cscope 15 $HOME/DBS/sqlite4               0003566513
	@benchmark/anntest.c

1 
	~"../∑r£.h
"

2 
	~"../›codes.h
"

3 
	~"../§c/sqlôeI¡.h
"

4 
	~"../§c/ve˘‹IndexI¡.h
"

5 
	~"as£π.h
"

6 
	~"°dboﬁ.h
"

7 
	~"°rög.h
"

8 
	~"°d¨g.h
"

9 
	~"time.h
"

10 
	~<sqlôe3.h
>

12 
	#ïrötf
(...Ë
	`Ârötf
(
°dîr
, 
__VA_ARGS__
)

	)

13 
	#ísuª
(
c⁄dôi⁄
, ...Ë{ i‡(!(c⁄dôi⁄)Ë{ 
	`ïrötf
(
__VA_ARGS__
); 
	`exô
(1); } }

	)

15 
	$£¨chVe˘‹s
(
sqlôe3
 *
db
, 
sqlôe3_°mt
 *
pStmt
, **
µIãms
, *
pIãmSize
) {

16 
	`ísuª
(
	`sqlôe3_ª£t
(
pStmt
Ë=
SQLITE_OK
, "ÁûedÅÿª£à°©emít: %s\n", 
	`sqlôe3_îrmsg
(
db
));

17 
rows
 = 0;

19 
rc
 = 
	`sqlôe3_°ï
(
pStmt
);

20 if–
rc
 =
SQLITE_DONE
 ){

22 } if–
rc
 =
SQLITE_ROW
 ){

23 c⁄° *
pBlob
 = 
	`sqlôe3_cﬁumn_blob
(
pStmt
, 0);

24 
nBlobSize
 = 
	`sqlôe3_cﬁumn_byãs
(
pStmt
, 0);

25 *
pBlobC›y
 = 
	`mÆloc
(
nBlobSize
);

26 
	`mem˝y
(
pBlobC›y
, 
pBlob
, 
nBlobSize
);

27 
µIãms
[
rows
] = 
pBlobC›y
;

28 
pIãmSize
[
rows
] = 
nBlobSize
;

29 
rows
++;

31 
	`ísuª
(
Ál£
, "u√x≥˘ed sã∞ªsu…: %s\n", 
	`sqlôe3_îrmsg
(
db
));

34  
rows
;

35 
	}
}

37 
	$£¨chRows
(
sqlôe3
 *
db
, 
sqlôe3_°mt
 *
pStmt
, *
pBlob
, 
nBlobSize
, *
ªsu…
) {

38 
	`ísuª
(
	`sqlôe3_ª£t
(
pStmt
Ë=
SQLITE_OK
, "ÁûedÅÿª£à°©emít: %s\n", 
	`sqlôe3_îrmsg
(
db
));

39 
	`ísuª
(
	`sqlôe3_böd_blob
(
pStmt
, 1, 
pBlob
, 
nBlobSize
, 
SQLITE_TRANSIENT
Ë=
SQLITE_OK
, "ÁûedÅÿböd blob: %s\n", 
	`sqlôe3_îrmsg
(
db
));

40 
rows
 = 0;

42 
rc
 = 
	`sqlôe3_°ï
(
pStmt
);

43 if–
rc
 =
SQLITE_DONE
 ){

45 } if–
rc
 =
SQLITE_ROW
 ){

46 
rowid
 = 
	`sqlôe3_cﬁumn_öt
(
pStmt
, 0);

47 
ªsu…
[
rows
++] = 
rowid
;

49 
	`ísuª
(
Ál£
, "u√x≥˘ed sã∞ªsu…: %s\n", 
	`sqlôe3_îrmsg
(
db
));

52  
rows
;

53 
	}
}

55 
	$ªˇŒ
(*
pExa˘
, 
nExa˘Size
, *
pA¬
, 
nA¬Size
) {

56 
ovîœp
 = 0;

57  
i
 = 0; i < 
nExa˘Size
; i++ ){

58 
ok
 = 0;

59 
s
 = 0; !
ok
 && s < 
nA¬Size
; s++ ){

60 
ok
 |
pExa˘
[
i
] =
pA¬
[
s
];

62 if(
ok
){

63 
ovîœp
++;

66  
ovîœp
 * 1.0 / 
nExa˘Size
;

67 
	}
}

69 
	$maö
(
¨gc
, * 
¨gv
[]) {

70 
	`ísuª
(
¨gc
 == 5, "pathÅoÅhe db file,ÑecallÅype,ánn query,Éxact query");

71 
sqlôe3
* 
db
;

72 
rc
 = 
	`sqlôe3_›í
(
¨gv
[1], &
db
);

73 
	`ísuª
(
rc
 == 0, "failedÅo open db:Ñc=%d\n",Ñc);

74 
	`¥ötf
("›í sqlôêdbáà'%s'\n", 
¨gv
[1]);

76 *
zTy≥
 = 
¨gv
[2];

77 * 
ve˘‹s
[65536];

78 
ve˘‹Size
[65536];

79 *
zA¬Quîy
 = 
¨gv
[3];

80 *
zExa˘Quîy
 = 
¨gv
[4];

82 
sqlôe3_°mt
 *
pVe˘‹s
;

83 
	`ísuª
(
	`sqlôe3_¥ï¨e_v2
(
db
, "SELECTÉmb FROM quîõs", -1, &
pVe˘‹s
, 0Ë=
SQLITE_OK
, "ÁûedÅÿ¥ï¨êve˘‹†°©emít: %s\n", 
	`sqlôe3_îrmsg
(db));

84 
sqlôe3_°mt
 *
pA¬
;

85 
	`ísuª
(
	`sqlôe3_¥ï¨e_v2
(
db
, 
zA¬Quîy
, -1, &
pA¬
, 0Ë=
SQLITE_OK
, "ÁûedÅÿ¥ï¨ê™¿°©emít: %s\n", 
	`sqlôe3_îrmsg
(db));

86 
sqlôe3_°mt
 *
pExa˘
;

87 
	`ísuª
(
	`sqlôe3_¥ï¨e_v2
(
db
, 
zExa˘Quîy
, -1, &
pExa˘
, 0Ë=
SQLITE_OK
, "ÁûedÅÿ¥ï¨êexa˘ sèãmít: %s\n", 
	`sqlôe3_îrmsg
(db));

89 
nVe˘‹s
 = 
	`£¨chVe˘‹s
(
db
, 
pVe˘‹s
, 
ve˘‹s
, 
ve˘‹Size
);

91 
blob
[8 * 65536];

92 
™nResu…
[65536];

93 
exa˘Resu…
[65536];

95 
	`¥ötf
("ªadyÅÿ≥rf‹m %d quîõ†wôh %†™¿quîyánd %†exa˘ quîy\n", 
nVe˘‹s
, 
zA¬Quîy
, 
zExa˘Quîy
);

96 
tŸÆReˇŒ
 = 0;

97 
tŸÆ
 = 0;

98 
i
 = 0; i < 
nVe˘‹s
; i++){

99 if–
i
 % 10 == 9 ){

100 
	`ïrötf
("¥ogªss: %d / %d, %.2f%% %†◊vg.)\n", 
i
, 
nVe˘‹s
, 
tŸÆReˇŒ
 / 
tŸÆ
 * 100, 
zTy≥
);

102 
nA¬Size
 = 
	`£¨chRows
(
db
, 
pA¬
, 
ve˘‹s
[
i
], 
ve˘‹Size
[i], 
™nResu…
);

103 
nExa˘Size
 = 
	`£¨chRows
(
db
, 
pExa˘
, 
ve˘‹s
[
i
], 
ve˘‹Size
[i], 
exa˘Resu…
);

104 
r
 = 
	`ªˇŒ
(
exa˘Resu…
, 
nExa˘Size
, 
™nResu…
, 
nA¬Size
);

105 
tŸÆReˇŒ
 +
r
;

106 
tŸÆ
++;

108 
	`sqlôe3_föÆize
(
pA¬
);

109 
	`sqlôe3_föÆize
(
pExa˘
);

110 
	`¥ötf
("%.2f%% %†◊vg.)\n", 
tŸÆReˇŒ
 / 
tŸÆ
 * 100, 
zTy≥
);

111 
	`sqlôe3_˛o£
(
db
);

113 
	}
}

	@benchmark/benchtest.c

1 
	~"∑r£.h
"

2 
	~"›codes.h
"

3 
	~"../§c/sqlôeI¡.h
"

4 
	~"as£π.h
"

5 
	~"°dboﬁ.h
"

6 
	~"˘y≥.h
"

7 
	~"°rög.h
"

8 
	~"°d¨g.h
"

9 
	~<time.h
>

10 
	~"sys/°©.h
"

12 
	~<°döt.h
>

13 
	~<°d©omic.h
>

15 
	#ïrötf
(...Ë
	`Ârötf
(
°dîr
, 
__VA_ARGS__
)

	)

16 
	#ísuª
(
c⁄dôi⁄
, ...Ë{ i‡(!(c⁄dôi⁄)Ë{ 
	`ïrötf
(
__VA_ARGS__
); 
	`exô
(1); } }

	)

18 
_Atomic
 
uöt64_t
 
	gg_disk™n_pﬁl_ns
 = 0;

19 
_Atomic
 
uöt64_t
 
	gg_disk™n_pﬁl_ˇŒs
 = 0;

21 
	$¥öt_ˇŒback
(

22 *
NŸU£d
,

23 
¨gc
,

24 
sqlôe4_vÆue
 **
¨gv
,

25 c⁄° **
cﬁName


27 
i
;

28 
i
 = 0; i < 
¨gc
; i++) {

29 c⁄° *
vÆ
;

31 i‡(
¨gv
[
i
] == 0) {

32 
vÆ
 = "NULL";

34 
vÆ
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], 
NULL
);

35 i‡(!
vÆ
) val = "(non-text)";

38 
	`¥ötf
("%s=%s\t", 
cﬁName
[
i
], 
vÆ
);

40 
	`¥ötf
("\n");

42 
	}
}

44 
DiskA¬EdgeSèts
 
	tDiskA¬EdgeSèts
;

45 
	sDiskA¬EdgeSèts
 {

46 
	möôed
;

47 
	mnMaxEdges
;

48 
u64
 
	mtŸÆNodes
;

49 
u64
 *
	mhi°
;

52 
DiskA¬EdgeSèts
 
	gg_edgeSèts
 = {0};

54 
ölöe
 
uöt64_t
 
	$now_ns_m⁄Ÿ⁄ic
() {

55 
time•ec
 
ts
;

56 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ts
);

57  (
uöt64_t
)
ts
.
tv_£c
 * 1000000000ULL + (uöt64_tÈs.
tv_n£c
;

58 
	}
}

60 
uöt64_t
 
	$disk™n_gë_pﬁl_ns
() {

61  
	`©omic_lﬂd_ex∂icô
(&
g_disk™n_pﬁl_ns
, 
mem‹y_‹dî_ªœxed
);

62 
	}
}

63 
	$disk™n_ª£t_pﬁl_ns
() {

64 
	`©omic_°‹e_ex∂icô
(&
g_disk™n_pﬁl_ns
, 0, 
mem‹y_‹dî_ªœxed
);

65 
	}
}

67 
uöt64_t
 
	$disk™n_gë_pﬁl_ˇŒs
() {

68  
	`©omic_lﬂd_ex∂icô
(&
g_disk™n_pﬁl_ˇŒs
, 
mem‹y_‹dî_ªœxed
);

69 
	}
}

70 
	$disk™n_ª£t_pﬁl_ˇŒs
() {

71 
	`©omic_°‹e_ex∂icô
(&
g_disk™n_pﬁl_ˇŒs
, 0, 
mem‹y_‹dî_ªœxed
);

72 
	}
}

74 
	$disk™n_¥öt_edge_fûl_°©s
(){

75 if–!
g_edgeSèts
.
öôed
 ){

76 
	`Ârötf
(
°dîr
, "[diskann]Édge-fill: statsÇot initialized\n");

80 
u64
 
nŸFuŒ
 = 0;

81 
u64
 
tŸÆ
 = 
g_edgeSèts
.
tŸÆNodes
;

82 
u64
 
nŸFuŒEdgesSum
 = 0;

83 
e
 = 0;É < 
g_edgeSèts
.
nMaxEdges
;É++){

84 
u64
 
˙t
 = 
g_edgeSèts
.
hi°
[
e
];

85 
nŸFuŒ
 +
˙t
;

86 
nŸFuŒEdgesSum
 +(
u64
)
e
 * 
˙t
;

89 
øtio
 = (
tŸÆ
 > 0Ë? (()
nŸFuŒ
 / ()total) : 0.0;

90 
avgNŸFuŒEdges
 = (
nŸFuŒ
 > 0Ë? (()
nŸFuŒEdgesSum
 / ()notFull) : 0.0;

92 
	`Ârötf
(
°dîr
,

95 ()
nŸFuŒ
,

96 ()
tŸÆ
,

97 
øtio
,

98 
øtio
 * 100.0,

99 
avgNŸFuŒEdges
,

100 
g_edgeSèts
.
nMaxEdges


102 
	}
}

105 
ölöe
 
	$now_£c_m⁄Ÿ⁄ic
() {

106 
time•ec
 
ts
;

107 
	`˛ock_gëtime
(
CLOCK_MONOTONIC
, &
ts
);

108  ()
ts
.
tv_£c
 + (Ès.
tv_n£c
 * 1e-9;

109 
	}
}

111 
	$¸óã_quîy_ãm∂©e
(* 
quîy
, * 
ãm∂©e
, ** 
∑ømëîs
, * 
Àngths
, * 
ty≥s
) {

112 
boﬁ
 
ö_quŸe
 = 
Ál£
;

113 
boﬁ
 
ö_digô
 = 
Ál£
;

114 
boﬁ
 
ö_tokí
 = 
Ál£
;

115 
∑ømëî
 = 0;

116 * 
∑ømëî_°¨t
 = 0;

118 i‡(
	`°∫cmp
(
quîy
, "INSERT", 6) != 0 && strncmp(query, "SELECT", 6) != 0) {

121 ; *
quîy
 != '\0'; query++) {

122 i‡(*
quîy
 == '\'') {

123 i‡(!
ö_quŸe
) {

124 
∑ømëî_°¨t
 = 
quîy
;

125 } i‡(
ö_quŸe
 && (
quîy
 - 
∑ømëî_°¨t
 < 3 || 
	`°∫cmp
(query - 3, "idx", 3) != 0)){

126 *(
ãm∂©e
++) = '?';

127 
∑ømëîs
[
∑ømëî
] = 
∑ømëî_°¨t
 + 1;

128 
Àngths
[
∑ømëî
] = ()(
quîy
 - 
∑ømëî_°¨t
 - 1);

129 
ty≥s
[
∑ømëî
] = 1;

130 
∑ømëî
++;

132 
quîy
 - 
∑ømëî_°¨t
 >= 0) {

133 *(
ãm∂©e
++Ë*(
∑ømëî_°¨t
++);

136 
ö_quŸe
 = !in_quote;

139 i‡(
ö_quŸe
) {

142 i‡(
	`ißÕha
(()*
quîy
Ë|| (
	`isdigô
(()*quîyË&& 
ö_tokí
)) {

143 
ö_tokí
 = 
åue
;

144 *(
ãm∂©e
++Ë*
quîy
;

147 i‡(
	`isdigô
(()*
quîy
)) {

148 i‡(!
ö_digô
) {

149 
∑ømëî_°¨t
 = 
quîy
;

151 
ö_digô
 = 
åue
;

154 i‡(
ö_digô
) {

155 *(
ãm∂©e
++) = '?';

156 
∑ømëîs
[
∑ømëî
] = 
∑ømëî_°¨t
;

157 
Àngths
[
∑ømëî
] = ()(
quîy
 - 
∑ømëî_°¨t
 + 1);

158 
ty≥s
[
∑ømëî
] = 0;

159 
∑ømëî
++;

161 
ö_tokí
 = 
Ál£
;

162 
ö_digô
 = 
Ál£
;

163 *(
ãm∂©e
++Ë*
quîy
;

165 *(
ãm∂©e
++) = '\0';

166  
∑ømëî
;

167 
	}
}

169 
	$gë_öt
(* 
s
, 
Àngth
) {

170 
buf„r
[32];

171 i‡(
Àngth
 < 0)Üength = 0;

172 i‡(
Àngth
 > 30)Üength = 30;

173 
	`mem˝y
(
buf„r
, 
s
, (
size_t
)
Àngth
);

174 
buf„r
[
Àngth
] = '\0';

175  
	`©oi
(
buf„r
);

176 
	}
}

178 
	$maö
(
¨gc
, * 
¨gv
[]) {

179 
	`ísuª
(
¨gc
 == 3, "provideÖathÅoÅhe query fileánd db file\n");

180 
FILE
* 
quîõs_f
 = 
	`f›í
(
¨gv
[1], "r");

181 
	`ísuª
(
quîõs_f
 !
NULL
, "failedÅo open queries file\n");

182 
	`¥ötf
("›í quîõ†fûê© %s\n", 
¨gv
[1]);

184 
sqlôe4
* 
db
;

185 
rc
 = 
	`sqlôe4_›í
(0, 
¨gv
[2], &
db
);

186 
	`ísuª
(
rc
 == 0, "failedÅo open db:Ñc=%d\n",Ñc);

187 
	`¥ötf
("›í sqlôêdbáà'%s'\n", 
¨gv
[2]);

189 
löe
[65536 * 32];

190 
ãm∂©e
[65536 * 32];

191 * 
∑ømëîs
[16];

192 
∑ømëî_Àngths
[16];

193 
∑ømëî_ty≥s
[16];

195 
sqlôe4_°mt
* 
°©emít
 = 
NULL
;

196 
¥ï¨ed
[65536 * 32];

197 
¥ï¨ed
[0] = '\0';

199 
tŸÆ_£À˘_time
 = 0;

200 
tŸÆ_ö£π_time
 = 0;

201 
tŸÆ_dñëe_time
 = 0;

202 
tŸÆ_ªads
 = 0;

203 
tŸÆ_wrôes
 = 0;

204 
tŸÆ_£À˘s
 = 0;

205 
tŸÆ_ö£πs
 = 0;

206 
tŸÆ_dñëes
 = 0;

207 
ödex
 = 0;

209 
	`fgës
(
löe
, ÷öe), 
quîõs_f
)) {

210 i‡(
ödex
 % 100 == 0) {

211 
	`ïrötf
("¥ogªss: %dÜöes\n", 
ödex
);

213 
ödex
++;

215 
Àn
 = ()
	`°æí
(
löe
);

216 i‡(
Àn
 == 0) ;

218 * 
íd
 = 
löe
 + 
Àn
 - 1;

219 
íd
 >
löe
 && (*end == '\n' || *end == '\r' || *end == ' ')) {

220 *(
íd
--) = '\0';

223 i‡(
	`°∫cmp
(
löe
, "---", 3) == 0) {

228 
	`¥ötf
("%†(%s):\n", 
löe
 + 3, 
¨gv
[1]);

229 
tŸÆ_quîõs
 = 
tŸÆ_£À˘s
 + 
tŸÆ_ö£πs
 + 
tŸÆ_dñëes
;

231 i‡(
tŸÆ_£À˘s
 > 0) {

232 
	`¥ötf
(" select: %.2f micros (avg.), %d (count)\n",

233 
tŸÆ_£À˘_time
 / 
tŸÆ_£À˘s
 * 1000000.0,Åotal_selects);

235 i‡(
tŸÆ_ö£πs
 > 0) {

236 
	`¥ötf
(" insert: %.2f micros (avg.), %d (count)\n",

237 
tŸÆ_ö£π_time
 / 
tŸÆ_ö£πs
 * 1000000.0,Åotal_inserts);

239 i‡(
tŸÆ_dñëes
 > 0) {

240 
	`¥ötf
(" delete: %.2f micros (avg.), %d (count)\n",

241 
tŸÆ_dñëe_time
 / 
tŸÆ_dñëes
 * 1000000.0,Åotal_deletes);

244 
°©
 
°
;

245 
	`°©
(
¨gv
[2], &
°
);

246 
	`¥ötf
(" sizê : %.4‡MB\n", 
°
.
°_size
 / 1024.0 / 1024.0);

248 i‡(
tŸÆ_quîõs
 > 0 && 
tŸÆ_ªads
 > 0) {

249 
	`¥ötf
("Ñeads : %.2f (avg.), %lld (total)\n",

250 
tŸÆ_ªads
 * 1.0 / 
tŸÆ_quîõs
,Åotal_reads);

252 i‡(
tŸÆ_quîõs
 > 0 && 
tŸÆ_wrôes
 > 0) {

253 
	`¥ötf
(" writes: %.2f (avg.), %lld (total)\n",

254 
tŸÆ_wrôes
 * 1.0 / 
tŸÆ_quîõs
,Åotal_writes);

257 
uöt64_t
 
pﬁl_ns
 = 
	`disk™n_gë_pﬁl_ns
();

258 
uöt64_t
 
pﬁl_ˇŒs
 = 
	`disk™n_gë_pﬁl_ˇŒs
();

260 i‡(
pﬁl_ˇŒs
 > 0) {

261 
	`¥ötf
("Öolling: %.2f micros/call (avg.), %.2f ms (total), %llu (calls)\n",

262 ()
pﬁl_ns
 / ()
pﬁl_ˇŒs
 / 1000.0,

263 ()
pﬁl_ns
 / 1e6,

264 ()
pﬁl_ˇŒs
);

266 
	`¥ötf
("Öolling: 0.00 micros/call (avg.), 0.00 ms (total), 0 (calls)\n");

269 i‡(
tŸÆ_ö£πs
 > 0) {

270 
tŸÆ_time_ns
 = 
tŸÆ_ö£π_time
 * 1e9;

271 
	`¥ötf
("Öolling share ofÅotal insertÅime: %.2f %%\n",

272 ()
pﬁl_ns
 / 
tŸÆ_time_ns
 * 100.0);

274 i‡(
tŸÆ_£À˘s
 > 0) {

275 
tŸÆ_time_ns
 = 
tŸÆ_£À˘_time
 * 1e9;

276 
	`¥ötf
("Öolling share ofÅotal selectÅime: %.2f %%\n",

277 ()
pﬁl_ns
 / 
tŸÆ_time_ns
 * 100.0);

281 
	`disk™n_ª£t_pﬁl_ns
();

282 
	`disk™n_ª£t_pﬁl_ˇŒs
();

283 
	`disk™n_¥öt_edge_fûl_°©s
();

285 
	`fÊush
(
°dout
);

287 
tŸÆ_ªads
 = 0;

288 
tŸÆ_wrôes
 = 0;

289 
tŸÆ_£À˘_time
 = 0;

290 
tŸÆ_ö£π_time
 = 0;

291 
tŸÆ_dñëe_time
 = 0;

292 
tŸÆ_£À˘s
 = 0;

293 
tŸÆ_ö£πs
 = 0;

294 
tŸÆ_dñëes
 = 0;

298 
cou¡
 = 
	`¸óã_quîy_ãm∂©e
(
löe
, 
ãm∂©e
, (**)&
∑ømëîs
,

299 
∑ømëî_Àngths
, 
∑ømëî_ty≥s
);

300 i‡(
cou¡
 > 0) {

301 i‡(
	`°rcmp
(
ãm∂©e
, 
¥ï¨ed
) != 0) {

302 i‡(
°©emít
) {

303 
	`sqlôe4_föÆize
(
°©emít
);

304 
°©emít
 = 
NULL
;

306 
	`mem˝y
(
¥ï¨ed
, 
ãm∂©e
, 
	`°æí
(template) + 1);

308 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
ãm∂©e
, ()
	`°æí
—em∂©e), &
°©emít
, 0);

309 
	`ísuª
(
rc
 =0, "ÁûedÅÿ¥ï¨ê°©emíà'%s': %d\n", 
ãm∂©e
,Ñc);

310 
	`ïrötf
("¥ï¨ed sèãmít: '%s'\n", 
ãm∂©e
);

313 
rc
 = 
	`sqlôe4_ª£t
(
°©emít
);

314 
	`ísuª
(
rc
 =0, "ÁûedÅÿª£à¥ï¨ed sèãmít: %s", 
	`sqlôe4_îrmsg
(
db
));

315 
rc
 = 
	`sqlôe4_˛ór_bödögs
(
°©emít
);

316 
	`ísuª
(
rc
 =0, "ÁûedÅÿ˛ó∏bödög†f‹Öª∑ªd sèãmít: %s", 
	`sqlôe4_îrmsg
(
db
));

319 
i
 = 0; i < 
cou¡
; i++) {

320 i‡(
∑ømëî_ty≥s
[
i
] == 0) {

321 
rc
 = 
	`sqlôe4_böd_öt
(
°©emít
, 
i
 + 1, 
	`gë_öt
(
∑ømëîs
[i], 
∑ømëî_Àngths
[i]));

322 
	`ísuª
(
rc
 =0, "ÁûedÅÿböd i¡Ö¨amëî (%d): %s\n", 
i
, 
	`sqlôe4_îrmsg
(
db
));

323 } i‡(
∑ømëî_ty≥s
[
i
] == 1) {

324 
rc
 = 
	`sqlôe4_böd_ãxt
(
°©emít
, 
i
 + 1, 
∑ømëîs
[i], 
∑ømëî_Àngths
[i], 
SQLITE4_TRANSIENT
, 0);

325 
	`ísuª
(
rc
 == 0, "failedÅo bind stringÖarameter: %d\n",Ñc);

327 
	`ísuª
(
Ál£
, "unexpectedÖarameterÅype\n");

331 
°¨t_time
 = 
	`now_£c_m⁄Ÿ⁄ic
();

333 * 
tŸÆ_time
 = 
NULL
;

334 * 
tŸÆ_cou¡
 = 
NULL
;

336 i‡(
	`°∫cmp
(
¥ï¨ed
, "SELECT", 6) == 0) {

337 
tŸÆ_time
 = &
tŸÆ_£À˘_time
;

338 
tŸÆ_cou¡
 = &
tŸÆ_£À˘s
;

341 
rc
 = 
	`sqlôe4_°ï
(
°©emít
);

342 } 
rc
 =
SQLITE4_ROW
);

343 
	`ísuª
(
rc
 =
SQLITE4_DONE
, "SELECT quîy föished inc‹ª˘ly: %s", 
	`sqlôe4_îrmsg
(
db
));

345 } i‡(
	`°∫cmp
(
¥ï¨ed
, "INSERT", 6) == 0) {

346 
tŸÆ_time
 = &
tŸÆ_ö£π_time
;

347 
tŸÆ_cou¡
 = &
tŸÆ_ö£πs
;

349 
rc
 = 
	`sqlôe4_°ï
(
°©emít
);

350 
	`ísuª
(
rc
 =
SQLITE4_DONE
, "INSERT quîy föished inc‹ª˘ly: %s", 
	`sqlôe4_îrmsg
(
db
));

352 } i‡(
	`°∫cmp
(
¥ï¨ed
, "DELETE", 6) == 0) {

353 
tŸÆ_time
 = &
tŸÆ_dñëe_time
;

354 
tŸÆ_cou¡
 = &
tŸÆ_dñëes
;

356 
rc
 = 
	`sqlôe4_°ï
(
°©emít
);

357 
	`ísuª
(
rc
 =
SQLITE4_DONE
, "DELETE quîy föished inc‹ª˘ly: %s", 
	`sqlôe4_îrmsg
(
db
));

360 
	`ísuª
(
Ál£
, "u√x≥˘ed quîyÅy≥: %s\n", 
¥ï¨ed
);

363 
íd_time
 = 
	`now_£c_m⁄Ÿ⁄ic
();

365 
tŸÆ_ªads
 +
	`sqlôe4_°mt_°©us
(
°©emít
, 1025, 1);

366 
tŸÆ_wrôes
 +
	`sqlôe4_°mt_°©us
(
°©emít
, 1026, 1);

368 *
tŸÆ_time
 +(
íd_time
 - 
°¨t_time
);

369 *
tŸÆ_cou¡
 += 1;

372 
rc
 = 
	`sqlôe4_exec
(
db
, 
löe
, 0, 0);

373 
	`ísuª
(
rc
 =0, "ÁûedÅÿexe¯sim∂ê°©emíà'%s': %s\n", 
löe
, 
	`sqlôe4_îrmsg
(
db
));

374 
	`ïrötf
("execuãd sim∂ê°©emít: '%s'\n", 
löe
);

379 
	`sqlôe4_exec
(
db
, "SELECT cou¡(*ËASÇ FROM x;", 
¥öt_ˇŒback
, 0);

380 
	`sqlôe4_exec
(
db
, "SELECT cou¡(*ËASÇ FROM x_idx_shadow;", 
¥öt_ˇŒback
, 0);

381 
	`sqlôe4_exec
(
db
, "SELECTÇame, sq»FROM sqlôe_schem®WHEREÇamêLIKE 'x_idx%';", 
¥öt_ˇŒback
, 0);

384 i‡(
°©emít
Ë
	`sqlôe4_föÆize
(statement);

385 
	`f˛o£
(
quîõs_f
);

386 
	`sqlôe4_˛o£
(
db
, 0);

388 
	}
}

	@benchmark/blobtest.c

1 
	~"../§c/sqlôeI¡.h
"

2 
	~"time.h
"

4 
	#ïrötf
(...Ë
	`Ârötf
(
°dîr
, 
__VA_ARGS__
)

	)

5 
	#ísuª
(
c⁄dôi⁄
, ...Ë{ i‡(!(c⁄dôi⁄)Ë{ 
	`ïrötf
(
__VA_ARGS__
); 
	`exô
(1); } }

	)

7 
	$maö
(
¨gc
, * 
¨gv
[]) {

8 
	`ísuª
(
¨gc
 == 6, "provideÖathÅoÅhe db file, blob open flags(read|write), blob open strategy(simple|reopen),ámount ofÑows, size ofÅhe blob\n");

9 
sqlôe3
* 
db
;

10 
rc
 = 
	`sqlôe3_›í
(
¨gv
[1], &
db
);

11 
	`ísuª
(
rc
 == 0, "failedÅo open db:Ñc=%d\n",Ñc);

12 
	`¥ötf
("›í sqlôêdbáà'%s'\n", 
¨gv
[1]);

14 
›íFœgs
 = 
¨gv
[2][0] == 'w';

15 
›íSå©egy
 = 
¨gv
[3][0] == 'r';

16 
nRows
 = 
	`©oi
(
¨gv
[4]);

17 
nBlobSize
 = 
	`©oi
(
¨gv
[5]);

19 
	`¥ötf
("blobÅable:ÑeadyÅoÖrepare\n");

20 
	`ísuª
(
	`sqlôe3_exec
(
db
, "CREATE TABLE x ( id INTEGER PRIMARY KEY, blob BLOB )", 0, 0, 
NULL
Ë=
SQLITE_OK
, "u«bÀÅÿ¸óãÅabÀ: %s\n", 
	`sqlôe3_îrmsg
(db));

21 
sqlôe3_°mt
 *
pStmt
;

22 
	`ísuª
(
	`sqlôe3_¥ï¨e
(
db
, "INSERT INTO x VALUES (?, ?)", -1, &
pStmt
, 
NULL
Ë=
SQLITE_OK
, "u«bÀÅÿ¥ï¨ê°©emít: %s\n", 
	`sqlôe3_îrmsg
(db));

23 *
pTøsh
 = 
	`mÆloc
(
nBlobSize
);

24 
i
 = 0; i < 
nRows
; i++){

25 
	`ísuª
(
	`sqlôe3_ª£t
(
pStmt
Ë=
SQLITE_OK
, "u«bÀÅÿª£à°©emít: %s\n", 
	`sqlôe3_îrmsg
(
db
));

26 
	`ísuª
(
	`sqlôe3_böd_öt
(
pStmt
, 1, 
i
Ë=
SQLITE_OK
, "u«bÀÅÿböd i¡: %s\n", 
	`sqlôe3_îrmsg
(
db
));

27 
	`ísuª
(
	`sqlôe3_böd_blob
(
pStmt
, 2, 
pTøsh
, 
nBlobSize
, 0Ë=
SQLITE_OK
, "u«bÀÅÿböd blob: %s\n", 
	`sqlôe3_îrmsg
(
db
));

28 
	`ísuª
(
	`sqlôe3_°ï
(
pStmt
Ë=
SQLITE_DONE
, "u√x≥˘edÑesu… o‡°ï: %s\n", 
	`sqlôe3_îrmsg
(
db
));

30 
	`sqlôe3_föÆize
(
pStmt
);

31 
	`¥ötf
("blobÅable:Örepared\n");

33 
time_t
 
°¨t_time
 = 
	`˛ock
();

34 
tŸÆ
 = 0;

35 
sqlôe3_blob
 *
pBlob
;

36 if–
›íSå©egy
 == 1 ){

37 
	`ísuª
(
	`sqlôe3_blob_›í
(
db
, db->
aDb
[0].
zDbSName
, "x", "blob", 0, 
›íFœgs
, &
pBlob
Ë=
SQLITE_OK
, "u«bÀÅÿ›í blob: %s\n", 
	`sqlôe3_îrmsg
(db));

39 
i
 = 0; i < 
nRows
; i++){

40 
rowid
 = 
	`ønd
(Ë% 
nRows
;

41 
tŸÆ
++;

42 if–
›íSå©egy
 == 1 ){

43 
	`ísuª
(
	`sqlôe3_blob_ª›í
(
pBlob
, 
rowid
Ë=
SQLITE_OK
, "u«bÀÅÿª›í blob: %s\n", 
	`sqlôe3_îrmsg
(
db
));

45 
	`ísuª
(
	`sqlôe3_blob_›í
(
db
, db->
aDb
[0].
zDbSName
, "x", "blob", 
rowid
, 
›íFœgs
, &
pBlob
Ë=
SQLITE_OK
, "u«bÀÅÿª›í blob: %s\n", 
	`sqlôe3_îrmsg
(db));

47 
	`ísuª
(
	`sqlôe3_blob_ªad
(
pBlob
, 
pTøsh
, 
nBlobSize
, 0Ë=
SQLITE_OK
, "u«bÀÅÿªad blob: %s\n", 
	`sqlôe3_îrmsg
(
db
));

48 if–
›íSå©egy
 == 0 ){

49 
	`ísuª
(
	`sqlôe3_blob_˛o£
(
pBlob
Ë=
SQLITE_OK
, "u«bÀÅÿ˛o£ blob: %s\n", 
	`sqlôe3_îrmsg
(
db
));

52 if–
›íSå©egy
 == 1 ){

53 
	`ísuª
(
	`sqlôe3_blob_˛o£
(
pBlob
Ë=
SQLITE_OK
, "u«bÀÅÿ˛o£ blob: %s\n", 
	`sqlôe3_îrmsg
(
db
));

56 
tŸÆ_time
 = (
	`˛ock
(Ë- 
°¨t_time
Ë* 1.0 / 
CLOCKS_PER_SEC
;

57 
	`¥ötf
("time: %.2‡mi¸o†◊vg.), %d (cou¡)\n", 
tŸÆ_time
 / 
tŸÆ
 * 1000000,Åotal);

59 
	`‰ì
(
pTøsh
);

60 
	`sqlôe3_˛o£
(
db
);

62 
	}
}

	@ext/fts1/ft_hash.c

16 
	~<as£π.h
>

17 
	~<°dlib.h
>

18 
	~<°rög.h
>

20 
	~"·_hash.h
"

22 *
	$mÆloc_™d_zîo
(
n
){

23 *
p
 = 
	`mÆloc
(
n
);

24 if–
p
 ){

25 
	`mem£t
(
p
, 0, 
n
);

27  
p
;

28 
	}
}

42 
	$HashInô
(
Hash
 *
pNew
, 
keyCœss
, 
c›yKey
){

43 
	`as£π
–
pNew
!=0 );

44 
	`as£π
–
keyCœss
>=
HASH_STRING
 && keyCœss<=
HASH_BINARY
 );

45 
pNew
->
keyCœss
 = keyClass;

47 if–
keyCœss
==
HASH_POINTER
 || keyCœss==
HASH_INT
 ) 
c›yKey
 = 0;

49 
pNew
->
c›yKey
 = copyKey;

50 
pNew
->
fú°
 = 0;

51 
pNew
->
cou¡
 = 0;

52 
pNew
->
htsize
 = 0;

53 
pNew
->
ht
 = 0;

54 
pNew
->
xMÆloc
 = 
mÆloc_™d_zîo
;

55 
pNew
->
xFªe
 = 
‰ì
;

56 
	}
}

62 
	$HashCÀ¨
(
Hash
 *
pH
){

63 
HashEÀm
 *
ñem
;

65 
	`as£π
–
pH
!=0 );

66 
ñem
 = 
pH
->
fú°
;

67 
pH
->
fú°
 = 0;

68 if–
pH
->
ht
 )ÖH->
	`xFªe
(pH->ht);

69 
pH
->
ht
 = 0;

70 
pH
->
htsize
 = 0;

71  
ñem
 ){

72 
HashEÀm
 *
√xt_ñem
 = 
ñem
->
√xt
;

73 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

74 
pH
->
	`xFªe
(
ñem
->
pKey
);

76 
pH
->
	`xFªe
(
ñem
);

77 
ñem
 = 
√xt_ñem
;

79 
pH
->
cou¡
 = 0;

80 
	}
}

86 
	$ötHash
(c⁄° *
pKey
, 
nKey
){

87  
nKey
 ^ (nKey<<8) ^ (nKey>>8);

88 
	}
}

89 
	$ötCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

90  
n2
 - 
n1
;

91 
	}
}

98 
	$±rHash
(c⁄° *
pKey
, 
nKey
){

99 
u±r
 
x
 = 
	`Addr
(
pKey
);

100  
x
 ^ (x<<8) ^ (x>>8);

101 
	}
}

102 
	$±rCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

103 if–
pKey1
==
pKey2
 )  0;

104 if–
pKey1
<
pKey2
 )  -1;

106 
	}
}

112 
	$°rHash
(c⁄° *
pKey
, 
nKey
){

113 c⁄° *
z
 = (c⁄° *)
pKey
;

114 
h
 = 0;

115 if–
nKey
<=0 )ÇKey = (Ë
	`°æí
(
z
);

116  
nKey
 > 0 ){

117 
h
 = (h<<3Ë^ h ^ *
z
++;

118 
nKey
--;

120  
h
 & 0x7fffffff;

121 
	}
}

122 
	$°rCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

123 if–
n1
!=
n2
 )  1;

124  
	`°∫cmp
((c⁄° *)
pKey1
,(c⁄° *)
pKey2
,
n1
);

125 
	}
}

130 
	$böHash
(c⁄° *
pKey
, 
nKey
){

131 
h
 = 0;

132 c⁄° *
z
 = (c⁄° *)
pKey
;

133  
nKey
-- > 0 ){

134 
h
 = (h<<3Ë^ h ^ *(
z
++);

136  
h
 & 0x7fffffff;

137 
	}
}

138 
	$böCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

139 if–
n1
!=
n2
 )  1;

140  
	`memcmp
(
pKey1
,
pKey2
,
n1
);

141 
	}
}

155 (*
	$hashFun˘i⁄
(
keyCœss
))(const *,){

157  
keyCœss
 ){

158 
HASH_INT
:  &
ötHash
;

159 
HASH_POINTER
:  &
±rHash
;

160 
HASH_STRING
:  &
°rHash
;

161 
HASH_BINARY
:  &
böHash
;;

166 if–
keyCœss
==
HASH_STRING
 ){

167  &
°rHash
;

169 
	`as£π
–
keyCœss
==
HASH_BINARY
 );

170  &
böHash
;

173 
	}
}

181 (*
	$com∑ªFun˘i⁄
(
keyCœss
))(const *,,const *,){

183  
keyCœss
 ){

184 
HASH_INT
:  &
ötCom∑ª
;

185 
HASH_POINTER
:  &
±rCom∑ª
;

186 
HASH_STRING
:  &
°rCom∑ª
;

187 
HASH_BINARY
:  &
böCom∑ª
;

192 if–
keyCœss
==
HASH_STRING
 ){

193  &
°rCom∑ª
;

195 
	`as£π
–
keyCœss
==
HASH_BINARY
 );

196  &
böCom∑ª
;

199 
	}
}

203 
	$ö£πEÀmít
(

204 
Hash
 *
pH
,

205 
_ht
 *
pE¡ry
,

206 
HashEÀm
 *
pNew


208 
HashEÀm
 *
pHód
;

209 
pHód
 = 
pE¡ry
->
chaö
;

210 if–
pHód
 ){

211 
pNew
->
√xt
 = 
pHód
;

212 
pNew
->
¥ev
 = 
pHód
->prev;

213 if–
pHód
->
¥ev
 ){ÖHód->¥ev->
√xt
 = 
pNew
; }

214 { 
pH
->
fú°
 = 
pNew
; }

215 
pHód
->
¥ev
 = 
pNew
;

217 
pNew
->
√xt
 = 
pH
->
fú°
;

218 if–
pH
->
fú°
 ){ÖH->fú°->
¥ev
 = 
pNew
; }

219 
pNew
->
¥ev
 = 0;

220 
pH
->
fú°
 = 
pNew
;

222 
pE¡ry
->
cou¡
++;

223 
pE¡ry
->
chaö
 = 
pNew
;

224 
	}
}

231 
	$ªhash
(
Hash
 *
pH
, 
√w_size
){

232 
_ht
 *
√w_ht
;

233 
HashEÀm
 *
ñem
, *
√xt_ñem
;

234 (*
xHash
)(const *,);

236 
	`as£π
–(
√w_size
 & (new_size-1))==0 );

237 
√w_ht
 = (
_ht
 *)
pH
->
	`xMÆloc
–
√w_size
*(_ht) );

238 if–
√w_ht
==0 ) ;

239 if–
pH
->
ht
 )ÖH->
	`xFªe
(pH->ht);

240 
pH
->
ht
 = 
√w_ht
;

241 
pH
->
htsize
 = 
√w_size
;

242 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

243 
ñem
=
pH
->
fú°
,ÖH->fú°=0;ÉÀm;ÉÀm = 
√xt_ñem
){

244 
h
 = (*
xHash
)(
ñem
->
pKey
,ÉÀm->
nKey
Ë& (
√w_size
-1);

245 
√xt_ñem
 = 
ñem
->
√xt
;

246 
	`ö£πEÀmít
(
pH
, &
√w_ht
[
h
], 
ñem
);

248 
	}
}

254 
HashEÀm
 *
	$födEÀmítGivíHash
(

255 c⁄° 
Hash
 *
pH
,

256 c⁄° *
pKey
,

257 
nKey
,

258 
h


260 
HashEÀm
 *
ñem
;

261 
cou¡
;

262 (*
xCom∑ª
)(const *,,const *,);

264 if–
pH
->
ht
 ){

265 
_ht
 *
pE¡ry
 = &
pH
->
ht
[
h
];

266 
ñem
 = 
pE¡ry
->
chaö
;

267 
cou¡
 = 
pE¡ry
->count;

268 
xCom∑ª
 = 
	`com∑ªFun˘i⁄
(
pH
->
keyCœss
);

269  
cou¡
-- && 
ñem
 ){

270 if–(*
xCom∑ª
)(
ñem
->
pKey
,ñem->
nKey
,pKey,nKey)==0 ){

271  
ñem
;

273 
ñem
 =ÉÀm->
√xt
;

277 
	}
}

282 
	$ªmoveEÀmítGivíHash
(

283 
Hash
 *
pH
,

284 
HashEÀm
* 
ñem
,

285 
h


287 
_ht
 *
pE¡ry
;

288 if–
ñem
->
¥ev
 ){

289 
ñem
->
¥ev
->
√xt
 =Élem->next;

291 
pH
->
fú°
 = 
ñem
->
√xt
;

293 if–
ñem
->
√xt
 ){

294 
ñem
->
√xt
->
¥ev
 =Élem->prev;

296 
pE¡ry
 = &
pH
->
ht
[
h
];

297 if–
pE¡ry
->
chaö
==
ñem
 ){

298 
pE¡ry
->
chaö
 = 
ñem
->
√xt
;

300 
pE¡ry
->
cou¡
--;

301 if–
pE¡ry
->
cou¡
<=0 ){

302 
pE¡ry
->
chaö
 = 0;

304 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

305 
pH
->
	`xFªe
(
ñem
->
pKey
);

307 
pH
->
	`xFªe
–
ñem
 );

308 
pH
->
cou¡
--;

309 if–
pH
->
cou¡
<=0 ){

310 
	`as£π
–
pH
->
fú°
==0 );

311 
	`as£π
–
pH
->
cou¡
==0 );

312 
	`HashCÀ¨
(
pH
);

314 
	}
}

320 *
	$HashFöd
(c⁄° 
Hash
 *
pH
, c⁄° *
pKey
, 
nKey
){

321 
h
;

322 
HashEÀm
 *
ñem
;

323 (*
xHash
)(const *,);

325 if–
pH
==0 ||ÖH->
ht
==0 )  0;

326 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

327 
	`as£π
–
xHash
!=0 );

328 
h
 = (*
xHash
)(
pKey
,
nKey
);

329 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

330 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
, 
h
 & (pH->
htsize
-1));

331  
ñem
 ?ÉÀm->
d©a
 : 0;

332 
	}
}

349 *
	$HashIn£π
(
Hash
 *
pH
, c⁄° *
pKey
, 
nKey
, *
d©a
){

350 
høw
;

351 
h
;

352 
HashEÀm
 *
ñem
;

353 
HashEÀm
 *
√w_ñem
;

354 (*
xHash
)(const *,);

356 
	`as£π
–
pH
!=0 );

357 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

358 
	`as£π
–
xHash
!=0 );

359 
høw
 = (*
xHash
)(
pKey
, 
nKey
);

360 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

361 
h
 = 
høw
 & (
pH
->
htsize
-1);

362 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
,
h
);

363 if–
ñem
 ){

364 *
ﬁd_d©a
 = 
ñem
->
d©a
;

365 if–
d©a
==0 ){

366 
	`ªmoveEÀmítGivíHash
(
pH
,
ñem
,
h
);

368 
ñem
->
d©a
 = data;

370  
ﬁd_d©a
;

372 if–
d©a
==0 )  0;

373 
√w_ñem
 = (
HashEÀm
*)
pH
->
	`xMÆloc
( (HashElem) );

374 if–
√w_ñem
==0 )  
d©a
;

375 if–
pH
->
c›yKey
 && 
pKey
!=0 ){

376 
√w_ñem
->
pKey
 = 
pH
->
	`xMÆloc
–
nKey
 );

377 if–
√w_ñem
->
pKey
==0 ){

378 
pH
->
	`xFªe
(
√w_ñem
);

379  
d©a
;

381 
	`mem˝y
((*)
√w_ñem
->
pKey
,ÖKey, 
nKey
);

383 
√w_ñem
->
pKey
 = (*)pKey;

385 
√w_ñem
->
nKey
 =ÇKey;

386 
pH
->
cou¡
++;

387 if–
pH
->
htsize
==0 ){

388 
	`ªhash
(
pH
,8);

389 if–
pH
->
htsize
==0 ){

390 
pH
->
cou¡
 = 0;

391 
pH
->
	`xFªe
(
√w_ñem
);

392  
d©a
;

395 if–
pH
->
cou¡
 >ÖH->
htsize
 ){

396 
	`ªhash
(
pH
,pH->
htsize
*2);

398 
	`as£π
–
pH
->
htsize
>0 );

399 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

400 
h
 = 
høw
 & (
pH
->
htsize
-1);

401 
	`ö£πEÀmít
(
pH
, &pH->
ht
[
h
], 
√w_ñem
);

402 
√w_ñem
->
d©a
 = data;

404 
	}
}

	@ext/fts1/ft_hash.h

17 #i‚de‡
_HASH_H_


18 
	#_HASH_H_


	)

21 
Hash
 
	tHash
;

22 
HashEÀm
 
	tHashEÀm
;

32 
	sHash
 {

33 
	mkeyCœss
;

34 
	mc›yKey
;

35 
	mcou¡
;

36 
HashEÀm
 *
	mfú°
;

37 *(*
	mxMÆloc
)();

38 (*
	mxFªe
)(*);

39 
	mhtsize
;

40 
	s_ht
 {

41 
	mcou¡
;

42 
HashEÀm
 *
	mchaö
;

43 } *
	mht
;

52 
	sHashEÀm
 {

53 
HashEÀm
 *
	m√xt
, *
	m¥ev
;

54 *
	md©a
;

55 *
	mpKey
; 
	mnKey
;

77 
	#HASH_STRING
 3

	)

78 
	#HASH_BINARY
 4

	)

83 
HashInô
(
Hash
*, 
keyty≥
, 
c›yKey
);

84 *
HashIn£π
(
Hash
*, c⁄° *
pKey
, 
nKey
, *
pD©a
);

85 *
HashFöd
(c⁄° 
Hash
*, c⁄° *
pKey
, 
nKey
);

86 
HashCÀ¨
(
Hash
*);

100 
	#HashFú°
(
H
Ë((H)->
fú°
)

	)

101 
	#HashNext
(
E
Ë((E)->
√xt
)

	)

102 
	#HashD©a
(
E
Ë((E)->
d©a
)

	)

103 
	#HashKey
(
E
Ë((E)->
pKey
)

	)

104 
	#HashKeysize
(
E
Ë((E)->
nKey
)

	)

109 
	#HashCou¡
(
H
Ë((H)->
cou¡
)

	)

	@ext/fts1/fts1.c

6 #i‡(!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS1
)) \

7 && !
	$deföed
(
SQLITE4_ENABLE_BROKEN_FTS1
)

8 #îr‹ 
·s1
 
has
 
a
 
design
 
Êaw
 
™d
 ha†
bìn
 
dïªˇãd
.

37 #i‡!
	`deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS1
)

39 #i‡
	`deföed
(
SQLITE4_ENABLE_FTS1
Ë&& !deföed(
SQLITE4_CORE
)

40 
	#SQLITE4_CORE
 1

	)

43 
	~<as£π.h
>

44 
	~<°dlib.h
>

45 
	~<°dio.h
>

46 
	~<°rög.h
>

47 
	~<˘y≥.h
>

49 
	~"·s1.h
"

50 
	~"·s1_hash.h
"

51 
	~"·s1_tokíizî.h
"

52 
	~"sqlôe4.h
"

53 
	~"sqlôe4ext.h
"

54 
SQLITE4_EXTENSION_INIT1


58 
	#TRACE
(
A
Ë
¥ötf
 A; 
	`fÊush
(
°dout
)

	)

60 
	#TRACE
(
A
)

	)

65 
	sSåögBuf„r
 {

66 
Àn
;

67 
Ælo˚d
;

68 *
s
;

69 } 
	tSåögBuf„r
;

71 
	$öôSåögBuf„r
(
SåögBuf„r
 *
sb
){

72 
sb
->
Àn
 = 0;

73 
sb
->
Ælo˚d
 = 100;

74 
sb
->
s
 = 
	`mÆloc
(100);

75 
sb
->
s
[0] = '\0';

76 
	}
}

78 
	$«µíd
(
SåögBuf„r
 *
sb
, c⁄° *
zFrom
, 
nFrom
){

79 if–
sb
->
Àn
 + 
nFrom
 >sb->
Ælo˚d
 ){

80 
sb
->
Ælo˚d
 = sb->
Àn
 + 
nFrom
 + 100;

81 
sb
->
s
 = 
	`ªÆloc
(sb->s, sb->
Ælo˚d
+1);

82 if–
sb
->
s
==0 ){

83 
	`öôSåögBuf„r
(
sb
);

87 
	`mem˝y
(
sb
->
s
 + sb->
Àn
, 
zFrom
, 
nFrom
);

88 
sb
->
Àn
 +
nFrom
;

89 
sb
->
s
[sb->
Àn
] = 0;

90 
	}
}

91 
	$≠≥nd
(
SåögBuf„r
 *
sb
, c⁄° *
zFrom
){

92 
	`«µíd
(
sb
, 
zFrom
, 
	`°æí
(zFrom));

93 
	}
}

109 
	#VARINT_MAX
 10

	)

114 
	$putV¨öt
(*
p
, 
sqlôe_öt64
 
v
){

115 *
q
 = (*Ë
p
;

116 
sqlôe_uöt64
 
vu
 = 
v
;

118 *
q
++ = (Ë((
vu
 & 0x7f) | 0x80);

119 
vu
 >>= 7;

120 } 
vu
!=0 );

121 
q
[-1] &= 0x7f;

122 
	`as£π
–
q
 - (*)
p
 <
VARINT_MAX
 );

123  (Ë(
q
 - (*)
p
);

124 
	}
}

129 
	$gëV¨öt
(c⁄° *
p
, 
sqlôe_öt64
 *
v
){

130 c⁄° *
q
 = (c⁄° *Ë
p
;

131 
sqlôe_uöt64
 
x
 = 0, 
y
 = 1;

132  (*
q
 & 0x80) == 0x80 ){

133 
x
 +
y
 * (*
q
++ & 0x7f);

134 
y
 <<= 7;

135 if–
q
 - (*)
p
 >
VARINT_MAX
 ){

136 
	`as£π
( 0 );

140 
x
 +
y
 * (*
q
++);

141 *
v
 = (
sqlôe_öt64
Ë
x
;

142  (Ë(
q
 - (*)
p
);

143 
	}
}

145 
	$gëV¨öt32
(c⁄° *
p
, *
pi
){

146 
sqlôe_öt64
 
i
;

147 
ªt
 = 
	`gëV¨öt
(
p
, &
i
);

148 *
pi
 = (Ë
i
;

149 
	`as£π
–*
pi
==
i
 );

150  
ªt
;

151 
	}
}

207 
	$ß„_is•a˚
(
c
){

208  (
c
&0x80)==0 ? 
	`is•a˚
(c) : 0;

209 
	}
}

210 
	$ß„_tﬁowî
(
c
){

211  (
c
&0x80)==0 ? 
	`tﬁowî
(c) : c;

212 
	}
}

213 
	$ß„_iß um
(
c
){

214  (
c
&0x80)==0 ? 
	`iß um
(c) : 0;

215 
	}
}

217 
	eDocLi°Ty≥
 {

218 
	mDL_DOCIDS
,

219 
	mDL_POSITIONS
,

220 
	mDL_POSITIONS_OFFSETS


221 } 
	tDocLi°Ty≥
;

230 #i‚de‡
DL_DEFAULT


231 
	#DL_DEFAULT
 
DL_POSITIONS


	)

234 
	sDocLi°
 {

235 *
	mpD©a
;

236 
	mnD©a
;

237 
DocLi°Ty≥
 
	miTy≥
;

238 
	miLa°Cﬁumn
;

239 
	miLa°Pos
;

240 
	miLa°Off£t
;

241 } 
	tDocLi°
;

244 
	mPOS_END
 = 0,

245 
	mPOS_COLUMN
,

246 
	mPOS_BASE


250 
	$docLi°Inô
(
DocLi°
 *
d
, 
DocLi°Ty≥
 
iTy≥
,

251 c⁄° *
pD©a
, 
nD©a
){

252 
d
->
nD©a
 =ÇData;

253 if–
nD©a
>0 ){

254 
d
->
pD©a
 = 
	`mÆloc
(
nD©a
);

255 
	`mem˝y
(
d
->
pD©a
,ÖD©a, 
nD©a
);

257 
d
->
pD©a
 = 
NULL
;

259 
d
->
iTy≥
 = iType;

260 
d
->
iLa°Cﬁumn
 = 0;

261 
d
->
iLa°Pos
 = d->
iLa°Off£t
 = 0;

262 
	}
}

265 
DocLi°
 *
	$docLi°New
(
DocLi°Ty≥
 
iTy≥
){

266 
DocLi°
 *
d
 = (DocLi° *Ë
	`mÆloc
((DocList));

267 
	`docLi°Inô
(
d
, 
iTy≥
, 0, 0);

268  
d
;

269 
	}
}

271 
	$docLi°De°roy
(
DocLi°
 *
d
){

272 
	`‰ì
(
d
->
pD©a
);

273 #i‚de‡
NDEBUG


274 
	`mem£t
(
d
, 0x55, (*d));

276 
	}
}

278 
	$docLi°Dñëe
(
DocLi°
 *
d
){

279 
	`docLi°De°roy
(
d
);

280 
	`‰ì
(
d
);

281 
	}
}

283 *
	$docLi°End
(
DocLi°
 *
d
){

284  
d
->
pD©a
 + d->
nD©a
;

285 
	}
}

288 
	$≠≥ndV¨öt
(
DocLi°
 *
d
, 
sqlôe_öt64
 
i
){

289 
c
[
VARINT_MAX
];

290 
n
 = 
	`putV¨öt
(
c
, 
i
);

291 
d
->
pD©a
 = 
	`ªÆloc
(d->pD©a, d->
nD©a
 + 
n
);

292 
	`mem˝y
(
d
->
pD©a
 + d->
nD©a
, 
c
, 
n
);

293 
d
->
nD©a
 +
n
;

294 
	}
}

296 
	$docLi°AddDocid
(
DocLi°
 *
d
, 
sqlôe_öt64
 
iDocid
){

297 
	`≠≥ndV¨öt
(
d
, 
iDocid
);

298 if–
d
->
iTy≥
>=
DL_POSITIONS
 ){

299 
	`≠≥ndV¨öt
(
d
, 
POS_END
);

300 
d
->
iLa°Cﬁumn
 = 0;

301 
d
->
iLa°Pos
 = d->
iLa°Off£t
 = 0;

303 
	}
}

306 
	$addPos
(
DocLi°
 *
d
, 
iCﬁumn
, 
iPos
){

307 
	`as£π
–
d
->
nD©a
>0 );

308 --
d
->
nD©a
;

309 if–
iCﬁumn
!=
d
->
iLa°Cﬁumn
 ){

310 
	`as£π
–
iCﬁumn
>
d
->
iLa°Cﬁumn
 );

311 
	`≠≥ndV¨öt
(
d
, 
POS_COLUMN
);

312 
	`≠≥ndV¨öt
(
d
, 
iCﬁumn
);

313 
d
->
iLa°Cﬁumn
 = 
iCﬁumn
;

314 
d
->
iLa°Pos
 = d->
iLa°Off£t
 = 0;

316 
	`as£π
–
iPos
>=
d
->
iLa°Pos
 );

317 
	`≠≥ndV¨öt
(
d
, 
iPos
-d->
iLa°Pos
+
POS_BASE
);

318 
d
->
iLa°Pos
 = 
iPos
;

319 
	}
}

322 
	$docLi°AddPos
(
DocLi°
 *
d
, 
iCﬁumn
, 
iPos
){

323 
	`as£π
–
d
->
iTy≥
==
DL_POSITIONS
 );

324 
	`addPos
(
d
, 
iCﬁumn
, 
iPos
);

325 
	`≠≥ndV¨öt
(
d
, 
POS_END
);

326 
	}
}

334 
	$docLi°AddPosOff£t
(

335 
DocLi°
 *
d
,

336 
iCﬁumn
,

337 
iPos
,

338 
iSèπOff£t
,

339 
iEndOff£t


341 
	`as£π
–
d
->
iTy≥
>=
DL_POSITIONS
 );

342 
	`addPos
(
d
, 
iCﬁumn
, 
iPos
);

343 if–
d
->
iTy≥
==
DL_POSITIONS_OFFSETS
 ){

344 
	`as£π
–
iSèπOff£t
>=
d
->
iLa°Off£t
 );

345 
	`≠≥ndV¨öt
(
d
, 
iSèπOff£t
-d->
iLa°Off£t
);

346 
d
->
iLa°Off£t
 = 
iSèπOff£t
;

347 
	`as£π
–
iEndOff£t
>=
iSèπOff£t
 );

348 
	`≠≥ndV¨öt
(
d
, 
iEndOff£t
-
iSèπOff£t
);

350 
	`≠≥ndV¨öt
(
d
, 
POS_END
);

351 
	}
}

367 
	sDocLi°Ródî
 {

368 
DocLi°
 *
	mpDo˛i°
;

369 *
	mp
;

370 
	miLa°Cﬁumn
;

371 
	miLa°Pos
;

372 } 
	tDocLi°Ródî
;

377 
	$ªadîInô
(
DocLi°Ródî
 *
r
, 
DocLi°
 *
pDo˛i°
){

378 
r
->
pDo˛i°
 =ÖDoclist;

379 if–
pDo˛i°
!=
NULL
 ){

380 
r
->
p
 = 
pDo˛i°
->
pD©a
;

382 
r
->
iLa°Cﬁumn
 = -1;

383 
r
->
iLa°Pos
 = -1;

384 
	}
}

390 
	$©End
(
DocLi°Ródî
 *
pRódî
){

391  
pRódî
->
pDo˛i°
==0 || (pRódî->
p
 >
	`docLi°End
(pReader->pDoclist));

392 
	}
}

396 
sqlôe_öt64
 
	$≥ekDocid
(
DocLi°Ródî
 *
pRódî
){

397 
sqlôe_öt64
 
ªt
;

398 
	`as£π
–!
	`©End
(
pRódî
) );

399 
	`as£π
–
pRódî
->
iLa°Pos
==-1 );

400 
	`gëV¨öt
(
pRódî
->
p
, &
ªt
);

401  
ªt
;

402 
	}
}

406 
sqlôe_öt64
 
	$ªadDocid
(
DocLi°Ródî
 *
pRódî
){

407 
sqlôe_öt64
 
ªt
;

408 
	`as£π
–!
	`©End
(
pRódî
) );

409 
	`as£π
–
pRódî
->
iLa°Pos
==-1 );

410 
pRódî
->
p
 +
	`gëV¨öt
’Ródî->p, &
ªt
);

411 if–
pRódî
->
pDo˛i°
->
iTy≥
>=
DL_POSITIONS
 ){

412 
pRódî
->
iLa°Cﬁumn
 = 0;

413 
pRódî
->
iLa°Pos
 = 0;

415  
ªt
;

416 
	}
}

420 
	$ªadPosôi⁄
(
DocLi°Ródî
 *
pRódî
, *
iCﬁumn
){

421 
i
;

422 
iTy≥
 = 
pRódî
->
pDo˛i°
->iType;

424 if–
pRódî
->
iLa°Pos
==-1 ){

427 
	`as£π
–!
	`©End
(
pRódî
) );

429 if–
iTy≥
<
DL_POSITIONS
 ){

432 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
i
);

433 if–
i
==
POS_END
 ){

434 
pRódî
->
iLa°Cﬁumn
 =ÖRódî->
iLa°Pos
 = -1;

435 *
iCﬁumn
 = -1;

438 if–
i
==
POS_COLUMN
 ){

439 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &pRódî->
iLa°Cﬁumn
);

440 
pRódî
->
iLa°Pos
 = 0;

441 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
i
);

442 
	`as£π
–
i
>=
POS_BASE
 );

444 
pRódî
->
iLa°Pos
 +((Ë
i
)-
POS_BASE
;

445 if–
iTy≥
>=
DL_POSITIONS_OFFSETS
 ){

447 
iSèπ
, 
iEnd
;

448 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
iSèπ
);

449 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
iEnd
);

451 *
iCﬁumn
 = 
pRódî
->
iLa°Cﬁumn
;

452  
pRódî
->
iLa°Pos
;

453 
	}
}

456 
	$skùPosôi⁄Li°
(
DocLi°Ródî
 *
pRódî
){

457 
DocLi°
 *
p
 = 
pRódî
->
pDo˛i°
;

458 if–
p
 &&Ö->
iTy≥
>=
DL_POSITIONS
 ){

459 
iCﬁumn
;

460  
	`ªadPosôi⁄
(
pRódî
, &
iCﬁumn
)!=-1 ){}

462 
	}
}

466 
	$skùDocumít
(
DocLi°Ródî
 *
pRódî
){

467 
	`ªadDocid
(
pRódî
);

468 
	`skùPosôi⁄Li°
(
pRódî
);

469 
	}
}

473 
	$skùToDocid
(
DocLi°Ródî
 *
pRódî
, 
sqlôe_öt64
 
iDocid
){

474 
sqlôe_öt64
 
d
 = 0;

475  !
	`©End
(
pRódî
Ë&& (
d
=
	`≥ekDocid
’Ródî))<
iDocid
 ){

476 
	`skùDocumít
(
pRódî
);

478  !
	`©End
(
pRódî
Ë&& 
d
==
iDocid
;

479 
	}
}

483 
sqlôe_öt64
 
	$fú°Docid
(
DocLi°
 *
d
){

484 
DocLi°Ródî
 
r
;

485 
	`ªadîInô
(&
r
, 
d
);

486  
	`ªadDocid
(&
r
);

487 
	}
}

489 #ifde‡
SQLITE4_DEBUG


495 
	$¥ötDo˛i°
(
DocLi°
 *
p
){

496 
DocLi°Ródî
 
r
;

497 c⁄° *
zSï
 = "";

499 
	`ªadîInô
(&
r
, 
p
);

500  !
	`©End
(&
r
) ){

501 
sqlôe_öt64
 
docid
 = 
	`ªadDocid
(&
r
);

502 if–
docid
==0 ){

503 
	`skùPosôi⁄Li°
(&
r
);

506 
	`¥ötf
("%s%Œd", 
zSï
, 
docid
);

507 
zSï
 = ",";

508 if–
p
->
iTy≥
>=
DL_POSITIONS
 ){

509 
iPos
, 
iCﬁ
;

510 c⁄° *
zDiv
 = "";

511 
	`¥ötf
("(");

512  (
iPos
 = 
	`ªadPosôi⁄
(&
r
, &
iCﬁ
))>=0 ){

513 
	`¥ötf
("%s%d:%d", 
zDiv
, 
iCﬁ
, 
iPos
);

514 
zDiv
 = ":";

516 
	`¥ötf
(")");

519 
	`¥ötf
("\n");

520 
	`fÊush
(
°dout
);

521 
	}
}

526 
	$docLi°Re°ri˘Cﬁumn
(
DocLi°
 *
ö
, 
iRe°ri˘Cﬁumn
){

527 
DocLi°Ródî
 
r
;

528 
DocLi°
 
out
;

530 
	`as£π
–
ö
->
iTy≥
>=
DL_POSITIONS
 );

531 
	`ªadîInô
(&
r
, 
ö
);

532 
	`docLi°Inô
(&
out
, 
DL_POSITIONS
, 
NULL
, 0);

534  !
	`©End
(&
r
) ){

535 
sqlôe_öt64
 
iDocid
 = 
	`ªadDocid
(&
r
);

536 
iPos
, 
iCﬁumn
;

538 
	`docLi°AddDocid
(&
out
, 
iDocid
);

539  (
iPos
 = 
	`ªadPosôi⁄
(&
r
, &
iCﬁumn
)) != -1 ){

540 if–
iCﬁumn
==
iRe°ri˘Cﬁumn
 ){

541 
	`docLi°AddPos
(&
out
, 
iCﬁumn
, 
iPos
);

546 
	`docLi°De°roy
(
ö
);

547 *
ö
 = 
out
;

548 
	}
}

552 
	$docLi°DisˇrdEm±y
(
DocLi°
 *
ö
) {

553 
DocLi°Ródî
 
r
;

554 
DocLi°
 
out
;

558 
	`as£π
–
ö
->
iTy≥
>=
DL_POSITIONS
 );

559 
	`ªadîInô
(&
r
, 
ö
);

560 
	`docLi°Inô
(&
out
, 
DL_POSITIONS
, 
NULL
, 0);

562  !
	`©End
(&
r
) ){

563 
sqlôe_öt64
 
iDocid
 = 
	`ªadDocid
(&
r
);

564 
m©ch
 = 0;

565 
iPos
, 
iCﬁumn
;

566  (
iPos
 = 
	`ªadPosôi⁄
(&
r
, &
iCﬁumn
)) != -1 ){

567 if–!
m©ch
 ){

568 
	`docLi°AddDocid
(&
out
, 
iDocid
);

569 
m©ch
 = 1;

571 
	`docLi°AddPos
(&
out
, 
iCﬁumn
, 
iPos
);

575 
	`docLi°De°roy
(
ö
);

576 *
ö
 = 
out
;

577 
	}
}

583 
	$docLi°S∂i˚EÀmít
(
DocLi°Ródî
 *
r
, 
sqlôe_öt64
 
iDocid
,

584 c⁄° *
pSour˚
, 
nSour˚
){

585 
DocLi°
 *
d
 = 
r
->
pDo˛i°
;

586 *
pT¨gë
;

587 
nT¨gë
, 
found
;

589 
found
 = 
	`skùToDocid
(
r
, 
iDocid
);

592 
pT¨gë
 = 
r
->
p
;

593 if–
found
 ){

594 
	`skùDocumít
(
r
);

595 
nT¨gë
 = 
r
->
p
-
pT¨gë
;

597 
nT¨gë
 = 0;

605 if–
nT¨gë
>
nSour˚
 ){

606 
	`memmove
(
pT¨gë
+
nSour˚
,ÖT¨gë+
nT¨gë
, 
	`docLi°End
(
d
)-(pTarget+nTarget));

608 if–
nT¨gë
!=
nSour˚
 ){

609 
iDo˛i°
 = 
pT¨gë
-
d
->
pD©a
;

610 
d
->
pD©a
 = 
	`ªÆloc
(d->pD©a, d->
nD©a
+
nSour˚
-
nT¨gë
);

611 
pT¨gë
 = 
d
->
pD©a
+
iDo˛i°
;

613 if–
nT¨gë
<
nSour˚
 ){

614 
	`memmove
(
pT¨gë
+
nSour˚
,ÖT¨gë+
nT¨gë
, 
	`docLi°End
(
d
)-(pTarget+nTarget));

617 
	`mem˝y
(
pT¨gë
, 
pSour˚
, 
nSour˚
);

618 
d
->
nD©a
 +
nSour˚
-
nT¨gë
;

619 
r
->
p
 = 
pT¨gë
+
nSour˚
;

620 
	}
}

623 
	$docLi°Upd©e
(
DocLi°
 *
d
, DocLi° *
pUpd©e
){

624 
DocLi°Ródî
 
ªadî
;

626 
	`as£π
–
d
!=
NULL
 && 
pUpd©e
!=NULL );

627 
	`as£π
–
d
->
iTy≥
==
pUpd©e
->iType);

629 
	`ªadîInô
(&
ªadî
, 
d
);

630 
	`docLi°S∂i˚EÀmít
(&
ªadî
, 
	`fú°Docid
(
pUpd©e
),

631 
pUpd©e
->
pD©a
,ÖUpd©e->
nD©a
);

632 
	}
}

637 
	$docLi°Accumuœã
(
DocLi°
 *
pAcc
, DocLi° *
pUpd©e
){

638 
DocLi°Ródî
 
accRódî
, 
upd©eRódî
;

641 
	`as£π
–
pAcc
!=
NULL
 );

642 if–
pUpd©e
==
NULL
 ||ÖUpd©e->
nD©a
==0 ) ;

643 if–
pAcc
->
nD©a
==0 ){

644 
pAcc
->
pD©a
 = 
	`mÆloc
(
pUpd©e
->
nD©a
);

645 
	`mem˝y
(
pAcc
->
pD©a
, 
pUpd©e
->pD©a,ÖUpd©e->
nD©a
);

646 
pAcc
->
nD©a
 = 
pUpd©e
->nData;

650 
	`ªadîInô
(&
accRódî
, 
pAcc
);

651 
	`ªadîInô
(&
upd©eRódî
, 
pUpd©e
);

653  !
	`©End
(&
upd©eRódî
) ){

654 *
pSour˚
 = 
upd©eRódî
.
p
;

655 
sqlôe_öt64
 
iDocid
 = 
	`ªadDocid
(&
upd©eRódî
);

656 
	`skùPosôi⁄Li°
(&
upd©eRódî
);

657 
	`docLi°S∂i˚EÀmít
(&
accRódî
, 
iDocid
, 
pSour˚
, 
upd©eRódî
.
p
-pSource);

659 
	}
}

667 
sqlôe_öt64
 
	$√xtDocid
(
DocLi°Ródî
 *
pIn
){

668 
	`skùPosôi⁄Li°
(
pIn
);

669  
	`©End
(
pIn
Ë? 0 : 
	`ªadDocid
(pIn);

670 
	}
}

688 
	$mîgePosLi°
(

689 
DocLi°Ródî
 *
pLe·
,

690 
DocLi°Ródî
 *
pRight
,

691 
sqlôe_öt64
 
iDocid
,

692 
DocLi°
 *
pOut


694 
iLe·Cﬁ
, 
iLe·Pos
 = 
	`ªadPosôi⁄
(
pLe·
, &iLeftCol);

695 
iRightCﬁ
, 
iRightPos
 = 
	`ªadPosôi⁄
(
pRight
, &iRightCol);

696 
m©ch
 = 0;

699  
iLe·Pos
!=-1 && 
iRightPos
!=-1 ){

700 if–
iLe·Cﬁ
==
iRightCﬁ
 && 
iLe·Pos
+1==
iRightPos
 ){

701 if–!
m©ch
 ){

702 
	`docLi°AddDocid
(
pOut
, 
iDocid
);

703 
m©ch
 = 1;

705 if–
pOut
->
iTy≥
>=
DL_POSITIONS
 ){

706 
	`docLi°AddPos
(
pOut
, 
iRightCﬁ
, 
iRightPos
);

708 
iLe·Pos
 = 
	`ªadPosôi⁄
(
pLe·
, &
iLe·Cﬁ
);

709 
iRightPos
 = 
	`ªadPosôi⁄
(
pRight
, &
iRightCﬁ
);

710 }if–
iRightCﬁ
<
iLe·Cﬁ
 ||

711 (
iRightCﬁ
==
iLe·Cﬁ
 && 
iRightPos
<
iLe·Pos
+1) ){

712 
iRightPos
 = 
	`ªadPosôi⁄
(
pRight
, &
iRightCﬁ
);

714 
iLe·Pos
 = 
	`ªadPosôi⁄
(
pLe·
, &
iLe·Cﬁ
);

717 if–
iLe·Pos
>=0 ) 
	`skùPosôi⁄Li°
(
pLe·
);

718 if–
iRightPos
>=0 ) 
	`skùPosôi⁄Li°
(
pRight
);

719 
	}
}

730 
	$docLi°Phø£Mîge
(

731 
DocLi°
 *
pLe·
,

732 
DocLi°
 *
pRight
,

733 
DocLi°
 *
pOut


735 
DocLi°Ródî
 
À·
, 
right
;

736 
sqlôe_öt64
 
docidLe·
, 
docidRight
;

738 
	`ªadîInô
(&
À·
, 
pLe·
);

739 
	`ªadîInô
(&
right
, 
pRight
);

740 
docidLe·
 = 
	`√xtDocid
(&
À·
);

741 
docidRight
 = 
	`√xtDocid
(&
right
);

743  
docidLe·
>0 && 
docidRight
>0 ){

744 if–
docidLe·
<
docidRight
 ){

745 
docidLe·
 = 
	`√xtDocid
(&
À·
);

746 }if–
docidRight
<
docidLe·
 ){

747 
docidRight
 = 
	`√xtDocid
(&
right
);

749 
	`mîgePosLi°
(&
À·
, &
right
, 
docidLe·
, 
pOut
);

750 
docidLe·
 = 
	`√xtDocid
(&
À·
);

751 
docidRight
 = 
	`√xtDocid
(&
right
);

754 
	}
}

762 
	$docLi°AndMîge
(

763 
DocLi°
 *
pLe·
,

764 
DocLi°
 *
pRight
,

765 
DocLi°
 *
pOut


767 
DocLi°Ródî
 
À·
, 
right
;

768 
sqlôe_öt64
 
docidLe·
, 
docidRight
;

770 
	`as£π
–
pOut
->
iTy≥
<
DL_POSITIONS
 );

772 
	`ªadîInô
(&
À·
, 
pLe·
);

773 
	`ªadîInô
(&
right
, 
pRight
);

774 
docidLe·
 = 
	`√xtDocid
(&
À·
);

775 
docidRight
 = 
	`√xtDocid
(&
right
);

777  
docidLe·
>0 && 
docidRight
>0 ){

778 if–
docidLe·
<
docidRight
 ){

779 
docidLe·
 = 
	`√xtDocid
(&
À·
);

780 }if–
docidRight
<
docidLe·
 ){

781 
docidRight
 = 
	`√xtDocid
(&
right
);

783 
	`docLi°AddDocid
(
pOut
, 
docidLe·
);

784 
docidLe·
 = 
	`√xtDocid
(&
À·
);

785 
docidRight
 = 
	`√xtDocid
(&
right
);

788 
	}
}

796 
	$docLi°OrMîge
(

797 
DocLi°
 *
pLe·
,

798 
DocLi°
 *
pRight
,

799 
DocLi°
 *
pOut


801 
DocLi°Ródî
 
À·
, 
right
;

802 
sqlôe_öt64
 
docidLe·
, 
docidRight
, 
¥i‹Le·
;

804 
	`ªadîInô
(&
À·
, 
pLe·
);

805 
	`ªadîInô
(&
right
, 
pRight
);

806 
docidLe·
 = 
	`√xtDocid
(&
À·
);

807 
docidRight
 = 
	`√xtDocid
(&
right
);

809  
docidLe·
>0 && 
docidRight
>0 ){

810 if–
docidLe·
<=
docidRight
 ){

811 
	`docLi°AddDocid
(
pOut
, 
docidLe·
);

813 
	`docLi°AddDocid
(
pOut
, 
docidRight
);

815 
¥i‹Le·
 = 
docidLe·
;

816 if–
docidLe·
<=
docidRight
 ){

817 
docidLe·
 = 
	`√xtDocid
(&
À·
);

819 if–
docidRight
>0 && docidRight<=
¥i‹Le·
 ){

820 
docidRight
 = 
	`√xtDocid
(&
right
);

823  
docidLe·
>0 ){

824 
	`docLi°AddDocid
(
pOut
, 
docidLe·
);

825 
docidLe·
 = 
	`√xtDocid
(&
À·
);

827  
docidRight
>0 ){

828 
	`docLi°AddDocid
(
pOut
, 
docidRight
);

829 
docidRight
 = 
	`√xtDocid
(&
right
);

831 
	}
}

841 
	$docLi°Ex˚±Mîge
(

842 
DocLi°
 *
pLe·
,

843 
DocLi°
 *
pRight
,

844 
DocLi°
 *
pOut


846 
DocLi°Ródî
 
À·
, 
right
;

847 
sqlôe_öt64
 
docidLe·
, 
docidRight
, 
¥i‹Le·
;

849 
	`ªadîInô
(&
À·
, 
pLe·
);

850 
	`ªadîInô
(&
right
, 
pRight
);

851 
docidLe·
 = 
	`√xtDocid
(&
À·
);

852 
docidRight
 = 
	`√xtDocid
(&
right
);

854  
docidLe·
>0 && 
docidRight
>0 ){

855 
¥i‹Le·
 = 
docidLe·
;

856 if–
docidLe·
<
docidRight
 ){

857 
	`docLi°AddDocid
(
pOut
, 
docidLe·
);

859 if–
docidLe·
<=
docidRight
 ){

860 
docidLe·
 = 
	`√xtDocid
(&
À·
);

862 if–
docidRight
>0 && docidRight<=
¥i‹Le·
 ){

863 
docidRight
 = 
	`√xtDocid
(&
right
);

866  
docidLe·
>0 ){

867 
	`docLi°AddDocid
(
pOut
, 
docidLe·
);

868 
docidLe·
 = 
	`√xtDocid
(&
À·
);

870 
	}
}

872 *
	$°rög_dup_n
(c⁄° *
s
, 
n
){

873 *
°r
 = 
	`mÆloc
(
n
 + 1);

874 
	`mem˝y
(
°r
, 
s
, 
n
);

875 
°r
[
n
] = '\0';

876  
°r
;

877 
	}
}

882 *
	$°rög_dup
(c⁄° *
s
){

883  
	`°rög_dup_n
(
s
, 
	`°æí
(s));

884 
	}
}

890 *
	$°rög_f‹m©
(c⁄° *
zF‹m©
,

891 c⁄° *
zDb
, c⁄° *
zName
){

892 c⁄° *
p
;

893 
size_t
 
Àn
 = 0;

894 
size_t
 
nDb
 = 
	`°æí
(
zDb
);

895 
size_t
 
nName
 = 
	`°æí
(
zName
);

896 
size_t
 
nFuŒTabÀName
 = 
nDb
+1+
nName
;

897 *
ªsu…
;

898 *
r
;

901 
p
 = 
zF‹m©
 ; *p ; ++p){

902 
Àn
 +(*
p
=='%' ? 
nFuŒTabÀName
 : 1);

904 
Àn
 += 1;

906 
r
 = 
ªsu…
 = 
	`mÆloc
(
Àn
);

907 
p
 = 
zF‹m©
; *p; ++p){

908 if–*
p
=='%' ){

909 
	`mem˝y
(
r
, 
zDb
, 
nDb
);

910 
r
 +
nDb
;

911 *
r
++ = '.';

912 
	`mem˝y
(
r
, 
zName
, 
nName
);

913 
r
 +
nName
;

915 *
r
++ = *
p
;

918 *
r
++ = '\0';

919 
	`as£π
–
r
 =
ªsu…
 + 
Àn
 );

920  
ªsu…
;

921 
	}
}

923 
	$sql_exec
(
sqlôe4
 *
db
, c⁄° *
zDb
, c⁄° *
zName
,

924 c⁄° *
zF‹m©
){

925 *
zComm™d
 = 
	`°rög_f‹m©
(
zF‹m©
, 
zDb
, 
zName
);

926 
rc
;

927 
	`TRACE
(("FTS1 sql: %s\n", 
zComm™d
));

928 
rc
 = 
	`sqlôe4_exec
(
db
, 
zComm™d
, 
NULL
, 0, NULL);

929 
	`‰ì
(
zComm™d
);

930  
rc
;

931 
	}
}

933 
	$sql_¥ï¨e
(
sqlôe4
 *
db
, c⁄° *
zDb
, c⁄° *
zName
,

934 
sqlôe4_°mt
 **
µStmt
, c⁄° *
zF‹m©
){

935 *
zComm™d
 = 
	`°rög_f‹m©
(
zF‹m©
, 
zDb
, 
zName
);

936 
rc
;

937 
	`TRACE
(("FTS1Öª∑ª: %s\n", 
zComm™d
));

938 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zComm™d
, -1, 
µStmt
, 
NULL
);

939 
	`‰ì
(
zComm™d
);

940  
rc
;

941 
	}
}

946 
fuŒãxt_vèb
 
	tfuŒãxt_vèb
;

951 
	sQuîyTîm
 {

952 
	mnPhø£
;

953 
	miPhø£
;

954 
	miCﬁumn
;

955 sig√d 
	misOr
;

956 sig√d 
	misNŸ
;

957 *
	mpTîm
;

958 
	mnTîm
;

959 } 
	tQuîyTîm
;

990 
	sQuîy
 {

991 
fuŒãxt_vèb
 *
	mpFts
;

992 
	mnTîms
;

993 
QuîyTîm
 *
	mpTîms
;

994 
	m√xtIsOr
;

995 
	m√xtCﬁumn
;

996 
	mdÊtCﬁumn
;

997 } 
	tQuîy
;

1004 
	sSnù≥t
 {

1005 
	mnM©ch
;

1006 
	mnAŒoc
;

1007 
	s¢ù≥tM©ch
 {

1008 
	m¢Sètus
;

1009 
	miCﬁ
;

1010 
	miTîm
;

1011 
	mnByã
;

1012 
	miSèπ
;

1013 } *
	maM©ch
;

1014 *
	mzOff£t
;

1015 
	mnOff£t
;

1016 *
	mzSnù≥t
;

1017 
	mnSnù≥t
;

1018 } 
	tSnù≥t
;

1021 
	eQuîyTy≥
 {

1022 
	mQUERY_GENERIC
,

1023 
	mQUERY_ROWID
,

1024 
	mQUERY_FULLTEXT


1025 } 
	tQuîyTy≥
;

1038 
	#CHUNK_MAX
 256

	)

1040 
	efuŒãxt_°©emít
 {

1041 
	mCONTENT_INSERT_STMT
,

1042 
	mCONTENT_SELECT_STMT
,

1043 
	mCONTENT_UPDATE_STMT
,

1044 
	mCONTENT_DELETE_STMT
,

1046 
	mTERM_SELECT_STMT
,

1047 
	mTERM_SELECT_ALL_STMT
,

1048 
	mTERM_INSERT_STMT
,

1049 
	mTERM_UPDATE_STMT
,

1050 
	mTERM_DELETE_STMT
,

1052 
	mMAX_STMT


1053 } 
	tfuŒãxt_°©emít
;

1061 c⁄° *c⁄° 
	gfuŒãxt_zSèãmít
[
MAX_STMT
] = {

1062  
NULL
,

1064  
NULL
,

1084 
	sfuŒãxt_vèb
 {

1085 
sqlôe4_vèb
 
	mba£
;

1086 
sqlôe4
 *
	mdb
;

1087 c⁄° *
	mzDb
;

1088 c⁄° *
	mzName
;

1089 
	mnCﬁumn
;

1090 **
	mazCﬁumn
;

1091 **
	mazC⁄ã¡Cﬁumn
;

1092 
sqlôe4_tokíizî
 *
	mpTokíizî
;

1097 
sqlôe4_°mt
 *
	mpFuŒãxtSèãmíts
[
MAX_STMT
];

1105 
	sfuŒãxt_curs‹
 {

1106 
sqlôe4_vèb_curs‹
 
	mba£
;

1107 
QuîyTy≥
 
	miCurs‹Ty≥
;

1108 
sqlôe4_°mt
 *
	mpStmt
;

1109 
	meof
;

1110 
Quîy
 
	mq
;

1111 
Snù≥t
 
	m¢ù≥t
;

1112 
	miCﬁumn
;

1113 
DocLi°Ródî
 
	mªsu…
;

1114 } 
	tfuŒãxt_curs‹
;

1116 
fuŒãxt_vèb
 *
	$curs‹_vèb
(
fuŒãxt_curs‹
 *
c
){

1117  (
fuŒãxt_vèb
 *Ë
c
->
ba£
.
pVèb
;

1118 
	}
}

1120 c⁄° 
sqlôe4_moduÀ
 
	gfuŒãxtModuÀ
;

1123 
	$≠≥ndLi°
(
SåögBuf„r
 *
sb
, 
nSåög
, **
azSåög
){

1124 
i
;

1125 
i
=0; i<
nSåög
; ++i){

1126 if–
i
>0 ) 
	`≠≥nd
(
sb
, ", ");

1127 
	`≠≥nd
(
sb
, 
azSåög
[
i
]);

1129 
	}
}

1134 c⁄° *
	$c⁄ã¡In£πSèãmít
(
fuŒãxt_vèb
 *
v
){

1135 
SåögBuf„r
 
sb
;

1136 
i
;

1138 
	`öôSåögBuf„r
(&
sb
);

1139 
	`≠≥nd
(&
sb
, "insert into %_content (rowid, ");

1140 
	`≠≥ndLi°
(&
sb
, 
v
->
nCﬁumn
, v->
azC⁄ã¡Cﬁumn
);

1141 
	`≠≥nd
(&
sb
, ") values (?");

1142 
i
=0; i<
v
->
nCﬁumn
; ++i)

1143 
	`≠≥nd
(&
sb
, ", ?");

1144 
	`≠≥nd
(&
sb
, ")");

1145  
sb
.
s
;

1146 
	}
}

1152 c⁄° *
	$c⁄ã¡Upd©eSèãmít
(
fuŒãxt_vèb
 *
v
){

1153 
SåögBuf„r
 
sb
;

1154 
i
;

1156 
	`öôSåögBuf„r
(&
sb
);

1157 
	`≠≥nd
(&
sb
, "update %_content set ");

1158 
i
=0; i<
v
->
nCﬁumn
; ++i) {

1159 if–
i
>0 ){

1160 
	`≠≥nd
(&
sb
, ", ");

1162 
	`≠≥nd
(&
sb
, 
v
->
azC⁄ã¡Cﬁumn
[
i
]);

1163 
	`≠≥nd
(&
sb
, " = ?");

1165 
	`≠≥nd
(&
sb
, " whereÑowid = ?");

1166  
sb
.
s
;

1167 
	}
}

1173 
	$sql_gë_°©emít
(
fuŒãxt_vèb
 *
v
, 
fuŒãxt_°©emít
 
iStmt
,

1174 
sqlôe4_°mt
 **
µStmt
){

1175 
	`as£π
–
iStmt
<
MAX_STMT
 );

1176 if–
v
->
pFuŒãxtSèãmíts
[
iStmt
]==
NULL
 ){

1177 c⁄° *
zStmt
;

1178 
rc
;

1179  
iStmt
 ){

1180 
CONTENT_INSERT_STMT
:

1181 
zStmt
 = 
	`c⁄ã¡In£πSèãmít
(
v
); ;

1182 
CONTENT_UPDATE_STMT
:

1183 
zStmt
 = 
	`c⁄ã¡Upd©eSèãmít
(
v
); ;

1185 
zStmt
 = 
fuŒãxt_zSèãmít
[
iStmt
];

1187 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zDb
, v->
zName
, &v->
pFuŒãxtSèãmíts
[
iStmt
],

1188 
zStmt
);

1189 if–
zStmt
 !
fuŒãxt_zSèãmít
[
iStmt
]Ë
	`‰ì
((*) zStmt);

1190 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1192 
rc
 = 
	`sqlôe4_ª£t
(
v
->
pFuŒãxtSèãmíts
[
iStmt
]);

1193 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1196 *
µStmt
 = 
v
->
pFuŒãxtSèãmíts
[
iStmt
];

1197  
SQLITE4_OK
;

1198 
	}
}

1206 
	$sql_°ï_°©emít
(
fuŒãxt_vèb
 *
v
, 
fuŒãxt_°©emít
 
iStmt
,

1207 
sqlôe4_°mt
 **
µStmt
){

1208 
rc
;

1209 
sqlôe4_°mt
 *
s
 = *
µStmt
;

1210 
	`as£π
–
iStmt
<
MAX_STMT
 );

1211 
	`as£π
–
s
==
v
->
pFuŒãxtSèãmíts
[
iStmt
] );

1213  (
rc
=
	`sqlôe4_°ï
(
s
))!=
SQLITE4_DONE
 &&Ñc!=
SQLITE4_ROW
 ){

1214 if–
rc
==
SQLITE4_BUSY
 ) ;

1215 if–
rc
!=
SQLITE4_ERROR
 ) Ñc;

1223 
v
->
pFuŒãxtSèãmíts
[
iStmt
] = 
NULL
;

1224 
rc
 = 
	`sqlôe4_föÆize
(
s
);

1227  
rc
;

1229 
îr
:

1230 
	`sqlôe4_föÆize
(
s
);

1231  
rc
;

1232 
	}
}

1237 
	$sql_sögÀ_°ï_°©emít
(
fuŒãxt_vèb
 *
v
,

1238 
fuŒãxt_°©emít
 
iStmt
,

1239 
sqlôe4_°mt
 **
µStmt
){

1240 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
iStmt
, 
µStmt
);

1241  (
rc
==
SQLITE4_DONE
Ë? 
SQLITE4_OK
 :Ñc;

1242 
	}
}

1245 
	$c⁄ã¡_ö£π
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 *
rowid
,

1246 
sqlôe4_vÆue
 **
pVÆues
){

1247 
sqlôe4_°mt
 *
s
;

1248 
i
;

1249 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_INSERT_STMT
, &
s
);

1250 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1252 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 1, 
rowid
);

1253 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1255 
i
=0; i<
v
->
nCﬁumn
; ++i){

1256 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 2+
i
, 
pVÆues
[i]);

1257 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1260  
	`sql_sögÀ_°ï_°©emít
(
v
, 
CONTENT_INSERT_STMT
, &
s
);

1261 
	}
}

1265 
	$c⁄ã¡_upd©e
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 **
pVÆues
,

1266 
sqlôe_öt64
 
iRowid
){

1267 
sqlôe4_°mt
 *
s
;

1268 
i
;

1269 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_UPDATE_STMT
, &
s
);

1270 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1272 
i
=0; i<
v
->
nCﬁumn
; ++i){

1273 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 1+
i
, 
pVÆues
[i]);

1274 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1277 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1+
v
->
nCﬁumn
, 
iRowid
);

1278 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1280  
	`sql_sögÀ_°ï_°©emít
(
v
, 
CONTENT_UPDATE_STMT
, &
s
);

1281 
	}
}

1283 
	$‰ìSåögAºay
(
nSåög
, c⁄° **
pSåög
){

1284 
i
;

1286 
i
=0 ; i < 
nSåög
 ; ++i) {

1287 if–
pSåög
[
i
]!=
NULL
 ) 
	`‰ì
((*)ÖString[i]);

1289 
	`‰ì
((*Ë
pSåög
);

1290 
	}
}

1298 
	$c⁄ã¡_£À˘
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
,

1299 c⁄° ***
pVÆues
){

1300 
sqlôe4_°mt
 *
s
;

1301 c⁄° **
vÆues
;

1302 
i
;

1303 
rc
;

1305 *
pVÆues
 = 
NULL
;

1307 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_SELECT_STMT
, &
s
);

1308 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1310 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iRow
);

1311 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1313 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
CONTENT_SELECT_STMT
, &
s
);

1314 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

1316 
vÆues
 = (c⁄° **Ë
	`mÆloc
(
v
->
nCﬁumn
 * (const *));

1317 
i
=0; i<
v
->
nCﬁumn
; ++i){

1318 if–
	`sqlôe4_cﬁumn_ty≥
(
s
, 
i
)==
SQLITE4_NULL
 ){

1319 
vÆues
[
i
] = 
NULL
;

1321 
vÆues
[
i
] = 
	`°rög_dup
((*)
	`sqlôe4_cﬁumn_ãxt
(
s
, i));

1327 
rc
 = 
	`sqlôe4_°ï
(
s
);

1328 if–
rc
==
SQLITE4_DONE
 ){

1329 *
pVÆues
 = 
vÆues
;

1330  
SQLITE4_OK
;

1333 
	`‰ìSåögAºay
(
v
->
nCﬁumn
, 
vÆues
);

1334  
rc
;

1335 
	}
}

1338 
	$c⁄ã¡_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
){

1339 
sqlôe4_°mt
 *
s
;

1340 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_DELETE_STMT
, &
s
);

1341 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1343 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iRow
);

1344 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1346  
	`sql_sögÀ_°ï_°©emít
(
v
, 
CONTENT_DELETE_STMT
, &
s
);

1347 
	}
}

1353 
	$ãrm_£À˘
(
fuŒãxt_vèb
 *
v
, c⁄° *
pTîm
, 
nTîm
,

1354 
iSegmít
,

1355 
sqlôe_öt64
 *
rowid
, 
DocLi°
 *
out
){

1356 
sqlôe4_°mt
 *
s
;

1357 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_SELECT_STMT
, &
s
);

1358 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1360 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 1, 
pTîm
, 
nTîm
, 
SQLITE4_STATIC
);

1361 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1363 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 2, 
iSegmít
);

1364 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1366 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
TERM_SELECT_STMT
, &
s
);

1367 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

1369 *
rowid
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

1370 
	`docLi°Inô
(
out
, 
DL_DEFAULT
,

1371 
	`sqlôe4_cﬁumn_blob
(
s
, 1), 
	`sqlôe4_cﬁumn_byãs
(s, 1));

1375 
rc
 = 
	`sqlôe4_°ï
(
s
);

1376  
rc
==
SQLITE4_DONE
 ? 
SQLITE4_ROW
 :Ñc;

1377 
	}
}

1390 
	$ãrm_£À˘_Æl
(

1391 
fuŒãxt_vèb
 *
v
,

1392 
iCﬁumn
,

1393 c⁄° *
pTîm
,

1394 
nTîm
,

1395 
DocLi°
 *
out


1397 
DocLi°
 
do˛i°
;

1398 
sqlôe4_°mt
 *
s
;

1399 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_SELECT_ALL_STMT
, &
s
);

1400 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1402 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 1, 
pTîm
, 
nTîm
, 
SQLITE4_STATIC
);

1403 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1405 
	`docLi°Inô
(&
do˛i°
, 
DL_DEFAULT
, 0, 0);

1408  (
rc
=
	`sql_°ï_°©emít
(
v
, 
TERM_SELECT_ALL_STMT
, &
s
))==
SQLITE4_ROW
 ){

1409 
DocLi°
 
ﬁd
;

1417 
	`docLi°Inô
(&
ﬁd
, 
DL_DEFAULT
,

1418 
	`sqlôe4_cﬁumn_blob
(
s
, 0), 
	`sqlôe4_cﬁumn_byãs
(s, 0));

1420 if–
iCﬁumn
<
v
->
nCﬁumn
 ){

1421 
	`docLi°Re°ri˘Cﬁumn
(&
ﬁd
, 
iCﬁumn
);

1427 
	`docLi°Accumuœã
(&
ﬁd
, &
do˛i°
);

1428 
	`docLi°De°roy
(&
do˛i°
);

1429 
do˛i°
 = 
ﬁd
;

1431 if–
rc
!=
SQLITE4_DONE
 ){

1432 
	`docLi°De°roy
(&
do˛i°
);

1433  
rc
;

1436 
	`docLi°DisˇrdEm±y
(&
do˛i°
);

1437 *
out
 = 
do˛i°
;

1438  
SQLITE4_OK
;

1439 
	}
}

1448 
	$ãrm_ö£π
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 *
piRowid
,

1449 c⁄° *
pTîm
, 
nTîm
,

1450 
iSegmít
, 
DocLi°
 *
do˛i°
){

1451 
sqlôe4_°mt
 *
s
;

1452 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_INSERT_STMT
, &
s
);

1453 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1455 if–
piRowid
==
NULL
 ){

1456 
rc
 = 
	`sqlôe4_böd_nuŒ
(
s
, 1);

1458 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, *
piRowid
);

1460 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1462 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 2, 
pTîm
, 
nTîm
, 
SQLITE4_STATIC
);

1463 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1465 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 3, 
iSegmít
);

1466 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1468 
rc
 = 
	`sqlôe4_böd_blob
(
s
, 4, 
do˛i°
->
pD©a
, do˛i°->
nD©a
, 
SQLITE4_STATIC
);

1469 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1471  
	`sql_sögÀ_°ï_°©emít
(
v
, 
TERM_INSERT_STMT
, &
s
);

1472 
	}
}

1475 
	$ãrm_upd©e
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
rowid
,

1476 
DocLi°
 *
do˛i°
){

1477 
sqlôe4_°mt
 *
s
;

1478 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_UPDATE_STMT
, &
s
);

1479 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1481 
rc
 = 
	`sqlôe4_böd_blob
(
s
, 1, 
do˛i°
->
pD©a
, do˛i°->
nD©a
, 
SQLITE4_STATIC
);

1482 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1484 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
rowid
);

1485 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1487  
	`sql_sögÀ_°ï_°©emít
(
v
, 
TERM_UPDATE_STMT
, &
s
);

1488 
	}
}

1490 
	$ãrm_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
rowid
){

1491 
sqlôe4_°mt
 *
s
;

1492 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_DELETE_STMT
, &
s
);

1493 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1495 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
rowid
);

1496 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1498  
	`sql_sögÀ_°ï_°©emít
(
v
, 
TERM_DELETE_STMT
, &
s
);

1499 
	}
}

1504 
	$fuŒãxt_vèb_de°roy
(
fuŒãxt_vèb
 *
v
){

1505 
iStmt
, 
i
;

1507 
	`TRACE
(("FTS1 De°roy %p\n", 
v
));

1508  
iStmt
=0; iStmt<
MAX_STMT
; iStmt++ ){

1509 if–
v
->
pFuŒãxtSèãmíts
[
iStmt
]!=
NULL
 ){

1510 
	`sqlôe4_föÆize
(
v
->
pFuŒãxtSèãmíts
[
iStmt
]);

1511 
v
->
pFuŒãxtSèãmíts
[
iStmt
] = 
NULL
;

1515 if–
v
->
pTokíizî
!=
NULL
 ){

1516 
v
->
pTokíizî
->
pModuÀ
->
	`xDe°roy
(v->pTokenizer);

1517 
v
->
pTokíizî
 = 
NULL
;

1520 
	`‰ì
(
v
->
azCﬁumn
);

1521 
i
 = 0; i < 
v
->
nCﬁumn
; ++i) {

1522 
	`sqlôe4_‰ì
(
v
->
azC⁄ã¡Cﬁumn
[
i
]);

1524 
	`‰ì
(
v
->
azC⁄ã¡Cﬁumn
);

1525 
	`‰ì
(
v
);

1526 
	}
}

1531 
	#TOKEN_EOF
 0

	)

1532 
	#TOKEN_SPACE
 1

	)

1533 
	#TOKEN_ID
 2

	)

1534 
	#TOKEN_STRING
 3

	)

1535 
	#TOKEN_PUNCT
 4

	)

1550 c⁄° 
	gisIdCh¨
[] = {

1559 
	#IdCh¨
(
C
Ë(((
c
=C)&0x80)!=0 || (c>0x1‡&& 
isIdCh¨
[c-0x20]))

	)

1566 
	$gëTokí
(c⁄° *
z
, *
tokíTy≥
){

1567 
i
, 
c
;

1568  *
z
 ){

1570 *
tokíTy≥
 = 
TOKEN_EOF
;

1574 
i
=1; 
	`ß„_is•a˚
(
z
[i]); i++){}

1575 *
tokíTy≥
 = 
TOKEN_SPACE
;

1576  
i
;

1581 
dñim
 = 
z
[0];

1582 
i
=1; (
c
=
z
[i])!=0; i++){

1583 if–
c
==
dñim
 ){

1584 if–
z
[
i
+1]==
dñim
 ){

1585 
i
++;

1591 *
tokíTy≥
 = 
TOKEN_STRING
;

1592  
i
 + (
c
!=0);

1595 
i
=1, 
c
=
z
[0]; c!=']' && (c=z[i])!=0; i++){}

1596 *
tokíTy≥
 = 
TOKEN_ID
;

1597  
i
;

1600 if–!
	`IdCh¨
(*
z
) ){

1603 
i
=1; 
	`IdCh¨
(
z
[i]); i++){}

1604 *
tokíTy≥
 = 
TOKEN_ID
;

1605  
i
;

1608 *
tokíTy≥
 = 
TOKEN_PUNCT
;

1610 
	}
}

1616 
	sTokí
 {

1617 c⁄° *
	mz
;

1618 
	mn
;

1619 } 
	tTokí
;

1634 **
	$tokíizeSåög
(c⁄° *
z
, *
≤Tokí
){

1635 
nTokí
 = 0;

1636 
Tokí
 *
aTokí
 = 
	`mÆloc
–
	`°æí
(
z
) * (aToken[0]) );

1637 
n
 = 1;

1638 
e
, 
i
;

1639 
tŸÆSize
 = 0;

1640 **
azTokí
;

1641 *
zC›y
;

1642  
n
>0 ){

1643 
n
 = 
	`gëTokí
(
z
, &
e
);

1644 if–
e
!=
TOKEN_SPACE
 ){

1645 
aTokí
[
nTokí
].
z
 = z;

1646 
aTokí
[
nTokí
].
n
 =Ç;

1647 
nTokí
++;

1648 
tŸÆSize
 +
n
+1;

1650 
z
 +
n
;

1652 
azTokí
 = (**)
	`mÆloc
–
nTokí
*(*Ë+ 
tŸÆSize
 );

1653 
zC›y
 = (*)&
azTokí
[
nTokí
];

1654 
nTokí
--;

1655 
i
=0; i<
nTokí
; i++){

1656 
azTokí
[
i
] = 
zC›y
;

1657 
n
 = 
aTokí
[
i
].n;

1658 
	`mem˝y
(
zC›y
, 
aTokí
[
i
].
z
, 
n
);

1659 
zC›y
[
n
] = 0;

1660 
zC›y
 +
n
+1;

1662 
azTokí
[
nTokí
] = 0;

1663 
	`‰ì
(
aTokí
);

1664 *
≤Tokí
 = 
nTokí
;

1665  
azTokí
;

1666 
	}
}

1681 
	$dequŸeSåög
(*
z
){

1682 
quŸe
;

1683 
i
, 
j
;

1684 if–
z
==0 ) ;

1685 
quŸe
 = 
z
[0];

1686  
quŸe
 ){

1690 '[': 
quŸe
 = ']'; ;

1693 
i
=1, 
j
=0; 
z
[i]; i++){

1694 if–
z
[
i
]==
quŸe
 ){

1695 if–
z
[
i
+1]==
quŸe
 ){

1696 
z
[
j
++] = 
quŸe
;

1697 
i
++;

1699 
z
[
j
++] = 0;

1703 
z
[
j
++] = z[
i
];

1706 
	}
}

1723 
	$tokíLi°ToIdLi°
(**
azIn
){

1724 
i
, 
j
;

1725 if–
azIn
 ){

1726 
i
=0, 
j
=-1; 
azIn
[i]; i++){

1727 if–
	`ß„_iß um
(
azIn
[
i
][0]) ||ázIn[i][1] ){

1728 
	`dequŸeSåög
(
azIn
[
i
]);

1729 if–
j
>=0 ){

1730 
azIn
[
j
] =ázIn[
i
];

1732 
j
++;

1735 
azIn
[
j
] = 0;

1737 
	}
}

1745 *
	$fú°Tokí
(*
zIn
, **
pzTaû
){

1746 
n
, 
ây≥
;

1748 
n
 = 
	`gëTokí
(
zIn
, &
ây≥
);

1749 if–
ây≥
==
TOKEN_SPACE
 ){

1750 
zIn
 +
n
;

1751 }if–
ây≥
==
TOKEN_EOF
 ){

1752 *
pzTaû
 = 
zIn
;

1755 
zIn
[
n
] = 0;

1756 *
pzTaû
 = &
zIn
[1];

1757 
	`dequŸeSåög
(
zIn
);

1758  
zIn
;

1762 
	}
}

1775 
	$°¨tsWôh
(c⁄° *
s
, c⁄° *
t
){

1776  
	`ß„_is•a˚
(*
s
) ){ s++; }

1777  *
t
 ){

1778 if–
	`ß„_tﬁowî
(*
s
++)!=ß„_tﬁowî(*
t
++) )  0;

1780  *
s
!='_' && !
	`ß„_iß um
(*s);

1781 
	}
}

1788 
	sTabÀS≥c
 {

1789 c⁄° *
	mzDb
;

1790 c⁄° *
	mzName
;

1791 
	mnCﬁumn
;

1792 **
	mazCﬁumn
;

1793 **
	mazC⁄ã¡Cﬁumn
;

1794 **
	mazTokíizî
;

1795 } 
	tTabÀS≥c
;

1800 
	$˛órTabÀS≥c
(
TabÀS≥c
 *
p
) {

1801 
	`‰ì
(
p
->
azCﬁumn
);

1802 
	`‰ì
(
p
->
azC⁄ã¡Cﬁumn
);

1803 
	`‰ì
(
p
->
azTokíizî
);

1804 
	}
}

1814 
	$∑r£S≥c
(
TabÀS≥c
 *
pS≥c
, 
¨gc
, c⁄° *c⁄°*
¨gv
,

1815 **
pzEº
){

1816 
i
, 
n
;

1817 *
z
, *
zDummy
;

1818 **
azArg
;

1819 c⁄° *
zTokíizî
 = 0;

1821 
	`as£π
–
¨gc
>=3 );

1834 
	`mem£t
(
pS≥c
, 0, (*pSpec));

1835 
i
=
n
=0; i<
¨gc
; i++){

1836 
n
 +
	`°æí
(
¨gv
[
i
]) + 1;

1838 
azArg
 = 
	`mÆloc
–(*)*
¨gc
 + 
n
 );

1839 if–
azArg
==0 ){

1840  
SQLITE4_NOMEM
;

1842 
z
 = (*)&
azArg
[
¨gc
];

1843 
i
=0; i<
¨gc
; i++){

1844 
azArg
[
i
] = 
z
;

1845 
	`°r˝y
(
z
, 
¨gv
[
i
]);

1846 
z
 +
	`°æí
(z)+1;

1852 
pS≥c
->
zDb
 = 
azArg
[1];

1853 
pS≥c
->
zName
 = 
azArg
[2];

1854 
pS≥c
->
nCﬁumn
 = 0;

1855 
pS≥c
->
azCﬁumn
 = 
azArg
;

1856 
zTokíizî
 = "tokenize simple";

1857 
i
=3; i<
¨gc
; ++i){

1858 if–
	`°¨tsWôh
(
azArg
[
i
],"tokenize") ){

1859 
zTokíizî
 = 
azArg
[
i
];

1861 
z
 = 
azArg
[
pS≥c
->
nCﬁumn
] = 
	`fú°Tokí
◊zArg[
i
], &
zDummy
);

1862 
pS≥c
->
nCﬁumn
++;

1865 if–
pS≥c
->
nCﬁumn
==0 ){

1866 
azArg
[0] = "content";

1867 
pS≥c
->
nCﬁumn
 = 1;

1883 
pS≥c
->
azC⁄ã¡Cﬁumn
 = 
	`mÆloc
–pS≥c->
nCﬁumn
 * (*) );

1884 if–
pS≥c
->
azC⁄ã¡Cﬁumn
==0 ){

1885 
	`˛órTabÀS≥c
(
pS≥c
);

1886  
SQLITE4_NOMEM
;

1888 
i
=0; i<
pS≥c
->
nCﬁumn
; i++){

1889 *
p
;

1890 
pS≥c
->
azC⁄ã¡Cﬁumn
[
i
] = 
	`sqlôe4_m¥ötf
("c%d%s", i, 
azArg
[i]);

1891 
p
 = 
pS≥c
->
azC⁄ã¡Cﬁumn
[
i
]; *p ; ++p) {

1892 if–!
	`ß„_iß um
(*
p
) ) *p = '_';

1899 
pS≥c
->
azTokíizî
 = 
	`tokíizeSåög
(
zTokíizî
, &
n
);

1900 
	`tokíLi°ToIdLi°
(
pS≥c
->
azTokíizî
);

1902  
SQLITE4_OK
;

1903 
	}
}

1912 *
	$fuŒãxtSchema
(

1913 
nCﬁumn
,

1914 c⁄° *c⁄°* 
azCﬁumn
,

1915 c⁄° *
zTabÀName


1917 
i
;

1918 *
zSchema
, *
zNext
;

1919 c⁄° *
zSï
 = "(";

1920 
zSchema
 = 
	`sqlôe4_m¥ötf
("CREATE TABLE x");

1921 
i
=0; i<
nCﬁumn
; i++){

1922 
zNext
 = 
	`sqlôe4_m¥ötf
("%s%s%Q", 
zSchema
, 
zSï
, 
azCﬁumn
[
i
]);

1923 
	`sqlôe4_‰ì
(
zSchema
);

1924 
zSchema
 = 
zNext
;

1925 
zSï
 = ",";

1927 
zNext
 = 
	`sqlôe4_m¥ötf
("%s,%Q)", 
zSchema
, 
zTabÀName
);

1928 
	`sqlôe4_‰ì
(
zSchema
);

1929  
zNext
;

1930 
	}
}

1936 
	$c⁄°ru˘Vèb
(

1937 
sqlôe4
 *
db
,

1938 
TabÀS≥c
 *
•ec
,

1939 
sqlôe4_vèb
 **
µVTab
,

1940 **
pzEº


1942 
rc
;

1943 
n
;

1944 
fuŒãxt_vèb
 *
v
 = 0;

1945 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
m
 = 
NULL
;

1946 *
schema
;

1948 
v
 = (
fuŒãxt_vèb
 *Ë
	`mÆloc
((fulltext_vtab));

1949 if–
v
==0 )  
SQLITE4_NOMEM
;

1950 
	`mem£t
(
v
, 0, (*v));

1952 
v
->
db
 = db;

1953 
v
->
zDb
 = 
•ec
->zDb;

1954 
v
->
zName
 = 
•ec
->zName;

1955 
v
->
nCﬁumn
 = 
•ec
->nColumn;

1956 
v
->
azC⁄ã¡Cﬁumn
 = 
•ec
->azContentColumn;

1957 
•ec
->
azC⁄ã¡Cﬁumn
 = 0;

1958 
v
->
azCﬁumn
 = 
•ec
->azColumn;

1959 
•ec
->
azCﬁumn
 = 0;

1961 if–
•ec
->
azTokíizî
==0 ){

1962  
SQLITE4_NOMEM
;

1965 if–
•ec
->
azTokíizî
[0]==0 || 
	`°¨tsWôh
(spec->azTokenizer[0], "simple") ){

1966 
	`sqlôe4Fts1Sim∂eTokíizîModuÀ
(&
m
);

1967 }if–
	`°¨tsWôh
(
•ec
->
azTokíizî
[0], "porter") ){

1968 
	`sqlôe4Fts1P‹ãrTokíizîModuÀ
(&
m
);

1970 *
pzEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
•ec
->
azTokíizî
[0]);

1971 
rc
 = 
SQLITE4_ERROR
;

1972 
îr
;

1974 
n
=0; 
•ec
->
azTokíizî
[n];Ç++){}

1975 if–
n
 ){

1976 
rc
 = 
m
->
	`xCª©e
(
n
-1, (c⁄° *c⁄°*)&
•ec
->
azTokíizî
[1],

1977 &
v
->
pTokíizî
);

1979 
rc
 = 
m
->
	`xCª©e
(0, 0, &
v
->
pTokíizî
);

1981 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

1982 
v
->
pTokíizî
->
pModuÀ
 = 
m
;

1986 
schema
 = 
	`fuŒãxtSchema
(
v
->
nCﬁumn
, (c⁄° *c⁄°*)v->
azCﬁumn
,

1987 
•ec
->
zName
);

1988 
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
db
, 
schema
);

1989 
	`sqlôe4_‰ì
(
schema
);

1990 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

1992 
	`mem£t
(
v
->
pFuŒãxtSèãmíts
, 0, (v->pFulltextStatements));

1994 *
µVTab
 = &
v
->
ba£
;

1995 
	`TRACE
(("FTS1 C⁄√˘ %p\n", 
v
));

1997  
rc
;

1999 
îr
:

2000 
	`fuŒãxt_vèb_de°roy
(
v
);

2001  
rc
;

2002 
	}
}

2004 
	$fuŒãxtC⁄√˘
(

2005 
sqlôe4
 *
db
,

2006 *
pAux
,

2007 
¨gc
, c⁄° *c⁄°*
¨gv
,

2008 
sqlôe4_vèb
 **
µVTab
,

2009 **
pzEº


2011 
TabÀS≥c
 
•ec
;

2012 
rc
 = 
	`∑r£S≥c
(&
•ec
, 
¨gc
, 
¨gv
, 
pzEº
);

2013 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2015 
rc
 = 
	`c⁄°ru˘Vèb
(
db
, &
•ec
, 
µVTab
, 
pzEº
);

2016 
	`˛órTabÀS≥c
(&
•ec
);

2017  
rc
;

2018 
	}
}

2055 
	$fuŒãxtCª©e
(
sqlôe4
 *
db
, *
pAux
,

2056 
¨gc
, c⁄° * c⁄° *
¨gv
,

2057 
sqlôe4_vèb
 **
µVTab
, **
pzEº
){

2058 
rc
;

2059 
TabÀS≥c
 
•ec
;

2060 
SåögBuf„r
 
schema
;

2061 
	`TRACE
(("FTS1 Create\n"));

2063 
rc
 = 
	`∑r£S≥c
(&
•ec
, 
¨gc
, 
¨gv
, 
pzEº
);

2064 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2066 
	`öôSåögBuf„r
(&
schema
);

2067 
	`≠≥nd
(&
schema
, "CREATE TABLE %_content(");

2068 
	`≠≥ndLi°
(&
schema
, 
•ec
.
nCﬁumn
, s≥c.
azC⁄ã¡Cﬁumn
);

2069 
	`≠≥nd
(&
schema
, ")");

2070 
rc
 = 
	`sql_exec
(
db
, 
•ec
.
zDb
, s≥c.
zName
, 
schema
.
s
);

2071 
	`‰ì
(
schema
.
s
);

2072 if–
rc
!=
SQLITE4_OK
 ) 
out
;

2074 
rc
 = 
	`sql_exec
(
db
, 
•ec
.
zDb
, s≥c.
zName
,

2077 if–
rc
!=
SQLITE4_OK
 ) 
out
;

2079 
rc
 = 
	`c⁄°ru˘Vèb
(
db
, &
•ec
, 
µVTab
, 
pzEº
);

2081 
out
:

2082 
	`˛órTabÀS≥c
(&
•ec
);

2083  
rc
;

2084 
	}
}

2087 
	$fuŒãxtBe°Index
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_ödex_öfo
 *
pInfo
){

2088 
i
;

2089 
	`TRACE
(("FTS1 BestIndex\n"));

2091 
i
=0; i<
pInfo
->
nC⁄°øöt
; ++i){

2092 c⁄° 
sqlôe4_ödex_c⁄°øöt
 *
pC⁄°øöt
;

2093 
pC⁄°øöt
 = &
pInfo
->
aC⁄°øöt
[
i
];

2094 if–
pC⁄°øöt
->
ußbÀ
 ) {

2095 if–
pC⁄°øöt
->
iCﬁumn
==-1 &&

2096 
pC⁄°øöt
->
›
==
SQLITE4_INDEX_CONSTRAINT_EQ
 ){

2097 
pInfo
->
idxNum
 = 
QUERY_ROWID
;

2098 
	`TRACE
(("FTS1 QUERY_ROWID\n"));

2099 } if–
pC⁄°øöt
->
iCﬁumn
>=0 &&

2100 
pC⁄°øöt
->
›
==
SQLITE4_INDEX_CONSTRAINT_MATCH
 ){

2102 
pInfo
->
idxNum
 = 
QUERY_FULLTEXT
 + 
pC⁄°øöt
->
iCﬁumn
;

2103 
	`TRACE
(("FTS1 QUERY_FULLTEXT %d\n", 
pC⁄°øöt
->
iCﬁumn
));

2106 
pInfo
->
aC⁄°øötUßge
[
i
].
¨gvIndex
 = 1;

2107 
pInfo
->
aC⁄°øötUßge
[
i
].
omô
 = 1;

2112 
pInfo
->
e°im©edCo°
 = 1.0;

2114  
SQLITE4_OK
;

2117 
pInfo
->
idxNum
 = 
QUERY_GENERIC
;

2118  
SQLITE4_OK
;

2119 
	}
}

2121 
	$fuŒãxtDisc⁄√˘
(
sqlôe4_vèb
 *
pVTab
){

2122 
	`TRACE
(("FTS1 Disc⁄√˘ %p\n", 
pVTab
));

2123 
	`fuŒãxt_vèb_de°roy
((
fuŒãxt_vèb
 *)
pVTab
);

2124  
SQLITE4_OK
;

2125 
	}
}

2127 
	$fuŒãxtDe°roy
(
sqlôe4_vèb
 *
pVTab
){

2128 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *)
pVTab
;

2129 
rc
;

2131 
	`TRACE
(("FTS1 De°roy %p\n", 
pVTab
));

2132 
rc
 = 
	`sql_exec
(
v
->
db
, v->
zDb
, v->
zName
,

2136 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2138 
	`fuŒãxt_vèb_de°roy
((
fuŒãxt_vèb
 *)
pVTab
);

2139  
SQLITE4_OK
;

2140 
	}
}

2142 
	$fuŒãxtO≥n
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µCurs‹
){

2143 
fuŒãxt_curs‹
 *
c
;

2145 
c
 = (
fuŒãxt_curs‹
 *Ë
	`ˇŒoc
((fulltext_cursor), 1);

2147 *
µCurs‹
 = &
c
->
ba£
;

2148 
	`TRACE
(("FTS1 O≥¿%p: %p\n", 
pVTab
, 
c
));

2150  
SQLITE4_OK
;

2151 
	}
}

2156 
	$quîyCÀ¨
(
Quîy
 *
q
){

2157 
i
;

2158 
i
 = 0; i < 
q
->
nTîms
; ++i){

2159 
	`‰ì
(
q
->
pTîms
[
i
].
pTîm
);

2161 
	`‰ì
(
q
->
pTîms
);

2162 
	`mem£t
(
q
, 0, (*q));

2163 
	}
}

2168 
	$¢ù≥tCÀ¨
(
Snù≥t
 *
p
){

2169 
	`‰ì
(
p
->
aM©ch
);

2170 
	`‰ì
(
p
->
zOff£t
);

2171 
	`‰ì
(
p
->
zSnù≥t
);

2172 
	`mem£t
(
p
, 0, (*p));

2173 
	}
}

2177 
	$¢ù≥tAµídM©ch
(

2178 
Snù≥t
 *
p
,

2179 
iCﬁ
, 
iTîm
,

2180 
iSèπ
, 
nByã


2182 
i
;

2183 
¢ù≥tM©ch
 *
pM©ch
;

2184 if–
p
->
nM©ch
+1>ı->
nAŒoc
 ){

2185 
p
->
nAŒoc
 =Ö->nAlloc*2 + 10;

2186 
p
->
aM©ch
 = 
	`ªÆloc
’->aM©ch,Ö->
nAŒoc
*(p->aMatch[0]) );

2187 if–
p
->
aM©ch
==0 ){

2188 
p
->
nM©ch
 = 0;

2189 
p
->
nAŒoc
 = 0;

2193 
i
 = 
p
->
nM©ch
++;

2194 
pM©ch
 = &
p
->
aM©ch
[
i
];

2195 
pM©ch
->
iCﬁ
 = iCol;

2196 
pM©ch
->
iTîm
 = iTerm;

2197 
pM©ch
->
iSèπ
 = iStart;

2198 
pM©ch
->
nByã
 =ÇByte;

2199 
	}
}

2204 
	#FTS1_ROTOR_SZ
 (32)

	)

2205 
	#FTS1_ROTOR_MASK
 (
FTS1_ROTOR_SZ
-1)

	)

2211 
	$¢ù≥tOff£tsOfCﬁumn
(

2212 
Quîy
 *
pQuîy
,

2213 
Snù≥t
 *
pSnù≥t
,

2214 
iCﬁumn
,

2215 c⁄° *
zDoc
,

2216 
nDoc


2218 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pTModuÀ
;

2219 
sqlôe4_tokíizî
 *
pTokíizî
;

2220 
sqlôe4_tokíizî_curs‹
 *
pTCurs‹
;

2221 
fuŒãxt_vèb
 *
pVèb
;

2222 
nCﬁumn
;

2223 c⁄° 
QuîyTîm
 *
aTîm
;

2224 
nTîm
;

2225 
i
, 
j
;

2226 
rc
;

2227 
m©ch
, 
¥evM©ch
;

2228 c⁄° *
zTokí
;

2229 
nTokí
;

2230 
iBegö
, 
iEnd
, 
iPos
;

2234 
iRŸ‹
 = 0;

2235 
iRŸ‹Begö
[
FTS1_ROTOR_SZ
];

2236 
iRŸ‹Lí
[
FTS1_ROTOR_SZ
];

2238 
pVèb
 = 
pQuîy
->
pFts
;

2239 
nCﬁumn
 = 
pVèb
->nColumn;

2240 
pTokíizî
 = 
pVèb
->pTokenizer;

2241 
pTModuÀ
 = 
pTokíizî
->
pModuÀ
;

2242 
rc
 = 
pTModuÀ
->
	`xO≥n
(
pTokíizî
, 
zDoc
, 
nDoc
, &
pTCurs‹
);

2243 if–
rc
 ) ;

2244 
pTCurs‹
->
pTokíizî
 =ÖTokenizer;

2245 
aTîm
 = 
pQuîy
->
pTîms
;

2246 
nTîm
 = 
pQuîy
->
nTîms
;

2247 if–
nTîm
>=
FTS1_ROTOR_SZ
 ){

2248 
nTîm
 = 
FTS1_ROTOR_SZ
 - 1;

2250 
¥evM©ch
 = 0;

2252 
rc
 = 
pTModuÀ
->
	`xNext
(
pTCurs‹
, &
zTokí
, &
nTokí
, &
iBegö
, &
iEnd
, &
iPos
);

2253 if–
rc
 ) ;

2254 
iRŸ‹Begö
[
iRŸ‹
&
FTS1_ROTOR_MASK
] = 
iBegö
;

2255 
iRŸ‹Lí
[
iRŸ‹
&
FTS1_ROTOR_MASK
] = 
iEnd
-
iBegö
;

2256 
m©ch
 = 0;

2257 
i
=0; i<
nTîm
; i++){

2258 
iCﬁ
;

2259 
iCﬁ
 = 
aTîm
[
i
].
iCﬁumn
;

2260 if–
iCﬁ
>=0 && iCﬁ<
nCﬁumn
 && iCﬁ!=
iCﬁumn
 ) ;

2261 if–
aTîm
[
i
].
nTîm
!=
nTokí
 ) ;

2262 if–
	`memcmp
(
aTîm
[
i
].
pTîm
, 
zTokí
, 
nTokí
) ) ;

2263 if–
aTîm
[
i
].
iPhø£
>1 && (
¥evM©ch
 & (1<<i))==0 ) ;

2264 
m©ch
 |1<<
i
;

2265 if–
i
==
nTîm
-1 || 
aTîm
[i+1].
iPhø£
==1 ){

2266 
j
=
aTîm
[
i
].
iPhø£
-1; j>=0; j--){

2267 
k
 = (
iRŸ‹
-
j
Ë& 
FTS1_ROTOR_MASK
;

2268 
	`¢ù≥tAµídM©ch
(
pSnù≥t
, 
iCﬁumn
, 
i
-
j
,

2269 
iRŸ‹Begö
[
k
], 
iRŸ‹Lí
[k]);

2273 
¥evM©ch
 = 
m©ch
<<1;

2274 
iRŸ‹
++;

2276 
pTModuÀ
->
	`xClo£
(
pTCurs‹
);

2277 
	}
}

2284 
	$¢ù≥tAŒOff£ts
(
fuŒãxt_curs‹
 *
p
){

2285 
nCﬁumn
;

2286 
iCﬁumn
, 
i
;

2287 
iFú°
, 
iLa°
;

2288 
fuŒãxt_vèb
 *
pFts
;

2290 if–
p
->
¢ù≥t
.
nM©ch
 ) ;

2291 if–
p
->
q
.
nTîms
==0 ) ;

2292 
pFts
 = 
p
->
q
.pFts;

2293 
nCﬁumn
 = 
pFts
->nColumn;

2294 
iCﬁumn
 = 
p
->
iCurs‹Ty≥
 - 
QUERY_FULLTEXT
;

2295 if–
iCﬁumn
<0 || iCﬁumn>=
nCﬁumn
 ){

2296 
iFú°
 = 0;

2297 
iLa°
 = 
nCﬁumn
-1;

2299 
iFú°
 = 
iCﬁumn
;

2300 
iLa°
 = 
iCﬁumn
;

2302 
i
=
iFú°
; i<=
iLa°
; i++){

2303 c⁄° *
zDoc
;

2304 
nDoc
;

2305 
zDoc
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
p
->
pStmt
, 
i
+1);

2306 
nDoc
 = 
	`sqlôe4_cﬁumn_byãs
(
p
->
pStmt
, 
i
+1);

2307 
	`¢ù≥tOff£tsOfCﬁumn
(&
p
->
q
, &p->
¢ù≥t
, 
i
, 
zDoc
, 
nDoc
);

2309 
	}
}

2315 
	$¢ù≥tOff£tText
(
Snù≥t
 *
p
){

2316 
i
;

2317 
˙t
 = 0;

2318 
SåögBuf„r
 
sb
;

2319 
zBuf
[200];

2320 if–
p
->
zOff£t
 ) ;

2321 
	`öôSåögBuf„r
(&
sb
);

2322 
i
=0; i<
p
->
nM©ch
; i++){

2323 
¢ù≥tM©ch
 *
pM©ch
 = &
p
->
aM©ch
[
i
];

2324 
zBuf
[0] = ' ';

2325 
	`sqlôe4_¢¥ötf
((
zBuf
)-1, &zBuf[
˙t
>0], "%d %d %d %d",

2326 
pM©ch
->
iCﬁ
,ÖM©ch->
iTîm
,ÖM©ch->
iSèπ
,ÖM©ch->
nByã
);

2327 
	`≠≥nd
(&
sb
, 
zBuf
);

2328 
˙t
++;

2330 
p
->
zOff£t
 = 
sb
.
s
;

2331 
p
->
nOff£t
 = 
sb
.
Àn
;

2332 
	}
}

2343 
	$w‹dBound¨y
(

2344 
iBªak
,

2345 c⁄° *
zDoc
,

2346 
nDoc
,

2347 
¢ù≥tM©ch
 *
aM©ch
,

2348 
nM©ch
,

2349 
iCﬁ


2351 
i
;

2352 if–
iBªak
<=10 ){

2355 if–
iBªak
>=
nDoc
-10 ){

2356  
nDoc
;

2358 
i
=0; i<
nM©ch
 && 
aM©ch
[i].
iCﬁ
<iCol; i++){}

2359  
i
<
nM©ch
 && 
aM©ch
[i].
iSèπ
+aM©ch[i].
nByã
<
iBªak
 ){ i++; }

2360 if–
i
<
nM©ch
 ){

2361 if–
aM©ch
[
i
].
iSèπ
<
iBªak
+10 ){

2362  
aM©ch
[
i
].
iSèπ
;

2364 if–
i
>0 && 
aM©ch
[i-1].
iSèπ
+aM©ch[i-1].
nByã
>=
iBªak
 ){

2365  
aM©ch
[
i
-1].
iSèπ
;

2368 
i
=1; i<=10; i++){

2369 if–
	`ß„_is•a˚
(
zDoc
[
iBªak
-
i
]) ){

2370  
iBªak
 - 
i
 + 1;

2372 if–
	`ß„_is•a˚
(
zDoc
[
iBªak
+
i
]) ){

2373  
iBªak
 + 
i
 + 1;

2376  
iBªak
;

2377 
	}
}

2383 
	$≠≥ndWhôeS∑˚
(
SåögBuf„r
 *
p
){

2384 if–
p
->
Àn
==0 ) ;

2385 if–
	`ß„_is•a˚
(
p
->
s
[p->
Àn
-1]) ) ;

2386 
	`≠≥nd
(
p
, " ");

2387 
	}
}

2392 
	$åimWhôeS∑˚
(
SåögBuf„r
 *
p
){

2393  
p
->
Àn
>0 && 
	`ß„_is•a˚
’->
s
[p->len-1]) ){

2394 
p
->
Àn
--;

2396 
	}
}

2403 
	#SNIPPET_IGNORE
 0

	)

2404 
	#SNIPPET_DESIRED
 1

	)

2409 
	$¢ù≥tText
(

2410 
fuŒãxt_curs‹
 *
pCurs‹
,

2411 c⁄° *
zSèπM¨k
,

2412 c⁄° *
zEndM¨k
,

2413 c⁄° *
zEŒùsis


2415 
i
, 
j
;

2416 
¢ù≥tM©ch
 *
aM©ch
;

2417 
nM©ch
;

2418 
nDesúed
;

2419 
SåögBuf„r
 
sb
;

2420 
èûCﬁ
;

2421 
èûOff£t
;

2422 
iCﬁ
;

2423 
nDoc
;

2424 c⁄° *
zDoc
;

2425 
iSèπ
, 
iEnd
;

2426 
èûEŒùsis
 = 0;

2427 
iM©ch
;

2430 
	`‰ì
(
pCurs‹
->
¢ù≥t
.
zSnù≥t
);

2431 
pCurs‹
->
¢ù≥t
.
zSnù≥t
 = 0;

2432 
aM©ch
 = 
pCurs‹
->
¢ù≥t
.aMatch;

2433 
nM©ch
 = 
pCurs‹
->
¢ù≥t
.nMatch;

2434 
	`öôSåögBuf„r
(&
sb
);

2436 
i
=0; i<
nM©ch
; i++){

2437 
aM©ch
[
i
].
¢Sètus
 = 
SNIPPET_IGNORE
;

2439 
nDesúed
 = 0;

2440 
i
=0; i<
pCurs‹
->
q
.
nTîms
; i++){

2441 
j
=0; j<
nM©ch
; j++){

2442 if–
aM©ch
[
j
].
iTîm
==
i
 ){

2443 
aM©ch
[
j
].
¢Sètus
 = 
SNIPPET_DESIRED
;

2444 
nDesúed
++;

2450 
iM©ch
 = 0;

2451 
èûCﬁ
 = -1;

2452 
èûOff£t
 = 0;

2453 
i
=0; i<
nM©ch
 && 
nDesúed
>0; i++){

2454 if–
aM©ch
[
i
].
¢Sètus
!=
SNIPPET_DESIRED
 ) ;

2455 
nDesúed
--;

2456 
iCﬁ
 = 
aM©ch
[
i
].iCol;

2457 
zDoc
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pCurs‹
->
pStmt
, 
iCﬁ
+1);

2458 
nDoc
 = 
	`sqlôe4_cﬁumn_byãs
(
pCurs‹
->
pStmt
, 
iCﬁ
+1);

2459 
iSèπ
 = 
aM©ch
[
i
].iStart - 40;

2460 
iSèπ
 = 
	`w‹dBound¨y
(iSèπ, 
zDoc
, 
nDoc
, 
aM©ch
, 
nM©ch
, 
iCﬁ
);

2461 if–
iSèπ
<=10 ){

2462 
iSèπ
 = 0;

2464 if–
iCﬁ
==
èûCﬁ
 && 
iSèπ
<=
èûOff£t
+20 ){

2465 
iSèπ
 = 
èûOff£t
;

2467 if–(
iCﬁ
!=
èûCﬁ
 &&ÅaûCﬁ>=0Ë|| 
iSèπ
!=
èûOff£t
 ){

2468 
	`åimWhôeS∑˚
(&
sb
);

2469 
	`≠≥ndWhôeS∑˚
(&
sb
);

2470 
	`≠≥nd
(&
sb
, 
zEŒùsis
);

2471 
	`≠≥ndWhôeS∑˚
(&
sb
);

2473 
iEnd
 = 
aM©ch
[
i
].
iSèπ
 +áM©ch[i].
nByã
 + 40;

2474 
iEnd
 = 
	`w‹dBound¨y
(iEnd, 
zDoc
, 
nDoc
, 
aM©ch
, 
nM©ch
, 
iCﬁ
);

2475 if–
iEnd
>=
nDoc
-10 ){

2476 
iEnd
 = 
nDoc
;

2477 
èûEŒùsis
 = 0;

2479 
èûEŒùsis
 = 1;

2481  
iM©ch
<
nM©ch
 && 
aM©ch
[iM©ch].
iCﬁ
<iCol ){ iMatch++; }

2482  
iSèπ
<
iEnd
 ){

2483  
iM©ch
<
nM©ch
 && 
aM©ch
[iM©ch].
iSèπ
<iStart

2484 && 
aM©ch
[
iM©ch
].
iCﬁ
<=iCol ){

2485 
iM©ch
++;

2487 if–
iM©ch
<
nM©ch
 && 
aM©ch
[iM©ch].
iSèπ
<
iEnd


2488 && 
aM©ch
[
iM©ch
].
iCﬁ
==iCol ){

2489 
	`«µíd
(&
sb
, &
zDoc
[
iSèπ
], 
aM©ch
[
iM©ch
].iStart - iStart);

2490 
iSèπ
 = 
aM©ch
[
iM©ch
].iStart;

2491 
	`≠≥nd
(&
sb
, 
zSèπM¨k
);

2492 
	`«µíd
(&
sb
, &
zDoc
[
iSèπ
], 
aM©ch
[
iM©ch
].
nByã
);

2493 
	`≠≥nd
(&
sb
, 
zEndM¨k
);

2494 
iSèπ
 +
aM©ch
[
iM©ch
].
nByã
;

2495 
j
=
iM©ch
+1; j<
nM©ch
; j++){

2496 if–
aM©ch
[
j
].
iTîm
=˜M©ch[
iM©ch
].iTerm

2497 && 
aM©ch
[
j
].
¢Sètus
==
SNIPPET_DESIRED
 ){

2498 
nDesúed
--;

2499 
aM©ch
[
j
].
¢Sètus
 = 
SNIPPET_IGNORE
;

2503 
	`«µíd
(&
sb
, &
zDoc
[
iSèπ
], 
iEnd
 - iStart);

2504 
iSèπ
 = 
iEnd
;

2507 
èûCﬁ
 = 
iCﬁ
;

2508 
èûOff£t
 = 
iEnd
;

2510 
	`åimWhôeS∑˚
(&
sb
);

2511 if–
èûEŒùsis
 ){

2512 
	`≠≥ndWhôeS∑˚
(&
sb
);

2513 
	`≠≥nd
(&
sb
, 
zEŒùsis
);

2515 
pCurs‹
->
¢ù≥t
.
zSnù≥t
 = 
sb
.
s
;

2516 
pCurs‹
->
¢ù≥t
.
nSnù≥t
 = 
sb
.
Àn
;

2517 
	}
}

2524 
	$fuŒãxtClo£
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

2525 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

2526 
	`TRACE
(("FTS1 Clo£ %p\n", 
c
));

2527 
	`sqlôe4_föÆize
(
c
->
pStmt
);

2528 
	`quîyCÀ¨
(&
c
->
q
);

2529 
	`¢ù≥tCÀ¨
(&
c
->
¢ù≥t
);

2530 if–
c
->
ªsu…
.
pDo˛i°
!=
NULL
 ){

2531 
	`docLi°Dñëe
(
c
->
ªsu…
.
pDo˛i°
);

2533 
	`‰ì
(
c
);

2534  
SQLITE4_OK
;

2535 
	}
}

2537 
	$fuŒãxtNext
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

2538 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

2539 
sqlôe_öt64
 
iDocid
;

2540 
rc
;

2542 
	`TRACE
(("FTS1 Nexà%p\n", 
pCurs‹
));

2543 
	`¢ù≥tCÀ¨
(&
c
->
¢ù≥t
);

2544 if–
c
->
iCurs‹Ty≥
 < 
QUERY_FULLTEXT
 ){

2546 
rc
 = 
	`sqlôe4_°ï
(
c
->
pStmt
);

2547  
rc
 ){

2548 
SQLITE4_ROW
:

2549 
c
->
eof
 = 0;

2550  
SQLITE4_OK
;

2551 
SQLITE4_DONE
:

2552 
c
->
eof
 = 1;

2553  
SQLITE4_OK
;

2555 
c
->
eof
 = 1;

2556  
rc
;

2559 
rc
 = 
	`sqlôe4_ª£t
(
c
->
pStmt
);

2560 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2562 
iDocid
 = 
	`√xtDocid
(&
c
->
ªsu…
);

2563 if–
iDocid
==0 ){

2564 
c
->
eof
 = 1;

2565  
SQLITE4_OK
;

2567 
rc
 = 
	`sqlôe4_böd_öt64
(
c
->
pStmt
, 1, 
iDocid
);

2568 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2570 
rc
 = 
	`sqlôe4_°ï
(
c
->
pStmt
);

2571 if–
rc
==
SQLITE4_ROW
 ){

2572 
c
->
eof
 = 0;

2573  
SQLITE4_OK
;

2576  
rc
==
SQLITE4_DONE
 ? 
SQLITE4_ERROR
 :Ñc;

2578 
	}
}

2587 
	$docLi°OfTîm
(

2588 
fuŒãxt_vèb
 *
v
,

2589 
iCﬁumn
,

2590 
QuîyTîm
 *
pQTîm
,

2591 
DocLi°
 **
µResu…


2593 
DocLi°
 *
pLe·
, *
pRight
, *
pNew
;

2594 
i
, 
rc
;

2596 
pLe·
 = 
	`docLi°New
(
DL_POSITIONS
);

2597 
rc
 = 
	`ãrm_£À˘_Æl
(
v
, 
iCﬁumn
, 
pQTîm
->
pTîm
,ÖQTîm->
nTîm
, 
pLe·
);

2598 if–
rc
 ){

2599 
	`docLi°Dñëe
(
pLe·
);

2600  
rc
;

2602 
i
=1; i<=
pQTîm
->
nPhø£
; i++){

2603 
pRight
 = 
	`docLi°New
(
DL_POSITIONS
);

2604 
rc
 = 
	`ãrm_£À˘_Æl
(
v
, 
iCﬁumn
, 
pQTîm
[
i
].
pTîm
,ÖQTîm[i].
nTîm
, 
pRight
);

2605 if–
rc
 ){

2606 
	`docLi°Dñëe
(
pLe·
);

2607  
rc
;

2609 
pNew
 = 
	`docLi°New
(
i
<
pQTîm
->
nPhø£
 ? 
DL_POSITIONS
 : 
DL_DOCIDS
);

2610 
	`docLi°Phø£Mîge
(
pLe·
, 
pRight
, 
pNew
);

2611 
	`docLi°Dñëe
(
pLe·
);

2612 
	`docLi°Dñëe
(
pRight
);

2613 
pLe·
 = 
pNew
;

2615 *
µResu…
 = 
pLe·
;

2616  
SQLITE4_OK
;

2617 
	}
}

2621 
	$quîyAdd
(
Quîy
 *
q
, c⁄° *
pTîm
, 
nTîm
){

2622 
QuîyTîm
 *
t
;

2623 ++
q
->
nTîms
;

2624 
q
->
pTîms
 = 
	`ªÆloc
(q->pTîms, q->
nTîms
 * (q->pTerms[0]));

2625 if–
q
->
pTîms
==0 ){

2626 
q
->
nTîms
 = 0;

2629 
t
 = &
q
->
pTîms
[q->
nTîms
 - 1];

2630 
	`mem£t
(
t
, 0, (*t));

2631 
t
->
pTîm
 = 
	`mÆloc
(
nTîm
+1);

2632 
	`mem˝y
(
t
->
pTîm
,ÖTîm, 
nTîm
);

2633 
t
->
pTîm
[
nTîm
] = 0;

2634 
t
->
nTîm
 =ÇTerm;

2635 
t
->
isOr
 = 
q
->
√xtIsOr
;

2636 
q
->
√xtIsOr
 = 0;

2637 
t
->
iCﬁumn
 = 
q
->
√xtCﬁumn
;

2638 
q
->
√xtCﬁumn
 = q->
dÊtCﬁumn
;

2639 
	}
}

2646 
	$checkCﬁumnS≥cifõr
(

2647 
fuŒãxt_vèb
 *
pVèb
,

2648 c⁄° *
zTokí
,

2649 
nTokí


2651 
i
;

2652 
i
=0; i<
pVèb
->
nCﬁumn
; i++){

2653 if–
	`memcmp
(
pVèb
->
azCﬁumn
[
i
], 
zTokí
, 
nTokí
)==0

2654 && 
pVèb
->
azCﬁumn
[
i
][
nTokí
]==0 ){

2655  
i
;

2659 
	}
}

2671 
	$tokíizeSegmít
(

2672 
sqlôe4_tokíizî
 *
pTokíizî
,

2673 c⁄° *
pSegmít
, 
nSegmít
,

2674 
öPhø£
,

2675 
Quîy
 *
pQuîy


2677 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pModuÀ
 = 
pTokíizî
->pModule;

2678 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

2679 
fú°Index
 = 
pQuîy
->
nTîms
;

2680 
iCﬁ
;

2681 
nTîm
 = 1;

2683 
rc
 = 
pModuÀ
->
	`xO≥n
(
pTokíizî
, 
pSegmít
, 
nSegmít
, &
pCurs‹
);

2684 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2685 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

2688 c⁄° *
pTokí
;

2689 
nTokí
, 
iBegö
, 
iEnd
, 
iPos
;

2691 
rc
 = 
pModuÀ
->
	`xNext
(
pCurs‹
,

2692 &
pTokí
, &
nTokí
,

2693 &
iBegö
, &
iEnd
, &
iPos
);

2694 if–
rc
!=
SQLITE4_OK
 ) ;

2695 if–!
öPhø£
 &&

2696 
pSegmít
[
iEnd
]==':' &&

2697 (
iCﬁ
 = 
	`checkCﬁumnS≥cifõr
(
pQuîy
->
pFts
, 
pTokí
, 
nTokí
))>=0 ){

2698 
pQuîy
->
√xtCﬁumn
 = 
iCﬁ
;

2701 if–!
öPhø£
 && 
pQuîy
->
nTîms
>0 && 
nTokí
==2

2702 && 
pSegmít
[
iBegö
]=='O' &&ÖSegment[iBegin+1]=='R' ){

2703 
pQuîy
->
√xtIsOr
 = 1;

2706 
	`quîyAdd
(
pQuîy
, 
pTokí
, 
nTokí
);

2707 if–!
öPhø£
 && 
iBegö
>0 && 
pSegmít
[iBegin-1]=='-' ){

2708 
pQuîy
->
pTîms
[pQuîy->
nTîms
-1].
isNŸ
 = 1;

2710 
pQuîy
->
pTîms
[pQuîy->
nTîms
-1].
iPhø£
 = 
nTîm
;

2711 if–
öPhø£
 ){

2712 
nTîm
++;

2716 if–
öPhø£
 && 
pQuîy
->
nTîms
>
fú°Index
 ){

2717 
pQuîy
->
pTîms
[
fú°Index
].
nPhø£
 =ÖQuîy->
nTîms
 - firstIndex - 1;

2720  
pModuÀ
->
	`xClo£
(
pCurs‹
);

2721 
	}
}

2728 
	$∑r£Quîy
(

2729 
fuŒãxt_vèb
 *
v
,

2730 c⁄° *
zI≈ut
,

2731 
nI≈ut
,

2732 
dÊtCﬁumn
,

2733 
Quîy
 *
pQuîy


2735 
iI≈ut
, 
öPhø£
 = 0;

2737 if–
zI≈ut
==0 ) 
nI≈ut
 = 0;

2738 if–
nI≈ut
<0 )ÇI≈uà
	`°æí
(
zI≈ut
);

2739 
pQuîy
->
nTîms
 = 0;

2740 
pQuîy
->
pTîms
 = 
NULL
;

2741 
pQuîy
->
√xtIsOr
 = 0;

2742 
pQuîy
->
√xtCﬁumn
 = 
dÊtCﬁumn
;

2743 
pQuîy
->
dÊtCﬁumn
 = dfltColumn;

2744 
pQuîy
->
pFts
 = 
v
;

2746 
iI≈ut
=0; iI≈ut<
nI≈ut
; ++iInput){

2747 
i
;

2748 
i
=
iI≈ut
; i<
nI≈ut
 && 
zI≈ut
[i]!='"'; ++i){}

2749 if–
i
>
iI≈ut
 ){

2750 
	`tokíizeSegmít
(
v
->
pTokíizî
, 
zI≈ut
+
iI≈ut
, 
i
-iI≈ut, 
öPhø£
,

2751 
pQuîy
);

2753 
iI≈ut
 = 
i
;

2754 if–
i
<
nI≈ut
 ){

2755 
	`as£π
–
zI≈ut
[
i
]=='"' );

2756 
öPhø£
 = !inPhrase;

2760 if–
öPhø£
 ){

2762 
	`quîyCÀ¨
(
pQuîy
);

2763  
SQLITE4_ERROR
;

2765  
SQLITE4_OK
;

2766 
	}
}

2775 
	$fuŒãxtQuîy
(

2776 
fuŒãxt_vèb
 *
v
,

2777 
iCﬁumn
,

2778 c⁄° *
zI≈ut
,

2779 
nI≈ut
,

2780 
DocLi°
 **
pResu…
,

2781 
Quîy
 *
pQuîy


2783 
i
, 
iNext
, 
rc
;

2784 
DocLi°
 *
pLe·
 = 
NULL
;

2785 
DocLi°
 *
pRight
, *
pNew
, *
pOr
;

2786 
nNŸ
 = 0;

2787 
QuîyTîm
 *
aTîm
;

2789 
rc
 = 
	`∑r£Quîy
(
v
, 
zI≈ut
, 
nI≈ut
, 
iCﬁumn
, 
pQuîy
);

2790 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2793 
aTîm
 = 
pQuîy
->
pTîms
;

2794 
i
 = 0; i<
pQuîy
->
nTîms
; i=
iNext
){

2795 if–
aTîm
[
i
].
isNŸ
 ){

2797 
nNŸ
++;

2798 
iNext
 = 
i
 + 
aTîm
[i].
nPhø£
+1;

2801 
iNext
 = 
i
 + 
aTîm
[i].
nPhø£
 + 1;

2802 
rc
 = 
	`docLi°OfTîm
(
v
, 
aTîm
[
i
].
iCﬁumn
, &aTîm[i], &
pRight
);

2803 if–
rc
 ){

2804 
	`quîyCÀ¨
(
pQuîy
);

2805  
rc
;

2807  
iNext
<
pQuîy
->
nTîms
 && 
aTîm
[iNext].
isOr
 ){

2808 
rc
 = 
	`docLi°OfTîm
(
v
, 
aTîm
[
iNext
].
iCﬁumn
, &aTîm[iNext], &
pOr
);

2809 
iNext
 +
aTîm
[iNext].
nPhø£
 + 1;

2810 if–
rc
 ){

2811 
	`quîyCÀ¨
(
pQuîy
);

2812  
rc
;

2814 
pNew
 = 
	`docLi°New
(
DL_DOCIDS
);

2815 
	`docLi°OrMîge
(
pRight
, 
pOr
, 
pNew
);

2816 
	`docLi°Dñëe
(
pRight
);

2817 
	`docLi°Dñëe
(
pOr
);

2818 
pRight
 = 
pNew
;

2820 if–
pLe·
==0 ){

2821 
pLe·
 = 
pRight
;

2823 
pNew
 = 
	`docLi°New
(
DL_DOCIDS
);

2824 
	`docLi°AndMîge
(
pLe·
, 
pRight
, 
pNew
);

2825 
	`docLi°Dñëe
(
pRight
);

2826 
	`docLi°Dñëe
(
pLe·
);

2827 
pLe·
 = 
pNew
;

2831 if–
nNŸ
 && 
pLe·
==0 ){

2833  
SQLITE4_ERROR
;

2837 
i
=0; i<
pQuîy
->
nTîms
; i +
aTîm
[i].
nPhø£
 + 1){

2838 if–!
aTîm
[
i
].
isNŸ
 ) ;

2839 
rc
 = 
	`docLi°OfTîm
(
v
, 
aTîm
[
i
].
iCﬁumn
, &aTîm[i], &
pRight
);

2840 if–
rc
 ){

2841 
	`quîyCÀ¨
(
pQuîy
);

2842 
	`docLi°Dñëe
(
pLe·
);

2843  
rc
;

2845 
pNew
 = 
	`docLi°New
(
DL_DOCIDS
);

2846 
	`docLi°Ex˚±Mîge
(
pLe·
, 
pRight
, 
pNew
);

2847 
	`docLi°Dñëe
(
pRight
);

2848 
	`docLi°Dñëe
(
pLe·
);

2849 
pLe·
 = 
pNew
;

2852 *
pResu…
 = 
pLe·
;

2853  
rc
;

2854 
	}
}

2877 
	$fuŒãxtFûãr
(

2878 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

2879 
idxNum
, c⁄° *
idxSå
,

2880 
¨gc
, 
sqlôe4_vÆue
 **
¨gv


2882 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

2883 
fuŒãxt_vèb
 *
v
 = 
	`curs‹_vèb
(
c
);

2884 
rc
;

2885 *
zSql
;

2887 
	`TRACE
(("FTS1 Fûã∏%p\n",
pCurs‹
));

2889 
zSql
 = 
	`sqlôe4_m¥ötf
("selectÑowid, * from %%_content %s",

2890 
idxNum
==
QUERY_GENERIC
 ? "" : "whereÑowid=?");

2891 
	`sqlôe4_föÆize
(
c
->
pStmt
);

2892 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zDb
, v->
zName
, &
c
->
pStmt
, 
zSql
);

2893 
	`sqlôe4_‰ì
(
zSql
);

2894 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2896 
c
->
iCurs‹Ty≥
 = 
idxNum
;

2897  
idxNum
 ){

2898 
QUERY_GENERIC
:

2901 
QUERY_ROWID
:

2902 
rc
 = 
	`sqlôe4_böd_öt64
(
c
->
pStmt
, 1, 
	`sqlôe4_vÆue_öt64
(
¨gv
[0]));

2903 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2908 c⁄° *
zQuîy
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

2909 
DocLi°
 *
pResu…
;

2910 
	`as£π
–
idxNum
<=
QUERY_FULLTEXT
+
v
->
nCﬁumn
);

2911 
	`as£π
–
¨gc
==1 );

2912 
	`quîyCÀ¨
(&
c
->
q
);

2913 
rc
 = 
	`fuŒãxtQuîy
(
v
, 
idxNum
-
QUERY_FULLTEXT
, 
zQuîy
, -1, &
pResu…
, &
c
->
q
);

2914 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2915 if–
c
->
ªsu…
.
pDo˛i°
!=
NULL
 ) 
	`docLi°Dñëe
(c->result.pDoclist);

2916 
	`ªadîInô
(&
c
->
ªsu…
, 
pResu…
);

2921  
	`fuŒãxtNext
(
pCurs‹
);

2922 
	}
}

2928 
	$fuŒãxtEof
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

2929 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

2930  
c
->
eof
;

2931 
	}
}

2939 
	$fuŒãxtCﬁumn
(
sqlôe4_vèb_curs‹
 *
pCurs‹
,

2940 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
, 
idxCﬁ
){

2941 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

2942 
fuŒãxt_vèb
 *
v
 = 
	`curs‹_vèb
(
c
);

2944 if–
idxCﬁ
<
v
->
nCﬁumn
 ){

2945 
sqlôe4_vÆue
 *
pVÆ
 = 
	`sqlôe4_cﬁumn_vÆue
(
c
->
pStmt
, 
idxCﬁ
+1);

2946 
	`sqlôe4_ªsu…_vÆue
(
pC⁄ãxt
, 
pVÆ
);

2947 }if–
idxCﬁ
==
v
->
nCﬁumn
 ){

2951 
	`sqlôe4_ªsu…_blob
(
pC⁄ãxt
, &
c
, (c), 
SQLITE4_TRANSIENT
);

2953  
SQLITE4_OK
;

2954 
	}
}

2960 
	$fuŒãxtRowid
(
sqlôe4_vèb_curs‹
 *
pCurs‹
, 
sqlôe_öt64
 *
pRowid
){

2961 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

2963 *
pRowid
 = 
	`sqlôe4_cﬁumn_öt64
(
c
->
pStmt
, 0);

2964  
SQLITE4_OK
;

2965 
	}
}

2970 
	$buûdTîms
(
fuŒãxt_vèb
 *
v
, 
·s1Hash
 *
ãrms
, 
sqlôe_öt64
 
iDocid
,

2971 c⁄° *
zText
, 
iCﬁumn
){

2972 
sqlôe4_tokíizî
 *
pTokíizî
 = 
v
->pTokenizer;

2973 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

2974 c⁄° *
pTokí
;

2975 
nTokíByãs
;

2976 
iSèπOff£t
, 
iEndOff£t
, 
iPosôi⁄
;

2977 
rc
;

2979 
rc
 = 
pTokíizî
->
pModuÀ
->
	`xO≥n
’Tokíizî, 
zText
, -1, &
pCurs‹
);

2980 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2982 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

2983  
SQLITE4_OK
==
pTokíizî
->
pModuÀ
->
	`xNext
(
pCurs‹
,

2984 &
pTokí
, &
nTokíByãs
,

2985 &
iSèπOff£t
, &
iEndOff£t
,

2986 &
iPosôi⁄
) ){

2987 
DocLi°
 *
p
;

2990 if–
iPosôi⁄
<0 ){

2991 
pTokíizî
->
pModuÀ
->
	`xClo£
(
pCurs‹
);

2992  
SQLITE4_ERROR
;

2995 
p
 = 
	`·s1HashFöd
(
ãrms
, 
pTokí
, 
nTokíByãs
);

2996 if–
p
==
NULL
 ){

2997 
p
 = 
	`docLi°New
(
DL_DEFAULT
);

2998 
	`docLi°AddDocid
(
p
, 
iDocid
);

2999 
	`·s1HashIn£π
(
ãrms
, 
pTokí
, 
nTokíByãs
, 
p
);

3001 if–
iCﬁumn
>=0 ){

3002 
	`docLi°AddPosOff£t
(
p
, 
iCﬁumn
, 
iPosôi⁄
, 
iSèπOff£t
, 
iEndOff£t
);

3011 
pTokíizî
->
pModuÀ
->
	`xClo£
(
pCurs‹
);

3012  
rc
;

3013 
	}
}

3016 
	$ödex_ö£π_ãrm
(
fuŒãxt_vèb
 *
v
, c⁄° *
pTîm
, 
nTîm
,

3017 
DocLi°
 *
d
){

3018 
sqlôe_öt64
 
iIndexRow
;

3019 
DocLi°
 
do˛i°
;

3020 
iSegmít
 = 0, 
rc
;

3022 
rc
 = 
	`ãrm_£À˘
(
v
, 
pTîm
, 
nTîm
, 
iSegmít
, &
iIndexRow
, &
do˛i°
);

3023 if–
rc
==
SQLITE4_DONE
 ){

3024 
	`docLi°Inô
(&
do˛i°
, 
DL_DEFAULT
, 0, 0);

3025 
	`docLi°Upd©e
(&
do˛i°
, 
d
);

3027 
rc
 = 
	`ãrm_ö£π
(
v
, 
NULL
, 
pTîm
, 
nTîm
, 
iSegmít
, &
do˛i°
);

3028 
îr
;

3030 if–
rc
!=
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

3032 
	`docLi°Upd©e
(&
do˛i°
, 
d
);

3033 if–
do˛i°
.
nD©a
<=
CHUNK_MAX
 ){

3034 
rc
 = 
	`ãrm_upd©e
(
v
, 
iIndexRow
, &
do˛i°
);

3035 
îr
;

3041 
rc
 = 
	`ãrm_dñëe
(
v
, 
iIndexRow
);

3042 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

3048 
iSegmít
++;

3049  (
rc
=
	`ãrm_ö£π
(
v
, &
iIndexRow
, 
pTîm
, 
nTîm
, 
iSegmít
,

3050 &
do˛i°
))!=
SQLITE4_OK
 ){

3051 
sqlôe_öt64
 
iSegmítRow
;

3052 
DocLi°
 
ﬁd
;

3053 
rc2
;

3058 
rc2
 = 
	`ãrm_£À˘
(
v
, 
pTîm
, 
nTîm
, 
iSegmít
, &
iSegmítRow
, &
ﬁd
);

3059 if–
rc2
!=
SQLITE4_ROW
 ) 
îr
;

3061 
rc
 = 
	`ãrm_dñëe
(
v
, 
iSegmítRow
);

3062 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

3065 if–
iSegmítRow
<
iIndexRow
 ) iIndexRow = iSegmentRow;

3070 
	`docLi°Accumuœã
(&
ﬁd
, &
do˛i°
);

3071 
	`docLi°De°roy
(&
do˛i°
);

3072 
do˛i°
 = 
ﬁd
;

3074 
iSegmít
++;

3077 
îr
:

3078 
	`docLi°De°roy
(&
do˛i°
);

3079  
rc
;

3080 
	}
}

3083 
	$ö£πTîms
(
fuŒãxt_vèb
 *
v
, 
·s1Hash
 *
ãrms
, 
sqlôe_öt64
 
iRowid
,

3084 
sqlôe4_vÆue
 **
pVÆues
){

3085 
i
;

3086 
i
 = 0; i < 
v
->
nCﬁumn
 ; ++i){

3087 *
zText
 = (*)
	`sqlôe4_vÆue_ãxt
(
pVÆues
[
i
]);

3088 
rc
 = 
	`buûdTîms
(
v
, 
ãrms
, 
iRowid
, 
zText
, 
i
);

3089 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3091  
SQLITE4_OK
;

3092 
	}
}

3096 
	$dñëeTîms
(
fuŒãxt_vèb
 *
v
, 
·s1Hash
 *
pTîms
, 
sqlôe_öt64
 
iRowid
){

3097 c⁄° **
pVÆues
;

3098 
i
;

3100 
rc
 = 
	`c⁄ã¡_£À˘
(
v
, 
iRowid
, &
pVÆues
);

3101 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3103 
i
 = 0 ; i < 
v
->
nCﬁumn
; ++i) {

3104 
rc
 = 
	`buûdTîms
(
v
, 
pTîms
, 
iRowid
, 
pVÆues
[
i
], -1);

3105 if–
rc
!=
SQLITE4_OK
 ) ;

3108 
	`‰ìSåögAºay
(
v
->
nCﬁumn
, 
pVÆues
);

3109  
SQLITE4_OK
;

3110 
	}
}

3114 
	$ödex_ö£π
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 *
pReque°Rowid
,

3115 
sqlôe4_vÆue
 **
pVÆues
,

3116 
sqlôe_öt64
 *
piRowid
, 
·s1Hash
 *
pTîms
){

3117 
rc
;

3119 
rc
 = 
	`c⁄ã¡_ö£π
(
v
, 
pReque°Rowid
, 
pVÆues
);

3120 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3121 *
piRowid
 = 
	`sqlôe4_œ°_ö£π_rowid
(
v
->
db
);

3122  
	`ö£πTîms
(
v
, 
pTîms
, *
piRowid
, 
pVÆues
);

3123 
	}
}

3127 
	$ödex_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
, 
·s1Hash
 *
pTîms
){

3128 
rc
 = 
	`dñëeTîms
(
v
, 
pTîms
, 
iRow
);

3129 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3130  
	`c⁄ã¡_dñëe
(
v
, 
iRow
);

3131 
	}
}

3135 
	$ödex_upd©e
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
,

3136 
sqlôe4_vÆue
 **
pVÆues
, 
·s1Hash
 *
pTîms
){

3139 
rc
 = 
	`dñëeTîms
(
v
, 
pTîms
, 
iRow
);

3140 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3142 
rc
 = 
	`c⁄ã¡_upd©e
(
v
, 
pVÆues
, 
iRow
);

3143 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3146  
	`ö£πTîms
(
v
, 
pTîms
, 
iRow
, 
pVÆues
);

3147 
	}
}

3151 
	$fuŒãxtUpd©e
(
sqlôe4_vèb
 *
pVèb
, 
nArg
, 
sqlôe4_vÆue
 **
µArg
,

3152 
sqlôe_öt64
 *
pRowid
){

3153 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *Ë
pVèb
;

3154 
·s1Hash
 
ãrms
;

3155 
rc
;

3156 
·s1HashEÀm
 *
e
;

3158 
	`TRACE
(("FTS1 Upd©ê%p\n", 
pVèb
));

3160 
	`·s1HashInô
(&
ãrms
, 
FTS1_HASH_STRING
, 1);

3162 if–
nArg
<2 ){

3163 
rc
 = 
	`ödex_dñëe
(
v
, 
	`sqlôe4_vÆue_öt64
(
µArg
[0]), &
ãrms
);

3164 } if–
	`sqlôe4_vÆue_ty≥
(
µArg
[0]Ë!
SQLITE4_NULL
 ){

3171 
sqlôe_öt64
 
rowid
 = 
	`sqlôe4_vÆue_öt64
(
µArg
[0]);

3172 if–
	`sqlôe4_vÆue_ty≥
(
µArg
[1]Ë!
SQLITE4_INTEGER
 ||

3173 
	`sqlôe4_vÆue_öt64
(
µArg
[1]Ë!
rowid
 ){

3174 
rc
 = 
SQLITE4_ERROR
;

3176 
	`as£π
–
nArg
==2+
v
->
nCﬁumn
+1);

3177 
rc
 = 
	`ödex_upd©e
(
v
, 
rowid
, &
µArg
[2], &
ãrms
);

3185 
	`as£π
–
nArg
==2+
v
->
nCﬁumn
+1);

3186 
rc
 = 
	`ödex_ö£π
(
v
, 
µArg
[1], &µArg[2], 
pRowid
, &
ãrms
);

3189 if–
rc
==
SQLITE4_OK
 ){

3191 
e
=
	`·s1HashFú°
(&
ãrms
);É;É=
	`·s1HashNext
(e)){

3192 
DocLi°
 *
p
 = 
	`·s1HashD©a
(
e
);

3193 
rc
 = 
	`ödex_ö£π_ãrm
(
v
, 
	`·s1HashKey
(
e
), 
	`·s1HashKeysize
”), 
p
);

3194 if–
rc
!=
SQLITE4_OK
 ) ;

3199 
e
=
	`·s1HashFú°
(&
ãrms
);É;É=
	`·s1HashNext
(e)){

3200 
DocLi°
 *
p
 = 
	`·s1HashD©a
(
e
);

3201 
	`docLi°Dñëe
(
p
);

3203 
	`·s1HashCÀ¨
(&
ãrms
);

3205  
rc
;

3206 
	}
}

3211 
	$¢ù≥tFunc
(

3212 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3213 
¨gc
,

3214 
sqlôe4_vÆue
 **
¨gv


3216 
fuŒãxt_curs‹
 *
pCurs‹
;

3217 if–
¨gc
<1 ) ;

3218 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

3219 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

3220 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, "illegal firstárgumentÅo html_snippet",-1);

3222 c⁄° *
zSèπ
 = "<b>";

3223 c⁄° *
zEnd
 = "</b>";

3224 c⁄° *
zEŒùsis
 = "<b>...</b>";

3225 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

3226 if–
¨gc
>=2 ){

3227 
zSèπ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

3228 if–
¨gc
>=3 ){

3229 
zEnd
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[2]);

3230 if–
¨gc
>=4 ){

3231 
zEŒùsis
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[3]);

3235 
	`¢ù≥tAŒOff£ts
(
pCurs‹
);

3236 
	`¢ù≥tText
(
pCurs‹
, 
zSèπ
, 
zEnd
, 
zEŒùsis
);

3237 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, 
pCurs‹
->
¢ù≥t
.
zSnù≥t
,

3238 
pCurs‹
->
¢ù≥t
.
nSnù≥t
, 
SQLITE4_STATIC
);

3240 
	}
}

3245 
	$¢ù≥tOff£tsFunc
(

3246 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3247 
¨gc
,

3248 
sqlôe4_vÆue
 **
¨gv


3250 
fuŒãxt_curs‹
 *
pCurs‹
;

3251 if–
¨gc
<1 ) ;

3252 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

3253 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

3254 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, "illegal firstárgumentÅo offsets",-1);

3256 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

3257 
	`¢ù≥tAŒOff£ts
(
pCurs‹
);

3258 
	`¢ù≥tOff£tText
(&
pCurs‹
->
¢ù≥t
);

3259 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
,

3260 
pCurs‹
->
¢ù≥t
.
zOff£t
,ÖCurs‹->¢ù≥t.
nOff£t
,

3261 
SQLITE4_STATIC
);

3263 
	}
}

3269 
fuŒãxtFödFun˘i⁄
(

3270 
sqlôe4_vèb
 *
pVèb
,

3271 
nArg
,

3272 c⁄° *
zName
,

3273 (**
pxFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**),

3274 **
µArg


3276 if–
	`°rcmp
(
zName
,"snippet")==0 ){

3277 *
pxFunc
 = 
¢ù≥tFunc
;

3279 }if–
	`°rcmp
(
zName
,"offsets")==0 ){

3280 *
pxFunc
 = 
¢ù≥tOff£tsFunc
;

3284 
	}
}

3289 
	$fuŒãxtRíame
(

3290 
sqlôe4_vèb
 *
pVèb
,

3291 c⁄° *
zName


3293 
fuŒãxt_vèb
 *
p
 = (fuŒãxt_vèb *)
pVèb
;

3294 
rc
 = 
SQLITE4_NOMEM
;

3295 *
zSql
 = 
	`sqlôe4_m¥ötf
(

3298 , 
p
->
zDb
,Ö->
zName
, zName

3299 , 
p
->
zDb
,Ö->
zName
, zName

3301 if–
zSql
 ){

3302 
rc
 = 
	`sqlôe4_exec
(
p
->
db
, 
zSql
, 0, 0, 0);

3303 
	`sqlôe4_‰ì
(
zSql
);

3305  
rc
;

3306 
	}
}

3308 c⁄° 
sqlôe4_moduÀ
 
	gfuŒãxtModuÀ
 = {

3310  
fuŒãxtCª©e
,

3311  
fuŒãxtC⁄√˘
,

3312  
fuŒãxtBe°Index
,

3313  
fuŒãxtDisc⁄√˘
,

3314  
fuŒãxtDe°roy
,

3315  
fuŒãxtO≥n
,

3316  
fuŒãxtClo£
,

3317  
fuŒãxtFûãr
,

3318  
fuŒãxtNext
,

3319  
fuŒãxtEof
,

3320  
fuŒãxtCﬁumn
,

3321  
fuŒãxtRowid
,

3322  
fuŒãxtUpd©e
,

3327  
fuŒãxtFödFun˘i⁄
,

3328  
fuŒãxtRíame
,

3331 
	$sqlôe4Fts1Inô
(
sqlôe4
 *
db
){

3332 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "snippet", -1);

3333 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "offsets", -1);

3334  
	`sqlôe4_¸óã_moduÀ
(
db
, "·s1", &
fuŒãxtModuÀ
, 0);

3335 
	}
}

3337 #i‡!
SQLITE4_CORE


3338 
	$sqlôe4_exãnsi⁄_öô
(
sqlôe4
 *
db
, **
pzEºMsg
,

3339 c⁄° 
sqlôe4_≠i_routöes
 *
pApi
){

3340 
	`SQLITE4_EXTENSION_INIT2
(
pApi
)

3341  
	`sqlôe4Fts1Inô
(
db
);

3342 
	}
}

	@ext/fts1/fts1.h

1 
	~"sqlôe4.h
"

3 #ifde‡
__˝lu•lus


7 
sqlôe4Fts1Inô
(
sqlôe4
 *
db
);

9 #ifde‡
__˝lu•lus


	@ext/fts1/fts1_hash.c

16 
	~<as£π.h
>

17 
	~<°dlib.h
>

18 
	~<°rög.h
>

29 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS1
)

32 
	~"·s1_hash.h
"

34 *
	$mÆloc_™d_zîo
(
n
){

35 *
p
 = 
	`mÆloc
(
n
);

36 if–
p
 ){

37 
	`mem£t
(
p
, 0, 
n
);

39  
p
;

40 
	}
}

52 
	$sqlôe4Fts1HashInô
(
·s1Hash
 *
pNew
, 
keyCœss
, 
c›yKey
){

53 
	`as£π
–
pNew
!=0 );

54 
	`as£π
–
keyCœss
>=
FTS1_HASH_STRING
 && keyCœss<=
FTS1_HASH_BINARY
 );

55 
pNew
->
keyCœss
 = keyClass;

56 
pNew
->
c›yKey
 = copyKey;

57 
pNew
->
fú°
 = 0;

58 
pNew
->
cou¡
 = 0;

59 
pNew
->
htsize
 = 0;

60 
pNew
->
ht
 = 0;

61 
pNew
->
xMÆloc
 = 
mÆloc_™d_zîo
;

62 
pNew
->
xFªe
 = 
‰ì
;

63 
	}
}

69 
	$sqlôe4Fts1HashCÀ¨
(
·s1Hash
 *
pH
){

70 
·s1HashEÀm
 *
ñem
;

72 
	`as£π
–
pH
!=0 );

73 
ñem
 = 
pH
->
fú°
;

74 
pH
->
fú°
 = 0;

75 if–
pH
->
ht
 )ÖH->
	`xFªe
(pH->ht);

76 
pH
->
ht
 = 0;

77 
pH
->
htsize
 = 0;

78  
ñem
 ){

79 
·s1HashEÀm
 *
√xt_ñem
 = 
ñem
->
√xt
;

80 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

81 
pH
->
	`xFªe
(
ñem
->
pKey
);

83 
pH
->
	`xFªe
(
ñem
);

84 
ñem
 = 
√xt_ñem
;

86 
pH
->
cou¡
 = 0;

87 
	}
}

92 
	$°rHash
(c⁄° *
pKey
, 
nKey
){

93 c⁄° *
z
 = (c⁄° *)
pKey
;

94 
h
 = 0;

95 if–
nKey
<=0 )ÇKey = (Ë
	`°æí
(
z
);

96  
nKey
 > 0 ){

97 
h
 = (h<<3Ë^ h ^ *
z
++;

98 
nKey
--;

100  
h
 & 0x7fffffff;

101 
	}
}

102 
	$°rCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

103 if–
n1
!=
n2
 )  1;

104  
	`°∫cmp
((c⁄° *)
pKey1
,(c⁄° *)
pKey2
,
n1
);

105 
	}
}

110 
	$böHash
(c⁄° *
pKey
, 
nKey
){

111 
h
 = 0;

112 c⁄° *
z
 = (c⁄° *)
pKey
;

113  
nKey
-- > 0 ){

114 
h
 = (h<<3Ë^ h ^ *(
z
++);

116  
h
 & 0x7fffffff;

117 
	}
}

118 
	$böCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

119 if–
n1
!=
n2
 )  1;

120  
	`memcmp
(
pKey1
,
pKey2
,
n1
);

121 
	}
}

135 (*
	$hashFun˘i⁄
(
keyCœss
))(const *,){

136 if–
keyCœss
==
FTS1_HASH_STRING
 ){

137  &
°rHash
;

139 
	`as£π
–
keyCœss
==
FTS1_HASH_BINARY
 );

140  &
böHash
;

142 
	}
}

150 (*
	$com∑ªFun˘i⁄
(
keyCœss
))(const *,,const *,){

151 if–
keyCœss
==
FTS1_HASH_STRING
 ){

152  &
°rCom∑ª
;

154 
	`as£π
–
keyCœss
==
FTS1_HASH_BINARY
 );

155  &
böCom∑ª
;

157 
	}
}

161 
	$ö£πEÀmít
(

162 
·s1Hash
 *
pH
,

163 
_·s1ht
 *
pE¡ry
,

164 
·s1HashEÀm
 *
pNew


166 
·s1HashEÀm
 *
pHód
;

167 
pHód
 = 
pE¡ry
->
chaö
;

168 if–
pHód
 ){

169 
pNew
->
√xt
 = 
pHód
;

170 
pNew
->
¥ev
 = 
pHód
->prev;

171 if–
pHód
->
¥ev
 ){ÖHód->¥ev->
√xt
 = 
pNew
; }

172 { 
pH
->
fú°
 = 
pNew
; }

173 
pHód
->
¥ev
 = 
pNew
;

175 
pNew
->
√xt
 = 
pH
->
fú°
;

176 if–
pH
->
fú°
 ){ÖH->fú°->
¥ev
 = 
pNew
; }

177 
pNew
->
¥ev
 = 0;

178 
pH
->
fú°
 = 
pNew
;

180 
pE¡ry
->
cou¡
++;

181 
pE¡ry
->
chaö
 = 
pNew
;

182 
	}
}

189 
	$ªhash
(
·s1Hash
 *
pH
, 
√w_size
){

190 
_·s1ht
 *
√w_ht
;

191 
·s1HashEÀm
 *
ñem
, *
√xt_ñem
;

192 (*
xHash
)(const *,);

194 
	`as£π
–(
√w_size
 & (new_size-1))==0 );

195 
√w_ht
 = (
_·s1ht
 *)
pH
->
	`xMÆloc
–
√w_size
*(_fts1ht) );

196 if–
√w_ht
==0 ) ;

197 if–
pH
->
ht
 )ÖH->
	`xFªe
(pH->ht);

198 
pH
->
ht
 = 
√w_ht
;

199 
pH
->
htsize
 = 
√w_size
;

200 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

201 
ñem
=
pH
->
fú°
,ÖH->fú°=0;ÉÀm;ÉÀm = 
√xt_ñem
){

202 
h
 = (*
xHash
)(
ñem
->
pKey
,ÉÀm->
nKey
Ë& (
√w_size
-1);

203 
√xt_ñem
 = 
ñem
->
√xt
;

204 
	`ö£πEÀmít
(
pH
, &
√w_ht
[
h
], 
ñem
);

206 
	}
}

212 
·s1HashEÀm
 *
	$födEÀmítGivíHash
(

213 c⁄° 
·s1Hash
 *
pH
,

214 c⁄° *
pKey
,

215 
nKey
,

216 
h


218 
·s1HashEÀm
 *
ñem
;

219 
cou¡
;

220 (*
xCom∑ª
)(const *,,const *,);

222 if–
pH
->
ht
 ){

223 
_·s1ht
 *
pE¡ry
 = &
pH
->
ht
[
h
];

224 
ñem
 = 
pE¡ry
->
chaö
;

225 
cou¡
 = 
pE¡ry
->count;

226 
xCom∑ª
 = 
	`com∑ªFun˘i⁄
(
pH
->
keyCœss
);

227  
cou¡
-- && 
ñem
 ){

228 if–(*
xCom∑ª
)(
ñem
->
pKey
,ñem->
nKey
,pKey,nKey)==0 ){

229  
ñem
;

231 
ñem
 =ÉÀm->
√xt
;

235 
	}
}

240 
	$ªmoveEÀmítGivíHash
(

241 
·s1Hash
 *
pH
,

242 
·s1HashEÀm
* 
ñem
,

243 
h


245 
_·s1ht
 *
pE¡ry
;

246 if–
ñem
->
¥ev
 ){

247 
ñem
->
¥ev
->
√xt
 =Élem->next;

249 
pH
->
fú°
 = 
ñem
->
√xt
;

251 if–
ñem
->
√xt
 ){

252 
ñem
->
√xt
->
¥ev
 =Élem->prev;

254 
pE¡ry
 = &
pH
->
ht
[
h
];

255 if–
pE¡ry
->
chaö
==
ñem
 ){

256 
pE¡ry
->
chaö
 = 
ñem
->
√xt
;

258 
pE¡ry
->
cou¡
--;

259 if–
pE¡ry
->
cou¡
<=0 ){

260 
pE¡ry
->
chaö
 = 0;

262 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

263 
pH
->
	`xFªe
(
ñem
->
pKey
);

265 
pH
->
	`xFªe
–
ñem
 );

266 
pH
->
cou¡
--;

267 if–
pH
->
cou¡
<=0 ){

268 
	`as£π
–
pH
->
fú°
==0 );

269 
	`as£π
–
pH
->
cou¡
==0 );

270 
	`·s1HashCÀ¨
(
pH
);

272 
	}
}

278 *
	$sqlôe4Fts1HashFöd
(c⁄° 
·s1Hash
 *
pH
, c⁄° *
pKey
, 
nKey
){

279 
h
;

280 
·s1HashEÀm
 *
ñem
;

281 (*
xHash
)(const *,);

283 if–
pH
==0 ||ÖH->
ht
==0 )  0;

284 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

285 
	`as£π
–
xHash
!=0 );

286 
h
 = (*
xHash
)(
pKey
,
nKey
);

287 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

288 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
, 
h
 & (pH->
htsize
-1));

289  
ñem
 ?ÉÀm->
d©a
 : 0;

290 
	}
}

307 *
	$sqlôe4Fts1HashIn£π
(

308 
·s1Hash
 *
pH
,

309 c⁄° *
pKey
,

310 
nKey
,

311 *
d©a


313 
høw
;

314 
h
;

315 
·s1HashEÀm
 *
ñem
;

316 
·s1HashEÀm
 *
√w_ñem
;

317 (*
xHash
)(const *,);

319 
	`as£π
–
pH
!=0 );

320 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

321 
	`as£π
–
xHash
!=0 );

322 
høw
 = (*
xHash
)(
pKey
, 
nKey
);

323 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

324 
h
 = 
høw
 & (
pH
->
htsize
-1);

325 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
,
h
);

326 if–
ñem
 ){

327 *
ﬁd_d©a
 = 
ñem
->
d©a
;

328 if–
d©a
==0 ){

329 
	`ªmoveEÀmítGivíHash
(
pH
,
ñem
,
h
);

331 
ñem
->
d©a
 = data;

333  
ﬁd_d©a
;

335 if–
d©a
==0 )  0;

336 
√w_ñem
 = (
·s1HashEÀm
*)
pH
->
	`xMÆloc
( (fts1HashElem) );

337 if–
√w_ñem
==0 )  
d©a
;

338 if–
pH
->
c›yKey
 && 
pKey
!=0 ){

339 
√w_ñem
->
pKey
 = 
pH
->
	`xMÆloc
–
nKey
 );

340 if–
√w_ñem
->
pKey
==0 ){

341 
pH
->
	`xFªe
(
√w_ñem
);

342  
d©a
;

344 
	`mem˝y
((*)
√w_ñem
->
pKey
,ÖKey, 
nKey
);

346 
√w_ñem
->
pKey
 = (*)pKey;

348 
√w_ñem
->
nKey
 =ÇKey;

349 
pH
->
cou¡
++;

350 if–
pH
->
htsize
==0 ){

351 
	`ªhash
(
pH
,8);

352 if–
pH
->
htsize
==0 ){

353 
pH
->
cou¡
 = 0;

354 
pH
->
	`xFªe
(
√w_ñem
);

355  
d©a
;

358 if–
pH
->
cou¡
 >ÖH->
htsize
 ){

359 
	`ªhash
(
pH
,pH->
htsize
*2);

361 
	`as£π
–
pH
->
htsize
>0 );

362 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

363 
h
 = 
høw
 & (
pH
->
htsize
-1);

364 
	`ö£πEÀmít
(
pH
, &pH->
ht
[
h
], 
√w_ñem
);

365 
√w_ñem
->
d©a
 = data;

367 
	}
}

	@ext/fts1/fts1_hash.h

17 #i‚de‡
_FTS1_HASH_H_


18 
	#_FTS1_HASH_H_


	)

21 
·s1Hash
 
	t·s1Hash
;

22 
·s1HashEÀm
 
	t·s1HashEÀm
;

32 
	s·s1Hash
 {

33 
	mkeyCœss
;

34 
	mc›yKey
;

35 
	mcou¡
;

36 
·s1HashEÀm
 *
	mfú°
;

37 *(*
	mxMÆloc
)();

38 (*
	mxFªe
)(*);

39 
	mhtsize
;

40 
	s_·s1ht
 {

41 
	mcou¡
;

42 
·s1HashEÀm
 *
	mchaö
;

43 } *
	mht
;

52 
	s·s1HashEÀm
 {

53 
·s1HashEÀm
 *
	m√xt
, *
	m¥ev
;

54 *
	md©a
;

55 *
	mpKey
; 
	mnKey
;

70 
	#FTS1_HASH_STRING
 1

	)

71 
	#FTS1_HASH_BINARY
 2

	)

76 
sqlôe4Fts1HashInô
(
·s1Hash
*, 
keyty≥
, 
c›yKey
);

77 *
sqlôe4Fts1HashIn£π
(
·s1Hash
*, c⁄° *
pKey
, 
nKey
, *
pD©a
);

78 *
sqlôe4Fts1HashFöd
(c⁄° 
·s1Hash
*, c⁄° *
pKey
, 
nKey
);

79 
sqlôe4Fts1HashCÀ¨
(
·s1Hash
*);

84 
	#·s1HashInô
 
sqlôe4Fts1HashInô


	)

85 
	#·s1HashIn£π
 
sqlôe4Fts1HashIn£π


	)

86 
	#·s1HashFöd
 
sqlôe4Fts1HashFöd


	)

87 
	#·s1HashCÀ¨
 
sqlôe4Fts1HashCÀ¨


	)

101 
	#·s1HashFú°
(
H
Ë((H)->
fú°
)

	)

102 
	#·s1HashNext
(
E
Ë((E)->
√xt
)

	)

103 
	#·s1HashD©a
(
E
Ë((E)->
d©a
)

	)

104 
	#·s1HashKey
(
E
Ë((E)->
pKey
)

	)

105 
	#·s1HashKeysize
(
E
Ë((E)->
nKey
)

	)

110 
	#·s1HashCou¡
(
H
Ë((H)->
cou¡
)

	)

	@ext/fts1/fts1_porter.c

25 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS1
)

28 
	~<as£π.h
>

29 
	~<°dlib.h
>

30 
	~<°dio.h
>

31 
	~<°rög.h
>

32 
	~<˘y≥.h
>

34 
	~"·s1_tokíizî.h
"

39 
	sp‹ãr_tokíizî
 {

40 
sqlôe4_tokíizî
 
	mba£
;

41 } 
	tp‹ãr_tokíizî
;

46 
	sp‹ãr_tokíizî_curs‹
 {

47 
sqlôe4_tokíizî_curs‹
 
	mba£
;

48 c⁄° *
	mzI≈ut
;

49 
	mnI≈ut
;

50 
	miOff£t
;

51 
	miTokí
;

52 *
	mzTokí
;

53 
	mnAŒoˇãd
;

54 } 
	tp‹ãr_tokíizî_curs‹
;

58 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gp‹ãrTokíizîModuÀ
;

64 
	$p‹ãrCª©e
(

65 
¨gc
, c⁄° * c⁄° *
¨gv
,

66 
sqlôe4_tokíizî
 **
µTokíizî


68 
p‹ãr_tokíizî
 *
t
;

69 
t
 = (
p‹ãr_tokíizî
 *Ë
	`ˇŒoc
((*t), 1);

70 if–
t
==
NULL
 )  
SQLITE4_NOMEM
;

72 *
µTokíizî
 = &
t
->
ba£
;

73  
SQLITE4_OK
;

74 
	}
}

79 
	$p‹ãrDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

80 
	`‰ì
(
pTokíizî
);

81  
SQLITE4_OK
;

82 
	}
}

90 
	$p‹ãrO≥n
(

91 
sqlôe4_tokíizî
 *
pTokíizî
,

92 c⁄° *
zI≈ut
, 
nI≈ut
,

93 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


95 
p‹ãr_tokíizî_curs‹
 *
c
;

97 
c
 = (
p‹ãr_tokíizî_curs‹
 *Ë
	`mÆloc
((*c));

98 if–
c
==
NULL
 )  
SQLITE4_NOMEM
;

100 
c
->
zI≈ut
 = zInput;

101 if–
zI≈ut
==0 ){

102 
c
->
nI≈ut
 = 0;

103 }if–
nI≈ut
<0 ){

104 
c
->
nI≈ut
 = ()
	`°æí
(
zI≈ut
);

106 
c
->
nI≈ut
 =ÇInput;

108 
c
->
iOff£t
 = 0;

109 
c
->
iTokí
 = 0;

110 
c
->
zTokí
 = 
NULL
;

111 
c
->
nAŒoˇãd
 = 0;

113 *
µCurs‹
 = &
c
->
ba£
;

114  
SQLITE4_OK
;

115 
	}
}

121 
	$p‹ãrClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

122 
p‹ãr_tokíizî_curs‹
 *
c
 = (p‹ãr_tokíizî_curs‹ *Ë
pCurs‹
;

123 
	`‰ì
(
c
->
zTokí
);

124 
	`‰ì
(
c
);

125  
SQLITE4_OK
;

126 
	}
}

130 c⁄° 
	gcTy≥
[] = {

148 
isVowñ
(const *);

149 
	$isC⁄s⁄™t
(c⁄° *
z
){

150 
j
;

151 
x
 = *
z
;

152 if–
x
==0 )  0;

153 
	`as£π
–
x
>='a' && x<='z' );

154 
j
 = 
cTy≥
[
x
-'a'];

155 if–
j
<2 )  j;

156  
z
[1]==0 || 
	`isVowñ
(z + 1);

157 
	}
}

158 
	$isVowñ
(c⁄° *
z
){

159 
j
;

160 
x
 = *
z
;

161 if–
x
==0 )  0;

162 
	`as£π
–
x
>='a' && x<='z' );

163 
j
 = 
cTy≥
[
x
-'a'];

164 if–
j
<2 )  1-j;

165  
	`isC⁄s⁄™t
(
z
 + 1);

166 
	}
}

187 
	$m_gt_0
(c⁄° *
z
){

188  
	`isVowñ
(
z
) ){ z++; }

189 if–*
z
==0 )  0;

190  
	`isC⁄s⁄™t
(
z
) ){ z++; }

191  *
z
!=0;

192 
	}
}

197 
	$m_eq_1
(c⁄° *
z
){

198  
	`isVowñ
(
z
) ){ z++; }

199 if–*
z
==0 )  0;

200  
	`isC⁄s⁄™t
(
z
) ){ z++; }

201 if–*
z
==0 )  0;

202  
	`isVowñ
(
z
) ){ z++; }

203 if–*
z
==0 )  1;

204  
	`isC⁄s⁄™t
(
z
) ){ z++; }

205  *
z
==0;

206 
	}
}

211 
	$m_gt_1
(c⁄° *
z
){

212  
	`isVowñ
(
z
) ){ z++; }

213 if–*
z
==0 )  0;

214  
	`isC⁄s⁄™t
(
z
) ){ z++; }

215 if–*
z
==0 )  0;

216  
	`isVowñ
(
z
) ){ z++; }

217 if–*
z
==0 )  0;

218  
	`isC⁄s⁄™t
(
z
) ){ z++; }

219  *
z
!=0;

220 
	}
}

225 
	$hasVowñ
(c⁄° *
z
){

226  
	`isC⁄s⁄™t
(
z
) ){ z++; }

227  *
z
!=0;

228 
	}
}

236 
	$doubÀC⁄s⁄™t
(c⁄° *
z
){

237  
	`isC⁄s⁄™t
(
z
) && z[0]==z[1] && isConsonant(z+1);

238 
	}
}

248 
	$°¨_oh
(c⁄° *
z
){

250 
z
[0]!=0 && 
	`isC⁄s⁄™t
(z) &&

251 
z
[0]!='w' && z[0]!='x' && z[0]!='y' &&

252 
z
[1]!=0 && 
	`isVowñ
(z+1) &&

253 
z
[2]!=0 && 
	`isC⁄s⁄™t
(z+2);

254 
	}
}

268 
°em
(

269 **
pz
,

270 c⁄° *
zFrom
,

271 c⁄° *
zTo
,

272 (*
xC⁄d
)(const *)

274 *
z
 = *
pz
;

275  *
zFrom
 && *zFrom==*
z
 ){ z++; zFrom++; }

276 if–*
zFrom
!=0 )  0;

277 if–
xC⁄d
 && !
	`xC⁄d
(
z
) )  1;

278  *
zTo
 ){

279 *(--
z
Ë*(
zTo
++);

281 *
pz
 = 
z
;

283 
	}
}

293 
	$c›y_°emmî
(c⁄° *
zIn
, 
nIn
, *
zOut
, *
≤Out
){

294 
i
, 
mx
, 
j
;

295 
hasDigô
 = 0;

296 
i
=0; i<
nIn
; i++){

297 
c
 = 
zIn
[
i
];

298 if–
c
>='A' && c<='Z' ){

299 
zOut
[
i
] = 
c
 - 'A' + 'a';

301 if–
c
>='0' && c<='9' ) 
hasDigô
 = 1;

302 
zOut
[
i
] = 
c
;

305 
mx
 = 
hasDigô
 ? 3 : 10;

306 if–
nIn
>
mx
*2 ){

307 
j
=
mx
, 
i
=
nIn
-mx; i<nIn; i++, j++){

308 
zOut
[
j
] = zOut[
i
];

310 
i
 = 
j
;

312 
zOut
[
i
] = 0;

313 *
≤Out
 = 
i
;

314 
	}
}

340 
	$p‹ãr_°emmî
(c⁄° *
zIn
, 
nIn
, *
zOut
, *
≤Out
){

341 
i
, 
j
, 
c
;

342 
zRevî£
[28];

343 *
z
, *
z2
;

344 if–
nIn
<3 ||ÇIn>=(
zRevî£
)-7 ){

347 
	`c›y_°emmî
(
zIn
, 
nIn
, 
zOut
, 
≤Out
);

350 
i
=0, 
j
=(
zRevî£
)-6; i<
nIn
; i++, j--){

351 
c
 = 
zIn
[
i
];

352 if–
c
>='A' && c<='Z' ){

353 
zRevî£
[
j
] = 
c
 + 'a' - 'A';

354 }if–
c
>='a' && c<='z' ){

355 
zRevî£
[
j
] = 
c
;

359 
	`c›y_°emmî
(
zIn
, 
nIn
, 
zOut
, 
≤Out
);

363 
	`mem£t
(&
zRevî£
[(zReverse)-5], 0, 5);

364 
z
 = &
zRevî£
[
j
+1];

368 if–
z
[0]=='s' ){

370 !
	`°em
(&
z
, "sess", "ss", 0) &&

371 !
	`°em
(&
z
, "sei", "i", 0) &&

372 !
	`°em
(&
z
, "ss", "ss", 0)

374 
z
++;

379 
z2
 = 
z
;

380 if–
	`°em
(&
z
, "dì", "ì", 
m_gt_0
) ){

383 (
	`°em
(&
z
, "gni", "", 
hasVowñ
) || stem(&z, "de", "", hasVowel))

384 && 
z
!=
z2


386 if–
	`°em
(&
z
, "ta", "ate", 0) ||

387 
	`°em
(&
z
, "lb", "ble", 0) ||

388 
	`°em
(&
z
, "zi", "ize", 0) ){

390 }if–
	`doubÀC⁄s⁄™t
(
z
) && (*z!='l' && *z!='s' && *z!='z') ){

391 
z
++;

392 }if–
	`m_eq_1
(
z
Ë&& 
	`°¨_oh
(z) ){

393 *(--
z
) = 'e';

398 if–
z
[0]=='y' && 
	`hasVowñ
(z+1) ){

399 
z
[0] = 'i';

403  
z
[1] ){

405 
	`°em
(&
z
, "œnoôa", "©e", 
m_gt_0
) ||

406 
	`°em
(&
z
, "œnoô", "ti⁄", 
m_gt_0
);

409 
	`°em
(&
z
, "i˙e", "í˚", 
m_gt_0
) ||

410 
	`°em
(&
z
, "i˙a", "™˚", 
m_gt_0
);

413 
	`°em
(&
z
, "ªzi", "ize", 
m_gt_0
);

416 
	`°em
(&
z
, "igﬁ", "log", 
m_gt_0
);

419 
	`°em
(&
z
, "ûb", "bÀ", 
m_gt_0
) ||

420 
	`°em
(&
z
, "ûœ", "Æ", 
m_gt_0
) ||

421 
	`°em
(&
z
, "ûäe", "ít", 
m_gt_0
) ||

422 
	`°em
(&
z
, "ûe", "e", 
m_gt_0
) ||

423 
	`°em
(&
z
, "ûsuo", "ous", 
m_gt_0
);

426 
	`°em
(&
z
, "noôazi", "ize", 
m_gt_0
) ||

427 
	`°em
(&
z
, "noôa", "©e", 
m_gt_0
) ||

428 
	`°em
(&
z
, "rŸa", "©e", 
m_gt_0
);

431 
	`°em
(&
z
, "msûa", "Æ", 
m_gt_0
) ||

432 
	`°em
(&
z
, "s£√vi", "ive", 
m_gt_0
) ||

433 
	`°em
(&
z
, "s£∆uf", "ful", 
m_gt_0
) ||

434 
	`°em
(&
z
, "s£nsuo", "ous", 
m_gt_0
);

437 
	`°em
(&
z
, "ôûa", "Æ", 
m_gt_0
) ||

438 
	`°em
(&
z
, "ôivi", "ive", 
m_gt_0
) ||

439 
	`°em
(&
z
, "ôûib", "bÀ", 
m_gt_0
);

444  
z
[0] ){

446 
	`°em
(&
z
, "ëaci", "ic", 
m_gt_0
) ||

447 
	`°em
(&
z
, "evôa", "", 
m_gt_0
) ||

448 
	`°em
(&
z
, "ezûa", "Æ", 
m_gt_0
);

451 
	`°em
(&
z
, "ôici", "ic", 
m_gt_0
);

454 
	`°em
(&
z
, "œci", "ic", 
m_gt_0
) ||

455 
	`°em
(&
z
, "luf", "", 
m_gt_0
);

458 
	`°em
(&
z
, "s£n", "", 
m_gt_0
);

463  
z
[1] ){

465 if–
z
[0]=='l' && 
	`m_gt_1
(z+2) ){

466 
z
 += 2;

470 if–
z
[0]=='e' && z[2]=='n' && (z[3]=='a' || z[3]=='e'Ë&& 
	`m_gt_1
(z+4) ){

471 
z
 += 4;

475 if–
z
[0]=='r' && 
	`m_gt_1
(z+2) ){

476 
z
 += 2;

480 if–
z
[0]=='c' && 
	`m_gt_1
(z+2) ){

481 
z
 += 2;

485 if–
z
[0]=='e' && z[2]=='b' && (z[3]=='a' || z[3]=='i'Ë&& 
	`m_gt_1
(z+4) ){

486 
z
 += 4;

490 if–
z
[0]=='t' ){

491 if–
z
[2]=='a' ){

492 if–
	`m_gt_1
(
z
+3) ){

493 
z
 += 3;

495 }if–
z
[2]=='e' ){

496 
	`°em
(&
z
, "äeme", "", 
m_gt_1
) ||

497 
	`°em
(&
z
, "äem", "", 
m_gt_1
) ||

498 
	`°em
(&
z
, "äe", "", 
m_gt_1
);

503 if–
z
[0]=='u' ){

504 if–
	`m_gt_1
(
z
+2) ){

505 
z
 += 2;

507 }if–
z
[3]=='s' || z[3]=='t' ){

508 
	`°em
(&
z
, "noi", "", 
m_gt_1
);

512 if–
z
[0]=='m' && z[2]=='i' && 
	`m_gt_1
(z+3) ){

513 
z
 += 3;

517 
	`°em
(&
z
, "ëa", "", 
m_gt_1
) ||

518 
	`°em
(&
z
, "ôi", "", 
m_gt_1
);

521 if–
z
[0]=='s' && z[2]=='o' && 
	`m_gt_1
(z+3) ){

522 
z
 += 3;

527 if–
z
[0]=='e' && z[2]=='i' && 
	`m_gt_1
(z+3) ){

528 
z
 += 3;

534 if–
z
[0]=='e' ){

535 if–
	`m_gt_1
(
z
+1) ){

536 
z
++;

537 }if–
	`m_eq_1
(
z
+1Ë&& !
	`°¨_oh
(z+1) ){

538 
z
++;

543 if–
	`m_gt_1
(
z
) && z[0]=='l' && z[1]=='l' ){

544 
z
++;

550 *
≤Out
 = 
i
 = 
	`°æí
(
z
);

551 
zOut
[
i
] = 0;

552  *
z
 ){

553 
zOut
[--
i
] = *(
z
++);

555 
	}
}

563 c⁄° 
	gisIdCh¨
[] = {

571 
	#idCh¨
(
C
Ë(((
ch
=C)&0x80)!=0 || (ch>0x2‡&& 
isIdCh¨
[ch-0x30]))

	)

572 
	#isDñim
(
C
Ë(((
ch
=C)&0x80)==0 && (ch<0x30 || !
isIdCh¨
[ch-0x30]))

	)

578 
	$p‹ãrNext
(

579 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

580 c⁄° **
pzTokí
,

581 *
≤Byãs
,

582 *
piSèπOff£t
,

583 *
piEndOff£t
,

584 *
piPosôi⁄


586 
p‹ãr_tokíizî_curs‹
 *
c
 = (p‹ãr_tokíizî_curs‹ *Ë
pCurs‹
;

587 c⁄° *
z
 = 
c
->
zI≈ut
;

589  
c
->
iOff£t
<c->
nI≈ut
 ){

590 
iSèπOff£t
, 
ch
;

593  
c
->
iOff£t
<c->
nI≈ut
 && 
	`isDñim
(
z
[c->iOffset]) ){

594 
c
->
iOff£t
++;

598 
iSèπOff£t
 = 
c
->
iOff£t
;

599  
c
->
iOff£t
<c->
nI≈ut
 && !
	`isDñim
(
z
[c->iOffset]) ){

600 
c
->
iOff£t
++;

603 if–
c
->
iOff£t
>
iSèπOff£t
 ){

604 
n
 = 
c
->
iOff£t
-
iSèπOff£t
;

605 if–
n
>
c
->
nAŒoˇãd
 ){

606 
c
->
nAŒoˇãd
 = 
n
+20;

607 
c
->
zTokí
 = 
	`ªÆloc
(c->zTokí, c->
nAŒoˇãd
);

608 if–
c
->
zTokí
==
NULL
 )  
SQLITE4_NOMEM
;

610 
	`p‹ãr_°emmî
(&
z
[
iSèπOff£t
], 
n
, 
c
->
zTokí
, 
≤Byãs
);

611 *
pzTokí
 = 
c
->
zTokí
;

612 *
piSèπOff£t
 = 
iSèπOff£t
;

613 *
piEndOff£t
 = 
c
->
iOff£t
;

614 *
piPosôi⁄
 = 
c
->
iTokí
++;

615  
SQLITE4_OK
;

618  
SQLITE4_DONE
;

619 
	}
}

624 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gp‹ãrTokíizîModuÀ
 = {

626 
p‹ãrCª©e
,

627 
p‹ãrDe°roy
,

628 
p‹ãrO≥n
,

629 
p‹ãrClo£
,

630 
p‹ãrNext
,

637 
	$sqlôe4Fts1P‹ãrTokíizîModuÀ
(

638 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


640 *
µModuÀ
 = &
p‹ãrTokíizîModuÀ
;

641 
	}
}

	@ext/fts1/fts1_tokenizer.h

20 #i‚de‡
_FTS1_TOKENIZER_H_


21 
	#_FTS1_TOKENIZER_H_


	)

27 
	~"sqlôe4.h
"

32 
sqlôe4_tokíizî
 
	tsqlôe4_tokíizî
;

33 
sqlôe4_tokíizî_curs‹
 
	tsqlôe4_tokíizî_curs‹
;

34 
sqlôe4_tokíizî_moduÀ
 
	tsqlôe4_tokíizî_moduÀ
;

36 
	ssqlôe4_tokíizî_moduÀ
 {

37 
	miVîsi⁄
;

43 (*
	mxCª©e
)(
	m¨gc
, c⁄° *c⁄°*
	m¨gv
,

44 
sqlôe4_tokíizî
 **
	mµTokíizî
);

45 (*
	mxDe°roy
)(
sqlôe4_tokíizî
 *
	mpTokíizî
);

59 (*
	mxO≥n
)(
sqlôe4_tokíizî
 *
	mpTokíizî
,

60 c⁄° *
	mpI≈ut
, 
	mnByãs
,

61 
sqlôe4_tokíizî_curs‹
 **
	mµCurs‹
);

62 (*
	mxClo£
)(
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
);

63 (*
	mxNext
)(
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
,

64 c⁄° **
	mµTokí
, *
	m≤Byãs
,

65 *
	mpiSèπOff£t
, *
	mpiEndOff£t
, *
	mpiPosôi⁄
);

68 
	ssqlôe4_tokíizî
 {

69 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
	mpModuÀ
;

73 
	ssqlôe4_tokíizî_curs‹
 {

74 
sqlôe4_tokíizî
 *
	mpTokíizî
;

87 
sqlôe4Fts1Sim∂eTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

88 
sqlôe4Fts1P‹ãrTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

	@ext/fts1/fts1_tokenizer1.c

17 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS1
)

20 
	~<as£π.h
>

21 
	~<°dlib.h
>

22 
	~<°dio.h
>

23 
	~<°rög.h
>

24 
	~<˘y≥.h
>

26 
	~"·s1_tokíizî.h
"

28 
	ssim∂e_tokíizî
 {

29 
sqlôe4_tokíizî
 
	mba£
;

30 
	mdñim
[128];

31 } 
	tsim∂e_tokíizî
;

33 
	ssim∂e_tokíizî_curs‹
 {

34 
sqlôe4_tokíizî_curs‹
 
	mba£
;

35 c⁄° *
	mpI≈ut
;

36 
	mnByãs
;

37 
	miOff£t
;

38 
	miTokí
;

39 *
	mpTokí
;

40 
	mnTokíAŒoˇãd
;

41 } 
	tsim∂e_tokíizî_curs‹
;

45 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
;

47 
	$isDñim
(
sim∂e_tokíizî
 *
t
, 
c
){

48  
c
<0x80 && 
t
->
dñim
[c];

49 
	}
}

54 
	$sim∂eCª©e
(

55 
¨gc
, c⁄° * c⁄° *
¨gv
,

56 
sqlôe4_tokíizî
 **
µTokíizî


58 
sim∂e_tokíizî
 *
t
;

60 
t
 = (
sim∂e_tokíizî
 *Ë
	`ˇŒoc
((*t), 1);

61 if–
t
==
NULL
 )  
SQLITE4_NOMEM
;

68 if–
¨gc
>1 ){

69 
i
, 
n
 = 
	`°æí
(
¨gv
[1]);

70 
i
=0; i<
n
; i++){

71 
ch
 = 
¨gv
[1][
i
];

73 if–
ch
>=0x80 ){

74 
	`‰ì
(
t
);

75  
SQLITE4_ERROR
;

77 
t
->
dñim
[
ch
] = 1;

81 
i
;

82 
i
=1; i<0x80; i++){

83 
t
->
dñim
[
i
] = !
	`iß um
(i);

87 *
µTokíizî
 = &
t
->
ba£
;

88  
SQLITE4_OK
;

89 
	}
}

94 
	$sim∂eDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

95 
	`‰ì
(
pTokíizî
);

96  
SQLITE4_OK
;

97 
	}
}

105 
	$sim∂eO≥n
(

106 
sqlôe4_tokíizî
 *
pTokíizî
,

107 c⁄° *
pI≈ut
, 
nByãs
,

108 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


110 
sim∂e_tokíizî_curs‹
 *
c
;

112 
c
 = (
sim∂e_tokíizî_curs‹
 *Ë
	`mÆloc
((*c));

113 if–
c
==
NULL
 )  
SQLITE4_NOMEM
;

115 
c
->
pI≈ut
 =ÖInput;

116 if–
pI≈ut
==0 ){

117 
c
->
nByãs
 = 0;

118 }if–
nByãs
<0 ){

119 
c
->
nByãs
 = ()
	`°æí
(
pI≈ut
);

121 
c
->
nByãs
 =ÇBytes;

123 
c
->
iOff£t
 = 0;

124 
c
->
iTokí
 = 0;

125 
c
->
pTokí
 = 
NULL
;

126 
c
->
nTokíAŒoˇãd
 = 0;

128 *
µCurs‹
 = &
c
->
ba£
;

129  
SQLITE4_OK
;

130 
	}
}

136 
	$sim∂eClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

137 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

138 
	`‰ì
(
c
->
pTokí
);

139 
	`‰ì
(
c
);

140  
SQLITE4_OK
;

141 
	}
}

147 
	$sim∂eNext
(

148 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

149 c⁄° **
µTokí
,

150 *
≤Byãs
,

151 *
piSèπOff£t
,

152 *
piEndOff£t
,

153 *
piPosôi⁄


155 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

156 
sim∂e_tokíizî
 *
t
 = (sim∂e_tokíizî *Ë
pCurs‹
->
pTokíizî
;

157 *
p
 = (*)
c
->
pI≈ut
;

159  
c
->
iOff£t
<c->
nByãs
 ){

160 
iSèπOff£t
;

163  
c
->
iOff£t
<c->
nByãs
 && 
	`isDñim
(
t
, 
p
[c->iOffset]) ){

164 
c
->
iOff£t
++;

168 
iSèπOff£t
 = 
c
->
iOff£t
;

169  
c
->
iOff£t
<c->
nByãs
 && !
	`isDñim
(
t
, 
p
[c->iOffset]) ){

170 
c
->
iOff£t
++;

173 if–
c
->
iOff£t
>
iSèπOff£t
 ){

174 
i
, 
n
 = 
c
->
iOff£t
-
iSèπOff£t
;

175 if–
n
>
c
->
nTokíAŒoˇãd
 ){

176 
c
->
nTokíAŒoˇãd
 = 
n
+20;

177 
c
->
pTokí
 = 
	`ªÆloc
(c->pTokí, c->
nTokíAŒoˇãd
);

178 if–
c
->
pTokí
==
NULL
 )  
SQLITE4_NOMEM
;

180 
i
=0; i<
n
; i++){

184 
ch
 = 
p
[
iSèπOff£t
+
i
];

185 
c
->
pTokí
[
i
] = 
ch
<0x80 ? 
	`tﬁowî
(ch) : ch;

187 *
µTokí
 = 
c
->
pTokí
;

188 *
≤Byãs
 = 
n
;

189 *
piSèπOff£t
 = 
iSèπOff£t
;

190 *
piEndOff£t
 = 
c
->
iOff£t
;

191 *
piPosôi⁄
 = 
c
->
iTokí
++;

193  
SQLITE4_OK
;

196  
SQLITE4_DONE
;

197 
	}
}

202 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
 = {

204 
sim∂eCª©e
,

205 
sim∂eDe°roy
,

206 
sim∂eO≥n
,

207 
sim∂eClo£
,

208 
sim∂eNext
,

215 
	$sqlôe4Fts1Sim∂eTokíizîModuÀ
(

216 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


218 *
µModuÀ
 = &
sim∂eTokíizîModuÀ
;

219 
	}
}

	@ext/fts1/fulltext.c

6 
	~<as£π.h
>

7 #i‡!
deföed
(
__APPLE__
)

8 
	~<mÆloc.h
>

10 
	~<°dlib.h
>

12 
	~<°dio.h
>

13 
	~<°rög.h
>

14 
	~<˘y≥.h
>

16 
	~"fuŒãxt.h
"

17 
	~"·_hash.h
"

18 
	~"tokíizî.h
"

19 
	~"sqlôe4.h
"

20 
	~"sqlôe4ext.h
"

21 
	gSQLITE4_EXTENSION_INIT1


39 
	#VARINT_MAX
 10

	)

44 
	$putV¨öt
(*
p
, 
sqlôe_öt64
 
v
){

45 *
q
 = (*Ë
p
;

46 
sqlôe_uöt64
 
vu
 = 
v
;

48 *
q
++ = (Ë((
vu
 & 0x7f) | 0x80);

49 
vu
 >>= 7;

50 } 
vu
!=0 );

51 
q
[-1] &= 0x7f;

52 
	`as£π
–
q
 - (*)
p
 <
VARINT_MAX
 );

53  (Ë(
q
 - (*)
p
);

54 
	}
}

59 
	$gëV¨öt
(c⁄° *
p
, 
sqlôe_öt64
 *
v
){

60 c⁄° *
q
 = (c⁄° *Ë
p
;

61 
sqlôe_uöt64
 
x
 = 0, 
y
 = 1;

62  (*
q
 & 0x80) == 0x80 ){

63 
x
 +
y
 * (*
q
++ & 0x7f);

64 
y
 <<= 7;

65 if–
q
 - (*)
p
 >
VARINT_MAX
 ){

66 
	`as£π
( 0 );

70 
x
 +
y
 * (*
q
++);

71 *
v
 = (
sqlôe_öt64
Ë
x
;

72  (Ë(
q
 - (*)
p
);

73 
	}
}

75 
	$gëV¨öt32
(c⁄° *
p
, *
pi
){

76 
sqlôe_öt64
 
i
;

77 
ªt
 = 
	`gëV¨öt
(
p
, &
i
);

78 *
pi
 = (Ë
i
;

79 
	`as£π
–*
pi
==
i
 );

80  
ªt
;

81 
	}
}

123 
	eDocLi°Ty≥
 {

124 
	mDL_DOCIDS
,

125 
	mDL_POSITIONS
,

126 
	mDL_POSITIONS_OFFSETS


127 } 
	tDocLi°Ty≥
;

129 
	sDocLi°
 {

130 *
	mpD©a
;

131 
	mnD©a
;

132 
DocLi°Ty≥
 
	miTy≥
;

133 
	miLa°Pos
;

134 
	miLa°Off£t
;

135 } 
	tDocLi°
;

138 
	$docLi°Inô
(
DocLi°
 *
d
, 
DocLi°Ty≥
 
iTy≥
,

139 c⁄° *
pD©a
, 
nD©a
){

140 
d
->
nD©a
 =ÇData;

141 if–
nD©a
>0 ){

142 
d
->
pD©a
 = 
	`mÆloc
(
nD©a
);

143 
	`mem˝y
(
d
->
pD©a
,ÖD©a, 
nD©a
);

145 
d
->
pD©a
 = 
NULL
;

147 
d
->
iTy≥
 = iType;

148 
d
->
iLa°Pos
 = 0;

149 
d
->
iLa°Off£t
 = 0;

150 
	}
}

153 
DocLi°
 *
	$docLi°New
(
DocLi°Ty≥
 
iTy≥
){

154 
DocLi°
 *
d
 = (DocLi° *Ë
	`mÆloc
((DocList));

155 
	`docLi°Inô
(
d
, 
iTy≥
, 0, 0);

156  
d
;

157 
	}
}

159 
	$docLi°De°roy
(
DocLi°
 *
d
){

160 
	`‰ì
(
d
->
pD©a
);

161 #i‚de‡
NDEBUG


162 
	`mem£t
(
d
, 0x55, (*d));

164 
	}
}

166 
	$docLi°Dñëe
(
DocLi°
 *
d
){

167 
	`docLi°De°roy
(
d
);

168 
	`‰ì
(
d
);

169 
	}
}

171 *
	$docLi°End
(
DocLi°
 *
d
){

172  
d
->
pD©a
 + d->
nD©a
;

173 
	}
}

176 
	$≠≥ndV¨öt
(
DocLi°
 *
d
, 
sqlôe_öt64
 
i
){

177 
c
[
VARINT_MAX
];

178 
n
 = 
	`putV¨öt
(
c
, 
i
);

179 
d
->
pD©a
 = 
	`ªÆloc
(d->pD©a, d->
nD©a
 + 
n
);

180 
	`mem˝y
(
d
->
pD©a
 + d->
nD©a
, 
c
, 
n
);

181 
d
->
nD©a
 +
n
;

182 
	}
}

184 
	$docLi°AddDocid
(
DocLi°
 *
d
, 
sqlôe_öt64
 
iDocid
){

185 
	`≠≥ndV¨öt
(
d
, 
iDocid
);

186 
d
->
iLa°Pos
 = 0;

187 
	}
}

190 
	$docLi°AddPos
(
DocLi°
 *
d
, 
iPos
){

191 
	`as£π
–
d
->
iTy≥
>=
DL_POSITIONS
 );

192 
	`≠≥ndV¨öt
(
d
, 
iPos
-d->
iLa°Pos
+1);

193 
d
->
iLa°Pos
 = 
iPos
;

194 
	}
}

196 
	$docLi°AddPosOff£t
(
DocLi°
 *
d
, 
iPos
,

197 
iSèπOff£t
, 
iEndOff£t
){

198 
	`as£π
–
d
->
iTy≥
==
DL_POSITIONS_OFFSETS
 );

199 
	`docLi°AddPos
(
d
, 
iPos
);

200 
	`≠≥ndV¨öt
(
d
, 
iSèπOff£t
-d->
iLa°Off£t
);

201 
d
->
iLa°Off£t
 = 
iSèπOff£t
;

202 
	`≠≥ndV¨öt
(
d
, 
iEndOff£t
-
iSèπOff£t
);

203 
	}
}

206 
	$docLi°AddEndPos
(
DocLi°
 *
d
){

207 
	`≠≥ndV¨öt
(
d
, 0);

208 
	}
}

210 
	sDocLi°Ródî
 {

211 
DocLi°
 *
	mpDo˛i°
;

212 *
	mp
;

213 
	miLa°Pos
;

214 } 
	tDocLi°Ródî
;

216 
	$ªadîInô
(
DocLi°Ródî
 *
r
, 
DocLi°
 *
pDo˛i°
){

217 
r
->
pDo˛i°
 =ÖDoclist;

218 if–
pDo˛i°
!=
NULL
 ){

219 
r
->
p
 = 
pDo˛i°
->
pD©a
;

221 
r
->
iLa°Pos
 = 0;

222 
	}
}

224 
	$ªadîAtEnd
(
DocLi°Ródî
 *
pRódî
){

225  
pRódî
->
p
 >
	`docLi°End
’Ródî->
pDo˛i°
);

226 
	}
}

229 
sqlôe_öt64
 
	$≥ekDocid
(
DocLi°Ródî
 *
pRódî
){

230 
sqlôe_öt64
 
ªt
;

231 
	`as£π
–!
	`ªadîAtEnd
(
pRódî
) );

232 
	`gëV¨öt
(
pRódî
->
p
, &
ªt
);

233  
ªt
;

234 
	}
}

237 
sqlôe_öt64
 
	$ªadDocid
(
DocLi°Ródî
 *
pRódî
){

238 
sqlôe_öt64
 
ªt
;

239 
	`as£π
–!
	`ªadîAtEnd
(
pRódî
) );

240 
pRódî
->
p
 +
	`gëV¨öt
’Ródî->p, &
ªt
);

241 
pRódî
->
iLa°Pos
 = 0;

242  
ªt
;

243 
	}
}

247 
	$ªadPosôi⁄
(
DocLi°Ródî
 *
pRódî
){

248 
i
;

249 
iTy≥
 = 
pRódî
->
pDo˛i°
->iType;

250 
	`as£π
–
iTy≥
>=
DL_POSITIONS
 );

251 
	`as£π
–!
	`ªadîAtEnd
(
pRódî
) );

253 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
i
);

254 if–
i
==0 ){

255 
pRódî
->
iLa°Pos
 = -1;

258 
pRódî
->
iLa°Pos
 +((Ë
i
)-1;

259 if–
iTy≥
>=
DL_POSITIONS_OFFSETS
 ){

261 
iSèπ
, 
iEnd
;

262 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
iSèπ
);

263 
pRódî
->
p
 +
	`gëV¨öt32
’Ródî->p, &
iEnd
);

265  
pRódî
->
iLa°Pos
;

266 
	}
}

269 
	$skùPosôi⁄Li°
(
DocLi°Ródî
 *
pRódî
){

270  
	`ªadPosôi⁄
(
pRódî
)!=-1 )

272 
	}
}

276 
	$skùDocumít
(
DocLi°Ródî
 *
pRódî
){

277 
	`ªadDocid
(
pRódî
);

278 if–
pRódî
->
pDo˛i°
->
iTy≥
 >
DL_POSITIONS
 ){

279 
	`skùPosôi⁄Li°
(
pRódî
);

281 
	}
}

283 
sqlôe_öt64
 
	$fú°Docid
(
DocLi°
 *
d
){

284 
DocLi°Ródî
 
r
;

285 
	`ªadîInô
(&
r
, 
d
);

286  
	`ªadDocid
(&
r
);

287 
	}
}

292 
	$docLi°Upd©e
(
DocLi°
 *
d
, 
sqlôe_öt64
 
iDocid
, DocLi° *
pUpd©e
){

293 
modifõd
 = 0;

294 
DocLi°Ródî
 
ªadî
;

295 *
p
;

297 if–
pUpd©e
!=
NULL
 ){

298 
	`as£π
–
d
->
iTy≥
==
pUpd©e
->iType);

299 
	`as£π
–
iDocid
==
	`fú°Docid
(
pUpd©e
) );

302 
	`ªadîInô
(&
ªadî
, 
d
);

303  !
	`ªadîAtEnd
(&
ªadî
Ë&& 
	`≥ekDocid
(&ªadî)<
iDocid
 ){

304 
	`skùDocumít
(&
ªadî
);

307 
p
 = 
ªadî
.p;

309 if–!
	`ªadîAtEnd
(&
ªadî
Ë&& 
iDocid
==
	`≥ekDocid
(&reader) ){

310 
	`skùDocumít
(&
ªadî
);

311 
	`memmove
(
p
, 
ªadî
.p, 
	`docLi°End
(
d
) -Ñeader.p);

312 
d
->
nD©a
 -(
ªadî
.
p
 -Ö);

313 
modifõd
 = 1;

317 if–
pUpd©e
!=
NULL
 ){

318 
iDo˛i°
 = 
p
-
d
->
pD©a
;

319 
	`docLi°AddEndPos
(
pUpd©e
);

321 
d
->
pD©a
 = 
	`ªÆloc
(d->pD©a, d->
nD©a
+
pUpd©e
->nData);

322 
p
 = 
d
->
pD©a
 + 
iDo˛i°
;

324 
	`memmove
(
p
+
pUpd©e
->
nD©a
,Ö, 
	`docLi°End
(
d
) -Ö);

325 
	`mem˝y
(
p
, 
pUpd©e
->
pD©a
,ÖUpd©e->
nD©a
);

326 
d
->
nD©a
 +
pUpd©e
->nData;

327 
modifõd
 = 1;

330  
modifõd
;

331 
	}
}

336 
	$docLi°S∂ô
(
DocLi°
 *
d
, DocLi° *
d2
){

337 c⁄° *
pS∂ôPoöt
 = 
d
->
pD©a
 + d->
nD©a
 / 2;

338 
DocLi°Ródî
 
ªadî
;

340 
	`ªadîInô
(&
ªadî
, 
d
);

341  
ªadî
.
p
<
pS∂ôPoöt
 ){

342 
	`skùDocumít
(&
ªadî
);

344 if–
	`ªadîAtEnd
(&
ªadî
) )  0;

345 
	`docLi°Inô
(
d2
, 
d
->
iTy≥
, 
ªadî
.
p
, 
	`docLi°End
(d) -Ñeader.p);

346 
d
->
nD©a
 = 
ªadî
.
p
 - d->
pD©a
;

347 
d
->
pD©a
 = 
	`ªÆloc
(d->pD©a, d->
nD©a
);

349 
	}
}

374 
	sDocLi°Mîge
 {

375 
DocLi°Ródî
 
	mö
;

376 
DocLi°
 *
	mpOut
;

377 
	miOff£t
;

378 } 
	tDocLi°Mîge
;

380 
	$mîgeInô
(
DocLi°Mîge
 *
m
,

381 
DocLi°
 *
pIn
, 
iOff£t
, DocLi° *
pOut
){

382 
	`ªadîInô
(&
m
->
ö
, 
pIn
);

383 
m
->
pOut
 =ÖOut;

384 
m
->
iOff£t
 = iOffset;

387 
	`as£π
–
pIn
==
NULL
 ||ÖIn->
iTy≥
 <
DL_POSITIONS
 );

388 
	`as£π
–
pOut
->
iTy≥
 <
DL_POSITIONS
 );

389 
	}
}

395 
	$mîgePosLi°
(
DocLi°Mîge
 *
m
, 
sqlôe_öt64
 
iDocid
,

396 
DocLi°Ródî
 *
pBlockRódî
){

397 
block_pos
 = 
	`ªadPosôi⁄
(
pBlockRódî
);

398 
ö_pos
 = 
	`ªadPosôi⁄
(&
m
->
ö
);

399 
m©ch
 = 0;

400  
block_pos
!=-1 || 
ö_pos
!=-1 ){

401 if–
block_pos
-
m
->
iOff£t
==
ö_pos
 ){

402 if–!
m©ch
 ){

403 
	`docLi°AddDocid
(
m
->
pOut
, 
iDocid
);

404 
m©ch
 = 1;

406 if–
m
->
pOut
->
iTy≥
 >
DL_POSITIONS
 ){

407 
	`docLi°AddPos
(
m
->
pOut
, 
ö_pos
);

409 
block_pos
 = 
	`ªadPosôi⁄
(
pBlockRódî
);

410 
ö_pos
 = 
	`ªadPosôi⁄
(&
m
->
ö
);

411 } if–
ö_pos
==-1 || (
block_pos
!=-1 && block_pos-
m
->
iOff£t
<in_pos) ){

412 
block_pos
 = 
	`ªadPosôi⁄
(
pBlockRódî
);

414 
ö_pos
 = 
	`ªadPosôi⁄
(&
m
->
ö
);

417 if–
m
->
pOut
->
iTy≥
 >
DL_POSITIONS
 && 
m©ch
 ){

418 
	`docLi°AddEndPos
(
m
->
pOut
);

420 
	}
}

423 
	$mîgeBlock
(
DocLi°Mîge
 *
m
, 
DocLi°
 *
pBlock
){

424 
DocLi°Ródî
 
blockRódî
;

425 
	`as£π
–
pBlock
->
iTy≥
 >
DL_POSITIONS
 );

426 
	`ªadîInô
(&
blockRódî
, 
pBlock
);

427  !
	`ªadîAtEnd
(&
blockRódî
) ){

428 
sqlôe_öt64
 
iDocid
 = 
	`ªadDocid
(&
blockRódî
);

429 if–
m
->
ö
.
pDo˛i°
!=
NULL
 ){

431 if–
	`ªadîAtEnd
(&
m
->
ö
) ) ;

432 if–
	`≥ekDocid
(&
m
->
ö
)>=
iDocid
 ) ;

433 
	`skùDocumít
(&
m
->
ö
);

435 if–
	`≥ekDocid
(&
m
->
ö
)>
iDocid
 ){

436 
	`skùPosôi⁄Li°
(&
blockRódî
);

439 
	`ªadDocid
(&
m
->
ö
);

442 if–
m
->
ö
.
pDo˛i°
==
NULL
 || m->ö.pDo˛i°->
iTy≥
 < 
DL_POSITIONS
 ){

444 
	`docLi°AddDocid
(
m
->
pOut
, 
iDocid
);

445 if–
m
->
pOut
->
iTy≥
 >
DL_POSITIONS
 ){

448 
pos
 = 
	`ªadPosôi⁄
(&
blockRódî
);

449 if–
pos
==-1 ) ;

450 
	`docLi°AddPos
(
m
->
pOut
, 
pos
);

452 
	`docLi°AddEndPos
(
m
->
pOut
);

453 } 
	`skùPosôi⁄Li°
(&
blockRódî
);

456 
	`mîgePosLi°
(
m
, 
iDocid
, &
blockRódî
);

458 
	}
}

460 *
	$°rög_dup_n
(c⁄° *
s
, 
n
){

461 *
°r
 = 
	`mÆloc
(
n
 + 1);

462 
	`mem˝y
(
°r
, 
s
, 
n
);

463 
°r
[
n
] = '\0';

464  
°r
;

465 
	}
}

470 *
	$°rög_dup
(c⁄° *
s
){

471  
	`°rög_dup_n
(
s
, 
	`°æí
(s));

472 
	}
}

478 *
	$°rög_f‹m©
(c⁄° *
zF‹m©
, c⁄° *
zName
){

479 c⁄° *
p
;

480 
size_t
 
Àn
 = 0;

481 
size_t
 
nName
 = 
	`°æí
(
zName
);

482 *
ªsu…
;

483 *
r
;

486 
p
 = 
zF‹m©
 ; *p ; ++p){

487 
Àn
 +(*
p
=='%' ? 
nName
 : 1);

489 
Àn
 += 1;

491 
r
 = 
ªsu…
 = 
	`mÆloc
(
Àn
);

492 
p
 = 
zF‹m©
; *p; ++p){

493 if–*
p
=='%' ){

494 
	`mem˝y
(
r
, 
zName
, 
nName
);

495 
r
 +
nName
;

497 *
r
++ = *
p
;

500 *
r
++ = '\0';

501 
	`as£π
–
r
 =
ªsu…
 + 
Àn
 );

502  
ªsu…
;

503 
	}
}

505 
	$sql_exec
(
sqlôe4
 *
db
, c⁄° *
zName
, c⁄° *
zF‹m©
){

506 *
zComm™d
 = 
	`°rög_f‹m©
(
zF‹m©
, 
zName
);

507 
rc
 = 
	`sqlôe4_exec
(
db
, 
zComm™d
, 
NULL
, 0, NULL);

508 
	`‰ì
(
zComm™d
);

509  
rc
;

510 
	}
}

512 
	$sql_¥ï¨e
(
sqlôe4
 *
db
, c⁄° *
zName
, 
sqlôe4_°mt
 **
µStmt
,

513 c⁄° *
zF‹m©
){

514 *
zComm™d
 = 
	`°rög_f‹m©
(
zF‹m©
, 
zName
);

515 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zComm™d
, -1, 
µStmt
, 
NULL
);

516 
	`‰ì
(
zComm™d
);

517  
rc
;

518 
	}
}

522 
	#QUERY_GENERIC
 0

	)

523 
	#QUERY_FULLTEXT
 1

	)

525 
	#CHUNK_MAX
 1024

	)

527 
	efuŒãxt_°©emít
 {

528 
	mCONTENT_INSERT_STMT
,

529 
	mCONTENT_SELECT_STMT
,

530 
	mCONTENT_DELETE_STMT
,

532 
	mTERM_SELECT_STMT
,

533 
	mTERM_CHUNK_SELECT_STMT
,

534 
	mTERM_INSERT_STMT
,

535 
	mTERM_UPDATE_STMT
,

536 
	mTERM_DELETE_STMT
,

538 
	mMAX_STMT


539 } 
	tfuŒãxt_°©emít
;

547 c⁄° *
	gfuŒãxt_zSèãmít
[
MAX_STMT
] = {

562 
	sfuŒãxt_vèb
 {

563 
sqlôe4_vèb
 
	mba£
;

564 
sqlôe4
 *
	mdb
;

565 c⁄° *
	mzName
;

566 
sqlôe4_tokíizî
 *
	mpTokíizî
;

571 
sqlôe4_°mt
 *
	mpFuŒãxtSèãmíts
[
MAX_STMT
];

572 } 
	tfuŒãxt_vèb
;

574 
	sfuŒãxt_curs‹
 {

575 
sqlôe4_vèb_curs‹
 
	mba£
;

576 
	miCurs‹Ty≥
;

578 
sqlôe4_°mt
 *
	mpStmt
;

580 
	meof
;

583 
DocLi°Ródî
 
	mªsu…
;

584 } 
	tfuŒãxt_curs‹
;

586 
fuŒãxt_vèb
 *
	$curs‹_vèb
(
fuŒãxt_curs‹
 *
c
){

587  (
fuŒãxt_vèb
 *Ë
c
->
ba£
.
pVèb
;

588 
	}
}

590 
sqlôe4_moduÀ
 
	gfuŒãxtModuÀ
;

596 
	$sql_gë_°©emít
(
fuŒãxt_vèb
 *
v
, 
fuŒãxt_°©emít
 
iStmt
,

597 
sqlôe4_°mt
 **
µStmt
){

598 
	`as£π
–
iStmt
<
MAX_STMT
 );

599 if–
v
->
pFuŒãxtSèãmíts
[
iStmt
]==
NULL
 ){

600 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zName
, &v->
pFuŒãxtSèãmíts
[
iStmt
],

601 
fuŒãxt_zSèãmít
[
iStmt
]);

602 if–
rc
!=
SQLITE4_OK
 ) Ñc;

604 
rc
 = 
	`sqlôe4_ª£t
(
v
->
pFuŒãxtSèãmíts
[
iStmt
]);

605 if–
rc
!=
SQLITE4_OK
 ) Ñc;

608 *
µStmt
 = 
v
->
pFuŒãxtSèãmíts
[
iStmt
];

609  
SQLITE4_OK
;

610 
	}
}

618 
	$sql_°ï_°©emít
(
fuŒãxt_vèb
 *
v
, 
fuŒãxt_°©emít
 
iStmt
,

619 
sqlôe4_°mt
 **
µStmt
){

620 
rc
;

621 
sqlôe4_°mt
 *
s
 = *
µStmt
;

622 
	`as£π
–
iStmt
<
MAX_STMT
 );

623 
	`as£π
–
s
==
v
->
pFuŒãxtSèãmíts
[
iStmt
] );

625  (
rc
=
	`sqlôe4_°ï
(
s
))!=
SQLITE4_DONE
 &&Ñc!=
SQLITE4_ROW
 ){

626 
sqlôe4_°mt
 *
pNewStmt
;

628 if–
rc
==
SQLITE4_BUSY
 ) ;

629 if–
rc
!=
SQLITE4_ERROR
 ) Ñc;

631 
rc
 = 
	`sqlôe4_ª£t
(
s
);

632 if–
rc
!=
SQLITE4_SCHEMA
 )  
SQLITE4_ERROR
;

634 
v
->
pFuŒãxtSèãmíts
[
iStmt
] = 
NULL
;

635 
rc
 = 
	`sql_gë_°©emít
(
v
, 
iStmt
, &
pNewStmt
);

636 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

637 *
µStmt
 = 
pNewStmt
;

639 
rc
 = 
	`sqlôe4_å™s„r_bödögs
(
s
, 
pNewStmt
);

640 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

642 
rc
 = 
	`sqlôe4_föÆize
(
s
);

643 if–
rc
!=
SQLITE4_OK
 ) Ñc;

644 
s
 = 
pNewStmt
;

646  
rc
;

648 
îr
:

649 
	`sqlôe4_föÆize
(
s
);

650  
rc
;

651 
	}
}

656 
	$sql_sögÀ_°ï_°©emít
(
fuŒãxt_vèb
 *
v
,

657 
fuŒãxt_°©emít
 
iStmt
,

658 
sqlôe4_°mt
 **
µStmt
){

659 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
iStmt
, 
µStmt
);

660  (
rc
==
SQLITE4_DONE
Ë? 
SQLITE4_OK
 :Ñc;

661 
	}
}

664 
	$c⁄ã¡_ö£π
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 *
rowid
,

665 c⁄° *
zC⁄ã¡
, 
nC⁄ã¡
){

666 
sqlôe4_°mt
 *
s
;

667 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_INSERT_STMT
, &
s
);

668 if–
rc
!=
SQLITE4_OK
 ) Ñc;

670 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 1, 
rowid
);

671 if–
rc
!=
SQLITE4_OK
 ) Ñc;

673 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 2, 
zC⁄ã¡
, 
nC⁄ã¡
, 
SQLITE4_STATIC
);

674 if–
rc
!=
SQLITE4_OK
 ) Ñc;

676  
	`sql_sögÀ_°ï_°©emít
(
v
, 
CONTENT_INSERT_STMT
, &
s
);

677 
	}
}

681 
	$c⁄ã¡_£À˘
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
,

682 **
pzC⁄ã¡
){

683 
sqlôe4_°mt
 *
s
;

684 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_SELECT_STMT
, &
s
);

685 if–
rc
!=
SQLITE4_OK
 ) Ñc;

687 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iRow
);

688 if–
rc
!=
SQLITE4_OK
 ) Ñc;

690 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
CONTENT_SELECT_STMT
, &
s
);

691 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

693 *
pzC⁄ã¡
 = 
	`°rög_dup
((c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
s
, 0));

697 
rc
 = 
	`sqlôe4_°ï
(
s
);

698 if–
rc
==
SQLITE4_DONE
 )  
SQLITE4_OK
;

700 
	`‰ì
(*
pzC⁄ã¡
);

701  
rc
;

702 
	}
}

705 
	$c⁄ã¡_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
){

706 
sqlôe4_°mt
 *
s
;

707 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_DELETE_STMT
, &
s
);

708 if–
rc
!=
SQLITE4_OK
 ) Ñc;

710 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iRow
);

711 if–
rc
!=
SQLITE4_OK
 ) Ñc;

713  
	`sql_sögÀ_°ï_°©emít
(
v
, 
CONTENT_DELETE_STMT
, &
s
);

714 
	}
}

719 
	$ãrm_£À˘
(
fuŒãxt_vèb
 *
v
, c⁄° *
zTîm
, 
nTîm
,

720 
sqlôe_öt64
 
iFú°
,

721 
sqlôe_öt64
 *
rowid
,

722 
DocLi°
 *
out
){

723 
sqlôe4_°mt
 *
s
;

724 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_SELECT_STMT
, &
s
);

725 if–
rc
!=
SQLITE4_OK
 ) Ñc;

727 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 1, 
zTîm
, 
nTîm
, 
SQLITE4_TRANSIENT
);

728 if–
rc
!=
SQLITE4_OK
 ) Ñc;

730 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
iFú°
);

731 if–
rc
!=
SQLITE4_OK
 ) Ñc;

733 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
TERM_SELECT_STMT
, &
s
);

734 if–
rc
!=
SQLITE4_ROW
 ) Ñc==
SQLITE4_DONE
 ? 
SQLITE4_ERROR
 :Ñc;

736 *
rowid
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

737 
	`docLi°Inô
(
out
, 
DL_POSITIONS_OFFSETS
,

738 
	`sqlôe4_cﬁumn_blob
(
s
, 1), 
	`sqlôe4_cﬁumn_byãs
(s, 1));

742 
rc
 = 
	`sqlôe4_°ï
(
s
);

743  
rc
==
SQLITE4_DONE
 ? 
SQLITE4_OK
 :Ñc;

744 
	}
}

750 
	$ãrm_chunk_£À˘
(
fuŒãxt_vèb
 *
v
, c⁄° *
zTîm
, 
nTîm
,

751 
sqlôe_öt64
 
iFú°
, sqlôe_öt64 *
piResu…
){

752 
sqlôe4_°mt
 *
s
;

753 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_CHUNK_SELECT_STMT
, &
s
);

754 if–
rc
!=
SQLITE4_OK
 ) Ñc;

756 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 1, 
zTîm
, 
nTîm
, 
SQLITE4_STATIC
);

757 if–
rc
!=
SQLITE4_OK
 ) Ñc;

759 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
iFú°
);

760 if–
rc
!=
SQLITE4_OK
 ) Ñc;

762 
rc
 = 
	`sql_°ï_°©emít
(
v
, 
TERM_CHUNK_SELECT_STMT
, &
s
);

763 if–
rc
!=
SQLITE4_ROW
 ) Ñc==
SQLITE4_DONE
 ? 
SQLITE4_ERROR
 :Ñc;

765  
	`sqlôe4_cﬁumn_ty≥
(
s
, 0) ){

766 
SQLITE4_NULL
:

767 
rc
 = 
SQLITE4_DONE
;

769 
SQLITE4_INTEGER
:

770 *
piResu…
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

773  
SQLITE4_ERROR
;

777 if–
	`sqlôe4_°ï
(
s
Ë!
SQLITE4_DONE
 )  
SQLITE4_ERROR
;

778  
rc
;

779 
	}
}

783 
	$ãrm_ö£π
(
fuŒãxt_vèb
 *
v
, c⁄° *
zTîm
, 
nTîm
,

784 
sqlôe_öt64
 
iFú°
, 
DocLi°
 *
do˛i°
){

785 
sqlôe4_°mt
 *
s
;

786 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_INSERT_STMT
, &
s
);

787 if–
rc
!=
SQLITE4_OK
 ) Ñc;

789 
rc
 = 
	`sqlôe4_böd_ãxt
(
s
, 1, 
zTîm
, 
nTîm
, 
SQLITE4_STATIC
);

790 if–
rc
!=
SQLITE4_OK
 ) Ñc;

792 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
iFú°
);

793 if–
rc
!=
SQLITE4_OK
 ) Ñc;

795 
rc
 = 
	`sqlôe4_böd_blob
(
s
, 3, 
do˛i°
->
pD©a
, do˛i°->
nD©a
, 
SQLITE4_STATIC
);

796 if–
rc
!=
SQLITE4_OK
 ) Ñc;

798  
	`sql_sögÀ_°ï_°©emít
(
v
, 
TERM_INSERT_STMT
, &
s
);

799 
	}
}

802 
	$ãrm_upd©e
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
rowid
,

803 
DocLi°
 *
do˛i°
){

804 
sqlôe4_°mt
 *
s
;

805 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_UPDATE_STMT
, &
s
);

806 if–
rc
!=
SQLITE4_OK
 ) Ñc;

808 
rc
 = 
	`sqlôe4_böd_blob
(
s
, 1, 
do˛i°
->
pD©a
, do˛i°->
nD©a
,

809 
SQLITE4_STATIC
);

810 if–
rc
!=
SQLITE4_OK
 ) Ñc;

812 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
rowid
);

813 if–
rc
!=
SQLITE4_OK
 ) Ñc;

815  
	`sql_sögÀ_°ï_°©emít
(
v
, 
TERM_UPDATE_STMT
, &
s
);

816 
	}
}

818 
	$ãrm_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
rowid
){

819 
sqlôe4_°mt
 *
s
;

820 
rc
 = 
	`sql_gë_°©emít
(
v
, 
TERM_DELETE_STMT
, &
s
);

821 if–
rc
!=
SQLITE4_OK
 ) Ñc;

823 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
rowid
);

824 if–
rc
!=
SQLITE4_OK
 ) Ñc;

826  
	`sql_sögÀ_°ï_°©emít
(
v
, 
TERM_DELETE_STMT
, &
s
);

827 
	}
}

829 
	$fuŒãxt_vèb_de°roy
(
fuŒãxt_vèb
 *
v
){

830 
iStmt
;

832  
iStmt
=0; iStmt<
MAX_STMT
; iStmt++ ){

833 if–
v
->
pFuŒãxtSèãmíts
[
iStmt
]!=
NULL
 ){

834 
	`sqlôe4_föÆize
(
v
->
pFuŒãxtSèãmíts
[
iStmt
]);

835 
v
->
pFuŒãxtSèãmíts
[
iStmt
] = 
NULL
;

839 if–
v
->
pTokíizî
!=
NULL
 ){

840 
v
->
pTokíizî
->
pModuÀ
->
	`xDe°roy
(v->pTokenizer);

841 
v
->
pTokíizî
 = 
NULL
;

844 
	`‰ì
((*Ë
v
->
zName
);

845 
	`‰ì
(
v
);

846 
	}
}

855 
	$fuŒãxtC⁄√˘
(
sqlôe4
 *
db
, *
pAux
, 
¨gc
, **
¨gv
,

856 
sqlôe4_vèb
 **
µVTab
){

857 
rc
;

858 
fuŒãxt_vèb
 *
v
;

859 
sqlôe4_tokíizî_moduÀ
 *
m
 = 
NULL
;

861 
	`as£π
–
¨gc
>=3 );

862 
v
 = (
fuŒãxt_vèb
 *Ë
	`mÆloc
((fulltext_vtab));

864 
v
->
db
 = db;

865 
v
->
zName
 = 
	`°rög_dup
(
¨gv
[2]);

866 
v
->
pTokíizî
 = 
NULL
;

868 if–
¨gc
==3 ){

869 
	`gë_sim∂e_tokíizî_moduÀ
(&
m
);

872 if–!
	`°rcmp
(
¨gv
[3], "simple") ){

873 
	`gë_sim∂e_tokíizî_moduÀ
(&
m
);

875 
	`as£π
–"uƒecognizedÅokíizî"==
NULL
 );

886 
rc
 = 
m
->
	`xCª©e
(
¨gc
-3, (c⁄° **Ë(
¨gv
+3), &
v
->
pTokíizî
);

887 if–
rc
!=
SQLITE4_OK
 ) Ñc;

888 
v
->
pTokíizî
->
pModuÀ
 = 
m
;

892 
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
db
, "createÅable x(contentÅext)");

893 if–
rc
!=
SQLITE4_OK
 ) Ñc;

895 
	`mem£t
(
v
->
pFuŒãxtSèãmíts
, 0, (v->pFulltextStatements));

897 *
µVTab
 = &
v
->
ba£
;

898  
SQLITE4_OK
;

899 
	}
}

901 
	$fuŒãxtCª©e
(
sqlôe4
 *
db
, *
pAux
, 
¨gc
, **
¨gv
,

902 
sqlôe4_vèb
 **
µVTab
){

903 
rc
;

904 
	`as£π
–
¨gc
>=3 );

931 
rc
 = 
	`sql_exec
(
db
, 
¨gv
[2],

935 if–
rc
!=
SQLITE4_OK
 ) Ñc;

937  
	`fuŒãxtC⁄√˘
(
db
, 
pAux
, 
¨gc
, 
¨gv
, 
µVTab
);

938 
	}
}

943 
	$fuŒãxtBe°Index
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_ödex_öfo
 *
pInfo
){

944 
i
;

946 
i
=0; i<
pInfo
->
nC⁄°øöt
; ++i){

947 c⁄° 
sqlôe4_ödex_c⁄°øöt
 *
pC⁄°øöt
;

948 
pC⁄°øöt
 = &
pInfo
->
aC⁄°øöt
[
i
];

949 if–
pC⁄°øöt
->
iCﬁumn
==0 &&

950 
pC⁄°øöt
->
›
==
SQLITE4_INDEX_CONSTRAINT_MATCH
 &&

951 
pC⁄°øöt
->
ußbÀ
 ){

952 
pInfo
->
aC⁄°øötUßge
[
i
].
¨gvIndex
 = 1;

953 
pInfo
->
aC⁄°øötUßge
[
i
].
omô
 = 1;

954 
pInfo
->
idxNum
 = 
QUERY_FULLTEXT
;

955 
pInfo
->
e°im©edCo°
 = 1.0;

956  
SQLITE4_OK
;

959 
pInfo
->
idxNum
 = 
QUERY_GENERIC
;

960  
SQLITE4_OK
;

961 
	}
}

963 
	$fuŒãxtDisc⁄√˘
(
sqlôe4_vèb
 *
pVTab
){

964 
	`fuŒãxt_vèb_de°roy
((
fuŒãxt_vèb
 *)
pVTab
);

965  
SQLITE4_OK
;

966 
	}
}

968 
	$fuŒãxtDe°roy
(
sqlôe4_vèb
 *
pVTab
){

969 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *)
pVTab
;

971 
rc
 = 
	`sql_exec
(
v
->
db
, v->
zName
,

973 if–
rc
!=
SQLITE4_OK
 ) Ñc;

975 
	`fuŒãxt_vèb_de°roy
((
fuŒãxt_vèb
 *)
pVTab
);

976  
SQLITE4_OK
;

977 
	}
}

979 
	$fuŒãxtO≥n
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µCurs‹
){

980 
fuŒãxt_curs‹
 *
c
;

982 
c
 = (
fuŒãxt_curs‹
 *Ë
	`ˇŒoc
((fulltext_cursor), 1);

984 *
µCurs‹
 = &
c
->
ba£
;

986  
SQLITE4_OK
;

987 
	}
}

989 
	$fuŒãxtClo£
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

990 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

991 
	`sqlôe4_föÆize
(
c
->
pStmt
);

992 if–
c
->
ªsu…
.
pDo˛i°
!=
NULL
 ){

993 
	`docLi°Dñëe
(
c
->
ªsu…
.
pDo˛i°
);

995 
	`‰ì
(
c
);

996  
SQLITE4_OK
;

997 
	}
}

999 
	$fuŒãxtNext
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

1000 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

1001 
sqlôe_öt64
 
iDocid
;

1002 
rc
;

1004  
c
->
iCurs‹Ty≥
 ){

1005 
QUERY_GENERIC
:

1007 
rc
 = 
	`sqlôe4_°ï
(
c
->
pStmt
);

1008  
rc
 ){

1009 
SQLITE4_ROW
:

1010 
c
->
eof
 = 0;

1011  
SQLITE4_OK
;

1012 
SQLITE4_DONE
:

1013 
c
->
eof
 = 1;

1014  
SQLITE4_OK
;

1016 
c
->
eof
 = 1;

1017  
rc
;

1019 
QUERY_FULLTEXT
:

1020 
rc
 = 
	`sqlôe4_ª£t
(
c
->
pStmt
);

1021 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1023 if–
	`ªadîAtEnd
(&
c
->
ªsu…
)){

1024 
c
->
eof
 = 1;

1025  
SQLITE4_OK
;

1027 
iDocid
 = 
	`ªadDocid
(&
c
->
ªsu…
);

1028 
rc
 = 
	`sqlôe4_böd_öt64
(
c
->
pStmt
, 1, 
iDocid
);

1029 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1031 
rc
 = 
	`sqlôe4_°ï
(
c
->
pStmt
);

1032 if–
rc
==
SQLITE4_ROW
 ){

1033 
c
->
eof
 = 0;

1034  
SQLITE4_OK
;

1037  
rc
==
SQLITE4_DONE
 ? 
SQLITE4_ERROR
 :Ñc;

1039 
	`as£π
( 0 );

1040  
SQLITE4_ERROR
;

1042 
	}
}

1044 
	$ãrm_£À˘_do˛i°
(
fuŒãxt_vèb
 *
v
, c⁄° *
pTîm
, 
nTîm
,

1045 
sqlôe4_°mt
 **
µStmt
){

1046 
rc
;

1047 if–*
µStmt
 ){

1048 
rc
 = 
	`sqlôe4_ª£t
(*
µStmt
);

1050 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zName
, 
µStmt
,

1053 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1055 
rc
 = 
	`sqlôe4_böd_ãxt
(*
µStmt
, 1, 
pTîm
, 
nTîm
, 
SQLITE4_TRANSIENT
);

1056 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1058  
	`sqlôe4_°ï
(*
µStmt
);

1059 
	}
}

1067 
	$quîy_mîge
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_°mt
 **
pSñe˘
,

1068 c⁄° *
zTîm
,

1069 
DocLi°
 *
pIn
, 
iOff£t
, DocLi° *
out
){

1070 
rc
;

1071 
DocLi°Mîge
 
mîge
;

1073 if–
pIn
!=
NULL
 && !pIn->
nD©a
 ){

1076  
SQLITE4_OK
;

1079 
rc
 = 
	`ãrm_£À˘_do˛i°
(
v
, 
zTîm
, -1, 
pSñe˘
);

1080 if–
rc
!=
SQLITE4_ROW
 &&Ñc!=
SQLITE4_DONE
 ) Ñc;

1082 
	`mîgeInô
(&
mîge
, 
pIn
, 
iOff£t
, 
out
);

1083  
rc
==
SQLITE4_ROW
 ){

1084 
DocLi°
 
block
;

1085 
	`docLi°Inô
(&
block
, 
DL_POSITIONS_OFFSETS
,

1086 
	`sqlôe4_cﬁumn_blob
(*
pSñe˘
, 0),

1087 
	`sqlôe4_cﬁumn_byãs
(*
pSñe˘
, 0));

1088 
	`mîgeBlock
(&
mîge
, &
block
);

1089 
	`docLi°De°roy
(&
block
);

1091 
rc
 = 
	`sqlôe4_°ï
(*
pSñe˘
);

1092 if–
rc
!=
SQLITE4_ROW
 &&Ñc!=
SQLITE4_DONE
 ){

1093  
rc
;

1097  
SQLITE4_OK
;

1098 
	}
}

1100 
	sQuîyTîm
 {

1101 
	mis_phø£
;

1102 c⁄° *
	mzTîm
;

1103 } 
	tQuîyTîm
;

1115 
	sQuîy
 {

1116 
	mnTîms
;

1117 
QuîyTîm
 *
	mpTîm
;

1118 } 
	tQuîy
;

1120 
	$quîy_add
(
Quîy
 *
q
, 
is_phø£
, c⁄° *
zTîm
){

1121 
QuîyTîm
 *
t
;

1122 ++
q
->
nTîms
;

1123 
q
->
pTîm
 = 
	`ªÆloc
(q->pTîm, q->
nTîms
 * (q->pTerm[0]));

1124 
t
 = &
q
->
pTîm
[q->
nTîms
 - 1];

1125 
t
->
is_phø£
 = is_phrase;

1126 
t
->
zTîm
 = zTerm;

1127 
	}
}

1129 
	$quîy_‰ì
(
Quîy
 *
q
){

1130 
i
;

1131 
i
 = 0; i < 
q
->
nTîms
; ++i){

1132 
	`‰ì
((*Ë
q
->
pTîm
[
i
].
zTîm
);

1134 
	`‰ì
(
q
->
pTîm
);

1135 
	}
}

1137 
	$tokíize_£gmít
(
sqlôe4_tokíizî
 *
pTokíizî
,

1138 c⁄° *
zQuîy
, 
ö_phø£
,

1139 
Quîy
 *
pQuîy
){

1140 
sqlôe4_tokíizî_moduÀ
 *
pModuÀ
 = 
pTokíizî
->pModule;

1141 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

1142 
is_fú°
 = 1;

1144 
rc
 = 
pModuÀ
->
	`xO≥n
(
pTokíizî
, 
zQuîy
, -1, &
pCurs‹
);

1145 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1146 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

1149 c⁄° *
zTokí
;

1150 
nTokí
, 
iSèπOff£t
, 
iEndOff£t
, 
dummy_pos
;

1152 
rc
 = 
pModuÀ
->
	`xNext
(
pCurs‹
,

1153 &
zTokí
, &
nTokí
,

1154 &
iSèπOff£t
, &
iEndOff£t
,

1155 &
dummy_pos
);

1156 if–
rc
!=
SQLITE4_OK
 ) ;

1157 
	`quîy_add
(
pQuîy
, !
ö_phø£
 || 
is_fú°
, 
	`°rög_dup_n
(
zTokí
, 
nTokí
));

1158 
is_fú°
 = 0;

1161  
pModuÀ
->
	`xClo£
(
pCurs‹
);

1162 
	}
}

1165 
	$∑r£_quîy
(
fuŒãxt_vèb
 *
v
, c⁄° *
zQuîy
, 
Quîy
 *
pQuîy
){

1166 *
zQuîy1
 = 
	`°rög_dup
(
zQuîy
);

1167 
ö_phø£
 = 0;

1168 *
s
 = 
zQuîy1
;

1169 
pQuîy
->
nTîms
 = 0;

1170 
pQuîy
->
pTîm
 = 
NULL
;

1172  *
s
 ){

1173 *
t
 = 
s
;

1174  *
t
 ){

1175 if–*
t
=='"' ){

1176 *
t
++ = '\0';

1179 ++
t
;

1181 if–*
s
 ){

1182 
	`tokíize_£gmít
(
v
->
pTokíizî
, 
s
, 
ö_phø£
, 
pQuîy
);

1184 
s
 = 
t
;

1185 
ö_phø£
 = !in_phrase;

1188 
	`‰ì
(
zQuîy1
);

1189  
SQLITE4_OK
;

1190 
	}
}

1193 
	$fuŒãxt_quîy
(
fuŒãxt_vèb
 *
v
, c⁄° *
zQuîy
,

1194 
DocLi°
 **
pResu…
){

1195 
Quîy
 
q
;

1196 
phø£_°¨t
 = -1;

1197 
i
;

1198 
sqlôe4_°mt
 *
pSñe˘
 = 
NULL
;

1199 
DocLi°
 *
d
 = 
NULL
;

1201 
rc
 = 
	`∑r£_quîy
(
v
, 
zQuîy
, &
q
);

1202 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1205 
i
 = 0 ; i < 
q
.
nTîms
 ; ++i){

1208 
√ed_posôi⁄s
 = 
i
<
q
.
nTîms
-1 && !q.
pTîm
[i+1].
is_phø£
;

1209 
DocLi°
 *
√xt
 = 
	`docLi°New
(
√ed_posôi⁄s
 ? 
DL_POSITIONS
 : 
DL_DOCIDS
);

1210 if–
q
.
pTîm
[
i
].
is_phø£
 ){

1211 
phø£_°¨t
 = 
i
;

1213 
rc
 = 
	`quîy_mîge
(
v
, &
pSñe˘
, 
q
.
pTîm
[
i
].
zTîm
, 
d
, i - 
phø£_°¨t
, 
√xt
);

1214 if–
rc
!=
SQLITE4_OK
 ) ;

1215 if–
d
!=
NULL
 ){

1216 
	`docLi°Dñëe
(
d
);

1218 
d
 = 
√xt
;

1221 
	`sqlôe4_föÆize
(
pSñe˘
);

1222 
	`quîy_‰ì
(&
q
);

1223 *
pResu…
 = 
d
;

1224  
rc
;

1225 
	}
}

1227 
	$fuŒãxtFûãr
(
sqlôe4_vèb_curs‹
 *
pCurs‹
,

1228 
idxNum
, c⁄° *
idxSå
,

1229 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1230 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

1231 
fuŒãxt_vèb
 *
v
 = 
	`curs‹_vèb
(
c
);

1232 
rc
;

1233 c⁄° *
zSèãmít
;

1235 
c
->
iCurs‹Ty≥
 = 
idxNum
;

1236  
idxNum
 ){

1237 
QUERY_GENERIC
:

1238 
zSèãmít
 = "selectÑowid, content from %_content";

1241 
QUERY_FULLTEXT
:

1243 c⁄° *
zQuîy
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

1244 
DocLi°
 *
pResu…
;

1245 
	`as£π
–
¨gc
==1 );

1246 
rc
 = 
	`fuŒãxt_quîy
(
v
, 
zQuîy
, &
pResu…
);

1247 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1248 
	`ªadîInô
(&
c
->
ªsu…
, 
pResu…
);

1249 
zSèãmít
 = "selectÑowid, content from %_content whereÑowid = ?";

1254 
	`as£π
( 0 );

1257 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zName
, &
c
->
pStmt
, 
zSèãmít
);

1258 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1260  
	`fuŒãxtNext
(
pCurs‹
);

1261 
	}
}

1263 
	$fuŒãxtEof
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

1264 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

1265  
c
->
eof
;

1266 
	}
}

1268 
	$fuŒãxtCﬁumn
(
sqlôe4_vèb_curs‹
 *
pCurs‹
,

1269 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
, 
idxCﬁ
){

1270 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

1271 c⁄° *
s
;

1273 
	`as£π
–
idxCﬁ
==0 );

1274 
s
 = (c⁄° *Ë
	`sqlôe4_cﬁumn_ãxt
(
c
->
pStmt
, 1);

1275 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, 
s
, -1, 
SQLITE4_TRANSIENT
);

1277  
SQLITE4_OK
;

1278 
	}
}

1280 
	$fuŒãxtRowid
(
sqlôe4_vèb_curs‹
 *
pCurs‹
, 
sqlôe_öt64
 *
pRowid
){

1281 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

1283 *
pRowid
 = 
	`sqlôe4_cﬁumn_öt64
(
c
->
pStmt
, 0);

1284  
SQLITE4_OK
;

1285 
	}
}

1288 
	$buûd_ãrms
(
Hash
 *
ãrms
, 
sqlôe4_tokíizî
 *
pTokíizî
,

1289 c⁄° *
zText
, 
sqlôe_öt64
 
iDocid
){

1290 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

1291 c⁄° *
pTokí
;

1292 
nTokíByãs
;

1293 
iSèπOff£t
, 
iEndOff£t
, 
iPosôi⁄
;

1295 
rc
 = 
pTokíizî
->
pModuÀ
->
	`xO≥n
’Tokíizî, 
zText
, -1, &
pCurs‹
);

1296 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1298 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

1299 
	`HashInô
(
ãrms
, 
HASH_STRING
, 1);

1300  
SQLITE4_OK
==
pTokíizî
->
pModuÀ
->
	`xNext
(
pCurs‹
,

1301 &
pTokí
, &
nTokíByãs
,

1302 &
iSèπOff£t
, &
iEndOff£t
,

1303 &
iPosôi⁄
) ){

1304 
DocLi°
 *
p
;

1307 if–
iPosôi⁄
<0 ) {

1308 
rc
 = 
SQLITE4_ERROR
;

1309 
îr
;

1312 
p
 = 
	`HashFöd
(
ãrms
, 
pTokí
, 
nTokíByãs
);

1313 if–
p
==
NULL
 ){

1314 
p
 = 
	`docLi°New
(
DL_POSITIONS_OFFSETS
);

1315 
	`docLi°AddDocid
(
p
, 
iDocid
);

1316 
	`HashIn£π
(
ãrms
, 
pTokí
, 
nTokíByãs
, 
p
);

1318 
	`docLi°AddPosOff£t
(
p
, 
iPosôi⁄
, 
iSèπOff£t
, 
iEndOff£t
);

1321 
îr
:

1327 
pTokíizî
->
pModuÀ
->
	`xClo£
(
pCurs‹
);

1328  
rc
;

1329 
	}
}

1331 
	$ödex_ö£π_ãrm
(
fuŒãxt_vèb
 *
v
, c⁄° *
zTîm
, 
nTîm
,

1332 
sqlôe_öt64
 
iDocid
, 
DocLi°
 *
p
){

1333 
sqlôe_öt64
 
iFú°
;

1334 
sqlôe_öt64
 
iIndexRow
;

1335 
DocLi°
 
do˛i°
;

1337 
rc
 = 
	`ãrm_chunk_£À˘
(
v
, 
zTîm
, 
nTîm
, 
iDocid
, &
iFú°
);

1338 if–
rc
==
SQLITE4_DONE
 ){

1339 
	`docLi°Inô
(&
do˛i°
, 
DL_POSITIONS_OFFSETS
, 0, 0);

1340 if–
	`docLi°Upd©e
(&
do˛i°
, 
iDocid
, 
p
) ){

1341 
rc
 = 
	`ãrm_ö£π
(
v
, 
zTîm
, 
nTîm
, 
iDocid
, &
do˛i°
);

1342 
	`docLi°De°roy
(&
do˛i°
);

1343  
rc
;

1345  
SQLITE4_OK
;

1347 if–
rc
!=
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

1351 
rc
 = 
	`ãrm_£À˘
(
v
, 
zTîm
, 
nTîm
, 
iFú°
, &
iIndexRow
, &
do˛i°
);

1352 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1354 if–
	`docLi°Upd©e
(&
do˛i°
, 
iDocid
, 
p
) ){

1356 if–
do˛i°
.
nD©a
>
CHUNK_MAX
 ){

1357 
DocLi°
 
hÆf
;

1358 if–
	`docLi°S∂ô
(&
do˛i°
, &
hÆf
) ){

1359 
rc
 = 
	`ãrm_ö£π
(
v
, 
zTîm
, 
nTîm
, 
	`fú°Docid
(&
hÆf
), &half);

1360 
	`docLi°De°roy
(&
hÆf
);

1361 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

1364 
rc
 = 
	`ãrm_upd©e
(
v
, 
iIndexRow
, &
do˛i°
);

1367 
îr
:

1368 
	`docLi°De°roy
(&
do˛i°
);

1369  
rc
;

1370 
	}
}

1374 
	$ödex_ö£π
(
fuŒãxt_vèb
 *
v
,

1375 
sqlôe4_vÆue
 *
pReque°Rowid
, c⁄° *
zText
,

1376 
sqlôe_öt64
 *
piRowid
){

1377 
Hash
 
ãrms
;

1378 
HashEÀm
 *
e
;

1380 
rc
 = 
	`c⁄ã¡_ö£π
(
v
, 
pReque°Rowid
, 
zText
, -1);

1381 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1382 *
piRowid
 = 
	`sqlôe4_œ°_ö£π_rowid
(
v
->
db
);

1384 if–!
zText
 )  
SQLITE4_OK
;

1386 
rc
 = 
	`buûd_ãrms
(&
ãrms
, 
v
->
pTokíizî
, 
zText
, *
piRowid
);

1387 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1389 
e
=
	`HashFú°
(&
ãrms
);É;É=
	`HashNext
(e)){

1390 
DocLi°
 *
p
 = 
	`HashD©a
(
e
);

1391 
rc
 = 
	`ödex_ö£π_ãrm
(
v
, 
	`HashKey
(
e
), 
	`HashKeysize
”), *
piRowid
, 
p
);

1392 if–
rc
!=
SQLITE4_OK
 ) ;

1395 
e
=
	`HashFú°
(&
ãrms
);É;É=
	`HashNext
(e)){

1396 
DocLi°
 *
p
 = 
	`HashD©a
(
e
);

1397 
	`docLi°Dñëe
(
p
);

1399 
	`HashCÀ¨
(&
ãrms
);

1400  
rc
;

1401 
	}
}

1403 
	$ödex_dñëe_ãrm
(
fuŒãxt_vèb
 *
v
, c⁄° *
zTîm
, 
nTîm
,

1404 
sqlôe_öt64
 
iDocid
){

1405 
sqlôe_öt64
 
iFú°
;

1406 
sqlôe_öt64
 
iIndexRow
;

1407 
DocLi°
 
do˛i°
;

1409 
rc
 = 
	`ãrm_chunk_£À˘
(
v
, 
zTîm
, 
nTîm
, 
iDocid
, &
iFú°
);

1410 if–
rc
!=
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

1412 
rc
 = 
	`ãrm_£À˘
(
v
, 
zTîm
, 
nTîm
, 
iFú°
, &
iIndexRow
, &
do˛i°
);

1413 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1415 if–
	`docLi°Upd©e
(&
do˛i°
, 
iDocid
, 
NULL
) ){

1416 if–
do˛i°
.
nD©a
>0 ){

1417 
rc
 = 
	`ãrm_upd©e
(
v
, 
iIndexRow
, &
do˛i°
);

1419 
rc
 = 
	`ãrm_dñëe
(
v
, 
iIndexRow
);

1422 
	`docLi°De°roy
(&
do˛i°
);

1423  
rc
;

1424 
	}
}

1427 
	$ödex_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
){

1428 *
zText
;

1429 
Hash
 
ãrms
;

1430 
HashEÀm
 *
e
;

1432 
rc
 = 
	`c⁄ã¡_£À˘
(
v
, 
iRow
, &
zText
);

1433 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1435 
rc
 = 
	`buûd_ãrms
(&
ãrms
, 
v
->
pTokíizî
, 
zText
, 
iRow
);

1436 
	`‰ì
(
zText
);

1437 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1439 
e
=
	`HashFú°
(&
ãrms
);É;É=
	`HashNext
(e)){

1440 
rc
 = 
	`ödex_dñëe_ãrm
(
v
, 
	`HashKey
(
e
), 
	`HashKeysize
”), 
iRow
);

1441 if–
rc
!=
SQLITE4_OK
 ) ;

1443 
e
=
	`HashFú°
(&
ãrms
);É;É=
	`HashNext
(e)){

1444 
DocLi°
 *
p
 = 
	`HashD©a
(
e
);

1445 
	`docLi°Dñëe
(
p
);

1447 
	`HashCÀ¨
(&
ãrms
);

1449  
	`c⁄ã¡_dñëe
(
v
, 
iRow
);

1450 
	}
}

1452 
	$fuŒãxtUpd©e
(
sqlôe4_vèb
 *
pVèb
, 
nArg
, 
sqlôe4_vÆue
 **
µArg
,

1453 
sqlôe_öt64
 *
pRowid
){

1454 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *Ë
pVèb
;

1456 if–
nArg
<2 ){

1457  
	`ödex_dñëe
(
v
, 
	`sqlôe4_vÆue_öt64
(
µArg
[0]));

1460 if–
	`sqlôe4_vÆue_ty≥
(
µArg
[0]Ë!
SQLITE4_NULL
 ){

1461  
SQLITE4_ERROR
;

1464 
	`as£π
–
nArg
==3 );

1465  
	`ödex_ö£π
(
v
, 
µArg
[1],

1466 (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
µArg
[2]), 
pRowid
);

1467 
	}
}

1469 
sqlôe4_moduÀ
 
	gfuŒãxtModuÀ
 = {

1471 
fuŒãxtCª©e
,

1472 
fuŒãxtC⁄√˘
,

1473 
fuŒãxtBe°Index
,

1474 
fuŒãxtDisc⁄√˘
,

1475 
fuŒãxtDe°roy
,

1476 
fuŒãxtO≥n
,

1477 
fuŒãxtClo£
,

1478 
fuŒãxtFûãr
,

1479 
fuŒãxtNext
,

1480 
fuŒãxtEof
,

1481 
fuŒãxtCﬁumn
,

1482 
fuŒãxtRowid
,

1483 
fuŒãxtUpd©e


1486 
	$fuŒãxt_öô
(
sqlôe4
 *
db
){

1487  
	`sqlôe4_¸óã_moduÀ
(
db
, "fuŒãxt", &
fuŒãxtModuÀ
, 0);

1488 
	}
}

1490 #i‡!
SQLITE4_CORE


1491 
	$sqlôe4_exãnsi⁄_öô
(
sqlôe4
 *
db
, **
pzEºMsg
,

1492 c⁄° 
sqlôe4_≠i_routöes
 *
pApi
){

1493 
	`SQLITE4_EXTENSION_INIT2
(
pApi
)

1494  
	`fuŒãxt_öô
(
db
);

1495 
	}
}

	@ext/fts1/fulltext.h

1 
	~"sqlôe4.h
"

3 #ifde‡
__˝lu•lus


7 
fuŒãxt_öô
(
sqlôe4
 *
db
);

9 #ifde‡
__˝lu•lus


	@ext/fts1/simple_tokenizer.c

8 
	~<as£π.h
>

9 #i‡!
deföed
(
__APPLE__
)

10 
	~<mÆloc.h
>

12 
	~<°dlib.h
>

14 
	~<°dio.h
>

15 
	~<°rög.h
>

16 
	~<˘y≥.h
>

18 
	~"tokíizî.h
"

25 *
	$°rög_dup
(c⁄° *
s
){

26 *
°r
 = 
	`mÆloc
(
	`°æí
(
s
) + 1);

27 
	`°r˝y
(
°r
, 
s
);

28  
°r
;

29 
	}
}

31 
	ssim∂e_tokíizî
 {

32 
sqlôe4_tokíizî
 
	mba£
;

33 c⁄° *
	mzDñim
;

34 } 
	tsim∂e_tokíizî
;

36 
	ssim∂e_tokíizî_curs‹
 {

37 
sqlôe4_tokíizî_curs‹
 
	mba£
;

38 c⁄° *
	mpI≈ut
;

39 
	mnByãs
;

40 c⁄° *
	mpCuºít
;

41 
	miTokí
;

42 *
	mzTokí
;

43 
	mnTokíByãs
;

44 
	mnTokíAŒoˇãd
;

45 } 
	tsim∂e_tokíizî_curs‹
;

47 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
;

49 
	$sim∂eCª©e
(

50 
¨gc
, c⁄° **
¨gv
,

51 
sqlôe4_tokíizî
 **
µTokíizî


53 
sim∂e_tokíizî
 *
t
;

55 
t
 = (
sim∂e_tokíizî
 *Ë
	`mÆloc
((simple_tokenizer));

61 if–
¨gc
>1 ){

62 
t
->
zDñim
 = 
	`°rög_dup
(
¨gv
[1]);

65 
zDñim
[0x80];

66 
i
, 
j
;

67 
i
=1, 
j
=0; i<0x80; i++){

68 if–!
	`iß um
(
i
) ){

69 
zDñim
[
j
++] = 
i
;

72 
zDñim
[
j
++] = '\0';

73 
	`as£π
–
j
<=(
zDñim
) );

74 
t
->
zDñim
 = 
	`°rög_dup
(zDelim);

77 *
µTokíizî
 = &
t
->
ba£
;

78  
SQLITE4_OK
;

79 
	}
}

81 
	$sim∂eDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

82 
sim∂e_tokíizî
 *
t
 = (sim∂e_tokíizî *Ë
pTokíizî
;

84 
	`‰ì
((*Ë
t
->
zDñim
);

85 
	`‰ì
(
t
);

87  
SQLITE4_OK
;

88 
	}
}

90 
	$sim∂eO≥n
(

91 
sqlôe4_tokíizî
 *
pTokíizî
,

92 c⁄° *
pI≈ut
, 
nByãs
,

93 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


95 
sim∂e_tokíizî_curs‹
 *
c
;

97 
c
 = (
sim∂e_tokíizî_curs‹
 *Ë
	`mÆloc
((simple_tokenizer_cursor));

98 
c
->
pI≈ut
 =ÖInput;

99 
c
->
nByãs
 =ÇByãs<0 ? (Ë
	`°æí
(
pI≈ut
) :ÇBytes;

100 
c
->
pCuºít
 = c->
pI≈ut
;

101 
c
->
iTokí
 = 0;

102 
c
->
zTokí
 = 
NULL
;

103 
c
->
nTokíByãs
 = 0;

104 
c
->
nTokíAŒoˇãd
 = 0;

106 *
µCurs‹
 = &
c
->
ba£
;

107  
SQLITE4_OK
;

108 
	}
}

110 
	$sim∂eClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

111 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

113 if–
NULL
!=
c
->
zTokí
 ){

114 
	`‰ì
(
c
->
zTokí
);

116 
	`‰ì
(
c
);

118  
SQLITE4_OK
;

119 
	}
}

121 
	$sim∂eNext
(

122 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

123 c⁄° **
µTokí
, *
≤Byãs
,

124 *
piSèπOff£t
, *
piEndOff£t
, *
piPosôi⁄


126 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

127 
sim∂e_tokíizî
 *
t
 = (sim∂e_tokíizî *Ë
pCurs‹
->
pTokíizî
;

128 
ii
;

130  
c
->
pCuºít
-c->
pI≈ut
<c->
nByãs
 ){

131 
n
 = (Ë
	`°rc•n
(
c
->
pCuºít
, 
t
->
zDñim
);

132 if–
n
>0 ){

133 if–
n
+1>
c
->
nTokíAŒoˇãd
 ){

134 
c
->
zTokí
 = 
	`ªÆloc
(c->zTokí, 
n
+1);

136 
ii
=0; ii<
n
; ii++){

140 
ch
 = 
c
->
pCuºít
[
ii
];

141 
c
->
zTokí
[
ii
] = ()
ch
<0x80 ? 
	`tﬁowî
(ch) : ch;

143 
c
->
zTokí
[
n
] = '\0';

144 *
µTokí
 = 
c
->
zTokí
;

145 *
≤Byãs
 = 
n
;

146 *
piSèπOff£t
 = (Ë(
c
->
pCuºít
-c->
pI≈ut
);

147 *
piEndOff£t
 = *
piSèπOff£t
+
n
;

148 *
piPosôi⁄
 = 
c
->
iTokí
++;

149 
c
->
pCuºít
 +
n
 + 1;

151  
SQLITE4_OK
;

153 
c
->
pCuºít
 +
n
 + 1;

158  
SQLITE4_DONE
;

159 
	}
}

161 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
 = {

163 
sim∂eCª©e
,

164 
sim∂eDe°roy
,

165 
sim∂eO≥n
,

166 
sim∂eClo£
,

167 
sim∂eNext
,

170 
	$gë_sim∂e_tokíizî_moduÀ
(

171 
sqlôe4_tokíizî_moduÀ
 **
µModuÀ


173 *
µModuÀ
 = &
sim∂eTokíizîModuÀ
;

174 
	}
}

	@ext/fts1/tokenizer.h

20 #i‚de‡
_TOKENIZER_H_


21 
	#_TOKENIZER_H_


	)

27 
	~"sqlôe4.h
"

32 
sqlôe4_tokíizî
 
	tsqlôe4_tokíizî
;

33 
sqlôe4_tokíizî_curs‹
 
	tsqlôe4_tokíizî_curs‹
;

34 
sqlôe4_tokíizî_moduÀ
 
	tsqlôe4_tokíizî_moduÀ
;

36 
	ssqlôe4_tokíizî_moduÀ
 {

37 
	miVîsi⁄
;

43 (*
	mxCª©e
)(
	m¨gc
, c⁄° **
	m¨gv
,

44 
sqlôe4_tokíizî
 **
	mµTokíizî
);

45 (*
	mxDe°roy
)(
sqlôe4_tokíizî
 *
	mpTokíizî
);

59 (*
	mxO≥n
)(
sqlôe4_tokíizî
 *
	mpTokíizî
,

60 c⁄° *
	mpI≈ut
, 
	mnByãs
,

61 
sqlôe4_tokíizî_curs‹
 **
	mµCurs‹
);

62 (*
	mxClo£
)(
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
);

63 (*
	mxNext
)(
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
,

64 c⁄° **
	mµTokí
, *
	m≤Byãs
,

65 *
	mpiSèπOff£t
, *
	mpiEndOff£t
, *
	mpiPosôi⁄
);

68 
	ssqlôe4_tokíizî
 {

69 
sqlôe4_tokíizî_moduÀ
 *
	mpModuÀ
;

73 
	ssqlôe4_tokíizî_curs‹
 {

74 
sqlôe4_tokíizî
 *
	mpTokíizî
;

87 
gë_sim∂e_tokíizî_moduÀ
(
sqlôe4_tokíizî_moduÀ
 **
µModuÀ
);

	@ext/fts2/fts2.c

6 #i‡(!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)) \

7 && !
	$deföed
(
SQLITE4_ENABLE_BROKEN_FTS2
)

8 #îr‹ 
·s2
 
has
 
a
 
design
 
Êaw
 
™d
 ha†
bìn
 
dïªˇãd
.

299 #i‡!
	`deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)

301 #i‡
	`deföed
(
SQLITE4_ENABLE_FTS2
Ë&& !deföed(
SQLITE4_CORE
)

302 
	#SQLITE4_CORE
 1

	)

305 
	~<as£π.h
>

306 
	~<°dlib.h
>

307 
	~<°dio.h
>

308 
	~<°rög.h
>

309 
	~"·s2.h
"

310 
	~"·s2_hash.h
"

311 
	~"·s2_tokíizî.h
"

312 
	~"sqlôe4.h
"

313 
	~"sqlôe4ext.h
"

314 
SQLITE4_EXTENSION_INIT1


331 
	#TRACE
(
A
Ë
¥ötf
 A; 
	`fÊush
(
°dout
)

	)

333 
	#TRACE
(
A
)

	)

345 
	$ß„_is•a˚
(
c
){

346  
c
==' ' || c=='\t' || c=='\n' || c=='\r' || c=='\v' || c=='\f';

347 
	}
}

348 
	$ß„_tﬁowî
(
c
){

349  (
c
>='A' && c<='Z') ? (c - 'A' + 'a') : c;

350 
	}
}

351 
	$ß„_iß um
(
c
){

352  (
c
>='0' && c<='9') || (c>='A' && c<='Z') || (c>='a' && c<='z');

353 
	}
}

355 
	eDocLi°Ty≥
 {

356 
	mDL_DOCIDS
,

357 
	mDL_POSITIONS
,

358 
	mDL_POSITIONS_OFFSETS


359 } 
	tDocLi°Ty≥
;

370 #i‚de‡
DL_DEFAULT


371 
	#DL_DEFAULT
 
DL_POSITIONS


	)

375 
	mPOS_END
 = 0,

376 
	mPOS_COLUMN
,

377 
	mPOS_BASE


383 
	#MERGE_COUNT
 16

	)

395 
	#CLEAR
(
b
Ë
	`mem£t
(b, '\0', (*(b)))

	)

397 #i‚de‡
NDEBUG


398 
	#SCRAMBLE
(
b
Ë
	`mem£t
(b, 0x55, (*(b)))

	)

400 
	#SCRAMBLE
(
b
)

	)

404 
	#VARINT_MAX
 10

	)

409 
	$putV¨öt
(*
p
, 
sqlôe_öt64
 
v
){

410 *
q
 = (*Ë
p
;

411 
sqlôe_uöt64
 
vu
 = 
v
;

413 *
q
++ = (Ë((
vu
 & 0x7f) | 0x80);

414 
vu
 >>= 7;

415 } 
vu
!=0 );

416 
q
[-1] &= 0x7f;

417 
	`as£π
–
q
 - (*)
p
 <
VARINT_MAX
 );

418  (Ë(
q
 - (*)
p
);

419 
	}
}

424 
	$gëV¨öt
(c⁄° *
p
, 
sqlôe_öt64
 *
v
){

425 c⁄° *
q
 = (c⁄° *Ë
p
;

426 
sqlôe_uöt64
 
x
 = 0, 
y
 = 1;

427  (*
q
 & 0x80) == 0x80 ){

428 
x
 +
y
 * (*
q
++ & 0x7f);

429 
y
 <<= 7;

430 if–
q
 - (*)
p
 >
VARINT_MAX
 ){

431 
	`as£π
( 0 );

435 
x
 +
y
 * (*
q
++);

436 *
v
 = (
sqlôe_öt64
Ë
x
;

437  (Ë(
q
 - (*)
p
);

438 
	}
}

440 
	$gëV¨öt32
(c⁄° *
p
, *
pi
){

441 
sqlôe_öt64
 
i
;

442 
ªt
 = 
	`gëV¨öt
(
p
, &
i
);

443 *
pi
 = (Ë
i
;

444 
	`as£π
–*
pi
==
i
 );

445  
ªt
;

446 
	}
}

462 
	sD©aBuf„r
 {

463 *
	mpD©a
;

464 
	mnC≠acôy
;

465 
	mnD©a
;

466 } 
	tD©aBuf„r
;

468 
	$d©aBuf„rInô
(
D©aBuf„r
 *
pBuf„r
, 
nC≠acôy
){

469 
	`as£π
–
nC≠acôy
>=0 );

470 
pBuf„r
->
nD©a
 = 0;

471 
pBuf„r
->
nC≠acôy
 =ÇCapacity;

472 
pBuf„r
->
pD©a
 = 
nC≠acôy
==0 ? 
NULL
 : 
	`sqlôe4_mÆloc
(nCapacity);

473 
	}
}

474 
	$d©aBuf„rRe£t
(
D©aBuf„r
 *
pBuf„r
){

475 
pBuf„r
->
nD©a
 = 0;

476 
	}
}

477 
	$d©aBuf„rDe°roy
(
D©aBuf„r
 *
pBuf„r
){

478 if–
pBuf„r
->
pD©a
!=
NULL
 ) 
	`sqlôe4_‰ì
(pBuffer->pData);

479 
	`SCRAMBLE
(
pBuf„r
);

480 
	}
}

481 
	$d©aBuf„rSw≠
(
D©aBuf„r
 *
pBuf„r1
, D©aBuf„∏*
pBuf„r2
){

482 
D©aBuf„r
 
tmp
 = *
pBuf„r1
;

483 *
pBuf„r1
 = *
pBuf„r2
;

484 *
pBuf„r2
 = 
tmp
;

485 
	}
}

486 
	$d©aBuf„rEx∑nd
(
D©aBuf„r
 *
pBuf„r
, 
nAddC≠acôy
){

487 
	`as£π
–
nAddC≠acôy
>0 );

492 if–
pBuf„r
->
nD©a
+
nAddC≠acôy
>pBuf„r->
nC≠acôy
 ){

493 
pBuf„r
->
nC≠acôy
 =ÖBuf„r->
nD©a
+
nAddC≠acôy
;

494 
pBuf„r
->
pD©a
 = 
	`sqlôe4_ªÆloc
’Buf„r->pD©a,ÖBuf„r->
nC≠acôy
);

496 
	}
}

497 
	$d©aBuf„rAµíd
(
D©aBuf„r
 *
pBuf„r
,

498 c⁄° *
pSour˚
, 
nSour˚
){

499 
	`as£π
–
nSour˚
>0 && 
pSour˚
!=
NULL
 );

500 
	`d©aBuf„rEx∑nd
(
pBuf„r
, 
nSour˚
);

501 
	`mem˝y
(
pBuf„r
->
pD©a
+pBuf„r->
nD©a
, 
pSour˚
, 
nSour˚
);

502 
pBuf„r
->
nD©a
 +
nSour˚
;

503 
	}
}

504 
	$d©aBuf„rAµíd2
(
D©aBuf„r
 *
pBuf„r
,

505 c⁄° *
pSour˚1
, 
nSour˚1
,

506 c⁄° *
pSour˚2
, 
nSour˚2
){

507 
	`as£π
–
nSour˚1
>0 && 
pSour˚1
!=
NULL
 );

508 
	`as£π
–
nSour˚2
>0 && 
pSour˚2
!=
NULL
 );

509 
	`d©aBuf„rEx∑nd
(
pBuf„r
, 
nSour˚1
+
nSour˚2
);

510 
	`mem˝y
(
pBuf„r
->
pD©a
+pBuf„r->
nD©a
, 
pSour˚1
, 
nSour˚1
);

511 
	`mem˝y
(
pBuf„r
->
pD©a
+pBuf„r->
nD©a
+
nSour˚1
, 
pSour˚2
, 
nSour˚2
);

512 
pBuf„r
->
nD©a
 +
nSour˚1
+
nSour˚2
;

513 
	}
}

514 
	$d©aBuf„rRïœ˚
(
D©aBuf„r
 *
pBuf„r
,

515 c⁄° *
pSour˚
, 
nSour˚
){

516 
	`d©aBuf„rRe£t
(
pBuf„r
);

517 
	`d©aBuf„rAµíd
(
pBuf„r
, 
pSour˚
, 
nSour˚
);

518 
	}
}

521 
	sSåögBuf„r
 {

522 
D©aBuf„r
 
	mb
;

523 } 
	tSåögBuf„r
;

525 
	$öôSåögBuf„r
(
SåögBuf„r
 *
sb
){

526 
	`d©aBuf„rInô
(&
sb
->
b
, 100);

527 
	`d©aBuf„rRïœ˚
(&
sb
->
b
, "", 1);

528 
	}
}

529 
	$°rögBuf„rLígth
(
SåögBuf„r
 *
sb
){

530  
sb
->
b
.
nD©a
-1;

531 
	}
}

532 *
	$°rögBuf„rD©a
(
SåögBuf„r
 *
sb
){

533  
sb
->
b
.
pD©a
;

534 
	}
}

535 
	$°rögBuf„rDe°roy
(
SåögBuf„r
 *
sb
){

536 
	`d©aBuf„rDe°roy
(&
sb
->
b
);

537 
	}
}

539 
	$«µíd
(
SåögBuf„r
 *
sb
, c⁄° *
zFrom
, 
nFrom
){

540 
	`as£π
–
sb
->
b
.
nD©a
>0 );

541 if–
nFrom
>0 ){

542 
sb
->
b
.
nD©a
--;

543 
	`d©aBuf„rAµíd2
(&
sb
->
b
, 
zFrom
, 
nFrom
, "", 1);

545 
	}
}

546 
	$≠≥nd
(
SåögBuf„r
 *
sb
, c⁄° *
zFrom
){

547 
	`«µíd
(
sb
, 
zFrom
, 
	`°æí
(zFrom));

548 
	}
}

551 
	$≠≥ndLi°
(
SåögBuf„r
 *
sb
, 
nSåög
, **
azSåög
){

552 
i
;

553 
i
=0; i<
nSåög
; ++i){

554 if–
i
>0 ) 
	`≠≥nd
(
sb
, ", ");

555 
	`≠≥nd
(
sb
, 
azSåög
[
i
]);

557 
	}
}

559 
	$ídsInWhôeS∑˚
(
SåögBuf„r
 *
p
){

560  
	`°rögBuf„rLígth
(
p
)>0 &&

561 
	`ß„_is•a˚
(
	`°rögBuf„rD©a
(
p
)[
	`°rögBuf„rLígth
(p)-1]);

562 
	}
}

567 
	$≠≥ndWhôeS∑˚
(
SåögBuf„r
 *
p
){

568 if–
	`°rögBuf„rLígth
(
p
)==0 ) ;

569 if–!
	`ídsInWhôeS∑˚
(
p
ËË
	`≠≥nd
(p, " ");

570 
	}
}

573 
	$åimWhôeS∑˚
(
SåögBuf„r
 *
p
){

574  
	`ídsInWhôeS∑˚
(
p
) ){

575 
p
->
b
.
pD©a
[--p->b.
nD©a
-1] = '\0';

577 
	}
}

605 
	sDLRódî
 {

606 
DocLi°Ty≥
 
	miTy≥
;

607 c⁄° *
	mpD©a
;

608 
	mnD©a
;

610 
sqlôe_öt64
 
	miDocid
;

611 
	mnEÀmít
;

612 } 
	tDLRódî
;

614 
	$dÃAtEnd
(
DLRódî
 *
pRódî
){

615 
	`as£π
–
pRódî
->
nD©a
>=0 );

616  
pRódî
->
nD©a
==0;

617 
	}
}

618 
sqlôe_öt64
 
	$dÃDocid
(
DLRódî
 *
pRódî
){

619 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

620  
pRódî
->
iDocid
;

621 
	}
}

622 c⁄° *
	$dÃDocD©a
(
DLRódî
 *
pRódî
){

623 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

624  
pRódî
->
pD©a
;

625 
	}
}

626 
	$dÃDocD©aByãs
(
DLRódî
 *
pRódî
){

627 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

628  
pRódî
->
nEÀmít
;

629 
	}
}

630 
	$dÃAŒD©aByãs
(
DLRódî
 *
pRódî
){

631 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

632  
pRódî
->
nD©a
;

633 
	}
}

638 c⁄° *
	$dÃPosD©a
(
DLRódî
 *
pRódî
){

639 
sqlôe_öt64
 
iDummy
;

640 
n
 = 
	`gëV¨öt
(
pRódî
->
pD©a
, &
iDummy
);

641 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

642  
pRódî
->
pD©a
+
n
;

643 
	}
}

644 
	$dÃPosD©aLí
(
DLRódî
 *
pRódî
){

645 
sqlôe_öt64
 
iDummy
;

646 
n
 = 
	`gëV¨öt
(
pRódî
->
pD©a
, &
iDummy
);

647 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

648  
pRódî
->
nEÀmít
-
n
;

649 
	}
}

650 
	$dÃSãp
(
DLRódî
 *
pRódî
){

651 
	`as£π
–!
	`dÃAtEnd
(
pRódî
) );

654 
	`as£π
–
pRódî
->
nEÀmít
<ıRódî->
nD©a
 );

655 
pRódî
->
pD©a
 +pRódî->
nEÀmít
;

656 
pRódî
->
nD©a
 -pRódî->
nEÀmít
;

659 if–
pRódî
->
nD©a
!=0 ){

660 
sqlôe_öt64
 
iDocidDñè
;

661 
iDummy
, 
n
 = 
	`gëV¨öt
(
pRódî
->
pD©a
, &
iDocidDñè
);

662 
pRódî
->
iDocid
 +
iDocidDñè
;

663 if–
pRódî
->
iTy≥
>=
DL_POSITIONS
 ){

664 
	`as£π
–
n
<
pRódî
->
nD©a
 );

666 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
iDummy
);

667 
	`as£π
–
n
<=
pRódî
->
nD©a
 );

668 if–
iDummy
==
POS_END
 ) ;

669 if–
iDummy
==
POS_COLUMN
 ){

670 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
iDummy
);

671 
	`as£π
–
n
<
pRódî
->
nD©a
 );

672 }if–
pRódî
->
iTy≥
==
DL_POSITIONS_OFFSETS
 ){

673 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
iDummy
);

674 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
iDummy
);

675 
	`as£π
–
n
<
pRódî
->
nD©a
 );

679 
pRódî
->
nEÀmít
 = 
n
;

680 
	`as£π
–
pRódî
->
nEÀmít
<ıRódî->
nD©a
 );

682 
	}
}

683 
	$dÃInô
(
DLRódî
 *
pRódî
, 
DocLi°Ty≥
 
iTy≥
,

684 c⁄° *
pD©a
, 
nD©a
){

685 
	`as£π
–
pD©a
!=
NULL
 && 
nD©a
!=0 );

686 
pRódî
->
iTy≥
 = iType;

687 
pRódî
->
pD©a
 =ÖData;

688 
pRódî
->
nD©a
 =ÇData;

689 
pRódî
->
nEÀmít
 = 0;

690 
pRódî
->
iDocid
 = 0;

693 
	`dÃSãp
(
pRódî
);

694 
	}
}

695 
	$dÃDe°roy
(
DLRódî
 *
pRódî
){

696 
	`SCRAMBLE
(
pRódî
);

697 
	}
}

699 #i‚de‡
NDEBUG


704 
	$docLi°VÆid©e
(
DocLi°Ty≥
 
iTy≥
, c⁄° *
pD©a
, 
nD©a
,

705 
sqlôe_öt64
 *
pLa°Docid
){

706 
sqlôe_öt64
 
iPªvDocid
 = 0;

707 
	`as£π
–
nD©a
>0 );

708 
	`as£π
–
pD©a
!=0 );

709 
	`as£π
–
pD©a
+
nD©a
>pData );

710  
nD©a
!=0 ){

711 
sqlôe_öt64
 
iDocidDñè
;

712 
n
 = 
	`gëV¨öt
(
pD©a
, &
iDocidDñè
);

713 
iPªvDocid
 +
iDocidDñè
;

714 if–
iTy≥
>
DL_DOCIDS
 ){

715 
iDummy
;

717 
n
 +
	`gëV¨öt32
(
pD©a
+n, &
iDummy
);

718 if–
iDummy
==
POS_END
 ) ;

719 if–
iDummy
==
POS_COLUMN
 ){

720 
n
 +
	`gëV¨öt32
(
pD©a
+n, &
iDummy
);

721 }if–
iTy≥
>
DL_POSITIONS
 ){

722 
n
 +
	`gëV¨öt32
(
pD©a
+n, &
iDummy
);

723 
n
 +
	`gëV¨öt32
(
pD©a
+n, &
iDummy
);

725 
	`as£π
–
n
<=
nD©a
 );

728 
	`as£π
–
n
<=
nD©a
 );

729 
pD©a
 +
n
;

730 
nD©a
 -
n
;

732 if–
pLa°Docid
 ) *pLa°Docid = 
iPªvDocid
;

733 
	}
}

734 
	#ASSERT_VALID_DOCLIST
(
i
, 
p
, 
n
, 
o
Ë
	`docLi°VÆid©e
(i,Ö,Ç, o)

	)

736 
	#ASSERT_VALID_DOCLIST
(
i
, 
p
, 
n
, 
o
Ë
	`as£π
–1 )

	)

750 
	sDLWrôî
 {

751 
DocLi°Ty≥
 
	miTy≥
;

752 
D©aBuf„r
 *
	mb
;

753 
sqlôe_öt64
 
	miPªvDocid
;

754 #i‚de‡
NDEBUG


755 
	mhas_iPªvDocid
;

757 } 
	tDLWrôî
;

759 
	$dlwInô
(
DLWrôî
 *
pWrôî
, 
DocLi°Ty≥
 
iTy≥
, 
D©aBuf„r
 *
b
){

760 
pWrôî
->
b
 = b;

761 
pWrôî
->
iTy≥
 = iType;

762 
pWrôî
->
iPªvDocid
 = 0;

763 #i‚de‡
NDEBUG


764 
pWrôî
->
has_iPªvDocid
 = 0;

766 
	}
}

767 
	$dlwDe°roy
(
DLWrôî
 *
pWrôî
){

768 
	`SCRAMBLE
(
pWrôî
);

769 
	}
}

783 
	$dlwAµíd
(
DLWrôî
 *
pWrôî
,

784 c⁄° *
pD©a
, 
nD©a
,

785 
sqlôe_öt64
 
iFú°Docid
, sqlôe_öt64 
iLa°Docid
){

786 
sqlôe_öt64
 
iDocid
 = 0;

787 
c
[
VARINT_MAX
];

788 
nFú°Old
, 
nFú°New
;

789 #i‚de‡
NDEBUG


790 
sqlôe_öt64
 
iLa°DocidDñè
;

794 
nFú°Old
 = 
	`gëV¨öt
(
pD©a
, &
iDocid
);

795 
	`as£π
–
nFú°Old
<
nD©a
 || (nFú°Old=ÚD©®&& 
pWrôî
->
iTy≥
==
DL_DOCIDS
) );

796 
nFú°New
 = 
	`putV¨öt
(
c
, 
iFú°Docid
-
pWrôî
->
iPªvDocid
);

802 
	`ASSERT_VALID_DOCLIST
(
pWrôî
->
iTy≥
, 
pD©a
, 
nD©a
, &
iLa°DocidDñè
);

803 
	`as£π
–
iLa°Docid
==
iFú°Docid
-
iDocid
+
iLa°DocidDñè
 );

808 if–
nFú°Old
<
nD©a
 ){

809 
	`d©aBuf„rAµíd2
(
pWrôî
->
b
, 
c
, 
nFú°New
,

810 
pD©a
+
nFú°Old
, 
nD©a
-nFirstOld);

812 
	`d©aBuf„rAµíd
(
pWrôî
->
b
, 
c
, 
nFú°New
);

814 
pWrôî
->
iPªvDocid
 = 
iLa°Docid
;

815 
	}
}

816 
	$dlwC›y
(
DLWrôî
 *
pWrôî
, 
DLRódî
 *
pRódî
){

817 
	`dlwAµíd
(
pWrôî
, 
	`dÃDocD©a
(
pRódî
), 
	`dÃDocD©aByãs
(pReader),

818 
	`dÃDocid
(
pRódî
), dlrDocid(pReader));

819 
	}
}

820 
	$dlwAdd
(
DLWrôî
 *
pWrôî
, 
sqlôe_öt64
 
iDocid
){

821 
c
[
VARINT_MAX
];

822 
n
 = 
	`putV¨öt
(
c
, 
iDocid
-
pWrôî
->
iPªvDocid
);

825 
	`as£π
–!
pWrôî
->
has_iPªvDocid
 || 
iDocid
>pWrôî->
iPªvDocid
 );

826 
	`as£π
–
pWrôî
->
iTy≥
==
DL_DOCIDS
 );

828 
	`d©aBuf„rAµíd
(
pWrôî
->
b
, 
c
, 
n
);

829 
pWrôî
->
iPªvDocid
 = 
iDocid
;

830 #i‚de‡
NDEBUG


831 
pWrôî
->
has_iPªvDocid
 = 1;

833 
	}
}

845 
	sPLRódî
 {

850 c⁄° *
	mpD©a
;

851 
	mnD©a
;

853 
DocLi°Ty≥
 
	miTy≥
;

854 
	miCﬁumn
;

855 
	miPosôi⁄
;

856 
	miSèπOff£t
;

857 
	miEndOff£t
;

858 } 
	tPLRódî
;

860 
	$∂rAtEnd
(
PLRódî
 *
pRódî
){

861  
pRódî
->
pD©a
==
NULL
;

862 
	}
}

863 
	$∂rCﬁumn
(
PLRódî
 *
pRódî
){

864 
	`as£π
–!
	`∂rAtEnd
(
pRódî
) );

865  
pRódî
->
iCﬁumn
;

866 
	}
}

867 
	$∂rPosôi⁄
(
PLRódî
 *
pRódî
){

868 
	`as£π
–!
	`∂rAtEnd
(
pRódî
) );

869  
pRódî
->
iPosôi⁄
;

870 
	}
}

871 
	$∂rSèπOff£t
(
PLRódî
 *
pRódî
){

872 
	`as£π
–!
	`∂rAtEnd
(
pRódî
) );

873  
pRódî
->
iSèπOff£t
;

874 
	}
}

875 
	$∂rEndOff£t
(
PLRódî
 *
pRódî
){

876 
	`as£π
–!
	`∂rAtEnd
(
pRódî
) );

877  
pRódî
->
iEndOff£t
;

878 
	}
}

879 
	$∂rSãp
(
PLRódî
 *
pRódî
){

880 
i
, 
n
;

882 
	`as£π
–!
	`∂rAtEnd
(
pRódî
) );

884 if–
pRódî
->
nD©a
==0 ){

885 
pRódî
->
pD©a
 = 
NULL
;

889 
n
 = 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
i
);

890 if–
i
==
POS_COLUMN
 ){

891 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &pRódî->
iCﬁumn
);

892 
pRódî
->
iPosôi⁄
 = 0;

893 
pRódî
->
iSèπOff£t
 = 0;

894 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
i
);

897 
	`as£π
–
i
!=
POS_COLUMN
 );

899 if–
i
==
POS_END
 ){

900 
pRódî
->
nD©a
 = 0;

901 
pRódî
->
pD©a
 = 
NULL
;

905 
pRódî
->
iPosôi⁄
 +
i
-
POS_BASE
;

906 if–
pRódî
->
iTy≥
==
DL_POSITIONS_OFFSETS
 ){

907 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
i
);

908 
pRódî
->
iSèπOff£t
 +
i
;

909 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
i
);

910 
pRódî
->
iEndOff£t
 =ÖRódî->
iSèπOff£t
+
i
;

912 
	`as£π
–
n
<=
pRódî
->
nD©a
 );

913 
pRódî
->
pD©a
 +
n
;

914 
pRódî
->
nD©a
 -
n
;

915 
	}
}

917 
	$∂rInô
(
PLRódî
 *
pRódî
, 
DLRódî
 *
pDLRódî
){

918 
pRódî
->
pD©a
 = 
	`dÃPosD©a
(
pDLRódî
);

919 
pRódî
->
nD©a
 = 
	`dÃPosD©aLí
(
pDLRódî
);

920 
pRódî
->
iTy≥
 = 
pDLRódî
->iType;

921 
pRódî
->
iCﬁumn
 = 0;

922 
pRódî
->
iPosôi⁄
 = 0;

923 
pRódî
->
iSèπOff£t
 = 0;

924 
pRódî
->
iEndOff£t
 = 0;

925 
	`∂rSãp
(
pRódî
);

926 
	}
}

927 
	$∂rDe°roy
(
PLRódî
 *
pRódî
){

928 
	`SCRAMBLE
(
pRódî
);

929 
	}
}

955 
	sPLWrôî
 {

956 
DLWrôî
 *
	mdlw
;

958 
	miCﬁumn
;

959 
	miPos
;

960 
	miOff£t
;

961 } 
	tPLWrôî
;

967 
	$∂wAdd
(
PLWrôî
 *
pWrôî
, 
iCﬁumn
, 
iPos
,

968 
iSèπOff£t
, 
iEndOff£t
){

972 
c
[5*
VARINT_MAX
];

973 
n
 = 0;

976 
	`as£π
–
pWrôî
->
iPos
!=-1 );

978 if–
pWrôî
->
dlw
->
iTy≥
==
DL_DOCIDS
 ) ;

980 if–
iCﬁumn
!=
pWrôî
->iColumn ){

981 
n
 +
	`putV¨öt
(
c
+n, 
POS_COLUMN
);

982 
n
 +
	`putV¨öt
(
c
+n, 
iCﬁumn
);

983 
pWrôî
->
iCﬁumn
 = iColumn;

984 
pWrôî
->
iPos
 = 0;

985 
pWrôî
->
iOff£t
 = 0;

987 
	`as£π
–
iPos
>=
pWrôî
->iPos );

988 
n
 +
	`putV¨öt
(
c
+n, 
POS_BASE
+(
iPos
-
pWrôî
->iPos));

989 
pWrôî
->
iPos
 = iPos;

990 if–
pWrôî
->
dlw
->
iTy≥
==
DL_POSITIONS_OFFSETS
 ){

991 
	`as£π
–
iSèπOff£t
>=
pWrôî
->
iOff£t
 );

992 
n
 +
	`putV¨öt
(
c
+n, 
iSèπOff£t
-
pWrôî
->
iOff£t
);

993 
pWrôî
->
iOff£t
 = 
iSèπOff£t
;

994 
	`as£π
–
iEndOff£t
>=
iSèπOff£t
 );

995 
n
 +
	`putV¨öt
(
c
+n, 
iEndOff£t
-
iSèπOff£t
);

997 
	`d©aBuf„rAµíd
(
pWrôî
->
dlw
->
b
, 
c
, 
n
);

998 
	}
}

999 
	$∂wC›y
(
PLWrôî
 *
pWrôî
, 
PLRódî
 *
pRódî
){

1000 
	`∂wAdd
(
pWrôî
, 
	`∂rCﬁumn
(
pRódî
), 
	`∂rPosôi⁄
(pReader),

1001 
	`∂rSèπOff£t
(
pRódî
), 
	`∂rEndOff£t
(pReader));

1002 
	}
}

1003 
	$∂wInô
(
PLWrôî
 *
pWrôî
, 
DLWrôî
 *
dlw
, 
sqlôe_öt64
 
iDocid
){

1004 
c
[
VARINT_MAX
];

1005 
n
;

1007 
pWrôî
->
dlw
 = dlw;

1010 
	`as£π
–!
pWrôî
->
dlw
->
has_iPªvDocid
 || 
iDocid
>pWrôî->dlw->
iPªvDocid
 );

1011 
n
 = 
	`putV¨öt
(
c
, 
iDocid
-
pWrôî
->
dlw
->
iPªvDocid
);

1012 
	`d©aBuf„rAµíd
(
pWrôî
->
dlw
->
b
, 
c
, 
n
);

1013 
pWrôî
->
dlw
->
iPªvDocid
 = 
iDocid
;

1014 #i‚de‡
NDEBUG


1015 
pWrôî
->
dlw
->
has_iPªvDocid
 = 1;

1018 
pWrôî
->
iCﬁumn
 = 0;

1019 
pWrôî
->
iPos
 = 0;

1020 
pWrôî
->
iOff£t
 = 0;

1021 
	}
}

1030 
	$∂wTîmö©e
(
PLWrôî
 *
pWrôî
){

1031 if–
pWrôî
->
dlw
->
iTy≥
>
DL_DOCIDS
 ){

1032 
c
[
VARINT_MAX
];

1033 
n
 = 
	`putV¨öt
(
c
, 
POS_END
);

1034 
	`d©aBuf„rAµíd
(
pWrôî
->
dlw
->
b
, 
c
, 
n
);

1036 #i‚de‡
NDEBUG


1038 
pWrôî
->
iPos
 = -1;

1040 
	}
}

1041 
	$∂wDe°roy
(
PLWrôî
 *
pWrôî
){

1042 
	`SCRAMBLE
(
pWrôî
);

1043 
	}
}

1055 
	sDLCﬁÀ˘‹
 {

1056 
D©aBuf„r
 
	mb
;

1057 
DLWrôî
 
	mdlw
;

1058 
PLWrôî
 
	m∂w
;

1059 } 
	tDLCﬁÀ˘‹
;

1069 
	$dlcAddDo˛i°
(
DLCﬁÀ˘‹
 *
pCﬁÀ˘‹
, 
D©aBuf„r
 *
b
){

1070 if–
pCﬁÀ˘‹
->
dlw
.
iTy≥
>
DL_DOCIDS
 ){

1071 
c
[
VARINT_MAX
];

1072 
n
 = 
	`putV¨öt
(
c
, 
POS_END
);

1073 
	`d©aBuf„rAµíd2
(
b
, 
pCﬁÀ˘‹
->b.
pD©a
,ÖCﬁÀ˘‹->b.
nD©a
, 
c
, 
n
);

1075 
	`d©aBuf„rAµíd
(
b
, 
pCﬁÀ˘‹
->b.
pD©a
,ÖCﬁÀ˘‹->b.
nD©a
);

1077 
	}
}

1078 
	$dlcNext
(
DLCﬁÀ˘‹
 *
pCﬁÀ˘‹
, 
sqlôe_öt64
 
iDocid
){

1079 
	`∂wTîmö©e
(&
pCﬁÀ˘‹
->
∂w
);

1080 
	`∂wDe°roy
(&
pCﬁÀ˘‹
->
∂w
);

1081 
	`∂wInô
(&
pCﬁÀ˘‹
->
∂w
, &pCﬁÀ˘‹->
dlw
, 
iDocid
);

1082 
	}
}

1083 
	$dlcAddPos
(
DLCﬁÀ˘‹
 *
pCﬁÀ˘‹
, 
iCﬁumn
, 
iPos
,

1084 
iSèπOff£t
, 
iEndOff£t
){

1085 
	`∂wAdd
(&
pCﬁÀ˘‹
->
∂w
, 
iCﬁumn
, 
iPos
, 
iSèπOff£t
, 
iEndOff£t
);

1086 
	}
}

1088 
DLCﬁÀ˘‹
 *
	$dlcNew
(
sqlôe_öt64
 
iDocid
, 
DocLi°Ty≥
 
iTy≥
){

1089 
DLCﬁÀ˘‹
 *
pCﬁÀ˘‹
 = 
	`sqlôe4_mÆloc
((DLCollector));

1090 
	`d©aBuf„rInô
(&
pCﬁÀ˘‹
->
b
, 0);

1091 
	`dlwInô
(&
pCﬁÀ˘‹
->
dlw
, 
iTy≥
, &pCﬁÀ˘‹->
b
);

1092 
	`∂wInô
(&
pCﬁÀ˘‹
->
∂w
, &pCﬁÀ˘‹->
dlw
, 
iDocid
);

1093  
pCﬁÀ˘‹
;

1094 
	}
}

1095 
	$dlcDñëe
(
DLCﬁÀ˘‹
 *
pCﬁÀ˘‹
){

1096 
	`∂wDe°roy
(&
pCﬁÀ˘‹
->
∂w
);

1097 
	`dlwDe°roy
(&
pCﬁÀ˘‹
->
dlw
);

1098 
	`d©aBuf„rDe°roy
(&
pCﬁÀ˘‹
->
b
);

1099 
	`SCRAMBLE
(
pCﬁÀ˘‹
);

1100 
	`sqlôe4_‰ì
(
pCﬁÀ˘‹
);

1101 
	}
}

1114 
	$docLi°Trim
(
DocLi°Ty≥
 
iTy≥
, c⁄° *
pD©a
, 
nD©a
,

1115 
iCﬁumn
, 
DocLi°Ty≥
 
iOutTy≥
, 
D©aBuf„r
 *
out
){

1116 
DLRódî
 
dlRódî
;

1117 
DLWrôî
 
dlWrôî
;

1119 
	`as£π
–
iOutTy≥
<=
iTy≥
 );

1121 
	`dÃInô
(&
dlRódî
, 
iTy≥
, 
pD©a
, 
nD©a
);

1122 
	`dlwInô
(&
dlWrôî
, 
iOutTy≥
, 
out
);

1124  !
	`dÃAtEnd
(&
dlRódî
) ){

1125 
PLRódî
 
∂Ródî
;

1126 
PLWrôî
 
∂Wrôî
;

1127 
m©ch
 = 0;

1129 
	`∂rInô
(&
∂Ródî
, &
dlRódî
);

1131  !
	`∂rAtEnd
(&
∂Ródî
) ){

1132 if–
iCﬁumn
==-1 || 
	`∂rCﬁumn
(&
∂Ródî
)==iColumn ){

1133 if–!
m©ch
 ){

1134 
	`∂wInô
(&
∂Wrôî
, &
dlWrôî
, 
	`dÃDocid
(&
dlRódî
));

1135 
m©ch
 = 1;

1137 
	`∂wAdd
(&
∂Wrôî
, 
	`∂rCﬁumn
(&
∂Ródî
), 
	`∂rPosôi⁄
(&plReader),

1138 
	`∂rSèπOff£t
(&
∂Ródî
), 
	`∂rEndOff£t
(&plReader));

1140 
	`∂rSãp
(&
∂Ródî
);

1142 if–
m©ch
 ){

1143 
	`∂wTîmö©e
(&
∂Wrôî
);

1144 
	`∂wDe°roy
(&
∂Wrôî
);

1147 
	`∂rDe°roy
(&
∂Ródî
);

1148 
	`dÃSãp
(&
dlRódî
);

1150 
	`dlwDe°roy
(&
dlWrôî
);

1151 
	`dÃDe°roy
(&
dlRódî
);

1152 
	}
}

1157 
	sOrdîedDLRódî
 {

1158 
DLRódî
 *
	mpRódî
;

1164 
	midx
;

1165 } 
	tOrdîedDLRódî
;

1168 
	$‹dîedDLRódîCmp
(
OrdîedDLRódî
 *
r1
, OrdîedDLRódî *
r2
){

1169 if–
	`dÃAtEnd
(
r1
->
pRódî
) ){

1170 if–
	`dÃAtEnd
(
r2
->
pRódî
) )  0;

1173 if–
	`dÃAtEnd
(
r2
->
pRódî
) )  -1;

1175 if–
	`dÃDocid
(
r1
->
pRódî
)<dÃDocid(
r2
->pReader) )  -1;

1176 if–
	`dÃDocid
(
r1
->
pRódî
)>dÃDocid(
r2
->pReader) )  1;

1179  
r2
->
idx
-
r1
->idx;

1180 
	}
}

1190 
	$‹dîedDLRódîRe‹dî
(
OrdîedDLRódî
 *
p
, 
n
){

1191  
n
>1 && 
	`‹dîedDLRódîCmp
(
p
,Ö+1)>0 ){

1192 
OrdîedDLRódî
 
tmp
 = 
p
[0];

1193 
p
[0] =Ö[1];

1194 
p
[1] = 
tmp
;

1195 
n
--;

1196 
p
++;

1198 
	}
}

1208 
	$docLi°Mîge
(
D©aBuf„r
 *
out
,

1209 
DLRódî
 *
pRódîs
, 
nRódîs
){

1210 
OrdîedDLRódî
 
ªadîs
[
MERGE_COUNT
];

1211 
DLWrôî
 
wrôî
;

1212 
i
, 
n
;

1213 c⁄° *
pSèπ
 = 0;

1214 
nSèπ
 = 0;

1215 
sqlôe_öt64
 
iFú°Docid
 = 0, 
iLa°Docid
 = 0;

1217 
	`as£π
–
nRódîs
>0 );

1218 if–
nRódîs
==1 ){

1219 
	`d©aBuf„rAµíd
(
out
, 
	`dÃDocD©a
(
pRódîs
), 
	`dÃAŒD©aByãs
(pReaders));

1223 
	`as£π
–
nRódîs
<=
MERGE_COUNT
 );

1224 
n
 = 0;

1225 
i
=0; i<
nRódîs
; i++){

1226 
	`as£π
–
pRódîs
[
i
].
iTy≥
==pReaders[0].iType );

1227 
ªadîs
[
i
].
pRódî
 = 
pRódîs
+i;

1228 
ªadîs
[
i
].
idx
 = i;

1229 
n
 +
	`dÃAŒD©aByãs
(&
pRódîs
[
i
]);

1234 
	`d©aBuf„rEx∑nd
(
out
, 
n
);

1237  
i
-->0 ){

1238 
	`‹dîedDLRódîRe‹dî
(
ªadîs
+
i
, 
nRódîs
-i);

1241 
	`dlwInô
(&
wrôî
, 
pRódîs
[0].
iTy≥
, 
out
);

1242  !
	`dÃAtEnd
(
ªadîs
[0].
pRódî
) ){

1243 
sqlôe_öt64
 
iDocid
 = 
	`dÃDocid
(
ªadîs
[0].
pRódî
);

1249 if–
	`dÃDocD©a
(
ªadîs
[0].
pRódî
)==
pSèπ
+
nSèπ
 ){

1250 
nSèπ
 +
	`dÃDocD©aByãs
(
ªadîs
[0].
pRódî
);

1252 if–
pSèπ
!=0 ){

1253 
	`dlwAµíd
(&
wrôî
, 
pSèπ
, 
nSèπ
, 
iFú°Docid
, 
iLa°Docid
);

1255 
pSèπ
 = 
	`dÃDocD©a
(
ªadîs
[0].
pRódî
);

1256 
nSèπ
 = 
	`dÃDocD©aByãs
(
ªadîs
[0].
pRódî
);

1257 
iFú°Docid
 = 
iDocid
;

1259 
iLa°Docid
 = 
iDocid
;

1260 
	`dÃSãp
(
ªadîs
[0].
pRódî
);

1263 
i
=1; i<
nRódîs
 &&

1264 !
	`dÃAtEnd
(
ªadîs
[
i
].
pRódî
) &&

1265 
	`dÃDocid
(
ªadîs
[
i
].
pRódî
)==
iDocid
; i++){

1266 
	`dÃSãp
(
ªadîs
[
i
].
pRódî
);

1270  
i
-->0 ){

1271 
	`‹dîedDLRódîRe‹dî
(
ªadîs
+
i
, 
nRódîs
-i);

1276 if–
nSèπ
>0 ) 
	`dlwAµíd
(&
wrôî
, 
pSèπ
,ÇSèπ, 
iFú°Docid
, 
iLa°Docid
);

1277 
	`dlwDe°roy
(&
wrôî
);

1278 
	}
}

1285 
	$posLi°Cmp
(
PLRódî
 *
pLe·
, PLRódî *
pRight
){

1286 
	`as£π
–
pLe·
->
iTy≥
==
pRight
->iType );

1287 if–
pLe·
->
iTy≥
==
DL_DOCIDS
 )  0;

1289 if–
	`∂rAtEnd
(
pLe·
ËËÖÃAtEnd(
pRight
) ? 0 : 1;

1290 if–
	`∂rAtEnd
(
pRight
) )  -1;

1292 if–
	`∂rCﬁumn
(
pLe·
)<∂rCﬁumn(
pRight
) )  -1;

1293 if–
	`∂rCﬁumn
(
pLe·
)>∂rCﬁumn(
pRight
) )  1;

1295 if–
	`∂rPosôi⁄
(
pLe·
)<∂rPosôi⁄(
pRight
) )  -1;

1296 if–
	`∂rPosôi⁄
(
pLe·
)>∂rPosôi⁄(
pRight
) )  1;

1297 if–
pLe·
->
iTy≥
==
DL_POSITIONS
 )  0;

1299 if–
	`∂rSèπOff£t
(
pLe·
)<∂rSèπOff£t(
pRight
) )  -1;

1300 if–
	`∂rSèπOff£t
(
pLe·
)>∂rSèπOff£t(
pRight
) )  1;

1302 if–
	`∂rEndOff£t
(
pLe·
)<∂rEndOff£t(
pRight
) )  -1;

1303 if–
	`∂rEndOff£t
(
pLe·
)>∂rEndOff£t(
pRight
) )  1;

1306 
	}
}

1313 
	$posLi°Uni⁄
(
DLRódî
 *
pLe·
, DLRódî *
pRight
, 
DLWrôî
 *
pOut
){

1314 
PLRódî
 
À·
, 
right
;

1315 
PLWrôî
 
wrôî
;

1317 
	`as£π
–
	`dÃDocid
(
pLe·
)==dÃDocid(
pRight
) );

1318 
	`as£π
–
pLe·
->
iTy≥
==
pRight
->iType );

1319 
	`as£π
–
pLe·
->
iTy≥
==
pOut
->iType );

1321 
	`∂rInô
(&
À·
, 
pLe·
);

1322 
	`∂rInô
(&
right
, 
pRight
);

1323 
	`∂wInô
(&
wrôî
, 
pOut
, 
	`dÃDocid
(
pLe·
));

1325  !
	`∂rAtEnd
(&
À·
Ë|| !∂rAtEnd(&
right
) ){

1326 
c
 = 
	`posLi°Cmp
(&
À·
, &
right
);

1327 if–
c
<0 ){

1328 
	`∂wC›y
(&
wrôî
, &
À·
);

1329 
	`∂rSãp
(&
À·
);

1330 }if–
c
>0 ){

1331 
	`∂wC›y
(&
wrôî
, &
right
);

1332 
	`∂rSãp
(&
right
);

1334 
	`∂wC›y
(&
wrôî
, &
À·
);

1335 
	`∂rSãp
(&
À·
);

1336 
	`∂rSãp
(&
right
);

1340 
	`∂wTîmö©e
(&
wrôî
);

1341 
	`∂wDe°roy
(&
wrôî
);

1342 
	`∂rDe°roy
(&
À·
);

1343 
	`∂rDe°roy
(&
right
);

1344 
	}
}

1350 
	$docLi°Uni⁄
(

1351 c⁄° *
pLe·
, 
nLe·
,

1352 c⁄° *
pRight
, 
nRight
,

1353 
D©aBuf„r
 *
pOut


1355 
DLRódî
 
À·
, 
right
;

1356 
DLWrôî
 
wrôî
;

1358 if–
nLe·
==0 ){

1359 if–
nRight
!=0Ë
	`d©aBuf„rAµíd
(
pOut
, 
pRight
,ÇRight);

1362 if–
nRight
==0 ){

1363 
	`d©aBuf„rAµíd
(
pOut
, 
pLe·
, 
nLe·
);

1367 
	`dÃInô
(&
À·
, 
DL_DEFAULT
, 
pLe·
, 
nLe·
);

1368 
	`dÃInô
(&
right
, 
DL_DEFAULT
, 
pRight
, 
nRight
);

1369 
	`dlwInô
(&
wrôî
, 
DL_DEFAULT
, 
pOut
);

1371  !
	`dÃAtEnd
(&
À·
Ë|| !dÃAtEnd(&
right
) ){

1372 if–
	`dÃAtEnd
(&
right
) ){

1373 
	`dlwC›y
(&
wrôî
, &
À·
);

1374 
	`dÃSãp
(&
À·
);

1375 }if–
	`dÃAtEnd
(&
À·
) ){

1376 
	`dlwC›y
(&
wrôî
, &
right
);

1377 
	`dÃSãp
(&
right
);

1378 }if–
	`dÃDocid
(&
À·
)<dÃDocid(&
right
) ){

1379 
	`dlwC›y
(&
wrôî
, &
À·
);

1380 
	`dÃSãp
(&
À·
);

1381 }if–
	`dÃDocid
(&
À·
)>dÃDocid(&
right
) ){

1382 
	`dlwC›y
(&
wrôî
, &
right
);

1383 
	`dÃSãp
(&
right
);

1385 
	`posLi°Uni⁄
(&
À·
, &
right
, &
wrôî
);

1386 
	`dÃSãp
(&
À·
);

1387 
	`dÃSãp
(&
right
);

1391 
	`dÃDe°roy
(&
À·
);

1392 
	`dÃDe°roy
(&
right
);

1393 
	`dlwDe°roy
(&
wrôî
);

1394 
	}
}

1408 
	$posLi°Phø£Mîge
(
DLRódî
 *
pLe·
, DLRódî *
pRight
,

1409 
DLWrôî
 *
pOut
){

1410 
PLRódî
 
À·
, 
right
;

1411 
PLWrôî
 
wrôî
;

1412 
m©ch
 = 0;

1414 
	`as£π
–
	`dÃDocid
(
pLe·
)==dÃDocid(
pRight
) );

1415 
	`as£π
–
pOut
->
iTy≥
!=
DL_POSITIONS_OFFSETS
 );

1417 
	`∂rInô
(&
À·
, 
pLe·
);

1418 
	`∂rInô
(&
right
, 
pRight
);

1420  !
	`∂rAtEnd
(&
À·
Ë&& !∂rAtEnd(&
right
) ){

1421 if–
	`∂rCﬁumn
(&
À·
)<∂rCﬁumn(&
right
) ){

1422 
	`∂rSãp
(&
À·
);

1423 }if–
	`∂rCﬁumn
(&
À·
)>∂rCﬁumn(&
right
) ){

1424 
	`∂rSãp
(&
right
);

1425 }if–
	`∂rPosôi⁄
(&
À·
)+1<∂rPosôi⁄(&
right
) ){

1426 
	`∂rSãp
(&
À·
);

1427 }if–
	`∂rPosôi⁄
(&
À·
)+1>∂rPosôi⁄(&
right
) ){

1428 
	`∂rSãp
(&
right
);

1430 if–!
m©ch
 ){

1431 
	`∂wInô
(&
wrôî
, 
pOut
, 
	`dÃDocid
(
pLe·
));

1432 
m©ch
 = 1;

1434 
	`∂wAdd
(&
wrôî
, 
	`∂rCﬁumn
(&
right
), 
	`∂rPosôi⁄
(&right), 0, 0);

1435 
	`∂rSãp
(&
À·
);

1436 
	`∂rSãp
(&
right
);

1440 if–
m©ch
 ){

1441 
	`∂wTîmö©e
(&
wrôî
);

1442 
	`∂wDe°roy
(&
wrôî
);

1445 
	`∂rDe°roy
(&
À·
);

1446 
	`∂rDe°roy
(&
right
);

1447 
	}
}

1458 
	$docLi°Phø£Mîge
(

1459 c⁄° *
pLe·
, 
nLe·
,

1460 c⁄° *
pRight
, 
nRight
,

1461 
DocLi°Ty≥
 
iTy≥
,

1462 
D©aBuf„r
 *
pOut


1464 
DLRódî
 
À·
, 
right
;

1465 
DLWrôî
 
wrôî
;

1467 if–
nLe·
==0 || 
nRight
==0 ) ;

1469 
	`as£π
–
iTy≥
!=
DL_POSITIONS_OFFSETS
 );

1471 
	`dÃInô
(&
À·
, 
DL_POSITIONS
, 
pLe·
, 
nLe·
);

1472 
	`dÃInô
(&
right
, 
DL_POSITIONS
, 
pRight
, 
nRight
);

1473 
	`dlwInô
(&
wrôî
, 
iTy≥
, 
pOut
);

1475  !
	`dÃAtEnd
(&
À·
Ë&& !dÃAtEnd(&
right
) ){

1476 if–
	`dÃDocid
(&
À·
)<dÃDocid(&
right
) ){

1477 
	`dÃSãp
(&
À·
);

1478 }if–
	`dÃDocid
(&
right
)<dÃDocid(&
À·
) ){

1479 
	`dÃSãp
(&
right
);

1481 
	`posLi°Phø£Mîge
(&
À·
, &
right
, &
wrôî
);

1482 
	`dÃSãp
(&
À·
);

1483 
	`dÃSãp
(&
right
);

1487 
	`dÃDe°roy
(&
À·
);

1488 
	`dÃDe°roy
(&
right
);

1489 
	`dlwDe°roy
(&
wrôî
);

1490 
	}
}

1496 
	$docLi°AndMîge
(

1497 c⁄° *
pLe·
, 
nLe·
,

1498 c⁄° *
pRight
, 
nRight
,

1499 
D©aBuf„r
 *
pOut


1501 
DLRódî
 
À·
, 
right
;

1502 
DLWrôî
 
wrôî
;

1504 if–
nLe·
==0 || 
nRight
==0 ) ;

1506 
	`dÃInô
(&
À·
, 
DL_DOCIDS
, 
pLe·
, 
nLe·
);

1507 
	`dÃInô
(&
right
, 
DL_DOCIDS
, 
pRight
, 
nRight
);

1508 
	`dlwInô
(&
wrôî
, 
DL_DOCIDS
, 
pOut
);

1510  !
	`dÃAtEnd
(&
À·
Ë&& !dÃAtEnd(&
right
) ){

1511 if–
	`dÃDocid
(&
À·
)<dÃDocid(&
right
) ){

1512 
	`dÃSãp
(&
À·
);

1513 }if–
	`dÃDocid
(&
right
)<dÃDocid(&
À·
) ){

1514 
	`dÃSãp
(&
right
);

1516 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
À·
));

1517 
	`dÃSãp
(&
À·
);

1518 
	`dÃSãp
(&
right
);

1522 
	`dÃDe°roy
(&
À·
);

1523 
	`dÃDe°roy
(&
right
);

1524 
	`dlwDe°roy
(&
wrôî
);

1525 
	}
}

1531 
	$docLi°OrMîge
(

1532 c⁄° *
pLe·
, 
nLe·
,

1533 c⁄° *
pRight
, 
nRight
,

1534 
D©aBuf„r
 *
pOut


1536 
DLRódî
 
À·
, 
right
;

1537 
DLWrôî
 
wrôî
;

1539 if–
nLe·
==0 ){

1540 if–
nRight
!=0 ) 
	`d©aBuf„rAµíd
(
pOut
, 
pRight
,ÇRight);

1543 if–
nRight
==0 ){

1544 
	`d©aBuf„rAµíd
(
pOut
, 
pLe·
, 
nLe·
);

1548 
	`dÃInô
(&
À·
, 
DL_DOCIDS
, 
pLe·
, 
nLe·
);

1549 
	`dÃInô
(&
right
, 
DL_DOCIDS
, 
pRight
, 
nRight
);

1550 
	`dlwInô
(&
wrôî
, 
DL_DOCIDS
, 
pOut
);

1552  !
	`dÃAtEnd
(&
À·
Ë|| !dÃAtEnd(&
right
) ){

1553 if–
	`dÃAtEnd
(&
right
) ){

1554 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
À·
));

1555 
	`dÃSãp
(&
À·
);

1556 }if–
	`dÃAtEnd
(&
À·
) ){

1557 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
right
));

1558 
	`dÃSãp
(&
right
);

1559 }if–
	`dÃDocid
(&
À·
)<dÃDocid(&
right
) ){

1560 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
À·
));

1561 
	`dÃSãp
(&
À·
);

1562 }if–
	`dÃDocid
(&
right
)<dÃDocid(&
À·
) ){

1563 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
right
));

1564 
	`dÃSãp
(&
right
);

1566 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
À·
));

1567 
	`dÃSãp
(&
À·
);

1568 
	`dÃSãp
(&
right
);

1572 
	`dÃDe°roy
(&
À·
);

1573 
	`dÃDe°roy
(&
right
);

1574 
	`dlwDe°roy
(&
wrôî
);

1575 
	}
}

1581 
	$docLi°Ex˚±Mîge
(

1582 c⁄° *
pLe·
, 
nLe·
,

1583 c⁄° *
pRight
, 
nRight
,

1584 
D©aBuf„r
 *
pOut


1586 
DLRódî
 
À·
, 
right
;

1587 
DLWrôî
 
wrôî
;

1589 if–
nLe·
==0 ) ;

1590 if–
nRight
==0 ){

1591 
	`d©aBuf„rAµíd
(
pOut
, 
pLe·
, 
nLe·
);

1595 
	`dÃInô
(&
À·
, 
DL_DOCIDS
, 
pLe·
, 
nLe·
);

1596 
	`dÃInô
(&
right
, 
DL_DOCIDS
, 
pRight
, 
nRight
);

1597 
	`dlwInô
(&
wrôî
, 
DL_DOCIDS
, 
pOut
);

1599  !
	`dÃAtEnd
(&
À·
) ){

1600  !
	`dÃAtEnd
(&
right
Ë&& 
	`dÃDocid
(&right)<dÃDocid(&
À·
) ){

1601 
	`dÃSãp
(&
right
);

1603 if–
	`dÃAtEnd
(&
right
Ë|| 
	`dÃDocid
(&
À·
)<dlrDocid(&right) ){

1604 
	`dlwAdd
(&
wrôî
, 
	`dÃDocid
(&
À·
));

1606 
	`dÃSãp
(&
À·
);

1609 
	`dÃDe°roy
(&
À·
);

1610 
	`dÃDe°roy
(&
right
);

1611 
	`dlwDe°roy
(&
wrôî
);

1612 
	}
}

1614 *
	$°rög_dup_n
(c⁄° *
s
, 
n
){

1615 *
°r
 = 
	`sqlôe4_mÆloc
(
n
 + 1);

1616 
	`mem˝y
(
°r
, 
s
, 
n
);

1617 
°r
[
n
] = '\0';

1618  
°r
;

1619 
	}
}

1624 *
	$°rög_dup
(c⁄° *
s
){

1625  
	`°rög_dup_n
(
s
, 
	`°æí
(s));

1626 
	}
}

1632 *
	$°rög_f‹m©
(c⁄° *
zF‹m©
,

1633 c⁄° *
zDb
, c⁄° *
zName
){

1634 c⁄° *
p
;

1635 
size_t
 
Àn
 = 0;

1636 
size_t
 
nDb
 = 
	`°æí
(
zDb
);

1637 
size_t
 
nName
 = 
	`°æí
(
zName
);

1638 
size_t
 
nFuŒTabÀName
 = 
nDb
+1+
nName
;

1639 *
ªsu…
;

1640 *
r
;

1643 
p
 = 
zF‹m©
 ; *p ; ++p){

1644 
Àn
 +(*
p
=='%' ? 
nFuŒTabÀName
 : 1);

1646 
Àn
 += 1;

1648 
r
 = 
ªsu…
 = 
	`sqlôe4_mÆloc
(
Àn
);

1649 
p
 = 
zF‹m©
; *p; ++p){

1650 if–*
p
=='%' ){

1651 
	`mem˝y
(
r
, 
zDb
, 
nDb
);

1652 
r
 +
nDb
;

1653 *
r
++ = '.';

1654 
	`mem˝y
(
r
, 
zName
, 
nName
);

1655 
r
 +
nName
;

1657 *
r
++ = *
p
;

1660 *
r
++ = '\0';

1661 
	`as£π
–
r
 =
ªsu…
 + 
Àn
 );

1662  
ªsu…
;

1663 
	}
}

1665 
	$sql_exec
(
sqlôe4
 *
db
, c⁄° *
zDb
, c⁄° *
zName
,

1666 c⁄° *
zF‹m©
){

1667 *
zComm™d
 = 
	`°rög_f‹m©
(
zF‹m©
, 
zDb
, 
zName
);

1668 
rc
;

1669 
	`TRACE
(("FTS2 sql: %s\n", 
zComm™d
));

1670 
rc
 = 
	`sqlôe4_exec
(
db
, 
zComm™d
, 
NULL
, 0, NULL);

1671 
	`sqlôe4_‰ì
(
zComm™d
);

1672  
rc
;

1673 
	}
}

1675 
	$sql_¥ï¨e
(
sqlôe4
 *
db
, c⁄° *
zDb
, c⁄° *
zName
,

1676 
sqlôe4_°mt
 **
µStmt
, c⁄° *
zF‹m©
){

1677 *
zComm™d
 = 
	`°rög_f‹m©
(
zF‹m©
, 
zDb
, 
zName
);

1678 
rc
;

1679 
	`TRACE
(("FTS2Öª∑ª: %s\n", 
zComm™d
));

1680 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zComm™d
, -1, 
µStmt
, 
NULL
);

1681 
	`sqlôe4_‰ì
(
zComm™d
);

1682  
rc
;

1683 
	}
}

1688 
fuŒãxt_vèb
 
	tfuŒãxt_vèb
;

1693 
	sQuîyTîm
 {

1694 
	mnPhø£
;

1695 
	miPhø£
;

1696 
	miCﬁumn
;

1697 sig√d 
	misOr
;

1698 sig√d 
	misNŸ
;

1699 sig√d 
	misPªfix
;

1700 *
	mpTîm
;

1701 
	mnTîm
;

1702 } 
	tQuîyTîm
;

1733 
	sQuîy
 {

1734 
fuŒãxt_vèb
 *
	mpFts
;

1735 
	mnTîms
;

1736 
QuîyTîm
 *
	mpTîms
;

1737 
	m√xtIsOr
;

1738 
	m√xtCﬁumn
;

1739 
	mdÊtCﬁumn
;

1740 } 
	tQuîy
;

1747 
	sSnù≥t
 {

1748 
	mnM©ch
;

1749 
	mnAŒoc
;

1750 
	s¢ù≥tM©ch
 {

1751 
	m¢Sètus
;

1752 
	miCﬁ
;

1753 
	miTîm
;

1754 
	mnByã
;

1755 
	miSèπ
;

1756 } *
	maM©ch
;

1757 *
	mzOff£t
;

1758 
	mnOff£t
;

1759 *
	mzSnù≥t
;

1760 
	mnSnù≥t
;

1761 } 
	tSnù≥t
;

1764 
	eQuîyTy≥
 {

1765 
	mQUERY_GENERIC
,

1766 
	mQUERY_ROWID
,

1767 
	mQUERY_FULLTEXT


1768 } 
	tQuîyTy≥
;

1770 
	efuŒãxt_°©emít
 {

1771 
	mCONTENT_INSERT_STMT
,

1772 
	mCONTENT_SELECT_STMT
,

1773 
	mCONTENT_UPDATE_STMT
,

1774 
	mCONTENT_DELETE_STMT
,

1775 
	mCONTENT_EXISTS_STMT
,

1777 
	mBLOCK_INSERT_STMT
,

1778 
	mBLOCK_SELECT_STMT
,

1779 
	mBLOCK_DELETE_STMT
,

1780 
	mBLOCK_DELETE_ALL_STMT
,

1782 
	mSEGDIR_MAX_INDEX_STMT
,

1783 
	mSEGDIR_SET_STMT
,

1784 
	mSEGDIR_SELECT_LEVEL_STMT
,

1785 
	mSEGDIR_SPAN_STMT
,

1786 
	mSEGDIR_DELETE_STMT
,

1787 
	mSEGDIR_SELECT_SEGMENT_STMT
,

1788 
	mSEGDIR_SELECT_ALL_STMT
,

1789 
	mSEGDIR_DELETE_ALL_STMT
,

1790 
	mSEGDIR_COUNT_STMT
,

1792 
	mMAX_STMT


1793 } 
	tfuŒãxt_°©emít
;

1800 c⁄° *c⁄° 
	gfuŒãxt_zSèãmít
[
MAX_STMT
] = {

1801  
NULL
,

1803  
NULL
,

1842 
	sfuŒãxt_vèb
 {

1843 
sqlôe4_vèb
 
	mba£
;

1844 
sqlôe4
 *
	mdb
;

1845 c⁄° *
	mzDb
;

1846 c⁄° *
	mzName
;

1847 
	mnCﬁumn
;

1848 **
	mazCﬁumn
;

1849 **
	mazC⁄ã¡Cﬁumn
;

1850 
sqlôe4_tokíizî
 *
	mpTokíizî
;

1855 
sqlôe4_°mt
 *
	mpFuŒãxtSèãmíts
[
MAX_STMT
];

1860 
sqlôe4_°mt
 *
	mpLófSñe˘Stmts
[
MERGE_COUNT
];

1862 
	#LEAF_SELECT
 \

1863 "£À˘ block from %_£gmít†whîêrowid bëwì¿?ánd ? ordî byÑowid"

	)

1875 
	mnPídögD©a
;

1876 
	#kPídögThªshﬁd
 (1*1024*1024)

	)

1877 
sqlôe_öt64
 
	miPªvDocid
;

1878 
·s2Hash
 
	m≥ndögTîms
;

1886 
	sfuŒãxt_curs‹
 {

1887 
sqlôe4_vèb_curs‹
 
	mba£
;

1888 
QuîyTy≥
 
	miCurs‹Ty≥
;

1889 
sqlôe4_°mt
 *
	mpStmt
;

1890 
	meof
;

1891 
Quîy
 
	mq
;

1892 
Snù≥t
 
	m¢ù≥t
;

1893 
	miCﬁumn
;

1894 
D©aBuf„r
 
	mªsu…
;

1895 
DLRódî
 
	mªadî
;

1896 } 
	tfuŒãxt_curs‹
;

1898 
fuŒãxt_vèb
 *
	$curs‹_vèb
(
fuŒãxt_curs‹
 *
c
){

1899  (
fuŒãxt_vèb
 *Ë
c
->
ba£
.
pVèb
;

1900 
	}
}

1902 c⁄° 
sqlôe4_moduÀ
 
	g·s2ModuÀ
;

1907 c⁄° *
	$c⁄ã¡In£πSèãmít
(
fuŒãxt_vèb
 *
v
){

1908 
SåögBuf„r
 
sb
;

1909 
i
;

1911 
	`öôSåögBuf„r
(&
sb
);

1912 
	`≠≥nd
(&
sb
, "insert into %_content (rowid, ");

1913 
	`≠≥ndLi°
(&
sb
, 
v
->
nCﬁumn
, v->
azC⁄ã¡Cﬁumn
);

1914 
	`≠≥nd
(&
sb
, ") values (?");

1915 
i
=0; i<
v
->
nCﬁumn
; ++i)

1916 
	`≠≥nd
(&
sb
, ", ?");

1917 
	`≠≥nd
(&
sb
, ")");

1918  
	`°rögBuf„rD©a
(&
sb
);

1919 
	}
}

1925 c⁄° *
	$c⁄ã¡Upd©eSèãmít
(
fuŒãxt_vèb
 *
v
){

1926 
SåögBuf„r
 
sb
;

1927 
i
;

1929 
	`öôSåögBuf„r
(&
sb
);

1930 
	`≠≥nd
(&
sb
, "update %_content set ");

1931 
i
=0; i<
v
->
nCﬁumn
; ++i) {

1932 if–
i
>0 ){

1933 
	`≠≥nd
(&
sb
, ", ");

1935 
	`≠≥nd
(&
sb
, 
v
->
azC⁄ã¡Cﬁumn
[
i
]);

1936 
	`≠≥nd
(&
sb
, " = ?");

1938 
	`≠≥nd
(&
sb
, " whereÑowid = ?");

1939  
	`°rögBuf„rD©a
(&
sb
);

1940 
	}
}

1946 
	$sql_gë_°©emít
(
fuŒãxt_vèb
 *
v
, 
fuŒãxt_°©emít
 
iStmt
,

1947 
sqlôe4_°mt
 **
µStmt
){

1948 
	`as£π
–
iStmt
<
MAX_STMT
 );

1949 if–
v
->
pFuŒãxtSèãmíts
[
iStmt
]==
NULL
 ){

1950 c⁄° *
zStmt
;

1951 
rc
;

1952  
iStmt
 ){

1953 
CONTENT_INSERT_STMT
:

1954 
zStmt
 = 
	`c⁄ã¡In£πSèãmít
(
v
); ;

1955 
CONTENT_UPDATE_STMT
:

1956 
zStmt
 = 
	`c⁄ã¡Upd©eSèãmít
(
v
); ;

1958 
zStmt
 = 
fuŒãxt_zSèãmít
[
iStmt
];

1960 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zDb
, v->
zName
, &v->
pFuŒãxtSèãmíts
[
iStmt
],

1961 
zStmt
);

1962 if–
zStmt
 !
fuŒãxt_zSèãmít
[
iStmt
]Ë
	`sqlôe4_‰ì
((*) zStmt);

1963 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1965 
rc
 = 
	`sqlôe4_ª£t
(
v
->
pFuŒãxtSèãmíts
[
iStmt
]);

1966 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1969 *
µStmt
 = 
v
->
pFuŒãxtSèãmíts
[
iStmt
];

1970  
SQLITE4_OK
;

1971 
	}
}

1977 
	$sql_sögÀ_°ï
(
sqlôe4_°mt
 *
s
){

1978 
rc
 = 
	`sqlôe4_°ï
(
s
);

1979  (
rc
==
SQLITE4_DONE
Ë? 
SQLITE4_OK
 :Ñc;

1980 
	}
}

1989 
	$sql_gë_Àaf_°©emít
(
fuŒãxt_vèb
 *
v
, 
idx
,

1990 
sqlôe4_°mt
 **
µStmt
){

1991 
	`as£π
–
idx
>=-1 && idx<
MERGE_COUNT
 );

1992 if–
idx
==-1 ){

1993  
	`sql_¥ï¨e
(
v
->
db
, v->
zDb
, v->
zName
, 
µStmt
, 
LEAF_SELECT
);

1994 }if–
v
->
pLófSñe˘Stmts
[
idx
]==
NULL
 ){

1995 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zDb
, v->
zName
, &v->
pLófSñe˘Stmts
[
idx
],

1996 
LEAF_SELECT
);

1997 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1999 
rc
 = 
	`sqlôe4_ª£t
(
v
->
pLófSñe˘Stmts
[
idx
]);

2000 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2003 *
µStmt
 = 
v
->
pLófSñe˘Stmts
[
idx
];

2004  
SQLITE4_OK
;

2005 
	}
}

2008 
	$c⁄ã¡_ö£π
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 *
rowid
,

2009 
sqlôe4_vÆue
 **
pVÆues
){

2010 
sqlôe4_°mt
 *
s
;

2011 
i
;

2012 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_INSERT_STMT
, &
s
);

2013 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2015 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 1, 
rowid
);

2016 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2018 
i
=0; i<
v
->
nCﬁumn
; ++i){

2019 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 2+
i
, 
pVÆues
[i]);

2020 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2023  
	`sql_sögÀ_°ï
(
s
);

2024 
	}
}

2028 
	$c⁄ã¡_upd©e
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 **
pVÆues
,

2029 
sqlôe_öt64
 
iRowid
){

2030 
sqlôe4_°mt
 *
s
;

2031 
i
;

2032 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_UPDATE_STMT
, &
s
);

2033 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2035 
i
=0; i<
v
->
nCﬁumn
; ++i){

2036 
rc
 = 
	`sqlôe4_böd_vÆue
(
s
, 1+
i
, 
pVÆues
[i]);

2037 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2040 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1+
v
->
nCﬁumn
, 
iRowid
);

2041 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2043  
	`sql_sögÀ_°ï
(
s
);

2044 
	}
}

2046 
	$‰ìSåögAºay
(
nSåög
, c⁄° **
pSåög
){

2047 
i
;

2049 
i
=0 ; i < 
nSåög
 ; ++i) {

2050 if–
pSåög
[
i
]!=
NULL
 ) 
	`sqlôe4_‰ì
((*)ÖString[i]);

2052 
	`sqlôe4_‰ì
((*Ë
pSåög
);

2053 
	}
}

2061 
	$c⁄ã¡_£À˘
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
,

2062 c⁄° ***
pVÆues
){

2063 
sqlôe4_°mt
 *
s
;

2064 c⁄° **
vÆues
;

2065 
i
;

2066 
rc
;

2068 *
pVÆues
 = 
NULL
;

2070 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_SELECT_STMT
, &
s
);

2071 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2073 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iRow
);

2074 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2076 
rc
 = 
	`sqlôe4_°ï
(
s
);

2077 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

2079 
vÆues
 = (c⁄° **Ë
	`sqlôe4_mÆloc
(
v
->
nCﬁumn
 * (const *));

2080 
i
=0; i<
v
->
nCﬁumn
; ++i){

2081 if–
	`sqlôe4_cﬁumn_ty≥
(
s
, 
i
)==
SQLITE4_NULL
 ){

2082 
vÆues
[
i
] = 
NULL
;

2084 
vÆues
[
i
] = 
	`°rög_dup
((*)
	`sqlôe4_cﬁumn_ãxt
(
s
, i));

2090 
rc
 = 
	`sqlôe4_°ï
(
s
);

2091 if–
rc
==
SQLITE4_DONE
 ){

2092 *
pVÆues
 = 
vÆues
;

2093  
SQLITE4_OK
;

2096 
	`‰ìSåögAºay
(
v
->
nCﬁumn
, 
vÆues
);

2097  
rc
;

2098 
	}
}

2101 
	$c⁄ã¡_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
){

2102 
sqlôe4_°mt
 *
s
;

2103 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_DELETE_STMT
, &
s
);

2104 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2106 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iRow
);

2107 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2109  
	`sql_sögÀ_°ï
(
s
);

2110 
	}
}

2115 
	$c⁄ã¡_exi°s
(
fuŒãxt_vèb
 *
v
){

2116 
sqlôe4_°mt
 *
s
;

2117 
rc
 = 
	`sql_gë_°©emít
(
v
, 
CONTENT_EXISTS_STMT
, &
s
);

2118 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2120 
rc
 = 
	`sqlôe4_°ï
(
s
);

2121 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

2125 
rc
 = 
	`sqlôe4_°ï
(
s
);

2126 if–
rc
==
SQLITE4_DONE
 )  
SQLITE4_ROW
;

2127 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2128  
rc
;

2129 
	}
}

2134 
	$block_ö£π
(
fuŒãxt_vèb
 *
v
, c⁄° *
pD©a
, 
nD©a
,

2135 
sqlôe_öt64
 *
piBlockid
){

2136 
sqlôe4_°mt
 *
s
;

2137 
rc
 = 
	`sql_gë_°©emít
(
v
, 
BLOCK_INSERT_STMT
, &
s
);

2138 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2140 
rc
 = 
	`sqlôe4_böd_blob
(
s
, 1, 
pD©a
, 
nD©a
, 
SQLITE4_STATIC
);

2141 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2143 
rc
 = 
	`sqlôe4_°ï
(
s
);

2144 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2145 if–
rc
!=
SQLITE4_DONE
 ) Ñc;

2147 *
piBlockid
 = 
	`sqlôe4_œ°_ö£π_rowid
(
v
->
db
);

2148  
SQLITE4_OK
;

2149 
	}
}

2157 
	$block_dñëe
(
fuŒãxt_vèb
 *
v
,

2158 
sqlôe_öt64
 
iSèπBlockid
, sqlôe_öt64 
iEndBlockid
){

2159 
sqlôe4_°mt
 *
s
;

2160 
rc
 = 
	`sql_gë_°©emít
(
v
, 
BLOCK_DELETE_STMT
, &
s
);

2161 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2163 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iSèπBlockid
);

2164 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2166 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
iEndBlockid
);

2167 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2169  
	`sql_sögÀ_°ï
(
s
);

2170 
	}
}

2176 
	$£gdú_max_ödex
(
fuŒãxt_vèb
 *
v
, 
iLevñ
, *
pidx
){

2177 
sqlôe4_°mt
 *
s
;

2178 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_MAX_INDEX_STMT
, &
s
);

2179 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2181 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 1, 
iLevñ
);

2182 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2184 
rc
 = 
	`sqlôe4_°ï
(
s
);

2186 if–
rc
==
SQLITE4_DONE
 )  SQLITE4_DONE;

2187 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

2190 if–
SQLITE4_NULL
==
	`sqlôe4_cﬁumn_ty≥
(
s
, 0) ){

2191 
rc
 = 
	`sqlôe4_°ï
(
s
);

2192 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2193  
rc
;

2196 *
pidx
 = 
	`sqlôe4_cﬁumn_öt
(
s
, 0);

2200 
rc
 = 
	`sqlôe4_°ï
(
s
);

2201 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2202 if–
rc
!=
SQLITE4_DONE
 ) Ñc;

2203  
SQLITE4_ROW
;

2204 
	}
}

2212 
	$£gdú_£t
(
fuŒãxt_vèb
 *
v
, 
iLevñ
, 
idx
,

2213 
sqlôe_öt64
 
iSèπBlockid
,

2214 
sqlôe_öt64
 
iLóvesEndBlockid
,

2215 
sqlôe_öt64
 
iEndBlockid
,

2216 c⁄° *
pRoŸD©a
, 
nRoŸD©a
){

2217 
sqlôe4_°mt
 *
s
;

2218 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SET_STMT
, &
s
);

2219 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2221 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 1, 
iLevñ
);

2222 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2224 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 2, 
idx
);

2225 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2227 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 3, 
iSèπBlockid
);

2228 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2230 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 4, 
iLóvesEndBlockid
);

2231 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2233 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 5, 
iEndBlockid
);

2234 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2236 
rc
 = 
	`sqlôe4_böd_blob
(
s
, 6, 
pRoŸD©a
, 
nRoŸD©a
, 
SQLITE4_STATIC
);

2237 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2239  
	`sql_sögÀ_°ï
(
s
);

2240 
	}
}

2246 
	$£gdú_•™
(
fuŒãxt_vèb
 *
v
, 
iLevñ
,

2247 
sqlôe_öt64
 *
piSèπBlockid
,

2248 
sqlôe_öt64
 *
piEndBlockid
){

2249 
sqlôe4_°mt
 *
s
;

2250 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SPAN_STMT
, &
s
);

2251 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2253 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 1, 
iLevñ
);

2254 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2256 
rc
 = 
	`sqlôe4_°ï
(
s
);

2257 if–
rc
==
SQLITE4_DONE
 )  SQLITE4_DONE;

2258 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

2261 if–
SQLITE4_NULL
==
	`sqlôe4_cﬁumn_ty≥
(
s
, 0) ){

2264 
rc2
 = 
	`sqlôe4_°ï
(
s
);

2265 if–
rc2
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2266  
rc2
;

2269 *
piSèπBlockid
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

2270 *
piEndBlockid
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 1);

2274 
rc
 = 
	`sqlôe4_°ï
(
s
);

2275 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2276 if–
rc
!=
SQLITE4_DONE
 ) Ñc;

2277  
SQLITE4_ROW
;

2278 
	}
}

2283 
	$£gdú_dñëe
(
fuŒãxt_vèb
 *
v
, 
iLevñ
){

2284 
sqlôe4_°mt
 *
s
;

2285 
sqlôe_öt64
 
iSèπBlockid
, 
iEndBlockid
;

2286 
rc
 = 
	`£gdú_•™
(
v
, 
iLevñ
, &
iSèπBlockid
, &
iEndBlockid
);

2287 if–
rc
!=
SQLITE4_ROW
 &&Ñc!=
SQLITE4_DONE
 ) Ñc;

2289 if–
rc
==
SQLITE4_ROW
 ){

2290 
rc
 = 
	`block_dñëe
(
v
, 
iSèπBlockid
, 
iEndBlockid
);

2291 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2295 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_DELETE_STMT
, &
s
);

2296 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2298 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iLevñ
);

2299 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2301  
	`sql_sögÀ_°ï
(
s
);

2302 
	}
}

2307 
	$£gdú_dñëe_Æl
(
fuŒãxt_vèb
 *
v
){

2308 
sqlôe4_°mt
 *
s
;

2309 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_DELETE_ALL_STMT
, &
s
);

2310 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2312 
rc
 = 
	`sql_sögÀ_°ï
(
s
);

2313 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2315 
rc
 = 
	`sql_gë_°©emít
(
v
, 
BLOCK_DELETE_ALL_STMT
, &
s
);

2316 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2318  
	`sql_sögÀ_°ï
(
s
);

2319 
	}
}

2325 
	$£gdú_cou¡
(
fuŒãxt_vèb
 *
v
, *
≤Segmíts
, *
piMaxLevñ
){

2326 
sqlôe4_°mt
 *
s
;

2327 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_COUNT_STMT
, &
s
);

2328 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2330 
rc
 = 
	`sqlôe4_°ï
(
s
);

2334 if–
rc
==
SQLITE4_DONE
 ){

2335 *
≤Segmíts
 = 0;

2336 *
piMaxLevñ
 = 0;

2337  
SQLITE4_OK
;

2339 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

2341 *
≤Segmíts
 = 
	`sqlôe4_cﬁumn_öt
(
s
, 0);

2342 *
piMaxLevñ
 = 
	`sqlôe4_cﬁumn_öt
(
s
, 1);

2346 
rc
 = 
	`sqlôe4_°ï
(
s
);

2347 if–
rc
==
SQLITE4_DONE
 )  
SQLITE4_OK
;

2348 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

2349  
rc
;

2350 
	}
}

2358 
˛órPídögTîms
(
fuŒãxt_vèb
 *
v
);

2363 
	$fuŒãxt_vèb_de°roy
(
fuŒãxt_vèb
 *
v
){

2364 
iStmt
, 
i
;

2366 
	`TRACE
(("FTS2 De°roy %p\n", 
v
));

2367  
iStmt
=0; iStmt<
MAX_STMT
; iStmt++ ){

2368 if–
v
->
pFuŒãxtSèãmíts
[
iStmt
]!=
NULL
 ){

2369 
	`sqlôe4_föÆize
(
v
->
pFuŒãxtSèãmíts
[
iStmt
]);

2370 
v
->
pFuŒãxtSèãmíts
[
iStmt
] = 
NULL
;

2374  
i
=0; i<
MERGE_COUNT
; i++ ){

2375 if–
v
->
pLófSñe˘Stmts
[
i
]!=
NULL
 ){

2376 
	`sqlôe4_föÆize
(
v
->
pLófSñe˘Stmts
[
i
]);

2377 
v
->
pLófSñe˘Stmts
[
i
] = 
NULL
;

2381 if–
v
->
pTokíizî
!=
NULL
 ){

2382 
v
->
pTokíizî
->
pModuÀ
->
	`xDe°roy
(v->pTokenizer);

2383 
v
->
pTokíizî
 = 
NULL
;

2386 
	`˛órPídögTîms
(
v
);

2388 
	`sqlôe4_‰ì
(
v
->
azCﬁumn
);

2389 
i
 = 0; i < 
v
->
nCﬁumn
; ++i) {

2390 
	`sqlôe4_‰ì
(
v
->
azC⁄ã¡Cﬁumn
[
i
]);

2392 
	`sqlôe4_‰ì
(
v
->
azC⁄ã¡Cﬁumn
);

2393 
	`sqlôe4_‰ì
(
v
);

2394 
	}
}

2399 
	#TOKEN_EOF
 0

	)

2400 
	#TOKEN_SPACE
 1

	)

2401 
	#TOKEN_ID
 2

	)

2402 
	#TOKEN_STRING
 3

	)

2403 
	#TOKEN_PUNCT
 4

	)

2418 c⁄° 
	gisIdCh¨
[] = {

2427 
	#IdCh¨
(
C
Ë(((
c
=C)&0x80)!=0 || (c>0x1‡&& 
isIdCh¨
[c-0x20]))

	)

2434 
	$gëTokí
(c⁄° *
z
, *
tokíTy≥
){

2435 
i
, 
c
;

2436  *
z
 ){

2438 *
tokíTy≥
 = 
TOKEN_EOF
;

2442 
i
=1; 
	`ß„_is•a˚
(
z
[i]); i++){}

2443 *
tokíTy≥
 = 
TOKEN_SPACE
;

2444  
i
;

2449 
dñim
 = 
z
[0];

2450 
i
=1; (
c
=
z
[i])!=0; i++){

2451 if–
c
==
dñim
 ){

2452 if–
z
[
i
+1]==
dñim
 ){

2453 
i
++;

2459 *
tokíTy≥
 = 
TOKEN_STRING
;

2460  
i
 + (
c
!=0);

2463 
i
=1, 
c
=
z
[0]; c!=']' && (c=z[i])!=0; i++){}

2464 *
tokíTy≥
 = 
TOKEN_ID
;

2465  
i
;

2468 if–!
	`IdCh¨
(*
z
) ){

2471 
i
=1; 
	`IdCh¨
(
z
[i]); i++){}

2472 *
tokíTy≥
 = 
TOKEN_ID
;

2473  
i
;

2476 *
tokíTy≥
 = 
TOKEN_PUNCT
;

2478 
	}
}

2484 
	sTokí
 {

2485 c⁄° *
	mz
;

2486 
	mn
;

2487 } 
	tTokí
;

2502 **
	$tokíizeSåög
(c⁄° *
z
, *
≤Tokí
){

2503 
nTokí
 = 0;

2504 
Tokí
 *
aTokí
 = 
	`sqlôe4_mÆloc
–
	`°æí
(
z
) * (aToken[0]) );

2505 
n
 = 1;

2506 
e
, 
i
;

2507 
tŸÆSize
 = 0;

2508 **
azTokí
;

2509 *
zC›y
;

2510  
n
>0 ){

2511 
n
 = 
	`gëTokí
(
z
, &
e
);

2512 if–
e
!=
TOKEN_SPACE
 ){

2513 
aTokí
[
nTokí
].
z
 = z;

2514 
aTokí
[
nTokí
].
n
 =Ç;

2515 
nTokí
++;

2516 
tŸÆSize
 +
n
+1;

2518 
z
 +
n
;

2520 
azTokí
 = (**)
	`sqlôe4_mÆloc
–
nTokí
*(*Ë+ 
tŸÆSize
 );

2521 
zC›y
 = (*)&
azTokí
[
nTokí
];

2522 
nTokí
--;

2523 
i
=0; i<
nTokí
; i++){

2524 
azTokí
[
i
] = 
zC›y
;

2525 
n
 = 
aTokí
[
i
].n;

2526 
	`mem˝y
(
zC›y
, 
aTokí
[
i
].
z
, 
n
);

2527 
zC›y
[
n
] = 0;

2528 
zC›y
 +
n
+1;

2530 
azTokí
[
nTokí
] = 0;

2531 
	`sqlôe4_‰ì
(
aTokí
);

2532 *
≤Tokí
 = 
nTokí
;

2533  
azTokí
;

2534 
	}
}

2549 
	$dequŸeSåög
(*
z
){

2550 
quŸe
;

2551 
i
, 
j
;

2552 if–
z
==0 ) ;

2553 
quŸe
 = 
z
[0];

2554  
quŸe
 ){

2558 '[': 
quŸe
 = ']'; ;

2561 
i
=1, 
j
=0; 
z
[i]; i++){

2562 if–
z
[
i
]==
quŸe
 ){

2563 if–
z
[
i
+1]==
quŸe
 ){

2564 
z
[
j
++] = 
quŸe
;

2565 
i
++;

2567 
z
[
j
++] = 0;

2571 
z
[
j
++] = z[
i
];

2574 
	}
}

2591 
	$tokíLi°ToIdLi°
(**
azIn
){

2592 
i
, 
j
;

2593 if–
azIn
 ){

2594 
i
=0, 
j
=-1; 
azIn
[i]; i++){

2595 if–
	`ß„_iß um
(
azIn
[
i
][0]) ||ázIn[i][1] ){

2596 
	`dequŸeSåög
(
azIn
[
i
]);

2597 if–
j
>=0 ){

2598 
azIn
[
j
] =ázIn[
i
];

2600 
j
++;

2603 
azIn
[
j
] = 0;

2605 
	}
}

2613 *
	$fú°Tokí
(*
zIn
, **
pzTaû
){

2614 
n
, 
ây≥
;

2616 
n
 = 
	`gëTokí
(
zIn
, &
ây≥
);

2617 if–
ây≥
==
TOKEN_SPACE
 ){

2618 
zIn
 +
n
;

2619 }if–
ây≥
==
TOKEN_EOF
 ){

2620 *
pzTaû
 = 
zIn
;

2623 
zIn
[
n
] = 0;

2624 *
pzTaû
 = &
zIn
[1];

2625 
	`dequŸeSåög
(
zIn
);

2626  
zIn
;

2630 
	}
}

2643 
	$°¨tsWôh
(c⁄° *
s
, c⁄° *
t
){

2644  
	`ß„_is•a˚
(*
s
) ){ s++; }

2645  *
t
 ){

2646 if–
	`ß„_tﬁowî
(*
s
++)!=ß„_tﬁowî(*
t
++) )  0;

2648  *
s
!='_' && !
	`ß„_iß um
(*s);

2649 
	}
}

2656 
	sTabÀS≥c
 {

2657 c⁄° *
	mzDb
;

2658 c⁄° *
	mzName
;

2659 
	mnCﬁumn
;

2660 **
	mazCﬁumn
;

2661 **
	mazC⁄ã¡Cﬁumn
;

2662 **
	mazTokíizî
;

2663 } 
	tTabÀS≥c
;

2668 
	$˛órTabÀS≥c
(
TabÀS≥c
 *
p
) {

2669 
	`sqlôe4_‰ì
(
p
->
azCﬁumn
);

2670 
	`sqlôe4_‰ì
(
p
->
azC⁄ã¡Cﬁumn
);

2671 
	`sqlôe4_‰ì
(
p
->
azTokíizî
);

2672 
	}
}

2682 
	$∑r£S≥c
(
TabÀS≥c
 *
pS≥c
, 
¨gc
, c⁄° *c⁄°*
¨gv
,

2683 **
pzEº
){

2684 
i
, 
n
;

2685 *
z
, *
zDummy
;

2686 **
azArg
;

2687 c⁄° *
zTokíizî
 = 0;

2689 
	`as£π
–
¨gc
>=3 );

2702 
	`CLEAR
(
pS≥c
);

2703 
i
=
n
=0; i<
¨gc
; i++){

2704 
n
 +
	`°æí
(
¨gv
[
i
]) + 1;

2706 
azArg
 = 
	`sqlôe4_mÆloc
–(*)*
¨gc
 + 
n
 );

2707 if–
azArg
==0 ){

2708  
SQLITE4_NOMEM
;

2710 
z
 = (*)&
azArg
[
¨gc
];

2711 
i
=0; i<
¨gc
; i++){

2712 
azArg
[
i
] = 
z
;

2713 
	`°r˝y
(
z
, 
¨gv
[
i
]);

2714 
z
 +
	`°æí
(z)+1;

2720 
pS≥c
->
zDb
 = 
azArg
[1];

2721 
pS≥c
->
zName
 = 
azArg
[2];

2722 
pS≥c
->
nCﬁumn
 = 0;

2723 
pS≥c
->
azCﬁumn
 = 
azArg
;

2724 
zTokíizî
 = "tokenize simple";

2725 
i
=3; i<
¨gc
; ++i){

2726 if–
	`°¨tsWôh
(
azArg
[
i
],"tokenize") ){

2727 
zTokíizî
 = 
azArg
[
i
];

2729 
z
 = 
azArg
[
pS≥c
->
nCﬁumn
] = 
	`fú°Tokí
◊zArg[
i
], &
zDummy
);

2730 
pS≥c
->
nCﬁumn
++;

2733 if–
pS≥c
->
nCﬁumn
==0 ){

2734 
azArg
[0] = "content";

2735 
pS≥c
->
nCﬁumn
 = 1;

2751 
pS≥c
->
azC⁄ã¡Cﬁumn
 = 
	`sqlôe4_mÆloc
–pS≥c->
nCﬁumn
 * (*) );

2752 if–
pS≥c
->
azC⁄ã¡Cﬁumn
==0 ){

2753 
	`˛órTabÀS≥c
(
pS≥c
);

2754  
SQLITE4_NOMEM
;

2756 
i
=0; i<
pS≥c
->
nCﬁumn
; i++){

2757 *
p
;

2758 
pS≥c
->
azC⁄ã¡Cﬁumn
[
i
] = 
	`sqlôe4_m¥ötf
("c%d%s", i, 
azArg
[i]);

2759 
p
 = 
pS≥c
->
azC⁄ã¡Cﬁumn
[
i
]; *p ; ++p) {

2760 if–!
	`ß„_iß um
(*
p
) ) *p = '_';

2767 
pS≥c
->
azTokíizî
 = 
	`tokíizeSåög
(
zTokíizî
, &
n
);

2768 
	`tokíLi°ToIdLi°
(
pS≥c
->
azTokíizî
);

2770  
SQLITE4_OK
;

2771 
	}
}

2780 *
	$fuŒãxtSchema
(

2781 
nCﬁumn
,

2782 c⁄° *c⁄°* 
azCﬁumn
,

2783 c⁄° *
zTabÀName


2785 
i
;

2786 *
zSchema
, *
zNext
;

2787 c⁄° *
zSï
 = "(";

2788 
zSchema
 = 
	`sqlôe4_m¥ötf
("CREATE TABLE x");

2789 
i
=0; i<
nCﬁumn
; i++){

2790 
zNext
 = 
	`sqlôe4_m¥ötf
("%s%s%Q", 
zSchema
, 
zSï
, 
azCﬁumn
[
i
]);

2791 
	`sqlôe4_‰ì
(
zSchema
);

2792 
zSchema
 = 
zNext
;

2793 
zSï
 = ",";

2795 
zNext
 = 
	`sqlôe4_m¥ötf
("%s,%Q)", 
zSchema
, 
zTabÀName
);

2796 
	`sqlôe4_‰ì
(
zSchema
);

2797  
zNext
;

2798 
	}
}

2804 
	$c⁄°ru˘Vèb
(

2805 
sqlôe4
 *
db
,

2806 
·s2Hash
 *
pHash
,

2807 
TabÀS≥c
 *
•ec
,

2808 
sqlôe4_vèb
 **
µVTab
,

2809 **
pzEº


2811 
rc
;

2812 
n
;

2813 
fuŒãxt_vèb
 *
v
 = 0;

2814 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
m
 = 
NULL
;

2815 *
schema
;

2817 c⁄° *
zTok
;

2818 
nTok
;

2820 
v
 = (
fuŒãxt_vèb
 *Ë
	`sqlôe4_mÆloc
((fulltext_vtab));

2821 if–
v
==0 )  
SQLITE4_NOMEM
;

2822 
	`CLEAR
(
v
);

2824 
v
->
db
 = db;

2825 
v
->
zDb
 = 
•ec
->zDb;

2826 
v
->
zName
 = 
•ec
->zName;

2827 
v
->
nCﬁumn
 = 
•ec
->nColumn;

2828 
v
->
azC⁄ã¡Cﬁumn
 = 
•ec
->azContentColumn;

2829 
•ec
->
azC⁄ã¡Cﬁumn
 = 0;

2830 
v
->
azCﬁumn
 = 
•ec
->azColumn;

2831 
•ec
->
azCﬁumn
 = 0;

2833 if–
•ec
->
azTokíizî
==0 ){

2834  
SQLITE4_NOMEM
;

2837 
zTok
 = 
•ec
->
azTokíizî
[0];

2838 if–!
zTok
 ){

2839 
zTok
 = "simple";

2841 
nTok
 = 
	`°æí
(
zTok
)+1;

2843 
m
 = (
sqlôe4_tokíizî_moduÀ
 *)
	`sqlôe4Fts2HashFöd
(
pHash
, 
zTok
, 
nTok
);

2844 if–!
m
 ){

2845 *
pzEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
•ec
->
azTokíizî
[0]);

2846 
rc
 = 
SQLITE4_ERROR
;

2847 
îr
;

2850 
n
=0; 
•ec
->
azTokíizî
[n];Ç++){}

2851 if–
n
 ){

2852 
rc
 = 
m
->
	`xCª©e
(
n
-1, (c⁄° *c⁄°*)&
•ec
->
azTokíizî
[1],

2853 &
v
->
pTokíizî
);

2855 
rc
 = 
m
->
	`xCª©e
(0, 0, &
v
->
pTokíizî
);

2857 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

2858 
v
->
pTokíizî
->
pModuÀ
 = 
m
;

2862 
schema
 = 
	`fuŒãxtSchema
(
v
->
nCﬁumn
, (c⁄° *c⁄°*)v->
azCﬁumn
,

2863 
•ec
->
zName
);

2864 
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
db
, 
schema
);

2865 
	`sqlôe4_‰ì
(
schema
);

2866 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

2868 
	`mem£t
(
v
->
pFuŒãxtSèãmíts
, 0, (v->pFulltextStatements));

2871 
v
->
nPídögD©a
 = -1;

2873 *
µVTab
 = &
v
->
ba£
;

2874 
	`TRACE
(("FTS2 C⁄√˘ %p\n", 
v
));

2876  
rc
;

2878 
îr
:

2879 
	`fuŒãxt_vèb_de°roy
(
v
);

2880  
rc
;

2881 
	}
}

2883 
	$fuŒãxtC⁄√˘
(

2884 
sqlôe4
 *
db
,

2885 *
pAux
,

2886 
¨gc
, c⁄° *c⁄°*
¨gv
,

2887 
sqlôe4_vèb
 **
µVTab
,

2888 **
pzEº


2890 
TabÀS≥c
 
•ec
;

2891 
rc
 = 
	`∑r£S≥c
(&
•ec
, 
¨gc
, 
¨gv
, 
pzEº
);

2892 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2894 
rc
 = 
	`c⁄°ru˘Vèb
(
db
, (
·s2Hash
 *)
pAux
, &
•ec
, 
µVTab
, 
pzEº
);

2895 
	`˛órTabÀS≥c
(&
•ec
);

2896  
rc
;

2897 
	}
}

2905 
	$fuŒãxtCª©e
(
sqlôe4
 *
db
, *
pAux
,

2906 
¨gc
, c⁄° * c⁄° *
¨gv
,

2907 
sqlôe4_vèb
 **
µVTab
, **
pzEº
){

2908 
rc
;

2909 
TabÀS≥c
 
•ec
;

2910 
SåögBuf„r
 
schema
;

2911 
	`TRACE
(("FTS2 Create\n"));

2913 
rc
 = 
	`∑r£S≥c
(&
•ec
, 
¨gc
, 
¨gv
, 
pzEº
);

2914 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2916 
	`öôSåögBuf„r
(&
schema
);

2917 
	`≠≥nd
(&
schema
, "CREATE TABLE %_content(");

2918 
	`≠≥ndLi°
(&
schema
, 
•ec
.
nCﬁumn
, s≥c.
azC⁄ã¡Cﬁumn
);

2919 
	`≠≥nd
(&
schema
, ")");

2920 
rc
 = 
	`sql_exec
(
db
, 
•ec
.
zDb
, s≥c.
zName
, 
	`°rögBuf„rD©a
(&
schema
));

2921 
	`°rögBuf„rDe°roy
(&
schema
);

2922 if–
rc
!=
SQLITE4_OK
 ) 
out
;

2924 
rc
 = 
	`sql_exec
(
db
, 
•ec
.
zDb
, s≥c.
zName
,

2926 if–
rc
!=
SQLITE4_OK
 ) 
out
;

2928 
rc
 = 
	`sql_exec
(
db
, 
•ec
.
zDb
, s≥c.
zName
,

2938 if–
rc
!=
SQLITE4_OK
 ) 
out
;

2940 
rc
 = 
	`c⁄°ru˘Vèb
(
db
, (
·s2Hash
 *)
pAux
, &
•ec
, 
µVTab
, 
pzEº
);

2942 
out
:

2943 
	`˛órTabÀS≥c
(&
•ec
);

2944  
rc
;

2945 
	}
}

2948 
	$fuŒãxtBe°Index
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_ödex_öfo
 *
pInfo
){

2949 
i
;

2950 
	`TRACE
(("FTS2 BestIndex\n"));

2952 
i
=0; i<
pInfo
->
nC⁄°øöt
; ++i){

2953 c⁄° 
sqlôe4_ödex_c⁄°øöt
 *
pC⁄°øöt
;

2954 
pC⁄°øöt
 = &
pInfo
->
aC⁄°øöt
[
i
];

2955 if–
pC⁄°øöt
->
ußbÀ
 ) {

2956 if–
pC⁄°øöt
->
iCﬁumn
==-1 &&

2957 
pC⁄°øöt
->
›
==
SQLITE4_INDEX_CONSTRAINT_EQ
 ){

2958 
pInfo
->
idxNum
 = 
QUERY_ROWID
;

2959 
	`TRACE
(("FTS2 QUERY_ROWID\n"));

2960 } if–
pC⁄°øöt
->
iCﬁumn
>=0 &&

2961 
pC⁄°øöt
->
›
==
SQLITE4_INDEX_CONSTRAINT_MATCH
 ){

2963 
pInfo
->
idxNum
 = 
QUERY_FULLTEXT
 + 
pC⁄°øöt
->
iCﬁumn
;

2964 
	`TRACE
(("FTS2 QUERY_FULLTEXT %d\n", 
pC⁄°øöt
->
iCﬁumn
));

2967 
pInfo
->
aC⁄°øötUßge
[
i
].
¨gvIndex
 = 1;

2968 
pInfo
->
aC⁄°øötUßge
[
i
].
omô
 = 1;

2973 
pInfo
->
e°im©edCo°
 = 1.0;

2975  
SQLITE4_OK
;

2978 
pInfo
->
idxNum
 = 
QUERY_GENERIC
;

2979  
SQLITE4_OK
;

2980 
	}
}

2982 
	$fuŒãxtDisc⁄√˘
(
sqlôe4_vèb
 *
pVTab
){

2983 
	`TRACE
(("FTS2 Disc⁄√˘ %p\n", 
pVTab
));

2984 
	`fuŒãxt_vèb_de°roy
((
fuŒãxt_vèb
 *)
pVTab
);

2985  
SQLITE4_OK
;

2986 
	}
}

2988 
	$fuŒãxtDe°roy
(
sqlôe4_vèb
 *
pVTab
){

2989 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *)
pVTab
;

2990 
rc
;

2992 
	`TRACE
(("FTS2 De°roy %p\n", 
pVTab
));

2993 
rc
 = 
	`sql_exec
(
v
->
db
, v->
zDb
, v->
zName
,

2998 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3000 
	`fuŒãxt_vèb_de°roy
((
fuŒãxt_vèb
 *)
pVTab
);

3001  
SQLITE4_OK
;

3002 
	}
}

3004 
	$fuŒãxtO≥n
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µCurs‹
){

3005 
fuŒãxt_curs‹
 *
c
;

3007 
c
 = (
fuŒãxt_curs‹
 *Ë
	`sqlôe4_mÆloc
((fulltext_cursor));

3008 if–
c
 ){

3009 
	`mem£t
(
c
, 0, (
fuŒãxt_curs‹
));

3011 *
µCurs‹
 = &
c
->
ba£
;

3012 
	`TRACE
(("FTS2 O≥¿%p: %p\n", 
pVTab
, 
c
));

3013  
SQLITE4_OK
;

3015  
SQLITE4_NOMEM
;

3017 
	}
}

3022 
	$quîyCÀ¨
(
Quîy
 *
q
){

3023 
i
;

3024 
i
 = 0; i < 
q
->
nTîms
; ++i){

3025 
	`sqlôe4_‰ì
(
q
->
pTîms
[
i
].
pTîm
);

3027 
	`sqlôe4_‰ì
(
q
->
pTîms
);

3028 
	`CLEAR
(
q
);

3029 
	}
}

3034 
	$¢ù≥tCÀ¨
(
Snù≥t
 *
p
){

3035 
	`sqlôe4_‰ì
(
p
->
aM©ch
);

3036 
	`sqlôe4_‰ì
(
p
->
zOff£t
);

3037 
	`sqlôe4_‰ì
(
p
->
zSnù≥t
);

3038 
	`CLEAR
(
p
);

3039 
	}
}

3043 
	$¢ù≥tAµídM©ch
(

3044 
Snù≥t
 *
p
,

3045 
iCﬁ
, 
iTîm
,

3046 
iSèπ
, 
nByã


3048 
i
;

3049 
¢ù≥tM©ch
 *
pM©ch
;

3050 if–
p
->
nM©ch
+1>ı->
nAŒoc
 ){

3051 
p
->
nAŒoc
 =Ö->nAlloc*2 + 10;

3052 
p
->
aM©ch
 = 
	`sqlôe4_ªÆloc
’->aM©ch,Ö->
nAŒoc
*(p->aMatch[0]) );

3053 if–
p
->
aM©ch
==0 ){

3054 
p
->
nM©ch
 = 0;

3055 
p
->
nAŒoc
 = 0;

3059 
i
 = 
p
->
nM©ch
++;

3060 
pM©ch
 = &
p
->
aM©ch
[
i
];

3061 
pM©ch
->
iCﬁ
 = iCol;

3062 
pM©ch
->
iTîm
 = iTerm;

3063 
pM©ch
->
iSèπ
 = iStart;

3064 
pM©ch
->
nByã
 =ÇByte;

3065 
	}
}

3070 
	#FTS2_ROTOR_SZ
 (32)

	)

3071 
	#FTS2_ROTOR_MASK
 (
FTS2_ROTOR_SZ
-1)

	)

3077 
	$¢ù≥tOff£tsOfCﬁumn
(

3078 
Quîy
 *
pQuîy
,

3079 
Snù≥t
 *
pSnù≥t
,

3080 
iCﬁumn
,

3081 c⁄° *
zDoc
,

3082 
nDoc


3084 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pTModuÀ
;

3085 
sqlôe4_tokíizî
 *
pTokíizî
;

3086 
sqlôe4_tokíizî_curs‹
 *
pTCurs‹
;

3087 
fuŒãxt_vèb
 *
pVèb
;

3088 
nCﬁumn
;

3089 c⁄° 
QuîyTîm
 *
aTîm
;

3090 
nTîm
;

3091 
i
, 
j
;

3092 
rc
;

3093 
m©ch
, 
¥evM©ch
;

3094 c⁄° *
zTokí
;

3095 
nTokí
;

3096 
iBegö
, 
iEnd
, 
iPos
;

3100 
iRŸ‹
 = 0;

3101 
iRŸ‹Begö
[
FTS2_ROTOR_SZ
];

3102 
iRŸ‹Lí
[
FTS2_ROTOR_SZ
];

3104 
pVèb
 = 
pQuîy
->
pFts
;

3105 
nCﬁumn
 = 
pVèb
->nColumn;

3106 
pTokíizî
 = 
pVèb
->pTokenizer;

3107 
pTModuÀ
 = 
pTokíizî
->
pModuÀ
;

3108 
rc
 = 
pTModuÀ
->
	`xO≥n
(
pTokíizî
, 
zDoc
, 
nDoc
, &
pTCurs‹
);

3109 if–
rc
 ) ;

3110 
pTCurs‹
->
pTokíizî
 =ÖTokenizer;

3111 
aTîm
 = 
pQuîy
->
pTîms
;

3112 
nTîm
 = 
pQuîy
->
nTîms
;

3113 if–
nTîm
>=
FTS2_ROTOR_SZ
 ){

3114 
nTîm
 = 
FTS2_ROTOR_SZ
 - 1;

3116 
¥evM©ch
 = 0;

3118 
rc
 = 
pTModuÀ
->
	`xNext
(
pTCurs‹
, &
zTokí
, &
nTokí
, &
iBegö
, &
iEnd
, &
iPos
);

3119 if–
rc
 ) ;

3120 
iRŸ‹Begö
[
iRŸ‹
&
FTS2_ROTOR_MASK
] = 
iBegö
;

3121 
iRŸ‹Lí
[
iRŸ‹
&
FTS2_ROTOR_MASK
] = 
iEnd
-
iBegö
;

3122 
m©ch
 = 0;

3123 
i
=0; i<
nTîm
; i++){

3124 
iCﬁ
;

3125 
iCﬁ
 = 
aTîm
[
i
].
iCﬁumn
;

3126 if–
iCﬁ
>=0 && iCﬁ<
nCﬁumn
 && iCﬁ!=
iCﬁumn
 ) ;

3127 if–
aTîm
[
i
].
nTîm
>
nTokí
 ) ;

3128 if–!
aTîm
[
i
].
isPªfix
 &&áTîm[i].
nTîm
<
nTokí
 ) ;

3129 
	`as£π
–
aTîm
[
i
].
nTîm
<=
nTokí
 );

3130 if–
	`memcmp
(
aTîm
[
i
].
pTîm
, 
zTokí
,áTîm[i].
nTîm
) ) ;

3131 if–
aTîm
[
i
].
iPhø£
>1 && (
¥evM©ch
 & (1<<i))==0 ) ;

3132 
m©ch
 |1<<
i
;

3133 if–
i
==
nTîm
-1 || 
aTîm
[i+1].
iPhø£
==1 ){

3134 
j
=
aTîm
[
i
].
iPhø£
-1; j>=0; j--){

3135 
k
 = (
iRŸ‹
-
j
Ë& 
FTS2_ROTOR_MASK
;

3136 
	`¢ù≥tAµídM©ch
(
pSnù≥t
, 
iCﬁumn
, 
i
-
j
,

3137 
iRŸ‹Begö
[
k
], 
iRŸ‹Lí
[k]);

3141 
¥evM©ch
 = 
m©ch
<<1;

3142 
iRŸ‹
++;

3144 
pTModuÀ
->
	`xClo£
(
pTCurs‹
);

3145 
	}
}

3152 
	$¢ù≥tAŒOff£ts
(
fuŒãxt_curs‹
 *
p
){

3153 
nCﬁumn
;

3154 
iCﬁumn
, 
i
;

3155 
iFú°
, 
iLa°
;

3156 
fuŒãxt_vèb
 *
pFts
;

3158 if–
p
->
¢ù≥t
.
nM©ch
 ) ;

3159 if–
p
->
q
.
nTîms
==0 ) ;

3160 
pFts
 = 
p
->
q
.pFts;

3161 
nCﬁumn
 = 
pFts
->nColumn;

3162 
iCﬁumn
 = (
p
->
iCurs‹Ty≥
 - 
QUERY_FULLTEXT
);

3163 if–
iCﬁumn
<0 || iCﬁumn>=
nCﬁumn
 ){

3164 
iFú°
 = 0;

3165 
iLa°
 = 
nCﬁumn
-1;

3167 
iFú°
 = 
iCﬁumn
;

3168 
iLa°
 = 
iCﬁumn
;

3170 
i
=
iFú°
; i<=
iLa°
; i++){

3171 c⁄° *
zDoc
;

3172 
nDoc
;

3173 
zDoc
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
p
->
pStmt
, 
i
+1);

3174 
nDoc
 = 
	`sqlôe4_cﬁumn_byãs
(
p
->
pStmt
, 
i
+1);

3175 
	`¢ù≥tOff£tsOfCﬁumn
(&
p
->
q
, &p->
¢ù≥t
, 
i
, 
zDoc
, 
nDoc
);

3177 
	}
}

3183 
	$¢ù≥tOff£tText
(
Snù≥t
 *
p
){

3184 
i
;

3185 
˙t
 = 0;

3186 
SåögBuf„r
 
sb
;

3187 
zBuf
[200];

3188 if–
p
->
zOff£t
 ) ;

3189 
	`öôSåögBuf„r
(&
sb
);

3190 
i
=0; i<
p
->
nM©ch
; i++){

3191 
¢ù≥tM©ch
 *
pM©ch
 = &
p
->
aM©ch
[
i
];

3192 
zBuf
[0] = ' ';

3193 
	`sqlôe4_¢¥ötf
((
zBuf
)-1, &zBuf[
˙t
>0], "%d %d %d %d",

3194 
pM©ch
->
iCﬁ
,ÖM©ch->
iTîm
,ÖM©ch->
iSèπ
,ÖM©ch->
nByã
);

3195 
	`≠≥nd
(&
sb
, 
zBuf
);

3196 
˙t
++;

3198 
p
->
zOff£t
 = 
	`°rögBuf„rD©a
(&
sb
);

3199 
p
->
nOff£t
 = 
	`°rögBuf„rLígth
(&
sb
);

3200 
	}
}

3211 
	$w‹dBound¨y
(

3212 
iBªak
,

3213 c⁄° *
zDoc
,

3214 
nDoc
,

3215 
¢ù≥tM©ch
 *
aM©ch
,

3216 
nM©ch
,

3217 
iCﬁ


3219 
i
;

3220 if–
iBªak
<=10 ){

3223 if–
iBªak
>=
nDoc
-10 ){

3224  
nDoc
;

3226 
i
=0; i<
nM©ch
 && 
aM©ch
[i].
iCﬁ
<iCol; i++){}

3227  
i
<
nM©ch
 && 
aM©ch
[i].
iSèπ
+aM©ch[i].
nByã
<
iBªak
 ){ i++; }

3228 if–
i
<
nM©ch
 ){

3229 if–
aM©ch
[
i
].
iSèπ
<
iBªak
+10 ){

3230  
aM©ch
[
i
].
iSèπ
;

3232 if–
i
>0 && 
aM©ch
[i-1].
iSèπ
+aM©ch[i-1].
nByã
>=
iBªak
 ){

3233  
aM©ch
[
i
-1].
iSèπ
;

3236 
i
=1; i<=10; i++){

3237 if–
	`ß„_is•a˚
(
zDoc
[
iBªak
-
i
]) ){

3238  
iBªak
 - 
i
 + 1;

3240 if–
	`ß„_is•a˚
(
zDoc
[
iBªak
+
i
]) ){

3241  
iBªak
 + 
i
 + 1;

3244  
iBªak
;

3245 
	}
}

3252 
	#SNIPPET_IGNORE
 0

	)

3253 
	#SNIPPET_DESIRED
 1

	)

3258 
	$¢ù≥tText
(

3259 
fuŒãxt_curs‹
 *
pCurs‹
,

3260 c⁄° *
zSèπM¨k
,

3261 c⁄° *
zEndM¨k
,

3262 c⁄° *
zEŒùsis


3264 
i
, 
j
;

3265 
¢ù≥tM©ch
 *
aM©ch
;

3266 
nM©ch
;

3267 
nDesúed
;

3268 
SåögBuf„r
 
sb
;

3269 
èûCﬁ
;

3270 
èûOff£t
;

3271 
iCﬁ
;

3272 
nDoc
;

3273 c⁄° *
zDoc
;

3274 
iSèπ
, 
iEnd
;

3275 
èûEŒùsis
 = 0;

3276 
iM©ch
;

3279 
	`sqlôe4_‰ì
(
pCurs‹
->
¢ù≥t
.
zSnù≥t
);

3280 
pCurs‹
->
¢ù≥t
.
zSnù≥t
 = 0;

3281 
aM©ch
 = 
pCurs‹
->
¢ù≥t
.aMatch;

3282 
nM©ch
 = 
pCurs‹
->
¢ù≥t
.nMatch;

3283 
	`öôSåögBuf„r
(&
sb
);

3285 
i
=0; i<
nM©ch
; i++){

3286 
aM©ch
[
i
].
¢Sètus
 = 
SNIPPET_IGNORE
;

3288 
nDesúed
 = 0;

3289 
i
=0; i<
pCurs‹
->
q
.
nTîms
; i++){

3290 
j
=0; j<
nM©ch
; j++){

3291 if–
aM©ch
[
j
].
iTîm
==
i
 ){

3292 
aM©ch
[
j
].
¢Sètus
 = 
SNIPPET_DESIRED
;

3293 
nDesúed
++;

3299 
iM©ch
 = 0;

3300 
èûCﬁ
 = -1;

3301 
èûOff£t
 = 0;

3302 
i
=0; i<
nM©ch
 && 
nDesúed
>0; i++){

3303 if–
aM©ch
[
i
].
¢Sètus
!=
SNIPPET_DESIRED
 ) ;

3304 
nDesúed
--;

3305 
iCﬁ
 = 
aM©ch
[
i
].iCol;

3306 
zDoc
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pCurs‹
->
pStmt
, 
iCﬁ
+1);

3307 
nDoc
 = 
	`sqlôe4_cﬁumn_byãs
(
pCurs‹
->
pStmt
, 
iCﬁ
+1);

3308 
iSèπ
 = 
aM©ch
[
i
].iStart - 40;

3309 
iSèπ
 = 
	`w‹dBound¨y
(iSèπ, 
zDoc
, 
nDoc
, 
aM©ch
, 
nM©ch
, 
iCﬁ
);

3310 if–
iSèπ
<=10 ){

3311 
iSèπ
 = 0;

3313 if–
iCﬁ
==
èûCﬁ
 && 
iSèπ
<=
èûOff£t
+20 ){

3314 
iSèπ
 = 
èûOff£t
;

3316 if–(
iCﬁ
!=
èûCﬁ
 &&ÅaûCﬁ>=0Ë|| 
iSèπ
!=
èûOff£t
 ){

3317 
	`åimWhôeS∑˚
(&
sb
);

3318 
	`≠≥ndWhôeS∑˚
(&
sb
);

3319 
	`≠≥nd
(&
sb
, 
zEŒùsis
);

3320 
	`≠≥ndWhôeS∑˚
(&
sb
);

3322 
iEnd
 = 
aM©ch
[
i
].
iSèπ
 +áM©ch[i].
nByã
 + 40;

3323 
iEnd
 = 
	`w‹dBound¨y
(iEnd, 
zDoc
, 
nDoc
, 
aM©ch
, 
nM©ch
, 
iCﬁ
);

3324 if–
iEnd
>=
nDoc
-10 ){

3325 
iEnd
 = 
nDoc
;

3326 
èûEŒùsis
 = 0;

3328 
èûEŒùsis
 = 1;

3330  
iM©ch
<
nM©ch
 && 
aM©ch
[iM©ch].
iCﬁ
<iCol ){ iMatch++; }

3331  
iSèπ
<
iEnd
 ){

3332  
iM©ch
<
nM©ch
 && 
aM©ch
[iM©ch].
iSèπ
<iStart

3333 && 
aM©ch
[
iM©ch
].
iCﬁ
<=iCol ){

3334 
iM©ch
++;

3336 if–
iM©ch
<
nM©ch
 && 
aM©ch
[iM©ch].
iSèπ
<
iEnd


3337 && 
aM©ch
[
iM©ch
].
iCﬁ
==iCol ){

3338 
	`«µíd
(&
sb
, &
zDoc
[
iSèπ
], 
aM©ch
[
iM©ch
].iStart - iStart);

3339 
iSèπ
 = 
aM©ch
[
iM©ch
].iStart;

3340 
	`≠≥nd
(&
sb
, 
zSèπM¨k
);

3341 
	`«µíd
(&
sb
, &
zDoc
[
iSèπ
], 
aM©ch
[
iM©ch
].
nByã
);

3342 
	`≠≥nd
(&
sb
, 
zEndM¨k
);

3343 
iSèπ
 +
aM©ch
[
iM©ch
].
nByã
;

3344 
j
=
iM©ch
+1; j<
nM©ch
; j++){

3345 if–
aM©ch
[
j
].
iTîm
=˜M©ch[
iM©ch
].iTerm

3346 && 
aM©ch
[
j
].
¢Sètus
==
SNIPPET_DESIRED
 ){

3347 
nDesúed
--;

3348 
aM©ch
[
j
].
¢Sètus
 = 
SNIPPET_IGNORE
;

3352 
	`«µíd
(&
sb
, &
zDoc
[
iSèπ
], 
iEnd
 - iStart);

3353 
iSèπ
 = 
iEnd
;

3356 
èûCﬁ
 = 
iCﬁ
;

3357 
èûOff£t
 = 
iEnd
;

3359 
	`åimWhôeS∑˚
(&
sb
);

3360 if–
èûEŒùsis
 ){

3361 
	`≠≥ndWhôeS∑˚
(&
sb
);

3362 
	`≠≥nd
(&
sb
, 
zEŒùsis
);

3364 
pCurs‹
->
¢ù≥t
.
zSnù≥t
 = 
	`°rögBuf„rD©a
(&
sb
);

3365 
pCurs‹
->
¢ù≥t
.
nSnù≥t
 = 
	`°rögBuf„rLígth
(&
sb
);

3366 
	}
}

3373 
	$fuŒãxtClo£
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

3374 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

3375 
	`TRACE
(("FTS2 Clo£ %p\n", 
c
));

3376 
	`sqlôe4_föÆize
(
c
->
pStmt
);

3377 
	`quîyCÀ¨
(&
c
->
q
);

3378 
	`¢ù≥tCÀ¨
(&
c
->
¢ù≥t
);

3379 if–
c
->
ªsu…
.
nD©a
!=0 ) 
	`dÃDe°roy
(&c->
ªadî
);

3380 
	`d©aBuf„rDe°roy
(&
c
->
ªsu…
);

3381 
	`sqlôe4_‰ì
(
c
);

3382  
SQLITE4_OK
;

3383 
	}
}

3385 
	$fuŒãxtNext
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

3386 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

3387 
rc
;

3389 
	`TRACE
(("FTS2 Nexà%p\n", 
pCurs‹
));

3390 
	`¢ù≥tCÀ¨
(&
c
->
¢ù≥t
);

3391 if–
c
->
iCurs‹Ty≥
 < 
QUERY_FULLTEXT
 ){

3393 
rc
 = 
	`sqlôe4_°ï
(
c
->
pStmt
);

3394  
rc
 ){

3395 
SQLITE4_ROW
:

3396 
c
->
eof
 = 0;

3397  
SQLITE4_OK
;

3398 
SQLITE4_DONE
:

3399 
c
->
eof
 = 1;

3400  
SQLITE4_OK
;

3402 
c
->
eof
 = 1;

3403  
rc
;

3406 
rc
 = 
	`sqlôe4_ª£t
(
c
->
pStmt
);

3407 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3409 if–
c
->
ªsu…
.
nD©a
==0 || 
	`dÃAtEnd
(&c->
ªadî
) ){

3410 
c
->
eof
 = 1;

3411  
SQLITE4_OK
;

3413 
rc
 = 
	`sqlôe4_böd_öt64
(
c
->
pStmt
, 1, 
	`dÃDocid
(&c->
ªadî
));

3414 
	`dÃSãp
(&
c
->
ªadî
);

3415 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3417 
rc
 = 
	`sqlôe4_°ï
(
c
->
pStmt
);

3418 if–
rc
==
SQLITE4_ROW
 ){

3419 
c
->
eof
 = 0;

3420  
SQLITE4_OK
;

3423  
rc
==
SQLITE4_DONE
 ? 
SQLITE4_ERROR
 :Ñc;

3425 
	}
}

3432 
ãrmSñe˘
(
fuŒãxt_vèb
 *
v
, 
iCﬁumn
,

3433 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

3434 
DocLi°Ty≥
 
iTy≥
, 
D©aBuf„r
 *
out
);

3443 
	$docLi°OfTîm
(

3444 
fuŒãxt_vèb
 *
v
,

3445 
iCﬁumn
,

3446 
QuîyTîm
 *
pQTîm
,

3447 
D©aBuf„r
 *
pResu…


3449 
D©aBuf„r
 
À·
, 
right
, 
√w
;

3450 
i
, 
rc
;

3453 
	`as£π
–
pQTîm
->
nPhø£
==0 || 
DL_DEFAULT
!=
DL_DOCIDS
 );

3456 
	`as£π
–
v
->
nPídögD©a
<0 );

3458 
	`d©aBuf„rInô
(&
À·
, 0);

3459 
rc
 = 
	`ãrmSñe˘
(
v
, 
iCﬁumn
, 
pQTîm
->
pTîm
,ÖQTîm->
nTîm
,ÖQTîm->
isPªfix
,

3460 0<
pQTîm
->
nPhø£
 ? 
DL_POSITIONS
 : 
DL_DOCIDS
, &
À·
);

3461 if–
rc
 ) Ñc;

3462 
i
=1; i<=
pQTîm
->
nPhø£
 && 
À·
.
nD©a
>0; i++){

3463 
	`d©aBuf„rInô
(&
right
, 0);

3464 
rc
 = 
	`ãrmSñe˘
(
v
, 
iCﬁumn
, 
pQTîm
[
i
].
pTîm
,ÖQTîm[i].
nTîm
,

3465 
pQTîm
[
i
].
isPªfix
, 
DL_POSITIONS
, &
right
);

3466 if–
rc
 ){

3467 
	`d©aBuf„rDe°roy
(&
À·
);

3468  
rc
;

3470 
	`d©aBuf„rInô
(&
√w
, 0);

3471 
	`docLi°Phø£Mîge
(
À·
.
pD©a
,Üe·.
nD©a
, 
right
.pData,Ñight.nData,

3472 
i
<
pQTîm
->
nPhø£
 ? 
DL_POSITIONS
 : 
DL_DOCIDS
, &
√w
);

3473 
	`d©aBuf„rDe°roy
(&
À·
);

3474 
	`d©aBuf„rDe°roy
(&
right
);

3475 
À·
 = 
√w
;

3477 *
pResu…
 = 
À·
;

3478  
SQLITE4_OK
;

3479 
	}
}

3483 
	$quîyAdd
(
Quîy
 *
q
, c⁄° *
pTîm
, 
nTîm
){

3484 
QuîyTîm
 *
t
;

3485 ++
q
->
nTîms
;

3486 
q
->
pTîms
 = 
	`sqlôe4_ªÆloc
(q->pTîms, q->
nTîms
 * (q->pTerms[0]));

3487 if–
q
->
pTîms
==0 ){

3488 
q
->
nTîms
 = 0;

3491 
t
 = &
q
->
pTîms
[q->
nTîms
 - 1];

3492 
	`CLEAR
(
t
);

3493 
t
->
pTîm
 = 
	`sqlôe4_mÆloc
(
nTîm
+1);

3494 
	`mem˝y
(
t
->
pTîm
,ÖTîm, 
nTîm
);

3495 
t
->
pTîm
[
nTîm
] = 0;

3496 
t
->
nTîm
 =ÇTerm;

3497 
t
->
isOr
 = 
q
->
√xtIsOr
;

3498 
t
->
isPªfix
 = 0;

3499 
q
->
√xtIsOr
 = 0;

3500 
t
->
iCﬁumn
 = 
q
->
√xtCﬁumn
;

3501 
q
->
√xtCﬁumn
 = q->
dÊtCﬁumn
;

3502 
	}
}

3509 
	$checkCﬁumnS≥cifõr
(

3510 
fuŒãxt_vèb
 *
pVèb
,

3511 c⁄° *
zTokí
,

3512 
nTokí


3514 
i
;

3515 
i
=0; i<
pVèb
->
nCﬁumn
; i++){

3516 if–
	`memcmp
(
pVèb
->
azCﬁumn
[
i
], 
zTokí
, 
nTokí
)==0

3517 && 
pVèb
->
azCﬁumn
[
i
][
nTokí
]==0 ){

3518  
i
;

3522 
	}
}

3534 
	$tokíizeSegmít
(

3535 
sqlôe4_tokíizî
 *
pTokíizî
,

3536 c⁄° *
pSegmít
, 
nSegmít
,

3537 
öPhø£
,

3538 
Quîy
 *
pQuîy


3540 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pModuÀ
 = 
pTokíizî
->pModule;

3541 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

3542 
fú°Index
 = 
pQuîy
->
nTîms
;

3543 
iCﬁ
;

3544 
nTîm
 = 1;

3546 
rc
 = 
pModuÀ
->
	`xO≥n
(
pTokíizî
, 
pSegmít
, 
nSegmít
, &
pCurs‹
);

3547 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3548 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

3551 c⁄° *
pTokí
;

3552 
nTokí
, 
iBegö
, 
iEnd
, 
iPos
;

3554 
rc
 = 
pModuÀ
->
	`xNext
(
pCurs‹
,

3555 &
pTokí
, &
nTokí
,

3556 &
iBegö
, &
iEnd
, &
iPos
);

3557 if–
rc
!=
SQLITE4_OK
 ) ;

3558 if–!
öPhø£
 &&

3559 
pSegmít
[
iEnd
]==':' &&

3560 (
iCﬁ
 = 
	`checkCﬁumnS≥cifõr
(
pQuîy
->
pFts
, 
pTokí
, 
nTokí
))>=0 ){

3561 
pQuîy
->
√xtCﬁumn
 = 
iCﬁ
;

3564 if–!
öPhø£
 && 
pQuîy
->
nTîms
>0 && 
nTokí
==2

3565 && 
pSegmít
[
iBegö
]=='O' &&ÖSegment[iBegin+1]=='R' ){

3566 
pQuîy
->
√xtIsOr
 = 1;

3569 
	`quîyAdd
(
pQuîy
, 
pTokí
, 
nTokí
);

3570 if–!
öPhø£
 && 
iBegö
>0 && 
pSegmít
[iBegin-1]=='-' ){

3571 
pQuîy
->
pTîms
[pQuîy->
nTîms
-1].
isNŸ
 = 1;

3573 if–
iEnd
<
nSegmít
 && 
pSegmít
[iEnd]=='*' ){

3574 
pQuîy
->
pTîms
[pQuîy->
nTîms
-1].
isPªfix
 = 1;

3576 
pQuîy
->
pTîms
[pQuîy->
nTîms
-1].
iPhø£
 = 
nTîm
;

3577 if–
öPhø£
 ){

3578 
nTîm
++;

3582 if–
öPhø£
 && 
pQuîy
->
nTîms
>
fú°Index
 ){

3583 
pQuîy
->
pTîms
[
fú°Index
].
nPhø£
 =ÖQuîy->
nTîms
 - firstIndex - 1;

3586  
pModuÀ
->
	`xClo£
(
pCurs‹
);

3587 
	}
}

3594 
	$∑r£Quîy
(

3595 
fuŒãxt_vèb
 *
v
,

3596 c⁄° *
zI≈ut
,

3597 
nI≈ut
,

3598 
dÊtCﬁumn
,

3599 
Quîy
 *
pQuîy


3601 
iI≈ut
, 
öPhø£
 = 0;

3603 if–
zI≈ut
==0 ) 
nI≈ut
 = 0;

3604 if–
nI≈ut
<0 )ÇI≈uà
	`°æí
(
zI≈ut
);

3605 
pQuîy
->
nTîms
 = 0;

3606 
pQuîy
->
pTîms
 = 
NULL
;

3607 
pQuîy
->
√xtIsOr
 = 0;

3608 
pQuîy
->
√xtCﬁumn
 = 
dÊtCﬁumn
;

3609 
pQuîy
->
dÊtCﬁumn
 = dfltColumn;

3610 
pQuîy
->
pFts
 = 
v
;

3612 
iI≈ut
=0; iI≈ut<
nI≈ut
; ++iInput){

3613 
i
;

3614 
i
=
iI≈ut
; i<
nI≈ut
 && 
zI≈ut
[i]!='"'; ++i){}

3615 if–
i
>
iI≈ut
 ){

3616 
	`tokíizeSegmít
(
v
->
pTokíizî
, 
zI≈ut
+
iI≈ut
, 
i
-iI≈ut, 
öPhø£
,

3617 
pQuîy
);

3619 
iI≈ut
 = 
i
;

3620 if–
i
<
nI≈ut
 ){

3621 
	`as£π
–
zI≈ut
[
i
]=='"' );

3622 
öPhø£
 = !inPhrase;

3626 if–
öPhø£
 ){

3628 
	`quîyCÀ¨
(
pQuîy
);

3629  
SQLITE4_ERROR
;

3631  
SQLITE4_OK
;

3632 
	}
}

3635 
ÊushPídögTîms
(
fuŒãxt_vèb
 *
v
);

3644 
	$fuŒãxtQuîy
(

3645 
fuŒãxt_vèb
 *
v
,

3646 
iCﬁumn
,

3647 c⁄° *
zI≈ut
,

3648 
nI≈ut
,

3649 
D©aBuf„r
 *
pResu…
,

3650 
Quîy
 *
pQuîy


3652 
i
, 
iNext
, 
rc
;

3653 
D©aBuf„r
 
À·
, 
right
, 
‹
, 
√w
;

3654 
nNŸ
 = 0;

3655 
QuîyTîm
 *
aTîm
;

3666 
rc
 = 
	`ÊushPídögTîms
(
v
);

3667 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3672 
rc
 = 
	`∑r£Quîy
(
v
, 
zI≈ut
, 
nI≈ut
, 
iCﬁumn
, 
pQuîy
);

3673 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3676 if–
pQuîy
->
nTîms
==0 ){

3677 
	`d©aBuf„rInô
(
pResu…
, 0);

3678  
SQLITE4_OK
;

3683 
aTîm
 = 
pQuîy
->
pTîms
;

3684 
i
 = 0; i<
pQuîy
->
nTîms
; i=
iNext
){

3685 if–
aTîm
[
i
].
isNŸ
 ){

3687 
nNŸ
++;

3688 
iNext
 = 
i
 + 
aTîm
[i].
nPhø£
+1;

3691 
iNext
 = 
i
 + 
aTîm
[i].
nPhø£
 + 1;

3692 
rc
 = 
	`docLi°OfTîm
(
v
, 
aTîm
[
i
].
iCﬁumn
, &aTîm[i], &
right
);

3693 if–
rc
 ){

3694 if–
i
!=
nNŸ
 ) 
	`d©aBuf„rDe°roy
(&
À·
);

3695 
	`quîyCÀ¨
(
pQuîy
);

3696  
rc
;

3698  
iNext
<
pQuîy
->
nTîms
 && 
aTîm
[iNext].
isOr
 ){

3699 
rc
 = 
	`docLi°OfTîm
(
v
, 
aTîm
[
iNext
].
iCﬁumn
, &aTîm[iNext], &
‹
);

3700 
iNext
 +
aTîm
[iNext].
nPhø£
 + 1;

3701 if–
rc
 ){

3702 if–
i
!=
nNŸ
 ) 
	`d©aBuf„rDe°roy
(&
À·
);

3703 
	`d©aBuf„rDe°roy
(&
right
);

3704 
	`quîyCÀ¨
(
pQuîy
);

3705  
rc
;

3707 
	`d©aBuf„rInô
(&
√w
, 0);

3708 
	`docLi°OrMîge
(
right
.
pD©a
,Ñight.
nD©a
, 
‹
.pD©a, or.nD©a, &
√w
);

3709 
	`d©aBuf„rDe°roy
(&
right
);

3710 
	`d©aBuf„rDe°roy
(&
‹
);

3711 
right
 = 
√w
;

3713 if–
i
==
nNŸ
 ){

3714 
À·
 = 
right
;

3716 
	`d©aBuf„rInô
(&
√w
, 0);

3717 
	`docLi°AndMîge
(
À·
.
pD©a
,Üe·.
nD©a
, 
right
.pD©a,Ñight.nD©a, &
√w
);

3718 
	`d©aBuf„rDe°roy
(&
right
);

3719 
	`d©aBuf„rDe°roy
(&
À·
);

3720 
À·
 = 
√w
;

3724 if–
nNŸ
==
pQuîy
->
nTîms
 ){

3726  
SQLITE4_ERROR
;

3730 
i
=0; i<
pQuîy
->
nTîms
; i +
aTîm
[i].
nPhø£
 + 1){

3731 if–!
aTîm
[
i
].
isNŸ
 ) ;

3732 
rc
 = 
	`docLi°OfTîm
(
v
, 
aTîm
[
i
].
iCﬁumn
, &aTîm[i], &
right
);

3733 if–
rc
 ){

3734 
	`quîyCÀ¨
(
pQuîy
);

3735 
	`d©aBuf„rDe°roy
(&
À·
);

3736  
rc
;

3738 
	`d©aBuf„rInô
(&
√w
, 0);

3739 
	`docLi°Ex˚±Mîge
(
À·
.
pD©a
,Üe·.
nD©a
, 
right
.pD©a,Ñight.nD©a, &
√w
);

3740 
	`d©aBuf„rDe°roy
(&
right
);

3741 
	`d©aBuf„rDe°roy
(&
À·
);

3742 
À·
 = 
√w
;

3745 *
pResu…
 = 
À·
;

3746  
rc
;

3747 
	}
}

3770 
	$fuŒãxtFûãr
(

3771 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

3772 
idxNum
, c⁄° *
idxSå
,

3773 
¨gc
, 
sqlôe4_vÆue
 **
¨gv


3775 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

3776 
fuŒãxt_vèb
 *
v
 = 
	`curs‹_vèb
(
c
);

3777 
rc
;

3779 
	`TRACE
(("FTS2 Fûã∏%p\n",
pCurs‹
));

3786 if–
c
->
pStmt
 && c->
iCurs‹Ty≥
!=
idxNum
 ){

3787 
	`sqlôe4_föÆize
(
c
->
pStmt
);

3788 
c
->
pStmt
 = 
NULL
;

3798 if–!
c
->
pStmt
 ){

3799 *
zSql
 = 
	`sqlôe4_m¥ötf
("selectÑowid, * from %%_content %s",

3800 
idxNum
==
QUERY_GENERIC
 ? "" : "whereÑowid=?");

3801 
rc
 = 
	`sql_¥ï¨e
(
v
->
db
, v->
zDb
, v->
zName
, &
c
->
pStmt
, 
zSql
);

3802 
	`sqlôe4_‰ì
(
zSql
);

3803 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3804 
c
->
iCurs‹Ty≥
 = 
idxNum
;

3806 
	`sqlôe4_ª£t
(
c
->
pStmt
);

3807 
	`as£π
–
c
->
iCurs‹Ty≥
==
idxNum
 );

3810  
idxNum
 ){

3811 
QUERY_GENERIC
:

3814 
QUERY_ROWID
:

3815 
rc
 = 
	`sqlôe4_böd_öt64
(
c
->
pStmt
, 1, 
	`sqlôe4_vÆue_öt64
(
¨gv
[0]));

3816 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3821 c⁄° *
zQuîy
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

3822 
	`as£π
–
idxNum
<=
QUERY_FULLTEXT
+
v
->
nCﬁumn
);

3823 
	`as£π
–
¨gc
==1 );

3824 
	`quîyCÀ¨
(&
c
->
q
);

3825 if–
c
->
ªsu…
.
nD©a
!=0 ){

3827 
	`dÃDe°roy
(&
c
->
ªadî
);

3828 
	`d©aBuf„rRe£t
(&
c
->
ªsu…
);

3830 
	`d©aBuf„rInô
(&
c
->
ªsu…
, 0);

3832 
rc
 = 
	`fuŒãxtQuîy
(
v
, 
idxNum
-
QUERY_FULLTEXT
, 
zQuîy
, -1, &
c
->
ªsu…
, &c->
q
);

3833 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3834 if–
c
->
ªsu…
.
nD©a
!=0 ){

3835 
	`dÃInô
(&
c
->
ªadî
, 
DL_DOCIDS
, c->
ªsu…
.
pD©a
, c->ªsu….
nD©a
);

3841  
	`fuŒãxtNext
(
pCurs‹
);

3842 
	}
}

3848 
	$fuŒãxtEof
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

3849 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

3850  
c
->
eof
;

3851 
	}
}

3859 
	$fuŒãxtCﬁumn
(
sqlôe4_vèb_curs‹
 *
pCurs‹
,

3860 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
, 
idxCﬁ
){

3861 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

3862 
fuŒãxt_vèb
 *
v
 = 
	`curs‹_vèb
(
c
);

3864 if–
idxCﬁ
<
v
->
nCﬁumn
 ){

3865 
sqlôe4_vÆue
 *
pVÆ
 = 
	`sqlôe4_cﬁumn_vÆue
(
c
->
pStmt
, 
idxCﬁ
+1);

3866 
	`sqlôe4_ªsu…_vÆue
(
pC⁄ãxt
, 
pVÆ
);

3867 }if–
idxCﬁ
==
v
->
nCﬁumn
 ){

3871 
	`sqlôe4_ªsu…_blob
(
pC⁄ãxt
, &
c
, (c), 
SQLITE4_TRANSIENT
);

3873  
SQLITE4_OK
;

3874 
	}
}

3880 
	$fuŒãxtRowid
(
sqlôe4_vèb_curs‹
 *
pCurs‹
, 
sqlôe_öt64
 *
pRowid
){

3881 
fuŒãxt_curs‹
 *
c
 = (fuŒãxt_curs‹ *Ë
pCurs‹
;

3883 *
pRowid
 = 
	`sqlôe4_cﬁumn_öt64
(
c
->
pStmt
, 0);

3884  
SQLITE4_OK
;

3885 
	}
}

3891 
	$buûdTîms
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iDocid
,

3892 c⁄° *
zText
, 
iCﬁumn
){

3893 
sqlôe4_tokíizî
 *
pTokíizî
 = 
v
->pTokenizer;

3894 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

3895 c⁄° *
pTokí
;

3896 
nTokíByãs
;

3897 
iSèπOff£t
, 
iEndOff£t
, 
iPosôi⁄
;

3898 
rc
;

3900 
rc
 = 
pTokíizî
->
pModuÀ
->
	`xO≥n
’Tokíizî, 
zText
, -1, &
pCurs‹
);

3901 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3903 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

3904  
SQLITE4_OK
==(
rc
=
pTokíizî
->
pModuÀ
->
	`xNext
(
pCurs‹
,

3905 &
pTokí
, &
nTokíByãs
,

3906 &
iSèπOff£t
, &
iEndOff£t
,

3907 &
iPosôi⁄
)) ){

3908 
DLCﬁÀ˘‹
 *
p
;

3909 
nD©a
;

3913 if–
iPosôi⁄
<0 || 
pTokí
 =
NULL
 || 
nTokíByãs
 == 0 ){

3914 
rc
 = 
SQLITE4_ERROR
;

3918 
p
 = 
	`·s2HashFöd
(&
v
->
≥ndögTîms
, 
pTokí
, 
nTokíByãs
);

3919 if–
p
==
NULL
 ){

3920 
nD©a
 = 0;

3921 
p
 = 
	`dlcNew
(
iDocid
, 
DL_DEFAULT
);

3922 
	`·s2HashIn£π
(&
v
->
≥ndögTîms
, 
pTokí
, 
nTokíByãs
, 
p
);

3925 
v
->
nPídögD©a
 +(
·s2HashEÀm
)+(*
p
)+
nTokíByãs
;

3927 
nD©a
 = 
p
->
b
.nData;

3928 if–
p
->
dlw
.
iPªvDocid
!=
iDocid
 ) 
	`dlcNext
(p, iDocid);

3930 if–
iCﬁumn
>=0 ){

3931 
	`dlcAddPos
(
p
, 
iCﬁumn
, 
iPosôi⁄
, 
iSèπOff£t
, 
iEndOff£t
);

3935 
v
->
nPídögD©a
 +
p
->
b
.
nD©a
-nData;

3943 
pTokíizî
->
pModuÀ
->
	`xClo£
(
pCurs‹
);

3944 if–
SQLITE4_DONE
 =
rc
 )  
SQLITE4_OK
;

3945  
rc
;

3946 
	}
}

3949 
	$ö£πTîms
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRowid
,

3950 
sqlôe4_vÆue
 **
pVÆues
){

3951 
i
;

3952 
i
 = 0; i < 
v
->
nCﬁumn
 ; ++i){

3953 *
zText
 = (*)
	`sqlôe4_vÆue_ãxt
(
pVÆues
[
i
]);

3954 
rc
 = 
	`buûdTîms
(
v
, 
iRowid
, 
zText
, 
i
);

3955 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3957  
SQLITE4_OK
;

3958 
	}
}

3963 
	$dñëeTîms
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRowid
){

3964 c⁄° **
pVÆues
;

3965 
i
, 
rc
;

3968 if–
DL_DEFAULT
==
DL_DOCIDS
 )  
SQLITE4_ERROR
;

3970 
rc
 = 
	`c⁄ã¡_£À˘
(
v
, 
iRowid
, &
pVÆues
);

3971 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3973 
i
 = 0 ; i < 
v
->
nCﬁumn
; ++i) {

3974 
rc
 = 
	`buûdTîms
(
v
, 
iRowid
, 
pVÆues
[
i
], -1);

3975 if–
rc
!=
SQLITE4_OK
 ) ;

3978 
	`‰ìSåögAºay
(
v
->
nCﬁumn
, 
pVÆues
);

3979  
SQLITE4_OK
;

3980 
	}
}

3983 
öôPídögTîms
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iDocid
);

3988 
	$ödex_ö£π
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_vÆue
 *
pReque°Rowid
,

3989 
sqlôe4_vÆue
 **
pVÆues
, 
sqlôe_öt64
 *
piRowid
){

3990 
rc
;

3992 
rc
 = 
	`c⁄ã¡_ö£π
(
v
, 
pReque°Rowid
, 
pVÆues
);

3993 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3995 *
piRowid
 = 
	`sqlôe4_œ°_ö£π_rowid
(
v
->
db
);

3996 
rc
 = 
	`öôPídögTîms
(
v
, *
piRowid
);

3997 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3999  
	`ö£πTîms
(
v
, *
piRowid
, 
pVÆues
);

4000 
	}
}

4005 
	$ödex_dñëe
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
){

4006 
rc
 = 
	`öôPídögTîms
(
v
, 
iRow
);

4007 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4009 
rc
 = 
	`dñëeTîms
(
v
, 
iRow
);

4010 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4012  
	`c⁄ã¡_dñëe
(
v
, 
iRow
);

4013 
	}
}

4019 
	$ödex_upd©e
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iRow
,

4020 
sqlôe4_vÆue
 **
pVÆues
){

4021 
rc
 = 
	`öôPídögTîms
(
v
, 
iRow
);

4022 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4026 
rc
 = 
	`dñëeTîms
(
v
, 
iRow
);

4027 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4029 
rc
 = 
	`c⁄ã¡_upd©e
(
v
, 
pVÆues
, 
iRow
);

4030 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4033  
	`ö£πTîms
(
v
, 
iRow
, 
pVÆues
);

4034 
	}
}

4043 
	#INTERIOR_MAX
 2048

	)

4050 
	#INTERIOR_MIN_TERMS
 7

	)

4051 #i‡
INTERIOR_MIN_TERMS
<1

4052 #îr‹ 
INTERIOR_MIN_TERMS
 
mu°
 
be
 
gª©î
 
th™
 0.

4063 
	#ROOT_MAX
 1024

	)

4064 #i‡
ROOT_MAX
<
VARINT_MAX
*2

4065 #îr‹ 
ROOT_MAX
 
mu°
 
have
 
íough
 
•a˚
 
a
 
hódî
.

4071 
	sI¡îi‹Block
 {

4072 
D©aBuf„r
 
	mãrm
;

4073 
D©aBuf„r
 
	md©a
;

4074 
I¡îi‹Block
 *
	m√xt
;

4075 } 
	tI¡îi‹Block
;

4077 
I¡îi‹Block
 *
	$öãri‹BlockNew
(
iHeight
, 
sqlôe_öt64
 
iChûdBlock
,

4078 c⁄° *
pTîm
, 
nTîm
){

4079 
I¡îi‹Block
 *
block
 = 
	`sqlôe4_mÆloc
((InteriorBlock));

4080 
c
[
VARINT_MAX
+VARINT_MAX];

4081 
n
;

4083 if–
block
 ){

4084 
	`mem£t
(
block
, 0, (*block));

4085 
	`d©aBuf„rInô
(&
block
->
ãrm
, 0);

4086 
	`d©aBuf„rRïœ˚
(&
block
->
ãrm
, 
pTîm
, 
nTîm
);

4088 
n
 = 
	`putV¨öt
(
c
, 
iHeight
);

4089 
n
 +
	`putV¨öt
(
c
+n, 
iChûdBlock
);

4090 
	`d©aBuf„rInô
(&
block
->
d©a
, 
INTERIOR_MAX
);

4091 
	`d©aBuf„rRïœ˚
(&
block
->
d©a
, 
c
, 
n
);

4093  
block
;

4094 
	}
}

4096 #i‚de‡
NDEBUG


4098 
	$öãri‹BlockVÆid©e
(
I¡îi‹Block
 *
pBlock
){

4099 c⁄° *
pD©a
 = 
pBlock
->
d©a
.pData;

4100 
nD©a
 = 
pBlock
->
d©a
.nData;

4101 
n
, 
iDummy
;

4102 
sqlôe_öt64
 
iBlockid
;

4104 
	`as£π
–
nD©a
>0 );

4105 
	`as£π
–
pD©a
!=0 );

4106 
	`as£π
–
pD©a
+
nD©a
>pData );

4109 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4110 
	`as£π
–
n
>0 );

4111 
	`as£π
–
iDummy
>0 );

4112 
	`as£π
–
n
<
nD©a
 );

4113 
pD©a
 +
n
;

4114 
nD©a
 -
n
;

4117 
n
 = 
	`gëV¨öt
(
pD©a
, &
iBlockid
);

4118 
	`as£π
–
n
>0 );

4119 
	`as£π
–
n
<=
nD©a
 );

4120 
pD©a
 +
n
;

4121 
nD©a
 -
n
;

4124 if–
nD©a
!=0 ){

4126 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4127 
	`as£π
–
n
>0 );

4128 
	`as£π
–
iDummy
>0 );

4129 
	`as£π
–
n
+
iDummy
>0);

4130 
	`as£π
–
n
+
iDummy
<=
nD©a
 );

4131 
pD©a
 +
n
+
iDummy
;

4132 
nD©a
 -
n
+
iDummy
;

4135  
nD©a
!=0 ){

4137 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4138 
	`as£π
–
n
>0 );

4139 
	`as£π
–
iDummy
>=0 );

4140 
	`as£π
–
n
<
nD©a
 );

4141 
pD©a
 +
n
;

4142 
nD©a
 -
n
;

4145 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4146 
	`as£π
–
n
>0 );

4147 
	`as£π
–
iDummy
>0 );

4148 
	`as£π
–
n
+
iDummy
>0);

4149 
	`as£π
–
n
+
iDummy
<=
nD©a
 );

4150 
pD©a
 +
n
+
iDummy
;

4151 
nD©a
 -
n
+
iDummy
;

4154 
	}
}

4155 
	#ASSERT_VALID_INTERIOR_BLOCK
(
x
Ë
	`öãri‹BlockVÆid©e
(x)

	)

4157 
	#ASSERT_VALID_INTERIOR_BLOCK
(
x
Ë
	`as£π
–1 )

	)

4160 
	sI¡îi‹Wrôî
 {

4161 
	miHeight
;

4162 
I¡îi‹Block
 *
	mfú°
, *
	mœ°
;

4163 
I¡îi‹Wrôî
 *
	m∑ª¡Wrôî
;

4165 
D©aBuf„r
 
	mãrm
;

4166 
sqlôe_öt64
 
	miO≥nögChûdBlock
;

4167 #i‚de‡
NDEBUG


4168 
sqlôe_öt64
 
	miLa°ChûdBlock
;

4170 } 
	tI¡îi‹Wrôî
;

4176 
	$öãri‹WrôîInô
(
iHeight
, c⁄° *
pTîm
, 
nTîm
,

4177 
sqlôe_öt64
 
iChûdBlock
,

4178 
I¡îi‹Wrôî
 *
pWrôî
){

4179 
I¡îi‹Block
 *
block
;

4180 
	`as£π
–
iHeight
>0 );

4181 
	`CLEAR
(
pWrôî
);

4183 
pWrôî
->
iHeight
 = iHeight;

4184 
pWrôî
->
iO≥nögChûdBlock
 = 
iChûdBlock
;

4185 #i‚de‡
NDEBUG


4186 
pWrôî
->
iLa°ChûdBlock
 = 
iChûdBlock
;

4188 
block
 = 
	`öãri‹BlockNew
(
iHeight
, 
iChûdBlock
, 
pTîm
, 
nTîm
);

4189 
pWrôî
->
œ°
 =ÖWrôî->
fú°
 = 
block
;

4190 
	`ASSERT_VALID_INTERIOR_BLOCK
(
pWrôî
->
œ°
);

4191 
	`d©aBuf„rInô
(&
pWrôî
->
ãrm
, 0);

4192 
	}
}

4197 
	$öãri‹WrôîAµíd
(
I¡îi‹Wrôî
 *
pWrôî
,

4198 c⁄° *
pTîm
, 
nTîm
,

4199 
sqlôe_öt64
 
iChûdBlock
){

4200 
c
[
VARINT_MAX
+VARINT_MAX];

4201 
n
, 
nPªfix
 = 0;

4203 
	`ASSERT_VALID_INTERIOR_BLOCK
(
pWrôî
->
œ°
);

4211 if–
pWrôî
->
ãrm
.
nD©a
==0 ){

4212 
n
 = 
	`putV¨öt
(
c
, 
nTîm
);

4214  
nPªfix
<
pWrôî
->
ãrm
.
nD©a
 &&

4215 
pTîm
[
nPªfix
]==
pWrôî
->
ãrm
.
pD©a
[nPrefix] ){

4216 
nPªfix
++;

4219 
n
 = 
	`putV¨öt
(
c
, 
nPªfix
);

4220 
n
 +
	`putV¨öt
(
c
+n, 
nTîm
-
nPªfix
);

4223 #i‚de‡
NDEBUG


4224 
pWrôî
->
iLa°ChûdBlock
++;

4226 
	`as£π
–
pWrôî
->
iLa°ChûdBlock
==
iChûdBlock
 );

4231 if–
pWrôî
->
œ°
->
d©a
.
nD©a
+
n
+
nTîm
-
nPªfix
>
INTERIOR_MAX
 &&

4232 
iChûdBlock
-
pWrôî
->
iO≥nögChûdBlock
>
INTERIOR_MIN_TERMS
 ){

4233 
pWrôî
->
œ°
->
√xt
 = 
	`öãri‹BlockNew
’Wrôî->
iHeight
, 
iChûdBlock
,

4234 
pTîm
, 
nTîm
);

4235 
pWrôî
->
œ°
 =ÖWrôî->œ°->
√xt
;

4236 
pWrôî
->
iO≥nögChûdBlock
 = 
iChûdBlock
;

4237 
	`d©aBuf„rRe£t
(&
pWrôî
->
ãrm
);

4239 
	`d©aBuf„rAµíd2
(&
pWrôî
->
œ°
->
d©a
, 
c
, 
n
,

4240 
pTîm
+
nPªfix
, 
nTîm
-nPrefix);

4241 
	`d©aBuf„rRïœ˚
(&
pWrôî
->
ãrm
, 
pTîm
, 
nTîm
);

4243 
	`ASSERT_VALID_INTERIOR_BLOCK
(
pWrôî
->
œ°
);

4244 
	}
}

4249 
	$öãri‹WrôîDe°roy
(
I¡îi‹Wrôî
 *
pWrôî
){

4250 
I¡îi‹Block
 *
block
 = 
pWrôî
->
fú°
;

4252  
block
!=
NULL
 ){

4253 
I¡îi‹Block
 *
b
 = 
block
;

4254 
block
 = block->
√xt
;

4255 
	`d©aBuf„rDe°roy
(&
b
->
ãrm
);

4256 
	`d©aBuf„rDe°roy
(&
b
->
d©a
);

4257 
	`sqlôe4_‰ì
(
b
);

4259 if–
pWrôî
->
∑ª¡Wrôî
!=
NULL
 ){

4260 
	`öãri‹WrôîDe°roy
(
pWrôî
->
∑ª¡Wrôî
);

4261 
	`sqlôe4_‰ì
(
pWrôî
->
∑ª¡Wrôî
);

4263 
	`d©aBuf„rDe°roy
(&
pWrôî
->
ãrm
);

4264 
	`SCRAMBLE
(
pWrôî
);

4265  
SQLITE4_OK
;

4266 
	}
}

4273 
	$öãri‹WrôîRoŸInfo
(
fuŒãxt_vèb
 *
v
, 
I¡îi‹Wrôî
 *
pWrôî
,

4274 **
µRoŸInfo
, *
≤RoŸInfo
,

4275 
sqlôe_öt64
 *
piEndBlockid
){

4276 
I¡îi‹Block
 *
block
 = 
pWrôî
->
fú°
;

4277 
sqlôe_öt64
 
iBlockid
 = 0;

4278 
rc
;

4281 if–
block
==
pWrôî
->
œ°
 && block->
d©a
.
nD©a
<
ROOT_MAX
 ){

4282 *
µRoŸInfo
 = 
block
->
d©a
.
pD©a
;

4283 *
≤RoŸInfo
 = 
block
->
d©a
.
nD©a
;

4284  
SQLITE4_OK
;

4290 
	`ASSERT_VALID_INTERIOR_BLOCK
(
block
);

4291 
rc
 = 
	`block_ö£π
(
v
, 
block
->
d©a
.
pD©a
, block->d©a.
nD©a
, &
iBlockid
);

4292 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4293 *
piEndBlockid
 = 
iBlockid
;

4295 
pWrôî
->
∑ª¡Wrôî
 = 
	`sqlôe4_mÆloc
((*pWriter->parentWriter));

4296 
	`öãri‹WrôîInô
(
pWrôî
->
iHeight
+1,

4297 
block
->
ãrm
.
pD©a
, block->ãrm.
nD©a
,

4298 
iBlockid
, 
pWrôî
->
∑ª¡Wrôî
);

4303 
block
=block->
√xt
; block!=
NULL
; block=block->next){

4304 
	`ASSERT_VALID_INTERIOR_BLOCK
(
block
);

4305 
rc
 = 
	`block_ö£π
(
v
, 
block
->
d©a
.
pD©a
, block->d©a.
nD©a
, &
iBlockid
);

4306 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4307 *
piEndBlockid
 = 
iBlockid
;

4309 
	`öãri‹WrôîAµíd
(
pWrôî
->
∑ª¡Wrôî
,

4310 
block
->
ãrm
.
pD©a
, block->ãrm.
nD©a
, 
iBlockid
);

4314  
	`öãri‹WrôîRoŸInfo
(
v
, 
pWrôî
->
∑ª¡Wrôî
,

4315 
µRoŸInfo
, 
≤RoŸInfo
, 
piEndBlockid
);

4316 
	}
}

4322 
	sI¡îi‹Ródî
 {

4323 c⁄° *
	mpD©a
;

4324 
	mnD©a
;

4326 
D©aBuf„r
 
	mãrm
;

4328 
sqlôe_öt64
 
	miBlockid
;

4329 } 
	tI¡îi‹Ródî
;

4331 
	$öãri‹RódîDe°roy
(
I¡îi‹Ródî
 *
pRódî
){

4332 
	`d©aBuf„rDe°roy
(&
pRódî
->
ãrm
);

4333 
	`SCRAMBLE
(
pRódî
);

4334 
	}
}

4339 
	$öãri‹RódîInô
(c⁄° *
pD©a
, 
nD©a
,

4340 
I¡îi‹Ródî
 *
pRódî
){

4341 
n
, 
nTîm
;

4344 
	`as£π
–
nD©a
>0 );

4345 
	`as£π
–
pD©a
[0]!='\0' );

4347 
	`CLEAR
(
pRódî
);

4350 
n
 = 
	`gëV¨öt
(
pD©a
+1, &
pRódî
->
iBlockid
);

4351 
	`as£π
–1+
n
<=
nD©a
 );

4352 
pRódî
->
pD©a
 =ÖD©a+1+
n
;

4353 
pRódî
->
nD©a
 =ÇD©a-(1+
n
);

4359 if–
pRódî
->
nD©a
==0 ){

4360 
	`d©aBuf„rInô
(&
pRódî
->
ãrm
, 0);

4362 
n
 = 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
nTîm
);

4363 
	`d©aBuf„rInô
(&
pRódî
->
ãrm
, 
nTîm
);

4364 
	`d©aBuf„rRïœ˚
(&
pRódî
->
ãrm
,ÖRódî->
pD©a
+
n
, 
nTîm
);

4365 
	`as£π
–
n
+
nTîm
<=
pRódî
->
nD©a
 );

4366 
pRódî
->
pD©a
 +
n
+
nTîm
;

4367 
pRódî
->
nD©a
 -
n
+
nTîm
;

4369 
	}
}

4371 
	$öãri‹RódîAtEnd
(
I¡îi‹Ródî
 *
pRódî
){

4372  
pRódî
->
ãrm
.
nD©a
==0;

4373 
	}
}

4375 
sqlôe_öt64
 
	$öãri‹RódîCuºítBlockid
(
I¡îi‹Ródî
 *
pRódî
){

4376  
pRódî
->
iBlockid
;

4377 
	}
}

4379 
	$öãri‹RódîTîmByãs
(
I¡îi‹Ródî
 *
pRódî
){

4380 
	`as£π
–!
	`öãri‹RódîAtEnd
(
pRódî
) );

4381  
pRódî
->
ãrm
.
nD©a
;

4382 
	}
}

4383 c⁄° *
	$öãri‹RódîTîm
(
I¡îi‹Ródî
 *
pRódî
){

4384 
	`as£π
–!
	`öãri‹RódîAtEnd
(
pRódî
) );

4385  
pRódî
->
ãrm
.
pD©a
;

4386 
	}
}

4389 
	$öãri‹RódîSãp
(
I¡îi‹Ródî
 *
pRódî
){

4390 
	`as£π
–!
	`öãri‹RódîAtEnd
(
pRódî
) );

4395 if–
pRódî
->
nD©a
==0 ){

4396 
	`d©aBuf„rRe£t
(&
pRódî
->
ãrm
);

4398 
n
, 
nPªfix
, 
nSuffix
;

4400 
n
 = 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
nPªfix
);

4401 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
nSuffix
);

4404 
pRódî
->
ãrm
.
nD©a
 = 
nPªfix
;

4405 
	`d©aBuf„rAµíd
(&
pRódî
->
ãrm
,ÖRódî->
pD©a
+
n
, 
nSuffix
);

4407 
	`as£π
–
n
+
nSuffix
<=
pRódî
->
nD©a
 );

4408 
pRódî
->
pD©a
 +
n
+
nSuffix
;

4409 
pRódî
->
nD©a
 -
n
+
nSuffix
;

4411 
pRódî
->
iBlockid
++;

4412 
	}
}

4417 
	$öãri‹RódîTîmCmp
(
I¡îi‹Ródî
 *
pRódî
,

4418 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
){

4419 c⁄° *
pRódîTîm
 = 
	`öãri‹RódîTîm
(
pRódî
);

4420 
nRódîTîm
 = 
	`öãri‹RódîTîmByãs
(
pRódî
);

4421 
c
, 
n
 = 
nRódîTîm
<
nTîm
 ?ÇReaderTerm :ÇTerm;

4423 if–
n
==0 ){

4424 if–
nRódîTîm
>0 )  -1;

4425 if–
nTîm
>0 )  1;

4429 
c
 = 
	`memcmp
(
pRódîTîm
, 
pTîm
, 
n
);

4430 if–
c
!=0 )  c;

4431 if–
isPªfix
 && 
n
==
nTîm
 )  0;

4432  
nRódîTîm
 - 
nTîm
;

4433 
	}
}

4461 
	#STANDALONE_MIN
 1024

	)

4464 
	#LEAF_MAX
 2048

	)

4466 
	sLófWrôî
 {

4467 
	miLevñ
;

4468 
	midx
;

4469 
sqlôe_öt64
 
	miSèπBlockid
;

4470 
sqlôe_öt64
 
	miEndBlockid
;

4472 
D©aBuf„r
 
	mãrm
;

4473 
D©aBuf„r
 
	md©a
;

4478 
	mnTîmDi°ö˘
;

4480 
I¡îi‹Wrôî
 
	m∑ª¡Wrôî
;

4481 
	mhas_∑ª¡
;

4482 } 
	tLófWrôî
;

4484 
	$ÀafWrôîInô
(
iLevñ
, 
idx
, 
LófWrôî
 *
pWrôî
){

4485 
	`CLEAR
(
pWrôî
);

4486 
pWrôî
->
iLevñ
 = iLevel;

4487 
pWrôî
->
idx
 = idx;

4489 
	`d©aBuf„rInô
(&
pWrôî
->
ãrm
, 32);

4492 
	`d©aBuf„rInô
(&
pWrôî
->
d©a
, 
LEAF_MAX
);

4493 
	}
}

4495 #i‚de‡
NDEBUG


4497 
	$ÀafNodeVÆid©e
(c⁄° *
pD©a
, 
nD©a
){

4498 
n
, 
iDummy
;

4500 if–
nD©a
==0 ) ;

4501 
	`as£π
–
nD©a
>0 );

4502 
	`as£π
–
pD©a
!=0 );

4503 
	`as£π
–
pD©a
+
nD©a
>pData );

4506 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4507 
	`as£π
–
iDummy
==0 );

4508 
	`as£π
–
n
>0 );

4509 
	`as£π
–
n
<
nD©a
 );

4510 
pD©a
 +
n
;

4511 
nD©a
 -
n
;

4514 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4515 
	`as£π
–
n
>0 );

4516 
	`as£π
–
iDummy
>0 );

4517 
	`as£π
–
n
+
iDummy
>0 );

4518 
	`as£π
–
n
+
iDummy
<
nD©a
 );

4519 
pD©a
 +
n
+
iDummy
;

4520 
nD©a
 -
n
+
iDummy
;

4523 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4524 
	`as£π
–
n
>0 );

4525 
	`as£π
–
iDummy
>0 );

4526 
	`as£π
–
n
+
iDummy
>0 );

4527 
	`as£π
–
n
+
iDummy
<=
nD©a
 );

4528 
	`ASSERT_VALID_DOCLIST
(
DL_DEFAULT
, 
pD©a
+
n
, 
iDummy
, 
NULL
);

4529 
pD©a
 +
n
+
iDummy
;

4530 
nD©a
 -
n
+
iDummy
;

4533  
nD©a
!=0 ){

4534 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4535 
	`as£π
–
n
>0 );

4536 
	`as£π
–
iDummy
>=0 );

4537 
	`as£π
–
n
<
nD©a
 );

4538 
pD©a
 +
n
;

4539 
nD©a
 -
n
;

4540 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4541 
	`as£π
–
n
>0 );

4542 
	`as£π
–
iDummy
>0 );

4543 
	`as£π
–
n
+
iDummy
>0 );

4544 
	`as£π
–
n
+
iDummy
<
nD©a
 );

4545 
pD©a
 +
n
+
iDummy
;

4546 
nD©a
 -
n
+
iDummy
;

4548 
n
 = 
	`gëV¨öt32
(
pD©a
, &
iDummy
);

4549 
	`as£π
–
n
>0 );

4550 
	`as£π
–
iDummy
>0 );

4551 
	`as£π
–
n
+
iDummy
>0 );

4552 
	`as£π
–
n
+
iDummy
<=
nD©a
 );

4553 
	`ASSERT_VALID_DOCLIST
(
DL_DEFAULT
, 
pD©a
+
n
, 
iDummy
, 
NULL
);

4554 
pD©a
 +
n
+
iDummy
;

4555 
nD©a
 -
n
+
iDummy
;

4557 
	}
}

4558 
	#ASSERT_VALID_LEAF_NODE
(
p
, 
n
Ë
	`ÀafNodeVÆid©e
’,Ç)

	)

4560 
	#ASSERT_VALID_LEAF_NODE
(
p
, 
n
Ë
	`as£π
–1 )

	)

4567 
	$ÀafWrôîI¡î«lFlush
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
,

4568 
iD©a
, 
nD©a
){

4569 
sqlôe_öt64
 
iBlockid
 = 0;

4570 c⁄° *
pSèπögTîm
;

4571 
nSèπögTîm
, 
rc
, 
n
;

4576 
	`as£π
–
nD©a
>2 );

4577 
	`as£π
–
iD©a
>=0 );

4578 
	`as£π
–
iD©a
+
nD©a
<=
pWrôî
->
d©a
.nData );

4579 
	`ASSERT_VALID_LEAF_NODE
(
pWrôî
->
d©a
.
pD©a
+
iD©a
, 
nD©a
);

4581 
rc
 = 
	`block_ö£π
(
v
, 
pWrôî
->
d©a
.
pD©a
+
iD©a
, 
nD©a
, &
iBlockid
);

4582 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4583 
	`as£π
–
iBlockid
!=0 );

4588 
n
 = 
	`gëV¨öt32
(
pWrôî
->
d©a
.
pD©a
+
iD©a
+1, &
nSèπögTîm
);

4589 
pSèπögTîm
 = 
pWrôî
->
d©a
.
pD©a
+
iD©a
+1+
n
;

4590 
	`as£π
–
pWrôî
->
d©a
.
nD©a
>
iD©a
+1+
n
+
nSèπögTîm
 );

4591 
	`as£π
–
pWrôî
->
nTîmDi°ö˘
>0 );

4592 
	`as£π
–
pWrôî
->
nTîmDi°ö˘
<=
nSèπögTîm
 );

4593 
nSèπögTîm
 = 
pWrôî
->
nTîmDi°ö˘
;

4595 if–
pWrôî
->
has_∑ª¡
 ){

4596 
	`öãri‹WrôîAµíd
(&
pWrôî
->
∑ª¡Wrôî
,

4597 
pSèπögTîm
, 
nSèπögTîm
, 
iBlockid
);

4599 
	`öãri‹WrôîInô
(1, 
pSèπögTîm
, 
nSèπögTîm
, 
iBlockid
,

4600 &
pWrôî
->
∑ª¡Wrôî
);

4601 
pWrôî
->
has_∑ª¡
 = 1;

4605 if–
pWrôî
->
iEndBlockid
==0 ){

4606 
pWrôî
->
iEndBlockid
 =ÖWrôî->
iSèπBlockid
 = 
iBlockid
;

4608 
pWrôî
->
iEndBlockid
++;

4609 
	`as£π
–
iBlockid
==
pWrôî
->
iEndBlockid
 );

4612  
SQLITE4_OK
;

4613 
	}
}

4614 
	$ÀafWrôîFlush
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
){

4615 
rc
 = 
	`ÀafWrôîI¡î«lFlush
(
v
, 
pWrôî
, 0,ÖWrôî->
d©a
.
nD©a
);

4616 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4619 
	`d©aBuf„rRe£t
(&
pWrôî
->
d©a
);

4621  
SQLITE4_OK
;

4622 
	}
}

4631 
	$ÀafWrôîRoŸInfo
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
,

4632 **
µRoŸInfo
, *
≤RoŸInfo
,

4633 
sqlôe_öt64
 *
piEndBlockid
){

4635 if–!
pWrôî
->
has_∑ª¡
 &&ÖWrôî->
d©a
.
nD©a
<
ROOT_MAX
 ){

4636 *
µRoŸInfo
 = 
pWrôî
->
d©a
.
pD©a
;

4637 *
≤RoŸInfo
 = 
pWrôî
->
d©a
.
nD©a
;

4638 *
piEndBlockid
 = 0;

4639  
SQLITE4_OK
;

4643 if–
pWrôî
->
d©a
.
nD©a
>0 ){

4644 
rc
 = 
	`ÀafWrôîFlush
(
v
, 
pWrôî
);

4645 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4649 
	`as£π
–
pWrôî
->
has_∑ª¡
 );

4656 *
piEndBlockid
 = 
pWrôî
->
iEndBlockid
;

4658  
	`öãri‹WrôîRoŸInfo
(
v
, &
pWrôî
->
∑ª¡Wrôî
,

4659 
µRoŸInfo
, 
≤RoŸInfo
, 
piEndBlockid
);

4660 
	}
}

4666 
	$ÀafWrôîFöÆize
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
){

4667 
sqlôe_öt64
 
iEndBlockid
;

4668 *
pRoŸInfo
;

4669 
rc
, 
nRoŸInfo
;

4671 
rc
 = 
	`ÀafWrôîRoŸInfo
(
v
, 
pWrôî
, &
pRoŸInfo
, &
nRoŸInfo
, &
iEndBlockid
);

4672 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4675 if–
iEndBlockid
==0 && 
nRoŸInfo
==0 )  
SQLITE4_OK
;

4677  
	`£gdú_£t
(
v
, 
pWrôî
->
iLevñ
,ÖWrôî->
idx
,

4678 
pWrôî
->
iSèπBlockid
,ÖWrôî->
iEndBlockid
,

4679 
iEndBlockid
, 
pRoŸInfo
, 
nRoŸInfo
);

4680 
	}
}

4682 
	$ÀafWrôîDe°roy
(
LófWrôî
 *
pWrôî
){

4683 if–
pWrôî
->
has_∑ª¡
 ) 
	`öãri‹WrôîDe°roy
(&pWrôî->
∑ª¡Wrôî
);

4684 
	`d©aBuf„rDe°roy
(&
pWrôî
->
ãrm
);

4685 
	`d©aBuf„rDe°roy
(&
pWrôî
->
d©a
);

4686 
	}
}

4693 
	$ÀafWrôîEncodeTîm
(
LófWrôî
 *
pWrôî
,

4694 c⁄° *
pTîm
, 
nTîm
){

4695 
c
[
VARINT_MAX
+VARINT_MAX];

4696 
n
, 
nPªfix
 = 0;

4698 
	`as£π
–
nTîm
>0 );

4699  
nPªfix
<
pWrôî
->
ãrm
.
nD©a
 &&

4700 
pTîm
[
nPªfix
]==
pWrôî
->
ãrm
.
pD©a
[nPrefix] ){

4701 
nPªfix
++;

4703 
	`as£π
–
nPªfix
<
nTîm
 );

4706 if–
pWrôî
->
d©a
.
nD©a
==0 ){

4712 
n
 = 
	`putV¨öt
(
c
, '\0');

4713 
n
 +
	`putV¨öt
(
c
+n, 
nTîm
);

4714 
	`d©aBuf„rAµíd2
(&
pWrôî
->
d©a
, 
c
, 
n
, 
pTîm
, 
nTîm
);

4721 
n
 = 
	`putV¨öt
(
c
, 
nPªfix
);

4722 
n
 +
	`putV¨öt
(
c
+n, 
nTîm
-
nPªfix
);

4723 
	`d©aBuf„rAµíd2
(&
pWrôî
->
d©a
, 
c
, 
n
, 
pTîm
+
nPªfix
, 
nTîm
-nPrefix);

4725 
	`d©aBuf„rRïœ˚
(&
pWrôî
->
ãrm
, 
pTîm
, 
nTîm
);

4727  
nPªfix
+1;

4728 
	}
}

4735 
	$ÀafWrôîI∆öeFlush
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
,

4736 c⁄° *
pTîm
, 
nTîm
,

4737 
iDo˛i°D©a
){

4738 
c
[
VARINT_MAX
+VARINT_MAX];

4739 
iD©a
, 
n
 = 
	`putV¨öt
(
c
, 0);

4740 
n
 +
	`putV¨öt
(
c
+n, 
nTîm
);

4747 
	`as£π
–
iDo˛i°D©a
>=
n
+
nTîm
 );

4749 
iD©a
 = 
iDo˛i°D©a
-(
n
+
nTîm
);

4750 
	`mem˝y
(
pWrôî
->
d©a
.
pD©a
+
iD©a
, 
c
, 
n
);

4751 
	`mem˝y
(
pWrôî
->
d©a
.
pD©a
+
iD©a
+
n
, 
pTîm
, 
nTîm
);

4753  
	`ÀafWrôîI¡î«lFlush
(
v
, 
pWrôî
, 
iD©a
,ÖWrôî->
d©a
.
nD©a
-iData);

4754 
	}
}

4759 
	$ÀafWrôîSãpMîge
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
,

4760 c⁄° *
pTîm
, 
nTîm
,

4761 
DLRódî
 *
pRódîs
, 
nRódîs
){

4762 
c
[
VARINT_MAX
+VARINT_MAX];

4763 
iTîmD©a
 = 
pWrôî
->
d©a
.
nD©a
, 
iDo˛i°D©a
;

4764 
i
, 
nD©a
, 
n
, 
nA˘uÆD©a
, 
nA˘uÆ
, 
rc
, 
nTîmDi°ö˘
;

4766 
	`ASSERT_VALID_LEAF_NODE
(
pWrôî
->
d©a
.
pD©a
,ÖWrôî->d©a.
nD©a
);

4767 
nTîmDi°ö˘
 = 
	`ÀafWrôîEncodeTîm
(
pWrôî
, 
pTîm
, 
nTîm
);

4770 if–
iTîmD©a
==0 ) 
pWrôî
->
nTîmDi°ö˘
 =ÇTermDistinct;

4772 
iDo˛i°D©a
 = 
pWrôî
->
d©a
.
nD©a
;

4777 
i
=0, 
nD©a
=0; i<
nRódîs
; i++){

4778 
nD©a
 +
	`dÃAŒD©aByãs
(&
pRódîs
[
i
]);

4780 
n
 = 
	`putV¨öt
(
c
, 
nD©a
);

4781 
	`d©aBuf„rAµíd
(&
pWrôî
->
d©a
, 
c
, 
n
);

4783 
	`docLi°Mîge
(&
pWrôî
->
d©a
, 
pRódîs
, 
nRódîs
);

4784 
	`ASSERT_VALID_DOCLIST
(
DL_DEFAULT
,

4785 
pWrôî
->
d©a
.
pD©a
+
iDo˛i°D©a
+
n
,

4786 
pWrôî
->
d©a
.
nD©a
-
iDo˛i°D©a
-
n
, 
NULL
);

4793 
nA˘uÆD©a
 = 
pWrôî
->
d©a
.
nD©a
-(
iDo˛i°D©a
+
n
);

4794 
nA˘uÆ
 = 
	`putV¨öt
(
c
, 
nA˘uÆD©a
);

4795 
	`as£π
–
nA˘uÆD©a
<=
nD©a
 );

4796 
	`as£π
–
nA˘uÆ
<=
n
 );

4807 if–
nTîm
+
nA˘uÆD©a
>
STANDALONE_MIN
 ){

4809 if–
iTîmD©a
>0 ){

4810 
rc
 = 
	`ÀafWrôîI¡î«lFlush
(
v
, 
pWrôî
, 0, 
iTîmD©a
);

4811 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4813 
pWrôî
->
nTîmDi°ö˘
 =ÇTermDistinct;

4817 
iDo˛i°D©a
 +
n
 - 
nA˘uÆ
;

4818 
	`mem˝y
(
pWrôî
->
d©a
.
pD©a
+
iDo˛i°D©a
, 
c
, 
nA˘uÆ
);

4821 
rc
 = 
	`ÀafWrôîI∆öeFlush
(
v
, 
pWrôî
, 
pTîm
, 
nTîm
, 
iDo˛i°D©a
);

4822 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4825 
	`d©aBuf„rRe£t
(&
pWrôî
->
d©a
);

4827  
rc
;

4833 if–
nA˘uÆ
<
n
 ){

4834 
	`memmove
(
pWrôî
->
d©a
.
pD©a
+
iDo˛i°D©a
+
nA˘uÆ
,

4835 
pWrôî
->
d©a
.
pD©a
+
iDo˛i°D©a
+
n
,

4836 
pWrôî
->
d©a
.
nD©a
-(
iDo˛i°D©a
+
n
));

4837 
pWrôî
->
d©a
.
nD©a
 -
n
-
nA˘uÆ
;

4841 
	`mem˝y
(
pWrôî
->
d©a
.
pD©a
+
iDo˛i°D©a
, 
c
, 
nA˘uÆ
);

4849 if–
iTîmD©a
+
nTîm
+
nA˘uÆD©a
>
LEAF_MAX
 ){

4851 
rc
 = 
	`ÀafWrôîI¡î«lFlush
(
v
, 
pWrôî
, 0, 
iTîmD©a
);

4852 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4854 
pWrôî
->
nTîmDi°ö˘
 =ÇTermDistinct;

4857 
n
 = 
	`putV¨öt
(
pWrôî
->
d©a
.
pD©a
, 0);

4858 
n
 +
	`putV¨öt
(
pWrôî
->
d©a
.
pD©a
+n, 
nTîm
);

4859 
	`mem˝y
(
pWrôî
->
d©a
.
pD©a
+
n
, 
pTîm
, 
nTîm
);

4860 
n
 +
nTîm
;

4865 
	`as£π
–
n
<
iDo˛i°D©a
 );

4869 
	`as£π
–2*
STANDALONE_MIN
<=
LEAF_MAX
 );

4870 
	`as£π
–
n
+
pWrôî
->
d©a
.
nD©a
-
iDo˛i°D©a
<iDoclistData );

4871 
	`mem˝y
(
pWrôî
->
d©a
.
pD©a
+
n
,

4872 
pWrôî
->
d©a
.
pD©a
+
iDo˛i°D©a
,

4873 
pWrôî
->
d©a
.
nD©a
-
iDo˛i°D©a
);

4874 
pWrôî
->
d©a
.
nD©a
 -
iDo˛i°D©a
-
n
;

4876 
	`ASSERT_VALID_LEAF_NODE
(
pWrôî
->
d©a
.
pD©a
,ÖWrôî->d©a.
nD©a
);

4878  
SQLITE4_OK
;

4879 
	}
}

4887 
	$ÀafWrôîSãp
(
fuŒãxt_vèb
 *
v
, 
LófWrôî
 *
pWrôî
,

4888 c⁄° *
pTîm
, 
nTîm
,

4889 c⁄° *
pD©a
, 
nD©a
){

4890 
rc
;

4891 
DLRódî
 
ªadî
;

4893 
	`dÃInô
(&
ªadî
, 
DL_DEFAULT
, 
pD©a
, 
nD©a
);

4894 
rc
 = 
	`ÀafWrôîSãpMîge
(
v
, 
pWrôî
, 
pTîm
, 
nTîm
, &
ªadî
, 1);

4895 
	`dÃDe°roy
(&
ªadî
);

4897  
rc
;

4898 
	}
}

4903 
	sLófRódî
 {

4904 
D©aBuf„r
 
	mãrm
;

4906 c⁄° *
	mpD©a
;

4907 
	mnD©a
;

4908 } 
	tLófRódî
;

4910 
	$ÀafRódîDe°roy
(
LófRódî
 *
pRódî
){

4911 
	`d©aBuf„rDe°roy
(&
pRódî
->
ãrm
);

4912 
	`SCRAMBLE
(
pRódî
);

4913 
	}
}

4915 
	$ÀafRódîAtEnd
(
LófRódî
 *
pRódî
){

4916  
pRódî
->
nD©a
<=0;

4917 
	}
}

4920 
	$ÀafRódîTîmByãs
(
LófRódî
 *
pRódî
){

4921  
pRódî
->
ãrm
.
nD©a
;

4922 
	}
}

4923 c⁄° *
	$ÀafRódîTîm
(
LófRódî
 *
pRódî
){

4924 
	`as£π
–
pRódî
->
ãrm
.
nD©a
>0 );

4925  
pRódî
->
ãrm
.
pD©a
;

4926 
	}
}

4929 
	$ÀafRódîD©aByãs
(
LófRódî
 *
pRódî
){

4930 
nD©a
;

4931 
	`as£π
–
pRódî
->
ãrm
.
nD©a
>0 );

4932 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
nD©a
);

4933  
nD©a
;

4934 
	}
}

4935 c⁄° *
	$ÀafRódîD©a
(
LófRódî
 *
pRódî
){

4936 
n
, 
nD©a
;

4937 
	`as£π
–
pRódî
->
ãrm
.
nD©a
>0 );

4938 
n
 = 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
nD©a
);

4939  
pRódî
->
pD©a
+
n
;

4940 
	}
}

4942 
	$ÀafRódîInô
(c⁄° *
pD©a
, 
nD©a
,

4943 
LófRódî
 *
pRódî
){

4944 
nTîm
, 
n
;

4946 
	`as£π
–
nD©a
>0 );

4947 
	`as£π
–
pD©a
[0]=='\0' );

4949 
	`CLEAR
(
pRódî
);

4952 
n
 = 
	`gëV¨öt32
(
pD©a
+1, &
nTîm
);

4953 
	`d©aBuf„rInô
(&
pRódî
->
ãrm
, 
nTîm
);

4954 
	`d©aBuf„rRïœ˚
(&
pRódî
->
ãrm
, 
pD©a
+1+
n
, 
nTîm
);

4957 
	`as£π
–1+
n
+
nTîm
<
nD©a
 );

4958 
pRódî
->
pD©a
 =ÖD©a+1+
n
+
nTîm
;

4959 
pRódî
->
nD©a
 =ÇD©a-1-
n
-
nTîm
;

4960 
	}
}

4963 
	$ÀafRódîSãp
(
LófRódî
 *
pRódî
){

4964 
n
, 
nD©a
, 
nPªfix
, 
nSuffix
;

4965 
	`as£π
–!
	`ÀafRódîAtEnd
(
pRódî
) );

4968 
n
 = 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
nD©a
);

4969 
	`as£π
–
n
+
nD©a
<=
pRódî
->nData );

4970 
pRódî
->
pD©a
 +
n
+
nD©a
;

4971 
pRódî
->
nD©a
 -
n
+nData;

4973 if–!
	`ÀafRódîAtEnd
(
pRódî
) ){

4977 
n
 = 
	`gëV¨öt32
(
pRódî
->
pD©a
, &
nPªfix
);

4978 
n
 +
	`gëV¨öt32
(
pRódî
->
pD©a
+n, &
nSuffix
);

4979 
	`as£π
–
n
+
nSuffix
<
pRódî
->
nD©a
 );

4980 
pRódî
->
ãrm
.
nD©a
 = 
nPªfix
;

4981 
	`d©aBuf„rAµíd
(&
pRódî
->
ãrm
,ÖRódî->
pD©a
+
n
, 
nSuffix
);

4983 
pRódî
->
pD©a
 +
n
+
nSuffix
;

4984 
pRódî
->
nD©a
 -
n
+
nSuffix
;

4986 
	}
}

4991 
	$ÀafRódîTîmCmp
(
LófRódî
 *
pRódî
,

4992 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
){

4993 
c
, 
n
 = 
pRódî
->
ãrm
.
nD©a
<
nTîm
 ?ÖReader->term.nData :ÇTerm;

4994 if–
n
==0 ){

4995 if–
pRódî
->
ãrm
.
nD©a
>0 )  -1;

4996 if(
nTîm
>0 )  1;

5000 
c
 = 
	`memcmp
(
pRódî
->
ãrm
.
pD©a
, 
pTîm
, 
n
);

5001 if–
c
!=0 )  c;

5002 if–
isPªfix
 && 
n
==
nTîm
 )  0;

5003  
pRódî
->
ãrm
.
nD©a
 - 
nTîm
;

5004 
	}
}

5011 
	sLóvesRódî
 {

5012 
	midx
;

5014 
sqlôe4_°mt
 *
	mpStmt
;

5015 
	meof
;

5017 
LófRódî
 
	mÀafRódî
;

5018 
D©aBuf„r
 
	mroŸD©a
;

5019 } 
	tLóvesRódî
;

5022 
	$ÀavesRódîTîmByãs
(
LóvesRódî
 *
pRódî
){

5023 
	`as£π
–!
pRódî
->
eof
 );

5024  
	`ÀafRódîTîmByãs
(&
pRódî
->
ÀafRódî
);

5025 
	}
}

5026 c⁄° *
	$ÀavesRódîTîm
(
LóvesRódî
 *
pRódî
){

5027 
	`as£π
–!
pRódî
->
eof
 );

5028  
	`ÀafRódîTîm
(&
pRódî
->
ÀafRódî
);

5029 
	}
}

5032 
	$ÀavesRódîD©aByãs
(
LóvesRódî
 *
pRódî
){

5033 
	`as£π
–!
pRódî
->
eof
 );

5034  
	`ÀafRódîD©aByãs
(&
pRódî
->
ÀafRódî
);

5035 
	}
}

5036 c⁄° *
	$ÀavesRódîD©a
(
LóvesRódî
 *
pRódî
){

5037 
	`as£π
–!
pRódî
->
eof
 );

5038  
	`ÀafRódîD©a
(&
pRódî
->
ÀafRódî
);

5039 
	}
}

5041 
	$ÀavesRódîAtEnd
(
LóvesRódî
 *
pRódî
){

5042  
pRódî
->
eof
;

5043 
	}
}

5058 
	$ÀavesRódîRe£t
(
LóvesRódî
 *
pRódî
){

5059  
	`sqlôe4_ª£t
(
pRódî
->
pStmt
);

5060 
	}
}

5062 
	$ÀavesRódîDe°roy
(
LóvesRódî
 *
pRódî
){

5066 if–
pRódî
->
pStmt
!=
NULL
 &&ÖRódî->
idx
==-1 ){

5067 
	`sqlôe4_föÆize
(
pRódî
->
pStmt
);

5069 
	`ÀafRódîDe°roy
(&
pRódî
->
ÀafRódî
);

5070 
	`d©aBuf„rDe°roy
(&
pRódî
->
roŸD©a
);

5071 
	`SCRAMBLE
(
pRódî
);

5072 
	}
}

5078 
	$ÀavesRódîInô
(
fuŒãxt_vèb
 *
v
,

5079 
idx
,

5080 
sqlôe_öt64
 
iSèπBlockid
,

5081 
sqlôe_öt64
 
iEndBlockid
,

5082 c⁄° *
pRoŸD©a
, 
nRoŸD©a
,

5083 
LóvesRódî
 *
pRódî
){

5084 
	`CLEAR
(
pRódî
);

5085 
pRódî
->
idx
 = idx;

5087 
	`d©aBuf„rInô
(&
pRódî
->
roŸD©a
, 0);

5088 if–
iSèπBlockid
==0 ){

5090 
	`d©aBuf„rRïœ˚
(&
pRódî
->
roŸD©a
, 
pRoŸD©a
, 
nRoŸD©a
);

5091 
	`ÀafRódîInô
(
pRódî
->
roŸD©a
.
pD©a
,ÖRódî->roŸD©a.
nD©a
,

5092 &
pRódî
->
ÀafRódî
);

5094 
sqlôe4_°mt
 *
s
;

5095 
rc
 = 
	`sql_gë_Àaf_°©emít
(
v
, 
idx
, &
s
);

5096 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5098 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iSèπBlockid
);

5099 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5101 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 2, 
iEndBlockid
);

5102 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5104 
rc
 = 
	`sqlôe4_°ï
(
s
);

5105 if–
rc
==
SQLITE4_DONE
 ){

5106 
pRódî
->
eof
 = 1;

5107  
SQLITE4_OK
;

5109 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

5111 
pRódî
->
pStmt
 = 
s
;

5112 
	`ÀafRódîInô
(
	`sqlôe4_cﬁumn_blob
(
pRódî
->
pStmt
, 0),

5113 
	`sqlôe4_cﬁumn_byãs
(
pRódî
->
pStmt
, 0),

5114 &
pRódî
->
ÀafRódî
);

5116  
SQLITE4_OK
;

5117 
	}
}

5122 
	$ÀavesRódîSãp
(
fuŒãxt_vèb
 *
v
, 
LóvesRódî
 *
pRódî
){

5123 
	`as£π
–!
	`ÀavesRódîAtEnd
(
pRódî
) );

5124 
	`ÀafRódîSãp
(&
pRódî
->
ÀafRódî
);

5126 if–
	`ÀafRódîAtEnd
(&
pRódî
->
ÀafRódî
) ){

5127 
rc
;

5128 if–
pRódî
->
roŸD©a
.
pD©a
 ){

5129 
pRódî
->
eof
 = 1;

5130  
SQLITE4_OK
;

5132 
rc
 = 
	`sqlôe4_°ï
(
pRódî
->
pStmt
);

5133 if–
rc
!=
SQLITE4_ROW
 ){

5134 
pRódî
->
eof
 = 1;

5135  
rc
==
SQLITE4_DONE
 ? 
SQLITE4_OK
 :Ñc;

5137 
	`ÀafRódîDe°roy
(&
pRódî
->
ÀafRódî
);

5138 
	`ÀafRódîInô
(
	`sqlôe4_cﬁumn_blob
(
pRódî
->
pStmt
, 0),

5139 
	`sqlôe4_cﬁumn_byãs
(
pRódî
->
pStmt
, 0),

5140 &
pRódî
->
ÀafRódî
);

5142  
SQLITE4_OK
;

5143 
	}
}

5148 
	$ÀavesRódîTîmCmp
(
LóvesRódî
 *
Ã1
, LóvesRódî *
Ã2
){

5149 if–
	`ÀavesRódîAtEnd
(
Ã1
) ){

5150 if–
	`ÀavesRódîAtEnd
(
Ã2
) )  0;

5153 if–
	`ÀavesRódîAtEnd
(
Ã2
) )  -1;

5155  
	`ÀafRódîTîmCmp
(&
Ã1
->
ÀafRódî
,

5156 
	`ÀavesRódîTîm
(
Ã2
), 
	`ÀavesRódîTîmByãs
(lr2),

5158 
	}
}

5163 
	$ÀavesRódîCmp
(
LóvesRódî
 *
Ã1
, LóvesRódî *
Ã2
){

5164 
c
 = 
	`ÀavesRódîTîmCmp
(
Ã1
, 
Ã2
);

5165 if–
c
!=0 )  c;

5166  
Ã1
->
idx
-
Ã2
->idx;

5167 
	}
}

5172 
	$ÀavesRódîRe‹dî
(
LóvesRódî
 *
pLr
, 
nLr
){

5173  
nLr
>1 && 
	`ÀavesRódîCmp
(
pLr
,ÖLr+1)>0 ){

5174 
LóvesRódî
 
tmp
 = 
pLr
[0];

5175 
pLr
[0] =ÖLr[1];

5176 
pLr
[1] = 
tmp
;

5177 
nLr
--;

5178 
pLr
++;

5180 
	}
}

5186 
	$ÀavesRódîsInô
(
fuŒãxt_vèb
 *
v
, 
iLevñ
,

5187 
LóvesRódî
 *
pRódîs
, *
piRódîs
){

5188 
sqlôe4_°mt
 *
s
;

5189 
i
, 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SELECT_LEVEL_STMT
, &
s
);

5190 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5192 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 1, 
iLevñ
);

5193 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5195 
i
 = 0;

5196  (
rc
 = 
	`sqlôe4_°ï
(
s
))==
SQLITE4_ROW
 ){

5197 
sqlôe_öt64
 
iSèπ
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

5198 
sqlôe_öt64
 
iEnd
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 1);

5199 c⁄° *
pRoŸD©a
 = 
	`sqlôe4_cﬁumn_blob
(
s
, 2);

5200 
nRoŸD©a
 = 
	`sqlôe4_cﬁumn_byãs
(
s
, 2);

5202 
	`as£π
–
i
<
MERGE_COUNT
 );

5203 
rc
 = 
	`ÀavesRódîInô
(
v
, 
i
, 
iSèπ
, 
iEnd
, 
pRoŸD©a
, 
nRoŸD©a
,

5204 &
pRódîs
[
i
]);

5205 if–
rc
!=
SQLITE4_OK
 ) ;

5207 
i
++;

5209 if–
rc
!=
SQLITE4_DONE
 ){

5210  
i
-->0 ){

5211 
	`ÀavesRódîDe°roy
(&
pRódîs
[
i
]);

5213  
rc
;

5216 *
piRódîs
 = 
i
;

5219  
i
-- ){

5220 
	`ÀavesRódîRe‹dî
(
pRódîs
+
i
, *
piRódîs
-i);

5222  
SQLITE4_OK
;

5223 
	}
}

5230 
	$ÀavesRódîsMîge
(
fuŒãxt_vèb
 *
v
,

5231 
LóvesRódî
 *
pRódîs
, 
nRódîs
,

5232 
LófWrôî
 *
pWrôî
){

5233 
DLRódî
 
dlRódîs
[
MERGE_COUNT
];

5234 c⁄° *
pTîm
 = 
	`ÀavesRódîTîm
(
pRódîs
);

5235 
i
, 
nTîm
 = 
	`ÀavesRódîTîmByãs
(
pRódîs
);

5237 
	`as£π
–
nRódîs
<=
MERGE_COUNT
 );

5239 
i
=0; i<
nRódîs
; i++){

5240 
	`dÃInô
(&
dlRódîs
[
i
], 
DL_DEFAULT
,

5241 
	`ÀavesRódîD©a
(
pRódîs
+
i
),

5242 
	`ÀavesRódîD©aByãs
(
pRódîs
+
i
));

5245  
	`ÀafWrôîSãpMîge
(
v
, 
pWrôî
, 
pTîm
, 
nTîm
, 
dlRódîs
, 
nRódîs
);

5246 
	}
}

5249 
£gmítMîge
(
fuŒãxt_vèb
 *
v
, 
iLevñ
);

5255 
	$£gdúNextIndex
(
fuŒãxt_vèb
 *
v
, 
iLevñ
, *
pidx
){

5256 
rc
 = 
	`£gdú_max_ödex
(
v
, 
iLevñ
, 
pidx
);

5257 if–
rc
==
SQLITE4_DONE
 ){

5258 *
pidx
 = 0;

5259 }if–
rc
==
SQLITE4_ROW
 ){

5260 if–*
pidx
==(
MERGE_COUNT
-1) ){

5261 
rc
 = 
	`£gmítMîge
(
v
, 
iLevñ
);

5262 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5263 *
pidx
 = 0;

5265 (*
pidx
)++;

5268  
rc
;

5270  
SQLITE4_OK
;

5271 
	}
}

5277 
	$£gmítMîge
(
fuŒãxt_vèb
 *
v
, 
iLevñ
){

5278 
LófWrôî
 
wrôî
;

5279 
LóvesRódî
 
Ãs
[
MERGE_COUNT
];

5280 
i
, 
rc
, 
idx
 = 0;

5285 
rc
 = 
	`£gdúNextIndex
(
v
, 
iLevñ
+1, &
idx
);

5286 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5293 
	`mem£t
(&
Ãs
, '\0', (lrs));

5294 
rc
 = 
	`ÀavesRódîsInô
(
v
, 
iLevñ
, 
Ãs
, &
i
);

5295 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5296 
	`as£π
–
i
==
MERGE_COUNT
 );

5298 
	`ÀafWrôîInô
(
iLevñ
+1, 
idx
, &
wrôî
);

5303  !
	`ÀavesRódîAtEnd
(
Ãs
) ){

5305 
i
=1; i<
MERGE_COUNT
 && !
	`ÀavesRódîAtEnd
(
Ãs
+i); i++){

5306 if–0!=
	`ÀavesRódîTîmCmp
(
Ãs
,Ürs+
i
) ) ;

5309 
rc
 = 
	`ÀavesRódîsMîge
(
v
, 
Ãs
, 
i
, &
wrôî
);

5310 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

5313  
i
-->0 ){

5314 
rc
 = 
	`ÀavesRódîSãp
(
v
, 
Ãs
+
i
);

5315 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

5318 
	`ÀavesRódîRe‹dî
(
Ãs
+
i
, 
MERGE_COUNT
-i);

5322 
i
=0; i<
MERGE_COUNT
; i++){

5323 
	`ÀavesRódîDe°roy
(&
Ãs
[
i
]);

5326 
rc
 = 
	`ÀafWrôîFöÆize
(
v
, &
wrôî
);

5327 
	`ÀafWrôîDe°roy
(&
wrôî
);

5328 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5331  
	`£gdú_dñëe
(
v
, 
iLevñ
);

5333 
îr
:

5334 
i
=0; i<
MERGE_COUNT
; i++){

5335 
	`ÀavesRódîDe°roy
(&
Ãs
[
i
]);

5337 
	`ÀafWrôîDe°roy
(&
wrôî
);

5338  
rc
;

5339 
	}
}

5342 
	$docLi°AccumuœãUni⁄
(
D©aBuf„r
 *
acc
,

5343 c⁄° *
pD©a
, 
nD©a
) {

5344 
D©aBuf„r
 
tmp
 = *
acc
;

5345 
	`d©aBuf„rInô
(
acc
, 
tmp
.
nD©a
+nData);

5346 
	`docLi°Uni⁄
(
tmp
.
pD©a
,Åmp.
nD©a
,ÖD©a,ÇD©a, 
acc
);

5347 
	`d©aBuf„rDe°roy
(&
tmp
);

5348 
	}
}

5365 
	$lﬂdSegmítLóvesI¡
(
fuŒãxt_vèb
 *
v
, 
LóvesRódî
 *
pRódî
,

5366 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5367 
D©aBuf„r
 *
out
){

5374 
D©aBuf„r
 *
pBuf„rs
 = 
NULL
;

5375 
nBuf„rs
 = 0, 
nMaxBuf„rs
 = 0, 
rc
;

5377 
	`as£π
–
nTîm
>0 );

5379 
rc
=
SQLITE4_OK
;Ñc==SQLITE4_OK && !
	`ÀavesRódîAtEnd
(
pRódî
);

5380 
rc
=
	`ÀavesRódîSãp
(
v
, 
pRódî
)){

5386 
c
 = 
	`ÀafRódîTîmCmp
(&
pRódî
->
ÀafRódî
, 
pTîm
, 
nTîm
, 
isPªfix
);

5387 if–
c
>0 ) ;

5388 if–
c
==0 ){

5389 c⁄° *
pD©a
 = 
	`ÀavesRódîD©a
(
pRódî
);

5390 
iBuf„r
, 
nD©a
 = 
	`ÀavesRódîD©aByãs
(
pRódî
);

5393 
iBuf„r
=0; iBuf„r<
nBuf„rs
; ++iBuffer){

5394 if–0==
pBuf„rs
[
iBuf„r
].
nD©a
 ) ;

5398 if–
iBuf„r
==
nBuf„rs
 ){

5399 if–
nBuf„rs
==
nMaxBuf„rs
 ){

5400 
D©aBuf„r
 *
p
;

5401 
nMaxBuf„rs
 += 20;

5404 
p
 = 
	`sqlôe4_mÆloc
(
nMaxBuf„rs
*(*
pBuf„rs
));

5405 if–
p
==
NULL
 ){

5406 
rc
 = 
SQLITE4_NOMEM
;

5410 if–
nBuf„rs
>0 ){

5411 
	`as£π
(
pBuf„rs
!=
NULL
);

5412 
	`mem˝y
(
p
, 
pBuf„rs
, 
nBuf„rs
*(*pBuffers));

5413 
	`sqlôe4_‰ì
(
pBuf„rs
);

5415 
pBuf„rs
 = 
p
;

5417 
	`d©aBuf„rInô
(&(
pBuf„rs
[
nBuf„rs
]), 0);

5418 
nBuf„rs
++;

5422 
	`as£π
(
iBuf„r
<
nBuf„rs
 && 
pBuf„rs
[iBuf„r].
nD©a
==0);

5425 if–
iBuf„r
==0 ){

5426 
	`d©aBuf„rRïœ˚
(&(
pBuf„rs
[0]), 
pD©a
, 
nD©a
);

5429 
D©aBuf„r
 *
pAcc
 = &(
pBuf„rs
[
iBuf„r
]);

5430 
D©aBuf„r
 *
p
 = &(
pBuf„rs
[0]);

5435 
	`d©aBuf„rSw≠
(
p
, 
pAcc
);

5436 
	`docLi°AccumuœãUni⁄
(
pAcc
, 
pD©a
, 
nD©a
);

5439 ++
p
;Ö<
pAcc
; ++p){

5440 
	`docLi°AccumuœãUni⁄
(
pAcc
, 
p
->
pD©a
,Ö->
nD©a
);

5445 if–
p
->
nC≠acôy
<1024 ){

5446 
	`d©aBuf„rRe£t
(
p
);

5448 
	`d©aBuf„rDe°roy
(
p
);

5449 
	`d©aBuf„rInô
(
p
, 0);

5458 if–
rc
==
SQLITE4_OK
 && 
nBuf„rs
>0 ){

5459 
iBuf„r
;

5460 
iBuf„r
=0; iBuf„r<
nBuf„rs
; ++iBuffer){

5461 if–
pBuf„rs
[
iBuf„r
].
nD©a
>0 ){

5462 if–
out
->
nD©a
==0 ){

5463 
	`d©aBuf„rSw≠
(
out
, &(
pBuf„rs
[
iBuf„r
]));

5465 
	`docLi°AccumuœãUni⁄
(
out
, 
pBuf„rs
[
iBuf„r
].
pD©a
,

5466 
pBuf„rs
[
iBuf„r
].
nD©a
);

5472  
nBuf„rs
-- ){

5473 
	`d©aBuf„rDe°roy
(&(
pBuf„rs
[
nBuf„rs
]));

5475 if–
pBuf„rs
!=
NULL
 ) 
	`sqlôe4_‰ì
(pBuffers);

5477  
rc
;

5478 
	}
}

5481 
	$lﬂdSegmítLóf
(
fuŒãxt_vèb
 *
v
, c⁄° *
pD©a
, 
nD©a
,

5482 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5483 
D©aBuf„r
 *
out
){

5484 
LóvesRódî
 
ªadî
;

5485 
rc
;

5487 
	`as£π
–
nD©a
>1 );

5488 
	`as£π
–*
pD©a
=='\0' );

5489 
rc
 = 
	`ÀavesRódîInô
(
v
, 0, 0, 0, 
pD©a
, 
nD©a
, &
ªadî
);

5490 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5492 
rc
 = 
	`lﬂdSegmítLóvesI¡
(
v
, &
ªadî
, 
pTîm
, 
nTîm
, 
isPªfix
, 
out
);

5493 
	`ÀavesRódîRe£t
(&
ªadî
);

5494 
	`ÀavesRódîDe°roy
(&
ªadî
);

5495  
rc
;

5496 
	}
}

5502 
	$lﬂdSegmítLóves
(
fuŒãxt_vèb
 *
v
,

5503 
sqlôe_öt64
 
iSèπLóf
, sqlôe_öt64 
iEndLóf
,

5504 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5505 
D©aBuf„r
 *
out
){

5506 
rc
;

5507 
LóvesRódî
 
ªadî
;

5509 
	`as£π
–
iSèπLóf
<=
iEndLóf
 );

5510 
rc
 = 
	`ÀavesRódîInô
(
v
, 0, 
iSèπLóf
, 
iEndLóf
, 
NULL
, 0, &
ªadî
);

5511 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5513 
rc
 = 
	`lﬂdSegmítLóvesI¡
(
v
, &
ªadî
, 
pTîm
, 
nTîm
, 
isPªfix
, 
out
);

5514 
	`ÀavesRódîRe£t
(&
ªadî
);

5515 
	`ÀavesRódîDe°roy
(&
ªadî
);

5516  
rc
;

5517 
	}
}

5530 
	$gëChûdªnC⁄èöög
(c⁄° *
pD©a
, 
nD©a
,

5531 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5532 
sqlôe_öt64
 *
piSèπChûd
,

5533 
sqlôe_öt64
 *
piEndChûd
){

5534 
I¡îi‹Ródî
 
ªadî
;

5536 
	`as£π
–
nD©a
>1 );

5537 
	`as£π
–*
pD©a
!='\0' );

5538 
	`öãri‹RódîInô
(
pD©a
, 
nD©a
, &
ªadî
);

5541  !
	`öãri‹RódîAtEnd
(&
ªadî
) ){

5542 if–
	`öãri‹RódîTîmCmp
(&
ªadî
, 
pTîm
, 
nTîm
, 0)>0 ) ;

5543 
	`öãri‹RódîSãp
(&
ªadî
);

5545 *
piSèπChûd
 = 
	`öãri‹RódîCuºítBlockid
(&
ªadî
);

5551  !
	`öãri‹RódîAtEnd
(&
ªadî
) ){

5552 if–
	`öãri‹RódîTîmCmp
(&
ªadî
, 
pTîm
, 
nTîm
, 
isPªfix
)>0 ) ;

5553 
	`öãri‹RódîSãp
(&
ªadî
);

5555 *
piEndChûd
 = 
	`öãri‹RódîCuºítBlockid
(&
ªadî
);

5557 
	`öãri‹RódîDe°roy
(&
ªadî
);

5560 
	`as£π
–*
piEndChûd
>=*
piSèπChûd
 );

5561 
	`as£π
–
isPªfix
 || *
piSèπChûd
==*
piEndChûd
 );

5562 
	}
}

5567 
	$lﬂdAndGëChûdªnC⁄èöög
(

5568 
fuŒãxt_vèb
 *
v
,

5569 
sqlôe_öt64
 
iBlockid
,

5570 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5571 
sqlôe_öt64
 *
piSèπChûd
, sqlôe_öt64 *
piEndChûd


5573 
sqlôe4_°mt
 *
s
 = 
NULL
;

5574 
rc
;

5576 
	`as£π
–
iBlockid
!=0 );

5577 
	`as£π
–
pTîm
!=
NULL
 );

5578 
	`as£π
–
nTîm
!=0 );

5579 
	`as£π
–
piSèπChûd
!=
NULL
 );

5580 
	`as£π
–
piEndChûd
!=
NULL
 );

5582 
rc
 = 
	`sql_gë_°©emít
(
v
, 
BLOCK_SELECT_STMT
, &
s
);

5583 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5585 
rc
 = 
	`sqlôe4_böd_öt64
(
s
, 1, 
iBlockid
);

5586 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5588 
rc
 = 
	`sqlôe4_°ï
(
s
);

5589 if–
rc
==
SQLITE4_DONE
 )  
SQLITE4_ERROR
;

5590 if–
rc
!=
SQLITE4_ROW
 ) Ñc;

5592 
	`gëChûdªnC⁄èöög
(
	`sqlôe4_cﬁumn_blob
(
s
, 0), 
	`sqlôe4_cﬁumn_byãs
(s, 0),

5593 
pTîm
, 
nTîm
, 
isPªfix
, 
piSèπChûd
, 
piEndChûd
);

5598 
rc
 = 
	`sqlôe4_°ï
(
s
);

5599 if–
rc
==
SQLITE4_ROW
 )  
SQLITE4_ERROR
;

5600 if–
rc
!=
SQLITE4_DONE
 ) Ñc;

5602  
SQLITE4_OK
;

5603 
	}
}

5609 
	$lﬂdSegmítI¡
(
fuŒãxt_vèb
 *
v
, c⁄° *
pD©a
, 
nD©a
,

5610 
sqlôe_öt64
 
iLóvesEnd
,

5611 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5612 
D©aBuf„r
 *
out
){

5614 if–*
pD©a
=='\0' ){

5615  
	`lﬂdSegmítLóf
(
v
, 
pD©a
, 
nD©a
, 
pTîm
, 
nTîm
, 
isPªfix
, 
out
);

5617 
rc
;

5618 
sqlôe_öt64
 
iSèπChûd
, 
iEndChûd
;

5623 
	`gëChûdªnC⁄èöög
(
pD©a
, 
nD©a
, 
pTîm
, 
nTîm
, 
isPªfix
,

5624 &
iSèπChûd
, &
iEndChûd
);

5625  
iSèπChûd
>
iLóvesEnd
 ){

5626 
sqlôe_öt64
 
iNextSèπ
, 
iNextEnd
;

5627 
rc
 = 
	`lﬂdAndGëChûdªnC⁄èöög
(
v
, 
iSèπChûd
, 
pTîm
, 
nTîm
, 
isPªfix
,

5628 &
iNextSèπ
, &
iNextEnd
);

5629 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5632 if–
iSèπChûd
!=
iEndChûd
 ){

5633 
sqlôe_öt64
 
iDummy
;

5634 
rc
 = 
	`lﬂdAndGëChûdªnC⁄èöög
(
v
, 
iEndChûd
, 
pTîm
, 
nTîm
, 
isPªfix
,

5635 &
iDummy
, &
iNextEnd
);

5636 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5639 
	`as£π
–
iNextSèπ
<=
iNextEnd
 );

5640 
iSèπChûd
 = 
iNextSèπ
;

5641 
iEndChûd
 = 
iNextEnd
;

5643 
	`as£π
–
iSèπChûd
<=
iLóvesEnd
 );

5644 
	`as£π
–
iEndChûd
<=
iLóvesEnd
 );

5647  
	`lﬂdSegmítLóves
(
v
, 
iSèπChûd
, 
iEndChûd
,

5648 
pTîm
, 
nTîm
, 
isPªfix
, 
out
);

5650 
	}
}

5669 
	$lﬂdSegmít
(
fuŒãxt_vèb
 *
v
, c⁄° *
pD©a
, 
nD©a
,

5670 
sqlôe_öt64
 
iLóvesEnd
,

5671 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5672 
D©aBuf„r
 *
out
){

5673 
D©aBuf„r
 
ªsu…
;

5674 
rc
;

5676 
	`as£π
–
nD©a
>1 );

5679 
	`as£π
–
v
->
nPídögD©a
<0 );

5681 
	`d©aBuf„rInô
(&
ªsu…
, 0);

5682 
rc
 = 
	`lﬂdSegmítI¡
(
v
, 
pD©a
, 
nD©a
, 
iLóvesEnd
,

5683 
pTîm
, 
nTîm
, 
isPªfix
, &
ªsu…
);

5684 if–
rc
==
SQLITE4_OK
 && 
ªsu…
.
nD©a
>0 ){

5685 if–
out
->
nD©a
==0 ){

5686 
D©aBuf„r
 
tmp
 = *
out
;

5687 *
out
 = 
ªsu…
;

5688 
ªsu…
 = 
tmp
;

5690 
D©aBuf„r
 
mîged
;

5691 
DLRódî
 
ªadîs
[2];

5693 
	`dÃInô
(&
ªadîs
[0], 
DL_DEFAULT
, 
out
->
pD©a
, out->
nD©a
);

5694 
	`dÃInô
(&
ªadîs
[1], 
DL_DEFAULT
, 
ªsu…
.
pD©a
,Ñesu….
nD©a
);

5695 
	`d©aBuf„rInô
(&
mîged
, 
out
->
nD©a
+
ªsu…
.nData);

5696 
	`docLi°Mîge
(&
mîged
, 
ªadîs
, 2);

5697 
	`d©aBuf„rDe°roy
(
out
);

5698 *
out
 = 
mîged
;

5699 
	`dÃDe°roy
(&
ªadîs
[0]);

5700 
	`dÃDe°roy
(&
ªadîs
[1]);

5703 
	`d©aBuf„rDe°roy
(&
ªsu…
);

5704  
rc
;

5705 
	}
}

5710 
	$ãrmSñe˘
(
fuŒãxt_vèb
 *
v
, 
iCﬁumn
,

5711 c⁄° *
pTîm
, 
nTîm
, 
isPªfix
,

5712 
DocLi°Ty≥
 
iTy≥
, 
D©aBuf„r
 *
out
){

5713 
D©aBuf„r
 
do˛i°
;

5714 
sqlôe4_°mt
 *
s
;

5715 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SELECT_ALL_STMT
, &
s
);

5716 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5719 
	`as£π
–
v
->
nPídögD©a
<0 );

5721 
	`d©aBuf„rInô
(&
do˛i°
, 0);

5726  (
rc
 = 
	`sqlôe4_°ï
(
s
))==
SQLITE4_ROW
 ){

5727 c⁄° *
pD©a
 = 
	`sqlôe4_cﬁumn_blob
(
s
, 2);

5728 c⁄° 
nD©a
 = 
	`sqlôe4_cﬁumn_byãs
(
s
, 2);

5729 c⁄° 
sqlôe_öt64
 
iLóvesEnd
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 1);

5730 
rc
 = 
	`lﬂdSegmít
(
v
, 
pD©a
, 
nD©a
, 
iLóvesEnd
, 
pTîm
, 
nTîm
, 
isPªfix
,

5731 &
do˛i°
);

5732 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

5734 if–
rc
==
SQLITE4_DONE
 ){

5735 if–
do˛i°
.
nD©a
!=0 ){

5741 if–
iCﬁumn
==
v
->
nCﬁumn
) iColumn = -1;

5742 
	`docLi°Trim
(
DL_DEFAULT
, 
do˛i°
.
pD©a
, do˛i°.
nD©a
,

5743 
iCﬁumn
, 
iTy≥
, 
out
);

5745 
rc
 = 
SQLITE4_OK
;

5748 
îr
:

5749 
	`d©aBuf„rDe°roy
(&
do˛i°
);

5750  
rc
;

5751 
	}
}

5755 
	sTîmD©a
 {

5756 c⁄° *
	mpTîm
;

5757 
	mnTîm
;

5758 
DLCﬁÀ˘‹
 *
	mpCﬁÀ˘‹
;

5759 } 
	tTîmD©a
;

5764 
	$ãrmD©aCmp
(c⁄° *
av
, c⁄° *
bv
){

5765 c⁄° 
TîmD©a
 *
a
 = (c⁄° TîmD©®*)
av
;

5766 c⁄° 
TîmD©a
 *
b
 = (c⁄° TîmD©®*)
bv
;

5767 
n
 = 
a
->
nTîm
<
b
->nTerm ?á->nTerm : b->nTerm;

5768 
c
 = 
	`memcmp
(
a
->
pTîm
, 
b
->pTîm, 
n
);

5769 if–
c
!=0 )  c;

5770  
a
->
nTîm
-
b
->nTerm;

5771 
	}
}

5776 
	$wrôeZîoSegmít
(
fuŒãxt_vèb
 *
v
, 
·s2Hash
 *
pTîms
){

5777 
·s2HashEÀm
 *
e
;

5778 
idx
, 
rc
, 
i
, 
n
;

5779 
TîmD©a
 *
pD©a
;

5780 
LófWrôî
 
wrôî
;

5781 
D©aBuf„r
 
dl
;

5784 
rc
 = 
	`£gdúNextIndex
(
v
, 0, &
idx
);

5785 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5787 
n
 = 
	`·s2HashCou¡
(
pTîms
);

5788 
pD©a
 = 
	`sqlôe4_mÆloc
(
n
*(
TîmD©a
));

5790 
i
 = 0, 
e
 = 
	`·s2HashFú°
(
pTîms
);É; i++,É = 
	`·s2HashNext
(e)){

5791 
	`as£π
–
i
<
n
 );

5792 
pD©a
[
i
].
pTîm
 = 
	`·s2HashKey
(
e
);

5793 
pD©a
[
i
].
nTîm
 = 
	`·s2HashKeysize
(
e
);

5794 
pD©a
[
i
].
pCﬁÀ˘‹
 = 
	`·s2HashD©a
(
e
);

5796 
	`as£π
–
i
==
n
 );

5801 if–
n
>1 ) 
	`qs‹t
(
pD©a
,Ç, (*pD©a), 
ãrmD©aCmp
);

5806 
	`ÀafWrôîInô
(0, 
idx
, &
wrôî
);

5807 
	`d©aBuf„rInô
(&
dl
, 0);

5808 
i
=0; i<
n
; i++){

5809 
	`d©aBuf„rRe£t
(&
dl
);

5810 
	`dlcAddDo˛i°
(
pD©a
[
i
].
pCﬁÀ˘‹
, &
dl
);

5811 
rc
 = 
	`ÀafWrôîSãp
(
v
, &
wrôî
,

5812 
pD©a
[
i
].
pTîm
,ÖD©a[i].
nTîm
, 
dl
.pD©a, dl.
nD©a
);

5813 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

5815 
rc
 = 
	`ÀafWrôîFöÆize
(
v
, &
wrôî
);

5817 
îr
:

5818 
	`d©aBuf„rDe°roy
(&
dl
);

5819 
	`sqlôe4_‰ì
(
pD©a
);

5820 
	`ÀafWrôîDe°roy
(&
wrôî
);

5821  
rc
;

5822 
	}
}

5825 
	$˛órPídögTîms
(
fuŒãxt_vèb
 *
v
){

5826 if–
v
->
nPídögD©a
>=0 ){

5827 
·s2HashEÀm
 *
e
;

5828 
e
=
	`·s2HashFú°
(&
v
->
≥ndögTîms
);É;É=
	`·s2HashNext
(e)){

5829 
	`dlcDñëe
(
	`·s2HashD©a
(
e
));

5831 
	`·s2HashCÀ¨
(&
v
->
≥ndögTîms
);

5832 
v
->
nPídögD©a
 = -1;

5834  
SQLITE4_OK
;

5835 
	}
}

5840 
	$ÊushPídögTîms
(
fuŒãxt_vèb
 *
v
){

5841 if–
v
->
nPídögD©a
>=0 ){

5842 
rc
 = 
	`wrôeZîoSegmít
(
v
, &v->
≥ndögTîms
);

5843 if–
rc
==
SQLITE4_OK
 ) 
	`˛órPídögTîms
(
v
);

5844  
rc
;

5846  
SQLITE4_OK
;

5847 
	}
}

5852 
	$öôPídögTîms
(
fuŒãxt_vèb
 *
v
, 
sqlôe_öt64
 
iDocid
){

5859 if–
iDocid
<=
v
->
iPªvDocid
 || v->
nPídögD©a
>
kPídögThªshﬁd
 ){

5860 
rc
 = 
	`ÊushPídögTîms
(
v
);

5861 if–
rc
!=
SQLITE4_OK
 ) Ñc;

5863 if–
v
->
nPídögD©a
<0 ){

5864 
	`·s2HashInô
(&
v
->
≥ndögTîms
, 
FTS2_HASH_STRING
, 1);

5865 
v
->
nPídögD©a
 = 0;

5867 
v
->
iPªvDocid
 = 
iDocid
;

5868  
SQLITE4_OK
;

5869 
	}
}

5873 
	$fuŒãxtUpd©e
(
sqlôe4_vèb
 *
pVèb
, 
nArg
, 
sqlôe4_vÆue
 **
µArg
,

5874 
sqlôe_öt64
 *
pRowid
){

5875 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *Ë
pVèb
;

5876 
rc
;

5878 
	`TRACE
(("FTS2 Upd©ê%p\n", 
pVèb
));

5880 if–
nArg
<2 ){

5881 
rc
 = 
	`ödex_dñëe
(
v
, 
	`sqlôe4_vÆue_öt64
(
µArg
[0]));

5882 if–
rc
==
SQLITE4_OK
 ){

5886 
rc
 = 
	`c⁄ã¡_exi°s
(
v
);

5887 if–
rc
==
SQLITE4_ROW
 ){

5888 
rc
 = 
SQLITE4_OK
;

5889 }if–
rc
==
SQLITE4_DONE
 ){

5893 
rc
 = 
	`˛órPídögTîms
(
v
);

5894 if–
rc
==
SQLITE4_OK
 ){

5895 
rc
 = 
	`£gdú_dñëe_Æl
(
v
);

5899 } if–
	`sqlôe4_vÆue_ty≥
(
µArg
[0]Ë!
SQLITE4_NULL
 ){

5906 
sqlôe_öt64
 
rowid
 = 
	`sqlôe4_vÆue_öt64
(
µArg
[0]);

5907 if–
	`sqlôe4_vÆue_ty≥
(
µArg
[1]Ë!
SQLITE4_INTEGER
 ||

5908 
	`sqlôe4_vÆue_öt64
(
µArg
[1]Ë!
rowid
 ){

5909 
rc
 = 
SQLITE4_ERROR
;

5911 
	`as£π
–
nArg
==2+
v
->
nCﬁumn
+1);

5912 
rc
 = 
	`ödex_upd©e
(
v
, 
rowid
, &
µArg
[2]);

5920 
	`as£π
–
nArg
==2+
v
->
nCﬁumn
+1);

5921 
rc
 = 
	`ödex_ö£π
(
v
, 
µArg
[1], &µArg[2], 
pRowid
);

5924  
rc
;

5925 
	}
}

5927 
	$fuŒãxtSync
(
sqlôe4_vèb
 *
pVèb
){

5928 
	`TRACE
(("FTS2 xSync()\n"));

5929  
	`ÊushPídögTîms
((
fuŒãxt_vèb
 *)
pVèb
);

5930 
	}
}

5932 
	$fuŒãxtBegö
(
sqlôe4_vèb
 *
pVèb
){

5933 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *Ë
pVèb
;

5934 
	`TRACE
(("FTS2 xBegin()\n"));

5939 
	`as£π
–
v
->
nPídögD©a
<0 );

5940  
	`˛órPídögTîms
(
v
);

5941 
	}
}

5943 
	$fuŒãxtCommô
(
sqlôe4_vèb
 *
pVèb
){

5944 
fuŒãxt_vèb
 *
v
 = (fuŒãxt_vèb *Ë
pVèb
;

5945 
	`TRACE
(("FTS2 xCommit()\n"));

5948 
	`as£π
–
v
->
nPídögD©a
<0 );

5949  
	`˛órPídögTîms
(
v
);

5950 
	}
}

5952 
	$fuŒãxtRﬁlback
(
sqlôe4_vèb
 *
pVèb
){

5953 
	`TRACE
(("FTS2 xRollback()\n"));

5954  
	`˛órPídögTîms
((
fuŒãxt_vèb
 *)
pVèb
);

5955 
	}
}

5960 
	$¢ù≥tFunc
(

5961 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

5962 
¨gc
,

5963 
sqlôe4_vÆue
 **
¨gv


5965 
fuŒãxt_curs‹
 *
pCurs‹
;

5966 if–
¨gc
<1 ) ;

5967 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

5968 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

5969 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, "illegal firstárgumentÅo html_snippet",-1);

5971 c⁄° *
zSèπ
 = "<b>";

5972 c⁄° *
zEnd
 = "</b>";

5973 c⁄° *
zEŒùsis
 = "<b>...</b>";

5974 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

5975 if–
¨gc
>=2 ){

5976 
zSèπ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

5977 if–
¨gc
>=3 ){

5978 
zEnd
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[2]);

5979 if–
¨gc
>=4 ){

5980 
zEŒùsis
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[3]);

5984 
	`¢ù≥tAŒOff£ts
(
pCurs‹
);

5985 
	`¢ù≥tText
(
pCurs‹
, 
zSèπ
, 
zEnd
, 
zEŒùsis
);

5986 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, 
pCurs‹
->
¢ù≥t
.
zSnù≥t
,

5987 
pCurs‹
->
¢ù≥t
.
nSnù≥t
, 
SQLITE4_STATIC
);

5989 
	}
}

5994 
	$¢ù≥tOff£tsFunc
(

5995 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

5996 
¨gc
,

5997 
sqlôe4_vÆue
 **
¨gv


5999 
fuŒãxt_curs‹
 *
pCurs‹
;

6000 if–
¨gc
<1 ) ;

6001 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

6002 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

6003 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, "illegal firstárgumentÅo offsets",-1);

6005 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

6006 
	`¢ù≥tAŒOff£ts
(
pCurs‹
);

6007 
	`¢ù≥tOff£tText
(&
pCurs‹
->
¢ù≥t
);

6008 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
,

6009 
pCurs‹
->
¢ù≥t
.
zOff£t
,ÖCurs‹->¢ù≥t.
nOff£t
,

6010 
SQLITE4_STATIC
);

6012 
	}
}

6032 
	sO±LóvesRódî
 {

6034 
	m£gmít
;

6035 
LóvesRódî
 
	mªadî
;

6036 } 
	tO±LóvesRódî
;

6038 
	$›tLóvesRódîAtEnd
(
O±LóvesRódî
 *
pRódî
){

6039  
	`ÀavesRódîAtEnd
(&
pRódî
->
ªadî
);

6040 
	}
}

6041 
	$›tLóvesRódîTîmByãs
(
O±LóvesRódî
 *
pRódî
){

6042  
	`ÀavesRódîTîmByãs
(&
pRódî
->
ªadî
);

6043 
	}
}

6044 c⁄° *
	$›tLóvesRódîD©a
(
O±LóvesRódî
 *
pRódî
){

6045  
	`ÀavesRódîD©a
(&
pRódî
->
ªadî
);

6046 
	}
}

6047 
	$›tLóvesRódîD©aByãs
(
O±LóvesRódî
 *
pRódî
){

6048  
	`ÀavesRódîD©aByãs
(&
pRódî
->
ªadî
);

6049 
	}
}

6050 c⁄° *
	$›tLóvesRódîTîm
(
O±LóvesRódî
 *
pRódî
){

6051  
	`ÀavesRódîTîm
(&
pRódî
->
ªadî
);

6052 
	}
}

6053 
	$›tLóvesRódîSãp
(
fuŒãxt_vèb
 *
v
, 
O±LóvesRódî
 *
pRódî
){

6054  
	`ÀavesRódîSãp
(
v
, &
pRódî
->
ªadî
);

6055 
	}
}

6056 
	$›tLóvesRódîTîmCmp
(
O±LóvesRódî
 *
Ã1
, O±LóvesRódî *
Ã2
){

6057  
	`ÀavesRódîTîmCmp
(&
Ã1
->
ªadî
, &
Ã2
->reader);

6058 
	}
}

6062 
	$›tLóvesRódîCmp
(
O±LóvesRódî
 *
Ã1
, O±LóvesRódî *
Ã2
){

6063 
c
 = 
	`›tLóvesRódîTîmCmp
(
Ã1
, 
Ã2
);

6064 if–
c
!=0 )  c;

6065  
Ã1
->
£gmít
-
Ã2
->segment;

6066 
	}
}

6070 
	$›tLóvesRódîRe‹dî
(
O±LóvesRódî
 *
pLr
, 
nLr
){

6071  
nLr
>1 && 
	`›tLóvesRódîCmp
(
pLr
,ÖLr+1)>0 ){

6072 
O±LóvesRódî
 
tmp
 = 
pLr
[0];

6073 
pLr
[0] =ÖLr[1];

6074 
pLr
[1] = 
tmp
;

6075 
nLr
--;

6076 
pLr
++;

6078 
	}
}

6085 
	$›timizeI¡î«l
(
fuŒãxt_vèb
 *
v
,

6086 
O±LóvesRódî
 *
ªadîs
, 
nRódîs
,

6087 
LófWrôî
 *
pWrôî
){

6088 
i
, 
rc
 = 
SQLITE4_OK
;

6089 
D©aBuf„r
 
do˛i°
, 
mîged
, 
tmp
;

6092 
i
 = 
nRódîs
;

6093  
i
-- > 0 ){

6094 
	`›tLóvesRódîRe‹dî
(&
ªadîs
[
i
], 
nRódîs
-i);

6097 
	`d©aBuf„rInô
(&
do˛i°
, 
LEAF_MAX
);

6098 
	`d©aBuf„rInô
(&
mîged
, 
LEAF_MAX
);

6103  !
	`›tLóvesRódîAtEnd
(&
ªadîs
[0]) ){

6106 
i
=1; i<
nRódîs
 && !
	`›tLóvesRódîAtEnd
(&
ªadîs
[i]); i++){

6107 if–0!=
	`›tLóvesRódîTîmCmp
(&
ªadîs
[0], &ªadîs[
i
]) ) ;

6111 if–
i
==1 ){

6113 
	`d©aBuf„rRe£t
(&
mîged
);

6114 
	`docLi°Trim
(
DL_DEFAULT
,

6115 
	`›tLóvesRódîD©a
(&
ªadîs
[0]),

6116 
	`›tLóvesRódîD©aByãs
(&
ªadîs
[0]),

6117 -1, 
DL_DEFAULT
, &
mîged
);

6119 
DLRódî
 
dlRódîs
[
MERGE_COUNT
];

6120 
iRódî
, 
nRódîs
;

6125 
	`dÃInô
(&
dlRódîs
[0], 
DL_DEFAULT
,

6126 
	`›tLóvesRódîD©a
(&
ªadîs
[0]),

6127 
	`›tLóvesRódîD©aByãs
(&
ªadîs
[0]));

6128 
iRódî
 = 1;

6130 
	`as£π
–
iRódî
<
i
 );

6131  
iRódî
<
i
 ){

6133  
nRódîs
=1; 
iRódî
<
i
 &&ÇRódîs<
MERGE_COUNT
;

6134 
iRódî
++, 
nRódîs
++ ){

6135 
	`dÃInô
(&
dlRódîs
[
nRódîs
], 
DL_DEFAULT
,

6136 
	`›tLóvesRódîD©a
(&
ªadîs
[
iRódî
]),

6137 
	`›tLóvesRódîD©aByãs
(&
ªadîs
[
iRódî
]));

6141 
	`d©aBuf„rRe£t
(&
mîged
);

6142 
	`docLi°Mîge
(&
mîged
, 
dlRódîs
, 
nRódîs
);

6143 
tmp
 = 
mîged
;

6144 
mîged
 = 
do˛i°
;

6145 
do˛i°
 = 
tmp
;

6147  
nRódîs
-- > 0 ){

6148 
	`dÃDe°roy
(&
dlRódîs
[
nRódîs
]);

6152 
	`dÃInô
(&
dlRódîs
[0], 
DL_DEFAULT
, 
do˛i°
.
pD©a
, do˛i°.
nD©a
);

6156 
	`dÃDe°roy
(&
dlRódîs
[0]);

6159 
	`d©aBuf„rRe£t
(&
mîged
);

6160 
	`docLi°Trim
(
DL_DEFAULT
, 
do˛i°
.
pD©a
, do˛i°.
nD©a
,

6161 -1, 
DL_DEFAULT
, &
mîged
);

6165 if–
mîged
.
nD©a
>0 ){

6166 
rc
 = 
	`ÀafWrôîSãp
(
v
, 
pWrôî
,

6167 
	`›tLóvesRódîTîm
(&
ªadîs
[0]),

6168 
	`›tLóvesRódîTîmByãs
(&
ªadîs
[0]),

6169 
mîged
.
pD©a
, mîged.
nD©a
);

6170 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

6174  
i
-- > 0 ){

6175 
rc
 = 
	`›tLóvesRódîSãp
(
v
, &
ªadîs
[
i
]);

6176 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

6178 
	`›tLóvesRódîRe‹dî
(&
ªadîs
[
i
], 
nRódîs
-i);

6182 
îr
:

6183 
	`d©aBuf„rDe°roy
(&
do˛i°
);

6184 
	`d©aBuf„rDe°roy
(&
mîged
);

6185  
rc
;

6186 
	}
}

6192 
	$›timizeFunc
(
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

6193 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

6194 
fuŒãxt_curs‹
 *
pCurs‹
;

6195 if–
¨gc
>1 ){

6196 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, "excessárgumentsÅo optimize()",-1);

6197 }if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

6198 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

6199 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, "illegal firstárgumentÅo optimize",-1);

6201 
fuŒãxt_vèb
 *
v
;

6202 
i
, 
rc
, 
iMaxLevñ
;

6203 
O±LóvesRódî
 *
ªadîs
;

6204 
nRódîs
;

6205 
LófWrôî
 
wrôî
;

6206 
sqlôe4_°mt
 *
s
;

6208 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

6209 
v
 = 
	`curs‹_vèb
(
pCurs‹
);

6212 
rc
 = 
	`ÊushPídögTîms
(
v
);

6213 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

6215 
rc
 = 
	`£gdú_cou¡
(
v
, &
nRódîs
, &
iMaxLevñ
);

6216 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

6217 if–
nRódîs
==0 ||ÇReaders==1 ){

6218 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, "Indexálready optimal", -1,

6219 
SQLITE4_STATIC
);

6223 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SELECT_ALL_STMT
, &
s
);

6224 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

6226 
ªadîs
 = 
	`sqlôe4_mÆloc
(
nRódîs
*(readers[0]));

6227 if–
ªadîs
==
NULL
 ) 
îr
;

6232 
	`ÀafWrôîInô
(
iMaxLevñ
, 0, &
wrôî
);

6234 
i
 = 0;

6235  (
rc
 = 
	`sqlôe4_°ï
(
s
))==
SQLITE4_ROW
 ){

6236 
sqlôe_öt64
 
iSèπ
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

6237 
sqlôe_öt64
 
iEnd
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 1);

6238 c⁄° *
pRoŸD©a
 = 
	`sqlôe4_cﬁumn_blob
(
s
, 2);

6239 
nRoŸD©a
 = 
	`sqlôe4_cﬁumn_byãs
(
s
, 2);

6241 
	`as£π
–
i
<
nRódîs
 );

6242 
rc
 = 
	`ÀavesRódîInô
(
v
, -1, 
iSèπ
, 
iEnd
, 
pRoŸD©a
, 
nRoŸD©a
,

6243 &
ªadîs
[
i
].
ªadî
);

6244 if–
rc
!=
SQLITE4_OK
 ) ;

6246 
ªadîs
[
i
].
£gmít
 = i;

6247 
i
++;

6251 if–
rc
==
SQLITE4_DONE
 ){

6252 
	`as£π
–
i
==
nRódîs
 );

6253 
rc
 = 
	`›timizeI¡î«l
(
v
, 
ªadîs
, 
nRódîs
, &
wrôî
);

6256  
i
-- > 0 ){

6257 
	`ÀavesRódîDe°roy
(&
ªadîs
[
i
].
ªadî
);

6259 
	`sqlôe4_‰ì
(
ªadîs
);

6264 if–
rc
==
SQLITE4_OK
 ){

6265  
i
=0; i<=
iMaxLevñ
; i++ ){

6266 
rc
 = 
	`£gdú_dñëe
(
v
, 
i
);

6267 if–
rc
!=
SQLITE4_OK
 ) ;

6270 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`ÀafWrôîFöÆize
(
v
, &
wrôî
);

6273 
	`ÀafWrôîDe°roy
(&
wrôî
);

6275 if–
rc
!=
SQLITE4_OK
 ) 
îr
;

6277 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, "Index o±imized", -1, 
SQLITE4_STATIC
);

6283 
îr
:

6285 
buf
[512];

6286 
	`sqlôe4_¢¥ötf
((
buf
), buf, "Error in optimize: %s",

6287 
	`sqlôe4_îrmsg
(
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pC⁄ãxt
)));

6288 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, 
buf
, -1);

6291 
	}
}

6293 #ifde‡
SQLITE4_TEST


6297 
	$gíî©eEº‹
(
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

6298 c⁄° *
¥efix
, c⁄° *
msg
){

6299 
buf
[512];

6300 if–
msg
==
NULL
 ) msg = 
	`sqlôe4_îrmsg
(
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pC⁄ãxt
));

6301 
	`sqlôe4_¢¥ötf
((
buf
), buf, "%s: %s", 
¥efix
, 
msg
);

6302 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, 
buf
, -1);

6303 
	}
}

6311 
	$cﬁÀ˘SegmítTîms
(
fuŒãxt_vèb
 *
v
, 
sqlôe4_°mt
 *
s
,

6312 
·s2Hash
 *
pTîms
){

6313 c⁄° 
sqlôe_öt64
 
iSèπBlockid
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 0);

6314 c⁄° 
sqlôe_öt64
 
iEndBlockid
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 1);

6315 c⁄° *
pRoŸD©a
 = 
	`sqlôe4_cﬁumn_blob
(
s
, 2);

6316 c⁄° 
nRoŸD©a
 = 
	`sqlôe4_cﬁumn_byãs
(
s
, 2);

6317 
LóvesRódî
 
ªadî
;

6318 
rc
 = 
	`ÀavesRódîInô
(
v
, 0, 
iSèπBlockid
, 
iEndBlockid
,

6319 
pRoŸD©a
, 
nRoŸD©a
, &
ªadî
);

6320 if–
rc
!=
SQLITE4_OK
 ) Ñc;

6322  
rc
==
SQLITE4_OK
 && !
	`ÀavesRódîAtEnd
(&
ªadî
) ){

6323 c⁄° *
pTîm
 = 
	`ÀavesRódîTîm
(&
ªadî
);

6324 c⁄° 
nTîm
 = 
	`ÀavesRódîTîmByãs
(&
ªadî
);

6325 *
ﬁdVÆue
 = 
	`sqlôe4Fts2HashFöd
(
pTîms
, 
pTîm
, 
nTîm
);

6326 *
√wVÆue
 = (*)((*)
ﬁdVÆue
+1);

6331 if–
√wVÆue
==
	`sqlôe4Fts2HashIn£π
(
pTîms
, 
pTîm
, 
nTîm
,ÇewValue) ){

6332 
rc
 = 
SQLITE4_NOMEM
;

6334 
rc
 = 
	`ÀavesRódîSãp
(
v
, &
ªadî
);

6338 
	`ÀavesRódîDe°roy
(&
ªadî
);

6339  
rc
;

6340 
	}
}

6343 
	$gíî©eTîmsResu…
(
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
, 
·s2Hash
 *
pTîms
){

6344 
iTîm
, 
nTîms
, 
nResu…Byãs
, 
iByã
;

6345 *
ªsu…
;

6346 
TîmD©a
 *
pD©a
;

6347 
·s2HashEÀm
 *
e
;

6352 
nTîms
 = 
	`·s2HashCou¡
(
pTîms
);

6353 
	`as£π
–
nTîms
>0 );

6354 
pD©a
 = 
	`sqlôe4_mÆloc
(
nTîms
*(
TîmD©a
));

6355 if–
pD©a
==
NULL
 )  
SQLITE4_NOMEM
;

6357 
nResu…Byãs
 = 0;

6358 
iTîm
 = 0, 
e
 = 
	`·s2HashFú°
(
pTîms
);É; iTîm++,É = 
	`·s2HashNext
(e)){

6359 
nResu…Byãs
 +
	`·s2HashKeysize
(
e
)+1;

6360 
	`as£π
–
iTîm
<
nTîms
 );

6361 
pD©a
[
iTîm
].
pTîm
 = 
	`·s2HashKey
(
e
);

6362 
pD©a
[
iTîm
].
nTîm
 = 
	`·s2HashKeysize
(
e
);

6363 
pD©a
[
iTîm
].
pCﬁÀ˘‹
 = 
	`·s2HashD©a
(
e
);

6365 
	`as£π
–
iTîm
==
nTîms
 );

6367 
	`as£π
–
nResu…Byãs
>0 );

6368 
ªsu…
 = 
	`sqlôe4_mÆloc
(
nResu…Byãs
);

6369 if–
ªsu…
==
NULL
 ){

6370 
	`sqlôe4_‰ì
(
pD©a
);

6371  
SQLITE4_NOMEM
;

6374 if–
nTîms
>1 ) 
	`qs‹t
(
pD©a
,ÇTîms, (*pD©a), 
ãrmD©aCmp
);

6377 
iByã
 = 0;

6378 
iTîm
=0; iTîm<
nTîms
; ++iTerm){

6379 
	`mem˝y
(
ªsu…
+
iByã
, 
pD©a
[
iTîm
].
pTîm
,ÖD©a[iTîm].
nTîm
);

6380 
iByã
 +
pD©a
[
iTîm
].
nTîm
;

6381 
ªsu…
[
iByã
++] = ' ';

6383 
	`as£π
–
iByã
==
nResu…Byãs
 );

6384 
	`as£π
–
ªsu…
[
nResu…Byãs
-1]==' ' );

6385 
ªsu…
[
nResu…Byãs
-1] = '\0';

6388 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, 
ªsu…
, 
nResu…Byãs
-1, 
sqlôe4_‰ì
);

6389 
	`sqlôe4_‰ì
(
pD©a
);

6390  
SQLITE4_OK
;

6391 
	}
}

6400 
	$dumpTîmsFunc
(

6401 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

6402 
¨gc
, 
sqlôe4_vÆue
 **
¨gv


6404 
fuŒãxt_curs‹
 *
pCurs‹
;

6405 if–
¨gc
!=3 &&árgc!=1 ){

6406 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_terms", "incorrectárguments");

6407 }if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

6408 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

6409 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_terms", "illegal firstárgument");

6411 
fuŒãxt_vèb
 *
v
;

6412 
·s2Hash
 
ãrms
;

6413 
sqlôe4_°mt
 *
s
 = 
NULL
;

6414 
rc
;

6416 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

6417 
v
 = 
	`curs‹_vèb
(
pCurs‹
);

6422 if–
¨gc
==1 ){

6423 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SELECT_ALL_STMT
, &
s
);

6425 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SELECT_SEGMENT_STMT
, &
s
);

6426 if–
rc
==
SQLITE4_OK
 ){

6427 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 1, 
	`sqlôe4_vÆue_öt
(
¨gv
[1]));

6428 if–
rc
==
SQLITE4_OK
 ){

6429 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 2, 
	`sqlôe4_vÆue_öt
(
¨gv
[2]));

6434 if–
rc
!=
SQLITE4_OK
 ){

6435 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_ãrms", 
NULL
);

6440 
	`sqlôe4Fts2HashInô
(&
ãrms
, 
FTS2_HASH_STRING
, 1);

6441  (
rc
 = 
	`sqlôe4_°ï
(
s
))==
SQLITE4_ROW
 ){

6442 
rc
 = 
	`cﬁÀ˘SegmítTîms
(
v
, 
s
, &
ãrms
);

6443 if–
rc
!=
SQLITE4_OK
 ) ;

6446 if–
rc
!=
SQLITE4_DONE
 ){

6447 
	`sqlôe4_ª£t
(
s
);

6448 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_ãrms", 
NULL
);

6450 c⁄° 
nTîms
 = 
	`·s2HashCou¡
(&
ãrms
);

6451 if–
nTîms
>0 ){

6452 
rc
 = 
	`gíî©eTîmsResu…
(
pC⁄ãxt
, &
ãrms
);

6453 if–
rc
==
SQLITE4_NOMEM
 ){

6454 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_terms", "out of memory");

6456 
	`as£π
–
rc
==
SQLITE4_OK
 );

6458 }if–
¨gc
==3 ){

6460 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_terms", "segmentÇot found");

6467 
	`sqlôe4_ªsu…_nuŒ
(
pC⁄ãxt
);

6470 
	`sqlôe4Fts2HashCÀ¨
(&
ãrms
);

6472 
	}
}

6477 
	$¸óãDo˛i°Resu…
(
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

6478 c⁄° *
pD©a
, 
nD©a
){

6479 
D©aBuf„r
 
dump
;

6480 
DLRódî
 
dlRódî
;

6482 
	`as£π
–
pD©a
!=
NULL
 && 
nD©a
>0 );

6484 
	`d©aBuf„rInô
(&
dump
, 0);

6485 
	`dÃInô
(&
dlRódî
, 
DL_DEFAULT
, 
pD©a
, 
nD©a
);

6486  ; !
	`dÃAtEnd
(&
dlRódî
); 
	`dÃSãp
(&dlReader) ){

6487 
buf
[256];

6488 
PLRódî
 
∂Ródî
;

6490 
	`∂rInô
(&
∂Ródî
, &
dlRódî
);

6491 if–
DL_DEFAULT
==
DL_DOCIDS
 || 
	`∂rAtEnd
(&
∂Ródî
) ){

6492 
	`sqlôe4_¢¥ötf
((
buf
), buf, "[%Œd] ", 
	`dÃDocid
(&
dlRódî
));

6493 
	`d©aBuf„rAµíd
(&
dump
, 
buf
, 
	`°æí
(buf));

6495 
iCﬁumn
 = 
	`∂rCﬁumn
(&
∂Ródî
);

6497 
	`sqlôe4_¢¥ötf
((
buf
), buf, "[%lld %d[",

6498 
	`dÃDocid
(&
dlRódî
), 
iCﬁumn
);

6499 
	`d©aBuf„rAµíd
(&
dump
, 
buf
, 
	`°æí
(buf));

6501  ; !
	`∂rAtEnd
(&
∂Ródî
); 
	`∂rSãp
(&plReader) ){

6502 if–
	`∂rCﬁumn
(&
∂Ródî
)!=
iCﬁumn
 ){

6503 
iCﬁumn
 = 
	`∂rCﬁumn
(&
∂Ródî
);

6504 
	`sqlôe4_¢¥ötf
((
buf
), buf, "] %d[", 
iCﬁumn
);

6505 
	`as£π
–
dump
.
nD©a
>0 );

6506 
dump
.
nD©a
--;

6507 
	`as£π
–
dump
.
pD©a
[dump.
nD©a
]==' ');

6508 
	`d©aBuf„rAµíd
(&
dump
, 
buf
, 
	`°æí
(buf));

6510 if–
DL_DEFAULT
==
DL_POSITIONS_OFFSETS
 ){

6511 
	`sqlôe4_¢¥ötf
((
buf
), buf, "%d,%d,%d ",

6512 
	`∂rPosôi⁄
(&
∂Ródî
),

6513 
	`∂rSèπOff£t
(&
∂Ródî
), 
	`∂rEndOff£t
(&plReader));

6514 }if–
DL_DEFAULT
==
DL_POSITIONS
 ){

6515 
	`sqlôe4_¢¥ötf
((
buf
), buf, "%d ", 
	`∂rPosôi⁄
(&
∂Ródî
));

6517 
	`as£π
–
NULL
=="Unhandled DL_DEFAULT value");

6519 
	`d©aBuf„rAµíd
(&
dump
, 
buf
, 
	`°æí
(buf));

6521 
	`∂rDe°roy
(&
∂Ródî
);

6523 
	`as£π
–
dump
.
nD©a
>0 );

6524 
dump
.
nD©a
--;

6525 
	`as£π
–
dump
.
pD©a
[dump.
nD©a
]==' ');

6526 
	`d©aBuf„rAµíd
(&
dump
, "]] ", 3);

6529 
	`dÃDe°roy
(&
dlRódî
);

6531 
	`as£π
–
dump
.
nD©a
>0 );

6532 
dump
.
nD©a
--;

6533 
	`as£π
–
dump
.
pD©a
[dump.
nD©a
]==' ');

6534 
dump
.
pD©a
[dump.
nD©a
] = '\0';

6535 
	`as£π
–
dump
.
nD©a
>0 );

6538 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, 
dump
.
pD©a
, dump.
nD©a
, 
sqlôe4_‰ì
);

6539 
dump
.
pD©a
 = 
NULL
;

6540 
dump
.
nD©a
 = dump.
nC≠acôy
 = 0;

6541 
	}
}

6564 
	$dumpDo˛i°Func
(

6565 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

6566 
¨gc
, 
sqlôe4_vÆue
 **
¨gv


6568 
fuŒãxt_curs‹
 *
pCurs‹
;

6569 if–
¨gc
!=2 &&árgc!=4 ){

6570 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_doclist", "incorrectárguments");

6571 }if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])!=
SQLITE4_BLOB
 ||

6572 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])!=(
pCurs‹
) ){

6573 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_doclist", "illegal firstárgument");

6574 }if–
	`sqlôe4_vÆue_ãxt
(
¨gv
[1])==
NULL
 ||

6575 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1])[0]=='\0' ){

6576 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_doclist", "empty secondárgument");

6578 c⁄° *
pTîm
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

6579 c⁄° 
nTîm
 = 
	`°æí
(
pTîm
);

6580 
fuŒãxt_vèb
 *
v
;

6581 
rc
;

6582 
D©aBuf„r
 
do˛i°
;

6584 
	`mem˝y
(&
pCurs‹
, 
	`sqlôe4_vÆue_blob
(
¨gv
[0]), (pCursor));

6585 
v
 = 
	`curs‹_vèb
(
pCurs‹
);

6587 
	`d©aBuf„rInô
(&
do˛i°
, 0);

6592 if–
¨gc
==2 ){

6593 
rc
 = 
	`ãrmSñe˘
(
v
, v->
nCﬁumn
, 
pTîm
, 
nTîm
, 0, 
DL_DEFAULT
, &
do˛i°
);

6595 
sqlôe4_°mt
 *
s
 = 
NULL
;

6598 
rc
 = 
	`sql_gë_°©emít
(
v
, 
SEGDIR_SELECT_SEGMENT_STMT
, &
s
);

6599 if–
rc
==
SQLITE4_OK
 ){

6600 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 1, 
	`sqlôe4_vÆue_öt
(
¨gv
[2]));

6601 if–
rc
==
SQLITE4_OK
 ){

6602 
rc
 = 
	`sqlôe4_böd_öt
(
s
, 2, 
	`sqlôe4_vÆue_öt
(
¨gv
[3]));

6606 if–
rc
==
SQLITE4_OK
 ){

6607 
rc
 = 
	`sqlôe4_°ï
(
s
);

6609 if–
rc
==
SQLITE4_DONE
 ){

6610 
	`d©aBuf„rDe°roy
(&
do˛i°
);

6611 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_doclist", "segmentÇot found");

6616 if–
rc
==
SQLITE4_ROW
 ){

6617 c⁄° 
sqlôe_öt64
 
iLóvesEnd
 = 
	`sqlôe4_cﬁumn_öt64
(
s
, 1);

6618 c⁄° *
pD©a
 = 
	`sqlôe4_cﬁumn_blob
(
s
, 2);

6619 c⁄° 
nD©a
 = 
	`sqlôe4_cﬁumn_byãs
(
s
, 2);

6624 
rc
 = 
	`lﬂdSegmít
(
v
, 
pD©a
, 
nD©a
, 
iLóvesEnd
, 
pTîm
, 
nTîm
, 0,

6625 &
do˛i°
);

6626 if–
rc
==
SQLITE4_OK
 ){

6627 
rc
 = 
	`sqlôe4_°ï
(
s
);

6630 if–
rc
!=
SQLITE4_DONE
 ){

6631 
	`sqlôe4_ª£t
(
s
);

6632 
	`d©aBuf„rDe°roy
(&
do˛i°
);

6633 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_doclist", "invalid segdir");

6636 
rc
 = 
SQLITE4_OK
;

6641 
	`sqlôe4_ª£t
(
s
);

6644 if–
rc
==
SQLITE4_OK
 ){

6645 if–
do˛i°
.
nD©a
>0 ){

6646 
	`¸óãDo˛i°Resu…
(
pC⁄ãxt
, 
do˛i°
.
pD©a
, do˛i°.
nD©a
);

6653 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, "", 0, 
SQLITE4_STATIC
);

6655 }if–
rc
==
SQLITE4_NOMEM
 ){

6663 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_doclist", "out of memory");

6665 
	`gíî©eEº‹
(
pC⁄ãxt
, "dump_do˛i°", 
NULL
);

6668 
	`d©aBuf„rDe°roy
(&
do˛i°
);

6670 
	}
}

6677 
fuŒãxtFödFun˘i⁄
(

6678 
sqlôe4_vèb
 *
pVèb
,

6679 
nArg
,

6680 c⁄° *
zName
,

6681 (**
pxFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**),

6682 **
µArg


6684 if–
	`°rcmp
(
zName
,"snippet")==0 ){

6685 *
pxFunc
 = 
¢ù≥tFunc
;

6687 }if–
	`°rcmp
(
zName
,"offsets")==0 ){

6688 *
pxFunc
 = 
¢ù≥tOff£tsFunc
;

6690 }if–
	`°rcmp
(
zName
,"optimize")==0 ){

6691 *
pxFunc
 = 
›timizeFunc
;

6693 #ifde‡
SQLITE4_TEST


6698 }if–
	`°rcmp
(
zName
,"dump_terms")==0 ){

6700 *
pxFunc
 = 
dumpTîmsFunc
;

6702 }if–
	`°rcmp
(
zName
,"dump_doclist")==0 ){

6704 *
pxFunc
 = 
dumpDo˛i°Func
;

6709 
	}
}

6714 
	$fuŒãxtRíame
(

6715 
sqlôe4_vèb
 *
pVèb
,

6716 c⁄° *
zName


6718 
fuŒãxt_vèb
 *
p
 = (fuŒãxt_vèb *)
pVèb
;

6719 
rc
 = 
SQLITE4_NOMEM
;

6720 *
zSql
 = 
	`sqlôe4_m¥ötf
(

6724 , 
p
->
zDb
,Ö->
zName
, zName

6725 , 
p
->
zDb
,Ö->
zName
, zName

6726 , 
p
->
zDb
,Ö->
zName
, zName

6728 if–
zSql
 ){

6729 
rc
 = 
	`sqlôe4_exec
(
p
->
db
, 
zSql
, 0, 0, 0);

6730 
	`sqlôe4_‰ì
(
zSql
);

6732  
rc
;

6733 
	}
}

6735 c⁄° 
sqlôe4_moduÀ
 
	g·s2ModuÀ
 = {

6737  
fuŒãxtCª©e
,

6738  
fuŒãxtC⁄√˘
,

6739  
fuŒãxtBe°Index
,

6740  
fuŒãxtDisc⁄√˘
,

6741  
fuŒãxtDe°roy
,

6742  
fuŒãxtO≥n
,

6743  
fuŒãxtClo£
,

6744  
fuŒãxtFûãr
,

6745  
fuŒãxtNext
,

6746  
fuŒãxtEof
,

6747  
fuŒãxtCﬁumn
,

6748  
fuŒãxtRowid
,

6749  
fuŒãxtUpd©e
,

6750  
fuŒãxtBegö
,

6751  
fuŒãxtSync
,

6752  
fuŒãxtCommô
,

6753  
fuŒãxtRﬁlback
,

6754  
fuŒãxtFödFun˘i⁄
,

6755  
fuŒãxtRíame
,

6758 
	$hashDe°roy
(*
p
){

6759 
·s2Hash
 *
pHash
 = (·s2Hash *)
p
;

6760 
	`sqlôe4Fts2HashCÀ¨
(
pHash
);

6761 
	`sqlôe4_‰ì
(
pHash
);

6762 
	}
}

6775 
sqlôe4Fts2Sim∂eTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

6776 
sqlôe4Fts2P‹ãrTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

6777 
sqlôe4Fts2IcuTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

6779 
sqlôe4Fts2InôHashTabÀ
(
sqlôe4
 *, 
·s2Hash
 *, const *);

6787 
	$sqlôe4Fts2Inô
(
sqlôe4
 *
db
){

6788 
rc
 = 
SQLITE4_OK
;

6789 
·s2Hash
 *
pHash
 = 0;

6790 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pSim∂e
 = 0;

6791 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pP‹ãr
 = 0;

6792 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pIcu
 = 0;

6794 
	`sqlôe4Fts2Sim∂eTokíizîModuÀ
(&
pSim∂e
);

6795 
	`sqlôe4Fts2P‹ãrTokíizîModuÀ
(&
pP‹ãr
);

6796 #ifde‡
SQLITE4_ENABLE_ICU


6797 
	`sqlôe4Fts2IcuTokíizîModuÀ
(&
pIcu
);

6801 
pHash
 = 
	`sqlôe4_mÆloc
((
·s2Hash
));

6802 if–!
pHash
 ){

6803 
rc
 = 
SQLITE4_NOMEM
;

6805 
	`sqlôe4Fts2HashInô
(
pHash
, 
FTS2_HASH_STRING
, 1);

6809 if–
rc
==
SQLITE4_OK
 ){

6810 if–
	`sqlôe4Fts2HashIn£π
(
pHash
, "sim∂e", 7, (*)
pSim∂e
)

6811 || 
	`sqlôe4Fts2HashIn£π
(
pHash
, "p‹ãr", 7, (*)
pP‹ãr
)

6812 || (
pIcu
 && 
	`sqlôe4Fts2HashIn£π
(
pHash
, "icu", 4, (*)pIcu))

6814 
rc
 = 
SQLITE4_NOMEM
;

6822 if–
SQLITE4_OK
==
rc


6823 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4Fts2InôHashTabÀ
(
db
, 
pHash
, "fts2_tokenizer"))

6824 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "snippet", -1))

6825 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "offsets", -1))

6826 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "optimize", -1))

6827 #ifde‡
SQLITE4_TEST


6828 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "dump_terms", -1))

6829 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "dump_doclist", -1))

6832  
	`sqlôe4_¸óã_moduÀ_v2
(

6833 
db
, "·s2", &
·s2ModuÀ
, (*)
pHash
, 
hashDe°roy


6838 
	`as£π
–
rc
!=
SQLITE4_OK
 );

6839 if–
pHash
 ){

6840 
	`sqlôe4Fts2HashCÀ¨
(
pHash
);

6841 
	`sqlôe4_‰ì
(
pHash
);

6843  
rc
;

6844 
	}
}

6846 #i‡!
SQLITE4_CORE


6847 
	$sqlôe4_exãnsi⁄_öô
(

6848 
sqlôe4
 *
db
,

6849 **
pzEºMsg
,

6850 c⁄° 
sqlôe4_≠i_routöes
 *
pApi


6852 
	`SQLITE4_EXTENSION_INIT2
(
pApi
)

6853  
	`sqlôe4Fts2Inô
(
db
);

6854 
	}
}

	@ext/fts2/fts2.h

16 
	~"sqlôe4.h
"

18 #ifde‡
__˝lu•lus


22 
sqlôe4Fts2Inô
(
sqlôe4
 *
db
);

24 #ifde‡
__˝lu•lus


	@ext/fts2/fts2_hash.c

26 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)

28 
	~<as£π.h
>

29 
	~<°dlib.h
>

30 
	~<°rög.h
>

32 
	~"sqlôe4.h
"

33 
	~"·s2_hash.h
"

38 *
	$·s2HashMÆloc
(
n
){

39 *
p
 = 
	`sqlôe4_mÆloc
(
n
);

40 if–
p
 ){

41 
	`mem£t
(
p
, 0, 
n
);

43  
p
;

44 
	}
}

45 
	$·s2HashFªe
(*
p
){

46 
	`sqlôe4_‰ì
(
p
);

47 
	}
}

59 
	$sqlôe4Fts2HashInô
(
·s2Hash
 *
pNew
, 
keyCœss
, 
c›yKey
){

60 
	`as£π
–
pNew
!=0 );

61 
	`as£π
–
keyCœss
>=
FTS2_HASH_STRING
 && keyCœss<=
FTS2_HASH_BINARY
 );

62 
pNew
->
keyCœss
 = keyClass;

63 
pNew
->
c›yKey
 = copyKey;

64 
pNew
->
fú°
 = 0;

65 
pNew
->
cou¡
 = 0;

66 
pNew
->
htsize
 = 0;

67 
pNew
->
ht
 = 0;

68 
	}
}

74 
	$sqlôe4Fts2HashCÀ¨
(
·s2Hash
 *
pH
){

75 
·s2HashEÀm
 *
ñem
;

77 
	`as£π
–
pH
!=0 );

78 
ñem
 = 
pH
->
fú°
;

79 
pH
->
fú°
 = 0;

80 
	`·s2HashFªe
(
pH
->
ht
);

81 
pH
->
ht
 = 0;

82 
pH
->
htsize
 = 0;

83  
ñem
 ){

84 
·s2HashEÀm
 *
√xt_ñem
 = 
ñem
->
√xt
;

85 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

86 
	`·s2HashFªe
(
ñem
->
pKey
);

88 
	`·s2HashFªe
(
ñem
);

89 
ñem
 = 
√xt_ñem
;

91 
pH
->
cou¡
 = 0;

92 
	}
}

97 
	$°rHash
(c⁄° *
pKey
, 
nKey
){

98 c⁄° *
z
 = (c⁄° *)
pKey
;

99 
h
 = 0;

100 if–
nKey
<=0 )ÇKey = (Ë
	`°æí
(
z
);

101  
nKey
 > 0 ){

102 
h
 = (h<<3Ë^ h ^ *
z
++;

103 
nKey
--;

105  
h
 & 0x7fffffff;

106 
	}
}

107 
	$°rCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

108 if–
n1
!=
n2
 )  1;

109  
	`°∫cmp
((c⁄° *)
pKey1
,(c⁄° *)
pKey2
,
n1
);

110 
	}
}

115 
	$böHash
(c⁄° *
pKey
, 
nKey
){

116 
h
 = 0;

117 c⁄° *
z
 = (c⁄° *)
pKey
;

118  
nKey
-- > 0 ){

119 
h
 = (h<<3Ë^ h ^ *(
z
++);

121  
h
 & 0x7fffffff;

122 
	}
}

123 
	$böCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

124 if–
n1
!=
n2
 )  1;

125  
	`memcmp
(
pKey1
,
pKey2
,
n1
);

126 
	}
}

140 (*
	$hashFun˘i⁄
(
keyCœss
))(const *,){

141 if–
keyCœss
==
FTS2_HASH_STRING
 ){

142  &
°rHash
;

144 
	`as£π
–
keyCœss
==
FTS2_HASH_BINARY
 );

145  &
böHash
;

147 
	}
}

155 (*
	$com∑ªFun˘i⁄
(
keyCœss
))(const *,,const *,){

156 if–
keyCœss
==
FTS2_HASH_STRING
 ){

157  &
°rCom∑ª
;

159 
	`as£π
–
keyCœss
==
FTS2_HASH_BINARY
 );

160  &
böCom∑ª
;

162 
	}
}

166 
	$ö£πEÀmít
(

167 
·s2Hash
 *
pH
,

168 
_·s2ht
 *
pE¡ry
,

169 
·s2HashEÀm
 *
pNew


171 
·s2HashEÀm
 *
pHód
;

172 
pHód
 = 
pE¡ry
->
chaö
;

173 if–
pHód
 ){

174 
pNew
->
√xt
 = 
pHód
;

175 
pNew
->
¥ev
 = 
pHód
->prev;

176 if–
pHód
->
¥ev
 ){ÖHód->¥ev->
√xt
 = 
pNew
; }

177 { 
pH
->
fú°
 = 
pNew
; }

178 
pHód
->
¥ev
 = 
pNew
;

180 
pNew
->
√xt
 = 
pH
->
fú°
;

181 if–
pH
->
fú°
 ){ÖH->fú°->
¥ev
 = 
pNew
; }

182 
pNew
->
¥ev
 = 0;

183 
pH
->
fú°
 = 
pNew
;

185 
pE¡ry
->
cou¡
++;

186 
pE¡ry
->
chaö
 = 
pNew
;

187 
	}
}

194 
	$ªhash
(
·s2Hash
 *
pH
, 
√w_size
){

195 
_·s2ht
 *
√w_ht
;

196 
·s2HashEÀm
 *
ñem
, *
√xt_ñem
;

197 (*
xHash
)(const *,);

199 
	`as£π
–(
√w_size
 & (new_size-1))==0 );

200 
√w_ht
 = (
_·s2ht
 *)
	`·s2HashMÆloc
–
√w_size
*(_fts2ht) );

201 if–
√w_ht
==0 ) ;

202 
	`·s2HashFªe
(
pH
->
ht
);

203 
pH
->
ht
 = 
√w_ht
;

204 
pH
->
htsize
 = 
√w_size
;

205 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

206 
ñem
=
pH
->
fú°
,ÖH->fú°=0;ÉÀm;ÉÀm = 
√xt_ñem
){

207 
h
 = (*
xHash
)(
ñem
->
pKey
,ÉÀm->
nKey
Ë& (
√w_size
-1);

208 
√xt_ñem
 = 
ñem
->
√xt
;

209 
	`ö£πEÀmít
(
pH
, &
√w_ht
[
h
], 
ñem
);

211 
	}
}

217 
·s2HashEÀm
 *
	$födEÀmítGivíHash
(

218 c⁄° 
·s2Hash
 *
pH
,

219 c⁄° *
pKey
,

220 
nKey
,

221 
h


223 
·s2HashEÀm
 *
ñem
;

224 
cou¡
;

225 (*
xCom∑ª
)(const *,,const *,);

227 if–
pH
->
ht
 ){

228 
_·s2ht
 *
pE¡ry
 = &
pH
->
ht
[
h
];

229 
ñem
 = 
pE¡ry
->
chaö
;

230 
cou¡
 = 
pE¡ry
->count;

231 
xCom∑ª
 = 
	`com∑ªFun˘i⁄
(
pH
->
keyCœss
);

232  
cou¡
-- && 
ñem
 ){

233 if–(*
xCom∑ª
)(
ñem
->
pKey
,ñem->
nKey
,pKey,nKey)==0 ){

234  
ñem
;

236 
ñem
 =ÉÀm->
√xt
;

240 
	}
}

245 
	$ªmoveEÀmítGivíHash
(

246 
·s2Hash
 *
pH
,

247 
·s2HashEÀm
* 
ñem
,

248 
h


250 
_·s2ht
 *
pE¡ry
;

251 if–
ñem
->
¥ev
 ){

252 
ñem
->
¥ev
->
√xt
 =Élem->next;

254 
pH
->
fú°
 = 
ñem
->
√xt
;

256 if–
ñem
->
√xt
 ){

257 
ñem
->
√xt
->
¥ev
 =Élem->prev;

259 
pE¡ry
 = &
pH
->
ht
[
h
];

260 if–
pE¡ry
->
chaö
==
ñem
 ){

261 
pE¡ry
->
chaö
 = 
ñem
->
√xt
;

263 
pE¡ry
->
cou¡
--;

264 if–
pE¡ry
->
cou¡
<=0 ){

265 
pE¡ry
->
chaö
 = 0;

267 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

268 
	`·s2HashFªe
(
ñem
->
pKey
);

270 
	`·s2HashFªe
–
ñem
 );

271 
pH
->
cou¡
--;

272 if–
pH
->
cou¡
<=0 ){

273 
	`as£π
–
pH
->
fú°
==0 );

274 
	`as£π
–
pH
->
cou¡
==0 );

275 
	`·s2HashCÀ¨
(
pH
);

277 
	}
}

283 *
	$sqlôe4Fts2HashFöd
(c⁄° 
·s2Hash
 *
pH
, c⁄° *
pKey
, 
nKey
){

284 
h
;

285 
·s2HashEÀm
 *
ñem
;

286 (*
xHash
)(const *,);

288 if–
pH
==0 ||ÖH->
ht
==0 )  0;

289 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

290 
	`as£π
–
xHash
!=0 );

291 
h
 = (*
xHash
)(
pKey
,
nKey
);

292 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

293 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
, 
h
 & (pH->
htsize
-1));

294  
ñem
 ?ÉÀm->
d©a
 : 0;

295 
	}
}

312 *
	$sqlôe4Fts2HashIn£π
(

313 
·s2Hash
 *
pH
,

314 c⁄° *
pKey
,

315 
nKey
,

316 *
d©a


318 
høw
;

319 
h
;

320 
·s2HashEÀm
 *
ñem
;

321 
·s2HashEÀm
 *
√w_ñem
;

322 (*
xHash
)(const *,);

324 
	`as£π
–
pH
!=0 );

325 
xHash
 = 
	`hashFun˘i⁄
(
pH
->
keyCœss
);

326 
	`as£π
–
xHash
!=0 );

327 
høw
 = (*
xHash
)(
pKey
, 
nKey
);

328 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

329 
h
 = 
høw
 & (
pH
->
htsize
-1);

330 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
,
h
);

331 if–
ñem
 ){

332 *
ﬁd_d©a
 = 
ñem
->
d©a
;

333 if–
d©a
==0 ){

334 
	`ªmoveEÀmítGivíHash
(
pH
,
ñem
,
h
);

336 
ñem
->
d©a
 = data;

338  
ﬁd_d©a
;

340 if–
d©a
==0 )  0;

341 
√w_ñem
 = (
·s2HashEÀm
*)
	`·s2HashMÆloc
( (fts2HashElem) );

342 if–
√w_ñem
==0 )  
d©a
;

343 if–
pH
->
c›yKey
 && 
pKey
!=0 ){

344 
√w_ñem
->
pKey
 = 
	`·s2HashMÆloc
–
nKey
 );

345 if–
√w_ñem
->
pKey
==0 ){

346 
	`·s2HashFªe
(
√w_ñem
);

347  
d©a
;

349 
	`mem˝y
((*)
√w_ñem
->
pKey
,ÖKey, 
nKey
);

351 
√w_ñem
->
pKey
 = (*)pKey;

353 
√w_ñem
->
nKey
 =ÇKey;

354 
pH
->
cou¡
++;

355 if–
pH
->
htsize
==0 ){

356 
	`ªhash
(
pH
,8);

357 if–
pH
->
htsize
==0 ){

358 
pH
->
cou¡
 = 0;

359 
	`·s2HashFªe
(
√w_ñem
);

360  
d©a
;

363 if–
pH
->
cou¡
 >ÖH->
htsize
 ){

364 
	`ªhash
(
pH
,pH->
htsize
*2);

366 
	`as£π
–
pH
->
htsize
>0 );

367 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

368 
h
 = 
høw
 & (
pH
->
htsize
-1);

369 
	`ö£πEÀmít
(
pH
, &pH->
ht
[
h
], 
√w_ñem
);

370 
√w_ñem
->
d©a
 = data;

372 
	}
}

	@ext/fts2/fts2_hash.h

17 #i‚de‡
_FTS2_HASH_H_


18 
	#_FTS2_HASH_H_


	)

21 
·s2Hash
 
	t·s2Hash
;

22 
·s2HashEÀm
 
	t·s2HashEÀm
;

32 
	s·s2Hash
 {

33 
	mkeyCœss
;

34 
	mc›yKey
;

35 
	mcou¡
;

36 
·s2HashEÀm
 *
	mfú°
;

37 
	mhtsize
;

38 
	s_·s2ht
 {

39 
	mcou¡
;

40 
·s2HashEÀm
 *
	mchaö
;

41 } *
	mht
;

50 
	s·s2HashEÀm
 {

51 
·s2HashEÀm
 *
	m√xt
, *
	m¥ev
;

52 *
	md©a
;

53 *
	mpKey
; 
	mnKey
;

68 
	#FTS2_HASH_STRING
 1

	)

69 
	#FTS2_HASH_BINARY
 2

	)

74 
sqlôe4Fts2HashInô
(
·s2Hash
*, 
keyty≥
, 
c›yKey
);

75 *
sqlôe4Fts2HashIn£π
(
·s2Hash
*, c⁄° *
pKey
, 
nKey
, *
pD©a
);

76 *
sqlôe4Fts2HashFöd
(c⁄° 
·s2Hash
*, c⁄° *
pKey
, 
nKey
);

77 
sqlôe4Fts2HashCÀ¨
(
·s2Hash
*);

82 
	#·s2HashInô
 
sqlôe4Fts2HashInô


	)

83 
	#·s2HashIn£π
 
sqlôe4Fts2HashIn£π


	)

84 
	#·s2HashFöd
 
sqlôe4Fts2HashFöd


	)

85 
	#·s2HashCÀ¨
 
sqlôe4Fts2HashCÀ¨


	)

99 
	#·s2HashFú°
(
H
Ë((H)->
fú°
)

	)

100 
	#·s2HashNext
(
E
Ë((E)->
√xt
)

	)

101 
	#·s2HashD©a
(
E
Ë((E)->
d©a
)

	)

102 
	#·s2HashKey
(
E
Ë((E)->
pKey
)

	)

103 
	#·s2HashKeysize
(
E
Ë((E)->
nKey
)

	)

108 
	#·s2HashCou¡
(
H
Ë((H)->
cou¡
)

	)

	@ext/fts2/fts2_icu.c

17 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)

18 #ifde‡
SQLITE4_ENABLE_ICU


20 
	~<as£π.h
>

21 
	~<°rög.h
>

22 
	~"·s2_tokíizî.h
"

24 
	~<unicode/ubrk.h
>

25 
	~<unicode/ucﬁ.h
>

26 
	~<unicode/u°rög.h
>

27 
	~<unicode/utf16.h
>

29 
IcuTokíizî
 
	tIcuTokíizî
;

30 
IcuCurs‹
 
	tIcuCurs‹
;

32 
	sIcuTokíizî
 {

33 
sqlôe4_tokíizî
 
	mba£
;

34 *
	mzLoˇÀ
;

37 
	sIcuCurs‹
 {

38 
sqlôe4_tokíizî_curs‹
 
	mba£
;

40 
UBªakIãøt‹
 *
	mpIãr
;

41 
	mnCh¨
;

42 
UCh¨
 *
	maCh¨
;

43 *
	maOff£t
;

45 
	mnBuf„r
;

46 *
	mzBuf„r
;

48 
	miTokí
;

54 
	$icuCª©e
(

55 
¨gc
,

56 c⁄° * c⁄° *
¨gv
,

57 
sqlôe4_tokíizî
 **
µTokíizî


59 
IcuTokíizî
 *
p
;

60 
n
 = 0;

62 if–
¨gc
>0 ){

63 
n
 = 
	`°æí
(
¨gv
[0])+1;

65 
p
 = (
IcuTokíizî
 *)
	`sqlôe4_mÆloc
((IcuTokíizî)+
n
);

66 if–!
p
 ){

67  
SQLITE4_NOMEM
;

69 
	`mem£t
(
p
, 0, (
IcuTokíizî
));

71 if–
n
 ){

72 
p
->
zLoˇÀ
 = (*)&p[1];

73 
	`mem˝y
(
p
->
zLoˇÀ
, 
¨gv
[0], 
n
);

76 *
µTokíizî
 = (
sqlôe4_tokíizî
 *)
p
;

78  
SQLITE4_OK
;

79 
	}
}

84 
	$icuDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

85 
IcuTokíizî
 *
p
 = (IcuTokíizî *)
pTokíizî
;

86 
	`sqlôe4_‰ì
(
p
);

87  
SQLITE4_OK
;

88 
	}
}

96 
	$icuO≥n
(

97 
sqlôe4_tokíizî
 *
pTokíizî
,

98 c⁄° *
zI≈ut
,

99 
nI≈ut
,

100 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


102 
IcuTokíizî
 *
p
 = (IcuTokíizî *)
pTokíizî
;

103 
IcuCurs‹
 *
pC§
;

105 c⁄° 
öt32_t
 
›t
 = 
U_FOLD_CASE_DEFAULT
;

106 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

107 
nCh¨
;

109 
UCh¨32
 
c
;

110 
iI≈ut
 = 0;

111 
iOut
 = 0;

113 *
µCurs‹
 = 0;

115 if–
nI≈ut
<0 ){

116 
nI≈ut
 = 
	`°æí
(
zI≈ut
);

118 
nCh¨
 = 
nI≈ut
+1;

119 
pC§
 = (
IcuCurs‹
 *)
	`sqlôe4_mÆloc
(

120 (
IcuCurs‹
) +

121 
nCh¨
 * (
UCh¨
) +

122 (
nCh¨
+1) * ()

124 if–!
pC§
 ){

125  
SQLITE4_NOMEM
;

127 
	`mem£t
(
pC§
, 0, (
IcuCurs‹
));

128 
pC§
->
aCh¨
 = (
UCh¨
 *)&pCsr[1];

129 
pC§
->
aOff£t
 = (*)&pC§->
aCh¨
[
nCh¨
];

131 
pC§
->
aOff£t
[
iOut
] = 
iI≈ut
;

132 
	`U8_NEXT
(
zI≈ut
, 
iI≈ut
, 
nI≈ut
, 
c
);

133  
c
>0 ){

134 
isEº‹
 = 0;

135 
c
 = 
	`u_fﬁdCa£
(c, 
›t
);

136 
	`U16_APPEND
(
pC§
->
aCh¨
, 
iOut
, 
nCh¨
, 
c
, 
isEº‹
);

137 if–
isEº‹
 ){

138 
	`sqlôe4_‰ì
(
pC§
);

139  
SQLITE4_ERROR
;

141 
pC§
->
aOff£t
[
iOut
] = 
iI≈ut
;

143 if–
iI≈ut
<
nI≈ut
 ){

144 
	`U8_NEXT
(
zI≈ut
, 
iI≈ut
, 
nI≈ut
, 
c
);

146 
c
 = 0;

150 
pC§
->
pIãr
 = 
	`ubrk_›í
(
UBRK_WORD
, 
p
->
zLoˇÀ
,ÖC§->
aCh¨
, 
iOut
, &
°©us
);

151 if–!
	`U_SUCCESS
(
°©us
) ){

152 
	`sqlôe4_‰ì
(
pC§
);

153  
SQLITE4_ERROR
;

155 
pC§
->
nCh¨
 = 
iOut
;

157 
	`ubrk_fú°
(
pC§
->
pIãr
);

158 *
µCurs‹
 = (
sqlôe4_tokíizî_curs‹
 *)
pC§
;

159  
SQLITE4_OK
;

160 
	}
}

165 
	$icuClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

166 
IcuCurs‹
 *
pC§
 = (IcuCurs‹ *)
pCurs‹
;

167 
	`ubrk_˛o£
(
pC§
->
pIãr
);

168 
	`sqlôe4_‰ì
(
pC§
->
zBuf„r
);

169 
	`sqlôe4_‰ì
(
pC§
);

170  
SQLITE4_OK
;

171 
	}
}

176 
	$icuNext
(

177 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

178 c⁄° **
µTokí
,

179 *
≤Byãs
,

180 *
piSèπOff£t
,

181 *
piEndOff£t
,

182 *
piPosôi⁄


184 
IcuCurs‹
 *
pC§
 = (IcuCurs‹ *)
pCurs‹
;

186 
iSèπ
 = 0;

187 
iEnd
 = 0;

188 
nByã
 = 0;

190  
iSèπ
==
iEnd
 ){

191 
UCh¨32
 
c
;

193 
iSèπ
 = 
	`ubrk_cuºít
(
pC§
->
pIãr
);

194 
iEnd
 = 
	`ubrk_√xt
(
pC§
->
pIãr
);

195 if–
iEnd
==
UBRK_DONE
 ){

196  
SQLITE4_DONE
;

199  
iSèπ
<
iEnd
 ){

200 
iWhôe
 = 
iSèπ
;

201 
	`U8_NEXT
(
pC§
->
aCh¨
, 
iWhôe
,ÖC§->
nCh¨
, 
c
);

202 if–
	`u_is•a˚
(
c
) ){

203 
iSèπ
 = 
iWhôe
;

208 
	`as£π
(
iSèπ
<=
iEnd
);

212 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

213 if–
nByã
 ){

214 *
zNew
 = 
	`sqlôe4_ªÆloc
(
pC§
->
zBuf„r
, 
nByã
);

215 if–!
zNew
 ){

216  
SQLITE4_NOMEM
;

218 
pC§
->
zBuf„r
 = 
zNew
;

219 
pC§
->
nBuf„r
 = 
nByã
;

222 
	`u_°rToUTF8
(

223 
pC§
->
zBuf„r
,ÖC§->
nBuf„r
, &
nByã
,

224 &
pC§
->
aCh¨
[
iSèπ
], 
iEnd
-iStart,

225 &
°©us


227 }  
nByã
>
pC§
->
nBuf„r
 );

229 *
µTokí
 = 
pC§
->
zBuf„r
;

230 *
≤Byãs
 = 
nByã
;

231 *
piSèπOff£t
 = 
pC§
->
aOff£t
[
iSèπ
];

232 *
piEndOff£t
 = 
pC§
->
aOff£t
[
iEnd
];

233 *
piPosôi⁄
 = 
pC§
->
iTokí
++;

235  
SQLITE4_OK
;

236 
	}
}

241 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gicuTokíizîModuÀ
 = {

243 
icuCª©e
,

244 
icuDe°roy
,

245 
icuO≥n
,

246 
icuClo£
,

247 
icuNext
,

253 
	$sqlôe4Fts2IcuTokíizîModuÀ
(

254 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


256 *
µModuÀ
 = &
icuTokíizîModuÀ
;

257 
	}
}

	@ext/fts2/fts2_porter.c

25 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)

28 
	~<as£π.h
>

29 
	~<°dlib.h
>

30 
	~<°dio.h
>

31 
	~<°rög.h
>

33 
	~"·s2_tokíizî.h
"

38 
	sp‹ãr_tokíizî
 {

39 
sqlôe4_tokíizî
 
	mba£
;

40 } 
	tp‹ãr_tokíizî
;

45 
	sp‹ãr_tokíizî_curs‹
 {

46 
sqlôe4_tokíizî_curs‹
 
	mba£
;

47 c⁄° *
	mzI≈ut
;

48 
	mnI≈ut
;

49 
	miOff£t
;

50 
	miTokí
;

51 *
	mzTokí
;

52 
	mnAŒoˇãd
;

53 } 
	tp‹ãr_tokíizî_curs‹
;

57 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gp‹ãrTokíizîModuÀ
;

63 
	$p‹ãrCª©e
(

64 
¨gc
, c⁄° * c⁄° *
¨gv
,

65 
sqlôe4_tokíizî
 **
µTokíizî


67 
p‹ãr_tokíizî
 *
t
;

68 
t
 = (
p‹ãr_tokíizî
 *Ë
	`sqlôe4_mÆloc
((*t));

69 if–
t
==
NULL
 )  
SQLITE4_NOMEM
;

70 
	`mem£t
(
t
, 0, (*t));

71 *
µTokíizî
 = &
t
->
ba£
;

72  
SQLITE4_OK
;

73 
	}
}

78 
	$p‹ãrDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

79 
	`sqlôe4_‰ì
(
pTokíizî
);

80  
SQLITE4_OK
;

81 
	}
}

89 
	$p‹ãrO≥n
(

90 
sqlôe4_tokíizî
 *
pTokíizî
,

91 c⁄° *
zI≈ut
, 
nI≈ut
,

92 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


94 
p‹ãr_tokíizî_curs‹
 *
c
;

96 
c
 = (
p‹ãr_tokíizî_curs‹
 *Ë
	`sqlôe4_mÆloc
((*c));

97 if–
c
==
NULL
 )  
SQLITE4_NOMEM
;

99 
c
->
zI≈ut
 = zInput;

100 if–
zI≈ut
==0 ){

101 
c
->
nI≈ut
 = 0;

102 }if–
nI≈ut
<0 ){

103 
c
->
nI≈ut
 = ()
	`°æí
(
zI≈ut
);

105 
c
->
nI≈ut
 =ÇInput;

107 
c
->
iOff£t
 = 0;

108 
c
->
iTokí
 = 0;

109 
c
->
zTokí
 = 
NULL
;

110 
c
->
nAŒoˇãd
 = 0;

112 *
µCurs‹
 = &
c
->
ba£
;

113  
SQLITE4_OK
;

114 
	}
}

120 
	$p‹ãrClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

121 
p‹ãr_tokíizî_curs‹
 *
c
 = (p‹ãr_tokíizî_curs‹ *Ë
pCurs‹
;

122 
	`sqlôe4_‰ì
(
c
->
zTokí
);

123 
	`sqlôe4_‰ì
(
c
);

124  
SQLITE4_OK
;

125 
	}
}

129 c⁄° 
	gcTy≥
[] = {

147 
isVowñ
(const *);

148 
	$isC⁄s⁄™t
(c⁄° *
z
){

149 
j
;

150 
x
 = *
z
;

151 if–
x
==0 )  0;

152 
	`as£π
–
x
>='a' && x<='z' );

153 
j
 = 
cTy≥
[
x
-'a'];

154 if–
j
<2 )  j;

155  
z
[1]==0 || 
	`isVowñ
(z + 1);

156 
	}
}

157 
	$isVowñ
(c⁄° *
z
){

158 
j
;

159 
x
 = *
z
;

160 if–
x
==0 )  0;

161 
	`as£π
–
x
>='a' && x<='z' );

162 
j
 = 
cTy≥
[
x
-'a'];

163 if–
j
<2 )  1-j;

164  
	`isC⁄s⁄™t
(
z
 + 1);

165 
	}
}

186 
	$m_gt_0
(c⁄° *
z
){

187  
	`isVowñ
(
z
) ){ z++; }

188 if–*
z
==0 )  0;

189  
	`isC⁄s⁄™t
(
z
) ){ z++; }

190  *
z
!=0;

191 
	}
}

196 
	$m_eq_1
(c⁄° *
z
){

197  
	`isVowñ
(
z
) ){ z++; }

198 if–*
z
==0 )  0;

199  
	`isC⁄s⁄™t
(
z
) ){ z++; }

200 if–*
z
==0 )  0;

201  
	`isVowñ
(
z
) ){ z++; }

202 if–*
z
==0 )  1;

203  
	`isC⁄s⁄™t
(
z
) ){ z++; }

204  *
z
==0;

205 
	}
}

210 
	$m_gt_1
(c⁄° *
z
){

211  
	`isVowñ
(
z
) ){ z++; }

212 if–*
z
==0 )  0;

213  
	`isC⁄s⁄™t
(
z
) ){ z++; }

214 if–*
z
==0 )  0;

215  
	`isVowñ
(
z
) ){ z++; }

216 if–*
z
==0 )  0;

217  
	`isC⁄s⁄™t
(
z
) ){ z++; }

218  *
z
!=0;

219 
	}
}

224 
	$hasVowñ
(c⁄° *
z
){

225  
	`isC⁄s⁄™t
(
z
) ){ z++; }

226  *
z
!=0;

227 
	}
}

235 
	$doubÀC⁄s⁄™t
(c⁄° *
z
){

236  
	`isC⁄s⁄™t
(
z
) && z[0]==z[1] && isConsonant(z+1);

237 
	}
}

247 
	$°¨_oh
(c⁄° *
z
){

249 
z
[0]!=0 && 
	`isC⁄s⁄™t
(z) &&

250 
z
[0]!='w' && z[0]!='x' && z[0]!='y' &&

251 
z
[1]!=0 && 
	`isVowñ
(z+1) &&

252 
z
[2]!=0 && 
	`isC⁄s⁄™t
(z+2);

253 
	}
}

267 
°em
(

268 **
pz
,

269 c⁄° *
zFrom
,

270 c⁄° *
zTo
,

271 (*
xC⁄d
)(const *)

273 *
z
 = *
pz
;

274  *
zFrom
 && *zFrom==*
z
 ){ z++; zFrom++; }

275 if–*
zFrom
!=0 )  0;

276 if–
xC⁄d
 && !
	`xC⁄d
(
z
) )  1;

277  *
zTo
 ){

278 *(--
z
Ë*(
zTo
++);

280 *
pz
 = 
z
;

282 
	}
}

292 
	$c›y_°emmî
(c⁄° *
zIn
, 
nIn
, *
zOut
, *
≤Out
){

293 
i
, 
mx
, 
j
;

294 
hasDigô
 = 0;

295 
i
=0; i<
nIn
; i++){

296 
c
 = 
zIn
[
i
];

297 if–
c
>='A' && c<='Z' ){

298 
zOut
[
i
] = 
c
 - 'A' + 'a';

300 if–
c
>='0' && c<='9' ) 
hasDigô
 = 1;

301 
zOut
[
i
] = 
c
;

304 
mx
 = 
hasDigô
 ? 3 : 10;

305 if–
nIn
>
mx
*2 ){

306 
j
=
mx
, 
i
=
nIn
-mx; i<nIn; i++, j++){

307 
zOut
[
j
] = zOut[
i
];

309 
i
 = 
j
;

311 
zOut
[
i
] = 0;

312 *
≤Out
 = 
i
;

313 
	}
}

339 
	$p‹ãr_°emmî
(c⁄° *
zIn
, 
nIn
, *
zOut
, *
≤Out
){

340 
i
, 
j
, 
c
;

341 
zRevî£
[28];

342 *
z
, *
z2
;

343 if–
nIn
<3 ||ÇIn>=(
zRevî£
)-7 ){

346 
	`c›y_°emmî
(
zIn
, 
nIn
, 
zOut
, 
≤Out
);

349 
i
=0, 
j
=(
zRevî£
)-6; i<
nIn
; i++, j--){

350 
c
 = 
zIn
[
i
];

351 if–
c
>='A' && c<='Z' ){

352 
zRevî£
[
j
] = 
c
 + 'a' - 'A';

353 }if–
c
>='a' && c<='z' ){

354 
zRevî£
[
j
] = 
c
;

358 
	`c›y_°emmî
(
zIn
, 
nIn
, 
zOut
, 
≤Out
);

362 
	`mem£t
(&
zRevî£
[(zReverse)-5], 0, 5);

363 
z
 = &
zRevî£
[
j
+1];

367 if–
z
[0]=='s' ){

369 !
	`°em
(&
z
, "sess", "ss", 0) &&

370 !
	`°em
(&
z
, "sei", "i", 0) &&

371 !
	`°em
(&
z
, "ss", "ss", 0)

373 
z
++;

378 
z2
 = 
z
;

379 if–
	`°em
(&
z
, "dì", "ì", 
m_gt_0
) ){

382 (
	`°em
(&
z
, "gni", "", 
hasVowñ
) || stem(&z, "de", "", hasVowel))

383 && 
z
!=
z2


385 if–
	`°em
(&
z
, "ta", "ate", 0) ||

386 
	`°em
(&
z
, "lb", "ble", 0) ||

387 
	`°em
(&
z
, "zi", "ize", 0) ){

389 }if–
	`doubÀC⁄s⁄™t
(
z
) && (*z!='l' && *z!='s' && *z!='z') ){

390 
z
++;

391 }if–
	`m_eq_1
(
z
Ë&& 
	`°¨_oh
(z) ){

392 *(--
z
) = 'e';

397 if–
z
[0]=='y' && 
	`hasVowñ
(z+1) ){

398 
z
[0] = 'i';

402  
z
[1] ){

404 
	`°em
(&
z
, "œnoôa", "©e", 
m_gt_0
) ||

405 
	`°em
(&
z
, "œnoô", "ti⁄", 
m_gt_0
);

408 
	`°em
(&
z
, "i˙e", "í˚", 
m_gt_0
) ||

409 
	`°em
(&
z
, "i˙a", "™˚", 
m_gt_0
);

412 
	`°em
(&
z
, "ªzi", "ize", 
m_gt_0
);

415 
	`°em
(&
z
, "igﬁ", "log", 
m_gt_0
);

418 
	`°em
(&
z
, "ûb", "bÀ", 
m_gt_0
) ||

419 
	`°em
(&
z
, "ûœ", "Æ", 
m_gt_0
) ||

420 
	`°em
(&
z
, "ûäe", "ít", 
m_gt_0
) ||

421 
	`°em
(&
z
, "ûe", "e", 
m_gt_0
) ||

422 
	`°em
(&
z
, "ûsuo", "ous", 
m_gt_0
);

425 
	`°em
(&
z
, "noôazi", "ize", 
m_gt_0
) ||

426 
	`°em
(&
z
, "noôa", "©e", 
m_gt_0
) ||

427 
	`°em
(&
z
, "rŸa", "©e", 
m_gt_0
);

430 
	`°em
(&
z
, "msûa", "Æ", 
m_gt_0
) ||

431 
	`°em
(&
z
, "s£√vi", "ive", 
m_gt_0
) ||

432 
	`°em
(&
z
, "s£∆uf", "ful", 
m_gt_0
) ||

433 
	`°em
(&
z
, "s£nsuo", "ous", 
m_gt_0
);

436 
	`°em
(&
z
, "ôûa", "Æ", 
m_gt_0
) ||

437 
	`°em
(&
z
, "ôivi", "ive", 
m_gt_0
) ||

438 
	`°em
(&
z
, "ôûib", "bÀ", 
m_gt_0
);

443  
z
[0] ){

445 
	`°em
(&
z
, "ëaci", "ic", 
m_gt_0
) ||

446 
	`°em
(&
z
, "evôa", "", 
m_gt_0
) ||

447 
	`°em
(&
z
, "ezûa", "Æ", 
m_gt_0
);

450 
	`°em
(&
z
, "ôici", "ic", 
m_gt_0
);

453 
	`°em
(&
z
, "œci", "ic", 
m_gt_0
) ||

454 
	`°em
(&
z
, "luf", "", 
m_gt_0
);

457 
	`°em
(&
z
, "s£n", "", 
m_gt_0
);

462  
z
[1] ){

464 if–
z
[0]=='l' && 
	`m_gt_1
(z+2) ){

465 
z
 += 2;

469 if–
z
[0]=='e' && z[2]=='n' && (z[3]=='a' || z[3]=='e'Ë&& 
	`m_gt_1
(z+4) ){

470 
z
 += 4;

474 if–
z
[0]=='r' && 
	`m_gt_1
(z+2) ){

475 
z
 += 2;

479 if–
z
[0]=='c' && 
	`m_gt_1
(z+2) ){

480 
z
 += 2;

484 if–
z
[0]=='e' && z[2]=='b' && (z[3]=='a' || z[3]=='i'Ë&& 
	`m_gt_1
(z+4) ){

485 
z
 += 4;

489 if–
z
[0]=='t' ){

490 if–
z
[2]=='a' ){

491 if–
	`m_gt_1
(
z
+3) ){

492 
z
 += 3;

494 }if–
z
[2]=='e' ){

495 
	`°em
(&
z
, "äeme", "", 
m_gt_1
) ||

496 
	`°em
(&
z
, "äem", "", 
m_gt_1
) ||

497 
	`°em
(&
z
, "äe", "", 
m_gt_1
);

502 if–
z
[0]=='u' ){

503 if–
	`m_gt_1
(
z
+2) ){

504 
z
 += 2;

506 }if–
z
[3]=='s' || z[3]=='t' ){

507 
	`°em
(&
z
, "noi", "", 
m_gt_1
);

511 if–
z
[0]=='m' && z[2]=='i' && 
	`m_gt_1
(z+3) ){

512 
z
 += 3;

516 
	`°em
(&
z
, "ëa", "", 
m_gt_1
) ||

517 
	`°em
(&
z
, "ôi", "", 
m_gt_1
);

520 if–
z
[0]=='s' && z[2]=='o' && 
	`m_gt_1
(z+3) ){

521 
z
 += 3;

526 if–
z
[0]=='e' && z[2]=='i' && 
	`m_gt_1
(z+3) ){

527 
z
 += 3;

533 if–
z
[0]=='e' ){

534 if–
	`m_gt_1
(
z
+1) ){

535 
z
++;

536 }if–
	`m_eq_1
(
z
+1Ë&& !
	`°¨_oh
(z+1) ){

537 
z
++;

542 if–
	`m_gt_1
(
z
) && z[0]=='l' && z[1]=='l' ){

543 
z
++;

549 *
≤Out
 = 
i
 = 
	`°æí
(
z
);

550 
zOut
[
i
] = 0;

551  *
z
 ){

552 
zOut
[--
i
] = *(
z
++);

554 
	}
}

562 c⁄° 
	gp‹ãrIdCh¨
[] = {

570 
	#isDñim
(
C
Ë(((
ch
=C)&0x80)==0 && (ch<0x30 || !
p‹ãrIdCh¨
[ch-0x30]))

	)

576 
	$p‹ãrNext
(

577 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

578 c⁄° **
pzTokí
,

579 *
≤Byãs
,

580 *
piSèπOff£t
,

581 *
piEndOff£t
,

582 *
piPosôi⁄


584 
p‹ãr_tokíizî_curs‹
 *
c
 = (p‹ãr_tokíizî_curs‹ *Ë
pCurs‹
;

585 c⁄° *
z
 = 
c
->
zI≈ut
;

587  
c
->
iOff£t
<c->
nI≈ut
 ){

588 
iSèπOff£t
, 
ch
;

591  
c
->
iOff£t
<c->
nI≈ut
 && 
	`isDñim
(
z
[c->iOffset]) ){

592 
c
->
iOff£t
++;

596 
iSèπOff£t
 = 
c
->
iOff£t
;

597  
c
->
iOff£t
<c->
nI≈ut
 && !
	`isDñim
(
z
[c->iOffset]) ){

598 
c
->
iOff£t
++;

601 if–
c
->
iOff£t
>
iSèπOff£t
 ){

602 
n
 = 
c
->
iOff£t
-
iSèπOff£t
;

603 if–
n
>
c
->
nAŒoˇãd
 ){

604 
c
->
nAŒoˇãd
 = 
n
+20;

605 
c
->
zTokí
 = 
	`sqlôe4_ªÆloc
(c->zTokí, c->
nAŒoˇãd
);

606 if–
c
->
zTokí
==
NULL
 )  
SQLITE4_NOMEM
;

608 
	`p‹ãr_°emmî
(&
z
[
iSèπOff£t
], 
n
, 
c
->
zTokí
, 
≤Byãs
);

609 *
pzTokí
 = 
c
->
zTokí
;

610 *
piSèπOff£t
 = 
iSèπOff£t
;

611 *
piEndOff£t
 = 
c
->
iOff£t
;

612 *
piPosôi⁄
 = 
c
->
iTokí
++;

613  
SQLITE4_OK
;

616  
SQLITE4_DONE
;

617 
	}
}

622 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gp‹ãrTokíizîModuÀ
 = {

624 
p‹ãrCª©e
,

625 
p‹ãrDe°roy
,

626 
p‹ãrO≥n
,

627 
p‹ãrClo£
,

628 
p‹ãrNext
,

635 
	$sqlôe4Fts2P‹ãrTokíizîModuÀ
(

636 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


638 *
µModuÀ
 = &
p‹ãrTokíizîModuÀ
;

639 
	}
}

	@ext/fts2/fts2_tokenizer.c

26 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)

29 
	~"sqlôe4.h
"

30 
	~"sqlôe4ext.h
"

31 
	gSQLITE4_EXTENSION_INIT1


33 
	~"·s2_hash.h
"

34 
	~"·s2_tokíizî.h
"

35 
	~<as£π.h
>

57 
	$sˇœrFunc
(

58 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

59 
¨gc
,

60 
sqlôe4_vÆue
 **
¨gv


62 
·s2Hash
 *
pHash
;

63 *
pPå
 = 0;

64 c⁄° *
zName
;

65 
nName
;

67 
	`as£π
–
¨gc
==1 ||árgc==2 );

69 
pHash
 = (
·s2Hash
 *)
	`sqlôe4_u£r_d©a
(
c⁄ãxt
);

71 
zName
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

72 
nName
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])+1;

74 if–
¨gc
==2 ){

75 *
pOld
;

76 
n
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[1]);

77 if–
n
!=(
pPå
) ){

78 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "argumentÅype mismatch", -1);

81 
pPå
 = *(**)
	`sqlôe4_vÆue_blob
(
¨gv
[1]);

82 
pOld
 = 
	`sqlôe4Fts2HashIn£π
(
pHash
, (*)
zName
, 
nName
, 
pPå
);

83 if–
pOld
==
pPå
 ){

84 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "out of memory", -1);

88 
pPå
 = 
	`sqlôe4Fts2HashFöd
(
pHash
, 
zName
, 
nName
);

89 if–!
pPå
 ){

90 *
zEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
zName
);

91 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

92 
	`sqlôe4_‰ì
(
zEº
);

97 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, (*)&
pPå
, ’På), 
SQLITE4_TRANSIENT
);

98 
	}
}

100 #ifde‡
SQLITE4_TEST


102 
	~<t˛.h
>

103 
	~<°rög.h
>

131 
	$ã°Func
(

132 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

133 
¨gc
,

134 
sqlôe4_vÆue
 **
¨gv


136 
·s2Hash
 *
pHash
;

137 
sqlôe4_tokíizî_moduÀ
 *
p
;

138 
sqlôe4_tokíizî
 *
pTokíizî
 = 0;

139 
sqlôe4_tokíizî_curs‹
 *
pC§
 = 0;

141 c⁄° *
zEº
 = 0;

143 c⁄° *
zName
;

144 
nName
;

145 c⁄° *
zI≈ut
;

146 
nI≈ut
;

148 c⁄° *
zArg
 = 0;

150 c⁄° *
zTokí
;

151 
nTokí
;

152 
iSèπ
;

153 
iEnd
;

154 
iPos
;

156 
T˛_Obj
 *
pRë
;

158 
	`as£π
–
¨gc
==2 ||árgc==3 );

160 
nName
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[0]);

161 
zName
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

162 
nI≈ut
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[
¨gc
-1]);

163 
zI≈ut
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[
¨gc
-1]);

165 if–
¨gc
==3 ){

166 
zArg
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

169 
pHash
 = (
·s2Hash
 *)
	`sqlôe4_u£r_d©a
(
c⁄ãxt
);

170 
p
 = (
sqlôe4_tokíizî_moduÀ
 *)
	`sqlôe4Fts2HashFöd
(
pHash
, 
zName
, 
nName
+1);

172 if–!
p
 ){

173 *
zEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
zName
);

174 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

175 
	`sqlôe4_‰ì
(
zEº
);

179 
pRë
 = 
	`T˛_NewObj
();

180 
	`T˛_In¸RefCou¡
(
pRë
);

182 if–
SQLITE4_OK
!=
p
->
	`xCª©e
(
zArg
 ? 1 : 0, &zArg, &
pTokíizî
) ){

183 
zEº
 = "error in xCreate()";

184 
föish
;

186 
pTokíizî
->
pModuÀ
 = 
p
;

187 if–
SQLITE4_OK
!=
p
->
	`xO≥n
(
pTokíizî
, 
zI≈ut
, 
nI≈ut
, &
pC§
) ){

188 
zEº
 = "error in xOpen()";

189 
föish
;

191 
pC§
->
pTokíizî
 =ÖTokenizer;

193  
SQLITE4_OK
==
p
->
	`xNext
(
pC§
, &
zTokí
, &
nTokí
, &
iSèπ
, &
iEnd
, &
iPos
) ){

194 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewI¡Obj
(
iPos
));

195 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewSåögObj
(
zTokí
, 
nTokí
));

196 
zTokí
 = &
zI≈ut
[
iSèπ
];

197 
nTokí
 = 
iEnd
-
iSèπ
;

198 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewSåögObj
(
zTokí
, 
nTokí
));

201 if–
SQLITE4_OK
!=
p
->
	`xClo£
(
pC§
) ){

202 
zEº
 = "error in xClose()";

203 
föish
;

205 if–
SQLITE4_OK
!=
p
->
	`xDe°roy
(
pTokíizî
) ){

206 
zEº
 = "error in xDestroy()";

207 
föish
;

210 
föish
:

211 if–
zEº
 ){

212 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

214 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
	`T˛_GëSåög
(
pRë
), -1, 
SQLITE4_TRANSIENT
);

216 
	`T˛_De¸RefCou¡
(
pRë
);

217 
	}
}

220 
	$ªgi°îTokíizî
(

221 
sqlôe4
 *
db
,

222 *
zName
,

223 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
p


225 
rc
;

226 
sqlôe4_°mt
 *
pStmt
;

227 c⁄° 
zSql
[] = "SELECT fts2_tokenizer(?, ?)";

229 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, 0);

230 if–
rc
!=
SQLITE4_OK
 ){

231  
rc
;

234 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zName
, -1, 
SQLITE4_STATIC
);

235 
	`sqlôe4_böd_blob
(
pStmt
, 2, &
p
, ’), 
SQLITE4_STATIC
);

236 
	`sqlôe4_°ï
(
pStmt
);

238  
	`sqlôe4_föÆize
(
pStmt
);

239 
	}
}

242 
	$quîyFts2Tokíizî
(

243 
sqlôe4
 *
db
,

244 *
zName
,

245 c⁄° 
sqlôe4_tokíizî_moduÀ
 **
µ


247 
rc
;

248 
sqlôe4_°mt
 *
pStmt
;

249 c⁄° 
zSql
[] = "SELECT fts2_tokenizer(?)";

251 *
µ
 = 0;

252 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, 0);

253 if–
rc
!=
SQLITE4_OK
 ){

254  
rc
;

257 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zName
, -1, 
SQLITE4_STATIC
);

258 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

259 if–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0)==
SQLITE4_BLOB
 ){

260 
	`mem˝y
(
µ
, 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0), (*pp));

264  
	`sqlôe4_föÆize
(
pStmt
);

265 
	}
}

267 
sqlôe4Fts2Sim∂eTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

287 
	$ötTe°Func
(

288 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

289 
¨gc
,

290 
sqlôe4_vÆue
 **
¨gv


292 
rc
;

293 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
p1
;

294 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
p2
;

295 
sqlôe4
 *
db
 = (sqlôe4 *)
	`sqlôe4_u£r_d©a
(
c⁄ãxt
);

298 
	`sqlôe4Fts2Sim∂eTokíizîModuÀ
(&
p1
);

299 
rc
 = 
	`quîyFts2Tokíizî
(
db
, "sim∂e", &
p2
);

300 
	`as£π
–
rc
==
SQLITE4_OK
 );

301 
	`as£π
–
p1
==
p2
 );

302 
rc
 = 
	`quîyFts2Tokíizî
(
db
, "nosuchtokíizî", &
p2
);

303 
	`as£π
–
rc
==
SQLITE4_ERROR
 );

304 
	`as£π
–
p2
==0 );

305 
	`as£π
–0==
	`°rcmp
(
	`sqlôe4_îrmsg
(
db
), "unknownÅokenizer:Çosuchtokenizer") );

308 
rc
 = 
	`ªgi°îTokíizî
(
db
, "nosuchtokíizî", 
p1
);

309 
	`as£π
–
rc
==
SQLITE4_OK
 );

310 
rc
 = 
	`quîyFts2Tokíizî
(
db
, "nosuchtokíizî", &
p2
);

311 
	`as£π
–
rc
==
SQLITE4_OK
 );

312 
	`as£π
–
p2
==
p1
 );

314 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, "ok", -1, 
SQLITE4_STATIC
);

315 
	}
}

336 
	$sqlôe4Fts2InôHashTabÀ
(

337 
sqlôe4
 *
db
,

338 
·s2Hash
 *
pHash
,

339 c⁄° *
zName


341 
rc
 = 
SQLITE4_OK
;

342 *
p
 = (*)
pHash
;

343 c⁄° 
™y
 = 
SQLITE4_ANY
;

344 *
zTe°
 = 0;

345 *
zTe°2
 = 0;

347 #ifde‡
SQLITE4_TEST


348 *
pdb
 = (*)
db
;

349 
zTe°
 = 
	`sqlôe4_m¥ötf
("%s_ã°", 
zName
);

350 
zTe°2
 = 
	`sqlôe4_m¥ötf
("%s_öã∫Æ_ã°", 
zName
);

351 if–!
zTe°
 || !
zTe°2
 ){

352 
rc
 = 
SQLITE4_NOMEM
;

356 if–
rc
!=
SQLITE4_OK


357 || (
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zName
, 1, 
™y
, 
p
, 
sˇœrFunc
, 0, 0))

358 || (
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zName
, 2, 
™y
, 
p
, 
sˇœrFunc
, 0, 0))

359 #ifde‡
SQLITE4_TEST


360 || (
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zTe°
, 2, 
™y
, 
p
, 
ã°Func
, 0, 0))

361 || (
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zTe°
, 3, 
™y
, 
p
, 
ã°Func
, 0, 0))

362 || (
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zTe°2
, 0, 
™y
, 
pdb
, 
ötTe°Func
, 0, 0))

366 
	`sqlôe4_‰ì
(
zTe°
);

367 
	`sqlôe4_‰ì
(
zTe°2
);

368  
rc
;

369 
	}
}

	@ext/fts2/fts2_tokenizer.h

20 #i‚de‡
_FTS2_TOKENIZER_H_


21 
	#_FTS2_TOKENIZER_H_


	)

27 
	~"sqlôe4.h
"

48 
sqlôe4_tokíizî_moduÀ
 
	tsqlôe4_tokíizî_moduÀ
;

49 
sqlôe4_tokíizî
 
	tsqlôe4_tokíizî
;

50 
sqlôe4_tokíizî_curs‹
 
	tsqlôe4_tokíizî_curs‹
;

52 
	ssqlôe4_tokíizî_moduÀ
 {

57 
	miVîsi⁄
;

76 (*
	mxCª©e
)(

77 
	m¨gc
,

78 c⁄° *c⁄°*
	m¨gv
,

79 
sqlôe4_tokíizî
 **
	mµTokíizî


86 (*
	mxDe°roy
)(
sqlôe4_tokíizî
 *
	mpTokíizî
);

93 (*
	mxO≥n
)(

94 
sqlôe4_tokíizî
 *
	mpTokíizî
,

95 c⁄° *
	mpI≈ut
, 
	mnByãs
,

96 
sqlôe4_tokíizî_curs‹
 **
	mµCurs‹


103 (*
	mxClo£
)(
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
);

126 (*
	mxNext
)(

127 
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
,

128 c⁄° **
	mµTokí
, *
	m≤Byãs
,

129 *
	mpiSèπOff£t
,

130 *
	mpiEndOff£t
,

131 *
	mpiPosôi⁄


135 
	ssqlôe4_tokíizî
 {

136 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
	mpModuÀ
;

140 
	ssqlôe4_tokíizî_curs‹
 {

141 
sqlôe4_tokíizî
 *
	mpTokíizî
;

	@ext/fts2/fts2_tokenizer1.c

25 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS2
)

28 
	~<as£π.h
>

29 
	~<°dlib.h
>

30 
	~<°dio.h
>

31 
	~<°rög.h
>

33 
	~"·s2_tokíizî.h
"

35 
	ssim∂e_tokíizî
 {

36 
sqlôe4_tokíizî
 
	mba£
;

37 
	mdñim
[128];

38 } 
	tsim∂e_tokíizî
;

40 
	ssim∂e_tokíizî_curs‹
 {

41 
sqlôe4_tokíizî_curs‹
 
	mba£
;

42 c⁄° *
	mpI≈ut
;

43 
	mnByãs
;

44 
	miOff£t
;

45 
	miTokí
;

46 *
	mpTokí
;

47 
	mnTokíAŒoˇãd
;

48 } 
	tsim∂e_tokíizî_curs‹
;

52 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
;

54 
	$sim∂eDñim
(
sim∂e_tokíizî
 *
t
, 
c
){

55  
c
<0x80 && 
t
->
dñim
[c];

56 
	}
}

61 
	$sim∂eCª©e
(

62 
¨gc
, c⁄° * c⁄° *
¨gv
,

63 
sqlôe4_tokíizî
 **
µTokíizî


65 
sim∂e_tokíizî
 *
t
;

67 
t
 = (
sim∂e_tokíizî
 *Ë
	`sqlôe4_mÆloc
((*t));

68 if–
t
==
NULL
 )  
SQLITE4_NOMEM
;

69 
	`mem£t
(
t
, 0, (*t));

76 if–
¨gc
>1 ){

77 
i
, 
n
 = 
	`°æí
(
¨gv
[1]);

78 
i
=0; i<
n
; i++){

79 
ch
 = 
¨gv
[1][
i
];

81 if–
ch
>=0x80 ){

82 
	`sqlôe4_‰ì
(
t
);

83  
SQLITE4_ERROR
;

85 
t
->
dñim
[
ch
] = 1;

89 
i
;

90 
i
=1; i<0x80; i++){

91 
t
->
dñim
[
i
] = !((i>='0' && i<='9') || (i>='A' && i<='Z') ||

92 (
i
>='a' && i<='z'));

96 *
µTokíizî
 = &
t
->
ba£
;

97  
SQLITE4_OK
;

98 
	}
}

103 
	$sim∂eDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

104 
	`sqlôe4_‰ì
(
pTokíizî
);

105  
SQLITE4_OK
;

106 
	}
}

114 
	$sim∂eO≥n
(

115 
sqlôe4_tokíizî
 *
pTokíizî
,

116 c⁄° *
pI≈ut
, 
nByãs
,

117 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


119 
sim∂e_tokíizî_curs‹
 *
c
;

121 
c
 = (
sim∂e_tokíizî_curs‹
 *Ë
	`sqlôe4_mÆloc
((*c));

122 if–
c
==
NULL
 )  
SQLITE4_NOMEM
;

124 
c
->
pI≈ut
 =ÖInput;

125 if–
pI≈ut
==0 ){

126 
c
->
nByãs
 = 0;

127 }if–
nByãs
<0 ){

128 
c
->
nByãs
 = ()
	`°æí
(
pI≈ut
);

130 
c
->
nByãs
 =ÇBytes;

132 
c
->
iOff£t
 = 0;

133 
c
->
iTokí
 = 0;

134 
c
->
pTokí
 = 
NULL
;

135 
c
->
nTokíAŒoˇãd
 = 0;

137 *
µCurs‹
 = &
c
->
ba£
;

138  
SQLITE4_OK
;

139 
	}
}

145 
	$sim∂eClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

146 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

147 
	`sqlôe4_‰ì
(
c
->
pTokí
);

148 
	`sqlôe4_‰ì
(
c
);

149  
SQLITE4_OK
;

150 
	}
}

156 
	$sim∂eNext
(

157 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

158 c⁄° **
µTokí
,

159 *
≤Byãs
,

160 *
piSèπOff£t
,

161 *
piEndOff£t
,

162 *
piPosôi⁄


164 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

165 
sim∂e_tokíizî
 *
t
 = (sim∂e_tokíizî *Ë
pCurs‹
->
pTokíizî
;

166 *
p
 = (*)
c
->
pI≈ut
;

168  
c
->
iOff£t
<c->
nByãs
 ){

169 
iSèπOff£t
;

172  
c
->
iOff£t
<c->
nByãs
 && 
	`sim∂eDñim
(
t
, 
p
[c->iOffset]) ){

173 
c
->
iOff£t
++;

177 
iSèπOff£t
 = 
c
->
iOff£t
;

178  
c
->
iOff£t
<c->
nByãs
 && !
	`sim∂eDñim
(
t
, 
p
[c->iOffset]) ){

179 
c
->
iOff£t
++;

182 if–
c
->
iOff£t
>
iSèπOff£t
 ){

183 
i
, 
n
 = 
c
->
iOff£t
-
iSèπOff£t
;

184 if–
n
>
c
->
nTokíAŒoˇãd
 ){

185 
c
->
nTokíAŒoˇãd
 = 
n
+20;

186 
c
->
pTokí
 = 
	`sqlôe4_ªÆloc
(c->pTokí, c->
nTokíAŒoˇãd
);

187 if–
c
->
pTokí
==
NULL
 )  
SQLITE4_NOMEM
;

189 
i
=0; i<
n
; i++){

193 
ch
 = 
p
[
iSèπOff£t
+
i
];

194 
c
->
pTokí
[
i
] = (
ch
>='A' && ch<='Z') ? (ch - 'A' + 'a') : ch;

196 *
µTokí
 = 
c
->
pTokí
;

197 *
≤Byãs
 = 
n
;

198 *
piSèπOff£t
 = 
iSèπOff£t
;

199 *
piEndOff£t
 = 
c
->
iOff£t
;

200 *
piPosôi⁄
 = 
c
->
iTokí
++;

202  
SQLITE4_OK
;

205  
SQLITE4_DONE
;

206 
	}
}

211 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
 = {

213 
sim∂eCª©e
,

214 
sim∂eDe°roy
,

215 
sim∂eO≥n
,

216 
sim∂eClo£
,

217 
sim∂eNext
,

224 
	$sqlôe4Fts2Sim∂eTokíizîModuÀ
(

225 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


227 *
µModuÀ
 = &
sim∂eTokíizîModuÀ
;

228 
	}
}

	@ext/fts3/fts3.c

295 
	~"·s3I¡.h
"

296 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

298 #i‡
deföed
(
SQLITE4_ENABLE_FTS3
Ë&& !deföed(
SQLITE4_CORE
)

299 
	#SQLITE4_CORE
 1

	)

302 
	~<as£π.h
>

303 
	~<°dlib.h
>

304 
	~<°ddef.h
>

305 
	~<°dio.h
>

306 
	~<°rög.h
>

307 
	~<°d¨g.h
>

309 
	~"·s3.h
"

311 
·s3EvÆNext
(
Fts3Curs‹
 *
pC§
);

312 
·s3EvÆSèπ
(
Fts3Curs‹
 *
pC§
);

313 
·s3TîmSegRódîCurs‹
(

314 
Fts3Curs‹
 *, c⁄° *, , , 
Fts3Mu…iSegRódî
 **);

321 
	$sqlôe4Fts3PutV¨öt
(*
p
, 
sqlôe_öt64
 
v
){

322 *
q
 = (*Ë
p
;

323 
sqlôe_uöt64
 
vu
 = 
v
;

325 *
q
++ = (Ë((
vu
 & 0x7f) | 0x80);

326 
vu
 >>= 7;

327 } 
vu
!=0 );

328 
q
[-1] &= 0x7f;

329 
	`as£π
–
q
 - (*)
p
 <
FTS3_VARINT_MAX
 );

330  (Ë(
q
 - (*)
p
);

331 
	}
}

338 
	$sqlôe4Fts3GëV¨öt
(c⁄° *
p
, 
sqlôe_öt64
 *
v
){

339 c⁄° *
q
 = (c⁄° *Ë
p
;

340 
sqlôe_uöt64
 
x
 = 0, 
y
 = 1;

341  (*
q
&0x80)==0x80 && q-(*)
p
<
FTS3_VARINT_MAX
 ){

342 
x
 +
y
 * (*
q
++ & 0x7f);

343 
y
 <<= 7;

345 
x
 +
y
 * (*
q
++);

346 *
v
 = (
sqlôe_öt64
Ë
x
;

347  (Ë(
q
 - (*)
p
);

348 
	}
}

354 
	$sqlôe4Fts3GëV¨öt32
(c⁄° *
p
, *
pi
){

355 
sqlôe_öt64
 
i
;

356 
ªt
 = 
	`sqlôe4Fts3GëV¨öt
(
p
, &
i
);

357 *
pi
 = (Ë
i
;

358  
ªt
;

359 
	}
}

364 
	$sqlôe4Fts3V¨ötLí
(
sqlôe4_uöt64
 
v
){

365 
i
 = 0;

367 
i
++;

368 
v
 >>= 7;

369 } 
v
!=0 );

370  
i
;

371 
	}
}

387 
	$sqlôe4Fts3DequŸe
(*
z
){

388 
quŸe
;

390 
quŸe
 = 
z
[0];

391 if–
quŸe
=='[' || quote=='\'' || quote=='"' || quote=='`' ){

392 
iIn
 = 1;

393 
iOut
 = 0;

396 if–
quŸe
=='[' ) quote = ']';

398  
	`ALWAYS
(
z
[
iIn
]) ){

399 if–
z
[
iIn
]==
quŸe
 ){

400 if–
z
[
iIn
+1]!=
quŸe
 ) ;

401 
z
[
iOut
++] = 
quŸe
;

402 
iIn
 += 2;

404 
z
[
iOut
++] = z[
iIn
++];

407 
z
[
iOut
] = '\0';

409 
	}
}

416 
	$·s3GëDñèV¨öt
(**
µ
, 
sqlôe4_öt64
 *
pVÆ
){

417 
sqlôe4_öt64
 
iVÆ
;

418 *
µ
 +
	`sqlôe4Fts3GëV¨öt
(*µ, &
iVÆ
);

419 *
pVÆ
 +
iVÆ
;

420 
	}
}

431 
	$·s3GëRevî£V¨öt
(

432 **
µ
,

433 *
pSèπ
,

434 
sqlôe4_öt64
 *
pVÆ


436 
sqlôe4_öt64
 
iVÆ
;

437 *
p
;

442 
p
 = (*
µ
)-2;Ö>=
pSèπ
 && *p&0x80;Ö--);

443 
p
++;

444 *
µ
 = 
p
;

446 
	`sqlôe4Fts3GëV¨öt
(
p
, &
iVÆ
);

447 *
pVÆ
 = 
iVÆ
;

448 
	}
}

453 
	$·s3Disc⁄√˘Mëhod
(
sqlôe4_vèb
 *
pVèb
){

454 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pVèb
;

455 
i
;

457 
	`as£π
–
p
->
nPídögD©a
==0 );

458 
	`as£π
–
p
->
pSegmíts
==0 );

461 
i
=0; i<
	`SizeofAºay
(
p
->
aStmt
); i++){

462 
	`sqlôe4_föÆize
(
p
->
aStmt
[
i
]);

464 
	`sqlôe4_‰ì
(
p
->
zSegmítsTbl
);

465 
	`sqlôe4_‰ì
(
p
->
zRódEx¥li°
);

466 
	`sqlôe4_‰ì
(
p
->
zWrôeEx¥li°
);

467 
	`sqlôe4_‰ì
(
p
->
zC⁄ã¡Tbl
);

470 
p
->
pTokíizî
->
pModuÀ
->
	`xDe°roy
(p->pTokenizer);

472 
	`sqlôe4_‰ì
(
p
);

473  
SQLITE4_OK
;

474 
	}
}

483 
	$·s3DbExec
(

484 *
pRc
,

485 
sqlôe4
 *
db
,

486 c⁄° *
zF‹m©
,

489 
va_li°
 
≠
;

490 *
zSql
;

491 if–*
pRc
 ) ;

492 
	`va_°¨t
(
≠
, 
zF‹m©
);

493 
zSql
 = 
	`sqlôe4_vm¥ötf
(
zF‹m©
, 
≠
);

494 
	`va_íd
(
≠
);

495 if–
zSql
==0 ){

496 *
pRc
 = 
SQLITE4_NOMEM
;

498 *
pRc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 0, 0, 0);

499 
	`sqlôe4_‰ì
(
zSql
);

501 
	}
}

506 
	$·s3De°royMëhod
(
sqlôe4_vèb
 *
pVèb
){

507 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pVèb
;

508 
rc
 = 
SQLITE4_OK
;

509 c⁄° *
zDb
 = 
p
->zDb;

510 
sqlôe4
 *
db
 = 
p
->db;

513 if–
p
->
zC⁄ã¡Tbl
==0 ){

514 
	`·s3DbExec
(&
rc
, 
db
, "DROP TABLE IF EXISTS %Q.'%q_c⁄ã¡'", 
zDb
, 
p
->
zName
);

516 
	`·s3DbExec
(&
rc
, 
db
, "DROP TABLE IF EXISTS %Q.'%q_£gmíts'", 
zDb
,
p
->
zName
);

517 
	`·s3DbExec
(&
rc
, 
db
, "DROP TABLE IF EXISTS %Q.'%q_£gdú'", 
zDb
, 
p
->
zName
);

518 
	`·s3DbExec
(&
rc
, 
db
, "DROP TABLE IF EXISTS %Q.'%q_docsize'", 
zDb
, 
p
->
zName
);

519 
	`·s3DbExec
(&
rc
, 
db
, "DROP TABLE IF EXISTS %Q.'%q_°©'", 
zDb
, 
p
->
zName
);

525  (
rc
==
SQLITE4_OK
 ? 
	`·s3Disc⁄√˘Mëhod
(
pVèb
) :Ñc);

526 
	}
}

538 
	$·s3De˛¨eVèb
(*
pRc
, 
Fts3TabÀ
 *
p
){

539 if–*
pRc
==
SQLITE4_OK
 ){

540 
i
;

541 
rc
;

542 *
zSql
;

543 *
zCﬁs
;

545 
	`sqlôe4_vèb_c⁄fig
(
p
->
db
, 
SQLITE4_VTAB_CONSTRAINT_SUPPORT
, 1);

548 
zCﬁs
 = 
	`sqlôe4_m¥ötf
("%Q, ", 
p
->
azCﬁumn
[0]);

549 
i
=1; 
zCﬁs
 && i<
p
->
nCﬁumn
; i++){

550 
zCﬁs
 = 
	`sqlôe4_m¥ötf
("%z%Q, ", zCﬁs, 
p
->
azCﬁumn
[
i
]);

554 
zSql
 = 
	`sqlôe4_m¥ötf
(

555 "CREATE TABLE x(%†%Q HIDDEN, docid HIDDEN)", 
zCﬁs
, 
p
->
zName


557 if–!
zCﬁs
 || !
zSql
 ){

558 
rc
 = 
SQLITE4_NOMEM
;

560 
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
p
->
db
, 
zSql
);

563 
	`sqlôe4_‰ì
(
zSql
);

564 
	`sqlôe4_‰ì
(
zCﬁs
);

565 *
pRc
 = 
rc
;

567 
	}
}

578 
	$·s3Cª©eTabÀs
(
Fts3TabÀ
 *
p
){

579 
rc
 = 
SQLITE4_OK
;

580 
i
;

581 
sqlôe4
 *
db
 = 
p
->db;

583 if–
p
->
zC⁄ã¡Tbl
==0 ){

584 *
zC⁄ã¡Cﬁs
;

587 
zC⁄ã¡Cﬁs
 = 
	`sqlôe4_m¥ötf
("docid INTEGER PRIMARY KEY");

588 
i
=0; 
zC⁄ã¡Cﬁs
 && i<
p
->
nCﬁumn
; i++){

589 *
z
 = 
p
->
azCﬁumn
[
i
];

590 
zC⁄ã¡Cﬁs
 = 
	`sqlôe4_m¥ötf
("%z, 'c%d%q'", zC⁄ã¡Cﬁs, 
i
, 
z
);

592 if–
zC⁄ã¡Cﬁs
==0 ) 
rc
 = 
SQLITE4_NOMEM
;

595 
	`·s3DbExec
(&
rc
, 
db
,

597 
p
->
zDb
,Ö->
zName
, 
zC⁄ã¡Cﬁs


599 
	`sqlôe4_‰ì
(
zC⁄ã¡Cﬁs
);

603 
	`·s3DbExec
(&
rc
, 
db
,

605 
p
->
zDb
,Ö->
zName


607 
	`·s3DbExec
(&
rc
, 
db
,

617 
p
->
zDb
,Ö->
zName


619 if–
p
->
bHasDocsize
 ){

620 
	`·s3DbExec
(&
rc
, 
db
,

622 
p
->
zDb
,Ö->
zName


625 if–
p
->
bHasSèt
 ){

626 
	`·s3DbExec
(&
rc
, 
db
,

628 
p
->
zDb
,Ö->
zName


631  
rc
;

632 
	}
}

641 
	$·s3D©aba£PageSize
(*
pRc
, 
Fts3TabÀ
 *
p
){

642 if–*
pRc
==
SQLITE4_OK
 ){

643 
rc
;

644 *
zSql
;

645 
sqlôe4_°mt
 *
pStmt
;

647 
zSql
 = 
	`sqlôe4_m¥ötf
("PRAGMA %Q.∑ge_size", 
p
->
zDb
);

648 if–!
zSql
 ){

649 
rc
 = 
SQLITE4_NOMEM
;

651 
rc
 = 
	`sqlôe4_¥ï¨e
(
p
->
db
, 
zSql
, -1, &
pStmt
, 0);

652 if–
rc
==
SQLITE4_OK
 ){

653 
	`sqlôe4_°ï
(
pStmt
);

654 
p
->
nPgsz
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

655 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

656 }if–
rc
==
SQLITE4_AUTH
 ){

657 
p
->
nPgsz
 = 1024;

658 
rc
 = 
SQLITE4_OK
;

661 
	`as£π
–
p
->
nPgsz
>0 || 
rc
!=
SQLITE4_OK
 );

662 
	`sqlôe4_‰ì
(
zSql
);

663 *
pRc
 = 
rc
;

665 
	}
}

675 
	$·s3IsS≥cülCﬁumn
(

676 c⁄° *
z
,

677 *
≤Key
,

678 **
pzVÆue


680 *
zVÆue
;

681 c⁄° *
zC§
 = 
z
;

683  *
zC§
!='=' ){

684 if–*
zC§
=='\0' )  0;

685 
zC§
++;

688 *
≤Key
 = ()(
zC§
-
z
);

689 
zVÆue
 = 
	`sqlôe4_m¥ötf
("%s", &
zC§
[1]);

690 if–
zVÆue
 ){

691 
	`sqlôe4Fts3DequŸe
(
zVÆue
);

693 *
pzVÆue
 = 
zVÆue
;

695 
	}
}

700 
	$·s3Aµídf
(

701 *
pRc
,

702 **
pz
,

703 c⁄° *
zF‹m©
,

706 if–*
pRc
==
SQLITE4_OK
 ){

707 
va_li°
 
≠
;

708 *
z
;

709 
	`va_°¨t
(
≠
, 
zF‹m©
);

710 
z
 = 
	`sqlôe4_vm¥ötf
(
zF‹m©
, 
≠
);

711 
	`va_íd
(
≠
);

712 if–
z
 && *
pz
 ){

713 *
z2
 = 
	`sqlôe4_m¥ötf
("%s%s", *
pz
, 
z
);

714 
	`sqlôe4_‰ì
(
z
);

715 
z
 = 
z2
;

717 if–
z
==0 ) *
pRc
 = 
SQLITE4_NOMEM
;

718 
	`sqlôe4_‰ì
(*
pz
);

719 *
pz
 = 
z
;

721 
	}
}

733 *
	$·s3QuŸeId
(c⁄° *
zI≈ut
){

734 
nRë
;

735 *
zRë
;

736 
nRë
 = 2 + 
	`°æí
(
zI≈ut
)*2 + 1;

737 
zRë
 = 
	`sqlôe4_mÆloc
(
nRë
);

738 if–
zRë
 ){

739 
i
;

740 *
z
 = 
zRë
;

741 *(
z
++) = '"';

742 
i
=0; 
zI≈ut
[i]; i++){

743 if–
zI≈ut
[
i
]=='"' ) *(
z
++) = '"';

744 *(
z
++Ë
zI≈ut
[
i
];

746 *(
z
++) = '"';

747 *(
z
++) = '\0';

749  
zRë
;

750 
	}
}

775 *
	$·s3RódEx¥Li°
(
Fts3TabÀ
 *
p
, c⁄° *
zFunc
, *
pRc
){

776 *
zRë
 = 0;

777 *
zFªe
 = 0;

778 *
zFun˘i⁄
;

779 
i
;

781 if–
p
->
zC⁄ã¡Tbl
==0 ){

782 if–!
zFunc
 ){

783 
zFun˘i⁄
 = "";

785 
zFªe
 = 
zFun˘i⁄
 = 
	`·s3QuŸeId
(
zFunc
);

787 
	`·s3Aµídf
(
pRc
, &
zRë
, "docid");

788 
i
=0; i<
p
->
nCﬁumn
; i++){

789 
	`·s3Aµídf
(
pRc
, &
zRë
, ",%s(x.'c%d%q')", 
zFun˘i⁄
, 
i
, 
p
->
azCﬁumn
[i]);

791 
	`sqlôe4_‰ì
(
zFªe
);

793 
	`·s3Aµídf
(
pRc
, &
zRë
, "rowid");

794 
i
=0; i<
p
->
nCﬁumn
; i++){

795 
	`·s3Aµídf
(
pRc
, &
zRë
, ", x.'%q'", 
p
->
azCﬁumn
[
i
]);

798 
	`·s3Aµídf
(
pRc
, &
zRë
, "FROM '%q'.'%q%s' AS x",

799 
p
->
zDb
,

800 (
p
->
zC⁄ã¡Tbl
 ?Ö->zC⁄ã¡Tb»:Ö->
zName
),

801 (
p
->
zC⁄ã¡Tbl
 ? "" : "_content")

803  
zRë
;

804 
	}
}

826 *
	$·s3WrôeEx¥Li°
(
Fts3TabÀ
 *
p
, c⁄° *
zFunc
, *
pRc
){

827 *
zRë
 = 0;

828 *
zFªe
 = 0;

829 *
zFun˘i⁄
;

830 
i
;

832 if–!
zFunc
 ){

833 
zFun˘i⁄
 = "";

835 
zFªe
 = 
zFun˘i⁄
 = 
	`·s3QuŸeId
(
zFunc
);

837 
	`·s3Aµídf
(
pRc
, &
zRë
, "?");

838 
i
=0; i<
p
->
nCﬁumn
; i++){

839 
	`·s3Aµídf
(
pRc
, &
zRë
, ",%s(?)", 
zFun˘i⁄
);

841 
	`sqlôe4_‰ì
(
zFªe
);

842  
zRë
;

843 
	}
}

858 
	$·s3GobbÀI¡
(c⁄° **
µ
, *
≤Out
){

859 c⁄° *
p
;

860 
nI¡
 = 0;

862 
p
=*
µ
;Ö[0]>='0' &&Ö[0]<='9';Ö++){

863 
nI¡
 =ÇI¡ * 10 + (
p
[0] - '0');

865 if–
p
==*
µ
 )  
SQLITE4_ERROR
;

866 *
≤Out
 = 
nI¡
;

867 *
µ
 = 
p
;

868  
SQLITE4_OK
;

869 
	}
}

888 
	$·s3PªfixP¨amëî
(

889 c⁄° *
zP¨am
,

890 *
≤Index
,

891 
Fts3Index
 **
≠Index


893 
Fts3Index
 *
aIndex
;

894 
nIndex
 = 1;

896 if–
zP¨am
 && zParam[0] ){

897 c⁄° *
p
;

898 
nIndex
++;

899 
p
=
zP¨am
; *p;Ö++){

900 if–*
p
==',' ) 
nIndex
++;

904 
aIndex
 = 
	`sqlôe4_mÆloc
((
Fts3Index
Ë* 
nIndex
);

905 *
≠Index
 = 
aIndex
;

906 *
≤Index
 = 
nIndex
;

907 if–!
aIndex
 ){

908  
SQLITE4_NOMEM
;

911 
	`mem£t
(
aIndex
, 0, (
Fts3Index
Ë* 
nIndex
);

912 if–
zP¨am
 ){

913 c⁄° *
p
 = 
zP¨am
;

914 
i
;

915 
i
=1; i<
nIndex
; i++){

916 
nPªfix
;

917 if–
	`·s3GobbÀI¡
(&
p
, &
nPªfix
ËË 
SQLITE4_ERROR
;

918 
aIndex
[
i
].
nPªfix
 =ÇPrefix;

919 
p
++;

923  
SQLITE4_OK
;

924 
	}
}

951 
	$·s3C⁄ã¡Cﬁumns
(

952 
sqlôe4
 *
db
,

953 c⁄° *
zDb
,

954 c⁄° *
zTbl
,

955 c⁄° ***
∑zCﬁ
,

956 *
≤Cﬁ
,

957 *
≤Så


959 
rc
 = 
SQLITE4_OK
;

960 *
zSql
;

961 
sqlôe4_°mt
 *
pStmt
 = 0;

963 
zSql
 = 
	`sqlôe4_m¥ötf
("SELECT * FROM %Q.%Q", 
zDb
, 
zTbl
);

964 if–!
zSql
 ){

965 
rc
 = 
SQLITE4_NOMEM
;

967 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

969 
	`sqlôe4_‰ì
(
zSql
);

971 if–
rc
==
SQLITE4_OK
 ){

972 c⁄° **
azCﬁ
;

973 
nSå
 = 0;

974 
nCﬁ
;

975 
i
;

980 
nCﬁ
 = 
	`sqlôe4_cﬁumn_cou¡
(
pStmt
);

981 
i
=0; i<
nCﬁ
; i++){

982 c⁄° *
zCﬁ
 = 
	`sqlôe4_cﬁumn_«me
(
pStmt
, 
i
);

983 
nSå
 +
	`°æí
(
zCﬁ
) + 1;

987 
azCﬁ
 = (c⁄° **)
	`sqlôe4_mÆloc
((*Ë* 
nCﬁ
 + 
nSå
);

988 if–
azCﬁ
==0 ){

989 
rc
 = 
SQLITE4_NOMEM
;

991 *
p
 = (*)&
azCﬁ
[
nCﬁ
];

992 
i
=0; i<
nCﬁ
; i++){

993 c⁄° *
zCﬁ
 = 
	`sqlôe4_cﬁumn_«me
(
pStmt
, 
i
);

994 
n
 = 
	`°æí
(
zCﬁ
)+1;

995 
	`mem˝y
(
p
, 
zCﬁ
, 
n
);

996 
azCﬁ
[
i
] = 
p
;

997 
p
 +
n
;

1000 
	`sqlôe4_föÆize
(
pStmt
);

1003 *
≤Cﬁ
 = 
nCﬁ
;

1004 *
≤Så
 = 
nSå
;

1005 *
∑zCﬁ
 = 
azCﬁ
;

1008  
rc
;

1009 
	}
}

1022 
	$·s3InôVèb
(

1023 
isCª©e
,

1024 
sqlôe4
 *
db
,

1025 *
pAux
,

1026 
¨gc
,

1027 c⁄° * c⁄° *
¨gv
,

1028 
sqlôe4_vèb
 **
µVTab
,

1029 **
pzEº


1031 
Fts3Hash
 *
pHash
 = (Fts3Hash *)
pAux
;

1032 
Fts3TabÀ
 *
p
 = 0;

1033 
rc
 = 
SQLITE4_OK
;

1034 
i
;

1035 
nByã
;

1036 
iCﬁ
;

1037 
nSåög
 = 0;

1038 
nCﬁ
 = 0;

1039 *
zC§
;

1040 
nDb
;

1041 
nName
;

1042 
isFts4
 = (
¨gv
[0][3]=='4');

1043 c⁄° **
aCﬁ
;

1044 
sqlôe4_tokíizî
 *
pTokíizî
 = 0;

1046 
nIndex
;

1047 
Fts3Index
 *
aIndex
 = 0;

1050 
bNoDocsize
 = 0;

1051 
bDescIdx
 = 0;

1052 *
zPªfix
 = 0;

1053 *
zCom¥ess
 = 0;

1054 *
zUncom¥ess
 = 0;

1055 *
zC⁄ã¡
 = 0;

1057 
	`as£π
–
	`°æí
(
¨gv
[0])==4 );

1058 
	`as£π
–(
	`sqlôe4_°∫icmp
(
¨gv
[0], "·s4", 4)==0 && 
isFts4
)

1059 || (
	`sqlôe4_°∫icmp
(
¨gv
[0], "·s3", 4)==0 && !
isFts4
)

1062 
nDb
 = ()
	`°æí
(
¨gv
[1]) + 1;

1063 
nName
 = ()
	`°æí
(
¨gv
[2]) + 1;

1065 
aCﬁ
 = (c⁄° **)
	`sqlôe4_mÆloc
((c⁄° *Ë* (
¨gc
-2) );

1066 if–!
aCﬁ
 )  
SQLITE4_NOMEM
;

1067 
	`mem£t
((*)
aCﬁ
, 0, (c⁄° *Ë* (
¨gc
-2));

1080 
i
=3; 
rc
==
SQLITE4_OK
 && i<
¨gc
; i++){

1081 c⁄° *
z
 = 
¨gv
[
i
];

1082 
nKey
;

1083 *
zVÆ
;

1086 if–!
pTokíizî


1087 && 
	`°æí
(
z
)>8

1088 && 0==
	`sqlôe4_°∫icmp
(
z
, "tokenize", 8)

1089 && 0==
	`sqlôe4Fts3IsIdCh¨
(
z
[8])

1091 
rc
 = 
	`sqlôe4Fts3InôTokíizî
(
pHash
, &
z
[9], &
pTokíizî
, 
pzEº
);

1095 if–
isFts4
 && 
	`·s3IsS≥cülCﬁumn
(
z
, &
nKey
, &
zVÆ
) ){

1096 
	sFts4O±i⁄
 {

1097 c⁄° *
zO±
;

1098 
nO±
;

1099 } 
aFts4O±
[] = {

1108 
iO±
;

1109 if–!
zVÆ
 ){

1110 
rc
 = 
SQLITE4_NOMEM
;

1112 
iO±
=0; iO±<
	`SizeofAºay
(
aFts4O±
); iOpt++){

1113 
Fts4O±i⁄
 *
pOp
 = &
aFts4O±
[
iO±
];

1114 if–
nKey
==
pOp
->
nO±
 && !
	`sqlôe4_°∫icmp
(
z
,ÖOp->
zO±
,ÖOp->nOpt) ){

1118 if–
iO±
==
	`SizeofAºay
(
aFts4O±
) ){

1119 *
pzEº
 = 
	`sqlôe4_m¥ötf
("uƒecognizedÖ¨amëî: %s", 
z
);

1120 
rc
 = 
SQLITE4_ERROR
;

1122  
iO±
 ){

1124 if–
	`°æí
(
zVÆ
)!=4 || 
	`sqlôe4_°∫icmp
(zVal, "fts3", 4) ){

1125 *
pzEº
 = 
	`sqlôe4_m¥ötf
("uƒecognized m©chöfo: %s", 
zVÆ
);

1126 
rc
 = 
SQLITE4_ERROR
;

1128 
bNoDocsize
 = 1;

1132 
	`sqlôe4_‰ì
(
zPªfix
);

1133 
zPªfix
 = 
zVÆ
;

1134 
zVÆ
 = 0;

1138 
	`sqlôe4_‰ì
(
zCom¥ess
);

1139 
zCom¥ess
 = 
zVÆ
;

1140 
zVÆ
 = 0;

1144 
	`sqlôe4_‰ì
(
zUncom¥ess
);

1145 
zUncom¥ess
 = 
zVÆ
;

1146 
zVÆ
 = 0;

1150 if–(
	`°æí
(
zVÆ
)!=3 || 
	`sqlôe4_°∫icmp
(zVal, "asc", 3))

1151 && (
	`°æí
(
zVÆ
)!=4 || 
	`sqlôe4_°∫icmp
(zVal, "desc", 4))

1153 *
pzEº
 = 
	`sqlôe4_m¥ötf
("uƒecognized ordî: %s", 
zVÆ
);

1154 
rc
 = 
SQLITE4_ERROR
;

1156 
bDescIdx
 = (
zVÆ
[0]=='d' || zVal[0]=='D');

1160 
	`as£π
–
iO±
==5 );

1161 
	`sqlôe4_‰ì
(
zUncom¥ess
);

1162 
zC⁄ã¡
 = 
zVÆ
;

1163 
zVÆ
 = 0;

1167 
	`sqlôe4_‰ì
(
zVÆ
);

1173 
nSåög
 +()(
	`°æí
(
z
) + 1);

1174 
aCﬁ
[
nCﬁ
++] = 
z
;

1185 if–
rc
==
SQLITE4_OK
 && 
zC⁄ã¡
 ){

1186 
	`sqlôe4_‰ì
(
zCom¥ess
);

1187 
	`sqlôe4_‰ì
(
zUncom¥ess
);

1188 
zCom¥ess
 = 0;

1189 
zUncom¥ess
 = 0;

1190 if–
nCﬁ
==0 ){

1191 
	`sqlôe4_‰ì
((*)
aCﬁ
);

1192 
aCﬁ
 = 0;

1193 
rc
 = 
	`·s3C⁄ã¡Cﬁumns
(
db
, 
¨gv
[1], 
zC⁄ã¡
, &
aCﬁ
, &
nCﬁ
, &
nSåög
);

1195 
	`as£π
–
rc
!=
SQLITE4_OK
 || 
nCﬁ
>0 );

1197 if–
rc
!=
SQLITE4_OK
 ) 
·s3_öô_out
;

1199 if–
nCﬁ
==0 ){

1200 
	`as£π
–
nSåög
==0 );

1201 
aCﬁ
[0] = "content";

1202 
nSåög
 = 8;

1203 
nCﬁ
 = 1;

1206 if–
pTokíizî
==0 ){

1207 
rc
 = 
	`sqlôe4Fts3InôTokíizî
(
pHash
, "sim∂e", &
pTokíizî
, 
pzEº
);

1208 if–
rc
!=
SQLITE4_OK
 ) 
·s3_öô_out
;

1210 
	`as£π
–
pTokíizî
 );

1212 
rc
 = 
	`·s3PªfixP¨amëî
(
zPªfix
, &
nIndex
, &
aIndex
);

1213 if–
rc
==
SQLITE4_ERROR
 ){

1214 
	`as£π
–
zPªfix
 );

1215 *
pzEº
 = 
	`sqlôe4_m¥ötf
("îr‹Ö¨sögÖªfixÖ¨amëî: %s", 
zPªfix
);

1217 if–
rc
!=
SQLITE4_OK
 ) 
·s3_öô_out
;

1220 
nByã
 = (
Fts3TabÀ
) +

1221 
nCﬁ
 * (*) +

1222 
nIndex
 * (
Fts3Index
) +

1223 
nName
 +

1224 
nDb
 +

1225 
nSåög
;

1226 
p
 = (
Fts3TabÀ
*)
	`sqlôe4_mÆloc
(
nByã
);

1227 if–
p
==0 ){

1228 
rc
 = 
SQLITE4_NOMEM
;

1229 
·s3_öô_out
;

1231 
	`mem£t
(
p
, 0, 
nByã
);

1232 
p
->
db
 = db;

1233 
p
->
nCﬁumn
 = 
nCﬁ
;

1234 
p
->
nPídögD©a
 = 0;

1235 
p
->
azCﬁumn
 = (**)&p[1];

1236 
p
->
pTokíizî
 =ÖTokenizer;

1237 
p
->
nMaxPídögD©a
 = 
FTS3_MAX_PENDING_DATA
;

1238 
p
->
bHasDocsize
 = (
isFts4
 && 
bNoDocsize
==0);

1239 
p
->
bHasSèt
 = 
isFts4
;

1240 
p
->
bDescIdx
 = bDescIdx;

1241 
p
->
zC⁄ã¡Tbl
 = 
zC⁄ã¡
;

1242 
zC⁄ã¡
 = 0;

1243 
	`TESTONLY
–
p
->
öTønß˘i⁄
 = -1 );

1244 
	`TESTONLY
–
p
->
mxSavïoöt
 = -1 );

1246 
p
->
aIndex
 = (
Fts3Index
 *)&p->
azCﬁumn
[
nCﬁ
];

1247 
	`mem˝y
(
p
->
aIndex
,áIndex, (
Fts3Index
Ë* 
nIndex
);

1248 
p
->
nIndex
 =ÇIndex;

1249 
i
=0; i<
nIndex
; i++){

1250 
	`·s3HashInô
(&
p
->
aIndex
[
i
].
hPídög
, 
FTS3_HASH_STRING
, 1);

1254 
zC§
 = (*)&
p
->
aIndex
[
nIndex
];

1255 
p
->
zName
 = 
zC§
;

1256 
	`mem˝y
(
zC§
, 
¨gv
[2], 
nName
);

1257 
zC§
 +
nName
;

1258 
p
->
zDb
 = 
zC§
;

1259 
	`mem˝y
(
zC§
, 
¨gv
[1], 
nDb
);

1260 
zC§
 +
nDb
;

1263 
iCﬁ
=0; iCﬁ<
nCﬁ
; iCol++){

1264 *
z
;

1265 
n
 = 0;

1266 
z
 = (*)
	`sqlôe4Fts3NextTokí
(
aCﬁ
[
iCﬁ
], &
n
);

1267 
	`mem˝y
(
zC§
, 
z
, 
n
);

1268 
zC§
[
n
] = '\0';

1269 
	`sqlôe4Fts3DequŸe
(
zC§
);

1270 
p
->
azCﬁumn
[
iCﬁ
] = 
zC§
;

1271 
zC§
 +
n
+1;

1272 
	`as£π
–
zC§
 <&((*)
p
)[
nByã
] );

1275 if–(
zCom¥ess
==0)!=(
zUncom¥ess
==0) ){

1276 c⁄° *
zMiss
 = (
zCom¥ess
==0 ? "compress" : "uncompress");

1277 
rc
 = 
SQLITE4_ERROR
;

1278 *
pzEº
 = 
	`sqlôe4_m¥ötf
("missög %†∑ømëî i¿·s4 c⁄°ru˘‹", 
zMiss
);

1280 
p
->
zRódEx¥li°
 = 
	`·s3RódEx¥Li°
’, 
zUncom¥ess
, &
rc
);

1281 
p
->
zWrôeEx¥li°
 = 
	`·s3WrôeEx¥Li°
’, 
zCom¥ess
, &
rc
);

1282 if–
rc
!=
SQLITE4_OK
 ) 
·s3_öô_out
;

1287 if–
isCª©e
 ){

1288 
rc
 = 
	`·s3Cª©eTabÀs
(
p
);

1293 
	`·s3D©aba£PageSize
(&
rc
, 
p
);

1294 
p
->
nNodeSize
 =Ö->
nPgsz
-35;

1297 
	`·s3De˛¨eVèb
(&
rc
, 
p
);

1299 
·s3_öô_out
:

1300 
	`sqlôe4_‰ì
(
zPªfix
);

1301 
	`sqlôe4_‰ì
(
aIndex
);

1302 
	`sqlôe4_‰ì
(
zCom¥ess
);

1303 
	`sqlôe4_‰ì
(
zUncom¥ess
);

1304 
	`sqlôe4_‰ì
(
zC⁄ã¡
);

1305 
	`sqlôe4_‰ì
((*)
aCﬁ
);

1306 if–
rc
!=
SQLITE4_OK
 ){

1307 if–
p
 ){

1308 
	`·s3Disc⁄√˘Mëhod
((
sqlôe4_vèb
 *)
p
);

1309 }if–
pTokíizî
 ){

1310 
pTokíizî
->
pModuÀ
->
	`xDe°roy
(pTokenizer);

1313 
	`as£π
–
p
->
pSegmíts
==0 );

1314 *
µVTab
 = &
p
->
ba£
;

1316  
rc
;

1317 
	}
}

1323 
	$·s3C⁄√˘Mëhod
(

1324 
sqlôe4
 *
db
,

1325 *
pAux
,

1326 
¨gc
,

1327 c⁄° * c⁄° *
¨gv
,

1328 
sqlôe4_vèb
 **
µVèb
,

1329 **
pzEº


1331  
	`·s3InôVèb
(0, 
db
, 
pAux
, 
¨gc
, 
¨gv
, 
µVèb
, 
pzEº
);

1332 
	}
}

1333 
	$·s3Cª©eMëhod
(

1334 
sqlôe4
 *
db
,

1335 *
pAux
,

1336 
¨gc
,

1337 c⁄° * c⁄° *
¨gv
,

1338 
sqlôe4_vèb
 **
µVèb
,

1339 **
pzEº


1341  
	`·s3InôVèb
(1, 
db
, 
pAux
, 
¨gc
, 
¨gv
, 
µVèb
, 
pzEº
);

1342 
	}
}

1352 
	$·s3Be°IndexMëhod
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_ödex_öfo
 *
pInfo
){

1353 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pVTab
;

1354 
i
;

1355 
iC⁄s
 = -1;

1361 
pInfo
->
idxNum
 = 
FTS3_FULLSCAN_SEARCH
;

1362 
pInfo
->
e°im©edCo°
 = 500000;

1363 
i
=0; i<
pInfo
->
nC⁄°øöt
; i++){

1364 
sqlôe4_ödex_c⁄°øöt
 *
pC⁄s
 = &
pInfo
->
aC⁄°øöt
[
i
];

1365 if–
pC⁄s
->
ußbÀ
==0 ) ;

1368 if–
pC⁄s
->
›
==
SQLITE4_INDEX_CONSTRAINT_EQ


1369 && (
pC⁄s
->
iCﬁumn
<0 ||ÖC⁄s->iCﬁumn==
p
->
nCﬁumn
+1 )

1371 
pInfo
->
idxNum
 = 
FTS3_DOCID_SEARCH
;

1372 
pInfo
->
e°im©edCo°
 = 1.0;

1373 
iC⁄s
 = 
i
;

1385 if–
pC⁄s
->
›
==
SQLITE4_INDEX_CONSTRAINT_MATCH


1386 && 
pC⁄s
->
iCﬁumn
>=0 &&ÖC⁄s->iCﬁumn<=
p
->
nCﬁumn


1388 
pInfo
->
idxNum
 = 
FTS3_FULLTEXT_SEARCH
 + 
pC⁄s
->
iCﬁumn
;

1389 
pInfo
->
e°im©edCo°
 = 2.0;

1390 
iC⁄s
 = 
i
;

1395 if–
iC⁄s
>=0 ){

1396 
pInfo
->
aC⁄°øötUßge
[
iC⁄s
].
¨gvIndex
 = 1;

1397 
pInfo
->
aC⁄°øötUßge
[
iC⁄s
].
omô
 = 1;

1403 if–
pInfo
->
nOrdîBy
==1 ){

1404 
sqlôe4_ödex_‹dîby
 *
pOrdî
 = &
pInfo
->
aOrdîBy
[0];

1405 if–
pOrdî
->
iCﬁumn
<0 ||ÖOrdî->iCﬁumn==
p
->
nCﬁumn
+1 ){

1406 if–
pOrdî
->
desc
 ){

1407 
pInfo
->
idxSå
 = "DESC";

1409 
pInfo
->
idxSå
 = "ASC";

1411 
pInfo
->
‹dîByC⁄sumed
 = 1;

1415 
	`as£π
–
p
->
pSegmíts
==0 );

1416  
SQLITE4_OK
;

1417 
	}
}

1422 
	$·s3O≥nMëhod
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µC§
){

1423 
sqlôe4_vèb_curs‹
 *
pC§
;

1425 
	`UNUSED_PARAMETER
(
pVTab
);

1431 *
µC§
 = 
pC§
 = (
sqlôe4_vèb_curs‹
 *)
	`sqlôe4_mÆloc
((
Fts3Curs‹
));

1432 if–!
pC§
 ){

1433  
SQLITE4_NOMEM
;

1435 
	`mem£t
(
pC§
, 0, (
Fts3Curs‹
));

1436  
SQLITE4_OK
;

1437 
	}
}

1443 
	$·s3Clo£Mëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

1444 
Fts3Curs‹
 *
pC§
 = (Fts3Curs‹ *)
pCurs‹
;

1445 
	`as£π
–((
Fts3TabÀ
 *)
pC§
->
ba£
.
pVèb
)->
pSegmíts
==0 );

1446 
	`sqlôe4_föÆize
(
pC§
->
pStmt
);

1447 
	`sqlôe4Fts3Ex¥Fªe
(
pC§
->
pEx¥
);

1448 
	`sqlôe4Fts3FªeDe„ºedTokís
(
pC§
);

1449 
	`sqlôe4_‰ì
(
pC§
->
aDo˛i°
);

1450 
	`sqlôe4_‰ì
(
pC§
->
aM©chöfo
);

1451 
	`as£π
–((
Fts3TabÀ
 *)
pC§
->
ba£
.
pVèb
)->
pSegmíts
==0 );

1452 
	`sqlôe4_‰ì
(
pC§
);

1453  
SQLITE4_OK
;

1454 
	}
}

1467 
	$·s3Curs‹SìkStmt
(
Fts3Curs‹
 *
pC§
, 
sqlôe4_°mt
 **
µStmt
){

1468 
rc
 = 
SQLITE4_OK
;

1469 if–
pC§
->
pStmt
==0 ){

1470 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

1471 *
zSql
;

1472 
zSql
 = 
	`sqlôe4_m¥ötf
("SELECT %†WHEREÑowid = ?", 
p
->
zRódEx¥li°
);

1473 if–!
zSql
 )  
SQLITE4_NOMEM
;

1474 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
p
->
db
, 
zSql
, -1, &
pC§
->
pStmt
, 0);

1475 
	`sqlôe4_‰ì
(
zSql
);

1477 *
µStmt
 = 
pC§
->
pStmt
;

1478  
rc
;

1479 
	}
}

1486 
	$·s3Curs‹Sìk
(
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
, 
Fts3Curs‹
 *
pC§
){

1487 
rc
 = 
SQLITE4_OK
;

1488 if–
pC§
->
isRequúeSìk
 ){

1489 
sqlôe4_°mt
 *
pStmt
 = 0;

1491 
rc
 = 
	`·s3Curs‹SìkStmt
(
pC§
, &
pStmt
);

1492 if–
rc
==
SQLITE4_OK
 ){

1493 
	`sqlôe4_böd_öt64
(
pC§
->
pStmt
, 1,ÖC§->
iPªvId
);

1494 
pC§
->
isRequúeSìk
 = 0;

1495 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pC§
->
pStmt
) ){

1496  
SQLITE4_OK
;

1498 
rc
 = 
	`sqlôe4_ª£t
(
pC§
->
pStmt
);

1499 if–
rc
==
SQLITE4_OK
 && ((
Fts3TabÀ
 *)
pC§
->
ba£
.
pVèb
)->
zC⁄ã¡Tbl
==0 ){

1503 
rc
 = 
FTS_CORRUPT_VTAB
;

1504 
pC§
->
isEof
 = 1;

1510 if–
rc
!=
SQLITE4_OK
 && 
pC⁄ãxt
 ){

1511 
	`sqlôe4_ªsu…_îr‹_code
(
pC⁄ãxt
, 
rc
);

1513  
rc
;

1514 
	}
}

1531 
	$·s3SˇnI¡îi‹Node
(

1532 c⁄° *
zTîm
,

1533 
nTîm
,

1534 c⁄° *
zNode
,

1535 
nNode
,

1536 
sqlôe4_öt64
 *
piFú°
,

1537 
sqlôe4_öt64
 *
piLa°


1539 
rc
 = 
SQLITE4_OK
;

1540 c⁄° *
zC§
 = 
zNode
;

1541 c⁄° *
zEnd
 = &
zC§
[
nNode
];

1542 *
zBuf„r
 = 0;

1543 
nAŒoc
 = 0;

1544 
isFú°Tîm
 = 1;

1545 
sqlôe4_öt64
 
iChûd
;

1560 
zC§
 +
	`sqlôe4Fts3GëV¨öt
(zC§, &
iChûd
);

1561 
zC§
 +
	`sqlôe4Fts3GëV¨öt
(zC§, &
iChûd
);

1562 if–
zC§
>
zEnd
 ){

1563  
FTS_CORRUPT_VTAB
;

1566  
zC§
<
zEnd
 && (
piFú°
 || 
piLa°
) ){

1567 
cmp
;

1568 
nSuffix
;

1569 
nPªfix
 = 0;

1570 
nBuf„r
;

1574 if–!
isFú°Tîm
 ){

1575 
zC§
 +
	`sqlôe4Fts3GëV¨öt32
(zC§, &
nPªfix
);

1577 
isFú°Tîm
 = 0;

1578 
zC§
 +
	`sqlôe4Fts3GëV¨öt32
(zC§, &
nSuffix
);

1580 if–
nPªfix
<0 || 
nSuffix
<0 || &
zC§
[nSuffix]>
zEnd
 ){

1581 
rc
 = 
FTS_CORRUPT_VTAB
;

1582 
föish_sˇn
;

1584 if–
nPªfix
+
nSuffix
>
nAŒoc
 ){

1585 *
zNew
;

1586 
nAŒoc
 = (
nPªfix
+
nSuffix
) * 2;

1587 
zNew
 = (*)
	`sqlôe4_ªÆloc
(
zBuf„r
, 
nAŒoc
);

1588 if–!
zNew
 ){

1589 
rc
 = 
SQLITE4_NOMEM
;

1590 
föish_sˇn
;

1592 
zBuf„r
 = 
zNew
;

1594 
	`as£π
–
zBuf„r
 );

1595 
	`mem˝y
(&
zBuf„r
[
nPªfix
], 
zC§
, 
nSuffix
);

1596 
nBuf„r
 = 
nPªfix
 + 
nSuffix
;

1597 
zC§
 +
nSuffix
;

1608 
cmp
 = 
	`memcmp
(
zTîm
, 
zBuf„r
, (
nBuf„r
>
nTîm
 ?ÇTerm :ÇBuffer));

1609 if–
piFú°
 && (
cmp
<0 || (cmp==0 && 
nBuf„r
>
nTîm
)) ){

1610 *
piFú°
 = 
iChûd
;

1611 
piFú°
 = 0;

1614 if–
piLa°
 && 
cmp
<0 ){

1615 *
piLa°
 = 
iChûd
;

1616 
piLa°
 = 0;

1619 
iChûd
++;

1622 if–
piFú°
 ) *piFú° = 
iChûd
;

1623 if–
piLa°
 ) *piLa° = 
iChûd
;

1625 
föish_sˇn
:

1626 
	`sqlôe4_‰ì
(
zBuf„r
);

1627  
rc
;

1628 
	}
}

1652 
	$·s3Sñe˘Lóf
(

1653 
Fts3TabÀ
 *
p
,

1654 c⁄° *
zTîm
,

1655 
nTîm
,

1656 c⁄° *
zNode
,

1657 
nNode
,

1658 
sqlôe4_öt64
 *
piLóf
,

1659 
sqlôe4_öt64
 *
piLóf2


1661 
rc
;

1662 
iHeight
;

1664 
	`as£π
–
piLóf
 || 
piLóf2
 );

1666 
	`sqlôe4Fts3GëV¨öt32
(
zNode
, &
iHeight
);

1667 
rc
 = 
	`·s3SˇnI¡îi‹Node
(
zTîm
, 
nTîm
, 
zNode
, 
nNode
, 
piLóf
, 
piLóf2
);

1668 
	`as£π
–!
piLóf2
 || !
piLóf
 || 
rc
!=
SQLITE4_OK
 || (*piLeaf<=*piLeaf2) );

1670 if–
rc
==
SQLITE4_OK
 && 
iHeight
>1 ){

1671 *
zBlob
 = 0;

1672 
nBlob
;

1674 if–
piLóf
 && 
piLóf2
 && (*piLeaf!=*piLeaf2) ){

1675 
rc
 = 
	`sqlôe4Fts3RódBlock
(
p
, *
piLóf
, &
zBlob
, &
nBlob
, 0);

1676 if–
rc
==
SQLITE4_OK
 ){

1677 
rc
 = 
	`·s3Sñe˘Lóf
(
p
, 
zTîm
, 
nTîm
, 
zBlob
, 
nBlob
, 
piLóf
, 0);

1679 
	`sqlôe4_‰ì
(
zBlob
);

1680 
piLóf
 = 0;

1681 
zBlob
 = 0;

1684 if–
rc
==
SQLITE4_OK
 ){

1685 
rc
 = 
	`sqlôe4Fts3RódBlock
(
p
, 
piLóf
?*piLóf:*
piLóf2
, &
zBlob
, &
nBlob
, 0);

1687 if–
rc
==
SQLITE4_OK
 ){

1688 
rc
 = 
	`·s3Sñe˘Lóf
(
p
, 
zTîm
, 
nTîm
, 
zBlob
, 
nBlob
, 
piLóf
, 
piLóf2
);

1690 
	`sqlôe4_‰ì
(
zBlob
);

1693  
rc
;

1694 
	}
}

1700 
	$·s3PutDñèV¨öt
(

1701 **
µ
,

1702 
sqlôe4_öt64
 *
piPªv
,

1703 
sqlôe4_öt64
 
iVÆ


1705 
	`as£π
–
iVÆ
-*
piPªv
 > 0 || (*piPrev==0 && iVal==0) );

1706 *
µ
 +
	`sqlôe4Fts3PutV¨öt
(*µ, 
iVÆ
-*
piPªv
);

1707 *
piPªv
 = 
iVÆ
;

1708 
	}
}

1724 
	$·s3Po¶i°C›y
(**
µ
, **
µPo¶i°
){

1725 *
pEnd
 = *
µPo¶i°
;

1726 
c
 = 0;

1738  *
pEnd
 | 
c
 ){

1739 
c
 = *
pEnd
++ & 0x80;

1740 
	`ã°ˇ£
–
c
!=0 && (*
pEnd
)==0 );

1742 
pEnd
++;

1744 if–
µ
 ){

1745 
n
 = ()(
pEnd
 - *
µPo¶i°
);

1746 *
p
 = *
µ
;

1747 
	`mem˝y
(
p
, *
µPo¶i°
, 
n
);

1748 
p
 +
n
;

1749 *
µ
 = 
p
;

1751 *
µPo¶i°
 = 
pEnd
;

1752 
	}
}

1771 
	$·s3Cﬁum∆i°C›y
(**
µ
, **
µPo¶i°
){

1772 *
pEnd
 = *
µPo¶i°
;

1773 
c
 = 0;

1778  0xFE & (*
pEnd
 | 
c
) ){

1779 
c
 = *
pEnd
++ & 0x80;

1780 
	`ã°ˇ£
–
c
!=0 && ((*
pEnd
)&0xfe)==0 );

1782 if–
µ
 ){

1783 
n
 = ()(
pEnd
 - *
µPo¶i°
);

1784 *
p
 = *
µ
;

1785 
	`mem˝y
(
p
, *
µPo¶i°
, 
n
);

1786 
p
 +
n
;

1787 *
µ
 = 
p
;

1789 *
µPo¶i°
 = 
pEnd
;

1790 
	}
}

1796 
	#POSITION_LIST_END
 0x7fffffff

	)

1816 
	$·s3RódNextPos
(

1817 **
µ
,

1818 
sqlôe4_öt64
 *
pi


1820 if–(**
µ
)&0xFE ){

1821 
	`·s3GëDñèV¨öt
(
µ
, 
pi
);

1822 *
pi
 -= 2;

1824 *
pi
 = 
POSITION_LIST_END
;

1826 
	}
}

1837 
	$·s3PutCﬁNumbî
(**
µ
, 
iCﬁ
){

1838 
n
 = 0;

1839 if–
iCﬁ
 ){

1840 *
p
 = *
µ
;

1841 
n
 = 1 + 
	`sqlôe4Fts3PutV¨öt
(&
p
[1], 
iCﬁ
);

1842 *
p
 = 0x01;

1843 *
µ
 = &
p
[
n
];

1845  
n
;

1846 
	}
}

1855 
	$·s3Po¶i°Mîge
(

1856 **
µ
,

1857 **
µ1
,

1858 **
µ2


1860 *
p
 = *
µ
;

1861 *
p1
 = *
µ1
;

1862 *
p2
 = *
µ2
;

1864  *
p1
 || *
p2
 ){

1865 
iCﬁ1
;

1866 
iCﬁ2
;

1868 if–*
p1
==
POS_COLUMN
 ) 
	`sqlôe4Fts3GëV¨öt32
(&p1[1], &
iCﬁ1
);

1869 if–*
p1
==
POS_END
 ) 
iCﬁ1
 = 
POSITION_LIST_END
;

1870 
iCﬁ1
 = 0;

1872 if–*
p2
==
POS_COLUMN
 ) 
	`sqlôe4Fts3GëV¨öt32
(&p2[1], &
iCﬁ2
);

1873 if–*
p2
==
POS_END
 ) 
iCﬁ2
 = 
POSITION_LIST_END
;

1874 
iCﬁ2
 = 0;

1876 if–
iCﬁ1
==
iCﬁ2
 ){

1877 
sqlôe4_öt64
 
i1
 = 0;

1878 
sqlôe4_öt64
 
i2
 = 0;

1879 
sqlôe4_öt64
 
iPªv
 = 0;

1880 
n
 = 
	`·s3PutCﬁNumbî
(&
p
, 
iCﬁ1
);

1881 
p1
 +
n
;

1882 
p2
 +
n
;

1893 
	`·s3GëDñèV¨öt
(&
p1
, &
i1
);

1894 
	`·s3GëDñèV¨öt
(&
p2
, &
i2
);

1896 
	`·s3PutDñèV¨öt
(&
p
, &
iPªv
, (
i1
<
i2
) ? i1 : i2);

1897 
iPªv
 -= 2;

1898 if–
i1
==
i2
 ){

1899 
	`·s3RódNextPos
(&
p1
, &
i1
);

1900 
	`·s3RódNextPos
(&
p2
, &
i2
);

1901 }if–
i1
<
i2
 ){

1902 
	`·s3RódNextPos
(&
p1
, &
i1
);

1904 
	`·s3RódNextPos
(&
p2
, &
i2
);

1906 } 
i1
!=
POSITION_LIST_END
 || 
i2
!=POSITION_LIST_END );

1907 }if–
iCﬁ1
<
iCﬁ2
 ){

1908 
p1
 +
	`·s3PutCﬁNumbî
(&
p
, 
iCﬁ1
);

1909 
	`·s3Cﬁum∆i°C›y
(&
p
, &
p1
);

1911 
p2
 +
	`·s3PutCﬁNumbî
(&
p
, 
iCﬁ2
);

1912 
	`·s3Cﬁum∆i°C›y
(&
p
, &
p2
);

1916 *
p
++ = 
POS_END
;

1917 *
µ
 = 
p
;

1918 *
µ1
 = 
p1
 + 1;

1919 *
µ2
 = 
p2
 + 1;

1920 
	}
}

1945 
	$·s3Po¶i°Phø£Mîge
(

1946 **
µ
,

1947 
nTokí
,

1948 
isSaveLe·
,

1949 
isExa˘
,

1950 **
µ1
,

1951 **
µ2


1953 *
p
 = *
µ
;

1954 *
p1
 = *
µ1
;

1955 *
p2
 = *
µ2
;

1956 
iCﬁ1
 = 0;

1957 
iCﬁ2
 = 0;

1960 
	`as£π
–
isSaveLe·
==0 || 
isExa˘
==0 );

1962 
	`as£π
–
p
!=0 && *
p1
!=0 && *
p2
!=0 );

1963 if–*
p1
==
POS_COLUMN
 ){

1964 
p1
++;

1965 
p1
 +
	`sqlôe4Fts3GëV¨öt32
’1, &
iCﬁ1
);

1967 if–*
p2
==
POS_COLUMN
 ){

1968 
p2
++;

1969 
p2
 +
	`sqlôe4Fts3GëV¨öt32
’2, &
iCﬁ2
);

1973 if–
iCﬁ1
==
iCﬁ2
 ){

1974 *
pSave
 = 
p
;

1975 
sqlôe4_öt64
 
iPªv
 = 0;

1976 
sqlôe4_öt64
 
iPos1
 = 0;

1977 
sqlôe4_öt64
 
iPos2
 = 0;

1979 if–
iCﬁ1
 ){

1980 *
p
++ = 
POS_COLUMN
;

1981 
p
 +
	`sqlôe4Fts3PutV¨öt
’, 
iCﬁ1
);

1984 
	`as£π
–*
p1
!=
POS_END
 && *p1!=
POS_COLUMN
 );

1985 
	`as£π
–*
p2
!=
POS_END
 && *p2!=
POS_COLUMN
 );

1986 
	`·s3GëDñèV¨öt
(&
p1
, &
iPos1
); iPos1 -= 2;

1987 
	`·s3GëDñèV¨öt
(&
p2
, &
iPos2
); iPos2 -= 2;

1990 if–
iPos2
==
iPos1
+
nTokí


1991 || (
isExa˘
==0 && 
iPos2
>
iPos1
 && iPos2<=iPos1+
nTokí
)

1993 
sqlôe4_öt64
 
iSave
;

1994 
iSave
 = 
isSaveLe·
 ? 
iPos1
 : 
iPos2
;

1995 
	`·s3PutDñèV¨öt
(&
p
, &
iPªv
, 
iSave
+2); iPrev -= 2;

1996 
pSave
 = 0;

1997 
	`as£π
–
p
 );

1999 if–(!
isSaveLe·
 && 
iPos2
<=(
iPos1
+
nTokí
)) || iPos2<=iPos1 ){

2000 if–(*
p2
&0xFE)==0 ) ;

2001 
	`·s3GëDñèV¨öt
(&
p2
, &
iPos2
); iPos2 -= 2;

2003 if–(*
p1
&0xFE)==0 ) ;

2004 
	`·s3GëDñèV¨öt
(&
p1
, &
iPos1
); iPos1 -= 2;

2008 if–
pSave
 ){

2009 
	`as£π
–
µ
 && 
p
 );

2010 
p
 = 
pSave
;

2013 
	`·s3Cﬁum∆i°C›y
(0, &
p1
);

2014 
	`·s3Cﬁum∆i°C›y
(0, &
p2
);

2015 
	`as£π
–(*
p1
&0xFE)==0 && (*
p2
&0xFE)==0 );

2016 if–0==*
p1
 || 0==*
p2
 ) ;

2018 
p1
++;

2019 
p1
 +
	`sqlôe4Fts3GëV¨öt32
’1, &
iCﬁ1
);

2020 
p2
++;

2021 
p2
 +
	`sqlôe4Fts3GëV¨öt32
’2, &
iCﬁ2
);

2029 if–
iCﬁ1
<
iCﬁ2
 ){

2030 
	`·s3Cﬁum∆i°C›y
(0, &
p1
);

2031 if–0==*
p1
 ) ;

2032 
p1
++;

2033 
p1
 +
	`sqlôe4Fts3GëV¨öt32
’1, &
iCﬁ1
);

2035 
	`·s3Cﬁum∆i°C›y
(0, &
p2
);

2036 if–0==*
p2
 ) ;

2037 
p2
++;

2038 
p2
 +
	`sqlôe4Fts3GëV¨öt32
’2, &
iCﬁ2
);

2042 
	`·s3Po¶i°C›y
(0, &
p2
);

2043 
	`·s3Po¶i°C›y
(0, &
p1
);

2044 *
µ1
 = 
p1
;

2045 *
µ2
 = 
p2
;

2046 if–*
µ
==
p
 ){

2049 *
p
++ = 0x00;

2050 *
µ
 = 
p
;

2052 
	}
}

2069 
	$·s3Po¶i°NórMîge
(

2070 **
µ
,

2071 *
aTmp
,

2072 
nRight
,

2073 
nLe·
,

2074 **
µ1
,

2075 **
µ2


2077 *
p1
 = *
µ1
;

2078 *
p2
 = *
µ2
;

2080 *
pTmp1
 = 
aTmp
;

2081 *
pTmp2
;

2082 *
aTmp2
;

2083 
ªs
 = 1;

2085 
	`·s3Po¶i°Phø£Mîge
(&
pTmp1
, 
nRight
, 0, 0, 
µ1
, 
µ2
);

2086 
aTmp2
 = 
pTmp2
 = 
pTmp1
;

2087 *
µ1
 = 
p1
;

2088 *
µ2
 = 
p2
;

2089 
	`·s3Po¶i°Phø£Mîge
(&
pTmp2
, 
nLe·
, 1, 0, 
µ2
, 
µ1
);

2090 if–
pTmp1
!=
aTmp
 && 
pTmp2
!=
aTmp2
 ){

2091 
	`·s3Po¶i°Mîge
(
µ
, &
aTmp
, &
aTmp2
);

2092 }if–
pTmp1
!=
aTmp
 ){

2093 
	`·s3Po¶i°C›y
(
µ
, &
aTmp
);

2094 }if–
pTmp2
!=
aTmp2
 ){

2095 
	`·s3Po¶i°C›y
(
µ
, &
aTmp2
);

2097 
ªs
 = 0;

2100  
ªs
;

2101 
	}
}

2108 
TîmSñe˘
 
	tTîmSñe˘
;

2109 
	sTîmSñe˘
 {

2110 *
	mØOuçut
[16];

2111 
	m™Ouçut
[16];

2127 
	$·s3GëDñèV¨öt3
(

2128 **
µ
,

2129 *
pEnd
,

2130 
bDescIdx
,

2131 
sqlôe4_öt64
 *
pVÆ


2133 if–*
µ
>=
pEnd
 ){

2134 *
µ
 = 0;

2136 
sqlôe4_öt64
 
iVÆ
;

2137 *
µ
 +
	`sqlôe4Fts3GëV¨öt
(*µ, &
iVÆ
);

2138 if–
bDescIdx
 ){

2139 *
pVÆ
 -
iVÆ
;

2141 *
pVÆ
 +
iVÆ
;

2144 
	}
}

2161 
	$·s3PutDñèV¨öt3
(

2162 **
µ
,

2163 
bDescIdx
,

2164 
sqlôe4_öt64
 *
piPªv
,

2165 *
pbFú°
,

2166 
sqlôe4_öt64
 
iVÆ


2168 
sqlôe4_öt64
 
iWrôe
;

2169 if–
bDescIdx
==0 || *
pbFú°
==0 ){

2170 
iWrôe
 = 
iVÆ
 - *
piPªv
;

2172 
iWrôe
 = *
piPªv
 - 
iVÆ
;

2174 
	`as£π
–*
pbFú°
 || *
piPªv
==0 );

2175 
	`as£π
–*
pbFú°
==0 || 
iWrôe
>0 );

2176 *
µ
 +
	`sqlôe4Fts3PutV¨öt
(*µ, 
iWrôe
);

2177 *
piPªv
 = 
iVÆ
;

2178 *
pbFú°
 = 1;

2179 
	}
}

2191 
	#DOCID_CMP
(
i1
, 
i2
Ë((
bDescDo˛i°
?-1:1Ë* (i1-i2))

	)

2207 
	$·s3Do˛i°OrMîge
(

2208 
bDescDo˛i°
,

2209 *
a1
, 
n1
,

2210 *
a2
, 
n2
,

2211 **
∑Out
, *
≤Out


2213 
sqlôe4_öt64
 
i1
 = 0;

2214 
sqlôe4_öt64
 
i2
 = 0;

2215 
sqlôe4_öt64
 
iPªv
 = 0;

2216 *
pEnd1
 = &
a1
[
n1
];

2217 *
pEnd2
 = &
a2
[
n2
];

2218 *
p1
 = 
a1
;

2219 *
p2
 = 
a2
;

2220 *
p
;

2221 *
aOut
;

2222 
bFú°Out
 = 0;

2224 *
∑Out
 = 0;

2225 *
≤Out
 = 0;

2256 
aOut
 = 
	`sqlôe4_mÆloc
(
n1
+
n2
+
FTS3_VARINT_MAX
-1);

2257 if–!
aOut
 )  
SQLITE4_NOMEM
;

2259 
p
 = 
aOut
;

2260 
	`·s3GëDñèV¨öt3
(&
p1
, 
pEnd1
, 0, &
i1
);

2261 
	`·s3GëDñèV¨öt3
(&
p2
, 
pEnd2
, 0, &
i2
);

2262  
p1
 || 
p2
 ){

2263 
sqlôe4_öt64
 
iDiff
 = 
	`DOCID_CMP
(
i1
, 
i2
);

2265 if–
p2
 && 
p1
 && 
iDiff
==0 ){

2266 
	`·s3PutDñèV¨öt3
(&
p
, 
bDescDo˛i°
, &
iPªv
, &
bFú°Out
, 
i1
);

2267 
	`·s3Po¶i°Mîge
(&
p
, &
p1
, &
p2
);

2268 
	`·s3GëDñèV¨öt3
(&
p1
, 
pEnd1
, 
bDescDo˛i°
, &
i1
);

2269 
	`·s3GëDñèV¨öt3
(&
p2
, 
pEnd2
, 
bDescDo˛i°
, &
i2
);

2270 }if–!
p2
 || (
p1
 && 
iDiff
<0) ){

2271 
	`·s3PutDñèV¨öt3
(&
p
, 
bDescDo˛i°
, &
iPªv
, &
bFú°Out
, 
i1
);

2272 
	`·s3Po¶i°C›y
(&
p
, &
p1
);

2273 
	`·s3GëDñèV¨öt3
(&
p1
, 
pEnd1
, 
bDescDo˛i°
, &
i1
);

2275 
	`·s3PutDñèV¨öt3
(&
p
, 
bDescDo˛i°
, &
iPªv
, &
bFú°Out
, 
i2
);

2276 
	`·s3Po¶i°C›y
(&
p
, &
p2
);

2277 
	`·s3GëDñèV¨öt3
(&
p2
, 
pEnd2
, 
bDescDo˛i°
, &
i2
);

2281 *
∑Out
 = 
aOut
;

2282 *
≤Out
 = (
p
-
aOut
);

2283 
	`as£π
–*
≤Out
<=
n1
+
n2
+
FTS3_VARINT_MAX
-1 );

2284  
SQLITE4_OK
;

2285 
	}
}

2299 
	$·s3Do˛i°Phø£Mîge
(

2300 
bDescDo˛i°
,

2301 
nDi°
,

2302 *
aLe·
, 
nLe·
,

2303 *
aRight
, *
≤Right


2305 
sqlôe4_öt64
 
i1
 = 0;

2306 
sqlôe4_öt64
 
i2
 = 0;

2307 
sqlôe4_öt64
 
iPªv
 = 0;

2308 *
pEnd1
 = &
aLe·
[
nLe·
];

2309 *
pEnd2
 = &
aRight
[*
≤Right
];

2310 *
p1
 = 
aLe·
;

2311 *
p2
 = 
aRight
;

2312 *
p
;

2313 
bFú°Out
 = 0;

2314 *
aOut
 = 
aRight
;

2316 
	`as£π
–
nDi°
>0 );

2318 
p
 = 
aOut
;

2319 
	`·s3GëDñèV¨öt3
(&
p1
, 
pEnd1
, 0, &
i1
);

2320 
	`·s3GëDñèV¨öt3
(&
p2
, 
pEnd2
, 0, &
i2
);

2322  
p1
 && 
p2
 ){

2323 
sqlôe4_öt64
 
iDiff
 = 
	`DOCID_CMP
(
i1
, 
i2
);

2324 if–
iDiff
==0 ){

2325 *
pSave
 = 
p
;

2326 
sqlôe4_öt64
 
iPªvSave
 = 
iPªv
;

2327 
bFú°OutSave
 = 
bFú°Out
;

2329 
	`·s3PutDñèV¨öt3
(&
p
, 
bDescDo˛i°
, &
iPªv
, &
bFú°Out
, 
i1
);

2330 if–0==
	`·s3Po¶i°Phø£Mîge
(&
p
, 
nDi°
, 0, 1, &
p1
, &
p2
) ){

2331 
p
 = 
pSave
;

2332 
iPªv
 = 
iPªvSave
;

2333 
bFú°Out
 = 
bFú°OutSave
;

2335 
	`·s3GëDñèV¨öt3
(&
p1
, 
pEnd1
, 
bDescDo˛i°
, &
i1
);

2336 
	`·s3GëDñèV¨öt3
(&
p2
, 
pEnd2
, 
bDescDo˛i°
, &
i2
);

2337 }if–
iDiff
<0 ){

2338 
	`·s3Po¶i°C›y
(0, &
p1
);

2339 
	`·s3GëDñèV¨öt3
(&
p1
, 
pEnd1
, 
bDescDo˛i°
, &
i1
);

2341 
	`·s3Po¶i°C›y
(0, &
p2
);

2342 
	`·s3GëDñèV¨öt3
(&
p2
, 
pEnd2
, 
bDescDo˛i°
, &
i2
);

2346 *
≤Right
 = 
p
 - 
aOut
;

2347 
	}
}

2357 
	$sqlôe4Fts3Fú°Fûãr
(

2358 
sqlôe4_öt64
 
iDñè
,

2359 *
pLi°
,

2360 
nLi°
,

2361 *
pOut


2363 
nOut
 = 0;

2364 
bWrôãn
 = 0;

2365 *
p
 = 
pLi°
;

2366 *
pEnd
 = &
pLi°
[
nLi°
];

2368 if–*
p
!=0x01 ){

2369 if–*
p
==0x02 ){

2370 
nOut
 +
	`sqlôe4Fts3PutV¨öt
(&
pOut
[nOut], 
iDñè
);

2371 
pOut
[
nOut
++] = 0x02;

2372 
bWrôãn
 = 1;

2374 
	`·s3Cﬁum∆i°C›y
(0, &
p
);

2377  
p
<
pEnd
 && *p==0x01 ){

2378 
sqlôe4_öt64
 
iCﬁ
;

2379 
p
++;

2380 
p
 +
	`sqlôe4Fts3GëV¨öt
’, &
iCﬁ
);

2381 if–*
p
==0x02 ){

2382 if–
bWrôãn
==0 ){

2383 
nOut
 +
	`sqlôe4Fts3PutV¨öt
(&
pOut
[nOut], 
iDñè
);

2384 
bWrôãn
 = 1;

2386 
pOut
[
nOut
++] = 0x01;

2387 
nOut
 +
	`sqlôe4Fts3PutV¨öt
(&
pOut
[nOut], 
iCﬁ
);

2388 
pOut
[
nOut
++] = 0x02;

2390 
	`·s3Cﬁum∆i°C›y
(0, &
p
);

2392 if–
bWrôãn
 ){

2393 
pOut
[
nOut
++] = 0x00;

2396  
nOut
;

2397 
	}
}

2409 
	$·s3TîmSñe˘FöishMîge
(
Fts3TabÀ
 *
p
, 
TîmSñe˘
 *
pTS
){

2410 *
aOut
 = 0;

2411 
nOut
 = 0;

2412 
i
;

2417 
i
=0; i<
	`SizeofAºay
(
pTS
->
ØOuçut
); i++){

2418 if–
pTS
->
ØOuçut
[
i
] ){

2419 if–!
aOut
 ){

2420 
aOut
 = 
pTS
->
ØOuçut
[
i
];

2421 
nOut
 = 
pTS
->
™Ouçut
[
i
];

2422 
pTS
->
ØOuçut
[
i
] = 0;

2424 
nNew
;

2425 *
aNew
;

2427 
rc
 = 
	`·s3Do˛i°OrMîge
(
p
->
bDescIdx
,

2428 
pTS
->
ØOuçut
[
i
],ÖTS->
™Ouçut
[i], 
aOut
, 
nOut
, &
aNew
, &
nNew


2430 if–
rc
!=
SQLITE4_OK
 ){

2431 
	`sqlôe4_‰ì
(
aOut
);

2432  
rc
;

2435 
	`sqlôe4_‰ì
(
pTS
->
ØOuçut
[
i
]);

2436 
	`sqlôe4_‰ì
(
aOut
);

2437 
pTS
->
ØOuçut
[
i
] = 0;

2438 
aOut
 = 
aNew
;

2439 
nOut
 = 
nNew
;

2444 
pTS
->
ØOuçut
[0] = 
aOut
;

2445 
pTS
->
™Ouçut
[0] = 
nOut
;

2446  
SQLITE4_OK
;

2447 
	}
}

2463 
	$·s3TîmSñe˘Mîge
(

2464 
Fts3TabÀ
 *
p
,

2465 
TîmSñe˘
 *
pTS
,

2466 *
aDo˛i°
,

2467 
nDo˛i°


2469 if–
pTS
->
ØOuçut
[0]==0 ){

2472 
pTS
->
ØOuçut
[0] = 
	`sqlôe4_mÆloc
(
nDo˛i°
);

2473 
pTS
->
™Ouçut
[0] = 
nDo˛i°
;

2474 if–
pTS
->
ØOuçut
[0] ){

2475 
	`mem˝y
(
pTS
->
ØOuçut
[0], 
aDo˛i°
, 
nDo˛i°
);

2477  
SQLITE4_NOMEM
;

2480 *
aMîge
 = 
aDo˛i°
;

2481 
nMîge
 = 
nDo˛i°
;

2482 
iOut
;

2484 
iOut
=0; iOut<
	`SizeofAºay
(
pTS
->
ØOuçut
); iOut++){

2485 if–
pTS
->
ØOuçut
[
iOut
]==0 ){

2486 
	`as£π
–
iOut
>0 );

2487 
pTS
->
ØOuçut
[
iOut
] = 
aMîge
;

2488 
pTS
->
™Ouçut
[
iOut
] = 
nMîge
;

2491 *
aNew
;

2492 
nNew
;

2494 
rc
 = 
	`·s3Do˛i°OrMîge
(
p
->
bDescIdx
, 
aMîge
, 
nMîge
,

2495 
pTS
->
ØOuçut
[
iOut
],ÖTS->
™Ouçut
[iOut], &
aNew
, &
nNew


2497 if–
rc
!=
SQLITE4_OK
 ){

2498 if–
aMîge
!=
aDo˛i°
 ) 
	`sqlôe4_‰ì
(aMerge);

2499  
rc
;

2502 if–
aMîge
!=
aDo˛i°
 ) 
	`sqlôe4_‰ì
(aMerge);

2503 
	`sqlôe4_‰ì
(
pTS
->
ØOuçut
[
iOut
]);

2504 
pTS
->
ØOuçut
[
iOut
] = 0;

2506 
aMîge
 = 
aNew
;

2507 
nMîge
 = 
nNew
;

2508 if–(
iOut
+1)==
	`SizeofAºay
(
pTS
->
ØOuçut
) ){

2509 
pTS
->
ØOuçut
[
iOut
] = 
aMîge
;

2510 
pTS
->
™Ouçut
[
iOut
] = 
nMîge
;

2515  
SQLITE4_OK
;

2516 
	}
}

2521 
	$·s3SegRódîCurs‹Aµíd
(

2522 
Fts3Mu…iSegRódî
 *
pC§
,

2523 
Fts3SegRódî
 *
pNew


2525 if–(
pC§
->
nSegmít
%16)==0 ){

2526 
Fts3SegRódî
 **
≠New
;

2527 
nByã
 = (
pC§
->
nSegmít
 + 16)*(
Fts3SegRódî
*);

2528 
≠New
 = (
Fts3SegRódî
 **)
	`sqlôe4_ªÆloc
(
pC§
->
≠Segmít
, 
nByã
);

2529 if–!
≠New
 ){

2530 
	`sqlôe4Fts3SegRódîFªe
(
pNew
);

2531  
SQLITE4_NOMEM
;

2533 
pC§
->
≠Segmít
 = 
≠New
;

2535 
pC§
->
≠Segmít
[pC§->
nSegmít
++] = 
pNew
;

2536  
SQLITE4_OK
;

2537 
	}
}

2546 
	$·s3SegRódîCurs‹
(

2547 
Fts3TabÀ
 *
p
,

2548 
iIndex
,

2549 
iLevñ
,

2550 c⁄° *
zTîm
,

2551 
nTîm
,

2552 
isPªfix
,

2553 
isSˇn
,

2554 
Fts3Mu…iSegRódî
 *
pC§


2556 
rc
 = 
SQLITE4_OK
;

2557 
sqlôe4_°mt
 *
pStmt
 = 0;

2558 
rc2
;

2566 if–
iLevñ
<0 && 
p
->
aIndex
 ){

2567 
Fts3SegRódî
 *
pSeg
 = 0;

2568 
rc
 = 
	`sqlôe4Fts3SegRódîPídög
(
p
, 
iIndex
, 
zTîm
, 
nTîm
, 
isPªfix
, &
pSeg
);

2569 if–
rc
==
SQLITE4_OK
 && 
pSeg
 ){

2570 
rc
 = 
	`·s3SegRódîCurs‹Aµíd
(
pC§
, 
pSeg
);

2574 if–
iLevñ
!=
FTS3_SEGCURSOR_PENDING
 ){

2575 if–
rc
==
SQLITE4_OK
 ){

2576 
rc
 = 
	`sqlôe4Fts3AŒSegdús
(
p
, 
iIndex
, 
iLevñ
, &
pStmt
);

2579  
rc
==
SQLITE4_OK
 && 
SQLITE4_ROW
==‘¯
	`sqlôe4_°ï
(
pStmt
)) ){

2580 
Fts3SegRódî
 *
pSeg
 = 0;

2583 
sqlôe4_öt64
 
iSèπBlock
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 1);

2584 
sqlôe4_öt64
 
iLóvesEndBlock
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 2);

2585 
sqlôe4_öt64
 
iEndBlock
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 3);

2586 
nRoŸ
 = 
	`sqlôe4_cﬁumn_byãs
(
pStmt
, 4);

2587 c⁄° *
zRoŸ
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 4);

2591 if–
iSèπBlock
 && 
zTîm
 ){

2592 
sqlôe4_öt64
 *
pi
 = (
isPªfix
 ? &
iLóvesEndBlock
 : 0);

2593 
rc
 = 
	`·s3Sñe˘Lóf
(
p
, 
zTîm
, 
nTîm
, 
zRoŸ
, 
nRoŸ
, &
iSèπBlock
, 
pi
);

2594 if–
rc
!=
SQLITE4_OK
 ) 
föished
;

2595 if–
isPªfix
==0 && 
isSˇn
==0 ) 
iLóvesEndBlock
 = 
iSèπBlock
;

2598 
rc
 = 
	`sqlôe4Fts3SegRódîNew
(
pC§
->
nSegmít
+1,

2599 
iSèπBlock
, 
iLóvesEndBlock
, 
iEndBlock
, 
zRoŸ
, 
nRoŸ
, &
pSeg


2601 if–
rc
!=
SQLITE4_OK
 ) 
föished
;

2602 
rc
 = 
	`·s3SegRódîCurs‹Aµíd
(
pC§
, 
pSeg
);

2606 
föished
:

2607 
rc2
 = 
	`sqlôe4_ª£t
(
pStmt
);

2608 if–
rc
==
SQLITE4_DONE
 )Ñ¯
rc2
;

2610  
rc
;

2611 
	}
}

2617 
	$sqlôe4Fts3SegRódîCurs‹
(

2618 
Fts3TabÀ
 *
p
,

2619 
iIndex
,

2620 
iLevñ
,

2621 c⁄° *
zTîm
,

2622 
nTîm
,

2623 
isPªfix
,

2624 
isSˇn
,

2625 
Fts3Mu…iSegRódî
 *
pC§


2627 
	`as£π
–
iIndex
>=0 && iIndex<
p
->
nIndex
 );

2628 
	`as£π
–
iLevñ
==
FTS3_SEGCURSOR_ALL


2629 || 
iLevñ
==
FTS3_SEGCURSOR_PENDING


2630 || 
iLevñ
>=0

2632 
	`as£π
–
iLevñ
<
FTS3_SEGDIR_MAXLEVEL
 );

2633 
	`as£π
–
FTS3_SEGCURSOR_ALL
<0 && 
FTS3_SEGCURSOR_PENDING
<0 );

2634 
	`as£π
–
isPªfix
==0 || 
isSˇn
==0 );

2638 
	`as£π
–
isSˇn
==0 || 
p
->
aIndex
==0 );

2640 
	`mem£t
(
pC§
, 0, (
Fts3Mu…iSegRódî
));

2642  
	`·s3SegRódîCurs‹
(

2643 
p
, 
iIndex
, 
iLevñ
, 
zTîm
, 
nTîm
, 
isPªfix
, 
isSˇn
, 
pC§


2645 
	}
}

2653 
	$·s3SegRódîCurs‹AddZîo
(

2654 
Fts3TabÀ
 *
p
,

2655 c⁄° *
zTîm
,

2656 
nTîm
,

2657 
Fts3Mu…iSegRódî
 *
pC§


2659  
	`·s3SegRódîCurs‹
(
p
, 0, 
FTS3_SEGCURSOR_ALL
, 
zTîm
, 
nTîm
, 0, 0,
pC§
);

2660 
	}
}

2675 
	$·s3TîmSegRódîCurs‹
(

2676 
Fts3Curs‹
 *
pC§
,

2677 c⁄° *
zTîm
,

2678 
nTîm
,

2679 
isPªfix
,

2680 
Fts3Mu…iSegRódî
 **
µSegc§


2682 
Fts3Mu…iSegRódî
 *
pSegc§
;

2683 
rc
 = 
SQLITE4_NOMEM
;

2685 
pSegc§
 = 
	`sqlôe4_mÆloc
((
Fts3Mu…iSegRódî
));

2686 if–
pSegc§
 ){

2687 
i
;

2688 
bFound
 = 0;

2689 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

2691 if–
isPªfix
 ){

2692 
i
=1; 
bFound
==0 && i<
p
->
nIndex
; i++){

2693 if–
p
->
aIndex
[
i
].
nPªfix
==
nTîm
 ){

2694 
bFound
 = 1;

2695 
rc
 = 
	`sqlôe4Fts3SegRódîCurs‹
(

2696 
p
, 
i
, 
FTS3_SEGCURSOR_ALL
, 
zTîm
, 
nTîm
, 0, 0, 
pSegc§
);

2697 
pSegc§
->
bLookup
 = 1;

2701 
i
=1; 
bFound
==0 && i<
p
->
nIndex
; i++){

2702 if–
p
->
aIndex
[
i
].
nPªfix
==
nTîm
+1 ){

2703 
bFound
 = 1;

2704 
rc
 = 
	`sqlôe4Fts3SegRódîCurs‹
(

2705 
p
, 
i
, 
FTS3_SEGCURSOR_ALL
, 
zTîm
, 
nTîm
, 1, 0, 
pSegc§


2707 if–
rc
==
SQLITE4_OK
 ){

2708 
rc
 = 
	`·s3SegRódîCurs‹AddZîo
(
p
, 
zTîm
, 
nTîm
, 
pSegc§
);

2714 if–
bFound
==0 ){

2715 
rc
 = 
	`sqlôe4Fts3SegRódîCurs‹
(

2716 
p
, 0, 
FTS3_SEGCURSOR_ALL
, 
zTîm
, 
nTîm
, 
isPªfix
, 0, 
pSegc§


2718 
pSegc§
->
bLookup
 = !
isPªfix
;

2722 *
µSegc§
 = 
pSegc§
;

2723  
rc
;

2724 
	}
}

2729 
	$·s3SegRódîCurs‹Fªe
(
Fts3Mu…iSegRódî
 *
pSegc§
){

2730 
	`sqlôe4Fts3SegRódîFöish
(
pSegc§
);

2731 
	`sqlôe4_‰ì
(
pSegc§
);

2732 
	}
}

2738 
	$·s3TîmSñe˘
(

2739 
Fts3TabÀ
 *
p
,

2740 
Fts3Phø£Tokí
 *
pTok
,

2741 
iCﬁumn
,

2742 *
≤Out
,

2743 **
µOut


2745 
rc
;

2746 
Fts3Mu…iSegRódî
 *
pSegc§
;

2747 
TîmSñe˘
 
tsc
;

2748 
Fts3SegFûãr
 
fûãr
;

2750 
pSegc§
 = 
pTok
->pSegcsr;

2751 
	`mem£t
(&
tsc
, 0, (
TîmSñe˘
));

2753 
fûãr
.
Êags
 = 
FTS3_SEGMENT_IGNORE_EMPTY
 | 
FTS3_SEGMENT_REQUIRE_POS


2754 | (
pTok
->
isPªfix
 ? 
FTS3_SEGMENT_PREFIX
 : 0)

2755 | (
pTok
->
bFú°
 ? 
FTS3_SEGMENT_FIRST
 : 0)

2756 | (
iCﬁumn
<
p
->
nCﬁumn
 ? 
FTS3_SEGMENT_COLUMN_FILTER
 : 0);

2757 
fûãr
.
iCﬁ
 = 
iCﬁumn
;

2758 
fûãr
.
zTîm
 = 
pTok
->
z
;

2759 
fûãr
.
nTîm
 = 
pTok
->
n
;

2761 
rc
 = 
	`sqlôe4Fts3SegRódîSèπ
(
p
, 
pSegc§
, &
fûãr
);

2762  
SQLITE4_OK
==
rc


2763 && 
SQLITE4_ROW
==(
rc
 = 
	`sqlôe4Fts3SegRódîSãp
(
p
, 
pSegc§
))

2765 
rc
 = 
	`·s3TîmSñe˘Mîge
(
p
, &
tsc
, 
pSegc§
->
aDo˛i°
,ÖSegc§->
nDo˛i°
);

2768 if–
rc
==
SQLITE4_OK
 ){

2769 
rc
 = 
	`·s3TîmSñe˘FöishMîge
(
p
, &
tsc
);

2771 if–
rc
==
SQLITE4_OK
 ){

2772 *
µOut
 = 
tsc
.
ØOuçut
[0];

2773 *
≤Out
 = 
tsc
.
™Ouçut
[0];

2775 
i
;

2776 
i
=0; i<
	`SizeofAºay
(
tsc
.
ØOuçut
); i++){

2777 
	`sqlôe4_‰ì
(
tsc
.
ØOuçut
[
i
]);

2781 
	`·s3SegRódîCurs‹Fªe
(
pSegc§
);

2782 
pTok
->
pSegc§
 = 0;

2783  
rc
;

2784 
	}
}

2795 
	$·s3Do˛i°Cou¡Docids
(*
aLi°
, 
nLi°
){

2796 
nDoc
 = 0;

2797 if–
aLi°
 ){

2798 *
aEnd
 = &
aLi°
[
nLi°
];

2799 *
p
 = 
aLi°
;

2800  
p
<
aEnd
 ){

2801 
nDoc
++;

2802  (*
p
++)&0x80 );

2803 
	`·s3Po¶i°C›y
(0, &
p
);

2807  
nDoc
;

2808 
	}
}

2821 
	$·s3NextMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

2822 
rc
;

2823 
Fts3Curs‹
 *
pC§
 = (Fts3Curs‹ *)
pCurs‹
;

2824 if–
pC§
->
eSórch
==
FTS3_DOCID_SEARCH
 ||ÖC§->eSórch==
FTS3_FULLSCAN_SEARCH
 ){

2825 if–
SQLITE4_ROW
!=
	`sqlôe4_°ï
(
pC§
->
pStmt
) ){

2826 
pC§
->
isEof
 = 1;

2827 
rc
 = 
	`sqlôe4_ª£t
(
pC§
->
pStmt
);

2829 
pC§
->
iPªvId
 = 
	`sqlôe4_cﬁumn_öt64
’C§->
pStmt
, 0);

2830 
rc
 = 
SQLITE4_OK
;

2833 
rc
 = 
	`·s3EvÆNext
((
Fts3Curs‹
 *)
pCurs‹
);

2835 
	`as£π
–((
Fts3TabÀ
 *)
pC§
->
ba£
.
pVèb
)->
pSegmíts
==0 );

2836  
rc
;

2837 
	}
}

2855 
	$·s3FûãrMëhod
(

2856 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

2857 
idxNum
,

2858 c⁄° *
idxSå
,

2859 
nVÆ
,

2860 
sqlôe4_vÆue
 **
≠VÆ


2862 
rc
;

2863 *
zSql
;

2864 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pCurs‹
->
pVèb
;

2865 
Fts3Curs‹
 *
pC§
 = (Fts3Curs‹ *)
pCurs‹
;

2867 
	`UNUSED_PARAMETER
(
idxSå
);

2868 
	`UNUSED_PARAMETER
(
nVÆ
);

2870 
	`as£π
–
idxNum
>=0 && idxNum<=(
FTS3_FULLTEXT_SEARCH
+
p
->
nCﬁumn
) );

2871 
	`as£π
–
nVÆ
==0 ||ÇVal==1 );

2872 
	`as£π
–(
nVÆ
==0)==(
idxNum
==
FTS3_FULLSCAN_SEARCH
) );

2873 
	`as£π
–
p
->
pSegmíts
==0 );

2876 
	`sqlôe4_föÆize
(
pC§
->
pStmt
);

2877 
	`sqlôe4_‰ì
(
pC§
->
aDo˛i°
);

2878 
	`sqlôe4Fts3Ex¥Fªe
(
pC§
->
pEx¥
);

2879 
	`mem£t
(&
pCurs‹
[1], 0, (
Fts3Curs‹
)-(
sqlôe4_vèb_curs‹
));

2881 if–
idxSå
 ){

2882 
pC§
->
bDesc
 = (
idxSå
[0]=='D');

2884 
pC§
->
bDesc
 = 
p
->
bDescIdx
;

2886 
pC§
->
eSórch
 = (
i16
)
idxNum
;

2888 if–
idxNum
!=
FTS3_DOCID_SEARCH
 && idxNum!=
FTS3_FULLSCAN_SEARCH
 ){

2889 
iCﬁ
 = 
idxNum
-
FTS3_FULLTEXT_SEARCH
;

2890 c⁄° *
zQuîy
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[0]);

2892 if–
zQuîy
==0 && 
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[0])!=
SQLITE4_NULL
 ){

2893  
SQLITE4_NOMEM
;

2896 
rc
 = 
	`sqlôe4Fts3Ex¥P¨£
(
p
->
pTokíizî
,Ö->
azCﬁumn
,Ö->
bHasSèt
,

2897 
p
->
nCﬁumn
, 
iCﬁ
, 
zQuîy
, -1, &
pC§
->
pEx¥


2899 if–
rc
!=
SQLITE4_OK
 ){

2900 if–
rc
==
SQLITE4_ERROR
 ){

2901 c⁄° *
zEº
 = "malformed MATCHÉxpression: [%s]";

2902 
p
->
ba£
.
zEºMsg
 = 
	`sqlôe4_m¥ötf
(
zEº
, 
zQuîy
);

2904  
rc
;

2907 
rc
 = 
	`sqlôe4Fts3RódLock
(
p
);

2908 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2910 
rc
 = 
	`·s3EvÆSèπ
(
pC§
);

2912 
	`sqlôe4Fts3SegmítsClo£
(
p
);

2913 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2914 
pC§
->
pNextId
 =ÖC§->
aDo˛i°
;

2915 
pC§
->
iPªvId
 = 0;

2923 if–
idxNum
==
FTS3_FULLSCAN_SEARCH
 ){

2924 
zSql
 = 
	`sqlôe4_m¥ötf
(

2926 
p
->
zRódEx¥li°
, (
pC§
->
bDesc
 ? "DESC" : "ASC")

2928 if–
zSql
 ){

2929 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
p
->
db
, 
zSql
, -1, &
pC§
->
pStmt
, 0);

2930 
	`sqlôe4_‰ì
(
zSql
);

2932 
rc
 = 
SQLITE4_NOMEM
;

2934 }if–
idxNum
==
FTS3_DOCID_SEARCH
 ){

2935 
rc
 = 
	`·s3Curs‹SìkStmt
(
pC§
, &pC§->
pStmt
);

2936 if–
rc
==
SQLITE4_OK
 ){

2937 
rc
 = 
	`sqlôe4_böd_vÆue
(
pC§
->
pStmt
, 1, 
≠VÆ
[0]);

2940 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2942  
	`·s3NextMëhod
(
pCurs‹
);

2943 
	}
}

2949 
	$·s3EofMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

2950  ((
Fts3Curs‹
 *)
pCurs‹
)->
isEof
;

2951 
	}
}

2959 
	$·s3RowidMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
, 
sqlôe_öt64
 *
pRowid
){

2960 
Fts3Curs‹
 *
pC§
 = (Fts3Curs‹ *Ë
pCurs‹
;

2961 *
pRowid
 = 
pC§
->
iPªvId
;

2962  
SQLITE4_OK
;

2963 
	}
}

2969 
	$·s3CﬁumnMëhod
(

2970 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

2971 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

2972 
iCﬁ


2974 
rc
 = 
SQLITE4_OK
;

2975 
Fts3Curs‹
 *
pC§
 = (Fts3Curs‹ *Ë
pCurs‹
;

2976 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pCurs‹
->
pVèb
;

2979 
	`as£π
–
iCﬁ
>=0 && iCﬁ<=
p
->
nCﬁumn
+1 );

2981 if–
iCﬁ
==
p
->
nCﬁumn
+1 ){

2985 
	`sqlôe4_ªsu…_öt64
(
pC⁄ãxt
, 
pC§
->
iPªvId
);

2986 }if–
iCﬁ
==
p
->
nCﬁumn
 ){

2990 
	`sqlôe4_ªsu…_blob
(
pC⁄ãxt
, &
pC§
, ’C§), 
SQLITE4_TRANSIENT
);

2992 
rc
 = 
	`·s3Curs‹Sìk
(0, 
pC§
);

2993 if–
rc
==
SQLITE4_OK
 && 
	`sqlôe4_d©a_cou¡
(
pC§
->
pStmt
)>(
iCﬁ
+1) ){

2994 
	`sqlôe4_ªsu…_vÆue
(
pC⁄ãxt
, 
	`sqlôe4_cﬁumn_vÆue
(
pC§
->
pStmt
, 
iCﬁ
+1));

2998 
	`as£π
–((
Fts3TabÀ
 *)
pC§
->
ba£
.
pVèb
)->
pSegmíts
==0 );

2999  
rc
;

3000 
	}
}

3007 
	$·s3Upd©eMëhod
(

3008 
sqlôe4_vèb
 *
pVèb
,

3009 
nArg
,

3010 
sqlôe4_vÆue
 **
≠VÆ
,

3011 
sqlôe_öt64
 *
pRowid


3013  
	`sqlôe4Fts3Upd©eMëhod
(
pVèb
, 
nArg
, 
≠VÆ
, 
pRowid
);

3014 
	}
}

3020 
	$·s3SyncMëhod
(
sqlôe4_vèb
 *
pVèb
){

3021 
rc
 = 
	`sqlôe4Fts3PídögTîmsFlush
((
Fts3TabÀ
 *)
pVèb
);

3022 
	`sqlôe4Fts3SegmítsClo£
((
Fts3TabÀ
 *)
pVèb
);

3023  
rc
;

3024 
	}
}

3029 
	$·s3BegöMëhod
(
sqlôe4_vèb
 *
pVèb
){

3030 
	`TESTONLY
–
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pVèb
 );

3031 
	`UNUSED_PARAMETER
(
pVèb
);

3032 
	`as£π
–
p
->
pSegmíts
==0 );

3033 
	`as£π
–
p
->
nPídögD©a
==0 );

3034 
	`as£π
–
p
->
öTønß˘i⁄
!=1 );

3035 
	`TESTONLY
–
p
->
öTønß˘i⁄
 = 1 );

3036 
	`TESTONLY
–
p
->
mxSavïoöt
 = -1; );

3037  
SQLITE4_OK
;

3038 
	}
}

3045 
	$·s3CommôMëhod
(
sqlôe4_vèb
 *
pVèb
){

3046 
	`TESTONLY
–
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pVèb
 );

3047 
	`UNUSED_PARAMETER
(
pVèb
);

3048 
	`as£π
–
p
->
nPídögD©a
==0 );

3049 
	`as£π
–
p
->
öTønß˘i⁄
!=0 );

3050 
	`as£π
–
p
->
pSegmíts
==0 );

3051 
	`TESTONLY
–
p
->
öTønß˘i⁄
 = 0 );

3052 
	`TESTONLY
–
p
->
mxSavïoöt
 = -1; );

3053  
SQLITE4_OK
;

3054 
	}
}

3060 
	$·s3RﬁlbackMëhod
(
sqlôe4_vèb
 *
pVèb
){

3061 
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pVèb
;

3062 
	`sqlôe4Fts3PídögTîmsCÀ¨
(
p
);

3063 
	`as£π
–
p
->
öTønß˘i⁄
!=0 );

3064 
	`TESTONLY
–
p
->
öTønß˘i⁄
 = 0 );

3065 
	`TESTONLY
–
p
->
mxSavïoöt
 = -1; );

3066  
SQLITE4_OK
;

3067 
	}
}

3075 
	$·s3Revî£Po¶i°
(*
pSèπ
, **
µPo¶i°
){

3076 *
p
 = &(*
µPo¶i°
)[-2];

3077 
c
 = 0;

3079  
p
>
pSèπ
 && (
c
=*p--)==0 );

3080  
p
>
pSèπ
 && (*∞& 0x80Ë| 
c
 ){

3081 
c
 = *
p
--;

3083 if–
p
>
pSèπ
 ){Ö = &p[2]; }

3084  *
p
++&0x80 );

3085 *
µPo¶i°
 = 
p
;

3086 
	}
}

3098 
	$·s3Fun˘i⁄Arg
(

3099 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3100 c⁄° *
zFunc
,

3101 
sqlôe4_vÆue
 *
pVÆ
,

3102 
Fts3Curs‹
 **
µC§


3104 
Fts3Curs‹
 *
pRë
;

3105 if–
	`sqlôe4_vÆue_ty≥
(
pVÆ
)!=
SQLITE4_BLOB


3106 || 
	`sqlôe4_vÆue_byãs
(
pVÆ
)!=(
Fts3Curs‹
 *)

3108 *
zEº
 = 
	`sqlôe4_m¥ötf
("ûÀgÆ fú°árgumíàtÿ%s", 
zFunc
);

3109 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, 
zEº
, -1);

3110 
	`sqlôe4_‰ì
(
zEº
);

3111  
SQLITE4_ERROR
;

3113 
	`mem˝y
(&
pRë
, 
	`sqlôe4_vÆue_blob
(
pVÆ
), (
Fts3Curs‹
 *));

3114 *
µC§
 = 
pRë
;

3115  
SQLITE4_OK
;

3116 
	}
}

3121 
	$·s3Snù≥tFunc
(

3122 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3123 
nVÆ
,

3124 
sqlôe4_vÆue
 **
≠VÆ


3126 
Fts3Curs‹
 *
pC§
;

3127 c⁄° *
zSèπ
 = "<b>";

3128 c⁄° *
zEnd
 = "</b>";

3129 c⁄° *
zEŒùsis
 = "<b>...</b>";

3130 
iCﬁ
 = -1;

3131 
nTokí
 = 15;

3136 
	`as£π
–
nVÆ
>=1 );

3138 if–
nVÆ
>6 ){

3139 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
,

3143 if–
	`·s3Fun˘i⁄Arg
(
pC⁄ãxt
, "¢ù≥t", 
≠VÆ
[0], &
pC§
) ) ;

3145  
nVÆ
 ){

3146 6: 
nTokí
 = 
	`sqlôe4_vÆue_öt
(
≠VÆ
[5]);

3147 5: 
iCﬁ
 = 
	`sqlôe4_vÆue_öt
(
≠VÆ
[4]);

3148 4: 
zEŒùsis
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[3]);

3149 3: 
zEnd
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[2]);

3150 2: 
zSèπ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[1]);

3152 if–!
zEŒùsis
 || !
zEnd
 || !
zSèπ
 ){

3153 
	`sqlôe4_ªsu…_îr‹_nomem
(
pC⁄ãxt
);

3154 }if–
SQLITE4_OK
==
	`·s3Curs‹Sìk
(
pC⁄ãxt
, 
pC§
) ){

3155 
	`sqlôe4Fts3Snù≥t
(
pC⁄ãxt
, 
pC§
, 
zSèπ
, 
zEnd
, 
zEŒùsis
, 
iCﬁ
, 
nTokí
);

3157 
	}
}

3162 
	$·s3Off£tsFunc
(

3163 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3164 
nVÆ
,

3165 
sqlôe4_vÆue
 **
≠VÆ


3167 
Fts3Curs‹
 *
pC§
;

3169 
	`UNUSED_PARAMETER
(
nVÆ
);

3171 
	`as£π
–
nVÆ
==1 );

3172 if–
	`·s3Fun˘i⁄Arg
(
pC⁄ãxt
, "off£ts", 
≠VÆ
[0], &
pC§
) ) ;

3173 
	`as£π
–
pC§
 );

3174 if–
SQLITE4_OK
==
	`·s3Curs‹Sìk
(
pC⁄ãxt
, 
pC§
) ){

3175 
	`sqlôe4Fts3Off£ts
(
pC⁄ãxt
, 
pC§
);

3177 
	}
}

3188 
	$·s3O±imizeFunc
(

3189 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3190 
nVÆ
,

3191 
sqlôe4_vÆue
 **
≠VÆ


3193 
rc
;

3194 
Fts3TabÀ
 *
p
;

3195 
Fts3Curs‹
 *
pCurs‹
;

3197 
	`UNUSED_PARAMETER
(
nVÆ
);

3199 
	`as£π
–
nVÆ
==1 );

3200 if–
	`·s3Fun˘i⁄Arg
(
pC⁄ãxt
, "›timize", 
≠VÆ
[0], &
pCurs‹
) ) ;

3201 
p
 = (
Fts3TabÀ
 *)
pCurs‹
->
ba£
.
pVèb
;

3202 
	`as£π
–
p
 );

3204 
rc
 = 
	`sqlôe4Fts3O±imize
(
p
);

3206  
rc
 ){

3207 
SQLITE4_OK
:

3208 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, "Index o±imized", -1, 
SQLITE4_STATIC
);

3210 
SQLITE4_DONE
:

3211 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, "IndexáÃódy o±imÆ", -1, 
SQLITE4_STATIC
);

3214 
	`sqlôe4_ªsu…_îr‹_code
(
pC⁄ãxt
, 
rc
);

3217 
	}
}

3222 
	$·s3M©chöfoFunc
(

3223 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

3224 
nVÆ
,

3225 
sqlôe4_vÆue
 **
≠VÆ


3227 
Fts3Curs‹
 *
pC§
;

3228 
	`as£π
–
nVÆ
==1 ||ÇVal==2 );

3229 if–
SQLITE4_OK
==
	`·s3Fun˘i⁄Arg
(
pC⁄ãxt
, "m©chöfo", 
≠VÆ
[0], &
pC§
) ){

3230 c⁄° *
zArg
 = 0;

3231 if–
nVÆ
>1 ){

3232 
zArg
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[1]);

3234 
	`sqlôe4Fts3M©chöfo
(
pC⁄ãxt
, 
pC§
, 
zArg
);

3236 
	}
}

3242 
·s3FödFun˘i⁄Mëhod
(

3243 
sqlôe4_vèb
 *
pVèb
,

3244 
nArg
,

3245 c⁄° *
zName
,

3246 (**
pxFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**),

3247 **
µArg


3249 
	sOvîlﬂded
 {

3250 c⁄° *
zName
;

3251 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**);

3252 } 
aOvîlﬂd
[] = {

3253 { "¢ù≥t", 
·s3Snù≥tFunc
 },

3254 { "off£ts", 
·s3Off£tsFunc
 },

3255 { "›timize", 
·s3O±imizeFunc
 },

3256 { "m©chöfo", 
·s3M©chöfoFunc
 },

3258 
i
;

3260 
	`UNUSED_PARAMETER
(
pVèb
);

3261 
	`UNUSED_PARAMETER
(
nArg
);

3262 
	`UNUSED_PARAMETER
(
µArg
);

3264 
i
=0; i<
	`SizeofAºay
(
aOvîlﬂd
); i++){

3265 if–
	`°rcmp
(
zName
, 
aOvîlﬂd
[
i
].zName)==0 ){

3266 *
pxFunc
 = 
aOvîlﬂd
[
i
].
xFunc
;

3273 
	}
}

3278 
	$·s3RíameMëhod
(

3279 
sqlôe4_vèb
 *
pVèb
,

3280 c⁄° *
zName


3282 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pVèb
;

3283 
sqlôe4
 *
db
 = 
p
->db;

3284 
rc
;

3292 
	`as£π
–
p
->
nPídögD©a
==0 );

3293 
rc
 = 
	`sqlôe4Fts3PídögTîmsFlush
(
p
);

3295 if–
p
->
zC⁄ã¡Tbl
==0 ){

3296 
	`·s3DbExec
(&
rc
, 
db
,

3298 
p
->
zDb
,Ö->
zName
, zName

3302 if–
p
->
bHasDocsize
 ){

3303 
	`·s3DbExec
(&
rc
, 
db
,

3305 
p
->
zDb
,Ö->
zName
, zName

3308 if–
p
->
bHasSèt
 ){

3309 
	`·s3DbExec
(&
rc
, 
db
,

3311 
p
->
zDb
,Ö->
zName
, zName

3314 
	`·s3DbExec
(&
rc
, 
db
,

3316 
p
->
zDb
,Ö->
zName
, zName

3318 
	`·s3DbExec
(&
rc
, 
db
,

3320 
p
->
zDb
,Ö->
zName
, zName

3322  
rc
;

3323 
	}
}

3330 
	$·s3SavïoötMëhod
(
sqlôe4_vèb
 *
pVèb
, 
iSavïoöt
){

3331 
	`UNUSED_PARAMETER
(
iSavïoöt
);

3332 
	`as£π
–((
Fts3TabÀ
 *)
pVèb
)->
öTønß˘i⁄
 );

3333 
	`as£π
–((
Fts3TabÀ
 *)
pVèb
)->
mxSavïoöt
 < 
iSavïoöt
 );

3334 
	`TESTONLY
–((
Fts3TabÀ
 *)
pVèb
)->
mxSavïoöt
 = 
iSavïoöt
 );

3335  
	`·s3SyncMëhod
(
pVèb
);

3336 
	}
}

3343 
	$·s3Rñó£Mëhod
(
sqlôe4_vèb
 *
pVèb
, 
iSavïoöt
){

3344 
	`TESTONLY
–
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pVèb
 );

3345 
	`UNUSED_PARAMETER
(
iSavïoöt
);

3346 
	`UNUSED_PARAMETER
(
pVèb
);

3347 
	`as£π
–
p
->
öTønß˘i⁄
 );

3348 
	`as£π
–
p
->
mxSavïoöt
 >
iSavïoöt
 );

3349 
	`TESTONLY
–
p
->
mxSavïoöt
 = 
iSavïoöt
-1 );

3350  
SQLITE4_OK
;

3351 
	}
}

3358 
	$·s3RﬁlbackToMëhod
(
sqlôe4_vèb
 *
pVèb
, 
iSavïoöt
){

3359 
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pVèb
;

3360 
	`UNUSED_PARAMETER
(
iSavïoöt
);

3361 
	`as£π
–
p
->
öTønß˘i⁄
 );

3362 
	`as£π
–
p
->
mxSavïoöt
 >
iSavïoöt
 );

3363 
	`TESTONLY
–
p
->
mxSavïoöt
 = 
iSavïoöt
 );

3364 
	`sqlôe4Fts3PídögTîmsCÀ¨
(
p
);

3365  
SQLITE4_OK
;

3366 
	}
}

3368 c⁄° 
sqlôe4_moduÀ
 
	g·s3ModuÀ
 = {

3370  
·s3Cª©eMëhod
,

3371  
·s3C⁄√˘Mëhod
,

3372  
·s3Be°IndexMëhod
,

3373  
·s3Disc⁄√˘Mëhod
,

3374  
·s3De°royMëhod
,

3375  
·s3O≥nMëhod
,

3376  
·s3Clo£Mëhod
,

3377  
·s3FûãrMëhod
,

3378  
·s3NextMëhod
,

3379  
·s3EofMëhod
,

3380  
·s3CﬁumnMëhod
,

3381  
·s3RowidMëhod
,

3382  
·s3Upd©eMëhod
,

3383  
·s3BegöMëhod
,

3384  
·s3SyncMëhod
,

3385  
·s3CommôMëhod
,

3386  
·s3RﬁlbackMëhod
,

3387  
·s3FödFun˘i⁄Mëhod
,

3388  
·s3RíameMëhod
,

3389  
·s3SavïoötMëhod
,

3390  
·s3Rñó£Mëhod
,

3391  
·s3RﬁlbackToMëhod
,

3399 
	$hashDe°roy
(*
p
){

3400 
Fts3Hash
 *
pHash
 = (Fts3Hash *)
p
;

3401 
	`sqlôe4Fts3HashCÀ¨
(
pHash
);

3402 
	`sqlôe4_‰ì
(
pHash
);

3403 
	}
}

3415 
sqlôe4Fts3Sim∂eTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

3416 
sqlôe4Fts3P‹ãrTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

3417 #ifde‡
SQLITE4_ENABLE_ICU


3418 
sqlôe4Fts3IcuTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

3427 
	$sqlôe4Fts3Inô
(
sqlôe4
 *
db
){

3428 
rc
 = 
SQLITE4_OK
;

3429 
Fts3Hash
 *
pHash
 = 0;

3430 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pSim∂e
 = 0;

3431 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pP‹ãr
 = 0;

3433 #ifde‡
SQLITE4_ENABLE_ICU


3434 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
pIcu
 = 0;

3435 
	`sqlôe4Fts3IcuTokíizîModuÀ
(&
pIcu
);

3438 #ifde‡
SQLITE4_TEST


3439 
rc
 = 
	`sqlôe4Fts3InôTîm
(
db
);

3440 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3443 
rc
 = 
	`sqlôe4Fts3InôAux
(
db
);

3444 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3446 
	`sqlôe4Fts3Sim∂eTokíizîModuÀ
(&
pSim∂e
);

3447 
	`sqlôe4Fts3P‹ãrTokíizîModuÀ
(&
pP‹ãr
);

3450 
pHash
 = 
	`sqlôe4_mÆloc
((
Fts3Hash
));

3451 if–!
pHash
 ){

3452 
rc
 = 
SQLITE4_NOMEM
;

3454 
	`sqlôe4Fts3HashInô
(
pHash
, 
FTS3_HASH_STRING
, 1);

3458 if–
rc
==
SQLITE4_OK
 ){

3459 if–
	`sqlôe4Fts3HashIn£π
(
pHash
, "sim∂e", 7, (*)
pSim∂e
)

3460 || 
	`sqlôe4Fts3HashIn£π
(
pHash
, "p‹ãr", 7, (*)
pP‹ãr
)

3461 #ifde‡
SQLITE4_ENABLE_ICU


3462 || (
pIcu
 && 
	`sqlôe4Fts3HashIn£π
(
pHash
, "icu", 4, (*)pIcu))

3465 
rc
 = 
SQLITE4_NOMEM
;

3469 #ifde‡
SQLITE4_TEST


3470 if–
rc
==
SQLITE4_OK
 ){

3471 
rc
 = 
	`sqlôe4Fts3Ex¥InôTe°I¡îÁ˚
(
db
);

3479 if–
SQLITE4_OK
==
rc


3480 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4Fts3InôHashTabÀ
(
db
, 
pHash
, "fts3_tokenizer"))

3481 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "snippet", -1))

3482 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "offsets", 1))

3483 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "matchinfo", 1))

3484 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "matchinfo", 2))

3485 && 
SQLITE4_OK
==(
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "optimize", 1))

3487 
rc
 = 
	`sqlôe4_¸óã_moduÀ_v2
(

3488 
db
, "·s3", &
·s3ModuÀ
, (*)
pHash
, 
hashDe°roy


3490 if–
rc
==
SQLITE4_OK
 ){

3491 
rc
 = 
	`sqlôe4_¸óã_moduÀ_v2
(

3492 
db
, "·s4", &
·s3ModuÀ
, (*)
pHash
, 0

3495  
rc
;

3499 
	`as£π
–
rc
!=
SQLITE4_OK
 );

3500 if–
pHash
 ){

3501 
	`sqlôe4Fts3HashCÀ¨
(
pHash
);

3502 
	`sqlôe4_‰ì
(
pHash
);

3504  
rc
;

3505 
	}
}

3522 
	$·s3EvÆAŒoˇãRódîs
(

3523 
Fts3Curs‹
 *
pC§
,

3524 
Fts3Ex¥
 *
pEx¥
,

3525 *
≤Tokí
,

3526 *
≤Or
,

3527 *
pRc


3529 if–
pEx¥
 && 
SQLITE4_OK
==*
pRc
 ){

3530 if–
pEx¥
->
eTy≥
==
FTSQUERY_PHRASE
 ){

3531 
i
;

3532 
nTokí
 = 
pEx¥
->
pPhø£
->nToken;

3533 *
≤Tokí
 +
nTokí
;

3534 
i
=0; i<
nTokí
; i++){

3535 
Fts3Phø£Tokí
 *
pTokí
 = &
pEx¥
->
pPhø£
->
aTokí
[
i
];

3536 
rc
 = 
	`·s3TîmSegRódîCurs‹
(
pC§
,

3537 
pTokí
->
z
,ÖTokí->
n
,ÖTokí->
isPªfix
, &pTokí->
pSegc§


3539 if–
rc
!=
SQLITE4_OK
 ){

3540 *
pRc
 = 
rc
;

3544 
	`as£π
–
pEx¥
->
pPhø£
->
iDo˛i°Tokí
==0 );

3545 
pEx¥
->
pPhø£
->
iDo˛i°Tokí
 = -1;

3547 *
≤Or
 +(
pEx¥
->
eTy≥
==
FTSQUERY_OR
);

3548 
	`·s3EvÆAŒoˇãRódîs
(
pC§
, 
pEx¥
->
pLe·
, 
≤Tokí
, 
≤Or
, 
pRc
);

3549 
	`·s3EvÆAŒoˇãRódîs
(
pC§
, 
pEx¥
->
pRight
, 
≤Tokí
, 
≤Or
, 
pRc
);

3552 
	}
}

3562 
	$·s3EvÆPhø£MîgeTokí
(

3563 
Fts3TabÀ
 *
pTab
,

3564 
Fts3Phø£
 *
p
,

3565 
iTokí
,

3566 *
pLi°
,

3567 
nLi°


3569 
	`as£π
–
iTokí
!=
p
->
iDo˛i°Tokí
 );

3571 if–
pLi°
==0 ){

3572 
	`sqlôe4_‰ì
(
p
->
do˛i°
.
aAŒ
);

3573 
p
->
do˛i°
.
aAŒ
 = 0;

3574 
p
->
do˛i°
.
nAŒ
 = 0;

3577 if–
p
->
iDo˛i°Tokí
<0 ){

3578 
p
->
do˛i°
.
aAŒ
 = 
pLi°
;

3579 
p
->
do˛i°
.
nAŒ
 = 
nLi°
;

3582 if–
p
->
do˛i°
.
aAŒ
==0 ){

3583 
	`sqlôe4_‰ì
(
pLi°
);

3587 *
pLe·
;

3588 *
pRight
;

3589 
nLe·
;

3590 
nRight
;

3591 
nDiff
;

3593 if–
p
->
iDo˛i°Tokí
<
iTokí
 ){

3594 
pLe·
 = 
p
->
do˛i°
.
aAŒ
;

3595 
nLe·
 = 
p
->
do˛i°
.
nAŒ
;

3596 
pRight
 = 
pLi°
;

3597 
nRight
 = 
nLi°
;

3598 
nDiff
 = 
iTokí
 - 
p
->
iDo˛i°Tokí
;

3600 
pRight
 = 
p
->
do˛i°
.
aAŒ
;

3601 
nRight
 = 
p
->
do˛i°
.
nAŒ
;

3602 
pLe·
 = 
pLi°
;

3603 
nLe·
 = 
nLi°
;

3604 
nDiff
 = 
p
->
iDo˛i°Tokí
 - 
iTokí
;

3607 
	`·s3Do˛i°Phø£Mîge
(
pTab
->
bDescIdx
, 
nDiff
, 
pLe·
, 
nLe·
, 
pRight
,&
nRight
);

3608 
	`sqlôe4_‰ì
(
pLe·
);

3609 
p
->
do˛i°
.
aAŒ
 = 
pRight
;

3610 
p
->
do˛i°
.
nAŒ
 = 
nRight
;

3613 if–
iTokí
>
p
->
iDo˛i°Tokí
 )Ö->iDoclistToken = iToken;

3614 
	}
}

3622 
	$·s3EvÆPhø£Lﬂd
(

3623 
Fts3Curs‹
 *
pC§
,

3624 
Fts3Phø£
 *
p


3626 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

3627 
iTokí
;

3628 
rc
 = 
SQLITE4_OK
;

3630 
iTokí
=0; 
rc
==
SQLITE4_OK
 && iTokí<
p
->
nTokí
; iToken++){

3631 
Fts3Phø£Tokí
 *
pTokí
 = &
p
->
aTokí
[
iTokí
];

3632 
	`as£π
–
pTokí
->
pDe„ºed
==0 ||ÖTokí->
pSegc§
==0 );

3634 if–
pTokí
->
pSegc§
 ){

3635 
nThis
 = 0;

3636 *
pThis
 = 0;

3637 
rc
 = 
	`·s3TîmSñe˘
(
pTab
, 
pTokí
, 
p
->
iCﬁumn
, &
nThis
, &
pThis
);

3638 if–
rc
==
SQLITE4_OK
 ){

3639 
	`·s3EvÆPhø£MîgeTokí
(
pTab
, 
p
, 
iTokí
, 
pThis
, 
nThis
);

3642 
	`as£π
–
pTokí
->
pSegc§
==0 );

3645  
rc
;

3646 
	}
}

3658 
	$·s3EvÆDe„ºedPhø£
(
Fts3Curs‹
 *
pC§
, 
Fts3Phø£
 *
pPhø£
){

3659 
iTokí
;

3660 *
aPo¶i°
 = 0;

3661 
nPo¶i°
 = 0;

3662 
iPªv
 = -1;

3664 
	`as£π
–
pPhø£
->
do˛i°
.
bFªeLi°
==0 );

3666 
iTokí
=0; iTokí<
pPhø£
->
nTokí
; iToken++){

3667 
Fts3Phø£Tokí
 *
pTokí
 = &
pPhø£
->
aTokí
[
iTokí
];

3668 
Fts3De„ºedTokí
 *
pDe„ºed
 = 
pTokí
->pDeferred;

3670 if–
pDe„ºed
 ){

3671 *
pLi°
;

3672 
nLi°
;

3673 
rc
 = 
	`sqlôe4Fts3De„ºedTokíLi°
(
pDe„ºed
, &
pLi°
, &
nLi°
);

3674 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3676 if–
pLi°
==0 ){

3677 
	`sqlôe4_‰ì
(
aPo¶i°
);

3678 
pPhø£
->
do˛i°
.
pLi°
 = 0;

3679 
pPhø£
->
do˛i°
.
nLi°
 = 0;

3680  
SQLITE4_OK
;

3682 }if–
aPo¶i°
==0 ){

3683 
aPo¶i°
 = 
pLi°
;

3684 
nPo¶i°
 = 
nLi°
;

3687 *
aOut
 = 
pLi°
;

3688 *
p1
 = 
aPo¶i°
;

3689 *
p2
 = 
aOut
;

3691 
	`as£π
–
iPªv
>=0 );

3692 
	`·s3Po¶i°Phø£Mîge
(&
aOut
, 
iTokí
-
iPªv
, 0, 1, &
p1
, &
p2
);

3693 
	`sqlôe4_‰ì
(
aPo¶i°
);

3694 
aPo¶i°
 = 
pLi°
;

3695 
nPo¶i°
 = 
aOut
 - 
aPo¶i°
;

3696 if–
nPo¶i°
==0 ){

3697 
	`sqlôe4_‰ì
(
aPo¶i°
);

3698 
pPhø£
->
do˛i°
.
pLi°
 = 0;

3699 
pPhø£
->
do˛i°
.
nLi°
 = 0;

3700  
SQLITE4_OK
;

3703 
iPªv
 = 
iTokí
;

3707 if–
iPªv
>=0 ){

3708 
nMaxUnde„ºed
 = 
pPhø£
->
iDo˛i°Tokí
;

3709 if–
nMaxUnde„ºed
<0 ){

3710 
pPhø£
->
do˛i°
.
pLi°
 = 
aPo¶i°
;

3711 
pPhø£
->
do˛i°
.
nLi°
 = 
nPo¶i°
;

3712 
pPhø£
->
do˛i°
.
iDocid
 = 
pC§
->
iPªvId
;

3713 
pPhø£
->
do˛i°
.
bFªeLi°
 = 1;

3715 
nDi°™˚
;

3716 *
p1
;

3717 *
p2
;

3718 *
aOut
;

3720 if–
nMaxUnde„ºed
>
iPªv
 ){

3721 
p1
 = 
aPo¶i°
;

3722 
p2
 = 
pPhø£
->
do˛i°
.
pLi°
;

3723 
nDi°™˚
 = 
nMaxUnde„ºed
 - 
iPªv
;

3725 
p1
 = 
pPhø£
->
do˛i°
.
pLi°
;

3726 
p2
 = 
aPo¶i°
;

3727 
nDi°™˚
 = 
iPªv
 - 
nMaxUnde„ºed
;

3730 
aOut
 = (*)
	`sqlôe4_mÆloc
(
nPo¶i°
+8);

3731 if–!
aOut
 ){

3732 
	`sqlôe4_‰ì
(
aPo¶i°
);

3733  
SQLITE4_NOMEM
;

3736 
pPhø£
->
do˛i°
.
pLi°
 = 
aOut
;

3737 if–
	`·s3Po¶i°Phø£Mîge
(&
aOut
, 
nDi°™˚
, 0, 1, &
p1
, &
p2
) ){

3738 
pPhø£
->
do˛i°
.
bFªeLi°
 = 1;

3739 
pPhø£
->
do˛i°
.
nLi°
 = (
aOut
 -ÖPhø£->do˛i°.
pLi°
);

3741 
	`sqlôe4_‰ì
(
aOut
);

3742 
pPhø£
->
do˛i°
.
pLi°
 = 0;

3743 
pPhø£
->
do˛i°
.
nLi°
 = 0;

3745 
	`sqlôe4_‰ì
(
aPo¶i°
);

3749  
SQLITE4_OK
;

3750 
	}
}

3764 
	$·s3EvÆPhø£Sèπ
(
Fts3Curs‹
 *
pC§
, 
bO±Ok
, 
Fts3Phø£
 *
p
){

3765 
rc
;

3766 
Fts3Phø£Tokí
 *
pFú°
 = &
p
->
aTokí
[0];

3767 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

3769 if–
pC§
->
bDesc
==
pTab
->
bDescIdx


3770 && 
bO±Ok
==1

3771 && 
p
->
nTokí
==1

3772 && 
pFú°
->
pSegc§


3773 && 
pFú°
->
pSegc§
->
bLookup


3774 && 
pFú°
->
bFú°
==0

3777 
iCﬁ
 = (
p
->
iCﬁumn
 >
pTab
->
nCﬁumn
 ? -1 :Ö->iColumn);

3778 
rc
 = 
	`sqlôe4Fts3M§In¸Sèπ
(

3779 
pTab
, 
pFú°
->
pSegc§
, 
iCﬁ
,ÖFú°->
z
,ÖFú°->
n
);

3780 
p
->
bIn¸
 = 1;

3784 
rc
 = 
	`·s3EvÆPhø£Lﬂd
(
pC§
, 
p
);

3785 
p
->
bIn¸
 = 0;

3788 
	`as£π
–
rc
!=
SQLITE4_OK
 || 
p
->
nTokí
<1 ||Ö->
aTokí
[0].
pSegc§
==0 ||Ö->
bIn¸
 );

3789  
rc
;

3790 
	}
}

3802 
	$sqlôe4Fts3Do˛i°Pªv
(

3803 
bDescIdx
,

3804 *
aDo˛i°
,

3805 
nDo˛i°
,

3806 **
µIãr
,

3807 
sqlôe4_öt64
 *
piDocid
,

3808 *
≤Li°
,

3809 
u8
 *
pbEof


3811 *
p
 = *
µIãr
;

3813 
	`as£π
–
nDo˛i°
>0 );

3814 
	`as£π
–*
pbEof
==0 );

3815 
	`as£π
–
p
 || *
piDocid
==0 );

3816 
	`as£π
–!
p
 || (p>
aDo˛i°
 &&Ö<&aDo˛i°[
nDo˛i°
]) );

3818 if–
p
==0 ){

3819 
sqlôe4_öt64
 
iDocid
 = 0;

3820 *
pNext
 = 0;

3821 *
pDocid
 = 
aDo˛i°
;

3822 *
pEnd
 = &
aDo˛i°
[
nDo˛i°
];

3823 
iMul
 = 1;

3825  
pDocid
<
pEnd
 ){

3826 
sqlôe4_öt64
 
iDñè
;

3827 
pDocid
 +
	`sqlôe4Fts3GëV¨öt
’Docid, &
iDñè
);

3828 
iDocid
 +(
iMul
 * 
iDñè
);

3829 
pNext
 = 
pDocid
;

3830 
	`·s3Po¶i°C›y
(0, &
pDocid
);

3831  
pDocid
<
pEnd
 && *pDocid==0 )ÖDocid++;

3832 
iMul
 = (
bDescIdx
 ? -1 : 1);

3835 *
≤Li°
 = 
pEnd
 - 
pNext
;

3836 *
µIãr
 = 
pNext
;

3837 *
piDocid
 = 
iDocid
;

3839 
iMul
 = (
bDescIdx
 ? -1 : 1);

3840 
sqlôe4_öt64
 
iDñè
;

3841 
	`·s3GëRevî£V¨öt
(&
p
, 
aDo˛i°
, &
iDñè
);

3842 *
piDocid
 -(
iMul
 * 
iDñè
);

3844 if–
p
==
aDo˛i°
 ){

3845 *
pbEof
 = 1;

3847 *
pSave
 = 
p
;

3848 
	`·s3Revî£Po¶i°
(
aDo˛i°
, &
p
);

3849 *
≤Li°
 = (
pSave
 - 
p
);

3851 *
µIãr
 = 
p
;

3853 
	}
}

3864 
	$·s3EvÆPhø£Next
(

3865 
Fts3Curs‹
 *
pC§
,

3866 
Fts3Phø£
 *
p
,

3867 
u8
 *
pbEof


3869 
rc
 = 
SQLITE4_OK
;

3870 
Fts3Do˛i°
 *
pDL
 = &
p
->
do˛i°
;

3871 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

3873 if–
p
->
bIn¸
 ){

3874 
	`as£π
–
p
->
nTokí
==1 );

3875 
	`as£π
–
pDL
->
pNextDocid
==0 );

3876 
rc
 = 
	`sqlôe4Fts3M§In¸Next
(
pTab
, 
p
->
aTokí
[0].
pSegc§
,

3877 &
pDL
->
iDocid
, &pDL->
pLi°
, &pDL->
nLi°


3879 if–
rc
==
SQLITE4_OK
 && !
pDL
->
pLi°
 ){

3880 *
pbEof
 = 1;

3882 }if–
pC§
->
bDesc
!=
pTab
->
bDescIdx
 && 
pDL
->
nAŒ
 ){

3883 
	`sqlôe4Fts3Do˛i°Pªv
(
pTab
->
bDescIdx
, 
pDL
->
aAŒ
,ÖDL->
nAŒ
,

3884 &
pDL
->
pNextDocid
, &pDL->
iDocid
, &pDL->
nLi°
, 
pbEof


3886 
pDL
->
pLi°
 =ÖDL->
pNextDocid
;

3888 *
pIãr
;

3889 *
pEnd
 = &
pDL
->
aAŒ
[pDL->
nAŒ
];

3890 if–
pDL
->
pNextDocid
 ){

3891 
pIãr
 = 
pDL
->
pNextDocid
;

3893 
pIãr
 = 
pDL
->
aAŒ
;

3896 if–
pIãr
>=
pEnd
 ){

3898 *
pbEof
 = 1;

3900 
sqlôe4_öt64
 
iDñè
;

3901 
pIãr
 +
	`sqlôe4Fts3GëV¨öt
’Iãr, &
iDñè
);

3902 if–
pTab
->
bDescIdx
==0 || 
pDL
->
pNextDocid
==0 ){

3903 
pDL
->
iDocid
 +
iDñè
;

3905 
pDL
->
iDocid
 -
iDñè
;

3907 
pDL
->
pLi°
 = 
pIãr
;

3908 
	`·s3Po¶i°C›y
(0, &
pIãr
);

3909 
pDL
->
nLi°
 = (
pIãr
 -ÖDL->
pLi°
);

3917  
pIãr
<
pEnd
 && *pIter==0 )ÖIter++;

3919 
pDL
->
pNextDocid
 = 
pIãr
;

3920 
	`as£π
–
pIãr
>=&
pDL
->
aAŒ
[pDL->
nAŒ
] || *pIter );

3921 *
pbEof
 = 0;

3925  
rc
;

3926 
	}
}

3944 
	$·s3EvÆSèπRódîs
(

3945 
Fts3Curs‹
 *
pC§
,

3946 
Fts3Ex¥
 *
pEx¥
,

3947 
bO±Ok
,

3948 *
pRc


3950 if–
pEx¥
 && 
SQLITE4_OK
==*
pRc
 ){

3951 if–
pEx¥
->
eTy≥
==
FTSQUERY_PHRASE
 ){

3952 
i
;

3953 
nTokí
 = 
pEx¥
->
pPhø£
->nToken;

3954 
i
=0; i<
nTokí
; i++){

3955 if–
pEx¥
->
pPhø£
->
aTokí
[
i
].
pDe„ºed
==0 ) ;

3957 
pEx¥
->
bDe„ºed
 = (
i
==
nTokí
);

3958 *
pRc
 = 
	`·s3EvÆPhø£Sèπ
(
pC§
, 
bO±Ok
, 
pEx¥
->
pPhø£
);

3960 
	`·s3EvÆSèπRódîs
(
pC§
, 
pEx¥
->
pLe·
, 
bO±Ok
, 
pRc
);

3961 
	`·s3EvÆSèπRódîs
(
pC§
, 
pEx¥
->
pRight
, 
bO±Ok
, 
pRc
);

3962 
pEx¥
->
bDe„ºed
 = (pEx¥->
pLe·
->bDe„ºed &&ÖEx¥->
pRight
->bDeferred);

3965 
	}
}

3979 
Fts3TokíAndCo°
 
	tFts3TokíAndCo°
;

3980 
	sFts3TokíAndCo°
 {

3981 
Fts3Phø£
 *
	mpPhø£
;

3982 
	miTokí
;

3983 
Fts3Phø£Tokí
 *
	mpTokí
;

3984 
Fts3Ex¥
 *
	mpRoŸ
;

3985 
	mnOvÊ
;

3986 
	miCﬁ
;

3996 
	$·s3EvÆTokíCo°s
(

3997 
Fts3Curs‹
 *
pC§
,

3998 
Fts3Ex¥
 *
pRoŸ
,

3999 
Fts3Ex¥
 *
pEx¥
,

4000 
Fts3TokíAndCo°
 **
µTC
,

4001 
Fts3Ex¥
 ***
µOr
,

4002 *
pRc


4004 if–*
pRc
==
SQLITE4_OK
 ){

4005 if–
pEx¥
->
eTy≥
==
FTSQUERY_PHRASE
 ){

4006 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

4007 
i
;

4008 
i
=0; *
pRc
==
SQLITE4_OK
 && i<
pPhø£
->
nTokí
; i++){

4009 
Fts3TokíAndCo°
 *
pTC
 = (*
µTC
)++;

4010 
pTC
->
pPhø£
 =ÖPhrase;

4011 
pTC
->
iTokí
 = 
i
;

4012 
pTC
->
pRoŸ
 =ÖRoot;

4013 
pTC
->
pTokí
 = &
pPhø£
->
aTokí
[
i
];

4014 
pTC
->
iCﬁ
 = 
pPhø£
->
iCﬁumn
;

4015 *
pRc
 = 
	`sqlôe4Fts3M§OvÊ
(
pC§
, 
pTC
->
pTokí
->
pSegc§
, &pTC->
nOvÊ
);

4017 }if–
pEx¥
->
eTy≥
!=
FTSQUERY_NOT
 ){

4018 
	`as£π
–
pEx¥
->
eTy≥
==
FTSQUERY_OR


4019 || 
pEx¥
->
eTy≥
==
FTSQUERY_AND


4020 || 
pEx¥
->
eTy≥
==
FTSQUERY_NEAR


4022 
	`as£π
–
pEx¥
->
pLe·
 &&ÖEx¥->
pRight
 );

4023 if–
pEx¥
->
eTy≥
==
FTSQUERY_OR
 ){

4024 
pRoŸ
 = 
pEx¥
->
pLe·
;

4025 **
µOr
 = 
pRoŸ
;

4026 (*
µOr
)++;

4028 
	`·s3EvÆTokíCo°s
(
pC§
, 
pRoŸ
, 
pEx¥
->
pLe·
, 
µTC
, 
µOr
, 
pRc
);

4029 if–
pEx¥
->
eTy≥
==
FTSQUERY_OR
 ){

4030 
pRoŸ
 = 
pEx¥
->
pRight
;

4031 **
µOr
 = 
pRoŸ
;

4032 (*
µOr
)++;

4034 
	`·s3EvÆTokíCo°s
(
pC§
, 
pRoŸ
, 
pEx¥
->
pRight
, 
µTC
, 
µOr
, 
pRc
);

4037 
	}
}

4050 
	$·s3EvÆAvîageDocsize
(
Fts3Curs‹
 *
pC§
, *
≤Page
){

4051 if–
pC§
->
nRowAvg
==0 ){

4063 
rc
;

4064 
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pC§
->
ba£
.
pVèb
;

4065 
sqlôe4_°mt
 *
pStmt
;

4066 
sqlôe4_öt64
 
nDoc
 = 0;

4067 
sqlôe4_öt64
 
nByã
 = 0;

4068 c⁄° *
pEnd
;

4069 c⁄° *
a
;

4071 
rc
 = 
	`sqlôe4Fts3Sñe˘Do˘ŸÆ
(
p
, &
pStmt
);

4072 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4073 
a
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0);

4074 
	`as£π
–
a
 );

4076 
pEnd
 = &
a
[
	`sqlôe4_cﬁumn_byãs
(
pStmt
, 0)];

4077 
a
 +
	`sqlôe4Fts3GëV¨öt
◊, &
nDoc
);

4078  
a
<
pEnd
 ){

4079 
a
 +
	`sqlôe4Fts3GëV¨öt
◊, &
nByã
);

4081 if–
nDoc
==0 || 
nByã
==0 ){

4082 
	`sqlôe4_ª£t
(
pStmt
);

4083  
FTS_CORRUPT_VTAB
;

4086 
pC§
->
nDoc
 =ÇDoc;

4087 
pC§
->
nRowAvg
 = ()(((
nByã
 / 
nDoc
Ë+ 
p
->
nPgsz
) /Ö->nPgsz);

4088 
	`as£π
–
pC§
->
nRowAvg
>0 );

4089 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

4090 if–
rc
!=
SQLITE4_OK
 ) Ñc;

4093 *
≤Page
 = 
pC§
->
nRowAvg
;

4094  
SQLITE4_OK
;

4095 
	}
}

4111 
	$·s3EvÆSñe˘De„ºed
(

4112 
Fts3Curs‹
 *
pC§
,

4113 
Fts3Ex¥
 *
pRoŸ
,

4114 
Fts3TokíAndCo°
 *
aTC
,

4115 
nTC


4117 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

4118 
nDocSize
 = 0;

4119 
rc
 = 
SQLITE4_OK
;

4120 
ii
;

4121 
nOvÊ
 = 0;

4122 
nTokí
 = 0;

4124 
nMöE°
 = 0;

4125 
nLﬂd4
 = 1;

4132 if–
pTab
->
zC⁄ã¡Tbl
 ){

4133  
SQLITE4_OK
;

4139 
ii
=0; ii<
nTC
; ii++){

4140 if–
aTC
[
ii
].
pRoŸ
==pRoot ){

4141 
nOvÊ
 +
aTC
[
ii
].nOvfl;

4142 
nTokí
++;

4145 if–
nOvÊ
==0 || 
nTokí
<2 )  
SQLITE4_OK
;

4148 
rc
 = 
	`·s3EvÆAvîageDocsize
(
pC§
, &
nDocSize
);

4149 
	`as£π
–
rc
!=
SQLITE4_OK
 || 
nDocSize
>0 );

4174 
ii
=0; ii<
nTokí
 && 
rc
==
SQLITE4_OK
; ii++){

4175 
iTC
;

4176 
Fts3TokíAndCo°
 *
pTC
 = 0;

4179 
iTC
=0; iTC<
nTC
; iTC++){

4180 if–
aTC
[
iTC
].
pTokí
 &&áTC[iTC].
pRoŸ
==pRoot

4181 && (!
pTC
 || 
aTC
[
iTC
].
nOvÊ
<pTC->nOvfl)

4183 
pTC
 = &
aTC
[
iTC
];

4186 
	`as£π
–
pTC
 );

4188 if–
ii
 && 
pTC
->
nOvÊ
>=((
nMöE°
+(
nLﬂd4
/4)-1)/“Lﬂd4/4))*
nDocSize
 ){

4193 
Fts3Phø£Tokí
 *
pTokí
 = 
pTC
->pToken;

4194 
rc
 = 
	`sqlôe4Fts3De„rTokí
(
pC§
, 
pTokí
, 
pTC
->
iCﬁ
);

4195 
	`·s3SegRódîCurs‹Fªe
(
pTokí
->
pSegc§
);

4196 
pTokí
->
pSegc§
 = 0;

4201 if–
ii
<12 ) 
nLﬂd4
 =ÇLoad4*4;

4203 if–
ii
==0 || 
pTC
->
pPhø£
->
nTokí
>1 ){

4207 
Fts3Phø£Tokí
 *
pTokí
 = 
pTC
->pToken;

4208 
nLi°
 = 0;

4209 *
pLi°
 = 0;

4210 
rc
 = 
	`·s3TîmSñe˘
(
pTab
, 
pTokí
, 
pTC
->
iCﬁ
, &
nLi°
, &
pLi°
);

4211 
	`as£π
–
rc
==
SQLITE4_OK
 || 
pLi°
==0 );

4212 if–
rc
==
SQLITE4_OK
 ){

4213 
nCou¡
;

4214 
	`·s3EvÆPhø£MîgeTokí
(
pTab
, 
pTC
->
pPhø£
,ÖTC->
iTokí
,
pLi°
,
nLi°
);

4215 
nCou¡
 = 
	`·s3Do˛i°Cou¡Docids
(

4216 
pTC
->
pPhø£
->
do˛i°
.
aAŒ
,ÖTC->pPhø£->do˛i°.
nAŒ


4218 if–
ii
==0 || 
nCou¡
<
nMöE°
 )ÇMinEst =ÇCount;

4222 
pTC
->
pTokí
 = 0;

4225  
rc
;

4226 
	}
}

4240 
	$·s3EvÆSèπ
(
Fts3Curs‹
 *
pC§
){

4241 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

4242 
rc
 = 
SQLITE4_OK
;

4243 
nTokí
 = 0;

4244 
nOr
 = 0;

4247 
	`·s3EvÆAŒoˇãRódîs
(
pC§
,ÖC§->
pEx¥
, &
nTokí
, &
nOr
, &
rc
);

4250 if–
rc
==
SQLITE4_OK
 && 
nTokí
>1 && 
pTab
->
bHasSèt
 ){

4251 
Fts3TokíAndCo°
 *
aTC
;

4252 
Fts3Ex¥
 **
≠Or
;

4253 
aTC
 = (
Fts3TokíAndCo°
 *)
	`sqlôe4_mÆloc
(

4254 (
Fts3TokíAndCo°
Ë* 
nTokí


4255 + (
Fts3Ex¥
 *Ë* 
nOr
 * 2

4257 
≠Or
 = (
Fts3Ex¥
 **)&
aTC
[
nTokí
];

4259 if–!
aTC
 ){

4260 
rc
 = 
SQLITE4_NOMEM
;

4262 
ii
;

4263 
Fts3TokíAndCo°
 *
pTC
 = 
aTC
;

4264 
Fts3Ex¥
 **
µOr
 = 
≠Or
;

4266 
	`·s3EvÆTokíCo°s
(
pC§
, 0,ÖC§->
pEx¥
, &
pTC
, &
µOr
, &
rc
);

4267 
nTokí
 = 
pTC
-
aTC
;

4268 
nOr
 = 
µOr
-
≠Or
;

4270 if–
rc
==
SQLITE4_OK
 ){

4271 
rc
 = 
	`·s3EvÆSñe˘De„ºed
(
pC§
, 0, 
aTC
, 
nTokí
);

4272 
ii
=0; 
rc
==
SQLITE4_OK
 && ii<
nOr
; ii++){

4273 
rc
 = 
	`·s3EvÆSñe˘De„ºed
(
pC§
, 
≠Or
[
ii
], 
aTC
, 
nTokí
);

4277 
	`sqlôe4_‰ì
(
aTC
);

4281 
	`·s3EvÆSèπRódîs
(
pC§
,ÖC§->
pEx¥
, 1, &
rc
);

4282  
rc
;

4283 
	}
}

4288 
	$·s3EvÆInvÆid©ePo¶i°
(
Fts3Phø£
 *
pPhø£
){

4289 if–
pPhø£
->
do˛i°
.
bFªeLi°
 ){

4290 
	`sqlôe4_‰ì
(
pPhø£
->
do˛i°
.
pLi°
);

4292 
pPhø£
->
do˛i°
.
pLi°
 = 0;

4293 
pPhø£
->
do˛i°
.
nLi°
 = 0;

4294 
pPhø£
->
do˛i°
.
bFªeLi°
 = 0;

4295 
	}
}

4319 
	$·s3EvÆNórTrim
(

4320 
nNór
,

4321 *
aTmp
,

4322 **
∑Po¶i°
,

4323 *
≤Tokí
,

4324 
Fts3Phø£
 *
pPhø£


4326 
nP¨am1
 = 
nNór
 + 
pPhø£
->
nTokí
;

4327 
nP¨am2
 = 
nNór
 + *
≤Tokí
;

4328 
nNew
;

4329 *
p2
;

4330 *
pOut
;

4331 
ªs
;

4333 
	`as£π
–
pPhø£
->
do˛i°
.
pLi°
 );

4335 
p2
 = 
pOut
 = 
pPhø£
->
do˛i°
.
pLi°
;

4336 
ªs
 = 
	`·s3Po¶i°NórMîge
(

4337 &
pOut
, 
aTmp
, 
nP¨am1
, 
nP¨am2
, 
∑Po¶i°
, &
p2


4339 if–
ªs
 ){

4340 
nNew
 = (
pOut
 - 
pPhø£
->
do˛i°
.
pLi°
) - 1;

4341 
	`as£π
–
pPhø£
->
do˛i°
.
pLi°
[
nNew
]=='\0' );

4342 
	`as£π
–
nNew
<=
pPhø£
->
do˛i°
.
nLi°
 &&ÇNew>0 );

4343 
	`mem£t
(&
pPhø£
->
do˛i°
.
pLi°
[
nNew
], 0,ÖPhø£->do˛i°.
nLi°
 -ÇNew);

4344 
pPhø£
->
do˛i°
.
nLi°
 = 
nNew
;

4345 *
∑Po¶i°
 = 
pPhø£
->
do˛i°
.
pLi°
;

4346 *
≤Tokí
 = 
pPhø£
->
nTokí
;

4349  
ªs
;

4350 
	}
}

4393 
	$·s3EvÆNextRow
(

4394 
Fts3Curs‹
 *
pC§
,

4395 
Fts3Ex¥
 *
pEx¥
,

4396 *
pRc


4398 if–*
pRc
==
SQLITE4_OK
 ){

4399 
bDescDo˛i°
 = 
pC§
->
bDesc
;

4400 
	`as£π
–
pEx¥
->
bEof
==0 );

4401 
pEx¥
->
bSèπ
 = 1;

4403  
pEx¥
->
eTy≥
 ){

4404 
FTSQUERY_NEAR
:

4405 
FTSQUERY_AND
: {

4406 
Fts3Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

4407 
Fts3Ex¥
 *
pRight
 = 
pEx¥
->pRight;

4408 
	`as£π
–!
pLe·
->
bDe„ºed
 || !
pRight
->bDeferred );

4410 if–
pLe·
->
bDe„ºed
 ){

4413 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4414 
pEx¥
->
iDocid
 = 
pRight
->iDocid;

4415 
pEx¥
->
bEof
 = 
pRight
->bEof;

4416 }if–
pRight
->
bDe„ºed
 ){

4419 
	`·s3EvÆNextRow
(
pC§
, 
pLe·
, 
pRc
);

4420 
pEx¥
->
iDocid
 = 
pLe·
->iDocid;

4421 
pEx¥
->
bEof
 = 
pLe·
->bEof;

4424 
	`·s3EvÆNextRow
(
pC§
, 
pLe·
, 
pRc
);

4425 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4426  !
pLe·
->
bEof
 && !
pRight
->bEo‡&& *
pRc
==
SQLITE4_OK
 ){

4427 
sqlôe4_öt64
 
iDiff
 = 
	`DOCID_CMP
(
pLe·
->
iDocid
, 
pRight
->iDocid);

4428 if–
iDiff
==0 ) ;

4429 if–
iDiff
<0 ){

4430 
	`·s3EvÆNextRow
(
pC§
, 
pLe·
, 
pRc
);

4432 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4435 
pEx¥
->
iDocid
 = 
pLe·
->iDocid;

4436 
pEx¥
->
bEof
 = (
pLe·
->bEo‡|| 
pRight
->bEof);

4441 
FTSQUERY_OR
: {

4442 
Fts3Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

4443 
Fts3Ex¥
 *
pRight
 = 
pEx¥
->pRight;

4444 
sqlôe4_öt64
 
iCmp
 = 
	`DOCID_CMP
(
pLe·
->
iDocid
, 
pRight
->iDocid);

4446 
	`as£π
–
pLe·
->
bSèπ
 ||ÖLe·->
iDocid
==
pRight
->iDocid );

4447 
	`as£π
–
pRight
->
bSèπ
 || 
pLe·
->
iDocid
==pRight->iDocid );

4449 if–
pRight
->
bEof
 || (
pLe·
->bEof==0 && 
iCmp
<0) ){

4450 
	`·s3EvÆNextRow
(
pC§
, 
pLe·
, 
pRc
);

4451 }if–
pLe·
->
bEof
 || (
pRight
->bEof==0 && 
iCmp
>0) ){

4452 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4454 
	`·s3EvÆNextRow
(
pC§
, 
pLe·
, 
pRc
);

4455 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4458 
pEx¥
->
bEof
 = (
pLe·
->bEo‡&& 
pRight
->bEof);

4459 
iCmp
 = 
	`DOCID_CMP
(
pLe·
->
iDocid
, 
pRight
->iDocid);

4460 if–
pRight
->
bEof
 || (
pLe·
->bEof==0 && 
iCmp
<0) ){

4461 
pEx¥
->
iDocid
 = 
pLe·
->iDocid;

4463 
pEx¥
->
iDocid
 = 
pRight
->iDocid;

4469 
FTSQUERY_NOT
: {

4470 
Fts3Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

4471 
Fts3Ex¥
 *
pRight
 = 
pEx¥
->pRight;

4473 if–
pRight
->
bSèπ
==0 ){

4474 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4475 
	`as£π
–*
pRc
!=
SQLITE4_OK
 || 
pRight
->
bSèπ
 );

4478 
	`·s3EvÆNextRow
(
pC§
, 
pLe·
, 
pRc
);

4479 if–
pLe·
->
bEof
==0 ){

4480  !*
pRc


4481 && !
pRight
->
bEof


4482 && 
	`DOCID_CMP
(
pLe·
->
iDocid
, 
pRight
->iDocid)>0

4484 
	`·s3EvÆNextRow
(
pC§
, 
pRight
, 
pRc
);

4487 
pEx¥
->
iDocid
 = 
pLe·
->iDocid;

4488 
pEx¥
->
bEof
 = 
pLe·
->bEof;

4493 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

4494 
	`·s3EvÆInvÆid©ePo¶i°
(
pPhø£
);

4495 *
pRc
 = 
	`·s3EvÆPhø£Next
(
pC§
, 
pPhø£
, &
pEx¥
->
bEof
);

4496 
pEx¥
->
iDocid
 = 
pPhø£
->
do˛i°
.iDocid;

4501 
	}
}

4518 
	$·s3EvÆNórTe°
(
Fts3Ex¥
 *
pEx¥
, *
pRc
){

4519 
ªs
 = 1;

4541 if–*
pRc
==
SQLITE4_OK


4542 && 
pEx¥
->
eTy≥
==
FTSQUERY_NEAR


4543 && 
pEx¥
->
bEof
==0

4544 && (
pEx¥
->
pP¨ít
==0 ||ÖEx¥->pP¨ít->
eTy≥
!=
FTSQUERY_NEAR
)

4546 
Fts3Ex¥
 *
p
;

4547 
nTmp
 = 0;

4548 *
aTmp
;

4551 
p
=
pEx¥
;Ö->
pLe·
;Ö=p->pLeft){

4552 
nTmp
 +
p
->
pRight
->
pPhø£
->
do˛i°
.
nLi°
;

4554 
nTmp
 +
p
->
pPhø£
->
do˛i°
.
nLi°
;

4555 
aTmp
 = 
	`sqlôe4_mÆloc
(
nTmp
*2);

4556 if–!
aTmp
 ){

4557 *
pRc
 = 
SQLITE4_NOMEM
;

4558 
ªs
 = 0;

4560 *
aPo¶i°
 = 
p
->
pPhø£
->
do˛i°
.
pLi°
;

4561 
nTokí
 = 
p
->
pPhø£
->nToken;

4563 
p
ı->
pP¨ít
;
ªs
 &&Ö &&Ö->
eTy≥
==
FTSQUERY_NEAR
;Ö=p->pParent){

4564 
Fts3Phø£
 *
pPhø£
 = 
p
->
pRight
->pPhrase;

4565 
nNór
 = 
p
->nNear;

4566 
ªs
 = 
	`·s3EvÆNórTrim
(
nNór
, 
aTmp
, &
aPo¶i°
, &
nTokí
, 
pPhø£
);

4569 
aPo¶i°
 = 
pEx¥
->
pRight
->
pPhø£
->
do˛i°
.
pLi°
;

4570 
nTokí
 = 
pEx¥
->
pRight
->
pPhø£
->nToken;

4571 
p
=
pEx¥
->
pLe·
;Ö && 
ªs
;Ö=p->pLeft){

4572 
nNór
;

4573 
Fts3Phø£
 *
pPhø£
;

4574 
	`as£π
–
p
->
pP¨ít
 &&Ö->pP¨ít->
pLe·
==p );

4575 
nNór
 = 
p
->
pP¨ít
->nNear;

4576 
pPhø£
 = (

4577 
p
->
eTy≥
==
FTSQUERY_NEAR
 ?Ö->
pRight
->
pPhø£
 :Ö->pPhrase

4579 
ªs
 = 
	`·s3EvÆNórTrim
(
nNór
, 
aTmp
, &
aPo¶i°
, &
nTokí
, 
pPhø£
);

4583 
	`sqlôe4_‰ì
(
aTmp
);

4586  
ªs
;

4587 
	}
}

4600 
	$·s3EvÆTe°Ex¥
(

4601 
Fts3Curs‹
 *
pC§
,

4602 
Fts3Ex¥
 *
pEx¥
,

4603 *
pRc


4605 
bHô
 = 1;

4606 if–*
pRc
==
SQLITE4_OK
 ){

4607  
pEx¥
->
eTy≥
 ){

4608 
FTSQUERY_NEAR
:

4609 
FTSQUERY_AND
:

4610 
bHô
 = (

4611 
	`·s3EvÆTe°Ex¥
(
pC§
, 
pEx¥
->
pLe·
, 
pRc
)

4612 && 
	`·s3EvÆTe°Ex¥
(
pC§
, 
pEx¥
->
pRight
, 
pRc
)

4613 && 
	`·s3EvÆNórTe°
(
pEx¥
, 
pRc
)

4631 if–
bHô
==0

4632 && 
pEx¥
->
eTy≥
==
FTSQUERY_NEAR


4633 && (
pEx¥
->
pP¨ít
==0 ||ÖEx¥->pP¨ít->
eTy≥
!=
FTSQUERY_NEAR
)

4635 
Fts3Ex¥
 *
p
;

4636 
p
=
pEx¥
;Ö->
pPhø£
==0;Öı->
pLe·
){

4637 if–
p
->
pRight
->
iDocid
==
pC§
->
iPªvId
 ){

4638 
	`·s3EvÆInvÆid©ePo¶i°
(
p
->
pRight
->
pPhø£
);

4641 if–
p
->
iDocid
==
pC§
->
iPªvId
 ){

4642 
	`·s3EvÆInvÆid©ePo¶i°
(
p
->
pPhø£
);

4648 
FTSQUERY_OR
: {

4649 
bHô1
 = 
	`·s3EvÆTe°Ex¥
(
pC§
, 
pEx¥
->
pLe·
, 
pRc
);

4650 
bHô2
 = 
	`·s3EvÆTe°Ex¥
(
pC§
, 
pEx¥
->
pRight
, 
pRc
);

4651 
bHô
 = 
bHô1
 || 
bHô2
;

4655 
FTSQUERY_NOT
:

4656 
bHô
 = (

4657 
	`·s3EvÆTe°Ex¥
(
pC§
, 
pEx¥
->
pLe·
, 
pRc
)

4658 && !
	`·s3EvÆTe°Ex¥
(
pC§
, 
pEx¥
->
pRight
, 
pRc
)

4663 if–
pC§
->
pDe„ºed


4664 && (
pEx¥
->
iDocid
==
pC§
->
iPªvId
 ||ÖEx¥->
bDe„ºed
)

4666 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

4667 
	`as£π
–
pEx¥
->
bDe„ºed
 || 
pPhø£
->
do˛i°
.
bFªeLi°
==0 );

4668 if–
pEx¥
->
bDe„ºed
 ){

4669 
	`·s3EvÆInvÆid©ePo¶i°
(
pPhø£
);

4671 *
pRc
 = 
	`·s3EvÆDe„ºedPhø£
(
pC§
, 
pPhø£
);

4672 
bHô
 = (
pPhø£
->
do˛i°
.
pLi°
!=0);

4673 
pEx¥
->
iDocid
 = 
pC§
->
iPªvId
;

4675 
bHô
 = (
pEx¥
->
bEof
==0 &&ÖEx¥->
iDocid
==
pC§
->
iPªvId
);

4681  
bHô
;

4682 
	}
}

4708 
	$·s3EvÆTe°De„ºedAndNór
(
Fts3Curs‹
 *
pC§
, *
pRc
){

4709 
rc
 = *
pRc
;

4710 
bMiss
 = 0;

4711 if–
rc
==
SQLITE4_OK
 ){

4719 if–
pC§
->
pDe„ºed
 ){

4720 
rc
 = 
	`·s3Curs‹Sìk
(0, 
pC§
);

4721 if–
rc
==
SQLITE4_OK
 ){

4722 
rc
 = 
	`sqlôe4Fts3CacheDe„ºedDo˛i°s
(
pC§
);

4725 
bMiss
 = (0==
	`·s3EvÆTe°Ex¥
(
pC§
,ÖC§->
pEx¥
, &
rc
));

4728 
	`sqlôe4Fts3FªeDe„ºedDo˛i°s
(
pC§
);

4729 *
pRc
 = 
rc
;

4731  (
rc
==
SQLITE4_OK
 && 
bMiss
);

4732 
	}
}

4738 
	$·s3EvÆNext
(
Fts3Curs‹
 *
pC§
){

4739 
rc
 = 
SQLITE4_OK
;

4740 
Fts3Ex¥
 *
pEx¥
 = 
pC§
->pExpr;

4741 
	`as£π
–
pC§
->
isEof
==0 );

4742 if–
pEx¥
==0 ){

4743 
pC§
->
isEof
 = 1;

4746 if–
pC§
->
isRequúeSìk
==0 ){

4747 
	`sqlôe4_ª£t
(
pC§
->
pStmt
);

4749 
	`as£π
–
	`sqlôe4_d©a_cou¡
(
pC§
->
pStmt
)==0 );

4750 
	`·s3EvÆNextRow
(
pC§
, 
pEx¥
, &
rc
);

4751 
pC§
->
isEof
 = 
pEx¥
->
bEof
;

4752 
pC§
->
isRequúeSìk
 = 1;

4753 
pC§
->
isM©chöfoNìded
 = 1;

4754 
pC§
->
iPªvId
 = 
pEx¥
->
iDocid
;

4755 } 
pC§
->
isEof
==0 && 
	`·s3EvÆTe°De„ºedAndNór
’C§, &
rc
) );

4757  
rc
;

4758 
	}
}

4769 
	$·s3EvÆRe°¨t
(

4770 
Fts3Curs‹
 *
pC§
,

4771 
Fts3Ex¥
 *
pEx¥
,

4772 *
pRc


4774 if–
pEx¥
 && *
pRc
==
SQLITE4_OK
 ){

4775 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

4777 if–
pPhø£
 ){

4778 
	`·s3EvÆInvÆid©ePo¶i°
(
pPhø£
);

4779 if–
pPhø£
->
bIn¸
 ){

4780 
	`as£π
–
pPhø£
->
nTokí
==1 );

4781 
	`as£π
–
pPhø£
->
aTokí
[0].
pSegc§
 );

4782 
	`sqlôe4Fts3M§In¸Re°¨t
(
pPhø£
->
aTokí
[0].
pSegc§
);

4783 *
pRc
 = 
	`·s3EvÆPhø£Sèπ
(
pC§
, 0, 
pPhø£
);

4786 
pPhø£
->
do˛i°
.
pNextDocid
 = 0;

4787 
pPhø£
->
do˛i°
.
iDocid
 = 0;

4790 
pEx¥
->
iDocid
 = 0;

4791 
pEx¥
->
bEof
 = 0;

4792 
pEx¥
->
bSèπ
 = 0;

4794 
	`·s3EvÆRe°¨t
(
pC§
, 
pEx¥
->
pLe·
, 
pRc
);

4795 
	`·s3EvÆRe°¨t
(
pC§
, 
pEx¥
->
pRight
, 
pRc
);

4797 
	}
}

4807 
	$·s3EvÆUpd©eCou¡s
(
Fts3Ex¥
 *
pEx¥
){

4808 if–
pEx¥
 ){

4809 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

4810 if–
pPhø£
 &&ÖPhø£->
do˛i°
.
pLi°
 ){

4811 
iCﬁ
 = 0;

4812 *
p
 = 
pPhø£
->
do˛i°
.
pLi°
;

4814 
	`as£π
–*
p
 );

4816 
u8
 
c
 = 0;

4817 
iC¡
 = 0;

4818  0xFE & (*
p
 | 
c
) ){

4819 if–(
c
&0x80)==0 ) 
iC¡
++;

4820 
c
 = *
p
++ & 0x80;

4826 
pEx¥
->
aMI
[
iCﬁ
*3 + 1] +
iC¡
;

4827 
pEx¥
->
aMI
[
iCﬁ
*3 + 2] +(
iC¡
>0);

4828 if–*
p
==0x00 ) ;

4829 
p
++;

4830 
p
 +
	`sqlôe4Fts3GëV¨öt32
’, &
iCﬁ
);

4834 
	`·s3EvÆUpd©eCou¡s
(
pEx¥
->
pLe·
);

4835 
	`·s3EvÆUpd©eCou¡s
(
pEx¥
->
pRight
);

4837 
	}
}

4850 
	$·s3EvÆG©hîSèts
(

4851 
Fts3Curs‹
 *
pC§
,

4852 
Fts3Ex¥
 *
pEx¥


4854 
rc
 = 
SQLITE4_OK
;

4856 
	`as£π
–
pEx¥
->
eTy≥
==
FTSQUERY_PHRASE
 );

4857 if–
pEx¥
->
aMI
==0 ){

4858 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

4859 
Fts3Ex¥
 *
pRoŸ
;

4860 
Fts3Ex¥
 *
p
;

4862 
sqlôe4_öt64
 
iPªvId
 = 
pC§
->iPrevId;

4863 
sqlôe4_öt64
 
iDocid
;

4864 
u8
 
bEof
;

4867 
pRoŸ
 = 
pEx¥
;

4868  
pRoŸ
->
pP¨ít
 &&ÖRoŸ->pP¨ít->
eTy≥
==
FTSQUERY_NEAR
 ){

4869 
pRoŸ
 =ÖRoŸ->
pP¨ít
;

4871 
iDocid
 = 
pRoŸ
->iDocid;

4872 
bEof
 = 
pRoŸ
->bEof;

4873 
	`as£π
–
pRoŸ
->
bSèπ
 );

4876 
p
=
pRoŸ
;Ö;Öı->
pLe·
){

4877 
Fts3Ex¥
 *
pE
 = (
p
->
eTy≥
==
FTSQUERY_PHRASE
?p:p->
pRight
);

4878 
	`as£π
–
pE
->
aMI
==0 );

4879 
pE
->
aMI
 = (
u32
 *)
	`sqlôe4_mÆloc
(
pTab
->
nCﬁumn
 * 3 * (u32));

4880 if–!
pE
->
aMI
 )  
SQLITE4_NOMEM
;

4881 
	`mem£t
(
pE
->
aMI
, 0, 
pTab
->
nCﬁumn
 * 3 * (
u32
));

4884 
	`·s3EvÆRe°¨t
(
pC§
, 
pRoŸ
, &
rc
);

4886  
pC§
->
isEof
==0 && 
rc
==
SQLITE4_OK
 ){

4890 if–
pC§
->
isRequúeSìk
==0 ) 
	`sqlôe4_ª£t
’C§->
pStmt
);

4891 
	`as£π
–
	`sqlôe4_d©a_cou¡
(
pC§
->
pStmt
)==0 );

4894 
	`·s3EvÆNextRow
(
pC§
, 
pRoŸ
, &
rc
);

4895 
pC§
->
isEof
 = 
pRoŸ
->
bEof
;

4896 
pC§
->
isRequúeSìk
 = 1;

4897 
pC§
->
isM©chöfoNìded
 = 1;

4898 
pC§
->
iPªvId
 = 
pRoŸ
->
iDocid
;

4899 } 
pC§
->
isEof
==0

4900 && 
pRoŸ
->
eTy≥
==
FTSQUERY_NEAR


4901 && 
	`·s3EvÆTe°De„ºedAndNór
(
pC§
, &
rc
)

4904 if–
rc
==
SQLITE4_OK
 && 
pC§
->
isEof
==0 ){

4905 
	`·s3EvÆUpd©eCou¡s
(
pRoŸ
);

4909 
pC§
->
isEof
 = 0;

4910 
pC§
->
iPªvId
 = iPrevId;

4912 if–
bEof
 ){

4913 
pRoŸ
->
bEof
 = bEof;

4921 
	`·s3EvÆRe°¨t
(
pC§
, 
pRoŸ
, &
rc
);

4923 
	`·s3EvÆNextRow
(
pC§
, 
pRoŸ
, &
rc
);

4924 
	`as£π
–
pRoŸ
->
bEof
==0 );

4925 } 
pRoŸ
->
iDocid
!=iDocid && 
rc
==
SQLITE4_OK
 );

4926 
	`·s3EvÆTe°De„ºedAndNór
(
pC§
, &
rc
);

4929  
rc
;

4930 
	}
}

4962 
	$sqlôe4Fts3EvÆPhø£Sèts
(

4963 
Fts3Curs‹
 *
pC§
,

4964 
Fts3Ex¥
 *
pEx¥
,

4965 
u32
 *
aiOut


4967 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

4968 
rc
 = 
SQLITE4_OK
;

4969 
iCﬁ
;

4971 if–
pEx¥
->
bDe„ºed
 &&ÖEx¥->
pP¨ít
->
eTy≥
!=
FTSQUERY_NEAR
 ){

4972 
	`as£π
–
pC§
->
nDoc
>0 );

4973 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁumn
; iCol++){

4974 
aiOut
[
iCﬁ
*3 + 1] = (
u32
)
pC§
->
nDoc
;

4975 
aiOut
[
iCﬁ
*3 + 2] = (
u32
)
pC§
->
nDoc
;

4978 
rc
 = 
	`·s3EvÆG©hîSèts
(
pC§
, 
pEx¥
);

4979 if–
rc
==
SQLITE4_OK
 ){

4980 
	`as£π
–
pEx¥
->
aMI
 );

4981 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁumn
; iCol++){

4982 
aiOut
[
iCﬁ
*3 + 1] = 
pEx¥
->
aMI
[iCol*3 + 1];

4983 
aiOut
[
iCﬁ
*3 + 2] = 
pEx¥
->
aMI
[iCol*3 + 2];

4988  
rc
;

4989 
	}
}

5010 *
	$sqlôe4Fts3EvÆPhø£Po¶i°
(

5011 
Fts3Curs‹
 *
pC§
,

5012 
Fts3Ex¥
 *
pEx¥
,

5013 
iCﬁ


5015 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

5016 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

5017 *
pIãr
 = 
pPhø£
->
do˛i°
.
pLi°
;

5018 
iThis
;

5020 
	`as£π
–
iCﬁ
>=0 && iCﬁ<
pTab
->
nCﬁumn
 );

5021 if–!
pIãr


5022 || 
pEx¥
->
bEof


5023 || 
pEx¥
->
iDocid
!=
pC§
->
iPªvId


5024 || (
pPhø£
->
iCﬁumn
<
pTab
->
nCﬁumn
 &&ÖPhø£->iCﬁumn!=
iCﬁ
)

5029 
	`as£π
–
pPhø£
->
do˛i°
.
nLi°
>0 );

5030 if–*
pIãr
==0x01 ){

5031 
pIãr
++;

5032 
pIãr
 +
	`sqlôe4Fts3GëV¨öt32
’Iãr, &
iThis
);

5034 
iThis
 = 0;

5036  
iThis
<
iCﬁ
 ){

5037 
	`·s3Cﬁum∆i°C›y
(0, &
pIãr
);

5038 if–*
pIãr
==0x00 )  0;

5039 
pIãr
++;

5040 
pIãr
 +
	`sqlôe4Fts3GëV¨öt32
’Iãr, &
iThis
);

5043  ((
iCﬁ
==
iThis
)?
pIãr
:0);

5044 
	}
}

5053 
	$sqlôe4Fts3EvÆPhø£CÀ™up
(
Fts3Phø£
 *
pPhø£
){

5054 if–
pPhø£
 ){

5055 
i
;

5056 
	`sqlôe4_‰ì
(
pPhø£
->
do˛i°
.
aAŒ
);

5057 
	`·s3EvÆInvÆid©ePo¶i°
(
pPhø£
);

5058 
	`mem£t
(&
pPhø£
->
do˛i°
, 0, (
Fts3Do˛i°
));

5059 
i
=0; i<
pPhø£
->
nTokí
; i++){

5060 
	`·s3SegRódîCurs‹Fªe
(
pPhø£
->
aTokí
[
i
].
pSegc§
);

5061 
pPhø£
->
aTokí
[
i
].
pSegc§
 = 0;

5064 
	}
}

5069 #ifde‡
SQLITE4_DEBUG


5070 
	$sqlôe4Fts3C‹ru±
(){

5071  
SQLITE4_CORRUPT_VTAB
;

5072 
	}
}

5075 #i‡!
SQLITE4_CORE


5079 
	$sqlôe4_exãnsi⁄_öô
(

5080 
sqlôe4
 *
db
,

5081 **
pzEºMsg
,

5082 c⁄° 
sqlôe4_≠i_routöes
 *
pApi


5084 
	`SQLITE4_EXTENSION_INIT2
(
pApi
)

5085  
	`sqlôe4Fts3Inô
(
db
);

5086 
	}
}

	@ext/fts3/fts3.h

16 
	~"sqlôe4.h
"

18 #ifde‡
__˝lu•lus


22 
sqlôe4Fts3Inô
(
sqlôe4
 *
db
);

24 #ifde‡
__˝lu•lus


	@ext/fts3/fts3Int.h

14 #i‚de‡
_FTSINT_H


15 
	#_FTSINT_H


	)

17 #i‡!
deföed
(
NDEBUG
Ë&& !deföed(
SQLITE4_DEBUG
)

18 
	#NDEBUG
 1

	)

26 #i‡
deföed
(
SQLITE4_ENABLE_FTS4
Ë&& !deföed(
SQLITE4_ENABLE_FTS3
)

27 
	#SQLITE4_ENABLE_FTS3


	)

30 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

32 
	~"sqlôe4.h
"

33 
	~"·s3_tokíizî.h
"

34 
	~"·s3_hash.h
"

41 
	#FTS3_MERGE_COUNT
 16

	)

51 
	#FTS3_MAX_PENDING_DATA
 (1*1024*1024)

	)

58 
	#SizeofAºay
(
X
Ë(()((X)/(X[0])))

	)

61 #i‚de‡
MIN


62 
	#MIN
(
x
,
y
Ë((x)<(y)?(x):(y))

	)

69 
	#FTS3_VARINT_MAX
 10

	)

86 
	#FTS3_SEGDIR_MAXLEVEL
 1024

	)

87 
	#FTS3_SEGDIR_MAXLEVEL_STR
 "1024"

	)

93 #i‚de‡
ã°ˇ£


94 
	#ã°ˇ£
(
X
)

	)

100 
	#POS_COLUMN
 (1Ë

	)

101 
	#POS_END
 (0Ë

	)

108 #i‚de‡
SQLITE4_AMALGAMATION


113 #ifde‡
SQLITE4_COVERAGE_TEST


114 
	#ALWAYS
(
x
Ë(1)

	)

115 
	#NEVER
(
X
Ë(0)

	)

117 
	#ALWAYS
(
x
Ë(x)

	)

118 
	#NEVER
(
X
Ë(
x
)

	)

124 
	tu8
;

125 
	ti16
;

126 
	tu32
;

127 
sqlôe4_uöt64
 
	tu64
;

132 
	#UNUSED_PARAMETER
(
x
Ë()(x)

	)

137 #i‡!
deföed
(
NDEBUG
Ë&& !deföed(
SQLITE4_DEBUG
)

138 
	#NDEBUG
 1

	)

146 #i‡
deföed
(
SQLITE4_DEBUG
Ë|| deföed(
SQLITE4_COVERAGE_TEST
)

147 
	#TESTONLY
(
X
Ë
	)
X

149 
	#TESTONLY
(
X
)

	)

154 #ifde‡
SQLITE4_DEBUG


155 
sqlôe4Fts3C‹ru±
();

156 
	#FTS_CORRUPT_VTAB
 
	`sqlôe4Fts3C‹ru±
()

	)

158 
	#FTS_CORRUPT_VTAB
 
SQLITE4_CORRUPT_VTAB


	)

161 
Fts3TabÀ
 
	tFts3TabÀ
;

162 
Fts3Curs‹
 
	tFts3Curs‹
;

163 
Fts3Ex¥
 
	tFts3Ex¥
;

164 
Fts3Phø£
 
	tFts3Phø£
;

165 
Fts3Phø£Tokí
 
	tFts3Phø£Tokí
;

167 
Fts3Do˛i°
 
	tFts3Do˛i°
;

168 
Fts3SegFûãr
 
	tFts3SegFûãr
;

169 
Fts3De„ºedTokí
 
	tFts3De„ºedTokí
;

170 
Fts3SegRódî
 
	tFts3SegRódî
;

171 
Fts3Mu…iSegRódî
 
	tFts3Mu…iSegRódî
;

180 
	sFts3TabÀ
 {

181 
sqlôe4_vèb
 
	mba£
;

182 
sqlôe4
 *
	mdb
;

183 c⁄° *
	mzDb
;

184 c⁄° *
	mzName
;

185 
	mnCﬁumn
;

186 **
	mazCﬁumn
;

187 
sqlôe4_tokíizî
 *
	mpTokíizî
;

188 *
	mzC⁄ã¡Tbl
;

193 
sqlôe4_°mt
 *
	maStmt
[27];

195 *
	mzRódEx¥li°
;

196 *
	mzWrôeEx¥li°
;

198 
	mnNodeSize
;

199 
u8
 
	mbHasSèt
;

200 
u8
 
	mbHasDocsize
;

201 
u8
 
	mbDescIdx
;

202 
	mnPgsz
;

203 *
	mzSegmítsTbl
;

204 
sqlôe4_blob
 *
	mpSegmíts
;

220 
	mnIndex
;

221 
	sFts3Index
 {

222 
	mnPªfix
;

223 
Fts3Hash
 
	mhPídög
;

224 } *
	maIndex
;

225 
	mnMaxPídögD©a
;

226 
	mnPídögD©a
;

227 
sqlôe_öt64
 
	miPªvDocid
;

229 #i‡
deföed
(
SQLITE4_DEBUG
Ë|| deföed(
SQLITE4_COVERAGE_TEST
)

235 
	möTønß˘i⁄
;

236 
	mmxSavïoöt
;

245 
	sFts3Curs‹
 {

246 
sqlôe4_vèb_curs‹
 
	mba£
;

247 
i16
 
	meSórch
;

248 
u8
 
	misEof
;

249 
u8
 
	misRequúeSìk
;

250 
sqlôe4_°mt
 *
	mpStmt
;

251 
Fts3Ex¥
 *
	mpEx¥
;

252 
	mnPhø£
;

253 
Fts3De„ºedTokí
 *
	mpDe„ºed
;

254 
sqlôe4_öt64
 
	miPªvId
;

255 *
	mpNextId
;

256 *
	maDo˛i°
;

257 
	mnDo˛i°
;

258 
u8
 
	mbDesc
;

259 
	meEvÆmode
;

260 
	mnRowAvg
;

261 
sqlôe4_öt64
 
	mnDoc
;

263 
	misM©chöfoNìded
;

264 
u32
 *
	maM©chöfo
;

265 
	mnM©chöfo
;

266 *
	mzM©chöfo
;

269 
	#FTS3_EVAL_FILTER
 0

	)

270 
	#FTS3_EVAL_NEXT
 1

	)

271 
	#FTS3_EVAL_MATCHINFO
 2

	)

288 
	#FTS3_FULLSCAN_SEARCH
 0

	)

289 
	#FTS3_DOCID_SEARCH
 1

	)

290 
	#FTS3_FULLTEXT_SEARCH
 2

	)

293 
	sFts3Do˛i°
 {

294 *
	maAŒ
;

295 
	mnAŒ
;

296 *
	mpNextDocid
;

298 
sqlôe4_öt64
 
	miDocid
;

299 
	mbFªeLi°
;

300 *
	mpLi°
;

301 
	mnLi°
;

310 
	sFts3Phø£Tokí
 {

311 *
	mz
;

312 
	mn
;

313 
	misPªfix
;

314 
	mbFú°
;

319 
Fts3De„ºedTokí
 *
	mpDe„ºed
;

320 
Fts3Mu…iSegRódî
 *
	mpSegc§
;

323 
	sFts3Phø£
 {

325 
Fts3Do˛i°
 
	mdo˛i°
;

326 
	mbIn¸
;

327 
	miDo˛i°Tokí
;

332 
	mnTokí
;

333 
	miCﬁumn
;

334 
Fts3Phø£Tokí
 
	maTokí
[1];

358 
	sFts3Ex¥
 {

359 
	meTy≥
;

360 
	mnNór
;

361 
Fts3Ex¥
 *
	mpP¨ít
;

362 
Fts3Ex¥
 *
	mpLe·
;

363 
Fts3Ex¥
 *
	mpRight
;

364 
Fts3Phø£
 *
	mpPhø£
;

367 
sqlôe4_öt64
 
	miDocid
;

368 
u8
 
	mbEof
;

369 
u8
 
	mbSèπ
;

370 
u8
 
	mbDe„ºed
;

372 
u32
 *
	maMI
;

386 
	#FTSQUERY_NEAR
 1

	)

387 
	#FTSQUERY_NOT
 2

	)

388 
	#FTSQUERY_AND
 3

	)

389 
	#FTSQUERY_OR
 4

	)

390 
	#FTSQUERY_PHRASE
 5

	)

394 
sqlôe4Fts3Upd©eMëhod
(
sqlôe4_vèb
*,,
sqlôe4_vÆue
**,
sqlôe4_öt64
*);

395 
sqlôe4Fts3PídögTîmsFlush
(
Fts3TabÀ
 *);

396 
sqlôe4Fts3PídögTîmsCÀ¨
(
Fts3TabÀ
 *);

397 
sqlôe4Fts3O±imize
(
Fts3TabÀ
 *);

398 
sqlôe4Fts3SegRódîNew
(, 
sqlôe4_öt64
,

399 
sqlôe4_öt64
, sqlôe4_öt64, c⁄° *, , 
Fts3SegRódî
**);

400 
sqlôe4Fts3SegRódîPídög
(

401 
Fts3TabÀ
*,,c⁄° *,,,
Fts3SegRódî
**);

402 
sqlôe4Fts3SegRódîFªe
(
Fts3SegRódî
 *);

403 
sqlôe4Fts3AŒSegdús
(
Fts3TabÀ
*, , , 
sqlôe4_°mt
 **);

404 
sqlôe4Fts3RódLock
(
Fts3TabÀ
 *);

405 
sqlôe4Fts3RódBlock
(
Fts3TabÀ
*, 
sqlôe4_öt64
, **, *, *);

407 
sqlôe4Fts3Sñe˘Do˘ŸÆ
(
Fts3TabÀ
 *, 
sqlôe4_°mt
 **);

408 
sqlôe4Fts3Sñe˘Docsize
(
Fts3TabÀ
 *, 
sqlôe4_öt64
, 
sqlôe4_°mt
 **);

410 
sqlôe4Fts3FªeDe„ºedTokís
(
Fts3Curs‹
 *);

411 
sqlôe4Fts3De„rTokí
(
Fts3Curs‹
 *, 
Fts3Phø£Tokí
 *, );

412 
sqlôe4Fts3CacheDe„ºedDo˛i°s
(
Fts3Curs‹
 *);

413 
sqlôe4Fts3FªeDe„ºedDo˛i°s
(
Fts3Curs‹
 *);

414 
sqlôe4Fts3SegmítsClo£
(
Fts3TabÀ
 *);

417 
	#FTS3_SEGCURSOR_PENDING
 -1

	)

418 
	#FTS3_SEGCURSOR_ALL
 -2

	)

420 
sqlôe4Fts3SegRódîSèπ
(
Fts3TabÀ
*, 
Fts3Mu…iSegRódî
*, 
Fts3SegFûãr
*);

421 
sqlôe4Fts3SegRódîSãp
(
Fts3TabÀ
 *, 
Fts3Mu…iSegRódî
 *);

422 
sqlôe4Fts3SegRódîFöish
(
Fts3Mu…iSegRódî
 *);

424 
sqlôe4Fts3SegRódîCurs‹
(

425 
Fts3TabÀ
 *, , , c⁄° *, , , , 
Fts3Mu…iSegRódî
 *);

428 
	#FTS3_SEGMENT_REQUIRE_POS
 0x00000001

	)

429 
	#FTS3_SEGMENT_IGNORE_EMPTY
 0x00000002

	)

430 
	#FTS3_SEGMENT_COLUMN_FILTER
 0x00000004

	)

431 
	#FTS3_SEGMENT_PREFIX
 0x00000008

	)

432 
	#FTS3_SEGMENT_SCAN
 0x00000010

	)

433 
	#FTS3_SEGMENT_FIRST
 0x00000020

	)

436 
	sFts3SegFûãr
 {

437 c⁄° *
	mzTîm
;

438 
	mnTîm
;

439 
	miCﬁ
;

440 
	mÊags
;

443 
	sFts3Mu…iSegRódî
 {

445 
Fts3SegRódî
 **
	m≠Segmít
;

446 
	mnSegmít
;

447 
	mnAdv™˚
;

448 
Fts3SegFûãr
 *
	mpFûãr
;

449 *
	maBuf„r
;

450 
	mnBuf„r
;

452 
	miCﬁFûãr
;

453 
	mbRe°¨t
;

456 
	mnCo°
;

457 
	mbLookup
;

460 *
	mzTîm
;

461 
	mnTîm
;

462 *
	maDo˛i°
;

463 
	mnDo˛i°
;

467 
sqlôe4Fts3PutV¨öt
(*, 
sqlôe4_öt64
);

468 
sqlôe4Fts3GëV¨öt
(c⁄° *, 
sqlôe_öt64
 *);

469 
sqlôe4Fts3GëV¨öt32
(const *, *);

470 
sqlôe4Fts3V¨ötLí
(
sqlôe4_uöt64
);

471 
sqlôe4Fts3DequŸe
(*);

472 
sqlôe4Fts3Do˛i°Pªv
(,*,,**,
sqlôe4_öt64
*,*,
u8
*);

473 
sqlôe4Fts3EvÆPhø£Sèts
(
Fts3Curs‹
 *, 
Fts3Ex¥
 *, 
u32
 *);

474 
sqlôe4Fts3Fú°Fûãr
(
sqlôe4_öt64
, *, , *);

477 c⁄° *
sqlôe4Fts3NextTokí
(const *, *);

478 
sqlôe4Fts3InôHashTabÀ
(
sqlôe4
 *, 
Fts3Hash
 *, const *);

479 
sqlôe4Fts3InôTokíizî
(
Fts3Hash
 *
pHash
, const *,

480 
sqlôe4_tokíizî
 **, **

482 
sqlôe4Fts3IsIdCh¨
();

485 
sqlôe4Fts3Off£ts
(
sqlôe4_c⁄ãxt
*, 
Fts3Curs‹
*);

486 
sqlôe4Fts3Snù≥t
(
sqlôe4_c⁄ãxt
 *, 
Fts3Curs‹
 *, const *,

489 
sqlôe4Fts3M©chöfo
(
sqlôe4_c⁄ãxt
 *, 
Fts3Curs‹
 *, const *);

492 
sqlôe4Fts3Ex¥P¨£
(
sqlôe4_tokíizî
 *,

493 **, , , , c⁄° *, , 
Fts3Ex¥
 **

495 
sqlôe4Fts3Ex¥Fªe
(
Fts3Ex¥
 *);

496 #ifde‡
SQLITE4_TEST


497 
sqlôe4Fts3Ex¥InôTe°I¡îÁ˚
(
sqlôe4
 *
db
);

498 
sqlôe4Fts3InôTîm
(
sqlôe4
 *
db
);

502 
sqlôe4Fts3InôAux
(
sqlôe4
 *
db
);

504 
sqlôe4Fts3EvÆPhø£CÀ™up
(
Fts3Phø£
 *);

506 
sqlôe4Fts3M§In¸Sèπ
(

507 
Fts3TabÀ
*, 
Fts3Mu…iSegRódî
*, , const *, );

508 
sqlôe4Fts3M§In¸Next
(

509 
Fts3TabÀ
 *, 
Fts3Mu…iSegRódî
 *, 
sqlôe4_öt64
 *, **, *);

510 *
sqlôe4Fts3EvÆPhø£Po¶i°
(
Fts3Curs‹
 *, 
Fts3Ex¥
 *, 
iCﬁ
);

511 
sqlôe4Fts3M§OvÊ
(
Fts3Curs‹
 *, 
Fts3Mu…iSegRódî
 *, *);

512 
sqlôe4Fts3M§In¸Re°¨t
(
Fts3Mu…iSegRódî
 *
pC§
);

514 
sqlôe4Fts3De„ºedTokíLi°
(
Fts3De„ºedTokí
 *, **, *);

	@ext/fts3/fts3_aux.c

14 
	~"·s3I¡.h
"

15 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

17 
	~<°rög.h
>

18 
	~<as£π.h
>

20 
Fts3auxTabÀ
 
	tFts3auxTabÀ
;

21 
Fts3auxCurs‹
 
	tFts3auxCurs‹
;

23 
	sFts3auxTabÀ
 {

24 
sqlôe4_vèb
 
	mba£
;

25 
Fts3TabÀ
 *
	mpFts3Tab
;

28 
	sFts3auxCurs‹
 {

29 
sqlôe4_vèb_curs‹
 
	mba£
;

30 
Fts3Mu…iSegRódî
 
	mc§
;

31 
Fts3SegFûãr
 
	mfûãr
;

32 *
	mzSt›
;

33 
	mnSt›
;

34 
	misEof
;

35 
sqlôe4_öt64
 
	miRowid
;

37 
	miCﬁ
;

38 
	mnSèt
;

39 
	sFts3auxCﬁ°©s
 {

40 
sqlôe4_öt64
 
	mnDoc
;

41 
sqlôe4_öt64
 
	mnOcc
;

42 } *
	maSèt
;

48 
	#FTS3_TERMS_SCHEMA
 "CREATE TABLE x—îm, cﬁ, documíts, occuºí˚s)"

	)

55 
	$·s3auxC⁄√˘Mëhod
(

56 
sqlôe4
 *
db
,

57 *
pUnu£d
,

58 
¨gc
,

59 c⁄° * c⁄° *
¨gv
,

60 
sqlôe4_vèb
 **
µVèb
,

61 **
pzEº


63 c⁄° *
zDb
;

64 c⁄° *
zFts3
;

65 
nDb
;

66 
nFts3
;

67 
nByã
;

68 
rc
;

69 
Fts3auxTabÀ
 *
p
;

71 
	`UNUSED_PARAMETER
(
pUnu£d
);

74 if–
¨gc
!=4 ){

75 *
pzEº
 = 
	`sqlôe4_m¥ötf
(

78  
SQLITE4_ERROR
;

81 
zDb
 = 
¨gv
[1];

82 
nDb
 = 
	`°æí
(
zDb
);

83 
zFts3
 = 
¨gv
[3];

84 
nFts3
 = 
	`°æí
(
zFts3
);

86 
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
db
, 
FTS3_TERMS_SCHEMA
);

87 if–
rc
!=
SQLITE4_OK
 ) Ñc;

89 
nByã
 = (
Fts3auxTabÀ
Ë+ (
Fts3TabÀ
Ë+ 
nDb
 + 
nFts3
 + 2;

90 
p
 = (
Fts3auxTabÀ
 *)
	`sqlôe4_mÆloc
(
nByã
);

91 if–!
p
 )  
SQLITE4_NOMEM
;

92 
	`mem£t
(
p
, 0, 
nByã
);

94 
p
->
pFts3Tab
 = (
Fts3TabÀ
 *)&p[1];

95 
p
->
pFts3Tab
->
zDb
 = (*)&p->pFts3Tab[1];

96 
p
->
pFts3Tab
->
zName
 = &p->pFts3Tab->
zDb
[
nDb
+1];

97 
p
->
pFts3Tab
->
db
 = db;

98 
p
->
pFts3Tab
->
nIndex
 = 1;

100 
	`mem˝y
((*)
p
->
pFts3Tab
->
zDb
, zDb, 
nDb
);

101 
	`mem˝y
((*)
p
->
pFts3Tab
->
zName
, 
zFts3
, 
nFts3
);

102 
	`sqlôe4Fts3DequŸe
((*)
p
->
pFts3Tab
->
zName
);

104 *
µVèb
 = (
sqlôe4_vèb
 *)
p
;

105  
SQLITE4_OK
;

106 
	}
}

113 
	$·s3auxDisc⁄√˘Mëhod
(
sqlôe4_vèb
 *
pVèb
){

114 
Fts3auxTabÀ
 *
p
 = (Fts3auxTabÀ *)
pVèb
;

115 
Fts3TabÀ
 *
pFts3
 = 
p
->
pFts3Tab
;

116 
i
;

119 
i
=0; i<
	`SizeofAºay
(
pFts3
->
aStmt
); i++){

120 
	`sqlôe4_föÆize
(
pFts3
->
aStmt
[
i
]);

122 
	`sqlôe4_‰ì
(
pFts3
->
zSegmítsTbl
);

123 
	`sqlôe4_‰ì
(
p
);

124  
SQLITE4_OK
;

125 
	}
}

127 
	#FTS4AUX_EQ_CONSTRAINT
 1

	)

128 
	#FTS4AUX_GE_CONSTRAINT
 2

	)

129 
	#FTS4AUX_LE_CONSTRAINT
 4

	)

134 
	$·s3auxBe°IndexMëhod
(

135 
sqlôe4_vèb
 *
pVTab
,

136 
sqlôe4_ödex_öfo
 *
pInfo


138 
i
;

139 
iEq
 = -1;

140 
iGe
 = -1;

141 
iLe
 = -1;

143 
	`UNUSED_PARAMETER
(
pVTab
);

146 if–
pInfo
->
nOrdîBy
==1

147 && 
pInfo
->
aOrdîBy
[0].
iCﬁumn
==0

148 && 
pInfo
->
aOrdîBy
[0].
desc
==0

150 
pInfo
->
‹dîByC⁄sumed
 = 1;

154 
i
=0; i<
pInfo
->
nC⁄°øöt
; i++){

155 if–
pInfo
->
aC⁄°øöt
[
i
].
ußbÀ
 &&ÖInfo->aC⁄°øöt[i].
iCﬁumn
==0 ){

156 
›
 = 
pInfo
->
aC⁄°øöt
[
i
].op;

157 if–
›
==
SQLITE4_INDEX_CONSTRAINT_EQ
 ) 
iEq
 = 
i
;

158 if–
›
==
SQLITE4_INDEX_CONSTRAINT_LT
 ) 
iLe
 = 
i
;

159 if–
›
==
SQLITE4_INDEX_CONSTRAINT_LE
 ) 
iLe
 = 
i
;

160 if–
›
==
SQLITE4_INDEX_CONSTRAINT_GT
 ) 
iGe
 = 
i
;

161 if–
›
==
SQLITE4_INDEX_CONSTRAINT_GE
 ) 
iGe
 = 
i
;

165 if–
iEq
>=0 ){

166 
pInfo
->
idxNum
 = 
FTS4AUX_EQ_CONSTRAINT
;

167 
pInfo
->
aC⁄°øötUßge
[
iEq
].
¨gvIndex
 = 1;

168 
pInfo
->
e°im©edCo°
 = 5;

170 
pInfo
->
idxNum
 = 0;

171 
pInfo
->
e°im©edCo°
 = 20000;

172 if–
iGe
>=0 ){

173 
pInfo
->
idxNum
 +
FTS4AUX_GE_CONSTRAINT
;

174 
pInfo
->
aC⁄°øötUßge
[
iGe
].
¨gvIndex
 = 1;

175 
pInfo
->
e°im©edCo°
 /= 2;

177 if–
iLe
>=0 ){

178 
pInfo
->
idxNum
 +
FTS4AUX_LE_CONSTRAINT
;

179 
pInfo
->
aC⁄°øötUßge
[
iLe
].
¨gvIndex
 = 1 + (
iGe
>=0);

180 
pInfo
->
e°im©edCo°
 /= 2;

184  
SQLITE4_OK
;

185 
	}
}

190 
	$·s3auxO≥nMëhod
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µC§
){

191 
Fts3auxCurs‹
 *
pC§
;

193 
	`UNUSED_PARAMETER
(
pVTab
);

195 
pC§
 = (
Fts3auxCurs‹
 *)
	`sqlôe4_mÆloc
((Fts3auxCursor));

196 if–!
pC§
 )  
SQLITE4_NOMEM
;

197 
	`mem£t
(
pC§
, 0, (
Fts3auxCurs‹
));

199 *
µC§
 = (
sqlôe4_vèb_curs‹
 *)
pC§
;

200  
SQLITE4_OK
;

201 
	}
}

206 
	$·s3auxClo£Mëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

207 
Fts3TabÀ
 *
pFts3
 = ((
Fts3auxTabÀ
 *)
pCurs‹
->
pVèb
)->
pFts3Tab
;

208 
Fts3auxCurs‹
 *
pC§
 = (Fts3auxCurs‹ *)
pCurs‹
;

210 
	`sqlôe4Fts3SegmítsClo£
(
pFts3
);

211 
	`sqlôe4Fts3SegRódîFöish
(&
pC§
->
c§
);

212 
	`sqlôe4_‰ì
((*)
pC§
->
fûãr
.
zTîm
);

213 
	`sqlôe4_‰ì
(
pC§
->
zSt›
);

214 
	`sqlôe4_‰ì
(
pC§
->
aSèt
);

215 
	`sqlôe4_‰ì
(
pC§
);

216  
SQLITE4_OK
;

217 
	}
}

219 
	$·s3auxGrowSètAºay
(
Fts3auxCurs‹
 *
pC§
, 
nSize
){

220 if–
nSize
>
pC§
->
nSèt
 ){

221 
Fts3auxCﬁ°©s
 *
aNew
;

222 
aNew
 = (
Fts3auxCﬁ°©s
 *)
	`sqlôe4_ªÆloc
(
pC§
->
aSèt
,

223 (
Fts3auxCﬁ°©s
Ë* 
nSize


225 if–
aNew
==0 )  
SQLITE4_NOMEM
;

226 
	`mem£t
(&
aNew
[
pC§
->
nSèt
], 0,

227 (
Fts3auxCﬁ°©s
Ë* (
nSize
 - 
pC§
->
nSèt
)

229 
pC§
->
aSèt
 = 
aNew
;

230 
pC§
->
nSèt
 = 
nSize
;

232  
SQLITE4_OK
;

233 
	}
}

238 
	$·s3auxNextMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

239 
Fts3auxCurs‹
 *
pC§
 = (Fts3auxCurs‹ *)
pCurs‹
;

240 
Fts3TabÀ
 *
pFts3
 = ((
Fts3auxTabÀ
 *)
pCurs‹
->
pVèb
)->
pFts3Tab
;

241 
rc
;

244 
pC§
->
iRowid
++;

246 
pC§
->
iCﬁ
++;ÖC§->iCﬁ<pC§->
nSèt
;ÖCsr->iCol++){

247 if–
pC§
->
aSèt
[pC§->
iCﬁ
].
nDoc
>0 )  
SQLITE4_OK
;

250 
rc
 = 
	`sqlôe4Fts3SegRódîSãp
(
pFts3
, &
pC§
->
c§
);

251 if–
rc
==
SQLITE4_ROW
 ){

252 
i
 = 0;

253 
nDo˛i°
 = 
pC§
->
c§
.nDoclist;

254 *
aDo˛i°
 = 
pC§
->
c§
.aDoclist;

255 
iCﬁ
;

257 
eSèã
 = 0;

259 if–
pC§
->
zSt›
 ){

260 
n
 = (
pC§
->
nSt›
<pC§->
c§
.
nTîm
) ?ÖCsr->nStop :ÖCsr->csr.nTerm;

261 
mc
 = 
	`memcmp
(
pC§
->
zSt›
,ÖC§->
c§
.
zTîm
, 
n
);

262 if–
mc
<0 || (mc==0 && 
pC§
->
c§
.
nTîm
>pC§->
nSt›
) ){

263 
pC§
->
isEof
 = 1;

264  
SQLITE4_OK
;

268 if–
	`·s3auxGrowSètAºay
(
pC§
, 2ËË 
SQLITE4_NOMEM
;

269 
	`mem£t
(
pC§
->
aSèt
, 0, (
Fts3auxCﬁ°©s
Ë*ÖC§->
nSèt
);

270 
iCﬁ
 = 0;

272  
i
<
nDo˛i°
 ){

273 
sqlôe4_öt64
 
v
 = 0;

275 
i
 +
	`sqlôe4Fts3GëV¨öt
(&
aDo˛i°
[i], &
v
);

276  
eSèã
 ){

279 
pC§
->
aSèt
[0].
nDoc
++;

280 
eSèã
 = 1;

281 
iCﬁ
 = 0;

293 
	`as£π
–
iCﬁ
==0 );

294 if–
v
>1 ){

295 
pC§
->
aSèt
[1].
nDoc
++;

297 
eSèã
 = 2;

301 if–
v
==0 ){

302 
eSèã
 = 0;

303 }if–
v
==1 ){

304 
eSèã
 = 3;

306 
pC§
->
aSèt
[
iCﬁ
+1].
nOcc
++;

307 
pC§
->
aSèt
[0].
nOcc
++;

312 : 
	`as£π
–
eSèã
==3 );

313 
iCﬁ
 = ()
v
;

314 if–
	`·s3auxGrowSètAºay
(
pC§
, 
iCﬁ
+2ËË 
SQLITE4_NOMEM
;

315 
pC§
->
aSèt
[
iCﬁ
+1].
nDoc
++;

316 
eSèã
 = 2;

321 
pC§
->
iCﬁ
 = 0;

322 
rc
 = 
SQLITE4_OK
;

324 
pC§
->
isEof
 = 1;

326  
rc
;

327 
	}
}

332 
	$·s3auxFûãrMëhod
(

333 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

334 
idxNum
,

335 c⁄° *
idxSå
,

336 
nVÆ
,

337 
sqlôe4_vÆue
 **
≠VÆ


339 
Fts3auxCurs‹
 *
pC§
 = (Fts3auxCurs‹ *)
pCurs‹
;

340 
Fts3TabÀ
 *
pFts3
 = ((
Fts3auxTabÀ
 *)
pCurs‹
->
pVèb
)->
pFts3Tab
;

341 
rc
;

342 
isSˇn
;

344 
	`UNUSED_PARAMETER
(
nVÆ
);

345 
	`UNUSED_PARAMETER
(
idxSå
);

347 
	`as£π
–
idxSå
==0 );

348 
	`as£π
–
idxNum
==
FTS4AUX_EQ_CONSTRAINT
 || idxNum==0

349 || 
idxNum
==
FTS4AUX_LE_CONSTRAINT
 || idxNum==
FTS4AUX_GE_CONSTRAINT


350 || 
idxNum
==(
FTS4AUX_LE_CONSTRAINT
|
FTS4AUX_GE_CONSTRAINT
)

352 
isSˇn
 = (
idxNum
!=
FTS4AUX_EQ_CONSTRAINT
);

355 
	`ã°ˇ£
(
pC§
->
fûãr
.
zTîm
);

356 
	`sqlôe4Fts3SegRódîFöish
(&
pC§
->
c§
);

357 
	`sqlôe4_‰ì
((*)
pC§
->
fûãr
.
zTîm
);

358 
	`sqlôe4_‰ì
(
pC§
->
aSèt
);

359 
	`mem£t
(&
pC§
->
c§
, 0, ((
u8
*)&pCsr[1]) - (u8*)&pCsr->csr);

361 
pC§
->
fûãr
.
Êags
 = 
FTS3_SEGMENT_REQUIRE_POS
|
FTS3_SEGMENT_IGNORE_EMPTY
;

362 if–
isSˇn
 ) 
pC§
->
fûãr
.
Êags
 |
FTS3_SEGMENT_SCAN
;

364 if–
idxNum
&(
FTS4AUX_EQ_CONSTRAINT
|
FTS4AUX_GE_CONSTRAINT
) ){

365 c⁄° *
zSå
 = 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[0]);

366 if–
zSå
 ){

367 
pC§
->
fûãr
.
zTîm
 = 
	`sqlôe4_m¥ötf
("%s", 
zSå
);

368 
pC§
->
fûãr
.
nTîm
 = 
	`sqlôe4_vÆue_byãs
(
≠VÆ
[0]);

369 if–
pC§
->
fûãr
.
zTîm
==0 )  
SQLITE4_NOMEM
;

372 if–
idxNum
&
FTS4AUX_LE_CONSTRAINT
 ){

373 
iIdx
 = (
idxNum
&
FTS4AUX_GE_CONSTRAINT
) ? 1 : 0;

374 
pC§
->
zSt›
 = 
	`sqlôe4_m¥ötf
("%s", 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[
iIdx
]));

375 
pC§
->
nSt›
 = 
	`sqlôe4_vÆue_byãs
(
≠VÆ
[
iIdx
]);

376 if–
pC§
->
zSt›
==0 )  
SQLITE4_NOMEM
;

379 
rc
 = 
	`sqlôe4Fts3SegRódîCurs‹
(
pFts3
, 0, 
FTS3_SEGCURSOR_ALL
,

380 
pC§
->
fûãr
.
zTîm
,ÖC§->fûãr.
nTîm
, 0, 
isSˇn
, &pC§->
c§


382 if–
rc
==
SQLITE4_OK
 ){

383 
rc
 = 
	`sqlôe4Fts3SegRódîSèπ
(
pFts3
, &
pC§
->
c§
, &pC§->
fûãr
);

386 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s3auxNextMëhod
(
pCurs‹
);

387  
rc
;

388 
	}
}

393 
	$·s3auxEofMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

394 
Fts3auxCurs‹
 *
pC§
 = (Fts3auxCurs‹ *)
pCurs‹
;

395  
pC§
->
isEof
;

396 
	}
}

401 
	$·s3auxCﬁumnMëhod
(

402 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

403 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

404 
iCﬁ


406 
Fts3auxCurs‹
 *
p
 = (Fts3auxCurs‹ *)
pCurs‹
;

408 
	`as£π
–
p
->
isEof
==0 );

409 if–
iCﬁ
==0 ){

410 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, 
p
->
c§
.
zTîm
,Ö->c§.
nTîm
, 
SQLITE4_TRANSIENT
);

411 }if–
iCﬁ
==1 ){

412 if–
p
->
iCﬁ
 ){

413 
	`sqlôe4_ªsu…_öt
(
pC⁄ãxt
, 
p
->
iCﬁ
-1);

415 
	`sqlôe4_ªsu…_ãxt
(
pC⁄ãxt
, "*", -1, 
SQLITE4_STATIC
);

417 }if–
iCﬁ
==2 ){

418 
	`sqlôe4_ªsu…_öt64
(
pC⁄ãxt
, 
p
->
aSèt
[p->
iCﬁ
].
nDoc
);

420 
	`sqlôe4_ªsu…_öt64
(
pC⁄ãxt
, 
p
->
aSèt
[p->
iCﬁ
].
nOcc
);

423  
SQLITE4_OK
;

424 
	}
}

429 
	$·s3auxRowidMëhod
(

430 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

431 
sqlôe_öt64
 *
pRowid


433 
Fts3auxCurs‹
 *
pC§
 = (Fts3auxCurs‹ *)
pCurs‹
;

434 *
pRowid
 = 
pC§
->
iRowid
;

435  
SQLITE4_OK
;

436 
	}
}

442 
	$sqlôe4Fts3InôAux
(
sqlôe4
 *
db
){

443 c⁄° 
sqlôe4_moduÀ
 
·s3aux_moduÀ
 = {

445 
·s3auxC⁄√˘Mëhod
,

446 
·s3auxC⁄√˘Mëhod
,

447 
·s3auxBe°IndexMëhod
,

448 
·s3auxDisc⁄√˘Mëhod
,

449 
·s3auxDisc⁄√˘Mëhod
,

450 
·s3auxO≥nMëhod
,

451 
·s3auxClo£Mëhod
,

452 
·s3auxFûãrMëhod
,

453 
·s3auxNextMëhod
,

454 
·s3auxEofMëhod
,

455 
·s3auxCﬁumnMëhod
,

456 
·s3auxRowidMëhod
,

468 
rc
;

470 
rc
 = 
	`sqlôe4_¸óã_moduÀ
(
db
, "·s4aux", &
·s3aux_moduÀ
, 0);

471  
rc
;

472 
	}
}

	@ext/fts3/fts3_expr.c

18 
	~"·s3I¡.h
"

19 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

66 #ifde‡
SQLITE4_TEST


67 
	gsqlôe4_·s3_íabÀ_∑ª¡he£s
 = 0;

69 #ifde‡
SQLITE4_ENABLE_FTS3_PARENTHESIS


70 
	#sqlôe4_·s3_íabÀ_∑ª¡he£s
 1

	)

72 
	#sqlôe4_·s3_íabÀ_∑ª¡he£s
 0

	)

79 
	#SQLITE4_FTS3_DEFAULT_NEAR_PARAM
 10

	)

81 
	~<°rög.h
>

82 
	~<as£π.h
>

92 
P¨£C⁄ãxt
 
	tP¨£C⁄ãxt
;

93 
	sP¨£C⁄ãxt
 {

94 
sqlôe4_tokíizî
 *
	mpTokíizî
;

95 c⁄° **
	mazCﬁ
;

96 
	mbFts4
;

97 
	mnCﬁ
;

98 
	miDeÁu…Cﬁ
;

99 
	misNŸ
;

100 
sqlôe4_c⁄ãxt
 *
	mpCtx
;

101 
	mnNe°
;

115 
	$·s3is•a˚
(
c
){

116  
c
==' ' || c=='\t' || c=='\n' || c=='\r' || c=='\v' || c=='\f';

117 
	}
}

124 *
	$·s3MÆlocZîo
(
nByã
){

125 *
pRë
 = 
	`sqlôe4_mÆloc
(
nByã
);

126 if–
pRë
 ) 
	`mem£t
’Rë, 0, 
nByã
);

127  
pRë
;

128 
	}
}

143 
	$gëNextTokí
(

144 
P¨£C⁄ãxt
 *
pP¨£
,

145 
iCﬁ
,

146 c⁄° *
z
, 
n
,

147 
Fts3Ex¥
 **
µEx¥
,

148 *
≤C⁄sumed


150 
sqlôe4_tokíizî
 *
pTokíizî
 = 
pP¨£
->pTokenizer;

151 
sqlôe4_tokíizî_moduÀ
 c⁄° *
pModuÀ
 = 
pTokíizî
->pModule;

152 
rc
;

153 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
;

154 
Fts3Ex¥
 *
pRë
 = 0;

155 
nC⁄sumed
 = 0;

157 
rc
 = 
pModuÀ
->
	`xO≥n
(
pTokíizî
, 
z
, 
n
, &
pCurs‹
);

158 if–
rc
==
SQLITE4_OK
 ){

159 c⁄° *
zTokí
;

160 
nTokí
, 
iSèπ
, 
iEnd
, 
iPosôi⁄
;

161 
nByã
;

163 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

164 
rc
 = 
pModuÀ
->
	`xNext
(
pCurs‹
, &
zTokí
, &
nTokí
, &
iSèπ
, &
iEnd
, &
iPosôi⁄
);

166 if–
rc
==
SQLITE4_OK
 ){

167 
nByã
 = (
Fts3Ex¥
Ë+ (
Fts3Phø£
Ë+ 
nTokí
;

168 
pRë
 = (
Fts3Ex¥
 *)
	`·s3MÆlocZîo
(
nByã
);

169 if–!
pRë
 ){

170 
rc
 = 
SQLITE4_NOMEM
;

172 
pRë
->
eTy≥
 = 
FTSQUERY_PHRASE
;

173 
pRë
->
pPhø£
 = (
Fts3Phø£
 *)&pRet[1];

174 
pRë
->
pPhø£
->
nTokí
 = 1;

175 
pRë
->
pPhø£
->
iCﬁumn
 = 
iCﬁ
;

176 
pRë
->
pPhø£
->
aTokí
[0].
n
 = 
nTokí
;

177 
pRë
->
pPhø£
->
aTokí
[0].
z
 = (*)&pRet->pPhrase[1];

178 
	`mem˝y
(
pRë
->
pPhø£
->
aTokí
[0].
z
, 
zTokí
, 
nTokí
);

180 if–
iEnd
<
n
 && 
z
[iEnd]=='*' ){

181 
pRë
->
pPhø£
->
aTokí
[0].
isPªfix
 = 1;

182 
iEnd
++;

186 if–!
sqlôe4_·s3_íabÀ_∑ª¡he£s


187 && 
iSèπ
>0 && 
z
[iStart-1]=='-'

189 
pP¨£
->
isNŸ
 = 1;

190 
iSèπ
--;

191 }if–
pP¨£
->
bFts4
 && 
iSèπ
>0 && 
z
[iStart-1]=='^' ){

192 
pRë
->
pPhø£
->
aTokí
[0].
bFú°
 = 1;

193 
iSèπ
--;

200 
nC⁄sumed
 = 
iEnd
;

203 
pModuÀ
->
	`xClo£
(
pCurs‹
);

206 *
≤C⁄sumed
 = 
nC⁄sumed
;

207 *
µEx¥
 = 
pRë
;

208  
rc
;

209 
	}
}

216 *
	$·s3RóŒocOrFªe
(*
pOrig
, 
nNew
){

217 *
pRë
 = 
	`sqlôe4_ªÆloc
(
pOrig
, 
nNew
);

218 if–!
pRë
 ){

219 
	`sqlôe4_‰ì
(
pOrig
);

221  
pRë
;

222 
	}
}

236 
	$gëNextSåög
(

237 
P¨£C⁄ãxt
 *
pP¨£
,

238 c⁄° *
zI≈ut
, 
nI≈ut
,

239 
Fts3Ex¥
 **
µEx¥


241 
sqlôe4_tokíizî
 *
pTokíizî
 = 
pP¨£
->pTokenizer;

242 
sqlôe4_tokíizî_moduÀ
 c⁄° *
pModuÀ
 = 
pTokíizî
->pModule;

243 
rc
;

244 
Fts3Ex¥
 *
p
 = 0;

245 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
 = 0;

246 *
zTemp
 = 0;

247 
nTemp
 = 0;

249 c⁄° 
nS∑˚
 = (
Fts3Ex¥
Ë+ (
Fts3Phø£
);

250 
nTokí
 = 0;

271 
rc
 = 
pModuÀ
->
	`xO≥n
(
pTokíizî
, 
zI≈ut
, 
nI≈ut
, &
pCurs‹
);

272 if–
rc
==
SQLITE4_OK
 ){

273 
ii
;

274 
pCurs‹
->
pTokíizî
 =ÖTokenizer;

275 
ii
=0; 
rc
==
SQLITE4_OK
; ii++){

276 c⁄° *
zByã
;

277 
nByã
, 
iBegö
, 
iEnd
, 
iPos
;

278 
rc
 = 
pModuÀ
->
	`xNext
(
pCurs‹
, &
zByã
, &
nByã
, &
iBegö
, &
iEnd
, &
iPos
);

279 if–
rc
==
SQLITE4_OK
 ){

280 
Fts3Phø£Tokí
 *
pTokí
;

282 
p
 = 
	`·s3RóŒocOrFªe
’, 
nS∑˚
 + 
ii
*(
Fts3Phø£Tokí
));

283 if–!
p
 ) 
no_mem
;

285 
zTemp
 = 
	`·s3RóŒocOrFªe
(zTemp, 
nTemp
 + 
nByã
);

286 if–!
zTemp
 ) 
no_mem
;

288 
	`as£π
–
nTokí
==
ii
 );

289 
pTokí
 = &((
Fts3Phø£
 *)(&
p
[1]))->
aTokí
[
ii
];

290 
	`mem£t
(
pTokí
, 0, (
Fts3Phø£Tokí
));

292 
	`mem˝y
(&
zTemp
[
nTemp
], 
zByã
, 
nByã
);

293 
nTemp
 +
nByã
;

295 
pTokí
->
n
 = 
nByã
;

296 
pTokí
->
isPªfix
 = (
iEnd
<
nI≈ut
 && 
zI≈ut
[iEnd]=='*');

297 
pTokí
->
bFú°
 = (
iBegö
>0 && 
zI≈ut
[iBegin-1]=='^');

298 
nTokí
 = 
ii
+1;

302 
pModuÀ
->
	`xClo£
(
pCurs‹
);

303 
pCurs‹
 = 0;

306 if–
rc
==
SQLITE4_DONE
 ){

307 
jj
;

308 *
zBuf
 = 0;

310 
p
 = 
	`·s3RóŒocOrFªe
’, 
nS∑˚
 + 
nTokí
*(
Fts3Phø£Tokí
Ë+ 
nTemp
);

311 if–!
p
 ) 
no_mem
;

312 
	`mem£t
(
p
, 0, (*)&(((
Fts3Phø£
 *)&p[1])->
aTokí
[0])-(*)p);

313 
p
->
eTy≥
 = 
FTSQUERY_PHRASE
;

314 
p
->
pPhø£
 = (
Fts3Phø£
 *)&p[1];

315 
p
->
pPhø£
->
iCﬁumn
 = 
pP¨£
->
iDeÁu…Cﬁ
;

316 
p
->
pPhø£
->
nTokí
 =ÇToken;

318 
zBuf
 = (*)&
p
->
pPhø£
->
aTokí
[
nTokí
];

319 if–
zTemp
 ){

320 
	`mem˝y
(
zBuf
, 
zTemp
, 
nTemp
);

321 
	`sqlôe4_‰ì
(
zTemp
);

323 
	`as£π
–
nTemp
==0 );

326 
jj
=0; jj<
p
->
pPhø£
->
nTokí
; jj++){

327 
p
->
pPhø£
->
aTokí
[
jj
].
z
 = 
zBuf
;

328 
zBuf
 +
p
->
pPhø£
->
aTokí
[
jj
].
n
;

330 
rc
 = 
SQLITE4_OK
;

333 *
µEx¥
 = 
p
;

334  
rc
;

335 
no_mem
:

337 if–
pCurs‹
 ){

338 
pModuÀ
->
	`xClo£
(
pCurs‹
);

340 
	`sqlôe4_‰ì
(
zTemp
);

341 
	`sqlôe4_‰ì
(
p
);

342 *
µEx¥
 = 0;

343  
SQLITE4_NOMEM
;

344 
	}
}

350 
·s3Ex¥P¨£
(
P¨£C⁄ãxt
 *, c⁄° *, , 
Fts3Ex¥
 **, *);

360 
	$gëNextNode
(

361 
P¨£C⁄ãxt
 *
pP¨£
,

362 c⁄° *
z
, 
n
,

363 
Fts3Ex¥
 **
µEx¥
,

364 *
≤C⁄sumed


366 c⁄° 
	sFts3Keyw‹d
 {

367 *
z
;

368 
n
;

369 
∑ªnO∆y
;

370 
eTy≥
;

371 } 
aKeyw‹d
[] = {

372 { "OR" , 2, 0, 
FTSQUERY_OR
 },

373 { "AND", 3, 1, 
FTSQUERY_AND
 },

374 { "NOT", 3, 1, 
FTSQUERY_NOT
 },

375 { "NEAR", 4, 0, 
FTSQUERY_NEAR
 }

377 
ii
;

378 
iCﬁ
;

379 
iCﬁLí
;

380 
rc
;

381 
Fts3Ex¥
 *
pRë
 = 0;

383 c⁄° *
zI≈ut
 = 
z
;

384 
nI≈ut
 = 
n
;

386 
pP¨£
->
isNŸ
 = 0;

391  
nI≈ut
>0 && 
	`·s3is•a˚
(*
zI≈ut
) ){

392 
nI≈ut
--;

393 
zI≈ut
++;

395 if–
nI≈ut
==0 ){

396  
SQLITE4_DONE
;

400 
ii
=0; ii<()((
aKeyw‹d
)/(
Fts3Keyw‹d
)); ii++){

401 c⁄° 
Fts3Keyw‹d
 *
pKey
 = &
aKeyw‹d
[
ii
];

403 if–(
pKey
->
∑ªnO∆y
 & ~
sqlôe4_·s3_íabÀ_∑ª¡he£s
)!=0 ){

407 if–
nI≈ut
>=
pKey
->
n
 && 0==
	`memcmp
(
zI≈ut
,ÖKey->
z
,ÖKey->n) ){

408 
nNór
 = 
SQLITE4_FTS3_DEFAULT_NEAR_PARAM
;

409 
nKey
 = 
pKey
->
n
;

410 
cNext
;

413 if–
pKey
->
eTy≥
==
FTSQUERY_NEAR
 ){

414 
	`as£π
–
nKey
==4 );

415 if–
zI≈ut
[4]=='/' && zInput[5]>='0' && zInput[5]<='9' ){

416 
nNór
 = 0;

417 
nKey
=5; 
zI≈ut
[nKey]>='0' && zInput[nKey]<='9';ÇKey++){

418 
nNór
 =ÇNó∏* 10 + (
zI≈ut
[
nKey
] - '0');

427 
cNext
 = 
zI≈ut
[
nKey
];

428 if–
	`·s3is•a˚
(
cNext
)

429 || 
cNext
=='"' || cNext=='(' || cNext==')' || cNext==0

431 
pRë
 = (
Fts3Ex¥
 *)
	`·s3MÆlocZîo
((Fts3Expr));

432 if–!
pRë
 ){

433  
SQLITE4_NOMEM
;

435 
pRë
->
eTy≥
 = 
pKey
->eType;

436 
pRë
->
nNór
 =ÇNear;

437 *
µEx¥
 = 
pRë
;

438 *
≤C⁄sumed
 = ()((
zI≈ut
 - 
z
Ë+ 
nKey
);

439  
SQLITE4_OK
;

449 if–
sqlôe4_·s3_íabÀ_∑ª¡he£s
 ){

450 if–*
zI≈ut
=='(' ){

451 
nC⁄sumed
;

452 
pP¨£
->
nNe°
++;

453 
rc
 = 
	`·s3Ex¥P¨£
(
pP¨£
, &
zI≈ut
[1], 
nI≈ut
-1, 
µEx¥
, &
nC⁄sumed
);

454 if–
rc
==
SQLITE4_OK
 && !*
µEx¥
 ){

455 
rc
 = 
SQLITE4_DONE
;

457 *
≤C⁄sumed
 = ()((
zI≈ut
 - 
z
Ë+ 1 + 
nC⁄sumed
);

458  
rc
;

462 if–*
zI≈ut
==')' ){

463 
pP¨£
->
nNe°
--;

464 *
≤C⁄sumed
 = ()((
zI≈ut
 - 
z
) + 1);

465  
SQLITE4_DONE
;

474 if–*
zI≈ut
=='"' ){

475 
ii
=1; ii<
nI≈ut
 && 
zI≈ut
[ii]!='"'; ii++);

476 *
≤C⁄sumed
 = ()((
zI≈ut
 - 
z
Ë+ 
ii
 + 1);

477 if–
ii
==
nI≈ut
 ){

478  
SQLITE4_ERROR
;

480  
	`gëNextSåög
(
pP¨£
, &
zI≈ut
[1], 
ii
-1, 
µEx¥
);

495 
iCﬁ
 = 
pP¨£
->
iDeÁu…Cﬁ
;

496 
iCﬁLí
 = 0;

497 
ii
=0; ii<
pP¨£
->
nCﬁ
; ii++){

498 c⁄° *
zSå
 = 
pP¨£
->
azCﬁ
[
ii
];

499 
nSå
 = ()
	`°æí
(
zSå
);

500 if–
nI≈ut
>
nSå
 && 
zI≈ut
[nStr]==':'

501 && 
	`sqlôe4_°∫icmp
(
zSå
, 
zI≈ut
, 
nSå
)==0

503 
iCﬁ
 = 
ii
;

504 
iCﬁLí
 = ()((
zI≈ut
 - 
z
Ë+ 
nSå
 + 1);

508 
rc
 = 
	`gëNextTokí
(
pP¨£
, 
iCﬁ
, &
z
[
iCﬁLí
], 
n
-iCﬁLí, 
µEx¥
, 
≤C⁄sumed
);

509 *
≤C⁄sumed
 +
iCﬁLí
;

510  
rc
;

511 
	}
}

532 
	$›Pª˚dí˚
(
Fts3Ex¥
 *
p
){

533 
	`as£π
–
p
->
eTy≥
!=
FTSQUERY_PHRASE
 );

534 if–
sqlôe4_·s3_íabÀ_∑ª¡he£s
 ){

535  
p
->
eTy≥
;

536 }if–
p
->
eTy≥
==
FTSQUERY_NEAR
 ){

538 }if–
p
->
eTy≥
==
FTSQUERY_OR
 ){

541 
	`as£π
–
p
->
eTy≥
==
FTSQUERY_AND
 );

543 
	}
}

553 
	$ö£πBö¨yO≥øt‹
(

554 
Fts3Ex¥
 **
µHód
,

555 
Fts3Ex¥
 *
pPªv
,

556 
Fts3Ex¥
 *
pNew


558 
Fts3Ex¥
 *
pS∂ô
 = 
pPªv
;

559  
pS∂ô
->
pP¨ít
 && 
	`›Pª˚dí˚
’S∂ô->pP¨ít)<=›Pª˚dí˚(
pNew
) ){

560 
pS∂ô
 =ÖS∂ô->
pP¨ít
;

563 if–
pS∂ô
->
pP¨ít
 ){

564 
	`as£π
–
pS∂ô
->
pP¨ít
->
pRight
==pSplit );

565 
pS∂ô
->
pP¨ít
->
pRight
 = 
pNew
;

566 
pNew
->
pP¨ít
 = 
pS∂ô
->pParent;

568 *
µHód
 = 
pNew
;

570 
pNew
->
pLe·
 = 
pS∂ô
;

571 
pS∂ô
->
pP¨ít
 = 
pNew
;

572 
	}
}

584 
	$·s3Ex¥P¨£
(

585 
P¨£C⁄ãxt
 *
pP¨£
,

586 c⁄° *
z
, 
n
,

587 
Fts3Ex¥
 **
µEx¥
,

588 *
≤C⁄sumed


590 
Fts3Ex¥
 *
pRë
 = 0;

591 
Fts3Ex¥
 *
pPªv
 = 0;

592 
Fts3Ex¥
 *
pNŸBønch
 = 0;

593 
nIn
 = 
n
;

594 c⁄° *
zIn
 = 
z
;

595 
rc
 = 
SQLITE4_OK
;

596 
isRequúePhø£
 = 1;

598  
rc
==
SQLITE4_OK
 ){

599 
Fts3Ex¥
 *
p
 = 0;

600 
nByã
 = 0;

601 
rc
 = 
	`gëNextNode
(
pP¨£
, 
zIn
, 
nIn
, &
p
, &
nByã
);

602 if–
rc
==
SQLITE4_OK
 ){

603 
isPhø£
;

605 if–!
sqlôe4_·s3_íabÀ_∑ª¡he£s


606 && 
p
->
eTy≥
==
FTSQUERY_PHRASE
 && 
pP¨£
->
isNŸ


609 
Fts3Ex¥
 *
pNŸ
 = 
	`·s3MÆlocZîo
((Fts3Expr));

610 if–!
pNŸ
 ){

611 
	`sqlôe4Fts3Ex¥Fªe
(
p
);

612 
rc
 = 
SQLITE4_NOMEM
;

613 
ex¥∑r£_out
;

615 
pNŸ
->
eTy≥
 = 
FTSQUERY_NOT
;

616 
pNŸ
->
pRight
 = 
p
;

617 if–
pNŸBønch
 ){

618 
pNŸ
->
pLe·
 = 
pNŸBønch
;

620 
pNŸBønch
 = 
pNŸ
;

621 
p
 = 
pPªv
;

623 
eTy≥
 = 
p
->eType;

624 
isPhø£
 = (
eTy≥
==
FTSQUERY_PHRASE
 || 
p
->
pLe·
);

631 if–!
isPhø£
 && 
isRequúePhø£
 ){

632 
	`sqlôe4Fts3Ex¥Fªe
(
p
);

633 
rc
 = 
SQLITE4_ERROR
;

634 
ex¥∑r£_out
;

637 if–
isPhø£
 && !
isRequúePhø£
 ){

639 
Fts3Ex¥
 *
pAnd
;

640 
	`as£π
–
pRë
 && 
pPªv
 );

641 
pAnd
 = 
	`·s3MÆlocZîo
((
Fts3Ex¥
));

642 if–!
pAnd
 ){

643 
	`sqlôe4Fts3Ex¥Fªe
(
p
);

644 
rc
 = 
SQLITE4_NOMEM
;

645 
ex¥∑r£_out
;

647 
pAnd
->
eTy≥
 = 
FTSQUERY_AND
;

648 
	`ö£πBö¨yO≥øt‹
(&
pRë
, 
pPªv
, 
pAnd
);

649 
pPªv
 = 
pAnd
;

661 if–
pPªv
 && (

662 (
eTy≥
==
FTSQUERY_NEAR
 && !
isPhø£
 && 
pPªv
->eTy≥!=
FTSQUERY_PHRASE
)

663 || (
eTy≥
!=
FTSQUERY_PHRASE
 && 
isPhø£
 && 
pPªv
->eTy≥==
FTSQUERY_NEAR
)

665 
	`sqlôe4Fts3Ex¥Fªe
(
p
);

666 
rc
 = 
SQLITE4_ERROR
;

667 
ex¥∑r£_out
;

670 if–
isPhø£
 ){

671 if–
pRë
 ){

672 
	`as£π
–
pPªv
 &&ÖPªv->
pLe·
 &&ÖPªv->
pRight
==0 );

673 
pPªv
->
pRight
 = 
p
;

674 
p
->
pP¨ít
 = 
pPªv
;

676 
pRë
 = 
p
;

679 
	`ö£πBö¨yO≥øt‹
(&
pRë
, 
pPªv
, 
p
);

681 
isRequúePhø£
 = !
isPhø£
;

683 
	`as£π
–
nByã
>0 );

685 
	`as£π
–
rc
!=
SQLITE4_OK
 || (
nByã
>0 &&ÇByã<=
nIn
) );

686 
nIn
 -
nByã
;

687 
zIn
 +
nByã
;

688 
pPªv
 = 
p
;

691 if–
rc
==
SQLITE4_DONE
 && 
pRë
 && 
isRequúePhø£
 ){

692 
rc
 = 
SQLITE4_ERROR
;

695 if–
rc
==
SQLITE4_DONE
 ){

696 
rc
 = 
SQLITE4_OK
;

697 if–!
sqlôe4_·s3_íabÀ_∑ª¡he£s
 && 
pNŸBønch
 ){

698 if–!
pRë
 ){

699 
rc
 = 
SQLITE4_ERROR
;

701 
Fts3Ex¥
 *
pIãr
 = 
pNŸBønch
;

702  
pIãr
->
pLe·
 ){

703 
pIãr
 =ÖIãr->
pLe·
;

705 
pIãr
->
pLe·
 = 
pRë
;

706 
pRë
 = 
pNŸBønch
;

710 *
≤C⁄sumed
 = 
n
 - 
nIn
;

712 
ex¥∑r£_out
:

713 if–
rc
!=
SQLITE4_OK
 ){

714 
	`sqlôe4Fts3Ex¥Fªe
(
pRë
);

715 
	`sqlôe4Fts3Ex¥Fªe
(
pNŸBønch
);

716 
pRë
 = 0;

718 *
µEx¥
 = 
pRë
;

719  
rc
;

720 
	}
}

746 
	$sqlôe4Fts3Ex¥P¨£
(

747 
sqlôe4_tokíizî
 *
pTokíizî
,

748 **
azCﬁ
,

749 
bFts4
,

750 
nCﬁ
,

751 
iDeÁu…Cﬁ
,

752 c⁄° *
z
, 
n
,

753 
Fts3Ex¥
 **
µEx¥


755 
nP¨£d
;

756 
rc
;

757 
P¨£C⁄ãxt
 
sP¨£
;

758 
sP¨£
.
pTokíizî
 =ÖTokenizer;

759 
sP¨£
.
azCﬁ
 = (const **)azCol;

760 
sP¨£
.
nCﬁ
 =ÇCol;

761 
sP¨£
.
iDeÁu…Cﬁ
 = iDefaultCol;

762 
sP¨£
.
nNe°
 = 0;

763 
sP¨£
.
bFts4
 = bFts4;

764 if–
z
==0 ){

765 *
µEx¥
 = 0;

766  
SQLITE4_OK
;

768 if–
n
<0 ){

769 
n
 = ()
	`°æí
(
z
);

771 
rc
 = 
	`·s3Ex¥P¨£
(&
sP¨£
, 
z
, 
n
, 
µEx¥
, &
nP¨£d
);

774 if–
rc
==
SQLITE4_OK
 && 
sP¨£
.
nNe°
 ){

775 
rc
 = 
SQLITE4_ERROR
;

776 
	`sqlôe4Fts3Ex¥Fªe
(*
µEx¥
);

777 *
µEx¥
 = 0;

780  
rc
;

781 
	}
}

786 
	$sqlôe4Fts3Ex¥Fªe
(
Fts3Ex¥
 *
p
){

787 if–
p
 ){

788 
	`as£π
–
p
->
eTy≥
==
FTSQUERY_PHRASE
 ||Ö->
pPhø£
==0 );

789 
	`sqlôe4Fts3Ex¥Fªe
(
p
->
pLe·
);

790 
	`sqlôe4Fts3Ex¥Fªe
(
p
->
pRight
);

791 
	`sqlôe4Fts3EvÆPhø£CÀ™up
(
p
->
pPhø£
);

792 
	`sqlôe4_‰ì
(
p
->
aMI
);

793 
	`sqlôe4_‰ì
(
p
);

795 
	}
}

802 #ifde‡
SQLITE4_TEST


804 
	~<°dio.h
>

809 
	$quîyTe°Tokíizî
(

810 
sqlôe4
 *
db
,

811 c⁄° *
zName
,

812 c⁄° 
sqlôe4_tokíizî_moduÀ
 **
µ


814 
rc
;

815 
sqlôe4_°mt
 *
pStmt
;

816 c⁄° 
zSql
[] = "SELECT fts3_tokenizer(?)";

818 *
µ
 = 0;

819 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, 0);

820 if–
rc
!=
SQLITE4_OK
 ){

821  
rc
;

824 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zName
, -1, 
SQLITE4_STATIC
);

825 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

826 if–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0)==
SQLITE4_BLOB
 ){

827 
	`mem˝y
((*)
µ
, 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0), (*pp));

831  
	`sqlôe4_föÆize
(
pStmt
);

832 
	}
}

844 *
	$ex¥ToSåög
(
Fts3Ex¥
 *
pEx¥
, *
zBuf
){

845  
pEx¥
->
eTy≥
 ){

846 
FTSQUERY_PHRASE
: {

847 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

848 
i
;

849 
zBuf
 = 
	`sqlôe4_m¥ötf
(

850 "%zPHRASE %d 0", 
zBuf
, 
pPhø£
->
iCﬁumn
);

851 
i
=0; 
zBuf
 && i<
pPhø£
->
nTokí
; i++){

852 
zBuf
 = 
	`sqlôe4_m¥ötf
("%z %.*s%s", zBuf,

853 
pPhø£
->
aTokí
[
i
].
n
,ÖPhø£->aTokí[i].
z
,

854 (
pPhø£
->
aTokí
[
i
].
isPªfix
?"+":"")

857  
zBuf
;

860 
FTSQUERY_NEAR
:

861 
zBuf
 = 
	`sqlôe4_m¥ötf
("%zNEAR/%d ", zBuf, 
pEx¥
->
nNór
);

863 
FTSQUERY_NOT
:

864 
zBuf
 = 
	`sqlôe4_m¥ötf
("%zNOT ", zBuf);

866 
FTSQUERY_AND
:

867 
zBuf
 = 
	`sqlôe4_m¥ötf
("%zAND ", zBuf);

869 
FTSQUERY_OR
:

870 
zBuf
 = 
	`sqlôe4_m¥ötf
("%zOR ", zBuf);

874 if–
zBuf
 ) zBu‡
	`sqlôe4_m¥ötf
("%z{", zBuf);

875 if–
zBuf
 ) zBu‡
	`ex¥ToSåög
(
pEx¥
->
pLe·
, zBuf);

876 if–
zBuf
 ) zBu‡
	`sqlôe4_m¥ötf
("%z} {", zBuf);

878 if–
zBuf
 ) zBu‡
	`ex¥ToSåög
(
pEx¥
->
pRight
, zBuf);

879 if–
zBuf
 ) zBu‡
	`sqlôe4_m¥ötf
("%z}", zBuf);

881  
zBuf
;

882 
	}
}

898 
	$·s3Ex¥Te°
(

899 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

900 
¨gc
,

901 
sqlôe4_vÆue
 **
¨gv


903 
sqlôe4_tokíizî_moduÀ
 c⁄° *
pModuÀ
 = 0;

904 
sqlôe4_tokíizî
 *
pTokíizî
 = 0;

905 
rc
;

906 **
azCﬁ
 = 0;

907 c⁄° *
zEx¥
;

908 
nEx¥
;

909 
nCﬁ
;

910 
ii
;

911 
Fts3Ex¥
 *
pEx¥
;

912 *
zBuf
 = 0;

913 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

915 if–
¨gc
<3 ){

916 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
,

922 
rc
 = 
	`quîyTe°Tokíizî
(
db
,

923 (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]), &
pModuÀ
);

924 if–
rc
==
SQLITE4_NOMEM
 ){

925 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

926 
ex¥ã°_out
;

927 }if–!
pModuÀ
 ){

928 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "No suchÅokenizer module", -1);

929 
ex¥ã°_out
;

932 
rc
 = 
pModuÀ
->
	`xCª©e
(0, 0, &
pTokíizî
);

933 
	`as£π
–
rc
==
SQLITE4_NOMEM
 ||Ñc==
SQLITE4_OK
 );

934 if–
rc
==
SQLITE4_NOMEM
 ){

935 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

936 
ex¥ã°_out
;

938 
pTokíizî
->
pModuÀ
 =ÖModule;

940 
zEx¥
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

941 
nEx¥
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[1]);

942 
nCﬁ
 = 
¨gc
-2;

943 
azCﬁ
 = (**)
	`sqlôe4_mÆloc
(
nCﬁ
*(*));

944 if–!
azCﬁ
 ){

945 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

946 
ex¥ã°_out
;

948 
ii
=0; ii<
nCﬁ
; ii++){

949 
azCﬁ
[
ii
] = (*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[ii+2]);

952 
rc
 = 
	`sqlôe4Fts3Ex¥P¨£
(

953 
pTokíizî
, 
azCﬁ
, 0, 
nCﬁ
,ÇCﬁ, 
zEx¥
, 
nEx¥
, &
pEx¥


955 if–
rc
!=
SQLITE4_OK
 &&Ñc!=
SQLITE4_NOMEM
 ){

956 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "ErrorÖarsingÉxpression", -1);

957 }if–
rc
==
SQLITE4_NOMEM
 || !(
zBuf
 = 
	`ex¥ToSåög
(
pEx¥
, 0)) ){

958 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

960 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
);

961 
	`sqlôe4_‰ì
(
zBuf
);

964 
	`sqlôe4Fts3Ex¥Fªe
(
pEx¥
);

966 
ex¥ã°_out
:

967 if–
pModuÀ
 && 
pTokíizî
 ){

968 
rc
 = 
pModuÀ
->
	`xDe°roy
(
pTokíizî
);

970 
	`sqlôe4_‰ì
(
azCﬁ
);

971 
	}
}

977 
	$sqlôe4Fts3Ex¥InôTe°I¡îÁ˚
(
sqlôe4
* 
db
){

978  
	`sqlôe4_¸óã_fun˘i⁄
(

979 
db
, "·s3_ex¥ã°", -1, 
SQLITE4_UTF8
, 0, 
·s3Ex¥Te°
, 0, 0

981 
	}
}

	@ext/fts3/fts3_hash.c

26 
	~"·s3I¡.h
"

27 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

29 
	~<as£π.h
>

30 
	~<°dlib.h
>

31 
	~<°rög.h
>

33 
	~"·s3_hash.h
"

38 *
	$·s3HashMÆloc
(
n
){

39 *
p
 = 
	`sqlôe4_mÆloc
(
n
);

40 if–
p
 ){

41 
	`mem£t
(
p
, 0, 
n
);

43  
p
;

44 
	}
}

45 
	$·s3HashFªe
(*
p
){

46 
	`sqlôe4_‰ì
(
p
);

47 
	}
}

59 
	$sqlôe4Fts3HashInô
(
Fts3Hash
 *
pNew
, 
keyCœss
, 
c›yKey
){

60 
	`as£π
–
pNew
!=0 );

61 
	`as£π
–
keyCœss
>=
FTS3_HASH_STRING
 && keyCœss<=
FTS3_HASH_BINARY
 );

62 
pNew
->
keyCœss
 = keyClass;

63 
pNew
->
c›yKey
 = copyKey;

64 
pNew
->
fú°
 = 0;

65 
pNew
->
cou¡
 = 0;

66 
pNew
->
htsize
 = 0;

67 
pNew
->
ht
 = 0;

68 
	}
}

74 
	$sqlôe4Fts3HashCÀ¨
(
Fts3Hash
 *
pH
){

75 
Fts3HashEÀm
 *
ñem
;

77 
	`as£π
–
pH
!=0 );

78 
ñem
 = 
pH
->
fú°
;

79 
pH
->
fú°
 = 0;

80 
	`·s3HashFªe
(
pH
->
ht
);

81 
pH
->
ht
 = 0;

82 
pH
->
htsize
 = 0;

83  
ñem
 ){

84 
Fts3HashEÀm
 *
√xt_ñem
 = 
ñem
->
√xt
;

85 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

86 
	`·s3HashFªe
(
ñem
->
pKey
);

88 
	`·s3HashFªe
(
ñem
);

89 
ñem
 = 
√xt_ñem
;

91 
pH
->
cou¡
 = 0;

92 
	}
}

97 
	$·s3SåHash
(c⁄° *
pKey
, 
nKey
){

98 c⁄° *
z
 = (c⁄° *)
pKey
;

99 
h
 = 0;

100 if–
nKey
<=0 )ÇKey = (Ë
	`°æí
(
z
);

101  
nKey
 > 0 ){

102 
h
 = (h<<3Ë^ h ^ *
z
++;

103 
nKey
--;

105  
h
 & 0x7fffffff;

106 
	}
}

107 
	$·s3SåCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

108 if–
n1
!=
n2
 )  1;

109  
	`°∫cmp
((c⁄° *)
pKey1
,(c⁄° *)
pKey2
,
n1
);

110 
	}
}

115 
	$·s3BöHash
(c⁄° *
pKey
, 
nKey
){

116 
h
 = 0;

117 c⁄° *
z
 = (c⁄° *)
pKey
;

118  
nKey
-- > 0 ){

119 
h
 = (h<<3Ë^ h ^ *(
z
++);

121  
h
 & 0x7fffffff;

122 
	}
}

123 
	$·s3BöCom∑ª
(c⁄° *
pKey1
, 
n1
, c⁄° *
pKey2
, 
n2
){

124 if–
n1
!=
n2
 )  1;

125  
	`memcmp
(
pKey1
,
pKey2
,
n1
);

126 
	}
}

140 (*
	$·sHashFun˘i⁄
(
keyCœss
))(const *,){

141 if–
keyCœss
==
FTS3_HASH_STRING
 ){

142  &
·s3SåHash
;

144 
	`as£π
–
keyCœss
==
FTS3_HASH_BINARY
 );

145  &
·s3BöHash
;

147 
	}
}

155 (*
	$·sCom∑ªFun˘i⁄
(
keyCœss
))(const *,,const *,){

156 if–
keyCœss
==
FTS3_HASH_STRING
 ){

157  &
·s3SåCom∑ª
;

159 
	`as£π
–
keyCœss
==
FTS3_HASH_BINARY
 );

160  &
·s3BöCom∑ª
;

162 
	}
}

166 
	$·s3HashIn£πEÀmít
(

167 
Fts3Hash
 *
pH
,

168 
_·s3ht
 *
pE¡ry
,

169 
Fts3HashEÀm
 *
pNew


171 
Fts3HashEÀm
 *
pHód
;

172 
pHód
 = 
pE¡ry
->
chaö
;

173 if–
pHód
 ){

174 
pNew
->
√xt
 = 
pHód
;

175 
pNew
->
¥ev
 = 
pHód
->prev;

176 if–
pHód
->
¥ev
 ){ÖHód->¥ev->
√xt
 = 
pNew
; }

177 { 
pH
->
fú°
 = 
pNew
; }

178 
pHód
->
¥ev
 = 
pNew
;

180 
pNew
->
√xt
 = 
pH
->
fú°
;

181 if–
pH
->
fú°
 ){ÖH->fú°->
¥ev
 = 
pNew
; }

182 
pNew
->
¥ev
 = 0;

183 
pH
->
fú°
 = 
pNew
;

185 
pE¡ry
->
cou¡
++;

186 
pE¡ry
->
chaö
 = 
pNew
;

187 
	}
}

196 
	$·s3Rehash
(
Fts3Hash
 *
pH
, 
√w_size
){

197 
_·s3ht
 *
√w_ht
;

198 
Fts3HashEÀm
 *
ñem
, *
√xt_ñem
;

199 (*
xHash
)(const *,);

201 
	`as£π
–(
√w_size
 & (new_size-1))==0 );

202 
√w_ht
 = (
_·s3ht
 *)
	`·s3HashMÆloc
–
√w_size
*(_fts3ht) );

203 if–
√w_ht
==0 )  1;

204 
	`·s3HashFªe
(
pH
->
ht
);

205 
pH
->
ht
 = 
√w_ht
;

206 
pH
->
htsize
 = 
√w_size
;

207 
xHash
 = 
	`·sHashFun˘i⁄
(
pH
->
keyCœss
);

208 
ñem
=
pH
->
fú°
,ÖH->fú°=0;ÉÀm;ÉÀm = 
√xt_ñem
){

209 
h
 = (*
xHash
)(
ñem
->
pKey
,ÉÀm->
nKey
Ë& (
√w_size
-1);

210 
√xt_ñem
 = 
ñem
->
√xt
;

211 
	`·s3HashIn£πEÀmít
(
pH
, &
√w_ht
[
h
], 
ñem
);

214 
	}
}

220 
Fts3HashEÀm
 *
	$·s3FödEÀmítByHash
(

221 c⁄° 
Fts3Hash
 *
pH
,

222 c⁄° *
pKey
,

223 
nKey
,

224 
h


226 
Fts3HashEÀm
 *
ñem
;

227 
cou¡
;

228 (*
xCom∑ª
)(const *,,const *,);

230 if–
pH
->
ht
 ){

231 
_·s3ht
 *
pE¡ry
 = &
pH
->
ht
[
h
];

232 
ñem
 = 
pE¡ry
->
chaö
;

233 
cou¡
 = 
pE¡ry
->count;

234 
xCom∑ª
 = 
	`·sCom∑ªFun˘i⁄
(
pH
->
keyCœss
);

235  
cou¡
-- && 
ñem
 ){

236 if–(*
xCom∑ª
)(
ñem
->
pKey
,ñem->
nKey
,pKey,nKey)==0 ){

237  
ñem
;

239 
ñem
 =ÉÀm->
√xt
;

243 
	}
}

248 
	$·s3RemoveEÀmítByHash
(

249 
Fts3Hash
 *
pH
,

250 
Fts3HashEÀm
* 
ñem
,

251 
h


253 
_·s3ht
 *
pE¡ry
;

254 if–
ñem
->
¥ev
 ){

255 
ñem
->
¥ev
->
√xt
 =Élem->next;

257 
pH
->
fú°
 = 
ñem
->
√xt
;

259 if–
ñem
->
√xt
 ){

260 
ñem
->
√xt
->
¥ev
 =Élem->prev;

262 
pE¡ry
 = &
pH
->
ht
[
h
];

263 if–
pE¡ry
->
chaö
==
ñem
 ){

264 
pE¡ry
->
chaö
 = 
ñem
->
√xt
;

266 
pE¡ry
->
cou¡
--;

267 if–
pE¡ry
->
cou¡
<=0 ){

268 
pE¡ry
->
chaö
 = 0;

270 if–
pH
->
c›yKey
 && 
ñem
->
pKey
 ){

271 
	`·s3HashFªe
(
ñem
->
pKey
);

273 
	`·s3HashFªe
–
ñem
 );

274 
pH
->
cou¡
--;

275 if–
pH
->
cou¡
<=0 ){

276 
	`as£π
–
pH
->
fú°
==0 );

277 
	`as£π
–
pH
->
cou¡
==0 );

278 
	`·s3HashCÀ¨
(
pH
);

280 
	}
}

282 
Fts3HashEÀm
 *
	$sqlôe4Fts3HashFödEÀm
(

283 c⁄° 
Fts3Hash
 *
pH
,

284 c⁄° *
pKey
,

285 
nKey


287 
h
;

288 (*
xHash
)(const *,);

290 if–
pH
==0 ||ÖH->
ht
==0 )  0;

291 
xHash
 = 
	`·sHashFun˘i⁄
(
pH
->
keyCœss
);

292 
	`as£π
–
xHash
!=0 );

293 
h
 = (*
xHash
)(
pKey
,
nKey
);

294 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

295  
	`·s3FödEÀmítByHash
(
pH
,
pKey
,
nKey
, 
h
 & (pH->
htsize
-1));

296 
	}
}

303 *
	$sqlôe4Fts3HashFöd
(c⁄° 
Fts3Hash
 *
pH
, c⁄° *
pKey
, 
nKey
){

304 
Fts3HashEÀm
 *
pEÀm
;

306 
pEÀm
 = 
	`sqlôe4Fts3HashFödEÀm
(
pH
, 
pKey
, 
nKey
);

307  
pEÀm
 ?ÖEÀm->
d©a
 : 0;

308 
	}
}

325 *
	$sqlôe4Fts3HashIn£π
(

326 
Fts3Hash
 *
pH
,

327 c⁄° *
pKey
,

328 
nKey
,

329 *
d©a


331 
høw
;

332 
h
;

333 
Fts3HashEÀm
 *
ñem
;

334 
Fts3HashEÀm
 *
√w_ñem
;

335 (*
xHash
)(const *,);

337 
	`as£π
–
pH
!=0 );

338 
xHash
 = 
	`·sHashFun˘i⁄
(
pH
->
keyCœss
);

339 
	`as£π
–
xHash
!=0 );

340 
høw
 = (*
xHash
)(
pKey
, 
nKey
);

341 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

342 
h
 = 
høw
 & (
pH
->
htsize
-1);

343 
ñem
 = 
	`·s3FödEÀmítByHash
(
pH
,
pKey
,
nKey
,
h
);

344 if–
ñem
 ){

345 *
ﬁd_d©a
 = 
ñem
->
d©a
;

346 if–
d©a
==0 ){

347 
	`·s3RemoveEÀmítByHash
(
pH
,
ñem
,
h
);

349 
ñem
->
d©a
 = data;

351  
ﬁd_d©a
;

353 if–
d©a
==0 )  0;

354 if–(
pH
->
htsize
==0 && 
	`·s3Rehash
(pH,8))

355 || (
pH
->
cou¡
>ıH->
htsize
 && 
	`·s3Rehash
(pH,ÖH->htsize*2))

357 
pH
->
cou¡
 = 0;

358  
d©a
;

360 
	`as£π
–
pH
->
htsize
>0 );

361 
√w_ñem
 = (
Fts3HashEÀm
*)
	`·s3HashMÆloc
( (Fts3HashElem) );

362 if–
√w_ñem
==0 )  
d©a
;

363 if–
pH
->
c›yKey
 && 
pKey
!=0 ){

364 
√w_ñem
->
pKey
 = 
	`·s3HashMÆloc
–
nKey
 );

365 if–
√w_ñem
->
pKey
==0 ){

366 
	`·s3HashFªe
(
√w_ñem
);

367  
d©a
;

369 
	`mem˝y
((*)
√w_ñem
->
pKey
,ÖKey, 
nKey
);

371 
√w_ñem
->
pKey
 = (*)pKey;

373 
√w_ñem
->
nKey
 =ÇKey;

374 
pH
->
cou¡
++;

375 
	`as£π
–
pH
->
htsize
>0 );

376 
	`as£π
–(
pH
->
htsize
 & (pH->htsize-1))==0 );

377 
h
 = 
høw
 & (
pH
->
htsize
-1);

378 
	`·s3HashIn£πEÀmít
(
pH
, &pH->
ht
[
h
], 
√w_ñem
);

379 
√w_ñem
->
d©a
 = data;

381 
	}
}

	@ext/fts3/fts3_hash.h

17 #i‚de‡
_FTS3_HASH_H_


18 
	#_FTS3_HASH_H_


	)

21 
Fts3Hash
 
	tFts3Hash
;

22 
Fts3HashEÀm
 
	tFts3HashEÀm
;

32 
	sFts3Hash
 {

33 
	mkeyCœss
;

34 
	mc›yKey
;

35 
	mcou¡
;

36 
Fts3HashEÀm
 *
	mfú°
;

37 
	mhtsize
;

38 
	s_·s3ht
 {

39 
	mcou¡
;

40 
Fts3HashEÀm
 *
	mchaö
;

41 } *
	mht
;

50 
	sFts3HashEÀm
 {

51 
Fts3HashEÀm
 *
	m√xt
, *
	m¥ev
;

52 *
	md©a
;

53 *
	mpKey
; 
	mnKey
;

68 
	#FTS3_HASH_STRING
 1

	)

69 
	#FTS3_HASH_BINARY
 2

	)

74 
sqlôe4Fts3HashInô
(
Fts3Hash
 *
pNew
, 
keyCœss
, 
c›yKey
);

75 *
sqlôe4Fts3HashIn£π
(
Fts3Hash
*, c⁄° *
pKey
, 
nKey
, *
pD©a
);

76 *
sqlôe4Fts3HashFöd
(c⁄° 
Fts3Hash
*, c⁄° *
pKey
, 
nKey
);

77 
sqlôe4Fts3HashCÀ¨
(
Fts3Hash
*);

78 
Fts3HashEÀm
 *
sqlôe4Fts3HashFödEÀm
(c⁄° 
Fts3Hash
 *, const *, );

83 
	#·s3HashInô
 
sqlôe4Fts3HashInô


	)

84 
	#·s3HashIn£π
 
sqlôe4Fts3HashIn£π


	)

85 
	#·s3HashFöd
 
sqlôe4Fts3HashFöd


	)

86 
	#·s3HashCÀ¨
 
sqlôe4Fts3HashCÀ¨


	)

87 
	#·s3HashFödEÀm
 
sqlôe4Fts3HashFödEÀm


	)

101 
	#·s3HashFú°
(
H
Ë((H)->
fú°
)

	)

102 
	#·s3HashNext
(
E
Ë((E)->
√xt
)

	)

103 
	#·s3HashD©a
(
E
Ë((E)->
d©a
)

	)

104 
	#·s3HashKey
(
E
Ë((E)->
pKey
)

	)

105 
	#·s3HashKeysize
(
E
Ë((E)->
nKey
)

	)

110 
	#·s3HashCou¡
(
H
Ë((H)->
cou¡
)

	)

	@ext/fts3/fts3_icu.c

14 
	~"·s3I¡.h
"

15 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

16 #ifde‡
SQLITE4_ENABLE_ICU


18 
	~<as£π.h
>

19 
	~<°rög.h
>

20 
	~"·s3_tokíizî.h
"

22 
	~<unicode/ubrk.h
>

23 
	~<unicode/ucﬁ.h
>

24 
	~<unicode/u°rög.h
>

25 
	~<unicode/utf16.h
>

27 
IcuTokíizî
 
	tIcuTokíizî
;

28 
IcuCurs‹
 
	tIcuCurs‹
;

30 
	sIcuTokíizî
 {

31 
sqlôe4_tokíizî
 
	mba£
;

32 *
	mzLoˇÀ
;

35 
	sIcuCurs‹
 {

36 
sqlôe4_tokíizî_curs‹
 
	mba£
;

38 
UBªakIãøt‹
 *
	mpIãr
;

39 
	mnCh¨
;

40 
UCh¨
 *
	maCh¨
;

41 *
	maOff£t
;

43 
	mnBuf„r
;

44 *
	mzBuf„r
;

46 
	miTokí
;

52 
	$icuCª©e
(

53 
¨gc
,

54 c⁄° * c⁄° *
¨gv
,

55 
sqlôe4_tokíizî
 **
µTokíizî


57 
IcuTokíizî
 *
p
;

58 
n
 = 0;

60 if–
¨gc
>0 ){

61 
n
 = 
	`°æí
(
¨gv
[0])+1;

63 
p
 = (
IcuTokíizî
 *)
	`sqlôe4_mÆloc
((IcuTokíizî)+
n
);

64 if–!
p
 ){

65  
SQLITE4_NOMEM
;

67 
	`mem£t
(
p
, 0, (
IcuTokíizî
));

69 if–
n
 ){

70 
p
->
zLoˇÀ
 = (*)&p[1];

71 
	`mem˝y
(
p
->
zLoˇÀ
, 
¨gv
[0], 
n
);

74 *
µTokíizî
 = (
sqlôe4_tokíizî
 *)
p
;

76  
SQLITE4_OK
;

77 
	}
}

82 
	$icuDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

83 
IcuTokíizî
 *
p
 = (IcuTokíizî *)
pTokíizî
;

84 
	`sqlôe4_‰ì
(
p
);

85  
SQLITE4_OK
;

86 
	}
}

94 
	$icuO≥n
(

95 
sqlôe4_tokíizî
 *
pTokíizî
,

96 c⁄° *
zI≈ut
,

97 
nI≈ut
,

98 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


100 
IcuTokíizî
 *
p
 = (IcuTokíizî *)
pTokíizî
;

101 
IcuCurs‹
 *
pC§
;

103 c⁄° 
öt32_t
 
›t
 = 
U_FOLD_CASE_DEFAULT
;

104 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

105 
nCh¨
;

107 
UCh¨32
 
c
;

108 
iI≈ut
 = 0;

109 
iOut
 = 0;

111 *
µCurs‹
 = 0;

113 if–
nI≈ut
<0 ){

114 
nI≈ut
 = 
	`°æí
(
zI≈ut
);

116 
nCh¨
 = 
nI≈ut
+1;

117 
pC§
 = (
IcuCurs‹
 *)
	`sqlôe4_mÆloc
(

118 (
IcuCurs‹
) +

119 
nCh¨
 * (
UCh¨
) +

120 (
nCh¨
+1) * ()

122 if–!
pC§
 ){

123  
SQLITE4_NOMEM
;

125 
	`mem£t
(
pC§
, 0, (
IcuCurs‹
));

126 
pC§
->
aCh¨
 = (
UCh¨
 *)&pCsr[1];

127 
pC§
->
aOff£t
 = (*)&pC§->
aCh¨
[
nCh¨
];

129 
pC§
->
aOff£t
[
iOut
] = 
iI≈ut
;

130 
	`U8_NEXT
(
zI≈ut
, 
iI≈ut
, 
nI≈ut
, 
c
);

131  
c
>0 ){

132 
isEº‹
 = 0;

133 
c
 = 
	`u_fﬁdCa£
(c, 
›t
);

134 
	`U16_APPEND
(
pC§
->
aCh¨
, 
iOut
, 
nCh¨
, 
c
, 
isEº‹
);

135 if–
isEº‹
 ){

136 
	`sqlôe4_‰ì
(
pC§
);

137  
SQLITE4_ERROR
;

139 
pC§
->
aOff£t
[
iOut
] = 
iI≈ut
;

141 if–
iI≈ut
<
nI≈ut
 ){

142 
	`U8_NEXT
(
zI≈ut
, 
iI≈ut
, 
nI≈ut
, 
c
);

144 
c
 = 0;

148 
pC§
->
pIãr
 = 
	`ubrk_›í
(
UBRK_WORD
, 
p
->
zLoˇÀ
,ÖC§->
aCh¨
, 
iOut
, &
°©us
);

149 if–!
	`U_SUCCESS
(
°©us
) ){

150 
	`sqlôe4_‰ì
(
pC§
);

151  
SQLITE4_ERROR
;

153 
pC§
->
nCh¨
 = 
iOut
;

155 
	`ubrk_fú°
(
pC§
->
pIãr
);

156 *
µCurs‹
 = (
sqlôe4_tokíizî_curs‹
 *)
pC§
;

157  
SQLITE4_OK
;

158 
	}
}

163 
	$icuClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

164 
IcuCurs‹
 *
pC§
 = (IcuCurs‹ *)
pCurs‹
;

165 
	`ubrk_˛o£
(
pC§
->
pIãr
);

166 
	`sqlôe4_‰ì
(
pC§
->
zBuf„r
);

167 
	`sqlôe4_‰ì
(
pC§
);

168  
SQLITE4_OK
;

169 
	}
}

174 
	$icuNext
(

175 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

176 c⁄° **
µTokí
,

177 *
≤Byãs
,

178 *
piSèπOff£t
,

179 *
piEndOff£t
,

180 *
piPosôi⁄


182 
IcuCurs‹
 *
pC§
 = (IcuCurs‹ *)
pCurs‹
;

184 
iSèπ
 = 0;

185 
iEnd
 = 0;

186 
nByã
 = 0;

188  
iSèπ
==
iEnd
 ){

189 
UCh¨32
 
c
;

191 
iSèπ
 = 
	`ubrk_cuºít
(
pC§
->
pIãr
);

192 
iEnd
 = 
	`ubrk_√xt
(
pC§
->
pIãr
);

193 if–
iEnd
==
UBRK_DONE
 ){

194  
SQLITE4_DONE
;

197  
iSèπ
<
iEnd
 ){

198 
iWhôe
 = 
iSèπ
;

199 
	`U8_NEXT
(
pC§
->
aCh¨
, 
iWhôe
,ÖC§->
nCh¨
, 
c
);

200 if–
	`u_is•a˚
(
c
) ){

201 
iSèπ
 = 
iWhôe
;

206 
	`as£π
(
iSèπ
<=
iEnd
);

210 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

211 if–
nByã
 ){

212 *
zNew
 = 
	`sqlôe4_ªÆloc
(
pC§
->
zBuf„r
, 
nByã
);

213 if–!
zNew
 ){

214  
SQLITE4_NOMEM
;

216 
pC§
->
zBuf„r
 = 
zNew
;

217 
pC§
->
nBuf„r
 = 
nByã
;

220 
	`u_°rToUTF8
(

221 
pC§
->
zBuf„r
,ÖC§->
nBuf„r
, &
nByã
,

222 &
pC§
->
aCh¨
[
iSèπ
], 
iEnd
-iStart,

223 &
°©us


225 }  
nByã
>
pC§
->
nBuf„r
 );

227 *
µTokí
 = 
pC§
->
zBuf„r
;

228 *
≤Byãs
 = 
nByã
;

229 *
piSèπOff£t
 = 
pC§
->
aOff£t
[
iSèπ
];

230 *
piEndOff£t
 = 
pC§
->
aOff£t
[
iEnd
];

231 *
piPosôi⁄
 = 
pC§
->
iTokí
++;

233  
SQLITE4_OK
;

234 
	}
}

239 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gicuTokíizîModuÀ
 = {

241 
icuCª©e
,

242 
icuDe°roy
,

243 
icuO≥n
,

244 
icuClo£
,

245 
icuNext
,

251 
	$sqlôe4Fts3IcuTokíizîModuÀ
(

252 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


254 *
µModuÀ
 = &
icuTokíizîModuÀ
;

255 
	}
}

	@ext/fts3/fts3_porter.c

25 
	~"·s3I¡.h
"

26 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

28 
	~<as£π.h
>

29 
	~<°dlib.h
>

30 
	~<°dio.h
>

31 
	~<°rög.h
>

33 
	~"·s3_tokíizî.h
"

38 
	sp‹ãr_tokíizî
 {

39 
sqlôe4_tokíizî
 
	mba£
;

40 } 
	tp‹ãr_tokíizî
;

45 
	sp‹ãr_tokíizî_curs‹
 {

46 
sqlôe4_tokíizî_curs‹
 
	mba£
;

47 c⁄° *
	mzI≈ut
;

48 
	mnI≈ut
;

49 
	miOff£t
;

50 
	miTokí
;

51 *
	mzTokí
;

52 
	mnAŒoˇãd
;

53 } 
	tp‹ãr_tokíizî_curs‹
;

59 
	$p‹ãrCª©e
(

60 
¨gc
, c⁄° * c⁄° *
¨gv
,

61 
sqlôe4_tokíizî
 **
µTokíizî


63 
p‹ãr_tokíizî
 *
t
;

65 
	`UNUSED_PARAMETER
(
¨gc
);

66 
	`UNUSED_PARAMETER
(
¨gv
);

68 
t
 = (
p‹ãr_tokíizî
 *Ë
	`sqlôe4_mÆloc
((*t));

69 if–
t
==
NULL
 )  
SQLITE4_NOMEM
;

70 
	`mem£t
(
t
, 0, (*t));

71 *
µTokíizî
 = &
t
->
ba£
;

72  
SQLITE4_OK
;

73 
	}
}

78 
	$p‹ãrDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

79 
	`sqlôe4_‰ì
(
pTokíizî
);

80  
SQLITE4_OK
;

81 
	}
}

89 
	$p‹ãrO≥n
(

90 
sqlôe4_tokíizî
 *
pTokíizî
,

91 c⁄° *
zI≈ut
, 
nI≈ut
,

92 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


94 
p‹ãr_tokíizî_curs‹
 *
c
;

96 
	`UNUSED_PARAMETER
(
pTokíizî
);

98 
c
 = (
p‹ãr_tokíizî_curs‹
 *Ë
	`sqlôe4_mÆloc
((*c));

99 if–
c
==
NULL
 )  
SQLITE4_NOMEM
;

101 
c
->
zI≈ut
 = zInput;

102 if–
zI≈ut
==0 ){

103 
c
->
nI≈ut
 = 0;

104 }if–
nI≈ut
<0 ){

105 
c
->
nI≈ut
 = ()
	`°æí
(
zI≈ut
);

107 
c
->
nI≈ut
 =ÇInput;

109 
c
->
iOff£t
 = 0;

110 
c
->
iTokí
 = 0;

111 
c
->
zTokí
 = 
NULL
;

112 
c
->
nAŒoˇãd
 = 0;

114 *
µCurs‹
 = &
c
->
ba£
;

115  
SQLITE4_OK
;

116 
	}
}

122 
	$p‹ãrClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

123 
p‹ãr_tokíizî_curs‹
 *
c
 = (p‹ãr_tokíizî_curs‹ *Ë
pCurs‹
;

124 
	`sqlôe4_‰ì
(
c
->
zTokí
);

125 
	`sqlôe4_‰ì
(
c
);

126  
SQLITE4_OK
;

127 
	}
}

131 c⁄° 
	gcTy≥
[] = {

149 
isVowñ
(const *);

150 
	$isC⁄s⁄™t
(c⁄° *
z
){

151 
j
;

152 
x
 = *
z
;

153 if–
x
==0 )  0;

154 
	`as£π
–
x
>='a' && x<='z' );

155 
j
 = 
cTy≥
[
x
-'a'];

156 if–
j
<2 )  j;

157  
z
[1]==0 || 
	`isVowñ
(z + 1);

158 
	}
}

159 
	$isVowñ
(c⁄° *
z
){

160 
j
;

161 
x
 = *
z
;

162 if–
x
==0 )  0;

163 
	`as£π
–
x
>='a' && x<='z' );

164 
j
 = 
cTy≥
[
x
-'a'];

165 if–
j
<2 )  1-j;

166  
	`isC⁄s⁄™t
(
z
 + 1);

167 
	}
}

188 
	$m_gt_0
(c⁄° *
z
){

189  
	`isVowñ
(
z
) ){ z++; }

190 if–*
z
==0 )  0;

191  
	`isC⁄s⁄™t
(
z
) ){ z++; }

192  *
z
!=0;

193 
	}
}

198 
	$m_eq_1
(c⁄° *
z
){

199  
	`isVowñ
(
z
) ){ z++; }

200 if–*
z
==0 )  0;

201  
	`isC⁄s⁄™t
(
z
) ){ z++; }

202 if–*
z
==0 )  0;

203  
	`isVowñ
(
z
) ){ z++; }

204 if–*
z
==0 )  1;

205  
	`isC⁄s⁄™t
(
z
) ){ z++; }

206  *
z
==0;

207 
	}
}

212 
	$m_gt_1
(c⁄° *
z
){

213  
	`isVowñ
(
z
) ){ z++; }

214 if–*
z
==0 )  0;

215  
	`isC⁄s⁄™t
(
z
) ){ z++; }

216 if–*
z
==0 )  0;

217  
	`isVowñ
(
z
) ){ z++; }

218 if–*
z
==0 )  0;

219  
	`isC⁄s⁄™t
(
z
) ){ z++; }

220  *
z
!=0;

221 
	}
}

226 
	$hasVowñ
(c⁄° *
z
){

227  
	`isC⁄s⁄™t
(
z
) ){ z++; }

228  *
z
!=0;

229 
	}
}

237 
	$doubÀC⁄s⁄™t
(c⁄° *
z
){

238  
	`isC⁄s⁄™t
(
z
) && z[0]==z[1];

239 
	}
}

249 
	$°¨_oh
(c⁄° *
z
){

251 
	`isC⁄s⁄™t
(
z
) &&

252 
z
[0]!='w' && z[0]!='x' && z[0]!='y' &&

253 
	`isVowñ
(
z
+1) &&

254 
	`isC⁄s⁄™t
(
z
+2);

255 
	}
}

269 
°em
(

270 **
pz
,

271 c⁄° *
zFrom
,

272 c⁄° *
zTo
,

273 (*
xC⁄d
)(const *)

275 *
z
 = *
pz
;

276  *
zFrom
 && *zFrom==*
z
 ){ z++; zFrom++; }

277 if–*
zFrom
!=0 )  0;

278 if–
xC⁄d
 && !
	`xC⁄d
(
z
) )  1;

279  *
zTo
 ){

280 *(--
z
Ë*(
zTo
++);

282 *
pz
 = 
z
;

284 
	}
}

294 
	$c›y_°emmî
(c⁄° *
zIn
, 
nIn
, *
zOut
, *
≤Out
){

295 
i
, 
mx
, 
j
;

296 
hasDigô
 = 0;

297 
i
=0; i<
nIn
; i++){

298 
c
 = 
zIn
[
i
];

299 if–
c
>='A' && c<='Z' ){

300 
zOut
[
i
] = 
c
 - 'A' + 'a';

302 if–
c
>='0' && c<='9' ) 
hasDigô
 = 1;

303 
zOut
[
i
] = 
c
;

306 
mx
 = 
hasDigô
 ? 3 : 10;

307 if–
nIn
>
mx
*2 ){

308 
j
=
mx
, 
i
=
nIn
-mx; i<nIn; i++, j++){

309 
zOut
[
j
] = zOut[
i
];

311 
i
 = 
j
;

313 
zOut
[
i
] = 0;

314 *
≤Out
 = 
i
;

315 
	}
}

341 
	$p‹ãr_°emmî
(c⁄° *
zIn
, 
nIn
, *
zOut
, *
≤Out
){

342 
i
, 
j
;

343 
zRevî£
[28];

344 *
z
, *
z2
;

345 if–
nIn
<3 ||ÇIn>=()(
zRevî£
)-7 ){

348 
	`c›y_°emmî
(
zIn
, 
nIn
, 
zOut
, 
≤Out
);

351 
i
=0, 
j
=(
zRevî£
)-6; i<
nIn
; i++, j--){

352 
c
 = 
zIn
[
i
];

353 if–
c
>='A' && c<='Z' ){

354 
zRevî£
[
j
] = 
c
 + 'a' - 'A';

355 }if–
c
>='a' && c<='z' ){

356 
zRevî£
[
j
] = 
c
;

360 
	`c›y_°emmî
(
zIn
, 
nIn
, 
zOut
, 
≤Out
);

364 
	`mem£t
(&
zRevî£
[(zReverse)-5], 0, 5);

365 
z
 = &
zRevî£
[
j
+1];

369 if–
z
[0]=='s' ){

371 !
	`°em
(&
z
, "sess", "ss", 0) &&

372 !
	`°em
(&
z
, "sei", "i", 0) &&

373 !
	`°em
(&
z
, "ss", "ss", 0)

375 
z
++;

380 
z2
 = 
z
;

381 if–
	`°em
(&
z
, "dì", "ì", 
m_gt_0
) ){

384 (
	`°em
(&
z
, "gni", "", 
hasVowñ
) || stem(&z, "de", "", hasVowel))

385 && 
z
!=
z2


387 if–
	`°em
(&
z
, "ta", "ate", 0) ||

388 
	`°em
(&
z
, "lb", "ble", 0) ||

389 
	`°em
(&
z
, "zi", "ize", 0) ){

391 }if–
	`doubÀC⁄s⁄™t
(
z
) && (*z!='l' && *z!='s' && *z!='z') ){

392 
z
++;

393 }if–
	`m_eq_1
(
z
Ë&& 
	`°¨_oh
(z) ){

394 *(--
z
) = 'e';

399 if–
z
[0]=='y' && 
	`hasVowñ
(z+1) ){

400 
z
[0] = 'i';

404  
z
[1] ){

406 
	`°em
(&
z
, "œnoôa", "©e", 
m_gt_0
) ||

407 
	`°em
(&
z
, "œnoô", "ti⁄", 
m_gt_0
);

410 
	`°em
(&
z
, "i˙e", "í˚", 
m_gt_0
) ||

411 
	`°em
(&
z
, "i˙a", "™˚", 
m_gt_0
);

414 
	`°em
(&
z
, "ªzi", "ize", 
m_gt_0
);

417 
	`°em
(&
z
, "igﬁ", "log", 
m_gt_0
);

420 
	`°em
(&
z
, "ûb", "bÀ", 
m_gt_0
) ||

421 
	`°em
(&
z
, "ûœ", "Æ", 
m_gt_0
) ||

422 
	`°em
(&
z
, "ûäe", "ít", 
m_gt_0
) ||

423 
	`°em
(&
z
, "ûe", "e", 
m_gt_0
) ||

424 
	`°em
(&
z
, "ûsuo", "ous", 
m_gt_0
);

427 
	`°em
(&
z
, "noôazi", "ize", 
m_gt_0
) ||

428 
	`°em
(&
z
, "noôa", "©e", 
m_gt_0
) ||

429 
	`°em
(&
z
, "rŸa", "©e", 
m_gt_0
);

432 
	`°em
(&
z
, "msûa", "Æ", 
m_gt_0
) ||

433 
	`°em
(&
z
, "s£√vi", "ive", 
m_gt_0
) ||

434 
	`°em
(&
z
, "s£∆uf", "ful", 
m_gt_0
) ||

435 
	`°em
(&
z
, "s£nsuo", "ous", 
m_gt_0
);

438 
	`°em
(&
z
, "ôûa", "Æ", 
m_gt_0
) ||

439 
	`°em
(&
z
, "ôivi", "ive", 
m_gt_0
) ||

440 
	`°em
(&
z
, "ôûib", "bÀ", 
m_gt_0
);

445  
z
[0] ){

447 
	`°em
(&
z
, "ëaci", "ic", 
m_gt_0
) ||

448 
	`°em
(&
z
, "evôa", "", 
m_gt_0
) ||

449 
	`°em
(&
z
, "ezûa", "Æ", 
m_gt_0
);

452 
	`°em
(&
z
, "ôici", "ic", 
m_gt_0
);

455 
	`°em
(&
z
, "œci", "ic", 
m_gt_0
) ||

456 
	`°em
(&
z
, "luf", "", 
m_gt_0
);

459 
	`°em
(&
z
, "s£n", "", 
m_gt_0
);

464  
z
[1] ){

466 if–
z
[0]=='l' && 
	`m_gt_1
(z+2) ){

467 
z
 += 2;

471 if–
z
[0]=='e' && z[2]=='n' && (z[3]=='a' || z[3]=='e'Ë&& 
	`m_gt_1
(z+4) ){

472 
z
 += 4;

476 if–
z
[0]=='r' && 
	`m_gt_1
(z+2) ){

477 
z
 += 2;

481 if–
z
[0]=='c' && 
	`m_gt_1
(z+2) ){

482 
z
 += 2;

486 if–
z
[0]=='e' && z[2]=='b' && (z[3]=='a' || z[3]=='i'Ë&& 
	`m_gt_1
(z+4) ){

487 
z
 += 4;

491 if–
z
[0]=='t' ){

492 if–
z
[2]=='a' ){

493 if–
	`m_gt_1
(
z
+3) ){

494 
z
 += 3;

496 }if–
z
[2]=='e' ){

497 
	`°em
(&
z
, "äeme", "", 
m_gt_1
) ||

498 
	`°em
(&
z
, "äem", "", 
m_gt_1
) ||

499 
	`°em
(&
z
, "äe", "", 
m_gt_1
);

504 if–
z
[0]=='u' ){

505 if–
	`m_gt_1
(
z
+2) ){

506 
z
 += 2;

508 }if–
z
[3]=='s' || z[3]=='t' ){

509 
	`°em
(&
z
, "noi", "", 
m_gt_1
);

513 if–
z
[0]=='m' && z[2]=='i' && 
	`m_gt_1
(z+3) ){

514 
z
 += 3;

518 
	`°em
(&
z
, "ëa", "", 
m_gt_1
) ||

519 
	`°em
(&
z
, "ôi", "", 
m_gt_1
);

522 if–
z
[0]=='s' && z[2]=='o' && 
	`m_gt_1
(z+3) ){

523 
z
 += 3;

528 if–
z
[0]=='e' && z[2]=='i' && 
	`m_gt_1
(z+3) ){

529 
z
 += 3;

535 if–
z
[0]=='e' ){

536 if–
	`m_gt_1
(
z
+1) ){

537 
z
++;

538 }if–
	`m_eq_1
(
z
+1Ë&& !
	`°¨_oh
(z+1) ){

539 
z
++;

544 if–
	`m_gt_1
(
z
) && z[0]=='l' && z[1]=='l' ){

545 
z
++;

551 *
≤Out
 = 
i
 = ()
	`°æí
(
z
);

552 
zOut
[
i
] = 0;

553  *
z
 ){

554 
zOut
[--
i
] = *(
z
++);

556 
	}
}

564 c⁄° 
	gp‹ãrIdCh¨
[] = {

572 
	#isDñim
(
C
Ë(((
ch
=C)&0x80)==0 && (ch<0x30 || !
p‹ãrIdCh¨
[ch-0x30]))

	)

578 
	$p‹ãrNext
(

579 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

580 c⁄° **
pzTokí
,

581 *
≤Byãs
,

582 *
piSèπOff£t
,

583 *
piEndOff£t
,

584 *
piPosôi⁄


586 
p‹ãr_tokíizî_curs‹
 *
c
 = (p‹ãr_tokíizî_curs‹ *Ë
pCurs‹
;

587 c⁄° *
z
 = 
c
->
zI≈ut
;

589  
c
->
iOff£t
<c->
nI≈ut
 ){

590 
iSèπOff£t
, 
ch
;

593  
c
->
iOff£t
<c->
nI≈ut
 && 
	`isDñim
(
z
[c->iOffset]) ){

594 
c
->
iOff£t
++;

598 
iSèπOff£t
 = 
c
->
iOff£t
;

599  
c
->
iOff£t
<c->
nI≈ut
 && !
	`isDñim
(
z
[c->iOffset]) ){

600 
c
->
iOff£t
++;

603 if–
c
->
iOff£t
>
iSèπOff£t
 ){

604 
n
 = 
c
->
iOff£t
-
iSèπOff£t
;

605 if–
n
>
c
->
nAŒoˇãd
 ){

606 *
pNew
;

607 
c
->
nAŒoˇãd
 = 
n
+20;

608 
pNew
 = 
	`sqlôe4_ªÆloc
(
c
->
zTokí
, c->
nAŒoˇãd
);

609 if–!
pNew
 )  
SQLITE4_NOMEM
;

610 
c
->
zTokí
 = 
pNew
;

612 
	`p‹ãr_°emmî
(&
z
[
iSèπOff£t
], 
n
, 
c
->
zTokí
, 
≤Byãs
);

613 *
pzTokí
 = 
c
->
zTokí
;

614 *
piSèπOff£t
 = 
iSèπOff£t
;

615 *
piEndOff£t
 = 
c
->
iOff£t
;

616 *
piPosôi⁄
 = 
c
->
iTokí
++;

617  
SQLITE4_OK
;

620  
SQLITE4_DONE
;

621 
	}
}

626 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gp‹ãrTokíizîModuÀ
 = {

628 
p‹ãrCª©e
,

629 
p‹ãrDe°roy
,

630 
p‹ãrO≥n
,

631 
p‹ãrClo£
,

632 
p‹ãrNext
,

639 
	$sqlôe4Fts3P‹ãrTokíizîModuÀ
(

640 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


642 *
µModuÀ
 = &
p‹ãrTokíizîModuÀ
;

643 
	}
}

	@ext/fts3/fts3_snippet.c

14 
	~"·s3I¡.h
"

15 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

17 
	~<°rög.h
>

18 
	~<as£π.h
>

23 
	#FTS3_MATCHINFO_NPHRASE
 'p'

	)

24 
	#FTS3_MATCHINFO_NCOL
 'c'

	)

25 
	#FTS3_MATCHINFO_NDOC
 'n'

	)

26 
	#FTS3_MATCHINFO_AVGLENGTH
 'a'

	)

27 
	#FTS3_MATCHINFO_LENGTH
 'l'

	)

28 
	#FTS3_MATCHINFO_LCS
 's'

	)

29 
	#FTS3_MATCHINFO_HITS
 'x'

	)

34 
	#FTS3_MATCHINFO_DEFAULT
 "pcx"

	)

41 
LﬂdDo˛i°Ctx
 
	tLﬂdDo˛i°Ctx
;

42 
	sLﬂdDo˛i°Ctx
 {

43 
Fts3Curs‹
 *
	mpC§
;

44 
	mnPhø£
;

45 
	mnTokí
;

52 
Snù≥tIãr
 
	tSnù≥tIãr
;

53 
Snù≥tPhø£
 
	tSnù≥tPhø£
;

54 
Snù≥tFøgmít
 
	tSnù≥tFøgmít
;

56 
	sSnù≥tIãr
 {

57 
Fts3Curs‹
 *
	mpC§
;

58 
	miCﬁ
;

59 
	mnSnù≥t
;

60 
	mnPhø£
;

61 
Snù≥tPhø£
 *
	maPhø£
;

62 
	miCuºít
;

65 
	sSnù≥tPhø£
 {

66 
	mnTokí
;

67 *
	mpLi°
;

68 
	miHód
;

69 *
	mpHód
;

70 
	miTaû
;

71 *
	mpTaû
;

74 
	sSnù≥tFøgmít
 {

75 
	miCﬁ
;

76 
	miPos
;

77 
u64
 
	mcovîed
;

78 
u64
 
	mhlmask
;

85 
M©chInfo
 
	tM©chInfo
;

86 
	sM©chInfo
 {

87 
Fts3Curs‹
 *
	mpCurs‹
;

88 
	mnCﬁ
;

89 
	mnPhø£
;

90 
sqlôe4_öt64
 
	mnDoc
;

91 
u32
 *
	maM©chöfo
;

101 
SåBuf„r
 
	tSåBuf„r
;

102 
	sSåBuf„r
 {

103 *
	mz
;

104 
	mn
;

105 
	mnAŒoc
;

129 
	$·s3GëDñèPosôi⁄
(**
µ
, *
piPos
){

130 
iVÆ
;

131 *
µ
 +
	`sqlôe4Fts3GëV¨öt32
(*µ, &
iVÆ
);

132 *
piPos
 +(
iVÆ
-2);

133 
	}
}

138 
·s3Ex¥Iãøã2
(

139 
Fts3Ex¥
 *
pEx¥
,

140 *
piPhø£
,

141 (*
x
)(
Fts3Ex¥
*,,*),

142 *
pCtx


144 
rc
;

145 
eTy≥
 = 
pEx¥
->eType;

147 if–
eTy≥
!=
FTSQUERY_PHRASE
 ){

148 
	`as£π
–
pEx¥
->
pLe·
 &&ÖEx¥->
pRight
 );

149 
rc
 = 
	`·s3Ex¥Iãøã2
(
pEx¥
->
pLe·
, 
piPhø£
, 
x
, 
pCtx
);

150 if–
rc
==
SQLITE4_OK
 && 
eTy≥
!=
FTSQUERY_NOT
 ){

151 
rc
 = 
	`·s3Ex¥Iãøã2
(
pEx¥
->
pRight
, 
piPhø£
, 
x
, 
pCtx
);

154 
rc
 = 
	`x
(
pEx¥
, *
piPhø£
, 
pCtx
);

155 (*
piPhø£
)++;

157  
rc
;

158 
	}
}

170 
·s3Ex¥Iãøã
(

171 
Fts3Ex¥
 *
pEx¥
,

172 (*
x
)(
Fts3Ex¥
*,,*),

173 *
pCtx


175 
iPhø£
 = 0;

176  
	`·s3Ex¥Iãøã2
(
pEx¥
, &
iPhø£
, 
x
, 
pCtx
);

177 
	}
}

184 
	$·s3Ex¥LﬂdDo˛i°sCb
(
Fts3Ex¥
 *
pEx¥
, 
iPhø£
, *
˘x
){

185 
rc
 = 
SQLITE4_OK
;

186 
Fts3Phø£
 *
pPhø£
 = 
pEx¥
->pPhrase;

187 
LﬂdDo˛i°Ctx
 *
p
 = (LﬂdDo˛i°Ctx *)
˘x
;

189 
	`UNUSED_PARAMETER
(
iPhø£
);

191 
p
->
nPhø£
++;

192 
p
->
nTokí
 +
pPhø£
->nToken;

194  
rc
;

195 
	}
}

207 
	$·s3Ex¥LﬂdDo˛i°s
(

208 
Fts3Curs‹
 *
pC§
,

209 *
≤Phø£
,

210 *
≤Tokí


212 
rc
;

213 
LﬂdDo˛i°Ctx
 
sCtx
 = {0,0,0};

214 
sCtx
.
pC§
 =ÖCsr;

215 
rc
 = 
	`·s3Ex¥Iãøã
(
pC§
->
pEx¥
, 
·s3Ex¥LﬂdDo˛i°sCb
, (*)&
sCtx
);

216 if–
≤Phø£
 ) *≤Phø£ = 
sCtx
.
nPhø£
;

217 if–
≤Tokí
 ) *≤Tokí = 
sCtx
.
nTokí
;

218  
rc
;

219 
	}
}

221 
	$·s3Ex¥Phø£Cou¡Cb
(
Fts3Ex¥
 *
pEx¥
, 
iPhø£
, *
˘x
){

222 (*(*)
˘x
)++;

223 
	`UNUSED_PARAMETER
(
pEx¥
);

224 
	`UNUSED_PARAMETER
(
iPhø£
);

225  
SQLITE4_OK
;

226 
	}
}

227 
	$·s3Ex¥Phø£Cou¡
(
Fts3Ex¥
 *
pEx¥
){

228 
nPhø£
 = 0;

229 ()
	`·s3Ex¥Iãøã
(
pEx¥
, 
·s3Ex¥Phø£Cou¡Cb
, (*)&
nPhø£
);

230  
nPhø£
;

231 
	}
}

238 
	$·s3Snù≥tAdv™˚
(**
µIãr
, *
piIãr
, 
iNext
){

239 *
pIãr
 = *
µIãr
;

240 if–
pIãr
 ){

241 
iIãr
 = *
piIãr
;

243  
iIãr
<
iNext
 ){

244 if–0==(*
pIãr
 & 0xFE) ){

245 
iIãr
 = -1;

246 
pIãr
 = 0;

249 
	`·s3GëDñèPosôi⁄
(&
pIãr
, &
iIãr
);

252 *
piIãr
 = 
iIãr
;

253 *
µIãr
 = 
pIãr
;

255 
	}
}

260 
	$·s3Snù≥tNextC™did©e
(
Snù≥tIãr
 *
pIãr
){

261 
i
;

263 if–
pIãr
->
iCuºít
<0 ){

268 
pIãr
->
iCuºít
 = 0;

273 
i
=0; i<
pIãr
->
nPhø£
; i++){

274 
Snù≥tPhø£
 *
pPhø£
 = &
pIãr
->
aPhø£
[
i
];

275 
	`·s3Snù≥tAdv™˚
(&
pPhø£
->
pHód
, &pPhø£->
iHód
, 
pIãr
->
nSnù≥t
);

278 
iSèπ
;

279 
iEnd
 = 0x7FFFFFFF;

281 
i
=0; i<
pIãr
->
nPhø£
; i++){

282 
Snù≥tPhø£
 *
pPhø£
 = &
pIãr
->
aPhø£
[
i
];

283 if–
pPhø£
->
pHód
 &&ÖPhø£->
iHód
<
iEnd
 ){

284 
iEnd
 = 
pPhø£
->
iHód
;

287 if–
iEnd
==0x7FFFFFFF ){

291 
pIãr
->
iCuºít
 = 
iSèπ
 = 
iEnd
 -ÖIãr->
nSnù≥t
 + 1;

292 
i
=0; i<
pIãr
->
nPhø£
; i++){

293 
Snù≥tPhø£
 *
pPhø£
 = &
pIãr
->
aPhø£
[
i
];

294 
	`·s3Snù≥tAdv™˚
(&
pPhø£
->
pHód
, &pPhø£->
iHód
, 
iEnd
+1);

295 
	`·s3Snù≥tAdv™˚
(&
pPhø£
->
pTaû
, &pPhø£->
iTaû
, 
iSèπ
);

300 
	}
}

306 
	$·s3Snù≥tDëaûs
(

307 
Snù≥tIãr
 *
pIãr
,

308 
u64
 
mCovîed
,

309 *
piTokí
,

310 *
piSc‹e
,

311 
u64
 *
pmCovî
,

312 
u64
 *
pmHighlight


314 
iSèπ
 = 
pIãr
->
iCuºít
;

315 
iSc‹e
 = 0;

316 
i
;

317 
u64
 
mCovî
 = 0;

318 
u64
 
mHighlight
 = 0;

320 
i
=0; i<
pIãr
->
nPhø£
; i++){

321 
Snù≥tPhø£
 *
pPhø£
 = &
pIãr
->
aPhø£
[
i
];

322 if–
pPhø£
->
pTaû
 ){

323 *
pC§
 = 
pPhø£
->
pTaû
;

324 
iC§
 = 
pPhø£
->
iTaû
;

326  
iC§
<(
iSèπ
+
pIãr
->
nSnù≥t
) ){

327 
j
;

328 
u64
 
mPhø£
 = (u64)1 << 
i
;

329 
u64
 
mPos
 = (u64)1 << (
iC§
 - 
iSèπ
);

330 
	`as£π
–
iC§
>=
iSèπ
 );

331 if–(
mCovî
|
mCovîed
)&
mPhø£
 ){

332 
iSc‹e
++;

334 
iSc‹e
 += 1000;

336 
mCovî
 |
mPhø£
;

338 
j
=0; j<
pPhø£
->
nTokí
; j++){

339 
mHighlight
 |(
mPos
>>
j
);

342 if–0==(*
pC§
 & 0x0FE) ) ;

343 
	`·s3GëDñèPosôi⁄
(&
pC§
, &
iC§
);

349 *
piTokí
 = 
iSèπ
;

350 *
piSc‹e
 = 
iSc‹e
;

351 *
pmCovî
 = 
mCovî
;

352 *
pmHighlight
 = 
mHighlight
;

353 
	}
}

359 
	$·s3Snù≥tFödPosôi⁄s
(
Fts3Ex¥
 *
pEx¥
, 
iPhø£
, *
˘x
){

360 
Snù≥tIãr
 *
p
 = (Snù≥tIã∏*)
˘x
;

361 
Snù≥tPhø£
 *
pPhø£
 = &
p
->
aPhø£
[
iPhø£
];

362 *
pC§
;

364 
pPhø£
->
nTokí
 = 
pEx¥
->pPhrase->nToken;

366 
pC§
 = 
	`sqlôe4Fts3EvÆPhø£Po¶i°
(
p
->pC§, 
pEx¥
,Ö->
iCﬁ
);

367 if–
pC§
 ){

368 
iFú°
 = 0;

369 
pPhø£
->
pLi°
 = 
pC§
;

370 
	`·s3GëDñèPosôi⁄
(&
pC§
, &
iFú°
);

371 
	`as£π
–
iFú°
>=0 );

372 
pPhø£
->
pHód
 = 
pC§
;

373 
pPhø£
->
pTaû
 = 
pC§
;

374 
pPhø£
->
iHód
 = 
iFú°
;

375 
pPhø£
->
iTaû
 = 
iFú°
;

377 
	`as£π
–
pPhø£
->
pLi°
==0 &&ÖPhø£->
pHód
==0 &&ÖPhø£->
pTaû
==0 );

380  
SQLITE4_OK
;

381 
	}
}

398 
	$·s3Be°Snù≥t
(

399 
nSnù≥t
,

400 
Fts3Curs‹
 *
pC§
,

401 
iCﬁ
,

402 
u64
 
mCovîed
,

403 
u64
 *
pmSìn
,

404 
Snù≥tFøgmít
 *
pFøgmít
,

405 *
piSc‹e


407 
rc
;

408 
nLi°
;

409 
Snù≥tIãr
 
sIãr
;

410 
nByã
;

411 
iBe°Sc‹e
 = -1;

412 
i
;

414 
	`mem£t
(&
sIãr
, 0, (sIter));

419 
rc
 = 
	`·s3Ex¥LﬂdDo˛i°s
(
pC§
, &
nLi°
, 0);

420 if–
rc
!=
SQLITE4_OK
 ){

421  
rc
;

427 
nByã
 = (
Snù≥tPhø£
Ë* 
nLi°
;

428 
sIãr
.
aPhø£
 = (
Snù≥tPhø£
 *)
	`sqlôe4_mÆloc
(
nByã
);

429 if–!
sIãr
.
aPhø£
 ){

430  
SQLITE4_NOMEM
;

432 
	`mem£t
(
sIãr
.
aPhø£
, 0, 
nByã
);

437 
sIãr
.
pC§
 =ÖCsr;

438 
sIãr
.
iCﬁ
 = iCol;

439 
sIãr
.
nSnù≥t
 =ÇSnippet;

440 
sIãr
.
nPhø£
 = 
nLi°
;

441 
sIãr
.
iCuºít
 = -1;

442 ()
	`·s3Ex¥Iãøã
(
pC§
->
pEx¥
, 
·s3Snù≥tFödPosôi⁄s
, (*)&
sIãr
);

445 
i
=0; i<
nLi°
; i++){

446 if–
sIãr
.
aPhø£
[
i
].
pHód
 ){

447 *
pmSìn
 |(
u64
)1 << 
i
;

454 
pFøgmít
->
iCﬁ
 = iCol;

455  !
	`·s3Snù≥tNextC™did©e
(&
sIãr
) ){

456 
iPos
;

457 
iSc‹e
;

458 
u64
 
mCovî
;

459 
u64
 
mHighlight
;

460 
	`·s3Snù≥tDëaûs
(&
sIãr
, 
mCovîed
, &
iPos
, &
iSc‹e
, &
mCovî
, &
mHighlight
);

461 
	`as£π
–
iSc‹e
>=0 );

462 if–
iSc‹e
>
iBe°Sc‹e
 ){

463 
pFøgmít
->
iPos
 = iPos;

464 
pFøgmít
->
hlmask
 = 
mHighlight
;

465 
pFøgmít
->
covîed
 = 
mCovî
;

466 
iBe°Sc‹e
 = 
iSc‹e
;

470 
	`sqlôe4_‰ì
(
sIãr
.
aPhø£
);

471 *
piSc‹e
 = 
iBe°Sc‹e
;

472  
SQLITE4_OK
;

473 
	}
}

482 
	$·s3SåögAµíd
(

483 
SåBuf„r
 *
pSå
,

484 c⁄° *
zAµíd
,

485 
nAµíd


487 if–
nAµíd
<0 ){

488 
nAµíd
 = ()
	`°æí
(
zAµíd
);

495 if–
pSå
->
n
+
nAµíd
+1>ıSå->
nAŒoc
 ){

496 
nAŒoc
 = 
pSå
->nAŒoc+
nAµíd
+100;

497 *
zNew
 = 
	`sqlôe4_ªÆloc
(
pSå
->
z
, 
nAŒoc
);

498 if–!
zNew
 ){

499  
SQLITE4_NOMEM
;

501 
pSå
->
z
 = 
zNew
;

502 
pSå
->
nAŒoc
 =ÇAlloc;

506 
	`mem˝y
(&
pSå
->
z
[pSå->
n
], 
zAµíd
, 
nAµíd
);

507 
pSå
->
n
 +
nAµíd
;

508 
pSå
->
z
[pSå->
n
] = '\0';

510  
SQLITE4_OK
;

511 
	}
}

533 
	$·s3Snù≥tShi·
(

534 
Fts3TabÀ
 *
pTab
,

535 
nSnù≥t
,

536 c⁄° *
zDoc
,

537 
nDoc
,

538 *
piPos
,

539 
u64
 *
pHlmask


541 
u64
 
hlmask
 = *
pHlmask
;

543 if–
hlmask
 ){

544 
nLe·
;

545 
nRight
;

546 
nDesúed
;

548 
nLe·
=0; !(
hlmask
 & ((
u64
)1 <<ÇLeft));ÇLeft++);

549 
nRight
=0; !(
hlmask
 & ((
u64
)1 << (
nSnù≥t
-1-nRight)));ÇRight++);

550 
nDesúed
 = (
nLe·
-
nRight
)/2;

559 if–
nDesúed
>0 ){

560 
nShi·
;

561 
iCuºít
 = 0;

562 
rc
;

563 
sqlôe4_tokíizî_moduÀ
 *
pMod
;

564 
sqlôe4_tokíizî_curs‹
 *
pC
;

565 
pMod
 = (
sqlôe4_tokíizî_moduÀ
 *)
pTab
->
pTokíizî
->
pModuÀ
;

570 
rc
 = 
pMod
->
	`xO≥n
(
pTab
->
pTokíizî
, 
zDoc
, 
nDoc
, &
pC
);

571 if–
rc
!=
SQLITE4_OK
 ){

572  
rc
;

574 
pC
->
pTokíizî
 = 
pTab
->pTokenizer;

575  
rc
==
SQLITE4_OK
 && 
iCuºít
<(
nSnù≥t
+
nDesúed
) ){

576 c⁄° *
ZDUMMY
; 
DUMMY1
, 
DUMMY2
, 
DUMMY3
;

577 
rc
 = 
pMod
->
	`xNext
(
pC
, &
ZDUMMY
, &
DUMMY1
, &
DUMMY2
, &
DUMMY3
, &
iCuºít
);

579 
pMod
->
	`xClo£
(
pC
);

580 if–
rc
!=
SQLITE4_OK
 &&Ñc!=
SQLITE4_DONE
 ){ Ñc; }

582 
nShi·
 = (
rc
==
SQLITE4_DONE
)+
iCuºít
-
nSnù≥t
;

583 
	`as£π
–
nShi·
<=
nDesúed
 );

584 if–
nShi·
>0 ){

585 *
piPos
 +
nShi·
;

586 *
pHlmask
 = 
hlmask
 >> 
nShi·
;

590  
SQLITE4_OK
;

591 
	}
}

597 
	$·s3Snù≥tText
(

598 
Fts3Curs‹
 *
pC§
,

599 
Snù≥tFøgmít
 *
pFøgmít
,

600 
iFøgmít
,

601 
isLa°
,

602 
nSnù≥t
,

603 c⁄° *
zO≥n
,

604 c⁄° *
zClo£
,

605 c⁄° *
zEŒùsis
,

606 
SåBuf„r
 *
pOut


608 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

609 
rc
;

610 c⁄° *
zDoc
;

611 
nDoc
;

612 
iCuºít
 = 0;

613 
iEnd
 = 0;

614 
isShi·D⁄e
 = 0;

615 
iPos
 = 
pFøgmít
->iPos;

616 
u64
 
hlmask
 = 
pFøgmít
->hlmask;

617 
iCﬁ
 = 
pFøgmít
->iCol+1;

618 
sqlôe4_tokíizî_moduÀ
 *
pMod
;

619 
sqlôe4_tokíizî_curs‹
 *
pC
;

620 c⁄° *
ZDUMMY
;

621 
DUMMY1
;

623 
zDoc
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pC§
->
pStmt
, 
iCﬁ
);

624 if–
zDoc
==0 ){

625 if–
	`sqlôe4_cﬁumn_ty≥
(
pC§
->
pStmt
, 
iCﬁ
)!=
SQLITE4_NULL
 ){

626  
SQLITE4_NOMEM
;

628  
SQLITE4_OK
;

630 
nDoc
 = 
	`sqlôe4_cﬁumn_byãs
(
pC§
->
pStmt
, 
iCﬁ
);

633 
pMod
 = (
sqlôe4_tokíizî_moduÀ
 *)
pTab
->
pTokíizî
->
pModuÀ
;

634 
rc
 = 
pMod
->
	`xO≥n
(
pTab
->
pTokíizî
, 
zDoc
, 
nDoc
, &
pC
);

635 if–
rc
!=
SQLITE4_OK
 ){

636  
rc
;

638 
pC
->
pTokíizî
 = 
pTab
->pTokenizer;

640  
rc
==
SQLITE4_OK
 ){

641 
iBegö
;

642 
iFö
;

643 
isHighlight
;

645 
rc
 = 
pMod
->
	`xNext
(
pC
, &
ZDUMMY
, &
DUMMY1
, &
iBegö
, &
iFö
, &
iCuºít
);

646 if–
rc
!=
SQLITE4_OK
 ){

647 if–
rc
==
SQLITE4_DONE
 ){

652 
rc
 = 
	`·s3SåögAµíd
(
pOut
, &
zDoc
[
iEnd
], -1);

656 if–
iCuºít
<
iPos
 ){ ; }

658 if–!
isShi·D⁄e
 ){

659 
n
 = 
nDoc
 - 
iBegö
;

660 
rc
 = 
	`·s3Snù≥tShi·
(
pTab
, 
nSnù≥t
, &
zDoc
[
iBegö
], 
n
, &
iPos
, &
hlmask
);

661 
isShi·D⁄e
 = 1;

667 if–
rc
==
SQLITE4_OK
 && (
iPos
>0 || 
iFøgmít
>0) ){

668 
rc
 = 
	`·s3SåögAµíd
(
pOut
, 
zEŒùsis
, -1);

670 if–
rc
!=
SQLITE4_OK
 || 
iCuºít
<
iPos
 ) ;

673 if–
iCuºít
>=(
iPos
+
nSnù≥t
) ){

674 if–
isLa°
 ){

675 
rc
 = 
	`·s3SåögAµíd
(
pOut
, 
zEŒùsis
, -1);

681 
isHighlight
 = (
hlmask
 & ((
u64
)1 << (
iCuºít
-
iPos
)))!=0;

683 if–
iCuºít
>
iPos
 ) 
rc
 = 
	`·s3SåögAµíd
(
pOut
, &
zDoc
[
iEnd
], 
iBegö
-iEnd);

684 if–
rc
==
SQLITE4_OK
 && 
isHighlight
 )Ñ¯
	`·s3SåögAµíd
(
pOut
, 
zO≥n
, -1);

685 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s3SåögAµíd
(
pOut
, &
zDoc
[
iBegö
], 
iFö
-iBegin);

686 if–
rc
==
SQLITE4_OK
 && 
isHighlight
 )Ñ¯
	`·s3SåögAµíd
(
pOut
, 
zClo£
, -1);

688 
iEnd
 = 
iFö
;

691 
pMod
->
	`xClo£
(
pC
);

692  
rc
;

693 
	}
}

709 
	$·s3Cﬁum∆i°Cou¡
(**
µCﬁli°
){

710 *
pEnd
 = *
µCﬁli°
;

711 
c
 = 0;

712 
nE¡ry
 = 0;

715  0xFE & (*
pEnd
 | 
c
) ){

716 
c
 = *
pEnd
++ & 0x80;

717 if–!
c
 ) 
nE¡ry
++;

720 *
µCﬁli°
 = 
pEnd
;

721  
nE¡ry
;

722 
	}
}

751 
	$·s3Ex¥GlobÆHôsCb
(

752 
Fts3Ex¥
 *
pEx¥
,

753 
iPhø£
,

754 *
pCtx


756 
M©chInfo
 *
p
 = (M©chInfÿ*)
pCtx
;

757  
	`sqlôe4Fts3EvÆPhø£Sèts
(

758 
p
->
pCurs‹
, 
pEx¥
, &p->
aM©chöfo
[3*
iPhø£
*p->
nCﬁ
]

760 
	}
}

767 
	$·s3Ex¥LoˇlHôsCb
(

768 
Fts3Ex¥
 *
pEx¥
,

769 
iPhø£
,

770 *
pCtx


772 
M©chInfo
 *
p
 = (M©chInfÿ*)
pCtx
;

773 
iSèπ
 = 
iPhø£
 * 
p
->
nCﬁ
 * 3;

774 
i
;

776 
i
=0; i<
p
->
nCﬁ
; i++){

777 *
pC§
;

778 
pC§
 = 
	`sqlôe4Fts3EvÆPhø£Po¶i°
(
p
->
pCurs‹
, 
pEx¥
, 
i
);

779 if–
pC§
 ){

780 
p
->
aM©chöfo
[
iSèπ
+
i
*3] = 
	`·s3Cﬁum∆i°Cou¡
(&
pC§
);

782 
p
->
aM©chöfo
[
iSèπ
+
i
*3] = 0;

786  
SQLITE4_OK
;

787 
	}
}

789 
	$·s3M©chöfoCheck
(

790 
Fts3TabÀ
 *
pTab
,

791 
cArg
,

792 **
pzEº


794 if–(
cArg
==
FTS3_MATCHINFO_NPHRASE
)

795 || (
cArg
==
FTS3_MATCHINFO_NCOL
)

796 || (
cArg
==
FTS3_MATCHINFO_NDOC
 && 
pTab
->
bHasSèt
)

797 || (
cArg
==
FTS3_MATCHINFO_AVGLENGTH
 && 
pTab
->
bHasSèt
)

798 || (
cArg
==
FTS3_MATCHINFO_LENGTH
 && 
pTab
->
bHasDocsize
)

799 || (
cArg
==
FTS3_MATCHINFO_LCS
)

800 || (
cArg
==
FTS3_MATCHINFO_HITS
)

802  
SQLITE4_OK
;

804 *
pzEº
 = 
	`sqlôe4_m¥ötf
("uƒecognized m©chöfÿªque°: %c", 
cArg
);

805  
SQLITE4_ERROR
;

806 
	}
}

808 
	$·s3M©chöfoSize
(
M©chInfo
 *
pInfo
, 
cArg
){

809 
nVÆ
;

811  
cArg
 ){

812 
FTS3_MATCHINFO_NDOC
:

813 
FTS3_MATCHINFO_NPHRASE
:

814 
FTS3_MATCHINFO_NCOL
:

815 
nVÆ
 = 1;

818 
FTS3_MATCHINFO_AVGLENGTH
:

819 
FTS3_MATCHINFO_LENGTH
:

820 
FTS3_MATCHINFO_LCS
:

821 
nVÆ
 = 
pInfo
->
nCﬁ
;

825 
	`as£π
–
cArg
==
FTS3_MATCHINFO_HITS
 );

826 
nVÆ
 = 
pInfo
->
nCﬁ
 *ÖInfo->
nPhø£
 * 3;

830  
nVÆ
;

831 
	}
}

833 
	$·s3M©chöfoSñe˘Do˘ŸÆ
(

834 
Fts3TabÀ
 *
pTab
,

835 
sqlôe4_°mt
 **
µStmt
,

836 
sqlôe4_öt64
 *
≤Doc
,

837 c⁄° **
∑Lí


839 
sqlôe4_°mt
 *
pStmt
;

840 c⁄° *
a
;

841 
sqlôe4_öt64
 
nDoc
;

843 if–!*
µStmt
 ){

844 
rc
 = 
	`sqlôe4Fts3Sñe˘Do˘ŸÆ
(
pTab
, 
µStmt
);

845 if–
rc
!=
SQLITE4_OK
 ) Ñc;

847 
pStmt
 = *
µStmt
;

848 
	`as£π
–
	`sqlôe4_d©a_cou¡
(
pStmt
)==1 );

850 
a
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0);

851 
a
 +
	`sqlôe4Fts3GëV¨öt
◊, &
nDoc
);

852 if–
nDoc
==0 )  
FTS_CORRUPT_VTAB
;

853 *
≤Doc
 = (
u32
)
nDoc
;

855 if–
∑Lí
 ) *∑Lí = 
a
;

856  
SQLITE4_OK
;

857 
	}
}

865 
LcsIãøt‹
 
	tLcsIãøt‹
;

866 
	sLcsIãøt‹
 {

867 
Fts3Ex¥
 *
	mpEx¥
;

868 
	miPosOff£t
;

869 *
	mpRód
;

870 
	miPos
;

877 
	#LCS_ITERATOR_FINISHED
 0x7FFFFFFF;

	)

879 
	$·s3M©chöfoLcsCb
(

880 
Fts3Ex¥
 *
pEx¥
,

881 
iPhø£
,

882 *
pCtx


884 
LcsIãøt‹
 *
aIãr
 = (LcsIãøt‹ *)
pCtx
;

885 
aIãr
[
iPhø£
].
pEx¥
 =ÖExpr;

886  
SQLITE4_OK
;

887 
	}
}

894 
	$·s3LcsIãøt‹Adv™˚
(
LcsIãøt‹
 *
pIãr
){

895 *
pRód
 = 
pIãr
->pRead;

896 
sqlôe4_öt64
 
iRód
;

897 
rc
 = 0;

899 
pRód
 +
	`sqlôe4Fts3GëV¨öt
’Ród, &
iRód
);

900 if–
iRód
==0 || iRead==1 ){

901 
pRód
 = 0;

902 
rc
 = 1;

904 
pIãr
->
iPos
 +()(
iRód
-2);

907 
pIãr
->
pRód
 =ÖRead;

908  
rc
;

909 
	}
}

922 
	$·s3M©chöfoLcs
(
Fts3Curs‹
 *
pC§
, 
M©chInfo
 *
pInfo
){

923 
LcsIãøt‹
 *
aIãr
;

924 
i
;

925 
iCﬁ
;

926 
nTokí
 = 0;

931 
aIãr
 = 
	`sqlôe4_mÆloc
((
LcsIãøt‹
Ë* 
pC§
->
nPhø£
);

932 if–!
aIãr
 )  
SQLITE4_NOMEM
;

933 
	`mem£t
(
aIãr
, 0, (
LcsIãøt‹
Ë* 
pC§
->
nPhø£
);

934 ()
	`·s3Ex¥Iãøã
(
pC§
->
pEx¥
, 
·s3M©chöfoLcsCb
, (*)
aIãr
);

936 
i
=0; i<
pInfo
->
nPhø£
; i++){

937 
LcsIãøt‹
 *
pIãr
 = &
aIãr
[
i
];

938 
nTokí
 -
pIãr
->
pEx¥
->
pPhø£
->nToken;

939 
pIãr
->
iPosOff£t
 = 
nTokí
;

942 
iCﬁ
=0; iCﬁ<
pInfo
->
nCﬁ
; iCol++){

943 
nLcs
 = 0;

944 
nLive
 = 0;

946 
i
=0; i<
pInfo
->
nPhø£
; i++){

947 
LcsIãøt‹
 *
pIt
 = &
aIãr
[
i
];

948 
pIt
->
pRód
 = 
	`sqlôe4Fts3EvÆPhø£Po¶i°
(
pC§
,ÖIt->
pEx¥
, 
iCﬁ
);

949 if–
pIt
->
pRód
 ){

950 
pIt
->
iPos
 =ÖIt->
iPosOff£t
;

951 
	`·s3LcsIãøt‹Adv™˚
(&
aIãr
[
i
]);

952 
nLive
++;

956  
nLive
>0 ){

957 
LcsIãøt‹
 *
pAdv
 = 0;

958 
nThisLcs
 = 0;

960 
i
=0; i<
pInfo
->
nPhø£
; i++){

961 
LcsIãøt‹
 *
pIãr
 = &
aIãr
[
i
];

962 if–
pIãr
->
pRód
==0 ){

964 
nThisLcs
 = 0;

966 if–
pAdv
==0 || 
pIãr
->
iPos
<pAdv->iPos ){

967 
pAdv
 = 
pIãr
;

969 if–
nThisLcs
==0 || 
pIãr
->
iPos
==pIter[-1].iPos ){

970 
nThisLcs
++;

972 
nThisLcs
 = 1;

974 if–
nThisLcs
>
nLcs
 )ÇLcs =ÇThisLcs;

977 if–
	`·s3LcsIãøt‹Adv™˚
(
pAdv
ËË
nLive
--;

980 
pInfo
->
aM©chöfo
[
iCﬁ
] = 
nLcs
;

983 
	`sqlôe4_‰ì
(
aIãr
);

984  
SQLITE4_OK
;

985 
	}
}

1004 
	$·s3M©chöfoVÆues
(

1005 
Fts3Curs‹
 *
pC§
,

1006 
bGlobÆ
,

1007 
M©chInfo
 *
pInfo
,

1008 c⁄° *
zArg


1010 
rc
 = 
SQLITE4_OK
;

1011 
i
;

1012 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

1013 
sqlôe4_°mt
 *
pSñe˘
 = 0;

1015 
i
=0; 
rc
==
SQLITE4_OK
 && 
zArg
[i]; i++){

1017  
zArg
[
i
] ){

1018 
FTS3_MATCHINFO_NPHRASE
:

1019 if–
bGlobÆ
 ) 
pInfo
->
aM©chöfo
[0] =ÖInfo->
nPhø£
;

1022 
FTS3_MATCHINFO_NCOL
:

1023 if–
bGlobÆ
 ) 
pInfo
->
aM©chöfo
[0] =ÖInfo->
nCﬁ
;

1026 
FTS3_MATCHINFO_NDOC
:

1027 if–
bGlobÆ
 ){

1028 
sqlôe4_öt64
 
nDoc
 = 0;

1029 
rc
 = 
	`·s3M©chöfoSñe˘Do˘ŸÆ
(
pTab
, &
pSñe˘
, &
nDoc
, 0);

1030 
pInfo
->
aM©chöfo
[0] = (
u32
)
nDoc
;

1034 
FTS3_MATCHINFO_AVGLENGTH
:

1035 if–
bGlobÆ
 ){

1036 
sqlôe4_öt64
 
nDoc
;

1037 c⁄° *
a
;

1039 
rc
 = 
	`·s3M©chöfoSñe˘Do˘ŸÆ
(
pTab
, &
pSñe˘
, &
nDoc
, &
a
);

1040 if–
rc
==
SQLITE4_OK
 ){

1041 
iCﬁ
;

1042 
iCﬁ
=0; iCﬁ<
pInfo
->
nCﬁ
; iCol++){

1043 
u32
 
iVÆ
;

1044 
sqlôe4_öt64
 
nTokí
;

1045 
a
 +
	`sqlôe4Fts3GëV¨öt
◊, &
nTokí
);

1046 
iVÆ
 = (
u32
)(((u32)(
nTokí
&0xffffffff)+
nDoc
/2)/nDoc);

1047 
pInfo
->
aM©chöfo
[
iCﬁ
] = 
iVÆ
;

1053 
FTS3_MATCHINFO_LENGTH
: {

1054 
sqlôe4_°mt
 *
pSñe˘Docsize
 = 0;

1055 
rc
 = 
	`sqlôe4Fts3Sñe˘Docsize
(
pTab
, 
pC§
->
iPªvId
, &
pSñe˘Docsize
);

1056 if–
rc
==
SQLITE4_OK
 ){

1057 
iCﬁ
;

1058 c⁄° *
a
 = 
	`sqlôe4_cﬁumn_blob
(
pSñe˘Docsize
, 0);

1059 
iCﬁ
=0; iCﬁ<
pInfo
->
nCﬁ
; iCol++){

1060 
sqlôe4_öt64
 
nTokí
;

1061 
a
 +
	`sqlôe4Fts3GëV¨öt
◊, &
nTokí
);

1062 
pInfo
->
aM©chöfo
[
iCﬁ
] = (
u32
)
nTokí
;

1065 
	`sqlôe4_ª£t
(
pSñe˘Docsize
);

1069 
FTS3_MATCHINFO_LCS
:

1070 
rc
 = 
	`·s3Ex¥LﬂdDo˛i°s
(
pC§
, 0, 0);

1071 if–
rc
==
SQLITE4_OK
 ){

1072 
rc
 = 
	`·s3M©chöfoLcs
(
pC§
, 
pInfo
);

1077 
Fts3Ex¥
 *
pEx¥
;

1078 
	`as£π
–
zArg
[
i
]==
FTS3_MATCHINFO_HITS
 );

1079 
pEx¥
 = 
pC§
->pExpr;

1080 
rc
 = 
	`·s3Ex¥LﬂdDo˛i°s
(
pC§
, 0, 0);

1081 if–
rc
!=
SQLITE4_OK
 ) ;

1082 if–
bGlobÆ
 ){

1083 if–
pC§
->
pDe„ºed
 ){

1084 
rc
 = 
	`·s3M©chöfoSñe˘Do˘ŸÆ
(
pTab
, &
pSñe˘
, &
pInfo
->
nDoc
, 0);

1085 if–
rc
!=
SQLITE4_OK
 ) ;

1087 
rc
 = 
	`·s3Ex¥Iãøã
(
pEx¥
, 
·s3Ex¥GlobÆHôsCb
,(*)
pInfo
);

1088 if–
rc
!=
SQLITE4_OK
 ) ;

1090 ()
	`·s3Ex¥Iãøã
(
pEx¥
, 
·s3Ex¥LoˇlHôsCb
,(*)
pInfo
);

1095 
pInfo
->
aM©chöfo
 +
	`·s3M©chöfoSize
’Info, 
zArg
[
i
]);

1098 
	`sqlôe4_ª£t
(
pSñe˘
);

1099  
rc
;

1100 
	}
}

1107 
	$·s3GëM©chöfo
(

1108 
Fts3Curs‹
 *
pC§
,

1109 c⁄° *
zArg


1111 
M©chInfo
 
sInfo
;

1112 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

1113 
rc
 = 
SQLITE4_OK
;

1114 
bGlobÆ
 = 0;

1116 
	`mem£t
(&
sInfo
, 0, (
M©chInfo
));

1117 
sInfo
.
pCurs‹
 = 
pC§
;

1118 
sInfo
.
nCﬁ
 = 
pTab
->
nCﬁumn
;

1123 if–
pC§
->
zM©chöfo
 && 
	`°rcmp
’C§->zM©chöfo, 
zArg
) ){

1124 
	`as£π
–
pC§
->
aM©chöfo
 );

1125 
	`sqlôe4_‰ì
(
pC§
->
aM©chöfo
);

1126 
pC§
->
zM©chöfo
 = 0;

1127 
pC§
->
aM©chöfo
 = 0;

1135 if–
pC§
->
aM©chöfo
==0 ){

1136 
nM©chöfo
 = 0;

1137 
nArg
;

1138 
i
;

1141 
pC§
->
nPhø£
 = 
	`·s3Ex¥Phø£Cou¡
’C§->
pEx¥
);

1142 
sInfo
.
nPhø£
 = 
pC§
->nPhrase;

1145 
i
=0; 
zArg
[i]; i++){

1146 
nM©chöfo
 +
	`·s3M©chöfoSize
(&
sInfo
, 
zArg
[
i
]);

1150 
nArg
 = ()
	`°æí
(
zArg
);

1151 
pC§
->
aM©chöfo
 = (
u32
 *)
	`sqlôe4_mÆloc
((u32)*
nM©chöfo
 + 
nArg
 + 1);

1152 if–!
pC§
->
aM©chöfo
 )  
SQLITE4_NOMEM
;

1154 
pC§
->
zM©chöfo
 = (*)&pC§->
aM©chöfo
[
nM©chöfo
];

1155 
pC§
->
nM©chöfo
 =ÇMatchinfo;

1156 
	`mem˝y
(
pC§
->
zM©chöfo
, 
zArg
, 
nArg
+1);

1157 
	`mem£t
(
pC§
->
aM©chöfo
, 0, (
u32
)*
nM©chöfo
);

1158 
pC§
->
isM©chöfoNìded
 = 1;

1159 
bGlobÆ
 = 1;

1162 
sInfo
.
aM©chöfo
 = 
pC§
->aMatchinfo;

1163 
sInfo
.
nPhø£
 = 
pC§
->nPhrase;

1164 if–
pC§
->
isM©chöfoNìded
 ){

1165 
rc
 = 
	`·s3M©chöfoVÆues
(
pC§
, 
bGlobÆ
, &
sInfo
, 
zArg
);

1166 
pC§
->
isM©chöfoNìded
 = 0;

1169  
rc
;

1170 
	}
}

1175 
	$sqlôe4Fts3Snù≥t
(

1176 
sqlôe4_c⁄ãxt
 *
pCtx
,

1177 
Fts3Curs‹
 *
pC§
,

1178 c⁄° *
zSèπ
,

1179 c⁄° *
zEnd
,

1180 c⁄° *
zEŒùsis
,

1181 
iCﬁ
,

1182 
nTokí


1184 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

1185 
rc
 = 
SQLITE4_OK
;

1186 
i
;

1187 
SåBuf„r
 
ªs
 = {0, 0, 0};

1197 
nSnù≥t
 = 0;

1198 
Snù≥tFøgmít
 
aSnù≥t
[4];

1199 
nFTokí
 = -1;

1201 if–!
pC§
->
pEx¥
 ){

1202 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, "", 0, 
SQLITE4_STATIC
);

1206 
nSnù≥t
=1; 1;ÇSnippet++){

1208 
iSnù
;

1209 
u64
 
mCovîed
 = 0;

1210 
u64
 
mSìn
 = 0;

1212 if–
nTokí
>=0 ){

1213 
nFTokí
 = (
nTokí
+
nSnù≥t
-1) /ÇSnippet;

1215 
nFTokí
 = -1 * 
nTokí
;

1218 
iSnù
=0; iSnù<
nSnù≥t
; iSnip++){

1219 
iBe°Sc‹e
 = -1;

1220 
iRód
;

1221 
Snù≥tFøgmít
 *
pFøgmít
 = &
aSnù≥t
[
iSnù
];

1223 
	`mem£t
(
pFøgmít
, 0, (*pFragment));

1229 
iRód
=0; iRód<
pTab
->
nCﬁumn
; iRead++){

1230 
Snù≥tFøgmít
 
sF
 = {0, 0, 0, 0};

1231 
iS
;

1232 if–
iCﬁ
>=0 && 
iRód
!=iCol ) ;

1235 
rc
 = 
	`·s3Be°Snù≥t
(
nFTokí
, 
pC§
, 
iRód
, 
mCovîed
, &
mSìn
, &
sF
, &
iS
);

1236 if–
rc
!=
SQLITE4_OK
 ){

1237 
¢ù≥t_out
;

1239 if–
iS
>
iBe°Sc‹e
 ){

1240 *
pFøgmít
 = 
sF
;

1241 
iBe°Sc‹e
 = 
iS
;

1245 
mCovîed
 |
pFøgmít
->
covîed
;

1251 
	`as£π
–(
mCovîed
&
mSìn
)==mCovered );

1252 if–
mSìn
==
mCovîed
 || 
nSnù≥t
==
	`SizeofAºay
(
aSnù≥t
) ) ;

1255 
	`as£π
–
nFTokí
>0 );

1257 
i
=0; i<
nSnù≥t
 && 
rc
==
SQLITE4_OK
; i++){

1258 
rc
 = 
	`·s3Snù≥tText
(
pC§
, &
aSnù≥t
[
i
],

1259 
i
, (i==
nSnù≥t
-1), 
nFTokí
, 
zSèπ
, 
zEnd
, 
zEŒùsis
, &
ªs


1263 
¢ù≥t_out
:

1264 
	`sqlôe4Fts3SegmítsClo£
(
pTab
);

1265 if–
rc
!=
SQLITE4_OK
 ){

1266 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

1267 
	`sqlôe4_‰ì
(
ªs
.
z
);

1269 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
ªs
.
z
, -1, 
sqlôe4_‰ì
);

1271 
	}
}

1274 
TîmOff£t
 
	tTîmOff£t
;

1275 
TîmOff£tCtx
 
	tTîmOff£tCtx
;

1277 
	sTîmOff£t
 {

1278 *
	mpLi°
;

1279 
	miPos
;

1280 
	miOff
;

1283 
	sTîmOff£tCtx
 {

1284 
Fts3Curs‹
 *
	mpC§
;

1285 
	miCﬁ
;

1286 
	miTîm
;

1287 
sqlôe4_öt64
 
	miDocid
;

1288 
TîmOff£t
 *
	maTîm
;

1294 
	$·s3Ex¥TîmOff£tInô
(
Fts3Ex¥
 *
pEx¥
, 
iPhø£
, *
˘x
){

1295 
TîmOff£tCtx
 *
p
 = (TîmOff£tCtx *)
˘x
;

1296 
nTîm
;

1297 
iTîm
;

1298 *
pLi°
;

1299 
iPos
 = 0;

1301 
	`UNUSED_PARAMETER
(
iPhø£
);

1302 
pLi°
 = 
	`sqlôe4Fts3EvÆPhø£Po¶i°
(
p
->
pC§
, 
pEx¥
,Ö->
iCﬁ
);

1303 
nTîm
 = 
pEx¥
->
pPhø£
->
nTokí
;

1304 if–
pLi°
 ){

1305 
	`·s3GëDñèPosôi⁄
(&
pLi°
, &
iPos
);

1306 
	`as£π
–
iPos
>=0 );

1309 
iTîm
=0; iTîm<
nTîm
; iTerm++){

1310 
TîmOff£t
 *
pT
 = &
p
->
aTîm
[p->
iTîm
++];

1311 
pT
->
iOff
 = 
nTîm
-
iTîm
-1;

1312 
pT
->
pLi°
 =ÖList;

1313 
pT
->
iPos
 = iPos;

1316  
SQLITE4_OK
;

1317 
	}
}

1322 
	$sqlôe4Fts3Off£ts
(

1323 
sqlôe4_c⁄ãxt
 *
pCtx
,

1324 
Fts3Curs‹
 *
pC§


1326 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

1327 
sqlôe4_tokíizî_moduÀ
 c⁄° *
pMod
 = 
pTab
->
pTokíizî
->
pModuÀ
;

1328 c⁄° *
ZDUMMY
;

1329 
NDUMMY
;

1330 
rc
;

1331 
nTokí
;

1332 
iCﬁ
;

1333 
SåBuf„r
 
ªs
 = {0, 0, 0};

1334 
TîmOff£tCtx
 
sCtx
;

1336 if–!
pC§
->
pEx¥
 ){

1337 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, "", 0, 
SQLITE4_STATIC
);

1341 
	`mem£t
(&
sCtx
, 0, (sCtx));

1342 
	`as£π
–
pC§
->
isRequúeSìk
==0 );

1345 
rc
 = 
	`·s3Ex¥LﬂdDo˛i°s
(
pC§
, 0, &
nTokí
);

1346 if–
rc
!=
SQLITE4_OK
 ) 
off£ts_out
;

1349 
sCtx
.
aTîm
 = (
TîmOff£t
 *)
	`sqlôe4_mÆloc
((TîmOff£t)*
nTokí
);

1350 if–0==
sCtx
.
aTîm
 ){

1351 
rc
 = 
SQLITE4_NOMEM
;

1352 
off£ts_out
;

1354 
sCtx
.
iDocid
 = 
pC§
->
iPªvId
;

1355 
sCtx
.
pC§
 =ÖCsr;

1360 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁumn
; iCol++){

1361 
sqlôe4_tokíizî_curs‹
 *
pC
;

1362 
iSèπ
;

1363 
iEnd
;

1364 
iCuºít
;

1365 c⁄° *
zDoc
;

1366 
nDoc
;

1372 
sCtx
.
iCﬁ
 = iCol;

1373 
sCtx
.
iTîm
 = 0;

1374 ()
	`·s3Ex¥Iãøã
(
pC§
->
pEx¥
, 
·s3Ex¥TîmOff£tInô
, (*)&
sCtx
);

1382 
zDoc
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pC§
->
pStmt
, 
iCﬁ
+1);

1383 
nDoc
 = 
	`sqlôe4_cﬁumn_byãs
(
pC§
->
pStmt
, 
iCﬁ
+1);

1384 if–
zDoc
==0 ){

1385 if–
	`sqlôe4_cﬁumn_ty≥
(
pC§
->
pStmt
, 
iCﬁ
+1)==
SQLITE4_NULL
 ){

1388 
rc
 = 
SQLITE4_NOMEM
;

1389 
off£ts_out
;

1393 
rc
 = 
pMod
->
	`xO≥n
(
pTab
->
pTokíizî
, 
zDoc
, 
nDoc
, &
pC
);

1394 if–
rc
!=
SQLITE4_OK
 ) 
off£ts_out
;

1395 
pC
->
pTokíizî
 = 
pTab
->pTokenizer;

1397 
rc
 = 
pMod
->
	`xNext
(
pC
, &
ZDUMMY
, &
NDUMMY
, &
iSèπ
, &
iEnd
, &
iCuºít
);

1398  
rc
==
SQLITE4_OK
 ){

1399 
i
;

1400 
iMöPos
 = 0x7FFFFFFF;

1401 
TîmOff£t
 *
pTîm
 = 0;

1403 
i
=0; i<
nTokí
; i++){

1404 
TîmOff£t
 *
pT
 = &
sCtx
.
aTîm
[
i
];

1405 if–
pT
->
pLi°
 && (pT->
iPos
-pT->
iOff
)<
iMöPos
 ){

1406 
iMöPos
 = 
pT
->
iPos
-pT->
iOff
;

1407 
pTîm
 = 
pT
;

1411 if–!
pTîm
 ){

1413 
rc
 = 
SQLITE4_DONE
;

1415 
	`as£π
–
iCuºít
<=
iMöPos
 );

1416 if–0==(0xFE&*
pTîm
->
pLi°
) ){

1417 
pTîm
->
pLi°
 = 0;

1419 
	`·s3GëDñèPosôi⁄
(&
pTîm
->
pLi°
, &pTîm->
iPos
);

1421  
rc
==
SQLITE4_OK
 && 
iCuºít
<
iMöPos
 ){

1422 
rc
 = 
pMod
->
	`xNext
(
pC
, &
ZDUMMY
, &
NDUMMY
, &
iSèπ
, &
iEnd
, &
iCuºít
);

1424 if–
rc
==
SQLITE4_OK
 ){

1425 
aBuf„r
[64];

1426 
	`sqlôe4_¢¥ötf
((
aBuf„r
),áBuffer,

1427 "%d %d %d %d ", 
iCﬁ
, 
pTîm
-
sCtx
.
aTîm
, 
iSèπ
, 
iEnd
-iStart

1429 
rc
 = 
	`·s3SåögAµíd
(&
ªs
, 
aBuf„r
, -1);

1430 }if–
rc
==
SQLITE4_DONE
 && 
pTab
->
zC⁄ã¡Tbl
==0 ){

1431 
rc
 = 
FTS_CORRUPT_VTAB
;

1435 if–
rc
==
SQLITE4_DONE
 ){

1436 
rc
 = 
SQLITE4_OK
;

1439 
pMod
->
	`xClo£
(
pC
);

1440 if–
rc
!=
SQLITE4_OK
 ) 
off£ts_out
;

1443 
off£ts_out
:

1444 
	`sqlôe4_‰ì
(
sCtx
.
aTîm
);

1445 
	`as£π
–
rc
!=
SQLITE4_DONE
 );

1446 
	`sqlôe4Fts3SegmítsClo£
(
pTab
);

1447 if–
rc
!=
SQLITE4_OK
 ){

1448 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

1449 
	`sqlôe4_‰ì
(
ªs
.
z
);

1451 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
ªs
.
z
,Ñes.
n
-1, 
sqlôe4_‰ì
);

1454 
	}
}

1459 
	$sqlôe4Fts3M©chöfo
(

1460 
sqlôe4_c⁄ãxt
 *
pC⁄ãxt
,

1461 
Fts3Curs‹
 *
pC§
,

1462 c⁄° *
zArg


1464 
Fts3TabÀ
 *
pTab
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

1465 
rc
;

1466 
i
;

1467 c⁄° *
zF‹m©
;

1469 if–
zArg
 ){

1470 
i
=0; 
zArg
[i]; i++){

1471 *
zEº
 = 0;

1472 if–
	`·s3M©chöfoCheck
(
pTab
, 
zArg
[
i
], &
zEº
) ){

1473 
	`sqlôe4_ªsu…_îr‹
(
pC⁄ãxt
, 
zEº
, -1);

1474 
	`sqlôe4_‰ì
(
zEº
);

1478 
zF‹m©
 = 
zArg
;

1480 
zF‹m©
 = 
FTS3_MATCHINFO_DEFAULT
;

1483 if–!
pC§
->
pEx¥
 ){

1484 
	`sqlôe4_ªsu…_blob
(
pC⁄ãxt
, "", 0, 
SQLITE4_STATIC
);

1489 
rc
 = 
	`·s3GëM©chöfo
(
pC§
, 
zF‹m©
);

1490 
	`sqlôe4Fts3SegmítsClo£
(
pTab
);

1492 if–
rc
!=
SQLITE4_OK
 ){

1493 
	`sqlôe4_ªsu…_îr‹_code
(
pC⁄ãxt
, 
rc
);

1495 
n
 = 
pC§
->
nM©chöfo
 * (
u32
);

1496 
	`sqlôe4_ªsu…_blob
(
pC⁄ãxt
, 
pC§
->
aM©chöfo
, 
n
, 
SQLITE4_TRANSIENT
);

1498 
	}
}

	@ext/fts3/fts3_term.c

18 
	~"·s3I¡.h
"

19 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

20 #ifde‡
SQLITE4_TEST


22 
	~<°rög.h
>

23 
	~<as£π.h
>

24 
	~<°dlib.h
>

26 
Fts3ãrmTabÀ
 
	tFts3ãrmTabÀ
;

27 
Fts3ãrmCurs‹
 
	tFts3ãrmCurs‹
;

29 
	sFts3ãrmTabÀ
 {

30 
sqlôe4_vèb
 
	mba£
;

31 
	miIndex
;

32 
Fts3TabÀ
 *
	mpFts3Tab
;

35 
	sFts3ãrmCurs‹
 {

36 
sqlôe4_vèb_curs‹
 
	mba£
;

37 
Fts3Mu…iSegRódî
 
	mc§
;

38 
Fts3SegFûãr
 
	mfûãr
;

40 
	misEof
;

41 *
	mpNext
;

43 
sqlôe4_öt64
 
	miRowid
;

44 
sqlôe4_öt64
 
	miDocid
;

45 
	miCﬁ
;

46 
	miPos
;

52 
	#FTS3_TERMS_SCHEMA
 "CREATE TABLE x—îm, docid, cﬁ,Öos)"

	)

59 
	$·s3ãrmC⁄√˘Mëhod
(

60 
sqlôe4
 *
db
,

61 *
pCtx
,

62 
¨gc
,

63 c⁄° * c⁄° *
¨gv
,

64 
sqlôe4_vèb
 **
µVèb
,

65 **
pzEº


67 c⁄° *
zDb
;

68 c⁄° *
zFts3
;

69 
nDb
;

70 
nFts3
;

71 
nByã
;

72 
rc
;

73 
Fts3ãrmTabÀ
 *
p
;

74 
iIndex
 = 0;

76 if–
¨gc
==5 ){

77 
iIndex
 = 
	`©oi
(
¨gv
[4]);

78 
¨gc
--;

82 if–
¨gc
!=4 ){

83 *
pzEº
 = 
	`sqlôe4_m¥ötf
(

86  
SQLITE4_ERROR
;

89 
zDb
 = 
¨gv
[1];

90 
nDb
 = 
	`°æí
(
zDb
);

91 
zFts3
 = 
¨gv
[3];

92 
nFts3
 = 
	`°æí
(
zFts3
);

94 
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
db
, 
FTS3_TERMS_SCHEMA
);

95 if–
rc
!=
SQLITE4_OK
 ) Ñc;

97 
nByã
 = (
Fts3ãrmTabÀ
Ë+ (
Fts3TabÀ
Ë+ 
nDb
 + 
nFts3
 + 2;

98 
p
 = (
Fts3ãrmTabÀ
 *)
	`sqlôe4_mÆloc
(
nByã
);

99 if–!
p
 )  
SQLITE4_NOMEM
;

100 
	`mem£t
(
p
, 0, 
nByã
);

102 
p
->
pFts3Tab
 = (
Fts3TabÀ
 *)&p[1];

103 
p
->
pFts3Tab
->
zDb
 = (*)&p->pFts3Tab[1];

104 
p
->
pFts3Tab
->
zName
 = &p->pFts3Tab->
zDb
[
nDb
+1];

105 
p
->
pFts3Tab
->
db
 = db;

106 
p
->
pFts3Tab
->
nIndex
 = 
iIndex
+1;

107 
p
->
iIndex
 = iIndex;

109 
	`mem˝y
((*)
p
->
pFts3Tab
->
zDb
, zDb, 
nDb
);

110 
	`mem˝y
((*)
p
->
pFts3Tab
->
zName
, 
zFts3
, 
nFts3
);

111 
	`sqlôe4Fts3DequŸe
((*)
p
->
pFts3Tab
->
zName
);

113 *
µVèb
 = (
sqlôe4_vèb
 *)
p
;

114  
SQLITE4_OK
;

115 
	}
}

122 
	$·s3ãrmDisc⁄√˘Mëhod
(
sqlôe4_vèb
 *
pVèb
){

123 
Fts3ãrmTabÀ
 *
p
 = (Fts3ãrmTabÀ *)
pVèb
;

124 
Fts3TabÀ
 *
pFts3
 = 
p
->
pFts3Tab
;

125 
i
;

128 
i
=0; i<
	`SizeofAºay
(
pFts3
->
aStmt
); i++){

129 
	`sqlôe4_föÆize
(
pFts3
->
aStmt
[
i
]);

131 
	`sqlôe4_‰ì
(
pFts3
->
zSegmítsTbl
);

132 
	`sqlôe4_‰ì
(
p
);

133  
SQLITE4_OK
;

134 
	}
}

136 
	#FTS4AUX_EQ_CONSTRAINT
 1

	)

137 
	#FTS4AUX_GE_CONSTRAINT
 2

	)

138 
	#FTS4AUX_LE_CONSTRAINT
 4

	)

143 
	$·s3ãrmBe°IndexMëhod
(

144 
sqlôe4_vèb
 *
pVTab
,

145 
sqlôe4_ödex_öfo
 *
pInfo


147 
	`UNUSED_PARAMETER
(
pVTab
);

150 if–
pInfo
->
nOrdîBy
 ){

151 
i
;

152 
i
=0; i<
pInfo
->
nOrdîBy
; i++){

153 if–
pInfo
->
aOrdîBy
[
i
].
iCﬁumn
!=ò||ÖInfo->aOrdîBy[i].
desc
 ) ;

155 if–
i
==
pInfo
->
nOrdîBy
 ){

156 
pInfo
->
‹dîByC⁄sumed
 = 1;

160  
SQLITE4_OK
;

161 
	}
}

166 
	$·s3ãrmO≥nMëhod
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µC§
){

167 
Fts3ãrmCurs‹
 *
pC§
;

169 
	`UNUSED_PARAMETER
(
pVTab
);

171 
pC§
 = (
Fts3ãrmCurs‹
 *)
	`sqlôe4_mÆloc
((Fts3termCursor));

172 if–!
pC§
 )  
SQLITE4_NOMEM
;

173 
	`mem£t
(
pC§
, 0, (
Fts3ãrmCurs‹
));

175 *
µC§
 = (
sqlôe4_vèb_curs‹
 *)
pC§
;

176  
SQLITE4_OK
;

177 
	}
}

182 
	$·s3ãrmClo£Mëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

183 
Fts3TabÀ
 *
pFts3
 = ((
Fts3ãrmTabÀ
 *)
pCurs‹
->
pVèb
)->
pFts3Tab
;

184 
Fts3ãrmCurs‹
 *
pC§
 = (Fts3ãrmCurs‹ *)
pCurs‹
;

186 
	`sqlôe4Fts3SegmítsClo£
(
pFts3
);

187 
	`sqlôe4Fts3SegRódîFöish
(&
pC§
->
c§
);

188 
	`sqlôe4_‰ì
(
pC§
);

189  
SQLITE4_OK
;

190 
	}
}

195 
	$·s3ãrmNextMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

196 
Fts3ãrmCurs‹
 *
pC§
 = (Fts3ãrmCurs‹ *)
pCurs‹
;

197 
Fts3TabÀ
 *
pFts3
 = ((
Fts3ãrmTabÀ
 *)
pCurs‹
->
pVèb
)->
pFts3Tab
;

198 
rc
;

199 
sqlôe4_öt64
 
v
;

202 
pC§
->
iRowid
++;

205 if–
pC§
->
c§
.
aDo˛i°
==0

206 || 
pC§
->
pNext
>=&pC§->
c§
.
aDo˛i°
[pC§->c§.
nDo˛i°
-1]

208 
rc
 = 
	`sqlôe4Fts3SegRódîSãp
(
pFts3
, &
pC§
->
c§
);

209 if–
rc
!=
SQLITE4_ROW
 ){

210 
pC§
->
isEof
 = 1;

211  
rc
;

214 
pC§
->
iCﬁ
 = 0;

215 
pC§
->
iPos
 = 0;

216 
pC§
->
iDocid
 = 0;

217 
pC§
->
pNext
 =ÖC§->
c§
.
aDo˛i°
;

220 
pC§
->
pNext
 +
	`sqlôe4Fts3GëV¨öt
’C§->pNext, &pC§->
iDocid
);

223 
pC§
->
pNext
 +
	`sqlôe4Fts3GëV¨öt
’C§->pNext, &
v
);

224 if–
v
==0 ){

225 
pC§
->
pNext
 +
	`sqlôe4Fts3GëV¨öt
’C§->pNext, &
v
);

226 
pC§
->
iDocid
 +
v
;

227 
pC§
->
pNext
 +
	`sqlôe4Fts3GëV¨öt
’C§->pNext, &
v
);

228 
pC§
->
iCﬁ
 = 0;

229 
pC§
->
iPos
 = 0;

232 if–
v
==1 ){

233 
pC§
->
pNext
 +
	`sqlôe4Fts3GëV¨öt
’C§->pNext, &
v
);

234 
pC§
->
iCﬁ
 +
v
;

235 
pC§
->
iPos
 = 0;

236 
pC§
->
pNext
 +
	`sqlôe4Fts3GëV¨öt
’C§->pNext, &
v
);

239 
pC§
->
iPos
 +(
v
 - 2);

241  
SQLITE4_OK
;

242 
	}
}

247 
	$·s3ãrmFûãrMëhod
(

248 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

249 
idxNum
,

250 c⁄° *
idxSå
,

251 
nVÆ
,

252 
sqlôe4_vÆue
 **
≠VÆ


254 
Fts3ãrmCurs‹
 *
pC§
 = (Fts3ãrmCurs‹ *)
pCurs‹
;

255 
Fts3ãrmTabÀ
 *
p
 = (Fts3ãrmTabÀ *)
pCurs‹
->
pVèb
;

256 
Fts3TabÀ
 *
pFts3
 = 
p
->
pFts3Tab
;

257 
rc
;

259 
	`UNUSED_PARAMETER
(
nVÆ
);

260 
	`UNUSED_PARAMETER
(
idxNum
);

261 
	`UNUSED_PARAMETER
(
idxSå
);

262 
	`UNUSED_PARAMETER
(
≠VÆ
);

264 
	`as£π
–
idxSå
==0 && 
idxNum
==0 );

267 
	`ã°ˇ£
(
pC§
->
fûãr
.
zTîm
);

268 
	`sqlôe4Fts3SegRódîFöish
(&
pC§
->
c§
);

269 
	`mem£t
(&
pC§
->
c§
, 0, ((
u8
*)&pCsr[1]) - (u8*)&pCsr->csr);

271 
pC§
->
fûãr
.
Êags
 = 
FTS3_SEGMENT_REQUIRE_POS
|
FTS3_SEGMENT_IGNORE_EMPTY
;

272 
pC§
->
fûãr
.
Êags
 |
FTS3_SEGMENT_SCAN
;

274 
rc
 = 
	`sqlôe4Fts3SegRódîCurs‹
(
pFts3
, 
p
->
iIndex
, 
FTS3_SEGCURSOR_ALL
,

275 
pC§
->
fûãr
.
zTîm
,ÖC§->fûãr.
nTîm
, 0, 1, &pC§->
c§


277 if–
rc
==
SQLITE4_OK
 ){

278 
rc
 = 
	`sqlôe4Fts3SegRódîSèπ
(
pFts3
, &
pC§
->
c§
, &pC§->
fûãr
);

280 if–
rc
==
SQLITE4_OK
 ){

281 
rc
 = 
	`·s3ãrmNextMëhod
(
pCurs‹
);

283  
rc
;

284 
	}
}

289 
	$·s3ãrmEofMëhod
(
sqlôe4_vèb_curs‹
 *
pCurs‹
){

290 
Fts3ãrmCurs‹
 *
pC§
 = (Fts3ãrmCurs‹ *)
pCurs‹
;

291  
pC§
->
isEof
;

292 
	}
}

297 
	$·s3ãrmCﬁumnMëhod
(

298 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

299 
sqlôe4_c⁄ãxt
 *
pCtx
,

300 
iCﬁ


302 
Fts3ãrmCurs‹
 *
p
 = (Fts3ãrmCurs‹ *)
pCurs‹
;

304 
	`as£π
–
iCﬁ
>=0 && iCol<=3 );

305  
iCﬁ
 ){

307 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
p
->
c§
.
zTîm
,Ö->c§.
nTîm
, 
SQLITE4_TRANSIENT
);

310 
	`sqlôe4_ªsu…_öt64
(
pCtx
, 
p
->
iDocid
);

313 
	`sqlôe4_ªsu…_öt64
(
pCtx
, 
p
->
iCﬁ
);

316 
	`sqlôe4_ªsu…_öt64
(
pCtx
, 
p
->
iPos
);

320  
SQLITE4_OK
;

321 
	}
}

326 
	$·s3ãrmRowidMëhod
(

327 
sqlôe4_vèb_curs‹
 *
pCurs‹
,

328 
sqlôe_öt64
 *
pRowid


330 
Fts3ãrmCurs‹
 *
pC§
 = (Fts3ãrmCurs‹ *)
pCurs‹
;

331 *
pRowid
 = 
pC§
->
iRowid
;

332  
SQLITE4_OK
;

333 
	}
}

339 
	$sqlôe4Fts3InôTîm
(
sqlôe4
 *
db
){

340 c⁄° 
sqlôe4_moduÀ
 
·s3ãrm_moduÀ
 = {

342 
·s3ãrmC⁄√˘Mëhod
,

343 
·s3ãrmC⁄√˘Mëhod
,

344 
·s3ãrmBe°IndexMëhod
,

345 
·s3ãrmDisc⁄√˘Mëhod
,

346 
·s3ãrmDisc⁄√˘Mëhod
,

347 
·s3ãrmO≥nMëhod
,

348 
·s3ãrmClo£Mëhod
,

349 
·s3ãrmFûãrMëhod
,

350 
·s3ãrmNextMëhod
,

351 
·s3ãrmEofMëhod
,

352 
·s3ãrmCﬁumnMëhod
,

353 
·s3ãrmRowidMëhod
,

362 
rc
;

364 
rc
 = 
	`sqlôe4_¸óã_moduÀ
(
db
, "·s4ãrm", &
·s3ãrm_moduÀ
, 0);

365  
rc
;

366 
	}
}

	@ext/fts3/fts3_test.c

18 
	~<t˛.h
>

19 
	~<°rög.h
>

20 
	~<as£π.h
>

22 #ifde‡
SQLITE4_TEST


25 
	~"·s3I¡.h
"

27 
	#NM_MAX_TOKEN
 12

	)

29 
NórPhø£
 
	tNórPhø£
;

30 
NórDocumít
 
	tNórDocumít
;

31 
NórTokí
 
	tNórTokí
;

33 
	sNórDocumít
 {

34 
	mnTokí
;

35 
NórTokí
 *
	maTokí
;

38 
	sNórTokí
 {

39 
	mn
;

40 c⁄° *
	mz
;

43 
	sNórPhø£
 {

44 
	mnNór
;

45 
	mnTokí
;

46 
NórTokí
 
	maTokí
[
NM_MAX_TOKEN
];

49 
	$nm_phø£_m©ch
(

50 
NórPhø£
 *
p
,

51 
NórTokí
 *
aTokí


53 
ii
;

55 
ii
=0; ii<
p
->
nTokí
; ii++){

56 
NórTokí
 *
pTokí
 = &
p
->
aTokí
[
ii
];

57 if–
pTokí
->
n
>0 &&ÖTokí->
z
[pToken->n-1]=='*' ){

58 if–
aTokí
[
ii
].
n
<(
pTokí
->n-1) )  0;

59 if–
	`memcmp
(
aTokí
[
ii
].
z
, 
pTokí
->z,ÖTokí->
n
-1) )  0;

61 if–
aTokí
[
ii
].
n
!=
pTokí
->n )  0;

62 if–
	`memcmp
(
aTokí
[
ii
].
z
, 
pTokí
->z,ÖTokí->
n
) )  0;

67 
	}
}

69 
	$nm_√¨_chaö
(

70 
iDú
,

71 
NórDocumít
 *
pDoc
,

72 
iPos
,

73 
nPhø£
,

74 
NórPhø£
 *
aPhø£
,

75 
iPhø£


77 
iSèπ
;

78 
iSt›
;

79 
ii
;

80 
nNór
;

81 
iPhø£2
;

82 
NórPhø£
 *
p
;

83 
NórPhø£
 *
pPªv
;

85 
	`as£π
–
iDú
==1 || iDir==-1 );

87 if–
iDú
==1 ){

88 if–(
iPhø£
+1)==
nPhø£
 )  1;

89 
nNór
 = 
aPhø£
[
iPhø£
+1].nNear;

91 if–
iPhø£
==0 )  1;

92 
nNór
 = 
aPhø£
[
iPhø£
].nNear;

94 
pPªv
 = &
aPhø£
[
iPhø£
];

95 
iPhø£2
 = 
iPhø£
+
iDú
;

96 
p
 = &
aPhø£
[
iPhø£2
];

98 
iSèπ
 = 
iPos
 - 
nNór
 - 
p
->
nTokí
;

99 
iSt›
 = 
iPos
 + 
nNór
 + 
pPªv
->
nTokí
;

101 if–
iSèπ
<0 ) iStart = 0;

102 if–
iSt›
 > 
pDoc
->
nTokí
 - 
p
->nToken ) iStop =ÖDoc->nToken -Ö->nToken;

104 
ii
=
iSèπ
; ii<=
iSt›
; ii++){

105 if–
	`nm_phø£_m©ch
(
p
, &
pDoc
->
aTokí
[
ii
]) ){

106 if–
	`nm_√¨_chaö
(
iDú
, 
pDoc
, 
ii
, 
nPhø£
, 
aPhø£
, 
iPhø£2
) )  1;

111 
	}
}

113 
	$nm_m©ch_cou¡
(

114 
NórDocumít
 *
pDoc
,

115 
nPhø£
,

116 
NórPhø£
 *
aPhø£
,

117 
iPhø£


119 
nOcc
 = 0;

120 
ii
;

121 
NórPhø£
 *
p
 = &
aPhø£
[
iPhø£
];

123 
ii
=0; ii<(
pDoc
->
nTokí
 + 1 - 
p
->nToken); ii++){

124 if–
	`nm_phø£_m©ch
(
p
, &
pDoc
->
aTokí
[
ii
]) ){

126 if–0==
	`nm_√¨_chaö
(1, 
pDoc
, 
ii
, 
nPhø£
, 
aPhø£
, 
iPhø£
) ) ;

129 if–0==
	`nm_√¨_chaö
(-1, 
pDoc
, 
ii
, 
nPhø£
, 
aPhø£
, 
iPhø£
) ) ;

132 
nOcc
++;

136  
nOcc
;

137 
	}
}

142 
	$·s3_√¨_m©ch_cmd
(

143 
Clõ¡D©a
 
˛õ¡D©a
,

144 
T˛_I¡îp
 *
öãΩ
,

145 
objc
,

146 
T˛_Obj
 *
CONST
 
objv
[]

148 
nTŸÆ
 = 0;

149 
rc
;

150 
ii
;

151 
nPhø£
;

152 
NórPhø£
 *
aPhø£
 = 0;

153 
NórDocumít
 
doc
 = {0, 0};

154 
T˛_Obj
 **
≠DocTokí
;

155 
T˛_Obj
 *
pRë
;

156 
T˛_Obj
 *
pPhø£cou¡
 = 0;

158 
T˛_Obj
 **
≠Ex¥Tokí
;

159 
nEx¥Tokí
;

162 if–
objc
<3 || (objc%2)==0 ){

163 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DOCUMENT EXPR ?OPTION VALUE?...");

164 
rc
 = 
TCL_ERROR
;

165 
√¨_m©ch_out
;

168 
ii
=3; ii<
objc
; ii+=2){

169 
	eNM_íum
 { 
NM_PHRASECOUNTS
 };

170 
	sTe°nmSubcmd
 {

171 *
zName
;

172 
NM_íum
 
eO±
;

173 } 
aO±
[] = {

174 { "-phø£cou¡v¨", 
NM_PHRASECOUNTS
 },

177 
iO±
;

178 if–
	`T˛_GëIndexFromObjSåu˘
(

179 
öãΩ
, 
objv
[
ii
], 
aO±
, ◊O±[0]), "›ti⁄", 0, &
iO±
)

181  
TCL_ERROR
;

184  
aO±
[
iO±
].
eO±
 ){

185 
NM_PHRASECOUNTS
:

186 
pPhø£cou¡
 = 
objv
[
ii
+1];

191 
rc
 = 
	`T˛_Li°ObjGëEÀmíts
(
öãΩ
, 
objv
[1], &
doc
.
nTokí
, &
≠DocTokí
);

192 if–
rc
!=
TCL_OK
 ) 
√¨_m©ch_out
;

193 
doc
.
aTokí
 = (
NórTokí
 *)
	`ckÆloc
(doc.
nTokí
*(NearToken));

194 
ii
=0; ii<
doc
.
nTokí
; ii++){

195 
doc
.
aTokí
[
ii
].
z
 = 
	`T˛_GëSåögFromObj
(
≠DocTokí
[ii], &doc.aTokí[ii].
n
);

198 
rc
 = 
	`T˛_Li°ObjGëEÀmíts
(
öãΩ
, 
objv
[2], &
nEx¥Tokí
, &
≠Ex¥Tokí
);

199 if–
rc
!=
TCL_OK
 ) 
√¨_m©ch_out
;

201 
nPhø£
 = (
nEx¥Tokí
 + 1) / 2;

202 
aPhø£
 = (
NórPhø£
 *)
	`ckÆloc
(
nPhø£
 * (NearPhrase));

203 
	`mem£t
(
aPhø£
, 0, 
nPhø£
 * (
NórPhø£
));

204 
ii
=0; ii<
nPhø£
; ii++){

205 
T˛_Obj
 *
pPhø£
 = 
≠Ex¥Tokí
[
ii
*2];

206 
T˛_Obj
 **
≠Tokí
;

207 
nTokí
;

208 
jj
;

210 
rc
 = 
	`T˛_Li°ObjGëEÀmíts
(
öãΩ
, 
pPhø£
, &
nTokí
, &
≠Tokí
);

211 if–
rc
!=
TCL_OK
 ) 
√¨_m©ch_out
;

212 if–
nTokí
>
NM_MAX_TOKEN
 ){

213 
	`T˛_AµídResu…
(
öãΩ
, "Too manyÅokens inÖhrase", 0);

214 
rc
 = 
TCL_ERROR
;

215 
√¨_m©ch_out
;

217 
jj
=0; jj<
nTokí
; jj++){

218 
NórTokí
 *
pT
 = &
aPhø£
[
ii
].
aTokí
[
jj
];

219 
pT
->
z
 = 
	`T˛_GëSåögFromObj
(
≠Tokí
[
jj
], &pT->
n
);

221 
aPhø£
[
ii
].
nTokí
 =ÇToken;

223 
ii
=1; ii<
nPhø£
; ii++){

224 
T˛_Obj
 *
pNór
 = 
≠Ex¥Tokí
[2*
ii
-1];

225 
nNór
;

226 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
pNór
, &
nNór
);

227 if–
rc
!=
TCL_OK
 ) 
√¨_m©ch_out
;

228 
aPhø£
[
ii
].
nNór
 =ÇNear;

231 
pRë
 = 
	`T˛_NewObj
();

232 
	`T˛_In¸RefCou¡
(
pRë
);

233 
ii
=0; ii<
nPhø£
; ii++){

234 
nOcc
 = 
	`nm_m©ch_cou¡
(&
doc
, 
nPhø£
, 
aPhø£
, 
ii
);

235 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
nOcc
));

236 
nTŸÆ
 +
nOcc
;

238 if–
pPhø£cou¡
 ){

239 
	`T˛_ObjSëV¨2
(
öãΩ
, 
pPhø£cou¡
, 0, 
pRë
, 0);

241 
	`T˛_De¸RefCou¡
(
pRë
);

242 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
nTŸÆ
>0));

244 
√¨_m©ch_out
:

245 
	`ck‰ì
((*)
aPhø£
);

246 
	`ck‰ì
((*)
doc
.
aTokí
);

247  
rc
;

248 
	}
}

275 
	$·s3_c⁄figuª_ö¸_lﬂd_cmd
(

276 
Clõ¡D©a
 
˛õ¡D©a
,

277 
T˛_I¡îp
 *
öãΩ
,

278 
objc
,

279 
T˛_Obj
 *
CONST
 
objv
[]

281 #ifde‡
SQLITE4_ENABLE_FTS3


282 
ã°_·s3_node_chunksize
;

283 
ã°_·s3_node_chunk_thªshﬁd
;

284 
T˛_Obj
 *
pRë
;

286 if–
objc
!=1 && objc!=3 ){

287 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "?CHUNKSIZE THRESHOLD?");

288  
TCL_ERROR
;

291 
pRë
 = 
	`T˛_NewObj
();

292 
	`T˛_In¸RefCou¡
(
pRë
);

293 
	`T˛_Li°ObjAµídEÀmít
(

294 
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
ã°_·s3_node_chunksize
));

295 
	`T˛_Li°ObjAµídEÀmít
(

296 
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
ã°_·s3_node_chunk_thªshﬁd
));

298 if–
objc
==3 ){

299 
iArg1
;

300 
iArg2
;

301 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
iArg1
)

302 || 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
iArg2
)

304 
	`T˛_De¸RefCou¡
(
pRë
);

305  
TCL_ERROR
;

307 
ã°_·s3_node_chunksize
 = 
iArg1
;

308 
ã°_·s3_node_chunk_thªshﬁd
 = 
iArg2
;

311 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

312 
	`T˛_De¸RefCou¡
(
pRë
);

314  
TCL_OK
;

315 
	}
}

317 
	$Sqlôëe°·s3_Inô
(
T˛_I¡îp
 *
öãΩ
){

318 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "·s3_√¨_m©ch", 
·s3_√¨_m©ch_cmd
, 0, 0);

319 
	`T˛_Cª©eObjComm™d
(
öãΩ
,

320 "·s3_c⁄figuª_ö¸_lﬂd", 
·s3_c⁄figuª_ö¸_lﬂd_cmd
, 0, 0

322  
TCL_OK
;

323 
	}
}

	@ext/fts3/fts3_tokenizer.c

26 
	~"·s3I¡.h
"

27 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

29 
	~<as£π.h
>

30 
	~<°rög.h
>

52 
	$sˇœrFunc
(

53 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

54 
¨gc
,

55 
sqlôe4_vÆue
 **
¨gv


57 
Fts3Hash
 *
pHash
;

58 *
pPå
 = 0;

59 c⁄° *
zName
;

60 
nName
;

62 
	`as£π
–
¨gc
==1 ||árgc==2 );

64 
pHash
 = (
Fts3Hash
 *)
	`sqlôe4_u£r_d©a
(
c⁄ãxt
);

66 
zName
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

67 
nName
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[0])+1;

69 if–
¨gc
==2 ){

70 *
pOld
;

71 
n
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[1]);

72 if–
n
!=(
pPå
) ){

73 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "argumentÅype mismatch", -1);

76 
pPå
 = *(**)
	`sqlôe4_vÆue_blob
(
¨gv
[1]);

77 
pOld
 = 
	`sqlôe4Fts3HashIn£π
(
pHash
, (*)
zName
, 
nName
, 
pPå
);

78 if–
pOld
==
pPå
 ){

79 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "out of memory", -1);

83 
pPå
 = 
	`sqlôe4Fts3HashFöd
(
pHash
, 
zName
, 
nName
);

84 if–!
pPå
 ){

85 *
zEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
zName
);

86 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

87 
	`sqlôe4_‰ì
(
zEº
);

92 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, (*)&
pPå
, ’På), 
SQLITE4_TRANSIENT
);

93 
	}
}

95 
	$sqlôe4Fts3IsIdCh¨
(
c
){

96 c⁄° 
isFtsIdCh¨
[] = {

106  (
c
&0x80 || 
isFtsIdCh¨
[()(c)]);

107 
	}
}

109 c⁄° *
	$sqlôe4Fts3NextTokí
(c⁄° *
zSå
, *
≤
){

110 c⁄° *
z1
;

111 c⁄° *
z2
 = 0;

114 
z1
 = 
zSå
;

115  
z2
==0 ){

116 
c
 = *
z1
;

117  
c
 ){

122 
z2
 = 
z1
;

123  *++
z2
 && (*z2!=
c
 || *++z2==c) );

127 
z2
 = &
z1
[1];

128  *
z2
 && z2[0]!=']' ) z2++;

129 if–*
z2
 ) z2++;

133 if–
	`sqlôe4Fts3IsIdCh¨
(*
z1
) ){

134 
z2
 = &
z1
[1];

135  
	`sqlôe4Fts3IsIdCh¨
(*
z2
) ) z2++;

137 
z1
++;

142 *
≤
 = ()(
z2
-
z1
);

143  
z1
;

144 
	}
}

146 
	$sqlôe4Fts3InôTokíizî
(

147 
Fts3Hash
 *
pHash
,

148 c⁄° *
zArg
,

149 
sqlôe4_tokíizî
 **
µTok
,

150 **
pzEº


152 
rc
;

153 *
z
 = (*)
zArg
;

154 
n
 = 0;

155 *
zC›y
;

156 *
zEnd
;

157 
sqlôe4_tokíizî_moduÀ
 *
m
;

159 
zC›y
 = 
	`sqlôe4_m¥ötf
("%s", 
zArg
);

160 if–!
zC›y
 )  
SQLITE4_NOMEM
;

161 
zEnd
 = &
zC›y
[
	`°æí
(zCopy)];

163 
z
 = (*)
	`sqlôe4Fts3NextTokí
(
zC›y
, &
n
);

164 
z
[
n
] = '\0';

165 
	`sqlôe4Fts3DequŸe
(
z
);

167 
m
 = (
sqlôe4_tokíizî_moduÀ
 *)
	`sqlôe4Fts3HashFöd
(
pHash
,
z
,()
	`°æí
(z)+1);

168 if–!
m
 ){

169 *
pzEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
z
);

170 
rc
 = 
SQLITE4_ERROR
;

172 c⁄° **
aArg
 = 0;

173 
iArg
 = 0;

174 
z
 = &z[
n
+1];

175  
z
<
zEnd
 && (
NULL
!=(z = (*)
	`sqlôe4Fts3NextTokí
(z, &
n
))) ){

176 
nNew
 = (*)*(
iArg
+1);

177 c⁄° **
aNew
 = (c⁄° **)
	`sqlôe4_ªÆloc
((*)
aArg
, 
nNew
);

178 if–!
aNew
 ){

179 
	`sqlôe4_‰ì
(
zC›y
);

180 
	`sqlôe4_‰ì
((*)
aArg
);

181  
SQLITE4_NOMEM
;

183 
aArg
 = 
aNew
;

184 
aArg
[
iArg
++] = 
z
;

185 
z
[
n
] = '\0';

186 
	`sqlôe4Fts3DequŸe
(
z
);

187 
z
 = &z[
n
+1];

189 
rc
 = 
m
->
	`xCª©e
(
iArg
, 
aArg
, 
µTok
);

190 
	`as£π
–
rc
!=
SQLITE4_OK
 || *
µTok
 );

191 if–
rc
!=
SQLITE4_OK
 ){

192 *
pzEº
 = 
	`sqlôe4_m¥ötf
("unknownÅokenizer");

194 (*
µTok
)->
pModuÀ
 = 
m
;

196 
	`sqlôe4_‰ì
((*)
aArg
);

199 
	`sqlôe4_‰ì
(
zC›y
);

200  
rc
;

201 
	}
}

204 #ifde‡
SQLITE4_TEST


206 
	~<t˛.h
>

207 
	~<°rög.h
>

235 
	$ã°Func
(

236 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

237 
¨gc
,

238 
sqlôe4_vÆue
 **
¨gv


240 
Fts3Hash
 *
pHash
;

241 
sqlôe4_tokíizî_moduÀ
 *
p
;

242 
sqlôe4_tokíizî
 *
pTokíizî
 = 0;

243 
sqlôe4_tokíizî_curs‹
 *
pC§
 = 0;

245 c⁄° *
zEº
 = 0;

247 c⁄° *
zName
;

248 
nName
;

249 c⁄° *
zI≈ut
;

250 
nI≈ut
;

252 c⁄° *
zArg
 = 0;

254 c⁄° *
zTokí
;

255 
nTokí
;

256 
iSèπ
;

257 
iEnd
;

258 
iPos
;

260 
T˛_Obj
 *
pRë
;

262 
	`as£π
–
¨gc
==2 ||árgc==3 );

264 
nName
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[0]);

265 
zName
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

266 
nI≈ut
 = 
	`sqlôe4_vÆue_byãs
(
¨gv
[
¨gc
-1]);

267 
zI≈ut
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[
¨gc
-1]);

269 if–
¨gc
==3 ){

270 
zArg
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

273 
pHash
 = (
Fts3Hash
 *)
	`sqlôe4_u£r_d©a
(
c⁄ãxt
);

274 
p
 = (
sqlôe4_tokíizî_moduÀ
 *)
	`sqlôe4Fts3HashFöd
(
pHash
, 
zName
, 
nName
+1);

276 if–!
p
 ){

277 *
zEº
 = 
	`sqlôe4_m¥ötf
("unknow¿tokíizî: %s", 
zName
);

278 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

279 
	`sqlôe4_‰ì
(
zEº
);

283 
pRë
 = 
	`T˛_NewObj
();

284 
	`T˛_In¸RefCou¡
(
pRë
);

286 if–
SQLITE4_OK
!=
p
->
	`xCª©e
(
zArg
 ? 1 : 0, &zArg, &
pTokíizî
) ){

287 
zEº
 = "error in xCreate()";

288 
föish
;

290 
pTokíizî
->
pModuÀ
 = 
p
;

291 if–
SQLITE4_OK
!=
p
->
	`xO≥n
(
pTokíizî
, 
zI≈ut
, 
nI≈ut
, &
pC§
) ){

292 
zEº
 = "error in xOpen()";

293 
föish
;

295 
pC§
->
pTokíizî
 =ÖTokenizer;

297  
SQLITE4_OK
==
p
->
	`xNext
(
pC§
, &
zTokí
, &
nTokí
, &
iSèπ
, &
iEnd
, &
iPos
) ){

298 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewI¡Obj
(
iPos
));

299 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewSåögObj
(
zTokí
, 
nTokí
));

300 
zTokí
 = &
zI≈ut
[
iSèπ
];

301 
nTokí
 = 
iEnd
-
iSèπ
;

302 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewSåögObj
(
zTokí
, 
nTokí
));

305 if–
SQLITE4_OK
!=
p
->
	`xClo£
(
pC§
) ){

306 
zEº
 = "error in xClose()";

307 
föish
;

309 if–
SQLITE4_OK
!=
p
->
	`xDe°roy
(
pTokíizî
) ){

310 
zEº
 = "error in xDestroy()";

311 
föish
;

314 
föish
:

315 if–
zEº
 ){

316 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

318 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
	`T˛_GëSåög
(
pRë
), -1, 
SQLITE4_TRANSIENT
);

320 
	`T˛_De¸RefCou¡
(
pRë
);

321 
	}
}

324 
	$ªgi°îTokíizî
(

325 
sqlôe4
 *
db
,

326 *
zName
,

327 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
p


329 
rc
;

330 
sqlôe4_°mt
 *
pStmt
;

331 c⁄° 
zSql
[] = "SELECT fts3_tokenizer(?, ?)";

333 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, 0);

334 if–
rc
!=
SQLITE4_OK
 ){

335  
rc
;

338 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zName
, -1, 
SQLITE4_STATIC
);

339 
	`sqlôe4_böd_blob
(
pStmt
, 2, &
p
, ’), 
SQLITE4_STATIC
);

340 
	`sqlôe4_°ï
(
pStmt
);

342  
	`sqlôe4_föÆize
(
pStmt
);

343 
	}
}

346 
	$quîyTokíizî
(

347 
sqlôe4
 *
db
,

348 *
zName
,

349 c⁄° 
sqlôe4_tokíizî_moduÀ
 **
µ


351 
rc
;

352 
sqlôe4_°mt
 *
pStmt
;

353 c⁄° 
zSql
[] = "SELECT fts3_tokenizer(?)";

355 *
µ
 = 0;

356 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, 0);

357 if–
rc
!=
SQLITE4_OK
 ){

358  
rc
;

361 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zName
, -1, 
SQLITE4_STATIC
);

362 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

363 if–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0)==
SQLITE4_BLOB
 ){

364 
	`mem˝y
((*)
µ
, 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0), (*pp));

368  
	`sqlôe4_föÆize
(
pStmt
);

369 
	}
}

371 
sqlôe4Fts3Sim∂eTokíizîModuÀ
(
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ
);

391 
	$ötTe°Func
(

392 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

393 
¨gc
,

394 
sqlôe4_vÆue
 **
¨gv


396 
rc
;

397 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
p1
;

398 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
p2
;

399 
sqlôe4
 *
db
 = (sqlôe4 *)
	`sqlôe4_u£r_d©a
(
c⁄ãxt
);

401 
	`UNUSED_PARAMETER
(
¨gc
);

402 
	`UNUSED_PARAMETER
(
¨gv
);

405 
	`sqlôe4Fts3Sim∂eTokíizîModuÀ
(&
p1
);

406 
rc
 = 
	`quîyTokíizî
(
db
, "sim∂e", &
p2
);

407 
	`as£π
–
rc
==
SQLITE4_OK
 );

408 
	`as£π
–
p1
==
p2
 );

409 
rc
 = 
	`quîyTokíizî
(
db
, "nosuchtokíizî", &
p2
);

410 
	`as£π
–
rc
==
SQLITE4_ERROR
 );

411 
	`as£π
–
p2
==0 );

412 
	`as£π
–0==
	`°rcmp
(
	`sqlôe4_îrmsg
(
db
), "unknownÅokenizer:Çosuchtokenizer") );

415 
rc
 = 
	`ªgi°îTokíizî
(
db
, "nosuchtokíizî", 
p1
);

416 
	`as£π
–
rc
==
SQLITE4_OK
 );

417 
rc
 = 
	`quîyTokíizî
(
db
, "nosuchtokíizî", &
p2
);

418 
	`as£π
–
rc
==
SQLITE4_OK
 );

419 
	`as£π
–
p2
==
p1
 );

421 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, "ok", -1, 
SQLITE4_STATIC
);

422 
	}
}

443 
	$sqlôe4Fts3InôHashTabÀ
(

444 
sqlôe4
 *
db
,

445 
Fts3Hash
 *
pHash
,

446 c⁄° *
zName


448 
rc
 = 
SQLITE4_OK
;

449 *
p
 = (*)
pHash
;

450 c⁄° 
™y
 = 
SQLITE4_ANY
;

452 #ifde‡
SQLITE4_TEST


453 *
zTe°
 = 0;

454 *
zTe°2
 = 0;

455 *
pdb
 = (*)
db
;

456 
zTe°
 = 
	`sqlôe4_m¥ötf
("%s_ã°", 
zName
);

457 
zTe°2
 = 
	`sqlôe4_m¥ötf
("%s_öã∫Æ_ã°", 
zName
);

458 if–!
zTe°
 || !
zTe°2
 ){

459 
rc
 = 
SQLITE4_NOMEM
;

463 if–
SQLITE4_OK
==
rc
 ){

464 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zName
, 1, 
™y
, 
p
, 
sˇœrFunc
, 0, 0);

466 if–
SQLITE4_OK
==
rc
 ){

467 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zName
, 2, 
™y
, 
p
, 
sˇœrFunc
, 0, 0);

469 #ifde‡
SQLITE4_TEST


470 if–
SQLITE4_OK
==
rc
 ){

471 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zTe°
, 2, 
™y
, 
p
, 
ã°Func
, 0, 0);

473 if–
SQLITE4_OK
==
rc
 ){

474 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zTe°
, 3, 
™y
, 
p
, 
ã°Func
, 0, 0);

476 if–
SQLITE4_OK
==
rc
 ){

477 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zTe°2
, 0, 
™y
, 
pdb
, 
ötTe°Func
, 0, 0);

481 #ifde‡
SQLITE4_TEST


482 
	`sqlôe4_‰ì
(
zTe°
);

483 
	`sqlôe4_‰ì
(
zTe°2
);

486  
rc
;

487 
	}
}

	@ext/fts3/fts3_tokenizer.h

20 #i‚de‡
_FTS3_TOKENIZER_H_


21 
	#_FTS3_TOKENIZER_H_


	)

27 
	~"sqlôe4.h
"

48 
sqlôe4_tokíizî_moduÀ
 
	tsqlôe4_tokíizî_moduÀ
;

49 
sqlôe4_tokíizî
 
	tsqlôe4_tokíizî
;

50 
sqlôe4_tokíizî_curs‹
 
	tsqlôe4_tokíizî_curs‹
;

52 
	ssqlôe4_tokíizî_moduÀ
 {

57 
	miVîsi⁄
;

76 (*
	mxCª©e
)(

77 
	m¨gc
,

78 c⁄° *c⁄°*
	m¨gv
,

79 
sqlôe4_tokíizî
 **
	mµTokíizî


86 (*
	mxDe°roy
)(
sqlôe4_tokíizî
 *
	mpTokíizî
);

93 (*
	mxO≥n
)(

94 
sqlôe4_tokíizî
 *
	mpTokíizî
,

95 c⁄° *
	mpI≈ut
, 
	mnByãs
,

96 
sqlôe4_tokíizî_curs‹
 **
	mµCurs‹


103 (*
	mxClo£
)(
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
);

129 (*
	mxNext
)(

130 
sqlôe4_tokíizî_curs‹
 *
	mpCurs‹
,

131 c⁄° **
	mµTokí
, *
	m≤Byãs
,

132 *
	mpiSèπOff£t
,

133 *
	mpiEndOff£t
,

134 *
	mpiPosôi⁄


138 
	ssqlôe4_tokíizî
 {

139 c⁄° 
sqlôe4_tokíizî_moduÀ
 *
	mpModuÀ
;

143 
	ssqlôe4_tokíizî_curs‹
 {

144 
sqlôe4_tokíizî
 *
	mpTokíizî
;

148 
·s3_globÆ_ãrm_˙t
(
iTîm
, 
iCﬁ
);

149 
·s3_ãrm_˙t
(
iTîm
, 
iCﬁ
);

	@ext/fts3/fts3_tokenizer1.c

25 
	~"·s3I¡.h
"

26 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

28 
	~<as£π.h
>

29 
	~<°dlib.h
>

30 
	~<°dio.h
>

31 
	~<°rög.h
>

33 
	~"·s3_tokíizî.h
"

35 
	ssim∂e_tokíizî
 {

36 
sqlôe4_tokíizî
 
	mba£
;

37 
	mdñim
[128];

38 } 
	tsim∂e_tokíizî
;

40 
	ssim∂e_tokíizî_curs‹
 {

41 
sqlôe4_tokíizî_curs‹
 
	mba£
;

42 c⁄° *
	mpI≈ut
;

43 
	mnByãs
;

44 
	miOff£t
;

45 
	miTokí
;

46 *
	mpTokí
;

47 
	mnTokíAŒoˇãd
;

48 } 
	tsim∂e_tokíizî_curs‹
;

51 
	$sim∂eDñim
(
sim∂e_tokíizî
 *
t
, 
c
){

52  
c
<0x80 && 
t
->
dñim
[c];

53 
	}
}

54 
	$·s3_iß um
(
x
){

55  (
x
>='0' && x<='9') || (x>='A' && x<='Z') || (x>='a' && x<='z');

56 
	}
}

61 
	$sim∂eCª©e
(

62 
¨gc
, c⁄° * c⁄° *
¨gv
,

63 
sqlôe4_tokíizî
 **
µTokíizî


65 
sim∂e_tokíizî
 *
t
;

67 
t
 = (
sim∂e_tokíizî
 *Ë
	`sqlôe4_mÆloc
((*t));

68 if–
t
==
NULL
 )  
SQLITE4_NOMEM
;

69 
	`mem£t
(
t
, 0, (*t));

76 if–
¨gc
>1 ){

77 
i
, 
n
 = ()
	`°æí
(
¨gv
[1]);

78 
i
=0; i<
n
; i++){

79 
ch
 = 
¨gv
[1][
i
];

81 if–
ch
>=0x80 ){

82 
	`sqlôe4_‰ì
(
t
);

83  
SQLITE4_ERROR
;

85 
t
->
dñim
[
ch
] = 1;

89 
i
;

90 
i
=1; i<0x80; i++){

91 
t
->
dñim
[
i
] = !
	`·s3_iß um
(i) ? -1 : 0;

95 *
µTokíizî
 = &
t
->
ba£
;

96  
SQLITE4_OK
;

97 
	}
}

102 
	$sim∂eDe°roy
(
sqlôe4_tokíizî
 *
pTokíizî
){

103 
	`sqlôe4_‰ì
(
pTokíizî
);

104  
SQLITE4_OK
;

105 
	}
}

113 
	$sim∂eO≥n
(

114 
sqlôe4_tokíizî
 *
pTokíizî
,

115 c⁄° *
pI≈ut
, 
nByãs
,

116 
sqlôe4_tokíizî_curs‹
 **
µCurs‹


118 
sim∂e_tokíizî_curs‹
 *
c
;

120 
	`UNUSED_PARAMETER
(
pTokíizî
);

122 
c
 = (
sim∂e_tokíizî_curs‹
 *Ë
	`sqlôe4_mÆloc
((*c));

123 if–
c
==
NULL
 )  
SQLITE4_NOMEM
;

125 
c
->
pI≈ut
 =ÖInput;

126 if–
pI≈ut
==0 ){

127 
c
->
nByãs
 = 0;

128 }if–
nByãs
<0 ){

129 
c
->
nByãs
 = ()
	`°æí
(
pI≈ut
);

131 
c
->
nByãs
 =ÇBytes;

133 
c
->
iOff£t
 = 0;

134 
c
->
iTokí
 = 0;

135 
c
->
pTokí
 = 
NULL
;

136 
c
->
nTokíAŒoˇãd
 = 0;

138 *
µCurs‹
 = &
c
->
ba£
;

139  
SQLITE4_OK
;

140 
	}
}

146 
	$sim∂eClo£
(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
){

147 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

148 
	`sqlôe4_‰ì
(
c
->
pTokí
);

149 
	`sqlôe4_‰ì
(
c
);

150  
SQLITE4_OK
;

151 
	}
}

157 
	$sim∂eNext
(

158 
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

159 c⁄° **
µTokí
,

160 *
≤Byãs
,

161 *
piSèπOff£t
,

162 *
piEndOff£t
,

163 *
piPosôi⁄


165 
sim∂e_tokíizî_curs‹
 *
c
 = (sim∂e_tokíizî_curs‹ *Ë
pCurs‹
;

166 
sim∂e_tokíizî
 *
t
 = (sim∂e_tokíizî *Ë
pCurs‹
->
pTokíizî
;

167 *
p
 = (*)
c
->
pI≈ut
;

169  
c
->
iOff£t
<c->
nByãs
 ){

170 
iSèπOff£t
;

173  
c
->
iOff£t
<c->
nByãs
 && 
	`sim∂eDñim
(
t
, 
p
[c->iOffset]) ){

174 
c
->
iOff£t
++;

178 
iSèπOff£t
 = 
c
->
iOff£t
;

179  
c
->
iOff£t
<c->
nByãs
 && !
	`sim∂eDñim
(
t
, 
p
[c->iOffset]) ){

180 
c
->
iOff£t
++;

183 if–
c
->
iOff£t
>
iSèπOff£t
 ){

184 
i
, 
n
 = 
c
->
iOff£t
-
iSèπOff£t
;

185 if–
n
>
c
->
nTokíAŒoˇãd
 ){

186 *
pNew
;

187 
c
->
nTokíAŒoˇãd
 = 
n
+20;

188 
pNew
 = 
	`sqlôe4_ªÆloc
(
c
->
pTokí
, c->
nTokíAŒoˇãd
);

189 if–!
pNew
 )  
SQLITE4_NOMEM
;

190 
c
->
pTokí
 = 
pNew
;

192 
i
=0; i<
n
; i++){

196 
ch
 = 
p
[
iSèπOff£t
+
i
];

197 
c
->
pTokí
[
i
] = ()((
ch
>='A' && ch<='Z') ? ch-'A'+'a' : ch);

199 *
µTokí
 = 
c
->
pTokí
;

200 *
≤Byãs
 = 
n
;

201 *
piSèπOff£t
 = 
iSèπOff£t
;

202 *
piEndOff£t
 = 
c
->
iOff£t
;

203 *
piPosôi⁄
 = 
c
->
iTokí
++;

205  
SQLITE4_OK
;

208  
SQLITE4_DONE
;

209 
	}
}

214 c⁄° 
sqlôe4_tokíizî_moduÀ
 
	gsim∂eTokíizîModuÀ
 = {

216 
sim∂eCª©e
,

217 
sim∂eDe°roy
,

218 
sim∂eO≥n
,

219 
sim∂eClo£
,

220 
sim∂eNext
,

227 
	$sqlôe4Fts3Sim∂eTokíizîModuÀ
(

228 
sqlôe4_tokíizî_moduÀ
 c⁄°**
µModuÀ


230 *
µModuÀ
 = &
sim∂eTokíizîModuÀ
;

231 
	}
}

	@ext/fts3/fts3_write.c

20 
	~"·s3I¡.h
"

21 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_FTS3
)

23 
	~<°rög.h
>

24 
	~<as£π.h
>

25 
	~<°dlib.h
>

37 
	#FTS3_NODE_PADDING
 (
FTS3_VARINT_MAX
*2)

	)

56 #ifde‡
SQLITE4_TEST


57 
	gã°_·s3_node_chunksize
 = (4*1024);

58 
	gã°_·s3_node_chunk_thªshﬁd
 = (4*1024)*4;

59 
	#FTS3_NODE_CHUNKSIZE
 
ã°_·s3_node_chunksize


	)

60 
	#FTS3_NODE_CHUNK_THRESHOLD
 
ã°_·s3_node_chunk_thªshﬁd


	)

62 
	#FTS3_NODE_CHUNKSIZE
 (4*1024)

	)

63 
	#FTS3_NODE_CHUNK_THRESHOLD
 (
FTS3_NODE_CHUNKSIZE
*4)

	)

66 
PídögLi°
 
	tPídögLi°
;

67 
SegmítNode
 
	tSegmítNode
;

68 
SegmítWrôî
 
	tSegmítWrôî
;

74 
	sPídögLi°
 {

75 
	mnD©a
;

76 *
	maD©a
;

77 
	mnS∑˚
;

78 
sqlôe4_öt64
 
	miLa°Docid
;

79 
sqlôe4_öt64
 
	miLa°Cﬁ
;

80 
sqlôe4_öt64
 
	miLa°Pos
;

87 
	sFts3De„ºedTokí
 {

88 
Fts3Phø£Tokí
 *
	mpTokí
;

89 
	miCﬁ
;

90 
Fts3De„ºedTokí
 *
	mpNext
;

91 
PídögLi°
 *
	mpLi°
;

111 
	sFts3SegRódî
 {

112 
	miIdx
;

114 
sqlôe4_öt64
 
	miSèπBlock
;

115 
sqlôe4_öt64
 
	miLófEndBlock
;

116 
sqlôe4_öt64
 
	miEndBlock
;

117 
sqlôe4_öt64
 
	miCuºítBlock
;

119 *
	maNode
;

120 
	mnNode
;

121 
	mnP›uœã
;

122 
sqlôe4_blob
 *
	mpBlob
;

124 
Fts3HashEÀm
 **
	mµNextEÀm
;

131 
	mnTîm
;

132 *
	mzTîm
;

133 
	mnTîmAŒoc
;

134 *
	maDo˛i°
;

135 
	mnDo˛i°
;

140 *
	mpOff£tLi°
;

141 
	mnOff£tLi°
;

142 
sqlôe4_öt64
 
	miDocid
;

145 
	#·s3SegRódîIsPídög
(
p
Ë(’)->
µNextEÀm
!=0)

	)

146 
	#·s3SegRódîIsRoŸO∆y
(
p
Ë(’)->
aNode
==(*)&’)[1])

	)

157 
	sSegmítWrôî
 {

158 
SegmítNode
 *
	mpTªe
;

159 
sqlôe4_öt64
 
	miFú°
;

160 
sqlôe4_öt64
 
	miFªe
;

161 *
	mzTîm
;

162 
	mnTîm
;

163 
	mnMÆloc
;

164 *
	mzMÆloc
;

165 
	mnSize
;

166 
	mnD©a
;

167 *
	maD©a
;

188 
	sSegmítNode
 {

189 
SegmítNode
 *
	mpP¨ít
;

190 
SegmítNode
 *
	mpRight
;

191 
SegmítNode
 *
	mpLe·mo°
;

192 
	mnE¡ry
;

193 *
	mzTîm
;

194 
	mnTîm
;

195 
	mnMÆloc
;

196 *
	mzMÆloc
;

197 
	mnD©a
;

198 *
	maD©a
;

204 
	#SQL_DELETE_CONTENT
 0

	)

205 
	#SQL_IS_EMPTY
 1

	)

206 
	#SQL_DELETE_ALL_CONTENT
 2

	)

207 
	#SQL_DELETE_ALL_SEGMENTS
 3

	)

208 
	#SQL_DELETE_ALL_SEGDIR
 4

	)

209 
	#SQL_DELETE_ALL_DOCSIZE
 5

	)

210 
	#SQL_DELETE_ALL_STAT
 6

	)

211 
	#SQL_SELECT_CONTENT_BY_ROWID
 7

	)

212 
	#SQL_NEXT_SEGMENT_INDEX
 8

	)

213 
	#SQL_INSERT_SEGMENTS
 9

	)

214 
	#SQL_NEXT_SEGMENTS_ID
 10

	)

215 
	#SQL_INSERT_SEGDIR
 11

	)

216 
	#SQL_SELECT_LEVEL
 12

	)

217 
	#SQL_SELECT_LEVEL_RANGE
 13

	)

218 
	#SQL_SELECT_LEVEL_COUNT
 14

	)

219 
	#SQL_SELECT_SEGDIR_MAX_LEVEL
 15

	)

220 
	#SQL_DELETE_SEGDIR_LEVEL
 16

	)

221 
	#SQL_DELETE_SEGMENTS_RANGE
 17

	)

222 
	#SQL_CONTENT_INSERT
 18

	)

223 
	#SQL_DELETE_DOCSIZE
 19

	)

224 
	#SQL_REPLACE_DOCSIZE
 20

	)

225 
	#SQL_SELECT_DOCSIZE
 21

	)

226 
	#SQL_SELECT_DOCTOTAL
 22

	)

227 
	#SQL_REPLACE_DOCTOTAL
 23

	)

229 
	#SQL_SELECT_ALL_PREFIX_LEVEL
 24

	)

230 
	#SQL_DELETE_ALL_TERMS_SEGDIR
 25

	)

232 
	#SQL_DELETE_SEGDIR_RANGE
 26

	)

245 
	$·s3SqlStmt
(

246 
Fts3TabÀ
 *
p
,

247 
eStmt
,

248 
sqlôe4_°mt
 **
µ
,

249 
sqlôe4_vÆue
 **
≠VÆ


251 c⁄° *
azSql
[] = {

289 
rc
 = 
SQLITE4_OK
;

290 
sqlôe4_°mt
 *
pStmt
;

292 
	`as£π
–
	`SizeofAºay
(
azSql
)==SizeofAºay(
p
->
aStmt
) );

293 
	`as£π
–
eStmt
<
	`SizeofAºay
(
azSql
) &&ÉStmt>=0 );

295 
pStmt
 = 
p
->
aStmt
[
eStmt
];

296 if–!
pStmt
 ){

297 *
zSql
;

298 if–
eStmt
==
SQL_CONTENT_INSERT
 ){

299 
zSql
 = 
	`sqlôe4_m¥ötf
(
azSql
[
eStmt
], 
p
->
zDb
,Ö->
zName
,Ö->
zWrôeEx¥li°
);

300 }if–
eStmt
==
SQL_SELECT_CONTENT_BY_ROWID
 ){

301 
zSql
 = 
	`sqlôe4_m¥ötf
(
azSql
[
eStmt
], 
p
->
zRódEx¥li°
);

303 
zSql
 = 
	`sqlôe4_m¥ötf
(
azSql
[
eStmt
], 
p
->
zDb
,Ö->
zName
);

305 if–!
zSql
 ){

306 
rc
 = 
SQLITE4_NOMEM
;

308 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
p
->
db
, 
zSql
, -1, &
pStmt
, 
NULL
);

309 
	`sqlôe4_‰ì
(
zSql
);

310 
	`as£π
–
rc
==
SQLITE4_OK
 || 
pStmt
==0 );

311 
p
->
aStmt
[
eStmt
] = 
pStmt
;

314 if–
≠VÆ
 ){

315 
i
;

316 
nP¨am
 = 
	`sqlôe4_böd_∑ømëî_cou¡
(
pStmt
);

317 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nP¨am
; i++){

318 
rc
 = 
	`sqlôe4_böd_vÆue
(
pStmt
, 
i
+1, 
≠VÆ
[i]);

321 *
µ
 = 
pStmt
;

322  
rc
;

323 
	}
}

325 
	$·s3Sñe˘Docsize
(

326 
Fts3TabÀ
 *
pTab
,

327 
eStmt
,

328 
sqlôe4_öt64
 
iDocid
,

329 
sqlôe4_°mt
 **
µStmt


331 
sqlôe4_°mt
 *
pStmt
 = 0;

332 
rc
;

334 
	`as£π
–
eStmt
==
SQL_SELECT_DOCSIZE
 ||ÉStmt==
SQL_SELECT_DOCTOTAL
 );

336 
rc
 = 
	`·s3SqlStmt
(
pTab
, 
eStmt
, &
pStmt
, 0);

337 if–
rc
==
SQLITE4_OK
 ){

338 if–
eStmt
==
SQL_SELECT_DOCSIZE
 ){

339 
	`sqlôe4_böd_öt64
(
pStmt
, 1, 
iDocid
);

341 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

342 if–
rc
!=
SQLITE4_ROW
 || 
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0)!=
SQLITE4_BLOB
 ){

343 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

344 if–
rc
==
SQLITE4_OK
 )Ñ¯
FTS_CORRUPT_VTAB
;

345 
pStmt
 = 0;

347 
rc
 = 
SQLITE4_OK
;

351 *
µStmt
 = 
pStmt
;

352  
rc
;

353 
	}
}

355 
	$sqlôe4Fts3Sñe˘Do˘ŸÆ
(

356 
Fts3TabÀ
 *
pTab
,

357 
sqlôe4_°mt
 **
µStmt


359  
	`·s3Sñe˘Docsize
(
pTab
, 
SQL_SELECT_DOCTOTAL
, 0, 
µStmt
);

360 
	}
}

362 
	$sqlôe4Fts3Sñe˘Docsize
(

363 
Fts3TabÀ
 *
pTab
,

364 
sqlôe4_öt64
 
iDocid
,

365 
sqlôe4_°mt
 **
µStmt


367  
	`·s3Sñe˘Docsize
(
pTab
, 
SQL_SELECT_DOCSIZE
, 
iDocid
, 
µStmt
);

368 
	}
}

378 
	$·s3SqlExec
(

379 *
pRC
,

380 
Fts3TabÀ
 *
p
,

381 
eStmt
,

382 
sqlôe4_vÆue
 **
≠VÆ


384 
sqlôe4_°mt
 *
pStmt
;

385 
rc
;

386 if–*
pRC
 ) ;

387 
rc
 = 
	`·s3SqlStmt
(
p
, 
eStmt
, &
pStmt
, 
≠VÆ
);

388 if–
rc
==
SQLITE4_OK
 ){

389 
	`sqlôe4_°ï
(
pStmt
);

390 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

392 *
pRC
 = 
rc
;

393 
	}
}

415 
	$sqlôe4Fts3RódLock
(
Fts3TabÀ
 *
p
){

416 
rc
;

417 
sqlôe4_°mt
 *
pStmt
;

419 if–
p
->
zC⁄ã¡Tbl
==0 ){

420 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_SELECT_CONTENT_BY_ROWID
, &
pStmt
, 0);

421 if–
rc
==
SQLITE4_OK
 ){

422 
	`sqlôe4_böd_nuŒ
(
pStmt
, 1);

423 
	`sqlôe4_°ï
(
pStmt
);

424 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

427 
rc
 = 
SQLITE4_OK
;

430  
rc
;

431 
	}
}

450 
	$sqlôe4Fts3AŒSegdús
(

451 
Fts3TabÀ
 *
p
,

452 
iIndex
,

453 
iLevñ
,

454 
sqlôe4_°mt
 **
µStmt


456 
rc
;

457 
sqlôe4_°mt
 *
pStmt
 = 0;

459 
	`as£π
–
iLevñ
==
FTS3_SEGCURSOR_ALL
 || iLevel>=0 );

460 
	`as£π
–
iLevñ
<
FTS3_SEGDIR_MAXLEVEL
 );

461 
	`as£π
–
iIndex
>=0 && iIndex<
p
->
nIndex
 );

463 if–
iLevñ
<0 ){

465 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_SELECT_LEVEL_RANGE
, &
pStmt
, 0);

466 if–
rc
==
SQLITE4_OK
 ){

467 
	`sqlôe4_böd_öt
(
pStmt
, 1, 
iIndex
*
FTS3_SEGDIR_MAXLEVEL
);

468 
	`sqlôe4_böd_öt
(
pStmt
, 2, (
iIndex
+1)*
FTS3_SEGDIR_MAXLEVEL
-1);

472 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_SELECT_LEVEL
, &
pStmt
, 0);

473 if–
rc
==
SQLITE4_OK
 ){

474 
	`sqlôe4_böd_öt
(
pStmt
, 1, 
iLevñ
+
iIndex
*
FTS3_SEGDIR_MAXLEVEL
);

477 *
µStmt
 = 
pStmt
;

478  
rc
;

479 
	}
}

494 
	$·s3PídögLi°AµídV¨öt
(

495 
PídögLi°
 **
µ
,

496 
sqlôe4_öt64
 
i


498 
PídögLi°
 *
p
 = *
µ
;

501 if–!
p
 ){

502 
p
 = 
	`sqlôe4_mÆloc
((*p) + 100);

503 if–!
p
 ){

504  
SQLITE4_NOMEM
;

506 
p
->
nS∑˚
 = 100;

507 
p
->
aD©a
 = (*)&p[1];

508 
p
->
nD©a
 = 0;

510 if–
p
->
nD©a
+
FTS3_VARINT_MAX
+1>p->
nS∑˚
 ){

511 
nNew
 = 
p
->
nS∑˚
 * 2;

512 
p
 = 
	`sqlôe4_ªÆloc
’, (*pË+ 
nNew
);

513 if–!
p
 ){

514 
	`sqlôe4_‰ì
(*
µ
);

515 *
µ
 = 0;

516  
SQLITE4_NOMEM
;

518 
p
->
nS∑˚
 = 
nNew
;

519 
p
->
aD©a
 = (*)&p[1];

523 
p
->
nD©a
 +
	`sqlôe4Fts3PutV¨öt
(&p->
aD©a
[p->nD©a], 
i
);

524 
p
->
aD©a
[p->
nD©a
] = '\0';

525 *
µ
 = 
p
;

526  
SQLITE4_OK
;

527 
	}
}

538 
	$·s3PídögLi°Aµíd
(

539 
PídögLi°
 **
µ
,

540 
sqlôe4_öt64
 
iDocid
,

541 
sqlôe4_öt64
 
iCﬁ
,

542 
sqlôe4_öt64
 
iPos
,

543 *
pRc


545 
PídögLi°
 *
p
 = *
µ
;

546 
rc
 = 
SQLITE4_OK
;

548 
	`as£π
–!
p
 ||Ö->
iLa°Docid
<=
iDocid
 );

550 if–!
p
 ||Ö->
iLa°Docid
!=
iDocid
 ){

551 
sqlôe4_öt64
 
iDñè
 = 
iDocid
 - (
p
 ?Ö->
iLa°Docid
 : 0);

552 if–
p
 ){

553 
	`as£π
–
p
->
nD©a
<p->
nS∑˚
 );

554 
	`as£π
–
p
->
aD©a
[p->
nD©a
]==0 );

555 
p
->
nD©a
++;

557 if–
SQLITE4_OK
!=(
rc
 = 
	`·s3PídögLi°AµídV¨öt
(&
p
, 
iDñè
)) ){

558 
≥ndögli°≠≥nd_out
;

560 
p
->
iLa°Cﬁ
 = -1;

561 
p
->
iLa°Pos
 = 0;

562 
p
->
iLa°Docid
 = 
iDocid
;

564 if–
iCﬁ
>0 && 
p
->
iLa°Cﬁ
!=iCol ){

565 if–
SQLITE4_OK
!=(
rc
 = 
	`·s3PídögLi°AµídV¨öt
(&
p
, 1))

566 || 
SQLITE4_OK
!=(
rc
 = 
	`·s3PídögLi°AµídV¨öt
(&
p
, 
iCﬁ
))

568 
≥ndögli°≠≥nd_out
;

570 
p
->
iLa°Cﬁ
 = 
iCﬁ
;

571 
p
->
iLa°Pos
 = 0;

573 if–
iCﬁ
>=0 ){

574 
	`as£π
–
iPos
>
p
->
iLa°Pos
 || (iPos==0 &&Ö->iLastPos==0) );

575 
rc
 = 
	`·s3PídögLi°AµídV¨öt
(&
p
, 2+
iPos
-p->
iLa°Pos
);

576 if–
rc
==
SQLITE4_OK
 ){

577 
p
->
iLa°Pos
 = 
iPos
;

581 
≥ndögli°≠≥nd_out
:

582 *
pRc
 = 
rc
;

583 if–
p
!=*
µ
 ){

584 *
µ
 = 
p
;

588 
	}
}

593 
	$·s3PídögLi°Dñëe
(
PídögLi°
 *
pLi°
){

594 
	`sqlôe4_‰ì
(
pLi°
);

595 
	}
}

600 
	$·s3PídögTîmsAddO√
(

601 
Fts3TabÀ
 *
p
,

602 
iCﬁ
,

603 
iPos
,

604 
Fts3Hash
 *
pHash
,

605 c⁄° *
zTokí
,

606 
nTokí


608 
PídögLi°
 *
pLi°
;

609 
rc
 = 
SQLITE4_OK
;

611 
pLi°
 = (
PídögLi°
 *)
	`·s3HashFöd
(
pHash
, 
zTokí
, 
nTokí
);

612 if–
pLi°
 ){

613 
p
->
nPídögD©a
 -(
pLi°
->
nD©a
 + 
nTokí
 + (
Fts3HashEÀm
));

615 if–
	`·s3PídögLi°Aµíd
(&
pLi°
, 
p
->
iPªvDocid
, 
iCﬁ
, 
iPos
, &
rc
) ){

616 if–
pLi°
==
	`·s3HashIn£π
(
pHash
, 
zTokí
, 
nTokí
,ÖList) ){

620 
	`as£π
–0==
	`·s3HashFöd
(
pHash
, 
zTokí
, 
nTokí
) );

621 
	`sqlôe4_‰ì
(
pLi°
);

622 
rc
 = 
SQLITE4_NOMEM
;

625 if–
rc
==
SQLITE4_OK
 ){

626 
p
->
nPídögD©a
 +(
pLi°
->
nD©a
 + 
nTokí
 + (
Fts3HashEÀm
));

628  
rc
;

629 
	}
}

638 
	$·s3PídögTîmsAdd
(

639 
Fts3TabÀ
 *
p
,

640 c⁄° *
zText
,

641 
iCﬁ
,

642 
u32
 *
≤W‹d


644 
rc
;

645 
iSèπ
;

646 
iEnd
;

647 
iPos
;

648 
nW‹d
 = 0;

650 c⁄° *
zTokí
;

651 
nTokí
;

653 
sqlôe4_tokíizî
 *
pTokíizî
 = 
p
->pTokenizer;

654 
sqlôe4_tokíizî_moduÀ
 c⁄° *
pModuÀ
 = 
pTokíizî
->pModule;

655 
sqlôe4_tokíizî_curs‹
 *
pC§
;

656 (*
xNext
)(
sqlôe4_tokíizî_curs‹
 *
pCurs‹
,

659 
	`as£π
–
pTokíizî
 && 
pModuÀ
 );

664 if–
zText
==0 ){

665 *
≤W‹d
 = 0;

666  
SQLITE4_OK
;

669 
rc
 = 
pModuÀ
->
	`xO≥n
(
pTokíizî
, 
zText
, -1, &
pC§
);

670 if–
rc
!=
SQLITE4_OK
 ){

671  
rc
;

673 
pC§
->
pTokíizî
 =ÖTokenizer;

675 
xNext
 = 
pModuÀ
->xNext;

676  
SQLITE4_OK
==
rc


677 && 
SQLITE4_OK
==(
rc
 = 
	`xNext
(
pC§
, &
zTokí
, &
nTokí
, &
iSèπ
, &
iEnd
, &
iPos
))

679 
i
;

680 if–
iPos
>=
nW‹d
 )ÇWord = iPos+1;

685 if–
iPos
<0 || !
zTokí
 || 
nTokí
<=0 ){

686 
rc
 = 
SQLITE4_ERROR
;

691 
rc
 = 
	`·s3PídögTîmsAddO√
(

692 
p
, 
iCﬁ
, 
iPos
, &p->
aIndex
[0].
hPídög
, 
zTokí
, 
nTokí


697 
i
=1; 
rc
==
SQLITE4_OK
 && i<
p
->
nIndex
; i++){

698 
Fts3Index
 *
pIndex
 = &
p
->
aIndex
[
i
];

699 if–
nTokí
<
pIndex
->
nPªfix
 ) ;

700 
rc
 = 
	`·s3PídögTîmsAddO√
(

701 
p
, 
iCﬁ
, 
iPos
, &
pIndex
->
hPídög
, 
zTokí
,ÖIndex->
nPªfix


706 
pModuÀ
->
	`xClo£
(
pC§
);

707 *
≤W‹d
 = 
nW‹d
;

708  (
rc
==
SQLITE4_DONE
 ? 
SQLITE4_OK
 :Ñc);

709 
	}
}

716 
	$·s3PídögTîmsDocid
(
Fts3TabÀ
 *
p
, 
sqlôe_öt64
 
iDocid
){

723 if–
iDocid
<=
p
->
iPªvDocid
 ||Ö->
nPídögD©a
>p->
nMaxPídögD©a
 ){

724 
rc
 = 
	`sqlôe4Fts3PídögTîmsFlush
(
p
);

725 if–
rc
!=
SQLITE4_OK
 ) Ñc;

727 
p
->
iPªvDocid
 = 
iDocid
;

728  
SQLITE4_OK
;

729 
	}
}

734 
	$sqlôe4Fts3PídögTîmsCÀ¨
(
Fts3TabÀ
 *
p
){

735 
i
;

736 
i
=0; i<
p
->
nIndex
; i++){

737 
Fts3HashEÀm
 *
pEÀm
;

738 
Fts3Hash
 *
pHash
 = &
p
->
aIndex
[
i
].
hPídög
;

739 
pEÀm
=
	`·s3HashFú°
(
pHash
);ÖEÀm;ÖEÀm=
	`·s3HashNext
(pElem)){

740 
PídögLi°
 *
pLi°
 = (PídögLi° *)
	`·s3HashD©a
(
pEÀm
);

741 
	`·s3PídögLi°Dñëe
(
pLi°
);

743 
	`·s3HashCÀ¨
(
pHash
);

745 
p
->
nPídögD©a
 = 0;

746 
	}
}

756 
	$·s3In£πTîms
(
Fts3TabÀ
 *
p
, 
sqlôe4_vÆue
 **
≠VÆ
, 
u32
 *
aSz
){

757 
i
;

758 
i
=2; i<
p
->
nCﬁumn
+2; i++){

759 c⁄° *
zText
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[
i
]);

760 
rc
 = 
	`·s3PídögTîmsAdd
(
p
, 
zText
, 
i
-2, &
aSz
[i-2]);

761 if–
rc
!=
SQLITE4_OK
 ){

762  
rc
;

764 
aSz
[
p
->
nCﬁumn
] +
	`sqlôe4_vÆue_byãs
(
≠VÆ
[
i
]);

766  
SQLITE4_OK
;

767 
	}
}

782 
	$·s3In£πD©a
(

783 
Fts3TabÀ
 *
p
,

784 
sqlôe4_vÆue
 **
≠VÆ
,

785 
sqlôe4_öt64
 *
piDocid


787 
rc
;

788 
sqlôe4_°mt
 *
pC⁄ã¡In£π
;

790 if–
p
->
zC⁄ã¡Tbl
 ){

791 
sqlôe4_vÆue
 *
pRowid
 = 
≠VÆ
[
p
->
nCﬁumn
+3];

792 if–
	`sqlôe4_vÆue_ty≥
(
pRowid
)==
SQLITE4_NULL
 ){

793 
pRowid
 = 
≠VÆ
[1];

795 if–
	`sqlôe4_vÆue_ty≥
(
pRowid
)!=
SQLITE4_INTEGER
 ){

796  
SQLITE4_CONSTRAINT
;

798 *
piDocid
 = 
	`sqlôe4_vÆue_öt64
(
pRowid
);

799  
SQLITE4_OK
;

810 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_CONTENT_INSERT
, &
pC⁄ã¡In£π
, &
≠VÆ
[1]);

811 if–
rc
!=
SQLITE4_OK
 ){

812  
rc
;

825 if–
SQLITE4_NULL
!=
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[3+
p
->
nCﬁumn
]) ){

826 if–
SQLITE4_NULL
==
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[0])

827 && 
SQLITE4_NULL
!=
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[1])

830  
SQLITE4_ERROR
;

832 
rc
 = 
	`sqlôe4_böd_vÆue
(
pC⁄ã¡In£π
, 1, 
≠VÆ
[3+
p
->
nCﬁumn
]);

833 if–
rc
!=
SQLITE4_OK
 ) Ñc;

839 
	`sqlôe4_°ï
(
pC⁄ã¡In£π
);

840 
rc
 = 
	`sqlôe4_ª£t
(
pC⁄ã¡In£π
);

842 *
piDocid
 = 
	`sqlôe4_œ°_ö£π_rowid
(
p
->
db
);

843  
rc
;

844 
	}
}

852 
	$·s3DñëeAŒ
(
Fts3TabÀ
 *
p
, 
bC⁄ã¡
){

853 
rc
 = 
SQLITE4_OK
;

856 
	`sqlôe4Fts3PídögTîmsCÀ¨
(
p
);

860 
	`as£π
–
p
->
zC⁄ã¡Tbl
==0 || 
bC⁄ã¡
==0 );

861 if–
bC⁄ã¡
 ) 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_ALL_CONTENT
, 0);

862 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_ALL_SEGMENTS
, 0);

863 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_ALL_SEGDIR
, 0);

864 if–
p
->
bHasDocsize
 ){

865 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_ALL_DOCSIZE
, 0);

867 if–
p
->
bHasSèt
 ){

868 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_ALL_STAT
, 0);

870  
rc
;

871 
	}
}

878 
	$·s3DñëeTîms
(

879 *
pRC
,

880 
Fts3TabÀ
 *
p
,

881 
sqlôe4_vÆue
 *
pRowid
,

882 
u32
 *
aSz


884 
rc
;

885 
sqlôe4_°mt
 *
pSñe˘
;

887 if–*
pRC
 ) ;

888 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_SELECT_CONTENT_BY_ROWID
, &
pSñe˘
, &
pRowid
);

889 if–
rc
==
SQLITE4_OK
 ){

890 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pSñe˘
) ){

891 
i
;

892 
i
=1; i<=
p
->
nCﬁumn
; i++){

893 c⁄° *
zText
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pSñe˘
, 
i
);

894 
rc
 = 
	`·s3PídögTîmsAdd
(
p
, 
zText
, -1, &
aSz
[
i
-1]);

895 if–
rc
!=
SQLITE4_OK
 ){

896 
	`sqlôe4_ª£t
(
pSñe˘
);

897 *
pRC
 = 
rc
;

900 
aSz
[
p
->
nCﬁumn
] +
	`sqlôe4_cﬁumn_byãs
(
pSñe˘
, 
i
);

903 
rc
 = 
	`sqlôe4_ª£t
(
pSñe˘
);

905 
	`sqlôe4_ª£t
(
pSñe˘
);

907 *
pRC
 = 
rc
;

908 
	}
}

914 
·s3SegmítMîge
(
Fts3TabÀ
 *, , );

931 
	$·s3AŒoˇãSegdúIdx
(

932 
Fts3TabÀ
 *
p
,

933 
iIndex
,

934 
iLevñ
,

935 *
piIdx


937 
rc
;

938 
sqlôe4_°mt
 *
pNextIdx
;

939 
iNext
 = 0;

942 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_NEXT_SEGMENT_INDEX
, &
pNextIdx
, 0);

943 if–
rc
==
SQLITE4_OK
 ){

944 
	`sqlôe4_böd_öt
(
pNextIdx
, 1, 
iIndex
*
FTS3_SEGDIR_MAXLEVEL
 + 
iLevñ
);

945 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pNextIdx
) ){

946 
iNext
 = 
	`sqlôe4_cﬁumn_öt
(
pNextIdx
, 0);

948 
rc
 = 
	`sqlôe4_ª£t
(
pNextIdx
);

951 if–
rc
==
SQLITE4_OK
 ){

957 if–
iNext
>=
FTS3_MERGE_COUNT
 ){

958 
rc
 = 
	`·s3SegmítMîge
(
p
, 
iIndex
, 
iLevñ
);

959 *
piIdx
 = 0;

961 *
piIdx
 = 
iNext
;

965  
rc
;

966 
	}
}

995 
	$sqlôe4Fts3RódBlock
(

996 
Fts3TabÀ
 *
p
,

997 
sqlôe4_öt64
 
iBlockid
,

998 **
∑Blob
,

999 *
≤Blob
,

1000 *
≤Lﬂd


1002 
rc
;

1005 
	`as£π
–
≤Blob
);

1007 if–
p
->
pSegmíts
 ){

1008 
rc
 = 
	`sqlôe4_blob_ª›í
(
p
->
pSegmíts
, 
iBlockid
);

1010 if–0==
p
->
zSegmítsTbl
 ){

1011 
p
->
zSegmítsTbl
 = 
	`sqlôe4_m¥ötf
("%s_£gmíts",Ö->
zName
);

1012 if–0==
p
->
zSegmítsTbl
 )  
SQLITE4_NOMEM
;

1014 
rc
 = 
	`sqlôe4_blob_›í
(

1015 
p
->
db
,Ö->
zDb
,Ö->
zSegmítsTbl
, "block", 
iBlockid
, 0, &p->
pSegmíts


1019 if–
rc
==
SQLITE4_OK
 ){

1020 
nByã
 = 
	`sqlôe4_blob_byãs
(
p
->
pSegmíts
);

1021 *
≤Blob
 = 
nByã
;

1022 if–
∑Blob
 ){

1023 *
aByã
 = 
	`sqlôe4_mÆloc
(
nByã
 + 
FTS3_NODE_PADDING
);

1024 if–!
aByã
 ){

1025 
rc
 = 
SQLITE4_NOMEM
;

1027 if–
≤Lﬂd
 && 
nByã
>(
FTS3_NODE_CHUNK_THRESHOLD
) ){

1028 
nByã
 = 
FTS3_NODE_CHUNKSIZE
;

1029 *
≤Lﬂd
 = 
nByã
;

1031 
rc
 = 
	`sqlôe4_blob_ªad
(
p
->
pSegmíts
, 
aByã
, 
nByã
, 0);

1032 
	`mem£t
(&
aByã
[
nByã
], 0, 
FTS3_NODE_PADDING
);

1033 if–
rc
!=
SQLITE4_OK
 ){

1034 
	`sqlôe4_‰ì
(
aByã
);

1035 
aByã
 = 0;

1038 *
∑Blob
 = 
aByã
;

1042  
rc
;

1043 
	}
}

1049 
	$sqlôe4Fts3SegmítsClo£
(
Fts3TabÀ
 *
p
){

1050 
	`sqlôe4_blob_˛o£
(
p
->
pSegmíts
);

1051 
p
->
pSegmíts
 = 0;

1052 
	}
}

1054 
	$·s3SegRódîIn¸Ród
(
Fts3SegRódî
 *
pRódî
){

1055 
nRód
;

1056 
rc
;

1058 
nRód
 = 
	`MIN
(
pRódî
->
nNode
 -ÖRódî->
nP›uœã
, 
FTS3_NODE_CHUNKSIZE
);

1059 
rc
 = 
	`sqlôe4_blob_ªad
(

1060 
pRódî
->
pBlob
,

1061 &
pRódî
->
aNode
[pRódî->
nP›uœã
],

1062 
nRód
,

1063 
pRódî
->
nP›uœã


1066 if–
rc
==
SQLITE4_OK
 ){

1067 
pRódî
->
nP›uœã
 +
nRód
;

1068 
	`mem£t
(&
pRódî
->
aNode
[pRódî->
nP›uœã
], 0, 
FTS3_NODE_PADDING
);

1069 if–
pRódî
->
nP›uœã
=ıRódî->
nNode
 ){

1070 
	`sqlôe4_blob_˛o£
(
pRódî
->
pBlob
);

1071 
pRódî
->
pBlob
 = 0;

1072 
pRódî
->
nP›uœã
 = 0;

1075  
rc
;

1076 
	}
}

1078 
	$·s3SegRódîRequúe
(
Fts3SegRódî
 *
pRódî
, *
pFrom
, 
nByã
){

1079 
rc
 = 
SQLITE4_OK
;

1080 
	`as£π
–!
pRódî
->
pBlob


1081 || (
pFrom
>=
pRódî
->
aNode
 &&ÖFrom<&pRódî->aNode[pRódî->
nNode
])

1083  
pRódî
->
pBlob
 && 
rc
==
SQLITE4_OK


1084 && (
pFrom
 - 
pRódî
->
aNode
 + 
nByã
)>pRódî->
nP›uœã


1086 
rc
 = 
	`·s3SegRódîIn¸Ród
(
pRódî
);

1088  
rc
;

1089 
	}
}

1096 
	$·s3SegRódîNext
(

1097 
Fts3TabÀ
 *
p
,

1098 
Fts3SegRódî
 *
pRódî
,

1099 
bIn¸


1101 
rc
;

1102 *
pNext
;

1103 
nPªfix
;

1104 
nSuffix
;

1106 if–!
pRódî
->
aDo˛i°
 ){

1107 
pNext
 = 
pRódî
->
aNode
;

1109 
pNext
 = &
pRódî
->
aDo˛i°
[pRódî->
nDo˛i°
];

1112 if–!
pNext
 ||ÖNext>=&
pRódî
->
aNode
[pRódî->
nNode
] ){

1114 if–
	`·s3SegRódîIsPídög
(
pRódî
) ){

1115 
Fts3HashEÀm
 *
pEÀm
 = *(
pRódî
->
µNextEÀm
);

1116 if–
pEÀm
==0 ){

1117 
pRódî
->
aNode
 = 0;

1119 
PídögLi°
 *
pLi°
 = (PídögLi° *)
	`·s3HashD©a
(
pEÀm
);

1120 
pRódî
->
zTîm
 = (*)
	`·s3HashKey
(
pEÀm
);

1121 
pRódî
->
nTîm
 = 
	`·s3HashKeysize
(
pEÀm
);

1122 
pRódî
->
nNode
 =ÖRódî->
nDo˛i°
 = 
pLi°
->
nD©a
 + 1;

1123 
pRódî
->
aNode
 =ÖRódî->
aDo˛i°
 = 
pLi°
->
aD©a
;

1124 
pRódî
->
µNextEÀm
++;

1125 
	`as£π
–
pRódî
->
aNode
 );

1127  
SQLITE4_OK
;

1130 if–!
	`·s3SegRódîIsRoŸO∆y
(
pRódî
) ){

1131 
	`sqlôe4_‰ì
(
pRódî
->
aNode
);

1132 
	`sqlôe4_blob_˛o£
(
pRódî
->
pBlob
);

1133 
pRódî
->
pBlob
 = 0;

1135 
pRódî
->
aNode
 = 0;

1139 
	`as£π
–
pRódî
->
iCuºítBlock
<ıRódî->
iLófEndBlock
 );

1140 if–
pRódî
->
iCuºítBlock
>ıRódî->
iLófEndBlock
 ){

1141  
SQLITE4_OK
;

1144 
rc
 = 
	`sqlôe4Fts3RódBlock
(

1145 
p
, ++
pRódî
->
iCuºítBlock
, &pRódî->
aNode
, &pRódî->
nNode
,

1146 (
bIn¸
 ? &
pRódî
->
nP›uœã
 : 0)

1148 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1149 
	`as£π
–
pRódî
->
pBlob
==0 );

1150 if–
bIn¸
 && 
pRódî
->
nP›uœã
<pRódî->
nNode
 ){

1151 
pRódî
->
pBlob
 = 
p
->
pSegmíts
;

1152 
p
->
pSegmíts
 = 0;

1154 
pNext
 = 
pRódî
->
aNode
;

1157 
	`as£π
–!
	`·s3SegRódîIsPídög
(
pRódî
) );

1159 
rc
 = 
	`·s3SegRódîRequúe
(
pRódî
, 
pNext
, 
FTS3_VARINT_MAX
*2);

1160 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1164 
pNext
 +
	`sqlôe4Fts3GëV¨öt32
’Next, &
nPªfix
);

1165 
pNext
 +
	`sqlôe4Fts3GëV¨öt32
’Next, &
nSuffix
);

1166 if–
nPªfix
<0 || 
nSuffix
<=0

1167 || &
pNext
[
nSuffix
]>&
pRódî
->
aNode
[pRódî->
nNode
]

1169  
FTS_CORRUPT_VTAB
;

1172 if–
nPªfix
+
nSuffix
>
pRódî
->
nTîmAŒoc
 ){

1173 
nNew
 = (
nPªfix
+
nSuffix
)*2;

1174 *
zNew
 = 
	`sqlôe4_ªÆloc
(
pRódî
->
zTîm
, 
nNew
);

1175 if–!
zNew
 ){

1176  
SQLITE4_NOMEM
;

1178 
pRódî
->
zTîm
 = 
zNew
;

1179 
pRódî
->
nTîmAŒoc
 = 
nNew
;

1182 
rc
 = 
	`·s3SegRódîRequúe
(
pRódî
, 
pNext
, 
nSuffix
+
FTS3_VARINT_MAX
);

1183 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1185 
	`mem˝y
(&
pRódî
->
zTîm
[
nPªfix
], 
pNext
, 
nSuffix
);

1186 
pRódî
->
nTîm
 = 
nPªfix
+
nSuffix
;

1187 
pNext
 +
nSuffix
;

1188 
pNext
 +
	`sqlôe4Fts3GëV¨öt32
’Next, &
pRódî
->
nDo˛i°
);

1189 
pRódî
->
aDo˛i°
 = 
pNext
;

1190 
pRódî
->
pOff£tLi°
 = 0;

1196 if–&
pRódî
->
aDo˛i°
[pRódî->
nDo˛i°
]>&pRódî->
aNode
[pRódî->
nNode
]

1197 || (
pRódî
->
nP›uœã
==0 &&ÖRódî->
aDo˛i°
[pRódî->
nDo˛i°
-1])

1199  
FTS_CORRUPT_VTAB
;

1201  
SQLITE4_OK
;

1202 
	}
}

1208 
	$·s3SegRódîFú°Docid
(
Fts3TabÀ
 *
pTab
, 
Fts3SegRódî
 *
pRódî
){

1209 
rc
 = 
SQLITE4_OK
;

1210 
	`as£π
–
pRódî
->
aDo˛i°
 );

1211 
	`as£π
–!
pRódî
->
pOff£tLi°
 );

1212 if–
pTab
->
bDescIdx
 && 
	`·s3SegRódîIsPídög
(
pRódî
) ){

1213 
u8
 
bEof
 = 0;

1214 
pRódî
->
iDocid
 = 0;

1215 
pRódî
->
nOff£tLi°
 = 0;

1216 
	`sqlôe4Fts3Do˛i°Pªv
(0,

1217 
pRódî
->
aDo˛i°
,ÖRódî->
nDo˛i°
, &pRódî->
pOff£tLi°
,

1218 &
pRódî
->
iDocid
, &pRódî->
nOff£tLi°
, &
bEof


1221 
rc
 = 
	`·s3SegRódîRequúe
(
pRódî
,ÖRódî->
aDo˛i°
, 
FTS3_VARINT_MAX
);

1222 if–
rc
==
SQLITE4_OK
 ){

1223 
n
 = 
	`sqlôe4Fts3GëV¨öt
(
pRódî
->
aDo˛i°
, &pRódî->
iDocid
);

1224 
pRódî
->
pOff£tLi°
 = &pRódî->
aDo˛i°
[
n
];

1227  
rc
;

1228 
	}
}

1240 
	$·s3SegRódîNextDocid
(

1241 
Fts3TabÀ
 *
pTab
,

1242 
Fts3SegRódî
 *
pRódî
,

1243 **
µOff£tLi°
,

1244 *
≤Off£tLi°


1246 
rc
 = 
SQLITE4_OK
;

1247 *
p
 = 
pRódî
->
pOff£tLi°
;

1248 
c
 = 0;

1250 
	`as£π
–
p
 );

1252 if–
pTab
->
bDescIdx
 && 
	`·s3SegRódîIsPídög
(
pRódî
) ){

1256 
u8
 
bEof
 = 0;

1257 if–
µOff£tLi°
 ){

1258 *
µOff£tLi°
 = 
pRódî
->
pOff£tLi°
;

1259 *
≤Off£tLi°
 = 
pRódî
->
nOff£tLi°
 - 1;

1261 
	`sqlôe4Fts3Do˛i°Pªv
(0,

1262 
pRódî
->
aDo˛i°
,ÖRódî->
nDo˛i°
, &
p
, &pRódî->
iDocid
,

1263 &
pRódî
->
nOff£tLi°
, &
bEof


1265 if–
bEof
 ){

1266 
pRódî
->
pOff£tLi°
 = 0;

1268 
pRódî
->
pOff£tLi°
 = 
p
;

1271 *
pEnd
 = &
pRódî
->
aDo˛i°
[pRódî->
nDo˛i°
];

1284  *
p
 | 
c
 ) c = *p++ & 0x80;

1285 
	`as£π
–*
p
==0 );

1287 if–
pRódî
->
pBlob
==0 || 
p
<&pRódî->
aNode
[pRódî->
nP›uœã
] ) ;

1288 
rc
 = 
	`·s3SegRódîIn¸Ród
(
pRódî
);

1289 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1291 
p
++;

1296 if–
µOff£tLi°
 ){

1297 *
µOff£tLi°
 = 
pRódî
->
pOff£tLi°
;

1298 *
≤Off£tLi°
 = ()(
p
 - 
pRódî
->
pOff£tLi°
 - 1);

1301  
p
<
pEnd
 && *p==0 )Ö++;

1308 if–
p
>=
pEnd
 ){

1309 
pRódî
->
pOff£tLi°
 = 0;

1311 
rc
 = 
	`·s3SegRódîRequúe
(
pRódî
, 
p
, 
FTS3_VARINT_MAX
);

1312 if–
rc
==
SQLITE4_OK
 ){

1313 
sqlôe4_öt64
 
iDñè
;

1314 
pRódî
->
pOff£tLi°
 = 
p
 + 
	`sqlôe4Fts3GëV¨öt
’, &
iDñè
);

1315 if–
pTab
->
bDescIdx
 ){

1316 
pRódî
->
iDocid
 -
iDñè
;

1318 
pRódî
->
iDocid
 +
iDñè
;

1324  
SQLITE4_OK
;

1325 
	}
}

1328 
	$sqlôe4Fts3M§OvÊ
(

1329 
Fts3Curs‹
 *
pC§
,

1330 
Fts3Mu…iSegRódî
 *
pM§
,

1331 *
≤OvÊ


1333 
Fts3TabÀ
 *
p
 = (Fts3TabÀ*)
pC§
->
ba£
.
pVèb
;

1334 
nOvÊ
 = 0;

1335 
ii
;

1336 
rc
 = 
SQLITE4_OK
;

1337 
pgsz
 = 
p
->
nPgsz
;

1339 
	`as£π
–
p
->
bHasSèt
 );

1340 
	`as£π
–
pgsz
>0 );

1342 
ii
=0; 
rc
==
SQLITE4_OK
 && ii<
pM§
->
nSegmít
; ii++){

1343 
Fts3SegRódî
 *
pRódî
 = 
pM§
->
≠Segmít
[
ii
];

1344 if–!
	`·s3SegRódîIsPídög
(
pRódî
)

1345 && !
	`·s3SegRódîIsRoŸO∆y
(
pRódî
)

1347 
sqlôe4_öt64
 
jj
;

1348 
jj
=
pRódî
->
iSèπBlock
; jj<ıRódî->
iLófEndBlock
; jj++){

1349 
nBlob
;

1350 
rc
 = 
	`sqlôe4Fts3RódBlock
(
p
, 
jj
, 0, &
nBlob
, 0);

1351 if–
rc
!=
SQLITE4_OK
 ) ;

1352 if–(
nBlob
+35)>
pgsz
 ){

1353 
nOvÊ
 +(
nBlob
 + 34)/
pgsz
;

1358 *
≤OvÊ
 = 
nOvÊ
;

1359  
rc
;

1360 
	}
}

1366 
	$sqlôe4Fts3SegRódîFªe
(
Fts3SegRódî
 *
pRódî
){

1367 if–
pRódî
 && !
	`·s3SegRódîIsPídög
(pReader) ){

1368 
	`sqlôe4_‰ì
(
pRódî
->
zTîm
);

1369 if–!
	`·s3SegRódîIsRoŸO∆y
(
pRódî
) ){

1370 
	`sqlôe4_‰ì
(
pRódî
->
aNode
);

1371 
	`sqlôe4_blob_˛o£
(
pRódî
->
pBlob
);

1374 
	`sqlôe4_‰ì
(
pRódî
);

1375 
	}
}

1380 
	$sqlôe4Fts3SegRódîNew
(

1381 
iAge
,

1382 
sqlôe4_öt64
 
iSèπLóf
,

1383 
sqlôe4_öt64
 
iEndLóf
,

1384 
sqlôe4_öt64
 
iEndBlock
,

1385 c⁄° *
zRoŸ
,

1386 
nRoŸ
,

1387 
Fts3SegRódî
 **
µRódî


1389 
Fts3SegRódî
 *
pRódî
;

1390 
nExåa
 = 0;

1392 
	`as£π
–
iSèπLóf
<=
iEndLóf
 );

1393 if–
iSèπLóf
==0 ){

1394 
nExåa
 = 
nRoŸ
 + 
FTS3_NODE_PADDING
;

1397 
pRódî
 = (
Fts3SegRódî
 *)
	`sqlôe4_mÆloc
((Fts3SegRódîË+ 
nExåa
);

1398 if–!
pRódî
 ){

1399  
SQLITE4_NOMEM
;

1401 
	`mem£t
(
pRódî
, 0, (
Fts3SegRódî
));

1402 
pRódî
->
iIdx
 = 
iAge
;

1403 
pRódî
->
iSèπBlock
 = 
iSèπLóf
;

1404 
pRódî
->
iLófEndBlock
 = 
iEndLóf
;

1405 
pRódî
->
iEndBlock
 = iEndBlock;

1407 if–
nExåa
 ){

1409 
pRódî
->
aNode
 = (*)&pReader[1];

1410 
pRódî
->
nNode
 = 
nRoŸ
;

1411 
	`mem˝y
(
pRódî
->
aNode
, 
zRoŸ
, 
nRoŸ
);

1412 
	`mem£t
(&
pRódî
->
aNode
[
nRoŸ
], 0, 
FTS3_NODE_PADDING
);

1414 
pRódî
->
iCuºítBlock
 = 
iSèπLóf
-1;

1416 *
µRódî
 = 
pRódî
;

1417  
SQLITE4_OK
;

1418 
	}
}

1425 
	$·s3Com∑ªEÀmByTîm
(c⁄° *
lhs
, c⁄° *
rhs
){

1426 *
z1
 = 
	`·s3HashKey
(*(
Fts3HashEÀm
 **)
lhs
);

1427 *
z2
 = 
	`·s3HashKey
(*(
Fts3HashEÀm
 **)
rhs
);

1428 
n1
 = 
	`·s3HashKeysize
(*(
Fts3HashEÀm
 **)
lhs
);

1429 
n2
 = 
	`·s3HashKeysize
(*(
Fts3HashEÀm
 **)
rhs
);

1431 
n
 = (
n1
<
n2
 ?Ç1 :Ç2);

1432 
c
 = 
	`memcmp
(
z1
, 
z2
, 
n
);

1433 if–
c
==0 ){

1434 
c
 = 
n1
 - 
n2
;

1436  
c
;

1437 
	}
}

1458 
	$sqlôe4Fts3SegRódîPídög
(

1459 
Fts3TabÀ
 *
p
,

1460 
iIndex
,

1461 c⁄° *
zTîm
,

1462 
nTîm
,

1463 
bPªfix
,

1464 
Fts3SegRódî
 **
µRódî


1466 
Fts3SegRódî
 *
pRódî
 = 0;

1467 
Fts3HashEÀm
 *
pE
;

1468 
Fts3HashEÀm
 **
aEÀm
 = 0;

1469 
nEÀm
 = 0;

1470 
rc
 = 
SQLITE4_OK
;

1471 
Fts3Hash
 *
pHash
;

1473 
pHash
 = &
p
->
aIndex
[
iIndex
].
hPídög
;

1474 if–
bPªfix
 ){

1475 
nAŒoc
 = 0;

1477 
pE
=
	`·s3HashFú°
(
pHash
);ÖE;ÖE=
	`·s3HashNext
(pE)){

1478 *
zKey
 = (*)
	`·s3HashKey
(
pE
);

1479 
nKey
 = 
	`·s3HashKeysize
(
pE
);

1480 if–
nTîm
==0 || (
nKey
>ÚTîm && 0==
	`memcmp
(
zKey
, 
zTîm
,ÇTerm)) ){

1481 if–
nEÀm
==
nAŒoc
 ){

1482 
Fts3HashEÀm
 **
aEÀm2
;

1483 
nAŒoc
 += 16;

1484 
aEÀm2
 = (
Fts3HashEÀm
 **)
	`sqlôe4_ªÆloc
(

1485 
aEÀm
, 
nAŒoc
*(
Fts3HashEÀm
 *)

1487 if–!
aEÀm2
 ){

1488 
rc
 = 
SQLITE4_NOMEM
;

1489 
nEÀm
 = 0;

1492 
aEÀm
 = 
aEÀm2
;

1495 
aEÀm
[
nEÀm
++] = 
pE
;

1503 if–
nEÀm
>1 ){

1504 
	`qs‹t
(
aEÀm
, 
nEÀm
, (
Fts3HashEÀm
 *), 
·s3Com∑ªEÀmByTîm
);

1515 
pE
 = 
	`·s3HashFödEÀm
(
pHash
, 
zTîm
, 
nTîm
);

1516 if–
pE
 ){

1517 
aEÀm
 = &
pE
;

1518 
nEÀm
 = 1;

1522 if–
nEÀm
>0 ){

1523 
nByã
 = (
Fts3SegRódî
Ë+ (
nEÀm
+1)*(
Fts3HashEÀm
 *);

1524 
pRódî
 = (
Fts3SegRódî
 *)
	`sqlôe4_mÆloc
(
nByã
);

1525 if–!
pRódî
 ){

1526 
rc
 = 
SQLITE4_NOMEM
;

1528 
	`mem£t
(
pRódî
, 0, 
nByã
);

1529 
pRódî
->
iIdx
 = 0x7FFFFFFF;

1530 
pRódî
->
µNextEÀm
 = (
Fts3HashEÀm
 **)&pReader[1];

1531 
	`mem˝y
(
pRódî
->
µNextEÀm
, 
aEÀm
, 
nEÀm
*(
Fts3HashEÀm
 *));

1535 if–
bPªfix
 ){

1536 
	`sqlôe4_‰ì
(
aEÀm
);

1538 *
µRódî
 = 
pRódî
;

1539  
rc
;

1540 
	}
}

1554 
	$·s3SegRódîCmp
(
Fts3SegRódî
 *
pLhs
, Fts3SegRódî *
pRhs
){

1555 
rc
;

1556 if–
pLhs
->
aNode
 && 
pRhs
->aNode ){

1557 
rc2
 = 
pLhs
->
nTîm
 - 
pRhs
->nTerm;

1558 if–
rc2
<0 ){

1559 
rc
 = 
	`memcmp
(
pLhs
->
zTîm
, 
pRhs
->zTîm,ÖLhs->
nTîm
);

1561 
rc
 = 
	`memcmp
(
pLhs
->
zTîm
, 
pRhs
->zTîm,ÖRhs->
nTîm
);

1563 if–
rc
==0 ){

1564 
rc
 = 
rc2
;

1567 
rc
 = (
pLhs
->
aNode
==0Ë- (
pRhs
->aNode==0);

1569 if–
rc
==0 ){

1570 
rc
 = 
pRhs
->
iIdx
 - 
pLhs
->iIdx;

1572 
	`as£π
–
rc
!=0 );

1573  
rc
;

1574 
	}
}

1587 
	$·s3SegRódîDo˛i°Cmp
(
Fts3SegRódî
 *
pLhs
, Fts3SegRódî *
pRhs
){

1588 
rc
 = (
pLhs
->
pOff£tLi°
==0)-(
pRhs
->pOffsetList==0);

1589 if–
rc
==0 ){

1590 if–
pLhs
->
iDocid
==
pRhs
->iDocid ){

1591 
rc
 = 
pRhs
->
iIdx
 - 
pLhs
->iIdx;

1593 
rc
 = (
pLhs
->
iDocid
 > 
pRhs
->iDocid) ? 1 : -1;

1596 
	`as£π
–
pLhs
->
aNode
 && 
pRhs
->aNode );

1597  
rc
;

1598 
	}
}

1599 
	$·s3SegRódîDo˛i°CmpRev
(
Fts3SegRódî
 *
pLhs
, Fts3SegRódî *
pRhs
){

1600 
rc
 = (
pLhs
->
pOff£tLi°
==0)-(
pRhs
->pOffsetList==0);

1601 if–
rc
==0 ){

1602 if–
pLhs
->
iDocid
==
pRhs
->iDocid ){

1603 
rc
 = 
pRhs
->
iIdx
 - 
pLhs
->iIdx;

1605 
rc
 = (
pLhs
->
iDocid
 < 
pRhs
->iDocid) ? 1 : -1;

1608 
	`as£π
–
pLhs
->
aNode
 && 
pRhs
->aNode );

1609  
rc
;

1610 
	}
}

1620 
	$·s3SegRódîTîmCmp
(

1621 
Fts3SegRódî
 *
pSeg
,

1622 c⁄° *
zTîm
,

1623 
nTîm


1625 
ªs
 = 0;

1626 if–
pSeg
->
aNode
 ){

1627 if–
pSeg
->
nTîm
>nTerm ){

1628 
ªs
 = 
	`memcmp
(
pSeg
->
zTîm
, zTîm, 
nTîm
);

1630 
ªs
 = 
	`memcmp
(
pSeg
->
zTîm
, zTîm,ÖSeg->
nTîm
);

1632 if–
ªs
==0 ){

1633 
ªs
 = 
pSeg
->
nTîm
-nTerm;

1636  
ªs
;

1637 
	}
}

1645 
·s3SegRódîS‹t
(

1646 
Fts3SegRódî
 **
≠Segmít
,

1647 
nSegmít
,

1648 
nSu•e˘
,

1649 (*
xCmp
)(
Fts3SegRódî
 *, Fts3SegReader *)

1651 
i
;

1653 
	`as£π
–
nSu•e˘
<=
nSegmít
 );

1655 if–
nSu•e˘
==
nSegmít
 )ÇSuspect--;

1656 
i
=
nSu•e˘
-1; i>=0; i--){

1657 
j
;

1658 
j
=
i
; j<(
nSegmít
-1); j++){

1659 
Fts3SegRódî
 *
pTmp
;

1660 if–
	`xCmp
(
≠Segmít
[
j
],ápSegment[j+1])<0 ) ;

1661 
pTmp
 = 
≠Segmít
[
j
+1];

1662 
≠Segmít
[
j
+1] =ápSegment[j];

1663 
≠Segmít
[
j
] = 
pTmp
;

1667 #i‚de‡
NDEBUG


1669 
i
=0; i<(
nSu•e˘
-1); i++){

1670 
	`as£π
–
	`xCmp
(
≠Segmít
[
i
],ápSegment[i+1])<0 );

1673 
	}
}

1678 
	$·s3WrôeSegmít
(

1679 
Fts3TabÀ
 *
p
,

1680 
sqlôe4_öt64
 
iBlock
,

1681 *
z
,

1682 
n


1684 
sqlôe4_°mt
 *
pStmt
;

1685 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_INSERT_SEGMENTS
, &
pStmt
, 0);

1686 if–
rc
==
SQLITE4_OK
 ){

1687 
	`sqlôe4_böd_öt64
(
pStmt
, 1, 
iBlock
);

1688 
	`sqlôe4_böd_blob
(
pStmt
, 2, 
z
, 
n
, 
SQLITE4_STATIC
);

1689 
	`sqlôe4_°ï
(
pStmt
);

1690 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

1692  
rc
;

1693 
	}
}

1698 
	$·s3WrôeSegdú
(

1699 
Fts3TabÀ
 *
p
,

1700 
iLevñ
,

1701 
iIdx
,

1702 
sqlôe4_öt64
 
iSèπBlock
,

1703 
sqlôe4_öt64
 
iLófEndBlock
,

1704 
sqlôe4_öt64
 
iEndBlock
,

1705 *
zRoŸ
,

1706 
nRoŸ


1708 
sqlôe4_°mt
 *
pStmt
;

1709 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_INSERT_SEGDIR
, &
pStmt
, 0);

1710 if–
rc
==
SQLITE4_OK
 ){

1711 
	`sqlôe4_böd_öt
(
pStmt
, 1, 
iLevñ
);

1712 
	`sqlôe4_böd_öt
(
pStmt
, 2, 
iIdx
);

1713 
	`sqlôe4_böd_öt64
(
pStmt
, 3, 
iSèπBlock
);

1714 
	`sqlôe4_böd_öt64
(
pStmt
, 4, 
iLófEndBlock
);

1715 
	`sqlôe4_böd_öt64
(
pStmt
, 5, 
iEndBlock
);

1716 
	`sqlôe4_böd_blob
(
pStmt
, 6, 
zRoŸ
, 
nRoŸ
, 
SQLITE4_STATIC
);

1717 
	`sqlôe4_°ï
(
pStmt
);

1718 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

1720  
rc
;

1721 
	}
}

1731 
	$·s3PªfixCom¥ess
(

1732 c⁄° *
zPªv
,

1733 
nPªv
,

1734 c⁄° *
zNext
,

1735 
nNext


1737 
n
;

1738 
	`UNUSED_PARAMETER
(
nNext
);

1739 
n
=0;Ç<
nPªv
 && 
zPªv
[n]==
zNext
[n];Ç++);

1740  
n
;

1741 
	}
}

1747 
	$·s3NodeAddTîm
(

1748 
Fts3TabÀ
 *
p
,

1749 
SegmítNode
 **
µTªe
,

1750 
isC›yTîm
,

1751 c⁄° *
zTîm
,

1752 
nTîm


1754 
SegmítNode
 *
pTªe
 = *
µTªe
;

1755 
rc
;

1756 
SegmítNode
 *
pNew
;

1761 if–
pTªe
 ){

1762 
nD©a
 = 
pTªe
->nData;

1763 
nReq
 = 
nD©a
;

1764 
nPªfix
;

1765 
nSuffix
;

1767 
nPªfix
 = 
	`·s3PªfixCom¥ess
(
pTªe
->
zTîm
,ÖTªe->
nTîm
, zTerm,ÇTerm);

1768 
nSuffix
 = 
nTîm
-
nPªfix
;

1770 
nReq
 +
	`sqlôe4Fts3V¨ötLí
(
nPªfix
)+sqlôe4Fts3V¨ötLí(
nSuffix
)+nSuffix;

1771 if–
nReq
<=
p
->
nNodeSize
 || !
pTªe
->
zTîm
 ){

1773 if–
nReq
>
p
->
nNodeSize
 ){

1781 
	`as£π
–
pTªe
->
aD©a
==(*)&pTree[1] );

1782 
pTªe
->
aD©a
 = (*)
	`sqlôe4_mÆloc
(
nReq
);

1783 if–!
pTªe
->
aD©a
 ){

1784  
SQLITE4_NOMEM
;

1788 if–
pTªe
->
zTîm
 ){

1790 
nD©a
 +
	`sqlôe4Fts3PutV¨öt
(&
pTªe
->
aD©a
[nD©a], 
nPªfix
);

1793 
nD©a
 +
	`sqlôe4Fts3PutV¨öt
(&
pTªe
->
aD©a
[nD©a], 
nSuffix
);

1794 
	`mem˝y
(&
pTªe
->
aD©a
[
nD©a
], &
zTîm
[
nPªfix
], 
nSuffix
);

1795 
pTªe
->
nD©a
 =ÇD©®+ 
nSuffix
;

1796 
pTªe
->
nE¡ry
++;

1798 if–
isC›yTîm
 ){

1799 if–
pTªe
->
nMÆloc
<
nTîm
 ){

1800 *
zNew
 = 
	`sqlôe4_ªÆloc
(
pTªe
->
zMÆloc
, 
nTîm
*2);

1801 if–!
zNew
 ){

1802  
SQLITE4_NOMEM
;

1804 
pTªe
->
nMÆloc
 = 
nTîm
*2;

1805 
pTªe
->
zMÆloc
 = 
zNew
;

1807 
pTªe
->
zTîm
 =ÖTªe->
zMÆloc
;

1808 
	`mem˝y
(
pTªe
->
zTîm
, zTîm, 
nTîm
);

1809 
pTªe
->
nTîm
 =ÇTerm;

1811 
pTªe
->
zTîm
 = (*)zTerm;

1812 
pTªe
->
nTîm
 =ÇTerm;

1814  
SQLITE4_OK
;

1826 
pNew
 = (
SegmítNode
 *)
	`sqlôe4_mÆloc
((SegmítNodeË+ 
p
->
nNodeSize
);

1827 if–!
pNew
 ){

1828  
SQLITE4_NOMEM
;

1830 
	`mem£t
(
pNew
, 0, (
SegmítNode
));

1831 
pNew
->
nD©a
 = 1 + 
FTS3_VARINT_MAX
;

1832 
pNew
->
aD©a
 = (*)&pNew[1];

1834 if–
pTªe
 ){

1835 
SegmítNode
 *
pP¨ít
 = 
pTªe
->pParent;

1836 
rc
 = 
	`·s3NodeAddTîm
(
p
, &
pP¨ít
, 
isC›yTîm
, 
zTîm
, 
nTîm
);

1837 if–
pTªe
->
pP¨ít
==0 ){

1838 
pTªe
->
pP¨ít
 =ÖParent;

1840 
pTªe
->
pRight
 = 
pNew
;

1841 
pNew
->
pLe·mo°
 = 
pTªe
->pLeftmost;

1842 
pNew
->
pP¨ít
 =ÖParent;

1843 
pNew
->
zMÆloc
 = 
pTªe
->zMalloc;

1844 
pNew
->
nMÆloc
 = 
pTªe
->nMalloc;

1845 
pTªe
->
zMÆloc
 = 0;

1847 
pNew
->
pLe·mo°
 =ÖNew;

1848 
rc
 = 
	`·s3NodeAddTîm
(
p
, &
pNew
, 
isC›yTîm
, 
zTîm
, 
nTîm
);

1851 *
µTªe
 = 
pNew
;

1852  
rc
;

1853 
	}
}

1858 
	$·s3TªeFöishNode
(

1859 
SegmítNode
 *
pTªe
,

1860 
iHeight
,

1861 
sqlôe4_öt64
 
iLe·Chûd


1863 
nSèπ
;

1864 
	`as£π
–
iHeight
>=1 && iHeight<128 );

1865 
nSèπ
 = 
FTS3_VARINT_MAX
 - 
	`sqlôe4Fts3V¨ötLí
(
iLe·Chûd
);

1866 
pTªe
->
aD©a
[
nSèπ
] = ()
iHeight
;

1867 
	`sqlôe4Fts3PutV¨öt
(&
pTªe
->
aD©a
[
nSèπ
+1], 
iLe·Chûd
);

1868  
nSèπ
;

1869 
	}
}

1884 
	$·s3NodeWrôe
(

1885 
Fts3TabÀ
 *
p
,

1886 
SegmítNode
 *
pTªe
,

1887 
iHeight
,

1888 
sqlôe4_öt64
 
iLóf
,

1889 
sqlôe4_öt64
 
iFªe
,

1890 
sqlôe4_öt64
 *
piLa°
,

1891 **
∑RoŸ
,

1892 *
≤RoŸ


1894 
rc
 = 
SQLITE4_OK
;

1896 if–!
pTªe
->
pP¨ít
 ){

1898 
nSèπ
 = 
	`·s3TªeFöishNode
(
pTªe
, 
iHeight
, 
iLóf
);

1899 *
piLa°
 = 
iFªe
-1;

1900 *
≤RoŸ
 = 
pTªe
->
nD©a
 - 
nSèπ
;

1901 *
∑RoŸ
 = &
pTªe
->
aD©a
[
nSèπ
];

1903 
SegmítNode
 *
pIãr
;

1904 
sqlôe4_öt64
 
iNextFªe
 = 
iFªe
;

1905 
sqlôe4_öt64
 
iNextLóf
 = 
iLóf
;

1906 
pIãr
=
pTªe
->
pLe·mo°
;ÖIã∏&& 
rc
==
SQLITE4_OK
;ÖIãrıIãr->
pRight
){

1907 
nSèπ
 = 
	`·s3TªeFöishNode
(
pIãr
, 
iHeight
, 
iNextLóf
);

1908 
nWrôe
 = 
pIãr
->
nD©a
 - 
nSèπ
;

1910 
rc
 = 
	`·s3WrôeSegmít
(
p
, 
iNextFªe
, &
pIãr
->
aD©a
[
nSèπ
], 
nWrôe
);

1911 
iNextFªe
++;

1912 
iNextLóf
 +(
pIãr
->
nE¡ry
+1);

1914 if–
rc
==
SQLITE4_OK
 ){

1915 
	`as£π
–
iNextLóf
==
iFªe
 );

1916 
rc
 = 
	`·s3NodeWrôe
(

1917 
p
, 
pTªe
->
pP¨ít
, 
iHeight
+1, 
iFªe
, 
iNextFªe
, 
piLa°
, 
∑RoŸ
, 
≤RoŸ


1922  
rc
;

1923 
	}
}

1928 
	$·s3NodeFªe
(
SegmítNode
 *
pTªe
){

1929 if–
pTªe
 ){

1930 
SegmítNode
 *
p
 = 
pTªe
->
pLe·mo°
;

1931 
	`·s3NodeFªe
(
p
->
pP¨ít
);

1932  
p
 ){

1933 
SegmítNode
 *
pRight
 = 
p
->pRight;

1934 if–
p
->
aD©a
!=(*)&p[1] ){

1935 
	`sqlôe4_‰ì
(
p
->
aD©a
);

1937 
	`as£π
–
pRight
==0 || 
p
->
zMÆloc
==0 );

1938 
	`sqlôe4_‰ì
(
p
->
zMÆloc
);

1939 
	`sqlôe4_‰ì
(
p
);

1940 
p
 = 
pRight
;

1943 
	}
}

1953 
	$·s3SegWrôîAdd
(

1954 
Fts3TabÀ
 *
p
,

1955 
SegmítWrôî
 **
µWrôî
,

1956 
isC›yTîm
,

1957 c⁄° *
zTîm
,

1958 
nTîm
,

1959 c⁄° *
aDo˛i°
,

1960 
nDo˛i°


1962 
nPªfix
;

1963 
nSuffix
;

1964 
nReq
;

1965 
nD©a
;

1966 
SegmítWrôî
 *
pWrôî
 = *
µWrôî
;

1968 if–!
pWrôî
 ){

1969 
rc
;

1970 
sqlôe4_°mt
 *
pStmt
;

1973 
pWrôî
 = (
SegmítWrôî
 *)
	`sqlôe4_mÆloc
((SegmentWriter));

1974 if–!
pWrôî
 )  
SQLITE4_NOMEM
;

1975 
	`mem£t
(
pWrôî
, 0, (
SegmítWrôî
));

1976 *
µWrôî
 = 
pWrôî
;

1979 
pWrôî
->
aD©a
 = (*)
	`sqlôe4_mÆloc
(
p
->
nNodeSize
);

1980 if–!
pWrôî
->
aD©a
 )  
SQLITE4_NOMEM
;

1981 
pWrôî
->
nSize
 = 
p
->
nNodeSize
;

1984 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_NEXT_SEGMENTS_ID
, &
pStmt
, 0);

1985 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1986 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

1987 
pWrôî
->
iFªe
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 0);

1988 
pWrôî
->
iFú°
 =ÖWrôî->
iFªe
;

1990 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

1991 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1993 
nD©a
 = 
pWrôî
->nData;

1995 
nPªfix
 = 
	`·s3PªfixCom¥ess
(
pWrôî
->
zTîm
,ÖWrôî->
nTîm
, zTerm,ÇTerm);

1996 
nSuffix
 = 
nTîm
-
nPªfix
;

1999 
nReq
 = 
	`sqlôe4Fts3V¨ötLí
(
nPªfix
) +

2000 
	`sqlôe4Fts3V¨ötLí
(
nSuffix
) +

2001 
nSuffix
 +

2002 
	`sqlôe4Fts3V¨ötLí
(
nDo˛i°
) +

2003 
nDo˛i°
;

2005 if–
nD©a
>0 &&ÇD©a+
nReq
>
p
->
nNodeSize
 ){

2006 
rc
;

2009 
rc
 = 
	`·s3WrôeSegmít
(
p
, 
pWrôî
->
iFªe
++,ÖWrôî->
aD©a
, 
nD©a
);

2010 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2024 
	`as£π
–
nPªfix
<
nTîm
 );

2025 
rc
 = 
	`·s3NodeAddTîm
(
p
, &
pWrôî
->
pTªe
, 
isC›yTîm
, 
zTîm
, 
nPªfix
+1);

2026 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2028 
nD©a
 = 0;

2029 
pWrôî
->
nTîm
 = 0;

2031 
nPªfix
 = 0;

2032 
nSuffix
 = 
nTîm
;

2033 
nReq
 = 1 +

2034 
	`sqlôe4Fts3V¨ötLí
(
nTîm
) +

2035 
nTîm
 +

2036 
	`sqlôe4Fts3V¨ötLí
(
nDo˛i°
) +

2037 
nDo˛i°
;

2043 if–
nReq
>
pWrôî
->
nSize
 ){

2044 *
aNew
 = 
	`sqlôe4_ªÆloc
(
pWrôî
->
aD©a
, 
nReq
);

2045 if–!
aNew
 )  
SQLITE4_NOMEM
;

2046 
pWrôî
->
aD©a
 = 
aNew
;

2047 
pWrôî
->
nSize
 = 
nReq
;

2049 
	`as£π
–
nD©a
+
nReq
<=
pWrôî
->
nSize
 );

2052 
nD©a
 +
	`sqlôe4Fts3PutV¨öt
(&
pWrôî
->
aD©a
[nD©a], 
nPªfix
);

2053 
nD©a
 +
	`sqlôe4Fts3PutV¨öt
(&
pWrôî
->
aD©a
[nD©a], 
nSuffix
);

2054 
	`mem˝y
(&
pWrôî
->
aD©a
[
nD©a
], &
zTîm
[
nPªfix
], 
nSuffix
);

2055 
nD©a
 +
nSuffix
;

2056 
nD©a
 +
	`sqlôe4Fts3PutV¨öt
(&
pWrôî
->
aD©a
[nD©a], 
nDo˛i°
);

2057 
	`mem˝y
(&
pWrôî
->
aD©a
[
nD©a
], 
aDo˛i°
, 
nDo˛i°
);

2058 
pWrôî
->
nD©a
 =ÇD©®+ 
nDo˛i°
;

2065 if–
isC›yTîm
 ){

2066 if–
nTîm
>
pWrôî
->
nMÆloc
 ){

2067 *
zNew
 = 
	`sqlôe4_ªÆloc
(
pWrôî
->
zMÆloc
, 
nTîm
*2);

2068 if–!
zNew
 ){

2069  
SQLITE4_NOMEM
;

2071 
pWrôî
->
nMÆloc
 = 
nTîm
*2;

2072 
pWrôî
->
zMÆloc
 = 
zNew
;

2073 
pWrôî
->
zTîm
 = 
zNew
;

2075 
	`as£π
–
pWrôî
->
zTîm
=ıWrôî->
zMÆloc
 );

2076 
	`mem˝y
(
pWrôî
->
zTîm
, zTîm, 
nTîm
);

2078 
pWrôî
->
zTîm
 = (*)zTerm;

2080 
pWrôî
->
nTîm
 =ÇTerm;

2082  
SQLITE4_OK
;

2083 
	}
}

2091 
	$·s3SegWrôîFlush
(

2092 
Fts3TabÀ
 *
p
,

2093 
SegmítWrôî
 *
pWrôî
,

2094 
iLevñ
,

2095 
iIdx


2097 
rc
;

2098 if–
pWrôî
->
pTªe
 ){

2099 
sqlôe4_öt64
 
iLa°
 = 0;

2100 
sqlôe4_öt64
 
iLa°Lóf
;

2101 *
zRoŸ
 = 
NULL
;

2102 
nRoŸ
 = 0;

2104 
iLa°Lóf
 = 
pWrôî
->
iFªe
;

2105 
rc
 = 
	`·s3WrôeSegmít
(
p
, 
pWrôî
->
iFªe
++,ÖWrôî->
aD©a
,ÖWrôî->
nD©a
);

2106 if–
rc
==
SQLITE4_OK
 ){

2107 
rc
 = 
	`·s3NodeWrôe
(
p
, 
pWrôî
->
pTªe
, 1,

2108 
pWrôî
->
iFú°
,ÖWrôî->
iFªe
, &
iLa°
, &
zRoŸ
, &
nRoŸ
);

2110 if–
rc
==
SQLITE4_OK
 ){

2111 
rc
 = 
	`·s3WrôeSegdú
(

2112 
p
, 
iLevñ
, 
iIdx
, 
pWrôî
->
iFú°
, 
iLa°Lóf
, 
iLa°
, 
zRoŸ
, 
nRoŸ
);

2116 
rc
 = 
	`·s3WrôeSegdú
(

2117 
p
, 
iLevñ
, 
iIdx
, 0, 0, 0, 
pWrôî
->
aD©a
,ÖWrôî->
nD©a
);

2119  
rc
;

2120 
	}
}

2126 
	$·s3SegWrôîFªe
(
SegmítWrôî
 *
pWrôî
){

2127 if–
pWrôî
 ){

2128 
	`sqlôe4_‰ì
(
pWrôî
->
aD©a
);

2129 
	`sqlôe4_‰ì
(
pWrôî
->
zMÆloc
);

2130 
	`·s3NodeFªe
(
pWrôî
->
pTªe
);

2131 
	`sqlôe4_‰ì
(
pWrôî
);

2133 
	}
}

2145 
	$·s3IsEm±y
(
Fts3TabÀ
 *
p
, 
sqlôe4_vÆue
 *
pRowid
, *
pisEm±y
){

2146 
sqlôe4_°mt
 *
pStmt
;

2147 
rc
;

2148 if–
p
->
zC⁄ã¡Tbl
 ){

2150 *
pisEm±y
 = 0;

2151 
rc
 = 
SQLITE4_OK
;

2153 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_IS_EMPTY
, &
pStmt
, &
pRowid
);

2154 if–
rc
==
SQLITE4_OK
 ){

2155 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

2156 *
pisEm±y
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

2158 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

2161  
rc
;

2162 
	}
}

2172 
	$·s3SegmítMaxLevñ
(
Fts3TabÀ
 *
p
, 
iIndex
, *
≤Max
){

2173 
sqlôe4_°mt
 *
pStmt
;

2174 
rc
;

2175 
	`as£π
–
iIndex
>=0 && iIndex<
p
->
nIndex
 );

2183 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_SELECT_SEGDIR_MAX_LEVEL
, &
pStmt
, 0);

2184 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2185 
	`sqlôe4_böd_öt
(
pStmt
, 1, 
iIndex
*
FTS3_SEGDIR_MAXLEVEL
);

2186 
	`sqlôe4_böd_öt
(
pStmt
, 2, (
iIndex
+1)*
FTS3_SEGDIR_MAXLEVEL
 - 1);

2187 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

2188 *
≤Max
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

2190  
	`sqlôe4_ª£t
(
pStmt
);

2191 
	}
}

2207 
	$·s3DñëeSegdú
(

2208 
Fts3TabÀ
 *
p
,

2209 
iIndex
,

2210 
iLevñ
,

2211 
Fts3SegRódî
 **
≠Segmít
,

2212 
nRódî


2214 
rc
;

2215 
i
;

2216 
sqlôe4_°mt
 *
pDñëe
;

2218 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_DELETE_SEGMENTS_RANGE
, &
pDñëe
, 0);

2219 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nRódî
; i++){

2220 
Fts3SegRódî
 *
pSegmít
 = 
≠Segmít
[
i
];

2221 if–
pSegmít
->
iSèπBlock
 ){

2222 
	`sqlôe4_böd_öt64
(
pDñëe
, 1, 
pSegmít
->
iSèπBlock
);

2223 
	`sqlôe4_böd_öt64
(
pDñëe
, 2, 
pSegmít
->
iEndBlock
);

2224 
	`sqlôe4_°ï
(
pDñëe
);

2225 
rc
 = 
	`sqlôe4_ª£t
(
pDñëe
);

2228 if–
rc
!=
SQLITE4_OK
 ){

2229  
rc
;

2232 
	`as£π
–
iLevñ
>=0 || iLevñ==
FTS3_SEGCURSOR_ALL
 );

2233 if–
iLevñ
==
FTS3_SEGCURSOR_ALL
 ){

2234 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_DELETE_SEGDIR_RANGE
, &
pDñëe
, 0);

2235 if–
rc
==
SQLITE4_OK
 ){

2236 
	`sqlôe4_böd_öt
(
pDñëe
, 1, 
iIndex
*
FTS3_SEGDIR_MAXLEVEL
);

2237 
	`sqlôe4_böd_öt
(
pDñëe
, 2, (
iIndex
+1Ë* 
FTS3_SEGDIR_MAXLEVEL
 - 1);

2240 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_DELETE_SEGDIR_LEVEL
, &
pDñëe
, 0);

2241 if–
rc
==
SQLITE4_OK
 ){

2242 
	`sqlôe4_böd_öt
(
pDñëe
, 1, 
iIndex
*
FTS3_SEGDIR_MAXLEVEL
 + 
iLevñ
);

2246 if–
rc
==
SQLITE4_OK
 ){

2247 
	`sqlôe4_°ï
(
pDñëe
);

2248 
rc
 = 
	`sqlôe4_ª£t
(
pDñëe
);

2251  
rc
;

2252 
	}
}

2263 
	$·s3CﬁumnFûãr
(

2264 
iCﬁ
,

2265 **
µLi°
,

2266 *
≤Li°


2268 *
pLi°
 = *
µLi°
;

2269 
nLi°
 = *
≤Li°
;

2270 *
pEnd
 = &
pLi°
[
nLi°
];

2271 
iCuºít
 = 0;

2272 *
p
 = 
pLi°
;

2274 
	`as£π
–
iCﬁ
>=0 );

2276 
c
 = 0;

2277  
p
<
pEnd
 && (
c
 | *p)&0xFE ) c = *p++ & 0x80;

2279 if–
iCﬁ
==
iCuºít
 ){

2280 
nLi°
 = ()(
p
 - 
pLi°
);

2284 
nLi°
 -()(
p
 - 
pLi°
);

2285 
pLi°
 = 
p
;

2286 if–
nLi°
==0 ){

2289 
p
 = &
pLi°
[1];

2290 
p
 +
	`sqlôe4Fts3GëV¨öt32
’, &
iCuºít
);

2293 *
µLi°
 = 
pLi°
;

2294 *
≤Li°
 = 
nLi°
;

2295 
	}
}

2304 
	$·s3M§Buf„rD©a
(

2305 
Fts3Mu…iSegRódî
 *
pM§
,

2306 *
pLi°
,

2307 
nLi°


2309 if–
nLi°
>
pM§
->
nBuf„r
 ){

2310 *
pNew
;

2311 
pM§
->
nBuf„r
 = 
nLi°
*2;

2312 
pNew
 = (*)
	`sqlôe4_ªÆloc
(
pM§
->
aBuf„r
,ÖM§->
nBuf„r
);

2313 if–!
pNew
 )  
SQLITE4_NOMEM
;

2314 
pM§
->
aBuf„r
 = 
pNew
;

2317 
	`mem˝y
(
pM§
->
aBuf„r
, 
pLi°
, 
nLi°
);

2318  
SQLITE4_OK
;

2319 
	}
}

2321 
	$sqlôe4Fts3M§In¸Next
(

2322 
Fts3TabÀ
 *
p
,

2323 
Fts3Mu…iSegRódî
 *
pM§
,

2324 
sqlôe4_öt64
 *
piDocid
,

2325 **
∑Po¶i°
,

2326 *
≤Po¶i°


2328 
nMîge
 = 
pM§
->
nAdv™˚
;

2329 
Fts3SegRódî
 **
≠Segmít
 = 
pM§
->apSegment;

2330 (*
xCmp
)(
Fts3SegRódî
 *, Fts3SegReader *) = (

2331 
p
->
bDescIdx
 ? 
·s3SegRódîDo˛i°CmpRev
 : 
·s3SegRódîDo˛i°Cmp


2334 if–
nMîge
==0 ){

2335 *
∑Po¶i°
 = 0;

2336  
SQLITE4_OK
;

2340 
Fts3SegRódî
 *
pSeg
;

2341 
pSeg
 = 
pM§
->
≠Segmít
[0];

2343 if–
pSeg
->
pOff£tLi°
==0 ){

2344 *
∑Po¶i°
 = 0;

2347 
rc
;

2348 *
pLi°
;

2349 
nLi°
;

2350 
j
;

2351 
sqlôe4_öt64
 
iDocid
 = 
≠Segmít
[0]->iDocid;

2353 
rc
 = 
	`·s3SegRódîNextDocid
(
p
, 
≠Segmít
[0], &
pLi°
, &
nLi°
);

2354 
j
 = 1;

2355  
rc
==
SQLITE4_OK


2356 && 
j
<
nMîge


2357 && 
≠Segmít
[
j
]->
pOff£tLi°


2358 && 
≠Segmít
[
j
]->
iDocid
==iDocid

2360 
rc
 = 
	`·s3SegRódîNextDocid
(
p
, 
≠Segmít
[
j
], 0, 0);

2361 
j
++;

2363 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2364 
	`·s3SegRódîS‹t
(
pM§
->
≠Segmít
, 
nMîge
, 
j
, 
xCmp
);

2366 if–
pM§
->
iCﬁFûãr
>=0 ){

2367 
	`·s3CﬁumnFûãr
(
pM§
->
iCﬁFûãr
, &
pLi°
, &
nLi°
);

2370 if–
nLi°
>0 ){

2371 if–
	`·s3SegRódîIsPídög
(
≠Segmít
[0]) ){

2372 
rc
 = 
	`·s3M§Buf„rD©a
(
pM§
, 
pLi°
, 
nLi°
+1);

2373 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2374 *
∑Po¶i°
 = 
pM§
->
aBuf„r
;

2375 
	`as£π
–(
pM§
->
aBuf„r
[
nLi°
] & 0xFE)==0x00 );

2377 *
∑Po¶i°
 = 
pLi°
;

2379 *
piDocid
 = 
iDocid
;

2380 *
≤Po¶i°
 = 
nLi°
;

2386  
SQLITE4_OK
;

2387 
	}
}

2389 
	$·s3SegRódîSèπ
(

2390 
Fts3TabÀ
 *
p
,

2391 
Fts3Mu…iSegRódî
 *
pC§
,

2392 c⁄° *
zTîm
,

2393 
nTîm


2395 
i
;

2396 
nSeg
 = 
pC§
->
nSegmít
;

2404 
i
=0; 
pC§
->
bRe°¨t
==0 && i<pC§->
nSegmít
; i++){

2405 
Fts3SegRódî
 *
pSeg
 = 
pC§
->
≠Segmít
[
i
];

2407 
rc
 = 
	`·s3SegRódîNext
(
p
, 
pSeg
, 0);

2408 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2409 } 
zTîm
 && 
	`·s3SegRódîTîmCmp
(
pSeg
, zTîm, 
nTîm
)<0 );

2411 
	`·s3SegRódîS‹t
(
pC§
->
≠Segmít
, 
nSeg
,ÇSeg, 
·s3SegRódîCmp
);

2413  
SQLITE4_OK
;

2414 
	}
}

2416 
	$sqlôe4Fts3SegRódîSèπ
(

2417 
Fts3TabÀ
 *
p
,

2418 
Fts3Mu…iSegRódî
 *
pC§
,

2419 
Fts3SegFûãr
 *
pFûãr


2421 
pC§
->
pFûãr
 =ÖFilter;

2422  
	`·s3SegRódîSèπ
(
p
, 
pC§
, 
pFûãr
->
zTîm
,ÖFûãr->
nTîm
);

2423 
	}
}

2425 
	$sqlôe4Fts3M§In¸Sèπ
(

2426 
Fts3TabÀ
 *
p
,

2427 
Fts3Mu…iSegRódî
 *
pC§
,

2428 
iCﬁ
,

2429 c⁄° *
zTîm
,

2430 
nTîm


2432 
i
;

2433 
rc
;

2434 
nSegmít
 = 
pC§
->nSegment;

2435 (*
xCmp
)(
Fts3SegRódî
 *, Fts3SegReader *) = (

2436 
p
->
bDescIdx
 ? 
·s3SegRódîDo˛i°CmpRev
 : 
·s3SegRódîDo˛i°Cmp


2439 
	`as£π
–
pC§
->
pFûãr
==0 );

2440 
	`as£π
–
zTîm
 && 
nTîm
>0 );

2443 
rc
 = 
	`·s3SegRódîSèπ
(
p
, 
pC§
, 
zTîm
, 
nTîm
);

2444 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2447 
i
=0; i<
nSegmít
; i++){

2448 
Fts3SegRódî
 *
pSeg
 = 
pC§
->
≠Segmít
[
i
];

2449 if–!
pSeg
->
aNode
 || 
	`·s3SegRódîTîmCmp
’Seg, 
zTîm
, 
nTîm
) ){

2453 
pC§
->
nAdv™˚
 = 
i
;

2456 
i
=0; i<
pC§
->
nAdv™˚
; i++){

2457 
rc
 = 
	`·s3SegRódîFú°Docid
(
p
, 
pC§
->
≠Segmít
[
i
]);

2458 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2460 
	`·s3SegRódîS‹t
(
pC§
->
≠Segmít
, 
i
, i, 
xCmp
);

2462 
	`as£π
–
iCﬁ
<0 || iCﬁ<
p
->
nCﬁumn
 );

2463 
pC§
->
iCﬁFûãr
 = 
iCﬁ
;

2465  
SQLITE4_OK
;

2466 
	}
}

2480 
	$sqlôe4Fts3M§In¸Re°¨t
(
Fts3Mu…iSegRódî
 *
pC§
){

2481 
i
;

2483 
	`as£π
–
pC§
->
zTîm
==0 );

2484 
	`as£π
–
pC§
->
nTîm
==0 );

2485 
	`as£π
–
pC§
->
aDo˛i°
==0 );

2486 
	`as£π
–
pC§
->
nDo˛i°
==0 );

2488 
pC§
->
nAdv™˚
 = 0;

2489 
pC§
->
bRe°¨t
 = 1;

2490 
i
=0; i<
pC§
->
nSegmít
; i++){

2491 
pC§
->
≠Segmít
[
i
]->
pOff£tLi°
 = 0;

2492 
pC§
->
≠Segmít
[
i
]->
nOff£tLi°
 = 0;

2493 
pC§
->
≠Segmít
[
i
]->
iDocid
 = 0;

2496  
SQLITE4_OK
;

2497 
	}
}

2500 
	$sqlôe4Fts3SegRódîSãp
(

2501 
Fts3TabÀ
 *
p
,

2502 
Fts3Mu…iSegRódî
 *
pC§


2504 
rc
 = 
SQLITE4_OK
;

2506 
isIgn‹eEm±y
 = (
pC§
->
pFûãr
->
Êags
 & 
FTS3_SEGMENT_IGNORE_EMPTY
);

2507 
isRequúePos
 = (
pC§
->
pFûãr
->
Êags
 & 
FTS3_SEGMENT_REQUIRE_POS
);

2508 
isCﬁFûãr
 = (
pC§
->
pFûãr
->
Êags
 & 
FTS3_SEGMENT_COLUMN_FILTER
);

2509 
isPªfix
 = (
pC§
->
pFûãr
->
Êags
 & 
FTS3_SEGMENT_PREFIX
);

2510 
isSˇn
 = (
pC§
->
pFûãr
->
Êags
 & 
FTS3_SEGMENT_SCAN
);

2511 
isFú°
 = (
pC§
->
pFûãr
->
Êags
 & 
FTS3_SEGMENT_FIRST
);

2513 
Fts3SegRódî
 **
≠Segmít
 = 
pC§
->apSegment;

2514 
nSegmít
 = 
pC§
->nSegment;

2515 
Fts3SegFûãr
 *
pFûãr
 = 
pC§
->pFilter;

2516 (*
xCmp
)(
Fts3SegRódî
 *, Fts3SegReader *) = (

2517 
p
->
bDescIdx
 ? 
·s3SegRódîDo˛i°CmpRev
 : 
·s3SegRódîDo˛i°Cmp


2520 if–
pC§
->
nSegmít
==0 )  
SQLITE4_OK
;

2523 
nMîge
;

2524 
i
;

2529 
i
=0; i<
pC§
->
nAdv™˚
; i++){

2530 
rc
 = 
	`·s3SegRódîNext
(
p
, 
≠Segmít
[
i
], 0);

2531 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2533 
	`·s3SegRódîS‹t
(
≠Segmít
, 
nSegmít
, 
pC§
->
nAdv™˚
, 
·s3SegRódîCmp
);

2534 
pC§
->
nAdv™˚
 = 0;

2537 
	`as£π
–
rc
==
SQLITE4_OK
 );

2538 if–
≠Segmít
[0]->
aNode
==0 ) ;

2540 
pC§
->
nTîm
 = 
≠Segmít
[0]->nTerm;

2541 
pC§
->
zTîm
 = 
≠Segmít
[0]->zTerm;

2550 if–
pFûãr
->
zTîm
 && !
isSˇn
 ){

2551 if–
pC§
->
nTîm
<
pFûãr
->nTerm

2552 || (!
isPªfix
 && 
pC§
->
nTîm
>
pFûãr
->nTerm)

2553 || 
	`memcmp
(
pC§
->
zTîm
, 
pFûãr
->zTîm,ÖFûãr->
nTîm
)

2559 
nMîge
 = 1;

2560  
nMîge
<
nSegmít


2561 && 
≠Segmít
[
nMîge
]->
aNode


2562 && 
≠Segmít
[
nMîge
]->
nTîm
==
pC§
->nTerm

2563 && 0==
	`memcmp
(
pC§
->
zTîm
, 
≠Segmít
[
nMîge
]->zTîm,ÖC§->
nTîm
)

2565 
nMîge
++;

2568 
	`as£π
–
isIgn‹eEm±y
 || (
isRequúePos
 && !
isCﬁFûãr
) );

2569 if–
nMîge
==1

2570 && !
isIgn‹eEm±y


2571 && !
isFú°


2572 && (
p
->
bDescIdx
==0 || 
	`·s3SegRódîIsPídög
(
≠Segmít
[0])==0)

2574 
pC§
->
nDo˛i°
 = 
≠Segmít
[0]->nDoclist;

2575 if–
	`·s3SegRódîIsPídög
(
≠Segmít
[0]) ){

2576 
rc
 = 
	`·s3M§Buf„rD©a
(
pC§
, 
≠Segmít
[0]->
aDo˛i°
,ÖC§->
nDo˛i°
);

2577 
pC§
->
aDo˛i°
 =ÖC§->
aBuf„r
;

2579 
pC§
->
aDo˛i°
 = 
≠Segmít
[0]->aDoclist;

2581 if–
rc
==
SQLITE4_OK
 )Ñ¯
SQLITE4_ROW
;

2583 
nDo˛i°
 = 0;

2584 
sqlôe4_öt64
 
iPªv
 = 0;

2590 
i
=0; i<
nMîge
; i++){

2591 
	`·s3SegRódîFú°Docid
(
p
, 
≠Segmít
[
i
]);

2593 
	`·s3SegRódîS‹t
(
≠Segmít
, 
nMîge
,ÇMîge, 
xCmp
);

2594  
≠Segmít
[0]->
pOff£tLi°
 ){

2595 
j
;

2596 *
pLi°
;

2597 
nLi°
;

2598 
nByã
;

2599 
sqlôe4_öt64
 
iDocid
 = 
≠Segmít
[0]->iDocid;

2600 
	`·s3SegRódîNextDocid
(
p
, 
≠Segmít
[0], &
pLi°
, &
nLi°
);

2601 
j
 = 1;

2602  
j
<
nMîge


2603 && 
≠Segmít
[
j
]->
pOff£tLi°


2604 && 
≠Segmít
[
j
]->
iDocid
==iDocid

2606 
	`·s3SegRódîNextDocid
(
p
, 
≠Segmít
[
j
], 0, 0);

2607 
j
++;

2610 if–
isCﬁFûãr
 ){

2611 
	`·s3CﬁumnFûãr
(
pFûãr
->
iCﬁ
, &
pLi°
, &
nLi°
);

2614 if–!
isIgn‹eEm±y
 || 
nLi°
>0 ){

2618 
sqlôe4_öt64
 
iDñè
;

2619 if–
p
->
bDescIdx
 && 
nDo˛i°
>0 ){

2620 
iDñè
 = 
iPªv
 - 
iDocid
;

2622 
iDñè
 = 
iDocid
 - 
iPªv
;

2624 
	`as£π
–
iDñè
>0 || (
nDo˛i°
==0 && iDñè==
iDocid
) );

2625 
	`as£π
–
nDo˛i°
>0 || 
iDñè
==
iDocid
 );

2627 
nByã
 = 
	`sqlôe4Fts3V¨ötLí
(
iDñè
Ë+ (
isRequúePos
?
nLi°
+1:0);

2628 if–
nDo˛i°
+
nByã
>
pC§
->
nBuf„r
 ){

2629 *
aNew
;

2630 
pC§
->
nBuf„r
 = (
nDo˛i°
+
nByã
)*2;

2631 
aNew
 = 
	`sqlôe4_ªÆloc
(
pC§
->
aBuf„r
,ÖC§->
nBuf„r
);

2632 if–!
aNew
 ){

2633  
SQLITE4_NOMEM
;

2635 
pC§
->
aBuf„r
 = 
aNew
;

2638 if–
isFú°
 ){

2639 *
a
 = &
pC§
->
aBuf„r
[
nDo˛i°
];

2640 
nWrôe
;

2642 
nWrôe
 = 
	`sqlôe4Fts3Fú°Fûãr
(
iDñè
, 
pLi°
, 
nLi°
, 
a
);

2643 if–
nWrôe
 ){

2644 
iPªv
 = 
iDocid
;

2645 
nDo˛i°
 +
nWrôe
;

2648 
nDo˛i°
 +
	`sqlôe4Fts3PutV¨öt
(&
pC§
->
aBuf„r
[nDo˛i°], 
iDñè
);

2649 
iPªv
 = 
iDocid
;

2650 if–
isRequúePos
 ){

2651 
	`mem˝y
(&
pC§
->
aBuf„r
[
nDo˛i°
], 
pLi°
, 
nLi°
);

2652 
nDo˛i°
 +
nLi°
;

2653 
pC§
->
aBuf„r
[
nDo˛i°
++] = '\0';

2658 
	`·s3SegRódîS‹t
(
≠Segmít
, 
nMîge
, 
j
, 
xCmp
);

2660 if–
nDo˛i°
>0 ){

2661 
pC§
->
aDo˛i°
 =ÖC§->
aBuf„r
;

2662 
pC§
->
nDo˛i°
 =ÇDoclist;

2663 
rc
 = 
SQLITE4_ROW
;

2666 
pC§
->
nAdv™˚
 = 
nMîge
;

2667 } 
rc
==
SQLITE4_OK
 );

2669  
rc
;

2670 
	}
}

2673 
	$sqlôe4Fts3SegRódîFöish
(

2674 
Fts3Mu…iSegRódî
 *
pC§


2676 if–
pC§
 ){

2677 
i
;

2678 
i
=0; i<
pC§
->
nSegmít
; i++){

2679 
	`sqlôe4Fts3SegRódîFªe
(
pC§
->
≠Segmít
[
i
]);

2681 
	`sqlôe4_‰ì
(
pC§
->
≠Segmít
);

2682 
	`sqlôe4_‰ì
(
pC§
->
aBuf„r
);

2684 
pC§
->
nSegmít
 = 0;

2685 
pC§
->
≠Segmít
 = 0;

2686 
pC§
->
aBuf„r
 = 0;

2688 
	}
}

2701 
	$·s3SegmítMîge
(
Fts3TabÀ
 *
p
, 
iIndex
, 
iLevñ
){

2702 
rc
;

2703 
iIdx
 = 0;

2704 
iNewLevñ
 = 0;

2705 
SegmítWrôî
 *
pWrôî
 = 0;

2706 
Fts3SegFûãr
 
fûãr
;

2707 
Fts3Mu…iSegRódî
 
c§
;

2708 
bIgn‹eEm±y
 = 0;

2710 
	`as£π
–
iLevñ
==
FTS3_SEGCURSOR_ALL


2711 || 
iLevñ
==
FTS3_SEGCURSOR_PENDING


2712 || 
iLevñ
>=0

2714 
	`as£π
–
iLevñ
<
FTS3_SEGDIR_MAXLEVEL
 );

2715 
	`as£π
–
iIndex
>=0 && iIndex<
p
->
nIndex
 );

2717 
rc
 = 
	`sqlôe4Fts3SegRódîCurs‹
(
p
, 
iIndex
, 
iLevñ
, 0, 0, 1, 0, &
c§
);

2718 if–
rc
!=
SQLITE4_OK
 || 
c§
.
nSegmít
==0 ) 
föished
;

2720 if–
iLevñ
==
FTS3_SEGCURSOR_ALL
 ){

2725 if–
c§
.
nSegmít
==1 ){

2726 
rc
 = 
SQLITE4_DONE
;

2727 
föished
;

2729 
rc
 = 
	`·s3SegmítMaxLevñ
(
p
, 
iIndex
, &
iNewLevñ
);

2730 
bIgn‹eEm±y
 = 1;

2732 }if–
iLevñ
==
FTS3_SEGCURSOR_PENDING
 ){

2733 
iNewLevñ
 = 
iIndex
 * 
FTS3_SEGDIR_MAXLEVEL
;

2734 
rc
 = 
	`·s3AŒoˇãSegdúIdx
(
p
, 
iIndex
, 0, &
iIdx
);

2740 
rc
 = 
	`·s3AŒoˇãSegdúIdx
(
p
, 
iIndex
, 
iLevñ
+1, &
iIdx
);

2741 
iNewLevñ
 = 
iIndex
 * 
FTS3_SEGDIR_MAXLEVEL
 + 
iLevñ
+1;

2743 if–
rc
!=
SQLITE4_OK
 ) 
föished
;

2744 
	`as£π
–
c§
.
nSegmít
>0 );

2745 
	`as£π
–
iNewLevñ
>=(
iIndex
*
FTS3_SEGDIR_MAXLEVEL
) );

2746 
	`as£π
–
iNewLevñ
<((
iIndex
+1)*
FTS3_SEGDIR_MAXLEVEL
) );

2748 
	`mem£t
(&
fûãr
, 0, (
Fts3SegFûãr
));

2749 
fûãr
.
Êags
 = 
FTS3_SEGMENT_REQUIRE_POS
;

2750 
fûãr
.
Êags
 |(
bIgn‹eEm±y
 ? 
FTS3_SEGMENT_IGNORE_EMPTY
 : 0);

2752 
rc
 = 
	`sqlôe4Fts3SegRódîSèπ
(
p
, &
c§
, &
fûãr
);

2753  
SQLITE4_OK
==
rc
 ){

2754 
rc
 = 
	`sqlôe4Fts3SegRódîSãp
(
p
, &
c§
);

2755 if–
rc
!=
SQLITE4_ROW
 ) ;

2756 
rc
 = 
	`·s3SegWrôîAdd
(
p
, &
pWrôî
, 1,

2757 
c§
.
zTîm
, c§.
nTîm
, c§.
aDo˛i°
, c§.
nDo˛i°
);

2759 if–
rc
!=
SQLITE4_OK
 ) 
föished
;

2760 
	`as£π
–
pWrôî
 );

2762 if–
iLevñ
!=
FTS3_SEGCURSOR_PENDING
 ){

2763 
rc
 = 
	`·s3DñëeSegdú
(
p
, 
iIndex
, 
iLevñ
, 
c§
.
≠Segmít
, c§.
nSegmít
);

2764 if–
rc
!=
SQLITE4_OK
 ) 
föished
;

2766 
rc
 = 
	`·s3SegWrôîFlush
(
p
, 
pWrôî
, 
iNewLevñ
, 
iIdx
);

2768 
föished
:

2769 
	`·s3SegWrôîFªe
(
pWrôî
);

2770 
	`sqlôe4Fts3SegRódîFöish
(&
c§
);

2771  
rc
;

2772 
	}
}

2778 
	$sqlôe4Fts3PídögTîmsFlush
(
Fts3TabÀ
 *
p
){

2779 
rc
 = 
SQLITE4_OK
;

2780 
i
;

2781 
i
=0; 
rc
==
SQLITE4_OK
 && i<
p
->
nIndex
; i++){

2782 
rc
 = 
	`·s3SegmítMîge
(
p
, 
i
, 
FTS3_SEGCURSOR_PENDING
);

2783 if–
rc
==
SQLITE4_DONE
 )Ñ¯
SQLITE4_OK
;

2785 
	`sqlôe4Fts3PídögTîmsCÀ¨
(
p
);

2786  
rc
;

2787 
	}
}

2792 
	$·s3EncodeI¡Aºay
(

2793 
N
,

2794 
u32
 *
a
,

2795 *
zBuf
,

2796 *
pNBuf


2798 
i
, 
j
;

2799 
i
=
j
=0; i<
N
; i++){

2800 
j
 +
	`sqlôe4Fts3PutV¨öt
(&
zBuf
[j], (
sqlôe4_öt64
)
a
[
i
]);

2802 *
pNBuf
 = 
j
;

2803 
	}
}

2808 
	$·s3DecodeI¡Aºay
(

2809 
N
,

2810 
u32
 *
a
,

2811 c⁄° *
zBuf
,

2812 
nBuf


2814 
i
, 
j
;

2815 
	`UNUSED_PARAMETER
(
nBuf
);

2816 
i
=
j
=0; i<
N
; i++){

2817 
sqlôe4_öt64
 
x
;

2818 
j
 +
	`sqlôe4Fts3GëV¨öt
(&
zBuf
[j], &
x
);

2819 
	`as£π
(
j
<=
nBuf
);

2820 
a
[
i
] = (
u32
)(
x
 & 0xffffffff);

2822 
	}
}

2829 
	$·s3In£πDocsize
(

2830 *
pRC
,

2831 
Fts3TabÀ
 *
p
,

2832 
u32
 *
aSz


2834 *
pBlob
;

2835 
nBlob
;

2836 
sqlôe4_°mt
 *
pStmt
;

2837 
rc
;

2839 if–*
pRC
 ) ;

2840 
pBlob
 = 
	`sqlôe4_mÆloc
–10*
p
->
nCﬁumn
 );

2841 if–
pBlob
==0 ){

2842 *
pRC
 = 
SQLITE4_NOMEM
;

2845 
	`·s3EncodeI¡Aºay
(
p
->
nCﬁumn
, 
aSz
, 
pBlob
, &
nBlob
);

2846 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_REPLACE_DOCSIZE
, &
pStmt
, 0);

2847 if–
rc
 ){

2848 
	`sqlôe4_‰ì
(
pBlob
);

2849 *
pRC
 = 
rc
;

2852 
	`sqlôe4_böd_öt64
(
pStmt
, 1, 
p
->
iPªvDocid
);

2853 
	`sqlôe4_böd_blob
(
pStmt
, 2, 
pBlob
, 
nBlob
, 
sqlôe4_‰ì
);

2854 
	`sqlôe4_°ï
(
pStmt
);

2855 *
pRC
 = 
	`sqlôe4_ª£t
(
pStmt
);

2856 
	}
}

2873 
	$·s3Upd©eDocTŸÆs
(

2874 *
pRC
,

2875 
Fts3TabÀ
 *
p
,

2876 
u32
 *
aSzIns
,

2877 
u32
 *
aSzDñ
,

2878 
nChng


2880 *
pBlob
;

2881 
nBlob
;

2882 
u32
 *
a
;

2883 
sqlôe4_°mt
 *
pStmt
;

2884 
i
;

2885 
rc
;

2887 c⁄° 
nSèt
 = 
p
->
nCﬁumn
+2;

2889 if–*
pRC
 ) ;

2890 
a
 = 
	`sqlôe4_mÆloc
–((
u32
)+10)*
nSèt
 );

2891 if–
a
==0 ){

2892 *
pRC
 = 
SQLITE4_NOMEM
;

2895 
pBlob
 = (*)&
a
[
nSèt
];

2896 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_SELECT_DOCTOTAL
, &
pStmt
, 0);

2897 if–
rc
 ){

2898 
	`sqlôe4_‰ì
(
a
);

2899 *
pRC
 = 
rc
;

2902 if–
	`sqlôe4_°ï
(
pStmt
)==
SQLITE4_ROW
 ){

2903 
	`·s3DecodeI¡Aºay
(
nSèt
, 
a
,

2904 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0),

2905 
	`sqlôe4_cﬁumn_byãs
(
pStmt
, 0));

2907 
	`mem£t
(
a
, 0, (
u32
)*(
nSèt
) );

2909 
	`sqlôe4_ª£t
(
pStmt
);

2910 if–
nChng
<0 && 
a
[0]<(
u32
)(-nChng) ){

2911 
a
[0] = 0;

2913 
a
[0] +
nChng
;

2915 
i
=0; i<
p
->
nCﬁumn
+1; i++){

2916 
u32
 
x
 = 
a
[
i
+1];

2917 if–
x
+
aSzIns
[
i
] < 
aSzDñ
[i] ){

2918 
x
 = 0;

2920 
x
 = x + 
aSzIns
[
i
] - 
aSzDñ
[i];

2922 
a
[
i
+1] = 
x
;

2924 
	`·s3EncodeI¡Aºay
(
nSèt
, 
a
, 
pBlob
, &
nBlob
);

2925 
rc
 = 
	`·s3SqlStmt
(
p
, 
SQL_REPLACE_DOCTOTAL
, &
pStmt
, 0);

2926 if–
rc
 ){

2927 
	`sqlôe4_‰ì
(
a
);

2928 *
pRC
 = 
rc
;

2931 
	`sqlôe4_böd_blob
(
pStmt
, 1, 
pBlob
, 
nBlob
, 
SQLITE4_STATIC
);

2932 
	`sqlôe4_°ï
(
pStmt
);

2933 *
pRC
 = 
	`sqlôe4_ª£t
(
pStmt
);

2934 
	`sqlôe4_‰ì
(
a
);

2935 
	}
}

2937 
	$·s3DoO±imize
(
Fts3TabÀ
 *
p
, 
bRëu∫D⁄e
){

2938 
i
;

2939 
bSìnD⁄e
 = 0;

2940 
rc
 = 
SQLITE4_OK
;

2941 
i
=0; 
rc
==
SQLITE4_OK
 && i<
p
->
nIndex
; i++){

2942 
rc
 = 
	`·s3SegmítMîge
(
p
, 
i
, 
FTS3_SEGCURSOR_ALL
);

2943 if–
rc
==
SQLITE4_DONE
 ){

2944 
bSìnD⁄e
 = 1;

2945 
rc
 = 
SQLITE4_OK
;

2948 
	`sqlôe4Fts3SegmítsClo£
(
p
);

2949 
	`sqlôe4Fts3PídögTîmsCÀ¨
(
p
);

2951  (
rc
==
SQLITE4_OK
 && 
bRëu∫D⁄e
 && 
bSìnD⁄e
Ë? 
SQLITE4_DONE
 :Ñc;

2952 
	}
}

2964 
	$·s3DoRebuûd
(
Fts3TabÀ
 *
p
){

2965 
rc
;

2967 
rc
 = 
	`·s3DñëeAŒ
(
p
, 0);

2968 if–
rc
==
SQLITE4_OK
 ){

2969 
u32
 *
aSz
 = 0;

2970 
u32
 *
aSzIns
 = 0;

2971 
u32
 *
aSzDñ
 = 0;

2972 
sqlôe4_°mt
 *
pStmt
 = 0;

2973 
nE¡ry
 = 0;

2976 *
zSql
 = 
	`sqlôe4_m¥ötf
("SELECT %s" , 
p
->
zRódEx¥li°
);

2977 if–!
zSql
 ){

2978 
rc
 = 
SQLITE4_NOMEM
;

2980 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
p
->
db
, 
zSql
, -1, &
pStmt
, 0);

2981 
	`sqlôe4_‰ì
(
zSql
);

2984 if–
rc
==
SQLITE4_OK
 ){

2985 
nByã
 = (
u32
Ë* (
p
->
nCﬁumn
+1)*3;

2986 
aSz
 = (
u32
 *)
	`sqlôe4_mÆloc
(
nByã
);

2987 if–
aSz
==0 ){

2988 
rc
 = 
SQLITE4_NOMEM
;

2990 
	`mem£t
(
aSz
, 0, 
nByã
);

2991 
aSzIns
 = &
aSz
[
p
->
nCﬁumn
+1];

2992 
aSzDñ
 = &
aSzIns
[
p
->
nCﬁumn
+1];

2996  
rc
==
SQLITE4_OK
 && 
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

2997 
iCﬁ
;

2998 
rc
 = 
	`·s3PídögTîmsDocid
(
p
, 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 0));

2999 
aSz
[
p
->
nCﬁumn
] = 0;

3000 
iCﬁ
=0; 
rc
==
SQLITE4_OK
 && iCﬁ<
p
->
nCﬁumn
; iCol++){

3001 c⁄° *
z
 = (c⁄° *Ë
	`sqlôe4_cﬁumn_ãxt
(
pStmt
, 
iCﬁ
+1);

3002 
rc
 = 
	`·s3PídögTîmsAdd
(
p
, 
z
, 
iCﬁ
, &
aSz
[iCol]);

3003 
aSz
[
p
->
nCﬁumn
] +
	`sqlôe4_cﬁumn_byãs
(
pStmt
, 
iCﬁ
+1);

3005 if–
p
->
bHasDocsize
 ){

3006 
	`·s3In£πDocsize
(&
rc
, 
p
, 
aSz
);

3008 if–
rc
!=
SQLITE4_OK
 ){

3009 
	`sqlôe4_föÆize
(
pStmt
);

3010 
pStmt
 = 0;

3012 
nE¡ry
++;

3013 
iCﬁ
=0; iCﬁ<=
p
->
nCﬁumn
; iCol++){

3014 
aSzIns
[
iCﬁ
] +
aSz
[iCol];

3018 if–
p
->
bHasSèt
 ){

3019 
	`·s3Upd©eDocTŸÆs
(&
rc
, 
p
, 
aSzIns
, 
aSzDñ
, 
nE¡ry
);

3021 
	`sqlôe4_‰ì
(
aSz
);

3023 if–
pStmt
 ){

3024 
rc2
 = 
	`sqlôe4_föÆize
(
pStmt
);

3025 if–
rc
==
SQLITE4_OK
 ){

3026 
rc
 = 
rc2
;

3031  
rc
;

3032 
	}
}

3042 
	$·s3S≥cülIn£π
(
Fts3TabÀ
 *
p
, 
sqlôe4_vÆue
 *
pVÆ
){

3043 
rc
;

3044 c⁄° *
zVÆ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
pVÆ
);

3045 
nVÆ
 = 
	`sqlôe4_vÆue_byãs
(
pVÆ
);

3047 if–!
zVÆ
 ){

3048  
SQLITE4_NOMEM
;

3049 }if–
nVÆ
==8 && 0==
	`sqlôe4_°∫icmp
(
zVÆ
, "optimize", 8) ){

3050 
rc
 = 
	`·s3DoO±imize
(
p
, 0);

3051 }if–
nVÆ
==7 && 0==
	`sqlôe4_°∫icmp
(
zVÆ
, "rebuild", 7) ){

3052 
rc
 = 
	`·s3DoRebuûd
(
p
);

3053 #ifde‡
SQLITE4_TEST


3054 }if–
nVÆ
>9 && 0==
	`sqlôe4_°∫icmp
(
zVÆ
, "nodesize=", 9) ){

3055 
p
->
nNodeSize
 = 
	`©oi
(&
zVÆ
[9]);

3056 
rc
 = 
SQLITE4_OK
;

3057 }if–
nVÆ
>11 && 0==
	`sqlôe4_°∫icmp
(
zVÆ
, "maxpending=", 9) ){

3058 
p
->
nMaxPídögD©a
 = 
	`©oi
(&
zVÆ
[11]);

3059 
rc
 = 
SQLITE4_OK
;

3062 
rc
 = 
SQLITE4_ERROR
;

3065  
rc
;

3066 
	}
}

3072 
	$sqlôe4Fts3FªeDe„ºedDo˛i°s
(
Fts3Curs‹
 *
pC§
){

3073 
Fts3De„ºedTokí
 *
pDef
;

3074 
pDef
=
pC§
->
pDe„ºed
;ÖDef;ÖDefıDef->
pNext
){

3075 
	`·s3PídögLi°Dñëe
(
pDef
->
pLi°
);

3076 
pDef
->
pLi°
 = 0;

3078 
	}
}

3084 
	$sqlôe4Fts3FªeDe„ºedTokís
(
Fts3Curs‹
 *
pC§
){

3085 
Fts3De„ºedTokí
 *
pDef
;

3086 
Fts3De„ºedTokí
 *
pNext
;

3087 
pDef
=
pC§
->
pDe„ºed
;ÖDef;ÖDef=
pNext
){

3088 
pNext
 = 
pDef
->pNext;

3089 
	`·s3PídögLi°Dñëe
(
pDef
->
pLi°
);

3090 
	`sqlôe4_‰ì
(
pDef
);

3092 
pC§
->
pDe„ºed
 = 0;

3093 
	}
}

3103 
	$sqlôe4Fts3CacheDe„ºedDo˛i°s
(
Fts3Curs‹
 *
pC§
){

3104 
rc
 = 
SQLITE4_OK
;

3105 if–
pC§
->
pDe„ºed
 ){

3106 
i
;

3107 
sqlôe4_öt64
 
iDocid
;

3108 
Fts3De„ºedTokí
 *
pDef
;

3110 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pC§
->
ba£
.
pVèb
;

3111 
sqlôe4_tokíizî
 *
pT
 = 
p
->
pTokíizî
;

3112 
sqlôe4_tokíizî_moduÀ
 c⁄° *
pModuÀ
 = 
pT
->pModule;

3114 
	`as£π
–
pC§
->
isRequúeSìk
==0 );

3115 
iDocid
 = 
	`sqlôe4_cﬁumn_öt64
(
pC§
->
pStmt
, 0);

3117 
i
=0; i<
p
->
nCﬁumn
 && 
rc
==
SQLITE4_OK
; i++){

3118 c⁄° *
zText
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pC§
->
pStmt
, 
i
+1);

3119 
sqlôe4_tokíizî_curs‹
 *
pTC
 = 0;

3121 
rc
 = 
pModuÀ
->
	`xO≥n
(
pT
, 
zText
, -1, &
pTC
);

3122  
rc
==
SQLITE4_OK
 ){

3123 c⁄° *
zTokí
;

3124 
nTokí
;

3125 
iDum1
, 
iDum2
;

3126 
iPos
;

3128 
pTC
->
pTokíizî
 = 
pT
;

3129 
rc
 = 
pModuÀ
->
	`xNext
(
pTC
, &
zTokí
, &
nTokí
, &
iDum1
, &
iDum2
, &
iPos
);

3130 
pDef
=
pC§
->
pDe„ºed
;ÖDe‡&& 
rc
==
SQLITE4_OK
;ÖDefıDef->
pNext
){

3131 
Fts3Phø£Tokí
 *
pPT
 = 
pDef
->
pTokí
;

3132 if–(
pDef
->
iCﬁ
>=
p
->
nCﬁumn
 ||ÖDef->iCﬁ==
i
)

3133 && (
pPT
->
bFú°
==0 || 
iPos
==0)

3134 && (
pPT
->
n
==
nTokí
 || (pPT->
isPªfix
 &&ÖPT->n<nToken))

3135 && (0==
	`memcmp
(
zTokí
, 
pPT
->
z
,ÖPT->
n
))

3137 
	`·s3PídögLi°Aµíd
(&
pDef
->
pLi°
, 
iDocid
, 
i
, 
iPos
, &
rc
);

3141 if–
pTC
 ) 
pModuÀ
->
	`xClo£
(pTC);

3142 if–
rc
==
SQLITE4_DONE
 )Ñ¯
SQLITE4_OK
;

3145 
pDef
=
pC§
->
pDe„ºed
;ÖDe‡&& 
rc
==
SQLITE4_OK
;ÖDefıDef->
pNext
){

3146 if–
pDef
->
pLi°
 ){

3147 
rc
 = 
	`·s3PídögLi°AµídV¨öt
(&
pDef
->
pLi°
, 0);

3152  
rc
;

3153 
	}
}

3155 
	$sqlôe4Fts3De„ºedTokíLi°
(

3156 
Fts3De„ºedTokí
 *
p
,

3157 **
µD©a
,

3158 *
≤D©a


3160 *
pRë
;

3161 
nSkù
;

3162 
sqlôe4_öt64
 
dummy
;

3164 *
µD©a
 = 0;

3165 *
≤D©a
 = 0;

3167 if–
p
->
pLi°
==0 ){

3168  
SQLITE4_OK
;

3171 
pRë
 = (*)
	`sqlôe4_mÆloc
(
p
->
pLi°
->
nD©a
);

3172 if–!
pRë
 )  
SQLITE4_NOMEM
;

3174 
nSkù
 = 
	`sqlôe4Fts3GëV¨öt
(
p
->
pLi°
->
aD©a
, &
dummy
);

3175 *
≤D©a
 = 
p
->
pLi°
->
nD©a
 - 
nSkù
;

3176 *
µD©a
 = 
pRë
;

3178 
	`mem˝y
(
pRë
, &
p
->
pLi°
->
aD©a
[
nSkù
], *
≤D©a
);

3179  
SQLITE4_OK
;

3180 
	}
}

3185 
	$sqlôe4Fts3De„rTokí
(

3186 
Fts3Curs‹
 *
pC§
,

3187 
Fts3Phø£Tokí
 *
pTokí
,

3188 
iCﬁ


3190 
Fts3De„ºedTokí
 *
pDe„ºed
;

3191 
pDe„ºed
 = 
	`sqlôe4_mÆloc
((*pDeferred));

3192 if–!
pDe„ºed
 ){

3193  
SQLITE4_NOMEM
;

3195 
	`mem£t
(
pDe„ºed
, 0, (*pDeferred));

3196 
pDe„ºed
->
pTokí
 =ÖToken;

3197 
pDe„ºed
->
pNext
 = 
pC§
->pDeferred;

3198 
pDe„ºed
->
iCﬁ
 = iCol;

3199 
pC§
->
pDe„ºed
 =ÖDeferred;

3201 
	`as£π
–
pTokí
->
pDe„ºed
==0 );

3202 
pTokí
->
pDe„ºed
 =ÖDeferred;

3204  
SQLITE4_OK
;

3205 
	}
}

3212 
	$·s3DñëeByRowid
(

3213 
Fts3TabÀ
 *
p
,

3214 
sqlôe4_vÆue
 *
pRowid
,

3215 *
≤Doc
,

3216 
u32
 *
aSzDñ


3218 
isEm±y
 = 0;

3219 
rc
 = 
	`·s3IsEm±y
(
p
, 
pRowid
, &
isEm±y
);

3220 if–
rc
==
SQLITE4_OK
 ){

3221 if–
isEm±y
 ){

3225 
rc
 = 
	`·s3DñëeAŒ
(
p
, 1);

3226 *
≤Doc
 = *pnDoc - 1;

3228 
sqlôe4_öt64
 
iRemove
 = 
	`sqlôe4_vÆue_öt64
(
pRowid
);

3229 
rc
 = 
	`·s3PídögTîmsDocid
(
p
, 
iRemove
);

3230 
	`·s3DñëeTîms
(&
rc
, 
p
, 
pRowid
, 
aSzDñ
);

3231 if–
p
->
zC⁄ã¡Tbl
==0 ){

3232 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_CONTENT
, &
pRowid
);

3233 if–
	`sqlôe4_ch™ges
(
p
->
db
ËË*
≤Doc
 = *pnDoc - 1;

3235 *
≤Doc
 = *pnDoc - 1;

3237 if–
p
->
bHasDocsize
 ){

3238 
	`·s3SqlExec
(&
rc
, 
p
, 
SQL_DELETE_DOCSIZE
, &
pRowid
);

3243  
rc
;

3244 
	}
}

3250 
	$sqlôe4Fts3Upd©eMëhod
(

3251 
sqlôe4_vèb
 *
pVèb
,

3252 
nArg
,

3253 
sqlôe4_vÆue
 **
≠VÆ
,

3254 
sqlôe_öt64
 *
pRowid


3256 
Fts3TabÀ
 *
p
 = (Fts3TabÀ *)
pVèb
;

3257 
rc
 = 
SQLITE4_OK
;

3258 
isRemove
 = 0;

3259 
u32
 *
aSzIns
 = 0;

3260 
u32
 *
aSzDñ
;

3261 
nChng
 = 0;

3262 
bIn£πD⁄e
 = 0;

3264 
	`as£π
–
p
->
pSegmíts
==0 );

3270 if–
nArg
>1

3271 && 
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[0])==
SQLITE4_NULL


3272 && 
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[
p
->
nCﬁumn
+2])!=
SQLITE4_NULL


3274 
rc
 = 
	`·s3S≥cülIn£π
(
p
, 
≠VÆ
[p->
nCﬁumn
+2]);

3275 
upd©e_out
;

3279 
aSzIns
 = 
	`sqlôe4_mÆloc
–◊SzIns[0])*(
p
->
nCﬁumn
+1)*2 );

3280 if–
aSzIns
==0 ){

3281 
rc
 = 
SQLITE4_NOMEM
;

3282 
upd©e_out
;

3284 
aSzDñ
 = &
aSzIns
[
p
->
nCﬁumn
+1];

3285 
	`mem£t
(
aSzIns
, 0, ◊SzIns[0])*(
p
->
nCﬁumn
+1)*2);

3296 if–
nArg
>1 && 
p
->
zC⁄ã¡Tbl
==0 ){

3298 
sqlôe4_vÆue
 *
pNewRowid
 = 
≠VÆ
[3+
p
->
nCﬁumn
];

3299 if–
	`sqlôe4_vÆue_ty≥
(
pNewRowid
)==
SQLITE4_NULL
 ){

3300 
pNewRowid
 = 
≠VÆ
[1];

3303 if–
	`sqlôe4_vÆue_ty≥
(
pNewRowid
)!=
SQLITE4_NULL
 && (

3304 
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[0])==
SQLITE4_NULL


3305 || 
	`sqlôe4_vÆue_öt64
(
≠VÆ
[0])!=sqlôe4_vÆue_öt64(
pNewRowid
)

3324 if–
	`sqlôe4_vèb_⁄_c⁄Êi˘
(
p
->
db
)==
SQLITE4_REPLACE
 ){

3325 
rc
 = 
	`·s3DñëeByRowid
(
p
, 
pNewRowid
, &
nChng
, 
aSzDñ
);

3327 
rc
 = 
	`·s3In£πD©a
(
p
, 
≠VÆ
, 
pRowid
);

3328 
bIn£πD⁄e
 = 1;

3332 if–
rc
!=
SQLITE4_OK
 ){

3333 
upd©e_out
;

3337 if–
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[0])!=
SQLITE4_NULL
 ){

3338 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[0])==
SQLITE4_INTEGER
 );

3339 
rc
 = 
	`·s3DñëeByRowid
(
p
, 
≠VÆ
[0], &
nChng
, 
aSzDñ
);

3340 
isRemove
 = 1;

3344 if–
nArg
>1 && 
rc
==
SQLITE4_OK
 ){

3345 if–
bIn£πD⁄e
==0 ){

3346 
rc
 = 
	`·s3In£πD©a
(
p
, 
≠VÆ
, 
pRowid
);

3347 if–
rc
==
SQLITE4_CONSTRAINT
 && 
p
->
zC⁄ã¡Tbl
==0 ){

3348 
rc
 = 
FTS_CORRUPT_VTAB
;

3351 if–
rc
==
SQLITE4_OK
 && (!
isRemove
 || *
pRowid
!=
p
->
iPªvDocid
 ) ){

3352 
rc
 = 
	`·s3PídögTîmsDocid
(
p
, *
pRowid
);

3354 if–
rc
==
SQLITE4_OK
 ){

3355 
	`as£π
–
p
->
iPªvDocid
==*
pRowid
 );

3356 
rc
 = 
	`·s3In£πTîms
(
p
, 
≠VÆ
, 
aSzIns
);

3358 if–
p
->
bHasDocsize
 ){

3359 
	`·s3In£πDocsize
(&
rc
, 
p
, 
aSzIns
);

3361 
nChng
++;

3364 if–
p
->
bHasSèt
 ){

3365 
	`·s3Upd©eDocTŸÆs
(&
rc
, 
p
, 
aSzIns
, 
aSzDñ
, 
nChng
);

3368 
upd©e_out
:

3369 
	`sqlôe4_‰ì
(
aSzIns
);

3370 
	`sqlôe4Fts3SegmítsClo£
(
p
);

3371  
rc
;

3372 
	}
}

3379 
	$sqlôe4Fts3O±imize
(
Fts3TabÀ
 *
p
){

3380 
rc
;

3381 
rc
 = 
	`sqlôe4_exec
(
p
->
db
, "SAVEPOINT fts3", 0, 0, 0);

3382 if–
rc
==
SQLITE4_OK
 ){

3383 
rc
 = 
	`·s3DoO±imize
(
p
, 1);

3384 if–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_DONE
 ){

3385 
rc2
 = 
	`sqlôe4_exec
(
p
->
db
, "RELEASE fts3", 0, 0, 0);

3386 if–
rc2
!=
SQLITE4_OK
 ) 
rc
 =Ñc2;

3388 
	`sqlôe4_exec
(
p
->
db
, "ROLLBACK TO fts3", 0, 0, 0);

3389 
	`sqlôe4_exec
(
p
->
db
, "RELEASE fts3", 0, 0, 0);

3392 
	`sqlôe4Fts3SegmítsClo£
(
p
);

3393  
rc
;

3394 
	}
}

	@ext/icu/icu.c

31 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_ICU
)

34 
	~<unicode/uty≥s.h
>

35 
	~<unicode/uªgex.h
>

36 
	~<unicode/u°rög.h
>

37 
	~<unicode/ucﬁ.h
>

39 
	~<as£π.h
>

41 #i‚de‡
SQLITE4_CORE


42 
	~"sqlôe4ext.h
"

43 
	gSQLITE4_EXTENSION_INIT1


45 
	~"sqlôe4.h
"

52 #i‚de‡
SQLITE4_MAX_LIKE_PATTERN_LENGTH


53 
	#SQLITE4_MAX_LIKE_PATTERN_LENGTH
 50000

	)

59 
	$xFªe
(*
p
){

60 
	`sqlôe4_‰ì
(
p
);

61 
	}
}

68 
	$icuLikeCom∑ª
(

69 c⁄° 
uöt8_t
 *
zP©ã∫
,

70 c⁄° 
uöt8_t
 *
zSåög
,

71 c⁄° 
UCh¨32
 
uEsc


73 c⁄° 
MATCH_ONE
 = (
UCh¨32
)'_';

74 c⁄° 
MATCH_ALL
 = (
UCh¨32
)'%';

76 
iP©ã∫
 = 0;

77 
iSåög
 = 0;

79 
¥evEsˇ≥
 = 0;

81  
zP©ã∫
[
iP©ã∫
]!=0 ){

84 
UCh¨32
 
uP©ã∫
;

85 
	`U8_NEXT_UNSAFE
(
zP©ã∫
, 
iP©ã∫
, 
uP©ã∫
);

86 
	`as£π
(
uP©ã∫
!=0);

95 if–!
¥evEsˇ≥
 && 
uP©ã∫
==
MATCH_ALL
 ){

97 
uöt8_t
 
c
;

103  (
c
=
zP©ã∫
[
iP©ã∫
]Ë=
MATCH_ALL
 || c =
MATCH_ONE
 ){

104 if–
c
==
MATCH_ONE
 ){

105 if–
zSåög
[
iSåög
]==0 )  0;

106 
	`U8_FWD_1_UNSAFE
(
zSåög
, 
iSåög
);

108 
iP©ã∫
++;

111 if–
zP©ã∫
[
iP©ã∫
]==0 )  1;

113  
zSåög
[
iSåög
] ){

114 if–
	`icuLikeCom∑ª
(&
zP©ã∫
[
iP©ã∫
], &
zSåög
[
iSåög
], 
uEsc
) ){

117 
	`U8_FWD_1_UNSAFE
(
zSåög
, 
iSåög
);

121 }if–!
¥evEsˇ≥
 && 
uP©ã∫
==
MATCH_ONE
 ){

123 if–
zSåög
[
iSåög
]==0 )  0;

124 
	`U8_FWD_1_UNSAFE
(
zSåög
, 
iSåög
);

126 }if–!
¥evEsˇ≥
 && 
uP©ã∫
==
uEsc
){

128 
¥evEsˇ≥
 = 1;

132 
UCh¨32
 
uSåög
;

133 
	`U8_NEXT_UNSAFE
(
zSåög
, 
iSåög
, 
uSåög
);

134 
uSåög
 = 
	`u_fﬁdCa£
(uSåög, 
U_FOLD_CASE_DEFAULT
);

135 
uP©ã∫
 = 
	`u_fﬁdCa£
(uP©ã∫, 
U_FOLD_CASE_DEFAULT
);

136 if–
uSåög
!=
uP©ã∫
 ){

139 
¥evEsˇ≥
 = 0;

143  
zSåög
[
iSåög
]==0;

144 
	}
}

159 
	$icuLikeFunc
(

160 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

161 
¨gc
,

162 
sqlôe4_vÆue
 **
¨gv


164 c⁄° *
zA
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

165 c⁄° *
zB
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

166 
UCh¨32
 
uEsc
 = 0;

171 if–
	`sqlôe4_vÆue_byãs
(
¨gv
[0])>
SQLITE4_MAX_LIKE_PATTERN_LENGTH
 ){

172 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "LIKE or GLOBÖatternÅoo complex", -1);

177 if–
¨gc
==3 ){

181 
nE

	`sqlôe4_vÆue_byãs
(
¨gv
[2]);

182 c⁄° *
zE
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[2]);

183 
i
 = 0;

184 if–
zE
==0 ) ;

185 
	`U8_NEXT
(
zE
, 
i
, 
nE
, 
uEsc
);

186 if–
i
!=
nE
){

187 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
,

193 if–
zA
 && 
zB
 ){

194 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
	`icuLikeCom∑ª
(
zA
, 
zB
, 
uEsc
));

196 
	}
}

205 
	$icuFun˘i⁄Eº‹
(

206 
sqlôe4_c⁄ãxt
 *
pCtx
,

207 c⁄° *
zName
,

208 
UEº‹Code
 
e


210 
zBuf
[128];

211 
	`sqlôe4_¢¥ötf
(128, 
zBuf
, "ICUÉº‹: %s(): %s", 
zName
, 
	`u_îr‹Name
(
e
));

212 
zBuf
[127] = '\0';

213 
	`sqlôe4_ªsu…_îr‹
(
pCtx
, 
zBuf
, -1);

214 
	}
}

220 
	$icuRegexpDñëe
(*
p
){

221 
UReguœrEx¥essi⁄
 *
pEx¥
 = (UReguœrEx¥essi⁄ *)
p
;

222 
	`uªgex_˛o£
(
pEx¥
);

223 
	}
}

244 
	$icuRegexpFunc
(
sqlôe4_c⁄ãxt
 *
p
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

245 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

246 
UReguœrEx¥essi⁄
 *
pEx¥
;

247 
UBoﬁ
 
ªs
;

248 c⁄° 
UCh¨
 *
zSåög
 = 
	`sqlôe4_vÆue_ãxt16
(
≠Arg
[1]);

250 ()
nArg
;

255 if–!
zSåög
 ){

259 
pEx¥
 = 
	`sqlôe4_gë_auxd©a
(
p
, 0);

260 if–!
pEx¥
 ){

261 c⁄° 
UCh¨
 *
zP©ã∫
 = 
	`sqlôe4_vÆue_ãxt16
(
≠Arg
[0]);

262 if–!
zP©ã∫
 ){

265 
pEx¥
 = 
	`uªgex_›í
(
zP©ã∫
, -1, 0, 0, &
°©us
);

267 if–
	`U_SUCCESS
(
°©us
) ){

268 
	`sqlôe4_£t_auxd©a
(
p
, 0, 
pEx¥
, 
icuRegexpDñëe
);

270 
	`as£π
(!
pEx¥
);

271 
	`icuFun˘i⁄Eº‹
(
p
, "uªgex_›í", 
°©us
);

277 
	`uªgex_£tText
(
pEx¥
, 
zSåög
, -1, &
°©us
);

278 if–!
	`U_SUCCESS
(
°©us
) ){

279 
	`icuFun˘i⁄Eº‹
(
p
, "uªgex_£tText", 
°©us
);

284 
ªs
 = 
	`uªgex_m©ches
(
pEx¥
, 0, &
°©us
);

285 if–!
	`U_SUCCESS
(
°©us
) ){

286 
	`icuFun˘i⁄Eº‹
(
p
, "uªgex_m©ches", 
°©us
);

295 
	`uªgex_£tText
(
pEx¥
, 0, 0, &
°©us
);

298 
	`sqlôe4_ªsu…_öt
(
p
, 
ªs
 ? 1 : 0);

299 
	}
}

327 
	$icuCa£Func16
(
sqlôe4_c⁄ãxt
 *
p
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

328 c⁄° 
UCh¨
 *
zI≈ut
;

329 
UCh¨
 *
zOuçut
;

330 
nI≈ut
;

331 
nOuçut
;

333 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

334 c⁄° *
zLoˇÀ
 = 0;

336 
	`as£π
(
nArg
==1 ||ÇArg==2);

337 if–
nArg
==2 ){

338 
zLoˇÀ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠Arg
[1]);

341 
zI≈ut
 = 
	`sqlôe4_vÆue_ãxt16
(
≠Arg
[0]);

342 if–!
zI≈ut
 ){

345 
nI≈ut
 = 
	`sqlôe4_vÆue_byãs16
(
≠Arg
[0]);

347 
nOuçut
 = 
nI≈ut
 * 2 + 2;

348 
zOuçut
 = 
	`sqlôe4_mÆloc
(
nOuçut
);

349 if–!
zOuçut
 ){

353 if–
	`sqlôe4_u£r_d©a
(
p
) ){

354 
	`u_°rToUµî
(
zOuçut
, 
nOuçut
/2, 
zI≈ut
, 
nI≈ut
/2, 
zLoˇÀ
, &
°©us
);

356 
	`u_°rToLowî
(
zOuçut
, 
nOuçut
/2, 
zI≈ut
, 
nI≈ut
/2, 
zLoˇÀ
, &
°©us
);

359 if–!
	`U_SUCCESS
(
°©us
) ){

360 
	`icuFun˘i⁄Eº‹
(
p
, "u_°rToLowî()/u_°rToUµî", 
°©us
);

364 
	`sqlôe4_ªsu…_ãxt16
(
p
, 
zOuçut
, -1, 
xFªe
);

365 
	}
}

371 
	$icuCﬁœti⁄Dñ
(*
pCtx
){

372 
UCﬁœt‹
 *
p
 = (UCﬁœt‹ *)
pCtx
;

373 
	`ucﬁ_˛o£
(
p
);

374 
	}
}

380 
	$icuCﬁœti⁄Cﬁl
(

381 *
pCtx
,

382 
nLe·
,

383 c⁄° *
zLe·
,

384 
nRight
,

385 c⁄° *
zRight


387 
UCﬁœti⁄Resu…
 
ªs
;

388 
UCﬁœt‹
 *
p
 = (UCﬁœt‹ *)
pCtx
;

389 
ªs
 = 
	`ucﬁ_°rcﬁl
(
p
, (
UCh¨
 *)
zLe·
, 
nLe·
/2, (UCh¨ *)
zRight
, 
nRight
/2);

390  
ªs
 ){

391 
UCOL_LESS
:  -1;

392 
UCOL_GREATER
:  +1;

393 
UCOL_EQUAL
:  0;

395 
	`as£π
(!"UnexpectedÑeturn value from ucol_strcoll()");

397 
	}
}

412 
	$icuLﬂdCﬁœti⁄
(

413 
sqlôe4_c⁄ãxt
 *
p
,

414 
nArg
,

415 
sqlôe4_vÆue
 **
≠Arg


417 
sqlôe4
 *
db
 = (sqlôe4 *)
	`sqlôe4_u£r_d©a
(
p
);

418 
UEº‹Code
 
°©us
 = 
U_ZERO_ERROR
;

419 c⁄° *
zLoˇÀ
;

420 c⁄° *
zName
;

421 
UCﬁœt‹
 *
pUCﬁœt‹
;

422 
rc
;

424 
	`as£π
(
nArg
==2);

425 
zLoˇÀ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠Arg
[0]);

426 
zName
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠Arg
[1]);

428 if–!
zLoˇÀ
 || !
zName
 ){

432 
pUCﬁœt‹
 = 
	`ucﬁ_›í
(
zLoˇÀ
, &
°©us
);

433 if–!
	`U_SUCCESS
(
°©us
) ){

434 
	`icuFun˘i⁄Eº‹
(
p
, "ucﬁ_›í", 
°©us
);

437 
	`as£π
(
p
);

439 
rc
 = 
	`sqlôe4_¸óã_cﬁœti⁄_v2
(
db
, 
zName
, 
SQLITE4_UTF16
, (*)
pUCﬁœt‹
,

440 
icuCﬁœti⁄Cﬁl
, 
icuCﬁœti⁄Dñ


442 if–
rc
!=
SQLITE4_OK
 ){

443 
	`ucﬁ_˛o£
(
pUCﬁœt‹
);

444 
	`sqlôe4_ªsu…_îr‹
(
p
, "ErrorÑegistering collation function", -1);

446 
	}
}

451 
	$sqlôe4IcuInô
(
sqlôe4
 *
db
){

452 
	sIcuSˇœr
 {

453 c⁄° *
zName
;

454 
nArg
;

455 
íc
;

456 *
pC⁄ãxt
;

457 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**);

458 } 
sˇœrs
[] = {

459 {"ªgexp", 2, 
SQLITE4_ANY
, 0, 
icuRegexpFunc
},

461 {"lowî", 1, 
SQLITE4_UTF16
, 0, 
icuCa£Func16
},

462 {"lowî", 2, 
SQLITE4_UTF16
, 0, 
icuCa£Func16
},

463 {"uµî", 1, 
SQLITE4_UTF16
, (*)1, 
icuCa£Func16
},

464 {"uµî", 2, 
SQLITE4_UTF16
, (*)1, 
icuCa£Func16
},

466 {"lowî", 1, 
SQLITE4_UTF8
, 0, 
icuCa£Func16
},

467 {"lowî", 2, 
SQLITE4_UTF8
, 0, 
icuCa£Func16
},

468 {"uµî", 1, 
SQLITE4_UTF8
, (*)1, 
icuCa£Func16
},

469 {"uµî", 2, 
SQLITE4_UTF8
, (*)1, 
icuCa£Func16
},

471 {"like", 2, 
SQLITE4_UTF8
, 0, 
icuLikeFunc
},

472 {"like", 3, 
SQLITE4_UTF8
, 0, 
icuLikeFunc
},

474 {"icu_lﬂd_cﬁœti⁄", 2, 
SQLITE4_UTF8
, (*)
db
, 
icuLﬂdCﬁœti⁄
},

477 
rc
 = 
SQLITE4_OK
;

478 
i
;

480 
i
=0; 
rc
==
SQLITE4_OK
 && i<()((
sˇœrs
)/(scalars[0])); i++){

481 
IcuSˇœr
 *
p
 = &
sˇœrs
[
i
];

482 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(

483 
db
, 
p
->
zName
,Ö->
nArg
,Ö->
íc
,Ö->
pC⁄ãxt
,Ö->
xFunc
, 0, 0

487  
rc
;

488 
	}
}

490 #i‡!
SQLITE4_CORE


491 
	$sqlôe4_exãnsi⁄_öô
(

492 
sqlôe4
 *
db
,

493 **
pzEºMsg
,

494 c⁄° 
sqlôe4_≠i_routöes
 *
pApi


496 
	`SQLITE4_EXTENSION_INIT2
(
pApi
)

497  
	`sqlôe4IcuInô
(
db
);

498 
	}
}

	@ext/icu/sqliteicu.h

16 
	~"sqlôe4.h
"

18 #ifde‡
__˝lu•lus


22 
sqlôe4IcuInô
(
sqlôe4
 *
db
);

24 #ifde‡
__˝lu•lus


	@ext/rtree/rtree.c

55 #i‡!
deföed
(
SQLITE4_CORE
Ë|| deföed(
SQLITE4_ENABLE_RTREE
)

68 
	#VARIANT_RSTARTREE_CHOOSESUBTREE
 0

	)

69 
	#VARIANT_RSTARTREE_REINSERT
 1

	)

74 
	#VARIANT_GUTTMAN_QUADRATIC_SPLIT
 0

	)

75 
	#VARIANT_GUTTMAN_LINEAR_SPLIT
 0

	)

76 
	#VARIANT_RSTARTREE_SPLIT
 1

	)

78 
	#VARIANT_GUTTMAN_SPLIT
 \

79 (
VARIANT_GUTTMAN_LINEAR_SPLIT
||
VARIANT_GUTTMAN_QUADRATIC_SPLIT
)

	)

81 #i‡
VARIANT_GUTTMAN_QUADRATIC_SPLIT


82 
	#PickNext
 
QuadøticPickNext


	)

83 
	#PickSìds
 
QuadøticPickSìds


	)

84 
	#AssignCñls
 
•lôNodeGuâm™


	)

86 #i‡
VARIANT_GUTTMAN_LINEAR_SPLIT


87 
	#PickNext
 
LöórPickNext


	)

88 
	#PickSìds
 
LöórPickSìds


	)

89 
	#AssignCñls
 
•lôNodeGuâm™


	)

91 #i‡
VARIANT_RSTARTREE_SPLIT


92 
	#AssignCñls
 
•lôNodeSèπªe


	)

95 #i‡!
deföed
(
NDEBUG
Ë&& !deföed(
SQLITE4_DEBUG
)

96 
	#NDEBUG
 1

	)

99 #i‚de‡
SQLITE4_CORE


100 
	~"sqlôe4ext.h
"

101 
	gSQLITE4_EXTENSION_INIT1


103 
	~"sqlôe4.h
"

106 
	~<°rög.h
>

107 
	~<as£π.h
>

109 #i‚de‡
SQLITE4_AMALGAMATION


110 
	~"sqlôe4πªe.h
"

111 
sqlôe4_öt64
 
	ti64
;

112 
	tu8
;

113 
	tu32
;

118 #i‚de‡
UNUSED_PARAMETER


119 
	#UNUSED_PARAMETER
(
x
Ë()(x)

	)

122 
Råì
 
	tRåì
;

123 
RåìCurs‹
 
	tRåìCurs‹
;

124 
RåìNode
 
	tRåìNode
;

125 
RåìCñl
 
	tRåìCñl
;

126 
RåìC⁄°øöt
 
	tRåìC⁄°øöt
;

127 
RåìM©chArg
 
	tRåìM©chArg
;

128 
RåìGeomCÆlback
 
	tRåìGeomCÆlback
;

129 
RåìCo‹d
 
	tRåìCo‹d
;

132 
	#RTREE_MAX_DIMENSIONS
 5

	)

138 
	#HASHSIZE
 128

	)

143 
	sRåì
 {

144 
sqlôe4_vèb
 
	mba£
;

145 
sqlôe4
 *
	mdb
;

146 
	miNodeSize
;

147 
	mnDim
;

148 
	mnByãsPîCñl
;

149 
	miDïth
;

150 *
	mzDb
;

151 *
	mzName
;

152 
RåìNode
 *
	maHash
[
HASHSIZE
];

153 
	mnBusy
;

160 
RåìNode
 *
	mpDñëed
;

161 
	miReö£πHeight
;

164 
sqlôe4_°mt
 *
	mpRódNode
;

165 
sqlôe4_°mt
 *
	mpWrôeNode
;

166 
sqlôe4_°mt
 *
	mpDñëeNode
;

169 
sqlôe4_°mt
 *
	mpRódRowid
;

170 
sqlôe4_°mt
 *
	mpWrôeRowid
;

171 
sqlôe4_°mt
 *
	mpDñëeRowid
;

174 
sqlôe4_°mt
 *
	mpRódP¨ít
;

175 
sqlôe4_°mt
 *
	mpWrôeP¨ít
;

176 
sqlôe4_°mt
 *
	mpDñëeP¨ít
;

178 
	meCo‹dTy≥
;

182 
	#RTREE_COORD_REAL32
 0

	)

183 
	#RTREE_COORD_INT32
 1

	)

194 
	#RTREE_MINCELLS
(
p
Ë(((’)->
iNodeSize
-4)/’)->
nByãsPîCñl
)/3)

	)

195 
	#RTREE_REINSERT
(
p
Ë
	`RTREE_MINCELLS
’)

	)

196 
	#RTREE_MAXCELLS
 51

	)

205 
	#RTREE_MAX_DEPTH
 40

	)

210 
	sRåìCurs‹
 {

211 
sqlôe4_vèb_curs‹
 
	mba£
;

212 
RåìNode
 *
	mpNode
;

213 
	miCñl
;

214 
	miSå©egy
;

215 
	mnC⁄°øöt
;

216 
RåìC⁄°øöt
 *
	maC⁄°øöt
;

219 
	uRåìCo‹d
 {

220 
	mf
;

221 
	mi
;

229 
	#DCOORD
(
co‹d
) ( \

230 (
pRåì
->
eCo‹dTy≥
==
RTREE_COORD_REAL32
) ? \

231 (()
co‹d
.
f
) : \

232 (()
co‹d
.
i
) \

233 )

	)

238 
	sRåìC⁄°øöt
 {

239 
	miCo‹d
;

240 
	m›
;

241 
	mrVÆue
;

242 (*
	mxGeom
)(
	msqlôe4_πªe_geomëry
 *, , *, *);

243 
sqlôe4_πªe_geomëry
 *
	mpGeom
;

247 
	#RTREE_EQ
 0x41

	)

248 
	#RTREE_LE
 0x42

	)

249 
	#RTREE_LT
 0x43

	)

250 
	#RTREE_GE
 0x44

	)

251 
	#RTREE_GT
 0x45

	)

252 
	#RTREE_MATCH
 0x46

	)

257 
	sRåìNode
 {

258 
RåìNode
 *
	mpP¨ít
;

259 
i64
 
	miNode
;

260 
	mnRef
;

261 
	misDúty
;

262 
u8
 *
	mzD©a
;

263 
RåìNode
 *
	mpNext
;

265 
	#NCELL
(
pNode
Ë
	`ªadI¡16
(&’Node)->
zD©a
[2])

	)

270 
	sRåìCñl
 {

271 
i64
 
	miRowid
;

272 
RåìCo‹d
 
	maCo‹d
[
RTREE_MAX_DIMENSIONS
*2];

281 
	#RTREE_GEOMETRY_MAGIC
 0x891245AB

	)

288 
	sRåìM©chArg
 {

289 
u32
 
	mmagic
;

290 (*
	mxGeom
)(
	msqlôe4_πªe_geomëry
 *, , *, *);

291 *
	mpC⁄ãxt
;

292 
	mnP¨am
;

293 
	maP¨am
[1];

304 
	sRåìGeomCÆlback
 {

305 (*
	mxGeom
)(
	msqlôe4_πªe_geomëry
 *, , *, *);

306 *
	mpC⁄ãxt
;

309 #i‚de‡
MAX


310 
	#MAX
(
x
,
y
Ë((xË< (yË? (yË: (x))

	)

312 #i‚de‡
MIN


313 
	#MIN
(
x
,
y
Ë((xË> (yË? (yË: (x))

	)

320 
	$ªadI¡16
(
u8
 *
p
){

321  (
p
[0]<<8) +Ö[1];

322 
	}
}

323 
	$ªadCo‹d
(
u8
 *
p
, 
RåìCo‹d
 *
pCo‹d
){

324 
u32
 
i
 = (

325 (((
u32
)
p
[0]) << 24) +

326 (((
u32
)
p
[1]) << 16) +

327 (((
u32
)
p
[2]) << 8) +

328 (((
u32
)
p
[3]) << 0)

330 *(
u32
 *)
pCo‹d
 = 
i
;

331 
	}
}

332 
i64
 
	$ªadI¡64
(
u8
 *
p
){

334 (((
i64
)
p
[0]) << 56) +

335 (((
i64
)
p
[1]) << 48) +

336 (((
i64
)
p
[2]) << 40) +

337 (((
i64
)
p
[3]) << 32) +

338 (((
i64
)
p
[4]) << 24) +

339 (((
i64
)
p
[5]) << 16) +

340 (((
i64
)
p
[6]) << 8) +

341 (((
i64
)
p
[7]) << 0)

343 
	}
}

350 
	$wrôeI¡16
(
u8
 *
p
, 
i
){

351 
p
[0] = (
i
>> 8)&0xFF;

352 
p
[1] = (
i
>> 0)&0xFF;

354 
	}
}

355 
	$wrôeCo‹d
(
u8
 *
p
, 
RåìCo‹d
 *
pCo‹d
){

356 
u32
 
i
;

357 
	`as£π
–(
RåìCo‹d
)==4 );

358 
	`as£π
–(
u32
)==4 );

359 
i
 = *(
u32
 *)
pCo‹d
;

360 
p
[0] = (
i
>>24)&0xFF;

361 
p
[1] = (
i
>>16)&0xFF;

362 
p
[2] = (
i
>> 8)&0xFF;

363 
p
[3] = (
i
>> 0)&0xFF;

365 
	}
}

366 
	$wrôeI¡64
(
u8
 *
p
, 
i64
 
i
){

367 
p
[0] = (
i
>>56)&0xFF;

368 
p
[1] = (
i
>>48)&0xFF;

369 
p
[2] = (
i
>>40)&0xFF;

370 
p
[3] = (
i
>>32)&0xFF;

371 
p
[4] = (
i
>>24)&0xFF;

372 
p
[5] = (
i
>>16)&0xFF;

373 
p
[6] = (
i
>> 8)&0xFF;

374 
p
[7] = (
i
>> 0)&0xFF;

376 
	}
}

381 
	$nodeRe„ªn˚
(
RåìNode
 *
p
){

382 if–
p
 ){

383 
p
->
nRef
++;

385 
	}
}

390 
	$nodeZîo
(
Råì
 *
pRåì
, 
RåìNode
 *
p
){

391 
	`mem£t
(&
p
->
zD©a
[2], 0, 
pRåì
->
iNodeSize
-2);

392 
p
->
isDúty
 = 1;

393 
	}
}

399 
	$nodeHash
(
i64
 
iNode
){

401 (
iNode
>>56) ^ (iNode>>48) ^ (iNode>>40) ^ (iNode>>32) ^

402 (
iNode
>>24) ^ (iNode>>16) ^ (iNode>> 8) ^ (iNode>> 0)

403 Ë% 
HASHSIZE
;

404 
	}
}

410 
RåìNode
 *
	$nodeHashLookup
(
Råì
 *
pRåì
, 
i64
 
iNode
){

411 
RåìNode
 *
p
;

412 
p
=
pRåì
->
aHash
[
	`nodeHash
(
iNode
)];Ö &&Ö->iNode!=iNode;Öı->
pNext
);

413  
p
;

414 
	}
}

419 
	$nodeHashIn£π
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
){

420 
iHash
;

421 
	`as£π
–
pNode
->
pNext
==0 );

422 
iHash
 = 
	`nodeHash
(
pNode
->
iNode
);

423 
pNode
->
pNext
 = 
pRåì
->
aHash
[
iHash
];

424 
pRåì
->
aHash
[
iHash
] = 
pNode
;

425 
	}
}

430 
	$nodeHashDñëe
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
){

431 
RåìNode
 **
µ
;

432 if–
pNode
->
iNode
!=0 ){

433 
µ
 = &
pRåì
->
aHash
[
	`nodeHash
(
pNode
->
iNode
)];

434  ; (*
µ
)!=
pNode
;Ö∞&(*µ)->
pNext
){ 
	`as£π
(*pp); }

435 *
µ
 = 
pNode
->
pNext
;

436 
pNode
->
pNext
 = 0;

438 
	}
}

446 
RåìNode
 *
	$nodeNew
(
Råì
 *
pRåì
, 
RåìNode
 *
pP¨ít
){

447 
RåìNode
 *
pNode
;

448 
pNode
 = (
RåìNode
 *)
	`sqlôe4_mÆloc
((RåìNodeË+ 
pRåì
->
iNodeSize
);

449 if–
pNode
 ){

450 
	`mem£t
(
pNode
, 0, (
RåìNode
Ë+ 
pRåì
->
iNodeSize
);

451 
pNode
->
zD©a
 = (
u8
 *)&pNode[1];

452 
pNode
->
nRef
 = 1;

453 
pNode
->
pP¨ít
 =ÖParent;

454 
pNode
->
isDúty
 = 1;

455 
	`nodeRe„ªn˚
(
pP¨ít
);

457  
pNode
;

458 
	}
}

464 
	$nodeAcquúe
(

465 
Råì
 *
pRåì
,

466 
i64
 
iNode
,

467 
RåìNode
 *
pP¨ít
,

468 
RåìNode
 **
µNode


470 
rc
;

471 
rc2
 = 
SQLITE4_OK
;

472 
RåìNode
 *
pNode
;

477 if–(
pNode
 = 
	`nodeHashLookup
(
pRåì
, 
iNode
)) ){

478 
	`as£π
–!
pP¨ít
 || !
pNode
->pParent ||ÖNode->pParent==pParent );

479 if–
pP¨ít
 && !
pNode
->pParent ){

480 
	`nodeRe„ªn˚
(
pP¨ít
);

481 
pNode
->
pP¨ít
 =ÖParent;

483 
pNode
->
nRef
++;

484 *
µNode
 = 
pNode
;

485  
SQLITE4_OK
;

488 
	`sqlôe4_böd_öt64
(
pRåì
->
pRódNode
, 1, 
iNode
);

489 
rc
 = 
	`sqlôe4_°ï
(
pRåì
->
pRódNode
);

490 if–
rc
==
SQLITE4_ROW
 ){

491 c⁄° 
u8
 *
zBlob
 = 
	`sqlôe4_cﬁumn_blob
(
pRåì
->
pRódNode
, 0);

492 if–
pRåì
->
iNodeSize
==
	`sqlôe4_cﬁumn_byãs
’Råì->
pRódNode
, 0) ){

493 
pNode
 = (
RåìNode
 *)
	`sqlôe4_mÆloc
((RåìNode)+
pRåì
->
iNodeSize
);

494 if–!
pNode
 ){

495 
rc2
 = 
SQLITE4_NOMEM
;

497 
pNode
->
pP¨ít
 =ÖParent;

498 
pNode
->
zD©a
 = (
u8
 *)&pNode[1];

499 
pNode
->
nRef
 = 1;

500 
pNode
->
iNode
 = iNode;

501 
pNode
->
isDúty
 = 0;

502 
pNode
->
pNext
 = 0;

503 
	`mem˝y
(
pNode
->
zD©a
, 
zBlob
, 
pRåì
->
iNodeSize
);

504 
	`nodeRe„ªn˚
(
pP¨ít
);

508 
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pRódNode
);

509 if–
rc
==
SQLITE4_OK
 )Ñ¯
rc2
;

517 if–
pNode
 && 
iNode
==1 ){

518 
pRåì
->
iDïth
 = 
	`ªadI¡16
(
pNode
->
zD©a
);

519 if–
pRåì
->
iDïth
>
RTREE_MAX_DEPTH
 ){

520 
rc
 = 
SQLITE4_CORRUPT_VTAB
;

528 if–
pNode
 && 
rc
==
SQLITE4_OK
 ){

529 if–
	`NCELL
(
pNode
)>((
pRåì
->
iNodeSize
-4)/pRåì->
nByãsPîCñl
) ){

530 
rc
 = 
SQLITE4_CORRUPT_VTAB
;

534 if–
rc
==
SQLITE4_OK
 ){

535 if–
pNode
!=0 ){

536 
	`nodeHashIn£π
(
pRåì
, 
pNode
);

538 
rc
 = 
SQLITE4_CORRUPT_VTAB
;

540 *
µNode
 = 
pNode
;

542 
	`sqlôe4_‰ì
(
pNode
);

543 *
µNode
 = 0;

546  
rc
;

547 
	}
}

552 
	$nodeOvîwrôeCñl
(

553 
Råì
 *
pRåì
,

554 
RåìNode
 *
pNode
,

555 
RåìCñl
 *
pCñl
,

556 
iCñl


558 
ii
;

559 
u8
 *
p
 = &
pNode
->
zD©a
[4 + 
pRåì
->
nByãsPîCñl
*
iCñl
];

560 
p
 +
	`wrôeI¡64
’, 
pCñl
->
iRowid
);

561 
ii
=0; ii<(
pRåì
->
nDim
*2); ii++){

562 
p
 +
	`wrôeCo‹d
’, &
pCñl
->
aCo‹d
[
ii
]);

564 
pNode
->
isDúty
 = 1;

565 
	}
}

570 
	$nodeDñëeCñl
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
, 
iCñl
){

571 
u8
 *
pD°
 = &
pNode
->
zD©a
[4 + 
pRåì
->
nByãsPîCñl
*
iCñl
];

572 
u8
 *
pSrc
 = &
pD°
[
pRåì
->
nByãsPîCñl
];

573 
nByã
 = (
	`NCELL
(
pNode
Ë- 
iCñl
 - 1Ë* 
pRåì
->
nByãsPîCñl
;

574 
	`memmove
(
pD°
, 
pSrc
, 
nByã
);

575 
	`wrôeI¡16
(&
pNode
->
zD©a
[2], 
	`NCELL
(pNode)-1);

576 
pNode
->
isDúty
 = 1;

577 
	}
}

586 
	$nodeIn£πCñl
(

587 
Råì
 *
pRåì
,

588 
RåìNode
 *
pNode
,

589 
RåìCñl
 *
pCñl


591 
nCñl
;

592 
nMaxCñl
;

594 
nMaxCñl
 = (
pRåì
->
iNodeSize
-4)/pRåì->
nByãsPîCñl
;

595 
nCñl
 = 
	`NCELL
(
pNode
);

597 
	`as£π
–
nCñl
<=
nMaxCñl
 );

598 if–
nCñl
<
nMaxCñl
 ){

599 
	`nodeOvîwrôeCñl
(
pRåì
, 
pNode
, 
pCñl
, 
nCñl
);

600 
	`wrôeI¡16
(&
pNode
->
zD©a
[2], 
nCñl
+1);

601 
pNode
->
isDúty
 = 1;

604  (
nCñl
==
nMaxCñl
);

605 
	}
}

611 
	$nodeWrôe
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
){

612 
rc
 = 
SQLITE4_OK
;

613 if–
pNode
->
isDúty
 ){

614 
sqlôe4_°mt
 *
p
 = 
pRåì
->
pWrôeNode
;

615 if–
pNode
->
iNode
 ){

616 
	`sqlôe4_böd_öt64
(
p
, 1, 
pNode
->
iNode
);

618 
	`sqlôe4_böd_nuŒ
(
p
, 1);

620 
	`sqlôe4_böd_blob
(
p
, 2, 
pNode
->
zD©a
, 
pRåì
->
iNodeSize
, 
SQLITE4_STATIC
);

621 
	`sqlôe4_°ï
(
p
);

622 
pNode
->
isDúty
 = 0;

623 
rc
 = 
	`sqlôe4_ª£t
(
p
);

624 if–
pNode
->
iNode
==0 && 
rc
==
SQLITE4_OK
 ){

625 
pNode
->
iNode
 = 
	`sqlôe4_œ°_ö£π_rowid
(
pRåì
->
db
);

626 
	`nodeHashIn£π
(
pRåì
, 
pNode
);

629  
rc
;

630 
	}
}

637 
	$nodeRñó£
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
){

638 
rc
 = 
SQLITE4_OK
;

639 if–
pNode
 ){

640 
	`as£π
–
pNode
->
nRef
>0 );

641 
pNode
->
nRef
--;

642 if–
pNode
->
nRef
==0 ){

643 if–
pNode
->
iNode
==1 ){

644 
pRåì
->
iDïth
 = -1;

646 if–
pNode
->
pP¨ít
 ){

647 
rc
 = 
	`nodeRñó£
(
pRåì
, 
pNode
->
pP¨ít
);

649 if–
rc
==
SQLITE4_OK
 ){

650 
rc
 = 
	`nodeWrôe
(
pRåì
, 
pNode
);

652 
	`nodeHashDñëe
(
pRåì
, 
pNode
);

653 
	`sqlôe4_‰ì
(
pNode
);

656  
rc
;

657 
	}
}

664 
i64
 
	$nodeGëRowid
(

665 
Råì
 *
pRåì
,

666 
RåìNode
 *
pNode
,

667 
iCñl


669 
	`as£π
–
iCñl
<
	`NCELL
(
pNode
) );

670  
	`ªadI¡64
(&
pNode
->
zD©a
[4 + 
pRåì
->
nByãsPîCñl
*
iCñl
]);

671 
	}
}

676 
	$nodeGëCo‹d
(

677 
Råì
 *
pRåì
,

678 
RåìNode
 *
pNode
,

679 
iCñl
,

680 
iCo‹d
,

681 
RåìCo‹d
 *
pCo‹d


683 
	`ªadCo‹d
(&
pNode
->
zD©a
[12 + 
pRåì
->
nByãsPîCñl
*
iCñl
 + 4*
iCo‹d
], 
pCo‹d
);

684 
	}
}

690 
	$nodeGëCñl
(

691 
Råì
 *
pRåì
,

692 
RåìNode
 *
pNode
,

693 
iCñl
,

694 
RåìCñl
 *
pCñl


696 
ii
;

697 
pCñl
->
iRowid
 = 
	`nodeGëRowid
(
pRåì
, 
pNode
, 
iCñl
);

698 
ii
=0; ii<
pRåì
->
nDim
*2; ii++){

699 
	`nodeGëCo‹d
(
pRåì
, 
pNode
, 
iCñl
, 
ii
, &
pCñl
->
aCo‹d
[ii]);

701 
	}
}

707 
πªeInô
(

708 
sqlôe4
 *, *, , c⁄° *c⁄°*, 
sqlôe4_vèb
 **, **, 

714 
	$πªeCª©e
(

715 
sqlôe4
 *
db
,

716 *
pAux
,

717 
¨gc
, c⁄° *c⁄°*
¨gv
,

718 
sqlôe4_vèb
 **
µVèb
,

719 **
pzEº


721  
	`πªeInô
(
db
, 
pAux
, 
¨gc
, 
¨gv
, 
µVèb
, 
pzEº
, 1);

722 
	}
}

727 
	$πªeC⁄√˘
(

728 
sqlôe4
 *
db
,

729 *
pAux
,

730 
¨gc
, c⁄° *c⁄°*
¨gv
,

731 
sqlôe4_vèb
 **
µVèb
,

732 **
pzEº


734  
	`πªeInô
(
db
, 
pAux
, 
¨gc
, 
¨gv
, 
µVèb
, 
pzEº
, 0);

735 
	}
}

740 
	$πªeRe„ªn˚
(
Råì
 *
pRåì
){

741 
pRåì
->
nBusy
++;

742 
	}
}

748 
	$πªeRñó£
(
Råì
 *
pRåì
){

749 
pRåì
->
nBusy
--;

750 if–
pRåì
->
nBusy
==0 ){

751 
	`sqlôe4_föÆize
(
pRåì
->
pRódNode
);

752 
	`sqlôe4_föÆize
(
pRåì
->
pWrôeNode
);

753 
	`sqlôe4_föÆize
(
pRåì
->
pDñëeNode
);

754 
	`sqlôe4_föÆize
(
pRåì
->
pRódRowid
);

755 
	`sqlôe4_föÆize
(
pRåì
->
pWrôeRowid
);

756 
	`sqlôe4_föÆize
(
pRåì
->
pDñëeRowid
);

757 
	`sqlôe4_föÆize
(
pRåì
->
pRódP¨ít
);

758 
	`sqlôe4_föÆize
(
pRåì
->
pWrôeP¨ít
);

759 
	`sqlôe4_föÆize
(
pRåì
->
pDñëeP¨ít
);

760 
	`sqlôe4_‰ì
(
pRåì
);

762 
	}
}

767 
	$πªeDisc⁄√˘
(
sqlôe4_vèb
 *
pVèb
){

768 
	`πªeRñó£
((
Råì
 *)
pVèb
);

769  
SQLITE4_OK
;

770 
	}
}

775 
	$πªeDe°roy
(
sqlôe4_vèb
 *
pVèb
){

776 
Råì
 *
pRåì
 = (Råì *)
pVèb
;

777 
rc
;

778 *
zCª©e
 = 
	`sqlôe4_m¥ötf
(

782 
pRåì
->
zDb
,ÖRåì->
zName
,

783 
pRåì
->
zDb
,ÖRåì->
zName
,

784 
pRåì
->
zDb
,ÖRåì->
zName


786 if–!
zCª©e
 ){

787 
rc
 = 
SQLITE4_NOMEM
;

789 
rc
 = 
	`sqlôe4_exec
(
pRåì
->
db
, 
zCª©e
, 0, 0, 0);

790 
	`sqlôe4_‰ì
(
zCª©e
);

792 if–
rc
==
SQLITE4_OK
 ){

793 
	`πªeRñó£
(
pRåì
);

796  
rc
;

797 
	}
}

802 
	$πªeO≥n
(
sqlôe4_vèb
 *
pVTab
, 
sqlôe4_vèb_curs‹
 **
µCurs‹
){

803 
rc
 = 
SQLITE4_NOMEM
;

804 
RåìCurs‹
 *
pC§
;

806 
pC§
 = (
RåìCurs‹
 *)
	`sqlôe4_mÆloc
((RtreeCursor));

807 if–
pC§
 ){

808 
	`mem£t
(
pC§
, 0, (
RåìCurs‹
));

809 
pC§
->
ba£
.
pVèb
 = 
pVTab
;

810 
rc
 = 
SQLITE4_OK
;

812 *
µCurs‹
 = (
sqlôe4_vèb_curs‹
 *)
pC§
;

814  
rc
;

815 
	}
}

821 
	$‰ìCurs‹C⁄°øöts
(
RåìCurs‹
 *
pC§
){

822 if–
pC§
->
aC⁄°øöt
 ){

823 
i
;

824 
i
=0; i<
pC§
->
nC⁄°øöt
; i++){

825 
sqlôe4_πªe_geomëry
 *
pGeom
 = 
pC§
->
aC⁄°øöt
[
i
].pGeom;

826 if–
pGeom
 ){

827 if–
pGeom
->
xDñU£r
 )ÖGeom->
	`xDñU£r
’Geom->
pU£r
);

828 
	`sqlôe4_‰ì
(
pGeom
);

831 
	`sqlôe4_‰ì
(
pC§
->
aC⁄°øöt
);

832 
pC§
->
aC⁄°øöt
 = 0;

834 
	}
}

839 
	$πªeClo£
(
sqlôe4_vèb_curs‹
 *
cur
){

840 
Råì
 *
pRåì
 = (Råì *)(
cur
->
pVèb
);

841 
rc
;

842 
RåìCurs‹
 *
pC§
 = (RåìCurs‹ *)
cur
;

843 
	`‰ìCurs‹C⁄°øöts
(
pC§
);

844 
rc
 = 
	`nodeRñó£
(
pRåì
, 
pC§
->
pNode
);

845 
	`sqlôe4_‰ì
(
pC§
);

846  
rc
;

847 
	}
}

855 
	$πªeEof
(
sqlôe4_vèb_curs‹
 *
cur
){

856 
RåìCurs‹
 *
pC§
 = (RåìCurs‹ *)
cur
;

857  (
pC§
->
pNode
==0);

858 
	}
}

864 
	$ã°RåìGeom
(

865 
Råì
 *
pRåì
,

866 
RåìC⁄°øöt
 *
pC⁄°øöt
,

867 
RåìCñl
 *
pCñl
,

868 *
pbRes


870 
i
;

871 
aCo‹d
[
RTREE_MAX_DIMENSIONS
*2];

872 
nCo‹d
 = 
pRåì
->
nDim
*2;

874 
	`as£π
–
pC⁄°øöt
->
›
==
RTREE_MATCH
 );

875 
	`as£π
–
pC⁄°øöt
->
pGeom
 );

877 
i
=0; i<
nCo‹d
; i++){

878 
aCo‹d
[
i
] = 
	`DCOORD
(
pCñl
->aCoord[i]);

880  
pC⁄°øöt
->
	`xGeom
’C⁄°øöt->
pGeom
, 
nCo‹d
, 
aCo‹d
, 
pbRes
);

881 
	}
}

892 
	$ã°RåìCñl
(
Råì
 *
pRåì
, 
RåìCurs‹
 *
pCurs‹
, *
pbEof
){

893 
RåìCñl
 
˚Œ
;

894 
ii
;

895 
bRes
 = 0;

896 
rc
 = 
SQLITE4_OK
;

898 
	`nodeGëCñl
(
pRåì
, 
pCurs‹
->
pNode
,ÖCurs‹->
iCñl
, &
˚Œ
);

899 
ii
=0; 
bRes
==0 && ii<
pCurs‹
->
nC⁄°øöt
; ii++){

900 
RåìC⁄°øöt
 *
p
 = &
pCurs‹
->
aC⁄°øöt
[
ii
];

901 
˚Œ_mö
 = 
	`DCOORD
(
˚Œ
.
aCo‹d
[(
p
->
iCo‹d
>>1)*2]);

902 
˚Œ_max
 = 
	`DCOORD
(
˚Œ
.
aCo‹d
[(
p
->
iCo‹d
>>1)*2+1]);

904 
	`as£π
(
p
->
›
==
RTREE_LE
 ||Ö->›==
RTREE_LT
 ||Ö->›==
RTREE_GE


905 || 
p
->
›
==
RTREE_GT
 ||Ö->›==
RTREE_EQ
 ||Ö->›==
RTREE_MATCH


908  
p
->
›
 ){

909 
RTREE_LE
: 
RTREE_LT
:

910 
bRes
 = 
p
->
rVÆue
<
˚Œ_mö
;

913 
RTREE_GE
: 
RTREE_GT
:

914 
bRes
 = 
p
->
rVÆue
>
˚Œ_max
;

917 
RTREE_EQ
:

918 
bRes
 = (
p
->
rVÆue
>
˚Œ_max
 ||Ö->rVÆue<
˚Œ_mö
);

922 
	`as£π
–
p
->
›
==
RTREE_MATCH
 );

923 
rc
 = 
	`ã°RåìGeom
(
pRåì
, 
p
, &
˚Œ
, &
bRes
);

924 
bRes
 = !bRes;

930 *
pbEof
 = 
bRes
;

931  
rc
;

932 
	}
}

946 
	$ã°RåìE¡ry
(
Råì
 *
pRåì
, 
RåìCurs‹
 *
pCurs‹
, *
pbEof
){

947 
RåìCñl
 
˚Œ
;

948 
ii
;

949 *
pbEof
 = 0;

951 
	`nodeGëCñl
(
pRåì
, 
pCurs‹
->
pNode
,ÖCurs‹->
iCñl
, &
˚Œ
);

952 
ii
=0; ii<
pCurs‹
->
nC⁄°øöt
; ii++){

953 
RåìC⁄°øöt
 *
p
 = &
pCurs‹
->
aC⁄°øöt
[
ii
];

954 
co‹d
 = 
	`DCOORD
(
˚Œ
.
aCo‹d
[
p
->
iCo‹d
]);

955 
ªs
;

956 
	`as£π
(
p
->
›
==
RTREE_LE
 ||Ö->›==
RTREE_LT
 ||Ö->›==
RTREE_GE


957 || 
p
->
›
==
RTREE_GT
 ||Ö->›==
RTREE_EQ
 ||Ö->›==
RTREE_MATCH


959  
p
->
›
 ){

960 
RTREE_LE
: 
ªs
 = (
co‹d
<=
p
->
rVÆue
); ;

961 
RTREE_LT
: 
ªs
 = (
co‹d
<
p
->
rVÆue
); ;

962 
RTREE_GE
: 
ªs
 = (
co‹d
>=
p
->
rVÆue
); ;

963 
RTREE_GT
: 
ªs
 = (
co‹d
>
p
->
rVÆue
); ;

964 
RTREE_EQ
: 
ªs
 = (
co‹d
==
p
->
rVÆue
); ;

966 
rc
;

967 
	`as£π
–
p
->
›
==
RTREE_MATCH
 );

968 
rc
 = 
	`ã°RåìGeom
(
pRåì
, 
p
, &
˚Œ
, &
ªs
);

969 if–
rc
!=
SQLITE4_OK
 ){

970  
rc
;

976 if–!
ªs
 ){

977 *
pbEof
 = 1;

978  
SQLITE4_OK
;

982  
SQLITE4_OK
;

983 
	}
}

991 
	$des˚ndToCñl
(

992 
Råì
 *
pRåì
,

993 
RåìCurs‹
 *
pCurs‹
,

994 
iHeight
,

995 *
pEof


997 
isEof
;

998 
rc
;

999 
ii
;

1000 
RåìNode
 *
pChûd
;

1001 
sqlôe4_öt64
 
iRowid
;

1003 
RåìNode
 *
pSavedNode
 = 
pCurs‹
->
pNode
;

1004 
iSavedCñl
 = 
pCurs‹
->
iCñl
;

1006 
	`as£π
–
iHeight
>=0 );

1008 if–
iHeight
==0 ){

1009 
rc
 = 
	`ã°RåìE¡ry
(
pRåì
, 
pCurs‹
, &
isEof
);

1011 
rc
 = 
	`ã°RåìCñl
(
pRåì
, 
pCurs‹
, &
isEof
);

1013 if–
rc
!=
SQLITE4_OK
 || 
isEof
 || 
iHeight
==0 ){

1014 
des˚nd_to_˚Œ_out
;

1017 
iRowid
 = 
	`nodeGëRowid
(
pRåì
, 
pCurs‹
->
pNode
,ÖCurs‹->
iCñl
);

1018 
rc
 = 
	`nodeAcquúe
(
pRåì
, 
iRowid
, 
pCurs‹
->
pNode
, &
pChûd
);

1019 if–
rc
!=
SQLITE4_OK
 ){

1020 
des˚nd_to_˚Œ_out
;

1023 
	`nodeRñó£
(
pRåì
, 
pCurs‹
->
pNode
);

1024 
pCurs‹
->
pNode
 = 
pChûd
;

1025 
isEof
 = 1;

1026 
ii
=0; 
isEof
 && ii<
	`NCELL
(
pChûd
); ii++){

1027 
pCurs‹
->
iCñl
 = 
ii
;

1028 
rc
 = 
	`des˚ndToCñl
(
pRåì
, 
pCurs‹
, 
iHeight
-1, &
isEof
);

1029 if–
rc
!=
SQLITE4_OK
 ){

1030 
des˚nd_to_˚Œ_out
;

1034 if–
isEof
 ){

1035 
	`as£π
–
pCurs‹
->
pNode
==
pChûd
 );

1036 
	`nodeRe„ªn˚
(
pSavedNode
);

1037 
	`nodeRñó£
(
pRåì
, 
pChûd
);

1038 
pCurs‹
->
pNode
 = 
pSavedNode
;

1039 
pCurs‹
->
iCñl
 = 
iSavedCñl
;

1042 
des˚nd_to_˚Œ_out
:

1043 *
pEof
 = 
isEof
;

1044  
rc
;

1045 
	}
}

1051 
	$nodeRowidIndex
(

1052 
Råì
 *
pRåì
,

1053 
RåìNode
 *
pNode
,

1054 
i64
 
iRowid
,

1055 *
piIndex


1057 
ii
;

1058 
nCñl
 = 
	`NCELL
(
pNode
);

1059 
ii
=0; ii<
nCñl
; ii++){

1060 if–
	`nodeGëRowid
(
pRåì
, 
pNode
, 
ii
)==
iRowid
 ){

1061 *
piIndex
 = 
ii
;

1062  
SQLITE4_OK
;

1065  
SQLITE4_CORRUPT_VTAB
;

1066 
	}
}

1072 
	$nodeP¨ítIndex
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
, *
piIndex
){

1073 
RåìNode
 *
pP¨ít
 = 
pNode
->pParent;

1074 if–
pP¨ít
 ){

1075  
	`nodeRowidIndex
(
pRåì
, 
pP¨ít
, 
pNode
->
iNode
, 
piIndex
);

1077 *
piIndex
 = -1;

1078  
SQLITE4_OK
;

1079 
	}
}

1084 
	$πªeNext
(
sqlôe4_vèb_curs‹
 *
pVèbCurs‹
){

1085 
Råì
 *
pRåì
 = (Råì *)(
pVèbCurs‹
->
pVèb
);

1086 
RåìCurs‹
 *
pC§
 = (RåìCurs‹ *)
pVèbCurs‹
;

1087 
rc
 = 
SQLITE4_OK
;

1093 
	`as£π
–
pC§
->
pNode
 );

1095 if–
pC§
->
iSå©egy
==1 ){

1097 
	`nodeRñó£
(
pRåì
, 
pC§
->
pNode
);

1098 
pC§
->
pNode
 = 0;

1101 
iHeight
 = 0;

1102  
pC§
->
pNode
 ){

1103 
RåìNode
 *
pNode
 = 
pC§
->pNode;

1104 
nCñl
 = 
	`NCELL
(
pNode
);

1105 
pC§
->
iCñl
++;ÖC§->iCñl<
nCñl
;ÖCsr->iCell++){

1106 
isEof
;

1107 
rc
 = 
	`des˚ndToCñl
(
pRåì
, 
pC§
, 
iHeight
, &
isEof
);

1108 if–
rc
!=
SQLITE4_OK
 || !
isEof
 ){

1109  
rc
;

1112 
pC§
->
pNode
 =ÖNode->
pP¨ít
;

1113 
rc
 = 
	`nodeP¨ítIndex
(
pRåì
, 
pNode
, &
pC§
->
iCñl
);

1114 if–
rc
!=
SQLITE4_OK
 ){

1115  
rc
;

1117 
	`nodeRe„ªn˚
(
pC§
->
pNode
);

1118 
	`nodeRñó£
(
pRåì
, 
pNode
);

1119 
iHeight
++;

1123  
rc
;

1124 
	}
}

1129 
	$πªeRowid
(
sqlôe4_vèb_curs‹
 *
pVèbCurs‹
, 
sqlôe_öt64
 *
pRowid
){

1130 
Råì
 *
pRåì
 = (Råì *)
pVèbCurs‹
->
pVèb
;

1131 
RåìCurs‹
 *
pC§
 = (RåìCurs‹ *)
pVèbCurs‹
;

1133 
	`as£π
(
pC§
->
pNode
);

1134 *
pRowid
 = 
	`nodeGëRowid
(
pRåì
, 
pC§
->
pNode
,ÖC§->
iCñl
);

1136  
SQLITE4_OK
;

1137 
	}
}

1142 
	$πªeCﬁumn
(
sqlôe4_vèb_curs‹
 *
cur
, 
sqlôe4_c⁄ãxt
 *
˘x
, 
i
){

1143 
Råì
 *
pRåì
 = (Råì *)
cur
->
pVèb
;

1144 
RåìCurs‹
 *
pC§
 = (RåìCurs‹ *)
cur
;

1146 if–
i
==0 ){

1147 
i64
 
iRowid
 = 
	`nodeGëRowid
(
pRåì
, 
pC§
->
pNode
,ÖC§->
iCñl
);

1148 
	`sqlôe4_ªsu…_öt64
(
˘x
, 
iRowid
);

1150 
RåìCo‹d
 
c
;

1151 
	`nodeGëCo‹d
(
pRåì
, 
pC§
->
pNode
,ÖC§->
iCñl
, 
i
-1, &
c
);

1152 if–
pRåì
->
eCo‹dTy≥
==
RTREE_COORD_REAL32
 ){

1153 
	`sqlôe4_ªsu…_doubÀ
(
˘x
, 
c
.
f
);

1155 
	`as£π
–
pRåì
->
eCo‹dTy≥
==
RTREE_COORD_INT32
 );

1156 
	`sqlôe4_ªsu…_öt
(
˘x
, 
c
.
i
);

1160  
SQLITE4_OK
;

1161 
	}
}

1170 
	$födLófNode
(
Råì
 *
pRåì
, 
i64
 
iRowid
, 
RåìNode
 **
µLóf
){

1171 
rc
;

1172 *
µLóf
 = 0;

1173 
	`sqlôe4_böd_öt64
(
pRåì
->
pRódRowid
, 1, 
iRowid
);

1174 if–
	`sqlôe4_°ï
(
pRåì
->
pRódRowid
)==
SQLITE4_ROW
 ){

1175 
i64
 
iNode
 = 
	`sqlôe4_cﬁumn_öt64
(
pRåì
->
pRódRowid
, 0);

1176 
rc
 = 
	`nodeAcquúe
(
pRåì
, 
iNode
, 0, 
µLóf
);

1177 
	`sqlôe4_ª£t
(
pRåì
->
pRódRowid
);

1179 
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pRódRowid
);

1181  
rc
;

1182 
	}
}

1190 
	$de£rülizeGeomëry
(
sqlôe4_vÆue
 *
pVÆue
, 
RåìC⁄°øöt
 *
pC⁄s
){

1191 
RåìM©chArg
 *
p
;

1192 
sqlôe4_πªe_geomëry
 *
pGeom
;

1193 
nBlob
;

1196 if–
	`sqlôe4_vÆue_ty≥
(
pVÆue
)!=
SQLITE4_BLOB
 )  
SQLITE4_ERROR
;

1199 
nBlob
 = 
	`sqlôe4_vÆue_byãs
(
pVÆue
);

1200 if–
nBlob
<()(
RåìM©chArg
)

1201 || ((
nBlob
-(
RåìM©chArg
))%())!=0

1203  
SQLITE4_ERROR
;

1206 
pGeom
 = (
sqlôe4_πªe_geomëry
 *)
	`sqlôe4_mÆloc
(

1207 (
sqlôe4_πªe_geomëry
Ë+ 
nBlob


1209 if–!
pGeom
 )  
SQLITE4_NOMEM
;

1210 
	`mem£t
(
pGeom
, 0, (
sqlôe4_πªe_geomëry
));

1211 
p
 = (
RåìM©chArg
 *)&
pGeom
[1];

1213 
	`mem˝y
(
p
, 
	`sqlôe4_vÆue_blob
(
pVÆue
), 
nBlob
);

1214 if–
p
->
magic
!=
RTREE_GEOMETRY_MAGIC


1215 || 
nBlob
!=()((
RåìM©chArg
Ë+ (
p
->
nP¨am
-1)*())

1217 
	`sqlôe4_‰ì
(
pGeom
);

1218  
SQLITE4_ERROR
;

1221 
pGeom
->
pC⁄ãxt
 = 
p
->pContext;

1222 
pGeom
->
nP¨am
 = 
p
->nParam;

1223 
pGeom
->
aP¨am
 = 
p
->aParam;

1225 
pC⁄s
->
xGeom
 = 
p
->xGeom;

1226 
pC⁄s
->
pGeom
 =ÖGeom;

1227  
SQLITE4_OK
;

1228 
	}
}

1233 
	$πªeFûãr
(

1234 
sqlôe4_vèb_curs‹
 *
pVèbCurs‹
,

1235 
idxNum
, c⁄° *
idxSå
,

1236 
¨gc
, 
sqlôe4_vÆue
 **
¨gv


1238 
Råì
 *
pRåì
 = (Råì *)
pVèbCurs‹
->
pVèb
;

1239 
RåìCurs‹
 *
pC§
 = (RåìCurs‹ *)
pVèbCurs‹
;

1241 
RåìNode
 *
pRoŸ
 = 0;

1242 
ii
;

1243 
rc
 = 
SQLITE4_OK
;

1245 
	`πªeRe„ªn˚
(
pRåì
);

1247 
	`‰ìCurs‹C⁄°øöts
(
pC§
);

1248 
pC§
->
iSå©egy
 = 
idxNum
;

1250 if–
idxNum
==1 ){

1252 
RåìNode
 *
pLóf
;

1253 
i64
 
iRowid
 = 
	`sqlôe4_vÆue_öt64
(
¨gv
[0]);

1254 
rc
 = 
	`födLófNode
(
pRåì
, 
iRowid
, &
pLóf
);

1255 
pC§
->
pNode
 = 
pLóf
;

1256 if–
pLóf
 ){

1257 
	`as£π
–
rc
==
SQLITE4_OK
 );

1258 
rc
 = 
	`nodeRowidIndex
(
pRåì
, 
pLóf
, 
iRowid
, &
pC§
->
iCñl
);

1264 if–
¨gc
>0 ){

1265 
pC§
->
aC⁄°øöt
 = 
	`sqlôe4_mÆloc
((
RåìC⁄°øöt
)*
¨gc
);

1266 
pC§
->
nC⁄°øöt
 = 
¨gc
;

1267 if–!
pC§
->
aC⁄°øöt
 ){

1268 
rc
 = 
SQLITE4_NOMEM
;

1270 
	`mem£t
(
pC§
->
aC⁄°øöt
, 0, (
RåìC⁄°øöt
)*
¨gc
);

1271 
	`as£π
–(
idxSå
==0 && 
¨gc
==0)

1272 || (
idxSå
 && ()
	`°æí
(idxSå)==
¨gc
*2) );

1273 
ii
=0; ii<
¨gc
; ii++){

1274 
RåìC⁄°øöt
 *
p
 = &
pC§
->
aC⁄°øöt
[
ii
];

1275 
p
->
›
 = 
idxSå
[
ii
*2];

1276 
p
->
iCo‹d
 = 
idxSå
[
ii
*2+1]-'a';

1277 if–
p
->
›
==
RTREE_MATCH
 ){

1282 
rc
 = 
	`de£rülizeGeomëry
(
¨gv
[
ii
], 
p
);

1283 if–
rc
!=
SQLITE4_OK
 ){

1287 
p
->
rVÆue
 = 
	`sqlôe4_vÆue_doubÀ
(
¨gv
[
ii
]);

1293 if–
rc
==
SQLITE4_OK
 ){

1294 
pC§
->
pNode
 = 0;

1295 
rc
 = 
	`nodeAcquúe
(
pRåì
, 1, 0, &
pRoŸ
);

1297 if–
rc
==
SQLITE4_OK
 ){

1298 
isEof
 = 1;

1299 
nCñl
 = 
	`NCELL
(
pRoŸ
);

1300 
pC§
->
pNode
 = 
pRoŸ
;

1301 
pC§
->
iCñl
=0; 
rc
==
SQLITE4_OK
 &&ÖC§->iCñl<
nCñl
;ÖCsr->iCell++){

1302 
	`as£π
–
pC§
->
pNode
==
pRoŸ
 );

1303 
rc
 = 
	`des˚ndToCñl
(
pRåì
, 
pC§
,ÖRåì->
iDïth
, &
isEof
);

1304 if–!
isEof
 ){

1308 if–
rc
==
SQLITE4_OK
 && 
isEof
 ){

1309 
	`as£π
–
pC§
->
pNode
==
pRoŸ
 );

1310 
	`nodeRñó£
(
pRåì
, 
pRoŸ
);

1311 
pC§
->
pNode
 = 0;

1313 
	`as£π
–
rc
!=
SQLITE4_OK
 || !
pC§
->
pNode
 ||ÖC§->
iCñl
<
	`NCELL
(pCsr->pNode) );

1317 
	`πªeRñó£
(
pRåì
);

1318  
rc
;

1319 
	}
}

1355 
	$πªeBe°Index
(
sqlôe4_vèb
 *
èb
, 
sqlôe4_ödex_öfo
 *
pIdxInfo
){

1356 
rc
 = 
SQLITE4_OK
;

1357 
ii
;

1359 
iIdx
 = 0;

1360 
zIdxSå
[
RTREE_MAX_DIMENSIONS
*8+1];

1361 
	`mem£t
(
zIdxSå
, 0, (zIdxStr));

1362 
	`UNUSED_PARAMETER
(
èb
);

1364 
	`as£π
–
pIdxInfo
->
idxSå
==0 );

1365 
ii
=0; ii<
pIdxInfo
->
nC⁄°øöt
 && 
iIdx
<()((
zIdxSå
)-1); ii++){

1366 
sqlôe4_ödex_c⁄°øöt
 *
p
 = &
pIdxInfo
->
aC⁄°øöt
[
ii
];

1368 if–
p
->
ußbÀ
 &&Ö->
iCﬁumn
==0 &&Ö->
›
==
SQLITE4_INDEX_CONSTRAINT_EQ
 ){

1370 
jj
;

1371 
jj
=0; jj<
ii
; jj++){

1372 
pIdxInfo
->
aC⁄°øötUßge
[
jj
].
¨gvIndex
 = 0;

1373 
pIdxInfo
->
aC⁄°øötUßge
[
jj
].
omô
 = 0;

1375 
pIdxInfo
->
idxNum
 = 1;

1376 
pIdxInfo
->
aC⁄°øötUßge
[
ii
].
¨gvIndex
 = 1;

1377 
pIdxInfo
->
aC⁄°øötUßge
[
jj
].
omô
 = 1;

1384 
pIdxInfo
->
e°im©edCo°
 = 10.0;

1385  
SQLITE4_OK
;

1388 if–
p
->
ußbÀ
 && (p->
iCﬁumn
>0 ||Ö->
›
==
SQLITE4_INDEX_CONSTRAINT_MATCH
) ){

1389 
u8
 
›
;

1390  
p
->
›
 ){

1391 
SQLITE4_INDEX_CONSTRAINT_EQ
: 
›
 = 
RTREE_EQ
; ;

1392 
SQLITE4_INDEX_CONSTRAINT_GT
: 
›
 = 
RTREE_GT
; ;

1393 
SQLITE4_INDEX_CONSTRAINT_LE
: 
›
 = 
RTREE_LE
; ;

1394 
SQLITE4_INDEX_CONSTRAINT_LT
: 
›
 = 
RTREE_LT
; ;

1395 
SQLITE4_INDEX_CONSTRAINT_GE
: 
›
 = 
RTREE_GE
; ;

1397 
	`as£π
–
p
->
›
==
SQLITE4_INDEX_CONSTRAINT_MATCH
 );

1398 
›
 = 
RTREE_MATCH
;

1401 
zIdxSå
[
iIdx
++] = 
›
;

1402 
zIdxSå
[
iIdx
++] = 
p
->
iCﬁumn
 - 1 + 'a';

1403 
pIdxInfo
->
aC⁄°øötUßge
[
ii
].
¨gvIndex
 = (
iIdx
/2);

1404 
pIdxInfo
->
aC⁄°øötUßge
[
ii
].
omô
 = 1;

1408 
pIdxInfo
->
idxNum
 = 2;

1409 
pIdxInfo
->
√edToFªeIdxSå
 = 1;

1410 if–
iIdx
>0 && 0==(
pIdxInfo
->
idxSå
 = 
	`sqlôe4_m¥ötf
("%s", 
zIdxSå
)) ){

1411  
SQLITE4_NOMEM
;

1413 
	`as£π
–
iIdx
>=0 );

1414 
pIdxInfo
->
e°im©edCo°
 = (2000000.0 / ()(
iIdx
 + 1));

1415  
rc
;

1416 
	}
}

1421 
	$˚ŒAªa
(
Råì
 *
pRåì
, 
RåìCñl
 *
p
){

1422 
¨ó
 = 1.0;

1423 
ii
;

1424 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

1425 
¨ó
 = ()◊ª®* (
	`DCOORD
(
p
->
aCo‹d
[
ii
+1]) - DCOORD(p->aCoord[ii])));

1427  
¨ó
;

1428 
	}
}

1434 
	$˚ŒM¨gö
(
Råì
 *
pRåì
, 
RåìCñl
 *
p
){

1435 
m¨gö
 = 0.0;

1436 
ii
;

1437 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

1438 
m¨gö
 +()(
	`DCOORD
(
p
->
aCo‹d
[
ii
+1]) - DCOORD(p->aCoord[ii]));

1440  
m¨gö
;

1441 
	}
}

1446 
	$˚ŒUni⁄
(
Råì
 *
pRåì
, 
RåìCñl
 *
p1
, RåìCñ»*
p2
){

1447 
ii
;

1448 if–
pRåì
->
eCo‹dTy≥
==
RTREE_COORD_REAL32
 ){

1449 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

1450 
p1
->
aCo‹d
[
ii
].
f
 = 
	`MIN
’1->aCo‹d[ii].f, 
p2
->aCoord[ii].f);

1451 
p1
->
aCo‹d
[
ii
+1].
f
 = 
	`MAX
’1->aCo‹d[ii+1].f, 
p2
->aCoord[ii+1].f);

1454 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

1455 
p1
->
aCo‹d
[
ii
].
i
 = 
	`MIN
’1->aCo‹d[ii].i, 
p2
->aCoord[ii].i);

1456 
p1
->
aCo‹d
[
ii
+1].
i
 = 
	`MAX
’1->aCo‹d[ii+1].i, 
p2
->aCoord[ii+1].i);

1459 
	}
}

1465 
	$˚ŒC⁄èös
(
Råì
 *
pRåì
, 
RåìCñl
 *
p1
, RåìCñ»*
p2
){

1466 
ii
;

1467 
isI¡
 = (
pRåì
->
eCo‹dTy≥
==
RTREE_COORD_INT32
);

1468 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

1469 
RåìCo‹d
 *
a1
 = &
p1
->
aCo‹d
[
ii
];

1470 
RåìCo‹d
 *
a2
 = &
p2
->
aCo‹d
[
ii
];

1471 if–(!
isI¡
 && (
a2
[0].
f
<
a1
[0].f ||á2[1].f>a1[1].f))

1472 || ( 
isI¡
 && (
a2
[0].
i
<
a1
[0].i ||á2[1].i>a1[1].i))

1478 
	}
}

1483 
	$˚ŒGrowth
(
Råì
 *
pRåì
, 
RåìCñl
 *
p
, RåìCñ»*
pCñl
){

1484 
¨ó
;

1485 
RåìCñl
 
˚Œ
;

1486 
	`mem˝y
(&
˚Œ
, 
p
, (
RåìCñl
));

1487 
¨ó
 = 
	`˚ŒAªa
(
pRåì
, &
˚Œ
);

1488 
	`˚ŒUni⁄
(
pRåì
, &
˚Œ
, 
pCñl
);

1489  (
	`˚ŒAªa
(
pRåì
, &
˚Œ
)-
¨ó
);

1490 
	}
}

1492 #i‡
VARIANT_RSTARTREE_CHOOSESUBTREE
 || 
VARIANT_RSTARTREE_SPLIT


1493 
	$˚ŒOvîœp
(

1494 
Råì
 *
pRåì
,

1495 
RåìCñl
 *
p
,

1496 
RåìCñl
 *
aCñl
,

1497 
nCñl
,

1498 
iEx˛ude


1500 
ii
;

1501 
ovîœp
 = 0.0;

1502 
ii
=0; ii<
nCñl
; ii++){

1503 #i‡
VARIANT_RSTARTREE_CHOOSESUBTREE


1504 if–
ii
!=
iEx˛ude
 )

1506 
	`as£π
–
iEx˛ude
==-1 );

1507 
	`UNUSED_PARAMETER
(
iEx˛ude
);

1510 
jj
;

1511 
o
 = 1.0;

1512 
jj
=0; jj<(
pRåì
->
nDim
*2); jj+=2){

1513 
x1
;

1514 
x2
;

1516 
x1
 = 
	`MAX
(
	`DCOORD
(
p
->
aCo‹d
[
jj
]), DCOORD(
aCñl
[
ii
].aCoord[jj]));

1517 
x2
 = 
	`MIN
(
	`DCOORD
(
p
->
aCo‹d
[
jj
+1]), DCOORD(
aCñl
[
ii
].aCoord[jj+1]));

1519 if–
x2
<
x1
 ){

1520 
o
 = 0.0;

1523 
o
 = o * ()(
x2
-
x1
);

1526 
ovîœp
 +
o
;

1529  
ovîœp
;

1530 
	}
}

1533 #i‡
VARIANT_RSTARTREE_CHOOSESUBTREE


1534 
	$˚ŒOvîœpE∆¨gemít
(

1535 
Råì
 *
pRåì
,

1536 
RåìCñl
 *
p
,

1537 
RåìCñl
 *
pIn£π
,

1538 
RåìCñl
 *
aCñl
,

1539 
nCñl
,

1540 
iEx˛ude


1542 
bef‹e
;

1543 
a·î
;

1544 
bef‹e
 = 
	`˚ŒOvîœp
(
pRåì
, 
p
, 
aCñl
, 
nCñl
, 
iEx˛ude
);

1545 
	`˚ŒUni⁄
(
pRåì
, 
p
, 
pIn£π
);

1546 
a·î
 = 
	`˚ŒOvîœp
(
pRåì
, 
p
, 
aCñl
, 
nCñl
, 
iEx˛ude
);

1547  ()(
a·î
-
bef‹e
);

1548 
	}
}

1556 
	$Choo£Lóf
(

1557 
Råì
 *
pRåì
,

1558 
RåìCñl
 *
pCñl
,

1559 
iHeight
,

1560 
RåìNode
 **
µLóf


1562 
rc
;

1563 
ii
;

1564 
RåìNode
 *
pNode
;

1565 
rc
 = 
	`nodeAcquúe
(
pRåì
, 1, 0, &
pNode
);

1567 
ii
=0; 
rc
==
SQLITE4_OK
 && ii<(
pRåì
->
iDïth
-
iHeight
); ii++){

1568 
iCñl
;

1569 
sqlôe4_öt64
 
iBe°
 = 0;

1571 
fMöGrowth
 = 0.0;

1572 
fMöAªa
 = 0.0;

1573 #i‡
VARIANT_RSTARTREE_CHOOSESUBTREE


1574 
fMöOvîœp
 = 0.0;

1575 
ovîœp
;

1578 
nCñl
 = 
	`NCELL
(
pNode
);

1579 
RåìCñl
 
˚Œ
;

1580 
RåìNode
 *
pChûd
;

1582 
RåìCñl
 *
aCñl
 = 0;

1584 #i‡
VARIANT_RSTARTREE_CHOOSESUBTREE


1585 if–
ii
==(
pRåì
->
iDïth
-1) ){

1586 
jj
;

1587 
aCñl
 = 
	`sqlôe4_mÆloc
((
RåìCñl
)*
nCñl
);

1588 if–!
aCñl
 ){

1589 
rc
 = 
SQLITE4_NOMEM
;

1590 
	`nodeRñó£
(
pRåì
, 
pNode
);

1591 
pNode
 = 0;

1594 
jj
=0; jj<
nCñl
; jj++){

1595 
	`nodeGëCñl
(
pRåì
, 
pNode
, 
jj
, &
aCñl
[jj]);

1604 
iCñl
=0; iCñl<
nCñl
; iCell++){

1605 
bBe°
 = 0;

1606 
growth
;

1607 
¨ó
;

1608 
	`nodeGëCñl
(
pRåì
, 
pNode
, 
iCñl
, &
˚Œ
);

1609 
growth
 = 
	`˚ŒGrowth
(
pRåì
, &
˚Œ
, 
pCñl
);

1610 
¨ó
 = 
	`˚ŒAªa
(
pRåì
, &
˚Œ
);

1612 #i‡
VARIANT_RSTARTREE_CHOOSESUBTREE


1613 if–
ii
==(
pRåì
->
iDïth
-1) ){

1614 
ovîœp
 = 
	`˚ŒOvîœpE∆¨gemít
(
pRåì
,&
˚Œ
,
pCñl
,
aCñl
,
nCñl
,
iCñl
);

1616 
ovîœp
 = 0.0;

1618 if–(
iCñl
==0)

1619 || (
ovîœp
<
fMöOvîœp
)

1620 || (
ovîœp
==
fMöOvîœp
 && 
growth
<
fMöGrowth
)

1621 || (
ovîœp
==
fMöOvîœp
 && 
growth
==
fMöGrowth
 && 
¨ó
<
fMöAªa
)

1623 
bBe°
 = 1;

1624 
fMöOvîœp
 = 
ovîœp
;

1627 if–
iCñl
==0||
growth
<
fMöGrowth
||(growth==fMöGrowth && 
¨ó
<
fMöAªa
) ){

1628 
bBe°
 = 1;

1631 if–
bBe°
 ){

1632 
fMöGrowth
 = 
growth
;

1633 
fMöAªa
 = 
¨ó
;

1634 
iBe°
 = 
˚Œ
.
iRowid
;

1638 
	`sqlôe4_‰ì
(
aCñl
);

1639 
rc
 = 
	`nodeAcquúe
(
pRåì
, 
iBe°
, 
pNode
, &
pChûd
);

1640 
	`nodeRñó£
(
pRåì
, 
pNode
);

1641 
pNode
 = 
pChûd
;

1644 *
µLóf
 = 
pNode
;

1645  
rc
;

1646 
	}
}

1653 
	$Adju°Tªe
(

1654 
Råì
 *
pRåì
,

1655 
RåìNode
 *
pNode
,

1656 
RåìCñl
 *
pCñl


1658 
RåìNode
 *
p
 = 
pNode
;

1659  
p
->
pP¨ít
 ){

1660 
RåìNode
 *
pP¨ít
 = 
p
->pParent;

1661 
RåìCñl
 
˚Œ
;

1662 
iCñl
;

1664 if–
	`nodeP¨ítIndex
(
pRåì
, 
p
, &
iCñl
) ){

1665  
SQLITE4_CORRUPT_VTAB
;

1668 
	`nodeGëCñl
(
pRåì
, 
pP¨ít
, 
iCñl
, &
˚Œ
);

1669 if–!
	`˚ŒC⁄èös
(
pRåì
, &
˚Œ
, 
pCñl
) ){

1670 
	`˚ŒUni⁄
(
pRåì
, &
˚Œ
, 
pCñl
);

1671 
	`nodeOvîwrôeCñl
(
pRåì
, 
pP¨ít
, &
˚Œ
, 
iCñl
);

1674 
p
 = 
pP¨ít
;

1676  
SQLITE4_OK
;

1677 
	}
}

1682 
	$rowidWrôe
(
Råì
 *
pRåì
, 
sqlôe4_öt64
 
iRowid
, sqlôe4_öt64 
iNode
){

1683 
	`sqlôe4_böd_öt64
(
pRåì
->
pWrôeRowid
, 1, 
iRowid
);

1684 
	`sqlôe4_böd_öt64
(
pRåì
->
pWrôeRowid
, 2, 
iNode
);

1685 
	`sqlôe4_°ï
(
pRåì
->
pWrôeRowid
);

1686  
	`sqlôe4_ª£t
(
pRåì
->
pWrôeRowid
);

1687 
	}
}

1692 
	$∑ª¡Wrôe
(
Råì
 *
pRåì
, 
sqlôe4_öt64
 
iNode
, sqlôe4_öt64 
iP¨
){

1693 
	`sqlôe4_böd_öt64
(
pRåì
->
pWrôeP¨ít
, 1, 
iNode
);

1694 
	`sqlôe4_böd_öt64
(
pRåì
->
pWrôeP¨ít
, 2, 
iP¨
);

1695 
	`sqlôe4_°ï
(
pRåì
->
pWrôeP¨ít
);

1696  
	`sqlôe4_ª£t
(
pRåì
->
pWrôeP¨ít
);

1697 
	}
}

1699 
πªeIn£πCñl
(
Råì
 *, 
RåìNode
 *, 
RåìCñl
 *, );

1701 #i‡
VARIANT_GUTTMAN_LINEAR_SPLIT


1706 
RåìCñl
 *
	$LöórPickNext
(

1707 
Råì
 *
pRåì
,

1708 
RåìCñl
 *
aCñl
,

1709 
nCñl
,

1710 
RåìCñl
 *
pLe·Box
,

1711 
RåìCñl
 *
pRightBox
,

1712 *
aiU£d


1714 
ii
;

1715 
ii
=0; 
aiU£d
[ii]; ii++);

1716 
aiU£d
[
ii
] = 1;

1717  &
aCñl
[
ii
];

1718 
	}
}

1724 
	$LöórPickSìds
(

1725 
Råì
 *
pRåì
,

1726 
RåìCñl
 *
aCñl
,

1727 
nCñl
,

1728 *
piLe·Sìd
,

1729 *
piRightSìd


1731 
i
;

1732 
iLe·Sìd
 = 0;

1733 
iRightSìd
 = 1;

1734 
maxN‹mÆI¬îWidth
 = 0.0;

1741 
i
=0; i<
pRåì
->
nDim
; i++){

1742 
x1
 = 
	`DCOORD
(
aCñl
[0].
aCo‹d
[
i
*2]);

1743 
x2
 = 
	`DCOORD
(
aCñl
[0].
aCo‹d
[
i
*2+1]);

1744 
x3
 = 
x1
;

1745 
x4
 = 
x2
;

1746 
jj
;

1748 
iCñlLe·
 = 0;

1749 
iCñlRight
 = 0;

1751 
jj
=1; jj<
nCñl
; jj++){

1752 
À·
 = 
	`DCOORD
(
aCñl
[
jj
].
aCo‹d
[
i
*2]);

1753 
right
 = 
	`DCOORD
(
aCñl
[
jj
].
aCo‹d
[
i
*2+1]);

1755 if–
À·
<
x1
 ) x1 =Üeft;

1756 if–
right
>
x4
 ) x4 =Ñight;

1757 if–
À·
>
x3
 ){

1758 
x3
 = 
À·
;

1759 
iCñlRight
 = 
jj
;

1761 if–
right
<
x2
 ){

1762 
x2
 = 
right
;

1763 
iCñlLe·
 = 
jj
;

1767 if–
x4
!=
x1
 ){

1768 
n‹mÆwidth
 = (
x3
 - 
x2
Ë/ (
x4
 - 
x1
);

1769 if–
n‹mÆwidth
>
maxN‹mÆI¬îWidth
 ){

1770 
iLe·Sìd
 = 
iCñlLe·
;

1771 
iRightSìd
 = 
iCñlRight
;

1776 *
piLe·Sìd
 = 
iLe·Sìd
;

1777 *
piRightSìd
 = 
iRightSìd
;

1778 
	}
}

1781 #i‡
VARIANT_GUTTMAN_QUADRATIC_SPLIT


1786 
RåìCñl
 *
	$QuadøticPickNext
(

1787 
Råì
 *
pRåì
,

1788 
RåìCñl
 *
aCñl
,

1789 
nCñl
,

1790 
RåìCñl
 *
pLe·Box
,

1791 
RåìCñl
 *
pRightBox
,

1792 *
aiU£d


1794 
	#FABS
(
a
Ë(◊)<0.0?-1.0*◊):◊))

	)

1796 
iSñe˘
 = -1;

1797 
fDiff
;

1798 
ii
;

1799 
ii
=0; ii<
nCñl
; ii++){

1800 if–
aiU£d
[
ii
]==0 ){

1801 
À·
 = 
	`˚ŒGrowth
(
pRåì
, 
pLe·Box
, &
aCñl
[
ii
]);

1802 
right
 = 
	`˚ŒGrowth
(
pRåì
, 
pLe·Box
, &
aCñl
[
ii
]);

1803 
diff
 = 
	`FABS
(
right
-
À·
);

1804 if–
iSñe˘
<0 || 
diff
>
fDiff
 ){

1805 
fDiff
 = 
diff
;

1806 
iSñe˘
 = 
ii
;

1810 
aiU£d
[
iSñe˘
] = 1;

1811  &
aCñl
[
iSñe˘
];

1812 
	}
}

1818 
	$QuadøticPickSìds
(

1819 
Råì
 *
pRåì
,

1820 
RåìCñl
 *
aCñl
,

1821 
nCñl
,

1822 *
piLe·Sìd
,

1823 *
piRightSìd


1825 
ii
;

1826 
jj
;

1828 
iLe·Sìd
 = 0;

1829 
iRightSìd
 = 1;

1830 
fWa°e
 = 0.0;

1832 
ii
=0; ii<
nCñl
; ii++){

1833 
jj
=
ii
+1; jj<
nCñl
; jj++){

1834 
right
 = 
	`˚ŒAªa
(
pRåì
, &
aCñl
[
jj
]);

1835 
growth
 = 
	`˚ŒGrowth
(
pRåì
, &
aCñl
[
ii
], &aCñl[
jj
]);

1836 
wa°e
 = 
growth
 - 
right
;

1838 if–
wa°e
>
fWa°e
 ){

1839 
iLe·Sìd
 = 
ii
;

1840 
iRightSìd
 = 
jj
;

1841 
fWa°e
 = 
wa°e
;

1846 *
piLe·Sìd
 = 
iLe·Sìd
;

1847 *
piRightSìd
 = 
iRightSìd
;

1848 
	}
}

1868 
	$S‹tByDi°™˚
(

1869 *
aIdx
,

1870 
nIdx
,

1871 *
aDi°™˚
,

1872 *
aS∑ª


1874 if–
nIdx
>1 ){

1875 
iLe·
 = 0;

1876 
iRight
 = 0;

1878 
nLe·
 = 
nIdx
/2;

1879 
nRight
 = 
nIdx
-
nLe·
;

1880 *
aLe·
 = 
aIdx
;

1881 *
aRight
 = &
aIdx
[
nLe·
];

1883 
	`S‹tByDi°™˚
(
aLe·
, 
nLe·
, 
aDi°™˚
, 
aS∑ª
);

1884 
	`S‹tByDi°™˚
(
aRight
, 
nRight
, 
aDi°™˚
, 
aS∑ª
);

1886 
	`mem˝y
(
aS∑ª
, 
aLe·
, ()*
nLe·
);

1887 
aLe·
 = 
aS∑ª
;

1889  
iLe·
<
nLe·
 || 
iRight
<
nRight
 ){

1890 if–
iLe·
==
nLe·
 ){

1891 
aIdx
[
iLe·
+
iRight
] = 
aRight
[iRight];

1892 
iRight
++;

1893 }if–
iRight
==
nRight
 ){

1894 
aIdx
[
iLe·
+
iRight
] = 
aLe·
[iLeft];

1895 
iLe·
++;

1897 
fLe·
 = 
aDi°™˚
[
aLe·
[
iLe·
]];

1898 
fRight
 = 
aDi°™˚
[
aRight
[
iRight
]];

1899 if–
fLe·
<
fRight
 ){

1900 
aIdx
[
iLe·
+
iRight
] = 
aLe·
[iLeft];

1901 
iLe·
++;

1903 
aIdx
[
iLe·
+
iRight
] = 
aRight
[iRight];

1904 
iRight
++;

1912 
jj
;

1913 
jj
=1; jj<
nIdx
; jj++){

1914 
À·
 = 
aDi°™˚
[
aIdx
[
jj
-1]];

1915 
right
 = 
aDi°™˚
[
aIdx
[
jj
]];

1916 
	`as£π
–
À·
<=
right
 );

1921 
	}
}

1934 
	$S‹tByDimísi⁄
(

1935 
Råì
 *
pRåì
,

1936 *
aIdx
,

1937 
nIdx
,

1938 
iDim
,

1939 
RåìCñl
 *
aCñl
,

1940 *
aS∑ª


1942 if–
nIdx
>1 ){

1944 
iLe·
 = 0;

1945 
iRight
 = 0;

1947 
nLe·
 = 
nIdx
/2;

1948 
nRight
 = 
nIdx
-
nLe·
;

1949 *
aLe·
 = 
aIdx
;

1950 *
aRight
 = &
aIdx
[
nLe·
];

1952 
	`S‹tByDimísi⁄
(
pRåì
, 
aLe·
, 
nLe·
, 
iDim
, 
aCñl
, 
aS∑ª
);

1953 
	`S‹tByDimísi⁄
(
pRåì
, 
aRight
, 
nRight
, 
iDim
, 
aCñl
, 
aS∑ª
);

1955 
	`mem˝y
(
aS∑ª
, 
aLe·
, ()*
nLe·
);

1956 
aLe·
 = 
aS∑ª
;

1957  
iLe·
<
nLe·
 || 
iRight
<
nRight
 ){

1958 
xÀ·1
 = 
	`DCOORD
(
aCñl
[
aLe·
[
iLe·
]].
aCo‹d
[
iDim
*2]);

1959 
xÀ·2
 = 
	`DCOORD
(
aCñl
[
aLe·
[
iLe·
]].
aCo‹d
[
iDim
*2+1]);

1960 
xright1
 = 
	`DCOORD
(
aCñl
[
aRight
[
iRight
]].
aCo‹d
[
iDim
*2]);

1961 
xright2
 = 
	`DCOORD
(
aCñl
[
aRight
[
iRight
]].
aCo‹d
[
iDim
*2+1]);

1962 if–(
iLe·
!=
nLe·
Ë&& ((
iRight
==
nRight
)

1963 || (
xÀ·1
<
xright1
)

1964 || (
xÀ·1
==
xright1
 && 
xÀ·2
<
xright2
)

1966 
aIdx
[
iLe·
+
iRight
] = 
aLe·
[iLeft];

1967 
iLe·
++;

1969 
aIdx
[
iLe·
+
iRight
] = 
aRight
[iRight];

1970 
iRight
++;

1977 
jj
;

1978 
jj
=1; jj<
nIdx
; jj++){

1979 
xÀ·1
 = 
aCñl
[
aIdx
[
jj
-1]].
aCo‹d
[
iDim
*2];

1980 
xÀ·2
 = 
aCñl
[
aIdx
[
jj
-1]].
aCo‹d
[
iDim
*2+1];

1981 
xright1
 = 
aCñl
[
aIdx
[
jj
]].
aCo‹d
[
iDim
*2];

1982 
xright2
 = 
aCñl
[
aIdx
[
jj
]].
aCo‹d
[
iDim
*2+1];

1983 
	`as£π
–
xÀ·1
<=
xright1
 && (xÀ·1<xright1 || 
xÀ·2
<=
xright2
) );

1988 
	}
}

1990 #i‡
VARIANT_RSTARTREE_SPLIT


1994 
	$•lôNodeSèπªe
(

1995 
Råì
 *
pRåì
,

1996 
RåìCñl
 *
aCñl
,

1997 
nCñl
,

1998 
RåìNode
 *
pLe·
,

1999 
RåìNode
 *
pRight
,

2000 
RåìCñl
 *
pBboxLe·
,

2001 
RåìCñl
 *
pBboxRight


2003 **
ØS‹ãd
;

2004 *
aS∑ª
;

2005 
ii
;

2007 
iBe°Dim
 = 0;

2008 
iBe°S∂ô
 = 0;

2009 
fBe°M¨gö
 = 0.0;

2011 
nByã
 = (
pRåì
->
nDim
+1)*((*)+
nCñl
*());

2013 
ØS‹ãd
 = (**)
	`sqlôe4_mÆloc
(
nByã
);

2014 if–!
ØS‹ãd
 ){

2015  
SQLITE4_NOMEM
;

2018 
aS∑ª
 = &((*)&
ØS‹ãd
[
pRåì
->
nDim
])[pRåì->nDim*
nCñl
];

2019 
	`mem£t
(
ØS‹ãd
, 0, 
nByã
);

2020 
ii
=0; ii<
pRåì
->
nDim
; ii++){

2021 
jj
;

2022 
ØS‹ãd
[
ii
] = &((*)&ØS‹ãd[
pRåì
->
nDim
])[ii*
nCñl
];

2023 
jj
=0; jj<
nCñl
; jj++){

2024 
ØS‹ãd
[
ii
][
jj
] = jj;

2026 
	`S‹tByDimísi⁄
(
pRåì
, 
ØS‹ãd
[
ii
], 
nCñl
, ii, 
aCñl
, 
aS∑ª
);

2029 
ii
=0; ii<
pRåì
->
nDim
; ii++){

2030 
m¨gö
 = 0.0;

2031 
fBe°Ovîœp
 = 0.0;

2032 
fBe°Aªa
 = 0.0;

2033 
iBe°Le·
 = 0;

2034 
nLe·
;

2037 
nLe·
=
	`RTREE_MINCELLS
(
pRåì
);

2038 
nLe·
<=(
nCñl
-
	`RTREE_MINCELLS
(
pRåì
));

2039 
nLe·
++

2041 
RåìCñl
 
À·
;

2042 
RåìCñl
 
right
;

2043 
kk
;

2044 
ovîœp
;

2045 
¨ó
;

2047 
	`mem˝y
(&
À·
, &
aCñl
[
ØS‹ãd
[
ii
][0]], (
RåìCñl
));

2048 
	`mem˝y
(&
right
, &
aCñl
[
ØS‹ãd
[
ii
][
nCñl
-1]], (
RåìCñl
));

2049 
kk
=1; kk<(
nCñl
-1); kk++){

2050 if–
kk
<
nLe·
 ){

2051 
	`˚ŒUni⁄
(
pRåì
, &
À·
, &
aCñl
[
ØS‹ãd
[
ii
][
kk
]]);

2053 
	`˚ŒUni⁄
(
pRåì
, &
right
, &
aCñl
[
ØS‹ãd
[
ii
][
kk
]]);

2056 
m¨gö
 +
	`˚ŒM¨gö
(
pRåì
, &
À·
);

2057 
m¨gö
 +
	`˚ŒM¨gö
(
pRåì
, &
right
);

2058 
ovîœp
 = 
	`˚ŒOvîœp
(
pRåì
, &
À·
, &
right
, 1, -1);

2059 
¨ó
 = 
	`˚ŒAªa
(
pRåì
, &
À·
Ë+ cñlAªa’Råì, &
right
);

2060 if–(
nLe·
==
	`RTREE_MINCELLS
(
pRåì
))

2061 || (
ovîœp
<
fBe°Ovîœp
)

2062 || (
ovîœp
==
fBe°Ovîœp
 && 
¨ó
<
fBe°Aªa
)

2064 
iBe°Le·
 = 
nLe·
;

2065 
fBe°Ovîœp
 = 
ovîœp
;

2066 
fBe°Aªa
 = 
¨ó
;

2070 if–
ii
==0 || 
m¨gö
<
fBe°M¨gö
 ){

2071 
iBe°Dim
 = 
ii
;

2072 
fBe°M¨gö
 = 
m¨gö
;

2073 
iBe°S∂ô
 = 
iBe°Le·
;

2077 
	`mem˝y
(
pBboxLe·
, &
aCñl
[
ØS‹ãd
[
iBe°Dim
][0]], (
RåìCñl
));

2078 
	`mem˝y
(
pBboxRight
, &
aCñl
[
ØS‹ãd
[
iBe°Dim
][
iBe°S∂ô
]], (
RåìCñl
));

2079 
ii
=0; ii<
nCñl
; ii++){

2080 
RåìNode
 *
pT¨gë
 = (
ii
<
iBe°S∂ô
)?
pLe·
:
pRight
;

2081 
RåìCñl
 *
pBbox
 = (
ii
<
iBe°S∂ô
)?
pBboxLe·
:
pBboxRight
;

2082 
RåìCñl
 *
pCñl
 = &
aCñl
[
ØS‹ãd
[
iBe°Dim
][
ii
]];

2083 
	`nodeIn£πCñl
(
pRåì
, 
pT¨gë
, 
pCñl
);

2084 
	`˚ŒUni⁄
(
pRåì
, 
pBbox
, 
pCñl
);

2087 
	`sqlôe4_‰ì
(
ØS‹ãd
);

2088  
SQLITE4_OK
;

2089 
	}
}

2092 #i‡
VARIANT_GUTTMAN_SPLIT


2096 
	$•lôNodeGuâm™
(

2097 
Råì
 *
pRåì
,

2098 
RåìCñl
 *
aCñl
,

2099 
nCñl
,

2100 
RåìNode
 *
pLe·
,

2101 
RåìNode
 *
pRight
,

2102 
RåìCñl
 *
pBboxLe·
,

2103 
RåìCñl
 *
pBboxRight


2105 
iLe·Sìd
 = 0;

2106 
iRightSìd
 = 1;

2107 *
aiU£d
;

2108 
i
;

2110 
aiU£d
 = 
	`sqlôe4_mÆloc
(()*
nCñl
);

2111 if–!
aiU£d
 ){

2112  
SQLITE4_NOMEM
;

2114 
	`mem£t
(
aiU£d
, 0, ()*
nCñl
);

2116 
	`PickSìds
(
pRåì
, 
aCñl
, 
nCñl
, &
iLe·Sìd
, &
iRightSìd
);

2118 
	`mem˝y
(
pBboxLe·
, &
aCñl
[
iLe·Sìd
], (
RåìCñl
));

2119 
	`mem˝y
(
pBboxRight
, &
aCñl
[
iRightSìd
], (
RåìCñl
));

2120 
	`nodeIn£πCñl
(
pRåì
, 
pLe·
, &
aCñl
[
iLe·Sìd
]);

2121 
	`nodeIn£πCñl
(
pRåì
, 
pRight
, &
aCñl
[
iRightSìd
]);

2122 
aiU£d
[
iLe·Sìd
] = 1;

2123 
aiU£d
[
iRightSìd
] = 1;

2125 
i
=
nCñl
-2; i>0; i--){

2126 
RåìCñl
 *
pNext
;

2127 
pNext
 = 
	`PickNext
(
pRåì
, 
aCñl
, 
nCñl
, 
pBboxLe·
, 
pBboxRight
, 
aiU£d
);

2128 
diff
 =

2129 
	`˚ŒGrowth
(
pRåì
, 
pBboxLe·
, 
pNext
) -

2130 
	`˚ŒGrowth
(
pRåì
, 
pBboxRight
, 
pNext
)

2132 if–(
	`RTREE_MINCELLS
(
pRåì
)-
	`NCELL
(
pRight
)==
i
)

2133 || (
diff
>0.0 && (
	`RTREE_MINCELLS
(
pRåì
)-
	`NCELL
(
pLe·
)!=
i
))

2135 
	`nodeIn£πCñl
(
pRåì
, 
pRight
, 
pNext
);

2136 
	`˚ŒUni⁄
(
pRåì
, 
pBboxRight
, 
pNext
);

2138 
	`nodeIn£πCñl
(
pRåì
, 
pLe·
, 
pNext
);

2139 
	`˚ŒUni⁄
(
pRåì
, 
pBboxLe·
, 
pNext
);

2143 
	`sqlôe4_‰ì
(
aiU£d
);

2144  
SQLITE4_OK
;

2145 
	}
}

2148 
	$upd©eM≠pög
(

2149 
Råì
 *
pRåì
,

2150 
i64
 
iRowid
,

2151 
RåìNode
 *
pNode
,

2152 
iHeight


2154 (*
xSëM≠pög
)(
Råì
 *, 
sqlôe4_öt64
, sqlite4_int64);

2155 
xSëM≠pög
 = ((
iHeight
==0)?
rowidWrôe
:
∑ª¡Wrôe
);

2156 if–
iHeight
>0 ){

2157 
RåìNode
 *
pChûd
 = 
	`nodeHashLookup
(
pRåì
, 
iRowid
);

2158 if–
pChûd
 ){

2159 
	`nodeRñó£
(
pRåì
, 
pChûd
->
pP¨ít
);

2160 
	`nodeRe„ªn˚
(
pNode
);

2161 
pChûd
->
pP¨ít
 = 
pNode
;

2164  
	`xSëM≠pög
(
pRåì
, 
iRowid
, 
pNode
->
iNode
);

2165 
	}
}

2167 
	$S∂ôNode
(

2168 
Råì
 *
pRåì
,

2169 
RåìNode
 *
pNode
,

2170 
RåìCñl
 *
pCñl
,

2171 
iHeight


2173 
i
;

2174 
√wCñlIsRight
 = 0;

2176 
rc
 = 
SQLITE4_OK
;

2177 
nCñl
 = 
	`NCELL
(
pNode
);

2178 
RåìCñl
 *
aCñl
;

2179 *
aiU£d
;

2181 
RåìNode
 *
pLe·
 = 0;

2182 
RåìNode
 *
pRight
 = 0;

2184 
RåìCñl
 
À·bbox
;

2185 
RåìCñl
 
rightbbox
;

2190 
aCñl
 = 
	`sqlôe4_mÆloc
(((
RåìCñl
)+())*(
nCñl
+1));

2191 if–!
aCñl
 ){

2192 
rc
 = 
SQLITE4_NOMEM
;

2193 
•lônode_out
;

2195 
aiU£d
 = (*)&
aCñl
[
nCñl
+1];

2196 
	`mem£t
(
aiU£d
, 0, ()*(
nCñl
+1));

2197 
i
=0; i<
nCñl
; i++){

2198 
	`nodeGëCñl
(
pRåì
, 
pNode
, 
i
, &
aCñl
[i]);

2200 
	`nodeZîo
(
pRåì
, 
pNode
);

2201 
	`mem˝y
(&
aCñl
[
nCñl
], 
pCñl
, (
RåìCñl
));

2202 
nCñl
++;

2204 if–
pNode
->
iNode
==1 ){

2205 
pRight
 = 
	`nodeNew
(
pRåì
, 
pNode
);

2206 
pLe·
 = 
	`nodeNew
(
pRåì
, 
pNode
);

2207 
pRåì
->
iDïth
++;

2208 
pNode
->
isDúty
 = 1;

2209 
	`wrôeI¡16
(
pNode
->
zD©a
, 
pRåì
->
iDïth
);

2211 
pLe·
 = 
pNode
;

2212 
pRight
 = 
	`nodeNew
(
pRåì
, 
pLe·
->
pP¨ít
);

2213 
	`nodeRe„ªn˚
(
pLe·
);

2216 if–!
pLe·
 || !
pRight
 ){

2217 
rc
 = 
SQLITE4_NOMEM
;

2218 
•lônode_out
;

2221 
	`mem£t
(
pLe·
->
zD©a
, 0, 
pRåì
->
iNodeSize
);

2222 
	`mem£t
(
pRight
->
zD©a
, 0, 
pRåì
->
iNodeSize
);

2224 
rc
 = 
	`AssignCñls
(
pRåì
, 
aCñl
, 
nCñl
, 
pLe·
, 
pRight
, &
À·bbox
, &
rightbbox
);

2225 if–
rc
!=
SQLITE4_OK
 ){

2226 
•lônode_out
;

2234 if–
SQLITE4_OK
!=(
rc
 = 
	`nodeWrôe
(
pRåì
, 
pRight
))

2235 || (0==
pLe·
->
iNode
 && 
SQLITE4_OK
!=(
rc
 = 
	`nodeWrôe
(
pRåì
,ÖLeft)))

2237 
•lônode_out
;

2240 
rightbbox
.
iRowid
 = 
pRight
->
iNode
;

2241 
À·bbox
.
iRowid
 = 
pLe·
->
iNode
;

2243 if–
pNode
->
iNode
==1 ){

2244 
rc
 = 
	`πªeIn£πCñl
(
pRåì
, 
pLe·
->
pP¨ít
, &
À·bbox
, 
iHeight
+1);

2245 if–
rc
!=
SQLITE4_OK
 ){

2246 
•lônode_out
;

2249 
RåìNode
 *
pP¨ít
 = 
pLe·
->pParent;

2250 
iCñl
;

2251 
rc
 = 
	`nodeP¨ítIndex
(
pRåì
, 
pLe·
, &
iCñl
);

2252 if–
rc
==
SQLITE4_OK
 ){

2253 
	`nodeOvîwrôeCñl
(
pRåì
, 
pP¨ít
, &
À·bbox
, 
iCñl
);

2254 
rc
 = 
	`Adju°Tªe
(
pRåì
, 
pP¨ít
, &
À·bbox
);

2256 if–
rc
!=
SQLITE4_OK
 ){

2257 
•lônode_out
;

2260 if–(
rc
 = 
	`πªeIn£πCñl
(
pRåì
, 
pRight
->
pP¨ít
, &
rightbbox
, 
iHeight
+1)) ){

2261 
•lônode_out
;

2264 
i
=0; i<
	`NCELL
(
pRight
); i++){

2265 
i64
 
iRowid
 = 
	`nodeGëRowid
(
pRåì
, 
pRight
, 
i
);

2266 
rc
 = 
	`upd©eM≠pög
(
pRåì
, 
iRowid
, 
pRight
, 
iHeight
);

2267 if–
iRowid
==
pCñl
->iRowid ){

2268 
√wCñlIsRight
 = 1;

2270 if–
rc
!=
SQLITE4_OK
 ){

2271 
•lônode_out
;

2274 if–
pNode
->
iNode
==1 ){

2275 
i
=0; i<
	`NCELL
(
pLe·
); i++){

2276 
i64
 
iRowid
 = 
	`nodeGëRowid
(
pRåì
, 
pLe·
, 
i
);

2277 
rc
 = 
	`upd©eM≠pög
(
pRåì
, 
iRowid
, 
pLe·
, 
iHeight
);

2278 if–
rc
!=
SQLITE4_OK
 ){

2279 
•lônode_out
;

2282 }if–
√wCñlIsRight
==0 ){

2283 
rc
 = 
	`upd©eM≠pög
(
pRåì
, 
pCñl
->
iRowid
, 
pLe·
, 
iHeight
);

2286 if–
rc
==
SQLITE4_OK
 ){

2287 
rc
 = 
	`nodeRñó£
(
pRåì
, 
pRight
);

2288 
pRight
 = 0;

2290 if–
rc
==
SQLITE4_OK
 ){

2291 
rc
 = 
	`nodeRñó£
(
pRåì
, 
pLe·
);

2292 
pLe·
 = 0;

2295 
•lônode_out
:

2296 
	`nodeRñó£
(
pRåì
, 
pRight
);

2297 
	`nodeRñó£
(
pRåì
, 
pLe·
);

2298 
	`sqlôe4_‰ì
(
aCñl
);

2299  
rc
;

2300 
	}
}

2313 
	$fixLófP¨ít
(
Råì
 *
pRåì
, 
RåìNode
 *
pLóf
){

2314 
rc
 = 
SQLITE4_OK
;

2315 
RåìNode
 *
pChûd
 = 
pLóf
;

2316  
rc
==
SQLITE4_OK
 && 
pChûd
->
iNode
!=1 &&ÖChûd->
pP¨ít
==0 ){

2317 
rc2
 = 
SQLITE4_OK
;

2318 
	`sqlôe4_böd_öt64
(
pRåì
->
pRódP¨ít
, 1, 
pChûd
->
iNode
);

2319 
rc
 = 
	`sqlôe4_°ï
(
pRåì
->
pRódP¨ít
);

2320 if–
rc
==
SQLITE4_ROW
 ){

2321 
RåìNode
 *
pTe°
;

2322 
i64
 
iNode
;

2329 
iNode
 = 
	`sqlôe4_cﬁumn_öt64
(
pRåì
->
pRódP¨ít
, 0);

2330 
pTe°
=
pLóf
;ÖTe° &&ÖTe°->
iNode
!=iNode;ÖTe°ıTe°->
pP¨ít
);

2331 if–!
pTe°
 ){

2332 
rc2
 = 
	`nodeAcquúe
(
pRåì
, 
iNode
, 0, &
pChûd
->
pP¨ít
);

2335 
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pRódP¨ít
);

2336 if–
rc
==
SQLITE4_OK
 )Ñ¯
rc2
;

2337 if–
rc
==
SQLITE4_OK
 && !
pChûd
->
pP¨ít
 )Ñ¯
SQLITE4_CORRUPT_VTAB
;

2338 
pChûd
 =ÖChûd->
pP¨ít
;

2340  
rc
;

2341 
	}
}

2343 
dñëeCñl
(
Råì
 *, 
RåìNode
 *, , );

2345 
	$ªmoveNode
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
, 
iHeight
){

2346 
rc
;

2347 
rc2
;

2348 
RåìNode
 *
pP¨ít
 = 0;

2349 
iCñl
;

2351 
	`as£π
–
pNode
->
nRef
==1 );

2354 
rc
 = 
	`nodeP¨ítIndex
(
pRåì
, 
pNode
, &
iCñl
);

2355 if–
rc
==
SQLITE4_OK
 ){

2356 
pP¨ít
 = 
pNode
->pParent;

2357 
pNode
->
pP¨ít
 = 0;

2358 
rc
 = 
	`dñëeCñl
(
pRåì
, 
pP¨ít
, 
iCñl
, 
iHeight
+1);

2360 
rc2
 = 
	`nodeRñó£
(
pRåì
, 
pP¨ít
);

2361 if–
rc
==
SQLITE4_OK
 ){

2362 
rc
 = 
rc2
;

2364 if–
rc
!=
SQLITE4_OK
 ){

2365  
rc
;

2369 
	`sqlôe4_böd_öt64
(
pRåì
->
pDñëeNode
, 1, 
pNode
->
iNode
);

2370 
	`sqlôe4_°ï
(
pRåì
->
pDñëeNode
);

2371 if–
SQLITE4_OK
!=(
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pDñëeNode
)) ){

2372  
rc
;

2376 
	`sqlôe4_böd_öt64
(
pRåì
->
pDñëeP¨ít
, 1, 
pNode
->
iNode
);

2377 
	`sqlôe4_°ï
(
pRåì
->
pDñëeP¨ít
);

2378 if–
SQLITE4_OK
!=(
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pDñëeP¨ít
)) ){

2379  
rc
;

2385 
	`nodeHashDñëe
(
pRåì
, 
pNode
);

2386 
pNode
->
iNode
 = 
iHeight
;

2387 
pNode
->
pNext
 = 
pRåì
->
pDñëed
;

2388 
pNode
->
nRef
++;

2389 
pRåì
->
pDñëed
 = 
pNode
;

2391  
SQLITE4_OK
;

2392 
	}
}

2394 
	$fixBoundögBox
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
){

2395 
RåìNode
 *
pP¨ít
 = 
pNode
->pParent;

2396 
rc
 = 
SQLITE4_OK
;

2397 if–
pP¨ít
 ){

2398 
ii
;

2399 
nCñl
 = 
	`NCELL
(
pNode
);

2400 
RåìCñl
 
box
;

2401 
	`nodeGëCñl
(
pRåì
, 
pNode
, 0, &
box
);

2402 
ii
=1; ii<
nCñl
; ii++){

2403 
RåìCñl
 
˚Œ
;

2404 
	`nodeGëCñl
(
pRåì
, 
pNode
, 
ii
, &
˚Œ
);

2405 
	`˚ŒUni⁄
(
pRåì
, &
box
, &
˚Œ
);

2407 
box
.
iRowid
 = 
pNode
->
iNode
;

2408 
rc
 = 
	`nodeP¨ítIndex
(
pRåì
, 
pNode
, &
ii
);

2409 if–
rc
==
SQLITE4_OK
 ){

2410 
	`nodeOvîwrôeCñl
(
pRåì
, 
pP¨ít
, &
box
, 
ii
);

2411 
rc
 = 
	`fixBoundögBox
(
pRåì
, 
pP¨ít
);

2414  
rc
;

2415 
	}
}

2421 
	$dñëeCñl
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
, 
iCñl
, 
iHeight
){

2422 
RåìNode
 *
pP¨ít
;

2423 
rc
;

2425 if–
SQLITE4_OK
!=(
rc
 = 
	`fixLófP¨ít
(
pRåì
, 
pNode
)) ){

2426  
rc
;

2432 
	`nodeDñëeCñl
(
pRåì
, 
pNode
, 
iCñl
);

2439 
pP¨ít
 = 
pNode
->pParent;

2440 
	`as£π
–
pP¨ít
 || 
pNode
->
iNode
==1 );

2441 if–
pP¨ít
 ){

2442 if–
	`NCELL
(
pNode
)<
	`RTREE_MINCELLS
(
pRåì
) ){

2443 
rc
 = 
	`ªmoveNode
(
pRåì
, 
pNode
, 
iHeight
);

2445 
rc
 = 
	`fixBoundögBox
(
pRåì
, 
pNode
);

2449  
rc
;

2450 
	}
}

2452 
	$Reö£π
(

2453 
Råì
 *
pRåì
,

2454 
RåìNode
 *
pNode
,

2455 
RåìCñl
 *
pCñl
,

2456 
iHeight


2458 *
aOrdî
;

2459 *
aS∑ª
;

2460 
RåìCñl
 *
aCñl
;

2461 *
aDi°™˚
;

2462 
nCñl
;

2463 
aCíãrCo‹d
[
RTREE_MAX_DIMENSIONS
];

2464 
iDim
;

2465 
ii
;

2466 
rc
 = 
SQLITE4_OK
;

2468 
	`mem£t
(
aCíãrCo‹d
, 0, ()*
RTREE_MAX_DIMENSIONS
);

2470 
nCñl
 = 
	`NCELL
(
pNode
)+1;

2475 
aCñl
 = (
RåìCñl
 *)
	`sqlôe4_mÆloc
(
nCñl
 * (

2476 (
RåìCñl
) +

2481 if–!
aCñl
 ){

2482  
SQLITE4_NOMEM
;

2484 
aOrdî
 = (*)&
aCñl
[
nCñl
];

2485 
aS∑ª
 = (*)&
aOrdî
[
nCñl
];

2486 
aDi°™˚
 = (*)&
aS∑ª
[
nCñl
];

2488 
ii
=0; ii<
nCñl
; ii++){

2489 if–
ii
==(
nCñl
-1) ){

2490 
	`mem˝y
(&
aCñl
[
ii
], 
pCñl
, (
RåìCñl
));

2492 
	`nodeGëCñl
(
pRåì
, 
pNode
, 
ii
, &
aCñl
[ii]);

2494 
aOrdî
[
ii
] = ii;

2495 
iDim
=0; iDim<
pRåì
->
nDim
; iDim++){

2496 
aCíãrCo‹d
[
iDim
] +()
	`DCOORD
(
aCñl
[
ii
].
aCo‹d
[iDim*2]);

2497 
aCíãrCo‹d
[
iDim
] +()
	`DCOORD
(
aCñl
[
ii
].
aCo‹d
[iDim*2+1]);

2500 
iDim
=0; iDim<
pRåì
->
nDim
; iDim++){

2501 
aCíãrCo‹d
[
iDim
] = ()◊CíãrCo‹d[iDim]/(()
nCñl
*2.0));

2504 
ii
=0; ii<
nCñl
; ii++){

2505 
aDi°™˚
[
ii
] = 0.0;

2506 
iDim
=0; iDim<
pRåì
->
nDim
; iDim++){

2507 
co‹d
 = ()(
	`DCOORD
(
aCñl
[
ii
].
aCo‹d
[
iDim
*2+1]) -

2508 
	`DCOORD
(
aCñl
[
ii
].
aCo‹d
[
iDim
*2]));

2509 
aDi°™˚
[
ii
] +(
co‹d
-
aCíãrCo‹d
[
iDim
])*(coord-aCenterCoord[iDim]);

2513 
	`S‹tByDi°™˚
(
aOrdî
, 
nCñl
, 
aDi°™˚
, 
aS∑ª
);

2514 
	`nodeZîo
(
pRåì
, 
pNode
);

2516 
ii
=0; 
rc
==
SQLITE4_OK
 && ii<(
nCñl
-(
	`RTREE_MINCELLS
(
pRåì
)+1)); ii++){

2517 
RåìCñl
 *
p
 = &
aCñl
[
aOrdî
[
ii
]];

2518 
	`nodeIn£πCñl
(
pRåì
, 
pNode
, 
p
);

2519 if–
p
->
iRowid
==
pCñl
->iRowid ){

2520 if–
iHeight
==0 ){

2521 
rc
 = 
	`rowidWrôe
(
pRåì
, 
p
->
iRowid
, 
pNode
->
iNode
);

2523 
rc
 = 
	`∑ª¡Wrôe
(
pRåì
, 
p
->
iRowid
, 
pNode
->
iNode
);

2527 if–
rc
==
SQLITE4_OK
 ){

2528 
rc
 = 
	`fixBoundögBox
(
pRåì
, 
pNode
);

2530 ; 
rc
==
SQLITE4_OK
 && 
ii
<
nCñl
; ii++){

2534 
RåìNode
 *
pIn£π
;

2535 
RåìCñl
 *
p
 = &
aCñl
[
aOrdî
[
ii
]];

2536 
rc
 = 
	`Choo£Lóf
(
pRåì
, 
p
, 
iHeight
, &
pIn£π
);

2537 if–
rc
==
SQLITE4_OK
 ){

2538 
rc2
;

2539 
rc
 = 
	`πªeIn£πCñl
(
pRåì
, 
pIn£π
, 
p
, 
iHeight
);

2540 
rc2
 = 
	`nodeRñó£
(
pRåì
, 
pIn£π
);

2541 if–
rc
==
SQLITE4_OK
 ){

2542 
rc
 = 
rc2
;

2547 
	`sqlôe4_‰ì
(
aCñl
);

2548  
rc
;

2549 
	}
}

2555 
	$πªeIn£πCñl
(

2556 
Råì
 *
pRåì
,

2557 
RåìNode
 *
pNode
,

2558 
RåìCñl
 *
pCñl
,

2559 
iHeight


2561 
rc
 = 
SQLITE4_OK
;

2562 if–
iHeight
>0 ){

2563 
RåìNode
 *
pChûd
 = 
	`nodeHashLookup
(
pRåì
, 
pCñl
->
iRowid
);

2564 if–
pChûd
 ){

2565 
	`nodeRñó£
(
pRåì
, 
pChûd
->
pP¨ít
);

2566 
	`nodeRe„ªn˚
(
pNode
);

2567 
pChûd
->
pP¨ít
 = 
pNode
;

2570 if–
	`nodeIn£πCñl
(
pRåì
, 
pNode
, 
pCñl
) ){

2571 #i‡
VARIANT_RSTARTREE_REINSERT


2572 if–
iHeight
<=
pRåì
->
iReö£πHeight
 || 
pNode
->
iNode
==1){

2573 
rc
 = 
	`S∂ôNode
(
pRåì
, 
pNode
, 
pCñl
, 
iHeight
);

2575 
pRåì
->
iReö£πHeight
 = 
iHeight
;

2576 
rc
 = 
	`Reö£π
(
pRåì
, 
pNode
, 
pCñl
, 
iHeight
);

2579 
rc
 = 
	`S∂ôNode
(
pRåì
, 
pNode
, 
pCñl
, 
iHeight
);

2582 
rc
 = 
	`Adju°Tªe
(
pRåì
, 
pNode
, 
pCñl
);

2583 if–
rc
==
SQLITE4_OK
 ){

2584 if–
iHeight
==0 ){

2585 
rc
 = 
	`rowidWrôe
(
pRåì
, 
pCñl
->
iRowid
, 
pNode
->
iNode
);

2587 
rc
 = 
	`∑ª¡Wrôe
(
pRåì
, 
pCñl
->
iRowid
, 
pNode
->
iNode
);

2591  
rc
;

2592 
	}
}

2594 
	$ªö£πNodeC⁄ã¡
(
Råì
 *
pRåì
, 
RåìNode
 *
pNode
){

2595 
ii
;

2596 
rc
 = 
SQLITE4_OK
;

2597 
nCñl
 = 
	`NCELL
(
pNode
);

2599 
ii
=0; 
rc
==
SQLITE4_OK
 && ii<
nCñl
; ii++){

2600 
RåìNode
 *
pIn£π
;

2601 
RåìCñl
 
˚Œ
;

2602 
	`nodeGëCñl
(
pRåì
, 
pNode
, 
ii
, &
˚Œ
);

2607 
rc
 = 
	`Choo£Lóf
(
pRåì
, &
˚Œ
, ()
pNode
->
iNode
, &
pIn£π
);

2608 if–
rc
==
SQLITE4_OK
 ){

2609 
rc2
;

2610 
rc
 = 
	`πªeIn£πCñl
(
pRåì
, 
pIn£π
, &
˚Œ
, ()
pNode
->
iNode
);

2611 
rc2
 = 
	`nodeRñó£
(
pRåì
, 
pIn£π
);

2612 if–
rc
==
SQLITE4_OK
 ){

2613 
rc
 = 
rc2
;

2617  
rc
;

2618 
	}
}

2623 
	$√wRowid
(
Råì
 *
pRåì
, 
i64
 *
piRowid
){

2624 
rc
;

2625 
	`sqlôe4_böd_nuŒ
(
pRåì
->
pWrôeRowid
, 1);

2626 
	`sqlôe4_böd_nuŒ
(
pRåì
->
pWrôeRowid
, 2);

2627 
	`sqlôe4_°ï
(
pRåì
->
pWrôeRowid
);

2628 
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pWrôeRowid
);

2629 *
piRowid
 = 
	`sqlôe4_œ°_ö£π_rowid
(
pRåì
->
db
);

2630  
rc
;

2631 
	}
}

2636 
	$πªeDñëeRowid
(
Råì
 *
pRåì
, 
sqlôe4_öt64
 
iDñëe
){

2637 
rc
;

2638 
RåìNode
 *
pLóf
;

2639 
iCñl
;

2640 
RåìNode
 *
pRoŸ
;

2644 
rc
 = 
	`nodeAcquúe
(
pRåì
, 1, 0, &
pRoŸ
);

2649 if–
rc
==
SQLITE4_OK
 ){

2650 
rc
 = 
	`födLófNode
(
pRåì
, 
iDñëe
, &
pLóf
);

2654 if–
rc
==
SQLITE4_OK
 ){

2655 
rc2
;

2656 
rc
 = 
	`nodeRowidIndex
(
pRåì
, 
pLóf
, 
iDñëe
, &
iCñl
);

2657 if–
rc
==
SQLITE4_OK
 ){

2658 
rc
 = 
	`dñëeCñl
(
pRåì
, 
pLóf
, 
iCñl
, 0);

2660 
rc2
 = 
	`nodeRñó£
(
pRåì
, 
pLóf
);

2661 if–
rc
==
SQLITE4_OK
 ){

2662 
rc
 = 
rc2
;

2667 if–
rc
==
SQLITE4_OK
 ){

2668 
	`sqlôe4_böd_öt64
(
pRåì
->
pDñëeRowid
, 1, 
iDñëe
);

2669 
	`sqlôe4_°ï
(
pRåì
->
pDñëeRowid
);

2670 
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pDñëeRowid
);

2681 if–
rc
==
SQLITE4_OK
 && 
pRåì
->
iDïth
>0 && 
	`NCELL
(
pRoŸ
)==1 ){

2682 
rc2
;

2683 
RåìNode
 *
pChûd
;

2684 
i64
 
iChûd
 = 
	`nodeGëRowid
(
pRåì
, 
pRoŸ
, 0);

2685 
rc
 = 
	`nodeAcquúe
(
pRåì
, 
iChûd
, 
pRoŸ
, &
pChûd
);

2686 if–
rc
==
SQLITE4_OK
 ){

2687 
rc
 = 
	`ªmoveNode
(
pRåì
, 
pChûd
,ÖRåì->
iDïth
-1);

2689 
rc2
 = 
	`nodeRñó£
(
pRåì
, 
pChûd
);

2690 if–
rc
==
SQLITE4_OK
 )Ñ¯
rc2
;

2691 if–
rc
==
SQLITE4_OK
 ){

2692 
pRåì
->
iDïth
--;

2693 
	`wrôeI¡16
(
pRoŸ
->
zD©a
, 
pRåì
->
iDïth
);

2694 
pRoŸ
->
isDúty
 = 1;

2699 
pLóf
=
pRåì
->
pDñëed
;ÖLeaf;ÖLeaf=pRtree->pDeleted){

2700 if–
rc
==
SQLITE4_OK
 ){

2701 
rc
 = 
	`ªö£πNodeC⁄ã¡
(
pRåì
, 
pLóf
);

2703 
pRåì
->
pDñëed
 = 
pLóf
->
pNext
;

2704 
	`sqlôe4_‰ì
(
pLóf
);

2708 if–
rc
==
SQLITE4_OK
 ){

2709 
rc
 = 
	`nodeRñó£
(
pRåì
, 
pRoŸ
);

2711 
	`nodeRñó£
(
pRåì
, 
pRoŸ
);

2714  
rc
;

2715 
	}
}

2720 
	$πªeUpd©e
(

2721 
sqlôe4_vèb
 *
pVèb
,

2722 
nD©a
,

2723 
sqlôe4_vÆue
 **
azD©a
,

2724 
sqlôe_öt64
 *
pRowid


2726 
Råì
 *
pRåì
 = (Råì *)
pVèb
;

2727 
rc
 = 
SQLITE4_OK
;

2728 
RåìCñl
 
˚Œ
;

2729 
bHaveRowid
 = 0;

2731 
	`πªeRe„ªn˚
(
pRåì
);

2732 
	`as£π
(
nD©a
>=1);

2745 if–
nD©a
>1 ){

2746 
ii
;

2749 
	`as£π
–
nD©a
==(
pRåì
->
nDim
*2 + 3) );

2750 if–
pRåì
->
eCo‹dTy≥
==
RTREE_COORD_REAL32
 ){

2751 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

2752 
˚Œ
.
aCo‹d
[
ii
].
f
 = ()
	`sqlôe4_vÆue_doubÀ
(
azD©a
[ii+3]);

2753 
˚Œ
.
aCo‹d
[
ii
+1].
f
 = ()
	`sqlôe4_vÆue_doubÀ
(
azD©a
[ii+4]);

2754 if–
˚Œ
.
aCo‹d
[
ii
].
f
>cell.aCoord[ii+1].f ){

2755 
rc
 = 
SQLITE4_CONSTRAINT
;

2756 
c⁄°øöt
;

2760 
ii
=0; ii<(
pRåì
->
nDim
*2); ii+=2){

2761 
˚Œ
.
aCo‹d
[
ii
].
i
 = 
	`sqlôe4_vÆue_öt
(
azD©a
[ii+3]);

2762 
˚Œ
.
aCo‹d
[
ii
+1].
i
 = 
	`sqlôe4_vÆue_öt
(
azD©a
[ii+4]);

2763 if–
˚Œ
.
aCo‹d
[
ii
].
i
>cell.aCoord[ii+1].i ){

2764 
rc
 = 
SQLITE4_CONSTRAINT
;

2765 
c⁄°øöt
;

2772 if–
	`sqlôe4_vÆue_ty≥
(
azD©a
[2])!=
SQLITE4_NULL
 ){

2773 
˚Œ
.
iRowid
 = 
	`sqlôe4_vÆue_öt64
(
azD©a
[2]);

2774 if–
	`sqlôe4_vÆue_ty≥
(
azD©a
[0])==
SQLITE4_NULL


2775 || 
	`sqlôe4_vÆue_öt64
(
azD©a
[0])!=
˚Œ
.
iRowid


2777 
°ïrc
;

2778 
	`sqlôe4_böd_öt64
(
pRåì
->
pRódRowid
, 1, 
˚Œ
.
iRowid
);

2779 
°ïrc
 = 
	`sqlôe4_°ï
(
pRåì
->
pRódRowid
);

2780 
rc
 = 
	`sqlôe4_ª£t
(
pRåì
->
pRódRowid
);

2781 if–
SQLITE4_ROW
==
°ïrc
 ){

2782 if–
	`sqlôe4_vèb_⁄_c⁄Êi˘
(
pRåì
->
db
)==
SQLITE4_REPLACE
 ){

2783 
rc
 = 
	`πªeDñëeRowid
(
pRåì
, 
˚Œ
.
iRowid
);

2785 
rc
 = 
SQLITE4_CONSTRAINT
;

2786 
c⁄°øöt
;

2790 
bHaveRowid
 = 1;

2798 if–
	`sqlôe4_vÆue_ty≥
(
azD©a
[0])!=
SQLITE4_NULL
 ){

2799 
rc
 = 
	`πªeDñëeRowid
(
pRåì
, 
	`sqlôe4_vÆue_öt64
(
azD©a
[0]));

2806 if–
rc
==
SQLITE4_OK
 && 
nD©a
>1 ){

2808 
RåìNode
 *
pLóf
;

2811 if–
bHaveRowid
==0 ){

2812 
rc
 = 
	`√wRowid
(
pRåì
, &
˚Œ
.
iRowid
);

2814 *
pRowid
 = 
˚Œ
.
iRowid
;

2816 if–
rc
==
SQLITE4_OK
 ){

2817 
rc
 = 
	`Choo£Lóf
(
pRåì
, &
˚Œ
, 0, &
pLóf
);

2819 if–
rc
==
SQLITE4_OK
 ){

2820 
rc2
;

2821 
pRåì
->
iReö£πHeight
 = -1;

2822 
rc
 = 
	`πªeIn£πCñl
(
pRåì
, 
pLóf
, &
˚Œ
, 0);

2823 
rc2
 = 
	`nodeRñó£
(
pRåì
, 
pLóf
);

2824 if–
rc
==
SQLITE4_OK
 ){

2825 
rc
 = 
rc2
;

2830 
c⁄°øöt
:

2831 
	`πªeRñó£
(
pRåì
);

2832  
rc
;

2833 
	}
}

2838 
	$πªeRíame
(
sqlôe4_vèb
 *
pVèb
, c⁄° *
zNewName
){

2839 
Råì
 *
pRåì
 = (Råì *)
pVèb
;

2840 
rc
 = 
SQLITE4_NOMEM
;

2841 *
zSql
 = 
	`sqlôe4_m¥ötf
(

2845 , 
pRåì
->
zDb
,ÖRåì->
zName
, 
zNewName


2846 , 
pRåì
->
zDb
,ÖRåì->
zName
, 
zNewName


2847 , 
pRåì
->
zDb
,ÖRåì->
zName
, 
zNewName


2849 if–
zSql
 ){

2850 
rc
 = 
	`sqlôe4_exec
(
pRåì
->
db
, 
zSql
, 0, 0, 0);

2851 
	`sqlôe4_‰ì
(
zSql
);

2853  
rc
;

2854 
	}
}

2856 
sqlôe4_moduÀ
 
	gπªeModuÀ
 = {

2858 
πªeCª©e
,

2859 
πªeC⁄√˘
,

2860 
πªeBe°Index
,

2861 
πªeDisc⁄√˘
,

2862 
πªeDe°roy
,

2863 
πªeO≥n
,

2864 
πªeClo£
,

2865 
πªeFûãr
,

2866 
πªeNext
,

2867 
πªeEof
,

2868 
πªeCﬁumn
,

2869 
πªeRowid
,

2870 
πªeUpd©e
,

2876 
πªeRíame
,

2882 
	$πªeSqlInô
(

2883 
Råì
 *
pRåì
,

2884 
sqlôe4
 *
db
,

2885 c⁄° *
zDb
,

2886 c⁄° *
zPªfix
,

2887 
isCª©e


2889 
rc
 = 
SQLITE4_OK
;

2891 
	#N_STATEMENT
 9

	)

2892 c⁄° *
azSql
[
N_STATEMENT
] = {

2908 
sqlôe4_°mt
 **
≠pStmt
[
N_STATEMENT
];

2909 
i
;

2911 
pRåì
->
db
 = db;

2913 if–
isCª©e
 ){

2914 *
zCª©e
 = 
	`sqlôe4_m¥ötf
(

2919 
zDb
, 
zPªfix
, zDb, zPªfix, zDb, zPªfix, zDb, zPªfix, 
pRåì
->
iNodeSize


2921 if–!
zCª©e
 ){

2922  
SQLITE4_NOMEM
;

2924 
rc
 = 
	`sqlôe4_exec
(
db
, 
zCª©e
, 0, 0, 0);

2925 
	`sqlôe4_‰ì
(
zCª©e
);

2926 if–
rc
!=
SQLITE4_OK
 ){

2927  
rc
;

2931 
≠pStmt
[0] = &
pRåì
->
pRódNode
;

2932 
≠pStmt
[1] = &
pRåì
->
pWrôeNode
;

2933 
≠pStmt
[2] = &
pRåì
->
pDñëeNode
;

2934 
≠pStmt
[3] = &
pRåì
->
pRódRowid
;

2935 
≠pStmt
[4] = &
pRåì
->
pWrôeRowid
;

2936 
≠pStmt
[5] = &
pRåì
->
pDñëeRowid
;

2937 
≠pStmt
[6] = &
pRåì
->
pRódP¨ít
;

2938 
≠pStmt
[7] = &
pRåì
->
pWrôeP¨ít
;

2939 
≠pStmt
[8] = &
pRåì
->
pDñëeP¨ít
;

2941 
i
=0; i<
N_STATEMENT
 && 
rc
==
SQLITE4_OK
; i++){

2942 *
zSql
 = 
	`sqlôe4_m¥ötf
(
azSql
[
i
], 
zDb
, 
zPªfix
);

2943 if–
zSql
 ){

2944 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, 
≠pStmt
[
i
], 0);

2946 
rc
 = 
SQLITE4_NOMEM
;

2948 
	`sqlôe4_‰ì
(
zSql
);

2951  
rc
;

2952 
	}
}

2961 
	$gëI¡FromStmt
(
sqlôe4
 *
db
, c⁄° *
zSql
, *
piVÆ
){

2962 
rc
 = 
SQLITE4_NOMEM
;

2963 if–
zSql
 ){

2964 
sqlôe4_°mt
 *
pStmt
 = 0;

2965 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, 0);

2966 if–
rc
==
SQLITE4_OK
 ){

2967 if–
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

2968 *
piVÆ
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

2970 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

2973  
rc
;

2974 
	}
}

2991 
	$gëNodeSize
(

2992 
sqlôe4
 *
db
,

2993 
Råì
 *
pRåì
,

2994 
isCª©e


2996 
rc
;

2997 *
zSql
;

2998 if–
isCª©e
 ){

2999 
iPageSize
 = 0;

3000 
zSql
 = 
	`sqlôe4_m¥ötf
("PRAGMA %Q.∑ge_size", 
pRåì
->
zDb
);

3001 
rc
 = 
	`gëI¡FromStmt
(
db
, 
zSql
, &
iPageSize
);

3002 if–
rc
==
SQLITE4_OK
 ){

3003 
pRåì
->
iNodeSize
 = 
iPageSize
-64;

3004 if–(4+
pRåì
->
nByãsPîCñl
*
RTREE_MAXCELLS
)<pRåì->
iNodeSize
 ){

3005 
pRåì
->
iNodeSize
 = 4+pRåì->
nByãsPîCñl
*
RTREE_MAXCELLS
;

3009 
zSql
 = 
	`sqlôe4_m¥ötf
(

3011 
pRåì
->
zDb
,ÖRåì->
zName


3013 
rc
 = 
	`gëI¡FromStmt
(
db
, 
zSql
, &
pRåì
->
iNodeSize
);

3016 
	`sqlôe4_‰ì
(
zSql
);

3017  
rc
;

3018 
	}
}

3029 
	$πªeInô
(

3030 
sqlôe4
 *
db
,

3031 *
pAux
,

3032 
¨gc
, c⁄° *c⁄°*
¨gv
,

3033 
sqlôe4_vèb
 **
µVèb
,

3034 **
pzEº
,

3035 
isCª©e


3037 
rc
 = 
SQLITE4_OK
;

3038 
Råì
 *
pRåì
;

3039 
nDb
;

3040 
nName
;

3041 
eCo‹dTy≥
 = (
pAux
 ? 
RTREE_COORD_INT32
 : 
RTREE_COORD_REAL32
);

3043 c⁄° *
aEºMsg
[] = {

3050 
iEº
 = (
¨gc
<6Ë? 2 :árgc>(
RTREE_MAX_DIMENSIONS
*2+4) ? 3 :árgc%2;

3051 if–
aEºMsg
[
iEº
] ){

3052 *
pzEº
 = 
	`sqlôe4_m¥ötf
("%s", 
aEºMsg
[
iEº
]);

3053  
SQLITE4_ERROR
;

3056 
	`sqlôe4_vèb_c⁄fig
(
db
, 
SQLITE4_VTAB_CONSTRAINT_SUPPORT
, 1);

3059 
nDb
 = 
	`°æí
(
¨gv
[1]);

3060 
nName
 = 
	`°æí
(
¨gv
[2]);

3061 
pRåì
 = (
Råì
 *)
	`sqlôe4_mÆloc
((Råì)+
nDb
+
nName
+2);

3062 if–!
pRåì
 ){

3063  
SQLITE4_NOMEM
;

3065 
	`mem£t
(
pRåì
, 0, (
Råì
)+
nDb
+
nName
+2);

3066 
pRåì
->
nBusy
 = 1;

3067 
pRåì
->
ba£
.
pModuÀ
 = &
πªeModuÀ
;

3068 
pRåì
->
zDb
 = (*)&pRtree[1];

3069 
pRåì
->
zName
 = &pRåì->
zDb
[
nDb
+1];

3070 
pRåì
->
nDim
 = (
¨gc
-4)/2;

3071 
pRåì
->
nByãsPîCñl
 = 8 +ÖRåì->
nDim
*4*2;

3072 
pRåì
->
eCo‹dTy≥
 =ÉCoordType;

3073 
	`mem˝y
(
pRåì
->
zDb
, 
¨gv
[1], 
nDb
);

3074 
	`mem˝y
(
pRåì
->
zName
, 
¨gv
[2], 
nName
);

3077 
rc
 = 
	`gëNodeSize
(
db
, 
pRåì
, 
isCª©e
);

3083 if–
rc
==
SQLITE4_OK
 ){

3084 if–(
rc
 = 
	`πªeSqlInô
(
pRåì
, 
db
, 
¨gv
[1],árgv[2], 
isCª©e
)) ){

3085 *
pzEº
 = 
	`sqlôe4_m¥ötf
("%s", 
	`sqlôe4_îrmsg
(
db
));

3087 *
zSql
 = 
	`sqlôe4_m¥ötf
("CREATE TABLE x(%s", 
¨gv
[3]);

3088 *
zTmp
;

3089 
ii
;

3090 
ii
=4; 
zSql
 && ii<
¨gc
; ii++){

3091 
zTmp
 = 
zSql
;

3092 
zSql
 = 
	`sqlôe4_m¥ötf
("%s, %s", 
zTmp
, 
¨gv
[
ii
]);

3093 
	`sqlôe4_‰ì
(
zTmp
);

3095 if–
zSql
 ){

3096 
zTmp
 = 
zSql
;

3097 
zSql
 = 
	`sqlôe4_m¥ötf
("%s);", 
zTmp
);

3098 
	`sqlôe4_‰ì
(
zTmp
);

3100 if–!
zSql
 ){

3101 
rc
 = 
SQLITE4_NOMEM
;

3102 }if–
SQLITE4_OK
!=(
rc
 = 
	`sqlôe4_de˛¨e_vèb
(
db
, 
zSql
)) ){

3103 *
pzEº
 = 
	`sqlôe4_m¥ötf
("%s", 
	`sqlôe4_îrmsg
(
db
));

3105 
	`sqlôe4_‰ì
(
zSql
);

3109 if–
rc
==
SQLITE4_OK
 ){

3110 *
µVèb
 = (
sqlôe4_vèb
 *)
pRåì
;

3112 
	`πªeRñó£
(
pRåì
);

3114  
rc
;

3115 
	}
}

3134 
	$πªíode
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

3135 *
zText
 = 0;

3136 
RåìNode
 
node
;

3137 
Råì
 
åì
;

3138 
ii
;

3140 
	`UNUSED_PARAMETER
(
nArg
);

3141 
	`mem£t
(&
node
, 0, (
RåìNode
));

3142 
	`mem£t
(&
åì
, 0, (
Råì
));

3143 
åì
.
nDim
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[0]);

3144 
åì
.
nByãsPîCñl
 = 8 + 8 *Åªe.
nDim
;

3145 
node
.
zD©a
 = (
u8
 *)
	`sqlôe4_vÆue_blob
(
≠Arg
[1]);

3147 
ii
=0; ii<
	`NCELL
(&
node
); ii++){

3148 
zCñl
[512];

3149 
nCñl
 = 0;

3150 
RåìCñl
 
˚Œ
;

3151 
jj
;

3153 
	`nodeGëCñl
(&
åì
, &
node
, 
ii
, &
˚Œ
);

3154 
	`sqlôe4_¢¥ötf
(512-
nCñl
,&
zCñl
[nCñl],"%Œd", 
˚Œ
.
iRowid
);

3155 
nCñl
 = 
	`°æí
(
zCñl
);

3156 
jj
=0; jj<
åì
.
nDim
*2; jj++){

3157 
	`sqlôe4_¢¥ötf
(512-
nCñl
,&
zCñl
[nCñl]," %f",()
˚Œ
.
aCo‹d
[
jj
].
f
);

3158 
nCñl
 = 
	`°æí
(
zCñl
);

3161 if–
zText
 ){

3162 *
zTextNew
 = 
	`sqlôe4_m¥ötf
("%†{%s}", 
zText
, 
zCñl
);

3163 
	`sqlôe4_‰ì
(
zText
);

3164 
zText
 = 
zTextNew
;

3166 
zText
 = 
	`sqlôe4_m¥ötf
("{%s}", 
zCñl
);

3170 
	`sqlôe4_ªsu…_ãxt
(
˘x
, 
zText
, -1, 
sqlôe4_‰ì
);

3171 
	}
}

3173 
	$πªedïth
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

3174 
	`UNUSED_PARAMETER
(
nArg
);

3175 if–
	`sqlôe4_vÆue_ty≥
(
≠Arg
[0])!=
SQLITE4_BLOB


3176 || 
	`sqlôe4_vÆue_byãs
(
≠Arg
[0])<2

3178 
	`sqlôe4_ªsu…_îr‹
(
˘x
, "InvalidárgumentÅoÑtreedepth()", -1);

3180 
u8
 *
zBlob
 = (u8 *)
	`sqlôe4_vÆue_blob
(
≠Arg
[0]);

3181 
	`sqlôe4_ªsu…_öt
(
˘x
, 
	`ªadI¡16
(
zBlob
));

3183 
	}
}

3190 
	$sqlôe4RåìInô
(
sqlôe4
 *
db
){

3191 c⁄° 
utf8
 = 
SQLITE4_UTF8
;

3192 
rc
;

3194 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "πªíode", 2, 
utf8
, 0, 
πªíode
, 0, 0);

3195 if–
rc
==
SQLITE4_OK
 ){

3196 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "πªedïth", 1, 
utf8
, 0,
πªedïth
, 0, 0);

3198 if–
rc
==
SQLITE4_OK
 ){

3199 *
c
 = (*)
RTREE_COORD_REAL32
;

3200 
rc
 = 
	`sqlôe4_¸óã_moduÀ_v2
(
db
, "πªe", &
πªeModuÀ
, 
c
, 0);

3202 if–
rc
==
SQLITE4_OK
 ){

3203 *
c
 = (*)
RTREE_COORD_INT32
;

3204 
rc
 = 
	`sqlôe4_¸óã_moduÀ_v2
(
db
, "πªe_i32", &
πªeModuÀ
, 
c
, 0);

3207  
rc
;

3208 
	}
}

3216 
	$doSqlôe3Fªe
(*
p
){

3217 
	`sqlôe4_‰ì
(
p
);

3218 
	}
}

3228 
	$geomCÆlback
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
aArg
){

3229 
RåìGeomCÆlback
 *
pGeomCtx
 = (RåìGeomCÆlback *)
	`sqlôe4_u£r_d©a
(
˘x
);

3230 
RåìM©chArg
 *
pBlob
;

3231 
nBlob
;

3233 
nBlob
 = (
RåìM©chArg
Ë+ (
nArg
-1)*();

3234 
pBlob
 = (
RåìM©chArg
 *)
	`sqlôe4_mÆloc
(
nBlob
);

3235 if–!
pBlob
 ){

3236 
	`sqlôe4_ªsu…_îr‹_nomem
(
˘x
);

3238 
i
;

3239 
pBlob
->
magic
 = 
RTREE_GEOMETRY_MAGIC
;

3240 
pBlob
->
xGeom
 = 
pGeomCtx
->xGeom;

3241 
pBlob
->
pC⁄ãxt
 = 
pGeomCtx
->pContext;

3242 
pBlob
->
nP¨am
 = 
nArg
;

3243 
i
=0; i<
nArg
; i++){

3244 
pBlob
->
aP¨am
[
i
] = 
	`sqlôe4_vÆue_doubÀ
(
aArg
[i]);

3246 
	`sqlôe4_ªsu…_blob
(
˘x
, 
pBlob
, 
nBlob
, 
doSqlôe3Fªe
);

3248 
	}
}

3253 
sqlôe4_πªe_geomëry_ˇŒback
(

3254 
sqlôe4
 *
db
,

3255 c⁄° *
zGeom
,

3256 (*
xGeom
)(
sqlôe4_πªe_geomëry
 *, , *, *),

3257 *
pC⁄ãxt


3259 
RåìGeomCÆlback
 *
pGeomCtx
;

3262 
pGeomCtx
 = (
RåìGeomCÆlback
 *)
	`sqlôe4_mÆloc
((RtreeGeomCallback));

3263 if–!
pGeomCtx
 )  
SQLITE4_NOMEM
;

3264 
pGeomCtx
->
xGeom
 = xGeom;

3265 
pGeomCtx
->
pC⁄ãxt
 =ÖContext;

3269  
	`sqlôe4_¸óã_fun˘i⁄_v2
(
db
, 
zGeom
, -1, 
SQLITE4_ANY
,

3270 (*)
pGeomCtx
, 
geomCÆlback
, 0, 0, 
doSqlôe3Fªe


3272 
	}
}

3274 #i‡!
SQLITE4_CORE


3275 
	$sqlôe4_exãnsi⁄_öô
(

3276 
sqlôe4
 *
db
,

3277 **
pzEºMsg
,

3278 c⁄° 
sqlôe4_≠i_routöes
 *
pApi


3280 
	`SQLITE4_EXTENSION_INIT2
(
pApi
)

3281  
	`sqlôe4RåìInô
(
db
);

3282 
	}
}

	@ext/rtree/rtree.h

16 
	~"sqlôe4.h
"

18 #ifde‡
__˝lu•lus


22 
sqlôe4RåìInô
(
sqlôe4
 *
db
);

24 #ifde‡
__˝lu•lus


	@ext/rtree/sqlite4rtree.h

14 #i‚de‡
_SQLITE3RTREE_H_


15 
	#_SQLITE3RTREE_H_


	)

17 
	~<sqlôe4.h
>

19 #ifde‡
__˝lu•lus


23 
sqlôe4_πªe_geomëry
 
	tsqlôe4_πªe_geomëry
;

31 
sqlôe4_πªe_geomëry_ˇŒback
(

32 
sqlôe4
 *
db
,

33 c⁄° *
zGeom
,

34 (*
xGeom
)(
sqlôe4_πªe_geomëry
 *, 
nCo‹d
, *
aCo‹d
, *
pRes
),

35 *
pC⁄ãxt


43 
	ssqlôe4_πªe_geomëry
 {

44 *
pC⁄ãxt
;

45 
nP¨am
;

46 *
aP¨am
;

47 *
pU£r
;

48 (*
xDñU£r
)(*);

52 #ifde‡
__˝lu•lus


	@lsm-test/lsmtest.h

2 #i‚de‡
__WRAPPER_INT_H_


3 
	#__WRAPPER_INT_H_


	)

5 
	~"lsmã°_tdb.h
"

6 
	~"sqlôe3.h
"

7 
	~"lsm.h
"

9 
	~<as£π.h
>

10 
	~<°dlib.h
>

11 
	~<°rög.h
>

12 
	~<°dio.h
>

14 #ifde‡
__˝lu•lus


18 #i‚de‡
_LSM_INT_H


19 
	tu32
;

20 
	tu8
;

21 
	ti64
;

22 
	tu64
;

26 
	#AºaySize
(
x
Ë(()((xË/ ((x)[0])))

	)

28 
	#MIN
(
x
,
y
Ë((x)<(yË? (xË: (y))

	)

29 
	#MAX
(
x
,
y
Ë((x)>(yË? (xË: (y))

	)

31 
	#unu£d_∑ømëî
(
x
Ë()(x)

	)

33 
	#TESTDB_DEFAULT_PAGE_SIZE
 4096

	)

34 
	#TESTDB_DEFAULT_CACHE_SIZE
 2048

	)

40 
D©aba£Mëhods
 
	tD©aba£Mëhods
;

41 
	sTe°Db
 {

42 
D©aba£Mëhods
 c⁄° *
	gpMëhods
;

43 c⁄° *
	gzLibøry
;

45 
	sD©aba£Mëhods
 {

46 (*
	gxClo£
)(
	gTe°Db
 *);

47 (*
	gxWrôe
)(
	gTe°Db
 *, *, , *, );

48 (*
	gxDñëe
)(
	gTe°Db
 *, *, );

49 (*
	gxDñëeR™ge
)(
	gTe°Db
 *, *, , *, );

50 (*
	gxFëch
)(
	gTe°Db
 *, *, , **, *);

51 (*
	gxSˇn
)(
	gTe°Db
 *, *, , *, , *, ,

54 (*
	gxBegö
)(
	gTe°Db
 *, );

55 (*
	gxCommô
)(
	gTe°Db
 *, );

56 (*
	gxRﬁlback
)(
	gTe°Db
 *, );

64 
ã°_kc_›í
(c⁄° *, c⁄° *
zFûíame
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

65 
ã°_kc_˛o£
(
Te°Db
 *);

66 
ã°_kc_wrôe
(
Te°Db
 *, *, , *, );

67 
ã°_kc_dñëe
(
Te°Db
 *, *, );

68 
ã°_kc_dñëe_ønge
(
Te°Db
 *, *, , *, );

69 
ã°_kc_„tch
(
Te°Db
 *, *, , **, *);

70 
ã°_kc_sˇn
(
Te°Db
 *, *, , *, , *, ,

74 
ã°_mdb_›í
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

75 
ã°_mdb_˛o£
(
Te°Db
 *);

76 
ã°_mdb_wrôe
(
Te°Db
 *, *, , *, );

77 
ã°_mdb_dñëe
(
Te°Db
 *, *, );

78 
ã°_mdb_„tch
(
Te°Db
 *, *, , **, *);

79 
ã°_mdb_sˇn
(
Te°Db
 *, *, , *, , *, ,

89 
ã°_lsm_›í
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

90 
ã°_lsm_lomem_›í
(c⁄° *, c⁄° *, 
bCÀ¨
, 
Te°Db
 **
µDb
);

91 
ã°_lsm_zù_›í
(c⁄° *, c⁄° *, 
bCÀ¨
, 
Te°Db
 **
µDb
);

92 
ã°_lsm_smÆl_›í
(c⁄° *, c⁄° *, 
bCÀ¨
, 
Te°Db
 **
µDb
);

93 
ã°_lsm_mt2
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

94 
ã°_lsm_mt3
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

96 
tdb_lsm_c⁄figuª
(
lsm_db
 *, const *);

99 
ã°_bt_›í
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

100 
ã°_fbt_›í
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

101 
ã°_fbts_›í
(c⁄° *, c⁄° *
zFûe
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

105 
ã°P∫gInô
();

106 
u32
 
ã°P∫gVÆue
(u32 
iVÆ
);

107 
ã°P∫gAºay
(
u32
 
iVÆ
, u32 *
aOut
, 
nOut
);

108 
ã°P∫gSåög
(
u32
 
iVÆ
, *
aOut
, 
nOut
);

110 
ã°Eº‹Inô
(
¨gc
, **);

111 
ã°PrötEº‹
(c⁄° *
zF‹m©
, ...);

112 
ã°PrötUßge
(c⁄° *
zArgs
);

113 
ã°PrötFUßge
(c⁄° *
zF‹m©
, ...);

114 
ã°TimeInô
();

115 
ã°TimeGë
();

118 
ã°MÆlocIn°Æl
(
lsm_ív
 *
pEnv
);

119 
ã°MÆlocUnö°Æl
(
lsm_ív
 *
pEnv
);

120 
ã°MÆlocCheck
(
lsm_ív
 *
pEnv
, *, *, 
FILE
 *);

121 
ã°MÆlocOom
(
lsm_ív
 *
pEnv
, , , (*)(*), *);

122 
ã°MÆlocOomE«bÀ
(
lsm_ív
 *
pEnv
, );

125 
Te°Db
 *
ã°O≥n
(c⁄° *
zSy°em
, , *
pRc
);

126 
ã°Re›í
(
Te°Db
 **
µDb
, *
pRc
);

127 
ã°Clo£
(
Te°Db
 **
µDb
);

129 
ã°Fëch
(
Te°Db
 *, *, , *, , *);

130 
ã°Wrôe
(
Te°Db
 *, *, , *, , *);

131 
ã°Dñëe
(
Te°Db
 *, *, , *);

132 
ã°DñëeR™ge
(
Te°Db
 *, *, , *, , *);

133 
ã°WrôeSå
(
Te°Db
 *, c⁄° *, c⁄° *
zVÆ
, *
pRc
);

134 
ã°FëchSå
(
Te°Db
 *, c⁄° *, c⁄° *, *
pRc
);

136 
ã°Begö
(
Te°Db
 *
pDb
, 
iTøns
, *
pRc
);

137 
ã°Commô
(
Te°Db
 *
pDb
, 
iTøns
, *
pRc
);

139 
ã°_Áûed
();

141 *
ã°MÆlocPrötf
(c⁄° *
zF‹m©
, ...);

142 *
ã°MÆlocVPrötf
(c⁄° *
zF‹m©
, 
va_li°
 
≠
);

143 
ã°GlobM©ch
(c⁄° *
zP©ã∫
, c⁄° *
zSå
);

145 
ã°SˇnCom∑ª
(
Te°Db
 *, TestDb *, , *, , *, , *);

146 
ã°FëchCom∑ª
(
Te°Db
 *, TestDb *, *, , *);

148 *
ã°MÆloc
();

149 *
ã°MÆlocC›y
(*
pC›y
, 
nByã
);

150 *
ã°RóŒoc
(*, );

151 
ã°Fªe
(*);

154 
do_bt
(
nArg
, **
azArg
);

157 
ã°VfsC⁄figuªDb
(
Te°Db
 *
pDb
);

160 
do_show
(
nArg
, **
azArg
);

161 
do_w‹k
(
nArg
, **
azArg
);

164 
do_io
(
nArg
, **
azArg
);

167 
do_¸ash_ã°
(c⁄° *
zP©ã∫
, *
pRc
);

168 
do_rﬁlback_ã°
(
nArg
, **
azArg
);

171 
ã°_rﬁlback
(c⁄° *
zSy°em
, c⁄° *
zP©ã∫
, *
pRc
);

174 
ã°_mc
(c⁄° *
zSy°em
, c⁄° *
zP©ã∫
, *
pRc
);

177 
ã°_mt
(c⁄° *
zSy°em
, c⁄° *
zP©ã∫
, *
pRc
);

180 
ã°_oom
(c⁄° *
zP©ã∫
, *
pRc
);

181 
ã°DñëeLsmdb
(c⁄° *
zFûe
);

183 
ã°SaveDb
(c⁄° *
zFûe
, c⁄° *
zAuxExt
);

184 
ã°Re°‹eDb
(c⁄° *
zFûe
, c⁄° *
zAuxExt
);

185 
ã°C›yLsmdb
(c⁄° *
zFrom
, c⁄° *
zTo
);

188 
ã°_≠i
(c⁄° *
zP©ã∫
, *
pRc
);

191 
do_wrôî_¸ash_ã°
(c⁄° *
zP©ã∫
, *
pRc
);

196 
D©asour˚
 
	tD©asour˚
;

197 
D©asour˚De‚
 
	tD©asour˚De‚
;

199 
	sD©asour˚De‚
 {

200 
	geTy≥
;

201 
	gnMöKey
;

202 
	gnMaxKey
;

203 
	gnMöVÆ
;

204 
	gnMaxVÆ
;

207 
	#TEST_DATASOURCE_RANDOM
 1

	)

208 
	#TEST_DATASOURCE_SEQUENCE
 2

	)

210 *
ã°D©asour˚Name
(c⁄° 
D©asour˚De‚
 *);

211 
D©asour˚
 *
ã°D©asour˚New
(c⁄° 
D©asour˚De‚
 *);

212 
ã°D©asour˚Fªe
(
D©asour˚
 *);

213 
ã°D©asour˚E¡ry
(
D©asour˚
 *, , **, *, **, *);

217 
ã°WrôeD©asour˚
(
Te°Db
 *, 
D©asour˚
 *, , *);

218 
ã°WrôeD©asour˚R™ge
(
Te°Db
 *, 
D©asour˚
 *, , , *);

219 
ã°DñëeD©asour˚
(
Te°Db
 *, 
D©asour˚
 *, , *);

220 
ã°DñëeD©asour˚R™ge
(
Te°Db
 *, 
D©asour˚
 *, , , *);

224 
ã°_d©a_1
(c⁄° *, c⁄° *, *
pRc
);

225 
ã°_d©a_2
(c⁄° *, c⁄° *, *
pRc
);

226 
ã°_d©a_3
(c⁄° *, c⁄° *, *
pRc
);

227 
ã°DbC⁄ã¡s
(
Te°Db
 *, 
D©asour˚
 *, , , , , , *);

228 
ã°Ca£Progªss
(, , , *);

229 
ã°Ca£NDŸ
();

231 
ã°Com∑ªDb
(
D©asour˚
 *, , , 
Te°Db
 *, TestDb *, *);

232 
ã°C⁄åﬁDb
(
Te°Db
 **
µDb
);

234 
CksumDb
 
	tCksumDb
;

235 
CksumDb
 *
ã°CksumAºayNew
(
D©asour˚
 *, , , );

236 *
ã°CksumAºayGë
(
CksumDb
 *, );

237 
ã°CksumAºayFªe
(
CksumDb
 *);

238 
ã°Ca£Sèπ
(*
pRc
, *
zFmt
, ...);

239 
ã°Ca£Föish
(
rc
);

240 
ã°Ca£Skù
();

241 
ã°Ca£Begö
(*, const *, const *, ...);

243 
	#TEST_CKSUM_BYTES
 29

	)

244 
ã°CksumD©aba£
(
Te°Db
 *
pDb
, *
zOut
);

245 
ã°Cou¡D©aba£
(
Te°Db
 *
pDb
);

246 
ã°Com∑ªI¡
(, , *);

247 
ã°Com∑ªSå
(c⁄° *
z1
, c⁄° *
z2
, *
pRc
);

250 
ã°_d©a_4
(c⁄° *, c⁄° *, *
pRc
);

256 
	#ã°ArgSñe˘
(
w
,
x
,
y
,
z
Ë
	`ã°ArgSñe˘X
(w,x,(w[0]),y,z)

	)

257 
ã°ArgSñe˘X
(*, const *, , const *, *);

259 #ifde‡
__˝lu•lus


	@lsm-test/lsmtest1.c

2 
	~"lsmã°.h
"

4 
	#DATA_SEQUENTIAL
 
TEST_DATASOURCE_SEQUENCE


	)

5 
	#DATA_RANDOM
 
TEST_DATASOURCE_RANDOM


	)

7 
D©©e°1
 
	tD©©e°1
;

8 
D©©e°2
 
	tD©©e°2
;

32 
	sD©©e°1
 {

34 
D©asour˚De‚
 
	mde‚
;

37 
	mnRow
;

38 
	mnVîify
;

39 
	mnTe°
;

40 
	mbTe°Sˇn
;

73 
	sD©©e°2
 {

74 
D©asour˚De‚
 
	mde‚
;

75 
	mnR™ge
;

76 
	mnWrôe
;

77 
	mnIãr
;

84 *
	$gëName
(c⁄° *
zSy°em
, 
D©©e°1
 *
pTe°
){

85 *
zRë
;

86 *
zD©a
;

87 
zD©a
 = 
	`ã°D©asour˚Name
(&
pTe°
->
de‚
);

88 
zRë
 = 
	`ã°MÆlocPrötf
("data.%s.%s.%d.%d",

89 
zSy°em
, 
zD©a
, 
pTe°
->
nRow
,ÖTe°->
nVîify


91 
	`ã°Fªe
(
zD©a
);

92  
zRë
;

93 
	}
}

95 
	$ã°C⁄åﬁDb
(
Te°Db
 **
µDb
){

96 #ifde‡
HAVE_KYOTOCABINET


97  
	`tdb_›í
("kyŸoˇböë", "tmp.db", 1, 
µDb
);

99  
	`tdb_›í
("sqlôe3", ":mem‹y:", 1, 
µDb
);

101 
	}
}

103 
	$ã°D©asour˚Fëch
(

104 
Te°Db
 *
pDb
,

105 
D©asour˚
 *
pD©a
,

106 
iKey
,

107 *
pRc


109 *
pKey
; 
nKey
;

110 *
pVÆ
; 
nVÆ
;

112 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

113 
	`ã°Fëch
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, 
pRc
);

114 
	}
}

153 
	$ã°DbC⁄ã¡s
(

154 
Te°Db
 *
pDb
,

155 
D©asour˚
 *
pD©a
,

156 
nRow
,

157 
iFú°
,

158 
iLa°
,

159 
nLookupTe°
,

160 
nSˇnTe°
,

161 *
pRc


163 
j
;

164 
rc
 = *
pRc
;

166 if–
rc
==0 && 
nSˇnTe°
 ){

167 
Te°Db
 *
pDb2
 = 0;

170 
rc
 = 
	`ã°C⁄åﬁDb
(&
pDb2
);

172 
j
=
iFú°
; 
rc
==0 && j<=
iLa°
; j++){

173 *
pKey
; 
nKey
;

174 *
pVÆ
; 
nVÆ
;

175 
	`ã°D©asour˚E¡ry
(
pD©a
, 
j
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

176 
rc
 = 
	`tdb_wrôe
(
pDb2
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

179 if–
rc
==0 ){

180 
iKey1
;

181 
iKey2
;

182 *
pKey1
; 
nKey1
;

183 *
pKey2
; 
nKey2
;

185 
iKey1
 = 
	`ã°P∫gVÆue
((
iFú°
<<8Ë+ (
iLa°
<<16)Ë% 
nRow
;

186 
iKey2
 = 
	`ã°P∫gVÆue
((
iLa°
<<8Ë+ (
iFú°
<<16)Ë% 
nRow
;

187 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey1
, &
pKey2
, &
nKey1
, 0, 0);

188 
pKey1
 = 
	`ã°MÆloc
(
nKey1
+1);

189 
	`mem˝y
(
pKey1
, 
pKey2
, 
nKey1
+1);

190 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey2
, &
pKey2
, &
nKey2
, 0, 0);

192 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 0, 0, 0, 0, 0, &
rc
);

193 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 0, 0, 0, 
pKey2
, 
nKey2
, &
rc
);

194 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 0, 
pKey1
, 
nKey1
, 0, 0, &
rc
);

195 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 0, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, &
rc
);

196 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 1, 0, 0, 0, 0, &
rc
);

197 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 1, 0, 0, 
pKey2
, 
nKey2
, &
rc
);

198 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 1, 
pKey1
, 
nKey1
, 0, 0, &
rc
);

199 
	`ã°SˇnCom∑ª
(
pDb2
, 
pDb
, 1, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, &
rc
);

200 
	`ã°Fªe
(
pKey1
);

202 
	`tdb_˛o£
(
pDb2
);

206 
j
=0; 
rc
==0 && j<
nLookupTe°
; j++){

207 
iKey
;

208 *
pKey
; 
nKey
;

209 *
pVÆ
; 
nVÆ
;

211 if–
nLookupTe°
>=
nRow
 ){

212 
iKey
 = 
j
;

214 
iKey
 = 
	`ã°P∫gVÆue
(
j
 + (
iFú°
<<8Ë+ (
iLa°
<<16)Ë% 
nRow
;

217 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

218 if–
iFú°
>
iKey
 || iKey>
iLa°
 ){

219 
pVÆ
 = 0;

220 
nVÆ
 = -1;

223 
	`ã°Fëch
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, &
rc
);

226 *
pRc
 = 
rc
;

227 
	}
}

233 
	$ã°Ca£Progªss
(
i
, 
n
, 
nDŸ
, *
piDŸ
){

234 
iDŸ
 = *
piDŸ
;

235  
iDŸ
 < ( ((
nDŸ
*2+1Ë* 
i
Ë/ (
n
*2) ) ){

236 
	`¥ötf
(".");

237 
	`fÊush
(
°dout
);

238 
iDŸ
++;

240 *
piDŸ
 = 
iDŸ
;

241 
	}
}

243 
	$ã°Ca£NDŸ
(){  20; 
	}
}

252 
	$ã°Ca£DbLóks
(
Te°Db
 *
db
, *
pRc
){

253 if–*
pRc
==
SQLITE4_OK
 ){

254 
bt_db
 *
pBt
 = 
	`tdb_bt
(
db
);

255 if–
pBt
 ){

256 
rc
;

257 
bt_öfo
 
i
;

258 
i
.
eTy≥
 = 
BT_INFO_PAGE_LEAKS
;

259 
i
.
pgno
 = 0;

260 
	`sqlôe4_buf„r_öô
(&
i
.
ouçut
, 0);

262 
rc
 = 
	`sqlôe4BtC⁄åﬁ
(
pBt
, 
BT_CONTROL_INFO
, (*)&
i
);

263 if–
rc
==
SQLITE4_OK
 && (*(*)
i
.
ouçut
.
p
)!='\0' ){

264 
rc
 = 1;

265 
	`ã°PrötEº‹
("PagêÀaks: %s\n", (*)
i
.
ouçut
.
p
);

267 
	`sqlôe4_buf„r_˛ór
(&
i
.
ouçut
);

268 *
pRc
 = 
rc
;

269 if–
rc
 ) 
	`ã°_Áûed
();

272 
	}
}

275 
	$¥ötSˇnCb
(

276 *
pCtx
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ


278 
	`¥ötf
("%s\n", (*)
pKey
);

279 
	`fÊush
(
°dout
);

280 
	}
}

283 
	$doD©aTe°1
(

284 c⁄° *
zSy°em
,

285 
D©©e°1
 *
p
,

286 *
pRc


288 
i
;

289 
iDŸ
;

290 
rc
 = 
LSM_OK
;

291 
D©asour˚
 *
pD©a
;

292 
Te°Db
 *
pDb
;

295 
pDb
 = 
	`ã°O≥n
(
zSy°em
, 1, &
rc
);

296 
pD©a
 = 
	`ã°D©asour˚New
(&
p
->
de‚
);

298 
i
 = 0;

299 
iDŸ
 = 0;

300  
rc
==
LSM_OK
 && 
i
<
p
->
nRow
 ){

303 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
i
, 
p
->
nVîify
, &
rc
);

304 
i
 +
p
->
nVîify
;

307 
	`ã°DbC⁄ã¡s
(
pDb
, 
pD©a
, 
p
->
nRow
, 0, 
i
-1,Ö->
nTe°
,Ö->
bTe°Sˇn
, &
rc
);

310 
	`ã°Re›í
(&
pDb
, &
rc
);

313 
	`ã°DbC⁄ã¡s
(
pDb
, 
pD©a
, 
p
->
nRow
, 0, 
i
-1,Ö->
nTe°
,Ö->
bTe°Sˇn
, &
rc
);

316 
	`ã°Ca£Progªss
(
i
, 
p
->
nRow
, 
	`ã°Ca£NDŸ
()/2, &
iDŸ
);

319 
i
 = 0;

320 
iDŸ
 = 0;

321  
rc
==
LSM_OK
 && 
i
<
p
->
nRow
 ){

324 
	`ã°DñëeD©asour˚R™ge
(
pDb
, 
pD©a
, 
i
, 
p
->
nVîify
, &
rc
);

325 
i
 +
p
->
nVîify
;

328 
	`ã°DbC⁄ã¡s
(
pDb
, 
pD©a
, 
p
->
nRow
, 
i
,Ö->nRow-1,p->
nTe°
,p->
bTe°Sˇn
,&
rc
);

331 
	`ã°Re›í
(&
pDb
, &
rc
);

334 
	`ã°DbC⁄ã¡s
(
pDb
, 
pD©a
, 
p
->
nRow
, 
i
,Ö->nRow-1,p->
nTe°
,p->
bTe°Sˇn
,&
rc
);

337 
	`ã°Ca£Progªss
(
i
, 
p
->
nRow
, 
	`ã°Ca£NDŸ
()/2, &
iDŸ
);

341 
	`ã°Ca£DbLóks
(
pDb
, &
rc
);

344 
	`ã°D©asour˚Fªe
(
pD©a
);

345 
	`tdb_˛o£
(
pDb
);

346 
	`ã°Ca£Föish
(
rc
);

347 *
pRc
 = 
rc
;

348 
	}
}

351 
	$ã°_d©a_1
(

352 c⁄° *
zSy°em
,

353 c⁄° *
zP©ã∫
,

354 *
pRc


356 
D©©e°1
 
aTe°
[] = {

357 { {
DATA_RANDOM
, 500,600, 1000,2000}, 1000, 100, 10, 0},

358 { {
DATA_RANDOM
, 20,25, 100,200}, 1000, 250, 1000, 1},

359 { {
DATA_RANDOM
, 8,10, 100,200}, 1000, 250, 1000, 1},

360 { {
DATA_RANDOM
, 8,10, 10,20}, 1000, 250, 1000, 1},

361 { {
DATA_RANDOM
, 8,10, 1000,2000}, 1000, 250, 1000, 1},

362 { {
DATA_RANDOM
, 8,100, 10000,20000}, 100, 25, 100, 1},

363 { {
DATA_RANDOM
, 80,100, 10,20}, 1000, 250, 1000, 1},

364 { {
DATA_RANDOM
, 5000,6000, 10,20}, 100, 25, 100, 1},

365 { {
DATA_SEQUENTIAL
, 5,10, 10,20}, 1000, 250, 1000, 1},

366 { {
DATA_SEQUENTIAL
, 5,10, 100,200}, 1000, 250, 1000, 1},

367 { {
DATA_SEQUENTIAL
, 5,10, 1000,2000}, 1000, 250, 1000, 1},

368 { {
DATA_SEQUENTIAL
, 5,100, 10000,20000}, 100, 25, 100, 1},

369 { {
DATA_RANDOM
, 10,10, 100,100}, 100000, 1000, 100, 0},

370 { {
DATA_SEQUENTIAL
, 10,10, 100,100}, 100000, 1000, 100, 0},

373 
i
;

375 
i
=0; *
pRc
==
LSM_OK
 && i<
	`AºaySize
(
aTe°
); i++){

376 *
zName
 = 
	`gëName
(
zSy°em
, &
aTe°
[
i
]);

377 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "%s", 
zName
) ){

378 
	`doD©aTe°1
(
zSy°em
, &
aTe°
[
i
], 
pRc
);

380 
	`ã°Fªe
(
zName
);

382 
	}
}

384 
	$ã°Com∑ªDb
(

385 
D©asour˚
 *
pD©a
,

386 
nD©a
,

387 
iSìd
,

388 
Te°Db
 *
pC⁄åﬁ
,

389 
Te°Db
 *
pDb
,

390 *
pRc


392 
i
;

394 
nCÆl
 = 0;

395 
nCÆl
++;

397 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 0, 0, 0, 0, 0, 
pRc
);

398 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 1, 0, 0, 0, 0, 
pRc
);

400 if–*
pRc
==0 ){

401 
iKey1
;

402 
iKey2
;

403 *
pKey1
; 
nKey1
;

404 *
pKey2
; 
nKey2
;

406 
iKey1
 = 
	`ã°P∫gVÆue
(
iSìd
Ë% 
nD©a
;

407 
iKey2
 = 
	`ã°P∫gVÆue
(
iSìd
+1Ë% 
nD©a
;

408 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey1
, &
pKey2
, &
nKey1
, 0, 0);

409 
pKey1
 = 
	`ã°MÆloc
(
nKey1
+1);

410 
	`mem˝y
(
pKey1
, 
pKey2
, 
nKey1
+1);

411 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey2
, &
pKey2
, &
nKey2
, 0, 0);

413 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 0, 0, 0, 
pKey2
, 
nKey2
, 
pRc
);

414 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 0, 
pKey1
, 
nKey1
, 0, 0, 
pRc
);

415 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 0, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, 
pRc
);

416 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 1, 0, 0, 
pKey2
, 
nKey2
, 
pRc
);

417 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 1, 
pKey1
, 
nKey1
, 0, 0, 
pRc
);

418 
	`ã°SˇnCom∑ª
(
pC⁄åﬁ
, 
pDb
, 1, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, 
pRc
);

419 
	`ã°Fªe
(
pKey1
);

422 
i
=0; i<
nD©a
 && *
pRc
==0; i++){

423 *
pKey
; 
nKey
;

424 
	`ã°D©asour˚E¡ry
(
pD©a
, 
i
, &
pKey
, &
nKey
, 0, 0);

425 
	`ã°FëchCom∑ª
(
pC⁄åﬁ
, 
pDb
, 
pKey
, 
nKey
, 
pRc
);

427 
	}
}

429 
	$doD©aTe°2
(

430 c⁄° *
zSy°em
,

431 
D©©e°2
 *
p
,

432 *
pRc


434 
Te°Db
 *
pDb
;

435 
Te°Db
 *
pC⁄åﬁ
;

436 
D©asour˚
 *
pD©a
;

437 
i
;

438 
rc
 = 
LSM_OK
;

439 
iDŸ
 = 0;

442 
pDb
 = 
	`ã°O≥n
(
zSy°em
, 1, &
rc
);

443 
pD©a
 = 
	`ã°D©asour˚New
(&
p
->
de‚
);

444 
rc
 = 
	`ã°C⁄åﬁDb
(&
pC⁄åﬁ
);

446 if–
	`tdb_lsm
(
pDb
) ){

447 
nBuf
 = 32 * 1024 * 1024;

448 
	`lsm_c⁄fig
(
	`tdb_lsm
(
pDb
), 
LSM_CONFIG_AUTOFLUSH
, &
nBuf
);

451 
i
=0; 
rc
==0 && i<
p
->
nIãr
; i++){

452 *
pKey1
; 
nKey1
;

453 *
pKey2
; 
nKey2
;

454 
ii
;

455 
nR™ge
 = 
	`MIN
(
p
->
nIãr
*p->
nWrôe
,Ö->nRange);

457 
ii
=0; 
rc
==0 && ii<
p
->
nWrôe
; ii++){

458 
iKey
 = (
i
*
p
->
nWrôe
 + 
ii
Ë%Ö->
nR™ge
;

459 
	`ã°WrôeD©asour˚
(
pC⁄åﬁ
, 
pD©a
, 
iKey
, &
rc
);

460 
	`ã°WrôeD©asour˚
(
pDb
, 
pD©a
, 
iKey
, &
rc
);

463 
	`ã°D©asour˚E¡ry
(
pD©a
, 
i
+1000000, &
pKey1
, &
nKey1
, 0, 0);

464 
pKey1
 = 
	`ã°MÆlocC›y
’Key1, 
nKey1
);

465 
	`ã°D©asour˚E¡ry
(
pD©a
, 
i
+2000000, &
pKey2
, &
nKey2
, 0, 0);

467 
	`ã°DñëeR™ge
(
pDb
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, &
rc
);

468 
	`ã°DñëeR™ge
(
pC⁄åﬁ
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, &
rc
);

469 
	`ã°Fªe
(
pKey1
);

471 
	`ã°Com∑ªDb
(
pD©a
, 
nR™ge
, 
i
, 
pC⁄åﬁ
, 
pDb
, &
rc
);

472 
	`ã°Re›í
(&
pDb
, &
rc
);

473 
	`ã°Com∑ªDb
(
pD©a
, 
nR™ge
, 
i
, 
pC⁄åﬁ
, 
pDb
, &
rc
);

476 
	`ã°Ca£Progªss
(
i
, 
p
->
nIãr
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

479 
	`ã°Clo£
(&
pDb
);

480 
	`ã°Clo£
(&
pC⁄åﬁ
);

481 
	`ã°D©asour˚Fªe
(
pD©a
);

482 
	`ã°Ca£Föish
(
rc
);

483 *
pRc
 = 
rc
;

484 
	}
}

486 *
	$gëName2
(c⁄° *
zSy°em
, 
D©©e°2
 *
pTe°
){

487 *
zRë
;

488 *
zD©a
;

489 
zD©a
 = 
	`ã°D©asour˚Name
(&
pTe°
->
de‚
);

490 
zRë
 = 
	`ã°MÆlocPrötf
("data2.%s.%s.%d.%d.%d",

491 
zSy°em
, 
zD©a
, 
pTe°
->
nR™ge
,ÖTe°->
nWrôe
,ÖTe°->
nIãr


493 
	`ã°Fªe
(
zD©a
);

494  
zRë
;

495 
	}
}

497 
	$ã°_d©a_2
(

498 c⁄° *
zSy°em
,

499 c⁄° *
zP©ã∫
,

500 *
pRc


502 
D©©e°2
 
aTe°
[] = {

504 { {
DATA_RANDOM
, 20,25, 100,200}, 10000, 10, 50 },

505 { {
DATA_RANDOM
, 20,25, 100,200}, 10000, 200, 50 },

506 { {
DATA_RANDOM
, 20,25, 100,200}, 100, 10, 1000 },

507 { {
DATA_RANDOM
, 20,25, 100,200}, 100, 200, 50 },

510 
i
;

512 
i
=0; *
pRc
==
LSM_OK
 && i<
	`AºaySize
(
aTe°
); i++){

513 *
zName
 = 
	`gëName2
(
zSy°em
, &
aTe°
[
i
]);

514 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "%s", 
zName
) ){

515 
	`doD©aTe°2
(
zSy°em
, &
aTe°
[
i
], 
pRc
);

517 
	`ã°Fªe
(
zName
);

519 
	}
}

525 
D©©e°3
 
	tD©©e°3
;

526 
	sD©©e°3
 {

527 
	mnR™ge
;

528 
	mnIãr
;

529 
	mnWrôe
;

530 
	mnDñëe
;

532 
	mnVÆMö
;

533 
	mnVÆMax
;

536 
	$ã°PutU32
(
u8
 *
aBuf
, 
u32
 
iVÆ
){

537 
aBuf
[0] = (
iVÆ
 >> 24) & 0xFF;

538 
aBuf
[1] = (
iVÆ
 >> 16) & 0xFF;

539 
aBuf
[2] = (
iVÆ
 >> 8) & 0xFF;

540 
aBuf
[3] = (
iVÆ
 >> 0) & 0xFF;

541 
	}
}

543 
	$dt3PutKey
(
u8
 *
aBuf
, 
iKey
){

544 
	`as£π
–
iKey
<100000 && iKey>=0 );

545 
	`•rötf
((*)
aBuf
, "%.5d", 
iKey
);

546 
	}
}

548 
	$doD©aTe°3
(

549 c⁄° *
zSy°em
,

550 
D©©e°3
 *
p
,

551 *
pRc


553 
iDŸ
 = 0;

554 
rc
 = *
pRc
;

555 
Te°Db
 *
pDb
;

556 
u8
 *
abPª£¡
;

557 *
aVÆ
;

558 
i
;

559 
u32
 
iSeq
 = 10;

561 
abPª£¡
 = (
u8
 *)
	`ã°MÆloc
(
p
->
nR™ge
+1);

562 
aVÆ
 = (*)
	`ã°MÆloc
(
p
->
nVÆMax
+1);

563 
pDb
 = 
	`ã°O≥n
(
zSy°em
, 1, &
rc
);

565 
i
=0; i<
p
->
nIãr
 && 
rc
==0; i++){

566 
ii
;

568 
	`ã°Ca£Progªss
(
i
, 
p
->
nIãr
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

571 
ii
=0; ii<
p
->
nWrôe
; ii++){

572 
u8
 
aKey
[6];

573 
u32
 
iKey
;

574 
nVÆ
;

576 
iKey
 = (
	`ã°P∫gVÆue
(
iSeq
++Ë% 
p
->
nR™ge
) + 1;

577 
nVÆ
 = (
	`ã°P∫gVÆue
(
iSeq
++Ë% (
p
->
nVÆMax
 -Ö->
nVÆMö
)) +Ö->nValMin;

578 
	`ã°P∫gSåög
(
	`ã°P∫gVÆue
(
iSeq
++), 
aVÆ
, 
nVÆ
);

579 
	`dt3PutKey
(
aKey
, 
iKey
);

581 
	`ã°Wrôe
(
pDb
, 
aKey
, ◊Key)-1, 
aVÆ
, 
nVÆ
, &
rc
);

582 
abPª£¡
[
iKey
] = 1;

586 
ii
=0; ii<
p
->
nDñëe
; ii++){

587 
u8
 
aKey1
[6];

588 
u8
 
aKey2
[6];

589 
u32
 
iKey
;

591 
iKey
 = (
	`ã°P∫gVÆue
(
iSeq
++Ë% 
p
->
nR™ge
) + 1;

592 
	`dt3PutKey
(
aKey1
, 
iKey
-1);

593 
	`dt3PutKey
(
aKey2
, 
iKey
+1);

595 
	`ã°DñëeR™ge
(
pDb
, 
aKey1
, ◊Key1)-1, 
aKey2
, ◊Key2)-1, &
rc
);

596 
abPª£¡
[
iKey
] = 0;

599 
	`ã°Re›í
(&
pDb
, &
rc
);

601 
ii
=1; 
rc
==0 && ii<=
p
->
nR™ge
; ii++){

602 
nDbVÆ
;

603 *
pDbVÆ
;

604 
u8
 
aKey
[6];

605 
dbrc
;

607 
	`dt3PutKey
(
aKey
, 
ii
);

608 
dbrc
 = 
	`tdb_„tch
(
pDb
, 
aKey
, ◊Key)-1, &
pDbVÆ
, &
nDbVÆ
);

609 
	`ã°Com∑ªI¡
(0, 
dbrc
, &
rc
);

611 if–
abPª£¡
[
ii
] ){

612 
	`ã°Com∑ªI¡
(1, (
nDbVÆ
>0), &
rc
);

614 
	`ã°Com∑ªI¡
(1, (
nDbVÆ
<0), &
rc
);

619 
	`ã°Clo£
(&
pDb
);

620 
	`ã°Ca£Föish
(
rc
);

621 *
pRc
 = 
rc
;

622 
	}
}

624 *
	$gëName3
(c⁄° *
zSy°em
, 
D©©e°3
 *
p
){

625  
	`ã°MÆlocPrötf
("data3.%s.%d.%d.%d.%d.(%d..%d)",

626 
zSy°em
, 
p
->
nR™ge
,Ö->
nIãr
,Ö->
nWrôe
,Ö->
nDñëe
,

627 
p
->
nVÆMö
,Ö->
nVÆMax


629 
	}
}

631 
	$ã°_d©a_3
(

632 c⁄° *
zSy°em
,

633 c⁄° *
zP©ã∫
,

634 *
pRc


636 
D©©e°3
 
aTe°
[] = {

642 
i
;

644 
i
=0; *
pRc
==
LSM_OK
 && i<
	`AºaySize
(
aTe°
); i++){

645 *
zName
 = 
	`gëName3
(
zSy°em
, &
aTe°
[
i
]);

646 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "%s", 
zName
) ){

647 
	`doD©aTe°3
(
zSy°em
, &
aTe°
[
i
], 
pRc
);

649 
	`ã°Fªe
(
zName
);

651 
	}
}

	@lsm-test/lsmtest2.c

7 
	~"lsmã°.h
"

12 
Cksum
 
	tCksum
;

13 
	sCksum
 {

14 
	mnRow
;

15 
	mcksum1
;

16 
	mcksum2
;

22 
	$sˇnCksumDb
(

23 *
pCtx
,

24 *
pKey
, 
nKey
,

25 *
pVÆ
, 
nVÆ


27 
Cksum
 *
p
 = (Cksum *)
pCtx
;

28 
i
;

30 
p
->
nRow
++;

31 
i
=0; i<
nKey
; i++){

32 
p
->
cksum1
 +((
u8
 *)
pKey
)[
i
];

33 
p
->
cksum2
 +p->
cksum1
;

35 
i
=0; i<
nVÆ
; i++){

36 
p
->
cksum1
 +((
u8
 *)
pVÆ
)[
i
];

37 
p
->
cksum2
 +p->
cksum1
;

39 
	}
}

44 
	$sˇnCou¡Db
(

45 *
pCtx
,

46 *
pKey
, 
nKey
,

47 *
pVÆ
, 
nVÆ


49 
Cksum
 *
p
 = (Cksum *)
pCtx
;

50 
p
->
nRow
++;

52 
	`unu£d_∑ømëî
(
pKey
);

53 
	`unu£d_∑ømëî
(
nKey
);

54 
	`unu£d_∑ømëî
(
pVÆ
);

55 
	`unu£d_∑ømëî
(
nVÆ
);

56 
	}
}

73 
	$ã°CksumD©aba£
(

74 
Te°Db
 *
pDb
,

75 *
zOut


77 
Cksum
 
cksum
;

78 
	`mem£t
(&
cksum
, 0, (
Cksum
));

79 
	`tdb_sˇn
(
pDb
, (*)&
cksum
, 0, 0, 0, 0, 0, 
sˇnCksumDb
);

80 
	`•rötf
(
zOut
, "%d %x %x",

81 
cksum
.
nRow
, (
u32
)cksum.
cksum1
, (u32)cksum.
cksum2


83 
	`as£π
–
	`°æí
(
zOut
)<
TEST_CKSUM_BYTES
 );

84  
cksum
.
nRow
;

85 
	}
}

87 
	$ã°Cou¡D©aba£
(
Te°Db
 *
pDb
){

88 
Cksum
 
cksum
;

89 
	`mem£t
(&
cksum
, 0, (
Cksum
));

90 
	`tdb_sˇn
(
pDb
, (*)&
cksum
, 0, 0, 0, 0, 0, 
sˇnCou¡Db
);

91  
cksum
.
nRow
;

92 
	}
}

102 
	$ã°Com∑ªSå
(c⁄° *
z1
, c⁄° *
z2
, *
pRc
){

103 if–*
pRc
==0 ){

104 if–
	`°rcmp
(
z1
, 
z2
) ){

105 
	`ã°PrötEº‹
("ã°Com∑ªSå: \"%s\" !\"%s\"\n", 
z1
, 
z2
);

106 *
pRc
 = 1;

107 
	`ã°_Áûed
();

110 
	}
}

119 
	$ã°Com∑ªI¡
(
i1
, 
i2
, *
pRc
){

120 if–*
pRc
==0 && 
i1
!=
i2
 ){

121 
	`ã°PrötEº‹
("ã°Com∑ªI¡: %d !%d\n", 
i1
, 
i2
);

122 *
pRc
 = 1;

123 
	`ã°_Áûed
();

125 
	}
}

127 
	$ã°Ca£Sèπ
(*
pRc
, *
zFmt
, ...){

128 
va_li°
 
≠
;

129 
	`va_°¨t
(
≠
, 
zFmt
);

130 
	`v¥ötf
(
zFmt
, 
≠
);

131 
	`¥ötf
(" ...");

132 
	`va_íd
(
≠
);

133 *
pRc
 = 0;

134 
	`fÊush
(
°dout
);

135 
	}
}

146 
	$ã°Ca£Begö
(*
pRc
, c⁄° *
zP©ã∫
, c⁄° *
zFmt
, ...){

147 
ªs
 = 0;

148 if–*
pRc
==0 ){

149 *
zTe°
;

150 
va_li°
 
≠
;

152 
	`va_°¨t
(
≠
, 
zFmt
);

153 
zTe°
 = 
	`ã°MÆlocVPrötf
(
zFmt
, 
≠
);

154 
	`va_íd
(
≠
);

155 if–
zP©ã∫
==0 || 
	`ã°GlobM©ch
(zP©ã∫, 
zTe°
) ){

156 
	`¥ötf
("%-50†...", 
zTe°
);

157 
ªs
 = 1;

159 
	`ã°Fªe
(
zTe°
);

160 
	`fÊush
(
°dout
);

163  
ªs
;

164 
	}
}

166 
	$ã°Ca£Föish
(
rc
){

167 if–
rc
==0 ){

168 
	`¥ötf
("Ok\n");

170 
	`¥ötf
("FAILED\n");

172 
	`fÊush
(
°dout
);

173 
	}
}

175 
	$ã°Ca£Skù
(){

176 
	`¥ötf
("Skipped\n");

177 
	}
}

179 
	$ã°SëupSavedLsmdb
(

180 c⁄° *
zCfg
,

181 c⁄° *
zFûe
,

182 
D©asour˚
 *
pD©a
,

183 
nRow
,

184 *
pRc


186 if–*
pRc
==0 ){

187 
rc
;

188 
Te°Db
 *
pDb
;

189 
rc
 = 
	`tdb_lsm_›í
(
zCfg
, 
zFûe
, 1, &
pDb
);

190 if–
rc
==0 ){

191 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 0, 
nRow
, &
rc
);

192 
	`ã°Clo£
(&
pDb
);

193 if–
rc
==0 ) 
	`ã°SaveDb
(
zFûe
, "log");

195 *
pRc
 = 
rc
;

197 
	}
}

199 
	$ã°SëupSavedBtdb
(

200 c⁄° *
zFûe
,

201 
D©asour˚
 *
pD©a
,

202 
nRow
,

203 *
pRc


205 if–*
pRc
==0 ){

206 
rc
;

207 
Te°Db
 *
pDb
;

208 
rc
 = 
	`tdb_›í
("bt", 
zFûe
, 1, &
pDb
);

209 if–
rc
==0 ){

210 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 0, 
nRow
, &
rc
);

211 
	`ã°Clo£
(&
pDb
);

212 if–
rc
==0 ) 
	`ã°SaveDb
(
zFûe
, "wal");

214 *
pRc
 = 
rc
;

216 
	}
}

226 
	$ã°Com∑ªCksumLsmdb
(

227 c⁄° *
zFûe
,

228 
bCom¥ess
,

229 c⁄° *
zEx≥˘1
,

230 c⁄° *
zEx≥˘2
,

231 *
pRc


233 if–*
pRc
==0 ){

234 
zCksum
[
TEST_CKSUM_BYTES
];

235 
Te°Db
 *
pDb
;

237 *
pRc
 = 
	`tdb_lsm_›í
((
bCom¥ess
?"com¥essi⁄=1 mm≠=0":""), 
zFûe
, 0, &
pDb
);

238 
	`ã°CksumD©aba£
(
pDb
, 
zCksum
);

239 
	`ã°Clo£
(&
pDb
);

241 if–*
pRc
==0 ){

242 
r1
 = 0;

243 
r2
 = -1;

245 
r1
 = 
	`°rcmp
(
zCksum
, 
zEx≥˘1
);

246 if–
zEx≥˘2
 ) 
r2
 = 
	`°rcmp
(
zCksum
, zExpect2);

247 if–
r1
 && 
r2
 ){

248 if–
zEx≥˘2
 ){

249 
	`ã°PrötEº‹
("testCompareCksumLsmdb: \"%s\" != (\"%s\" OR \"%s\")",

250 
zCksum
, 
zEx≥˘1
, 
zEx≥˘2


253 
	`ã°PrötEº‹
("testCompareCksumLsmdb: \"%s\" != \"%s\"",

254 
zCksum
, 
zEx≥˘1


257 *
pRc
 = 1;

258 
	`ã°_Áûed
();

262 
	}
}

264 
	$ã°Com∑ªCksumBtdb
(

265 c⁄° *
zFûe
,

266 c⁄° *
zEx≥˘1
,

267 c⁄° *
zEx≥˘2
,

268 *
pRc


270 if–*
pRc
==0 ){

271 
zCksum
[
TEST_CKSUM_BYTES
];

272 
Te°Db
 *
pDb
;

274 *
pRc
 = 
	`tdb_›í
("bt", 
zFûe
, 0, &
pDb
);

275 
	`ã°CksumD©aba£
(
pDb
, 
zCksum
);

276 
	`ã°Clo£
(&
pDb
);

278 if–*
pRc
==0 ){

279 
r1
 = 0;

280 
r2
 = -1;

282 
r1
 = 
	`°rcmp
(
zCksum
, 
zEx≥˘1
);

283 if–
zEx≥˘2
 ) 
r2
 = 
	`°rcmp
(
zCksum
, zExpect2);

284 if–
r1
 && 
r2
 ){

285 if–
zEx≥˘2
 ){

286 
	`ã°PrötEº‹
("testCompareCksumLsmdb: \"%s\" != (\"%s\" OR \"%s\")",

287 
zCksum
, 
zEx≥˘1
, 
zEx≥˘2


290 
	`ã°PrötEº‹
("testCompareCksumLsmdb: \"%s\" != \"%s\"",

291 
zCksum
, 
zEx≥˘1


294 *
pRc
 = 1;

295 
	`ã°_Áûed
();

299 
	}
}

309 
	$¸ash_ã°1
(
bCom¥ess
, *
pRc
){

310 c⁄° *
DBNAME
 = "testdb.lsm";

311 c⁄° 
D©asour˚De‚
 
de‚
 = {
TEST_DATASOURCE_RANDOM
, 12, 16, 200, 200};

313 c⁄° 
nRow
 = 5000;

314 c⁄° 
nIãr
 = 200;

315 c⁄° 
nW‹k
 = 20;

316 c⁄° 
nPage
 = 15;

318 
i
;

319 
iDŸ
 = 0;

320 
D©asour˚
 *
pD©a
;

321 
CksumDb
 *
pCksumDb
;

322 
Te°Db
 *
pDb
;

323 *
zCfg
;

325 c⁄° *
azC⁄fig
[2] = {

330 
	`as£π
–
bCom¥ess
==0 || bCompress==1 );

333 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

334 
pCksumDb
 = 
	`ã°CksumAºayNew
(
pD©a
, 
nRow
,ÇRow, 1);

338 
zCfg
 = 
	`ã°MÆlocPrötf
("%†automîge=7", 
azC⁄fig
[
bCom¥ess
]);

339 
	`ã°SëupSavedLsmdb
(
zCfg
, 
DBNAME
, 
pD©a
, 5000, 
pRc
);

340 
	`ã°Fªe
(
zCfg
);

342 
i
=0; i<
nIãr
 && *
pRc
==0; i++){

343 
iW‹k
;

344 
ã°rc
 = 0;

346 
	`ã°Ca£Progªss
(
i
, 
nIãr
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

349 
	`ã°Re°‹eDb
(
DBNAME
, "log");

350 
ã°rc
 = 
	`tdb_lsm_›í
(
azC⁄fig
[
bCom¥ess
], 
DBNAME
, 0, &
pDb
);

351 
	`as£π
–
ã°rc
==0 );

354 
	`tdb_lsm_¥ï¨e_sync_¸ash
(
pDb
, 1 + (
i
%(
nW‹k
*2)));

355 
iW‹k
=0; 
ã°rc
==0 && iW‹k<
nW‹k
; iWork++){

356 
nWrôe
 = 0;

357 
lsm_db
 *
db
 = 
	`tdb_lsm
(
pDb
);

358 
ã°rc
 = 
	`lsm_w‹k
(
db
, 0, 
nPage
, &
nWrôe
);

359 
	`as£π
–
ã°rc
!=0 || 
nWrôe
>0 );

360 if–
ã°rc
==0 )Åe°r¯
	`lsm_checkpoöt
(
db
, 0);

362 
	`tdb_˛o£
(
pDb
);

365 
	`ã°Com∑ªCksumLsmdb
(
DBNAME
,

366 
bCom¥ess
, 
	`ã°CksumAºayGë
(
pCksumDb
, 
nRow
), 0, 
pRc
);

369 
	`ã°CksumAºayFªe
(
pCksumDb
);

370 
	`ã°D©asour˚Fªe
(
pD©a
);

371 
	}
}

377 
	$¸ash_ã°2
(
bCom¥ess
, *
pRc
){

378 c⁄° *
DBNAME
 = "testdb.lsm";

379 c⁄° 
D©asour˚De‚
 
de‚
 = {
TEST_DATASOURCE_RANDOM
, 12, 16, 1000, 1000};

381 c⁄° 
nIãr
 = 200;

382 c⁄° 
nIn£π
 = 20;

384 
i
;

385 
iDŸ
 = 0;

386 
D©asour˚
 *
pD©a
;

387 
CksumDb
 *
pCksumDb
;

388 
Te°Db
 *
pDb
;

391 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

392 
pCksumDb
 = 
	`ã°CksumAºayNew
(
pD©a
, 100, 100+
nIn£π
, 1);

395 
	`ã°SëupSavedLsmdb
("", 
DBNAME
, 
pD©a
, 100, 
pRc
);

397 
i
=0; i<
nIãr
 && *
pRc
==0; i++){

398 
iIns
;

399 
ã°rc
 = 0;

401 
	`ã°Ca£Progªss
(
i
, 
nIãr
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

404 
	`ã°Re°‹eDb
(
DBNAME
, "log");

405 
ã°rc
 = 
	`tdb_lsm_›í
("ß„ty=2", 
DBNAME
, 0, &
pDb
);

406 
	`as£π
–
ã°rc
==0 );

409 
	`tdb_lsm_¥ï¨e_sync_¸ash
(
pDb
, 1 + (
i
%(
nIn£π
+2)));

410 
iIns
=0; iIns<
nIn£π
; iIns++){

411 *
pKey
; 
nKey
;

412 *
pVÆ
; 
nVÆ
;

414 
	`ã°D©asour˚E¡ry
(
pD©a
, 100+
iIns
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

415 
ã°rc
 = 
	`tdb_wrôe
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

416 if–
ã°rc
 ) ;

418 
	`tdb_˛o£
(
pDb
);

421 
	`ã°Com∑ªCksumLsmdb
(
DBNAME
, 
bCom¥ess
,

422 
	`ã°CksumAºayGë
(
pCksumDb
, 100 + 
iIns
),

423 
	`ã°CksumAºayGë
(
pCksumDb
, 100 + 
iIns
 + 1),

424 
pRc


428 
	`ã°D©asour˚Fªe
(
pD©a
);

429 
	`ã°CksumAºayFªe
(
pCksumDb
);

430 
	}
}

437 
	$¸ash_ã°2b
(
bCom¥ess
, *
pRc
){

438 c⁄° *
DBNAME
 = "testdb.bt";

439 c⁄° 
D©asour˚De‚
 
de‚
 = {
TEST_DATASOURCE_RANDOM
, 12, 16, 800, 800};

441 c⁄° 
nIãr
 = 200;

442 c⁄° 
nIn£π
 = 200;

444 
i
;

445 
iDŸ
 = 0;

446 
D©asour˚
 *
pD©a
;

447 
CksumDb
 *
pCksumDb
;

448 
Te°Db
 *
pDb
;

451 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

452 
pCksumDb
 = 
	`ã°CksumAºayNew
(
pD©a
, 100, 100+
nIn£π
+1, 1);

455 
	`ã°SëupSavedBtdb
(
DBNAME
, 
pD©a
, 100, 
pRc
);

457 
i
=0; i<
nIãr
 && *
pRc
==0; i++){

458 
iIns
;

459 
ã°rc
 = 0;

461 
	`ã°Ca£Progªss
(
i
, 
nIãr
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

464 
	`ã°Re°‹eDb
(
DBNAME
, "wal");

465 
ã°rc
 = 
	`tdb_›í
("bàß„ty=2", 
DBNAME
, 0, &
pDb
);

466 
	`as£π
–
ã°rc
==0 );

469 
	`tdb_bt_¥ï¨e_sync_¸ash
(
pDb
, 1 + (
i
%(
nIn£π
+2)));

470 
iIns
=0; iIns<
nIn£π
; iIns++){

471 *
pKey
; 
nKey
;

472 *
pVÆ
; 
nVÆ
;

474 
	`ã°D©asour˚E¡ry
(
pD©a
, 100+
iIns
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

475 
ã°rc
 = 
	`tdb_wrôe
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

476 if–
ã°rc
 ) ;

478 
	`tdb_˛o£
(
pDb
);

481 
	`ã°Com∑ªCksumBtdb
(
DBNAME
,

482 
	`ã°CksumAºayGë
(
pCksumDb
, 100 + 
iIns
 - (
ã°rc
==0)),

483 
	`ã°CksumAºayGë
(
pCksumDb
, 100 + 
iIns
 + 1 - (
ã°rc
==0)),

484 
pRc


489 
	`ã°D©asour˚Fªe
(
pD©a
);

490 
	`ã°CksumAºayFªe
(
pCksumDb
);

491 
	}
}

498 
	$¸ash_ã°3
(
bCom¥ess
, *
pRc
){

499 c⁄° *
DBNAME
 = "testdb.lsm";

500 c⁄° 
nIãr
 = 100;

501 c⁄° 
D©asour˚De‚
 
de‚
 = {
TEST_DATASOURCE_RANDOM
, 12, 16, 1000, 1000};

503 
i
;

504 
iDŸ
 = 0;

505 
D©asour˚
 *
pD©a
;

506 
CksumDb
 *
pCksumDb
;

507 
Te°Db
 *
pDb
;

510 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

511 
pCksumDb
 = 
	`ã°CksumAºayNew
(
pD©a
, 110, 150, 10);

514 
	`ã°SëupSavedLsmdb
("", 
DBNAME
, 
pD©a
, 100, 
pRc
);

516 
i
=0; i<
nIãr
 && *
pRc
==0; i++){

517 
iO≥n
;

518 
	`ã°Ca£Progªss
(
i
, 
nIãr
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

519 
	`ã°Re°‹eDb
(
DBNAME
, "log");

521 
iO≥n
=0; iOpen<5; iOpen++){

523 
pDb
 = 
	`ã°O≥n
("lsm", 0, 
pRc
);

524 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 100+
iO≥n
*10, 10, 
pRc
);

527 
	`tdb_lsm_¥ï¨e_sync_¸ash
(
pDb
, 1 + (
i
%2));

528 
	`tdb_˛o£
(
pDb
);

532 
	`ã°Com∑ªCksumLsmdb
(
DBNAME
, 
bCom¥ess
,

533 
	`ã°CksumAºayGë
(
pCksumDb
, 110 + 
iO≥n
*10), 0,

534 
pRc


539 
	`ã°D©asour˚Fªe
(
pD©a
);

540 
	`ã°CksumAºayFªe
(
pCksumDb
);

541 
	}
}

543 
	$do_¸ash_ã°
(c⁄° *
zP©ã∫
, *
pRc
){

544 
	sTe°
 {

545 c⁄° *
zTe°
;

546 (*
x
)(, *);

547 
bCom¥ess
;

548 } 
aTe°
 [] = {

549 { "¸ash.bt.2", 
¸ash_ã°2b
, 0 },

551 { "¸ash.lsm.1", 
¸ash_ã°1
, 0 },

552 { "¸ash.lsm_zù.1", 
¸ash_ã°1
, 1 },

553 { "¸ash.lsm.2", 
¸ash_ã°2
, 0 },

554 { "¸ash.lsm.3", 
¸ash_ã°3
, 0 },

556 
i
;

558 
i
=0; *
pRc
==
LSM_OK
 && i<
	`AºaySize
(
aTe°
); i++){

559 
Te°
 *
p
 = &
aTe°
[
i
];

560 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "%s", 
p
->
zTe°
) ){

561 
p
->
	`x
’->
bCom¥ess
, 
pRc
);

562 
	`ã°Ca£Föish
(*
pRc
);

565 
	}
}

	@lsm-test/lsmtest3.c

24 
	~"lsmã°.h
"

26 
	sCksumDb
 {

27 
	mnFú°
;

28 
	mnLa°
;

29 
	mnSãp
;

30 **
	mazCksum
;

33 
CksumDb
 *
	$ã°CksumAºayNew
(

34 
D©asour˚
 *
pD©a
,

35 
nFú°
,

36 
nLa°
,

37 
nSãp


39 
Te°Db
 *
pDb
;

40 
CksumDb
 *
pRë
;

41 
i
;

42 
nE¡ry
;

43 
rc
 = 0;

45 
	`as£π
–
nLa°
>=
nFú°
 && (“La°-nFú°)%
nSãp
)==0 );

47 
pRë
 = 
	`mÆloc
((
CksumDb
));

48 
	`mem£t
(
pRë
, 0, (
CksumDb
));

49 
pRë
->
nFú°
 =ÇFirst;

50 
pRë
->
nLa°
 =ÇLast;

51 
pRë
->
nSãp
 =ÇStep;

52 
nE¡ry
 = 1 + ((
nLa°
 - 
nFú°
Ë/ 
nSãp
);

56 
pRë
->
azCksum
 = (**)
	`mÆloc
(
nE¡ry
 * ((*Ë+ 
TEST_CKSUM_BYTES
));

57 
i
=0; i<
nE¡ry
; i++){

58 *
pSèπ
 = (*)(&
pRë
->
azCksum
[
nE¡ry
]);

59 
pRë
->
azCksum
[
i
] = &
pSèπ
[ò* 
TEST_CKSUM_BYTES
];

62 
	`tdb_›í
("lsm", "ãmpdb.lsm", 1, &
pDb
);

63 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 0, 
nFú°
, &
rc
);

64 
i
=0; i<
nE¡ry
; i++){

65 
	`ã°CksumD©aba£
(
pDb
, 
pRë
->
azCksum
[
i
]);

66 if–
i
==
nE¡ry
 ) ;

67 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
nFú°
+
i
*
nSãp
,ÇSãp, &
rc
);

70 
	`tdb_˛o£
(
pDb
);

72  
pRë
;

73 
	}
}

75 *
	$ã°CksumAºayGë
(
CksumDb
 *
p
, 
nRow
){

76 
i
;

77 
	`as£π
–
nRow
>=
p
->
nFú°
 );

78 
	`as£π
–
nRow
<=
p
->
nLa°
 );

79 
	`as£π
–((
nRow
-
p
->
nFú°
Ë%Ö->
nSãp
)==0 );

81 
i
 = (
nRow
 - 
p
->
nFú°
Ë/Ö->
nSãp
;

82  
p
->
azCksum
[
i
];

83 
	}
}

85 
	$ã°CksumAºayFªe
(
CksumDb
 *
p
){

86 
	`‰ì
(
p
->
azCksum
);

87 
	`mem£t
(
p
, 0x55, (*p));

88 
	`‰ì
(
p
);

89 
	}
}

98 
	$ã°WrôeD©asour˚
(
Te°Db
 *
pDb
, 
D©asour˚
 *
pD©a
, 
i
, *
pRc
){

99 *
pKey
; 
nKey
;

100 *
pVÆ
; 
nVÆ
;

101 
	`ã°D©asour˚E¡ry
(
pD©a
, 
i
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

102 
	`ã°Wrôe
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, 
pRc
);

103 
	}
}

108 
	$ã°DñëeD©asour˚
(
Te°Db
 *
pDb
, 
D©asour˚
 *
pD©a
, 
i
, *
pRc
){

109 *
pKey
; 
nKey
;

110 
	`ã°D©asour˚E¡ry
(
pD©a
, 
i
, &
pKey
, &
nKey
, 0, 0);

111 
	`ã°Dñëe
(
pDb
, 
pKey
, 
nKey
, 
pRc
);

112 
	}
}

118 
	$ã°WrôeD©asour˚R™ge
(

119 
Te°Db
 *
pDb
,

120 
D©asour˚
 *
pD©a
,

121 
iFú°
,

122 
nWrôe
,

123 *
pRc


125 
i
;

126 
i
=0; i<
nWrôe
; i++){

127 
	`ã°WrôeD©asour˚
(
pDb
, 
pD©a
, 
iFú°
+
i
, 
pRc
);

129 
	}
}

131 
	$ã°DñëeD©asour˚R™ge
(

132 
Te°Db
 *
pDb
,

133 
D©asour˚
 *
pD©a
,

134 
iFú°
,

135 
nWrôe
,

136 *
pRc


138 
i
;

139 
i
=0; i<
nWrôe
; i++){

140 
	`ã°DñëeD©asour˚
(
pDb
, 
pD©a
, 
iFú°
+
i
, 
pRc
);

142 
	}
}

144 *
	$gëName
(c⁄° *
zSy°em
){

145 *
zRë
;

146 
zRë
 = 
	`ã°MÆlocPrötf
("rﬁlback.%s", 
zSy°em
);

147  
zRë
;

148 
	}
}

150 
	$rﬁlback_ã°_1
(

151 c⁄° *
zSy°em
,

152 
D©asour˚
 *
pD©a


154 c⁄° 
nRïót
 = 100;

156 
Te°Db
 *
pDb
;

157 
rc
;

158 
i
;

159 
CksumDb
 *
pCksum
;

160 *
zName
;

162 
zName
 = 
	`gëName
(
zSy°em
);

163 
	`ã°Ca£Sèπ
(&
rc
, 
zName
);

164 
	`ã°Fªe
(
zName
);

166 
pCksum
 = 
	`ã°CksumAºayNew
(
pD©a
, 0, 
nRïót
*100, 100);

167 
pDb
 = 0;

168 
rc
 = 
	`tdb_›í
(
zSy°em
, 0, 1, &
pDb
);

169 if–
pDb
 && 
	`tdb_å™ß˘i⁄_suµ‹t
(pDb)==0 ){

170 
	`ã°Ca£Skù
();

171 
skù_rﬁlback_ã°
;

174 
i
=0; i<
nRïót
 && 
rc
==0; i++){

175 
zCksum
[
TEST_CKSUM_BYTES
];

176 
nCuºít
 = (((
i
+1)/2) * 100);

177 
nDbRow
;

178 
iTøns
;

181 
nDbRow
 = 
	`ã°Cou¡D©aba£
(
pDb
);

182 
	`ã°Com∑ªI¡
(
nCuºít
, 
nDbRow
, &
rc
);

184 
iTøns
=2; iTøns<=6 && 
rc
==0; iTrans++){

185 
	`tdb_begö
(
pDb
, 
iTøns
);

186 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
nCuºít
, 100, &
rc
);

187 
nCuºít
 += 100;

190 
	`ã°CksumD©aba£
(
pDb
, 
zCksum
);

191 
	`ã°Com∑ªSå
(
zCksum
, 
	`ã°CksumAºayGë
(
pCksum
, 
nCuºít
), &
rc
);

193 
iTøns
=6; iTøns>2 && 
rc
==0; iTrans--){

194 
	`tdb_rﬁlback
(
pDb
, 
iTøns
);

195 
nCuºít
 -= 100;

196 
	`ã°CksumD©aba£
(
pDb
, 
zCksum
);

197 
	`ã°Com∑ªSå
(
zCksum
, 
	`ã°CksumAºayGë
(
pCksum
, 
nCuºít
), &
rc
);

200 if–
i
%2 ){

201 
	`tdb_rﬁlback
(
pDb
, 0);

202 
nCuºít
 -= 100;

203 
	`ã°CksumD©aba£
(
pDb
, 
zCksum
);

204 
	`ã°Com∑ªSå
(
zCksum
, 
	`ã°CksumAºayGë
(
pCksum
, 
nCuºít
), &
rc
);

206 
	`tdb_commô
(
pDb
, 0);

209 
	`ã°Ca£Föish
(
rc
);

211 
skù_rﬁlback_ã°
:

212 
	`tdb_˛o£
(
pDb
);

213 
	`ã°CksumAºayFªe
(
pCksum
);

214  
rc
;

215 
	}
}

217 
	$ã°_rﬁlback
(

218 c⁄° *
zSy°em
,

219 c⁄° *
zP©ã∫
,

220 *
pRc


222 if–*
pRc
==0 ){

223 
bRun
 = 1;

225 if–
zP©ã∫
 ){

226 *
zName
 = 
	`gëName
(
zSy°em
);

227 
bRun
 = 
	`ã°GlobM©ch
(
zP©ã∫
, 
zName
);

228 
	`ã°Fªe
(
zName
);

231 if–
bRun
 ){

232 
D©asour˚De‚
 
de‚
 = { 
TEST_DATASOURCE_RANDOM
, 10, 15, 50, 100 };

233 
D©asour˚
 *
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

234 *
pRc
 = 
	`rﬁlback_ã°_1
(
zSy°em
, 
pD©a
);

235 
	`ã°D©asour˚Fªe
(
pD©a
);

238 
	}
}

	@lsm-test/lsmtest4.c

6 
	~"lsmã°.h
"

32 
M˘e°
 
	tM˘e°
;

33 
	sM˘e°
 {

34 
D©asour˚De‚
 
	mde‚
;

35 
	mnSãp
;

36 
	mnWrôeSãp
;

37 
	mnRódî
;

39 
	$do_mc_ã°
(

40 c⁄° *
zSy°em
,

41 
M˘e°
 *
pTe°
,

42 *
pRc


44 c⁄° 
nDomaö
 = 
pTe°
->
nSãp
 *ÖTe°->
nWrôeSãp
;

45 
D©asour˚
 *
pD©a
;

46 
Te°Db
 *
pDb
;

47 
iRódî
;

48 
iSãp
;

49 
iDŸ
 = 0;

52 
	sRódî
 {

53 
Te°Db
 *
pDb
;

54 
iLa°
;

55 } *
aRódî
;

58 
pD©a
 = 
	`ã°D©asour˚New
(&
pTe°
->
de‚
);

61 
pDb
 = 
	`ã°O≥n
(
zSy°em
, 1, 
pRc
);

64 
aRódî
 = (
Ródî
 *)
	`ã°MÆloc
(◊Ródî[0]Ë* 
pTe°
->
nRódî
);

65 
iRódî
=0; iRódî<
pTe°
->
nRódî
; iReader++){

66 
aRódî
[
iRódî
].
pDb
 = 
	`ã°O≥n
(
zSy°em
, 0, 
pRc
);

69 
iSãp
=0; iSãp<
pTe°
->
nSãp
; iStep++){

70 
iLa°
;

71 
iBegö
;

74 
iFú°
 = 
iSãp
*
pTe°
->
nWrôeSãp
;

75 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
iFú°
, 
pTe°
->
nWrôeSãp
, 
pRc
);

78 
iLa°
 = (
iSãp
+1Ë* 
pTe°
->
nWrôeSãp
 - 1;

79 
	`ã°DbC⁄ã¡s
(
pDb
, 
pD©a
, 
nDomaö
, 0, 
iLa°
, iLa°, 1, 
pRc
);

82 
iBegö
 = (
iSãp
 % 
pTe°
->
nRódî
);

83 if–
iBegö
<
iSãp
 ) 
	`tdb_commô
(
aRódî
[iBegö].
pDb
, 0);

84 
	`tdb_begö
(
aRódî
[
iBegö
].
pDb
, 1);

85 
aRódî
[
iBegö
].
iLa°
 = iLast;

88 
iRódî
=0; iRódî<
pTe°
->
nRódî
 && 
aRódî
[iRódî].
iLa°
; iReader++){

89 
iLa°
 = 
aRódî
[
iRódî
].iLast;

90 
	`ã°DbC⁄ã¡s
(

91 
aRódî
[
iRódî
].
pDb
, 
pD©a
, 
nDomaö
, 0, 
iLa°
, iLa°, 1, 
pRc


96 
	`ã°Ca£Progªss
(
iSãp
, 
pTe°
->
nSãp
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

100 
iRódî
=0; iRódî<
pTe°
->
nRódî
; iReader++){

101 
	`ã°Clo£
(&
aRódî
[
iRódî
].
pDb
);

103 
	`ã°Fªe
(
aRódî
);

106 
	`ã°Clo£
(&
pDb
);

107 
	`ã°D©asour˚Fªe
(
pD©a
);

108 
	}
}

111 
	$ã°_mc
(

112 c⁄° *
zSy°em
,

113 c⁄° *
zP©ã∫
,

114 *
pRc


116 
i
;

117 
M˘e°
 
aTe°
[] = {

118 { { 
TEST_DATASOURCE_RANDOM
, 10,10, 100,100 }, 100, 10, 5 },

121 
i
=0; i<
	`AºaySize
(
aTe°
); i++){

122 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "mc1.%s.%d", 
zSy°em
, 
i
) ){

123 
	`do_mc_ã°
(
zSy°em
, &
aTe°
[
i
], 
pRc
);

124 
	`ã°Ca£Föish
(*
pRc
);

127 
	}
}

	@lsm-test/lsmtest5.c

64 
	~"lsmã°.h
"

66 
DbP¨amëîs
 
	tDbP¨amëîs
;

67 
	sDbP¨amëîs
 {

68 
	mnF™out
;

69 
	mnKey
;

72 
	#DB_KEY_BYTES
 (2+5+10+1)

	)

79 
	$dbF‹m©Key
(

80 
DbP¨amëîs
 *
pP¨am
,

81 
iLevñ
,

82 
iKey
,

83 *
aBuf


85 if–
iLevñ
==0 ){

86 
	`¢¥ötf
(
aBuf
, 
DB_KEY_BYTES
, "k.%.10d", 
iKey
);

88 
f
 = 1;

89 
i
;

90 
i
=0; i<
iLevñ
; i++Ë
f
 = f * 
pP¨am
->
nF™out
;

91 
	`¢¥ötf
(
aBuf
, 
DB_KEY_BYTES
, "c.%d.%.10d", 
iLevñ
, 
f
*(
iKey
/f));

93 
	}
}

100 
	$dbF‹m©CksumVÆue
(
u32
 
iVÆ
, *
aBuf
){

101 
	`¢¥ötf
(
aBuf
, 
DB_KEY_BYTES
, "%.10u", 
iVÆ
);

102 
	}
}

108 
	$dbMaxLevñ
(
DbP¨amëîs
 *
pP¨am
){

109 
iMax
;

110 
n
 = 1;

111 
iMax
=0; 
n
<
pP¨am
->
nKey
; iMax++){

112 
n
 =Ç * 
pP¨am
->
nF™out
;

114  
iMax
;

115 
	}
}

117 
	$dbCksum
(

118 *
pCtx
,

119 *
pKey
, 
nKey
,

120 *
pVÆ
, 
nVÆ


122 
u8
 *
aVÆ
 = (u8 *)
pVÆ
;

123 
u32
 *
pCksum
 = (u32 *)
pCtx
;

124 
u32
 
cksum
 = *
pCksum
;

125 
i
;

127 
	`unu£d_∑ømëî
(
pKey
);

128 
	`unu£d_∑ømëî
(
nKey
);

130 
i
=0; i<
nVÆ
; i++){

131 
cksum
 +(cksum<<3Ë+ ()
aVÆ
[
i
];

134 *
pCksum
 = 
cksum
;

135 
	}
}

142 
u32
 
	$dbCompuãCksum
(

143 
DbP¨amëîs
 *
pP¨am
,

144 
Te°Db
 *
pDb
,

145 
iLevñ
,

146 
iKey
,

147 *
pRc


149 
u32
 
cksum
 = 0;

150 if–*
pRc
==0 ){

151 
nFú°
;

152 
nLa°
;

153 
iFú°
 = 0;

154 
iLa°
 = 0;

155 
i
;

156 
f
 = 1;

157 
zFú°
[
DB_KEY_BYTES
];

158 
zLa°
[
DB_KEY_BYTES
];

160 
	`as£π
–
iLevñ
>=1 );

161 
i
=0; i<
iLevñ
; i++Ë
f
 = f * 
pP¨am
->
nF™out
;

163 
iFú°
 = 
f
*(
iKey
/f);

164 
iLa°
 = 
iFú°
 + 
f
 - 1;

165 
	`dbF‹m©Key
(
pP¨am
, 
iLevñ
-1, 
iFú°
, 
zFú°
);

166 
	`dbF‹m©Key
(
pP¨am
, 
iLevñ
-1, 
iLa°
, 
zLa°
);

167 
nFú°
 = 
	`°æí
(
zFú°
);

168 
nLa°
 = 
	`°æí
(
zLa°
);

170 *
pRc
 = 
	`tdb_sˇn
(
pDb
, (
u32
*)&
cksum
, 0, 
zFú°
, 
nFú°
, 
zLa°
, 
nLa°
,
dbCksum
);

173  
cksum
;

174 
	}
}

176 
dbRódO≥øti⁄
(

177 
DbP¨amëîs
 *
pP¨am
,

178 
Te°Db
 *
pDb
,

179 (*
xDñay
)(*),

180 *
pDñayCtx
,

181 
iKey
,

182 *
pRc


184 c⁄° 
iMax
 = 
	`dbMaxLevñ
(
pP¨am
);

185 
i
;

187 if–
	`tdb_å™ß˘i⁄_suµ‹t
(
pDb
ËË
	`ã°Begö
’Db, 1, 
pRc
);

188 
i
=1; *
pRc
==0 && i<=
iMax
; i++){

189 
zCksum
[
DB_KEY_BYTES
];

190 
zKey
[
DB_KEY_BYTES
];

191 
u32
 
iCksum
 = 0;

193 
iCksum
 = 
	`dbCompuãCksum
(
pP¨am
, 
pDb
, 
i
, 
iKey
, 
pRc
);

194 if–
iCksum
 ){

195 if–
xDñay
 && 
i
==1 ) 
	`xDñay
(
pDñayCtx
);

196 
	`dbF‹m©CksumVÆue
(
iCksum
, 
zCksum
);

197 
	`dbF‹m©Key
(
pP¨am
, 
i
, 
iKey
, 
zKey
);

198 
	`ã°FëchSå
(
pDb
, 
zKey
, 
zCksum
, 
pRc
);

201 if–
	`tdb_å™ß˘i⁄_suµ‹t
(
pDb
ËË
	`ã°Commô
’Db, 0, 
pRc
);

202 
	}
}

204 
	$dbWrôeO≥øti⁄
(

205 
DbP¨amëîs
 *
pP¨am
,

206 
Te°Db
 *
pDb
,

207 
iKey
,

208 c⁄° *
zVÆue
,

209 *
pRc


211 c⁄° 
iMax
 = 
	`dbMaxLevñ
(
pP¨am
);

212 
zKey
[
DB_KEY_BYTES
];

213 
i
;

214 
rc
;

216 
	`as£π
–
iKey
>=0 && iKey<
pP¨am
->
nKey
 );

217 
	`dbF‹m©Key
(
pP¨am
, 0, 
iKey
, 
zKey
);

220 if–*
pRc
==0 && 
	`tdb_å™ß˘i⁄_suµ‹t
(
pDb
) ){

221 
rc
 = 
	`tdb_begö
(
pDb
, 2);

222 if–
rc
==5 )  0;

223 *
pRc
 = 
rc
;

226 
	`ã°WrôeSå
(
pDb
, 
zKey
, 
zVÆue
, 
pRc
);

227 
i
=1; i<=
iMax
; i++){

228 
zCksum
[
DB_KEY_BYTES
];

229 
u32
 
iCksum
 = 0;

231 
iCksum
 = 
	`dbCompuãCksum
(
pP¨am
, 
pDb
, 
i
, 
iKey
, 
pRc
);

232 
	`dbF‹m©CksumVÆue
(
iCksum
, 
zCksum
);

233 
	`dbF‹m©Key
(
pP¨am
, 
i
, 
iKey
, 
zKey
);

234 
	`ã°WrôeSå
(
pDb
, 
zKey
, 
zCksum
, 
pRc
);

236 if–
	`tdb_å™ß˘i⁄_suµ‹t
(
pDb
ËË
	`ã°Commô
’Db, 0, 
pRc
);

238 
	}
}

261 
ThªadSë
 
	tThªadSë
;

262 #ifde‡
LSM_MUTEX_PTHREADS


264 
	~<±hªad.h
>

265 
	~<uni°d.h
>

267 
Thªad
 
	tThªad
;

268 
	sThªad
 {

269 
	mrc
;

270 *
	mzMsg
;

271 
±hªad_t
 
	mid
;

272 (*
	mxMaö
)(
	mThªadSë
 *, , *);

273 *
	mpCtx
;

274 
ThªadSë
 *
	mpThªadSë
;

277 
	sThªadSë
 {

278 
	mbHÆt
;

279 
	mnThªad
;

280 
Thªad
 *
	maThªad
;

281 
±hªad_muãx_t
 
	mmuãx
;

289 
	$ã°ThªadSuµ‹t
(){  1; 
	}
}

296 
ThªadSë
 *
	$ã°ThªadInô
(
nMax
){

297 
nByã
;

298 
ThªadSë
 *
p
;

300 
nByã
 = (
ThªadSë
Ë+ (
Thªad
Ë* 
nMax
;

301 
p
 = (
ThªadSë
 *)
	`ã°MÆloc
(
nByã
);

302 
p
->
nThªad
 = 
nMax
;

303 
p
->
aThªad
 = (
Thªad
 *)&p[1];

304 
	`±hªad_muãx_öô
(&
p
->
muãx
, 0);

306  
p
;

307 
	}
}

312 
	$ã°ThªadShutdown
(
ThªadSë
 *
p
){

313 
i
;

314 
i
=0; i<
p
->
nThªad
; i++){

315 
	`ã°Fªe
(
p
->
aThªad
[
i
].
zMsg
);

317 
	`±hªad_muãx_de°roy
(&
p
->
muãx
);

318 
	`ã°Fªe
(
p
);

319 
	}
}

321 *
	$âMaö
(*
pArg
){

322 
Thªad
 *
pThªad
 = (Thªad *)
pArg
;

323 
iThªad
;

324 
iThªad
 = (
pThªad
 -ÖThªad->
pThªadSë
->
aThªad
);

325 
pThªad
->
	`xMaö
’Thªad->
pThªadSë
, 
iThªad
,ÖThªad->
pCtx
);

327 
	}
}

332 
ã°ThªadLaunch
(

333 
ThªadSë
 *
p
,

334 
iThªad
,

335 (*
xMaö
)(
ThªadSë
 *, , *),

336 *
pCtx


338 
rc
;

339 
Thªad
 *
pThªad
;

341 
	`as£π
–
iThªad
>=0 && iThªad<
p
->
nThªad
 );

343 
pThªad
 = &
p
->
aThªad
[
iThªad
];

344 
	`as£π
–
pThªad
->
pThªadSë
==0 );

345 
pThªad
->
xMaö
 = xMain;

346 
pThªad
->
pCtx
 =ÖCtx;

347 
pThªad
->
pThªadSë
 = 
p
;

348 
rc
 = 
	`±hªad_¸óã
(&
pThªad
->
id
, 0, 
âMaö
, (*)pThread);

350  
rc
;

351 
	}
}

356 
	$ã°ThªadSëHÆt
(
ThªadSë
 *
pThªadSë
){

357 
pThªadSë
->
bHÆt
 = 1;

358 
	}
}

363 
	$ã°ThªadGëHÆt
(
ThªadSë
 *
pThªadSë
){

364  
pThªadSë
->
bHÆt
;

365 
	}
}

367 
	$ã°ThªadSÀï
(
ThªadSë
 *
pThªadSë
, 
nMs
){

368 
nRem
 = 
nMs
;

369  
nRem
>0 && 
	`ã°ThªadGëHÆt
(
pThªadSë
)==0 ){

370 
	`u¶ìp
(50000);

371 
nRem
 -= 50;

373 
	}
}

380 
	$ã°ThªadWaô
(
ThªadSë
 *
pThªadSë
, 
nMs
){

381 
i
;

383 
	`ã°ThªadSÀï
(
pThªadSë
, 
nMs
);

384 
	`ã°ThªadSëHÆt
(
pThªadSë
);

385 
i
=0; i<
pThªadSë
->
nThªad
; i++){

386 
Thªad
 *
pThªad
 = &
pThªadSë
->
aThªad
[
i
];

387 if–
pThªad
->
xMaö
 ){

388 
	`±hªad_joö
(
pThªad
->
id
, 0);

391 
	}
}

396 
	$ã°ThªadSëResu…
(

397 
ThªadSë
 *
pThªadSë
,

398 
iThªad
,

399 
rc
,

400 *
zFmt
,

403 
va_li°
 
≠
;

405 
	`ã°Fªe
(
pThªadSë
->
aThªad
[
iThªad
].
zMsg
);

406 
pThªadSë
->
aThªad
[
iThªad
].
rc
 =Ñc;

407 
pThªadSë
->
aThªad
[
iThªad
].
zMsg
 = 0;

408 if–
zFmt
 ){

409 
	`va_°¨t
(
≠
, 
zFmt
);

410 
pThªadSë
->
aThªad
[
iThªad
].
zMsg
 = 
	`ã°MÆlocVPrötf
(
zFmt
, 
≠
);

411 
	`va_íd
(
≠
);

413 
	}
}

418 
	$ã°ThªadGëResu…
(

419 
ThªadSë
 *
pThªadSë
,

420 
iThªad
,

421 c⁄° **
pzRes


423 if–
pzRes
 ) *pzRe†
pThªadSë
->
aThªad
[
iThªad
].
zMsg
;

424  
pThªadSë
->
aThªad
[
iThªad
].
rc
;

425 
	}
}

431 
	$ã°ThªadE¡îMuãx
(
ThªadSë
 *
p
){

432 
	`±hªad_muãx_lock
(&
p
->
muãx
);

433 
	}
}

434 
	$ã°ThªadLóveMuãx
(
ThªadSë
 *
p
){

435 
	`±hªad_muãx_u∆ock
(&
p
->
muãx
);

436 
	}
}

440 #i‡!
deföed
(
LSM_MUTEX_PTHREADS
)

441 
	$ã°ThªadSuµ‹t
(){  0; 
	}
}

443 
	#ã°ThªadInô
(
a
Ë0

	)

444 
	#ã°ThªadShutdown
(
a
)

	)

445 
	#ã°ThªadLaunch
(
a
,
b
,
c
,
d
Ë0

	)

446 
	#ã°ThªadWaô
(
a
,
b
)

	)

447 
	#ã°ThªadSëHÆt
(
a
)

	)

448 
	#ã°ThªadGëHÆt
(
a
Ë0

	)

449 
	#ã°ThªadGëResu…
(
a
,
b
,
c
Ë0

	)

450 
	#ã°ThªadSÀï
(
a
,
b
Ë0

	)

452 
	$ã°ThªadSëResu…
(
ThªadSë
 *
a
, 
b
, 
c
, *
d
, ...){

453 
	`unu£d_∑ømëî
(
a
);

454 
	`unu£d_∑ømëî
(
b
);

455 
	`unu£d_∑ømëî
(
c
);

456 
	`unu£d_∑ømëî
(
d
);

457 
	}
}

466 
Mt1Te°
 
	tMt1Te°
;

467 
	sMt1Te°
 {

468 
DbP¨amëîs
 
	m∑øm
;

469 
	mnRódwrôe
;

470 
	mnFa°Ródî
;

471 
	mnSlowRódî
;

472 
	mnMs
;

473 c⁄° *
	mzSy°em
;

476 
Mt1DñayCtx
 
	tMt1DñayCtx
;

477 
	sMt1DñayCtx
 {

478 
ThªadSë
 *
	mpSë
;

479 
	mnMs
;

482 
	$xMt1Dñay
(*
pCtx
){

483 
Mt1DñayCtx
 *
p
 = (Mt1DñayCtx *)
pCtx
;

484 
	`ã°ThªadSÀï
(
p
->
pSë
,Ö->
nMs
);

485 
	}
}

487 
	#MT1_THREAD_RDWR
 0

	)

488 
	#MT1_THREAD_SLOW
 1

	)

489 
	#MT1_THREAD_FAST
 2

	)

491 
	$xMt1W‹k
(
lsm_db
 *
pDb
, *
pCtx
){

493 *
z
 = 0;

494 
	`lsm_öfo
(
pDb
, 
LSM_INFO_DB_STRUCTURE
, &
z
);

495 
	`¥ötf
("%s\n", 
z
);

496 
	`fÊush
(
°dout
);

498 
	}
}

503 
	$mt1Maö
(
ThªadSë
 *
pThªadSë
, 
iThªad
, *
pCtx
){

504 
Mt1Te°
 *
p
 = (Mt1Te° *)
pCtx
;

505 
Mt1DñayCtx
 
dñay
;

506 
nRód
 = 0;

507 
nWrôe
 = 0;

508 
rc
 = 0;

509 
iP∫g
;

510 
Te°Db
 *
pDb
;

511 
eTy≥
;

513 
dñay
.
pSë
 = 
pThªadSë
;

514 
dñay
.
nMs
 = 0;

515 if–
iThªad
<
p
->
nRódwrôe
 ){

516 
eTy≥
 = 
MT1_THREAD_RDWR
;

517 }if–
iThªad
<(
p
->
nRódwrôe
+p->
nFa°Ródî
) ){

518 
eTy≥
 = 
MT1_THREAD_FAST
;

520 
eTy≥
 = 
MT1_THREAD_SLOW
;

521 
dñay
.
nMs
 = (
p
->nMs / 20);

526 
iP∫g
 = 
	`ã°P∫gVÆue
(
iThªad
);

527 
pDb
 = 
	`ã°O≥n
(
p
->
zSy°em
, 0, &
rc
);

529 if–
rc
==0 ){

530 
	`tdb_lsm_c⁄fig_w‹k_hook
(
pDb
, 
xMt1W‹k
, 0);

535  
rc
==0 && 
	`ã°ThªadGëHÆt
(
pThªadSë
)==0 ){

536 
iKey
;

539 
iKey
 = (
	`ã°P∫gVÆue
(
iP∫g
++Ë% 
p
->
∑øm
.
nKey
);

540 
	`dbRódO≥øti⁄
(&
p
->
∑øm
, 
pDb
, 
xMt1Dñay
, (*)&
dñay
, 
iKey
, &
rc
);

541 if–
rc
 ) ;

542 
nRód
++;

547 if–
eTy≥
==
MT1_THREAD_RDWR
 ){

548 
aVÆue
[50];

549 
aRnd
[25];

551 
iKey
 = (
	`ã°P∫gVÆue
(
iP∫g
++Ë% 
p
->
∑øm
.
nKey
);

552 
	`ã°P∫gSåög
(
iP∫g
, 
aRnd
, (aRnd));

553 
iP∫g
 +(
aRnd
);

554 
	`¢¥ötf
(
aVÆue
, ◊VÆue), "%d.%s", 
iThªad
, 
aRnd
);

555 
nWrôe
 +
	`dbWrôeO≥øti⁄
(&
p
->
∑øm
, 
pDb
, 
iKey
, 
aVÆue
, &
rc
);

558 
	`ã°Clo£
(&
pDb
);

564 if–
rc
 ){

565 
	`ã°ThªadSëResu…
(
pThªadSë
, 
iThªad
, 
rc
, 0);

566 
	`ã°ThªadSëHÆt
(
pThªadSë
);

568 
	`ã°ThªadSëResu…
(
pThªadSë
, 
iThªad
, 0, "r/w: %d/%d", 
nRód
, 
nWrôe
);

570 
	}
}

572 
	$do_ã°_mt1
(

573 c⁄° *
zSy°em
,

574 c⁄° *
zP©ã∫
,

575 *
pRc


577 
Mt1Te°
 
aTe°
[] = {

584 
i
;

586 
i
=0; *
pRc
==0 && i<
	`AºaySize
(
aTe°
); i++){

587 
Mt1Te°
 *
p
 = &
aTe°
[
i
];

588 
bRun
 = 
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
,

590 
zSy°em
, 
p
->
∑øm
.
nF™out
,Ö->∑øm.
nKey
,

591 
p
->
nMs
,Ö->
nRódwrôe
,Ö->
nFa°Ródî
,Ö->
nSlowRódî


593 if–
bRun
 ){

594 
Te°Db
 *
pDb
;

595 
ThªadSë
 *
pSë
;

596 
iThªad
;

597 
nThªad
;

599 
p
->
zSy°em
 = zSystem;

600 
pDb
 = 
	`ã°O≥n
(
zSy°em
, 1, 
pRc
);

602 
nThªad
 = 
p
->
nRódwrôe
 +Ö->
nFa°Ródî
 +Ö->
nSlowRódî
;

603 
pSë
 = 
	`ã°ThªadInô
(
nThªad
);

604 
iThªad
=0; *
pRc
==0 && iThªad<
nThªad
; iThread++){

605 
	`ã°ThªadLaunch
(
pSë
, 
iThªad
, 
mt1Maö
, (*)
p
);

608 
	`ã°ThªadWaô
(
pSë
, 
p
->
nMs
);

609 
iThªad
=0; *
pRc
==0 && iThªad<
nThªad
; iThread++){

610 *
pRc
 = 
	`ã°ThªadGëResu…
(
pSë
, 
iThªad
, 0);

612 
	`ã°Ca£Föish
(*
pRc
);

614 
iThªad
=0; *
pRc
==0 && iThªad<
nThªad
; iThread++){

615 c⁄° *
zMsg
 = 0;

616 *
pRc
 = 
	`ã°ThªadGëResu…
(
pSë
, 
iThªad
, &
zMsg
);

617 
	`¥ötf
(" Info:Åhªad %d (%d): %s\n", 
iThªad
, *
pRc
, 
zMsg
);

620 
	`ã°ThªadShutdown
(
pSë
);

621 
	`ã°Clo£
(&
pDb
);

624 
	}
}

626 
	$ã°_mt
(

627 c⁄° *
zSy°em
,

628 c⁄° *
zP©ã∫
,

629 *
pRc


631 if–
	`ã°ThªadSuµ‹t
()==0 ) ;

632 
	`do_ã°_mt1
(
zSy°em
, 
zP©ã∫
, 
pRc
);

633 
	}
}

	@lsm-test/lsmtest6.c

2 
	~"lsmã°.h
"

4 
OomTe°
 
	tOomTe°
;

5 
	sOomTe°
 {

6 
lsm_ív
 *
	mpEnv
;

7 
	miNext
;

8 
	mnFaû
;

9 
	mbE«bÀ
;

10 
	mrc
;

13 
	$ã°OomSèπ
(
OomTe°
 *
p
){

14 
	`mem£t
(
p
, 0, (
OomTe°
));

15 
p
->
iNext
 = 1;

16 
p
->
bE«bÀ
 = 1;

17 
p
->
nFaû
 = 1;

18 
p
->
pEnv
 = 
	`tdb_lsm_ív
();

19 
	}
}

21 
	$xOomHook
(
OomTe°
 *
p
){

22 
p
->
nFaû
++;

23 
	}
}

25 
	$ã°OomC⁄töue
(
OomTe°
 *
p
){

26 if–
p
->
rc
!=0 || (p->
iNext
>1 &&Ö->
nFaû
==0) ){

29 
p
->
nFaû
 = 0;

30 
	`ã°MÆlocOom
(
p
->
pEnv
,Ö->
iNext
, 0, ((*)(*))
xOomHook
, (*)p);

32 
	}
}

34 
	$ã°OomE«bÀ
(
OomTe°
 *
p
, 
bE«bÀ
){

35 
p
->
bE«bÀ
 = bEnable;

36 
	`ã°MÆlocOomE«bÀ
(
p
->
pEnv
, 
bE«bÀ
);

37 
	}
}

39 
	$ã°OomNext
(
OomTe°
 *
p
){

40 
p
->
iNext
++;

41 
	}
}

43 
	$ã°OomHô
(
OomTe°
 *
p
){

44  (
p
->
nFaû
>0);

45 
	}
}

47 
	$ã°OomFöish
(
OomTe°
 *
p
){

48  
p
->
rc
;

49 
	}
}

51 
	$ã°OomAs£π
(
OomTe°
 *
p
, 
bVÆ
){

52 if–
bVÆ
==0 ){

53 
	`ã°_Áûed
();

54 
p
->
rc
 = 1;

56 
	}
}

63 
	$ã°OomAs£πRc
(
OomTe°
 *
p
, 
rc
){

64 
	`ã°OomAs£π
(
p
, 
rc
==
LSM_OK
 ||Ñc==
LSM_NOMEM
);

65 
	`ã°OomAs£π
(
p
, 
	`ã°OomHô
’)==(
rc
==
LSM_NOMEM
Ë||Ö->
bE«bÀ
==0 );

66 
	}
}

68 
	$ã°OomO≥n
(

69 
OomTe°
 *
pOom
,

70 c⁄° *
zName
,

71 
lsm_db
 **
µDb
,

72 *
pRc


74 if–*
pRc
==
LSM_OK
 ){

75 
rc
;

76 
rc
 = 
	`lsm_√w
(
	`tdb_lsm_ív
(), 
µDb
);

77 if–
rc
==
LSM_OK
 )Ñ¯
	`lsm_›í
(*
µDb
, 
zName
);

78 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

79 *
pRc
 = 
rc
;

81 
	}
}

83 
	$ã°OomFëch
(

84 
OomTe°
 *
pOom
,

85 
lsm_db
 *
pDb
,

86 *
pKey
, 
nKey
,

87 *
pVÆ
, 
nVÆ
,

88 *
pRc


90 
	`ã°OomAs£πRc
(
pOom
, *
pRc
);

91 if–*
pRc
==
LSM_OK
 ){

92 
lsm_curs‹
 *
pC§
;

93 
rc
;

95 
rc
 = 
	`lsm_c§_›í
(
pDb
, &
pC§
);

96 if–
rc
==
LSM_OK
 )Ñ¯
	`lsm_c§_£ek
(
pC§
, 
pKey
, 
nKey
, 0);

97 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

99 if–
rc
==
LSM_OK
 ){

100 c⁄° *
p
; 
n
;

101 
	`ã°OomAs£π
(
pOom
, 
	`lsm_c§_vÆid
(
pC§
));

103 
rc
 = 
	`lsm_c§_key
(
pC§
, &
p
, &
n
);

104 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

105 
	`ã°OomAs£π
(
pOom
, 
rc
!=
LSM_OK
 || (
n
==
nKey
 && 
	`memcmp
(
pKey
, 
p
,ÇKey)==0) );

108 if–
rc
==
LSM_OK
 ){

109 c⁄° *
p
; 
n
;

110 
	`ã°OomAs£π
(
pOom
, 
	`lsm_c§_vÆid
(
pC§
));

112 
rc
 = 
	`lsm_c§_vÆue
(
pC§
, &
p
, &
n
);

113 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

114 
	`ã°OomAs£π
(
pOom
, 
rc
!=
LSM_OK
 || (
n
==
nVÆ
 && 
	`memcmp
(
pVÆ
, 
p
,ÇVal)==0) );

117 
	`lsm_c§_˛o£
(
pC§
);

118 *
pRc
 = 
rc
;

120 
	}
}

122 
	$ã°OomWrôe
(

123 
OomTe°
 *
pOom
,

124 
lsm_db
 *
pDb
,

125 *
pKey
, 
nKey
,

126 *
pVÆ
, 
nVÆ
,

127 *
pRc


129 
	`ã°OomAs£πRc
(
pOom
, *
pRc
);

130 if–*
pRc
==
LSM_OK
 ){

131 
rc
;

133 
rc
 = 
	`lsm_ö£π
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

134 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

136 *
pRc
 = 
rc
;

138 
	}
}

141 
	$ã°OomFëchSå
(

142 
OomTe°
 *
pOom
,

143 
lsm_db
 *
pDb
,

144 c⁄° *
zKey
,

145 c⁄° *
zVÆ
,

146 *
pRc


148 
nKey
 = 
	`°æí
(
zKey
);

149 
nVÆ
 = 
	`°æí
(
zVÆ
);

150 
	`ã°OomFëch
(
pOom
, 
pDb
, (*)
zKey
, 
nKey
, (*)
zVÆ
, 
nVÆ
, 
pRc
);

151 
	}
}

153 
	$ã°OomFëchD©a
(

154 
OomTe°
 *
pOom
,

155 
lsm_db
 *
pDb
,

156 
D©asour˚
 *
pD©a
,

157 
iKey
,

158 *
pRc


160 *
pKey
; 
nKey
;

161 *
pVÆ
; 
nVÆ
;

162 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

163 
	`ã°OomFëch
(
pOom
, 
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, 
pRc
);

164 
	}
}

166 
	$ã°OomWrôeSå
(

167 
OomTe°
 *
pOom
,

168 
lsm_db
 *
pDb
,

169 c⁄° *
zKey
,

170 c⁄° *
zVÆ
,

171 *
pRc


173 
nKey
 = 
	`°æí
(
zKey
);

174 
nVÆ
 = 
	`°æí
(
zVÆ
);

175 
	`ã°OomWrôe
(
pOom
, 
pDb
, (*)
zKey
, 
nKey
, (*)
zVÆ
, 
nVÆ
, 
pRc
);

176 
	}
}

178 
	$ã°OomWrôeD©a
(

179 
OomTe°
 *
pOom
,

180 
lsm_db
 *
pDb
,

181 
D©asour˚
 *
pD©a
,

182 
iKey
,

183 *
pRc


185 *
pKey
; 
nKey
;

186 *
pVÆ
; 
nVÆ
;

187 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

188 
	`ã°OomWrôe
(
pOom
, 
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, 
pRc
);

189 
	}
}

191 
	$ã°OomSˇn
(

192 
OomTe°
 *
pOom
,

193 
lsm_db
 *
pDb
,

194 
bRevî£
,

195 c⁄° *
pKey
, 
nKey
,

196 
nSˇn
,

197 *
pRc


199 if–*
pRc
==0 ){

200 
rc
;

201 
iSˇn
 = 0;

202 
lsm_curs‹
 *
pC§
;

203 (*
xAdv™˚
)(
lsm_curs‹
 *);

206 
rc
 = 
	`lsm_c§_›í
(
pDb
, &
pC§
);

207 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

209 if–
rc
==
LSM_OK
 ){

210 if–
bRevî£
 ){

211 
rc
 = 
	`lsm_c§_£ek
(
pC§
, 
pKey
, 
nKey
, 
LSM_SEEK_LE
);

212 
xAdv™˚
 = 
lsm_c§_¥ev
;

214 
rc
 = 
	`lsm_c§_£ek
(
pC§
, 
pKey
, 
nKey
, 
LSM_SEEK_GE
);

215 
xAdv™˚
 = 
lsm_c§_√xt
;

218 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

220  
rc
==
LSM_OK
 && 
	`lsm_c§_vÆid
(
pC§
Ë&& 
iSˇn
<
nSˇn
 ){

221 c⁄° *
p
; 
n
;

223 
rc
 = 
	`lsm_c§_key
(
pC§
, &
p
, &
n
);

224 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

225 if–
rc
==
LSM_OK
 ){

226 
rc
 = 
	`lsm_c§_vÆue
(
pC§
, &
p
, &
n
);

227 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

229 if–
rc
==
LSM_OK
 ){

230 
rc
 = 
	`xAdv™˚
(
pC§
);

231 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

233 
iSˇn
++;

236 
	`lsm_c§_˛o£
(
pC§
);

237 *
pRc
 = 
rc
;

239 
	}
}

241 
	#LSMTEST6_TESTDB
 "ã°db.lsm"

	)

243 
	~<uni°d.h
>

244 
	~<sys/ty≥s.h
>

245 
	~<sys/°©.h
>

246 
	~<f˙é.h
>

248 
	$ã°DñëeLsmdb
(c⁄° *
zFûe
){

249 *
zLog
 = 
	`ã°MÆlocPrötf
("%s-log", 
zFûe
);

250 *
zShm
 = 
	`ã°MÆlocPrötf
("%s-shm", 
zFûe
);

251 
	`u∆ök
(
zFûe
);

252 
	`u∆ök
(
zLog
);

253 
	`u∆ök
(
zShm
);

254 
	`ã°Fªe
(
zLog
);

255 
	`ã°Fªe
(
zShm
);

256 
	}
}

258 
	$c›y_fûe
(c⁄° *
zFrom
, c⁄° *
zTo
){

260 if–
	`ac˚ss
(
zFrom
, 
F_OK
) ){

261 
	`u∆ök
(
zTo
);

263 
fd1
;

264 
fd2
;

265 
off_t
 
sz
;

266 
off_t
 
i
;

267 
°©
 
buf
;

268 
u8
 *
aBuf
;

270 
fd1
 = 
	`›í
(
zFrom
, 
O_RDONLY
, 0644);

271 
fd2
 = 
	`›í
(
zTo
, 
O_RDWR
 | 
O_CREAT
, 0644);

273 
	`f°©
(
fd1
, &
buf
);

274 
sz
 = 
buf
.
°_size
;

275 
	`·runˇã
(
fd2
, 
sz
);

277 
aBuf
 = 
	`ã°MÆloc
(4096);

278 
i
=0; i<
sz
; i+=4096){

279 
nByã
 = 
	`MIN
(4096, 
sz
 - 
i
);

280 
	`ªad
(
fd1
, 
aBuf
, 
nByã
);

281 
	`wrôe
(
fd2
, 
aBuf
, 
nByã
);

283 
	`ã°Fªe
(
aBuf
);

285 
	`˛o£
(
fd1
);

286 
	`˛o£
(
fd2
);

288 
	}
}

290 
	$ã°C›yLsmdb
(c⁄° *
zFrom
, c⁄° *
zTo
){

291 *
zLog1
 = 
	`ã°MÆlocPrötf
("%s-log", 
zFrom
);

292 *
zLog2
 = 
	`ã°MÆlocPrötf
("%s-log", 
zTo
);

293 *
zShm1
 = 
	`ã°MÆlocPrötf
("%s-shm", 
zFrom
);

294 *
zShm2
 = 
	`ã°MÆlocPrötf
("%s-shm", 
zTo
);

296 
	`u∆ök
(
zShm2
);

297 
	`u∆ök
(
zLog2
);

298 
	`u∆ök
(
zTo
);

299 
	`c›y_fûe
(
zFrom
, 
zTo
);

300 
	`c›y_fûe
(
zLog1
, 
zLog2
);

301 
	`c›y_fûe
(
zShm1
, 
zShm2
);

303 
	`ã°Fªe
(
zLog1
);Åe°Fªe(
zLog2
);Åe°Fªe(
zShm1
);Åe°Fªe(
zShm2
);

304 
	}
}

316 
	$ã°SaveDb
(c⁄° *
zFûe
, c⁄° *
zAux
){

317 *
zLog
 = 
	`ã°MÆlocPrötf
("%s-%s", 
zFûe
, 
zAux
);

318 *
zFûeSave
 = 
	`ã°MÆlocPrötf
("%s-ßve", 
zFûe
);

319 *
zLogSave
 = 
	`ã°MÆlocPrötf
("%s-%s-ßve", 
zFûe
, 
zAux
);

321 
	`u∆ök
(
zFûeSave
);

322 
	`u∆ök
(
zLogSave
);

323 
	`c›y_fûe
(
zFûe
, 
zFûeSave
);

324 
	`c›y_fûe
(
zLog
, 
zLogSave
);

326 
	`ã°Fªe
(
zLog
);Åe°Fªe(
zFûeSave
);Åe°Fªe(
zLogSave
);

327 
	}
}

337 
	$ã°Re°‹eDb
(c⁄° *
zFûe
, c⁄° *
zAux
){

338 *
zLog
 = 
	`ã°MÆlocPrötf
("%s-%s", 
zFûe
, 
zAux
);

339 *
zFûeSave
 = 
	`ã°MÆlocPrötf
("%s-ßve", 
zFûe
);

340 *
zLogSave
 = 
	`ã°MÆlocPrötf
("%s-%s-ßve", 
zFûe
, 
zAux
);

342 
	`c›y_fûe
(
zFûeSave
, 
zFûe
);

343 
	`c›y_fûe
(
zLogSave
, 
zLog
);

345 
	`ã°Fªe
(
zLog
);Åe°Fªe(
zFûeSave
);Åe°Fªe(
zLogSave
);

346 
	}
}

349 
	$lsmWrôeSå
(
lsm_db
 *
pDb
, c⁄° *
zKey
, c⁄° *
zVÆ
){

350 
nKey
 = 
	`°æí
(
zKey
);

351 
nVÆ
 = 
	`°æí
(
zVÆ
);

352  
	`lsm_ö£π
(
pDb
, (*)
zKey
, 
nKey
, (*)
zVÆ
, 
nVÆ
);

353 
	}
}

355 
	$£tup_dñëe_db
(){

356 
	`ã°DñëeLsmdb
(
LSMTEST6_TESTDB
);

357 
	}
}

371 
	$£tup_p›uœã_db
(){

372 c⁄° *
azSå
[] = {

382 
rc
;

383 
ii
;

384 
lsm_db
 *
pDb
;

386 
	`ã°DñëeLsmdb
(
LSMTEST6_TESTDB
);

388 
rc
 = 
	`lsm_√w
(
	`tdb_lsm_ív
(), &
pDb
);

389 if–
rc
==
LSM_OK
 )Ñ¯
	`lsm_›í
(
pDb
, 
LSMTEST6_TESTDB
);

391 
ii
=0; 
rc
==
LSM_OK
 && ii<
	`AºaySize
(
azSå
); ii+=2){

392 
rc
 = 
	`lsmWrôeSå
(
pDb
, 
azSå
[
ii
],ázStr[ii+1]);

394 
	`lsm_˛o£
(
pDb
);

396 
	`ã°SaveDb
(
LSMTEST6_TESTDB
, "log");

397 
	`as£π
–
rc
==
LSM_OK
 );

398 
	}
}

400 
D©asour˚
 *
	$gëD©asour˚
(){

401 c⁄° 
D©asour˚De‚
 
de‚
 = { 
TEST_DATASOURCE_RANDOM
, 10, 15, 200, 250 };

402  
	`ã°D©asour˚New
(&
de‚
);

403 
	}
}

413 
	$£tup_p›uœã_db2
(){

414 
D©asour˚
 *
pD©a
;

415 
ii
;

416 
rc
;

417 
nBlocksize
 = 64*1024;

418 
nPagesize
 = 1024;

419 
nWrôebuf„r
 = 4*1024;

420 
lsm_db
 *
pDb
;

422 
	`ã°DñëeLsmdb
(
LSMTEST6_TESTDB
);

423 
rc
 = 
	`lsm_√w
(
	`tdb_lsm_ív
(), &
pDb
);

424 if–
rc
==
LSM_OK
 )Ñ¯
	`lsm_›í
(
pDb
, 
LSMTEST6_TESTDB
);

426 
	`lsm_c⁄fig
(
pDb
, 
LSM_CONFIG_BLOCK_SIZE
, &
nBlocksize
);

427 
	`lsm_c⁄fig
(
pDb
, 
LSM_CONFIG_PAGE_SIZE
, &
nPagesize
);

428 
	`lsm_c⁄fig
(
pDb
, 
LSM_CONFIG_AUTOFLUSH
, &
nWrôebuf„r
);

430 
pD©a
 = 
	`gëD©asour˚
();

431 
ii
=0; 
rc
==
LSM_OK
 && ii<5000; ii++){

432 *
pKey
; 
nKey
;

433 *
pVÆ
; 
nVÆ
;

434 
	`ã°D©asour˚E¡ry
(
pD©a
, 
ii
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

435 
	`lsm_ö£π
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

437 
	`ã°D©asour˚Fªe
(
pD©a
);

438 
	`lsm_˛o£
(
pDb
);

440 
	`ã°SaveDb
(
LSMTEST6_TESTDB
, "log");

441 
	`as£π
–
rc
==
LSM_OK
 );

442 
	}
}

447 
	$sim∂e_oom_1
(
OomTe°
 *
pOom
){

448 
rc
;

449 
lsm_db
 *
pDb
;

451 
rc
 = 
	`lsm_√w
(
	`tdb_lsm_ív
(), &
pDb
);

452 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

454 
	`lsm_˛o£
(
pDb
);

455 
	}
}

460 
	$sim∂e_oom_2
(
OomTe°
 *
pOom
){

461 
rc
;

462 
lsm_db
 *
pDb
;

464 
rc
 = 
	`lsm_√w
(
	`tdb_lsm_ív
(), &
pDb
);

465 if–
rc
==
LSM_OK
 ){

466 
rc
 = 
	`lsm_›í
(
pDb
, "testdb.lsm");

468 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

470 
	`lsm_˛o£
(
pDb
);

471 
	}
}

476 
	$sim∂e_oom_3
(
OomTe°
 *
pOom
){

477 
rc
 = 
LSM_OK
;

478 
lsm_db
 *
pDb
;

480 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb
, &
rc
);

482 
	`ã°OomFëchSå
(
pOom
, 
pDb
, "four", "sixãí", &
rc
);

483 
	`ã°OomFëchSå
(
pOom
, 
pDb
, "£ví", "fouπynöe", &
rc
);

484 
	`ã°OomFëchSå
(
pOom
, 
pDb
, "⁄e", "⁄e", &
rc
);

485 
	`ã°OomFëchSå
(
pOom
, 
pDb
, "eight", "sixtyfour", &
rc
);

487 
	`lsm_˛o£
(
pDb
);

488 
	}
}

493 
	$sim∂e_oom_4
(
OomTe°
 *
pOom
){

494 
rc
 = 
LSM_OK
;

495 
lsm_db
 *
pDb
;

497 
	`ã°DñëeLsmdb
(
LSMTEST6_TESTDB
);

498 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb
, &
rc
);

500 
	`ã°OomWrôeSå
(
pOom
, 
pDb
, "123", "⁄ëwŸhªe", &
rc
);

501 
	`ã°OomWrôeSå
(
pOom
, 
pDb
, "456", "fourfivesix", &
rc
);

502 
	`ã°OomWrôeSå
(
pOom
, 
pDb
, "789", "£víeighäöe", &
rc
);

503 
	`ã°OomWrôeSå
(
pOom
, 
pDb
, "123", "ã√Àvítwñve", &
rc
);

504 
	`ã°OomWrôeSå
(
pOom
, 
pDb
, "456", "fouπìnfi·ìnsixãí", &
rc
);

506 
	`lsm_˛o£
(
pDb
);

507 
	}
}

509 
	$sim∂e_oom_5
(
OomTe°
 *
pOom
){

510 
D©asour˚
 *
pD©a
 = 
	`gëD©asour˚
();

511 
rc
 = 
LSM_OK
;

512 
lsm_db
 *
pDb
;

514 
	`ã°Re°‹eDb
(
LSMTEST6_TESTDB
, "log");

515 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb
, &
rc
);

517 
	`ã°OomFëchD©a
(
pOom
, 
pDb
, 
pD©a
, 3333, &
rc
);

518 
	`ã°OomFëchD©a
(
pOom
, 
pDb
, 
pD©a
, 0, &
rc
);

519 
	`ã°OomFëchD©a
(
pOom
, 
pDb
, 
pD©a
, 4999, &
rc
);

521 
	`lsm_˛o£
(
pDb
);

522 
	`ã°D©asour˚Fªe
(
pD©a
);

523 
	}
}

525 
	$sim∂e_oom_6
(
OomTe°
 *
pOom
){

526 
D©asour˚
 *
pD©a
 = 
	`gëD©asour˚
();

527 
rc
 = 
LSM_OK
;

528 
lsm_db
 *
pDb
;

530 
	`ã°Re°‹eDb
(
LSMTEST6_TESTDB
, "log");

531 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb
, &
rc
);

533 
	`ã°OomWrôeD©a
(
pOom
, 
pDb
, 
pD©a
, 5000, &
rc
);

534 
	`ã°OomWrôeD©a
(
pOom
, 
pDb
, 
pD©a
, 5001, &
rc
);

535 
	`ã°OomWrôeD©a
(
pOom
, 
pDb
, 
pD©a
, 5002, &
rc
);

536 
	`ã°OomFëchD©a
(
pOom
, 
pDb
, 
pD©a
, 5001, &
rc
);

537 
	`ã°OomFëchD©a
(
pOom
, 
pDb
, 
pD©a
, 1234, &
rc
);

539 
	`lsm_˛o£
(
pDb
);

540 
	`ã°D©asour˚Fªe
(
pD©a
);

541 
	}
}

543 
	$sim∂e_oom_7
(
OomTe°
 *
pOom
){

544 
D©asour˚
 *
pD©a
 = 
	`gëD©asour˚
();

545 
rc
 = 
LSM_OK
;

546 
lsm_db
 *
pDb
;

548 
	`ã°Re°‹eDb
(
LSMTEST6_TESTDB
, "log");

549 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb
, &
rc
);

550 
	`ã°OomSˇn
(
pOom
, 
pDb
, 0, "abc", 3, 20, &
rc
);

551 
	`lsm_˛o£
(
pDb
);

552 
	`ã°D©asour˚Fªe
(
pD©a
);

553 
	}
}

555 
	$sim∂e_oom_8
(
OomTe°
 *
pOom
){

556 
D©asour˚
 *
pD©a
 = 
	`gëD©asour˚
();

557 
rc
 = 
LSM_OK
;

558 
lsm_db
 *
pDb
;

559 
	`ã°Re°‹eDb
(
LSMTEST6_TESTDB
, "log");

560 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb
, &
rc
);

561 
	`ã°OomSˇn
(
pOom
, 
pDb
, 1, "xyz", 3, 20, &
rc
);

562 
	`lsm_˛o£
(
pDb
);

563 
	`ã°D©asour˚Fªe
(
pD©a
);

564 
	}
}

571 
	$sim∂e_oom2_1
(
OomTe°
 *
pOom
){

572 c⁄° 
nRec‹d
 = 100;

573 c⁄° 
nIns
 = 10;

575 
D©asour˚
 *
pD©a
 = 
	`gëD©asour˚
();

576 
rc
 = 
LSM_OK
;

577 
lsm_db
 *
pDb1
;

578 
lsm_db
 *
pDb2
;

579 
i
;

581 
	`ã°DñëeLsmdb
(
LSMTEST6_TESTDB
);

585 
	`ã°OomE«bÀ
(
pOom
, 0);

586 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb1
, &
rc
);

587 
	`ã°OomO≥n
(
pOom
, 
LSMTEST6_TESTDB
, &
pDb2
, &
rc
);

588 
i
=0; i<
nRec‹d
; i++){

589 
	`ã°OomWrôeD©a
(
pOom
, 
pDb1
, 
pD©a
, 
i
, &
rc
);

591 
	`ã°OomE«bÀ
(
pOom
, 1);

592 
	`as£π
–
rc
==0 );

595 
i
=
nRec‹d
; i<nRec‹d+
nIns
; i++){

596 
	`ã°OomWrôeD©a
(
pOom
, 
pDb1
, 
pD©a
, 
i
, &
rc
);

597 if–
rc
 ) ;

599 
	`ã°OomAs£πRc
(
pOom
, 
rc
);

603 
	`ã°OomE«bÀ
(
pOom
, 0);

604 
rc
 = 0;

605 ; 
i
<
nRec‹d
+
nIns
 && 
rc
==0; i++){

606 
	`ã°OomWrôeD©a
(
pOom
, 
pDb2
, 
pD©a
, 
i
, &
rc
);

608 
i
=0; i<
nRec‹d
+
nIns
; i++Ë
	`ã°OomFëchD©a
(
pOom
, 
pDb2
, 
pD©a
, i, &
rc
);

609 
	`ã°OomE«bÀ
(
pOom
, 1);

611 
	`lsm_˛o£
(
pDb1
);

612 
	`lsm_˛o£
(
pDb2
);

613 
	`ã°D©asour˚Fªe
(
pD©a
);

614 
	}
}

617 
	$do_ã°_oom1
(c⁄° *
zP©ã∫
, *
pRc
){

618 
	sSim∂eOom
 {

619 c⁄° *
zName
;

620 (*
xSëup
)();

621 (*
xFunc
)(
OomTe°
 *);

622 } 
aSim∂e
[] = {

623 { "oom1.lsm.1", 
£tup_dñëe_db
, 
sim∂e_oom_1
 },

624 { "oom1.lsm.2", 
£tup_dñëe_db
, 
sim∂e_oom_2
 },

625 { "oom1.lsm.3", 
£tup_p›uœã_db
, 
sim∂e_oom_3
 },

626 { "oom1.lsm.4", 
£tup_dñëe_db
, 
sim∂e_oom_4
 },

627 { "oom1.lsm.5", 
£tup_p›uœã_db2
, 
sim∂e_oom_5
 },

628 { "oom1.lsm.6", 
£tup_p›uœã_db2
, 
sim∂e_oom_6
 },

629 { "oom1.lsm.7", 
£tup_p›uœã_db2
, 
sim∂e_oom_7
 },

630 { "oom1.lsm.8", 
£tup_p›uœã_db2
, 
sim∂e_oom_8
 },

632 { "oom2.lsm.1", 
£tup_dñëe_db
, 
sim∂e_oom2_1
 },

634 
i
;

636 
i
=0; i<
	`AºaySize
(
aSim∂e
); i++){

637 if–*
pRc
==0 && 
	`ã°Ca£Begö
’Rc, 
zP©ã∫
, "%s", 
aSim∂e
[
i
].
zName
) ){

638 
OomTe°
 
t
;

640 if–
aSim∂e
[
i
].
xSëup
 ){

641 
aSim∂e
[
i
].
	`xSëup
();

644 
	`ã°OomSèπ
(&
t
); 
	`ã°OomC⁄töue
(&t); 
	`ã°OomNext
(&t)){

645 
aSim∂e
[
i
].
	`xFunc
(&
t
);

648 
	`¥ötf
("(%d inje˘i⁄s).", 
t
.
iNext
-2);

649 
	`ã°Ca£Föish
–(*
pRc
 = 
	`ã°OomFöish
(&
t
)) );

650 
	`ã°MÆlocOom
(
	`tdb_lsm_ív
(), 0, 0, 0, 0);

653 
	}
}

655 
	$ã°_oom
(

656 c⁄° *
zP©ã∫
,

657 *
pRc


659 
	`do_ã°_oom1
(
zP©ã∫
, 
pRc
);

660 
	}
}

	@lsm-test/lsmtest7.c

3 
	~"lsmã°.h
"

19 
	$do_ã°_≠i1_lsm
(
lsm_db
 *
pDb
, *
pRc
){

20 
ªt
;

21 
lsm_curs‹
 *
pC§
;

22 
lsm_curs‹
 *
pC§2
;

23 
nKey
;

24 c⁄° *
pKey
;

26 
ªt
 = 
	`lsm_c§_›í
(
pDb
, &
pC§
);

27 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

29 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

30 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

31 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

32 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

34 
ªt
 = 
	`lsm_c§_£ek
(
pC§
, "jjj", 3, 
LSM_SEEK_GE
);

35 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

36 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

37 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

38 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

39 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

41 
ªt
 = 
	`lsm_c§_£ek
(
pC§
, "jjj", 3, 
LSM_SEEK_LE
);

42 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

43 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

44 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

45 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

46 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

48 
ªt
 = 
	`lsm_c§_£ek
(
pC§
, "jjj", 3, 
LSM_SEEK_LEFAST
);

49 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

50 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

51 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

52 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

53 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

55 
ªt
 = 
	`lsm_c§_key
(
pC§
, &
pKey
, &
nKey
);

56 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

58 
ªt
 = 
	`lsm_c§_›í
(
pDb
, &
pC§2
);

59 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

61 
ªt
 = 
	`lsm_c§_£ek
(
pC§2
, 
pKey
, 
nKey
, 
LSM_SEEK_EQ
);

62 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

63 
	`ã°Com∑ªI¡
(1, 
	`lsm_c§_vÆid
(
pC§2
), 
pRc
);

64 
ªt
 = 
	`lsm_c§_√xt
(
pC§2
);

65 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

66 
ªt
 = 
	`lsm_c§_¥ev
(
pC§2
);

67 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

69 
	`lsm_c§_˛o£
(
pC§2
);

71 
ªt
 = 
	`lsm_c§_fú°
(
pC§
);

72 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

73 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

74 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

75 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

76 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

78 
ªt
 = 
	`lsm_c§_œ°
(
pC§
);

79 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

80 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

81 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

82 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

83 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

85 
ªt
 = 
	`lsm_c§_fú°
(
pC§
);

86  
	`lsm_c§_vÆid
(
pC§
) ){

87 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

88 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

90 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

91 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

92 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

93 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

95 
ªt
 = 
	`lsm_c§_œ°
(
pC§
);

96  
	`lsm_c§_vÆid
(
pC§
) ){

97 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

98 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

100 
ªt
 = 
	`lsm_c§_¥ev
(
pC§
);

101 
	`ã°Com∑ªI¡
(
LSM_OK
, 
ªt
, 
pRc
);

102 
ªt
 = 
	`lsm_c§_√xt
(
pC§
);

103 
	`ã°Com∑ªI¡
(
LSM_MISUSE
, 
ªt
, 
pRc
);

105 
	`lsm_c§_˛o£
(
pC§
);

106 
	}
}

108 
	$do_ã°_≠i1
(c⁄° *
zP©ã∫
, *
pRc
){

109 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "api1.lsm") ){

110 c⁄° 
D©asour˚De‚
 
de‚
 = { 
TEST_DATASOURCE_RANDOM
, 10, 15, 200, 250 };

111 
D©asour˚
 *
pD©a
;

112 
Te°Db
 *
pDb
;

113 
rc
 = 0;

115 
pDb
 = 
	`ã°O≥n
("lsm_lomem", 1, &
rc
);

116 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

117 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 0, 1000, 
pRc
);

119 
	`do_ã°_≠i1_lsm
(
	`tdb_lsm
(
pDb
), 
pRc
);

121 
	`ã°D©asour˚Fªe
(
pD©a
);

122 
	`ã°Clo£
(&
pDb
);

124 
	`ã°Ca£Föish
(*
pRc
);

126 
	}
}

128 
lsm_db
 *
	$√wLsmC⁄√˘i⁄
(

129 c⁄° *
zDb
,

130 
nPgsz
,

131 
nBlksz
,

132 *
pRc


134 
lsm_db
 *
db
 = 0;

135 if–*
pRc
==0 ){

136 
n1
 = 
nPgsz
;

137 
n2
 = 
nBlksz
;

138 *
pRc
 = 
	`lsm_√w
(
	`tdb_lsm_ív
(), &
db
);

139 if–*
pRc
==0 ){

140 if–
n1
 ) 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_PAGE_SIZE
, &n1);

141 if–
n2
 ) 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_BLOCK_SIZE
, &n2);

142 *
pRc
 = 
	`lsm_›í
(
db
, "testdb.lsm");

145  
db
;

146 
	}
}

148 
	$ã°Pagesize
(
lsm_db
 *
db
, 
nPgsz
, 
nBlksz
, *
pRc
){

149 if–*
pRc
==0 ){

150 
n1
 = 0;

151 
n2
 = 0;

153 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_PAGE_SIZE
, &
n1
);

154 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_BLOCK_SIZE
, &
n2
);

156 
	`ã°Com∑ªI¡
(
n1
, 
nPgsz
, 
pRc
);

157 
	`ã°Com∑ªI¡
(
n2
, 
nBlksz
, 
pRc
);

159 
	}
}

167 
	$do_ã°_≠i2
(c⁄° *
zP©ã∫
, *
pRc
){

168 if–*
pRc
==0 && 
	`ã°Ca£Begö
’Rc, 
zP©ã∫
, "api2.lsm") ){

169 
lsm_db
 *
db1
 = 0;

170 
lsm_db
 *
db2
 = 0;

172 
	`ã°DñëeLsmdb
("testdb.lsm");

173 
db1
 = 
	`√wLsmC⁄√˘i⁄
("ã°db.lsm", 0, 0, 
pRc
);

174 
	`ã°Pagesize
(
db1
, 4096, 2*1024*1024, 
pRc
);

175 
db2
 = 
	`√wLsmC⁄√˘i⁄
("ã°db.lsm", 1024, 64*1024, 
pRc
);

176 
	`ã°Pagesize
(
db2
, 4096, 2*1024*1024, 
pRc
);

177 
	`lsm_˛o£
(
db1
);

178 
	`lsm_˛o£
(
db2
);

180 
	`ã°DñëeLsmdb
("testdb.lsm");

181 
db1
 = 
	`√wLsmC⁄√˘i⁄
("ã°db.lsm", 1024, 64*1024, 
pRc
);

182 
	`ã°Pagesize
(
db1
, 1024, 64*1024, 
pRc
);

183 
db2
 = 
	`√wLsmC⁄√˘i⁄
("ã°db.lsm", 0, 0, 
pRc
);

184 
	`ã°Pagesize
(
db2
, 1024, 64*1024, 
pRc
);

185 
	`lsm_˛o£
(
db1
);

186 
	`lsm_˛o£
(
db2
);

188 
	`ã°DñëeLsmdb
("testdb.lsm");

189 
db1
 = 
	`√wLsmC⁄√˘i⁄
("ã°db.lsm", 8192, 1*1024*1024, 
pRc
);

190 
	`ã°Pagesize
(
db1
, 8192, 1*1024*1024, 
pRc
);

191 
db2
 = 
	`√wLsmC⁄√˘i⁄
("ã°db.lsm", 1024, 64*1024, 
pRc
);

192 
	`ã°Pagesize
(
db2
, 8192, 1*1024*1024, 
pRc
);

193 
	`lsm_˛o£
(
db1
);

194 
	`lsm_˛o£
(
db2
);

196 
	`ã°Ca£Föish
(*
pRc
);

198 
	}
}

200 
	$ã°_≠i
(

201 c⁄° *
zP©ã∫
,

202 *
pRc


204 
	`do_ã°_≠i1
(
zP©ã∫
, 
pRc
);

205 
	`do_ã°_≠i2
(
zP©ã∫
, 
pRc
);

206 
	}
}

	@lsm-test/lsmtest8.c

13 
	~"lsmI¡.h
"

15 
	~"lsmã°.h
"

17 
SëupSãp
 
	tSëupSãp
;

18 
	sSëupSãp
 {

19 
	mbFlush
;

20 
	miInsSèπ
;

21 
	mnIns
;

22 
	miDñSèπ
;

23 
	mnDñ
;

26 
	$doSëupSãp
(

27 
Te°Db
 *
pDb
,

28 
D©asour˚
 *
pD©a
,

29 c⁄° 
SëupSãp
 *
pSãp
,

30 *
pRc


32 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
pSãp
->
iInsSèπ
,ÖSãp->
nIns
, 
pRc
);

33 
	`ã°DñëeD©asour˚R™ge
(
pDb
, 
pD©a
, 
pSãp
->
iDñSèπ
,ÖSãp->
nDñ
, 
pRc
);

34 if–*
pRc
==0 ){

35 
nSave
 = -1;

36 
nBuf
 = 64;

37 
lsm_db
 *
db
 = 
	`tdb_lsm
(
pDb
);

39 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_AUTOFLUSH
, &
nSave
);

40 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_AUTOFLUSH
, &
nBuf
);

41 
	`lsm_begö
(
db
, 1);

42 
	`lsm_commô
(
db
, 0);

43 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_AUTOFLUSH
, &
nSave
);

45 *
pRc
 = 
	`lsm_w‹k
(
db
, 0, 0, 0);

46 if–*
pRc
==0 ){

47 *
pRc
 = 
	`lsm_checkpoöt
(
db
, 0);

50 
	}
}

52 
	$doSëupSãpAºay
(

53 
Te°Db
 *
pDb
,

54 
D©asour˚
 *
pD©a
,

55 c⁄° 
SëupSãp
 *
aSãp
,

56 
nSãp


58 
i
;

59 
i
=0; i<
nSãp
; i++){

60 
rc
 = 0;

61 
	`doSëupSãp
(
pDb
, 
pD©a
, &
aSãp
[
i
], &
rc
);

62 
	`as£π
–
rc
==0 );

64 
	}
}

66 
	$£tupD©aba£1
(
Te°Db
 *
pDb
, 
D©asour˚
 **
µD©a
){

67 c⁄° 
SëupSãp
 
aSãp
[] = {

72 c⁄° 
D©asour˚De‚
 
de‚
 = {
TEST_DATASOURCE_RANDOM
, 12, 16, 100, 500};

73 
D©asour˚
 *
pD©a
;

75 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

76 
	`doSëupSãpAºay
(
pDb
, 
pD©a
, 
aSãp
, 
	`AºaySize
(aStep));

77 if–
µD©a
 ){

78 *
µD©a
 = 
pD©a
;

80 
	`ã°D©asour˚Fªe
(
pD©a
);

82 
	}
}

84 
	~<°dio.h
>

85 
	$ã°RódFûe
(c⁄° *
zFûe
, 
iOff
, *
pOut
, 
nByã
, *
pRc
){

86 if–*
pRc
==0 ){

87 
FILE
 *
fd
;

88 
fd
 = 
	`f›í
(
zFûe
, "r");

89 if–
fd
==0 ){

90 *
pRc
 = 1;

92 if–0!=
	`f£ek
(
fd
, 
iOff
, 
SEEK_SET
) ){

93 *
pRc
 = 1;

95 if–
nByã
!=
	`‰ód
(
pOut
, 1,ÇByã, 
fd
) ){

96 *
pRc
 = 1;

99 
	`f˛o£
(
fd
);

102 
	}
}

104 
	$ã°WrôeFûe
(

105 c⁄° *
zFûe
,

106 
iOff
,

107 *
pOut
,

108 
nByã
,

109 *
pRc


111 if–*
pRc
==0 ){

112 
FILE
 *
fd
;

113 
fd
 = 
	`f›í
(
zFûe
, "r+");

114 if–
fd
==0 ){

115 *
pRc
 = 1;

117 if–0!=
	`f£ek
(
fd
, 
iOff
, 
SEEK_SET
) ){

118 *
pRc
 = 1;

120 if–
nByã
!=
	`fwrôe
(
pOut
, 1,ÇByã, 
fd
) ){

121 *
pRc
 = 1;

124 
	`f˛o£
(
fd
);

127 
	}
}

129 
ShmHódî
 *
	$gëShmHódî
(c⁄° *
zDb
){

130 
rc
 = 0;

131 *
zShm
 = 
	`ã°MÆlocPrötf
("%s-shm", 
zDb
);

132 
ShmHódî
 *
pHdr
;

134 
pHdr
 = 
	`ã°MÆloc
((
ShmHódî
));

135 
	`ã°RódFûe
(
zShm
, 0, (*)
pHdr
, (
ShmHódî
), &
rc
);

136 
	`as£π
–
rc
==0 );

138  
pHdr
;

139 
	}
}

157 
	$doLiveRecovîy
(c⁄° *
zDb
, c⁄° *
zCksum
, *
pRc
){

158 c⁄° 
D©asour˚De‚
 
de‚
 = {
TEST_DATASOURCE_RANDOM
, 20, 25, 100, 500};

159 
D©asour˚
 *
pD©a
;

160 c⁄° *
zC›y
 = "testcopy.lsm";

161 
zCksum2
[
TEST_CKSUM_BYTES
];

162 
Te°Db
 *
pDb
 = 0;

163 
rc
;

165 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

167 
	`ã°C›yLsmdb
(
zDb
, 
zC›y
);

168 
rc
 = 
	`tdb_lsm_›í
("ã°_no_ªcovîy=1", 
zC›y
, 0, &
pDb
);

169 if–
rc
==0 ){

170 
ShmHódî
 *
pHdr
;

171 
lsm_db
 *
db
;

172 
	`ã°CksumD©aba£
(
pDb
, 
zCksum2
);

173 
	`ã°Com∑ªSå
(
zCksum
, 
zCksum2
, &
rc
);

175 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 1, 10, &
rc
);

176 
	`ã°DñëeD©asour˚R™ge
(
pDb
, 
pD©a
, 1, 10, &
rc
);

179 
pHdr
 = 
	`gëShmHódî
(
zC›y
);

180 if–
rc
==0 && 
	`memcmp
(&
pHdr
->
hdr1
, &pHdr->
hdr2
, (pHdr->hdr1)) ){

181 
rc
 = 1;

183 
	`ã°Fªe
(
pHdr
);

185 if–
rc
==0 ){

186 
nBuf
 = 64;

187 
db
 = 
	`tdb_lsm
(
pDb
);

188 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_AUTOFLUSH
, &
nBuf
);

189 
	`lsm_begö
(
db
, 1);

190 
	`lsm_commô
(
db
, 0);

191 
rc
 = 
	`lsm_w‹k
(
db
, 0, 0, 0);

194 
	`ã°CksumD©aba£
(
pDb
, 
zCksum2
);

195 
	`ã°Com∑ªSå
(
zCksum
, 
zCksum2
, &
rc
);

198 
	`ã°D©asour˚Fªe
(
pD©a
);

199 
	`ã°Clo£
(&
pDb
);

200 
	`ã°DñëeLsmdb
(
zC›y
);

201 *
pRc
 = 
rc
;

202 
	}
}

204 
	$doWrôîCøsh1
(*
pRc
){

205 c⁄° 
nWrôe
 = 2000;

206 c⁄° 
nSãp
 = 10;

207 c⁄° 
iWrôeSèπ
 = 20000;

208 
rc
 = 0;

209 
Te°Db
 *
pDb
 = 0;

210 
D©asour˚
 *
pD©a
 = 0;

212 
rc
 = 
	`tdb_lsm_›í
("autow‹k=0", "ã°db.lsm", 1, &
pDb
);

213 if–
rc
==0 ){

214 
iDŸ
 = 0;

215 
zCksum
[
TEST_CKSUM_BYTES
];

216 
i
;

217 
	`£tupD©aba£1
(
pDb
, &
pD©a
);

218 
	`ã°CksumD©aba£
(
pDb
, 
zCksum
);

219 
	`ã°Begö
(
pDb
, 2, &
rc
);

220 
i
=0; 
rc
==0 && i<
nWrôe
; i+=
nSãp
){

221 
	`ã°Ca£Progªss
(
i
, 
nWrôe
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

222 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
iWrôeSèπ
+
i
, 
nSãp
, &
rc
);

223 
	`doLiveRecovîy
("ã°db.lsm", 
zCksum
, &
rc
);

226 
	`ã°Commô
(
pDb
, 0, &
rc
);

227 
	`ã°Clo£
(&
pDb
);

228 
	`ã°D©asour˚Fªe
(
pD©a
);

229 *
pRc
 = 
rc
;

230 
	}
}

236 
	$doWrôîCøsh2
(*
pRc
){

237 
rc
 = 0;

238 
Te°Db
 *
pDb
 = 0;

239 
D©asour˚
 *
pD©a
 = 0;

241 
rc
 = 
	`tdb_lsm_›í
("autow‹k=0", "ã°db.lsm", 1, &
pDb
);

242 if–
rc
==0 ){

243 
ShmHódî
 *
pHdr1
;

244 
ShmHódî
 *
pHdr2
;

245 
zCksum1
[
TEST_CKSUM_BYTES
];

246 
zCksum2
[
TEST_CKSUM_BYTES
];

248 
pHdr1
 = 
	`ã°MÆloc
((
ShmHódî
));

249 
pHdr2
 = 
	`ã°MÆloc
((
ShmHódî
));

250 
	`£tupD©aba£1
(
pDb
, &
pD©a
);

253 
	`ã°RódFûe
("ã°db.lsm-shm", 0, (*)
pHdr1
, (
ShmHódî
), &
rc
);

254 
	`ã°CksumD©aba£
(
pDb
, 
zCksum1
);

257 
	`ã°Begö
(
pDb
, 2, &
rc
);

258 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 30000, 200, &
rc
);

259 
	`ã°Commô
(
pDb
, 0, &
rc
);

262 
	`ã°RódFûe
("ã°db.lsm-shm", 0, (*)
pHdr2
, (
ShmHódî
), &
rc
);

263 
	`ã°CksumD©aba£
(
pDb
, 
zCksum2
);

264 
	`doLiveRecovîy
("ã°db.lsm", 
zCksum2
, &
rc
);

267 
	`mem˝y
(&
pHdr2
->
hdr1
, &
pHdr1
->hdr1, (pHdr1->hdr1));

268 
pHdr2
->
bWrôî
 = 1;

269 
	`ã°WrôeFûe
("ã°db.lsm-shm", 0, (*)
pHdr2
, (
ShmHódî
), &
rc
);

270 
	`doLiveRecovîy
("ã°db.lsm", 
zCksum1
, &
rc
);

273 
	`mem˝y
(&
pHdr2
->
hdr1
, &pHdr2->
hdr2
, (
pHdr1
->hdr1));

274 
	`mem˝y
(&
pHdr2
->
hdr2
, &
pHdr1
->
hdr1
, (pHdr1->hdr1));

275 
pHdr2
->
bWrôî
 = 1;

276 
	`ã°WrôeFûe
("ã°db.lsm-shm", 0, (*)
pHdr2
, (
ShmHódî
), &
rc
);

277 
	`doLiveRecovîy
("ã°db.lsm", 
zCksum2
, &
rc
);

280 
	`mem˝y
(&
pHdr2
->
hdr2
, &pHdr2->
hdr1
, (
pHdr1
->hdr1));

281 
pHdr2
->
hdr1
.
aCksum
[0] = 5;

282 
pHdr2
->
hdr1
.
aCksum
[0] = 6;

283 
pHdr2
->
bWrôî
 = 1;

284 
	`ã°WrôeFûe
("ã°db.lsm-shm", 0, (*)
pHdr2
, (
ShmHódî
), &
rc
);

285 
	`doLiveRecovîy
("ã°db.lsm", 
zCksum2
, &
rc
);

288 
	`mem˝y
(&
pHdr2
->
hdr1
, &pHdr2->
hdr2
, (
pHdr1
->hdr1));

289 
pHdr2
->
hdr2
.
aCksum
[0] = 5;

290 
pHdr2
->
hdr2
.
aCksum
[0] = 6;

291 
pHdr2
->
bWrôî
 = 1;

292 
	`ã°WrôeFûe
("ã°db.lsm-shm", 0, (*)
pHdr2
, (
ShmHódî
), &
rc
);

293 
	`doLiveRecovîy
("ã°db.lsm", 
zCksum2
, &
rc
);

295 
	`ã°Fªe
(
pHdr1
);

296 
	`ã°Fªe
(
pHdr2
);

297 
	`ã°Clo£
(&
pDb
);

300 *
pRc
 = 
rc
;

301 
	}
}

303 
	$do_wrôî_¸ash_ã°
(c⁄° *
zP©ã∫
, *
pRc
){

304 
	sTe°
 {

305 c⁄° *
zName
;

306 (*
xFunc
)(*);

307 } 
aTe°
[] = {

308 { "wrôî¸ash1.lsm", 
doWrôîCøsh1
 },

309 { "wrôî¸ash2.lsm", 
doWrôîCøsh2
 },

311 
i
;

312 
i
=0; i<
	`AºaySize
(
aTe°
); i++){

313 
Te°
 *
p
 = &
aTe°
[
i
];

314 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, 
p
->
zName
) ){

315 
p
->
	`xFunc
(
pRc
);

316 
	`ã°Ca£Föish
(*
pRc
);

320 
	}
}

	@lsm-test/lsmtest9.c

2 
	~"lsmã°.h
"

4 
	#DATA_SEQUENTIAL
 
TEST_DATASOURCE_SEQUENCE


	)

5 
	#DATA_RANDOM
 
TEST_DATASOURCE_RANDOM


	)

7 
D©©e°4
 
	tD©©e°4
;

26 
	sD©©e°4
 {

28 
D©asour˚De‚
 
	mde‚
;

30 
	mnRec
;

31 
	mnRïót
;

32 
	mbRe›í
;

35 
	$doD©aTe°4
(

36 c⁄° *
zSy°em
,

37 
D©©e°4
 *
p
,

38 *
pRc


40 
lsm_db
 *
db
 = 0;

41 
Te°Db
 *
pDb
;

42 
Te°Db
 *
pC⁄åﬁ
;

43 
D©asour˚
 *
pD©a
;

44 
i
;

45 
rc
 = 0;

46 
iDŸ
 = 0;

48 
nRecOn3
 = (
p
->
nRec
 / 3);

49 
iD©a
 = 0;

52 
rc
 = 
	`ã°C⁄åﬁDb
(&
pC⁄åﬁ
);

53 
pDb
 = 
	`ã°O≥n
(
zSy°em
, 1, &
rc
);

54 
pD©a
 = 
	`ã°D©asour˚New
(&
p
->
de‚
);

55 if–
rc
==0 ) 
db
 = 
	`tdb_lsm
(
pDb
);

57 
	`ã°WrôeD©asour˚R™ge
(
pC⁄åﬁ
, 
pD©a
, 
iD©a
, 
nRecOn3
*3, &
rc
);

58 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
iD©a
, 
nRecOn3
*3, &
rc
);

60 
i
=0; 
rc
==0 && i<
p
->
nRïót
; i++){

62 
	`ã°DñëeD©asour˚R™ge
(
pC⁄åﬁ
, 
pD©a
, 
iD©a
, 
nRecOn3
*2, &
rc
);

63 
	`ã°DñëeD©asour˚R™ge
(
pDb
, 
pD©a
, 
iD©a
, 
nRecOn3
*2, &
rc
);

65 if–
db
 ){

66 
nD⁄e
;

68 
	`Ârötf
(
°dîr
, "lsm_w‹k(Ë°¨t...\n"); 
	`fÊush
(stderr);

71 
nD⁄e
 = 0;

72 
rc
 = 
	`lsm_w‹k
(
db
, 1, (1<<30), &
nD⁄e
);

73 } 
rc
==0 && 
nD⁄e
>0 );

75 
	`Ârötf
(
°dîr
, "lsm_w‹k(Ëd⁄e...\n"); 
	`fÊush
(stderr);

79 if–
i
+1<
p
->
nRïót
 ){

80 
iD©a
 +(
nRecOn3
*2);

81 
	`ã°WrôeD©asour˚R™ge
(
pC⁄åﬁ
, 
pD©a
, 
iD©a
+
nRecOn3
,ÇRecOn3*2, &
rc
);

82 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
iD©a
+
nRecOn3
,ÇRecOn3*2, &
rc
);

84 
	`ã°Com∑ªDb
(
pD©a
, 
nRecOn3
*3, 
iD©a
, 
pC⁄åﬁ
, 
pDb
, &
rc
);

87 if–
p
->
bRe›í
 ){

88 
	`ã°Re›í
(&
pDb
, &
rc
);

89 if–
rc
==0 ) 
db
 = 
	`tdb_lsm
(
pDb
);

94 
	`ã°Ca£Progªss
(
i
, 
p
->
nRïót
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

97 
	`ã°Clo£
(&
pDb
);

98 
	`ã°Clo£
(&
pC⁄åﬁ
);

99 
	`ã°D©asour˚Fªe
(
pD©a
);

100 
	`ã°Ca£Föish
(
rc
);

101 *
pRc
 = 
rc
;

102 
	}
}

104 *
	$gëName4
(c⁄° *
zSy°em
, 
D©©e°4
 *
pTe°
){

105 *
zRë
;

106 *
zD©a
;

107 
zD©a
 = 
	`ã°D©asour˚Name
(&
pTe°
->
de‚
);

108 
zRë
 = 
	`ã°MÆlocPrötf
("data4.%s.%s.%d.%d.%d",

109 
zSy°em
, 
zD©a
, 
pTe°
->
nRec
,ÖTe°->
nRïót
,ÖTe°->
bRe›í


111 
	`ã°Fªe
(
zD©a
);

112  
zRë
;

113 
	}
}

115 
	$ã°_d©a_4
(

116 c⁄° *
zSy°em
,

117 c⁄° *
zP©ã∫
,

118 *
pRc


120 
D©©e°4
 
aTe°
[] = {

122 { {
DATA_RANDOM
, 20,25, 500,600}, 10000, 10, 0 },

123 { {
DATA_RANDOM
, 20,25, 500,600}, 10000, 10, 1 },

126 
i
;

128 
i
=0; *
pRc
==
LSM_OK
 && i<
	`AºaySize
(
aTe°
); i++){

129 *
zName
 = 
	`gëName4
(
zSy°em
, &
aTe°
[
i
]);

130 if–
	`ã°Ca£Begö
(
pRc
, 
zP©ã∫
, "%s", 
zName
) ){

131 
	`doD©aTe°4
(
zSy°em
, &
aTe°
[
i
], 
pRc
);

133 
	`ã°Fªe
(
zName
);

135 
	}
}

	@lsm-test/lsmtest_datasource.c

3 
	~"lsmã°.h
"

5 
	sD©asour˚
 {

6 
	meTy≥
;

8 
	mnMöKey
;

9 
	mnMaxKey
;

10 
	mnMöVÆ
;

11 
	mnMaxVÆ
;

13 *
	maKey
;

14 *
	maVÆ
;

17 
	$ã°D©asour˚E¡ry
(

18 
D©asour˚
 *
p
,

19 
iD©a
,

20 **
µKey
, *
≤Key
,

21 **
µVÆ
, *
≤VÆ


23 
	`as£π
–(
µKey
==0)==(
≤Key
==0) );

24 
	`as£π
–(
µVÆ
==0)==(
≤VÆ
==0) );

26 if–
µKey
 ){

27 
nKey
 = 0;

28  
p
->
eTy≥
 ){

29 
TEST_DATASOURCE_RANDOM
: {

30 
nR™ge
 = (1 + 
p
->
nMaxKey
 -Ö->
nMöKey
);

31 
nKey
 = ()–
	`ã°P∫gVÆue
((
u32
)
iD©a
Ë% 
nR™ge
 ) + 
p
->
nMöKey
;

32 
	`ã°P∫gSåög
((
u32
)
iD©a
, 
p
->
aKey
, 
nKey
);

35 
TEST_DATASOURCE_SEQUENCE
:

36 
nKey
 = 
	`•rötf
(
p
->
aKey
, "%012d", 
iD©a
);

39 *
µKey
 = 
p
->
aKey
;

40 *
≤Key
 = 
nKey
;

42 if–
µVÆ
 ){

43 
u32
 
nVÆ
 = 
	`ã°P∫gVÆue
((u32)
iD©a
)%(1+
p
->
nMaxVÆ
-p->
nMöVÆ
)+p->nMinVal;

44 
	`ã°P∫gSåög
((
u32
)~
iD©a
, 
p
->
aVÆ
, ()
nVÆ
);

45 *
µVÆ
 = 
p
->
aVÆ
;

46 *
≤VÆ
 = ()
nVÆ
;

48 
	}
}

50 
	$ã°D©asour˚Fªe
(
D©asour˚
 *
p
){

51 
	`ã°Fªe
(
p
);

52 
	}
}

59 *
	$ã°D©asour˚Name
(c⁄° 
D©asour˚De‚
 *
p
){

60 *
zRë
;

61 
zRë
 = 
	`ã°MÆlocPrötf
("%s.(%d-%d).(%d-%d)",

62 (
p
->
eTy≥
==
TEST_DATASOURCE_SEQUENCE
 ? "seq" : "rnd"),

63 
p
->
nMöKey
,Ö->
nMaxKey
,

64 
p
->
nMöVÆ
,Ö->
nMaxVÆ


66  
zRë
;

67 
	}
}

69 
D©asour˚
 *
	$ã°D©asour˚New
(c⁄° 
D©asour˚De‚
 *
pDe‚
){

70 
D©asour˚
 *
p
;

71 
nMöKey
;

72 
nMaxKey
;

73 
nMöVÆ
;

74 
nMaxVÆ
;

76 if–
pDe‚
->
eTy≥
==
TEST_DATASOURCE_SEQUENCE
 ){

77 
nMöKey
 = 128;

78 
nMaxKey
 = 128;

80 
nMöKey
 = 
	`MAX
(0, 
pDe‚
->nMinKey);

81 
nMaxKey
 = 
	`MAX
(
nMöKey
, 
pDe‚
->nMaxKey);

83 
nMöVÆ
 = 
	`MAX
(0, 
pDe‚
->nMinVal);

84 
nMaxVÆ
 = 
	`MAX
(
nMöVÆ
, 
pDe‚
->nMaxVal);

86 
p
 = (
D©asour˚
 *)
	`ã°MÆloc
((D©asour˚Ë+ 
nMaxKey
 + 
nMaxVÆ
 + 1);

87 
p
->
eTy≥
 = 
pDe‚
->eType;

88 
p
->
nMöKey
 =ÇMinKey;

89 
p
->
nMöVÆ
 =ÇMinVal;

90 
p
->
nMaxKey
 =ÇMaxKey;

91 
p
->
nMaxVÆ
 =ÇMaxVal;

93 
p
->
aKey
 = (*)&p[1];

94 
p
->
aVÆ
 = &p->
aKey
[
nMaxKey
];

95  
p
;

96 
	}
};

	@lsm-test/lsmtest_func.c

2 
	~"lsmã°.h
"

5 
	$do_w‹k
(
nArg
, **
azArg
){

6 
	sO±i⁄
 {

7 c⁄° *
zName
;

8 } 
aO±
 [] = {

14 
lsm_db
 *
pDb
;

15 
rc
;

16 
i
;

17 c⁄° *
zDb
;

18 
nMîge
 = 1;

19 
nKB
 = (1<<30);

21 if–
nArg
==0 ) 
ußge
;

22 
zDb
 = 
azArg
[
nArg
-1];

23 
i
=0; i<(
nArg
-1); i++){

24 
iSñ
;

25 
rc
 = 
	`ã°ArgSñe˘
(
aO±
, "›ti⁄", 
azArg
[
i
], &
iSñ
);

26 if–
rc
 ) Ñc;

27  
iSñ
 ){

29 
i
++;

30 if–
i
==(
nArg
-1ËË
ußge
;

31 
nMîge
 = 
	`©oi
(
azArg
[
i
]);

34 
i
++;

35 if–
i
==(
nArg
-1ËË
ußge
;

36 
nKB
 = 
	`©oi
(
azArg
[
i
]);

41 
rc
 = 
	`lsm_√w
(0, &
pDb
);

42 if–
rc
!=
LSM_OK
 ){

43 
	`ã°PrötEº‹
("lsm_›í():Ñc=%d\n", 
rc
);

45 
rc
 = 
	`lsm_›í
(
pDb
, 
zDb
);

46 if–
rc
!=
LSM_OK
 ){

47 
	`ã°PrötEº‹
("lsm_›í():Ñc=%d\n", 
rc
);

49 
n
 = -1;

50 
	`lsm_c⁄fig
(
pDb
, 
LSM_CONFIG_BLOCK_SIZE
, &
n
);

51 
n
 =Ç*2;

52 
	`lsm_c⁄fig
(
pDb
, 
LSM_CONFIG_AUTOCHECKPOINT
, &
n
);

54 
rc
 = 
	`lsm_w‹k
(
pDb
, 
nMîge
, 
nKB
, 0);

55 if–
rc
!=
LSM_OK
 ){

56 
	`ã°PrötEº‹
("lsm_w‹k():Ñc=%d\n", 
rc
);

60 if–
rc
==
LSM_OK
 ){

61 
rc
 = 
	`lsm_checkpoöt
(
pDb
, 0);

64 
	`lsm_˛o£
(
pDb
);

65  
rc
;

67 
ußge
:

68 
	`ã°PrötUßge
("?-optimize? ?-n N? DATABASE");

70 
	}
}

76 
	$do_show
(
nArg
, **
azArg
){

77 
lsm_db
 *
pDb
;

78 
rc
;

79 c⁄° *
zDb
;

81 
eO±
 = 
LSM_INFO_DB_STRUCTURE
;

82 
iPg
 = 0;

83 
bC⁄fig
 = 0;

84 c⁄° *
zC⁄fig
 = "";

86 
	sO±i⁄
 {

87 c⁄° *
zName
;

88 
bC⁄fig
;

89 
eO±
;

90 } 
aO±
 [] = {

91 { "¨øy", 0, 
LSM_INFO_ARRAY_STRUCTURE
 },

92 { "¨øy-∑ges", 0, 
LSM_INFO_ARRAY_PAGES
 },

93 { "blocksize", 1, 
LSM_CONFIG_BLOCK_SIZE
 },

94 { "∑gesize", 1, 
LSM_CONFIG_PAGE_SIZE
 },

95 { "‰ìli°", 0, 
LSM_INFO_FREELIST
 },

96 { "∑ge-ascii", 0, 
LSM_INFO_PAGE_ASCII_DUMP
 },

97 { "∑ge-hex", 0, 
LSM_INFO_PAGE_HEX_DUMP
 },

101 *
z
 = 0;

102 
iDb
 = 0;

105 if–
nArg
>2 && 
	`°æí
(
azArg
[0])>1

106 && 
	`memcmp
(
azArg
[0], "-c⁄fig", 
	`°æí
(azArg[0]))==0

108 
zC⁄fig
 = 
azArg
[1];

109 
iDb
 = 2;

111 if–
nArg
<(
iDb
+1ËË
ußge
;

113 if–
nArg
>(
iDb
+1) ){

114 
rc
 = 
	`ã°ArgSñe˘
(
aO±
, "›ti⁄", 
azArg
[
iDb
+1], &
eO±
);

115 if–
rc
!=0 ) Ñc;

116 
bC⁄fig
 = 
aO±
[
eO±
].bConfig;

117 
eO±
 = 
aO±
[eOpt].eOpt;

118 if–(
bC⁄fig
==0 && 
eO±
==
LSM_INFO_FREELIST
)

119 || (
bC⁄fig
==1 && 
eO±
==
LSM_CONFIG_BLOCK_SIZE
)

120 || (
bC⁄fig
==1 && 
eO±
==
LSM_CONFIG_PAGE_SIZE
)

122 if–
nArg
!=(
iDb
+2ËË
ußge
;

124 if–
nArg
!=(
iDb
+3ËË
ußge
;

125 
iPg
 = 
	`©oi
(
azArg
[
iDb
+2]);

128 
zDb
 = 
azArg
[
iDb
];

130 
rc
 = 
	`lsm_√w
(0, &
pDb
);

131 
	`tdb_lsm_c⁄figuª
(
pDb
, 
zC⁄fig
);

132 if–
rc
!=
LSM_OK
 ){

133 
	`ã°PrötEº‹
("lsm_√w():Ñc=%d\n", 
rc
);

135 
rc
 = 
	`lsm_›í
(
pDb
, 
zDb
);

136 if–
rc
!=
LSM_OK
 ){

137 
	`ã°PrötEº‹
("lsm_›í():Ñc=%d\n", 
rc
);

141 if–
rc
==
LSM_OK
 ){

142 if–
bC⁄fig
==0 ){

143  
eO±
 ){

144 
LSM_INFO_DB_STRUCTURE
:

145 
LSM_INFO_FREELIST
:

146 
rc
 = 
	`lsm_öfo
(
pDb
, 
eO±
, &
z
);

148 
LSM_INFO_ARRAY_STRUCTURE
:

149 
LSM_INFO_ARRAY_PAGES
:

150 
LSM_INFO_PAGE_ASCII_DUMP
:

151 
LSM_INFO_PAGE_HEX_DUMP
:

152 
rc
 = 
	`lsm_öfo
(
pDb
, 
eO±
, 
iPg
, &
z
);

155 
	`as£π
( !"no chance" );

158 if–
rc
==
LSM_OK
 ){

159 
	`¥ötf
("%s\n", 
z
 ? z : "");

160 
	`fÊush
(
°dout
);

162 
	`lsm_‰ì
(
	`lsm_gë_ív
(
pDb
), 
z
);

164 
iRes
 = -1;

165 
	`lsm_c⁄fig
(
pDb
, 
eO±
, &
iRes
);

166 
	`¥ötf
("%d\n", 
iRes
);

167 
	`fÊush
(
°dout
);

171 
	`lsm_˛o£
(
pDb
);

172  
rc
;

174 
ußge
:

175 
	`ã°PrötUßge
("DATABASE ?array|page-ascii|page-hex PGNO?");

177 
	}
}

	@lsm-test/lsmtest_io.c

56 
	~"lsmã°.h
"

58 
	~<sys/ty≥s.h
>

59 
	~<sys/°©.h
>

60 
	~<f˙é.h
>

61 
	~<uni°d.h
>

62 
	~<˘y≥.h
>

64 
IoC⁄ãxt
 
	tIoC⁄ãxt
;

66 
	sIoC⁄ãxt
 {

67 
	mfd
;

68 
	mnWrôe
;

74 
	$ß„_is•a˚
(
c
){

75 if–
c
&0x80)  0;

76  
	`is•a˚
(
c
);

77 
	}
}

82 
	$ß„_isdigô
(
c
){

83 if–
c
&0x80)  0;

84  
	`isdigô
(
c
);

85 
	}
}

87 
i64
 
	$gëNextSize
(*
zIn
, **
pzOut
, *
pRc
){

88 
i64
 
iRë
 = 0;

89 if–*
pRc
==0 ){

90 *
z
 = 
zIn
;

92 if–!
	`ß„_isdigô
(*
z
) ){

93 *
pRc
 = 1;

98  
	`ß„_isdigô
(*
z
) ){

99 
iRë
 = iRë*10 + (*
z
 - '0');

100 
z
++;

104  *
z
 ){

106 
iRë
 = iRet * 1024;

107 
z
++;

111 
iRë
 = iRet * 1024 * 1024;

112 
z
++;

116 
iRë
 = iRet * 1024 * 1024 * 1024;

117 
z
++;

121 if–
pzOut
 ) *pzOuà
z
;

123  
iRë
;

124 
	}
}

126 
	$doO√Cmd
(

127 
IoC⁄ãxt
 *
pCtx
,

128 
u8
 *
aD©a
,

129 
pgsz
,

130 *
zCmd
,

131 **
pzOut


133 
c
;

134 *
z
 = 
zCmd
;

136  
	`ß„_is•a˚
(*
z
) ) z++;

137 
c
 = *
z
;

139 if–
c
==0 ){

140 if–
pzOut
 ) *pzOuà
z
;

144 if–
c
=='s' || c=='S' ){

145 if–
pzOut
 ) *pzOuà&
z
[1];

146  
	`fd©async
(
pCtx
->
fd
);

149 if–
	`ß„_isdigô
(
c
) ){

150 
i64
 
iOff
 = 0;

151 
nByã
 = 0;

152 
rc
 = 0;

153 
nPg
;

154 
iPg
;

156 
nByã
 = 
	`gëNextSize
(
z
, &z, &
rc
);

157 if–
rc
 || *
z
!='@' ) 
bad_comm™d
;

158 
z
++;

159 
iOff
 = 
	`gëNextSize
(
z
, &z, &
rc
);

160 if–
rc
 || (
	`ß„_is•a˚
(*
z
)==0 && *z!='\0'ËË
bad_comm™d
;

161 if–
pzOut
 ) *pzOuà
z
;

163 
nPg
 = (
nByã
+
pgsz
-1) /Ögsz;

164 
	`l£ek
(
pCtx
->
fd
, 
iOff
, 
SEEK_SET
);

165 
iPg
=0; iPg<
nPg
; iPg++){

166 
	`wrôe
(
pCtx
->
fd
, 
aD©a
, 
pgsz
);

168 
pCtx
->
nWrôe
 +
nByã
/1024;

173 
bad_comm™d
:

174 
	`ã°PrötEº‹
("uƒecognized comm™d: %s", 
zCmd
);

176 
	}
}

178 
	$ªadStdö
(**
pzOut
){

179 
nAŒoc
 = 128;

180 *
zOut
 = 0;

181 
nOut
 = 0;

183  !
	`„of
(
°dö
) ){

184 
nRód
;

186 
nAŒoc
 =ÇAlloc*2;

187 
zOut
 = 
	`ªÆloc
(zOut, 
nAŒoc
);

188 
nRód
 = 
	`‰ód
(&
zOut
[
nOut
], 1, 
nAŒoc
-nOut-1, 
°dö
);

190 if–
nRód
==0 ) ;

191 
nOut
 +
nRód
;

192 
zOut
[
nOut
] = '\0';

195 *
pzOut
 = 
zOut
;

197 
	}
}

199 
	$do_io
(
nArg
, **
azArg
){

200 
IoC⁄ãxt
 
˘x
;

201 
pgsz
;

202 *
zFûe
;

203 *
zPgsz
;

204 
i
;

205 
rc
 = 0;

207 *
zStdö
 = 0;

208 *
z
;

210 
u8
 *
aD©a
;

212 
	`mem£t
(&
˘x
, 0, (
IoC⁄ãxt
));

213 if–
nArg
<2 ){

214 
	`ã°PrötUßge
("FILE PGSZ ?CMD-1 ...?");

217 
zFûe
 = 
azArg
[0];

218 
zPgsz
 = 
azArg
[1];

220 
pgsz
 = 
	`gëNextSize
(
zPgsz
, 0, &
rc
);

221 if–
pgsz
<=0 ){

222 
	`ã°PrötEº‹
("Ridiculou†∑gêsize: %d", 
pgsz
);

225 
aD©a
 = 
	`mÆloc
(
pgsz
);

226 
	`mem£t
(
aD©a
, 0x77, 
pgsz
);

228 
˘x
.
fd
 = 
	`›í
(
zFûe
, 
O_RDWR
|
O_CREAT
, 0644);

229 if–
˘x
.
fd
<0 ){

230 
	`≥º‹
("open: ");

234 if–
nArg
==2 ){

235 
	`ªadStdö
(&
zStdö
);

236 
	`ã°TimeInô
();

237 
z
 = 
zStdö
;

238  *
z
 && 
rc
==0 ){

239 
rc
 = 
	`doO√Cmd
(&
˘x
, 
aD©a
, 
pgsz
, 
z
, &z);

242 
	`ã°TimeInô
();

243 
i
=2; i<
nArg
; i++){

244 
rc
 = 
	`doO√Cmd
(&
˘x
, 
aD©a
, 
pgsz
, 
azArg
[
i
], 0);

248 
	`¥ötf
("%dK wrôã¿ö %d ms\n", 
˘x
.
nWrôe
, 
	`ã°TimeGë
());

250 
	`‰ì
(
zStdö
);

251 
	`˛o£
(
˘x
.
fd
);

254 
	}
}

	@lsm-test/lsmtest_main.c

2 
	~<°d¨g.h
>

3 
	~"lsmã°.h
"

4 
	~"°dio.h
"

5 
	~"as£π.h
"

6 
	~"°rög.h
"

7 
	~"°dlib.h
"

9 
	~<sqlôe3.h
>

11 
	~<uni°d.h
>

12 
	~<sys/ty≥s.h
>

13 
	~<sys/°©.h
>

14 
	~<f˙é.h
>

15 
	~<î∫o.h
>

18 
	$ã°_Áûed
(){

19 
	`as£π
( 0 );

21 
	}
}

23 
	#ã°SëEº‹
(
rc
Ë
	`ã°SëEº‹Func
‘c, 
pRc
, 
__FILE__
, 
__LINE__
)

	)

24 
	$ã°SëEº‹Func
(
rc
, *
pRc
, c⁄° *
zFûe
, 
iLöe
){

25 if–
rc
 ){

26 *
pRc
 = 
rc
;

27 
	`¥ötf
("FAILED (%s:%dËrc=%d ", 
zFûe
, 
iLöe
, 
rc
);

28 
	`ã°_Áûed
();

30 
	}
}

32 
	$lsm_memcmp
(
u8
 *
a
, u8 *
b
, 
c
){

33 
i
;

34 
i
=0; i<
c
; i++){

35 if–
a
[
i
]!=
b
[i] ) á[i] - b[i];

38 
	}
}

43 
	$ã°Fëch
(

44 
Te°Db
 *
pDb
,

45 *
pKey
, 
nKey
,

46 *
pVÆ
, 
nVÆ
,

47 *
pRc


49 if–*
pRc
==0 ){

50 *
pDbVÆ
;

51 
nDbVÆ
;

52 
rc
;

54 
nCÆl
 = 0;ÇCall++;

56 
rc
 = 
	`tdb_„tch
(
pDb
, 
pKey
, 
nKey
, &
pDbVÆ
, &
nDbVÆ
);

57 
	`ã°SëEº‹
(
rc
);

58 if–
rc
==0 && (
nVÆ
!=
nDbVÆ
 || (nVÆ>0 && 
	`lsm_memcmp
(
pVÆ
, 
pDbVÆ
,ÇVal))) ){

59 
	`ã°SëEº‹
(1);

62 
	}
}

64 
	$ã°Wrôe
(

65 
Te°Db
 *
pDb
,

66 *
pKey
, 
nKey
,

67 *
pVÆ
, 
nVÆ
,

68 *
pRc


70 if–*
pRc
==0 ){

71 
rc
;

72 
nCÆl
 = 0;

73 
nCÆl
++;

74 
rc
 = 
	`tdb_wrôe
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

75 
	`ã°SëEº‹
(
rc
);

77 
	}
}

78 
	$ã°Dñëe
(

79 
Te°Db
 *
pDb
,

80 *
pKey
, 
nKey
,

81 *
pRc


83 if–*
pRc
==0 ){

84 
rc
;

85 *
pRc
 = 
rc
 = 
	`tdb_dñëe
(
pDb
, 
pKey
, 
nKey
);

86 
	`ã°SëEº‹
(
rc
);

88 
	}
}

89 
	$ã°DñëeR™ge
(

90 
Te°Db
 *
pDb
,

91 *
pKey1
, 
nKey1
,

92 *
pKey2
, 
nKey2
,

93 *
pRc


95 if–*
pRc
==0 ){

96 
rc
;

97 *
pRc
 = 
rc
 = 
	`tdb_dñëe_ønge
(
pDb
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
);

98 
	`ã°SëEº‹
(
rc
);

100 
	}
}

102 
	$ã°Begö
(
Te°Db
 *
pDb
, 
iTøns
, *
pRc
){

103 if–*
pRc
==0 ){

104 
rc
;

105 
rc
 = 
	`tdb_begö
(
pDb
, 
iTøns
);

106 
	`ã°SëEº‹
(
rc
);

108 
	}
}

109 
	$ã°Commô
(
Te°Db
 *
pDb
, 
iTøns
, *
pRc
){

110 if–*
pRc
==0 ){

111 
rc
;

112 
rc
 = 
	`tdb_commô
(
pDb
, 
iTøns
);

113 
	`ã°SëEº‹
(
rc
);

115 
	}
}

116 
	$ã°Rﬁlback
(
Te°Db
 *
pDb
, 
iTøns
, *
pRc
){

117 if–*
pRc
==0 ){

118 
rc
;

119 
rc
 = 
	`tdb_rﬁlback
(
pDb
, 
iTøns
);

120 
	`ã°SëEº‹
(
rc
);

122 
	}
}

124 
	$ã°WrôeSå
(

125 
Te°Db
 *
pDb
,

126 c⁄° *
zKey
,

127 c⁄° *
zVÆ
,

128 *
pRc


130 
nVÆ
 = (
zVÆ
 ? 
	`°æí
(zVal) : 0);

131 
	`ã°Wrôe
(
pDb
, (*)
zKey
, 
	`°æí
(zKey), (*)
zVÆ
, 
nVÆ
, 
pRc
);

132 
	}
}

134 
	$ã°DñëeSå
(
Te°Db
 *
pDb
, c⁄° *
zKey
, *
pRc
){

135 
	`ã°Dñëe
(
pDb
, (*)
zKey
, 
	`°æí
(zKey), 
pRc
);

136 
	}
}

138 
	$ã°FëchSå
(

139 
Te°Db
 *
pDb
,

140 c⁄° *
zKey
,

141 c⁄° *
zVÆ
,

142 *
pRc


144 
nVÆ
 = (
zVÆ
 ? 
	`°æí
(zVal) : 0);

145 
	`ã°Fëch
(
pDb
, (*)
zKey
, 
	`°æí
(zKey), (*)
zVÆ
, 
nVÆ
, 
pRc
);

146 
	}
}

148 
	$ã°FëchCom∑ª
(

149 
Te°Db
 *
pC⁄åﬁ
,

150 
Te°Db
 *
pDb
,

151 *
pKey
, 
nKey
,

152 *
pRc


154 
rc
;

155 *
pDbVÆ1
;

156 *
pDbVÆ2
;

157 
nDbVÆ1
;

158 
nDbVÆ2
;

160 
nCÆl
 = 0;

161 
nCÆl
++;

163 
rc
 = 
	`tdb_„tch
(
pC⁄åﬁ
, 
pKey
, 
nKey
, &
pDbVÆ1
, &
nDbVÆ1
);

164 
	`ã°SëEº‹
(
rc
);

166 
rc
 = 
	`tdb_„tch
(
pDb
, 
pKey
, 
nKey
, &
pDbVÆ2
, &
nDbVÆ2
);

167 
	`ã°SëEº‹
(
rc
);

169 if–*
pRc
==0

170 && (
nDbVÆ1
!=
nDbVÆ2
 || (nDbVÆ1>0 && 
	`memcmp
(
pDbVÆ1
, 
pDbVÆ2
,ÇDbVal1)))

172 
	`ã°SëEº‹
(1);

174 
	}
}

176 
SˇnResu…
 
	tSˇnResu…
;

177 
	sSˇnResu…
 {

178 
Te°Db
 *
	mpDb
;

180 
	mnRow
;

181 
u32
 
	mcksum1
;

182 
u32
 
	mcksum2
;

183 *
	mpKey1
; 
	mnKey1
;

184 *
	mpKey2
; 
	mnKey2
;

186 
	mbRevî£
;

187 
	mnPªvKey
;

188 
u8
 
	maPªvKey
[256];

191 
	$keyCom∑ª
(*
pKey1
, 
nKey1
, *
pKey2
, 
nKey2
){

192 
ªs
;

193 
ªs
 = 
	`memcmp
(
pKey1
, 
pKey2
, 
	`MIN
(
nKey1
, 
nKey2
));

194 if–
ªs
==0 ){

195 
ªs
 = 
nKey1
 - 
nKey2
;

197  
ªs
;

198 
	}
}

200 
	gã°_sˇn_debug
 = 0;

202 
	$sˇnCom∑ªCb
(

203 *
pCtx
,

204 *
pKey
, 
nKey
,

205 *
pVÆ
, 
nVÆ


207 
SˇnResu…
 *
p
 = (SˇnResu… *)
pCtx
;

208 
u8
 *
aKey
 = (u8 *)
pKey
;

209 
u8
 *
aVÆ
 = (u8 *)
pVÆ
;

210 
i
;

212 if–
ã°_sˇn_debug
 ){

213 
	`¥ötf
("%d: %.*s\n", 
p
->
nRow
, 
nKey
, (*)
pKey
);

214 
	`fÊush
(
°dout
);

217 if–
ã°_sˇn_debug
 ) 
	`¥ötf
("%.20s\n", (*)
pVÆ
);

222 
rc
 = 0;

223 
	`ã°Fëch
(
p
->
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, &
rc
);

224 
	`as£π
–
rc
==0 );

228 
p
->
nRow
++;

229 
i
=0; i<
nKey
; i++){

230 
p
->
cksum1
 +(()
aKey
[
i
] << (i&0x0F));

231 
p
->
cksum2
 +p->
cksum1
;

233 
i
=0; i<
nVÆ
; i++){

234 
p
->
cksum1
 +(()
aVÆ
[
i
] << (i&0x0F));

235 
p
->
cksum2
 +p->
cksum1
;

239 if–
nKey
<()(
p
->
aPªvKey
) ){

240 if–
p
->
nPªvKey
 ){

241 
ªs
 = 
	`keyCom∑ª
(
p
->
aPªvKey
,Ö->
nPªvKey
, 
pKey
, 
nKey
);

242 if–(
ªs
<0 && 
p
->
bRevî£
) || (res>0 &&Ö->bReverse==0) ){

243 
	`ã°PrötEº‹
("Returned key out of orderát %s:%d\n",

244 
__FILE__
, 
__LINE__


249 
p
->
nPªvKey
 = 
nKey
;

250 
	`mem˝y
(
p
->
aPªvKey
, 
pKey
, 
	`MIN
’->
nPªvKey
, 
nKey
));

254 if–
p
->
pKey1
 && (

255 (
	`memcmp
(
p
->
pKey1
, 
pKey
, 
	`MIN
’->
nKey1
, 
nKey
))>0)

256 || (
	`memcmp
(
p
->
pKey1
, 
pKey
, 
	`MIN
’->
nKey1
, 
nKey
))==0 &&Ö->nKey1>nKey)

258 
	`ã°PrötEº‹
("Rëu∫ed keyÅoÿsmÆ»© %s:%d\n", 
__FILE__
, 
__LINE__
);

260 if–
p
->
pKey2
 && (

261 (
	`memcmp
(
p
->
pKey2
, 
pKey
, 
	`MIN
’->
nKey2
, 
nKey
))<0)

262 || (
	`memcmp
(
p
->
pKey2
, 
pKey
, 
	`MIN
’->
nKey2
, 
nKey
))==0 &&Ö->nKey2<nKey)

264 
	`ã°PrötEº‹
("Rëu∫ed keyÅoÿœrgê© %s:%d\n", 
__FILE__
, 
__LINE__
);

267 
	}
}

272 
	$ã°SˇnCom∑ª
(

273 
Te°Db
 *
pDb1
,

274 
Te°Db
 *
pDb2
,

275 
bRevî£
,

276 *
pKey1
, 
nKey1
,

277 *
pKey2
, 
nKey2
,

278 *
pRc


280 
nCÆl
 = 0;ÇCall++;

281 if–*
pRc
==0 ){

282 
SˇnResu…
 
ªs1
;

283 
SˇnResu…
 
ªs2
;

284 *
pRes1
 = (*)&
ªs1
;

285 *
pRes2
 = (*)&
ªs2
;

287 
	`mem£t
(&
ªs1
, 0, (
SˇnResu…
));

288 
	`mem£t
(&
ªs2
, 0, (
SˇnResu…
));

290 
ªs1
.
pDb
 = 
pDb1
;

291 
ªs1
.
nKey1
 =ÇKey1;Ñes1.
pKey1
 =ÖKey1;

292 
ªs1
.
nKey2
 =ÇKey2;Ñes1.
pKey2
 =ÖKey2;

293 
ªs1
.
bRevî£
 = bReverse;

294 
ªs2
.
pDb
 = 
pDb2
;

295 
ªs2
.
nKey1
 =ÇKey1;Ñes2.
pKey1
 =ÖKey1;

296 
ªs2
.
nKey2
 =ÇKey2;Ñes2.
pKey2
 =ÖKey2;

297 
ªs2
.
bRevî£
 = bReverse;

299 
	`tdb_sˇn
(
pDb1
, 
pRes1
, 
bRevî£
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, 
sˇnCom∑ªCb
);

300 if–
ã°_sˇn_debug
 ) 
	`¥ötf
("\n\n\n");

301 
	`tdb_sˇn
(
pDb2
, 
pRes2
, 
bRevî£
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, 
sˇnCom∑ªCb
);

302 if–
ã°_sˇn_debug
 ) 
	`¥ötf
("\n\n\n");

304 if–
ªs1
.
nRow
!=
ªs2
.nRow

305 || 
ªs1
.
cksum1
!=
ªs2
.cksum1

306 || 
ªs1
.
cksum2
!=
ªs2
.cksum2

308 
	`¥ötf
("ex≥˘ed: %d %X %X\n", 
ªs1
.
nRow
,Ñes1.
cksum1
,Ñes1.
cksum2
);

309 
	`¥ötf
("gŸ: %d %X %X\n", 
ªs2
.
nRow
,Ñes2.
cksum1
,Ñes2.
cksum2
);

310 
	`ã°SëEº‹
(1);

311 *
pRc
 = 1;

314 
	}
}

316 
	$ã°Clo£
(
Te°Db
 **
µDb
){

317 
	`tdb_˛o£
(*
µDb
);

318 *
µDb
 = 0;

319 
	}
}

321 
Te°Db
 *
	$ã°O≥n
(c⁄° *
zSy°em
, 
bCÀ¨
, *
pRc
){

322 
Te°Db
 *
pDb
 = 0;

323 if–*
pRc
==0 ){

324 
rc
;

325 
rc
 = 
	`tdb_›í
(
zSy°em
, 0, 
bCÀ¨
, &
pDb
);

326 if–
rc
!=0 ){

327 
	`ã°SëEº‹
(
rc
);

328 *
pRc
 = 
rc
;

331  
pDb
;

332 
	}
}

334 
	$ã°Re›í
(
Te°Db
 **
µDb
, *
pRc
){

335 if–*
pRc
==0 ){

336 c⁄° *
zLib
;

337 
zLib
 = 
	`tdb_libøry_«me
(*
µDb
);

338 
	`ã°Clo£
(
µDb
);

339 *
pRc
 = 
	`tdb_›í
(
zLib
, 0, 0, 
µDb
);

341 
	}
}

344 
	$ã°Sy°emSñe˘
(c⁄° *
zSys
, *
piSñ
, *
pRc
){

345 if–*
pRc
==0 ){

346 
	sSysName
 { c⁄° *
zName
; } *
aName
;

347 
nSys
;

348 
i
;

350 
nSys
=0; 
	`tdb_sy°em_«me
(nSys);ÇSys++);

351 
aName
 = 
	`mÆloc
((
SysName
Ë* (
nSys
+1));

352 
i
=0; i<=
nSys
; i++){

353 
aName
[
i
].
zName
 = 
	`tdb_sy°em_«me
(i);

356 *
pRc
 = 
	`ã°ArgSñe˘
(
aName
, "db", 
zSys
, 
piSñ
);

357 
	`‰ì
(
aName
);

359 
	}
}

361 *
	$ã°MÆlocVPrötf
(c⁄° *
zF‹m©
, 
va_li°
 
≠
){

362 
nByã
;

363 
va_li°
 
c›y
;

364 *
zRë
;

366 
	`va_c›y
(
c›y
, 
≠
);

367 
nByã
 = 
	`v¢¥ötf
(0, 0, 
zF‹m©
, 
c›y
);

368 
	`va_íd
(
c›y
);

370 
	`as£π
–
nByã
>=0 );

371 
zRë
 = (*)
	`ã°MÆloc
(
nByã
+1);

372 
	`v¢¥ötf
(
zRë
, 
nByã
+1, 
zF‹m©
, 
≠
);

373  
zRë
;

374 
	}
}

376 *
	$ã°MÆlocPrötf
(c⁄° *
zF‹m©
, ...){

377 
va_li°
 
≠
;

378 *
zRë
;

380 
	`va_°¨t
(
≠
, 
zF‹m©
);

381 
zRë
 = 
	`ã°MÆlocVPrötf
(
zF‹m©
, 
≠
);

382 
	`va_íd
(
≠
);

384  
zRë
;

385 
	}
}

399 *
	$ã°MÆloc
(
n
){

400 
u8
 *
p
 = (u8*)
	`mÆloc
(
n
 + 8);

401 
	`mem£t
(
p
, 0, 
n
+8);

402 *(*)
p
 = 
n
;

403  (*)&
p
[8];

404 
	}
}

406 *
	$ã°MÆlocC›y
(*
pC›y
, 
nByã
){

407 *
pRë
 = 
	`ã°MÆloc
(
nByã
);

408 
	`mem˝y
(
pRë
, 
pC›y
, 
nByã
);

409  
pRë
;

410 
	}
}

412 *
	$ã°RóŒoc
(*
±r
, 
n
){

413 if–
±r
 ){

414 
u8
 *
p
 = (u8*)
±r
 - 8;

415 
nOrig
 = *(*)
p
;

416 
p
 = (
u8
*)
	`ªÆloc
’, 
n
+8);

417 if–
nOrig
<
n
 ){

418 
	`mem£t
(&
p
[8+
nOrig
], 0, 
n
-nOrig);

420 *(*)
p
 = 
n
;

421  (*)&
p
[8];

423  
	`ã°MÆloc
(
n
);

424 
	}
}

429 
	$ã°Fªe
(*
±r
){

430 if–
±r
 ){

431 
u8
 *
p
 = (u8*)
±r
 - 8;

432 
	`mem£t
(
p
, 0x55, *(*)p + 8);

433 
	`‰ì
(
p
);

435 
	}
}

441 
	$ã°GlobM©ch
(c⁄° *
zP©ã∫
, c⁄° *
zSå
){

442 
i
 = 0;

443 
j
 = 0;

445  
zP©ã∫
[
i
] ){

446 
p
 = 
zP©ã∫
[
i
];

448 if–
p
=='*' ||Ö=='%' ){

450 if–
	`ã°GlobM©ch
(&
zP©ã∫
[
i
+1], &
zSå
[
j
]) )  1;

451 } 
zSå
[
j
++] );

455 if–
zSå
[
j
]==0 || (
p
!='?' &&Ö!=zStr[j]) ){

460 
j
++;

461 
i
++;

464  (
zP©ã∫
[
i
]==0 && 
zSå
[
j
]==0);

465 
	}
}

471 
	$do_ã°
(
nArg
, **
azArg
){

472 
j
;

473 
rc
;

474 
nFaû
 = 0;

475 c⁄° *
zP©ã∫
 = 0;

477 if–
nArg
>1 ){

478 
	`ã°PrötEº‹
("Usage:Åest ?PATTERN?\n");

481 if–
nArg
==1 ){

482 
zP©ã∫
 = 
azArg
[0];

485 
j
=0; 
	`tdb_sy°em_«me
(j); j++){

486 
rc
 = 0;

488 
	`ã°_d©a_1
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

489 
	`ã°_d©a_2
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

490 
	`ã°_d©a_3
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

491 
	`ã°_d©a_4
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

492 
	`ã°_rﬁlback
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

493 
	`ã°_mc
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

494 
	`ã°_mt
(
	`tdb_sy°em_«me
(
j
), 
zP©ã∫
, &
rc
);

496 if–
rc
 ) 
nFaû
++;

499 
rc
 = 0;

500 
	`ã°_oom
(
zP©ã∫
, &
rc
);

501 if–
rc
 ) 
nFaû
++;

503 
rc
 = 0;

504 
	`ã°_≠i
(
zP©ã∫
, &
rc
);

505 if–
rc
 ) 
nFaû
++;

507 
rc
 = 0;

508 
	`do_¸ash_ã°
(
zP©ã∫
, &
rc
);

509 if–
rc
 ) 
nFaû
++;

511 
rc
 = 0;

512 
	`do_wrôî_¸ash_ã°
(
zP©ã∫
, &
rc
);

513 if–
rc
 ) 
nFaû
++;

515  (
nFaû
!=0);

516 
	}
}

518 
lsm_db
 *
	$c⁄figuª_lsm_db
(
Te°Db
 *
pDb
){

519 
lsm_db
 *
pLsm
;

520 
pLsm
 = 
	`tdb_lsm
(
pDb
);

521 if–
pLsm
 ){

522 
	`tdb_lsm_c⁄fig_°r
(
pDb
, "mmap=1áutowork=1áutomerge=4 worker_automerge=4");

524  
pLsm
;

525 
	}
}

527 
WrôeHookEvít
 
	tWrôeHookEvít
;

528 
	sWrôeHookEvít
 {

529 
i64
 
	miOff
;

530 
	mnD©a
;

531 
	mnUs
;

533 
WrôeHookEvít
 
	g¥ev
 = {0, 0, 0};

535 
	$ÊushPªv
(
FILE
 *
pOut
){

536 if–
¥ev
.
nD©a
 ){

537 
	`Ârötf
(
pOut
, "w %†%Œd %d %d\n", "d", 
¥ev
.
iOff
,Öªv.
nD©a
,Öªv.
nUs
);

538 
¥ev
.
nD©a
 = 0;

540 
	}
}

542 
	$do_•ìd_wrôe_hook2
(

543 *
pCtx
,

544 
bLog
,

545 
i64
 
iOff
,

546 
nD©a
,

547 
nUs


549 
FILE
 *
pOut
 = (FILE *)
pCtx
;

550 if–
bLog
 ) ;

552 if–
¥ev
.
nD©a
 &&ÇD©®&& 
iOff
==prev.iOff+prev.nData ){

553 
¥ev
.
nD©a
 +=ÇData;

554 
¥ev
.
nUs
 +=ÇUs;

556 
	`ÊushPªv
(
pOut
);

557 if–
nD©a
==0 ){

558 
	`Ârötf
(
pOut
, "†%†0 0 %d\n", (
bLog
 ? "l" : "d"), 
nUs
);

560 
¥ev
.
iOff
 = iOff;

561 
¥ev
.
nD©a
 =ÇData;

562 
¥ev
.
nUs
 =ÇUs;

565 
	}
}

567 
	#ST_REPEAT
 0

	)

568 
	#ST_WRITE
 1

	)

569 
	#ST_PAUSE
 2

	)

570 
	#ST_FETCH
 3

	)

571 
	#ST_SCAN
 4

	)

572 
	#ST_NSCAN
 5

	)

573 
	#ST_KEYSIZE
 6

	)

574 
	#ST_VALSIZE
 7

	)

577 
	$¥öt_•ìd_ã°_hñp
(){

578 
	`¥ötf
(

598 
	}
}

600 
	$do_•ìd_ã°2
(
nArg
, **
azArg
){

601 
	sO±i⁄
 {

602 c⁄° *
zO±
;

603 
eVÆ
;

604 
iDeÁu…
;

605 } 
aO±
[] = {

606 { "-ª≥©", 
ST_REPEAT
, 10},

607 { "-wrôe", 
ST_WRITE
, 10000},

608 { "-∑u£", 
ST_PAUSE
, 0},

609 { "-„tch", 
ST_FETCH
, 0},

610 { "-sˇn", 
ST_SCAN
, 0},

611 { "-nsˇn", 
ST_NSCAN
, 0},

612 { "-keysize", 
ST_KEYSIZE
, 12},

613 { "-vÆsize", 
ST_VALSIZE
, 100},

618 
i
;

619 
aP¨am
[8];

620 
rc
 = 0;

621 
bRód⁄ly
 = 0;

622 
nC⁄ã¡
 = 0;

624 
Te°Db
 *
pDb
;

625 
D©asour˚
 *
pD©a
;

626 
D©asour˚De‚
 
de‚
 = { 
TEST_DATASOURCE_RANDOM
, 0, 0, 0, 0 };

627 *
zSy°em
 = "";

628 
bLsm
 = 1;

629 
FILE
 *
pLog
 = 0;

631 #ifde‡
NDEBUG


634 
	`ã°MÆlocUnö°Æl
(
	`tdb_lsm_ív
());

638 
i
=0; i<
	`AºaySize
(
aO±
); i++){

639 if–
aO±
[
i
].
zO±
 ) 
aP¨am
[aO±[i].
eVÆ
] =áO±[i].
iDeÁu…
;

643 
i
=0; i<
nArg
; i+=2){

644 
iSñ
;

645 
rc
 = 
	`ã°ArgSñe˘
(
aO±
, "swôch", 
azArg
[
i
], &
iSñ
);

646 if–
rc
 ){

647  
rc
;

649 if–
aO±
[
iSñ
].
eVÆ
==-2 ){

650 
	`¥öt_•ìd_ã°_hñp
();

653 if–
i
+1==
nArg
 ){

654 
	`ã°PrötEº‹
("›ti⁄ %†ªquúe†™árgumít\n", 
aO±
[
iSñ
].
zO±
);

657 if–
aO±
[
iSñ
].
eVÆ
>=0 ){

658 
aP¨am
[
aO±
[
iSñ
].
eVÆ
] = 
	`©oi
(
azArg
[
i
+1]);

660 
j
;

661 
zSy°em
 = 
azArg
[
i
+1];

662 
bLsm
 = 0;

664 
j
=0; 
zSy°em
[j]; j++){

665 if–
zSy°em
[
j
]=='=' ) 
bLsm
 = 1;

671 
	`¥ötf
("#");

672 
i
=0; i<
	`AºaySize
(
aO±
); i++){

673 if–
aO±
[
i
].
zO±
 ){

674 if–
aO±
[
i
].
eVÆ
>=0 ){

675 
	`¥ötf
(" %s=%d", &
aO±
[
i
].
zO±
[1], 
aP¨am
[aO±[i].
eVÆ
]);

676 }if–
aO±
[
i
].
eVÆ
==-1 ){

677 
	`¥ötf
(" %s=\"%s\"", &
aO±
[
i
].
zO±
[1], 
zSy°em
);

681 
	`¥ötf
("\n");

683 
de‚
.
nMöKey
 = de‚.
nMaxKey
 = 
aP¨am
[
ST_KEYSIZE
];

684 
de‚
.
nMöVÆ
 = de‚.
nMaxVÆ
 = 
aP¨am
[
ST_VALSIZE
];

685 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

687 if–
aP¨am
[
ST_WRITE
]==0 ){

688 
bRód⁄ly
 = 1;

691 if–
bLsm
 ){

692 
rc
 = 
	`tdb_lsm_›í
(
zSy°em
, "ã°db.lsm", !
bRód⁄ly
, &
pDb
);

694 
pDb
 = 
	`ã°O≥n
(
zSy°em
, !
bRód⁄ly
, &
rc
);

696 if–
rc
!=0 ) Ñc;

697 if–
bRód⁄ly
 ){

698 
nC⁄ã¡
 = 
	`ã°Cou¡D©aba£
(
pDb
);

702 
pLog
 = 
	`f›í
("/tmp/speed.log", "w");

703 
	`tdb_lsm_wrôe_hook
(
pDb
, 
do_•ìd_wrôe_hook2
, (*)
pLog
);

706 
i
=0; i<
aP¨am
[
ST_REPEAT
] && 
rc
==0; i++){

707 
msWrôe
, 
msFëch
;

708 
iFëch
;

709 
nWrôe
 = 
aP¨am
[
ST_WRITE
];

711 if–
bRód⁄ly
 ){

712 
msWrôe
 = 0;

714 
	`ã°TimeInô
();

715 
	`ã°WrôeD©asour˚R™ge
(
pDb
, 
pD©a
, 
i
*
nWrôe
,ÇWrôe, &
rc
);

716 
msWrôe
 = 
	`ã°TimeGë
();

717 
nC⁄ã¡
 +
nWrôe
;

720 if–
aP¨am
[
ST_PAUSE
] ){

721 if–
aP¨am
[
ST_PAUSE
]/1000 ) 
	`¶ìp
(aParam[ST_PAUSE]/1000);

722 if–
aP¨am
[
ST_PAUSE
]%1000 ) 
	`u¶ìp
(1000 * (aParam[ST_PAUSE]%1000));

725 if–
aP¨am
[
ST_FETCH
] ){

726 
	`ã°TimeInô
();

727 
iFëch
=0; iFëch<
aP¨am
[
ST_FETCH
]; iFetch++){

728 
iKey
 = 
	`ã°P∫gVÆue
(
i
*
nWrôe
+
iFëch
Ë% 
nC⁄ã¡
;

729 #i‚de‡
NDEBUG


730 
	`ã°D©asour˚Fëch
(
pDb
, 
pD©a
, 
iKey
, &
rc
);

732 *
pKey
; 
nKey
;

733 *
pVÆ
; 
nVÆ
;

735 
	`ã°D©asour˚E¡ry
(
pD©a
, 
iKey
, &
pKey
, &
nKey
, 0, 0);

736 
rc
 = 
	`tdb_„tch
(
pDb
, 
pKey
, 
nKey
, &
pVÆ
, &
nVÆ
);

737 if–
rc
==0 && 
nVÆ
<0 )Ñc = 1;

738 if–
rc
 ) ;

741 
msFëch
 = 
	`ã°TimeGë
();

743 
msFëch
 = 0;

746 if–
i
==(
aP¨am
[
ST_REPEAT
]-1) ){

747 
	`ã°TimeInô
();

748 
	`ã°Clo£
(&
pDb
);

749 
msWrôe
 +
	`ã°TimeGë
();

752 
	`¥ötf
("%d %d %d\n", 
i
, 
msWrôe
, 
msFëch
);

753 
	`fÊush
(
°dout
);

756 
	`ã°Clo£
(&
pDb
);

757 
	`ã°D©asour˚Fªe
(
pD©a
);

759 if–
pLog
 ){

760 
	`ÊushPªv
(
pLog
);

761 
	`f˛o£
(
pLog
);

763  
rc
;

764 
	}
}

766 
	$do_•ìd_ã°s
(
nArg
, **
azArg
){

768 
	sDbSy°em
 {

769 c⁄° *
zLibøry
;

770 c⁄° *
zCﬁ‹
;

771 } 
aSys
[] = {

781 
i
;

782 
j
;

783 
rc
;

784 
nSÀï
 = 0;

785 
nRow
 = 0;

786 
nSãp
;

787 
nSñSãp
;

788 
nSñTe°
;

789 
doRódTe°
 = 1;

790 
doWrôeTe°
 = 1;

792 *
aTime
;

793 *
aWrôe
;

794 *
aSñTime
;

795 
isFú°
 = 1;

796 
bSÀï
 = 0;

799 c⁄° *
zOut
 = "lsmtest_speed.gnuplot";

801 
u32
 
sys_mask
 = 0;

803 
	`ã°MÆlocUnö°Æl
(
	`tdb_lsm_ív
());

805 
i
=0; i<
nArg
; i++){

806 
	sO±
 {

807 c⁄° *
zO±
;

808 
isSwôch
;

809 } 
aO±
[] = {

822 
iSñ
;

824 
rc
 = 
	`ã°ArgSñe˘
(
aO±
, "¨gumít", 
azArg
[
i
], &
iSñ
);

825 if–
rc
 ) Ñc;

827 if–
aO±
[
iSñ
].
isSwôch
 ){

828 
i
++;

830 if–
i
>=
nArg
 ){

831 
	`ã°PrötEº‹
("›ti⁄ %†ªquúe†™árgumít\n", 
aO±
[
iSñ
].
zO±
);

834 if–
aO±
[
iSñ
].
isSwôch
==1 ){

835 
nRow
 = 
	`©oi
(
azArg
[
i
]);

837 if–
aO±
[
iSñ
].
isSwôch
==2 ){

838 
nSÀï
 = 
	`©oi
(
azArg
[
i
]);

840 if–
aO±
[
iSñ
].
isSwôch
==3 ){

841 
	sMode
 {

842 c⁄° *
zMode
;

843 
doRódTe°
;

844 
doWrôeTe°
;

845 } 
aMode
[] = {{"ro", 1, 0} , {"rw", 1, 1}, {"wo", 0, 1}, {0, 0, 0}};

846 
iMode
;

847 
rc
 = 
	`ã°ArgSñe˘
(
aMode
, "›ti⁄", 
azArg
[
i
], &
iMode
);

848 if–
rc
 ) Ñc;

849 
doRódTe°
 = 
aMode
[
iMode
].doReadTest;

850 
doWrôeTe°
 = 
aMode
[
iMode
].doWriteTest;

852 if–
aO±
[
iSñ
].
isSwôch
==4 ){

855 
zOut
 = 
azArg
[
i
];

859 
rc
 = 
	`ã°ArgSñe˘
(
aO±
, "sy°em", 
azArg
[
i
], &
iSñ
);

860 if–
rc
 ) Ñc;

861 
sys_mask
 |(1<<
iSñ
);

865 if–
sys_mask
==0 ) sys_mask = (1 << 0) | (1 << 1) | (1 << 2) | (1 << 3);

866 
nRow
 = 
	`MAX
(nRow, 100000);

867 
nSãp
 = 
nRow
/100;

868 
nSñSãp
 = 
nRow
/10;

869 
nSñTe°
 = (
nSñSãp
 > 100000) ? 100000 :ÇSelStep;

871 
aTime
 = 
	`mÆloc
((Ë* 
	`AºaySize
(
aSys
Ë* 
nRow
/
nSãp
);

872 
aWrôe
 = 
	`mÆloc
((Ë* 
nRow
/
nSãp
);

873 
aSñTime
 = 
	`mÆloc
((Ë* 
	`AºaySize
(
aSys
Ë* 
nRow
/
nSñSãp
);

876 if–
doWrôeTe°
 ){

877 
	`¥ötf
("Wrôög ouçuàtÿfûê\"%s\".\n", 
zOut
);

879 
j
=0; 
aSys
[j].
zLibøry
; j++){

880 
FILE
 *
pLog
 = 0;

881 
Te°Db
 *
pDb
;

882 
lsm_db
 *
pLsm
;

883 
iDŸ
 = 0;

885 if–((1<<
j
)&
sys_mask
)==0 ) ;

886 if–
bSÀï
 && 
nSÀï
 ) 
	`sqlôe3_¶ìp
(nSleep);

887 
bSÀï
 = 1;

889 
	`ã°Ca£Begö
(&
rc
, 0, "•ìd.ö£π.%s", 
aSys
[
j
].
zLibøry
);

891 
rc
 = 
	`tdb_›í
(
aSys
[
j
].
zLibøry
, 0, 1, &
pDb
);

892 if–
rc
 ) Ñc;

894 
pLsm
 = 
	`c⁄figuª_lsm_db
(
pDb
);

896 
pLog
 = 
	`f›í
("/tmp/speed.log", "w");

897 
	`tdb_lsm_wrôe_hook
(
pDb
, 
do_•ìd_wrôe_hook2
, (*)
pLog
);

900 
	`ã°TimeInô
();

901 
i
=0; i<
nRow
; i+=
nSãp
){

902 
iSãp
;

903 
nWrôe1
, 
nWrôe2
;

904 
	`ã°Ca£Progªss
(
i
, 
nRow
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

905 if–
pLsm
 ) 
	`lsm_öfo
’Lsm, 
LSM_INFO_NWRITE
, &
nWrôe1
);

906 
iSãp
=0; iSãp<
nSãp
; iStep++){

907 
u32
 
aKey
[4];

908 
u32
 
aVÆ
[25];

909 
	`ã°P∫gAºay
(
i
+
iSãp
, 
aKey
, 
	`AºaySize
(aKey));

910 
	`ã°P∫gAºay
(
i
+
iSãp
, 
aVÆ
, 
	`AºaySize
(aVal));

911 
rc
 = 
	`tdb_wrôe
(
pDb
, 
aKey
, ◊Key), 
aVÆ
, (aVal));

913 
aTime
[(
j
*
nRow
+
i
)/
nSãp
] = 
	`ã°TimeGë
();

914 if–
pLsm
 ) 
	`lsm_öfo
’Lsm, 
LSM_INFO_NWRITE
, &
nWrôe2
);

915 
aWrôe
[
i
/
nSãp
] = 
nWrôe2
 - 
nWrôe1
;

918 
	`tdb_˛o£
(
pDb
);

919 if–
pLog
 ) 
	`f˛o£
(pLog);

920 
	`ã°Ca£Föish
(
rc
);

925 if–
doRódTe°
 ){

926 
j
=0; 
aSys
[j].
zLibøry
; j++){

927 
iDŸ
 = 0;

928 
Te°Db
 *
pDb
;

930 if–((1<<
j
)&
sys_mask
)==0 ) ;

931 if–
bSÀï
 && 
nSÀï
 ) 
	`sqlôe3_¶ìp
(nSleep);

932 
bSÀï
 = 1;

934 
	`ã°Ca£Begö
(&
rc
, 0, "•ìd.£À˘.%s", 
aSys
[
j
].
zLibøry
);

936 if–
doWrôeTe°
 ){

937 
rc
 = 
	`tdb_›í
(
aSys
[
j
].
zLibøry
, 0, 1, &
pDb
);

938 if–
rc
 ) Ñc;

939 
	`c⁄figuª_lsm_db
(
pDb
);

941 
i
=0; i<
nRow
; i+=
nSñSãp
){

942 
iSãp
;

943 
iSñ
;

944 
	`ã°Ca£Progªss
(
i
, 
nRow
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

945 
iSãp
=0; iSãp<
nSñSãp
; iStep++){

946 
u32
 
aKey
[4];

947 
u32
 
aVÆ
[25];

948 
	`ã°P∫gAºay
(
i
+
iSãp
, 
aKey
, 
	`AºaySize
(aKey));

949 
	`ã°P∫gAºay
(
i
+
iSãp
, 
aVÆ
, 
	`AºaySize
(aVal));

950 
rc
 = 
	`tdb_wrôe
(
pDb
, 
aKey
, ◊Key), 
aVÆ
, (aVal));

953 
	`ã°TimeInô
();

954 
iSñ
=0; iSñ<
nSñTe°
; iSel++){

955 *
pDummy
;

956 
nDummy
;

957 
u32
 
iKey
;

958 
u32
 
aKey
[4];

960 
iKey
 = 
	`ã°P∫gVÆue
(
iSñ
Ë% (
i
+
nSñSãp
);

961 
	`ã°P∫gAºay
(
iKey
, 
aKey
, 
	`AºaySize
(aKey));

962 
rc
 = 
	`tdb_„tch
(
pDb
, 
aKey
, ◊Key), &
pDummy
, &
nDummy
);

964 
aSñTime
[(
j
*
nRow
+
i
)/
nSñSãp
] = 
	`ã°TimeGë
();

965 
	`tdb_„tch
(
pDb
, 0, 0, 0, 0);

968 
t
;

969 
iSñ
;

971 
rc
 = 
	`tdb_›í
(
aSys
[
j
].
zLibøry
, 0, 0, &
pDb
);

972 
	`c⁄figuª_lsm_db
(
pDb
);

974 
	`ã°TimeInô
();

975 
iSñ
=0; 
rc
==
LSM_OK
 && iSñ<
nSñTe°
; iSel++){

976 *
pDummy
;

977 
nDummy
;

978 
u32
 
iKey
;

979 
u32
 
aKey
[4];

981 
	`ã°Ca£Progªss
(
iSñ
, 
nSñTe°
, 
	`ã°Ca£NDŸ
(), &
iDŸ
);

983 
iKey
 = 
	`ã°P∫gVÆue
(
iSñ
Ë% 
nRow
;

984 
	`ã°P∫gAºay
(
iKey
, 
aKey
, 
	`AºaySize
(aKey));

985 
rc
 = 
	`tdb_„tch
(
pDb
, 
aKey
, ◊Key), &
pDummy
, &
nDummy
);

987 #i‚de‡
NDEBUG


988 
u32
 
aVÆ
[25];

989 
	`ã°P∫gAºay
(
iKey
, 
aVÆ
, 
	`AºaySize
(aVal));

990 
	`as£π
–
nDummy
==100 && 
	`memcmp
(
aVÆ
, 
pDummy
, 100)==0 );

993 if–
rc
!=
LSM_OK
 ) Ñc;

995 
t
 = 
	`ã°TimeGë
();

996 
	`tdb_„tch
(
pDb
, 0, 0, 0, 0);

998 
	`¥ötf
("%s: %d selects/second\n",

999 
aSys
[
j
].
zLibøry
, ()(()
nSñTe°
*1000.0/
t
)

1003 
	`tdb_˛o£
(
pDb
);

1004 
	`ã°Ca£Föish
(
rc
);

1009 if–
doWrôeTe°
 ){

1010 
FILE
 *
pOut
 = 
	`f›í
(
zOut
, "w");

1011 if–!
pOut
 ){

1012 
	`¥ötf
("f›í(\"%s\", \"w\"): %s\n", 
zOut
, 
	`°ªº‹
(
î∫o
));

1016 
	`Ârötf
(
pOut
, "set xlabel \"Rows Inserted\"\n");

1017 
	`Ârötf
(
pOut
, "set ylabel \"InsertsÖer second\"\n");

1018 if–
doRódTe°
 ){

1019 
	`Ârötf
(
pOut
, "set y2label \"SelectsÖer second\"\n");

1020 }if–
sys_mask
==(1<<2) ){

1021 
	`Ârötf
(
pOut
, "set y2label \"Page writesÖer insert\"\n");

1023 
	`Ârötf
(
pOut
, "set yrange [0:*]\n");

1024 
	`Ârötf
(
pOut
, "set y2range [0:*]\n");

1025 
	`Ârötf
(
pOut
, "£àxøngê[%d:*]\n", 
	`MAX
(
nSãp
, 
nRow
/20) );

1026 
	`Ârötf
(
pOut
, "set yticsÇomirror\n");

1027 
	`Ârötf
(
pOut
, "set y2ticsÇomirror\n");

1028 
	`Ârötf
(
pOut
, "set key boxÜw 0.01\n");

1029 
	`Ârötf
(
pOut
, "plot ");

1031 
j
=0; 
aSys
[j].
zLibøry
; j++){

1032 if–(1<<
j
)&
sys_mask
 ){

1033 c⁄° *
zLib
 = 
aSys
[
j
].
zLibøry
;

1034 
	`Ârötf
(
pOut
, "%s\"-\"Åi \"%s INSERT\" withÜinesÜcÑgb \"%s\" ",

1035 (
isFú°
?"":", "), 
zLib
, 
aSys
[
j
].
zCﬁ‹


1037 if–
doRódTe°
 ){

1038 
	`Ârötf
(
pOut
, ", \"-\"Åi \"%s SELECT\" "

1040 , 
zLib
, 
aSys
[
j
].
zCﬁ‹


1043 
isFú°
 = 0;

1047 
	`as£π
–
	`°rcmp
(
aSys
[2].
zLibøry
, "lsm")==0 );

1048 if–
sys_mask
==(1<<2Ë&& !
doRódTe°
 ){

1049 
	`Ârötf
(
pOut
, ", \"-\"Åi \"lsmÖages written\" "

1054 
	`Ârötf
(
pOut
, "\n");

1056 
j
=0; 
aSys
[j].
zLibøry
; j++){

1057 if–((1<<
j
)&
sys_mask
)==0 ) ;

1058 
	`Ârötf
(
pOut
, "# Rows InsertsÖer second\n");

1059 
i
=0; i<
nRow
; i+=
nSãp
){

1060 
iTime
 = 
aTime
[(
j
*
nRow
+
i
)/
nSãp
];

1061 
ùs
 = ()((
i
+
nSãp
)*1000.0 / ()
iTime
);

1062 
	`Ârötf
(
pOut
, "%d %d\n", 
i
+
nSãp
, 
ùs
);

1064 
	`Ârötf
(
pOut
, "end\n");

1066 if–
doRódTe°
 ){

1067 
	`Ârötf
(
pOut
, "# Rows SelectsÖer second\n");

1068 
i
=0; i<
nRow
; i+=
nSñSãp
){

1069 
•s
 = ()(
nSñTe°
*1000.0/()
aSñTime
[(
j
*
nRow
+
i
)/
nSñSãp
]);

1070 
	`Ârötf
(
pOut
, "%d %d\n", 
i
+
nSñSãp
, 
•s
);

1072 
	`Ârötf
(
pOut
, "end\n");

1073 }if–
sys_mask
==(1<<2) ){

1074 
i
=0; i<(
nRow
/
nSãp
); i++){

1075 
	`Ârötf
(
pOut
, "%d %f\n", 
i
*
nSãp
, ()
aWrôe
[i] / ()nStep);

1077 
	`Ârötf
(
pOut
, "end\n");

1081 
	`Ârötf
(
pOut
, "pause -1\n");

1082 
	`f˛o£
(
pOut
);

1085 
	`‰ì
(
aTime
);

1086 
	`‰ì
(
aSñTime
);

1087 
	`‰ì
(
aWrôe
);

1088 
	`ã°MÆlocIn°Æl
(
	`tdb_lsm_ív
());

1090 
	}
}

1102 
	$do_øndom_ã°s
(
nArg
, **
azArg
){

1103 
i
;

1104 
nR™d
;

1105 if–
nArg
==0 ){

1106 
nR™d
 = 10;

1107 }if–
nArg
==1 ){

1108 
nR™d
 = 
	`©oi
(
azArg
[0]);

1110 
	`ã°PrötEº‹
("Usage:Ñandom ?N?\n");

1113 
i
=0; i<
nR™d
; i++){

1114 
	`¥ötf
("0x%x\n", 
	`ã°P∫gVÆue
(
i
));

1117 
	}
}

1119 
	$ã°F‹m©Size
(*
aBuf
, 
nBuf
, 
i64
 
nByã
){

1120 
ªs
;

1121 if–
nByã
<(1<<10) ){

1122 
ªs
 = 
	`¢¥ötf
(
aBuf
, 
nBuf
, "%d byã", ()
nByã
);

1123 }if–
nByã
<(1<<20) ){

1124 
ªs
 = 
	`¢¥ötf
(
aBuf
, 
nBuf
, "%dK", ()(
nByã
/(1<<10)));

1126 
ªs
 = 
	`¢¥ötf
(
aBuf
, 
nBuf
, "%dM", ()(
nByã
/(1<<20)));

1128  
ªs
;

1129 
	}
}

1131 
i64
 
	$ã°RódSize
(*
z
){

1132 
n
 = 
	`°æí
(
z
);

1133 
c
 = 
z
[
n
-1];

1134 
i64
 
nMul
 = 1;

1136  
c
 ){

1138 
nMul
 = (1<<30);

1142 
nMul
 = (1<<20);

1146 
nMul
 = (1<<10);

1150 
nMul
 = 1;

1153  
nMul
 * (
i64
)
	`©oi
(
z
);

1154 
	}
}

1159 
	$do_wrôî_ã°
(
nArg
, **
azArg
){

1160 
nBlock
;

1161 
nSize
;

1162 
i
;

1163 
fd
;

1164 
ms
;

1165 
aFûesize
[32];

1166 
aBlockSize
[32];

1168 *
aPage
;

1169 *
aOrdî
;

1170 
nSync
;

1172 
i64
 
fûesize
;

1173 
i64
 
blocksize
;

1174 
i64
 
syncsize
;

1175 
nPage
 = 4096;

1179 c⁄° 
nSÀï
 = 10000;

1181 c⁄° 
nSÀï
 = 0;

1183 if–
nArg
!=3 ){

1184 
	`ã°PrötUßge
("FILESIZE BLOCKSIZE SYNCSIZE");

1188 
fûesize
 = 
	`ã°RódSize
(
azArg
[0]);

1189 
blocksize
 = 
	`ã°RódSize
(
azArg
[1]);

1190 
syncsize
 = 
	`ã°RódSize
(
azArg
[2]);

1192 
nBlock
 = ()(
fûesize
 / 
blocksize
);

1193 
nSize
 = ()
blocksize
;

1194 
nSync
 = ()(
syncsize
 / 
blocksize
);

1196 
aPage
 = (*)
	`mÆloc
(4096);

1197 
aOrdî
 = (*)
	`mÆloc
(
nBlock
 * ());

1198 
i
=0; i<
nBlock
; i++Ë
aOrdî
[i] = i;

1199 
i
=0; i<(
nBlock
*25); i++){

1200 
tmp
;

1201 
u32
 
a
 = 
	`ã°P∫gVÆue
(
i
);

1202 
u32
 
b
 = 
	`ã°P∫gVÆue
(
a
);

1203 
a
 =á % 
nBlock
;

1204 
b
 = b % 
nBlock
;

1205 
tmp
 = 
aOrdî
[
a
];

1206 
aOrdî
[
a
] =áOrdî[
b
];

1207 
aOrdî
[
b
] = 
tmp
;

1210 
	`ã°F‹m©Size
(
aFûesize
, ◊Fûesize), (
i64
)
nBlock
 * (i64)
nSize
);

1211 
	`ã°F‹m©Size
(
aBlockSize
, (
aFûesize
), 
nSize
);

1213 
	`¥ötf
("Te°ög wrôögá %†fûêusög %†blocks. ", 
aFûesize
, 
aBlockSize
);

1214 if–
nSync
==1 ){

1215 
	`¥ötf
("SyncáfterÉach block.\n");

1217 
	`¥ötf
("Syn¯a·îÉach %d blocks.\n", 
nSync
);

1220 
	`¥ötf
("Preparing file... ");

1221 
	`fÊush
(
°dout
);

1222 
	`u∆ök
("writer.out");

1223 
fd
 = 
	`›í
("wrôî.out", 
O_RDWR
|
O_CREAT
, 0664);

1224 if–
fd
<0 ){

1225 
	`ã°PrötEº‹
("›í(): %d - %s\n", 
î∫o
, 
	`°ªº‹
(errno));

1228 
	`ã°TimeInô
();

1229 
i
=0; i<
nBlock
; i++){

1230 
iPg
;

1231 
	`mem£t
(
aPage
, 
i
&0xFF, 
nPage
);

1232 
iPg
=0; iPg<(
nSize
/
nPage
); iPg++){

1233 
	`wrôe
(
fd
, 
aPage
, 
nPage
);

1236 
	`fsync
(
fd
);

1237 
	`¥ötf
("ok (%d ms)\n", 
	`ã°TimeGë
());

1239 
i
=0; i<5; i++){

1240 
j
;

1242 
	`sqlôe3_¶ìp
(
nSÀï
);

1243 
	`¥ötf
("Now writing sequentially... ");

1244 
	`fÊush
(
°dout
);

1246 
	`l£ek
(
fd
, 0, 
SEEK_SET
);

1247 
	`ã°TimeInô
();

1248 
j
=0; j<
nBlock
; j++){

1249 
iPg
;

1250 if–((
j
+1)%
nSync
)==0 ) 
	`fd©async
(
fd
);

1251 
	`mem£t
(
aPage
, 
j
&0xFF, 
nPage
);

1252 
iPg
=0; iPg<(
nSize
/
nPage
); iPg++){

1253 
	`wrôe
(
fd
, 
aPage
, 
nPage
);

1256 
	`fd©async
(
fd
);

1257 
ms
 = 
	`ã°TimeGë
();

1258 
	`¥ötf
("%d ms\n", 
ms
);

1259 
	`sqlôe3_¶ìp
(
nSÀï
);

1260 
	`¥ötf
("Now inánárbitrary order... ");

1262 
	`fÊush
(
°dout
);

1263 
	`ã°TimeInô
();

1264 
j
=0; j<
nBlock
; j++){

1265 
iPg
;

1266 if–((
j
+1)%
nSync
)==0 ) 
	`fd©async
(
fd
);

1267 
	`l£ek
(
fd
, 
aOrdî
[
j
]*
nSize
, 
SEEK_SET
);

1268 
	`mem£t
(
aPage
, 
j
&0xFF, 
nPage
);

1269 
iPg
=0; iPg<(
nSize
/
nPage
); iPg++){

1270 
	`wrôe
(
fd
, 
aPage
, 
nPage
);

1273 
	`fd©async
(
fd
);

1274 
ms
 = 
	`ã°TimeGë
();

1275 
	`¥ötf
("%d ms\n", 
ms
);

1278 
	`˛o£
(
fd
);

1279 
	`‰ì
(
aPage
);

1280 
	`‰ì
(
aOrdî
);

1283 
	}
}

1285 
	$do_ö£π_w‹k_hook
(
lsm_db
 *
db
, *
p
){

1286 *
z
 = 0;

1287 
	`lsm_öfo
(
db
, 
LSM_INFO_DB_STRUCTURE
, &
z
);

1288 if–
z
 ){

1289 
	`¥ötf
("%s\n", 
z
);

1290 
	`fÊush
(
°dout
);

1291 
	`lsm_‰ì
(
	`lsm_gë_ív
(
db
), 
z
);

1294 
	`unu£d_∑ømëî
(
p
);

1295 
	}
}

1297 
In£πWrôeHook
 
	tIn£πWrôeHook
;

1298 
	sIn£πWrôeHook
 {

1299 
FILE
 *
	mpOut
;

1300 
	mbLog
;

1301 
i64
 
	miOff
;

1302 
	mnD©a
;

1305 
	$ÊushHook
(
In£πWrôeHook
 *
pHook
){

1306 if–
pHook
->
nD©a
 ){

1307 
	`Ârötf
(
pHook
->
pOut
, "write %s %d %d\n",

1308 (
pHook
->
bLog
 ? "log" : "db"), (ÌHook->
iOff
,ÖHook->
nD©a


1310 
pHook
->
nD©a
 = 0;

1311 
	`fÊush
(
pHook
->
pOut
);

1313 
	}
}

1315 
	$do_ö£π_wrôe_hook
(

1316 *
pCtx
,

1317 
bLog
,

1318 
i64
 
iOff
,

1319 
nD©a
,

1320 
nUs


1322 
In£πWrôeHook
 *
pHook
 = (In£πWrôeHook *)
pCtx
;

1323 if–
bLog
 ) ;

1325 if–
nD©a
==0 ){

1326 
	`ÊushHook
(
pHook
);

1327 
	`Ârötf
(
pHook
->
pOut
, "syn¯%s\n", (
bLog
 ? "log" : "db"));

1328 }if–
pHook
->
nD©a


1329 && 
bLog
==
pHook
->bLog

1330 && 
iOff
==(
pHook
->iOff+pHook->
nD©a
)

1332 
pHook
->
nD©a
 +=ÇData;

1334 
	`ÊushHook
(
pHook
);

1335 
pHook
->
bLog
 = bLog;

1336 
pHook
->
iOff
 = iOff;

1337 
pHook
->
nD©a
 =ÇData;

1339 
	}
}

1341 
	$do_ª∂ay
(
nArg
, **
azArg
){

1342 
aBuf
[4096];

1343 
FILE
 *
pI≈ut
;

1344 
FILE
 *
pClo£
 = 0;

1345 c⁄° *
zDb
;

1347 
lsm_ív
 *
pEnv
;

1348 
lsm_fûe
 *
pOut
;

1349 
rc
;

1351 if–
nArg
!=2 ){

1352 
	`ã°PrötEº‹
("Usage:Ñeplay WRITELOG FILE\n");

1356 if–
	`°rcmp
(
azArg
[0], "-")==0 ){

1357 
pI≈ut
 = 
°dö
;

1359 
pClo£
 = 
pI≈ut
 = 
	`f›í
(
azArg
[0], "r");

1361 
zDb
 = 
azArg
[1];

1362 
pEnv
 = 
	`tdb_lsm_ív
();

1363 
rc
 = 
pEnv
->
	`xO≥n
’Env, 
zDb
, 0, &
pOut
);

1364 if–
rc
!=
LSM_OK
 ) Ñc;

1366  
	`„of
(
pI≈ut
)==0 ){

1367 
zLöe
[80];

1368 
	`fgës
(
zLöe
, (zLöe)-1, 
pI≈ut
);

1369 
zLöe
[(zLine)-1] = '\0';

1371 if–0==
	`memcmp
("syn¯db", 
zLöe
, 7) ){

1372 
rc
 = 
pEnv
->
	`xSync
(
pOut
);

1373 if–
rc
!=0 ) ;

1375 
iOff
;

1376 
nD©a
;

1377 
nM©ch
;

1378 
nM©ch
 = 
	`ssˇnf
(
zLöe
, "wrôêdb %d %d", &
iOff
, &
nD©a
);

1379 if–
nM©ch
==2 ){

1380 
i
;

1381 
i
=0; i<
nD©a
; i+=(
aBuf
)){

1382 
	`mem£t
(
aBuf
, 
i
&0xFF, (aBuf));

1383 
rc
 = 
pEnv
->
	`xWrôe
(
pOut
, 
iOff
+
i
, 
aBuf
, (aBuf));

1384 if–
rc
!=0 ) ;

1389 if–
pClo£
 ) 
	`f˛o£
(pClose);

1390 
pEnv
->
	`xClo£
(
pOut
);

1392  
rc
;

1393 
	}
}

1395 
	$do_ö£π
(
nArg
, **
azArg
){

1396 c⁄° *
zDb
 = "lsm";

1397 
Te°Db
 *
pDb
 = 0;

1398 
i
;

1399 
rc
;

1400 c⁄° 
nRow
 = 1 * 1000 * 1000;

1402 
D©asour˚De‚
 
de‚
 = { 
TEST_DATASOURCE_RANDOM
, 8, 15, 80, 150 };

1403 
D©asour˚
 *
pD©a
 = 0;

1405 if–
nArg
>1 ){

1406 
	`ã°PrötEº‹
("Usage: insert ?DATABASE?\n");

1409 if–
nArg
==1 ){ 
zDb
 = 
azArg
[0]; }

1411 
	`ã°MÆlocUnö°Æl
(
	`tdb_lsm_ív
());

1412 
i
=0; 
zDb
[i] && zDb[i]!='='; i++);

1413 if–
zDb
[
i
] ){

1414 
rc
 = 
	`tdb_lsm_›í
(
zDb
, "ã°db.lsm", 1, &
pDb
);

1416 
rc
 = 
	`tdb_›í
(
zDb
, 0, 1, &
pDb
);

1419 if–
rc
!=0 ){

1420 
	`ã°PrötEº‹
("Eº‹ o≥nög db \"%s\": %d\n", 
zDb
, 
rc
);

1422 
In£πWrôeHook
 
hook
;

1423 
	`mem£t
(&
hook
, 0, (hook));

1424 
hook
.
pOut
 = 
	`f›í
("writelog.txt", "w");

1426 
pD©a
 = 
	`ã°D©asour˚New
(&
de‚
);

1427 
	`tdb_lsm_c⁄fig_w‹k_hook
(
pDb
, 
do_ö£π_w‹k_hook
, 0);

1428 
	`tdb_lsm_wrôe_hook
(
pDb
, 
do_ö£π_wrôe_hook
, (*)&
hook
);

1430 if–
rc
==0 ){

1431 
i
=0; i<
nRow
; i++){

1432 *
pKey
; 
nKey
;

1433 *
pVÆ
; 
nVÆ
;

1434 
	`ã°D©asour˚E¡ry
(
pD©a
, 
i
, &
pKey
, &
nKey
, &
pVÆ
, &
nVÆ
);

1435 
	`tdb_wrôe
(
pDb
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

1439 
	`ã°D©asour˚Fªe
(
pD©a
);

1440 
	`tdb_˛o£
(
pDb
);

1441 
	`ÊushHook
(&
hook
);

1442 
	`f˛o£
(
hook
.
pOut
);

1444 
	`ã°MÆlocIn°Æl
(
	`tdb_lsm_ív
());

1446  
rc
;

1447 
	}
}

1449 
	$°_do_show
(
a
, **
b
Ë{  
	`do_show
◊, b); 
	}
}

1450 
	$°_do_w‹k
(
a
, **
b
Ë{  
	`do_w‹k
◊, b); 
	}
}

1451 
	$°_do_io
(
a
, **
b
Ë{  
	`do_io
◊, b); 
	}
}

1453 #ifde‡
__löux__


1454 
	~<sys/time.h
>

1455 
	~<sys/ªsour˚.h
>

1457 
	$lsmã°_rußge_ªp‹t
(){

1458 
rußge
 
r
;

1459 
	`mem£t
(&
r
, 0, (r));

1461 
	`gërußge
(
RUSAGE_SELF
, &
r
);

1462 
	`¥ötf
("# getrusage: {Ñu_maxrss %dÑu_oublock %dÑu_inblock %d }\n",

1463 ()
r
.
ru_maxrss
, (Ï.
ru_oublock
, (Ï.
ru_öblock


1465 
	}
}

1467 
	$lsmã°_rußge_ªp‹t
(){

1469 
	}
}

1472 
	$maö
(
¨gc
, **
¨gv
){

1473 
	sTe°Func
 {

1474 c⁄° *
zName
;

1475 
bRußgeRï‹t
;

1476 (*
xFunc
)(, **);

1477 } 
aTe°
[] = {

1478 {"øndom", 1, 
do_øndom_ã°s
},

1479 {"wrôe•ìd", 1, 
do_wrôî_ã°
},

1480 {"io", 1, 
°_do_io
},

1482 {"ö£π", 1, 
do_ö£π
},

1483 {"ª∂ay", 1, 
do_ª∂ay
},

1485 {"•ìd", 1, 
do_•ìd_ã°s
},

1486 {"•ìd2", 1, 
do_•ìd_ã°2
},

1487 {"show", 0, 
°_do_show
},

1488 {"w‹k", 1, 
°_do_w‹k
},

1489 {"ã°", 1, 
do_ã°
},

1491 {"bt", 0, 
do_bt
},

1494 
rc
;

1495 
iFunc
;

1497 
nLókAŒoc
 = 0;

1498 
nLókByã
 = 0;

1500 #ifde‡
LSM_DEBUG_MEM


1501 
FILE
 *
pRï‹t
 = 0;

1502 c⁄° *
zRï‹t
 = "malloc.txt generated";

1504 c⁄° *
zRï‹t
 = "malloc.txt NOT generated";

1507 
	`ã°MÆlocIn°Æl
(
	`tdb_lsm_ív
());

1509 if–
¨gc
<2 ){

1510 
	`ã°PrötEº‹
("Ußge: %†sub-comm™d ?¨gs...?\n", 
¨gv
[0]);

1515 
	`ã°Eº‹Inô
(
¨gc
, 
¨gv
);

1518 
	`ã°P∫gInô
();

1520 
rc
 = 
	`ã°ArgSñe˘
(
aTe°
, "sub-comm™d", 
¨gv
[1], &
iFunc
);

1521 if–
rc
==0 ){

1522 
rc
 = 
aTe°
[
iFunc
].
	`xFunc
(
¨gc
-2, &
¨gv
[2]);

1525 #ifde‡
LSM_DEBUG_MEM


1526 
pRï‹t
 = 
	`f›í
("malloc.txt", "w");

1527 
	`ã°MÆlocCheck
(
	`tdb_lsm_ív
(), &
nLókAŒoc
, &
nLókByã
, 
pRï‹t
);

1528 
	`f˛o£
(
pRï‹t
);

1530 
	`ã°MÆlocCheck
(
	`tdb_lsm_ív
(), &
nLókAŒoc
, &
nLókByã
, 0);

1533 if–
nLókAŒoc
 ){

1534 
	`ã°PrötEº‹
("Leaked %d bytes in %dállocations (%s)\n",

1535 
nLókByã
, 
nLókAŒoc
, 
zRï‹t


1537 if–
rc
==0 )Ñc = -1;

1539 
	`ã°MÆlocUnö°Æl
(
	`tdb_lsm_ív
());

1541 if–
aTe°
[
iFunc
].
bRußgeRï‹t
 ){

1542 
	`lsmã°_rußge_ªp‹t
();

1544  
rc
;

1545 
	}
}

	@lsm-test/lsmtest_mem.c

2 
	~<°dio.h
>

3 
	~<as£π.h
>

4 
	~<°rög.h
>

6 
	#AºaySize
(
x
Ë(()((xË/ ((x)[0])))

	)

8 
	#MIN
(
x
,
y
Ë((x)<(yË? (xË: (y))

	)

10 
	tu32
;

11 
	tu8
;

12 
	ti64
;

13 
	tu64
;

15 #i‡
deföed
(
__GLIBC__
Ë&& deföed(
LSM_DEBUG_MEM
)

16 
backåa˚
(**,);

17 
backåa˚_symbﬁs_fd
(*const*,,);

18 
	#TM_BACKTRACE
 12

	)

20 
	#backåa˚
(
A
,
B
Ë1

	)

21 
	#backåa˚_symbﬁs_fd
(
A
,
B
,
C
)

	)

25 
TmBlockHdr
 
	tTmBlockHdr
;

26 
TmAgg
 
	tTmAgg
;

27 
TmGlobÆ
 
	tTmGlobÆ
;

29 
	sTmGlobÆ
 {

32 
TmBlockHdr
 *
	mpFú°
;

33 #ifde‡
TM_BACKTRACE


34 
TmAgg
 *
	maHash
[10000];

38 *(*
	mxMÆloc
)();

39 *(*
	mxRóŒoc
)(*, );

40 (*
	mxFªe
)(*);

43 (*
	mxE¡îMuãx
)(
	mTmGlobÆ
*);

44 (*
	mxLóveMuãx
)(
	mTmGlobÆ
*);

45 (*
	mxDñMuãx
)(
	mTmGlobÆ
*);

46 *
	mpMuãx
;

48 *
	mxSaveMÆloc
;

49 *
	mxSaveRóŒoc
;

50 *
	mxSaveFªe
;

58 
	mnCou¡down
;

59 
	mbPîsi°
;

60 
	mbE«bÀ
;

61 (*
	mxHook
)(*);

62 *
	mpHookCtx
;

65 
	sTmBlockHdr
 {

66 
TmBlockHdr
 *
	mpNext
;

67 
TmBlockHdr
 *
	mpPªv
;

68 
	mnByã
;

69 #ifde‡
TM_BACKTRACE


70 
TmAgg
 *
	mpAgg
;

72 
u32
 
	miF‹eGu¨d
;

75 #ifde‡
TM_BACKTRACE


76 
	sTmAgg
 {

77 
	mnAŒoc
;

78 
	mnByã
;

79 
	mnOutAŒoc
;

80 
	mnOutByã
;

81 *
	maFøme
[
TM_BACKTRACE
];

82 
TmAgg
 *
	mpNext
;

86 
	#FOREGUARD
 0x80F5E153

	)

87 
	#REARGUARD
 0xE4676B53

	)

88 c⁄° 
u32
 
	gª¨gu¨d
 = 
REARGUARD
;

90 
	#ROUND8
(
x
Ë(((x)+7)&~7)

	)

92 
	#BLOCK_HDR_SIZE
 (
	`ROUND8
–(
TmBlockHdr
Ë))

	)

94 
	$lsmã°_oom_îr‹
(){

95 
nEº
 = 0;

96 
nEº
++;

97 
	}
}

99 
	$tmE¡îMuãx
(
TmGlobÆ
 *
pTm
){

100 
pTm
->
	`xE¡îMuãx
(pTm);

101 
	}
}

102 
	$tmLóveMuãx
(
TmGlobÆ
 *
pTm
){

103 
pTm
->
	`xLóveMuãx
(pTm);

104 
	}
}

106 *
	$tmMÆloc
(
TmGlobÆ
 *
pTm
, 
nByã
){

107 
TmBlockHdr
 *
pNew
;

108 
u8
 *
pU£r
;

109 
nReq
;

111 
	`as£π
–(
ª¨gu¨d
)==4 );

112 
nReq
 = 
BLOCK_HDR_SIZE
 + 
nByã
 + 4;

113 
pNew
 = (
TmBlockHdr
 *)
pTm
->
	`xMÆloc
(
nReq
);

114 
	`mem£t
(
pNew
, 0, (
TmBlockHdr
));

116 
	`tmE¡îMuãx
(
pTm
);

117 
	`as£π
–
pTm
->
nCou¡down
>=0 );

118 
	`as£π
–
pTm
->
bPîsi°
==0 ||ÖTm->bPersist==1 );

120 if–
pTm
->
bE«bÀ
 &&ÖTm->
nCou¡down
==1 ){

122 
	`lsmã°_oom_îr‹
();

123 
pTm
->
	`xFªe
(
pNew
);

124 
pTm
->
nCou¡down
 =ÖTm->
bPîsi°
;

125 if–
pTm
->
xHook
 )ÖTm->
	`xHook
’Tm->
pHookCtx
);

126 
pU£r
 = 0;

128 if–
pTm
->
bE«bÀ
 &&ÖTm->
nCou¡down
 )ÖTm->nCountdown--;

130 
pNew
->
iF‹eGu¨d
 = 
FOREGUARD
;

131 
pNew
->
nByã
 =ÇByte;

132 
pNew
->
pNext
 = 
pTm
->
pFú°
;

134 if–
pTm
->
pFú°
 ){

135 
pTm
->
pFú°
->
pPªv
 = 
pNew
;

137 
pTm
->
pFú°
 = 
pNew
;

139 
pU£r
 = &((
u8
 *)
pNew
)[
BLOCK_HDR_SIZE
];

140 
	`mem£t
(
pU£r
, 0x56, 
nByã
);

141 
	`mem˝y
(&
pU£r
[
nByã
], &
ª¨gu¨d
, 4);

143 #ifde‡
TM_BACKTRACE


145 
TmAgg
 *
pAgg
;

146 
i
;

147 
u32
 
iHash
 = 0;

148 *
aFøme
[
TM_BACKTRACE
];

149 
	`mem£t
(
aFøme
, 0, (aFrame));

150 
	`backåa˚
(
aFøme
, 
TM_BACKTRACE
);

152 
i
=0; i<
	`AºaySize
(
aFøme
); i++){

153 
iHash
 +(
u64
)(
aFøme
[
i
]) + (iHash<<3);

155 
iHash
 = iHash % 
	`AºaySize
(
pTm
->
aHash
);

157 
pAgg
=
pTm
->
aHash
[
iHash
];ÖAgg;ÖAggıAgg->
pNext
){

158 if–
	`memcmp
(
pAgg
->
aFøme
,áFrame, (aFrame))==0 ) ;

160 if–!
pAgg
 ){

161 
pAgg
 = (
TmAgg
 *)
pTm
->
	`xMÆloc
((TmAgg));

162 
	`mem£t
(
pAgg
, 0, (
TmAgg
));

163 
	`mem˝y
(
pAgg
->
aFøme
,áFrame, (aFrame));

164 
pAgg
->
pNext
 = 
pTm
->
aHash
[
iHash
];

165 
pTm
->
aHash
[
iHash
] = 
pAgg
;

167 
pAgg
->
nAŒoc
++;

168 
pAgg
->
nByã
 +=ÇByte;

169 
pAgg
->
nOutAŒoc
++;

170 
pAgg
->
nOutByã
 +
nByã
;

171 
pNew
->
pAgg
 =ÖAgg;

176 
	`tmLóveMuãx
(
pTm
);

177  
pU£r
;

178 
	}
}

180 
	$tmFªe
(
TmGlobÆ
 *
pTm
, *
p
){

181 if–
p
 ){

182 
TmBlockHdr
 *
pHdr
;

183 
u8
 *
pU£r
 = (u8 *)
p
;

185 
	`tmE¡îMuãx
(
pTm
);

186 
pHdr
 = (
TmBlockHdr
 *)&
pU£r
[
BLOCK_HDR_SIZE
 * -1];

187 
	`as£π
–
pHdr
->
iF‹eGu¨d
==
FOREGUARD
 );

188 
	`as£π
–0==
	`memcmp
(&
pU£r
[
pHdr
->
nByã
], &
ª¨gu¨d
, 4) );

190 if–
pHdr
->
pPªv
 ){

191 
	`as£π
–
pHdr
->
pPªv
->
pNext
==pHdr );

192 
pHdr
->
pPªv
->
pNext
 =ÖHdr->pNext;

194 
	`as£π
–
pHdr
==
pTm
->
pFú°
 );

195 
pTm
->
pFú°
 = 
pHdr
->
pNext
;

197 if–
pHdr
->
pNext
 ){

198 
	`as£π
–
pHdr
->
pNext
->
pPªv
==pHdr );

199 
pHdr
->
pNext
->
pPªv
 =ÖHdr->pPrev;

202 #ifde‡
TM_BACKTRACE


203 
pHdr
->
pAgg
->
nOutAŒoc
--;

204 
pHdr
->
pAgg
->
nOutByã
 -pHdr->
nByã
;

207 
	`tmLóveMuãx
(
pTm
);

208 
	`mem£t
(
pU£r
, 0x58, 
pHdr
->
nByã
);

209 
	`mem£t
(
pHdr
, 0x57, (
TmBlockHdr
));

210 
pTm
->
	`xFªe
(
pHdr
);

212 
	}
}

214 *
	$tmRóŒoc
(
TmGlobÆ
 *
pTm
, *
p
, 
nByã
){

215 *
pNew
;

217 
pNew
 = 
	`tmMÆloc
(
pTm
, 
nByã
);

218 if–
pNew
 && 
p
 ){

219 
TmBlockHdr
 *
pHdr
;

220 
u8
 *
pU£r
 = (u8 *)
p
;

221 
pHdr
 = (
TmBlockHdr
 *)&
pU£r
[
BLOCK_HDR_SIZE
 * -1];

222 
	`mem˝y
(
pNew
, 
p
, 
	`MIN
(
nByã
, 
pHdr
->nByte));

223 
	`tmFªe
(
pTm
, 
p
);

225  
pNew
;

226 
	}
}

228 
tmMÆlocOom
(

229 
TmGlobÆ
 *
pTm
,

230 
nCou¡down
,

231 
bPîsi°
,

232 (*
xHook
)(*),

233 *
pHookCtx


235 
	`as£π
–
nCou¡down
>=0 );

236 
	`as£π
–
bPîsi°
==0 || bPersist==1 );

237 
pTm
->
nCou¡down
 =ÇCountdown;

238 
pTm
->
bPîsi°
 = bPersist;

239 
pTm
->
xHook
 = xHook;

240 
pTm
->
pHookCtx
 =ÖHookCtx;

241 
pTm
->
bE«bÀ
 = 1;

242 
	}
}

244 
	$tmMÆlocOomE«bÀ
(

245 
TmGlobÆ
 *
pTm
,

246 
bE«bÀ


248 
pTm
->
bE«bÀ
 = bEnable;

249 
	}
}

251 
	$tmMÆlocCheck
(

252 
TmGlobÆ
 *
pTm
,

253 *
≤LókAŒoc
,

254 *
≤LókByã
,

255 
FILE
 *
pFûe


257 
TmBlockHdr
 *
pHdr
;

258 
nLók
 = 0;

259 
nByã
 = 0;

261 if–
pTm
==0 ) ;

263 
pHdr
=
pTm
->
pFú°
;ÖHdr;ÖHdrıHdr->
pNext
){

264 
nLók
++;

265 
nByã
 +
pHdr
->nByte;

267 if–
≤LókAŒoc
 ) *≤LókAŒo¯
nLók
;

268 if–
≤LókByã
 ) *≤LókByã = 
nByã
;

270 #ifde‡
TM_BACKTRACE


271 if–
pFûe
 ){

272 
i
;

273 
	`Ârötf
(
pFûe
, "LEAKS\n");

274 
i
=0; i<
	`AºaySize
(
pTm
->
aHash
); i++){

275 
TmAgg
 *
pAgg
;

276 
pAgg
=
pTm
->
aHash
[
i
];ÖAgg;ÖAggıAgg->
pNext
){

277 if–
pAgg
->
nOutAŒoc
 ){

278 
j
;

279 
	`Ârötf
(
pFûe
, "%d %d ", 
pAgg
->
nOutByã
,ÖAgg->
nOutAŒoc
);

280 
j
=0; j<
TM_BACKTRACE
; j++){

281 
	`Ârötf
(
pFûe
, "%∞", 
pAgg
->
aFøme
[
j
]);

283 
	`Ârötf
(
pFûe
, "\n");

287 
	`Ârötf
(
pFûe
, "\nALLOCATIONS\n");

288 
i
=0; i<
	`AºaySize
(
pTm
->
aHash
); i++){

289 
TmAgg
 *
pAgg
;

290 
pAgg
=
pTm
->
aHash
[
i
];ÖAgg;ÖAggıAgg->
pNext
){

291 
j
;

292 
	`Ârötf
(
pFûe
, "%d %d ", 
pAgg
->
nByã
,ÖAgg->
nAŒoc
);

293 
j
=0; j<
TM_BACKTRACE
; j++Ë
	`Ârötf
(
pFûe
, "%∞", 
pAgg
->
aFøme
[j]);

294 
	`Ârötf
(
pFûe
, "\n");

299 ()
pFûe
;

301 
	}
}

304 
	~"lsm.h
"

305 
	~"°dlib.h
"

307 
LsmMuãx
 
	tLsmMuãx
;

308 
	sLsmMuãx
 {

309 
lsm_ív
 *
	mpEnv
;

310 
lsm_muãx
 *
	mpMuãx
;

313 
	$tmLsmMuãxE¡î
(
TmGlobÆ
 *
pTm
){

314 
LsmMuãx
 *
p
 = (LsmMuãx *)
pTm
->
pMuãx
;

315 
p
->
pEnv
->
	`xMuãxE¡î
’->
pMuãx
);

316 
	}
}

317 
	$tmLsmMuãxLóve
(
TmGlobÆ
 *
pTm
){

318 
LsmMuãx
 *
p
 = (LsmMuãx *)(
pTm
->
pMuãx
);

319 
p
->
pEnv
->
	`xMuãxLóve
’->
pMuãx
);

320 
	}
}

321 
	$tmLsmMuãxDñ
(
TmGlobÆ
 *
pTm
){

322 
LsmMuãx
 *
p
 = (LsmMuãx *)
pTm
->
pMuãx
;

323 
pTm
->
	`xFªe
(
p
);

324 
	}
}

325 *
	$tmLsmMÆloc
(
n
){  
	`mÆloc
“); 
	}
}

326 
	$tmLsmFªe
(*
±r
){ 
	`‰ì
’å); 
	}
}

327 *
	$tmLsmRóŒoc
(*
±r
, 
n
){  
	`ªÆloc
’å,Ç); 
	}
}

329 *
	$tmLsmEnvMÆloc
(
lsm_ív
 *
p
, 
n
){

330  
	`tmMÆloc
((
TmGlobÆ
 *)(
p
->
pMemCtx
), 
n
);

331 
	}
}

332 
	$tmLsmEnvFªe
(
lsm_ív
 *
p
, *
±r
){

333 
	`tmFªe
((
TmGlobÆ
 *)(
p
->
pMemCtx
), 
±r
);

334 
	}
}

335 *
	$tmLsmEnvRóŒoc
(
lsm_ív
 *
p
, *
±r
, 
n
){

336  
	`tmRóŒoc
((
TmGlobÆ
 *)(
p
->
pMemCtx
), 
±r
, 
n
);

337 
	}
}

339 
	$ã°MÆlocIn°Æl
(
lsm_ív
 *
pEnv
){

340 
TmGlobÆ
 *
pGlobÆ
;

341 
LsmMuãx
 *
pMuãx
;

342 
	`as£π
–
pEnv
->
pMemCtx
==0 );

345 
pGlobÆ
 = (
TmGlobÆ
 *)
	`tmLsmMÆloc
((TmGlobal));

346 
	`mem£t
(
pGlobÆ
, 0, (
TmGlobÆ
));

347 
pGlobÆ
->
xMÆloc
 = 
tmLsmMÆloc
;

348 
pGlobÆ
->
xRóŒoc
 = 
tmLsmRóŒoc
;

349 
pGlobÆ
->
xFªe
 = 
tmLsmFªe
;

350 
pMuãx
 = (
LsmMuãx
 *)
pGlobÆ
->
	`xMÆloc
((LsmMutex));

351 
pMuãx
->
pEnv
 =ÖEnv;

352 
pEnv
->
	`xMuãxSètic
’Env, 
LSM_MUTEX_HEAP
, &
pMuãx
->pMutex);

353 
pGlobÆ
->
xE¡îMuãx
 = 
tmLsmMuãxE¡î
;

354 
pGlobÆ
->
xLóveMuãx
 = 
tmLsmMuãxLóve
;

355 
pGlobÆ
->
xDñMuãx
 = 
tmLsmMuãxDñ
;

356 
pGlobÆ
->
pMuãx
 = (*)pMutex;

358 
pGlobÆ
->
xSaveMÆloc
 = (*)
pEnv
->
xMÆloc
;

359 
pGlobÆ
->
xSaveRóŒoc
 = (*)
pEnv
->
xRóŒoc
;

360 
pGlobÆ
->
xSaveFªe
 = (*)
pEnv
->
xFªe
;

363 
pEnv
->
pMemCtx
 = (*)
pGlobÆ
;

364 
pEnv
->
xMÆloc
 = 
tmLsmEnvMÆloc
;

365 
pEnv
->
xRóŒoc
 = 
tmLsmEnvRóŒoc
;

366 
pEnv
->
xFªe
 = 
tmLsmEnvFªe
;

367 
	}
}

369 
	$ã°MÆlocUnö°Æl
(
lsm_ív
 *
pEnv
){

370 
TmGlobÆ
 *
p
 = (TmGlobÆ *)
pEnv
->
pMemCtx
;

371 
pEnv
->
pMemCtx
 = 0;

372 if–
p
 ){

373 
pEnv
->
xMÆloc
 = (*(*)(
lsm_ív
*, ))(
p
->
xSaveMÆloc
);

374 
pEnv
->
xRóŒoc
 = (*(*)(
lsm_ív
*, *, ))(
p
->
xSaveRóŒoc
);

375 
pEnv
->
xFªe
 = ((*)(
lsm_ív
*, *))(
p
->
xSaveFªe
);

376 
p
->
	`xDñMuãx
(p);

377 
	`tmLsmFªe
(
p
);

379 
	}
}

381 
	$ã°MÆlocCheck
(

382 
lsm_ív
 *
pEnv
,

383 *
≤LókAŒoc
,

384 *
≤LókByã
,

385 
FILE
 *
pFûe


387 if–
pEnv
->
pMemCtx
==0 ){

388 *
≤LókAŒoc
 = 0;

389 *
≤LókByã
 = 0;

391 
	`tmMÆlocCheck
((
TmGlobÆ
 *)(
pEnv
->
pMemCtx
), 
≤LókAŒoc
, 
≤LókByã
, 
pFûe
);

393 
	}
}

395 
ã°MÆlocOom
(

396 
lsm_ív
 *
pEnv
,

397 
nCou¡down
,

398 
bPîsi°
,

399 (*
xHook
)(*),

400 *
pHookCtx


402 
TmGlobÆ
 *
pTm
 = (TmGlobÆ *)(
pEnv
->
pMemCtx
);

403 
	`tmMÆlocOom
(
pTm
, 
nCou¡down
, 
bPîsi°
, 
xHook
, 
pHookCtx
);

404 
	}
}

406 
	$ã°MÆlocOomE«bÀ
(
lsm_ív
 *
pEnv
, 
bE«bÀ
){

407 
TmGlobÆ
 *
pTm
 = (TmGlobÆ *)(
pEnv
->
pMemCtx
);

408 
	`tmMÆlocOomE«bÀ
(
pTm
, 
bE«bÀ
);

409 
	}
}

	@lsm-test/lsmtest_tdb.c

9 
	~"lsmã°_tdb.h
"

10 
	~"lsm.h
"

12 
	~"lsmã°.h
"

14 
	~<°dlib.h
>

15 
	~<°rög.h
>

16 
	~<as£π.h
>

17 
	~<uni°d.h
>

18 
	~<°dio.h
>

21 
SqlDb
 
	tSqlDb
;

23 
	$îr‹_å™ß˘i⁄_fun˘i⁄
(
Te°Db
 *
p
, 
iLevñ
){

24 
	`unu£d_∑ømëî
(
p
);

25 
	`unu£d_∑ømëî
(
iLevñ
);

27 
	}
}

33 #ifde‡
HAVE_LEVELDB


35 
	~<Àvñdb/c.h
>

37 
LevñDb
 
	tLevñDb
;

38 
	sLevñDb
 {

39 
Te°Db
 
	mba£
;

40 
Àvñdb_t
 *
	mdb
;

41 
Àvñdb_›ti⁄s_t
 *
	mpO±
;

42 
Àvñdb_wrôe›ti⁄s_t
 *
	mpWrôeO±
;

43 
Àvñdb_ªad›ti⁄s_t
 *
	mpRódO±
;

45 *
	mpVÆ
;

48 
	$ã°_Àvñdb_˛o£
(
Te°Db
 *
pTe°Db
){

49 
LevñDb
 *
pDb
 = (LevñDb *)
pTe°Db
;

51 
	`Àvñdb_˛o£
(
pDb
->
db
);

52 
	`Àvñdb_wrôe›ti⁄s_de°roy
(
pDb
->
pWrôeO±
);

53 
	`Àvñdb_ªad›ti⁄s_de°roy
(
pDb
->
pRódO±
);

54 
	`Àvñdb_›ti⁄s_de°roy
(
pDb
->
pO±
);

55 
	`‰ì
(
pDb
->
pVÆ
);

56 
	`‰ì
(
pDb
);

59 
	}
}

61 
	$ã°_Àvñdb_wrôe
(

62 
Te°Db
 *
pTe°Db
,

63 *
pKey
,

64 
nKey
,

65 *
pVÆ
,

66 
nVÆ


68 
LevñDb
 *
pDb
 = (LevñDb *)
pTe°Db
;

69 *
zEº
 = 0;

70 
	`Àvñdb_put
(
pDb
->
db
,ÖDb->
pWrôeO±
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, &
zEº
);

71  (
zEº
!=0);

72 
	}
}

74 
	$ã°_Àvñdb_dñëe
(
Te°Db
 *
pTe°Db
, *
pKey
, 
nKey
){

75 
LevñDb
 *
pDb
 = (LevñDb *)
pTe°Db
;

76 *
zEº
 = 0;

77 
	`Àvñdb_dñëe
(
pDb
->
db
,ÖDb->
pWrôeO±
, 
pKey
, 
nKey
, &
zEº
);

78  (
zEº
!=0);

79 
	}
}

81 
	$ã°_Àvñdb_„tch
(

82 
Te°Db
 *
pTe°Db
,

83 *
pKey
,

84 
nKey
,

85 **
µVÆ
,

86 *
≤VÆ


88 
LevñDb
 *
pDb
 = (LevñDb *)
pTe°Db
;

89 *
zEº
 = 0;

90 
size_t
 
nVÆ
 = 0;

92 if–
pKey
==0 )  0;

93 
	`‰ì
(
pDb
->
pVÆ
);

94 
pDb
->
pVÆ
 = 
	`Àvñdb_gë
’Db->
db
,ÖDb->
pRódO±
, 
pKey
, 
nKey
, &
nVÆ
, &
zEº
);

95 *
µVÆ
 = (*)(
pDb
->
pVÆ
);

96 if–
pDb
->
pVÆ
==0 ){

97 *
≤VÆ
 = -1;

99 *
≤VÆ
 = ()
nVÆ
;

102  (
zEº
!=0);

103 
	}
}

105 
ã°_Àvñdb_sˇn
(

106 
Te°Db
 *
pTe°Db
,

107 *
pCtx
,

108 
bRevî£
,

109 *
pKey1
, 
nKey1
,

110 *
pKey2
, 
nKey2
,

111 (*
xCÆlback
)(*, *, , *, )

113 
LevñDb
 *
pDb
 = (LevñDb *)
pTe°Db
;

114 
Àvñdb_ôî©‹_t
 *
ôî
;

116 
ôî
 = 
	`Àvñdb_¸óã_ôî©‹
(
pDb
->
db
,ÖDb->
pRódO±
);

118 if–
bRevî£
==0 ){

119 if–
pKey1
 ){

120 
	`Àvñdb_ôî_£ek
(
ôî
, 
pKey1
, 
nKey1
);

122 
	`Àvñdb_ôî_£ek_to_fú°
(
ôî
);

125 if–
pKey2
 ){

126 
	`Àvñdb_ôî_£ek
(
ôî
, 
pKey2
, 
nKey2
);

128 if–
	`Àvñdb_ôî_vÆid
(
ôî
)==0 ){

129 
	`Àvñdb_ôî_£ek_to_œ°
(
ôî
);

131 c⁄° *
k
; 
size_t
 
n
;

132 
ªs
;

133 
k
 = 
	`Àvñdb_ôî_key
(
ôî
, &
n
);

134 
ªs
 = 
	`memcmp
(
k
, 
pKey2
, 
	`MIN
(
n
, 
nKey2
));

135 if–
ªs
==0 )Ñe†
n
 - 
nKey2
;

136 
	`as£π
–
ªs
>=0 );

137 if–
ªs
>0 ){

138 
	`Àvñdb_ôî_¥ev
(
ôî
);

142 
	`Àvñdb_ôî_£ek_to_œ°
(
ôî
);

147  
	`Àvñdb_ôî_vÆid
(
ôî
) ){

148 c⁄° *
k
; 
size_t
 
n
;

149 c⁄° *
v
; 
size_t
 
n2
;

150 
ªs
;

152 
k
 = 
	`Àvñdb_ôî_key
(
ôî
, &
n
);

153 if–
bRevî£
==0 && 
pKey2
 ){

154 
ªs
 = 
	`memcmp
(
k
, 
pKey2
, 
	`MIN
(
n
, 
nKey2
));

155 if–
ªs
==0 )Ñe†
n
 - 
nKey2
;

156 if–
ªs
>0 ) ;

158 if–
bRevî£
!=0 && 
pKey1
 ){

159 
ªs
 = 
	`memcmp
(
k
, 
pKey1
, 
	`MIN
(
n
, 
nKey1
));

160 if–
ªs
==0 )Ñe†
n
 - 
nKey1
;

161 if–
ªs
<0 ) ;

164 
v
 = 
	`Àvñdb_ôî_vÆue
(
ôî
, &
n2
);

166 
	`xCÆlback
(
pCtx
, (*)
k
, 
n
, (*)
v
, 
n2
);

168 if–
bRevî£
==0 ){

169 
	`Àvñdb_ôî_√xt
(
ôî
);

171 
	`Àvñdb_ôî_¥ev
(
ôî
);

175 
	`Àvñdb_ôî_de°roy
(
ôî
);

177 
	}
}

179 
	$ã°_Àvñdb_›í
(

180 c⁄° *
zS≥c
,

181 c⁄° *
zFûíame
,

182 
bCÀ¨
,

183 
Te°Db
 **
µDb


185 c⁄° 
D©aba£Mëhods
 
LevñdbMëhods
 = {

186 
ã°_Àvñdb_˛o£
,

187 
ã°_Àvñdb_wrôe
,

188 
ã°_Àvñdb_dñëe
,

190 
ã°_Àvñdb_„tch
,

191 
ã°_Àvñdb_sˇn
,

192 
îr‹_å™ß˘i⁄_fun˘i⁄
,

193 
îr‹_å™ß˘i⁄_fun˘i⁄
,

194 
îr‹_å™ß˘i⁄_fun˘i⁄


197 
LevñDb
 *
pLevñDb
;

198 *
zEº
 = 0;

200 if–
bCÀ¨
 ){

201 *
zCmd
 = 
	`sqlôe3_m¥ötf
("rm -r‡%s\n", 
zFûíame
);

202 
	`sy°em
(
zCmd
);

203 
	`sqlôe3_‰ì
(
zCmd
);

206 
pLevñDb
 = (
LevñDb
 *)
	`mÆloc
((LevelDb));

207 
	`mem£t
(
pLevñDb
, 0, (
LevñDb
));

209 
pLevñDb
->
pO±
 = 
	`Àvñdb_›ti⁄s_¸óã
();

210 
	`Àvñdb_›ti⁄s_£t_¸óã_if_missög
(
pLevñDb
->
pO±
, 1);

211 
pLevñDb
->
pWrôeO±
 = 
	`Àvñdb_wrôe›ti⁄s_¸óã
();

212 
pLevñDb
->
pRódO±
 = 
	`Àvñdb_ªad›ti⁄s_¸óã
();

214 
pLevñDb
->
db
 = 
	`Àvñdb_›í
’LevñDb->
pO±
, 
zFûíame
, &
zEº
);

216 if–
zEº
 ){

217 
	`ã°_Àvñdb_˛o£
((
Te°Db
 *)
pLevñDb
);

218 *
µDb
 = 0;

222 *
µDb
 = (
Te°Db
 *)
pLevñDb
;

223 
pLevñDb
->
ba£
.
pMëhods
 = &
LevñdbMëhods
;

225 
	}
}

231 #ifde‡
HAVE_KYOTOCABINET


232 
	$kc_˛o£
(
Te°Db
 *
pTe°Db
){

233  
	`ã°_kc_˛o£
(
pTe°Db
);

234 
	}
}

236 
	$kc_wrôe
(

237 
Te°Db
 *
pTe°Db
,

238 *
pKey
,

239 
nKey
,

240 *
pVÆ
,

241 
nVÆ


243  
	`ã°_kc_wrôe
(
pTe°Db
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

244 
	}
}

246 
	$kc_dñëe
(
Te°Db
 *
pTe°Db
, *
pKey
, 
nKey
){

247  
	`ã°_kc_dñëe
(
pTe°Db
, 
pKey
, 
nKey
);

248 
	}
}

250 
	$kc_dñëe_ønge
(

251 
Te°Db
 *
pTe°Db
,

252 *
pKey1
, 
nKey1
,

253 *
pKey2
, 
nKey2


255  
	`ã°_kc_dñëe_ønge
(
pTe°Db
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
);

256 
	}
}

258 
	$kc_„tch
(

259 
Te°Db
 *
pTe°Db
,

260 *
pKey
,

261 
nKey
,

262 **
µVÆ
,

263 *
≤VÆ


265 if–
pKey
==0 )  
LSM_OK
;

266  
	`ã°_kc_„tch
(
pTe°Db
, 
pKey
, 
nKey
, 
µVÆ
, 
≤VÆ
);

267 
	}
}

269 
kc_sˇn
(

270 
Te°Db
 *
pTe°Db
,

271 *
pCtx
,

272 
bRevî£
,

273 *
pFú°
, 
nFú°
,

274 *
pLa°
, 
nLa°
,

275 (*
xCÆlback
)(*, *, , *, )

277  
	`ã°_kc_sˇn
(

278 
pTe°Db
, 
pCtx
, 
bRevî£
, 
pFú°
, 
nFú°
, 
pLa°
, 
nLa°
, 
xCÆlback


280 
	}
}

282 
	$kc_›í
(

283 c⁄° *
zS≥c
,

284 c⁄° *
zFûíame
,

285 
bCÀ¨
,

286 
Te°Db
 **
µDb


288 c⁄° 
D©aba£Mëhods
 
KcdbMëhods
 = {

289 
kc_˛o£
,

290 
kc_wrôe
,

291 
kc_dñëe
,

292 
kc_dñëe_ønge
,

293 
kc_„tch
,

294 
kc_sˇn
,

295 
îr‹_å™ß˘i⁄_fun˘i⁄
,

296 
îr‹_å™ß˘i⁄_fun˘i⁄
,

297 
îr‹_å™ß˘i⁄_fun˘i⁄


300 
rc
;

301 
Te°Db
 *
pTe°Db
 = 0;

303 
rc
 = 
	`ã°_kc_›í
(
zFûíame
, 
bCÀ¨
, &
pTe°Db
);

304 if–
rc
!=0 ){

305 *
µDb
 = 0;

306  
rc
;

308 
pTe°Db
->
pMëhods
 = &
KcdbMëhods
;

309 *
µDb
 = 
pTe°Db
;

311 
	}
}

317 #ifde‡
HAVE_MDB


318 
	$mdb_˛o£
(
Te°Db
 *
pTe°Db
){

319  
	`ã°_mdb_˛o£
(
pTe°Db
);

320 
	}
}

322 
	$mdb_wrôe
(

323 
Te°Db
 *
pTe°Db
,

324 *
pKey
,

325 
nKey
,

326 *
pVÆ
,

327 
nVÆ


329  
	`ã°_mdb_wrôe
(
pTe°Db
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

330 
	}
}

332 
	$mdb_dñëe
(
Te°Db
 *
pTe°Db
, *
pKey
, 
nKey
){

333  
	`ã°_mdb_dñëe
(
pTe°Db
, 
pKey
, 
nKey
);

334 
	}
}

336 
	$mdb_„tch
(

337 
Te°Db
 *
pTe°Db
,

338 *
pKey
,

339 
nKey
,

340 **
µVÆ
,

341 *
≤VÆ


343 if–
pKey
==0 )  
LSM_OK
;

344  
	`ã°_mdb_„tch
(
pTe°Db
, 
pKey
, 
nKey
, 
µVÆ
, 
≤VÆ
);

345 
	}
}

347 
mdb_sˇn
(

348 
Te°Db
 *
pTe°Db
,

349 *
pCtx
,

350 
bRevî£
,

351 *
pFú°
, 
nFú°
,

352 *
pLa°
, 
nLa°
,

353 (*
xCÆlback
)(*, *, , *, )

355  
	`ã°_mdb_sˇn
(

356 
pTe°Db
, 
pCtx
, 
bRevî£
, 
pFú°
, 
nFú°
, 
pLa°
, 
nLa°
, 
xCÆlback


358 
	}
}

360 
	$mdb_›í
(

361 c⁄° *
zS≥c
,

362 c⁄° *
zFûíame
,

363 
bCÀ¨
,

364 
Te°Db
 **
µDb


366 c⁄° 
D©aba£Mëhods
 
KcdbMëhods
 = {

367 
mdb_˛o£
,

368 
mdb_wrôe
,

369 
mdb_dñëe
,

371 
mdb_„tch
,

372 
mdb_sˇn
,

373 
îr‹_å™ß˘i⁄_fun˘i⁄
,

374 
îr‹_å™ß˘i⁄_fun˘i⁄
,

375 
îr‹_å™ß˘i⁄_fun˘i⁄


378 
rc
;

379 
Te°Db
 *
pTe°Db
 = 0;

381 
rc
 = 
	`ã°_mdb_›í
(
zS≥c
, 
zFûíame
, 
bCÀ¨
, &
pTe°Db
);

382 if–
rc
!=0 ){

383 *
µDb
 = 0;

384  
rc
;

386 
pTe°Db
->
pMëhods
 = &
KcdbMëhods
;

387 *
µDb
 = 
pTe°Db
;

389 
	}
}

404 
	sSqlDb
 {

405 
Te°Db
 
	mba£
;

406 
sqlôe3
 *
	mdb
;

407 
sqlôe3_°mt
 *
	mpIn£π
;

408 
sqlôe3_°mt
 *
	mpDñëe
;

409 
sqlôe3_°mt
 *
	mpDñëeR™ge
;

410 
sqlôe3_°mt
 *
	mpFëch
;

411 
sqlôe3_°mt
 *
	m≠Sˇn
[8];

413 
	mnO≥nTøns
;

416 
	mnAŒoc
;

417 
u8
 *
	maAŒoc
;

420 
	$sql_˛o£
(
Te°Db
 *
pTe°Db
){

421 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

422 
	`sqlôe3_föÆize
(
pDb
->
pIn£π
);

423 
	`sqlôe3_föÆize
(
pDb
->
pDñëe
);

424 
	`sqlôe3_föÆize
(
pDb
->
pDñëeR™ge
);

425 
	`sqlôe3_föÆize
(
pDb
->
pFëch
);

426 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[0]);

427 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[1]);

428 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[2]);

429 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[3]);

430 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[4]);

431 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[5]);

432 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[6]);

433 
	`sqlôe3_föÆize
(
pDb
->
≠Sˇn
[7]);

434 
	`sqlôe3_˛o£
(
pDb
->
db
);

435 
	`‰ì
((*)
pDb
->
aAŒoc
);

436 
	`‰ì
((*)
pDb
);

437  
SQLITE_OK
;

438 
	}
}

440 
	$sql_wrôe
(

441 
Te°Db
 *
pTe°Db
,

442 *
pKey
,

443 
nKey
,

444 *
pVÆ
,

445 
nVÆ


447 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

448 
	`sqlôe3_böd_blob
(
pDb
->
pIn£π
, 1, 
pKey
, 
nKey
, 
SQLITE_STATIC
);

449 
	`sqlôe3_böd_blob
(
pDb
->
pIn£π
, 2, 
pVÆ
, 
nVÆ
, 
SQLITE_STATIC
);

450 
	`sqlôe3_°ï
(
pDb
->
pIn£π
);

451  
	`sqlôe3_ª£t
(
pDb
->
pIn£π
);

452 
	}
}

454 
	$sql_dñëe
(
Te°Db
 *
pTe°Db
, *
pKey
, 
nKey
){

455 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

456 
	`sqlôe3_böd_blob
(
pDb
->
pDñëe
, 1, 
pKey
, 
nKey
, 
SQLITE_STATIC
);

457 
	`sqlôe3_°ï
(
pDb
->
pDñëe
);

458  
	`sqlôe3_ª£t
(
pDb
->
pDñëe
);

459 
	}
}

461 
	$sql_dñëe_ønge
(

462 
Te°Db
 *
pTe°Db
,

463 *
pKey1
, 
nKey1
,

464 *
pKey2
, 
nKey2


466 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

467 
	`sqlôe3_böd_blob
(
pDb
->
pDñëeR™ge
, 1, 
pKey1
, 
nKey1
, 
SQLITE_STATIC
);

468 
	`sqlôe3_böd_blob
(
pDb
->
pDñëeR™ge
, 2, 
pKey2
, 
nKey2
, 
SQLITE_STATIC
);

469 
	`sqlôe3_°ï
(
pDb
->
pDñëeR™ge
);

470  
	`sqlôe3_ª£t
(
pDb
->
pDñëeR™ge
);

471 
	}
}

473 
	$sql_„tch
(

474 
Te°Db
 *
pTe°Db
,

475 *
pKey
,

476 
nKey
,

477 **
µVÆ
,

478 *
≤VÆ


480 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

481 
rc
;

483 
	`sqlôe3_ª£t
(
pDb
->
pFëch
);

484 if–
pKey
==0 ){

485 
	`as£π
–
µVÆ
==0 );

486 
	`as£π
–
≤VÆ
==0 );

487  
LSM_OK
;

490 
	`sqlôe3_böd_blob
(
pDb
->
pFëch
, 1, 
pKey
, 
nKey
, 
SQLITE_STATIC
);

491 
rc
 = 
	`sqlôe3_°ï
(
pDb
->
pFëch
);

492 if–
rc
==
SQLITE_ROW
 ){

493 
nVÆ
 = 
	`sqlôe3_cﬁumn_byãs
(
pDb
->
pFëch
, 0);

494 
u8
 *
aVÆ
 = (*)
	`sqlôe3_cﬁumn_blob
(
pDb
->
pFëch
, 0);

496 if–
nVÆ
>
pDb
->
nAŒoc
 ){

497 
	`‰ì
(
pDb
->
aAŒoc
);

498 
pDb
->
aAŒoc
 = (
u8
 *)
	`mÆloc
(
nVÆ
*2);

499 
pDb
->
nAŒoc
 = 
nVÆ
*2;

501 
	`mem˝y
(
pDb
->
aAŒoc
, 
aVÆ
, 
nVÆ
);

502 *
≤VÆ
 = 
nVÆ
;

503 *
µVÆ
 = (*)
pDb
->
aAŒoc
;

505 *
≤VÆ
 = -1;

506 *
µVÆ
 = 0;

509 
rc
 = 
	`sqlôe3_ª£t
(
pDb
->
pFëch
);

510  
rc
;

511 
	}
}

513 
sql_sˇn
(

514 
Te°Db
 *
pTe°Db
,

515 *
pCtx
,

516 
bRevî£
,

517 *
pFú°
, 
nFú°
,

518 *
pLa°
, 
nLa°
,

519 (*
xCÆlback
)(*, *, , *, )

521 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

522 
sqlôe3_°mt
 *
pSˇn
;

524 
	`as£π
–
bRevî£
==1 || bReverse==0 );

525 
pSˇn
 = 
pDb
->
≠Sˇn
[(
pFú°
==0Ë+ (
pLa°
==0)*2 + 
bRevî£
*4];

527 if–
pFú°
 ) 
	`sqlôe3_böd_blob
(
pSˇn
, 1,ÖFú°, 
nFú°
, 
SQLITE_STATIC
);

528 if–
pLa°
 ) 
	`sqlôe3_böd_blob
(
pSˇn
, 2,ÖLa°, 
nLa°
, 
SQLITE_STATIC
);

530  
SQLITE_ROW
==
	`sqlôe3_°ï
(
pSˇn
) ){

531 *
pKey
; 
nKey
;

532 *
pVÆ
; 
nVÆ
;

534 
nKey
 = 
	`sqlôe3_cﬁumn_byãs
(
pSˇn
, 0);

535 
pKey
 = (*)
	`sqlôe3_cﬁumn_blob
(
pSˇn
, 0);

536 
nVÆ
 = 
	`sqlôe3_cﬁumn_byãs
(
pSˇn
, 1);

537 
pVÆ
 = (*)
	`sqlôe3_cﬁumn_blob
(
pSˇn
, 1);

539 
	`xCÆlback
(
pCtx
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

541  
	`sqlôe3_ª£t
(
pSˇn
);

542 
	}
}

544 
	$sql_begö
(
Te°Db
 *
pTe°Db
, 
iLevñ
){

545 
i
;

546 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

549 if–
iLevñ
==0 )  0;

552 if–
pDb
->
nO≥nTøns
==0 ){

553 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
,

556 if–
rc
!=0 ) Ñc;

557 
pDb
->
nO≥nTøns
 = 1;

561 
i
=
pDb
->
nO≥nTøns
; i<
iLevñ
; i++){

562 *
zSql
 = 
	`sqlôe3_m¥ötf
("SAVEPOINT x%d", 
i
);

563 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, 
zSql
, 0, 0, 0);

564 
	`sqlôe3_‰ì
(
zSql
);

565 if–
rc
!=
SQLITE_OK
 ) Ñc;

568 
pDb
->
nO≥nTøns
 = 
iLevñ
;

570 
	}
}

572 
	$sql_commô
(
Te°Db
 *
pTe°Db
, 
iLevñ
){

573 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

574 
	`as£π
–
iLevñ
>=0 );

577 if–
pDb
->
nO≥nTøns
>=1 && 
iLevñ
==0 ){

578 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, "COMMIT", 0, 0, 0);

579 if–
rc
!=0 ) Ñc;

580 
pDb
->
nO≥nTøns
 = 0;

584 if–
pDb
->
nO≥nTøns
>
iLevñ
 ){

585 *
zSql
 = 
	`sqlôe3_m¥ötf
("RELEASE x%d", 
iLevñ
);

586 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, 
zSql
, 0, 0, 0);

587 
	`sqlôe3_‰ì
(
zSql
);

588 if–
rc
!=0 ) Ñc;

591 
pDb
->
nO≥nTøns
 = 
iLevñ
;

593 
	}
}

595 
	$sql_rﬁlback
(
Te°Db
 *
pTe°Db
, 
iLevñ
){

596 
SqlDb
 *
pDb
 = (SqlDb *)
pTe°Db
;

597 
	`as£π
–
iLevñ
>=0 );

599 if–
pDb
->
nO≥nTøns
>=1 && 
iLevñ
==0 ){

601 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, "ROLLBACK", 0, 0, 0);

602 if–
rc
!=0 ) Ñc;

603 }if–
pDb
->
nO≥nTøns
>1 && 
iLevñ
==1 ){

605 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, "ROLLBACK TO x1; RELEASE x1;", 0, 0, 0);

606 if–
rc
!=0 ) Ñc;

609 *
zSql
 = 
	`sqlôe3_m¥ötf
("ROLLBACK TO x%d", 
iLevñ
-1);

610 
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, 
zSql
, 0, 0, 0);

611 
	`sqlôe3_‰ì
(
zSql
);

612 if–
rc
!=0 ) Ñc;

615 
pDb
->
nO≥nTøns
 = 
iLevñ
;

617 
	}
}

619 
	$sql_›í
(

620 c⁄° *
zS≥c
,

621 c⁄° *
zFûíame
,

622 
bCÀ¨
,

623 
Te°Db
 **
µDb


625 c⁄° 
D©aba£Mëhods
 
SqlMëhods
 = {

626 
sql_˛o£
,

627 
sql_wrôe
,

628 
sql_dñëe
,

629 
sql_dñëe_ønge
,

630 
sql_„tch
,

631 
sql_sˇn
,

632 
sql_begö
,

633 
sql_commô
,

634 
sql_rﬁlback


636 c⁄° *
zCª©e
 = "CREATE TABLE IF NOT EXISTSÅ1(k PRIMARY KEY, v)";

637 c⁄° *
zIn£π
 = "REPLACE INTOÅ1 VALUES(?, ?)";

638 c⁄° *
zDñëe
 = "DELETE FROMÅ1 WHERE k = ?";

639 c⁄° *
zR™ge
 = "DELETE FROMÅ1 WHERE k>? AND k<?";

640 c⁄° *
zFëch
 = "SELECT v FROMÅ1 WHERE k = ?";

642 c⁄° *
zSˇn0
 = "SELECT * FROMÅ1 WHERE k BETWEEN ?1 AND ?2 ORDER BY k";

643 c⁄° *
zSˇn1
 = "SELECT * FROMÅ1 WHERE k <= ?2 ORDER BY k";

644 c⁄° *
zSˇn2
 = "SELECT * FROMÅ1 WHERE k >= ?1 ORDER BY k";

645 c⁄° *
zSˇn3
 = "SELECT * FROMÅ1 ORDER BY k";

647 c⁄° *
zSˇn4
 =

649 c⁄° *
zSˇn5
 = "SELECT * FROMÅ1 WHERE k <= ?2 ORDER BY k DESC";

650 c⁄° *
zSˇn6
 = "SELECT * FROMÅ1 WHERE k >= ?1 ORDER BY k DESC";

651 c⁄° *
zSˇn7
 = "SELECT * FROMÅ1 ORDER BY k DESC";

653 
rc
;

654 
SqlDb
 *
pDb
;

655 *
zPøgma
;

657 if–
bCÀ¨
 && 
zFûíame
 && zFilename[0] ){

658 
	`u∆ök
(
zFûíame
);

661 
pDb
 = (
SqlDb
 *)
	`mÆloc
((SqlDb));

662 
	`mem£t
(
pDb
, 0, (
SqlDb
));

663 
pDb
->
ba£
.
pMëhods
 = &
SqlMëhods
;

665 if–0!=(
rc
 = 
	`sqlôe3_›í
(
zFûíame
, &
pDb
->
db
))

666 || 0!=(
rc
 = 
	`sqlôe3_exec
(
pDb
->
db
, 
zCª©e
, 0, 0, 0))

667 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zIn£π
, -1, &pDb->
pIn£π
, 0))

668 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zDñëe
, -1, &pDb->
pDñëe
, 0))

669 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zR™ge
, -1, &pDb->
pDñëeR™ge
, 0))

670 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zFëch
, -1, &pDb->
pFëch
, 0))

671 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn0
, -1, &pDb->
≠Sˇn
[0], 0))

672 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn1
, -1, &pDb->
≠Sˇn
[1], 0))

673 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn2
, -1, &pDb->
≠Sˇn
[2], 0))

674 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn3
, -1, &pDb->
≠Sˇn
[3], 0))

675 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn4
, -1, &pDb->
≠Sˇn
[4], 0))

676 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn5
, -1, &pDb->
≠Sˇn
[5], 0))

677 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn6
, -1, &pDb->
≠Sˇn
[6], 0))

678 || 0!=(
rc
 = 
	`sqlôe3_¥ï¨e_v2
(
pDb
->
db
, 
zSˇn7
, -1, &pDb->
≠Sˇn
[7], 0))

680 *
µDb
 = 0;

681 
	`sql_˛o£
((
Te°Db
 *)
pDb
);

682  
rc
;

685 
zPøgma
 = 
	`sqlôe3_m¥ötf
("PRAGMAÖage_size=%d", 
TESTDB_DEFAULT_PAGE_SIZE
);

686 
	`sqlôe3_exec
(
pDb
->
db
, 
zPøgma
, 0, 0, 0);

687 
	`sqlôe3_‰ì
(
zPøgma
);

688 
zPøgma
 = 
	`sqlôe3_m¥ötf
("PRAGMA cache_size=%d", 
TESTDB_DEFAULT_CACHE_SIZE
);

689 
	`sqlôe3_exec
(
pDb
->
db
, 
zPøgma
, 0, 0, 0);

690 
	`sqlôe3_‰ì
(
zPøgma
);

693 
	`sqlôe3_exec
(
pDb
->
db
, "PRAGMA synchronous=OFF", 0, 0, 0);

694 
	`sqlôe3_exec
(
pDb
->
db
, "PRAGMA journal_mode=WAL", 0, 0, 0);

695 
	`sqlôe3_exec
(
pDb
->
db
, "PRAGMA wal_autocheckpoint=4096", 0, 0, 0);

697 *
µDb
 = (
Te°Db
 *)
pDb
;

699 
	}
}

707 
	sLib
 {

708 c⁄° *
	mzName
;

709 c⁄° *
	mzDeÁu…Db
;

710 (*
	mxO≥n
)(c⁄° *, c⁄° *
	mzFûíame
, 
	mbCÀ¨
, 
Te°Db
 **
	mµDb
);

711 } 
	gaLib
[] = {

712 { "bt", "ã°db.bt", 
ã°_bt_›í
 },

713 { "fbt", "ã°db.fbt", 
ã°_fbt_›í
 },

714 { "fbts", "ã°db.fbts", 
ã°_fbts_›í
 },

715 { "sqlôe3", "ã°db.sqlôe", 
sql_›í
 },

716 { "lsm_smÆl", "ã°db.lsm_smÆl", 
ã°_lsm_smÆl_›í
 },

717 { "lsm_lomem", "ã°db.lsm_lomem", 
ã°_lsm_lomem_›í
 },

718 #ifde‡
HAVE_ZLIB


719 { "lsm_zù", "ã°db.lsm_zù", 
ã°_lsm_zù_›í
 },

721 { "lsm", "ã°db.lsm", 
ã°_lsm_›í
 },

722 #ifde‡
LSM_MUTEX_PTHREADS


723 { "lsm_mt2", "ã°db.lsm_mt2", 
ã°_lsm_mt2
 },

724 { "lsm_mt3", "ã°db.lsm_mt3", 
ã°_lsm_mt3
 },

726 #ifde‡
HAVE_LEVELDB


727 { "Àvñdb", "ã°db.Àvñdb", 
ã°_Àvñdb_›í
 },

729 #ifde‡
HAVE_KYOTOCABINET


730 { "kyŸoˇböë", "ã°db.kc", 
kc_›í
 },

732 #ifde‡
HAVE_MDB


733 { "mdb", "./ã°db.mdb", 
mdb_›í
 }

737 c⁄° *
	$tdb_sy°em_«me
(
i
){

738 if–
i
<0 || i>=
	`AºaySize
(
aLib
) )  0;

739  
aLib
[
i
].
zName
;

740 
	}
}

742 
	$tdb_›í
(c⁄° *
zLib
, c⁄° *
zDb
, 
bCÀ¨
, 
Te°Db
 **
µDb
){

743 
i
;

744 
rc
 = 1;

745 c⁄° *
zS≥c
 = 0;

747 
nLib
 = 0;

748  
zLib
[
nLib
] && zLib[nLib]!=' ' ){

749 
nLib
++;

751 
zS≥c
 = &
zLib
[
nLib
];

752  *
zS≥c
==' ' ) zSpec++;

753 if–*
zS≥c
=='\0' ) zSpec = 0;

755 
i
=0; i<
	`AºaySize
(
aLib
); i++){

756 if–
	`°æí
(
aLib
[
i
].
zName
)==
nLib
 && 0==
	`memcmp
(
zLib
,áLib[i].zName,ÇLib) ){

757 
rc
 = 
aLib
[
i
].
	`xO≥n
(
zS≥c
, (
zDb
 ? zDb :áLib[i].
zDeÁu…Db
), 
bCÀ¨
, 
µDb
);

758 if–
rc
==0 ){

759 (*
µDb
)->
zLibøry
 = 
aLib
[
i
].
zName
;

765 if–
rc
 ){

767 *
µDb
 = 0;

769  
rc
;

770 
	}
}

772 
	$tdb_˛o£
(
Te°Db
 *
pDb
){

773 if–
pDb
 ){

774  
pDb
->
pMëhods
->
	`xClo£
(pDb);

777 
	}
}

779 
	$tdb_wrôe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
){

780  
pDb
->
pMëhods
->
	`xWrôe
’Db, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

781 
	}
}

783 
	$tdb_dñëe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
){

784  
pDb
->
pMëhods
->
	`xDñëe
’Db, 
pKey
, 
nKey
);

785 
	}
}

787 
	$tdb_dñëe_ønge
(

788 
Te°Db
 *
pDb
, *
pKey1
, 
nKey1
, *
pKey2
, 
nKey2


790  
pDb
->
pMëhods
->
	`xDñëeR™ge
’Db, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
);

791 
	}
}

793 
	$tdb_„tch
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
, **
µVÆ
, *
≤VÆ
){

794  
pDb
->
pMëhods
->
	`xFëch
’Db, 
pKey
, 
nKey
, 
µVÆ
, 
≤VÆ
);

795 
	}
}

797 
tdb_sˇn
(

798 
Te°Db
 *
pDb
,

799 *
pCtx
,

800 
bRevî£
,

801 *
pKey1
, 
nKey1
,

802 *
pKey2
, 
nKey2
,

803 (*
xCÆlback
)(*
pCtx
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
)

805  
pDb
->
pMëhods
->
	`xSˇn
(

806 
pDb
, 
pCtx
, 
bRevî£
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
, 
xCÆlback


808 
	}
}

810 
	$tdb_begö
(
Te°Db
 *
pDb
, 
iLevñ
){

811  
pDb
->
pMëhods
->
	`xBegö
’Db, 
iLevñ
);

812 
	}
}

813 
	$tdb_commô
(
Te°Db
 *
pDb
, 
iLevñ
){

814  
pDb
->
pMëhods
->
	`xCommô
’Db, 
iLevñ
);

815 
	}
}

816 
	$tdb_rﬁlback
(
Te°Db
 *
pDb
, 
iLevñ
){

817  
pDb
->
pMëhods
->
	`xRﬁlback
’Db, 
iLevñ
);

818 
	}
}

820 
	$tdb_å™ß˘i⁄_suµ‹t
(
Te°Db
 *
pDb
){

821  (
pDb
->
pMëhods
->
xBegö
 !
îr‹_å™ß˘i⁄_fun˘i⁄
);

822 
	}
}

824 c⁄° *
	$tdb_libøry_«me
(
Te°Db
 *
pDb
){

825  
pDb
->
zLibøry
;

826 
	}
}

	@lsm-test/lsmtest_tdb.h

10 #i‚de‡
__WRAPPER_H_


11 
	#__WRAPPER_H_


	)

13 #ifde‡
__˝lu•lus


17 
	~"lsm.h
"

18 
	~"bt.h
"

20 
Te°Db
 
	tTe°Db
;

37 
tdb_›í
(c⁄° *
zLibøry
, c⁄° *
zDb
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

42 
tdb_˛o£
(
Te°Db
 *
pDb
);

47 
tdb_wrôe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
);

52 
tdb_dñëe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
);

57 
tdb_dñëe_ønge
(
Te°Db
 *, *
pKey1
, 
nKey1
, *
pKey2
, 
nKey2
);

64 
tdb_„tch
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
, **
µVÆ
, *
≤VÆ
);

100 
tdb_begö
(
Te°Db
 *
pDb
, 
iLevñ
);

101 
tdb_commô
(
Te°Db
 *
pDb
, 
iLevñ
);

102 
tdb_rﬁlback
(
Te°Db
 *
pDb
, 
iLevñ
);

107 
tdb_å™ß˘i⁄_suµ‹t
(
Te°Db
 *
pDb
);

113 c⁄° *
tdb_libøry_«me
(
Te°Db
 *
pDb
);

119 
tdb_sˇn
(

120 
Te°Db
 *
pDb
,

121 *
pCtx
,

122 
bRevî£
,

123 *
pKey1
, 
nKey1
,

124 *
pKey2
, 
nKey2
,

125 (*
xCÆlback
)(*
pCtx
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
)

128 c⁄° *
tdb_sy°em_«me
(
i
);

130 
tdb_lsm_›í
(c⁄° *
zCfg
, c⁄° *
zDb
, 
bCÀ¨
, 
Te°Db
 **
µDb
);

137 
lsm_db
 *
tdb_lsm
(
Te°Db
 *
pDb
);

145 
lsm_ív
 *
tdb_lsm_ív
();

152 
tdb_lsm_íabÀ_log
(
Te°Db
 *
pDb
, 
bE«bÀ
);

153 
tdb_lsm_≠∂iˇti⁄_¸ash
(
Te°Db
 *
pDb
);

154 
tdb_lsm_¥ï¨e_sy°em_¸ash
(
Te°Db
 *
pDb
);

155 
tdb_lsm_sy°em_¸ash
(
Te°Db
 *
pDb
);

156 
tdb_lsm_¥ï¨e_sync_¸ash
(
Te°Db
 *
pDb
, 
iSync
);

159 
tdb_lsm_ß„ty
(
Te°Db
 *
pDb
, 
eMode
);

160 
tdb_lsm_c⁄fig_w‹k_hook
(
Te°Db
 *
pDb
, (*)(
lsm_db
 *, *), *);

161 
tdb_lsm_wrôe_hook
(
Te°Db
 *, (*)(*,,
lsm_i64
,,), *);

162 
tdb_lsm_c⁄fig_°r
(
Te°Db
 *
pDb
, c⁄° *
zSå
);

167 
bt_db
 *
tdb_bt
(
Te°Db
 *
pDb
);

173 
tdb_bt_¥ï¨e_sync_¸ash
(
Te°Db
 *
pDb
, 
iSync
);

175 #ifde‡
__˝lu•lus


	@lsm-test/lsmtest_tdb2.cc

3 
	~"lsmã°.h
"

4 
	~<°dlib.h
>

6 #ifde‡
HAVE_KYOTOCABINET


7 
	~"k˝ﬁydb.h
"

9 
	sKcDb
 {

10 
Te°Db
 
ba£
;

11 
kyŸoˇböë
::
TªeDB
* 
db
;

12 *
pVÆ
;

16 
	$ã°_kc_›í
(c⁄° *
zFûíame
, 
bCÀ¨
, 
Te°Db
 **
µDb
){

17 
KcDb
 *
pKcDb
;

18 
ok
;

19 
rc
 = 0;

21 if–
bCÀ¨
 ){

22 *
zCmd
 = 
	`sqlôe3_m¥ötf
("rm -r‡%s\n", 
zFûíame
);

23 
	`sy°em
(
zCmd
);

24 
	`sqlôe3_‰ì
(
zCmd
);

27 
pKcDb
 = (
KcDb
 *)
	`mÆloc
((KcDb));

28 
	`mem£t
(
pKcDb
, 0, (
KcDb
));

31 
pKcDb
->
db
 = 
√w
 
kyŸoˇböë
::
	`TªeDB
();

32 
pKcDb
->
db
->
	`tu√_∑ge
(
TESTDB_DEFAULT_PAGE_SIZE
);

33 
pKcDb
->
db
->
	`tu√_∑ge_ˇche
(

34 
TESTDB_DEFAULT_PAGE_SIZE
 * 
TESTDB_DEFAULT_CACHE_SIZE


36 
ok
 = 
pKcDb
->
db
->
	`›í
(
zFûíame
,

37 
kyŸoˇböë
::
PﬁyDB
::
OWRITER
 | kyŸoˇböë::PﬁyDB::
OCREATE


39 if–
ok
==0 ){

40 
	`‰ì
(
pKcDb
);

41 
pKcDb
 = 0;

42 
rc
 = 1;

45 *
µDb
 = (
Te°Db
 *)
pKcDb
;

46  
rc
;

47 
	}
}

49 
	$ã°_kc_˛o£
(
Te°Db
 *
pDb
){

50 
KcDb
 *
pKcDb
 = (KcDb *)
pDb
;

51 if–
pKcDb
->
pVÆ
 ){

52 
dñëe
 [] 
pKcDb
->
pVÆ
;

54 
pKcDb
->
db
->
	`˛o£
();

55 
dñëe
 
pKcDb
->
db
;

56 
	`‰ì
(
pKcDb
);

58 
	}
}

60 
	$ã°_kc_wrôe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
){

61 
KcDb
 *
pKcDb
 = (KcDb *)
pDb
;

62 
ok
;

64 
ok
 = 
pKcDb
->
db
->
	`£t
((c⁄° *)
pKey
, 
nKey
, (c⁄° *)
pVÆ
, 
nVÆ
);

65  (
ok
 ? 0 : 1);

66 
	}
}

68 
	$ã°_kc_dñëe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
){

69 
KcDb
 *
pKcDb
 = (KcDb *)
pDb
;

70 
ok
;

72 
ok
 = 
pKcDb
->
db
->
	`ªmove
((c⁄° *)
pKey
, 
nKey
);

73  (
ok
 ? 0 : 1);

74 
	}
}

76 
	$ã°_kc_dñëe_ønge
(

77 
Te°Db
 *
pDb
,

78 *
pKey1
, 
nKey1
,

79 *
pKey2
, 
nKey2


81 
ªs
;

82 
KcDb
 *
pKcDb
 = (KcDb *)
pDb
;

83 
kyŸoˇböë
::
DB
::
Curs‹
* 
pCur
 = 
pKcDb
->
db
->
	`curs‹
();

85 if–
pKey1
 ){

86 
ªs
 = 
pCur
->
	`jump
((c⁄° *)
pKey1
, 
nKey1
);

88 
ªs
 = 
pCur
->
	`jump
();

92 c⁄° *
pKey
; 
size_t
 
nKey
;

93 c⁄° *
pVÆ
; 
size_t
 
nVÆ
;

95 
pKey
 = 
pCur
->
	`gë
(&
nKey
, &
pVÆ
, &
nVÆ
);

96 if–
pKey
==0 ) ;

98 #i‚de‡
NDEBUG


99 if–
pKey1
 ){

100 
ªs
 = 
	`memcmp
(
pKey
, 
pKey1
, 
	`MIN
((
size_t
)
nKey1
, 
nKey
));

101 
	`as£π
–
ªs
>0 || (ªs==0 && 
nKey
>
nKey1
) );

105 if–
pKey2
 ){

106 
ªs
 = 
	`memcmp
(
pKey
, 
pKey2
, 
	`MIN
((
size_t
)
nKey2
, 
nKey
));

107 if–
ªs
>0 || (ªs==0 && (
size_t
)
nKey2
<
nKey
) ){

108 
dñëe
 [] 
pKey
;

112 
pCur
->
	`ªmove
();

113 
dñëe
 [] 
pKey
;

116 
dñëe
 
pCur
;

118 
	}
}

120 
	$ã°_kc_„tch
(

121 
Te°Db
 *
pDb
,

122 *
pKey
,

123 
nKey
,

124 **
µVÆ
,

125 *
≤VÆ


127 
KcDb
 *
pKcDb
 = (KcDb *)
pDb
;

128 
size_t
 
nVÆ
;

130 if–
pKcDb
->
pVÆ
 ){

131 
dñëe
 [] 
pKcDb
->
pVÆ
;

132 
pKcDb
->
pVÆ
 = 0;

135 
pKcDb
->
pVÆ
 =ÖKcDb->
db
->
	`gë
((c⁄° *)
pKey
, 
nKey
, &
nVÆ
);

136 if–
pKcDb
->
pVÆ
 ){

137 *
µVÆ
 = 
pKcDb
->
pVÆ
;

138 *
≤VÆ
 = 
nVÆ
;

140 *
µVÆ
 = 0;

141 *
≤VÆ
 = -1;

145 
	}
}

147 
ã°_kc_sˇn
(

148 
Te°Db
 *
pDb
,

149 *
pCtx
,

150 
bRevî£
,

151 *
pKey1
, 
nKey1
,

152 *
pKey2
, 
nKey2
,

153 (*
xCÆlback
)(*
pCtx
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
)

155 
KcDb
 *
pKcDb
 = (KcDb *)
pDb
;

156 
kyŸoˇböë
::
DB
::
Curs‹
* 
pCur
 = 
pKcDb
->
db
->
	`curs‹
();

157 
ªs
;

159 if–
bRevî£
==0 ){

160 if–
pKey1
 ){

161 
ªs
 = 
pCur
->
	`jump
((c⁄° *)
pKey1
, 
nKey1
);

163 
ªs
 = 
pCur
->
	`jump
();

166 if–
pKey2
 ){

167 
ªs
 = 
pCur
->
	`jump_back
((c⁄° *)
pKey2
, 
nKey2
);

169 
ªs
 = 
pCur
->
	`jump_back
();

173  
ªs
 ){

174 c⁄° *
pKey
; 
size_t
 
nKey
;

175 c⁄° *
pVÆ
; 
size_t
 
nVÆ
;

176 
pKey
 = 
pCur
->
	`gë
(&
nKey
, &
pVÆ
, &
nVÆ
);

178 if–
bRevî£
==0 && 
pKey2
 ){

179 
ªs
 = 
	`memcmp
(
pKey
, 
pKey2
, 
	`MIN
((
size_t
)
nKey2
, 
nKey
));

180 if–
ªs
>0 || (ªs==0 && (
size_t
)
nKey2
<
nKey
) ){

181 
dñëe
 [] 
pKey
;

184 }if–
bRevî£
!=0 && 
pKey1
 ){

185 
ªs
 = 
	`memcmp
(
pKey
, 
pKey1
, 
	`MIN
((
size_t
)
nKey1
, 
nKey
));

186 if–
ªs
<0 || (ªs==0 && (
size_t
)
nKey1
>
nKey
) ){

187 
dñëe
 [] 
pKey
;

192 
	`xCÆlback
(
pCtx
, (*)
pKey
, ()
nKey
, (*)
pVÆ
, ()
nVÆ
);

193 
dñëe
 [] 
pKey
;

195 if–
bRevî£
 ){

196 
ªs
 = 
pCur
->
	`°ï_back
();

198 
ªs
 = 
pCur
->
	`°ï
();

202 
dñëe
 
pCur
;

204 
	}
}

207 #ifde‡
HAVE_MDB


208 
	~"lmdb.h
"

211 
	sMdbDb
 {

212 
Te°Db
 
ba£
;

213 
MDB_ív
 *
ív
;

214 
MDB_dbi
 
dbi
;

218 
	$ã°_mdb_›í
(

219 c⁄° *
zS≥c
,

220 c⁄° *
zFûíame
,

221 
bCÀ¨
,

222 
Te°Db
 **
µDb


224 
MDB_txn
 *
txn
;

225 
MdbDb
 *
pMdb
;

226 
rc
;

228 if–
bCÀ¨
 ){

229 *
zCmd
 = 
	`sqlôe3_m¥ötf
("rm -r‡%s\n", 
zFûíame
);

230 
	`sy°em
(
zCmd
);

231 
	`sqlôe3_‰ì
(
zCmd
);

234 
pMdb
 = (
MdbDb
 *)
	`mÆloc
((MdbDb));

235 
	`mem£t
(
pMdb
, 0, (
MdbDb
));

237 
rc
 = 
	`mdb_ív_¸óã
(&
pMdb
->
ív
);

238 if–
rc
==0 )Ñ¯
	`mdb_ív_£t_m≠size
(
pMdb
->
ív
, 1*1024*1024*1024);

239 if–
rc
==0 )Ñ¯
	`mdb_ív_›í
(
pMdb
->
ív
, 
zFûíame
, 
MDB_NOSYNC
|
MDB_NOSUBDIR
, 0600);

240 if–
rc
==0 )Ñ¯
	`mdb_txn_begö
(
pMdb
->
ív
, 
NULL
, 0, &
txn
);

241 if–
rc
==0 ){

242 
rc
 = 
	`mdb_›í
(
txn
, 
NULL
, 0, &
pMdb
->
dbi
);

243 
	`mdb_txn_commô
(
txn
);

246 *
µDb
 = (
Te°Db
 *)
pMdb
;

247  
rc
;

248 
	}
}

250 
	$ã°_mdb_˛o£
(
Te°Db
 *
pDb
){

251 
MdbDb
 *
pMdb
 = (MdbDb *)
pDb
;

253 
	`mdb_˛o£
(
pMdb
->
ív
,ÖMdb->
dbi
);

254 
	`mdb_ív_˛o£
(
pMdb
->
ív
);

255 
	`‰ì
(
pMdb
);

257 
	}
}

259 
	$ã°_mdb_wrôe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
){

260 
rc
;

261 
MdbDb
 *
pMdb
 = (MdbDb *)
pDb
;

262 
MDB_vÆ
 
vÆ
;

263 
MDB_vÆ
 
key
;

264 
MDB_txn
 *
txn
;

266 
vÆ
.
mv_size
 = 
nVÆ
;

267 
vÆ
.
mv_d©a
 = 
pVÆ
;

268 
key
.
mv_size
 = 
nKey
;

269 
key
.
mv_d©a
 = 
pKey
;

271 
rc
 = 
	`mdb_txn_begö
(
pMdb
->
ív
, 
NULL
, 0, &
txn
);

272 if–
rc
==0 ){

273 
rc
 = 
	`mdb_put
(
txn
, 
pMdb
->
dbi
, &
key
, &
vÆ
, 0);

274 if–
rc
==0 ){

275 
rc
 = 
	`mdb_txn_commô
(
txn
);

277 
	`mdb_txn_ab‹t
(
txn
);

281  
rc
;

282 
	}
}

284 
	$ã°_mdb_dñëe
(
Te°Db
 *
pDb
, *
pKey
, 
nKey
){

285 
rc
;

286 
MdbDb
 *
pMdb
 = (MdbDb *)
pDb
;

287 
MDB_vÆ
 
key
;

288 
MDB_txn
 *
txn
;

290 
key
.
mv_size
 = 
nKey
;

291 
key
.
mv_d©a
 = 
pKey
;

292 
rc
 = 
	`mdb_txn_begö
(
pMdb
->
ív
, 
NULL
, 0, &
txn
);

293 if–
rc
==0 ){

294 
rc
 = 
	`mdb_dñ
(
txn
, 
pMdb
->
dbi
, &
key
, 0);

295 if–
rc
==0 ){

296 
rc
 = 
	`mdb_txn_commô
(
txn
);

298 
	`mdb_txn_ab‹t
(
txn
);

302  
rc
;

303 
	}
}

305 
	$ã°_mdb_„tch
(

306 
Te°Db
 *
pDb
,

307 *
pKey
,

308 
nKey
,

309 **
µVÆ
,

310 *
≤VÆ


312 
rc
;

313 
MdbDb
 *
pMdb
 = (MdbDb *)
pDb
;

314 
MDB_vÆ
 
key
;

315 
MDB_txn
 *
txn
;

317 
key
.
mv_size
 = 
nKey
;

318 
key
.
mv_d©a
 = 
pKey
;

320 
rc
 = 
	`mdb_txn_begö
(
pMdb
->
ív
, 
NULL
, 
MDB_RDONLY
, &
txn
);

321 if–
rc
==0 ){

322 
MDB_vÆ
 
vÆ
 = {0, 0};

323 
rc
 = 
	`mdb_gë
(
txn
, 
pMdb
->
dbi
, &
key
, &
vÆ
);

324 if–
rc
==
MDB_NOTFOUND
 ){

325 
rc
 = 0;

326 *
µVÆ
 = 0;

327 *
≤VÆ
 = -1;

329 *
µVÆ
 = 
vÆ
.
mv_d©a
;

330 *
≤VÆ
 = 
vÆ
.
mv_size
;

332 
	`mdb_txn_commô
(
txn
);

335  
rc
;

336 
	}
}

338 
ã°_mdb_sˇn
(

339 
Te°Db
 *
pDb
,

340 *
pCtx
,

341 
bRevî£
,

342 *
pKey1
, 
nKey1
,

343 *
pKey2
, 
nKey2
,

344 (*
xCÆlback
)(*
pCtx
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
)

346 
MdbDb
 *
pMdb
 = (MdbDb *)
pDb
;

347 
rc
;

348 
MDB_curs‹_›
 
›
 = 
bRevî£
 ? 
MDB_PREV
 : 
MDB_NEXT
;

349 
MDB_txn
 *
txn
;

351 
rc
 = 
	`mdb_txn_begö
(
pMdb
->
ív
, 
NULL
, 
MDB_RDONLY
, &
txn
);

352 if–
rc
==0 ){

353 
MDB_curs‹
 *
c§
;

354 
MDB_vÆ
 
key
 = {0, 0};

355 
MDB_vÆ
 
vÆ
 = {0, 0};

357 
rc
 = 
	`mdb_curs‹_›í
(
txn
, 
pMdb
->
dbi
, &
c§
);

358 if–
rc
==0 ){

359  
	`mdb_curs‹_gë
(
c§
, &
key
, &
vÆ
, 
›
)==0 ){

360 
	`xCÆlback
(
pCtx
, 
key
.
mv_d©a
, key.
mv_size
, 
vÆ
.mv_data, val.mv_size);

362 
	`mdb_curs‹_˛o£
(
c§
);

366  
rc
;

367 
	}
}

	@lsm-test/lsmtest_tdb3.c

2 
	~"lsmã°_tdb.h
"

3 
	~"lsm.h
"

4 
	~"lsmã°.h
"

6 
	~<°dlib.h
>

7 
	~<°rög.h
>

8 
	~<as£π.h
>

9 
	~<uni°d.h
>

10 
	~<°dio.h
>

12 
	~<sys/time.h
>

14 
LsmDb
 
	tLsmDb
;

15 
LsmW‹kî
 
	tLsmW‹kî
;

16 
LsmFûe
 
	tLsmFûe
;

18 
	#LSMTEST_DFLT_MT_MAX_CKPT
 (8*1024)

	)

19 
	#LSMTEST_DFLT_MT_MIN_CKPT
 (2*1024)

	)

21 #ifde‡
LSM_MUTEX_PTHREADS


22 
	~<±hªad.h
>

24 
	#LSMTEST_THREAD_CKPT
 1

	)

25 
	#LSMTEST_THREAD_WORKER
 2

	)

26 
	#LSMTEST_THREAD_WORKER_AC
 3

	)

36 
	sLsmW‹kî
 {

37 
LsmDb
 *
	mpDb
;

38 
lsm_db
 *
	mpW‹kî
;

39 
±hªad_t
 
	mw‹kî_thªad
;

40 
±hªad_c⁄d_t
 
	mw‹kî_c⁄d
;

41 
±hªad_muãx_t
 
	mw‹kî_muãx
;

42 
	mbDoW‹k
;

43 
	mw‹kî_rc
;

44 
	meTy≥
;

45 
	mbBlock
;

48 
	sLsmW‹kî
 { 
	mw‹kî_rc
; 
	mbBlock
; };

51 
mt_shutdown
(
LsmDb
 *);

53 
lsm_ív
 *
	$tdb_lsm_ív
(){

54 
bInô
 = 0;

55 
lsm_ív
 
ív
;

56 if–
bInô
==0 ){

57 
	`mem˝y
(&
ív
, 
	`lsm_deÁu…_ív
(), (env));

58 
bInô
 = 1;

60  &
ív
;

61 
	}
}

63 
FûeSe˘‹
 
	tFûeSe˘‹
;

64 
FûeD©a
 
	tFûeD©a
;

66 
	sFûeSe˘‹
 {

67 
u8
 *
	maOld
;

70 
	sFûeD©a
 {

71 
	mnSe˘‹
;

72 
FûeSe˘‹
 *
	maSe˘‹
;

92 
	sLsmDb
 {

93 
Te°Db
 
	mba£
;

94 
lsm_ív
 
	mív
;

95 *
	mzName
;

96 
lsm_db
 *
	mdb
;

98 
lsm_curs‹
 *
	mpC§
;

99 *
	mpBuf
;

100 
	mnBuf
;

103 
	mbCøshed
;

104 
	mnAutoCøsh
;

105 
	mbPª∑ªCøsh
;

108 
	mszSe˘‹
;

109 
FûeD©a
 
	maFûe
[2];

112 
	mbNoRecovîy
;

115 (*
	mxW‹k
)(
	mlsm_db
 *, *);

116 *
	mpW‹kCtx
;

119 (*
	mxWrôeHook
)(*, , 
	mlsm_i64
, , );

120 *
	mpWrôeCtx
;

123 
	mnMtMöCk±
;

124 
	mnMtMaxCk±
;

125 
	meMode
;

126 
	mnW‹kî
;

127 
LsmW‹kî
 *
	maW‹kî
;

130 
	#LSMTEST_MODE_SINGLETHREAD
 1

	)

131 
	#LSMTEST_MODE_BACKGROUND_CKPT
 2

	)

132 
	#LSMTEST_MODE_BACKGROUND_WORK
 3

	)

133 
	#LSMTEST_MODE_BACKGROUND_BOTH
 4

	)

140 
	sLsmFûe
 {

141 
lsm_fûe
 *
	mpRól
;

142 
	mbLog
;

143 
LsmDb
 *
	mpDb
;

146 
	$ã°EnvFuŒ∑th
(

147 
lsm_ív
 *
pEnv
,

148 c⁄° *
zFûe
,

149 *
zOut
,

150 *
≤Out


152 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

153  
pRólEnv
->
	`xFuŒ∑th
’RólEnv, 
zFûe
, 
zOut
, 
≤Out
);

154 
	}
}

156 
	$ã°EnvO≥n
(

157 
lsm_ív
 *
pEnv
,

158 c⁄° *
zFûe
,

159 
Êags
,

160 
lsm_fûe
 **
µFûe


162 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

163 
LsmDb
 *
pDb
 = (LsmDb *)
pEnv
->
pVfsCtx
;

164 
rc
;

165 
LsmFûe
 *
pRë
;

166 
nFûe
;

168 
nFûe
 = 
	`°æí
(
zFûe
);

169 
pRë
 = (
LsmFûe
 *)
	`ã°MÆloc
((LsmFile));

170 
pRë
->
pDb
 =ÖDb;

171 
pRë
->
bLog
 = (
nFûe
 > 4 && 0==
	`memcmp
("-log", &
zFûe
[nFile-4], 4));

173 
rc
 = 
pRólEnv
->
	`xO≥n
’RólEnv, 
zFûe
, 
Êags
, &
pRë
->
pRól
);

174 if–
rc
!=
LSM_OK
 ){

175 
	`ã°Fªe
(
pRë
);

176 
pRë
 = 0;

179 *
µFûe
 = (
lsm_fûe
 *)
pRë
;

180  
rc
;

181 
	}
}

183 
	$ã°EnvRód
(
lsm_fûe
 *
pFûe
, 
lsm_i64
 
iOff
, *
pD©a
, 
nD©a
){

184 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

185 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

186 if–
p
->
pDb
->
bCøshed
 )  
LSM_IOERR
;

187  
pRólEnv
->
	`xRód
(
p
->
pRól
, 
iOff
, 
pD©a
, 
nD©a
);

188 
	}
}

190 
	$ã°EnvWrôe
(
lsm_fûe
 *
pFûe
, 
lsm_i64
 
iOff
, *
pD©a
, 
nD©a
){

191 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

192 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

193 
LsmDb
 *
pDb
 = 
p
->pDb;

195 if–
pDb
->
bCøshed
 )  
LSM_IOERR
;

197 if–
pDb
->
bPª∑ªCøsh
 ){

198 
FûeD©a
 *
pD©a
 = &
pDb
->
aFûe
[
p
->
bLog
];

199 
iFú°
;

200 
iLa°
;

201 
iSe˘‹
;

203 
iFú°
 = (
iOff
 / 
pDb
->
szSe˘‹
);

204 
iLa°
 = ((
iOff
 + 
nD©a
 - 1Ë/ 
pDb
->
szSe˘‹
);

206 if–
pD©a
->
nSe˘‹
<(
iLa°
+1) ){

207 
nNew
 = ( ((
iLa°
 + 1) + 63) / 64 ) * 64;

208 
	`as£π
–
nNew
>
iLa°
 );

209 
pD©a
->
aSe˘‹
 = (
FûeSe˘‹
 *)
	`ã°RóŒoc
(

210 
pD©a
->
aSe˘‹
, 
nNew
*(
FûeSe˘‹
)

212 
	`mem£t
(&
pD©a
->
aSe˘‹
[pD©a->
nSe˘‹
],

213 0, (
nNew
 - 
pD©a
->
nSe˘‹
Ë* (
FûeSe˘‹
)

215 
pD©a
->
nSe˘‹
 = 
nNew
;

218 
iSe˘‹
=
iFú°
; iSe˘‹<=
iLa°
; iSector++){

219 if–
pD©a
->
aSe˘‹
[
iSe˘‹
].
aOld
==0 ){

220 
u8
 *
aOld
 = (u8 *)
	`ã°MÆloc
(
pDb
->
szSe˘‹
);

221 
pRólEnv
->
	`xRód
(

222 
p
->
pRól
, (
lsm_i64
)
iSe˘‹
*
pDb
->
szSe˘‹
, 
aOld
,ÖDb->szSector

224 
pD©a
->
aSe˘‹
[
iSe˘‹
].
aOld
 =áOld;

229 if–
pDb
->
xWrôeHook
 ){

230 
rc
;

231 
nUs
;

232 
timevÆ
 
t1
;

233 
timevÆ
 
t2
;

235 
	`gëtimeofday
(&
t1
, 0);

236 
	`as£π
–
nD©a
>0 );

237 
rc
 = 
pRólEnv
->
	`xWrôe
(
p
->
pRól
, 
iOff
, 
pD©a
, 
nD©a
);

238 
	`gëtimeofday
(&
t2
, 0);

240 
nUs
 = (
t2
.
tv_£c
 - 
t1
.tv_£cË* 1000000 + (t2.
tv_u£c
 -Å1.tv_usec);

241 
pDb
->
	`xWrôeHook
’Db->
pWrôeCtx
, 
p
->
bLog
, 
iOff
, 
nD©a
, 
nUs
);

242  
rc
;

245  
pRólEnv
->
	`xWrôe
(
p
->
pRól
, 
iOff
, 
pD©a
, 
nD©a
);

246 
	}
}

248 
doSy°emCøsh
(
LsmDb
 *
pDb
);

250 
	$ã°EnvSync
(
lsm_fûe
 *
pFûe
){

251 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

252 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

253 
LsmDb
 *
pDb
 = 
p
->pDb;

254 
FûeD©a
 *
pD©a
 = &
pDb
->
aFûe
[
p
->
bLog
];

255 
i
;

257 if–
pDb
->
bCøshed
 )  
LSM_IOERR
;

259 if–
pDb
->
nAutoCøsh
 ){

260 
pDb
->
nAutoCøsh
--;

261 if–
pDb
->
nAutoCøsh
==0 ){

262 
	`doSy°emCøsh
(
pDb
);

263 
pDb
->
bCøshed
 = 1;

264  
LSM_IOERR
;

268 if–
pDb
->
bPª∑ªCøsh
 ){

269 
i
=0; i<
pD©a
->
nSe˘‹
; i++){

270 
	`ã°Fªe
(
pD©a
->
aSe˘‹
[
i
].
aOld
);

271 
pD©a
->
aSe˘‹
[
i
].
aOld
 = 0;

275 if–
pDb
->
xWrôeHook
 ){

276 
rc
;

277 
nUs
;

278 
timevÆ
 
t1
;

279 
timevÆ
 
t2
;

281 
	`gëtimeofday
(&
t1
, 0);

282 
rc
 = 
pRólEnv
->
	`xSync
(
p
->
pRól
);

283 
	`gëtimeofday
(&
t2
, 0);

285 
nUs
 = (
t2
.
tv_£c
 - 
t1
.tv_£cË* 1000000 + (t2.
tv_u£c
 -Å1.tv_usec);

286 
pDb
->
	`xWrôeHook
’Db->
pWrôeCtx
, 
p
->
bLog
, 0, 0, 
nUs
);

287  
rc
;

290  
pRólEnv
->
	`xSync
(
p
->
pRól
);

291 
	}
}

293 
	$ã°EnvTrunˇã
(
lsm_fûe
 *
pFûe
, 
lsm_i64
 
iOff
){

294 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

295 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

296 if–
p
->
pDb
->
bCøshed
 )  
LSM_IOERR
;

297  
pRólEnv
->
	`xTrunˇã
(
p
->
pRól
, 
iOff
);

298 
	}
}

300 
	$ã°EnvSe˘‹Size
(
lsm_fûe
 *
pFûe
){

301 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

302 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

303  
pRólEnv
->
	`xSe˘‹Size
(
p
->
pRól
);

304 
	}
}

306 
	$ã°EnvRem≠
(

307 
lsm_fûe
 *
pFûe
,

308 
lsm_i64
 
iMö
,

309 **
µOut
,

310 
lsm_i64
 *
≤Out


312 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

313 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

314  
pRólEnv
->
	`xRem≠
(
p
->
pRól
, 
iMö
, 
µOut
, 
≤Out
);

315 
	}
}

317 
	$ã°EnvFûeid
(

318 
lsm_fûe
 *
pFûe
,

319 *
µOut
,

320 *
≤Out


322 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

323 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

324  
pRólEnv
->
	`xFûeid
(
p
->
pRól
, 
µOut
, 
≤Out
);

325 
	}
}

327 
	$ã°EnvClo£
(
lsm_fûe
 *
pFûe
){

328 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

329 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

331 
pRólEnv
->
	`xClo£
(
p
->
pRól
);

332 
	`ã°Fªe
(
p
);

333  
LSM_OK
;

334 
	}
}

336 
	$ã°EnvU∆ök
(
lsm_ív
 *
pEnv
, c⁄° *
zFûe
){

337 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

338 
	`unu£d_∑ømëî
(
pEnv
);

339  
pRólEnv
->
	`xU∆ök
’RólEnv, 
zFûe
);

340 
	}
}

342 
	$ã°EnvLock
(
lsm_fûe
 *
pFûe
, 
iLock
, 
eTy≥
){

343 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

344 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

346 if–
iLock
==2 && 
eTy≥
==
LSM_LOCK_EXCL
 && 
p
->
pDb
->
bNoRecovîy
 ){

347  
LSM_BUSY
;

349  
pRólEnv
->
	`xLock
(
p
->
pRól
, 
iLock
, 
eTy≥
);

350 
	}
}

352 
	$ã°EnvTe°Lock
(
lsm_fûe
 *
pFûe
, 
iLock
, 
nLock
, 
eTy≥
){

353 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

354 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

356 if–
iLock
==2 && 
eTy≥
==
LSM_LOCK_EXCL
 && 
p
->
pDb
->
bNoRecovîy
 ){

357  
LSM_BUSY
;

359  
pRólEnv
->
	`xTe°Lock
(
p
->
pRól
, 
iLock
, 
nLock
, 
eTy≥
);

360 
	}
}

362 
	$ã°EnvShmM≠
(
lsm_fûe
 *
pFûe
, 
iRegi⁄
, 
sz
, **
µ
){

363 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

364 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

365  
pRólEnv
->
	`xShmM≠
(
p
->
pRól
, 
iRegi⁄
, 
sz
, 
µ
);

366 
	}
}

368 
	$ã°EnvShmB¨rõr
(){

369 
	}
}

371 
	$ã°EnvShmUnm≠
(
lsm_fûe
 *
pFûe
, 
bDñ
){

372 
LsmFûe
 *
p
 = (LsmFûê*)
pFûe
;

373 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

374  
pRólEnv
->
	`xShmUnm≠
(
p
->
pRól
, 
bDñ
);

375 
	}
}

377 
	$ã°EnvSÀï
(
lsm_ív
 *
pEnv
, 
us
){

378 
lsm_ív
 *
pRólEnv
 = 
	`tdb_lsm_ív
();

379  
pRólEnv
->
	`xSÀï
’RólEnv, 
us
);

380 
	}
}

382 
	$doSy°emCøsh
(
LsmDb
 *
pDb
){

383 
lsm_ív
 *
pEnv
 = 
	`tdb_lsm_ív
();

384 
iFûe
;

385 
iSìd
 = 
pDb
->
aFûe
[0].
nSe˘‹
 +ÖDb->aFile[1].nSector;

387 *
zFûe
 = 
pDb
->
zName
;

388 *
zFªe
 = 0;

390 
iFûe
=0; iFile<2; iFile++){

391 
lsm_fûe
 *
pFûe
 = 0;

392 
i
;

394 
pEnv
->
	`xO≥n
’Env, 
zFûe
, 0, &
pFûe
);

395 
i
=0; i<
pDb
->
aFûe
[
iFûe
].
nSe˘‹
; i++){

396 
u8
 *
aOld
 = 
pDb
->
aFûe
[
iFûe
].
aSe˘‹
[
i
].aOld;

397 if–
aOld
 ){

398 
iO±
 = 
	`ã°P∫gVÆue
(
iSìd
++) % 3;

399  
iO±
 ){

404 
	`ã°P∫gAºay
(
iSìd
++, (
u32
 *)
aOld
, 
pDb
->
szSe˘‹
/4);

408 
pEnv
->
	`xWrôe
(

409 
pFûe
, (
lsm_i64
)
i
 * 
pDb
->
szSe˘‹
, 
aOld
,ÖDb->szSector

413 
	`ã°Fªe
(
aOld
);

414 
pDb
->
aFûe
[
iFûe
].
aSe˘‹
[
i
].
aOld
 = 0;

417 
pEnv
->
	`xClo£
(
pFûe
);

418 
zFªe
 = 
zFûe
 = 
	`sqlôe3_m¥ötf
("%s-log", 
pDb
->
zName
);

421 
	`sqlôe3_‰ì
(
zFªe
);

422 
	}
}

433 #ifde‡
HAVE_ZLIB


434 
	~<zlib.h
>

436 
	$ã°ZùBound
(*
pCtx
, 
nSrc
){

437  
	`com¥essBound
(
nSrc
);

438 
	}
}

440 
	$ã°ZùCom¥ess
(

441 *
pCtx
,

442 *
aOut
, *
≤Out
,

443 c⁄° *
aIn
, 
nIn


445 
uL⁄gf
 
n
 = *
≤Out
;

446 
rc
;

448 
rc
 = 
	`com¥ess
((
Byãf
*)
aOut
, &
n
, (Byãf*)
aIn
, 
nIn
);

449 *
≤Out
 = 
n
;

450  (
rc
==
Z_OK
 ? 0 : 
LSM_ERROR
);

451 
	}
}

453 
	$ã°ZùUncom¥ess
(

454 *
pCtx
,

455 *
aOut
, *
≤Out
,

456 c⁄° *
aIn
, 
nIn


458 
uL⁄gf
 
n
 = *
≤Out
;

459 
rc
;

461 
rc
 = 
	`uncom¥ess
((
Byãf
*)
aOut
, &
n
, (Byãf*)
aIn
, 
nIn
);

462 *
≤Out
 = 
n
;

463  (
rc
==
Z_OK
 ? 0 : 
LSM_ERROR
);

464 
	}
}

466 
	$ã°C⁄figuªCom¥essi⁄
(
lsm_db
 *
pDb
){

467 
lsm_com¥ess
 
zù
 = {

470 
ã°ZùBound
,

471 
ã°ZùCom¥ess
,

472 
ã°ZùUncom¥ess


474  
	`lsm_c⁄fig
(
pDb
, 
LSM_CONFIG_SET_COMPRESSION
, &
zù
);

475 
	}
}

483 
	$ã°_lsm_˛o£
(
Te°Db
 *
pTe°Db
){

484 
i
;

485 
rc
 = 
LSM_OK
;

486 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

488 
	`lsm_c§_˛o£
(
pDb
->
pC§
);

489 
	`lsm_˛o£
(
pDb
->
db
);

492 
	`mt_shutdown
(
pDb
);

493 
i
=0; i<
pDb
->
nW‹kî
 && 
rc
==
LSM_OK
; i++){

494 
rc
 = 
pDb
->
aW‹kî
[
i
].
w‹kî_rc
;

497 
i
=0; i<
pDb
->
aFûe
[0].
nSe˘‹
; i++){

498 
	`ã°Fªe
(
pDb
->
aFûe
[0].
aSe˘‹
[
i
].
aOld
);

500 
	`ã°Fªe
(
pDb
->
aFûe
[0].
aSe˘‹
);

501 
i
=0; i<
pDb
->
aFûe
[1].
nSe˘‹
; i++){

502 
	`ã°Fªe
(
pDb
->
aFûe
[1].
aSe˘‹
[
i
].
aOld
);

504 
	`ã°Fªe
(
pDb
->
aFûe
[1].
aSe˘‹
);

506 
	`mem£t
(
pDb
, (
LsmDb
), 0x11);

507 
	`ã°Fªe
((*)
pDb
->
pBuf
);

508 
	`ã°Fªe
((*)
pDb
);

509  
rc
;

510 
	}
}

512 
	$waôOnCheckpoöãr
(
LsmDb
 *
pDb
, 
lsm_db
 *
db
){

513 
nSÀï
 = 0;

514 
nKB
;

515 
rc
;

518 
nKB
 = 0;

519 
rc
 = 
	`lsm_öfo
(
db
, 
LSM_INFO_CHECKPOINT_SIZE
, &
nKB
);

520 if–
rc
!=
LSM_OK
 || 
nKB
<
pDb
->
nMtMaxCk±
 ) ;

521 
	`u¶ìp
(5000);

522 
nSÀï
 += 5;

526 if–
nSÀï
 ) 
	`¥ötf
("# waitOnCheckpointer():ÇSleep=%d\n",ÇSleep);

529  
rc
;

530 
	}
}

532 
	$waôOnW‹kî
(
LsmDb
 *
pDb
){

533 
rc
;

534 
nLimô
 = -1;

535 
nSÀï
 = 0;

537 
rc
 = 
	`lsm_c⁄fig
(
pDb
->
db
, 
LSM_CONFIG_AUTOFLUSH
, &
nLimô
);

539 
nOld
, 
nNew
, 
rc
;

540 
rc
 = 
	`lsm_öfo
(
pDb
->
db
, 
LSM_INFO_TREE_SIZE
, &
nOld
, &
nNew
);

541 if–
rc
!=
LSM_OK
 ) Ñc;

542 if–
nOld
==0 || 
nNew
<(
nLimô
/2) ) ;

543 
	`u¶ìp
(5000);

544 
nSÀï
 += 5;

548 if–
nSÀï
 ) 
	`¥ötf
("# waitOnWorker():ÇSleep=%d\n",ÇSleep);

551  
rc
;

552 
	}
}

554 
	$ã°_lsm_wrôe
(

555 
Te°Db
 *
pTe°Db
,

556 *
pKey
,

557 
nKey
,

558 *
pVÆ
,

559 
nVÆ


561 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

562 
rc
 = 
LSM_OK
;

564 if–
pDb
->
eMode
==
LSMTEST_MODE_BACKGROUND_CKPT
 ){

565 
rc
 = 
	`waôOnCheckpoöãr
(
pDb
,ÖDb->
db
);

567 
pDb
->
eMode
==
LSMTEST_MODE_BACKGROUND_WORK


568 || 
pDb
->
eMode
==
LSMTEST_MODE_BACKGROUND_BOTH


570 
rc
 = 
	`waôOnW‹kî
(
pDb
);

573 if–
rc
==
LSM_OK
 ){

574 
rc
 = 
	`lsm_ö£π
(
pDb
->
db
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

576  
rc
;

577 
	}
}

579 
	$ã°_lsm_dñëe
(
Te°Db
 *
pTe°Db
, *
pKey
, 
nKey
){

580 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

581  
	`lsm_dñëe
(
pDb
->
db
, 
pKey
, 
nKey
);

582 
	}
}

584 
	$ã°_lsm_dñëe_ønge
(

585 
Te°Db
 *
pTe°Db
,

586 *
pKey1
, 
nKey1
,

587 *
pKey2
, 
nKey2


589 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

590  
	`lsm_dñëe_ønge
(
pDb
->
db
, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
);

591 
	}
}

593 
	$ã°_lsm_„tch
(

594 
Te°Db
 *
pTe°Db
,

595 *
pKey
,

596 
nKey
,

597 **
µVÆ
,

598 *
≤VÆ


600 
rc
;

601 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

602 
lsm_curs‹
 *
c§
;

604 if–
pKey
==0 )  
LSM_OK
;

606 
rc
 = 
	`lsm_c§_›í
(
pDb
->
db
, &
c§
);

607 if–
rc
!=
LSM_OK
 ) Ñc;

609 
rc
 = 
	`lsm_c§_£ek
(
c§
, 
pKey
, 
nKey
, 
LSM_SEEK_EQ
);

610 if–
rc
==
LSM_OK
 ){

611 if–
	`lsm_c§_vÆid
(
c§
) ){

612 c⁄° *
pVÆ
; 
nVÆ
;

613 
rc
 = 
	`lsm_c§_vÆue
(
c§
, &
pVÆ
, &
nVÆ
);

614 if–
nVÆ
>
pDb
->
nBuf
 ){

615 
	`ã°Fªe
(
pDb
->
pBuf
);

616 
pDb
->
pBuf
 = 
	`ã°MÆloc
(
nVÆ
*2);

617 
pDb
->
nBuf
 = 
nVÆ
*2;

619 
	`mem˝y
(
pDb
->
pBuf
, 
pVÆ
, 
nVÆ
);

620 *
µVÆ
 = 
pDb
->
pBuf
;

621 *
≤VÆ
 = 
nVÆ
;

623 *
µVÆ
 = 0;

624 *
≤VÆ
 = -1;

627 
	`lsm_c§_˛o£
(
c§
);

628  
rc
;

629 
	}
}

631 
ã°_lsm_sˇn
(

632 
Te°Db
 *
pTe°Db
,

633 *
pCtx
,

634 
bRevî£
,

635 *
pFú°
, 
nFú°
,

636 *
pLa°
, 
nLa°
,

637 (*
xCÆlback
)(*, *, , *, )

639 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

640 
lsm_curs‹
 *
c§
;

641 
rc
;

643 
rc
 = 
	`lsm_c§_›í
(
pDb
->
db
, &
c§
);

644 if–
rc
!=
LSM_OK
 ) Ñc;

646 if–
bRevî£
 ){

647 if–
pLa°
 ){

648 
rc
 = 
	`lsm_c§_£ek
(
c§
, 
pLa°
, 
nLa°
, 
LSM_SEEK_LE
);

650 
rc
 = 
	`lsm_c§_œ°
(
c§
);

653 if–
pFú°
 ){

654 
rc
 = 
	`lsm_c§_£ek
(
c§
, 
pFú°
, 
nFú°
, 
LSM_SEEK_GE
);

656 
rc
 = 
	`lsm_c§_fú°
(
c§
);

660  
rc
==
LSM_OK
 && 
	`lsm_c§_vÆid
(
c§
) ){

661 c⁄° *
pKey
; 
nKey
;

662 c⁄° *
pVÆ
; 
nVÆ
;

663 
cmp
;

665 
	`lsm_c§_key
(
c§
, &
pKey
, &
nKey
);

666 
	`lsm_c§_vÆue
(
c§
, &
pVÆ
, &
nVÆ
);

668 if–
bRevî£
 && 
pFú°
 ){

669 
cmp
 = 
	`memcmp
(
pFú°
, 
pKey
, 
	`MIN
(
nKey
, 
nFú°
));

670 if–
cmp
>0 || (cmp==0 && 
nFú°
>
nKey
) ) ;

671 }if–
bRevî£
==0 && 
pLa°
 ){

672 
cmp
 = 
	`memcmp
(
pLa°
, 
pKey
, 
	`MIN
(
nKey
, 
nLa°
));

673 if–
cmp
<0 || (cmp==0 && 
nLa°
<
nKey
) ) ;

676 
	`xCÆlback
(
pCtx
, (*)
pKey
, 
nKey
, (*)
pVÆ
, 
nVÆ
);

678 if–
bRevî£
 ){

679 
rc
 = 
	`lsm_c§_¥ev
(
c§
);

681 
rc
 = 
	`lsm_c§_√xt
(
c§
);

685 
	`lsm_c§_˛o£
(
c§
);

686  
rc
;

687 
	}
}

689 
	$ã°_lsm_begö
(
Te°Db
 *
pTe°Db
, 
iLevñ
){

690 
rc
 = 
LSM_OK
;

691 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

694 if–
iLevñ
==0 )  0;

696 if–
pDb
->
pC§
==0 ) 
rc
 = 
	`lsm_c§_›í
’Db->
db
, &pDb->pCsr);

697 if–
rc
==
LSM_OK
 && 
iLevñ
>1 ){

698 
rc
 = 
	`lsm_begö
(
pDb
->
db
, 
iLevñ
-1);

701  
rc
;

702 
	}
}

703 
	$ã°_lsm_commô
(
Te°Db
 *
pTe°Db
, 
iLevñ
){

704 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

707 if–
iLevñ
==0 && 
pDb
->
pC§
 ){

708 
	`lsm_c§_˛o£
(
pDb
->
pC§
);

709 
pDb
->
pC§
 = 0;

713  
	`lsm_commô
(
pDb
->
db
, 
	`MAX
(0, 
iLevñ
-1));

714 
	}
}

715 
	$ã°_lsm_rﬁlback
(
Te°Db
 *
pTe°Db
, 
iLevñ
){

716 
LsmDb
 *
pDb
 = (LsmDb *)
pTe°Db
;

719 if–
iLevñ
==0 && 
pDb
->
pC§
 ){

720 
	`lsm_c§_˛o£
(
pDb
->
pC§
);

721 
pDb
->
pC§
 = 0;

724  
	`lsm_rﬁlback
(
pDb
->
db
, 
	`MAX
(0, 
iLevñ
-1));

725 
	}
}

731 
	$xLog
(*
pCtx
, 
rc
, c⁄° *
z
){

732 
	`unu£d_∑ømëî
(
rc
);

734 if–
pCtx
 ) 
	`Ârötf
(
°dîr
, "%s: ", (*)pCtx);

735 
	`Ârötf
(
°dîr
, "%s\n", 
z
);

736 
	`fÊush
(
°dîr
);

737 
	}
}

739 
	$xW‹kHook
(
lsm_db
 *
db
, *
pArg
){

740 
LsmDb
 *
p
 = (LsmDb *)
pArg
;

741 if–
p
->
xW‹k
 )Ö->
	`xW‹k
(
db
,Ö->
pW‹kCtx
);

742 
	}
}

744 
	#TEST_NO_RECOVERY
 -1

	)

745 
	#TEST_COMPRESSION
 -3

	)

747 
	#TEST_MT_MODE
 -2

	)

748 
	#TEST_MT_MIN_CKPT
 -4

	)

749 
	#TEST_MT_MAX_CKPT
 -5

	)

751 
	$ã°_lsm_c⁄fig_°r
(

752 
LsmDb
 *
pLsm
,

753 
lsm_db
 *
db
,

754 
bW‹kî
,

755 c⁄° *
zSå
,

756 *
≤Thªad


758 
	sCfgP¨am
 {

759 c⁄° *
zP¨am
;

760 
bW‹kî
;

761 
eP¨am
;

762 } 
aP¨am
[] = {

763 { "autoÊush", 0, 
LSM_CONFIG_AUTOFLUSH
 },

764 { "∑ge_size", 0, 
LSM_CONFIG_PAGE_SIZE
 },

765 { "block_size", 0, 
LSM_CONFIG_BLOCK_SIZE
 },

766 { "ß„ty", 0, 
LSM_CONFIG_SAFETY
 },

767 { "autow‹k", 0, 
LSM_CONFIG_AUTOWORK
 },

768 { "autocheckpoöt", 0, 
LSM_CONFIG_AUTOCHECKPOINT
 },

769 { "mm≠", 0, 
LSM_CONFIG_MMAP
 },

770 { "u£_log", 0, 
LSM_CONFIG_USE_LOG
 },

771 { "automîge", 0, 
LSM_CONFIG_AUTOMERGE
 },

772 { "max_‰ìli°", 0, 
LSM_CONFIG_MAX_FREELIST
 },

773 { "mu…i_¥oc", 0, 
LSM_CONFIG_MULTIPLE_PROCESSES
 },

774 { "w‹kî_automîge", 1, 
LSM_CONFIG_AUTOMERGE
 },

775 { "ã°_no_ªcovîy", 0, 
TEST_NO_RECOVERY
 },

776 { "bg_mö_ck±", 0, 
TEST_NO_RECOVERY
 },

778 { "mt_mode", 0, 
TEST_MT_MODE
 },

779 { "mt_mö_ck±", 0, 
TEST_MT_MIN_CKPT
 },

780 { "mt_max_ck±", 0, 
TEST_MT_MAX_CKPT
 },

782 #ifde‡
HAVE_ZLIB


783 { "com¥essi⁄", 0, 
TEST_COMPRESSION
 },

787 c⁄° *
z
 = 
zSå
;

788 
nThªad
 = 1;

790 
	`as£π
–
db
 );

791  
z
[0] ){

792 c⁄° *
zSèπ
;

795  *
z
==' ' ) z++;

796 
zSèπ
 = 
z
;

798  *
z
 && *z!='=' ) z++;

799 if–*
z
 ){

800 
eP¨am
;

801 
i
;

802 
iVÆ
;

803 
iMul
 = 1;

804 
rc
;

805 
zP¨am
[32];

806 
nP¨am
 = 
z
-
zSèπ
;

807 if–
nP¨am
==0 ||ÇP¨am>(
zP¨am
)-1 ) 
sy¡ax_îr‹
;

809 
	`mem˝y
(
zP¨am
, 
zSèπ
, 
nP¨am
);

810 
zP¨am
[
nP¨am
] = '\0';

811 
rc
 = 
	`ã°ArgSñe˘
(
aP¨am
, "∑øm", 
zP¨am
, &
i
);

812 if–
rc
!=0 ) Ñc;

813 
eP¨am
 = 
aP¨am
[
i
].eParam;

815 
z
++;

816 
zSèπ
 = 
z
;

817  *
z
>='0' && *z<='9' ) z++;

818 if–*
z
=='k' || *z=='K' ){

819 
iMul
 = 1;

820 
z
++;

821 }if–*
z
=='M' || *z=='M' ){

822 
iMul
 = 1024;

823 
z
++;

825 
nP¨am
 = 
z
-
zSèπ
;

826 if–
nP¨am
==0 ||ÇP¨am>(
zP¨am
)-1 ) 
sy¡ax_îr‹
;

827 
	`mem˝y
(
zP¨am
, 
zSèπ
, 
nP¨am
);

828 
zP¨am
[
nP¨am
] = '\0';

829 
iVÆ
 = 
	`©oi
(
zP¨am
Ë* 
iMul
;

831 if–
eP¨am
>0 ){

832 if–
bW‹kî
 || 
aP¨am
[
i
].bWorker==0 ){

833 
	`lsm_c⁄fig
(
db
, 
eP¨am
, &
iVÆ
);

836  
eP¨am
 ){

837 
TEST_NO_RECOVERY
:

838 if–
pLsm
 )ÖLsm->
bNoRecovîy
 = 
iVÆ
;

840 
TEST_MT_MODE
:

841 if–
pLsm
 ) 
nThªad
 = 
iVÆ
;

843 
TEST_MT_MIN_CKPT
:

844 if–
pLsm
 && 
iVÆ
>0 )ÖLsm->
nMtMöCk±
 = iVal*1024;

846 
TEST_MT_MAX_CKPT
:

847 if–
pLsm
 && 
iVÆ
>0 )ÖLsm->
nMtMaxCk±
 = iVal*1024;

849 #ifde‡
HAVE_ZLIB


850 
TEST_COMPRESSION
:

851 
	`ã°C⁄figuªCom¥essi⁄
(
db
);

856 }if–
z
!=
zSèπ
 ){

857 
sy¡ax_îr‹
;

861 if–
≤Thªad
 ) *≤Thªad = 
nThªad
;

862 if–
pLsm
 &&ÖLsm->
nMtMaxCk±
 <ÖLsm->
nMtMöCk±
 ){

863 
pLsm
->
nMtMöCk±
 =ÖLsm->
nMtMaxCk±
;

867 
sy¡ax_îr‹
:

868 
	`ã°PrötEº‹
("sy¡axÉº‹át: \"%s\"\n", 
z
);

870 
	}
}

872 
	$tdb_lsm_c⁄fig_°r
(
Te°Db
 *
pDb
, c⁄° *
zSå
){

873 
rc
 = 0;

874 if–
	`tdb_lsm
(
pDb
) ){

875 
i
;

876 
LsmDb
 *
pLsm
 = (LsmDb *)
pDb
;

878 
rc
 = 
	`ã°_lsm_c⁄fig_°r
(
pLsm
,ÖLsm->
db
, 0, 
zSå
, 0);

879 #ifde‡
LSM_MUTEX_PTHREADS


880 
i
=0; 
rc
==0 && i<
pLsm
->
nW‹kî
; i++){

881 
rc
 = 
	`ã°_lsm_c⁄fig_°r
(0, 
pLsm
->
aW‹kî
[
i
].
pW‹kî
, 1, 
zSå
, 0);

885  
rc
;

886 
	}
}

888 
	$tdb_lsm_c⁄figuª
(
lsm_db
 *
db
, c⁄° *
zC⁄fig
){

889  
	`ã°_lsm_c⁄fig_°r
(0, 
db
, 0, 
zC⁄fig
, 0);

890 
	}
}

892 
ã°LsmSèπW‹kîs
(
LsmDb
 *, , const *, const *);

894 
	$ã°LsmO≥n
(

895 c⁄° *
zCfg
,

896 c⁄° *
zFûíame
,

897 
bCÀ¨
,

898 
Te°Db
 **
µDb


900 c⁄° 
D©aba£Mëhods
 
LsmMëhods
 = {

901 
ã°_lsm_˛o£
,

902 
ã°_lsm_wrôe
,

903 
ã°_lsm_dñëe
,

904 
ã°_lsm_dñëe_ønge
,

905 
ã°_lsm_„tch
,

906 
ã°_lsm_sˇn
,

907 
ã°_lsm_begö
,

908 
ã°_lsm_commô
,

909 
ã°_lsm_rﬁlback


912 
rc
;

913 
nFûíame
;

914 
LsmDb
 *
pDb
;

917 
	`as£π
–
zFûíame
);

918 if–
bCÀ¨
 ) 
	`ã°DñëeLsmdb
(
zFûíame
);

919 
nFûíame
 = 
	`°æí
(
zFûíame
);

921 
pDb
 = (
LsmDb
 *)
	`ã°MÆloc
((LsmDbË+ 
nFûíame
 + 1);

922 
	`mem£t
(
pDb
, 0, (
LsmDb
));

923 
pDb
->
ba£
.
pMëhods
 = &
LsmMëhods
;

924 
pDb
->
zName
 = (*)&pDb[1];

925 
	`mem˝y
(
pDb
->
zName
, 
zFûíame
, 
nFûíame
 + 1);

932 
pDb
->
szSe˘‹
 = 256;

935 
pDb
->
nMtMöCk±
 = 
LSMTEST_DFLT_MT_MIN_CKPT
;

936 
pDb
->
nMtMaxCk±
 = 
LSMTEST_DFLT_MT_MAX_CKPT
;

938 
	`mem˝y
(&
pDb
->
ív
, 
	`tdb_lsm_ív
(), (
lsm_ív
));

939 
pDb
->
ív
.
pVfsCtx
 = (*)pDb;

940 
pDb
->
ív
.
xFuŒ∑th
 = 
ã°EnvFuŒ∑th
;

941 
pDb
->
ív
.
xO≥n
 = 
ã°EnvO≥n
;

942 
pDb
->
ív
.
xRód
 = 
ã°EnvRód
;

943 
pDb
->
ív
.
xWrôe
 = 
ã°EnvWrôe
;

944 
pDb
->
ív
.
xTrunˇã
 = 
ã°EnvTrunˇã
;

945 
pDb
->
ív
.
xSync
 = 
ã°EnvSync
;

946 
pDb
->
ív
.
xSe˘‹Size
 = 
ã°EnvSe˘‹Size
;

947 
pDb
->
ív
.
xRem≠
 = 
ã°EnvRem≠
;

948 
pDb
->
ív
.
xFûeid
 = 
ã°EnvFûeid
;

949 
pDb
->
ív
.
xClo£
 = 
ã°EnvClo£
;

950 
pDb
->
ív
.
xU∆ök
 = 
ã°EnvU∆ök
;

951 
pDb
->
ív
.
xLock
 = 
ã°EnvLock
;

952 
pDb
->
ív
.
xTe°Lock
 = 
ã°EnvTe°Lock
;

953 
pDb
->
ív
.
xShmB¨rõr
 = 
ã°EnvShmB¨rõr
;

954 
pDb
->
ív
.
xShmM≠
 = 
ã°EnvShmM≠
;

955 
pDb
->
ív
.
xShmUnm≠
 = 
ã°EnvShmUnm≠
;

956 
pDb
->
ív
.
xSÀï
 = 
ã°EnvSÀï
;

958 
rc
 = 
	`lsm_√w
(&
pDb
->
ív
, &pDb->
db
);

959 if–
rc
==
LSM_OK
 ){

960 
nThªad
 = 1;

961 
	`lsm_c⁄fig_log
(
pDb
->
db
, 
xLog
, 0);

962 
	`lsm_c⁄fig_w‹k_hook
(
pDb
->
db
, 
xW‹kHook
, (*)pDb);

964 
rc
 = 
	`ã°_lsm_c⁄fig_°r
(
pDb
,ÖDb->
db
, 0, 
zCfg
, &
nThªad
);

965 if–
rc
==
LSM_OK
 )Ñ¯
	`lsm_›í
(
pDb
->
db
, 
zFûíame
);

967 
pDb
->
eMode
 = 
nThªad
;

968 #ifde‡
LSM_MUTEX_PTHREADS


969 if–
rc
==
LSM_OK
 && 
nThªad
>1 ){

970 
	`ã°LsmSèπW‹kîs
(
pDb
, 
nThªad
, 
zFûíame
, 
zCfg
);

974 if–
rc
!=
LSM_OK
 ){

975 
	`ã°_lsm_˛o£
((
Te°Db
 *)
pDb
);

976 
pDb
 = 0;

980 *
µDb
 = (
Te°Db
 *)
pDb
;

981  
rc
;

982 
	}
}

984 
	$ã°_lsm_›í
(

985 c⁄° *
zS≥c
,

986 c⁄° *
zFûíame
,

987 
bCÀ¨
,

988 
Te°Db
 **
µDb


990  
	`ã°LsmO≥n
("", 
zFûíame
, 
bCÀ¨
, 
µDb
);

991 
	}
}

993 
	$ã°_lsm_smÆl_›í
(

994 c⁄° *
zS≥c
,

995 c⁄° *
zFûe
,

996 
bCÀ¨
,

997 
Te°Db
 **
µDb


999 c⁄° *
zCfg
 = "page_size=256 block_size=64 mmap=1024";

1000  
	`ã°LsmO≥n
(
zCfg
, 
zFûe
, 
bCÀ¨
, 
µDb
);

1001 
	}
}

1003 
	$ã°_lsm_lomem_›í
(

1004 c⁄° *
zS≥c
,

1005 c⁄° *
zFûíame
,

1006 
bCÀ¨
,

1007 
Te°Db
 **
µDb


1010 c⁄° *
zCfg
 =

1015  
	`ã°LsmO≥n
(
zCfg
, 
zFûíame
, 
bCÀ¨
, 
µDb
);

1016 
	}
}

1018 
	$ã°_lsm_zù_›í
(

1019 c⁄° *
zS≥c
,

1020 c⁄° *
zFûíame
,

1021 
bCÀ¨
,

1022 
Te°Db
 **
µDb


1024 c⁄° *
zCfg
 =

1028  
	`ã°LsmO≥n
(
zCfg
, 
zFûíame
, 
bCÀ¨
, 
µDb
);

1029 
	}
}

1031 
lsm_db
 *
	$tdb_lsm
(
Te°Db
 *
pDb
){

1032 if–
pDb
->
pMëhods
->
xClo£
==
ã°_lsm_˛o£
 ){

1033  ((
LsmDb
 *)
pDb
)->
db
;

1036 
	}
}

1038 
	$tdb_lsm_íabÀ_log
(
Te°Db
 *
pDb
, 
bE«bÀ
){

1039 
lsm_db
 *
db
 = 
	`tdb_lsm
(
pDb
);

1040 if–
db
 ){

1041 
	`lsm_c⁄fig_log
(
db
, (
bE«bÀ
 ? 
xLog
 : 0), (*)"client");

1043 
	}
}

1045 
	$tdb_lsm_≠∂iˇti⁄_¸ash
(
Te°Db
 *
pDb
){

1046 if–
	`tdb_lsm
(
pDb
) ){

1047 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1048 
p
->
bCøshed
 = 1;

1050 
	}
}

1052 
	$tdb_lsm_¥ï¨e_sy°em_¸ash
(
Te°Db
 *
pDb
){

1053 if–
	`tdb_lsm
(
pDb
) ){

1054 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1055 
p
->
bPª∑ªCøsh
 = 1;

1057 
	}
}

1059 
	$tdb_lsm_sy°em_¸ash
(
Te°Db
 *
pDb
){

1060 if–
	`tdb_lsm
(
pDb
) ){

1061 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1062 
p
->
bCøshed
 = 1;

1063 
	`doSy°emCøsh
(
p
);

1065 
	}
}

1067 
	$tdb_lsm_ß„ty
(
Te°Db
 *
pDb
, 
eMode
){

1068 
	`as£π
–
eMode
==
LSM_SAFETY_OFF


1069 || 
eMode
==
LSM_SAFETY_NORMAL


1070 || 
eMode
==
LSM_SAFETY_FULL


1072 if–
	`tdb_lsm
(
pDb
) ){

1073 
iP¨am
 = 
eMode
;

1074 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1075 
	`lsm_c⁄fig
(
p
->
db
, 
LSM_CONFIG_SAFETY
, &
iP¨am
);

1077 
	}
}

1079 
	$tdb_lsm_¥ï¨e_sync_¸ash
(
Te°Db
 *
pDb
, 
iSync
){

1080 
	`as£π
–
iSync
>0 );

1081 if–
	`tdb_lsm
(
pDb
) ){

1082 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1083 
p
->
nAutoCøsh
 = 
iSync
;

1084 
p
->
bPª∑ªCøsh
 = 1;

1086 
	}
}

1088 
tdb_lsm_c⁄fig_w‹k_hook
(

1089 
Te°Db
 *
pDb
,

1090 (*
xW‹k
)(
lsm_db
 *, *),

1091 *
pW‹kCtx


1093 if–
	`tdb_lsm
(
pDb
) ){

1094 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1095 
p
->
xW‹k
 = xWork;

1096 
p
->
pW‹kCtx
 =ÖWorkCtx;

1098 
	}
}

1100 
tdb_lsm_wrôe_hook
(

1101 
Te°Db
 *
pDb
,

1102 (*
xWrôe
)(*, , 
lsm_i64
, , ),

1103 *
pWrôeCtx


1105 if–
	`tdb_lsm
(
pDb
) ){

1106 
LsmDb
 *
p
 = (LsmDb *)
pDb
;

1107 
p
->
xWrôeHook
 = 
xWrôe
;

1108 
p
->
pWrôeCtx
 =ÖWriteCtx;

1110 
	}
}

1112 
	$tdb_lsm_›í
(c⁄° *
zCfg
, c⁄° *
zDb
, 
bCÀ¨
, 
Te°Db
 **
µDb
){

1113  
	`ã°LsmO≥n
(
zCfg
, 
zDb
, 
bCÀ¨
, 
µDb
);

1114 
	}
}

1116 #ifde‡
LSM_MUTEX_PTHREADS


1121 
	$mt_sig«l_w‹kî
(
LsmDb
 *
pDb
, 
iW‹kî
){

1122 
LsmW‹kî
 *
p
 = &
pDb
->
aW‹kî
[
iW‹kî
];

1123 
	`±hªad_muãx_lock
(&
p
->
w‹kî_muãx
);

1124 
p
->
bDoW‹k
 = 1;

1125 
	`±hªad_c⁄d_sig«l
(&
p
->
w‹kî_c⁄d
);

1126 
	`±hªad_muãx_u∆ock
(&
p
->
w‹kî_muãx
);

1127 
	}
}

1132 *
	$w‹kî_maö
(*
pArg
){

1133 
LsmW‹kî
 *
p
 = (LsmW‹kî *)
pArg
;

1134 
lsm_db
 *
pW‹kî
;

1136 
	`±hªad_muãx_lock
(&
p
->
w‹kî_muãx
);

1137  (
pW‹kî
 = 
p
->pWorker) ){

1138 
rc
 = 
LSM_OK
;

1142 
	`±hªad_muãx_u∆ock
(&
p
->
w‹kî_muãx
);

1143 if–
p
->
eTy≥
==
LSMTEST_THREAD_CKPT
 ){

1144 
nKB
 = 0;

1145 
rc
 = 
	`lsm_öfo
(
pW‹kî
, 
LSM_INFO_CHECKPOINT_SIZE
, &
nKB
);

1146 if–
rc
==
LSM_OK
 && 
nKB
>=
p
->
pDb
->
nMtMöCk±
 ){

1147 
rc
 = 
	`lsm_checkpoöt
(
pW‹kî
, 0);

1150 
nWrôe
;

1153 if–
p
->
eTy≥
==
LSMTEST_THREAD_WORKER
 ){

1154 
	`waôOnCheckpoöãr
(
p
->
pDb
, 
pW‹kî
);

1157 
nWrôe
 = 0;

1158 
rc
 = 
	`lsm_w‹k
(
pW‹kî
, 0, 256, &
nWrôe
);

1160 if–
p
->
eTy≥
==
LSMTEST_THREAD_WORKER
 && 
nWrôe
 ){

1161 
	`mt_sig«l_w‹kî
(
p
->
pDb
, 1);

1163 } 
nWrôe
 && 
p
->
pW‹kî
 );

1165 
	`±hªad_muãx_lock
(&
p
->
w‹kî_muãx
);

1167 if–
rc
!=
LSM_OK
 &&Ñc!=
LSM_BUSY
 ){

1168 
p
->
w‹kî_rc
 = 
rc
;

1175 if–
p
->
pW‹kî
 &&Ö->
bDoW‹k
==0 ){

1176 
	`±hªad_c⁄d_waô
(&
p
->
w‹kî_c⁄d
, &p->
w‹kî_muãx
);

1178 
p
->
bDoW‹k
 = 0;

1180 
	`±hªad_muãx_u∆ock
(&
p
->
w‹kî_muãx
);

1183 
	}
}

1186 
	$mt_°›_w‹kî
(
LsmDb
 *
pDb
, 
iW‹kî
){

1187 
LsmW‹kî
 *
p
 = &
pDb
->
aW‹kî
[
iW‹kî
];

1188 if–
p
->
pW‹kî
 ){

1189 *
pDummy
;

1190 
lsm_db
 *
pW‹kî
;

1193 
	`±hªad_muãx_lock
(&
p
->
w‹kî_muãx
);

1194 
pW‹kî
 = 
p
->pWorker;

1195 
p
->
pW‹kî
 = 0;

1196 
	`±hªad_c⁄d_sig«l
(&
p
->
w‹kî_c⁄d
);

1197 
	`±hªad_muãx_u∆ock
(&
p
->
w‹kî_muãx
);

1200 
	`±hªad_joö
(
p
->
w‹kî_thªad
, &
pDummy
);

1203 
	`±hªad_c⁄d_de°roy
(&
p
->
w‹kî_c⁄d
);

1204 
	`±hªad_muãx_de°roy
(&
p
->
w‹kî_muãx
);

1205 
	`lsm_˛o£
(
pW‹kî
);

1207 
	}
}

1209 
	$mt_shutdown
(
LsmDb
 *
pDb
){

1210 
i
;

1211 
i
=0; i<
pDb
->
nW‹kî
; i++){

1212 
	`mt_°›_w‹kî
(
pDb
, 
i
);

1214 
	}
}

1222 
	$mt_˛õ¡_w‹k_hook
(
lsm_db
 *
db
, *
pArg
){

1223 
LsmDb
 *
pDb
 = (LsmDb *)
pArg
;

1226 if–
pDb
->
xW‹k
 )ÖDb->
	`xW‹k
(
db
,ÖDb->
pW‹kCtx
);

1229 
	`mt_sig«l_w‹kî
(
pDb
, 0);

1230 
	}
}

1232 
	$mt_w‹kî_w‹k_hook
(
lsm_db
 *
db
, *
pArg
){

1233 
LsmDb
 *
pDb
 = (LsmDb *)
pArg
;

1236 if–
pDb
->
xW‹k
 )ÖDb->
	`xW‹k
(
db
,ÖDb->
pW‹kCtx
);

1237 
	}
}

1242 
	$mt_°¨t_w‹kî
(

1243 
LsmDb
 *
pDb
,

1244 
iW‹kî
,

1245 c⁄° *
zFûíame
,

1246 c⁄° *
zCfg
,

1247 
eTy≥


1249 
rc
 = 0;

1250 
LsmW‹kî
 *
p
;

1252 
	`as£π
–
iW‹kî
<
pDb
->
nW‹kî
 );

1253 
	`as£π
–
eTy≥
==
LSMTEST_THREAD_CKPT


1254 || 
eTy≥
==
LSMTEST_THREAD_WORKER


1255 || 
eTy≥
==
LSMTEST_THREAD_WORKER_AC


1258 
p
 = &
pDb
->
aW‹kî
[
iW‹kî
];

1259 
p
->
eTy≥
 =ÉType;

1260 
p
->
pDb
 =ÖDb;

1263 if–
rc
==0 )Ñ¯
	`lsm_√w
(&
pDb
->
ív
, &
p
->
pW‹kî
);

1264 if–
zCfg
 ){

1265 
	`ã°_lsm_c⁄fig_°r
(
pDb
, 
p
->
pW‹kî
, 1, 
zCfg
, 0);

1267 if–
rc
==0 )Ñ¯
	`lsm_›í
(
p
->
pW‹kî
, 
zFûíame
);

1268 
	`lsm_c⁄fig_log
(
p
->
pW‹kî
, 
xLog
, (*)"worker");

1271 if–
rc
==0 ){

1272 
	`lsm_c⁄fig_w‹k_hook
(
p
->
pW‹kî
, 
mt_w‹kî_w‹k_hook
, (*)
pDb
);

1275 if–
eTy≥
==
LSMTEST_THREAD_WORKER
 ){

1276 
	`ã°_lsm_c⁄fig_°r
(0, 
p
->
pW‹kî
, 1, "autocheckpoint=0", 0);

1280 if–
rc
==0 )Ñ¯
	`±hªad_c⁄d_öô
(&
p
->
w‹kî_c⁄d
, 0);

1281 if–
rc
==0 )Ñ¯
	`±hªad_muãx_öô
(&
p
->
w‹kî_muãx
, 0);

1282 if–
rc
==0 )Ñ¯
	`±hªad_¸óã
(&
p
->
w‹kî_thªad
, 0, 
w‹kî_maö
, (*)p);

1284  
rc
;

1285 
	}
}

1288 
	$ã°LsmSèπW‹kîs
(

1289 
LsmDb
 *
pDb
, 
eModñ
, c⁄° *
zFûíame
, c⁄° *
zCfg


1291 
rc
;

1293 if–
eModñ
<1 ||ÉModel>4 )  1;

1294 if–
eModñ
==1 )  0;

1298 
	`lsm_c⁄fig_w‹k_hook
(
pDb
->
db
, 
mt_˛õ¡_w‹k_hook
, (*)pDb);

1302 
pDb
->
aW‹kî
 = (
LsmW‹kî
 *)
	`ã°MÆloc
((LsmWorker) * 2);

1303 
	`mem£t
(
pDb
->
aW‹kî
, 0, (
LsmW‹kî
) * 2);

1305  
eModñ
 ){

1306 
LSMTEST_MODE_BACKGROUND_CKPT
:

1307 
pDb
->
nW‹kî
 = 1;

1308 
	`ã°_lsm_c⁄fig_°r
(0, 
pDb
->
db
, 0, "autocheckpoint=0", 0);

1309 
rc
 = 
	`mt_°¨t_w‹kî
(
pDb
, 0, 
zFûíame
, 
zCfg
, 
LSMTEST_THREAD_CKPT
);

1312 
LSMTEST_MODE_BACKGROUND_WORK
:

1313 
pDb
->
nW‹kî
 = 1;

1314 
	`ã°_lsm_c⁄fig_°r
(0, 
pDb
->
db
, 0, "autowork=0", 0);

1315 
rc
 = 
	`mt_°¨t_w‹kî
(
pDb
, 0, 
zFûíame
, 
zCfg
, 
LSMTEST_THREAD_WORKER_AC
);

1318 
LSMTEST_MODE_BACKGROUND_BOTH
:

1319 
pDb
->
nW‹kî
 = 2;

1320 
	`ã°_lsm_c⁄fig_°r
(0, 
pDb
->
db
, 0, "autowork=0", 0);

1321 
rc
 = 
	`mt_°¨t_w‹kî
(
pDb
, 0, 
zFûíame
, 
zCfg
, 
LSMTEST_THREAD_WORKER
);

1322 if–
rc
==0 ){

1323 
rc
 = 
	`mt_°¨t_w‹kî
(
pDb
, 1, 
zFûíame
, 
zCfg
, 
LSMTEST_THREAD_CKPT
);

1328  
rc
;

1329 
	}
}

1332 
	$ã°_lsm_mt2
(

1333 c⁄° *
zS≥c
,

1334 c⁄° *
zFûíame
,

1335 
bCÀ¨
,

1336 
Te°Db
 **
µDb


1338 c⁄° *
zCfg
 = "mt_mode=2";

1339  
	`ã°LsmO≥n
(
zCfg
, 
zFûíame
, 
bCÀ¨
, 
µDb
);

1340 
	}
}

1342 
	$ã°_lsm_mt3
(

1343 c⁄° *
zS≥c
,

1344 c⁄° *
zFûíame
,

1345 
bCÀ¨
,

1346 
Te°Db
 **
µDb


1348 c⁄° *
zCfg
 = "mt_mode=4";

1349  
	`ã°LsmO≥n
(
zCfg
, 
zFûíame
, 
bCÀ¨
, 
µDb
);

1350 
	}
}

1353 
	$mt_shutdown
(
LsmDb
 *
pDb
) {

1354 
	`unu£d_∑ømëî
(
pDb
);

1355 
	}
}

1356 
	$ã°_lsm_mt
(c⁄° *
zFûíame
, 
bCÀ¨
, 
Te°Db
 **
µDb
){

1357 
	`unu£d_∑ømëî
(
zFûíame
);

1358 
	`unu£d_∑ømëî
(
bCÀ¨
);

1359 
	`unu£d_∑ømëî
(
µDb
);

1360 
	`ã°PrötEº‹
("threads unavailable -Ñecompile with LSM_MUTEX_PTHREADS\n");

1362 
	}
}

	@lsm-test/lsmtest_tdb4.c

6 
	~"lsmã°_tdb.h
"

7 
	~"lsmã°.h
"

8 
	~<uni°d.h
>

9 
	~"bt.h
"

11 
	~<±hªad.h
>

13 
BtDb
 
	tBtDb
;

14 
BtFûe
 
	tBtFûe
;

17 
bt_ck±î
 
	tbt_ck±î
;

18 
bgc_©èch
(
BtDb
 *
pDb
, const *);

19 
bgc_dëach
(
BtDb
 *
pDb
);

25 
	sBtFûe
 {

26 
BtDb
 *
	mpBt
;

27 
bt_ív
 *
	mpVfs
;

28 
bt_fûe
 *
	mpFûe
;

29 
	mnSe˘‹Size
;

30 
	mnSe˘‹
;

31 
u8
 **
	m≠Se˘‹
;

50 
	sBtDb
 {

51 
Te°Db
 
	mba£
;

52 
bt_db
 *
	mpBt
;

53 
sqlôe4_ív
 *
	mpEnv
;

54 
bt_ív
 *
	mpVfs
;

55 
	mbFa°In£π
;

58 
u8
 *
	maBuf„r
;

59 
	mnBuf„r
;

60 
	mnRef
;

63 
bt_ck±î
 *
	mpCk±î
;

66 
BtFûe
 *
	m≠Fûe
[2];

67 
bt_ív
 
	mív
;

68 
	mnCøshSync
;

69 
	mbCøsh
;

72 
	$btVfsFuŒ∑th
(

73 
sqlôe4_ív
 *
pEnv
,

74 
bt_ív
 *
pVfs
,

75 c⁄° *
z
,

76 **
pzOut


78 
BtDb
 *
pBt
 = (BtDb*)
pVfs
->
pVfsCtx
;

79 if–
pBt
->
bCøsh
 )  
SQLITE4_IOERR
;

80  
pBt
->
pVfs
->
	`xFuŒ∑th
(
pEnv
,ÖBt->pVfs, 
z
, 
pzOut
);

81 
	}
}

83 
	$btVfsO≥n
(

84 
sqlôe4_ív
 *
pEnv
,

85 
bt_ív
 *
pVfs
,

86 c⁄° *
zFûe
,

87 
Êags
, 
bt_fûe
 **
µFûe


89 
BtFûe
 *
p
;

90 
BtDb
 *
pBt
 = (BtDb*)
pVfs
->
pVfsCtx
;

91 
rc
;

93 if–
pBt
->
bCøsh
 )  
SQLITE4_IOERR
;

95 
p
 = (
BtFûe
*)
	`ã°MÆloc
((BtFile));

96 if–!
p
 )  
SQLITE4_NOMEM
;

97 if–
Êags
 & 
BT_OPEN_DATABASE
 ){

98 
pBt
->
≠Fûe
[0] = 
p
;

99 }if–
Êags
 & 
BT_OPEN_LOG
 ){

100 
pBt
->
≠Fûe
[1] = 
p
;

102 if–(
Êags
 & 
BT_OPEN_SHARED
)==0 ){

103 
p
->
pBt
 =ÖBt;

105 
p
->
pVfs
 = 
pBt
->pVfs;

107 
rc
 = 
pBt
->
pVfs
->
	`xO≥n
(
pEnv
,ÖVfs, 
zFûe
, 
Êags
, &
p
->
pFûe
);

108 if–
rc
!=
SQLITE4_OK
 ){

109 
	`ã°Fªe
(
p
);

110 
p
 = 0;

112 
pBt
->
nRef
++;

115 *
µFûe
 = (
bt_fûe
*)
p
;

116  
rc
;

117 
	}
}

119 
	$btVfsSize
(
bt_fûe
 *
pFûe
, 
sqlôe4_öt64
 *
piRes
){

120 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

121 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

122  
p
->
pVfs
->
	`xSize
’->
pFûe
, 
piRes
);

123 
	}
}

125 
	$btVfsRód
(
bt_fûe
 *
pFûe
, 
sqlôe4_öt64
 
iOff
, *
pBuf
, 
nBuf
){

126 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

127 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

128  
p
->
pVfs
->
	`xRód
’->
pFûe
, 
iOff
, 
pBuf
, 
nBuf
);

129 
	}
}

131 
	$btFlushSe˘‹s
(
BtFûe
 *
p
, 
iFûe
){

132 
sqlôe4_öt64
 
iSz
;

133 
rc
;

134 
i
;

135 
u8
 *
aTmp
 = 0;

137 
rc
 = 
p
->
pBt
->
pVfs
->
	`xSize
’->
pFûe
, &
iSz
);

138 
i
=0; 
rc
==
SQLITE4_OK
 && i<
p
->
nSe˘‹
; i++){

139 if–
p
->
pBt
->
bCøsh
 &&Ö->
≠Se˘‹
[
i
] ){

148 
sqlôe4_öt64
 
iSOff
 = 
p
->
nSe˘‹Size
*
i
;

149 
nWrôe
 = 
	`MIN
(
p
->
nSe˘‹Size
, 
iSz
 - 
iSOff
);

151 if–
nWrôe
 ){

152 
u8
 *
aWrôe
 = 0;

153 
iO±
 = (
	`ã°P∫gVÆue
(
i
) % 3) + 1;

154 if–
iO±
==1 ){

155 
aWrôe
 = 
p
->
≠Se˘‹
[
i
];

156 }if–
iO±
==3 ){

157 if–
aTmp
==0 )áTm∞
	`ã°MÆloc
(
p
->
nSe˘‹Size
);

158 
aWrôe
 = 
aTmp
;

159 
	`ã°P∫gAºay
(
i
*13, (
u32
*)
aWrôe
, 
nWrôe
/(u32));

163 
	`Ârötf
(
°dîr
, "h™dÀ se˘‹ %d o‡%†wôh %s\n", 
i
,

164 
iFûe
==0 ? "db" : "log",

165 
iO±
==1 ? "rollback" : iOpt==2 ? "write" : "omit"

167 
	`fÊush
(
°dîr
);

170 if–
aWrôe
 ){

171 
rc
 = 
p
->
pBt
->
pVfs
->
	`xWrôe
’->
pFûe
, 
iSOff
, 
aWrôe
, 
nWrôe
);

175 
	`ã°Fªe
(
p
->
≠Se˘‹
[
i
]);

176 
p
->
≠Se˘‹
[
i
] = 0;

179 
	`ã°Fªe
(
aTmp
);

180  
rc
;

181 
	}
}

183 
	$btSaveSe˘‹s
(
BtFûe
 *
p
, 
sqlôe4_öt64
 
iOff
, 
nBuf
){

184 
rc
;

185 
sqlôe4_öt64
 
iSz
;

186 
iFú°
;

187 
iSe˘‹
;

188 
iLa°
;

190 if–
p
->
nSe˘‹Size
==0 ){

191 
p
->
nSe˘‹Size
 =Ö->
pBt
->
pVfs
->
	`xSe˘‹Size
’->
pFûe
);

192 if–
p
->
nSe˘‹Size
<512 )Ö->nSectorSize = 512;

194 
iLa°
 = (
iOff
+
nBuf
-1Ë/ 
p
->
nSe˘‹Size
;

195 
iFú°
 = 
iOff
 / 
p
->
nSe˘‹Size
;

197 
rc
 = 
p
->
pBt
->
pVfs
->
	`xSize
’->
pFûe
, &
iSz
);

198 
iSe˘‹
=
iFú°
; 
rc
==
SQLITE4_OK
 && iSe˘‹<=
iLa°
; iSector++){

199 
nRód
;

200 
sqlôe4_öt64
 
iSOff
 = 
iSe˘‹
 * 
p
->
nSe˘‹Size
;

201 
u8
 *
aBuf
 = 
	`ã°MÆloc
(
p
->
nSe˘‹Size
);

202 
nRód
 = 
	`MIN
(
p
->
nSe˘‹Size
, (
iSz
 - 
iSOff
));

203 if–
nRód
>0 ){

204 
rc
 = 
p
->
pBt
->
pVfs
->
	`xRód
’->
pFûe
, 
iSOff
, 
aBuf
, 
nRód
);

207  
rc
==
SQLITE4_OK
 && 
iSe˘‹
>=
p
->
nSe˘‹
 ){

208 
nNew
 = 
p
->
nSe˘‹
 + 32;

209 
u8
 **
≠New
 = (u8**)
	`ã°MÆloc
(
nNew
 * (u8*));

210 
	`mem˝y
(
≠New
, 
p
->
≠Se˘‹
,Ö->
nSe˘‹
*(
u8
*));

211 
	`ã°Fªe
(
p
->
≠Se˘‹
);

212 
p
->
≠Se˘‹
 = 
≠New
;

213 
p
->
nSe˘‹
 = 
nNew
;

216 
p
->
≠Se˘‹
[
iSe˘‹
] = 
aBuf
;

219  
rc
;

220 
	}
}

222 
	$btVfsWrôe
(
bt_fûe
 *
pFûe
, 
sqlôe4_öt64
 
iOff
, *
pBuf
, 
nBuf
){

223 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

224 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

225 if–
p
->
pBt
 &&Ö->pBt->
nCøshSync
 ){

226 
	`btSaveSe˘‹s
(
p
, 
iOff
, 
nBuf
);

228  
p
->
pVfs
->
	`xWrôe
’->
pFûe
, 
iOff
, 
pBuf
, 
nBuf
);

229 
	}
}

231 
	$btVfsTrunˇã
(
bt_fûe
 *
pFûe
, 
sqlôe4_öt64
 
iOff
){

232 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

233 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

234  
p
->
pVfs
->
	`xTrunˇã
’->
pFûe
, 
iOff
);

235 
	}
}

237 
	$btVfsSync
(
bt_fûe
 *
pFûe
){

238 
rc
 = 
SQLITE4_OK
;

239 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

240 
BtDb
 *
pBt
 = 
p
->pBt;

242 if–
pBt
 ){

243 if–
pBt
->
bCøsh
 )  
SQLITE4_IOERR
;

244 if–
pBt
->
nCøshSync
 ){

245 
pBt
->
nCøshSync
--;

246 
pBt
->
bCøsh
 = (pBt->
nCøshSync
==0);

247 if–
pBt
->
bCøsh
 ){

248 
	`btFlushSe˘‹s
(
pBt
->
≠Fûe
[0], 0);

249 
	`btFlushSe˘‹s
(
pBt
->
≠Fûe
[1], 1);

250 
rc
 = 
SQLITE4_IOERR
;

252 
	`btFlushSe˘‹s
(
p
, 0);

257 if–
rc
==
SQLITE4_OK
 ){

258 
rc
 = 
p
->
pVfs
->
	`xSync
’->
pFûe
);

260  
rc
;

261 
	}
}

263 
	$btVfsSe˘‹Size
(
bt_fûe
 *
pFûe
){

264 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

265  
p
->
pVfs
->
	`xSe˘‹Size
’->
pFûe
);

266 
	}
}

268 
	$btDîef
(
BtDb
 *
p
){

269 
p
->
nRef
--;

270 
	`as£π
–
p
->
nRef
>=0 );

271 if–
p
->
nRef
<=0 ) 
	`ã°Fªe
(p);

272 
	}
}

274 
	$btVfsClo£
(
bt_fûe
 *
pFûe
){

275 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

276 
BtDb
 *
pBt
 = 
p
->pBt;

277 
rc
;

278 if–
pBt
 ){

279 
	`btFlushSe˘‹s
(
p
, 0);

280 if–
p
==
pBt
->
≠Fûe
[0] )ÖBt->apFile[0] = 0;

281 if–
p
==
pBt
->
≠Fûe
[1] )ÖBt->apFile[1] = 0;

283 
	`ã°Fªe
(
p
->
≠Se˘‹
);

284 
rc
 = 
p
->
pVfs
->
	`xClo£
’->
pFûe
);

286 
	`btDîef
(
p
->
pBt
);

288 
	`ã°Fªe
(
p
);

289  
rc
;

290 
	}
}

292 
	$btVfsU∆ök
(
sqlôe4_ív
 *
pEnv
, 
bt_ív
 *
pVfs
, c⁄° *
zFûe
){

293 
BtDb
 *
pBt
 = (BtDb*)
pVfs
->
pVfsCtx
;

294 if–
pBt
->
bCøsh
 )  
SQLITE4_IOERR
;

295  
pBt
->
pVfs
->
	`xU∆ök
(
pEnv
,ÖBt->pVfs, 
zFûe
);

296 
	}
}

298 
	$btVfsLock
(
bt_fûe
 *
pFûe
, 
iLock
, 
eTy≥
){

299 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

300 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

301  
p
->
pVfs
->
	`xLock
’->
pFûe
, 
iLock
, 
eTy≥
);

302 
	}
}

304 
	$btVfsTe°Lock
(
bt_fûe
 *
pFûe
, 
iLock
, 
nLock
, 
eTy≥
){

305 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

306 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

307  
p
->
pVfs
->
	`xTe°Lock
’->
pFûe
, 
iLock
, 
nLock
, 
eTy≥
);

308 
	}
}

310 
	$btVfsShmM≠
(
bt_fûe
 *
pFûe
, 
iChunk
, 
sz
, **
µOut
){

311 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

312 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

313  
p
->
pVfs
->
	`xShmM≠
’->
pFûe
, 
iChunk
, 
sz
, 
µOut
);

314 
	}
}

316 
	$btVfsShmB¨rõr
(
bt_fûe
 *
pFûe
){

317 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

318  
p
->
pVfs
->
	`xShmB¨rõr
’->
pFûe
);

319 
	}
}

321 
	$btVfsShmUnm≠
(
bt_fûe
 *
pFûe
, 
bDñëe
){

322 
BtFûe
 *
p
 = (BtFûe*)
pFûe
;

323 if–
p
->
pBt
 &&Ö->pBt->
bCøsh
 )  
SQLITE4_IOERR
;

324  
p
->
pVfs
->
	`xShmUnm≠
’->
pFûe
, 
bDñëe
);

325 
	}
}

327 
	$bt_˛o£
(
Te°Db
 *
pTe°Db
){

328 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

329 
rc
 = 
	`sqlôe4BtClo£
(
p
->
pBt
);

330 
	`‰ì
(
p
->
aBuf„r
);

331 if–
p
->
≠Fûe
[0] )Ö->≠Fûe[0]->
pBt
 = 0;

332 if–
p
->
≠Fûe
[1] )Ö->≠Fûe[1]->
pBt
 = 0;

333 
	`bgc_dëach
(
p
);

334 
	`ã°Fªe
(
p
);

335  
rc
;

336 
	}
}

338 
	$btMöTønß˘i⁄
(
BtDb
 *
p
, 
iMö
, *
piLevñ
){

339 
iLevñ
;

340 
rc
 = 
SQLITE4_OK
;

342 
iLevñ
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pBt
);

343 if–
iLevñ
<
iMö
 ){

344 
rc
 = 
	`sqlôe4BtBegö
(
p
->
pBt
, 
iMö
);

345 *
piLevñ
 = 
iLevñ
;

347 *
piLevñ
 = -1;

350  
rc
;

351 
	}
}

352 
	$btRe°‹eTønß˘i⁄
(
BtDb
 *
p
, 
iLevñ
, 
rcö
){

353 
rc
 = 
rcö
;

354 if–
iLevñ
>=0 ){

355 if–
rc
==
SQLITE4_OK
 ){

356 
rc
 = 
	`sqlôe4BtCommô
(
p
->
pBt
, 
iLevñ
);

358 
	`sqlôe4BtRﬁlback
(
p
->
pBt
, 
iLevñ
);

360 
	`as£π
–
iLevñ
==
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pBt
) );

362  
rc
;

363 
	}
}

365 
	$bt_wrôe
(
Te°Db
 *
pTe°Db
, *
pK
, 
nK
, *
pV
, 
nV
){

366 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

367 
iLevñ
;

368 
rc
;

370 
rc
 = 
	`btMöTønß˘i⁄
(
p
, 2, &
iLevñ
);

371 if–
rc
==
SQLITE4_OK
 ){

372 if–
p
->
bFa°In£π
 ) 
	`sqlôe4BtC⁄åﬁ
’->
pBt
, 
BT_CONTROL_FAST_INSERT_OP
, 0);

373 
rc
 = 
	`sqlôe4BtRïœ˚
(
p
->
pBt
, 
pK
, 
nK
, 
pV
, 
nV
);

374 
rc
 = 
	`btRe°‹eTønß˘i⁄
(
p
, 
iLevñ
,Ñc);

376  
rc
;

377 
	}
}

379 
	$bt_dñëe
(
Te°Db
 *
pTe°Db
, *
pK
, 
nK
){

380  
	`bt_wrôe
(
pTe°Db
, 
pK
, 
nK
, 0, -1);

381 
	}
}

383 
	$bt_dñëe_ønge
(

384 
Te°Db
 *
pTe°Db
,

385 *
pKey1
, 
nKey1
,

386 *
pKey2
, 
nKey2


388 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

389 
bt_curs‹
 *
pC§
 = 0;

390 
rc
 = 
SQLITE4_OK
;

391 
iLevñ
;

393 
rc
 = 
	`btMöTønß˘i⁄
(
p
, 2, &
iLevñ
);

394 if–
rc
==
SQLITE4_OK
 ){

395 if–
p
->
bFa°In£π
 ) 
	`sqlôe4BtC⁄åﬁ
’->
pBt
, 
BT_CONTROL_FAST_INSERT_OP
, 0);

396 
rc
 = 
	`sqlôe4BtC§O≥n
(
p
->
pBt
, 0, &
pC§
);

398  
rc
==
SQLITE4_OK
 ){

399 c⁄° *
pK
;

400 
n
;

401 
nCmp
;

402 
ªs
;

404 
rc
 = 
	`sqlôe4BtC§Sìk
(
pC§
, 
pKey1
, 
nKey1
, 
BT_SEEK_GE
);

405 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

406 if–
rc
!=
SQLITE4_OK
 ) ;

408 
rc
 = 
	`sqlôe4BtC§Key
(
pC§
, &
pK
, &
n
);

409 if–
rc
!=
SQLITE4_OK
 ) ;

411 
nCmp
 = 
	`MIN
(
n
, 
nKey1
);

412 
ªs
 = 
	`memcmp
(
pKey1
, 
pK
, 
nCmp
);

413 
	`as£π
–
ªs
<0 || (ªs==0 && 
nKey1
<=
n
) );

414 if–
ªs
==0 && 
nKey1
==
n
 ){

415 
rc
 = 
	`sqlôe4BtC§Next
(
pC§
);

416 if–
rc
!=
SQLITE4_OK
 ) ;

417 
rc
 = 
	`sqlôe4BtC§Key
(
pC§
, &
pK
, &
n
);

418 if–
rc
!=
SQLITE4_OK
 ) ;

421 
nCmp
 = 
	`MIN
(
n
, 
nKey2
);

422 
ªs
 = 
	`memcmp
(
pKey2
, 
pK
, 
nCmp
);

423 if–
ªs
<0 || (ªs==0 && 
nKey2
<=
n
) ) ;

425 
rc
 = 
	`sqlôe4BtDñëe
(
pC§
);

427 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

429 
	`sqlôe4BtC§Clo£
(
pC§
);

431 
rc
 = 
	`btRe°‹eTønß˘i⁄
(
p
, 
iLevñ
,Ñc);

432  
rc
;

433 
	}
}

435 
	$bt_„tch
(

436 
Te°Db
 *
pTe°Db
,

437 *
pK
, 
nK
,

438 **
µVÆ
, *
≤VÆ


440 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

441 
bt_curs‹
 *
pC§
 = 0;

442 
iLevñ
;

443 
rc
 = 
SQLITE4_OK
;

445 
iLevñ
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pBt
);

446 if–
iLevñ
==0 ){

447 
rc
 = 
	`sqlôe4BtBegö
(
p
->
pBt
, 1);

448 if–
rc
!=
SQLITE4_OK
 ) Ñc;

451 if–
p
->
bFa°In£π
 ) 
	`sqlôe4BtC⁄åﬁ
’->
pBt
, 
BT_CONTROL_FAST_INSERT_OP
, 0);

452 
rc
 = 
	`sqlôe4BtC§O≥n
(
p
->
pBt
, 0, &
pC§
);

453 if–
rc
==
SQLITE4_OK
 ){

454 
rc
 = 
	`sqlôe4BtC§Sìk
(
pC§
, 
pK
, 
nK
, 
BT_SEEK_EQ
);

455 if–
rc
==
SQLITE4_OK
 ){

456 c⁄° *
pV
 = 0;

457 
nV
 = 0;

458 
rc
 = 
	`sqlôe4BtC§D©a
(
pC§
, 0, -1, &
pV
, &
nV
);

459 if–
rc
==
SQLITE4_OK
 ){

460 if–
nV
>
p
->
nBuf„r
 ){

461 
	`‰ì
(
p
->
aBuf„r
);

462 
p
->
aBuf„r
 = (
u8
*)
	`mÆloc
(
nV
*2);

463 
p
->
nBuf„r
 = 
nV
*2;

465 
	`mem˝y
(
p
->
aBuf„r
, 
pV
, 
nV
);

466 *
≤VÆ
 = 
nV
;

467 *
µVÆ
 = (*)(
p
->
aBuf„r
);

470 }if–
rc
==
SQLITE4_INEXACT
 ||Ñc==
SQLITE4_NOTFOUND
 ){

471 *
µVÆ
 = 0;

472 *
≤VÆ
 = -1;

473 
rc
 = 
SQLITE4_OK
;

475 
	`sqlôe4BtC§Clo£
(
pC§
);

478 if–
iLevñ
==0 ) 
	`sqlôe4BtCommô
(
p
->
pBt
, 0);

479  
rc
;

480 
	}
}

482 
bt_sˇn
(

483 
Te°Db
 *
pTe°Db
,

484 *
pCtx
,

485 
bRevî£
,

486 *
pFú°
, 
nFú°
,

487 *
pLa°
, 
nLa°
,

488 (*
xCÆlback
)(*, *, , *, )

490 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

491 
bt_curs‹
 *
pC§
 = 0;

492 
rc
;

493 
iLevñ
;

495 
rc
 = 
	`btMöTønß˘i⁄
(
p
, 1, &
iLevñ
);

497 if–
rc
==
SQLITE4_OK
 ){

498 if–
p
->
bFa°In£π
 ) 
	`sqlôe4BtC⁄åﬁ
’->
pBt
, 
BT_CONTROL_FAST_INSERT_OP
, 0);

499 
rc
 = 
	`sqlôe4BtC§O≥n
(
p
->
pBt
, 0, &
pC§
);

501 if–
rc
==
SQLITE4_OK
 ){

502 if–
bRevî£
 ){

503 if–
pLa°
 ){

504 
rc
 = 
	`sqlôe4BtC§Sìk
(
pC§
, 
pLa°
, 
nLa°
, 
BT_SEEK_LE
);

506 
rc
 = 
	`sqlôe4BtC§La°
(
pC§
);

509 
rc
 = 
	`sqlôe4BtC§Sìk
(
pC§
, 
pFú°
, 
nFú°
, 
BT_SEEK_GE
);

511 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

513  
rc
==
SQLITE4_OK
 ){

514 c⁄° *
pK
 = 0; 
nK
 = 0;

515 c⁄° *
pV
 = 0; 
nV
 = 0;

517 
rc
 = 
	`sqlôe4BtC§Key
(
pC§
, &
pK
, &
nK
);

518 if–
rc
==
SQLITE4_OK
 ){

519 
rc
 = 
	`sqlôe4BtC§D©a
(
pC§
, 0, -1, &
pV
, &
nV
);

522 if–
rc
!=
SQLITE4_OK
 ) ;

523 if–
bRevî£
 ){

524 if–
pFú°
 ){

525 
ªs
;

526 
nCmp
 = 
	`MIN
(
nK
, 
nFú°
);

527 
ªs
 = 
	`memcmp
(
pFú°
, 
pK
, 
nCmp
);

528 if–
ªs
>0 || (ªs==0 && 
nK
<
nFú°
) ) ;

531 if–
pLa°
 ){

532 
ªs
;

533 
nCmp
 = 
	`MIN
(
nK
, 
nLa°
);

534 
ªs
 = 
	`memcmp
(
pLa°
, 
pK
, 
nCmp
);

535 if–
ªs
<0 || (ªs==0 && 
nK
>
nLa°
) ) ;

539 
	`xCÆlback
(
pCtx
, (*)
pK
, 
nK
, (*)
pV
, 
nV
);

540 if–
bRevî£
 ){

541 
rc
 = 
	`sqlôe4BtC§Pªv
(
pC§
);

543 
rc
 = 
	`sqlôe4BtC§Next
(
pC§
);

546 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

548 
	`sqlôe4BtC§Clo£
(
pC§
);

551 
rc
 = 
	`btRe°‹eTønß˘i⁄
(
p
, 
iLevñ
,Ñc);

552  
rc
;

553 
	}
}

555 
	$bt_begö
(
Te°Db
 *
pTe°Db
, 
iLvl
){

556 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

557 
rc
 = 
	`sqlôe4BtBegö
(
p
->
pBt
, 
iLvl
);

558  
rc
;

559 
	}
}

561 
	$bt_commô
(
Te°Db
 *
pTe°Db
, 
iLvl
){

562 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

563 
rc
 = 
	`sqlôe4BtCommô
(
p
->
pBt
, 
iLvl
);

564  
rc
;

565 
	}
}

567 
	$bt_rﬁlback
(
Te°Db
 *
pTe°Db
, 
iLvl
){

568 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

569 
rc
 = 
	`sqlôe4BtRﬁlback
(
p
->
pBt
, 
iLvl
);

570  
rc
;

571 
	}
}

573 
	$ã°P¨£O±i⁄
(

574 c⁄° **
pzIn
,

575 c⁄° **
pzO±
,

576 c⁄° **
pzArg
,

577 *
pS∑˚


579 c⁄° *
p
 = *
pzIn
;

580 c⁄° *
pSèπ
;

581 
n
;

583 *
pOut
 = 
pS∑˚
;

585  *
p
==' ' )Ö++;

586 
pSèπ
 = 
p
;

587  *
p
 && *p!='=' )Ö++;

588 if–*
p
==0 )  1;

590 
n
 = (
p
 - 
pSèπ
);

591 
	`mem˝y
(
pOut
, 
pSèπ
, 
n
);

592 *
pzO±
 = 
pOut
;

593 
pOut
 +
n
;

594 *
pOut
++ = '\0';

596 
p
++;

597 
pSèπ
 = 
p
;

598  *
p
 && *p!=' ' )Ö++;

599 
n
 = (
p
 - 
pSèπ
);

601 
	`mem˝y
(
pOut
, 
pSèπ
, 
n
);

602 *
pzArg
 = 
pOut
;

603 
pOut
 +
n
;

604 *
pOut
++ = '\0';

606 *
pzIn
 = 
p
;

608 
	}
}

610 
	$ã°P¨£I¡
(c⁄° *
z
, *
piVÆ
){

611 
i
 = 0;

612 c⁄° *
p
 = 
z
;

614  *
p
>='0' && *p<='9' ){

615 
i
 = i*10 + (*
p
 - '0');

616 
p
++;

618 if–*
p
=='K' || *p=='k' ){

619 
i
 = i * 1024;

620 
p
++;

621 }if–*
p
=='M' || *p=='m' ){

622 
i
 = i * 1024 * 1024;

623 
p
++;

626 if–*
p
 )  
SQLITE4_ERROR
;

627 *
piVÆ
 = 
i
;

628  
SQLITE4_OK
;

629 
	}
}

631 
	$ã°BtC⁄figuª
(
BtDb
 *
pDb
, c⁄° *
zCfg
, *
pbMt
){

632 
rc
 = 
SQLITE4_OK
;

634 if–
zCfg
 ){

635 
	sCfgP¨am
 {

636 c⁄° *
zP¨am
;

637 
eP¨am
;

638 } 
aP¨am
[] = {

639 { "ß„ty", 
BT_CONTROL_SAFETY
 },

640 { "autock±", 
BT_CONTROL_AUTOCKPT
 },

641 { "mu…ùroc", 
BT_CONTROL_MULTIPROC
 },

642 { "blksz", 
BT_CONTROL_BLKSZ
 },

643 { "∑gesz", 
BT_CONTROL_PAGESZ
 },

648 c⁄° *
z
 = 
zCfg
;

649 
n
 = 
	`°æí
(
z
);

650 *
aS∑˚
;

651 c⁄° *
zO±
;

652 c⁄° *
zArg
;

654 
aS∑˚
 = (*)
	`ã°MÆloc
(
n
+2);

655  
rc
==
SQLITE4_OK
 && 0==
	`ã°P¨£O±i⁄
(&
z
, &
zO±
, &
zArg
, 
aS∑˚
) ){

656 
i
;

657 
iVÆ
;

658 
rc
 = 
	`ã°ArgSñe˘
(
aP¨am
, "∑øm", 
zO±
, &
i
);

659 if–
rc
!=
SQLITE4_OK
 ) ;

661 
rc
 = 
	`ã°P¨£I¡
(
zArg
, &
iVÆ
);

662 if–
rc
!=
SQLITE4_OK
 ) ;

664  
aP¨am
[
i
].
eP¨am
 ){

666 *
pbMt
 = 
iVÆ
;

669 
pDb
->
bFa°In£π
 = 1;

672 
rc
 = 
	`sqlôe4BtC⁄åﬁ
(
pDb
->
pBt
, 
aP¨am
[
i
].
eP¨am
, (*)&
iVÆ
);

676 
	`ã°Fªe
(
aS∑˚
);

679  
rc
;

680 
	}
}

683 
	$ã°_bt_›í
(

684 c⁄° *
zS≥c
,

685 c⁄° *
zFûíame
,

686 
bCÀ¨
,

687 
Te°Db
 **
µDb


690 c⁄° 
D©aba£Mëhods
 
SqlMëhods
 = {

691 
bt_˛o£
,

692 
bt_wrôe
,

693 
bt_dñëe
,

694 
bt_dñëe_ønge
,

695 
bt_„tch
,

696 
bt_sˇn
,

697 
bt_begö
,

698 
bt_commô
,

699 
bt_rﬁlback


701 
BtDb
 *
p
 = 0;

702 
bt_db
 *
pBt
 = 0;

703 
rc
;

704 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_ív_deÁu…
();

706 if–
bCÀ¨
 && 
zFûíame
 && zFilename[0] ){

707 *
zLog
 = 
	`sqlôe3_m¥ötf
("%s-wÆ", 
zFûíame
);

708 
	`u∆ök
(
zFûíame
);

709 
	`u∆ök
(
zLog
);

710 
	`sqlôe3_‰ì
(
zLog
);

713 
rc
 = 
	`sqlôe4BtNew
(
pEnv
, 0, &
pBt
);

714 if–
rc
==
SQLITE4_OK
 ){

715 
mt
 = 0;

717 
p
 = (
BtDb
*)
	`ã°MÆloc
((BtDb));

718 
p
->
ba£
.
pMëhods
 = &
SqlMëhods
;

719 
p
->
pBt
 =ÖBt;

720 
p
->
pEnv
 =ÖEnv;

721 
p
->
nRef
 = 1;

723 
p
->
ív
.
pVfsCtx
 = (*)p;

724 
p
->
ív
.
xFuŒ∑th
 = 
btVfsFuŒ∑th
;

725 
p
->
ív
.
xO≥n
 = 
btVfsO≥n
;

726 
p
->
ív
.
xSize
 = 
btVfsSize
;

727 
p
->
ív
.
xRód
 = 
btVfsRód
;

728 
p
->
ív
.
xWrôe
 = 
btVfsWrôe
;

729 
p
->
ív
.
xTrunˇã
 = 
btVfsTrunˇã
;

730 
p
->
ív
.
xSync
 = 
btVfsSync
;

731 
p
->
ív
.
xSe˘‹Size
 = 
btVfsSe˘‹Size
;

732 
p
->
ív
.
xClo£
 = 
btVfsClo£
;

733 
p
->
ív
.
xU∆ök
 = 
btVfsU∆ök
;

734 
p
->
ív
.
xLock
 = 
btVfsLock
;

735 
p
->
ív
.
xTe°Lock
 = 
btVfsTe°Lock
;

736 
p
->
ív
.
xShmM≠
 = 
btVfsShmM≠
;

737 
p
->
ív
.
xShmB¨rõr
 = 
btVfsShmB¨rõr
;

738 
p
->
ív
.
xShmUnm≠
 = 
btVfsShmUnm≠
;

740 
	`sqlôe4BtC⁄åﬁ
(
pBt
, 
BT_CONTROL_GETVFS
, (*)&
p
->
pVfs
);

741 
	`sqlôe4BtC⁄åﬁ
(
pBt
, 
BT_CONTROL_SETVFS
, (*)&
p
->
ív
);

743 
rc
 = 
	`ã°BtC⁄figuª
(
p
, 
zS≥c
, &
mt
);

744 if–
rc
==
SQLITE4_OK
 ){

745 
rc
 = 
	`sqlôe4BtO≥n
(
pBt
, 
zFûíame
);

748 if–
rc
==
SQLITE4_OK
 && 
mt
 ){

749 
nAuto
 = 0;

750 
rc
 = 
	`bgc_©èch
(
p
, 
zS≥c
);

751 
	`sqlôe4BtC⁄åﬁ
(
pBt
, 
BT_CONTROL_AUTOCKPT
, (*)&
nAuto
);

755 if–
rc
!=
SQLITE4_OK
 && 
p
 ){

756 
	`bt_˛o£
(&
p
->
ba£
);

759 *
µDb
 = &
p
->
ba£
;

760  
rc
;

761 
	}
}

763 
	$ã°_fbt_›í
(

764 c⁄° *
zS≥c
,

765 c⁄° *
zFûíame
,

766 
bCÀ¨
,

767 
Te°Db
 **
µDb


769  
	`ã°_bt_›í
("Á°=1", 
zFûíame
, 
bCÀ¨
, 
µDb
);

770 
	}
}

772 
	$ã°_fbts_›í
(

773 c⁄° *
zS≥c
,

774 c⁄° *
zFûíame
,

775 
bCÀ¨
,

776 
Te°Db
 **
µDb


778  
	`ã°_bt_›í
("Á°=1 blksz=32KÖagesz=512", 
zFûíame
, 
bCÀ¨
, 
µDb
);

779 
	}
}

782 
	$tdb_bt_¥ï¨e_sync_¸ash
(
Te°Db
 *
pTe°Db
, 
iSync
){

783 
BtDb
 *
p
 = (BtDb*)
pTe°Db
;

784 
	`as£π
–
pTe°Db
->
pMëhods
->
xClo£
==
bt_˛o£
 );

785 
	`as£π
–
p
->
bCøsh
==0 );

786 
p
->
nCøshSync
 = 
iSync
;

787 
	}
}

789 
bt_db
 *
	$tdb_bt
(
Te°Db
 *
pDb
){

790 if–
pDb
->
pMëhods
->
xClo£
==
bt_˛o£
 ){

791  ((
BtDb
 *)
pDb
)->
pBt
;

794 
	}
}

800 
	sbt_ck±î
 {

801 
sqlôe4_buf„r
 
	mfûe
;

802 
sqlôe4_buf„r
 
	m•ec
;

803 
	mnLogsize
;

804 
	mnRef
;

806 
	mbDoW‹k
;

807 
±hªad_t
 
	mck±î_thªad
;

808 
±hªad_c⁄d_t
 
	mck±î_c⁄d
;

809 
±hªad_muãx_t
 
	mck±î_muãx
;

811 
bt_ck±î
 *
	mpNext
;

814 
	sGlobÆBackgroundCheckpoöãr
 {

815 
bt_ck±î
 *
	mpCk±î
;

816 } 
	ggBgc
;

818 *
	$bgc_maö
(*
pArg
){

819 
BtDb
 *
pDb
 = 0;

820 
rc
;

821 
mt
;

822 
bt_ck±î
 *
pCk±î
 = (bt_ck±î*)
pArg
;

824 
rc
 = 
	`ã°_bt_›í
("", (*)
pCk±î
->
fûe
.
p
, 0, (
Te°Db
**)&
pDb
);

825 
	`as£π
–
rc
==
SQLITE4_OK
 );

826 
rc
 = 
	`ã°BtC⁄figuª
(
pDb
, (*)
pCk±î
->
•ec
.
p
, &
mt
);

828  
pCk±î
->
nRef
>0 ){

829 
bt_db
 *
db
 = 
pDb
->
pBt
;

830 
nLog
 = 0;

832 
	`sqlôe4BtBegö
(
db
, 1);

833 
	`sqlôe4BtCommô
(
db
, 0);

834 
	`sqlôe4BtC⁄åﬁ
(
db
, 
BT_CONTROL_LOGSIZE
, (*)&
nLog
);

836 if–
nLog
>=
pCk±î
->
nLogsize
 ){

837 
rc
;

838 
bt_checkpoöt
 
ck±
;

839 
	`mem£t
(&
ck±
, 0, (
bt_checkpoöt
));

840 
ck±
.
nFømeBuf„r
 = 
nLog
/2;

841 
rc
 = 
	`sqlôe4BtC⁄åﬁ
(
db
, 
BT_CONTROL_CHECKPOINT
, (*)&
ck±
);

842 
	`as£π
–
rc
==
SQLITE4_OK
 );

843 
	`sqlôe4BtC⁄åﬁ
(
db
, 
BT_CONTROL_LOGSIZE
, (*)&
nLog
);

849 
	`±hªad_muãx_lock
(&
pCk±î
->
ck±î_muãx
);

850 if–
pCk±î
->
bDoW‹k
==0 ){

851 
	`±hªad_c⁄d_waô
(&
pCk±î
->
ck±î_c⁄d
, &pCk±î->
ck±î_muãx
);

853 
pCk±î
->
bDoW‹k
 = 0;

854 
	`±hªad_muãx_u∆ock
(&
pCk±î
->
ck±î_muãx
);

857 if–
pDb
 ) 
	`bt_˛o£
((
Te°Db
*)pDb);

859 
	}
}

861 
	$bgc_logsize_cb
(*
pCtx
, 
nLogsize
){

862 
bt_ck±î
 *
p
 = (bt_ck±î*)
pCtx
;

863 if–
nLogsize
>=
p
->nLogsize ){

864 
	`±hªad_muãx_lock
(&
p
->
ck±î_muãx
);

865 
p
->
bDoW‹k
 = 1;

866 
	`±hªad_c⁄d_sig«l
(&
p
->
ck±î_c⁄d
);

867 
	`±hªad_muãx_u∆ock
(&
p
->
ck±î_muãx
);

869 
	}
}

871 
	$bgc_©èch
(
BtDb
 *
pDb
, c⁄° *
zS≥c
){

872 
rc
;

873 
n
;

874 
bt_öfo
 
öfo
;

875 
bt_ck±î
 *
pCk±î
;

878 
öfo
.
eTy≥
 = 
BT_INFO_FILENAME
;

879 
öfo
.
pgno
 = 0;

880 
	`sqlôe4_buf„r_öô
(&
öfo
.
ouçut
, 0);

881 
rc
 = 
	`sqlôe4BtC⁄åﬁ
(
pDb
->
pBt
, 
BT_CONTROL_INFO
, (*)&
öfo
);

882 if–
rc
!=
SQLITE4_OK
 ) Ñc;

884 
	`sqlôe4_muãx_íãr
(
	`sqlôe4_muãx_Æloc
(
pDb
->
pEnv
, 
SQLITE4_MUTEX_STATIC_KV
));

887 
n
 = 
öfo
.
ouçut
.n;

888 
pCk±î
=
gBgc
.pCk±î;ÖCk±î;ÖCk±îıCk±î->
pNext
){

889 if–
n
==
pCk±î
->
fûe
.¿&& 0==
	`memcmp
(
öfo
.
ouçut
.
p
,ÖCkpter->file.p,Ç) ){

895 if–
pCk±î
==0 ){

896 
bt_logsizecb
 
cb
;

898 
pCk±î
 = 
	`ã°MÆloc
((
bt_ck±î
));

899 
	`mem˝y
(&
pCk±î
->
fûe
, &
öfo
.
ouçut
, (
sqlôe4_buf„r
));

900 
öfo
.
ouçut
.
p
 = 0;

901 
pCk±î
->
pNext
 = 
gBgc
.pCkpter;

902 
pCk±î
->
nLogsize
 = 1000;

903 
gBgc
.
pCk±î
 =ÖCkpter;

904 
pCk±î
->
nRef
 = 1;

906 
	`sqlôe4_buf„r_öô
(&
pCk±î
->
•ec
, 0);

907 
rc
 = 
	`sqlôe4_buf„r_£t
(&
pCk±î
->
•ec
, 
zS≥c
, 
	`°æí
(zSpec)+1);

908 
	`as£π
–
rc
==
SQLITE4_OK
 );

911 if–
rc
==0 )Ñ¯
	`±hªad_c⁄d_öô
(&
pCk±î
->
ck±î_c⁄d
, 0);

912 if–
rc
==0 )Ñ¯
	`±hªad_muãx_öô
(&
pCk±î
->
ck±î_muãx
, 0);

913 if–
rc
==0 ){

914 
rc
 = 
	`±hªad_¸óã
(&
pCk±î
->
ck±î_thªad
, 0, 
bgc_maö
, (*)pCkpter);

916 
	`as£π
–
rc
==0 );

919 
cb
.
pCtx
 = (*)
pCk±î
;

920 
cb
.
xLogsize
 = 
bgc_logsize_cb
;

921 
	`sqlôe4BtC⁄åﬁ
(
pDb
->
pBt
, 
BT_CONTROL_LOGSIZECB
, (*)&
cb
);

923 
pCk±î
->
nRef
++;

928 if–
pCk±î
 ){

929 
pDb
->
pCk±î
 =ÖCkpter;

932 
	`sqlôe4_muãx_Àave
(
	`sqlôe4_muãx_Æloc
(
pDb
->
pEnv
, 
SQLITE4_MUTEX_STATIC_KV
));

933 
	`sqlôe4_buf„r_˛ór
(&
öfo
.
ouçut
);

934  
rc
;

935 
	}
}

937 
	$bgc_dëach
(
BtDb
 *
pDb
){

938 
rc
 = 
SQLITE4_OK
;

939 
bt_ck±î
 *
pCk±î
 = 
pDb
->pCkpter;

940 if–
pCk±î
 ){

941 
bShutdown
 = 0;

943 
	`sqlôe4_muãx_íãr
(
	`sqlôe4_muãx_Æloc
(
pDb
->
pEnv
,
SQLITE4_MUTEX_STATIC_KV
));

944 
pCk±î
->
nRef
--;

945 if–
pCk±î
->
nRef
==0 ){

946 
bt_ck±î
 **
µ
;

948 *
µ
 = 
pCk±î
->
pNext
;

949 
µ
=&
gBgc
.
pCk±î
; *µ!ıCk±î;Öp=&((*µ)->
pNext
));

950 
bShutdown
 = 1;

952 
	`sqlôe4_muãx_Àave
(
	`sqlôe4_muãx_Æloc
(
pDb
->
pEnv
,
SQLITE4_MUTEX_STATIC_KV
));

954 if–
bShutdown
 ){

955 *
pDummy
;

958 
	`±hªad_muãx_lock
(&
pCk±î
->
ck±î_muãx
);

959 
pCk±î
->
bDoW‹k
 = 1;

960 
	`±hªad_c⁄d_sig«l
(&
pCk±î
->
ck±î_c⁄d
);

961 
	`±hªad_muãx_u∆ock
(&
pCk±î
->
ck±î_muãx
);

964 
	`±hªad_joö
(
pCk±î
->
ck±î_thªad
, &
pDummy
);

965 
	`±hªad_c⁄d_de°roy
(&
pCk±î
->
ck±î_c⁄d
);

966 
	`±hªad_muãx_de°roy
(&
pCk±î
->
ck±î_muãx
);

968 
	`sqlôe4_buf„r_˛ór
(&
pCk±î
->
fûe
);

969 
	`sqlôe4_buf„r_˛ór
(&
pCk±î
->
•ec
);

970 
	`ã°Fªe
(
pCk±î
);

973 
pDb
->
pCk±î
 = 0;

975  
rc
;

976 
	}
}

	@lsm-test/lsmtest_util.c

2 
	~<°d¨g.h
>

3 
	~<°dio.h
>

4 
	~<°rög.h
>

5 
	~<sys/time.h
>

10 
	sTe°utûGlobÆ
 {

11 **
	m¨gv
;

12 
	m¨gc
;

13 } 
	gg
 = {0, 0};

15 
	sTe°utûRnd
 {

16 
	maR™d1
[2048];

17 
	maR™d2
[2048];

18 
	maR™d3
[1024];

19 } 
	gr
;

30 
	ssqlôe3P∫gTy≥
 {

31 
	mi
, 
	mj
;

32 
	ms
[256];

33 } 
	gsqlôe3P∫g
 = {

72 
	$øndomByã
(){

73 
t
;

74 
sqlôe3P∫g
.
i
++;

75 
t
 = 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
i
];

76 
sqlôe3P∫g
.
j
 +
t
;

77 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
i
] = sqlôe3P∫g.s[sqlôe3P∫g.
j
];

78 
sqlôe3P∫g
.
s
[sqlôe3P∫g.
j
] = 
t
;

79 
t
 +
sqlôe3P∫g
.
s
[sqlôe3P∫g.
i
];

80  
sqlôe3P∫g
.
s
[
t
];

81 
	}
}

86 
	$øndomBlob
(
nBuf
, *
zBuf
){

87 
i
;

88 
i
=0; i<
nBuf
; i++){

89 
zBuf
[
i
] = 
	`øndomByã
();

91 
	}
}

97 
	$ã°P∫gInô
(){

98 
	`øndomBlob
((
r
.
aR™d1
), (*)r.aRand1);

99 
	`øndomBlob
((
r
.
aR™d2
), (*)r.aRand2);

100 
	`øndomBlob
((
r
.
aR™d3
), (*)r.aRand3);

102 
	}
}

104 
	$ã°P∫gVÆue
(
iVÆ
){

106 
r
.
aR™d1
[
iVÆ
 & 0x000007FF] ^

107 
r
.
aR™d2
[(
iVÆ
>>11) & 0x000007FF] ^

108 
r
.
aR™d3
[(
iVÆ
>>22) & 0x000003FF]

110 
	}
}

112 
	$ã°P∫gAºay
(
iVÆ
, *
aOut
, 
nOut
){

113 
i
;

114 
i
=0; i<
nOut
; i++){

115 
aOut
[
i
] = 
	`ã°P∫gVÆue
(
iVÆ
+i);

117 
	}
}

119 
	$ã°P∫gSåög
(
iVÆ
, *
aOut
, 
nOut
){

120 
i
;

121 
i
=0; i<(
nOut
-1); i++){

122 
aOut
[
i
] = 'a' + (
	`ã°P∫gVÆue
(
iVÆ
+i) % 26);

124 
aOut
[
i
] = '\0';

125 
	}
}

127 
	$ã°Eº‹Inô
(
¨gc
, **
¨gv
){

128 
g
.
¨gc
 =árgc;

129 
g
.
¨gv
 =árgv;

130 
	}
}

132 
	$ã°PrötEº‹
(c⁄° *
zF‹m©
, ...){

133 
va_li°
 
≠
;

134 
	`va_°¨t
(
≠
, 
zF‹m©
);

135 
	`vÂrötf
(
°dîr
, 
zF‹m©
, 
≠
);

136 
	`va_íd
(
≠
);

137 
	}
}

139 
	$ã°PrötFUßge
(c⁄° *
zF‹m©
, ...){

140 
va_li°
 
≠
;

141 
	`va_°¨t
(
≠
, 
zF‹m©
);

142 
	`Ârötf
(
°dîr
, "Ußge: %†%†", 
g
.
¨gv
[0], g.argv[1]);

143 
	`vÂrötf
(
°dîr
, 
zF‹m©
, 
≠
);

144 
	`Ârötf
(
°dîr
, "\n");

145 
	`va_íd
(
≠
);

146 
	}
}

148 
	$ã°PrötUßge
(c⁄° *
zArgs
){

149 
	`ã°PrötEº‹
("Ußge: %†%†%s\n", 
g
.
¨gv
[0], g.¨gv[1], 
zArgs
);

150 
	}
}

153 
	$¨gEº‹
(*
aD©a
, c⁄° *
zTy≥
, 
sz
, c⁄° *
zArg
){

154 
	sE¡ry
 { c⁄° *
zName
; };

155 
E¡ry
 *
pE¡ry
;

156 c⁄° *
zPªv
 = 0;

158 
	`ã°PrötEº‹
("uƒecognized %†\"%s\": mu° bê", 
zTy≥
, 
zArg
);

159 
pE¡ry
=(
E¡ry
 *)
aD©a
;

160 
pE¡ry
->
zName
;

161 
pE¡ry
=(
E¡ry
 *)&((*ÌE¡ry)[
sz
]

163 if–
zPªv
 ){ 
	`ã°PrötEº‹
("%s, ", zPrev); }

164 
zPªv
 = 
pE¡ry
->
zName
;

166 
	`ã°PrötEº‹
("‹ %s\n", 
zPªv
);

167 
	}
}

169 
	$ã°ArgSñe˘X
(

170 *
aD©a
,

171 c⁄° *
zTy≥
,

172 
sz
,

173 c⁄° *
zArg
,

174 *
piOut


176 
	sE¡ry
 { c⁄° *
zName
; };

177 
E¡ry
 *
pE¡ry
;

178 
nArg
 = 
	`°æí
(
zArg
);

180 
i
 = 0;

181 
iOut
 = -1;

182 
nOut
 = 0;

184 
pE¡ry
=(
E¡ry
 *)
aD©a
;

185 
pE¡ry
->
zName
;

186 
pE¡ry
=(
E¡ry
 *)&((*ÌE¡ry)[
sz
]

188 
nName
 = 
	`°æí
(
pE¡ry
->
zName
);

189 if–
nArg
<=
nName
 && 
	`memcmp
(
pE¡ry
->
zName
, 
zArg
,ÇArg)==0 ){

190 
iOut
 = 
i
;

191 if–
nName
==
nArg
 ){

192 
nOut
 = 1;

195 
nOut
++;

197 
i
++;

200 if–
nOut
!=1 ){

201 
	`¨gEº‹
(
aD©a
, 
zTy≥
, 
sz
, 
zArg
);

203 *
piOut
 = 
iOut
;

205  (
nOut
!=1);

206 
	}
}

208 
timevÆ
 
	gzîo_time
;

210 
	$ã°TimeInô
(){

211 
	`gëtimeofday
(&
zîo_time
, 0);

212 
	}
}

214 
	$ã°TimeGë
(){

215 
timevÆ
 
now
;

216 
	`gëtimeofday
(&
now
, 0);

218 ((()
now
.
tv_£c
 - ()
zîo_time
.tv_sec)*1000) +

219 ((()
now
.
tv_u£c
 - ()
zîo_time
.tv_usec)/1000);

220 
	}
}

	@lsm-test/sqltest.c

17 
	~"sqlôe4.h
"

18 
	~"sqlôe3.h
"

19 
	~"lsm.h
"

21 
	~<°dio.h
>

22 
	~<°dlib.h
>

23 
	~<as£π.h
>

24 
	~<uni°d.h
>

26 
	#SQLITE3_DB_FILE
 "ã°.db3"

	)

27 
	#SQLITE4_DB_FILE
 "ã°.db4"

	)

29 
	~"lsmã°_utû.c
"

35 
	$u∆ök_db
(c⁄° *
zDb
){

36 
i
;

37 *
zBa£
 = (*)
zDb
;

38 c⁄° *
azExt
[] = { "", "-shm", "-wal", "-journal", "-log", 0 };

40 if–0==
	`sqlôe4_°∫icmp
("fûe:", 
zDb
, 5) ){

41 
i
=5; 
zDb
[i] && zDb[i]!='?'; i++);

42 
zBa£
 = 
	`sqlôe4_m¥ötf
(0, "%.*s", 
i
-5, &
zDb
[5]);

45 
i
=0; 
azExt
[i]; i++){

46 *
zFûe
 = 
	`sqlôe4_m¥ötf
(0, "%s%s", 
zBa£
, 
azExt
[
i
]);

47 
	`u∆ök
(
zFûe
);

48 
	`sqlôe4_‰ì
(0, 
zFûe
);

51 if–
zBa£
!=
zDb
 ){

52 
	`sqlôe4_‰ì
(0, 
zBa£
);

55 
	}
}

69 *
	$¸óã_schema_sql
(
nIdx
, 
bWôhoutRowid
){

70 *
zSchema
;

71 
i
;

73 
zSchema
 = 
	`sqlôe4_m¥ötf
(0, "CREATE TABLEÅ1(k PRIMARY KEY,");

74 
i
=0; i<
nIdx
; i++){

75 
zSchema
 = 
	`sqlôe4_m¥ötf
(0, "%z c%d BLOB,", zSchema, 
i
);

77 
zSchema
 = 
	`sqlôe4_m¥ötf
(0, "%z v BLOB)%s;", zSchema,

78 (
bWôhoutRowid
 ? " WITHOUT ROWID" : "")

81 
i
=0; i<
nIdx
; i++){

82 
zSchema
 = 
	`sqlôe4_m¥ötf
(

83 0, "%z\nCREATE INDEX i%d ONÅ1 (c%d);", 
zSchema
, 
i
, i

87  
zSchema
;

88 
	}
}

90 *
	$¸óã_ö£π_sql
(
nIdx
){

91 *
zIn£π
;

92 
i
;

94 
zIn£π
 = 
	`sqlôe4_m¥ötf
(0, "INSERT INTOÅ1 VALUES(rblob(:1, 8, 20),");

95 
i
=0; i<
nIdx
; i++){

96 
zIn£π
 = 
	`sqlôe4_m¥ötf
(0, "%zÑblob((:1<<%d)+:1, 8, 20),", zIn£π, 
i
);

98 
zIn£π
 = 
	`sqlôe4_m¥ötf
(0, "%zÑblob((:1<<%d)+:1, 100, 150));", zIn£π, 
i
);

100  
zIn£π
;

101 
	}
}

103 *
	$¸óã_£À˘_sql
(
iIdx
){

104 *
zSql
;

105 if–
iIdx
==0 ){

106 
zSql
 = 
	`sqlôe4_m¥ötf
(0, "SELECT * FROMÅ1 WHERE k =Ñblob(:1, 8, 20)");

108 
iCﬁ
 = 
iIdx
-1;

109 
zSql
 = 
	`sqlôe4_m¥ötf
(0,

110 "SELECT * FROMÅ1 WHERE c%d =Ñblob((:1<<%d)+:1, 8, 20)", 
iCﬁ
, iCol

113  
zSql
;

114 
	}
}

116 
	$do_ex∂ode
(c⁄° *
zLöe
, 
rc
, 
iLöe
){

117 if–
rc
 ){

118 
	`Ârötf
(
°dîr
, "ERROR: \"%s\"átÜine %d failed.Ñc=%d\n",

119 
zLöe
, 
iLöe
, 
rc


121 
	`exô
(-1);

124 
	}
}

125 
	#EXPLODE
(
rc
Ë
	`do_ex∂ode
(#rc,Ñc, 
__LINE__
)

	)

134 
	$rblobFunc4
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

135 
aBlob
[1000];

137 
iSìd
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[0]);

138 
nMö
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[1]);

139 
nMax
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[2]);

140 
nByã
;

142 
nByã
 = 
	`ã°P∫gVÆue
(
iSìd
 + 1000000) & 0x7FFFFFFF;

143 
nByã
 = (nByã % (
nMax
+1-
nMö
)) +ÇMin;

144 
	`as£π
–
nByã
>=
nMö
 &&ÇByã<=
nMax
 );

145 if–
nByã
>(
aBlob
) )ÇByte = (aBlob);

146 
	`ã°P∫gAºay
(
iSìd
, (*)
aBlob
, (
nByã
+3)/4);

148 
	`sqlôe4_ªsu…_blob
(
˘x
, 
aBlob
, 
nByã
, 
SQLITE4_TRANSIENT
, 0);

149 
	}
}

150 
	$ö°Æl_rblob_fun˘i⁄4
(
sqlôe4
 *
db
){

151 
	`ã°P∫gInô
();

152 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "rblob", 3, 0, 
rblobFunc4
, 0, 0, 0);

153 
	}
}

156 
	$rblobFunc3
(
sqlôe3_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe3_vÆue
 **
≠Arg
){

157 
aBlob
[1000];

159 
iSìd
 = 
	`sqlôe3_vÆue_öt
(
≠Arg
[0]);

160 
nMö
 = 
	`sqlôe3_vÆue_öt
(
≠Arg
[1]);

161 
nMax
 = 
	`sqlôe3_vÆue_öt
(
≠Arg
[2]);

162 
nByã
;

164 
nByã
 = 
	`ã°P∫gVÆue
(
iSìd
 + 1000000) & 0x7FFFFFFF;

165 
nByã
 = (nByã % (
nMax
+1-
nMö
)) +ÇMin;

166 
	`as£π
–
nByã
>=
nMö
 &&ÇByã<=
nMax
 );

167 if–
nByã
>(
aBlob
) )ÇByte = (aBlob);

168 
	`ã°P∫gAºay
(
iSìd
, (*)
aBlob
, (
nByã
+3)/4);

170 
	`sqlôe3_ªsu…_blob
(
˘x
, 
aBlob
, 
nByã
, 
SQLITE_TRANSIENT
);

171 
	}
}

172 
	$ö°Æl_rblob_fun˘i⁄3
(
sqlôe3
 *
db
){

173 
	`ã°P∫gInô
();

174 
	`sqlôe3_¸óã_fun˘i⁄
(
db
, "rblob", 3, 
SQLITE_UTF8
, 0, 
rblobFunc3
, 0, 0);

175 
	}
}

186 
	$rötFunc3
(
sqlôe3_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe3_vÆue
 **
≠Arg
){

187 
iVÆ
;

188 
iSìd
 = 
	`sqlôe3_vÆue_öt
(
≠Arg
[0]);

189 
nR™ge
 = 
	`sqlôe3_vÆue_öt
(
≠Arg
[1]);

191 
iVÆ
 = 
	`ã°P∫gVÆue
(
iSìd
) & 0x7FFFFFFF;

192 if–
nR™ge
>0 ){

193 
iVÆ
 = iVÆ % 
nR™ge
;

195 
	`sqlôe3_ªsu…_öt
(
˘x
, 
iVÆ
);

196 
	}
}

197 
	$ö°Æl_röt_fun˘i⁄3
(
sqlôe3
 *
db
){

198 
	`ã°P∫gInô
();

199 
	`sqlôe3_¸óã_fun˘i⁄
(
db
, "röt", 2, 
SQLITE_UTF8
, 0, 
rötFunc3
, 0, 0);

200 
	}
}

203 
	$rötFunc4
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

204 
iVÆ
;

205 
iSìd
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[0]);

206 
nR™ge
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[1]);

208 
iVÆ
 = 
	`ã°P∫gVÆue
(
iSìd
) & 0x7FFFFFFF;

209 if–
nR™ge
>0 ){

210 
iVÆ
 = iVÆ % 
nR™ge
;

212 
	`sqlôe4_ªsu…_öt
(
˘x
, 
iVÆ
);

213 
	}
}

214 
	$ö°Æl_röt_fun˘i⁄4
(
sqlôe4
 *
db
){

215 
	`ã°P∫gInô
();

216 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "röt", 2, 0, 
rötFunc4
, 0, 0, 0);

217 
	}
}

225 
	$öãgî_quîy4
(
sqlôe4
 *
db
, c⁄° *
zSql
){

226 
iRë
;

227 
sqlôe4_°mt
 *
pStmt
;

229 
	`EXPLODE
–
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0) );

230 
	`EXPLODE
–
SQLITE_ROW
!=
	`sqlôe4_°ï
(
pStmt
) );

231 
iRë
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

232 
	`EXPLODE
–
	`sqlôe4_föÆize
(
pStmt
) );

234  
iRë
;

235 
	}
}

236 
	$öãgî_quîy3
(
sqlôe3
 *
db
, c⁄° *
zSql
){

237 
iRë
;

238 
sqlôe3_°mt
 *
pStmt
;

240 
	`EXPLODE
–
	`sqlôe3_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0) );

241 
	`EXPLODE
–
SQLITE_ROW
!=
	`sqlôe3_°ï
(
pStmt
) );

242 
iRë
 = 
	`sqlôe3_cﬁumn_öt
(
pStmt
, 0);

243 
	`EXPLODE
–
	`sqlôe3_föÆize
(
pStmt
) );

245  
iRë
;

246 
	}
}

252 
	$bt_›í
(
sqlôe4_ív
 *
pEnv
, c⁄° *
zFûe
, 
sqlôe4
 **
pDb
){

253 *
zUri
 = 
	`sqlôe3_m¥ötf
("fûe:%s?kv=bt", 
zFûe
);

254 
rc
 = 
	`sqlôe4_›í
(
pEnv
, 
zUri
, 
pDb
);

255 
	`sqlôe3_‰ì
(
zUri
);

256  
rc
;

257 
	}
}

259 
	$do_ö£π1_ã°4
(

260 c⁄° *
zFûe
,

261 
nRow
,

262 
nRowPîTøns
,

263 
nIdx
,

264 
iSync


266 *
zCª©eTbl
;

267 *
zIn£π
;

268 
sqlôe4_°mt
 *
pIn£π
;

269 
sqlôe4
 *
db
 = 0;

270 
i
;

271 
nMs
;

273 
lsm_db
 *
pLsm
;

275 if–
zFûe
==0 ) zFûê
SQLITE4_DB_FILE
;

276 
	`u∆ök_db
(
zFûe
);

277 
	`EXPLODE
–
	`bt_›í
(0, 
zFûe
, &
db
) );

278 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, "maö", 
SQLITE4_KVCTRL_LSM_HANDLE
, &
pLsm
);

279 
i
 = 
iSync
;

280 
	`lsm_c⁄fig
(
pLsm
, 
LSM_CONFIG_SAFETY
, &
i
);

281 
	`as£π
–
i
==
iSync
 );

283 
	`ö°Æl_rblob_fun˘i⁄4
(
db
);

285 
zCª©eTbl
 = 
	`¸óã_schema_sql
(
nIdx
, 0);

286 
zIn£π
 = 
	`¸óã_ö£π_sql
(
nIdx
);

289 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, 
zCª©eTbl
, 0, 0) );

290 
	`EXPLODE
–
	`sqlôe4_¥ï¨e
(
db
, 
zIn£π
, -1, &
pIn£π
, 0) );

293 
	`ã°TimeInô
();

294 
i
=0; i<
nRow
; i++){

295 if–(
i
 % 
nRowPîTøns
)==0 ){

296 if–
i
!=0 ) 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, "COMMIT", 0, 0) );

297 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, "BEGIN", 0, 0) );

299 
	`sqlôe4_böd_öt
(
pIn£π
, 1, 
i
);

300 
	`sqlôe4_°ï
(
pIn£π
);

301 
	`EXPLODE
–
	`sqlôe4_ª£t
(
pIn£π
) );

303 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, "COMMIT", 0, 0) );

306 
	`sqlôe4_föÆize
(
pIn£π
);

307 
	`sqlôe4_‰ì
(0, 
zCª©eTbl
);

308 
	`sqlôe4_‰ì
(0, 
zIn£π
);

309 
	`sqlôe4_˛o£
(
db
, 0);

310 
nMs
 = 
	`ã°TimeGë
();

313 
	`¥ötf
("%.3‡£c⁄ds\n", ()
nMs
 / 1000.0);

315 
	}
}

316 
	$do_ö£π1_ã°3
(

317 c⁄° *
zFûe
,

318 
nRow
,

319 
nRowPîTøns
,

320 
nIdx
,

321 
iSync


323 *
zCª©eTbl
;

324 *
zIn£π
;

325 *
zSync
;

326 
sqlôe3_°mt
 *
pIn£π
;

327 
sqlôe3
 *
db
 = 0;

328 
i
;

329 
nMs
;

331 if–
zFûe
==0 ) zFûê
SQLITE3_DB_FILE
;

332 
	`u∆ök_db
(
zFûe
);

333 
	`EXPLODE
–
	`sqlôe3_›í
(
zFûe
, &
db
) );

334 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "PRAGMA journal_mode=WAL", 0, 0, 0) );

335 
zSync
 = 
	`sqlôe4_m¥ötf
(0, "PRAGMA synchr⁄ous=%d", 
iSync
);

336 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, 
zSync
, 0, 0, 0) );

337 
	`sqlôe4_‰ì
(0, 
zSync
);

339 
	`ö°Æl_rblob_fun˘i⁄3
(
db
);

341 
zCª©eTbl
 = 
	`¸óã_schema_sql
(
nIdx
, 1);

342 
zIn£π
 = 
	`¸óã_ö£π_sql
(
nIdx
);

345 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, 
zCª©eTbl
, 0, 0, 0) );

346 
	`EXPLODE
–
	`sqlôe3_¥ï¨e
(
db
, 
zIn£π
, -1, &
pIn£π
, 0) );

349 
	`ã°TimeInô
();

350 
i
=0; i<
nRow
; i++){

351 if–(
i
 % 
nRowPîTøns
)==0 ){

352 if–
i
!=0 ) 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "COMMIT", 0, 0, 0) );

353 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "BEGIN", 0, 0, 0) );

355 
	`sqlôe3_böd_öt
(
pIn£π
, 1, 
i
);

356 
	`sqlôe3_°ï
(
pIn£π
);

357 
	`EXPLODE
–
	`sqlôe3_ª£t
(
pIn£π
) );

359 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "COMMIT", 0, 0, 0) );

362 
	`sqlôe3_föÆize
(
pIn£π
);

363 
	`sqlôe3_˛o£
(
db
);

364 
nMs
 = 
	`ã°TimeGë
();

367 
	`sqlôe4_‰ì
(0, 
zCª©eTbl
);

368 
	`sqlôe4_‰ì
(0, 
zIn£π
);

371 
	`¥ötf
("%.3‡£c⁄ds\n", ()
nMs
 / 1000.0);

373 
	}
}

375 
	$do_ö£π1
(
¨gc
, **
¨gv
){

376 
	sIn£π1Arg
 {

377 c⁄° *
zArg
;

378 
nMö
;

379 
nMax
;

380 } 
aArg
[] = {

389 
i
;

391 
iDb
 = 4;

392 
nRow
 = 50000;

393 
nRowPîTøns
 = 10;

394 
nIdx
 = 3;

395 
iSync
 = 1;

396 c⁄° *
zFûe
 = 0;

398 
i
=0; i<
¨gc
; i++){

399 
iSñ
;

400 
iVÆ
;

401 
rc
;

403 
rc
 = 
	`ã°ArgSñe˘X
(
aArg
, "¨gumít", ◊Arg[0]), 
¨gv
[
i
], &
iSñ
);

404 if–
rc
!=0 )  -1;

405 if–
i
==
¨gc
-1 ){

406 
	`Ârötf
(
°dîr
, "›ti⁄ %†ªquúe†™árgumít\n", 
aArg
[
iSñ
].
zArg
);

409 if–0==
	`°rcmp
("-fûe", 
aArg
[
iSñ
].
zArg
) ){

410 
zFûe
 = 
¨gv
[++
i
];

412 
iVÆ
 = 
	`©oi
(
¨gv
[++
i
]);

413 if–
iVÆ
<
aArg
[
iSñ
].
nMö
 || iVÆ>aArg[iSñ].
nMax
 ){

414 
	`Ârötf
(
°dîr
, "option %s out ofÑange (%d..%d)\n",

415 
aArg
[
iSñ
].
zArg
,áArg[iSñ].
nMö
,áArg[iSñ].
nMax


420  
iSñ
 ){

421 0: 
iDb
 = 
iVÆ
; ;

422 1: 
nRow
 = 
iVÆ
; ;

423 2: 
nRowPîTøns
 = 
iVÆ
; ;

424 3: 
nIdx
 = 
iVÆ
; ;

425 4: 
iSync
 = 
iVÆ
; ;

430 
	`¥ötf
("insert1: db=%dÑows=%dÑowspertrans=%d indexes=%d sync=%d ... ",

431 
iDb
, 
nRow
, 
nRowPîTøns
, 
nIdx
, 
iSync


433 
	`fÊush
(
°dout
);

434 if–
iDb
==3 ){

435 
	`do_ö£π1_ã°3
(
zFûe
, 
nRow
, 
nRowPîTøns
, 
nIdx
, 
iSync
);

437 
	`do_ö£π1_ã°4
(
zFûe
, 
nRow
, 
nRowPîTøns
, 
nIdx
, 
iSync
);

441 
	}
}

443 
	$do_£À˘1_ã°4
(

444 c⁄° *
zFûe
,

445 
nRow
,

446 
nRowPîTøns
,

447 
iIdx


449 
nMs
 = 0;

450 
sqlôe4_°mt
 *
pSñe˘
 = 0;

451 *
zSñe˘
;

452 
sqlôe4
 *
db
;

453 
i
;

454 
nTblRow
;

456 if–
zFûe
==0 ) zFûê
SQLITE4_DB_FILE
;

457 
	`EXPLODE
–
	`bt_›í
(0, 
zFûe
, &
db
) );

458 
	`ö°Æl_rblob_fun˘i⁄4
(
db
);

460 
nTblRow
 = 
	`öãgî_quîy4
(
db
, "SELECT count(*) FROMÅ1");

463 
zSñe˘
 = 
	`¸óã_£À˘_sql
(
iIdx
);

464 
	`EXPLODE
–
	`sqlôe4_¥ï¨e
(
db
, 
zSñe˘
, -1, &
pSñe˘
, 0) );

466 
	`ã°TimeInô
();

467 
i
=0; i<
nRow
; i++){

468 if–(
i
 % 
nRowPîTøns
)==0 ){

469 if–
i
!=0 ) 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, "COMMIT", 0, 0) );

470 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, "BEGIN", 0, 0) );

472 
	`sqlôe4_böd_öt
(
pSñe˘
, 1, (
i
*211)%
nTblRow
);

473 
	`EXPLODE
–
SQLITE_ROW
!=
	`sqlôe4_°ï
(
pSñe˘
) );

474 
	`EXPLODE
–
	`sqlôe4_ª£t
(
pSñe˘
) );

476 
	`EXPLODE
–
	`sqlôe4_exec
(
db
, "COMMIT", 0, 0) );

477 
nMs
 = 
	`ã°TimeGë
();

479 
	`sqlôe4_föÆize
(
pSñe˘
);

480 
	`sqlôe4_˛o£
(
db
, 0);

481 
	`sqlôe4_‰ì
(0, 
zSñe˘
);

483 
	`¥ötf
("%.3‡£c⁄ds\n", ()
nMs
 / 1000.0);

485 
	}
}

486 
	$do_£À˘1_ã°3
(

487 c⁄° *
zFûe
,

488 
nRow
,

489 
nRowPîTøns
,

490 
iIdx


492 
nMs
 = 0;

493 
sqlôe3_°mt
 *
pSñe˘
 = 0;

494 *
zSñe˘
;

495 
sqlôe3
 *
db
;

496 
i
;

497 
nTblRow
;

499 if–
zFûe
==0 ) zFûê
SQLITE3_DB_FILE
;

500 
	`EXPLODE
–
	`sqlôe3_›í
(
zFûe
, &
db
) );

501 
	`ö°Æl_rblob_fun˘i⁄3
(
db
);

503 
nTblRow
 = 
	`öãgî_quîy3
(
db
, "SELECT count(*) FROMÅ1");

506 
zSñe˘
 = 
	`¸óã_£À˘_sql
(
iIdx
);

507 
	`EXPLODE
–
	`sqlôe3_¥ï¨e
(
db
, 
zSñe˘
, -1, &
pSñe˘
, 0) );

509 
	`ã°TimeInô
();

510 
i
=0; i<
nRow
; i++){

511 if–(
i
 % 
nRowPîTøns
)==0 ){

512 if–
i
!=0 ) 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "COMMIT", 0, 0, 0) );

513 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "BEGIN", 0, 0, 0) );

515 
	`sqlôe3_böd_öt
(
pSñe˘
, 1, (
i
*211)%
nTblRow
);

516 
	`EXPLODE
–
SQLITE_ROW
!=
	`sqlôe3_°ï
(
pSñe˘
) );

517 
	`EXPLODE
–
	`sqlôe3_ª£t
(
pSñe˘
) );

519 
	`EXPLODE
–
	`sqlôe3_exec
(
db
, "COMMIT", 0, 0, 0) );

520 
nMs
 = 
	`ã°TimeGë
();

522 
	`sqlôe3_föÆize
(
pSñe˘
);

523 
	`sqlôe3_˛o£
(
db
);

524 
	`sqlôe4_‰ì
(0, 
zSñe˘
);

526 
	`¥ötf
("%.3‡£c⁄ds\n", ()
nMs
 / 1000.0);

528 
	}
}

530 
	$do_£À˘1
(
¨gc
, **
¨gv
){

531 
	sIn£π1Arg
 {

532 c⁄° *
zArg
;

533 
nMö
;

534 
nMax
;

535 } 
aArg
[] = {

543 
i
;

545 
iDb
 = 4;

546 
nRow
 = 50000;

547 
nRowPîTøns
 = 10;

548 
iIdx
 = 0;

549 c⁄° *
zFûe
 = 0;

551 
i
=0; i<
¨gc
; i++){

552 
iSñ
;

553 
rc
;

555 
rc
 = 
	`ã°ArgSñe˘X
(
aArg
, "¨gumít", ◊Arg[0]), 
¨gv
[
i
], &
iSñ
);

556 if–
rc
!=0 )  -1;

557 if–
i
==
¨gc
-1 ){

558 
	`Ârötf
(
°dîr
, "›ti⁄ %†ªquúe†™árgumít\n", 
aArg
[
iSñ
].
zArg
);

561 if–0==
	`°rcmp
("-fûe", 
aArg
[
iSñ
].
zArg
) ){

562 
zFûe
 = 
¨gv
[++
i
];

564 
iVÆ
 = 
	`©oi
(
¨gv
[++
i
]);

565 if–
iVÆ
<
aArg
[
iSñ
].
nMö
 || iVÆ>aArg[iSñ].
nMax
 ){

566 
	`Ârötf
(
°dîr
, "option %s out ofÑange (%d..%d)\n",

567 
aArg
[
iSñ
].
zArg
,áArg[iSñ].
nMö
,áArg[iSñ].
nMax


572  
iSñ
 ){

573 0: 
iDb
 = 
iVÆ
; ;

574 1: 
nRow
 = 
iVÆ
; ;

575 2: 
nRowPîTøns
 = 
iVÆ
; ;

576 3: 
iIdx
 = 
iVÆ
; ;

581 
	`¥ötf
("select1: db=%dÑows=%dÑowspertrans=%d index=%d ... ",

582 
iDb
, 
nRow
, 
nRowPîTøns
, 
iIdx


584 
	`fÊush
(
°dout
);

585 if–
iDb
==3 ){

586 
	`do_£À˘1_ã°3
(
zFûe
, 
nRow
, 
nRowPîTøns
, 
iIdx
);

588 
	`do_£À˘1_ã°4
(
zFûe
, 
nRow
, 
nRowPîTøns
, 
iIdx
);

592 
	}
}

594 
SqlD©aba£
 
	tSqlD©aba£
;

595 
SqlStmt
 
	tSqlStmt
;

596 
SqlD©aba£3
 
	tSqlD©aba£3
;

597 
SqlD©aba£4
 
	tSqlD©aba£4
;

598 
	sSqlStmt
 {

599 *
	mzStmt
;

600 *
	mpStmt
;

601 
SqlStmt
 *
	mpNext
;

603 
	sSqlD©aba£
 {

604 
	miDb
;

605 
SqlStmt
 *
	mpSqlStmt
;

607 
	sSqlD©aba£3
 {

608 
SqlD©aba£
 
	mx
;

609 
sqlôe3
 *
	mdb
;

611 
	sSqlD©aba£4
 {

612 
SqlD©aba£
 
	mx
;

613 
sqlôe4
 *
	mdb
;

616 
	$›í_d©aba£
(

617 
iDb
,

618 c⁄° *
zC⁄fig
,

619 c⁄° *
zFûe
,

620 
bNew
,

621 
SqlD©aba£
 **
µ


623 
rc
 = 0;

625 
	`as£π
–
iDb
==3 || iDb==4 );

626 if–
zFûe
==0 ){

627 if–
iDb
==3 ){

628 
zFûe
 = 
SQLITE3_DB_FILE
;

630 
zFûe
 = 
SQLITE4_DB_FILE
;

634 if–
bNew
 ){

635 
	`u∆ök_db
(
zFûe
);

638 if–
iDb
==3 ){

639 
SqlD©aba£3
 *
p
 = 
	`sqlôe4_mÆloc
(0, (
SqlD©aba£4
));

640 
	`mem£t
(
p
, 0, (
SqlD©aba£3
));

641 
p
->
x
.
iDb
 = 3;

642 
rc
 = 
	`sqlôe3_›í
(
zFûe
, &
p
->
db
);

643 if–
rc
!=
SQLITE_OK
 ){

644 
	`sqlôe4_‰ì
(0, 
p
);

645 
p
 = 0;

647 
	`sqlôe3_exec
(
p
->
db
, "PRAGMA synchronous=NORMAL", 0, 0, 0);

648 
	`sqlôe3_exec
(
p
->
db
, "PRAGMA journal_mode=WAL", 0, 0, 0);

649 
	`ö°Æl_röt_fun˘i⁄3
(
p
->
db
);

650 if–
zC⁄fig
 ) {

651 
rc
 = 
	`sqlôe3_exec
(
p
->
db
, 
zC⁄fig
, 0, 0, 0);

654 *
µ
 = (
SqlD©aba£
 *)
p
;

656 
SqlD©aba£4
 *
p
 = 
	`sqlôe4_mÆloc
(0, (SqlDatabase4));

657 
	`mem£t
(
p
, 0, (
SqlD©aba£4
));

658 
p
->
x
.
iDb
 = 4;

659 
rc
 = 
	`bt_›í
(0, 
zFûe
, &
p
->
db
);

660 if–
rc
!=
SQLITE4_OK
 ){

661 
	`sqlôe4_‰ì
(0, 
p
);

662 
p
 = 0;

664 
	`ö°Æl_röt_fun˘i⁄4
(
p
->
db
);

665 if–
zC⁄fig
 ) {

666 
rc
 = 
	`sqlôe4_exec
(
p
->
db
, 
zC⁄fig
, 0, 0);

669 *
µ
 = (
SqlD©aba£
 *)
p
;

672  
rc
;

673 
	}
}

675 
	$˛o£_d©aba£
(
SqlD©aba£
 *
pDb
){

676 
	`as£π
–
pDb
->
iDb
==3 ||ÖDb->iDb==4 );

677 if–
pDb
->
iDb
==3 ){

678 
SqlD©aba£3
 *
p
 = (SqlD©aba£3 *)
pDb
;

679 
SqlStmt
 *
pSql
;

680 
SqlStmt
 *
pNext
;

681 
pSql
=
pDb
->
pSqlStmt
;ÖSql;ÖSql=
pNext
){

682 
pNext
 = 
pSql
->pNext;

683 
	`sqlôe3_föÆize
((
sqlôe3_°mt
 *)
pSql
->
pStmt
);

684 
	`sqlôe4_‰ì
(0, 
pSql
);

686 
	`sqlôe3_˛o£
(
p
->
db
);

687 
	`sqlôe4_‰ì
(0, 
p
);

689 
SqlD©aba£4
 *
p
 = (SqlD©aba£4 *)
pDb
;

690 
SqlStmt
 *
pSql
;

691 
SqlStmt
 *
pNext
;

692 
pSql
=
pDb
->
pSqlStmt
;ÖSql;ÖSql=
pNext
){

693 
pNext
 = 
pSql
->pNext;

694 
	`sqlôe4_föÆize
((
sqlôe4_°mt
 *)
pSql
->
pStmt
);

695 
	`sqlôe4_‰ì
(0, 
pSql
);

697 
	`sqlôe4_˛o£
(
p
->
db
, 0);

698 
	`sqlôe4_‰ì
(0, 
p
);

700 
	}
}

702 
	$exec_sql
(
SqlD©aba£
 *
pDb
, c⁄° *
zSql
, c⁄° *
zBöd
, ...){

703 
rc
 = 0;

704 *
pNewStmt
 = 0;

705 
SqlStmt
 *
pSql
;

708 
pSql
=
pDb
->
pSqlStmt
;ÖSq»&& 
	`°rcmp
’Sql->
zStmt
, 
zSql
);ÖSqlıSql->
pNext
);

710 
	`as£π
–
pDb
->
iDb
==3 ||ÖDb->iDb==4 );

711 if–
pDb
->
iDb
==3 ){

712 *
piOut
 = 0;

713 
sqlôe3_°mt
 *
pStmt
 = 0;

714 
SqlD©aba£3
 *
p
 = (SqlD©aba£3 *)
pDb
;

716 if–
pSql
==0 ){

717 
rc
 = 
	`sqlôe3_¥ï¨e
(
p
->
db
, 
zSql
, -1, &
pStmt
, 0);

719 
pStmt
 = (
sqlôe3_°mt
 *)(
pSql
->pStmt);

722 if–
zBöd
 ){

723 
i
;

724 
va_li°
 
≠
;

726 
	`va_°¨t
(
≠
, 
zBöd
);

727 
i
=0; 
zBöd
[i] && 
rc
==
SQLITE_OK
; i++){

728  
zBöd
[
i
] ){

730 
piOut
 = 
	`va_¨g
(
≠
, *);

735 
iVÆ
 = 
	`va_¨g
(
≠
, );

736 
rc
 = 
	`sqlôe3_böd_öt
(
pStmt
, 
i
+1, 
iVÆ
);

740 
rc
 = -1;

744 
	`va_íd
(
≠
);

747 if–
rc
==
SQLITE_OK
 ){

748  
SQLITE_ROW
==
	`sqlôe3_°ï
(
pStmt
) ){

749 if–
piOut
 ) *piOuà
	`sqlôe3_cﬁumn_öt
(
pStmt
, 0);

751 
rc
 = 
	`sqlôe3_ª£t
(
pStmt
);

752 
pNewStmt
 = 
pStmt
;

754 
	`sqlôe3_föÆize
(
pStmt
);

757 *
piOut
 = 0;

758 
sqlôe4_°mt
 *
pStmt
 = 0;

759 
SqlD©aba£4
 *
p
 = (SqlD©aba£4 *)
pDb
;

761 if–
pSql
==0 ){

762 
rc
 = 
	`sqlôe4_¥ï¨e
(
p
->
db
, 
zSql
, -1, &
pStmt
, 0);

764 
pStmt
 = (
sqlôe4_°mt
 *)(
pSql
->pStmt);

767 if–
zBöd
 ){

768 
i
;

769 
va_li°
 
≠
;

771 
	`va_°¨t
(
≠
, 
zBöd
);

772 
i
=0; 
zBöd
[i] && 
rc
==
SQLITE4_OK
; i++){

773  
zBöd
[
i
] ){

775 
piOut
 = 
	`va_¨g
(
≠
, *);

779 
iVÆ
 = 
	`va_¨g
(
≠
, );

780 
rc
 = 
	`sqlôe4_böd_öt
(
pStmt
, 
i
+1, 
iVÆ
);

784 
rc
 = -1;

788 
	`va_íd
(
≠
);

791 if–
rc
==
SQLITE4_OK
 ){

792  
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pStmt
) ){

793 if–
piOut
 ) *piOuà
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

795 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

796 
pNewStmt
 = 
pStmt
;

798 
	`sqlôe4_föÆize
(
pStmt
);

802 if–
pSql
==0 && 
pNewStmt
 ){

803 
nSql
 = 
	`°æí
(
zSql
);

804 
pSql
 = 
	`sqlôe4_mÆloc
(0, (
SqlStmt
Ë+ 
nSql
 + 1);

805 
	`mem£t
(
pSql
, 0, (
SqlStmt
));

806 
pSql
->
zStmt
 = (*)&pSql[1];

807 
	`mem˝y
(
pSql
->
zStmt
, 
zSql
, 
nSql
+1);

808 
pSql
->
pStmt
 = 
pNewStmt
;

809 
pSql
->
pNext
 = 
pDb
->
pSqlStmt
;

810 
pDb
->
pSqlStmt
 = 
pSql
;

813  
rc
;

814 
	}
}

816 
	$do_öt_ö£π_ã°
(

817 
iDb
,

818 c⁄° *
zCfg
,

819 c⁄° *
zFûe
,

820 
nRow
,

821 
nRowPîTøns


823 
nMs
 = 0;

824 
SqlD©aba£
 *
db
;

825 
i
;

827 
	`EXPLODE
–
	`›í_d©aba£
(
iDb
, 
zCfg
, 
zFûe
, 1, &
db
) );

828 
	`EXPLODE
–
	`exec_sql
(
db
,

832 
	`ã°TimeInô
();

833 
i
=0; i<
nRow
; i++){

834 if–(
i
 % 
nRowPîTøns
)==0 ){

835 if–
i
!=0 ) 
	`EXPLODE
–
	`exec_sql
(
db
, "COMMIT", 0) );

836 
	`EXPLODE
–
	`exec_sql
(
db
, "BEGIN", 0) );

838 
	`EXPLODE
–
	`exec_sql
(
db
,

839 "INSERT INTOÅ1 VALUES(?+1,Ñöt(?,0))", "ii", 
i
, i

842 
	`EXPLODE
–
	`exec_sql
(
db
, "COMMIT", 0) );

844 
nMs
 = 
	`ã°TimeGë
();

846 
	`˛o£_d©aba£
(
db
);

847 
	`¥ötf
("%.3‡£c⁄ds\n", ()
nMs
 / 1000.0);

849 
	}
}

851 
	$do_öt_upd©e_ã°
(

852 
iDb
,

853 c⁄° *
zCfg
,

854 c⁄° *
zFûe
,

855 
nRow
,

856 
nRowPîTøns


858 
nMs
 = 0;

859 
SqlD©aba£
 *
db
;

860 
i
;

861 
k
 = 0;

862 
v
 = 0;

863 
nTblRow
 = 0;

865 
	`EXPLODE
–
	`›í_d©aba£
(
iDb
, 
zCfg
, 
zFûe
, 0, &
db
) );

866 
	`EXPLODE
–
	`exec_sql
(
db
, "SELECT cou¡(*ËFROMÅ1", "O", &
nTblRow
) );

868 
	`ã°TimeInô
();

869 
i
=0; i<
nRow
; i++){

870 if–(
i
 % 
nRowPîTøns
)==0 ){

871 if–
i
!=0 ) 
	`EXPLODE
–
	`exec_sql
(
db
, "COMMIT", 0) );

872 
	`EXPLODE
–
	`exec_sql
(
db
, "BEGIN", 0) );

874 
k
 = (
	`ã°P∫gVÆue
(
v
+
i
Ë% 
nTblRow
);

875 
v
 = (
	`ã°P∫gVÆue
(
k
+
i
Ë% 
nTblRow
);

876 
	`EXPLODE
–
	`exec_sql
(
db
, "UPDATEÅ1 SET v = ? WHERE k = (?+1)", "ii", 
v
, 
k
));

878 
	`EXPLODE
–
	`exec_sql
(
db
, "COMMIT", 0) );

880 
nMs
 = 
	`ã°TimeGë
();

882 
	`˛o£_d©aba£
(
db
);

883 
	`¥ötf
("%.3‡£c⁄ds\n", ()
nMs
 / 1000.0);

885 
	}
}

887 
	$gë_öt_ã°_¨gs
(

888 
¨gc
, **
¨gv
,

889 *
piDb
,

890 *
≤Row
,

891 *
≤RowPîTøns
,

892 c⁄° **
pzCfg
,

893 c⁄° **
pzFûe


895 
	sIn£π1Arg
 {

896 c⁄° *
zArg
;

897 
nMö
;

898 
nMax
;

899 } 
aArg
[] = {

907 
i
;

909 
iDb
 = 4;

910 
nRow
 = 50000;

911 
nRowPîTøns
 = 10;

912 c⁄° *
zFûe
 = 0;

913 c⁄° *
zCfg
 = 0;

915 
i
=0; i<
¨gc
; i++){

916 
iSñ
;

917 
rc
;

919 
rc
 = 
	`ã°ArgSñe˘X
(
aArg
, "¨gumít", ◊Arg[0]), 
¨gv
[
i
], &
iSñ
);

920 if–
rc
!=0 )  -1;

921 if–
i
==
¨gc
-1 ){

922 
	`Ârötf
(
°dîr
, "›ti⁄ %†ªquúe†™árgumít\n", 
aArg
[
iSñ
].
zArg
);

925 if–0==
	`°rcmp
("-c⁄fig", 
aArg
[
iSñ
].
zArg
) ){

926 
zCfg
 = 
¨gv
[++
i
];

927 }if–0==
	`°rcmp
("-fûe", 
aArg
[
iSñ
].
zArg
) ){

928 
zFûe
 = 
¨gv
[++
i
];

930 
iVÆ
 = 
	`©oi
(
¨gv
[++
i
]);

931 if–
iVÆ
<
aArg
[
iSñ
].
nMö
 || iVÆ>aArg[iSñ].
nMax
 ){

932 
	`Ârötf
(
°dîr
, "option %s out ofÑange (%d..%d)\n",

933 
aArg
[
iSñ
].
zArg
,áArg[iSñ].
nMö
,áArg[iSñ].
nMax


938  
iSñ
 ){

939 0: 
iDb
 = 
iVÆ
; ;

940 1: 
nRow
 = 
iVÆ
; ;

941 2: 
nRowPîTøns
 = 
iVÆ
; ;

946 *
piDb
 = 
iDb
;

947 *
≤Row
 = 
nRow
;

948 *
≤RowPîTøns
 = 
nRowPîTøns
;

949 *
pzCfg
 = 
zCfg
;

950 *
pzFûe
 = 
zFûe
;

952 
	}
}

954 
	$do_öt_ö£π
(
¨gc
, **
¨gv
){

955 
iDb
;

956 
nRow
;

957 
nRowPîTøns
;

958 c⁄° *
zFûe
;

959 c⁄° *
zCfg
;

960 
rc
;

962 
rc
 = 
	`gë_öt_ã°_¨gs
(
¨gc
, 
¨gv
, &
iDb
, &
nRow
, &
nRowPîTøns
, &
zCfg
, &
zFûe
);

963 if–
rc
!=0 ) Ñc;

965 
	`¥ötf
("int_insert: db=%dÑows=%dÑowspertrans=%d ... ",

966 
iDb
, 
nRow
, 
nRowPîTøns


968 
	`fÊush
(
°dout
);

969 
	`do_öt_ö£π_ã°
(
iDb
, 
zCfg
, 
zFûe
, 
nRow
, 
nRowPîTøns
);

972 
	}
}

974 
	$do_öt_upd©e
(
¨gc
, **
¨gv
){

975 
iDb
;

976 
nRow
;

977 
nRowPîTøns
;

978 c⁄° *
zFûe
;

979 c⁄° *
zCfg
;

980 
rc
;

982 
rc
 = 
	`gë_öt_ã°_¨gs
(
¨gc
, 
¨gv
, &
iDb
, &
nRow
, &
nRowPîTøns
, &
zCfg
, &
zFûe
);

983 if–
rc
!=0 ) Ñc;

985 
	`¥ötf
("int_update: db=%dÑows=%dÑowspertrans=%d ... ",

986 
iDb
, 
nRow
, 
nRowPîTøns


988 
	`fÊush
(
°dout
);

989 
	`do_öt_upd©e_ã°
(
iDb
, 
zCfg
, 
zFûe
, 
nRow
, 
nRowPîTøns
);

992 
	}
}

994 
	$maö
(
¨gc
, **
¨gv
){

995 
	sSq…e°Arg
 {

996 c⁄° *
zPrg
;

997 (*
xPrg
)(, **);

998 } 
aArg
[] = {

999 {"£À˘", 
do_£À˘1
},

1000 {"ö£π", 
do_ö£π1
},

1001 {"öt_ö£π", 
do_öt_ö£π
},

1002 {"öt_upd©e", 
do_öt_upd©e
},

1005 
iSñ
;

1006 
rc
;

1008 if–
¨gc
<2 ){

1009 
	`Ârötf
(
°dîr
, "Ußge: %†sub-¥ogøm...\n", 
¨gv
[0]);

1013 
rc
 = 
	`ã°ArgSñe˘X
(
aArg
, "sub-¥ogøm", ◊Arg[0]), 
¨gv
[1], &
iSñ
);

1014 if–
rc
!=0 )  -1;

1016 
aArg
[
iSñ
].
	`xPrg
(
¨gc
-2, 
¨gv
+2);

1018 
	}
}

	@src/alter.c

15 
	~"sqlôeI¡.h
"

21 #i‚de‡
SQLITE4_OMIT_ALTERTABLE


37 
	$ª«meTabÀFunc
(

38 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

39 
NŸU£d
,

40 
sqlôe4_vÆue
 **
¨gv


42 c⁄° *
zSql
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

43 c⁄° *
zTabÀName
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0);

45 
tokí
;

46 
Tokí
 
äame
;

47 c⁄° *
zC§
 = 
zSql
;

48 
Àn
 = 0;

49 *
zRë
;

51 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

53 
	`UNUSED_PARAMETER
(
NŸU£d
);

59 if–
zSql
 ){

61 if–!*
zC§
 ){

67 
äame
.
z
 = (*)
zC§
;

68 
äame
.
n
 = 
Àn
;

74 
zC§
 +
Àn
;

75 
Àn
 = 
	`sqlôe4GëTokí
((
u8
*)
zC§
, &
tokí
);

76 }  
tokí
==
TK_SPACE
 );

77 
	`as£π
–
Àn
>0 );

78 }  
tokí
!=
TK_LP
 &&Åokí!=
TK_USING
 );

80 
zRë
 = 
	`sqlôe4MPrötf
(
db
, "%.*s\"%w\"%s", 
äame
.
z
 - 
zSql
, zSql,

81 
zTabÀName
, 
äame
.
z
+äame.
n
);

82 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zRë
, -1, 
SQLITE4_TRANSIENT
, 0);

83 
	`sqlôe4DbFªe
(
db
, 
zRë
);

85 
	}
}

102 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


103 
	$ª«meP¨ítFunc
(

104 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

105 
NŸU£d
,

106 
sqlôe4_vÆue
 **
¨gv


108 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

109 *
zOuçut
 = 0;

110 *
zResu…
;

111 c⁄° *
zI≈ut
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

112 c⁄° *
zOld
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0);

113 c⁄° *
zNew
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[2], 0);

115 c⁄° *
z
;

116 
n
;

117 
tokí
;

119 
	`UNUSED_PARAMETER
(
NŸU£d
);

120 
z
=
zI≈ut
; *z; z=z+
n
){

121 
n
 = 
	`sqlôe4GëTokí
((
u8
*)
z
, &
tokí
);

122 if–
tokí
==
TK_REFERENCES
 ){

123 *
zP¨ít
;

125 
z
 +
n
;

126 
n
 = 
	`sqlôe4GëTokí
((
u8
*)
z
, &
tokí
);

127 } 
tokí
==
TK_SPACE
 );

129 
zP¨ít
 = 
	`sqlôe4DbSåNDup
(
db
, (c⁄° *)
z
, 
n
);

130 if–
zP¨ít
==0 ) ;

131 
	`sqlôe4DequŸe
(
zP¨ít
);

132 if–0==
	`sqlôe4_°ricmp
(
zOld
, 
zP¨ít
) ){

133 *
zOut
 = 
	`sqlôe4MPrötf
(
db
, "%s%.*s\"%w\"",

134 (
zOuçut
?zOuçut:""), 
z
-
zI≈ut
, zI≈ut, 
zNew


136 
	`sqlôe4DbFªe
(
db
, 
zOuçut
);

137 
zOuçut
 = 
zOut
;

138 
zI≈ut
 = &
z
[
n
];

140 
	`sqlôe4DbFªe
(
db
, 
zP¨ít
);

144 
zResu…
 = 
	`sqlôe4MPrötf
(
db
, "%s%s", (
zOuçut
?zOuçut:""), 
zI≈ut
),

145 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zResu…
, -1, 
SQLITE4_TRANSIENT
, 0);

146 
	`sqlôe4DbFªe
(
db
, 
zOuçut
);

147 
	`sqlôe4DbFªe
(
db
, 
zResu…
);

148 
	}
}

151 #i‚de‡
SQLITE4_OMIT_TRIGGER


159 
	$ª«meTriggîFunc
(

160 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

161 
NŸU£d
,

162 
sqlôe4_vÆue
 **
¨gv


164 c⁄° *
zSql
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

165 c⁄° *
zTabÀName
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0);

167 
tokí
;

168 
Tokí
 
äame
;

169 
di°
 = 3;

170 c⁄° *
zC§
 = 
zSql
;

171 
Àn
 = 0;

172 *
zRë
;

173 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

175 
	`UNUSED_PARAMETER
(
NŸU£d
);

182 if–
zSql
 ){

185 if–!*
zC§
 ){

191 
äame
.
z
 = (*)
zC§
;

192 
äame
.
n
 = 
Àn
;

198 
zC§
 +
Àn
;

199 
Àn
 = 
	`sqlôe4GëTokí
((
u8
*)
zC§
, &
tokí
);

200 } 
tokí
==
TK_SPACE
 );

201 
	`as£π
–
Àn
>0 );

212 
di°
++;

213 if–
tokí
==
TK_DOT
 ||Åokí==
TK_ON
 ){

214 
di°
 = 0;

216 }  
di°
!=2 || (
tokí
!=
TK_WHEN
 &&Åokí!=
TK_FOR
 &&Åokí!=
TK_BEGIN
) );

221 
zRë
 = 
	`sqlôe4MPrötf
(
db
, "%.*s\"%w\"%s", 
äame
.
z
 - 
zSql
, zSql,

222 
zTabÀName
, 
äame
.
z
+äame.
n
);

223 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zRë
, -1, 
SQLITE4_TRANSIENT
, 0);

224 
	`sqlôe4DbFªe
(
db
, 
zRë
);

226 
	}
}

232 
	$sqlôe4A…îFun˘i⁄s
(
sqlôe4_ív
 *
pEnv
){

233 
FuncDef
 
aA…îTabÀFuncs
[] = {

234 
	`FUNCTION
(
sqlôe_ª«me_èbÀ
, 2, 0, 0, 
ª«meTabÀFunc
),

235 #i‚de‡
SQLITE4_OMIT_TRIGGER


236 
	`FUNCTION
(
sqlôe_ª«me_åiggî
, 2, 0, 0, 
ª«meTriggîFunc
),

238 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


239 
	`FUNCTION
(
sqlôe_ª«me_∑ª¡
, 3, 0, 0, 
ª«meP¨ítFunc
),

242 
i
;

243 
FuncDefTabÀ
 *
pFuncTab
 = &
pEnv
->
aGlobÆFuncs
;

244 
FuncDef
 *
aFunc
 = (FuncDef*)
aA…îTabÀFuncs
;

246 
i
=0; i<
	`AºaySize
(
aA…îTabÀFuncs
); i++){

247 
	`sqlôe4FuncDefIn£π
(
pFuncTab
, &
aFunc
[
i
], 1);

249 
	}
}

267 *
	$whîeOrName
(
sqlôe4
 *
db
, *
zWhîe
, *
zC⁄°™t
){

268 *
zNew
;

269 if–!
zWhîe
 ){

270 
zNew
 = 
	`sqlôe4MPrötf
(
db
, "«me=%Q", 
zC⁄°™t
);

272 
zNew
 = 
	`sqlôe4MPrötf
(
db
, "%†ORÇame=%Q", 
zWhîe
, 
zC⁄°™t
);

273 
	`sqlôe4DbFªe
(
db
, 
zWhîe
);

275  
zNew
;

276 
	}
}

278 #i‡!
deföed
(
SQLITE4_OMIT_FOREIGN_KEY
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

285 *
	$whîeF‹eignKeys
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
){

286 
FKey
 *
p
;

287 *
zWhîe
 = 0;

288 
p
=
	`sqlôe4FkRe„ªn˚s
(
pTab
);Ö;Öı->
pNextTo
){

289 
zWhîe
 = 
	`whîeOrName
(
pP¨£
->
db
, zWhîe, 
p
->
pFrom
->
zName
);

291  
zWhîe
;

292 
	}
}

301 *
	$whîeTempTriggîs
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
){

302 
Triggî
 *
pTrig
;

303 *
zWhîe
 = 0;

304 c⁄° 
Schema
 *
pTempSchema
 = 
pP¨£
->
db
->
aDb
[1].
pSchema
;

311 if–
pTab
->
pSchema
!=
pTempSchema
 ){

312 
sqlôe4
 *
db
 = 
pP¨£
->db;

313 
pTrig
=
	`sqlôe4TriggîLi°
(
pP¨£
, 
pTab
);ÖTrig;ÖTrigıTrig->
pNext
){

314 if–
pTrig
->
pSchema
==
pTempSchema
 ){

315 
zWhîe
 = 
	`whîeOrName
(
db
, zWhîe, 
pTrig
->
zName
);

319 if–
zWhîe
 ){

320 *
zNew
 = 
	`sqlôe4MPrötf
(
pP¨£
->
db
, "ty≥='åiggî' AND (%s)", 
zWhîe
);

321 
	`sqlôe4DbFªe
(
pP¨£
->
db
, 
zWhîe
);

322 
zWhîe
 = 
zNew
;

324  
zWhîe
;

325 
	}
}

335 
	$ªlﬂdTabÀSchema
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, c⁄° *
zName
){

336 
Vdbe
 *
v
;

337 *
zWhîe
;

338 
iDb
;

339 #i‚de‡
SQLITE4_OMIT_TRIGGER


340 
Triggî
 *
pTrig
;

343 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

344 if–
	`NEVER
(
v
==0) ) ;

345 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

346 
	`as£π
–
iDb
>=0 );

348 #i‚de‡
SQLITE4_OMIT_TRIGGER


350 
pTrig
=
	`sqlôe4TriggîLi°
(
pP¨£
, 
pTab
);ÖTrig;ÖTrigıTrig->
pNext
){

351 
iTrigDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTrig
->
pSchema
);

352 
	`as£π
–
iTrigDb
==
iDb
 || iTrigDb==1 );

353 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Dr›Triggî
, 
iTrigDb
, 0, 0, 
pTrig
->
zName
, 0);

358 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Dr›TabÀ
, 
iDb
, 0, 0, 
pTab
->
zName
, 0);

361 
zWhîe
 = 
	`sqlôe4MPrötf
(
pP¨£
->
db
, "tbl_«me=%Q", 
zName
);

362 if–!
zWhîe
 ) ;

363 
	`sqlôe4VdbeAddP¨£SchemaOp
(
v
, 
iDb
, 
zWhîe
);

365 #i‚de‡
SQLITE4_OMIT_TRIGGER


369 if–(
zWhîe
=
	`whîeTempTriggîs
(
pP¨£
, 
pTab
))!=0 ){

370 
	`sqlôe4VdbeAddP¨£SchemaOp
(
v
, 1, 
zWhîe
);

373 
	}
}

383 
	$isSy°emTabÀ
(
P¨£
 *
pP¨£
, c⁄° *
zName
){

384 if–
	`sqlôe4SåÀn30
(
zName
)>6 && 0==
	`sqlôe4_°∫icmp
(zName, "sqlite_", 7) ){

385 
	`sqlôe4Eº‹Msg
(
pP¨£
, "èbÀ %†mayÇŸ bêÆãªd", 
zName
);

389 
	}
}

395 
	$sqlôe4A…îRíameTabÀ
(

396 
P¨£
 *
pP¨£
,

397 
SrcLi°
 *
pSrc
,

398 
Tokí
 *
pName


400 
iDb
;

401 *
zDb
;

402 
TabÀ
 *
pTab
;

403 *
zName
 = 0;

404 
sqlôe4
 *
db
 = 
pP¨£
->db;

405 
nTabName
;

406 c⁄° *
zTabName
;

407 
Vdbe
 *
v
;

408 #i‚de‡
SQLITE4_OMIT_TRIGGER


409 *
zWhîe
 = 0;

411 
VTabÀ
 *
pVTab
 = 0;

412 
ßvedDbFœgs
;

414 
ßvedDbFœgs
 = 
db
->
Êags
;

415 if–
	`NEVER
(
db
->
mÆlocFaûed
ËË
exô_ª«me_èbÀ
;

416 
	`as£π
–
pSrc
->
nSrc
==1 );

418 
pTab
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 0, 
pSrc
->
a
[0].
zName
,ÖSrc->a[0].
zD©aba£
);

419 if–!
pTab
 ) 
exô_ª«me_èbÀ
;

420 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

421 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

422 
db
->
Êags
 |
SQLITE4_Pª„rBuûtö
;

425 
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName
);

426 if–!
zName
 ) 
exô_ª«me_èbÀ
;

431 if–
	`sqlôe4FödTabÀ
(
db
, 
zName
, 
zDb
Ë|| 
	`sqlôe4FödIndex
(db, zName, zDb) ){

432 
	`sqlôe4Eº‹Msg
(
pP¨£
,

433 "thîêi†ÆªadyánŸhîÅabÀ o∏ödex wôhÅhi†«me: %s", 
zName
);

434 
exô_ª«me_èbÀ
;

440 if–
SQLITE4_OK
!=
	`isSy°emTabÀ
(
pP¨£
, 
pTab
->
zName
) ){

441 
exô_ª«me_èbÀ
;

443 if–
SQLITE4_OK
!=
	`sqlôe4CheckObje˘Name
(
pP¨£
, 
zName
) ){ 

444 
exô_ª«me_èbÀ
;

447 #i‚de‡
SQLITE4_OMIT_VIEW


448 if–
pTab
->
pSñe˘
 ){

449 
	`sqlôe4Eº‹Msg
(
pP¨£
, "võw %†mayÇŸ bêÆãªd", 
pTab
->
zName
);

450 
exô_ª«me_èbÀ
;

454 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


456 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_ALTER_TABLE
, 
zDb
, 
pTab
->
zName
, 0) ){

457 
exô_ª«me_èbÀ
;

461 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


462 if–
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
, 
pTab
) ){

463 
exô_ª«me_èbÀ
;

465 if–
	`IsVútuÆ
(
pTab
) ){

466 
pVTab
 = 
	`sqlôe4GëVTabÀ
(
db
, 
pTab
);

467 if–
pVTab
->
pVèb
->
pModuÀ
->
xRíame
==0 ){

468 
pVTab
 = 0;

478 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

479 if–
v
==0 ){

480 
exô_ª«me_èbÀ
;

482 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 
pVTab
!=0, 
iDb
);

483 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

490 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


491 if–
pVTab
 ){

492 
i
 = ++
pP¨£
->
nMem
;

493 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
i
, 0, 
zName
, 0);

494 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VRíame
, 
i
, 0, 0,(c⁄° *)
pVTab
, 
P4_VTAB
);

495 
	`sqlôe4MayAb‹t
(
pP¨£
);

500 
zTabName
 = 
pTab
->
zName
;

501 
nTabName
 = 
	`sqlôe4Utf8Ch¨Lí
(
zTabName
, -1);

503 #i‡!
	`deföed
(
SQLITE4_OMIT_FOREIGN_KEY
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

504 if–
db
->
Êags
&
SQLITE4_F‹eignKeys
 ){

508 if–(
zWhîe
=
	`whîeF‹eignKeys
(
pP¨£
, 
pTab
))!=0 ){

509 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

512 "WHERE %s;", 
zDb
, 
	`SCHEMA_TABLE
(
iDb
), 
zTabName
, 
zName
, 
zWhîe
);

513 
	`sqlôe4DbFªe
(
db
, 
zWhîe
);

519 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

521 #ifde‡
SQLITE4_OMIT_TRIGGER


536 
zDb
, 
	`SCHEMA_TABLE
(
iDb
), 
zName
, zName, zName,

537 #i‚de‡
SQLITE4_OMIT_TRIGGER


538 
zName
,

540 
zName
, 
nTabName
, 
zTabName


543 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


547 if–
	`sqlôe4FödTabÀ
(
db
, "sqlôe_£quí˚", 
zDb
) ){

548 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

550 
zDb
, 
zName
, 
pTab
->zName);

554 #i‚de‡
SQLITE4_OMIT_TRIGGER


559 if–(
zWhîe
=
	`whîeTempTriggîs
(
pP¨£
, 
pTab
))!=0 ){

560 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

564 "WHERE %s;", 
zName
, zName, 
zWhîe
);

565 
	`sqlôe4DbFªe
(
db
, 
zWhîe
);

569 #i‡!
	`deföed
(
SQLITE4_OMIT_FOREIGN_KEY
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

570 if–
db
->
Êags
&
SQLITE4_F‹eignKeys
 ){

571 
FKey
 *
p
;

572 
p
=
	`sqlôe4FkRe„ªn˚s
(
pTab
);Ö;Öı->
pNextTo
){

573 
TabÀ
 *
pFrom
 = 
p
->pFrom;

574 if–
pFrom
!=
pTab
 ){

575 
	`ªlﬂdTabÀSchema
(
pP¨£
, 
p
->
pFrom
,ÖFrom->
zName
);

582 
	`ªlﬂdTabÀSchema
(
pP¨£
, 
pTab
, 
zName
);

584 
exô_ª«me_èbÀ
:

585 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pSrc
);

586 
	`sqlôe4DbFªe
(
db
, 
zName
);

587 
db
->
Êags
 = 
ßvedDbFœgs
;

588 
	}
}

599 
	$sqlôe4A…îFöishAddCﬁumn
(
P¨£
 *
pP¨£
, 
Tokí
 *
pCﬁDef
){

600 
TabÀ
 *
pNew
;

601 
TabÀ
 *
pTab
;

602 
iDb
;

603 c⁄° *
zDb
;

604 c⁄° *
zTab
;

605 *
zCﬁ
;

606 
Cﬁumn
 *
pCﬁ
;

607 
Ex¥
 *
pDÊt
;

608 
sqlôe4
 *
db
;

610 
db
 = 
pP¨£
->db;

611 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ) ;

612 
pNew
 = 
pP¨£
->
pNewTabÀ
;

613 
	`as£π
–
pNew
 );

615 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pNew
->
pSchema
);

616 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

617 
zTab
 = &
pNew
->
zName
[16];

618 
pCﬁ
 = &
pNew
->
aCﬁ
[pNew->
nCﬁ
-1];

619 
pDÊt
 = 
pCﬁ
->pDflt;

620 
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
zTab
, 
zDb
);

621 
	`as£π
–
pTab
 );

623 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


625 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_ALTER_TABLE
, 
zDb
, 
pTab
->
zName
, 0) ){

634 if–
pDÊt
 &&ÖDÊt->
›
==
TK_NULL
 ){

635 
pDÊt
 = 0;

642 if–
pCﬁ
->
iPrimKey
>0 ){

643 
	`sqlôe4Eº‹Msg
(
pP¨£
, "Cannotáddá PRIMARY KEY column");

646 if–
pNew
->
pIndex
 ){

647 
	`sqlôe4Eº‹Msg
(
pP¨£
, "Cannotáddá UNIQUE column");

650 if–(
db
->
Êags
&
SQLITE4_F‹eignKeys
Ë&& 
pNew
->
pFKey
 && 
pDÊt
 ){

651 
	`sqlôe4Eº‹Msg
(
pP¨£
,

655 if–
pCﬁ
->
nŸNuŒ
 && !
pDÊt
 ){

656 
	`sqlôe4Eº‹Msg
(
pP¨£
,

664 if–
pDÊt
 ){

665 
sqlôe4_vÆue
 *
pVÆ
;

666 if–
	`sqlôe4VÆueFromEx¥
(
db
, 
pDÊt
, 
SQLITE4_UTF8
, 
SQLITE4_AFF_NONE
, &
pVÆ
) ){

667 
db
->
mÆlocFaûed
 = 1;

670 if–!
pVÆ
 ){

671 
	`sqlôe4Eº‹Msg
(
pP¨£
, "Cannotáddá column withÇon-constant default");

674 
	`sqlôe4VÆueFªe
(
pVÆ
);

678 
zCﬁ
 = 
	`sqlôe4DbSåNDup
(
db
, (*)
pCﬁDef
->
z
,ÖCﬁDef->
n
);

679 if–
zCﬁ
 ){

680 *
zEnd
 = &
zCﬁ
[
pCﬁDef
->
n
-1];

681 
ßvedDbFœgs
 = 
db
->
Êags
;

682  
zEnd
>
zCﬁ
 && (*zEnd==';' || 
	`sqlôe4Is•a˚
(*zEnd)) ){

683 *
zEnd
-- = '\0';

685 
db
->
Êags
 |
SQLITE4_Pª„rBuûtö
;

686 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

690 
zDb
, 
	`SCHEMA_TABLE
(
iDb
), 
pNew
->
addCﬁOff£t
, 
zCﬁ
,ÖNew->addColOffset+1,

691 
zTab


693 
	`sqlôe4DbFªe
(
db
, 
zCﬁ
);

694 
db
->
Êags
 = 
ßvedDbFœgs
;

698 
	`ªlﬂdTabÀSchema
(
pP¨£
, 
pTab
,ÖTab->
zName
);

699 
	}
}

716 
	$sqlôe4A…îBegöAddCﬁumn
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pSrc
){

717 
TabÀ
 *
pNew
;

718 
TabÀ
 *
pTab
;

719 
Vdbe
 *
v
;

720 
iDb
;

721 
i
;

722 
nAŒoc
;

723 
sqlôe4
 *
db
 = 
pP¨£
->db;

726 
	`as£π
–
pP¨£
->
pNewTabÀ
==0 );

727 if–
db
->
mÆlocFaûed
 ) 
exô_begö_add_cﬁumn
;

728 
pTab
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 0, 
pSrc
->
a
[0].
zName
,ÖSrc->a[0].
zD©aba£
);

729 if–!
pTab
 ) 
exô_begö_add_cﬁumn
;

731 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


732 if–
	`IsVútuÆ
(
pTab
) ){

733 
	`sqlôe4Eº‹Msg
(
pP¨£
, "virtualÅables mayÇot beáltered");

734 
exô_begö_add_cﬁumn
;

739 if–
pTab
->
pSñe˘
 ){

740 
	`sqlôe4Eº‹Msg
(
pP¨£
, "Cannotáddá columnÅoá view");

741 
exô_begö_add_cﬁumn
;

743 if–
SQLITE4_OK
!=
	`isSy°emTabÀ
(
pP¨£
, 
pTab
->
zName
) ){

744 
exô_begö_add_cﬁumn
;

747 
	`as£π
–
pTab
->
addCﬁOff£t
>0 );

748 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

757 
pNew
 = (
TabÀ
*)
	`sqlôe4DbMÆlocZîo
(
db
, (Table));

758 if–!
pNew
 ) 
exô_begö_add_cﬁumn
;

759 
pP¨£
->
pNewTabÀ
 = 
pNew
;

760 
pNew
->
nRef
 = 1;

761 
pNew
->
nCﬁ
 = 
pTab
->nCol;

762 
	`as£π
–
pNew
->
nCﬁ
>0 );

763 
nAŒoc
 = (((
pNew
->
nCﬁ
-1)/8)*8)+8;

764 
	`as£π
–
nAŒoc
>=
pNew
->
nCﬁ
 &&ÇAlloc%8==0 &&ÇAlloc-pNew->nCol<8 );

765 
pNew
->
aCﬁ
 = (
Cﬁumn
*)
	`sqlôe4DbMÆlocZîo
(
db
, (Cﬁumn)*
nAŒoc
);

766 
pNew
->
zName
 = 
	`sqlôe4MPrötf
(
db
, "sqlôe_Æãπab_%s", 
pTab
->zName);

767 if–!
pNew
->
aCﬁ
 || !pNew->
zName
 ){

768 
db
->
mÆlocFaûed
 = 1;

769 
exô_begö_add_cﬁumn
;

771 
	`mem˝y
(
pNew
->
aCﬁ
, 
pTab
->aCﬁ, (
Cﬁumn
)*pNew->
nCﬁ
);

772 
i
=0; i<
pNew
->
nCﬁ
; i++){

773 
Cﬁumn
 *
pCﬁ
 = &
pNew
->
aCﬁ
[
i
];

774 
pCﬁ
->
zName
 = 
	`sqlôe4DbSåDup
(
db
,ÖCol->zName);

775 
pCﬁ
->
zCﬁl
 = 0;

776 
pCﬁ
->
zTy≥
 = 0;

777 
pCﬁ
->
pDÊt
 = 0;

778 
pCﬁ
->
zDÊt
 = 0;

780 
pNew
->
pSchema
 = 
db
->
aDb
[
iDb
].pSchema;

781 
pNew
->
addCﬁOff£t
 = 
pTab
->addColOffset;

782 
pNew
->
nRef
 = 1;

785 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

786 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

787 if–!
v
 ) 
exô_begö_add_cﬁumn
;

788 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

790 
exô_begö_add_cﬁumn
:

791 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pSrc
);

793 
	}
}

	@src/analyze.c

79 #i‚de‡
SQLITE4_OMIT_ANALYZE


80 
	~"sqlôeI¡.h
"

98 
	$›íSètTabÀ
(

99 
P¨£
 *
pP¨£
,

100 
iDb
,

101 
iSètCur
,

102 c⁄° *
zWhîe
,

103 c⁄° *
zWhîeTy≥


106 c⁄° *
zName
;

107 c⁄° *
zCﬁs
;

108 } 
aTabÀ
[] = {

110 #ifde‡
SQLITE4_ENABLE_STAT3


115 
aRoŸ
[] = {0, 0};

116 
u8
 
aCª©eTbl
[] = {0, 0};

118 
i
;

119 
sqlôe4
 *
db
 = 
pP¨£
->db;

120 
Db
 *
pDb
;

121 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

122 if–
v
==0 ) ;

123 
	`as£π
–
	`sqlôe4VdbeDb
(
v
)==
db
 );

124 
pDb
 = &
db
->
aDb
[
iDb
];

129 
i
=0; i<
	`AºaySize
(
aTabÀ
); i++){

130 c⁄° *
zTab
 = 
aTabÀ
[
i
].
zName
;

131 
TabÀ
 *
pSèt
;

132 if–(
pSèt
 = 
	`sqlôe4FödTabÀ
(
db
, 
zTab
, 
pDb
->
zName
))==0 ){

137 
pP¨£
->
pPKRoŸ
 = &
aRoŸ
[
i
];

138 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

139 "CREATE TABLE %Q.%s(%s)", 
pDb
->
zName
, 
zTab
, 
aTabÀ
[
i
].
zCﬁs


141 
	`as£π
–
pP¨£
->
nEº
>0 || 
aRoŸ
[
i
]>0 );

142 
pP¨£
->
pPKRoŸ
 = 0;

143 
aCª©eTbl
[
i
] = 1;

148 
Index
 *
pPK
 = 
	`sqlôe4FödPrim¨yKey
(
pSèt
, 0);

149 
aRoŸ
[
i
] = 
pPK
->
äum
;

150 
	`as£π
–
aRoŸ
[
i
]>0 );

151 if–
zWhîe
 ){

152 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

153 "DELETE FROM %Q.%†WHERE %s=%Q", 
pDb
->
zName
, 
zTab
, 
zWhîeTy≥
, 
zWhîe


157 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_CÀ¨
, 
aRoŸ
[
i
], 
iDb
);

163 
i
=0; i<
	`AºaySize
(
aTabÀ
); i++){

164 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_O≥nWrôe
, 
iSètCur
+
i
, 
aRoŸ
[i], 
iDb
);

165 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (*)3, 
P4_INT32
);

166 
	`sqlôe4VdbeCh™geP5
(
v
, 
aCª©eTbl
[
i
]);

168 
	}
}

173 #i‚de‡
SQLITE4_STAT3_SAMPLES


174 
	#SQLITE4_STAT3_SAMPLES
 24

	)

182 
Sèt3Accum
 
	tSèt3Accum
;

183 
	sSèt3Accum
 {

184 
tRow˙t
 
	mnRow
;

185 
tRow˙t
 
	mnPSam∂e
;

186 
	miMö
;

187 
	mmxSam∂e
;

188 
	mnSam∂e
;

189 
u32
 
	miP∫
;

190 
	sSèt3Sam∂e
 {

191 *
	mpKey
;

192 
	mnKey
;

193 
	mnAŒoc
;

194 
tRow˙t
 
	mnEq
;

195 
tRow˙t
 
	mnLt
;

196 
tRow˙t
 
	mnDLt
;

197 
u8
 
	misPSam∂e
;

198 
u32
 
	miHash
;

199 } *
	ma
;

202 #ifde‡
SQLITE4_ENABLE_STAT3


207 
	$dñSèt3Accum
(*
pCtx
, *
pDñ
){

208 
sqlôe4
 *
db
 = (sqlôe4*)
pCtx
;

209 
Sèt3Accum
 *
p
 = (Sèt3Accum*)
pDñ
;

210 
i
;

212 
i
=0; i<
p
->
nSam∂e
; i++){

213 
	`sqlôe4DbFªe
(
db
, 
p
->
a
[
i
].
pKey
);

215 
	`sqlôe4DbFªe
(
db
, 
p
);

216 
	}
}

227 
	$°©3Inô
(

228 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

229 
¨gc
,

230 
sqlôe4_vÆue
 **
¨gv


232 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

233 
Sèt3Accum
 *
p
;

234 
tRow˙t
 
nRow
;

235 
mxSam∂e
;

236 
n
;

238 
	`UNUSED_PARAMETER
(
¨gc
);

239 
nRow
 = (
tRow˙t
)
	`sqlôe4_vÆue_öt64
(
¨gv
[0]);

240 
mxSam∂e
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[1]);

241 
n
 = (*
p
Ë+ ’->
a
[0])*
mxSam∂e
;

242 
p
 = (
Sèt3Accum
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
n
);

243 if–
p
==0 ){

244 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

247 
p
->
a
 = (
Sèt3Sam∂e
*)&p[1];

248 
p
->
nRow
 =ÇRow;

249 
p
->
mxSam∂e
 = mxSample;

250 
p
->
nPSam∂e
 =Ö->
nRow
/(
mxSam∂e
/3+1) + 1;

251 
	`sqlôe4_øndom√ss
(
	`sqlôe4_db_ív
(
db
), (
p
->
iP∫
), &p->iPrn);

252 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, 
p
, ’), 
dñSèt3Accum
, (*)
db
);

253 
	}
}

254 c⁄° 
FuncDef
 
	g°©3InôFuncdef
 = {

259 
°©3Inô
,

276 
	$°©3Push
(

277 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

278 
¨gc
,

279 
sqlôe4_vÆue
 **
¨gv


281 
Sèt3Accum
 *
p
 = (Sèt3Accum*)
	`sqlôe4_vÆue_blob
(
¨gv
[4], 0);

282 
tRow˙t
 
nEq
 = 
	`sqlôe4_vÆue_öt64
(
¨gv
[0]);

283 
tRow˙t
 
nLt
 = 
	`sqlôe4_vÆue_öt64
(
¨gv
[1]);

284 
tRow˙t
 
nDLt
 = 
	`sqlôe4_vÆue_öt64
(
¨gv
[2]);

285 c⁄° *
pKey
;

286 
nKey
;

287 
u8
 
isPSam∂e
 = 0;

288 
u8
 
doIn£π
 = 0;

289 
iMö
 = 
p
->iMin;

290 
Sèt3Sam∂e
 *
pSam∂e
;

291 
i
;

292 
u32
 
h
;

294 
	`UNUSED_PARAMETER
(
c⁄ãxt
);

295 
	`UNUSED_PARAMETER
(
¨gc
);

296 if–
nEq
==0 ) ;

297 
h
 = 
p
->
iP∫
 =Ö->iPrn*1103515245 + 12345;

298 if–(
nLt
/
p
->
nPSam∂e
)!=((
nEq
+nLt)/p->nPSample) ){

299 
doIn£π
 = 
isPSam∂e
 = 1;

300 }if–
p
->
nSam∂e
<p->
mxSam∂e
 ){

301 
doIn£π
 = 1;

303 if–
nEq
>
p
->
a
[
iMö
].nEq || (nEq=ı->a[iMö].nEq && 
h
>p->a[iMö].
iHash
) ){

304 
doIn£π
 = 1;

307 if–!
doIn£π
 ) ;

308 if–
p
->
nSam∂e
=ı->
mxSam∂e
 ){

309 *
pKey
 = 
p
->
a
[
iMö
].pKey;

310 
nAŒoc
 = 
p
->
a
[
iMö
].nAlloc;

311 
	`as£π
–
p
->
nSam∂e
 - 
iMö
 - 1 >= 0 );

312 
	`memmove
(&
p
->
a
[
iMö
], &p->a[iMö+1], ’->a[0])*’->
nSam∂e
-iMin-1));

313 
pSam∂e
 = &
p
->
a
[p->
nSam∂e
-1];

314 
	`mem£t
(
pSam∂e
, 0, (
Sèt3Sam∂e
));

315 
pSam∂e
->
pKey
 =ÖKey;

316 
pSam∂e
->
nAŒoc
 =ÇAlloc;

318 
pSam∂e
 = &
p
->
a
[p->
nSam∂e
++];

321 
pKey
 = 
	`sqlôe4_vÆue_blob
(
¨gv
[3], &
nKey
);

322 if–
nKey
>
pSam∂e
->
nAŒoc
 ){

323 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

324 
nReq
 = 
nKey
*4;

325 
pSam∂e
->
pKey
 = 
	`sqlôe4DbRóŒocOrFªe
(
db
,ÖSam∂e->pKey, 
nReq
);

326 if–
pSam∂e
->
pKey
==0 ) ;

327 
pSam∂e
->
nAŒoc
 = 
nReq
;

329 
	`mem˝y
(
pSam∂e
->
pKey
,ÖKey, 
nKey
);

330 
pSam∂e
->
nKey
 =ÇKey;

331 
pSam∂e
->
nEq
 =ÇEq;

332 
pSam∂e
->
nLt
 =ÇLt;

333 
pSam∂e
->
nDLt
 =ÇDLt;

334 
pSam∂e
->
iHash
 = 
h
;

335 
pSam∂e
->
isPSam∂e
 = isPSample;

338 if–
p
->
nSam∂e
=ı->
mxSam∂e
 ){

339 
pSam∂e
 = 
p
->
a
;

340 
i
 = 0;

341  
pSam∂e
->
isPSam∂e
 ){

342 
i
++;

343 
pSam∂e
++;

344 
	`as£π
–
i
<
p
->
nSam∂e
 );

346 
nEq
 = 
pSam∂e
->nEq;

347 
h
 = 
pSam∂e
->
iHash
;

348 
iMö
 = 
i
;

349 
i
++, 
pSam∂e
++; i<
p
->
nSam∂e
; i++,ÖSample++){

350 if–
pSam∂e
->
isPSam∂e
 ) ;

351 if–
pSam∂e
->
nEq
<nEq

352 || (
pSam∂e
->
nEq
=ÚEq &&ÖSam∂e->
iHash
<
h
)

354 
iMö
 = 
i
;

355 
nEq
 = 
pSam∂e
->nEq;

356 
h
 = 
pSam∂e
->
iHash
;

359 
p
->
iMö
 = iMin;

361 
	}
}

362 c⁄° 
FuncDef
 
	g°©3PushFuncdef
 = {

367 
°©3Push
,

388 
	$°©3Gë
(

389 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

390 
¨gc
,

391 
sqlôe4_vÆue
 **
¨gv


393 
n
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[1]);

394 
Sèt3Accum
 *
p
 = (Sèt3Accum*)
	`sqlôe4_vÆue_blob
(
¨gv
[0], 0);

396 
	`as£π
–
p
!=0 );

397 if–
p
->
nSam∂e
<=
n
 ) ;

398  
¨gc
 ){

399 2: 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
p
->
a
[
n
].
nEq
); ;

400 3: 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
p
->
a
[
n
].
nLt
); ;

401 4: 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
p
->
a
[
n
].
nDLt
); ;

403 
	`as£π
–
¨gc
==5 );

404 
	`sqlôe4_ªsu…_blob
(

405 
c⁄ãxt
, 
p
->
a
[
n
].
pKey
,Ö->a[n].
nKey
, 
SQLITE4_TRANSIENT
, 0

410 
	}
}

411 c⁄° 
FuncDef
 
	g°©3GëFuncdef
 = {

416 
°©3Gë
,

429 
	$™ÆyzeO√TabÀ
(

430 
P¨£
 *
pP¨£
,

431 
TabÀ
 *
pTab
,

432 
Index
 *
pO∆yIdx
,

433 
iSètCur
,

434 
iMem


436 
sqlôe4
 *
db
 = 
pP¨£
->db;

437 
Index
 *
pIdx
;

438 
iIdxCur
;

439 
Vdbe
 *
v
;

440 
i
;

441 
t›OfLo›
;

442 
ídOfLo›
;

443 
jZîoRows
 = -1;

444 
iDb
;

445 
ªgTab«me
 = 
iMem
++;

446 
ªgIdx«me
 = 
iMem
++;

447 
ªgSèt1
 = 
iMem
++;

448 #ifde‡
SQLITE4_ENABLE_STAT3


449 
ªgNumEq
 = 
ªgSèt1
;

450 
ªgNumLt
 = 
iMem
++;

451 
ªgNumDLt
 = 
iMem
++;

452 
ªgSam∂e
 = 
iMem
++;

453 
ªgAccum
 = 
iMem
++;

454 
ªgLo›
 = 
iMem
++;

455 
ªgCou¡
 = 
iMem
++;

456 
ªgTemp1
 = 
iMem
++;

457 
ªgTemp2
 = 
iMem
++;

458 
ªgNewSam∂e
 = 
iMem
++;

459 
⁄˚
 = 1;

460 
iTabCur
 = 
pP¨£
->
nTab
++;

461 
addrEq
;

463 
ªgRec
 = 
iMem
++;

464 
ªgTemp
 = 
iMem
++;

465 
ªgNewRowid
 = 
iMem
++;

467 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

468 if–
v
==0 || 
	`NEVER
(
pTab
==0) ){

471 if–
pTab
->
pIndex
==0 ){

475 if–
	`sqlôe4_°∫icmp
(
pTab
->
zName
, "sqlite_", 7)==0 ){

479 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

480 
	`as£π
–
iDb
>=0 );

481 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


482 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_ANALYZE
, 
pTab
->
zName
, 0,

483 
db
->
aDb
[
iDb
].
zName
 ) ){

488 
iIdxCur
 = 
pP¨£
->
nTab
++;

489 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgTab«me
, 0, 
pTab
->
zName
, 0);

490 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

491 
nCﬁ
;

492 
KeyInfo
 *
pKey
;

493 
ªgC¡
;

494 
ªgPªv
;

495 
¨egC¨d
;

496 #ifde‡
SQLITE4_ENABLE_STAT3


497 
addrAddimm
;

498 
addrI¢uŒ
;

501 if–
pO∆yIdx
 &&ÖO∆yIdx!=
pIdx
 ) ;

502 
	`VdbeNo›Commít
((
v
, "Begöá«lysi†o‡%s", 
pIdx
->
zName
));

503 
nCﬁ
 = 
pIdx
->
nCﬁumn
;

504 
pKey
 = 
	`sqlôe4IndexKeyöfo
(
pP¨£
, 
pIdx
);

505 if–
iMem
+1+(
nCﬁ
*2)>
pP¨£
->
nMem
 ){

506 
pP¨£
->
nMem
 = 
iMem
+1+(
nCﬁ
*2);

510 
	`as£π
–
iDb
==
	`sqlôe4SchemaToIndex
(
db
, 
pIdx
->
pSchema
) );

511 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_O≥nRód
, 
iIdxCur
, 
pIdx
->
äum
, 
iDb
,

512 (*)
pKey
, 
P4_KEYINFO_HANDOFF
);

513 
	`VdbeCommít
((
v
, "%s", 
pIdx
->
zName
));

516 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgIdx«me
, 0, 
pIdx
->
zName
, 0);

518 #ifde‡
SQLITE4_ENABLE_STAT3


519 if–
⁄˚
 ){

520 
⁄˚
 = 0;

521 
	`sqlôe4O≥nTabÀ
(
pP¨£
, 
iTabCur
, 
iDb
, 
pTab
, 
OP_O≥nRód
);

524 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgNumEq
);

525 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgNumLt
);

526 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgNumDLt
);

528 
	`as£π
–
ªgAccum
==
ªgSam∂e
+1 );

529 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NuŒ
, 0, 
ªgSam∂e
, 
ªgAccum
);

530 
	`as£π
–
ªgTemp1
==
ªgCou¡
+1 );

531 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Cou¡
, 
iIdxCur
, 
ªgCou¡
);

532 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
SQLITE4_STAT3_SAMPLES
, 
ªgTemp1
);

533 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Fun˘i⁄
, 1, 
ªgCou¡
, 
ªgAccum
,

534 (*)&
°©3InôFuncdef
, 
P4_FUNCDEF
);

535 
	`sqlôe4VdbeCh™geP5
(
v
, 2);

551 
ªgC¡
 = 
iMem
;

552 
ªgPªv
 = 
iMem
+1;

553 
¨egC¨d
 = 
iMem
+2;

555 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgC¡
);

556 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgPªv
);

557 #ifde‡
SQLITE4_ENABLE_STAT3


558 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgSam∂e
);

560 
i
=0; i<
nCﬁ
; i++){

561 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
¨egC¨d
+
i
);

566 
ídOfLo›
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

567 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
iIdxCur
, 
ídOfLo›
);

568 
t›OfLo›
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

569 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgC¡
, 1);

570 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_A«lyzeKey
, 
iIdxCur
, 
ªgPªv
, 
¨egC¨d
, 
nCﬁ
);

572 #ifde‡
SQLITE4_ENABLE_STAT3


573 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iIdxCur
, 
ªgNewSam∂e
);

574 
	`sqlôe4VdbeCh™geP5
(
v
, 1);

575 
addrEq
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Eq
, 
ªgNewSam∂e
, 0, 
ªgSam∂e
);

576 
addrI¢uŒ
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
ªgSam∂e
, 0);

578 
	`as£π
–
ªgNumEq
==
ªgNumLt
-1 &&ÑegNumEq==
ªgNumDLt
-2

579 && 
ªgNumEq
==
ªgSam∂e
-3 &&ÑegNumEq==
ªgAccum
-4

581 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Fun˘i⁄
, 1, 
ªgNumEq
, 
ªgTemp2
,

582 (*)&
°©3PushFuncdef
, 
P4_FUNCDEF


584 
	`sqlôe4VdbeCh™geP5
(
v
, 5);

585 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Add
, 
ªgNumEq
, 
ªgNumLt
,ÑegNumLt);

586 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgNumDLt
, 1);

588 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrI¢uŒ
);

589 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgNumEq
);

590 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
ªgNewSam∂e
, 
ªgSam∂e
);

591 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrEq
);

592 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgNumEq
, 1);

596 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
ídOfLo›
);

598 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iIdxCur
, 
t›OfLo›
);

599 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iIdxCur
);

601 #ifde‡
SQLITE4_ENABLE_STAT3


603 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Fun˘i⁄
, 1, 
ªgNumEq
, 
ªgTemp2
,

604 (*)&
°©3PushFuncdef
, 
P4_FUNCDEF
);

605 
	`sqlôe4VdbeCh™geP5
(
v
, 5);

610 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, -1, 
ªgLo›
);

611 
addrAddimm
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgLo›
, 1);

612 
i
=0; i<4; i++){

613 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Fun˘i⁄
, 1, 
ªgAccum
, 
ªgNumEq
+
i
);

614 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (*)&
°©3GëFuncdef
, 
P4_FUNCDEF
);

615 
	`sqlôe4VdbeCh™geP5
(
v
, 
i
+2);

617 
addrI¢uŒ
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IsNuŒ
, 
ªgNumEq
);

618 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_MakeRec‹d
, 
ªgTab«me
, 6, 
ªgRec
, "bbbbbb", 0);

619 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
iSètCur
+1, 
ªgNewRowid
);

620 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iSètCur
+1, 
ªgRec
, 
ªgNewRowid
);

621 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrAddimm
);

622 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrI¢uŒ
);

643 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
iMem
, 
ªgSèt1
);

644 if–
jZîoRows
<0 ){

645 
jZîoRows
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfNŸ
, 
iMem
);

647 
i
=0; i<
nCﬁ
; i++){

648 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgTemp
, 0, " ", 0);

649 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgTemp
, 
ªgSèt1
,ÑegStat1);

650 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Add
, 
iMem
, 
¨egC¨d
+
i
, 
ªgTemp
);

651 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgTemp
, -1);

652 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Divide
, 
¨egC¨d
+
i
, 
ªgTemp
,ÑegTemp);

653 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_ToI¡
, 
ªgTemp
);

654 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgTemp
, 
ªgSèt1
,ÑegStat1);

656 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_MakeRec‹d
, 
ªgTab«me
, 3, 
ªgRec
, "aaa", 0);

657 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
iSètCur
, 
ªgNewRowid
);

658 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iSètCur
, 
ªgRec
, 
ªgNewRowid
);

661 
	`sqlôe4VdbeJumpHîe
(
v
, 
jZîoRows
);

662 
jZîoRows
 = 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_GŸo
);

663 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgIdx«me
);

664 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_MakeRec‹d
, 
ªgTab«me
, 3, 
ªgRec
, "aaa", 0);

665 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
iSètCur
, 
ªgNewRowid
);

666 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iSètCur
, 
ªgRec
, 
ªgNewRowid
);

667 if–
pP¨£
->
nMem
<
ªgRec
 )ÖParse->nMem =ÑegRec;

668 
	`sqlôe4VdbeJumpHîe
(
v
, 
jZîoRows
);

669 
	}
}

675 
	$lﬂdA«lysis
(
P¨£
 *
pP¨£
, 
iDb
){

676 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

677 if–
v
 ){

678 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_LﬂdA«lysis
, 
iDb
);

680 
	}
}

685 
	$™ÆyzeD©aba£
(
P¨£
 *
pP¨£
, 
iDb
){

686 
sqlôe4
 *
db
 = 
pP¨£
->db;

687 
Schema
 *
pSchema
 = 
db
->
aDb
[
iDb
].pSchema;

688 
HashEÀm
 *
k
;

689 
iSètCur
;

690 
iMem
;

692 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

693 
iSètCur
 = 
pP¨£
->
nTab
;

694 
pP¨£
->
nTab
 += 3;

695 
	`›íSètTabÀ
(
pP¨£
, 
iDb
, 
iSètCur
, 0, 0);

696 
iMem
 = 
pP¨£
->
nMem
+1;

697 
k
=
	`sqlôeHashFú°
(&
pSchema
->
tblHash
); k; k=
	`sqlôeHashNext
(k)){

698 
TabÀ
 *
pTab
 = (TabÀ*)
	`sqlôeHashD©a
(
k
);

699 
	`™ÆyzeO√TabÀ
(
pP¨£
, 
pTab
, 0, 
iSètCur
, 
iMem
);

701 
	`lﬂdA«lysis
(
pP¨£
, 
iDb
);

702 
	}
}

709 
	$™ÆyzeTabÀ
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, 
Index
 *
pO∆yIdx
){

710 
iDb
;

711 
iSètCur
;

713 
	`as£π
–
pTab
!=0 );

714 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

715 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

716 
iSètCur
 = 
pP¨£
->
nTab
;

717 
pP¨£
->
nTab
 += 3;

718 if–
pO∆yIdx
 ){

719 
	`›íSètTabÀ
(
pP¨£
, 
iDb
, 
iSètCur
, 
pO∆yIdx
->
zName
, "idx");

721 
	`›íSètTabÀ
(
pP¨£
, 
iDb
, 
iSètCur
, 
pTab
->
zName
, "tbl");

723 
	`™ÆyzeO√TabÀ
(
pP¨£
, 
pTab
, 
pO∆yIdx
, 
iSètCur
,ÖP¨£->
nMem
+1);

724 
	`lﬂdA«lysis
(
pP¨£
, 
iDb
);

725 
	}
}

739 
	$sqlôe4A«lyze
(
P¨£
 *
pP¨£
, 
Tokí
 *
pName1
, Tokí *
pName2
){

740 
sqlôe4
 *
db
 = 
pP¨£
->db;

741 
iDb
;

742 
i
;

743 *
z
, *
zDb
;

744 
TabÀ
 *
pTab
;

745 
Index
 *
pIdx
;

746 
Tokí
 *
pTabÀName
;

750 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

754 
	`as£π
–
pName2
!=0 || 
pName1
==0 );

755 if–
pName1
==0 ){

757 
i
=0; i<
db
->
nDb
; i++){

758 if–
i
==1 ) ;

759 
	`™ÆyzeD©aba£
(
pP¨£
, 
i
);

761 }if–
pName2
->
n
==0 ){

763 
iDb
 = 
	`sqlôe4FödDb
(
db
, 
pName1
);

764 if–
iDb
>=0 ){

765 
	`™ÆyzeD©aba£
(
pP¨£
, 
iDb
);

767 
z
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName1
);

768 if–
z
 ){

769 if–(
pTab
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 0, 
z
, 0))!=0 ){

770 
	`™ÆyzeTabÀ
(
pP¨£
, 
pTab
, 0);

771 }if–(
pIdx
 = 
	`sqlôe4FödIndex
(
db
, 
z
, 0))!=0 ){

772 
	`™ÆyzeTabÀ
(
pP¨£
, 
pIdx
->
pTabÀ
,ÖIdx);

774 
	`sqlôe4DbFªe
(
db
, 
z
);

779 
iDb
 = 
	`sqlôe4TwoP¨tName
(
pP¨£
, 
pName1
, 
pName2
, &
pTabÀName
);

780 if–
iDb
>=0 ){

781 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

782 
z
 = 
	`sqlôe4NameFromTokí
(
db
, 
pTabÀName
);

783 if–
z
 ){

784 if–(
pTab
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 0, 
z
, 
zDb
))!=0 ){

785 
	`™ÆyzeTabÀ
(
pP¨£
, 
pTab
, 0);

786 }if–(
pIdx
 = 
	`sqlôe4FödIndex
(
db
, 
z
, 
zDb
))!=0 ){

787 
	`™ÆyzeTabÀ
(
pP¨£
, 
pIdx
->
pTabÀ
,ÖIdx);

789 
	`sqlôe4DbFªe
(
db
, 
z
);

793 
	}
}

799 
™ÆysisInfo
 
	t™ÆysisInfo
;

800 
	s™ÆysisInfo
 {

801 
sqlôe4
 *
	mdb
;

802 c⁄° *
	mzD©aba£
;

816 
	$™ÆysisLﬂdî
(

817 *
pD©a
,

818 
nVÆ
,

819 
sqlôe4_vÆue
 **
≠VÆ
,

820 c⁄° **
NŸU£d


822 
™ÆysisInfo
 *
pInfo
 = (™ÆysisInfo*)
pD©a
;

823 
Index
 *
pIndex
;

824 
TabÀ
 *
pTabÀ
;

825 
i
, 
c
, 
n
;

826 
tRow˙t
 
v
;

828 c⁄° *
zTab
 = 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[0], 0);

829 c⁄° *
zIdx
 = 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[1], 0);

830 c⁄° *
z
 = 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[2], 0);

832 
	`as£π
–
nVÆ
==3 );

833 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
nVÆ
);

835 if–
zTab
==0 || 
zIdx
==0 || 
z
==0 )  0;

837 
pTabÀ
 = 
	`sqlôe4FödTabÀ
(
pInfo
->
db
, 
zTab
,ÖInfo->
zD©aba£
);

838 if–
pTabÀ
==0 ){

841 
pIndex
 = 
	`sqlôe4FödIndex
(
pInfo
->
db
, 
zIdx
,ÖInfo->
zD©aba£
);

843 
n
 = 
pIndex
 ?ÖIndex->
nCﬁumn
 : 0;

844 
i
=0; *
z
 && i<=
n
; i++){

845 
v
 = 0;

846  (
c
=
z
[0])>='0' && c<='9' ){

847 
v
 = v*10 + 
c
 - '0';

848 
z
++;

850 if–
i
==0 ) 
pTabÀ
->
nRowE°
 = 
v
;

851 if–
pIndex
==0 ) ;

852 
pIndex
->
aiRowE°
[
i
] = 
v
;

853 if–*
z
==' ' ) z++;

855 if–
	`°rcmp
(
z
, "unordered")==0 ){

856 
pIndex
->
bUn‹dîed
 = 1;

862 
	}
}

868 
	$sqlôe4DñëeIndexSam∂es
(
sqlôe4
 *
db
, 
Index
 *
pIdx
){

869 #ifde‡
SQLITE4_ENABLE_STAT3


870 
	`sqlôe4DbFªe
(
db
, 
pIdx
->
aSam∂e
);

871 if–
db
 && db->
≤ByãsFªed
==0 ){

872 
pIdx
->
nSam∂e
 = 0;

873 
pIdx
->
aSam∂e
 = 0;

876 
	`UNUSED_PARAMETER
(
db
);

877 
	`UNUSED_PARAMETER
(
pIdx
);

879 
	}
}

881 #ifde‡
SQLITE4_ENABLE_STAT3


886 
	$lﬂdSèt3
(
sqlôe4
 *
db
, c⁄° *
zDb
){

887 
rc
;

888 
sqlôe4_°mt
 *
pStmt
 = 0;

889 *
zSql
;

890 
Index
 *
pPªvIdx
 = 0;

891 
idx
 = 0;

892 
IndexSam∂e
 *
pSam∂e
;

893 
u8
 *
pS∑˚
;

895 
	`as£π
–
db
->
lookaside
.
bE«bÀd
==0 );

896 if–!
	`sqlôe4FödTabÀ
(
db
, "sqlôe_°©3", 
zDb
) ){

897  
SQLITE4_OK
;

900 
zSql
 = 
	`sqlôe4MPrötf
(
db
,

902 " GROUP BY idx", 
zDb
);

903 if–!
zSql
 ){

904  
SQLITE4_NOMEM
;

906 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

907 
	`sqlôe4DbFªe
(
db
, 
zSql
);

908 if–
rc
 ) Ñc;

910  
	`sqlôe4_°ï
(
pStmt
)==
SQLITE4_ROW
 ){

911 *
zIndex
;

912 
Index
 *
pIdx
;

913 
nSam∂e
;

914 
nS∑˚
;

915 
nAŒoc
;

917 
zIndex
 = (*)
	`sqlôe4_cﬁumn_ãxt
(
pStmt
, 0, 0);

918 if–
zIndex
==0 ) ;

919 
nSam∂e
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 1);

920 
nS∑˚
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 2);

921 
pIdx
 = 
	`sqlôe4FödIndex
(
db
, 
zIndex
, 
zDb
);

922 if–
pIdx
==0 ) ;

923 
	`as£π
–
pIdx
->
nSam∂e
==0 );

924 
nAŒoc
 = 
nSam∂e
*(
IndexSam∂e
Ë+ 
nS∑˚
;

925 
pIdx
->
nSam∂e
 =ÇSample;

926 
pIdx
->
aSam∂e
 = (
IndexSam∂e
*)
	`sqlôe4DbMÆlocZîo
(
db
, 
nAŒoc
);

927 
pIdx
->
avgEq
 =ÖIdx->
aiRowE°
[1];

928 if–
pIdx
->
aSam∂e
==0 ){

929 
db
->
mÆlocFaûed
 = 1;

930 
	`sqlôe4_föÆize
(
pStmt
);

931  
SQLITE4_NOMEM
;

934 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

935 if–
rc
 ) Ñc;

937 
zSql
 = 
	`sqlôe4MPrötf
(
db
,

938 "SELECT idx,√q,∆t,nd…,ßm∂êFROM %Q.sqlôe_°©3", 
zDb
);

939 if–!
zSql
 ){

940  
SQLITE4_NOMEM
;

942 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

943 
	`sqlôe4DbFªe
(
db
, 
zSql
);

944 if–
rc
 ) Ñc;

946  
	`sqlôe4_°ï
(
pStmt
)==
SQLITE4_ROW
 ){

947 *
zIndex
;

948 
Index
 *
pIdx
;

949 
i
;

950 
tRow˙t
 
sumEq
;

951 c⁄° 
u8
 *
aVÆ
;

952 
nVÆ
;

954 
zIndex
 = (*)
	`sqlôe4_cﬁumn_ãxt
(
pStmt
, 0, 0);

955 if–
zIndex
==0 ) ;

956 
pIdx
 = 
	`sqlôe4FödIndex
(
db
, 
zIndex
, 
zDb
);

957 if–
pIdx
==0 ) ;

958 if–
pIdx
==
pPªvIdx
 ){

959 
idx
++;

961 
pPªvIdx
 = 
pIdx
;

962 
idx
 = 0;

963 
pS∑˚
 = (
u8
*)&
pIdx
->
aSam∂e
[pIdx->
nSam∂e
];

965 
	`as£π
–
idx
<
pIdx
->
nSam∂e
 );

966 
pSam∂e
 = &
pIdx
->
aSam∂e
[
idx
];

967 
pSam∂e
->
nEq
 = (
tRow˙t
)
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 1);

968 
pSam∂e
->
nLt
 = (
tRow˙t
)
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 2);

969 
pSam∂e
->
nDLt
 = (
tRow˙t
)
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 3);

970 if–
idx
==
pIdx
->
nSam∂e
-1 ){

971 if–
pSam∂e
->
nDLt
>0 ){

972 
i
=0, 
sumEq
=0; i<=
idx
-1; i++ËsumEq +
pIdx
->
aSam∂e
[i].
nEq
;

973 
pIdx
->
avgEq
 = (
pSam∂e
->
nLt
 - 
sumEq
)/pSam∂e->
nDLt
;

975 if–
pIdx
->
avgEq
<=0 )ÖIdx->avgEq = 1;

978 
aVÆ
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 4, &
nVÆ
);

979 
pSam∂e
->
aVÆ
 = 
pS∑˚
;

980 
pSam∂e
->
nVÆ
 =ÇVal;

981 
	`mem˝y
(
pSam∂e
->
aVÆ
,áVÆ, 
nVÆ
);

982 
pS∑˚
 +
nVÆ
;

984  
	`sqlôe4_föÆize
(
pStmt
);

985 
	}
}

1008 
	$sqlôe4A«lysisLﬂd
(
sqlôe4
 *
db
, 
iDb
){

1009 
™ÆysisInfo
 
sInfo
;

1010 
HashEÀm
 *
i
;

1011 *
zSql
;

1012 
rc
;

1014 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

1015 
	`as£π
–
db
->
aDb
[
iDb
].
pKV
!=0 );

1018 
i
=
	`sqlôeHashFú°
(&
db
->
aDb
[
iDb
].
pSchema
->
idxHash
);i;i=
	`sqlôeHashNext
(i)){

1019 
Index
 *
pIdx
 = 
	`sqlôeHashD©a
(
i
);

1020 
	`sqlôe4DeÁu…RowE°
(
pIdx
);

1021 #ifde‡
SQLITE4_ENABLE_STAT3


1022 
	`sqlôe4DñëeIndexSam∂es
(
db
, 
pIdx
);

1023 
pIdx
->
aSam∂e
 = 0;

1028 
sInfo
.
db
 = db;

1029 
sInfo
.
zD©aba£
 = 
db
->
aDb
[
iDb
].
zName
;

1030 if–
	`sqlôe4FödTabÀ
(
db
, "sqlôe_°©1", 
sInfo
.
zD©aba£
)==0 ){

1031  
SQLITE4_ERROR
;

1035 
zSql
 = 
	`sqlôe4MPrötf
(
db
,

1036 "SELECTÅbl,idx,°© FROM %Q.sqlôe_°©1", 
sInfo
.
zD©aba£
);

1037 if–
zSql
==0 ){

1038 
rc
 = 
SQLITE4_NOMEM
;

1040 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
™ÆysisLﬂdî
, &
sInfo
);

1041 
	`sqlôe4DbFªe
(
db
, 
zSql
);

1046 #ifde‡
SQLITE4_ENABLE_STAT3


1047 if–
rc
==
SQLITE4_OK
 ){

1048 
lookasideE«bÀd
 = 
db
->
lookaside
.
bE«bÀd
;

1049 
db
->
lookaside
.
bE«bÀd
 = 0;

1050 
rc
 = 
	`lﬂdSèt3
(
db
, 
sInfo
.
zD©aba£
);

1051 
db
->
lookaside
.
bE«bÀd
 = 
lookasideE«bÀd
;

1055 if–
rc
==
SQLITE4_NOMEM
 ){

1056 
db
->
mÆlocFaûed
 = 1;

1058  
rc
;

1059 
	}
}

	@src/attach.c

14 
	~"sqlôeI¡.h
"

16 #i‚de‡
SQLITE4_OMIT_ATTACH


35 
	$ªsﬁveAâachEx¥
(
NameC⁄ãxt
 *
pName
, 
Ex¥
 *
pEx¥
)

37 
rc
 = 
SQLITE4_OK
;

38 if–
pEx¥
 ){

39 if–
pEx¥
->
›
!=
TK_ID
 ){

40 
rc
 = 
	`sqlôe4ResﬁveEx¥Names
(
pName
, 
pEx¥
);

41 if–
rc
==
SQLITE4_OK
 && !
	`sqlôe4Ex¥IsC⁄°™t
(
pEx¥
) ){

42 
	`sqlôe4Eº‹Msg
(
pName
->
pP¨£
, "övÆidÇame: \"%s\"", 
pEx¥
->
u
.
zTokí
);

43  
SQLITE4_ERROR
;

46 
pEx¥
->
›
 = 
TK_STRING
;

49  
rc
;

50 
	}
}

63 
	$©èchFunc
(

64 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

65 
NŸU£d
,

66 
sqlôe4_vÆue
 **
¨gv


68 
i
;

69 
rc
 = 0;

70 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

71 c⁄° *
zName
;

72 c⁄° *
zFûe
;

73 *
zP©h
 = 0;

74 *
zEº
 = 0;

75 
Êags
;

76 
Db
 *
aNew
;

77 *
zEºDyn
 = 0;

79 
	`UNUSED_PARAMETER
(
NŸU£d
);

81 
zFûe
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

82 
zName
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0);

83 if–
zFûe
==0 ) zFile = "";

84 if–
zName
==0 ) zName = "";

92 if–
db
->
nDb
>=db->
aLimô
[
SQLITE4_LIMIT_ATTACHED
]+2 ){

93 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
, "too manyáttached databases - max %d",

94 
db
->
aLimô
[
SQLITE4_LIMIT_ATTACHED
]

96 
©èch_îr‹
;

98 if–
db
->
pSavïoöt
 ){

99 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
, "cannot ATTACH database withinÅransaction");

100 
©èch_îr‹
;

102 
i
=0; i<
db
->
nDb
; i++){

103 *
z
 = 
db
->
aDb
[
i
].
zName
;

104 
	`as£π
–
z
 && 
zName
 );

105 if–
	`sqlôe4_°ricmp
(
z
, 
zName
)==0 ){

106 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
, "d©aba£ %†i†Æªady i¿u£", 
zName
);

107 
©èch_îr‹
;

114 if–
db
->
aDb
==db->
aDbSètic
 ){

115 
aNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (db->
aDb
[0])*3 );

116 if–
aNew
==0 ) ;

117 
	`mem˝y
(
aNew
, 
db
->
aDb
, (db->aDb[0])*2);

119 
aNew
 = 
	`sqlôe4DbRóŒoc
(
db
, db->
aDb
, (db->aDb[0])*(db->
nDb
+1) );

120 if–
aNew
==0 ) ;

122 
db
->
aDb
 = 
aNew
;

123 
aNew
 = &
db
->
aDb
[db->
nDb
];

124 
	`mem£t
(
aNew
, 0, (*aNew));

130 
Êags
 = 
db
->
›íFœgs
;

131 
rc
 = 
	`sqlôe4P¨£Uri
(
db
->
pEnv
, 
zFûe
, &
Êags
, &
zP©h
, &
zEº
);

132 if–
rc
!=
SQLITE4_OK
 ){

133 if–
rc
==
SQLITE4_NOMEM
 ) 
db
->
mÆlocFaûed
 = 1;

134 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

135 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zEº
);

138 
rc
 = 
	`sqlôe4KVSt‹eO≥n
(
db
, 
zName
, 
zP©h
, &
aNew
->
pKV
, 
Êags
);

139 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zP©h
);

140 
db
->
nDb
++;

141 if–
rc
==
SQLITE4_CONSTRAINT
 ){

142 
rc
 = 
SQLITE4_ERROR
;

143 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
, "database isálreadyáttached");

144 }if–
rc
==
SQLITE4_OK
 ){

145 
aNew
->
pSchema
 = 
	`sqlôe4SchemaGë
(
db
);

146 if–!
aNew
->
pSchema
 ){

147 
rc
 = 
SQLITE4_NOMEM
;

148 }if–
aNew
->
pSchema
->
fûe_f‹m©
 &&áNew->pSchema->
íc
!=
	`ENC
(
db
) ){

149 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
,

151 
rc
 = 
SQLITE4_ERROR
;

154 
aNew
->
zName
 = 
	`sqlôe4DbSåDup
(
db
, zName);

155 if–
rc
==
SQLITE4_OK
 && 
aNew
->
zName
==0 ){

156 
rc
 = 
SQLITE4_NOMEM
;

164 if–
rc
==
SQLITE4_OK
 ){

165 
rc
 = 
	`sqlôe4Inô
(
db
, &
zEºDyn
);

167 if–
rc
 ){

168 
iDb
 = 
db
->
nDb
 - 1;

169 
	`as£π
–
iDb
>=2 );

170 if–
db
->
aDb
[
iDb
].
pKV
 ){

171 
	`sqlôe4KVSt‹eClo£
(
db
->
aDb
[
iDb
].
pKV
);

172 
db
->
aDb
[
iDb
].
pKV
 = 0;

173 
db
->
aDb
[
iDb
].
pSchema
 = 0;

175 
	`sqlôe4Re£tI¡î«lSchema
(
db
, -1);

176 
db
->
nDb
 = 
iDb
;

177 if–
rc
==
SQLITE4_NOMEM
 ||Ñc==
SQLITE4_IOERR_NOMEM
 ){

178 
db
->
mÆlocFaûed
 = 1;

179 
	`sqlôe4DbFªe
(
db
, 
zEºDyn
);

180 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
, "out of memory");

181 }if–
zEºDyn
==0 ){

182 
zEºDyn
 = 
	`sqlôe4MPrötf
(
db
, "u«bÀÅÿ›í d©aba£: %s", 
zFûe
);

184 
©èch_îr‹
;

189 
©èch_îr‹
:

191 if–
zEºDyn
 ){

192 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEºDyn
, -1);

193 
	`sqlôe4DbFªe
(
db
, 
zEºDyn
);

195 if–
rc
 ) 
	`sqlôe4_ªsu…_îr‹_code
(
c⁄ãxt
,Ñc);

196 
	}
}

206 
	$dëachFunc
(

207 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

208 
NŸU£d
,

209 
sqlôe4_vÆue
 **
¨gv


211 c⁄° *
zName
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

212 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

213 
i
;

214 
Db
 *
pDb
 = 0;

215 
zEº
[128];

217 
	`UNUSED_PARAMETER
(
NŸU£d
);

219 if–
zName
==0 ) zName = "";

220 
i
=0; i<
db
->
nDb
; i++){

221 
pDb
 = &
db
->
aDb
[
i
];

222 if–
pDb
->
pKV
==0 ) ;

223 if–
	`sqlôe4_°ricmp
(
pDb
->
zName
, zName)==0 ) ;

226 if–
i
>=
db
->
nDb
 ){

227 
	`sqlôe4_¢¥ötf
(
zEº
,(zEº), "nÿsuch d©aba£: %s", 
zName
);

228 
dëach_îr‹
;

230 if–
i
<2 ){

231 
	`sqlôe4_¢¥ötf
(
zEº
,(zEº), "ˇ¬Ÿ dëach d©aba£ %s", 
zName
);

232 
dëach_îr‹
;

234 if–
db
->
pSavïoöt
 ){

235 
	`sqlôe4_¢¥ötf
(
zEº
,(zErr),

237 
dëach_îr‹
;

239 if–
pDb
->
pKV
->
iTønsLevñ
 ){

240 
	`sqlôe4_¢¥ötf
(
zEº
,(zEº), "d©aba£ %†i†locked", 
zName
);

241 
dëach_îr‹
;

244 
	`sqlôe4KVSt‹eClo£
(
pDb
->
pKV
);

245 
pDb
->
pKV
 = 0;

246 
	`sqlôe4SchemaCÀ¨
(
db
->
pEnv
, 
pDb
->
pSchema
);

247 
	`sqlôe4DbFªe
(
db
, 
pDb
->
pSchema
);

248 
pDb
->
pSchema
 = 0;

249 
	`sqlôe4Re£tI¡î«lSchema
(
db
, -1);

252 
dëach_îr‹
:

253 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

254 
	}
}

260 
	$codeAâach
(

261 
P¨£
 *
pP¨£
,

262 
ty≥
,

263 
FuncDef
 c⁄° *
pFunc
,

264 
Ex¥
 *
pAuthArg
,

265 
Ex¥
 *
pFûíame
,

266 
Ex¥
 *
pDb«me
,

267 
Ex¥
 *
pKey


269 
rc
;

270 
NameC⁄ãxt
 
sName
;

271 
Vdbe
 *
v
;

272 
sqlôe4
* 
db
 = 
pP¨£
->db;

273 
ªgArgs
;

275 
	`mem£t
(&
sName
, 0, (
NameC⁄ãxt
));

276 
sName
.
pP¨£
 =ÖParse;

279 
SQLITE4_OK
!=(
rc
 = 
	`ªsﬁveAâachEx¥
(&
sName
, 
pFûíame
)) ||

280 
SQLITE4_OK
!=(
rc
 = 
	`ªsﬁveAâachEx¥
(&
sName
, 
pDb«me
)) ||

281 
SQLITE4_OK
!=(
rc
 = 
	`ªsﬁveAâachEx¥
(&
sName
, 
pKey
))

283 
pP¨£
->
nEº
++;

284 
©èch_íd
;

287 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


288 if–
pAuthArg
 ){

289 *
zAuthArg
;

290 if–
pAuthArg
->
›
==
TK_STRING
 ){

291 
zAuthArg
 = 
pAuthArg
->
u
.
zTokí
;

293 
zAuthArg
 = 0;

295 
rc
 = 
	`sqlôe4AuthCheck
(
pP¨£
, 
ty≥
, 
zAuthArg
, 0, 0);

296 if(
rc
!=
SQLITE4_OK
 ){

297 
©èch_íd
;

303 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

304 
ªgArgs
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 4);

305 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pFûíame
, 
ªgArgs
);

306 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pDb«me
, 
ªgArgs
+1);

307 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pKey
, 
ªgArgs
+2);

309 
	`as£π
–
v
 || 
db
->
mÆlocFaûed
 );

310 if–
v
 ){

311 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Fun˘i⁄
, 0, 
ªgArgs
+3-
pFunc
->
nArg
,ÑegArgs+3);

312 
	`as£π
–
pFunc
->
nArg
==-1 || (pFunc->nArg&0xff)==pFunc->nArg );

313 
	`sqlôe4VdbeCh™geP5
(
v
, (
u8
)(
pFunc
->
nArg
));

314 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (*)
pFunc
, 
P4_FUNCDEF
);

320 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Expúe
, (
ty≥
==
SQLITE4_ATTACH
));

323 
©èch_íd
:

324 
	`sqlôe4Ex¥Dñëe
(
db
, 
pFûíame
);

325 
	`sqlôe4Ex¥Dñëe
(
db
, 
pDb«me
);

326 
	`sqlôe4Ex¥Dñëe
(
db
, 
pKey
);

327 
	}
}

334 
	$sqlôe4Dëach
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pDb«me
){

335 c⁄° 
FuncDef
 
dëach_func
 = {

340 
dëachFunc
,

347 
	`codeAâach
(
pP¨£
, 
SQLITE4_DETACH
, &
dëach_func
, 
pDb«me
, 0, 0,ÖDbname);

348 
	}
}

355 
	$sqlôe4Aâach
(
P¨£
 *
pP¨£
, 
Ex¥
 *
p
, Ex¥ *
pDb«me
, Ex¥ *
pKey
){

356 c⁄° 
FuncDef
 
©èch_func
 = {

361 
©èchFunc
,

368 
	`codeAâach
(
pP¨£
, 
SQLITE4_ATTACH
, &
©èch_func
, 
p
,Ö, 
pDb«me
, 
pKey
);

369 
	}
}

379 
	$sqlôe4FixInô
(

380 
DbFixî
 *
pFix
,

381 
P¨£
 *
pP¨£
,

382 
iDb
,

383 c⁄° *
zTy≥
,

384 c⁄° 
Tokí
 *
pName


386 
sqlôe4
 *
db
;

388 if–
	`NEVER
(
iDb
<0) || iDb==1 )  0;

389 
db
 = 
pP¨£
->db;

390 
	`as£π
–
db
->
nDb
>
iDb
 );

391 
pFix
->
pP¨£
 =ÖParse;

392 
pFix
->
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

393 
pFix
->
zTy≥
 = zType;

394 
pFix
->
pName
 =ÖName;

396 
	}
}

412 
	$sqlôe4FixSrcLi°
(

413 
DbFixî
 *
pFix
,

414 
SrcLi°
 *
pLi°


416 
i
;

417 c⁄° *
zDb
;

418 
SrcLi°Iãm
 *
pIãm
;

420 if–
	`NEVER
(
pLi°
==0) )  0;

421 
zDb
 = 
pFix
->zDb;

422 
i
=0, 
pIãm
=
pLi°
->
a
; i<pLi°->
nSrc
; i++,ÖItem++){

423 if–
pIãm
->
zD©aba£
==0 ){

424 
pIãm
->
zD©aba£
 = 
	`sqlôe4DbSåDup
(
pFix
->
pP¨£
->
db
, 
zDb
);

425 }if–
	`sqlôe4_°ricmp
(
pIãm
->
zD©aba£
,
zDb
)!=0 ){

426 
	`sqlôe4Eº‹Msg
(
pFix
->
pP¨£
,

428 
pFix
->
zTy≥
,ÖFix->
pName
, 
pIãm
->
zD©aba£
);

431 #i‡!
	`deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed(
SQLITE4_OMIT_TRIGGER
)

432 if–
	`sqlôe4FixSñe˘
(
pFix
, 
pIãm
->
pSñe˘
) )  1;

433 if–
	`sqlôe4FixEx¥
(
pFix
, 
pIãm
->
pOn
) )  1;

437 
	}
}

438 #i‡!
deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed(
SQLITE4_OMIT_TRIGGER
)

439 
	$sqlôe4FixSñe˘
(

440 
DbFixî
 *
pFix
,

441 
Sñe˘
 *
pSñe˘


443  
pSñe˘
 ){

444 if–
	`sqlôe4FixEx¥Li°
(
pFix
, 
pSñe˘
->
pELi°
) ){

447 if–
	`sqlôe4FixSrcLi°
(
pFix
, 
pSñe˘
->
pSrc
) ){

450 if–
	`sqlôe4FixEx¥
(
pFix
, 
pSñe˘
->
pWhîe
) ){

453 if–
	`sqlôe4FixEx¥
(
pFix
, 
pSñe˘
->
pHavög
) ){

456 
pSñe˘
 =ÖSñe˘->
pPri‹
;

459 
	}
}

460 
	$sqlôe4FixEx¥
(

461 
DbFixî
 *
pFix
,

462 
Ex¥
 *
pEx¥


464  
pEx¥
 ){

465 if–
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_TokíO∆y
) ) ;

466 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

467 if–
	`sqlôe4FixSñe˘
(
pFix
, 
pEx¥
->
x
.
pSñe˘
) )  1;

469 if–
	`sqlôe4FixEx¥Li°
(
pFix
, 
pEx¥
->
x
.
pLi°
) )  1;

471 if–
	`sqlôe4FixEx¥
(
pFix
, 
pEx¥
->
pRight
) ){

474 
pEx¥
 =ÖEx¥->
pLe·
;

477 
	}
}

478 
	$sqlôe4FixEx¥Li°
(

479 
DbFixî
 *
pFix
,

480 
Ex¥Li°
 *
pLi°


482 
i
;

483 
Ex¥Li°Iãm
 *
pIãm
;

484 if–
pLi°
==0 )  0;

485 
i
=0, 
pIãm
=
pLi°
->
a
; i<pLi°->
nEx¥
; i++,ÖItem++){

486 if–
	`sqlôe4FixEx¥
(
pFix
, 
pIãm
->
pEx¥
) ){

491 
	}
}

494 #i‚de‡
SQLITE4_OMIT_TRIGGER


495 
	$sqlôe4FixTriggîSãp
(

496 
DbFixî
 *
pFix
,

497 
TriggîSãp
 *
pSãp


499  
pSãp
 ){

500 if–
	`sqlôe4FixSñe˘
(
pFix
, 
pSãp
->
pSñe˘
) ){

503 if–
	`sqlôe4FixEx¥
(
pFix
, 
pSãp
->
pWhîe
) ){

506 if–
	`sqlôe4FixEx¥Li°
(
pFix
, 
pSãp
->
pEx¥Li°
) ){

509 
pSãp
 =ÖSãp->
pNext
;

512 
	}
}

	@src/auth.c

17 
	~"sqlôeI¡.h
"

23 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


30 
	sAuth‹izî
 {

31 *
	mpCtx
;

32 (*
	mxAuth
)(*,,const *,const *,const *,const *);

33 (*
	mxDe°roy
)(*);

34 
Auth‹izî
 *
	mpNext
;

40 
sqlôe4_auth‹izî_push
(

41 
sqlôe4
 *
db
,

42 *
pCtx
,

43 (*
xAuth
)(*,,const *,const *,const *,const *),

44 (*
xDe°roy
)(*)

46 
rc
 = 
SQLITE4_OK
;

47 
Auth‹izî
 *
pNew
;

49 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

51 
pNew
 = (
Auth‹izî
 *)
	`sqlôe4DbMÆlocZîo
(
db
, (Authorizer));

52 if–
pNew
==0 ){

53 
rc
 = 
SQLITE4_NOMEM
;

54 if–
xDe°roy
 ) 
	`xDe°roy
(
pCtx
);

56 
pNew
->
pCtx
 =ÖCtx;

57 
pNew
->
xAuth
 = xAuth;

58 
pNew
->
xDe°roy
 = xDestroy;

59 
pNew
->
pNext
 = 
db
->
pAuth
;

60 
db
->
pAuth
 = 
pNew
;

61 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

64 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

65  
rc
;

66 
	}
}

72 
	$authP›Sèck
(
sqlôe4
 *
db
){

73 
Auth‹izî
 *
pAuth
 = 
db
->pAuth;

74 
db
->
pAuth
 =ÖAuth->
pNext
;

75 if–
pAuth
->
xDe°roy
 ){

76 
pAuth
->
	`xDe°roy
’Auth->
pCtx
);

78 
	`sqlôe4DbFªe
(
db
, 
pAuth
);

79 
	}
}

84 
	$sqlôe4_auth‹izî_p›
(
sqlôe4
 *
db
){

85 
rc
 = 
SQLITE4_OK
;

86 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

88 if–
db
->
pAuth
==0 ){

89 
rc
 = 
SQLITE4_ERROR
;

91 
	`authP›Sèck
(
db
);

93 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

94 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

95  
rc
;

96 
	}
}

102 
	$sqlôe4AuthFªeAŒ
(
sqlôe4
 *
db
){

103  
db
->
pAuth
 ){

104 
	`authP›Sèck
(
db
);

106 
	}
}

112 
	$authBadRëu∫Code
(
P¨£
 *
pP¨£
){

113 
	`sqlôe4Eº‹Msg
(
pP¨£
, "authorizer malfunction");

114 
pP¨£
->
rc
 = 
SQLITE4_ERROR
;

115 
	}
}

124 
	$authInvokeSèck
(

125 
P¨£
 *
pP¨£
,

126 
eAuth
,

127 c⁄° *
z1
,

128 c⁄° *
z2
,

129 c⁄° *
z3
,

130 c⁄° *
z4


132 
rc
 = 
SQLITE4_OK
;

133 
Auth‹izî
 *
p
;

135 
p
=
pP¨£
->
db
->
pAuth
;Ö;Öı->
pNext
){

136 
rˇuth
 = 
p
->
	`xAuth
’->
pCtx
, 
eAuth
, 
z1
, 
z2
, 
z3
, 
z4
);

137 if–
rˇuth
!=
SQLITE4_OK
 ){

138  
rˇuth
 ){

139 
SQLITE4_IGNORE
:

140 
SQLITE4_DENY
:

141 
rc
 = 
rˇuth
;

144 
SQLITE4_ALLOW
:

148 
	`authBadRëu∫Code
(
pP¨£
);

149 
rc
 = 
SQLITE4_DENY
;

155 
	`as£π
–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_DENY
 ||Ñc==
SQLITE4_IGNORE
 );

156  
rc
;

157 
	}
}

168 
	$sqlôe4AuthRódCﬁ
(

169 
P¨£
 *
pP¨£
,

170 c⁄° *
zTab
,

171 c⁄° *
zCﬁ
,

172 
iDb


174 c⁄° *
zAuthC⁄ãxt
 = 
pP¨£
->zAuthContext;

175 
sqlôe4
 *
db
 = 
pP¨£
->db;

176 *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

177 
rc
;

179 
rc
 = 
	`authInvokeSèck
(
pP¨£
, 
SQLITE4_READ
, 
zTab
, 
zCﬁ
, 
zDb
, 
zAuthC⁄ãxt
);

180 if–
rc
==
SQLITE4_DENY
 && 
pP¨£
->rc==
SQLITE4_OK
 ){

181 if–
db
->
nDb
>2 || 
iDb
!=0 ){

182 
	`sqlôe4Eº‹Msg
(
pP¨£
, "ac˚s†tÿ%s.%s.%†i†¥ohibôed",
zDb
,
zTab
,
zCﬁ
);

184 
	`sqlôe4Eº‹Msg
(
pP¨£
, "ac˚s†tÿ%s.%†i†¥ohibôed", 
zTab
, 
zCﬁ
);

186 
pP¨£
->
rc
 = 
SQLITE4_AUTH
;

189  
rc
;

190 
	}
}

201 
	$sqlôe4AuthRód
(

202 
P¨£
 *
pP¨£
,

203 
Ex¥
 *
pEx¥
,

204 
Schema
 *
pSchema
,

205 
SrcLi°
 *
pTabLi°


207 
sqlôe4
 *
db
 = 
pP¨£
->db;

208 
TabÀ
 *
pTab
 = 0;

209 c⁄° *
zCﬁ
;

210 
iSrc
;

211 
iDb
;

212 
iCﬁ
;

214 if–
db
->
pAuth
==0 ) ;

215 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pSchema
);

216 if–
iDb
<0 ){

222 
	`as£π
–
pEx¥
->
›
==
TK_COLUMN
 ||ÖEx¥->›==
TK_TRIGGER
 );

223 if–
pEx¥
->
›
==
TK_TRIGGER
 ){

224 
pTab
 = 
pP¨£
->
pTriggîTab
;

226 
	`as£π
–
pTabLi°
 );

227 
iSrc
=0; 
	`ALWAYS
(iSrc<
pTabLi°
->
nSrc
); iSrc++){

228 if–
pEx¥
->
iTabÀ
==
pTabLi°
->
a
[
iSrc
].
iCurs‹
 ){

229 
pTab
 = 
pTabLi°
->
a
[
iSrc
].pTab;

234 
iCﬁ
 = 
pEx¥
->
iCﬁumn
;

235 if–
	`NEVER
(
pTab
==0) ) ;

237 if–
iCﬁ
>=0 ){

238 
	`as£π
–
iCﬁ
<
pTab
->
nCﬁ
 );

239 
zCﬁ
 = 
pTab
->
aCﬁ
[
iCﬁ
].
zName
;

241 
zCﬁ
 = "ROWID";

243 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

244 if–
SQLITE4_IGNORE
==
	`sqlôe4AuthRódCﬁ
(
pP¨£
, 
pTab
->
zName
, 
zCﬁ
, 
iDb
) ){

245 
pEx¥
->
›
 = 
TK_NULL
;

247 
	}
}

255 
	$sqlôe4AuthCheck
(

256 
P¨£
 *
pP¨£
,

257 
code
,

258 c⁄° *
zArg1
,

259 c⁄° *
zArg2
,

260 c⁄° *
zArg3


262 
sqlôe4
 *
db
 = 
pP¨£
->db;

263 
rc
;

268 if–
db
->
öô
.
busy
 || 
IN_DECLARE_VTAB
 ){

269  
SQLITE4_OK
;

272 
rc
 = 
	`authInvokeSèck
(
pP¨£
, 
code
, 
zArg1
, 
zArg2
, 
zArg3
,ÖP¨£->
zAuthC⁄ãxt
);

273 if–
rc
==
SQLITE4_DENY
 && 
pP¨£
->rc==
SQLITE4_OK
 ){

274 
	`sqlôe4Eº‹Msg
(
pP¨£
, "notáuthorized");

275 
pP¨£
->
rc
 = 
SQLITE4_AUTH
;

278  
rc
;

279 
	}
}

286 
	$sqlôe4AuthC⁄ãxtPush
(

287 
P¨£
 *
pP¨£
,

288 
AuthC⁄ãxt
 *
pC⁄ãxt
,

289 c⁄° *
zC⁄ãxt


291 
	`as£π
–
pP¨£
 );

292 
pC⁄ãxt
->
pP¨£
 =ÖParse;

293 
pC⁄ãxt
->
zAuthC⁄ãxt
 = 
pP¨£
->zAuthContext;

294 
pP¨£
->
zAuthC⁄ãxt
 = 
zC⁄ãxt
;

295 
	}
}

301 
	$sqlôe4AuthC⁄ãxtP›
(
AuthC⁄ãxt
 *
pC⁄ãxt
){

302 if–
pC⁄ãxt
->
pP¨£
 ){

303 
pC⁄ãxt
->
pP¨£
->
zAuthC⁄ãxt
 =ÖContext->zAuthContext;

304 
pC⁄ãxt
->
pP¨£
 = 0;

306 
	}
}

	@src/bt.h

15 #i‚de‡
__BT_H


16 
	#__BT_H


	)

18 
	~<sqlôe4.h
>

20 
bt_db
 
	tbt_db
;

21 
bt_curs‹
 
	tbt_curs‹
;

26 
	#BT_SEEK_LEFAST
 -2

	)

27 
	#BT_SEEK_LE
 -1

	)

28 
	#BT_SEEK_EQ
 0

	)

29 
	#BT_SEEK_GE
 1

	)

34 
sqlôe4BtNew
(
sqlôe4_ív
*, 
nExåa
, 
bt_db
 **
µDb
);

35 
sqlôe4BtClo£
(
bt_db
*);

36 *
sqlôe4BtExåa
(
bt_db
*);

41 
sqlôe4BtO≥n
(
bt_db
*, c⁄° *
zFûíame
);

84 
sqlôe4BtBegö
(
bt_db
*, 
iLevñ
);

85 
sqlôe4BtCommô
(
bt_db
*, 
iLevñ
);

86 
sqlôe4BtRﬁlback
(
bt_db
*, 
iLevñ
);

87 
sqlôe4BtTønß˘i⁄Levñ
(
bt_db
*);

92 
sqlôe4BtC§O≥n
(
bt_db
*, 
nExåa
, 
bt_curs‹
 **
µC§
);

93 
sqlôe4BtC§Clo£
(
bt_curs‹
 *
pC§
);

94 *
sqlôe4BtC§Exåa
(
bt_curs‹
 *
pC§
);

104 
sqlôe4BtC§Sìk
(
bt_curs‹
 *
pC§
, c⁄° *
pK
, 
nK
, 
eSìk
);

106 
sqlôe4BtC§Fú°
(
bt_curs‹
 *
pC§
);

107 
sqlôe4BtC§La°
(
bt_curs‹
 *
pC§
);

109 
sqlôe4BtC§Next
(
bt_curs‹
 *
pC§
);

110 
sqlôe4BtC§Pªv
(
bt_curs‹
 *
pC§
);

112 
sqlôe4BtC§Key
(
bt_curs‹
 *
pC§
, c⁄° **
µK
, *
≤K
);

113 
sqlôe4BtC§D©a
(
bt_curs‹
 *
pC§
, , , c⁄° **
µV
, *
≤V
);

115 
sqlôe4BtRïœ˚
(
bt_db
*, c⁄° *
pK
, 
nK
, c⁄° *
pV
, 
nV
);

116 
sqlôe4BtDñëe
(
bt_curs‹
*);

118 
sqlôe4BtSëCookõ
(
bt_db
*, 
iVÆ
);

119 
sqlôe4BtGëCookõ
(
bt_db
*, *
piVÆ
);

181 
	#BT_CONTROL_INFO
 7706389

	)

182 
	#BT_CONTROL_SETVFS
 7706390

	)

183 
	#BT_CONTROL_GETVFS
 7706391

	)

184 
	#BT_CONTROL_SAFETY
 7706392

	)

185 
	#BT_CONTROL_AUTOCKPT
 7706393

	)

186 
	#BT_CONTROL_LOGSIZE
 7706394

	)

187 
	#BT_CONTROL_MULTIPROC
 7706395

	)

188 
	#BT_CONTROL_LOGSIZECB
 7706396

	)

189 
	#BT_CONTROL_CHECKPOINT
 7706397

	)

190 
	#BT_CONTROL_FAST_INSERT_OP
 7706498

	)

191 
	#BT_CONTROL_BLKSZ
 7706499

	)

192 
	#BT_CONTROL_PAGESZ
 7706500

	)

194 
sqlôe4BtC⁄åﬁ
(
bt_db
*, 
›
, *
pArg
);

196 
	#BT_SAFETY_OFF
 0

	)

197 
	#BT_SAFETY_NORMAL
 1

	)

198 
	#BT_SAFETY_FULL
 2

	)

200 
bt_öfo
 
	tbt_öfo
;

201 
	sbt_öfo
 {

202 
	meTy≥
;

203 
	mpgno
;

204 
sqlôe4_buf„r
 
	mouçut
;

207 
	#BT_INFO_PAGEDUMP
 1

	)

208 
	#BT_INFO_FILENAME
 2

	)

209 
	#BT_INFO_HDRDUMP
 3

	)

210 
	#BT_INFO_PAGEDUMP_ASCII
 4

	)

211 
	#BT_INFO_BLOCK_FREELIST
 5

	)

212 
	#BT_INFO_PAGE_FREELIST
 6

	)

213 
	#BT_INFO_PAGE_LEAKS
 7

	)

215 
bt_logsizecb
 
	tbt_logsizecb
;

216 
	sbt_logsizecb
 {

217 *
	mpCtx
;

218 (*
	mxLogsize
)(*, );

221 
bt_checkpoöt
 
	tbt_checkpoöt
;

222 
	sbt_checkpoöt
 {

223 
	mnFømeBuf„r
;

224 
	mnCk±
;

230 
bt_ív
 
	tbt_ív
;

231 
bt_fûe
 
	tbt_fûe
;

236 
	sbt_ív
 {

237 *
	mpVfsCtx
;

238 (*
	mxFuŒ∑th
)(
	msqlôe4_ív
*,
	mbt_ív
*, const *, **);

239 (*
	mxO≥n
)(
	msqlôe4_ív
*,
	mbt_ív
*, c⁄° *, 
	mÊags
, 
	mbt_fûe
**);

240 (*
	mxSize
)(
	mbt_fûe
*, 
	msqlôe4_öt64
*);

241 (*
	mxRód
)(
	mbt_fûe
*, 
	msqlôe4_öt64
, *, );

242 (*
	mxWrôe
)(
	mbt_fûe
*, 
	msqlôe4_öt64
, *, );

243 (*
	mxTrunˇã
)(
	mbt_fûe
*, 
	msqlôe4_öt64
);

244 (*
	mxSync
)(
	mbt_fûe
*);

245 (*
	mxSe˘‹Size
)(
	mbt_fûe
*);

246 (*
	mxClo£
)(
	mbt_fûe
*);

247 (*
	mxU∆ök
)(
	msqlôe4_ív
*,
	mbt_ív
*, const *);

248 (*
	mxLock
)(
	mbt_fûe
*, , );

249 (*
	mxTe°Lock
)(
	mbt_fûe
*, , , );

250 (*
	mxShmM≠
)(
	mbt_fûe
*, , , **);

251 (*
	mxShmB¨rõr
)(
	mbt_fûe
*);

252 (*
	mxShmUnm≠
)(
	mbt_fûe
*, );

258 
	#BT_OPEN_DATABASE
 0x0001

	)

259 
	#BT_OPEN_LOG
 0x0002

	)

260 
	#BT_OPEN_SHARED
 0x0004

	)

261 
	#BT_OPEN_READONLY
 0x0008

	)

	@src/btInt.h

15 
	~"bt.h
"

19 
sqlôe4_öt64
 
	ti64
;

20 
sqlôe4_uöt64
 
	tu64
;

21 
	tu32
;

22 
	tu16
;

23 
	tu8
;

25 
BtDbHdr
 
	tBtDbHdr
;

32 
	#BT_BLOCKFULL
 -1

	)

36 
	#¨øy_size
(
x
Ë((x)/(x[0]))

	)

39 
	#BT_NREADER
 4

	)

41 #i‚de‡
MIN


42 
	#MIN
(
a
,
b
Ë((◊)<(b))?◊):(b))

	)

44 #i‚de‡
MAX


45 
	#MAX
(
a
,
b
Ë((◊)>(b))?◊):(b))

	)

49 
	#BT_DEFAULT_PGSZ
 1024

	)

52 
	#BT_DEFAULT_BLKSZ
 (512*1024)

	)

55 
	#BT_DEFAULT_CACHESZ
 1000

	)

81 
	#BT_DBHDR_STRING
 "SQLôe4 bàd©aba£ 0001"

	)

82 
	sBtDbHdr
 {

83 
	mazSå
[24];

84 
u32
 
	mpgsz
;

85 
u32
 
	mblksz
;

86 
u32
 
	mnPg
;

88 
u32
 
	miRoŸ
;

89 
u32
 
	miMRoŸ
;

90 
u32
 
	miSRoŸ
;

92 
u32
 
	miSubBlock
;

93 
u32
 
	mnSubPg
;

95 
u32
 
	miCookõ
;

96 
u32
 
	miFªePg
;

97 
u32
 
	miFªeBlk
;

106 
BtScheduÀ
 
	tBtScheduÀ
;

107 
	sBtScheduÀ
 {

108 
u32
 
	meBusy
;

109 
u32
 
	miAge
;

110 
u32
 
	miMöLevñ
;

111 
u32
 
	miMaxLevñ
;

112 
u32
 
	miOutLevñ
;

113 
u32
 
	maBlock
[32];

115 
u32
 
	miNextPg
;

116 
u32
 
	miNextCñl
;

117 
u32
 
	miFªeLi°
;

118 
u32
 
	maRoŸ
[32];

121 
	#BT_SCHEDULE_EMPTY
 0

	)

122 
	#BT_SCHEDULE_BUSY
 1

	)

123 
	#BT_SCHEDULE_DONE
 2

	)

125 
sqlôe4BtMîge
(
bt_db
 *
db
, 
BtDbHdr
 *
pHdr
, 
u8
 *
aSched
);

130 
BtPage
 
	tBtPage
;

131 
BtPagî
 
	tBtPagî
;

136 
sqlôe4BtPagîNew
(
sqlôe4_ív
*, 
nExåa
, 
BtPagî
 **
µ
);

137 
sqlôe4BtPagîClo£
(
BtPagî
*);

138 *
sqlôe4BtPagîExåa
(
BtPagî
*);

143 
sqlôe4BtPagîO≥n
(
BtPagî
*, c⁄° *
zFûíame
);

149 
sqlôe4BtPagîBegö
(
BtPagî
*, 
iLevñ
);

150 
sqlôe4BtPagîCommô
(
BtPagî
*, 
iLevñ
);

151 
sqlôe4BtPagîRevît
(
BtPagî
*, 
iLevñ
);

152 
sqlôe4BtPagîRﬁlback
(
BtPagî
*, 
iLevñ
);

153 
sqlôe4BtPagîTønß˘i⁄Levñ
(
BtPagî
*);

158 
sqlôe4BtPagîPagesize
(
BtPagî
*);

164 
BtDbHdr
 *
sqlôe4BtPagîDbhdr
(
BtPagî
*);

165 
sqlôe4BtPagîDbhdrDúty
(
BtPagî
*);

170 
sqlôe4BtPagîSëDbhdr
(
BtPagî
 *, 
BtDbHdr
 *);

175 
sqlôe4BtPageGë
(
BtPagî
*, 
u32
 
pgno
, 
BtPage
 **
µPage
);

176 
sqlôe4BtPageTrimPgno
(
BtPagî
*, 
u32
 
pgno
);

177 
sqlôe4BtPageWrôe
(
BtPage
*);

178 
sqlôe4BtPageTrim
(
BtPage
*);

179 
sqlôe4BtPageRñó£
(
BtPage
*);

180 
sqlôe4BtPageRe„ªn˚
(
BtPage
*);

185 
sqlôe4BtPageAŒoˇã
(
BtPagî
*, 
BtPage
 **
µPage
);

186 
sqlôe4BtBlockAŒoˇã
(
BtPagî
*, 
nBlk
, 
u32
 *
piBlk
);

189 
sqlôe4BtBlockTrim
(
BtPagî
*, 
u32
);

194 
u32
 
sqlôe4BtPagePgno
(
BtPage
*);

195 *
sqlôe4BtPageD©a
(
BtPage
*);

200 
sqlôe4BtPagîRefcou¡
(
BtPagî
*);

205 
sqlôe4BtPagîSëCookõ
(
BtPagî
*, 
u32
 
iVÆ
);

206 
sqlôe4BtPagîGëCookõ
(
BtPagî
*, 
u32
 *
piVÆ
);

211 
	#BT_PAGERFILE_DATABASE
 0

	)

212 
	#BT_PAGERFILE_LOG
 1

	)

213 
	#BT_PAGERFILE_SHM
 2

	)

214 c⁄° *
sqlôe4BtPagîFûíame
(
BtPagî
*, 
ePagîfûe
);

216 
bt_ív
 *
sqlôe4BtPagîGëEnv
(
BtPagî
*);

217 
sqlôe4BtPagîSëEnv
(
BtPagî
*, 
bt_ív
*);

219 
sqlôe4BtPagîSëSa„ty
(
BtPagî
*, *);

220 
sqlôe4BtPagîSëAutock±
(
BtPagî
*, *);

222 
sqlôe4BtPagîLogsize
(
BtPagî
*, *);

223 
sqlôe4BtPagîMu…ùroc
(
BtPagî
 *
pPagî
, *
piVÆ
);

224 
sqlôe4BtPagîLogsizeCb
(
BtPagî
 *
pPagî
, 
bt_logsizecb
*);

225 
sqlôe4BtPagîCheckpoöt
(
BtPagî
 *
pPagî
, 
bt_checkpoöt
*);

227 
sqlôe4BtPagîHdrdump
(
BtPagî
 *
pPagî
, 
sqlôe4_buf„r
 *
pBuf
);

232 
sqlôe4BtPagîRawWrôe
(
BtPagî
 *
pPagî
, 
u32
 
pgno
, 
u8
 *
aBuf
);

243 
	#BT_LOCK_UNLOCK
 0

	)

244 
	#BT_LOCK_SHARED
 1

	)

245 
	#BT_LOCK_EXCL
 2

	)

248 
	#BT_SHM_CHUNK_SIZE
 (48*1024)

	)

251 
bt_ív
 *
sqlôe4BtEnvDeÁu…
();

262 
sqlôe4BtV¨ötPut32
(
u8
 *, );

263 
sqlôe4BtV¨ötGë32
(
u8
 *, *);

264 
sqlôe4BtV¨ötPut64
(
u8
 *
aD©a
, 
i64
 
iVÆ
);

265 
sqlôe4BtV¨ötGë64
(c⁄° 
u8
 *
aD©a
, 
i64
 *
piVÆ
);

266 
sqlôe4BtV¨ötLí32
();

267 
sqlôe4BtV¨ötSize
(
u8
 
c
);

275 
BtLog
 
	tBtLog
;

276 
sqlôe4BtLogO≥n
(
BtPagî
*, 
bRecovî
, 
BtLog
**);

277 
sqlôe4BtLogClo£
(
BtLog
*, 
bCÀ™up
);

279 
sqlôe4BtLogRód
(
BtLog
*, 
u32
 
pgno
, 
u8
 *
aD©a
);

280 
sqlôe4BtLogWrôe
(
BtLog
*, 
u32
 
pgno
, 
u8
 *
aD©a
, u32 
nPg
);

282 
sqlôe4BtLogS«pshŸO≥n
(
BtLog
*);

283 
sqlôe4BtLogS«pshŸClo£
(
BtLog
*);

285 
sqlôe4BtLogS«pshŸWrôe
(
BtLog
*);

286 
sqlôe4BtLogS«pshŸEndWrôe
(
BtLog
*);

288 
sqlôe4BtLogSize
(
BtLog
*);

289 
sqlôe4BtLogCheckpoöt
(
BtLog
*, );

291 
sqlôe4BtLogFømeToIdx
(
u32
 *
aLog
, u32 
iFøme
);

294 
sqlôe4BtLogPagesize
(
BtLog
*);

295 
sqlôe4BtLogPagecou¡
(
BtLog
*);

296 
u32
 
sqlôe4BtLogCookõ
(
BtLog
*);

298 
BtDbHdr
 *
sqlôe4BtLogDbhdr
(
BtLog
*);

300 
sqlôe4BtLogSëCookõ
(
BtLog
*, 
u32
 
iCookõ
);

301 
sqlôe4BtLogDbhdrFlush
(
BtLog
*);

302 
sqlôe4BtLogRñﬂdDbHdr
(
BtLog
*);

311 
BtSh¨ed
 
	tBtSh¨ed
;

312 
BtLock
 
	tBtLock
;

313 
BtRódSlŸ
 
	tBtRódSlŸ
;

314 
BtFûe
 
	tBtFûe
;

316 
	sBtLock
 {

319 
sqlôe4_ív
 *
	mpEnv
;

320 
bt_ív
 *
	mpVfs
;

321 
bt_fûe
 *
	mpFd
;

322 
	miDebugId
;

333 
	miSa„tyLevñ
;

334 
	mnAutoCk±
;

335 
	mbReque°Mu…iProc
;

336 
	mnBlksz
;

337 
	mnPgsz
;

340 
BtSh¨ed
 *
	mpSh¨ed
;

341 
BtLock
 *
	mpNext
;

342 
u32
 
	mmEx˛Lock
;

343 
u32
 
	mmSh¨edLock
;

344 
BtFûe
 *
	mpBtFûe
;

346 
u8
 *
	maU£d
;

349 
	sBtRódSlŸ
 {

350 
u32
 
	miFú°
;

351 
u32
 
	miLa°
;

355 
sqlôe4BtLockC⁄√˘
(
BtLock
*, (*
xRecovî
)(BtLock*));

356 
	`sqlôe4BtLockDisc⁄√˘
(
BtLock
*, (*
xCk±
)(BtLock*), (*
xDñ
)(BtLock*));

359 
	`sqlôe4BtLockWrôî
(
BtLock
*);

360 
	`sqlôe4BtLockWrôîU∆ock
(
BtLock
*);

363 
	`sqlôe4BtLockCk±
(
BtLock
*);

364 
	`sqlôe4BtLockCk±U∆ock
(
BtLock
*);

367 
	`sqlôe4BtLockRódî
(
BtLock
*, 
u32
 *
aLog
, u32 
iFú°
, 
BtRódSlŸ
 *
aLock
);

368 
	`sqlôe4BtLockRódîU∆ock
(
BtLock
*);

371 
	`sqlôe4BtLockRódîQuîy
(
BtLock
*, 
u32
*, 
BtRódSlŸ
*, u32*, *);

374 
	`sqlôe4BtLockShmM≠
(
BtLock
*, 
iChunk
, 
nByã
, 
u8
 **
µOut
);

383 
	`sqlôe4BtPutU32
(
u8
 *
a
, 
u32
 
i
);

384 
u32
 
	`sqlôe4BtGëU32
(c⁄° 
u8
 *
a
);

385 
	`sqlôe4BtBufAµídf
(
sqlôe4_buf„r
 *
pBuf
, c⁄° *
zF‹m©
, ...);

391 #ifde‡
NDEBUG


392 
	#sqlôe4BtDebugRódPage
(
a
,
b
,
c
,
d
)

	)

393 
	#sqlôe4BtDebugKV
(
a
,
b
,
c
,
d
,
e
,
f
)

	)

394 
	#sqlôe4BtDebugRódlock
(
a
,
b
,
c
)

	)

395 
	#sqlôe4BtDebugPageAŒoc
(
a
,
b
,
c
)

	)

396 
	#sqlôe4BtDebugPageFªe
(
a
,
b
,
c
,
d
)

	)

397 
	#btEº‹Bk±
(
x
Ë
	)
x

399 
	`sqlôe4BtDebugRódPage
(
BtLock
 *
pLock
, 
u32
 
pgno
, 
u8
 *
aD©a
, 
pgsz
);

400 
	`sqlôe4BtDebugKV
(
BtLock
*, c⁄° *,
u8
 *
pK
, 
nK
, u8 *
pV
, 
nV
);

401 
	`sqlôe4BtDebugRódlock
(
BtLock
 *
pLock
, 
u32
 
iFú°
, u32 
iLa°
);

402 
	`sqlôe4BtDebugPageAŒoc
(
BtLock
 *
pLock
, c⁄° *, 
u32
);

403 
	`sqlôe4BtDebugPageFªe
(
BtLock
 *
pLock
, , c⁄° *, 
u32
);

404 
	`btEº‹Bk±
(
rc
);

	@src/bt_lock.c

15 
	~"sqlôeI¡.h
"

16 
	~"btI¡.h
"

18 
	~<°rög.h
>

19 
	~<as£π.h
>

20 
	~<°dio.h
>

22 
	#BT_LOCK_DMS1
 0

	)

23 
	#BT_LOCK_DMS2_RW
 1

	)

24 
	#BT_LOCK_DMS2_RO
 2

	)

25 
	#BT_LOCK_WRITER
 3

	)

26 
	#BT_LOCK_CKPTER
 4

	)

27 
	#BT_LOCK_READER_DBONLY
 5

	)

28 
	#BT_LOCK_READER0
 6

	)

30 
	#BT_LOCK_UNLOCK
 0

	)

31 
	#BT_LOCK_SHARED
 1

	)

32 
	#BT_LOCK_EXCL
 2

	)

48 
	sBtSh¨edD©a
 {

49 
BtSh¨ed
 *
	mpD©aba£
;

50 
	miDebugId
;

51 } 
	ggBtSh¨ed
 = {0, 0};

53 
	sBtFûe
 {

54 
BtFûe
 *
	mpNext
;

55 
bt_fûe
 *
	mpFd
;

58 
	sBtSh¨ed
 {

60 *
	mzName
;

61 
	mnName
;

62 
	mnRef
;

63 
BtSh¨ed
 *
	mpNext
;

66 
sqlôe4_muãx
 *
	mpClõ¡Muãx
;

67 
	mnShmChunk
;

68 
u8
 **
	m≠ShmChunk
;

69 
BtLock
 *
	mpLock
;

72 
	mbMu…iProc
;

73 
	mbRód⁄ly
;

74 
bt_fûe
 *
	mpFûe
;

75 
BtFûe
 *
	mpBtFûe
;

82 
	$btLockMuãxE¡î
(
sqlôe4_ív
 *
pEnv
){

83 
	`sqlôe4_muãx_íãr
(
	`sqlôe4_muãx_Æloc
(
pEnv
, 
SQLITE4_MUTEX_STATIC_KV
));

84 
	}
}

89 
	$btLockMuãxLóve
(
sqlôe4_ív
 *
pEnv
){

90 
	`sqlôe4_muãx_Àave
(
	`sqlôe4_muãx_Æloc
(
pEnv
, 
SQLITE4_MUTEX_STATIC_KV
));

91 
	}
}

97 
	$btLockSh¨edFûe
(
BtLock
 *
p
, 
iLock
, 
eOp
){

98 
rc
 = 
SQLITE4_OK
;

99 
BtSh¨ed
 *
pSh¨ed
 = 
p
->pShared;

102 
	`as£π
–(
pSh¨ed
->
bMu…iProc
==0)==’Sh¨ed->
pFûe
==0) );

103 if–
pSh¨ed
->
pFûe
 ){

104 
rc
 = 
p
->
pVfs
->
	`xLock
(
pSh¨ed
->
pFûe
, 
iLock
, 
eOp
);

106  
rc
;

107 
	}
}

109 
	$btLockLock›N⁄blockög
(

110 
BtLock
 *
p
,

111 
iLock
,

112 
eOp


114 c⁄° 
u32
 
mask
 = ((u32)1 << 
iLock
);

115 
rc
 = 
SQLITE4_OK
;

116 
BtSh¨ed
 *
pSh¨ed
 = 
p
->pShared;

118 
	`as£π
–
iLock
>=0 && iLock<(
BT_LOCK_READER0
 + 
BT_NREADER
) );

119 
	`as£π
–(
BT_LOCK_READER0
+
BT_NREADER
)<=32 );

120 
	`as£π
–
eOp
==
BT_LOCK_UNLOCK
 ||ÉOp==
BT_LOCK_SHARED
 ||ÉOp==
BT_LOCK_EXCL
 );

123 if–(
eOp
==
BT_LOCK_UNLOCK
 && (
mask
 & (
p
->
mEx˛Lock
|p->
mSh¨edLock
))!=0)

124 || (
eOp
==
BT_LOCK_SHARED
 && (
mask
 & 
p
->
mSh¨edLock
)==0)

125 || (
eOp
==
BT_LOCK_EXCL
 && (
mask
 & 
p
->
mEx˛Lock
)==0)

127 
BtLock
 *
pIãr
;

128 
nEx˛
 = 0;

129 
nSh¨ed
 = 0;

130 
	`sqlôe4_muãx_íãr
(
pSh¨ed
->
pClõ¡Muãx
);

134 
pIãr
=
pSh¨ed
->
pLock
;ÖIãr;ÖIãrıIãr->
pNext
){

135 
	`as£π
–(
pIãr
->
mEx˛Lock
 &ÖIãr->
mSh¨edLock
)==0 );

136 if–
pIãr
!=
p
 ){

137 
	`as£π
–(
pIãr
->
mEx˛Lock
 & 
p
->
mSh¨edLock
)==0 );

138 
	`as£π
–(
pIãr
->
mSh¨edLock
 & 
p
->
mEx˛Lock
)==0 );

139 if–
mask
 & 
pIãr
->
mEx˛Lock
 ){

140 
nEx˛
++;

141 }if–
mask
 & 
pIãr
->
mSh¨edLock
 ){

142 
nSh¨ed
++;

146 
	`as£π
–
nEx˛
==0 ||ÇExcl==1 );

147 
	`as£π
–
nEx˛
==0 || 
nSh¨ed
==0 );

149  
eOp
 ){

150 
BT_LOCK_UNLOCK
:

151 if–
nSh¨ed
==0 ){

152 
	`btLockSh¨edFûe
(
p
, 
iLock
, 
BT_LOCK_UNLOCK
);

154 
p
->
mEx˛Lock
 &~
mask
;

155 
p
->
mSh¨edLock
 &~
mask
;

158 
BT_LOCK_SHARED
:

159 if–
nEx˛
 ){

160 
rc
 = 
SQLITE4_BUSY
;

162 if–
nSh¨ed
==0 ){

163 
rc
 = 
	`btLockSh¨edFûe
(
p
, 
iLock
, 
BT_LOCK_SHARED
);

169 if–
rc
==
SQLITE4_OK
 ) 
p
->
mSh¨edLock
 |
mask
;

170 
p
->
mEx˛Lock
 &~
mask
;

175 
	`as£π
–
eOp
==
BT_LOCK_EXCL
 );

176 if–
nEx˛
 || 
nSh¨ed
 ){

177 
rc
 = 
SQLITE4_BUSY
;

179 
rc
 = 
	`btLockSh¨edFûe
(
p
, 
iLock
, 
BT_LOCK_EXCL
);

180 if–
rc
==
SQLITE4_OK
 ){

181 
p
->
mSh¨edLock
 &~
mask
;

182 
p
->
mEx˛Lock
 |
mask
;

188 
	`sqlôe4_muãx_Àave
(
pSh¨ed
->
pClõ¡Muãx
);

191  
rc
;

192 
	}
}

194 
	$btLockDñay
(){

195 
	`u¶ìp
(10000);

197 
nCÆl
 = 0;

198 
nCÆl
++;

199 
	`Ârötf
(
°dîr
, "%d dñay\n", 
nCÆl
);

200 
	`fÊush
(
°dîr
);

202 
	}
}

213 
	$btLockLock›
(

214 
BtLock
 *
p
,

215 
iLock
,

216 
eOp
,

217 
bBlock


219 
rc
;

221 
rc
 = 
	`btLockLock›N⁄blockög
(
p
, 
iLock
, 
eOp
);

222 if–
rc
!=
SQLITE4_BUSY
 || 
bBlock
==0 ) ;

224 
	`btLockDñay
();

226  
rc
;

227 
	}
}

229 
	$btLockSh¨edDîef
(

230 
sqlôe4_ív
 *
pEnv
,

231 
bt_ív
 *
pVfs
,

232 
BtSh¨ed
 *
pSh¨ed


234 
	`btLockMuãxE¡î
(
pEnv
);

235 
pSh¨ed
->
nRef
--;

236 if–
pSh¨ed
->
nRef
==0 ){

237 
BtSh¨ed
 **
µS
;

238 
µS
=&
gBtSh¨ed
.
pD©aba£
; *µS!=
pSh¨ed
;ÖpS=&(*µS)->
pNext
);

239 *
µS
 = (*µS)->
pNext
;

240  
pSh¨ed
->
pBtFûe
 ){

241 
BtFûe
 *
p
 = 
pSh¨ed
->
pBtFûe
;

242 
pSh¨ed
->
pBtFûe
 = 
p
->
pNext
;

243 
pVfs
->
	`xClo£
(
p
->
pFd
);

244 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

246 
	`sqlôe4_muãx_‰ì
(
pSh¨ed
->
pClõ¡Muãx
);

249 if–
pSh¨ed
->
pFûe
==0 ){

250 
i
;

251 
i
=0; i<
pSh¨ed
->
nShmChunk
; i++){

252 
	`sqlôe4_‰ì
(
pEnv
, 
pSh¨ed
->
≠ShmChunk
[
i
]);

255 
pVfs
->
	`xClo£
(
pSh¨ed
->
pFûe
);

257 
	`sqlôe4_‰ì
(
pEnv
, 
pSh¨ed
->
≠ShmChunk
);

258 
	`sqlôe4_‰ì
(
pEnv
, 
pSh¨ed
);

260 
	`btLockMuãxLóve
(
pEnv
);

261 
	}
}

271 
sqlôe4BtLockC⁄√˘
(
BtLock
 *
p
, (*
xRecovî
)(BtLock*)){

272 
sqlôe4_ív
 *
pEnv
 = 
p
->pEnv;

273 
bt_ív
 *
pVfs
 = 
p
->pVfs;

274 
rc
 = 
SQLITE4_OK
;

275 c⁄° *
zName
;

276 
nName
;

277 
BtSh¨ed
 *
pSh¨ed
;

279 
zName
 = 
	`sqlôe4BtPagîFûíame
((
BtPagî
*)
p
, 
BT_PAGERFILE_DATABASE
);

280 
nName
 = 
	`°æí
(
zName
);

282 
	`btLockMuãxE¡î
(
p
->
pEnv
);

283 
p
->
iDebugId
 = 
gBtSh¨ed
.iDebugId++;

284 
pSh¨ed
=
gBtSh¨ed
.
pD©aba£
;ÖSh¨ed;ÖSh¨edıSh¨ed->
pNext
){

285 if–
pSh¨ed
->
nName
=ÚNamê&& 0==
	`memcmp
(
zName
,ÖShared->zName,ÇName) ){

290 if–
pSh¨ed
==0 ){

291 
sqlôe4_muãx
 *
pMuãx
;

292 
pSh¨ed
 = (
BtSh¨ed
*)
	`sqlôe4_mÆloc
(
pEnv
, (BtSh¨edË+ 
nName
 + 1);

293 
pMuãx
 = 
	`sqlôe4_muãx_Æloc
(
pEnv
, 
SQLITE4_MUTEX_RECURSIVE
);

295 if–
pSh¨ed
==0 || 
pMuãx
==0 ){

296 
	`sqlôe4_‰ì
(
pEnv
, 
pSh¨ed
);

297 
	`sqlôe4_muãx_‰ì
(
pMuãx
);

298 
pSh¨ed
 = 0;

299 
pMuãx
 = 0;

300 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

302 
	`mem£t
(
pSh¨ed
, 0, (
BtSh¨ed
));

303 
pSh¨ed
->
bMu…iProc
 = 
p
->
bReque°Mu…iProc
;

304 
pSh¨ed
->
nName
 =ÇName;

305 
pSh¨ed
->
zName
 = (*)&pShared[1];

306 
	`mem˝y
(
pSh¨ed
->
zName
, zName, 
nName
+1);

307 
pSh¨ed
->
pNext
 = 
gBtSh¨ed
.
pD©aba£
;

308 
pSh¨ed
->
pClõ¡Muãx
 = 
pMuãx
;

309 
gBtSh¨ed
.
pD©aba£
 = 
pSh¨ed
;

312 if–
rc
==
SQLITE4_OK
 ){

313 
pSh¨ed
->
nRef
++;

315 
	`btLockMuãxLóve
(
p
->
pEnv
);

318 if–
rc
==
SQLITE4_OK
 ){

319 
	`sqlôe4_muãx_íãr
(
pSh¨ed
->
pClõ¡Muãx
);

324 if–
pSh¨ed
->
pFûe
==0 &&ÖSh¨ed->
bMu…iProc
 ){

325 
Êags
 = 
BT_OPEN_SHARED
;

326 
rc
 = 
pVfs
->
	`xO≥n
(
pEnv
,ÖVfs, 
pSh¨ed
->
zName
, 
Êags
, &pSh¨ed->
pFûe
);

329 if–
rc
==
SQLITE4_OK
 ){

330 if–
pSh¨ed
->
pBtFûe
 ){

331 
p
->
pBtFûe
 = 
pSh¨ed
->pBtFile;

332 
pSh¨ed
->
pBtFûe
 = 
p
->pBtFûe->
pNext
;

333 
p
->
pBtFûe
->
pNext
 = 0;

334 
p
->
pFd
 =Ö->
pBtFûe
->pFd;

336 
p
->
pBtFûe
 = (
BtFûe
*)
	`sqlôe4_mÆloc
(
pEnv
, (BtFile));

337 if–
p
->
pBtFûe
 ){

338 
Êags
 = 
BT_OPEN_DATABASE
;

339 
p
->
pBtFûe
->
pNext
 = 0;

340 
rc
 = 
pVfs
->
	`xO≥n
(
pEnv
,ÖVfs, 
pSh¨ed
->
zName
, 
Êags
, &
p
->
pFd
);

341 if–
rc
==
SQLITE4_OK
 ){

342 
p
->
pBtFûe
->
pFd
 =Ö->pFd;

344 
	`sqlôe4_‰ì
(
pEnv
, 
p
->
pBtFûe
);

345 
p
->
pBtFûe
 = 0;

348 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

353 if–
rc
==
SQLITE4_OK
 ){

354 
p
->
pNext
 = 
pSh¨ed
->
pLock
;

355 
pSh¨ed
->
pLock
 = 
p
;

356 
p
->
pSh¨ed
 =ÖShared;

358 
	`sqlôe4_muãx_Àave
(
pSh¨ed
->
pClõ¡Muãx
);

359 if–
rc
!=
SQLITE4_OK
 ){

360 
	`btLockSh¨edDîef
(
pEnv
, 
pVfs
, 
pSh¨ed
);

364 if–
rc
==
SQLITE4_OK
 ){

365 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS1
, 
BT_LOCK_EXCL
, 1);

366 if–
rc
==
SQLITE4_OK
 ){

367 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RW
, 
BT_LOCK_EXCL
, 0);

368 if–
rc
==
SQLITE4_OK
 ){

369 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RO
, 
BT_LOCK_EXCL
, 0);

371 if–
rc
==
SQLITE4_OK
 ){

372 
rc
 = 
pVfs
->
	`xShmM≠
(
p
->
pFd
, 0, 0, 0);

374 if–
rc
==
SQLITE4_OK
 ){

375 
rc
 = 
	`xRecovî
(
p
);

377 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RO
, 
BT_LOCK_UNLOCK
, 0);

378 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RW
, 
BT_LOCK_UNLOCK
, 0);

379 if–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_BUSY
 ){

380 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RW
, 
BT_LOCK_SHARED
, 0);

382 
	`btLockLock›
(
p
, 
BT_LOCK_DMS1
, 
BT_LOCK_UNLOCK
, 0);

386  
rc
;

387 
	}
}

404 
sqlôe4BtLockDisc⁄√˘
(

405 
BtLock
 *
p
,

406 (*
xCk±
)(
BtLock
*),

407 (*
xDñ
)(
BtLock
*)

409 
BtSh¨ed
 *
pSh¨ed
 = 
p
->pShared;

410 
BtLock
 **
µ
;

411 
rc
;

413 if–
p
->
pSh¨ed
==0 )  
SQLITE4_OK
;

415 
	`sqlôe4_muãx_íãr
(
pSh¨ed
->
pClõ¡Muãx
);

416 
µ
=&
p
->
pSh¨ed
->
pLock
; *µ!ı;Öp=&(*µ)->
pNext
);

417 *
µ
 = (*µ)->
pNext
;

418 
	`sqlôe4_muãx_Àave
(
pSh¨ed
->
pClõ¡Muãx
);

420 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS1
, 
BT_LOCK_EXCL
, 1);

421 if–
rc
==
SQLITE4_OK
 ){

422 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RW
, 
BT_LOCK_EXCL
, 0);

423 if–
rc
==
SQLITE4_OK
 ){

424 
rc
 = 
	`xCk±
(
p
);

426 if–
rc
==
SQLITE4_OK
 ){

427 
rc
 = 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RO
, 
BT_LOCK_EXCL
, 0);

429 if–
rc
==
SQLITE4_OK
 ){

430 
rc
 = 
	`xDñ
(
p
);

431 if–
pSh¨ed
->
pFûe
 ) 
p
->
pVfs
->
	`xShmUnm≠
(pShared->pFile, 1);

433 if–
rc
==
SQLITE4_BUSY
 )Ñ¯
SQLITE4_OK
;

434 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RW
, 
BT_LOCK_UNLOCK
, 0);

435 
	`btLockLock›
(
p
, 
BT_LOCK_DMS2_RO
, 
BT_LOCK_UNLOCK
, 0);

436 
	`btLockLock›
(
p
, 
BT_LOCK_DMS1
, 
BT_LOCK_UNLOCK
, 0);

439 
	`sqlôe4_muãx_íãr
(
pSh¨ed
->
pClõ¡Muãx
);

440 
	`as£π
–
p
->
pBtFûe
->
pNext
==0 );

441 
p
->
pBtFûe
->
pNext
 = 
pSh¨ed
->pBtFile;

442 
pSh¨ed
->
pBtFûe
 = 
p
->pBtFile;

443 
	`sqlôe4_muãx_Àave
(
pSh¨ed
->
pClõ¡Muãx
);

445 
	`btLockSh¨edDîef
(
p
->
pEnv
,Ö->
pVfs
, 
pSh¨ed
);

446 
p
->
pSh¨ed
 = 0;

447  
rc
;

448 
	}
}

450 #i‚de‡
NDEBUG


451 
	$as£πNoLockedSlŸs
(
BtLock
 *
pLock
){

452 
u32
 
mask
 = (1 << (
BT_LOCK_READER0
+
BT_NREADER
+1)) - (1 << BT_LOCK_READER0);

453 
	`as£π
–(
pLock
->
mEx˛Lock
 & 
mask
)==0 );

454 
	}
}

456 
	#as£πNoLockedSlŸs
(
x
)

	)

466 
	$sqlôe4BtLockRódî
(

467 
BtLock
 *
pLock
,

468 
u32
 *
aLog
,

469 
u32
 
iFú°
,

470 
BtRódSlŸ
 *
aSlŸ


472 
rc
 = 
SQLITE4_BUSY
;

473 
i
;

474 
u32
 
iLa°
 = 
aLog
[5];

484 if–(
iFú°
<
aLog
[0] || iFirst>aLog[1])

485 && (
iFú°
<
aLog
[2] || iFirst>aLog[3])

486 && (
iFú°
<
aLog
[4] || iFirst>aLog[5])

488 
iLa°
 = 0;

491 if–
iLa°
==0 ){

492 
rc
 = 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER_DBONLY
, 
BT_LOCK_SHARED
, 0);

494 c⁄° 
nMaxRëry
 = 100;

495 
nAâem±
 = 100;

497 
nAâem±
=0; 
rc
==
SQLITE4_BUSY
 &&ÇAâem±<
nMaxRëry
;ÇAttempt++){

499 
iIdxFú°
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iFú°
);

500 
iIdxLa°
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iLa°
);

502 
	`as£π
–
iIdxFú°
>=0 && 
iIdxLa°
>=0 );

505 
i
=0; i<
BT_NREADER
; i++){

506 if–
aSlŸ
[
i
].
iFú°
==iFú° &&áSlŸ[i].
iLa°
==iLast ){

512 if–
i
==
BT_NREADER
 ){

513 
i
=0; i<
BT_NREADER
; i++){

514 
rc
 = 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER0
 + 
i
, 
BT_LOCK_EXCL
, 0);

515 if–
rc
==
SQLITE4_OK
 ){

519 
aSlŸ
[
i
].
iFú°
 = iFirst;

520 
aSlŸ
[
i
].
iLa°
 = iLast;

522 }if–
rc
!=
SQLITE4_BUSY
 ){

523  
rc
;

533 if–
i
==
BT_NREADER
 ){

534 
i
=0; i<
BT_NREADER
; i++){

535 
iSlŸFú°
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
aSlŸ
[
i
].
iFú°
);

536 
iSlŸLa°
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
aSlŸ
[
i
].
iLa°
);

537 if–
iSlŸFú°
<0 || 
iSlŸLa°
<0 ) ;

538 if–
iSlŸFú°
<=
iIdxFú°
 && 
iSlŸLa°
<=
iIdxLa°
 ) ;

542 if–
i
<
BT_NREADER
 ){

543 
rc
 = 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER0
 + 
i
, 
BT_LOCK_SHARED
, 0);

544 if–
rc
==
SQLITE4_OK
 ){

545 
iSF
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
aSlŸ
[
i
].
iFú°
);

546 
iSL
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
aSlŸ
[
i
].
iLa°
);

547 if–
iSF
>
iIdxFú°
 || 
iSL
>
iIdxLa°
 || iSF<0 || iSL<0 ){

548 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER0
 + 
i
, 
BT_LOCK_UNLOCK
, 0);

549 
rc
 = 
SQLITE4_BUSY
;

551 
	`sqlôe4BtDebugRódlock
(
pLock
, 
aSlŸ
[
i
].
iFú°
,áSlŸ[i].
iLa°
);

553 }if–
rc
==
SQLITE4_BUSY
 && 
nAâem±
>(
nMaxRëry
/2) ){

554 
	`btLockDñay
();

560 
	`as£πNoLockedSlŸs
(
pLock
);

561  
rc
;

562 
	}
}

567 
	$sqlôe4BtLockRódîU∆ock
(
BtLock
 *
pLock
){

568 
i
;

571 
	`as£π
–(
BT_LOCK_READER_DBONLY
+1)==
BT_LOCK_READER0
 );

572 
i
=0; i<
BT_NREADER
+1; i++){

573 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER_DBONLY
 + 
i
, 
BT_LOCK_UNLOCK
, 0);

576  
SQLITE4_OK
;

577 
	}
}

591 
	$sqlôe4BtLockRódîQuîy
(

592 
BtLock
 *
pLock
,

593 
u32
 *
aLog
,

594 
BtRódSlŸ
 *
aSlŸ
,

595 
u32
 *
piOut
,

596 *
piDblocked


598 
u32
 
iOut
 = 0;

599 
iIdxOut
 = 0;

600 
bLa°
 = (
piDblocked
!=0);

601 
rc
 = 
SQLITE4_OK
;

602 
i
;

604 if–
piDblocked
 ){

605 
rc
 = 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER_DBONLY
, 
BT_LOCK_EXCL
, 0);

606 if–
rc
==
SQLITE4_OK
 ){

607 *
piDblocked
 = 0;

608 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER_DBONLY
, 
BT_LOCK_UNLOCK
, 0);

609 }if–
rc
==
SQLITE4_BUSY
 ){

610 *
piDblocked
 = 1;

612  
rc
;

616 
i
=0; i<3 && 
iOut
==0; i++){

617 
iSlŸ
;

618 
iSlŸ
=0; iSlŸ<
BT_NREADER
; iSlot++){

619 
u32
 
iVÆ
 = (
bLa°
 ? 
aSlŸ
[
iSlŸ
].
iLa°
 :áSlŸ[iSlŸ].
iFú°
);

620 if–
iVÆ
 ){

622 
rc
 = 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER0
 + 
iSlŸ
, 
BT_LOCK_EXCL
, 0);

623 if–
rc
==
SQLITE4_OK
 ){

624 
aSlŸ
[
iSlŸ
].
iFú°
 = 0;

625 
aSlŸ
[
iSlŸ
].
iLa°
 = 0;

626 
	`btLockLock›
(
pLock
, 
BT_LOCK_READER0
 + 
iSlŸ
, 
BT_LOCK_UNLOCK
, 0);

627 }if–
rc
==
SQLITE4_BUSY
 ){

628 
iIdx
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iVÆ
);

629 if–
iIdx
>=0 && (
iOut
==0 || iIdx<
iIdxOut
) ){

630 
iIdxOut
 = 
iIdx
;

631 
iOut
 = 
iVÆ
;

634  
rc
;

640 *
piOut
 = 
iOut
;

641  
SQLITE4_OK
;

642 
	}
}

644 
	$sqlôe4BtLockShmM≠
(
BtLock
 *
pLock
, 
iChunk
, 
nByã
, 
u8
 **
µOut
){

645 
rc
 = 
SQLITE4_OK
;

646 
BtSh¨ed
 *
pSh¨ed
 = 
pLock
->pShared;

647 
u8
 *
pOut
 = 0;

649 
	`as£π
–
pSh¨ed
->
bRód⁄ly
==0 );

651 
	`sqlôe4_muãx_íãr
(
pSh¨ed
->
pClõ¡Muãx
);

652 if–
pSh¨ed
->
nShmChunk
<=
iChunk
 ){

653 
u8
 **
≠New
;

654 
nNew
 = 
iChunk
+1;

655 
nByã
 = (
u8
*)*
nNew
;

657 
≠New
 = (
u8
**)
	`sqlôe4_ªÆloc
(
pLock
->
pEnv
, 
pSh¨ed
->
≠ShmChunk
, 
nByã
);

658 if–
≠New
==0 ){

659 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

661 
	`mem£t
(&
≠New
[
pSh¨ed
->
nShmChunk
],0,
nByã
-(
u8
*)*pShared->nShmChunk);

662 
pSh¨ed
->
nShmChunk
 = 
nNew
;

663 
pSh¨ed
->
≠ShmChunk
 = 
≠New
;

667 if–
rc
==
SQLITE4_OK
 ){

669 
	`as£π
–(
pSh¨ed
->
bMu…iProc
==0)==’Sh¨ed->
pFûe
==0) );

670 if–
pSh¨ed
->
pFûe
==0 ){

672 if–
pSh¨ed
->
≠ShmChunk
[
iChunk
]==0 ){

673 
u8
 *
p
 = (u8*)
	`sqlôe4_mÆloc
(
pLock
->
pEnv
, 
nByã
);

674 if–
p
 ){

675 
	`mem£t
(
p
, 0, 
nByã
);

676 
pSh¨ed
->
≠ShmChunk
[
iChunk
] = 
p
;

678 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

683 *
pShm
 = 0;

684 
rc
 = 
pLock
->
pVfs
->
	`xShmM≠
(
pSh¨ed
->
pFûe
, 
iChunk
, 
nByã
, &
pShm
);

685 
pSh¨ed
->
≠ShmChunk
[
iChunk
] = (
u8
*)
pShm
;

688 
pOut
 = 
pSh¨ed
->
≠ShmChunk
[
iChunk
];

689 
	`as£π
–
pOut
 || 
rc
!=
SQLITE4_OK
 );

691 
	`sqlôe4_muãx_Àave
(
pSh¨ed
->
pClõ¡Muãx
);

693 *
µOut
 = 
pOut
;

694  
rc
;

695 
	}
}

704 
	$sqlôe4BtLockCk±
(
BtLock
 *
pLock
){

705  
	`btLockLock›
(
pLock
, 
BT_LOCK_CKPTER
, 
BT_LOCK_EXCL
, 0);

706 
	}
}

707 
	$sqlôe4BtLockCk±U∆ock
(
BtLock
 *
pLock
){

708  
	`btLockLock›
(
pLock
, 
BT_LOCK_CKPTER
, 
BT_LOCK_UNLOCK
, 0);

709 
	}
}

718 
	$sqlôe4BtLockWrôî
(
BtLock
 *
pLock
){

719  
	`btLockLock›
(
pLock
, 
BT_LOCK_WRITER
, 
BT_LOCK_EXCL
, 0);

720 
	}
}

721 
	$sqlôe4BtLockWrôîU∆ock
(
BtLock
 *
pLock
){

722  
	`btLockLock›
(
pLock
, 
BT_LOCK_WRITER
, 
BT_LOCK_UNLOCK
, 0);

723 
	}
}

	@src/bt_log.c

14 
	~"btI¡.h
"

16 
	~<°rög.h
>

17 
	~<as£π.h
>

18 
	~<°dio.h
>

19 
	~<°ddef.h
>

22 
	#BT_WAL_MAGIC
 0xBEE1CA62

	)

23 
	#BT_WAL_VERSION
 0x00000001

	)

27 
	#BT_NWRAPLOG
 100

	)

29 
BtCk±Hdr
 
	tBtCk±Hdr
;

30 
BtDbHdrCksum
 
	tBtDbHdrCksum
;

31 
BtFømeHdr
 
	tBtFømeHdr
;

32 
BtShm
 
	tBtShm
;

33 
BtShmHdr
 
	tBtShmHdr
;

34 
BtWÆHdr
 
	tBtWÆHdr
;

43 
	sBtWÆHdr
 {

44 
u32
 
	miMagic
;

45 
u32
 
	miVîsi⁄
;

46 
u32
 
	miC¡
;

47 
u32
 
	mnSe˘‹
;

49 
u32
 
	mnPgsz
;

50 
u32
 
	mnPg
;

52 
u32
 
	m∑ddög
;

54 
u32
 
	miSÆt1
;

55 
u32
 
	miSÆt2
;

56 
u32
 
	miFú°Føme
;

58 
u32
 
	maCksum
[2];

74 
	sBtFømeHdr
 {

75 
u32
 
	mpgno
;

76 
u32
 
	miNext
;

77 
u32
 
	mnPg
;

78 
u32
 
	maCksum
[2];

81 
	#BT_FRAME_COMMIT
 0x80000000

	)

86 
	sBtDbHdrCksum
 {

87 
BtDbHdr
 
	mhdr
;

88 
u32
 
	maCksum
[2];

96 
	sBtShmHdr
 {

97 
u32
 
	maLog
[6];

98 
	mnSe˘‹
;

99 
	miHashSide
;

100 
u32
 
	maFømeCksum
[2];

101 
u32
 
	miNextFøme
;

102 
BtDbHdr
 
	mdbhdr
;

104 
u32
 
	m∑ddög
;

105 
u32
 
	maCksum
[2];

124 
	sBtCk±Hdr
 {

125 
u32
 
	miFú°Ród
;

126 
u32
 
	miWÆHdr
;

127 
u32
 
	miFú°Recovî
;

130 
	sBtShm
 {

131 
BtShmHdr
 
	mhdr1
;

132 
BtShmHdr
 
	mhdr2
;

133 
BtCk±Hdr
 
	mck±
;

134 
BtRódSlŸ
 
	maRódlock
[
BT_NREADER
];

141 
	sBtLog
 {

142 
BtLock
 *
	mpLock
;

143 
bt_fûe
 *
	mpFd
;

144 
BtShmHdr
 
	m¢≠shŸ
;

145 
	mnShm
;

146 
u8
 **
	m≠Shm
;

147 
	mnWøpLog
;

150 
u16
 
	tht_¶Ÿ
;

155 
	#HASHTABLE_NFRAME
 (
BT_SHM_CHUNK_SIZE
/((
u32
Ë+ 4*(
ht_¶Ÿ
)))

	)

164 
	#HASHTABLE_NFRAME_ONE
 (
HASHTABLE_NFRAME
 - ((
BtShm
)/(
u32
)))

	)

169 
	#HASHTABLE_NSLOT
 (
HASHTABLE_NFRAME
 * 2)

	)

171 
	#HASHTABLE_OFFSET_1
 (
HASHTABLE_NFRAME
 * (
u32
))

	)

172 
	#HASHTABLE_OFFSET_2
 (
HASHTABLE_OFFSET_1
+
HASHTABLE_NSLOT
*(
ht_¶Ÿ
))

	)

177 
	#HASHTABLE_KEY_MUL
 383

	)

187 
	#BYTESWAP32
(
x
) ( \

188 (((
x
)&0x000000FF)<<24) + (((x)&0x0000FF00)<<8) \

189 + (((
x
)&0x00FF0000)>>8) + (((x)&0xFF000000)>>24) \

190 )

	)

193 c⁄° 
	gbtO√
 = 1;

194 
	#BTLOG_LITTLE_ENDIAN
 (*(
u8
 *)(&
btO√
))

	)

205 
	$btLogChecksum
(

206 
«tiveCksum
,

207 
u8
 *
a
,

208 
nByã
,

209 c⁄° 
u32
 *
aIn
,

210 
u32
 *
aOut


212 
u32
 
s1
, 
s2
;

213 
u32
 *
aD©a
 = (u32 *)
a
;

214 
u32
 *
aEnd
 = (u32 *)&
a
[
nByã
];

216 if–
aIn
 ){

217 
s1
 = 
aIn
[0];

218 
s2
 = 
aIn
[1];

220 
s1
 = 
s2
 = 0;

223 
	`as£π
–
nByã
>=8 );

224 
	`as£π
–(
nByã
&0x00000007)==0 );

226 if–
«tiveCksum
 ){

228 
s1
 +*
aD©a
++ + 
s2
;

229 
s2
 +*
aD©a
++ + 
s1
;

230 } 
aD©a
<
aEnd
 );

233 
s1
 +
	`BYTESWAP32
(
aD©a
[0]Ë+ 
s2
;

234 
s2
 +
	`BYTESWAP32
(
aD©a
[1]Ë+ 
s1
;

235 
aD©a
 += 2;

236 } 
aD©a
<
aEnd
 );

239 
aOut
[0] = 
s1
;

240 
aOut
[1] = 
s2
;

241 
	}
}

243 
	$btLogChecksum32
(

244 
«tiveCksum
,

245 
u8
 *
a
,

246 
nByã
,

247 c⁄° 
u32
 *
aIn
,

248 
u32
 *
aOut


250 
	`as£π
–
nByã
>=8 );

251 if–
nByã
&0x00000007 ){

252 
	`btLogChecksum
(
«tiveCksum
, 
a
, 8, 
aIn
, 
aOut
);

253 
	`btLogChecksum
(
«tiveCksum
, &
a
[4], 
nByã
-4, 
aOut
,áOut);

255 
	`btLogChecksum
(
«tiveCksum
, 
a
, 
nByã
, 
aIn
, 
aOut
);

257 
	}
}

259 
	#BT_ALLOC_DEBUG
 0

	)

260 
	#BT_PAGE_DEBUG
 0

	)

261 
	#BT_VAL_DEBUG
 0

	)

262 
	#BT_HDR_DEBUG
 0

	)

263 
	#BT_RECOVER_DEBUG
 0

	)

265 
	$btDebugT›ﬁogy
(
BtLock
 *
pLock
, *
zSå
, 
iSide
, 
u32
 *
aLog
){

266 #i‡
BT_PAGE_DEBUG


267 
	`Ârötf
(
°dîr
, "%d:%s: (side=%d) %d..%d %d..%d %d..%d\n",

268 
pLock
->
iDebugId
, 
zSå
, 
iSide
,

269 ()
aLog
[0], ()aLog[1], ()aLog[2],

270 ()
aLog
[3], ()aLog[4], ()aLog[5]

272 
	`fÊush
(
°dîr
);

274 
	}
}

276 
	$btDebugDbhdr
(
BtLock
 *
pLock
, c⁄° *
zSå
, 
BtDbHdr
 *
pHdr
){

277 #i‡
BT_HDR_DEBUG


278 
nCÆl
 = 0;

279 
	`Ârötf
(
°dîr
, "%d:%d: %s db-header "

281 
pLock
->
iDebugId
, 
nCÆl
++,

282 
zSå
, ()
pHdr
->
pgsz
, (ÌHdr->
nPg
, (ÌHdr->
iRoŸ
,

283 ()
pHdr
->
iCookõ
, (ÌHdr->
iFªePg
, (ÌHdr->
iFªeBlk


285 
	`fÊush
(
°dîr
);

287 
	}
}

289 
	$btDebugRecovîFøme
(
BtLock
 *
pLock
, 
u32
 
iFøme
, u32 
pgno
){

290 #i‡
BT_RECOVER_DEBUG


291 
nCÆl
 = 0;

292 
	`Ârötf
(
°dîr
, "%d:%d:ÑecoveredÖage %d from frame %d\n",

293 
pLock
->
iDebugId
, 
nCÆl
++, ()
pgno
, ()
iFøme


295 
	`fÊush
(
°dîr
);

297 
	}
}

299 #i‚de‡
NDEBUG


300 
	$sqlôe4BtDebugRódlock
(
BtLock
 *
pLock
, 
u32
 
iFú°
, u32 
iLa°
){

301 #i‡
BT_PAGE_DEBUG


302 
nCÆl
 = 0;

303 
	`Ârötf
(
°dîr
, "%d:%d:Ñeadlock=(%d..%d)\n",

304 
pLock
->
iDebugId
, 
nCÆl
++, ()
iFú°
, ()
iLa°


306 
	`fÊush
(
°dîr
);

308 
	}
}

311 #i‚de‡
NDEBUG


312 
	$sqlôe4BtDebugPageAŒoc
(
BtLock
 *
pLock
, c⁄° *
zSå
, 
u32
 
pgno
){

313 #i‡
BT_ALLOC_DEBUG


314 
nCÆl
 = 0;

315 
	`Ârötf
(
°dîr
, "%d:%d:állocateÖage %d from %s\n",

316 
pLock
->
iDebugId
, 
nCÆl
++, 
pgno
, 
zSå


318 
	`fÊush
(
°dîr
);

320 
	}
}

323 #i‚de‡
NDEBUG


324 
	$sqlôe4BtDebugPageFªe
(

325 
BtLock
 *
pLock
, 
bBlock
, c⁄° *
zSå
, 
u32
 
pgno


327 #i‡
BT_ALLOC_DEBUG


328 
nCÆl
 = 0;

329 
	`Ârötf
(
°dîr
, "%d:%d:Årim %s %d (%s)\n",

330 
pLock
->
iDebugId
, 
nCÆl
++, 
bBlock
 ? "block" : "∑ge", 
pgno
, 
zSå


332 
	`fÊush
(
°dîr
);

333 
	`as£π
–
pgno
<1000000 );

335 
	}
}

339 #i‚de‡
NDEBUG


340 
	$btDebugCheckS«pshŸ
(
BtShmHdr
 *
pHdr
){

341 
u32
 *
aLog
 = 
pHdr
->aLog;

342 
	`as£π
–
pHdr
->
iNextFøme
!=1 ||

343 (
aLog
[0]==0 &&áLog[1]==0 &&áLog[2]==0 &&áLog[3]==0)

347 
	`as£π
–
aLog
[0]==0 ||áLog[2]==0 ||áLog[3]<aLog[0] ||áLog[2]>aLog[1] );

348 
	`as£π
–
aLog
[0]==0 ||áLog[4]==0 ||áLog[5]<aLog[0] ||áLog[4]>aLog[1] );

349 
	`as£π
–
aLog
[2]==0 ||áLog[4]==0 ||áLog[5]<aLog[2] ||áLog[4]>aLog[3] );

352 
	`as£π
–
aLog
[0]==0 || 
pHdr
->
iNextFøme
<aLog[0] ||ÖHdr->iNextFrame>aLog[1] );

353 
	`as£π
–
aLog
[2]==0 || 
pHdr
->
iNextFøme
<aLog[2] ||ÖHdr->iNextFrame>aLog[3] );

354 
	`as£π
–
aLog
[4]==0 || 
pHdr
->
iNextFøme
<aLog[4] ||ÖHdr->iNextFrame>aLog[5] );

355 
	}
}

357 
	#btDebugCheckS«pshŸ
(
x
)

	)

360 #i‚de‡
NDEBUG


361 
	$btDebugLogSa„poöt
(
BtLock
 *
pLock
, 
u32
 
iSa„
){

362 #i‡
BT_PAGE_DEBUG


363 
nCÆl
 = 0;

364 
	`Ârötf
(
°dîr
, "%d:%d: checkpoint safepoint=%d\n",

365 
pLock
->
iDebugId
, 
nCÆl
++, ()
iSa„


367 
	`fÊush
(
°dîr
);

369 
	}
}

371 
	#btDebugLogSa„poöt
(
x
,
y
)

	)

374 
	$btDebugCk±Page
(
BtLock
 *
pLock
, 
u32
 
pgno
, 
u8
 *
aD©a
, 
pgsz
){

375 #i‡
BT_PAGE_DEBUG


376 
nCÆl
 = 0;

377 
u32
 
aCksum
[2];

378 
	`btLogChecksum
(1, 
aD©a
, 
pgsz
, 0, 
aCksum
);

379 
	`Ârötf
(
°dîr
, "%d:%d: CkptÖage %d (cksum=%08x%08x)\n",

380 
pLock
->
iDebugId
, 
nCÆl
++, ()
pgno
, 
aCksum
[0],áCksum[1]

382 
	`fÊush
(
°dîr
);

384 
	}
}

386 
	$btDebugLogPage
(

387 
BtLock
 *
pLock
, 
u32
 
pgno
, u32 
iFøme
, 
u8
 *
aD©a
, 
pgsz
, 
bCommô


389 #i‡
BT_PAGE_DEBUG


390 
nCÆl
 = 0;

391 
u32
 
aCksum
[2];

392 
	`btLogChecksum
(1, 
aD©a
, 
pgsz
, 0, 
aCksum
);

393 
	`Ârötf
(
°dîr
, "%d:%d: LogÖage %dÅo frame %d (cksum=%08x%08x)%s\n",

394 
pLock
->
iDebugId
, 
nCÆl
++, ()
pgno
, ()
iFøme
,

395 
aCksum
[0],áCksum[1], (
bCommô
 ? " commit" : "")

397 
	`fÊush
(
°dîr
);

399 
	}
}

401 #i‚de‡
NDEBUG


402 
	$sqlôe4BtDebugRódPage
(
BtLock
 *
pLock
, 
u32
 
pgno
, 
u8
 *
aD©a
, 
pgsz
){

403 #i‡
BT_PAGE_DEBUG


404 
nCÆl
 = 0;

405 
u32
 
aCksum
[2];

406 
	`btLogChecksum
(1, 
aD©a
, 
pgsz
, 0, 
aCksum
);

407 
	`Ârötf
(
°dîr
, "%d:%d: RódÖagê%d (cksum=%08x%08x)\n", 
pLock
->
iDebugId
,

408 
nCÆl
++, ()
pgno
, 
aCksum
[0],áCksum[1]

410 
	`fÊush
(
°dîr
);

412 
	}
}

415 #i‚de‡
NDEBUG


416 
	~<˘y≥.h
>

417 #i‡
BT_VAL_DEBUG


418 
	$böToSå
(
u8
 *
pIn
, 
nIn
, u8 *
pOut
, 
nOut
){

419 
i
;

420 
nC›y
 = 
	`MIN
(
nIn
, (
nOut
-1));

421 
i
=0; i<
nC›y
; i++){

422 if–
	`i•röt
(
pIn
[
i
]) ){

423 
pOut
[
i
] = 
pIn
[i];

425 
pOut
[
i
] = '.';

428 
pOut
[
i
] = '\0';

429 
	}
}

431 
	$sqlôe4BtDebugKV
(

432 
BtLock
 *
pLock
, c⁄° *
zSå
, 
u8
 *
pK
, 
nK
, u8 *
pV
, 
nV


434 #i‡
BT_VAL_DEBUG


435 
u8
 
aKBuf
[40];

436 
u8
 
aVBuf
[40];

437 
nCÆl
 = 0;

439 
	`böToSå
(
pK
, 
nK
, 
aKBuf
, (aKBuf));

440 if–
nV
<0 ){

441 
	`mem˝y
(
aVBuf
, "(delete)", 9);

443 
	`böToSå
(
pV
, 
nV
, 
aVBuf
, (aVBuf));

445 
	`Ârötf
(
°dîr
, "%d:%d: %s \"%s\" -> \"%s\" (%d bytes)\n",

446 
pLock
->
iDebugId
, 
nCÆl
++, 
zSå
, 
aKBuf
, 
aVBuf
, 
nV


449 
	`fÊush
(
°dîr
);

451 
	}
}

454 
	$btDebugLogSórch
(
BtLock
 *
pLock
, 
u32
 
pgno
, u32 
iSa„
, u32 
iFøme
){

455 #i‡
BT_PAGE_DEBUG


456 
nCÆl
 = 0;

457 
	`Ârötf
(
°dîr
, "%d:%d: SearchÜog forÖage %d (safe=%d) - frame %d\n",

458 
pLock
->
iDebugId
, 
nCÆl
++, ()
pgno
, ()
iSa„
, ()
iFøme


460 
	`fÊush
(
°dîr
);

462 
	}
}

464 
	$btDebugSëPgno
(
BtLock
 *
pLock
,

465 
iHash
, 
iSide
, 
u32
 *
aPgno
, 
iFøme
, 
iZîo
, u32 
pgno


467 #i‡
BT_PAGE_DEBUG


468 
nCÆl
 = 0;

469 
	`Ârötf
(
°dîr
, "%d:%d: Set iHash=%d/%dáPgno=%p iFrame=%d iZero=%dÖgno=%d\n"

470 , 
pLock
->
iDebugId
, 
nCÆl
++, 
iHash
, 
iSide
,

471 (*)
aPgno
, 
iFøme
, 
iZîo
, ()
pgno


473 
	`fÊush
(
°dîr
);

475 
	}
}

477 #i‚de‡
NDEBUG


478 
	$btDebugLogHódî
(

479 
BtLock
 *
pLock
, c⁄° *
z
, 
BtWÆHdr
 *
pHdr
, 
iHdr


481 #i‡
BT_HDR_DEBUG


482 
nCÆl
 = 0;

483 
	`Ârötf
(
°dîr
,

485 
pLock
->
iDebugId
, 
nCÆl
++, 
z
, 
iHdr
,

486 ()
pHdr
->
iC¡
, (ÌHdr->
iFú°Føme
, (ÌHdr->
nPgsz


488 
	`fÊush
(
°dîr
);

490 
	}
}

494 #ifde‡
NDEBUG


495 
	#btDebugLogHódî
(
a
,
b
,
c
,
d
)

	)

503 
	$btLogM≠Shm
(
BtLog
 *
pLog
, 
iChunk
){

504 
rc
 = 
SQLITE4_OK
;

506 if–
pLog
->
nShm
<=
iChunk
 ){

507 
sqlôe4_ív
 *
pEnv
 = 
pLog
->
pLock
->pEnv;

508 
u8
 **
≠New
;

509 
nNew
 = 
iChunk
+1;

511 
≠New
 = (
u8
**)
	`sqlôe4_ªÆloc
(
pEnv
, 
pLog
->
≠Shm
, (u8*)*
nNew
);

512 if–
≠New
==0 )  
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

513 
	`mem£t
(&
≠New
[
pLog
->
nShm
], 0, (
nNew
-pLog->nShmË* (
u8
*));

514 
pLog
->
nShm
 = 
nNew
;

515 
pLog
->
≠Shm
 = 
≠New
;

518 if–
pLog
->
≠Shm
[
iChunk
]==0 ){

519 
u8
 **
µ
 = &
pLog
->
≠Shm
[
iChunk
];

520 
rc
 = 
	`sqlôe4BtLockShmM≠
(
pLog
->
pLock
, 
iChunk
, 
BT_SHM_CHUNK_SIZE
, 
µ
);

523  
rc
;

524 
	}
}

526 
BtShm
 *
	$btLogShm
(
BtLog
 *
pLog
){

527  (
BtShm
*)(
pLog
->
≠Shm
[0]);

528 
	}
}

530 
	$btLogUpd©eSh¨edHdr
(
BtLog
 *
pLog
){

531 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

532 
BtShmHdr
 *
p
 = &
pLog
->
¢≠shŸ
;

533 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

536 
	`btLogChecksum32
(1, (
u8
*)
p
, 
	`off£tof
(
BtShmHdr
, 
aCksum
), 0,Ö->aCksum);

539 
pVfs
->
	`xShmB¨rõr
(
pLog
->
pFd
);

540 
	`mem˝y
(&
pShm
->
hdr1
, 
p
, (
BtShmHdr
));

541 
pVfs
->
	`xShmB¨rõr
(
pLog
->
pFd
);

542 
	`mem˝y
(&
pShm
->
hdr2
, 
p
, (
BtShmHdr
));

544  
SQLITE4_OK
;

545 
	}
}

547 
	$btLogZîoS«pshŸ
(
BtLog
 *
pLog
){

548 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

549 
	`mem£t
(&
pLog
->
¢≠shŸ
, 0, (
BtShmHdr
));

550 
pLog
->
¢≠shŸ
.
nSe˘‹
 = 
pVfs
->
	`xSe˘‹Size
’Log->
pFd
);

551 
	}
}

556 
i64
 
	$btLogFømeOff£t
(
BtLog
 *
pLog
, 
pgsz
, 
u32
 
iFøme
){

558 (
i64
)
pLog
->
¢≠shŸ
.
nSe˘‹
*2

559 + (
i64
)(
iFøme
-1Ë* (i64)(
pgsz
 + (
BtFømeHdr
));

560 
	}
}

562 
	$btLogSyncFûe
(
BtLog
 *
pLog
, 
bt_fûe
 *
pFd
){

563 if–
pLog
->
pLock
->
iSa„tyLevñ
==
BT_SAFETY_OFF
 )  
SQLITE4_OK
;

564 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

565  
pVfs
->
	`xSync
(
pFd
);

566 
	}
}

568 
	$btLogWrôeD©a
(
BtLog
 *
pLog
, 
i64
 
iOff
, 
u8
 *
aD©a
, 
nD©a
){

569 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

570  
pVfs
->
	`xWrôe
(
pLog
->
pFd
, 
iOff
, 
aD©a
, 
nD©a
);

571 
	}
}

573 
	$btLogRódD©a
(
BtLog
 *
pLog
, 
i64
 
iOff
, 
u8
 *
aD©a
, 
nD©a
){

574 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

575  
pVfs
->
	`xRód
(
pLog
->
pFd
, 
iOff
, 
aD©a
, 
nD©a
);

576 
	}
}

578 
	$btLogRódHódî
(
BtLog
 *
pLog
, 
iOff
, 
BtWÆHdr
 *
pHdr
){

579 
rc
 = 
	`btLogRódD©a
(
pLog
, (
i64
)
iOff
, (
u8
*)
pHdr
, (
BtWÆHdr
));

580 if–
rc
==
SQLITE4_OK
 ){

581 
u32
 
aCksum
[2];

582 
	`btLogChecksum
(1, (
u8
*)
pHdr
, 
	`off£tof
(
BtWÆHdr
, 
aCksum
), 0,áCksum);

583 if–
pHdr
->
iMagic
!=
BT_WAL_MAGIC


584 || 
aCksum
[0]!=
pHdr
->aCksum[0]

585 || 
aCksum
[1]!=
pHdr
->aCksum[1]

587 
rc
 = 
SQLITE4_NOTFOUND
;

589 
	`btDebugLogHódî
(
pLog
->
pLock
, "ªad", 
pHdr
, 
iOff
!=0);

592  
rc
;

593 
	}
}

600 
btLogTøvî£
(

601 
BtLog
 *
pLog
,

602 
BtWÆHdr
 *
pHdr
,

603 (*
xFøme
)(
BtLog
*, *, 
u32
, 
BtFømeHdr
*),

604 *
pCtx


606 
sqlôe4_ív
 *
pEnv
 = 
pLog
->
pLock
->pEnv;

607 c⁄° 
pgsz
 = 
pHdr
->
nPgsz
;

608 
u32
 
iFøme
 = 
pHdr
->
iFú°Føme
;

609 
u32
 
aCksum
[2];

610 
BtFømeHdr
 
fhdr
;

611 
u8
 *
aBuf
;

612 
rc
 = 
SQLITE4_OK
;

614 
aCksum
[0] = 
pHdr
->
iSÆt1
;

615 
aCksum
[1] = 
pHdr
->
iSÆt2
;

617 
aBuf
 = 
	`sqlôe4_mÆloc
(
pEnv
, 
pgsz
);

618 if–
aBuf
==0 ){

619 
rc
 = 
SQLITE4_NOMEM
;

622  
rc
==
SQLITE4_OK
 ){

623 
i64
 
iOff
;

624 
iOff
 = 
	`btLogFømeOff£t
(
pLog
, 
pgsz
, 
iFøme
);

626 
rc
 = 
	`btLogRódD©a
(
pLog
, 
iOff
, (
u8
*)&
fhdr
, (
BtFømeHdr
));

627 if–
rc
==
SQLITE4_OK
 ){

628 
rc
 = 
	`btLogRódD©a
(
pLog
, 
iOff
+(
BtFømeHdr
), 
aBuf
, 
pgsz
);

630 if–
rc
==
SQLITE4_OK
 ){

631 
	`btLogChecksum32
(1, (
u8
*)&
fhdr
, 
	`off£tof
(
BtFømeHdr
,
aCksum
),aCksum,aCksum);

632 
	`btLogChecksum
(1, 
aBuf
, 
pgsz
, 
aCksum
,áCksum);

633 if–
aCksum
[0]!=
fhdr
.aCksum[0] ||áCksum[1]!=fhdr.aCksum[1] ) ;

635 if–
rc
==
SQLITE4_OK
 ){

636 
rc
 = 
	`xFøme
(
pLog
, 
pCtx
, 
iFøme
, &
fhdr
);

639 
iFøme
 = 
fhdr
.
iNext
;

642 
	`sqlôe4_‰ì
(
pEnv
, 
aBuf
);

643  
rc
;

644 
	}
}

649 
	$btLogFödHash
(

650 
BtLog
 *
pLog
,

651 
iSide
,

652 
iHash
,

653 
ht_¶Ÿ
 **
∑Hash
,

654 
u32
 **
∑Pgno
,

655 
u32
 *
piZîo


657 
rc
;

659 
	`as£π
–
iSide
==0 || iSide==1 );

661 
rc
 = 
	`btLogM≠Shm
(
pLog
, 
iHash
);

662 if–
rc
==
SQLITE4_OK
 ){

663 
u8
 *
aChunk
 = 
pLog
->
≠Shm
[
iHash
];

664 
u32
 *
aPgno
;

665 
u32
 
iZîo
;

667 *
∑Hash
 = (
ht_¶Ÿ
*)&
aChunk
[
iSide
?
HASHTABLE_OFFSET_1
:
HASHTABLE_OFFSET_2
];

668 if–
iHash
==0 ){

669 
aPgno
 = (
u32
*)&
aChunk
[(
BtShm
)];

670 
iZîo
 = 1;

672 
aPgno
 = (
u32
*)
aChunk
;

673 
iZîo
 = 1 + 
HASHTABLE_NFRAME_ONE
 + (
HASHTABLE_NFRAME
 * (
iHash
-1));

675 *
∑Pgno
 = 
aPgno
;

676 *
piZîo
 = 
iZîo
;

679  
rc
;

680 
	}
}

687 
	$btLogFømeHash
(
BtLog
 *
pLog
, 
u32
 
iFøme
){

688 if–
iFøme
<=
HASHTABLE_NFRAME_ONE
 )  0;

689  1 + ((
iFøme
 - 
HASHTABLE_NFRAME_ONE
 - 1Ë/ 
HASHTABLE_NFRAME
);

690 
	}
}

695 
	$btLogHashKey
(
BtLog
 *
pLog
, 
u32
 
pgno
){

696 
	`as£π
–
pgno
>=1 );

697  ((
pgno
 * 
HASHTABLE_KEY_MUL
Ë% 
HASHTABLE_NSLOT
);

698 
	}
}

700 
	$btLogHashNext
(
BtLog
 *
pLog
, 
iSlŸ
){

701  ((
iSlŸ
 + 1Ë% 
HASHTABLE_NSLOT
);

702 
	}
}

709 
	$btLogHashIn£π
(
BtLog
 *
pLog
, 
u32
 
pgno
, u32 
iFøme
){

710 
iHash
;

711 
rc
 = 
SQLITE4_OK
;

712 
ht_¶Ÿ
 *
aHash
;

713 
u32
 *
aPgno
;

714 
u32
 
iZîo
;

715 
iSide
 = 
pLog
->
¢≠shŸ
.
iHashSide
;

717 
	`as£π
–
iFøme
>=1 && 
pgno
>=1 );

720 
iHash
 = 
	`btLogFømeHash
(
pLog
, 
iFøme
);

721 
rc
 = 
	`btLogFödHash
(
pLog
, 
iSide
, 
iHash
, &
aHash
, &
aPgno
, &
iZîo
);

724 if–
rc
==
SQLITE4_OK
 ){

725 
iSlŸ
;

726 
nCﬁlide
 = 
HASHTABLE_NSLOT
*2;

727 
aPgno
[
iFøme
-
iZîo
] = 
pgno
;

728 
	`btDebugSëPgno
(
pLog
->
pLock
, 
iHash
, 
iSide
, 
aPgno
, 
iFøme
, 
iZîo
, 
pgno
);

730 if–
iFøme
==
iZîo
 ){

731 
	`mem£t
(
aHash
, 0, (
ht_¶Ÿ
Ë* 
HASHTABLE_NSLOT
);

734 
iSlŸ
=
	`btLogHashKey
(
pLog
,
pgno
); ; iSlŸ=
	`btLogHashNext
(pLog, iSlot)){

735 if–
aHash
[
iSlŸ
]==0 ){

736 
aHash
[
iSlŸ
] = (
iFøme
-
iZîo
+1);

739 if–(
nCﬁlide
--)==0 )  
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

743  
rc
;

744 
	}
}

749 
	$btLogHashRﬁlback
(
BtLog
 *
pLog
, 
iHash
, 
u32
 
iFøme
){

750 
ht_¶Ÿ
 *
aHash
;

751 
u32
 *
aPgno
;

752 
u32
 
iZîo
;

753 
iSide
 = 
pLog
->
¢≠shŸ
.
iHashSide
;

754 
rc
;

756 
rc
 = 
	`btLogFödHash
(
pLog
, 
iSide
, 
iHash
, &
aHash
, &
aPgno
, &
iZîo
);

757 if–
rc
==
SQLITE4_OK
 ){

758 
i
;

759 
ht_¶Ÿ
 
iMax
;

760 
iMax
 = (
iFøme
 - 
iZîo
) + 1;

762 
i
=0; i<
HASHTABLE_NSLOT
; i++){

763 if–
aHash
[
i
]>
iMax
 ){

764 
aPgno
[
aHash
[
i
]-1] = 0;

765 
aHash
[
i
] = 0;

770  
rc
;

771 
	}
}

778 
	$btLogIsEm±y
(
BtLog
 *
pLog
){

779  (
pLog
->
¢≠shŸ
.
aLog
[4]==0 &&ÖLog->¢≠shŸ.
iNextFøme
==0);

780 
	}
}

782 
FømeRecovîCtx
 
	tFømeRecovîCtx
;

783 
	sFømeRecovîCtx
 {

784 
u32
 
	miLa°
;

785 
u32
 
	miNextFøme
;

786 
u32
 
	miPageO√Føme
;

789 
	$btLogRecovîFøme
(

790 
BtLog
 *
pLog
,

791 *
pCtx
,

792 
u32
 
iFøme
,

793 
BtFømeHdr
 *
pHdr


795 
FømeRecovîCtx
 *
pFRC
 = (FømeRecovîCtx*)
pCtx
;

797 
	`btDebugRecovîFøme
(
pLog
->
pLock
, 
iFøme
, 
pHdr
->
pgno
);

799 if–
	`btLogIsEm±y
(
pLog
) ){

802 
pLog
->
¢≠shŸ
.
aLog
[4] = 
iFøme
;

803 
pLog
->
¢≠shŸ
.
aLog
[5] = 
iFøme
;

805 
u32
 
iEx≥˘
 = 
pLog
->
¢≠shŸ
.
aLog
[5]+1;

806 if–
iFøme
==
iEx≥˘
 ){

807 
pLog
->
¢≠shŸ
.
aLog
[5] = 
iFøme
;

808 }if–
iFøme
<
iEx≥˘
 ){

809 
	`as£π
–
iFøme
==1 );

810 
	`as£π
–
pLog
->
¢≠shŸ
.
aLog
[0]==0 &&ÖLog->snapshot.aLog[1]==0 );

811 
pLog
->
¢≠shŸ
.
aLog
[0] =ÖLog->snapshot.aLog[4];

812 
pLog
->
¢≠shŸ
.
aLog
[1] =ÖLog->snapshot.aLog[5];

813 
pLog
->
¢≠shŸ
.
aLog
[4] = 
iFøme
;

814 
pLog
->
¢≠shŸ
.
aLog
[5] = 
iFøme
;

815 
pLog
->
¢≠shŸ
.
iHashSide
 = (pLog->snapshot.iHashSide + 1) % 2;

817 
	`as£π
–
pLog
->
¢≠shŸ
.
aLog
[2]==0 &&ÖLog->snapshot.aLog[3]==0 );

818 
pLog
->
¢≠shŸ
.
aLog
[2] =ÖLog->snapshot.aLog[4];

819 
pLog
->
¢≠shŸ
.
aLog
[3] =ÖLog->snapshot.aLog[5];

820 
pLog
->
¢≠shŸ
.
aLog
[4] = 
iFøme
;

821 
pLog
->
¢≠shŸ
.
aLog
[5] = 
iFøme
;

825 
	`btLogHashIn£π
(
pLog
, 
pHdr
->
pgno
, 
iFøme
);

826 if–
pHdr
->
nPg
!=0 ){

827 
pFRC
->
iLa°
 = 
iFøme
;

828 
pFRC
->
iNextFøme
 = 
pHdr
->
iNext
;

829 
	`mem˝y
(
pLog
->
¢≠shŸ
.
aFømeCksum
, 
pHdr
->
aCksum
, (pHdr->aCksum));

830 
pLog
->
¢≠shŸ
.
dbhdr
.
nPg
 = 
pHdr
->nPg;

833 if–
pHdr
->
pgno
==1 ){

834 
pFRC
->
iPageO√Føme
 = 
iFøme
;

838 
	`Ârötf
(
°dîr
, "ªcovîed føme=%dÖgno=%d\n", 
iFøme
, 
pHdr
->
pgno
);

839 
	`fÊush
(
°dîr
);

842 
	}
}

852 
	$btLogRﬁlbackRecovîy
(
BtLog
 *
pLog
, 
FømeRecovîCtx
 *
pCtx
){

853 
u32
 
iLa°
 = 
pCtx
->iLast;

854 
u32
 *
aLog
 = 
pLog
->
¢≠shŸ
.aLog;

856  
iLa°
<
aLog
[4] || iLast>aLog[5] ){

857 if–
aLog
[2] ){

858 
aLog
[5] =áLog[3];

859 
aLog
[4] =áLog[2];

860 if–
aLog
[0] &&áLog[0]<aLog[4] ){

861 
aLog
[3] =áLog[1];

862 
aLog
[2] =áLog[0];

863 
aLog
[0] =áLog[1] = 0;

865 
aLog
[2] =áLog[3] = 0;

868 
aLog
[5] =áLog[1];

869 
aLog
[4] =áLog[0];

870 
aLog
[0] =áLog[1] = 0;

871 
pLog
->
¢≠shŸ
.
iHashSide
 = (pLog->snapshot.iHashSide + 1) % 2;

875 
aLog
[5] = 
iLa°
;

876  
	`btLogHashRﬁlback
(
pLog
, 
	`btLogFømeHash
’Log, 
iLa°
), iLast);

877 
	}
}

879 
	$btLogDecodeDbhdr
(
BtLog
 *
pLog
, 
u8
 *
aD©a
, 
BtDbHdr
 *
pHdr
){

880 
BtDbHdrCksum
 
hdr
;

881 
u32
 
aCksum
[2] = {0,0};

883 if–
aD©a
 ){

884 
	`mem˝y
(&
hdr
, 
aD©a
, (
BtDbHdrCksum
));

885 
	`btLogChecksum32
(1, (
u8
*)&
hdr
, 
	`off£tof
(
BtDbHdrCksum
, 
aCksum
), 0,áCksum);

888 if–
aD©a
==0 || 
aCksum
[0]!=
hdr
.aCksum[0] ||áCksum[1]!=hdr.aCksum[1] ){

889  
SQLITE4_NOTFOUND
;

892 
	`mem˝y
(
pHdr
, &
hdr
, (
BtDbHdr
));

893  
SQLITE4_OK
;

894 
	}
}

896 
	$btLogZîoDbhdr
(
BtLog
 *
pLog
, 
BtDbHdr
 *
pHdr
){

897 
	`as£π
–(
pHdr
->
azSå
)==
	`°æí
(
BT_DBHDR_STRING
) );

899 
	`mem£t
(
pHdr
, 0, (
BtDbHdr
));

900 
	`mem˝y
(
pHdr
->
azSå
, 
BT_DBHDR_STRING
, 
	`°æí
(BT_DBHDR_STRING));

901 
pHdr
->
pgsz
 = 
pLog
->
pLock
->
nPgsz
;

902 
pHdr
->
blksz
 = 
pLog
->
pLock
->
nBlksz
;

903 
pHdr
->
nPg
 = 2;

904 
pHdr
->
iRoŸ
 = 2;

905 
	}
}

907 
	$btLogRódDbhdr
(
BtLog
 *
pLog
, 
BtDbHdr
 *
pHdr
, 
u32
 
iFøme
){

908 
BtLock
 *
p
 = 
pLog
->
pLock
;

909 
rc
;

910 
i64
 
nByã
;

911 
u8
 
aBuf„r
[(
BtDbHdrCksum
)];

912 
u8
 *
aD©a
 = 0;

914 if–
iFøme
==0 ){

915 
rc
 = 
p
->
pVfs
->
	`xSize
’->
pFd
, &
nByã
);

916 if–
rc
==
SQLITE4_OK
 && 
nByã
>0 ){

917 
rc
 = 
p
->
pVfs
->
	`xRód
’->
pFd
, 0, 
aBuf„r
, (
BtDbHdrCksum
));

918 
aD©a
 = 
aBuf„r
;

921 
i64
 
iOff
 = 
	`btLogFømeOff£t
(
pLog
,ÖLog->
¢≠shŸ
.
dbhdr
.
pgsz
, 
iFøme
);

922 
iOff
 +(
BtFømeHdr
);

923 
rc
 = 
p
->
pVfs
->
	`xRód
(
pLog
->
pFd
, 
iOff
, 
aBuf„r
, (
BtDbHdrCksum
));

924 
aD©a
 = 
aBuf„r
;

927 if–
rc
==
SQLITE4_OK
 ){

928 
rc
 = 
	`btLogDecodeDbhdr
(
pLog
, 
aD©a
, 
pHdr
);

930  
rc
;

931 
	}
}

933 
	$btLogUpd©eDbhdr
(
BtLog
 *
pLog
, 
u8
 *
aD©a
){

934 
BtDbHdrCksum
 
hdr
;

936 
	`mem˝y
(&
hdr
.hdr, &
pLog
->
¢≠shŸ
.
dbhdr
, (
BtDbHdr
));

937 
	`btLogChecksum32
(1, (
u8
*)&
hdr
, 
	`off£tof
(
BtDbHdrCksum
, 
aCksum
), 0, hdr.aCksum);

938 
	`btDebugDbhdr
(
pLog
->
pLock
, "upd©e", &pLog->
¢≠shŸ
.
dbhdr
);

940 
	`as£π
–
hdr
.hdr.
iRoŸ
==2 );

941 
	`as£π
–
hdr
.hdr.
pgsz
>0 );

942 
	`mem˝y
(
aD©a
, &
hdr
, (
BtDbHdrCksum
));

944 #i‚de‡
NDEBUG


946 
BtDbHdr
 
t°
;

947 
	`btLogDecodeDbhdr
(
pLog
, 
aD©a
, &
t°
);

948 
	`as£π
–0==
	`memcmp
(&
t°
, &
pLog
->
¢≠shŸ
.
dbhdr
, (tst)) );

952  
SQLITE4_OK
;

953 
	}
}

960 
	$btLogRecovî
(
BtLog
 *
pLog
){

961 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

962 
i64
 
nByã
 = 0;

963 
rc
;

964 
BtWÆHdr
 *
pHdr
 = 0;

965 
iSlŸ
 = 0;

966 
FømeRecovîCtx
 
˘x
 = {0, 0};

967 
BtWÆHdr
 
hdr1
;

968 
BtWÆHdr
 
hdr2
;

970 
nCÆl
 = 0;

971 
nCÆl
++;

974 
rc
 = 
pVfs
->
	`xSize
(
pLog
->
pFd
, &
nByã
);

975 if–
rc
==
SQLITE4_OK
 && 
nByã
>0 ){

976 
rc
 = 
	`btLogRódHódî
(
pLog
, 0, &
hdr1
);

977 if–
rc
==
SQLITE4_OK
 ){

978 
rc
 = 
	`btLogRódHódî
(
pLog
, 
hdr1
.
nSe˘‹
, &
hdr2
);

979 if–
rc
==
SQLITE4_NOTFOUND
 ){

980 
pHdr
 = &
hdr1
;

981 }if–
rc
==
SQLITE4_OK
 ){

982 
aGª©î
[3] = {1, 2, 0};

983 
pHdr
 = ((
hdr2
.
iC¡
==
aGª©î
[
hdr1
.iCnt]) ? &hdr2 : &hdr1);

985 
iSlŸ
 = (
pHdr
==&
hdr2
);

986 }if–
rc
==
SQLITE4_NOTFOUND
 ){

987 
iOff
;

988 
iOff
=256; iOff<=65536 && 
rc
==
SQLITE4_NOTFOUND
; iOff=iOff*2){

989 
rc
 = 
	`btLogRódHódî
(
pLog
, 
iOff
, &
hdr1
);

991 if–
rc
==
SQLITE4_OK
 ){

992 
pHdr
 = &
hdr1
;

993 
iSlŸ
 = 1;

996 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

1001 if–
pHdr
 ){

1010 
rc
 = 
	`btLogTøvî£
(
pLog
, 
pHdr
, 
btLogRecovîFøme
, (*)&
˘x
);

1012 if–
rc
==
SQLITE4_OK
 && 
˘x
.
iLa°
>0 ){

1014 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

1015 
pShm
->
ck±
.
iWÆHdr
 = (
iSlŸ
<<2Ë+ 
pHdr
->
iC¡
;

1016 
pShm
->
ck±
.
iFú°Ród
 = 
pHdr
->
iFú°Føme
;

1017 
pShm
->
ck±
.
iFú°Recovî
 = 
pHdr
->
iFú°Føme
;

1018 
rc
 = 
	`btLogRﬁlbackRecovîy
(
pLog
, &
˘x
);

1019 
pLog
->
¢≠shŸ
.
iNextFøme
 = 
˘x
.iNextFrame;

1020 
pLog
->
¢≠shŸ
.
dbhdr
.
pgsz
 = 
pHdr
->
nPgsz
;

1021 
	`as£π
–
pShm
->
ck±
.
iFú°Ród
>0 );

1023 
	`as£π
–
rc
!=
SQLITE4_NOTFOUND
 );

1029 if–
rc
==
SQLITE4_OK
 ){

1030 
u32
 
nPg
 = 
pLog
->
¢≠shŸ
.
dbhdr
.nPg;

1031 
rc
 = 
	`btLogRódDbhdr
(
pLog
, &pLog->
¢≠shŸ
.
dbhdr
, 
˘x
.
iPageO√Føme
);

1032 if–
˘x
.
iLa°
>0 ){

1033 
pLog
->
¢≠shŸ
.
dbhdr
.
nPg
 =ÇPg;

1037 }if–
rc
==
SQLITE4_OK
 ){

1040 
	`btLogZîoS«pshŸ
(
pLog
);

1041 
rc
 = 
	`btLogRódDbhdr
(
pLog
, &pLog->
¢≠shŸ
.
dbhdr
, 0);

1044 if–
rc
==
SQLITE4_NOTFOUND
 ){

1049 
rc
 = 
pVfs
->
	`xSize
(
pLog
->
pLock
->
pFd
, &
nByã
);

1050 if–
rc
==
SQLITE4_OK
 ){

1051 if–
nByã
==0 ){

1052 
	`btLogZîoDbhdr
(
pLog
, &pLog->
¢≠shŸ
.
dbhdr
);

1054 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOTADB
);

1059 if–
rc
==
SQLITE4_OK
 ){

1060 
	`btDebugT›ﬁogy
(

1061 
pLog
->
pLock
, "ªcovîed",ÖLog->
¢≠shŸ
.
iHashSide
,ÖLog->¢≠shŸ.
aLog


1064 
	`btDebugDbhdr
(
pLog
->
pLock
, "ªad", &pLog->
¢≠shŸ
.
dbhdr
);

1066  
rc
;

1067 
	}
}

1075 
	$sqlôe4BtLogO≥n
(
BtPagî
 *
pPagî
, 
bRecovî
, 
BtLog
 **
µLog
){

1076 
BtLock
 *
pLock
 = (BtLock*)
pPagî
;

1077 
bt_ív
 *
pVfs
 = 
pLock
->pVfs;

1078 
sqlôe4_ív
 *
pEnv
 = 
pLock
->pEnv;

1079 
rc
;

1080 c⁄° *
zWÆ
;

1081 
BtLog
 *
pLog
;

1082 
Êags
 = 
BT_OPEN_LOG
;

1084 
pLog
 = 
	`sqlôe4_mÆloc
(
pEnv
, (
BtLog
));

1085 if–
pLog
==0 ){

1086 
rc
 = 
SQLITE4_NOMEM
;

1087 
›í_out
;

1089 
	`mem£t
(
pLog
, 0, (
BtLog
));

1090 
pLog
->
pLock
 = (
BtLock
*)
pPagî
;

1091 
pLog
->
nWøpLog
 = 
BT_NWRAPLOG
;

1093 
zWÆ
 = 
	`sqlôe4BtPagîFûíame
(
pPagî
, 
BT_PAGERFILE_LOG
);

1094 
rc
 = 
pVfs
->
	`xO≥n
(
pEnv
,ÖVfs, 
zWÆ
, 
Êags
, &
pLog
->
pFd
);

1096 if–
rc
==
SQLITE4_OK
 && 
bRecovî
 ){

1097 
rc
 = 
	`btLogM≠Shm
(
pLog
, 0);

1098 if–
rc
==
SQLITE4_OK
 ){

1099 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

1100 
	`mem£t
(
pShm
, 0, (
BtShm
));

1101 
pShm
->
ck±
.
iFú°Ród
 = 1;

1102 
pShm
->
ck±
.
iFú°Recovî
 = 1;

1103 
	`btLogZîoS«pshŸ
(
pLog
);

1104 
rc
 = 
	`btLogRecovî
(
pLog
);

1106 if–
rc
==
SQLITE4_OK
 ){

1107 
rc
 = 
	`btLogUpd©eSh¨edHdr
(
pLog
);

1111 
›í_out
:

1112 if–
rc
!=
SQLITE4_OK
 ){

1113 
	`sqlôe4BtLogClo£
(
pLog
, 0);

1114 
pLog
 = 0;

1116 *
µLog
 = 
pLog
;

1117  
rc
;

1118 
	}
}

1123 
	$sqlôe4BtLogClo£
(
BtLog
 *
pLog
, 
bCÀ™up
){

1124 
rc
 = 
SQLITE4_OK
;

1125 if–
pLog
 ){

1126 
sqlôe4_ív
 *
pEnv
 = 
pLog
->
pLock
->pEnv;

1127 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

1129 if–
pLog
->
pFd
 ) 
pVfs
->
	`xClo£
(pLog->pFd);

1130 if–
bCÀ™up
 ){

1131 
BtPagî
 *
pPagî
 = (BtPagî*)
pLog
->
pLock
;

1132 c⁄° *
zWÆ
 = 
	`sqlôe4BtPagîFûíame
(
pPagî
, 
BT_PAGERFILE_LOG
);

1133 
rc
 = 
pVfs
->
	`xU∆ök
(
pEnv
,ÖVfs, 
zWÆ
);

1136 
	`sqlôe4_‰ì
(
pEnv
, 
pLog
->
≠Shm
);

1137 
	`sqlôe4_‰ì
(
pEnv
, 
pLog
);

1140  
rc
;

1141 
	}
}

1143 
	$btLogWrôeHódî
(
BtLog
 *
pLog
, 
iHdr
, 
BtWÆHdr
 *
pHdr
){

1144 
rc
;

1145 
i64
 
iOff
;

1146 
	`as£π
–
iHdr
==0 || iHdr==1 );

1148 
	`btDebugLogHódî
(
pLog
->
pLock
, "wrôe", 
pHdr
, 
iHdr
);

1151 
	`btLogChecksum
(1, (
u8
*)
pHdr
, 
	`off£tof
(
BtWÆHdr
, 
aCksum
), 0,ÖHdr->aCksum);

1154 
iOff
 = 
iHdr
 * 
pLog
->
¢≠shŸ
.
nSe˘‹
;

1155 
rc
 = 
	`btLogWrôeD©a
(
pLog
, 
iOff
, (
u8
*)
pHdr
, (
BtWÆHdr
));

1157  
rc
;

1158 
	}
}

1160 
	$btLogHashSórch
(

1161 
BtLog
 *
pLog
,

1162 
iSide
,

1163 
iHash
,

1164 
u32
 
iHi
,

1165 
u32
 
pgno
,

1166 
u32
 *
piFøme


1168 
ht_¶Ÿ
 *
aHash
;

1169 
u32
 *
aPgno
;

1170 
u32
 
iZîo
;

1171 
rc
;

1173 
rc
 = 
	`btLogFödHash
(
pLog
, 
iSide
, 
iHash
, &
aHash
, &
aPgno
, &
iZîo
);

1174 if–
rc
==
SQLITE4_OK
 ){

1175 
nCﬁlide
 = 
HASHTABLE_NSLOT
*2;

1176 
iSlŸ
;

1177 
u32
 
iFøme
 = 0;

1179 
iSlŸ
 = 
	`btLogHashKey
(
pLog
, 
pgno
);

1180  ; 
aHash
[
iSlŸ
]; iSlŸ=
	`btLogHashNext
(
pLog
, iSlot)){

1181 if–
aPgno
[
aHash
[
iSlŸ
]-1]==
pgno
 ){

1182 
u32
 
iC™did©e
 = 
iZîo
 + 
aHash
[
iSlŸ
] - 1;

1183 if–
iC™did©e
<=
iHi
 ) 
iFøme
 = iCandidate;

1185 if–(
nCﬁlide
--)==0 )  
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

1188 *
piFøme
 = 
iFøme
;

1189 if–
iFøme
==0 ){

1190 
rc
 = 
SQLITE4_NOTFOUND
;

1194  
rc
;

1195 
	}
}

1203 
	$btLogRód
(
BtLog
 *
pLog
, 
u32
 
pgno
, 
u8
 *
aD©a
, u32 
iSa„
){

1204 c⁄° 
pgsz
 = 
pLog
->
¢≠shŸ
.
dbhdr
.pgsz;

1205 
rc
 = 
SQLITE4_NOTFOUND
;

1206 
u32
 
iFøme
 = 0;

1207 
i
;

1209 
u32
 *
aLog
 = 
pLog
->
¢≠shŸ
.aLog;

1210 
iSa„Idx
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iSa„
);

1213 
i
=2; i>=0 && 
rc
==
SQLITE4_NOTFOUND
; i--){

1214 
u32
 
iLo
 = 
pLog
->
¢≠shŸ
.
aLog
[
i
*2+0];

1215 if–
iLo
 ){

1216 
u32
 
iHi
 = 
pLog
->
¢≠shŸ
.
aLog
[
i
*2+1];

1217 
iSide
;

1218 
iHash
;

1219 
iHashLa°
;

1221 
iHash
 = 
	`btLogFømeHash
(
pLog
, 
iHi
);

1222 
iHashLa°
 = 
	`btLogFømeHash
(
pLog
, 
iLo
);

1223 
iSide
 = (
pLog
->
¢≠shŸ
.
iHashSide
 + (
i
==0)) % 2;

1225  ; 
rc
==
SQLITE4_NOTFOUND
 && 
iHash
>=
iHashLa°
; iHash--){

1226 
rc
 = 
	`btLogHashSórch
(
pLog
, 
iSide
, 
iHash
, 
iHi
, 
pgno
, &
iFøme
);

1227 if–
rc
==
SQLITE4_OK
 ){

1228 if–
iFøme
<
iLo
 || iFøme>
iHi
 ){

1229 
rc
 = 
SQLITE4_NOTFOUND
;

1231 
	`as£π
–
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iFøme
)>=0 );

1232 if–
iSa„Idx
>=0 && 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iFøme
)>iSafeIdx ){

1233  
SQLITE4_NOTFOUND
;

1241 
	`btDebugLogSórch
(
pLog
->
pLock
, 
pgno
, 
iSa„
, (
rc
==
SQLITE4_OK
 ? 
iFøme
 : 0));

1243 if–
rc
==
SQLITE4_OK
 ){

1244 
bt_ív
 *
pVfs
 = 
pLog
->
pLock
->pVfs;

1245 
i64
 
iOff
;

1246 
	`as£π
–
rc
==
SQLITE4_OK
 );

1247 
iOff
 = 
	`btLogFømeOff£t
(
pLog
, 
pgsz
, 
iFøme
);

1248 
rc
 = 
pVfs
->
	`xRód
(
pLog
->
pFd
, 
iOff
 + (
BtFømeHdr
), 
aD©a
, 
pgsz
);

1251 
	`Ârötf
(
°dîr
, "ªadÖagê%d from off£à%d\n", ()
pgno
, ()
iOff
);

1252 
	`fÊush
(
°dîr
);

1256  
rc
;

1257 
	}
}

1270 
	$sqlôe4BtLogRód
(
BtLog
 *
pLog
, 
u32
 
pgno
, 
u8
 *
aD©a
){

1271 if–
pLog
->
¢≠shŸ
.
aLog
[4]==0 ){

1272 
	`as£π
–
pLog
->
¢≠shŸ
.
aLog
[0]==0 &&ÖLog->snapshot.aLog[2]==0 );

1273  
SQLITE4_NOTFOUND
;

1275  
	`btLogRód
(
pLog
, 
pgno
, 
aD©a
, 0);

1276 
	}
}

1278 
	$btLogZîoHash
(
BtLog
 *
pLog
, 
iHash
){

1279 
iSide
 = 
pLog
->
¢≠shŸ
.
iHashSide
;

1280 
ht_¶Ÿ
 *
aHash
;

1281 
u32
 *
aPgno
;

1282 
u32
 
iZîo
;

1283 
rc
;

1285 
rc
 = 
	`btLogFödHash
(
pLog
, 
iSide
, 
iHash
, &
aHash
, &
aPgno
, &
iZîo
);

1286 if–
rc
==
SQLITE4_OK
 ){

1287 
	`mem£t
(
aHash
, 0, (
ht_¶Ÿ
)*
HASHTABLE_NSLOT
);

1289  
rc
;

1290 
	}
}

1292 
	$btLogWrôeFøme
(
BtLog
 *
pLog
, 
nPad
, 
u32
 
pgno
, 
u8
 *
aD©a
, u32 
nPg
){

1293 c⁄° 
pgsz
 = 
pLog
->
¢≠shŸ
.
dbhdr
.pgsz;

1294 
u32
 *
aLog
 = 
pLog
->
¢≠shŸ
.aLog;

1295 
rc
 = 
SQLITE4_OK
;

1296 
u32
 
iFøme
;

1297 
u32
 
iNextFøme
;

1298 
i64
 
iOff
;

1299 
BtFømeHdr
 
‰ame
;

1302 
iFøme
 = 
pLog
->
¢≠shŸ
.
iNextFøme
;

1303 
iOff
 = 
	`btLogFømeOff£t
(
pLog
, 
pgsz
, 
iFøme
);

1314 
iNextFøme
 = 
pLog
->
¢≠shŸ
.iNextFrame + 1;

1315 if–
iFøme
!=1 && iFøme==
aLog
[5]+1

1316 && 
aLog
[0]==0 &&áLog[2]==0

1317 && 
aLog
[4]!=0 &&áLog[4]>
pLog
->
nWøpLog


1320 
iNextFøme
 = 1;

1321 }if–(
iNextFøme
+
nPad
)>=
aLog
[0] && iNextFrame<=aLog[1] ){

1324 
iNextFøme
 = 
aLog
[1]+
nPad
+1;

1325 
	`as£π
–
iNextFøme
!=1 );

1327 if–
	`btLogFømeHash
(
pLog
, 
iNextFøme
)!=btLogFømeHash’Log, 
iFøme
) ){

1328 
rc
 = 
	`btLogZîoHash
(
pLog
, 
	`btLogFømeHash
’Log, 
iNextFøme
));

1332 if–
rc
==
SQLITE4_OK
 ){

1333 if–
iNextFøme
 & 0x80000000 ){

1334 
rc
 = 
SQLITE4_FULL
;

1336 
u32
 *
a
;

1339 
	`mem£t
(&
‰ame
, 0, (frame));

1340 
‰ame
.
pgno
 =Ögno;

1341 
‰ame
.
iNext
 = 
iNextFøme
;

1342 
‰ame
.
nPg
 =ÇPg;

1343 
a
 = 
pLog
->
¢≠shŸ
.
aFømeCksum
;

1344 
	`btLogChecksum32
(1,(
u8
*)&
‰ame
,
	`off£tof
(
BtFømeHdr
,
aCksum
),
a
,frame.aCksum);

1345 
	`btLogChecksum
(1, 
aD©a
, 
pgsz
, 
‰ame
.
aCksum
, frame.aCksum);

1347 
	`btDebugLogPage
(
pLog
->
pLock
, 
pgno
, 
iFøme
, 
aD©a
, 
pgsz
, 
nPg
);

1350 
rc
 = 
	`btLogWrôeD©a
(
pLog
, 
iOff
, (
u8
*)&
‰ame
, (frame));

1352 
pLog
->
¢≠shŸ
.
iNextFøme
 = iNextFrame;

1356 if–
rc
==
SQLITE4_OK
 ){

1357 
rc
 = 
	`btLogWrôeD©a
(
pLog
, 
iOff
+(
‰ame
), 
aD©a
, 
pgsz
);

1362 if–
rc
==
SQLITE4_OK
 ){

1363 if–
iFøme
==1 ){

1364 
pLog
->
¢≠shŸ
.
iHashSide
 = (pLog->snapshot.iHashSide+1) % 2;

1366 if–
nPg
 ) 
pLog
->
¢≠shŸ
.
dbhdr
.nPg =ÇPg;

1368 
rc
 = 
	`btLogHashIn£π
(
pLog
, 
pgno
, 
iFøme
);

1372 
	`btDebugCheckS«pshŸ
(&
pLog
->
¢≠shŸ
);

1373 
BtShmHdr
 
hdr
;

1374 
	`mem˝y
(&
hdr
, &
pLog
->
¢≠shŸ
, (
BtShmHdr
));

1375 if–
rc
==
SQLITE4_OK
 ){

1376 if–
	`btLogIsEm±y
(
pLog
) ){

1377 
	`as£π
–
iFøme
==1 );

1378 
aLog
[4] = 
iFøme
;

1379 }if–
iFøme
==1 ){

1380 
	`as£π
–
aLog
[0]==0 &&áLog[1]==0 &&áLog[2]==0 &&áLog[3]==0 );

1381 
aLog
[0] =áLog[4];

1382 
aLog
[1] =áLog[5];

1383 
aLog
[4] = 
iFøme
;

1384 }if–
iFøme
!=
aLog
[5]+1 ){

1385 
	`as£π
–
iFøme
>
aLog
[5] );

1386 
	`as£π
–
aLog
[2]==0 &&áLog[3]==0 );

1387 
aLog
[2] =áLog[4];

1388 
aLog
[3] =áLog[5];

1389 
aLog
[4] = 
iFøme
;

1392 
aLog
[5] = 
iFøme
;

1393 
	`mem˝y
(
pLog
->
¢≠shŸ
.
aFømeCksum
, 
‰ame
.
aCksum
, (frame.aCksum));

1395 
	`btDebugCheckS«pshŸ
(&
pLog
->
¢≠shŸ
);

1397  
rc
;

1398 
	}
}

1403 
	$sqlôe4BtLogWrôe
(
BtLog
 *
pLog
, 
u32
 
pgno
, 
u8
 *
aD©a
, u32 
nPg
){

1404 c⁄° 
pgsz
 = 
pLog
->
¢≠shŸ
.
dbhdr
.pgsz;

1405 
rc
 = 
SQLITE4_OK
;

1407 
nPad
 = 0;

1408 if–
pLog
->
pLock
->
iSa„tyLevñ
==
BT_SAFETY_FULL
 ){

1409 
nPad
 = (
pLog
->
¢≠shŸ
.
nSe˘‹
 + 
pgsz
-1) /Ögsz;

1417 if–
nPg
 ){

1418 
BtPagî
 *
pPagî
 = (BtPagî *)(
pLog
->
pLock
);

1419 
BtPage
 *
pO√
 = 0;

1420 
rc
 = 
	`sqlôe4BtPageGë
(
pPagî
, 1, &
pO√
);

1421 if–
rc
==
SQLITE4_OK
 ){

1422 
rc
 = 
	`sqlôe4BtLogWrôe
(
pLog
, 1, 
	`sqlôe4BtPageD©a
(
pO√
), 0);

1423 
	`sqlôe4BtPageRñó£
(
pO√
);

1425 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1430 if–
	`btLogIsEm±y
(
pLog
) ){

1431 
BtWÆHdr
 
hdr
;

1432 
	`mem£t
(&
hdr
, 0, (
BtWÆHdr
));

1434 
hdr
.
iMagic
 = 
BT_WAL_MAGIC
;

1435 
hdr
.
iVîsi⁄
 = 
BT_WAL_VERSION
;

1436 
hdr
.
nSe˘‹
 = 
pLog
->
¢≠shŸ
.nSector;

1437 
hdr
.
nPgsz
 = 
pgsz
;

1438 
hdr
.
iSÆt1
 = 22;

1439 
hdr
.
iSÆt2
 = 23;

1440 
hdr
.
iFú°Føme
 = 1;

1442 
rc
 = 
	`btLogWrôeHódî
(
pLog
, 0, &
hdr
);

1443 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1445 
pLog
->
¢≠shŸ
.
aFømeCksum
[0] = 
hdr
.
iSÆt1
;

1446 
pLog
->
¢≠shŸ
.
aFømeCksum
[1] = 
hdr
.
iSÆt2
;

1447 
pLog
->
¢≠shŸ
.
iNextFøme
 = 1;

1449 
	`btDebugCheckS«pshŸ
(&
pLog
->
¢≠shŸ
);

1451 
rc
 = 
	`btLogWrôeFøme
(
pLog
, 
nPad
, 
pgno
, 
aD©a
, 
nPg
);

1454 if–
nPg
 ){

1455 
i
;

1456 
i
=0; i<
nPad
 && 
rc
==
SQLITE4_OK
; i++){

1457 
rc
 = 
	`btLogWrôeFøme
(
pLog
, 
nPad
, 
pgno
, 
aD©a
, 
nPg
);

1459 if–
rc
==
SQLITE4_OK
 && 
pLog
->
pLock
->
iSa„tyLevñ
==
BT_SAFETY_FULL
 ){

1460 
rc
 = 
	`btLogSyncFûe
(
pLog
,ÖLog->
pFd
);

1462 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`btLogUpd©eSh¨edHdr
(
pLog
);

1465  
rc
;

1466 
	}
}

1472 
	$btLogChecksumOk
(
BtShmHdr
 *
pHdr
){

1473 
u32
 
aCksum
[2];

1474 
	`btLogChecksum32
(1, (
u8
*)
pHdr
, 
	`off£tof
(
BtShmHdr
, 
aCksum
), 0,áCksum);

1475  (
aCksum
[0]==
pHdr
->aCksum[0] &&áCksum[1]==pHdr->aCksum[1]);

1476 
	}
}

1478 
	$btLogS«pshŸ
(
BtLog
 *
pLog
, 
BtShmHdr
 *
pHdr
){

1479 
rc
;

1481 
rc
 = 
	`btLogM≠Shm
(
pLog
, 0);

1482 if–
rc
==
SQLITE4_OK
 ){

1483 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

1484 
nAâem±
 = 500;

1486  (
nAâem±
--)>0 ){

1487 
	`mem˝y
(
pHdr
, &
pShm
->
hdr1
, (
BtShmHdr
));

1488 if–
	`btLogChecksumOk
(
pHdr
) ) ;

1489 
	`mem˝y
(
pHdr
, &
pShm
->
hdr2
, (
BtShmHdr
));

1490 if–
	`btLogChecksumOk
(
pHdr
) ) ;

1493 if–
nAâem±
==0 ) 
rc
 = 
SQLITE4_PROTOCOL
;

1496  
rc
;

1497 
	}
}

1499 
	$btLogS«pshŸTrim
(
u32
 *
aLog
, u32 
iFú°
){

1500 if–
iFú°
 ){

1501 
iRegi⁄
;

1502 
iRegi⁄
=0; iRegion<3; iRegion++){

1503 if–
aLog
[
iRegi⁄
*2] ){

1504 if–
iFú°
>=
aLog
[
iRegi⁄
*2] && iFirst<=aLog[iRegion*2+1] ){

1505 
aLog
[
iRegi⁄
*2] = 
iFú°
;

1508 
aLog
[
iRegi⁄
*2] = 0;

1509 
aLog
[
iRegi⁄
*2+1] = 0;

1514 
	}
}

1516 
	$sqlôe4BtLogS«pshŸO≥n
(
BtLog
 *
pLog
){

1517 
u32
 *
aLog
 = 
pLog
->
¢≠shŸ
.aLog;

1518 
rc
 = 
SQLITE4_NOTFOUND
;

1519 
BtShmHdr
 
shmhdr
;

1520 
u32
 
iFú°Ród
 = 0;

1522  
rc
==
SQLITE4_NOTFOUND
 ){

1523 
BtShm
 *
pShm
;

1526 
rc
 = 
	`btLogS«pshŸ
(
pLog
, &pLog->
¢≠shŸ
);

1527 
	`btDebugCheckS«pshŸ
(&
pLog
->
¢≠shŸ
);

1530 if–
rc
==
SQLITE4_OK
 ){

1531 
BtRódSlŸ
 *
aRódlock
;

1532 
pShm
 = 
	`btLogShm
(
pLog
);

1534 
aRódlock
 = 
pShm
->aReadlock;

1535 
iFú°Ród
 = 
pShm
->
ck±
.iFirstRead;

1536 
rc
 = 
	`sqlôe4BtLockRódî
(
pLog
->
pLock
, 
aLog
, 
iFú°Ród
, 
aRódlock
);

1541 if–
rc
==
SQLITE4_OK
 ){

1542 
rc
 = 
	`btLogS«pshŸ
(
pLog
, &
shmhdr
);

1544 if–
rc
==
SQLITE4_OK
 ){

1545 if–
iFú°Ród
!=
pShm
->
ck±
.iFirstRead

1546 || 
	`memcmp
(&
shmhdr
, &
pLog
->
¢≠shŸ
, (
BtShmHdr
))

1548 
rc
 = 
SQLITE4_NOTFOUND
;

1552 if–
rc
!=
SQLITE4_OK
 ){

1553 
	`sqlôe4BtLockRódîU∆ock
(
pLog
->
pLock
);

1557 if–
rc
==
SQLITE4_OK
 ){

1558 
	`btDebugT›ﬁogy
(

1559 
pLog
->
pLock
, "¢≠shŸA",ÖLog->
¢≠shŸ
.
iHashSide
,ÖLog->¢≠shŸ.
aLog


1566 if–
rc
==
SQLITE4_OK
 ){

1567 
	`btLogS«pshŸTrim
(
aLog
, 
iFú°Ród
);

1570 if–
rc
==
SQLITE4_OK
 ){

1571 
	`btDebugT›ﬁogy
(

1572 
pLog
->
pLock
, "¢≠shŸB",ÖLog->
¢≠shŸ
.
iHashSide
,ÖLog->¢≠shŸ.
aLog


1576  
rc
;

1577 
	}
}

1579 
	$sqlôe4BtLogS«pshŸClo£
(
BtLog
 *
pLog
){

1580 
	`sqlôe4BtLockRódîU∆ock
(
pLog
->
pLock
);

1581  
SQLITE4_OK
;

1582 
	}
}

1589 
	$sqlôe4BtLogS«pshŸWrôe
(
BtLog
 *
pLog
){

1590 
BtLock
 *
pLock
 = 
pLog
->pLock;

1591 
rc
;

1593 
rc
 = 
	`sqlôe4BtLockWrôî
(
pLock
);

1594 if–
rc
==
SQLITE4_OK
 ){

1595 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

1596 
BtShmHdr
 
shmhdr
;

1600 
rc
 = 
	`btLogS«pshŸ
(
pLog
, &
shmhdr
);

1601 if–
rc
==
SQLITE4_OK
 && 
	`memcmp
(&
pShm
->
hdr1
, &pShm->
hdr2
, (
BtShmHdr
)) ){

1602 
	`mem˝y
(&
pShm
->
hdr1
, &
shmhdr
, (
BtShmHdr
));

1603 
	`mem˝y
(&
pShm
->
hdr2
, &
shmhdr
, (
BtShmHdr
));

1605 if–
rc
==
SQLITE4_OK
 && 
pLog
->
¢≠shŸ
.
iNextFøme
!=
shmhdr
.iNextFrame ){

1606 
rc
 = 
SQLITE4_BUSY
;

1615 if–
rc
==
SQLITE4_OK
 ){

1616 
u32
 *
aLog
 = 
shmhdr
.aLog;

1617 
u32
 
iRecovî
 = 
pShm
->
ck±
.
iFú°Recovî
;

1618 
u32
 
iRód
 = 0;

1620 
	`btDebugT›ﬁogy
(
pLog
->
pLock
, "¢≠shŸC", 
shmhdr
.
iHashSide
, 
aLog
);

1622 
	`as£π
–
shmhdr
.
iHashSide
==
pLog
->
¢≠shŸ
.iHashSide );

1623 
	`btDebugCheckS«pshŸ
(&
pLog
->
¢≠shŸ
);

1625 
rc
 = 
	`sqlôe4BtLockRódîQuîy
(
pLock
, 
aLog
, 
pShm
->
aRódlock
, &
iRód
, 0);

1627 if–
rc
==
SQLITE4_OK
 ){

1630 
u32
 
iTrim
 = 
iRecovî
;

1631 if–
iRód
 ){

1632 
iIdxRód
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iRód
);

1633 if–
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iRecovî
)>
iIdxRód
 ) 
iTrim
 = 
iRód
;

1636 if–
iTrim
==0 || iTrim==
shmhdr
.
iNextFøme
 || 
	`btLogIsEm±y
(
pLog
) ){

1637 
	`mem£t
(
aLog
, 0, (
u32
)*6);

1639 
i
;

1640 
i
=0; i<3; i++){

1641 
bIn
 = (
aLog
[2*
i
]<=
iTrim
 && iTrim<=aLog[2*i+1]);

1642 if–
bIn
 ){

1643 
aLog
[2*
i
] = 
iTrim
;

1646 
aLog
[2*
i
] =áLog[2*i+1] = 0;

1652 
	`btDebugT›ﬁogy
(
pLog
->
pLock
, "¢≠shŸD", 
shmhdr
.
iHashSide
, 
aLog
);

1654 if–
rc
==
SQLITE4_OK
 ){

1655 
	`mem˝y
(
pLog
->
¢≠shŸ
.
aLog
,áLog, (
u32
)*6);

1657 
	`btDebugCheckS«pshŸ
(&
pLog
->
¢≠shŸ
);

1661  
rc
;

1662 
	}
}

1664 
	$sqlôe4BtLogS«pshŸEndWrôe
(
BtLog
 *
pLog
){

1665  
	`sqlôe4BtLockWrôîU∆ock
(
pLog
->
pLock
);

1666 
	}
}

1668 
	$btLogMîgeI≈œ˚
(

1669 
u32
 *
aLe·
, 
nLe·
,

1670 
u32
 *
aRight
, 
nRight
,

1671 
u32
 *
aS∑˚
,

1672 *
≤Out


1674 
iLe·
 = 0;

1675 
iRight
 = 0;

1676 
iOut
 = 0;

1678  
iLe·
<
nLe·
 || 
iRight
<
nRight
 ){

1679 
u32
 
v
;

1680 if–
iRight
==
nRight
 || (
iLe·
<
nLe·
 && 
aLe·
[iLe·]<
aRight
[iRight]) ){

1681 
	`as£π
–
iLe·
<
nLe·
 );

1682 
v
 = 
aLe·
[
iLe·
++];

1684 
	`as£π
–
iRight
<
nRight
 );

1685 
v
 = 
aRight
[
iRight
++];

1687 if–
v
 && (
iOut
==0 || v!=
aS∑˚
[iOut-1]) )áSpace[iOut++] = v;

1690 
	`mem˝y
(
aLe·
, 
aS∑˚
, 
iOut
*(
u32
));

1691 
	`mem£t
(&
aLe·
[
iOut
], 0, ((
nLe·
+
nRight
)-iOutË* (
u32
));

1692 *
≤Out
 = 
iOut
;

1693 
	}
}

1695 
	$btLogMîgeS‹t
(

1696 
u32
 *
aPgno
,

1697 *
≤Pgno
,

1698 
u32
 *
aS∑˚


1700 
nMîge
;

1701 
nPgno
 = *
≤Pgno
;

1703 
nMîge
=1;ÇMîge<
nPgno
;ÇMerge=nMerge*2){

1704 
iLe·
;

1705 
iLe·
=0; iLe·<
nPgno
; iLe·+=(
nMîge
*2)){

1706 
u32
 *
aLe·
 = &
aPgno
[
iLe·
];

1707 
nLe·
 = 
	`MIN
(
nMîge
, 
nPgno
-
iLe·
);

1708 
u32
 *
aRight
 = &
aPgno
[
iLe·
+
nMîge
];

1709 
nRight
 = 
	`MIN
(
nMîge
, 
nPgno
-
iLe·
-
nLe·
);

1710 
	`btLogMîgeI≈œ˚
(
aLe·
, 
nLe·
, 
aRight
, 
nRight
, 
aS∑˚
, 
≤Pgno
);

1713 
	}
}

1715 
	$sqlôe4BtLogFømeToIdx
(
u32
 *
aLog
, u32 
iFøme
){

1716 
i
;

1717 
iRë
 = 0;

1718 
i
=0; i<3; i++){

1719 
u32
 
iFú°
 = 
aLog
[
i
*2];

1720 
u32
 
iLa°
 = 
aLog
[
i
*2+1];

1721 if–
iFú°
 ){

1722 if–
iFøme
>=
iFú°
 && iFøme<=
iLa°
 ){

1723 
iRë
 +(
iFøme
 - 
iFú°
);

1724  
iRë
;

1726 
iRë
 +(
iLa°
 - 
iFú°
) + 1;

1730 if–
i
==3 )  -1;

1731  
iRë
;

1732 
	}
}

1741 
	$btLogG©hîPgno
(

1742 
BtLog
 *
pLog
,

1743 
nFømeBuf„r
,

1744 
u32
 **
∑Pgno
,

1745 *
≤Pgno
,

1746 
u32
 *
piLa°Føme


1748 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

1749 
BtLock
 *
pLock
 = 
pLog
->pLock;

1750 
u32
 *
aLog
 = 
pLog
->
¢≠shŸ
.aLog;

1751 
u32
 
i
;

1752 
u32
 *
aPgno
;

1753 
nPgno
;

1754 
u32
 *
aS∑˚
;

1755 
nMax
;

1756 
rc
 = 
SQLITE4_OK
;

1757 
iRegi⁄
;

1758 
bLocked
;

1759 
u32
 
iSa„
;

1761 
iSa„Idx
 = -1;

1762 
iFú°Idx
 = -1;

1763 
iBufIdx
;

1764 
iIdx
 = 0;

1766 *
∑Pgno
 = 0;

1767 *
≤Pgno
 = 0;

1768 *
piLa°Føme
 = 0;

1770 
rc
 = 
	`sqlôe4BtLockRódîQuîy
(
pLock
, 
aLog
, 
pShm
->
aRódlock
, &
iSa„
, &
bLocked
);

1771 if–
rc
!=
SQLITE4_OK
 || 
bLocked
 ) Ñc;

1772 
	`btDebugLogSa„poöt
(
pLock
, 
iSa„
);

1773 
	`btDebugT›ﬁogy
(

1774 
pLock
, "checkpoöãr", 
pLog
->
¢≠shŸ
.
iHashSide
,ÖLog->¢≠shŸ.
aLog


1777 
iFú°Idx
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
pShm
->
ck±
.
iFú°Recovî
);

1778 
iSa„Idx
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
iSa„
);

1779 
iBufIdx
 = 
	`sqlôe4BtLogFømeToIdx
(
aLog
, 
pLog
->
¢≠shŸ
.aLog[5]Ë- 
nFømeBuf„r
;

1780 if–
iSa„Idx
<0 || 
iBufIdx
<iSafeIdx ) iSafeIdx = iBufIdx;

1781 if–
iSa„Idx
<0 || (
iFú°Idx
>=0 && iSa„Idx<iFú°IdxËË 
rc
;

1785 
nMax
 = 
iSa„Idx
 - 
iFú°Idx
 +1;

1788 
aPgno
 = (
u32
*)
	`sqlôe4_mÆloc
(
pLog
->
pLock
->
pEnv
, (u32)*
nMax
*2);

1789 if–
aPgno
==0 ) 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

1790 
aS∑˚
 = &
aPgno
[
nMax
];

1791 
nPgno
 = 0;

1794 
iRegi⁄
=0; iRegion<3; iRegion++){

1795 
u32
 
iFú°
 = 
aLog
[
iRegi⁄
*2];

1796 
u32
 
iLa°
 = 
aLog
[
iRegi⁄
*2+1];

1797 if–
iFú°
 ){

1799 
i
=
iFú°
; 
rc
==
SQLITE4_OK
 && i<=
iLa°
; i++, 
iIdx
++){

1800 
iHash
 = 
	`btLogFømeHash
(
pLog
, 
i
);

1801 
u32
 *
aPage
;

1802 
ht_¶Ÿ
 *
aHash
;

1803 
u32
 
iZîo
;

1810 if–(
iFú°Idx
>=0 && 
iIdx
<iFirstIdx)

1811 || (
iSa„Idx
>=0 && 
iIdx
>iSafeIdx)

1815 *
piLa°Føme
 = 
i
;

1821 
rc
 = 
	`btLogFödHash
(
pLog
, 0, 
iHash
, &
aHash
, &
aPage
, &
iZîo
);

1822 if–
rc
==
SQLITE4_OK
 ){

1823 
aPgno
[
nPgno
++] = 
aPage
[
i
-
iZîo
];

1831 if–
rc
==
SQLITE4_OK
 ){

1832 
	`btLogMîgeS‹t
(
aPgno
, &
nPgno
, 
aS∑˚
);

1833 *
≤Pgno
 = 
nPgno
;

1834 *
∑Pgno
 = 
aPgno
;

1836 
	`sqlôe4_‰ì
(
pLog
->
pLock
->
pEnv
, 
aPgno
);

1837 *
∑Pgno
 = 0;

1838 *
≤Pgno
 = 0;

1841  
rc
;

1842 
	}
}

1850 
	$sqlôe4BtLogSize
(
BtLog
 *
pLog
){

1852 ()
pLog
->
¢≠shŸ
.
aLog
[1] - ()pLog->snapshot.aLog[0]

1853 + (
pLog
->
¢≠shŸ
.
aLog
[0]!=0)

1854 + ()
pLog
->
¢≠shŸ
.
aLog
[3] - ()pLog->snapshot.aLog[2]

1855 + (
pLog
->
¢≠shŸ
.
aLog
[3]!=0)

1856 + ()
pLog
->
¢≠shŸ
.
aLog
[5] - ()pLog->snapshot.aLog[4]

1857 + (
pLog
->
¢≠shŸ
.
aLog
[5]!=0)

1859 
	}
}

1861 
	$btLogMîge
(
BtLog
 *
pLog
, 
u8
 *
aBuf
){

1862 
bt_db
 *
db
 = (bt_db*)
	`sqlôe4BtPagîExåa
((
BtPagî
*)
pLog
->
pLock
);

1863  
	`sqlôe4BtMîge
(
db
, &
pLog
->
¢≠shŸ
.
dbhdr
, 
aBuf
);

1864 
	}
}

1866 
	$sqlôe4BtLogCheckpoöt
(
BtLog
 *
pLog
, 
nFømeBuf„r
){

1867 
BtLock
 *
pLock
 = 
pLog
->pLock;

1868 
rc
;

1871 
rc
 = 
	`sqlôe4BtLockCk±
(
pLock
);

1872 if–
rc
==
SQLITE4_OK
 ){

1873 
pgsz
;

1874 
bt_ív
 *
pVfs
 = 
pLock
->pVfs;

1875 
bt_fûe
 *
pFd
 = 
pLock
->pFd;

1876 
BtShm
 *
pShm
;

1877 
u32
 
iLa°
;

1878 
BtFømeHdr
 
fhdr
;

1879 
u32
 *
aPgno
 = 0;

1880 
nPgno
;

1881 
i
;

1882 
u8
 *
aBuf
;

1883 
u32
 
iFú°Ród
;

1885 
rc
 = 
	`btLogS«pshŸ
(
pLog
, &pLog->
¢≠shŸ
);

1886 
	`sqlôe4BtPagîSëDbhdr
((
BtPagî
*)
pLock
, &
pLog
->
¢≠shŸ
.
dbhdr
);

1887 
pgsz
 = 
pLog
->
¢≠shŸ
.
dbhdr
.pgsz;

1889 if–
rc
==
SQLITE4_OK
 ){

1891 
aBuf
 = 
	`sqlôe4_mÆloc
(
pLock
->
pEnv
, 
pgsz
);

1892 if–
aBuf
==0 ) 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

1898 if–
rc
==
SQLITE4_OK
 ){

1899 
rc
 = 
	`btLogG©hîPgno
(
pLog
, 
nFømeBuf„r
, &
aPgno
, &
nPgno
, &
iLa°
);

1902 if–
rc
==
SQLITE4_OK
 && 
nPgno
>0 ){

1903 
i64
 
iOff
 = 
	`btLogFømeOff£t
(
pLog
, 
pgsz
, 
iLa°
);

1906 if–
rc
==
SQLITE4_OK
 ){

1907 
rc
 = 
	`btLogSyncFûe
(
pLog
,ÖLog->
pFd
);

1910 
rc
 = 
	`btLogRódD©a
(
pLog
, 
iOff
, (
u8
*)&
fhdr
, (
BtFømeHdr
));

1911 
iFú°Ród
 = 
fhdr
.
iNext
;

1914 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nPgno
; i++){

1915 
u32
 
pgno
 = 
aPgno
[
i
];

1916 
rc
 = 
	`btLogRód
(
pLog
, 
pgno
, 
aBuf
, 
iLa°
);

1917 if–
rc
==
SQLITE4_OK
 ){

1918 
i64
 
iOff
 = (i64)
pgsz
 * (
pgno
-1);

1919 if–
pgno
==1 ){

1920 
rc
 = 
	`btLogUpd©eDbhdr
(
pLog
, 
aBuf
);

1921 }if–
pgno
==
pLog
->
¢≠shŸ
.
dbhdr
.
iSRoŸ
 ){

1922 
rc
 = 
	`btLogMîge
(
pLog
, 
aBuf
);

1924 if–
rc
==
SQLITE4_OK
 ){

1925 
	`btDebugCk±Page
(
pLog
->
pLock
, 
pgno
, 
aBuf
, 
pgsz
);

1926 
rc
 = 
pVfs
->
	`xWrôe
(
pFd
, 
iOff
, 
aBuf
, 
pgsz
);

1928 }if–
rc
==
SQLITE4_NOTFOUND
 ){

1929 
rc
 = 
SQLITE4_OK
;

1934 if–
rc
==
SQLITE4_OK
 ){

1935 
rc
 = 
	`btLogSyncFûe
(
pLog
,ÖLog->
pLock
->
pFd
);

1942 if–
rc
==
SQLITE4_OK
 ){

1943 
	`as£π
–
iFú°Ród
>0 );

1944 
pShm
 = 
	`btLogShm
(
pLog
);

1945 
pShm
->
ck±
.
iFú°Ród
 = iFirstRead;

1946 
pVfs
->
	`xShmB¨rõr
(
pLog
->
pFd
);

1953 if–
rc
==
SQLITE4_OK
 ){

1954 
iSlŸ
 = ((
pShm
->
ck±
.
iWÆHdr
 >> 2) + 1) % 2;

1955 
BtWÆHdr
 
hdr
;

1957 
	`mem£t
(&
hdr
, 0, (
BtWÆHdr
));

1958 
hdr
.
iMagic
 = 
BT_WAL_MAGIC
;

1959 
hdr
.
iVîsi⁄
 = 
BT_WAL_VERSION
;

1960 
hdr
.
iC¡
 = (((
pShm
->
ck±
.
iWÆHdr
 & 0x03) + 1) % 3);

1961 
hdr
.
nSe˘‹
 = 
pLog
->
¢≠shŸ
.nSector;

1962 
hdr
.
nPgsz
 = 
pgsz
;

1963 
hdr
.
iFú°Føme
 = 
iFú°Ród
;

1965 
hdr
.
iSÆt1
 = 
fhdr
.
aCksum
[0];

1966 
hdr
.
iSÆt2
 = 
fhdr
.
aCksum
[1];

1967 
rc
 = 
	`btLogWrôeHódî
(
pLog
, 
iSlŸ
, &
hdr
);

1968 if–
rc
==
SQLITE4_OK
 ){

1969 
rc
 = 
	`btLogSyncFûe
(
pLog
,ÖLog->
pFd
);

1971 if–
rc
==
SQLITE4_OK
 ){

1972 
pShm
->
ck±
.
iWÆHdr
 = (
iSlŸ
<<2Ë+ 
hdr
.
iC¡
;

1979 if–
rc
==
SQLITE4_OK
 ){

1980 
pShm
->
ck±
.
iFú°Recovî
 = 
iFú°Ród
;

1981 
pVfs
->
	`xShmB¨rõr
(
pLog
->
pFd
);

1986 
	`sqlôe4_‰ì
(
pLock
->
pEnv
, 
aBuf
);

1987 
	`sqlôe4_‰ì
(
pLock
->
pEnv
, 
aPgno
);

1988 
	`sqlôe4BtLockCk±U∆ock
(
pLock
);

1989 
	`sqlôe4BtPagîSëDbhdr
((
BtPagî
*)
pLock
, 0);

1992  
rc
;

1993 
	}
}

1999 
	$sqlôe4BtLogPagesize
(
BtLog
 *
pLog
){

2000  
pLog
->
¢≠shŸ
.
dbhdr
.
pgsz
;

2001 
	}
}

2006 
	$sqlôe4BtLogPagecou¡
(
BtLog
 *
pLog
){

2007  (
pLog
->
¢≠shŸ
.
dbhdr
.
nPg
==1 ? 2 :ÖLog->snapshot.dbhdr.nPg);

2008 
	}
}

2013 
u32
 
	$sqlôe4BtLogCookõ
(
BtLog
 *
pLog
){

2014  
pLog
->
¢≠shŸ
.
dbhdr
.
iCookõ
;

2015 
	}
}

2018 
BtDbHdr
 *
	$sqlôe4BtLogDbhdr
(
BtLog
 *
pLog
){

2019  &
pLog
->
¢≠shŸ
.
dbhdr
;

2020 
	}
}

2022 
	$sqlôe4BtLogRñﬂdDbHdr
(
BtLog
 *
pLog
){

2023 
BtShm
 *
pShm
 = 
	`btLogShm
(
pLog
);

2024 
	`mem˝y
(&
pLog
->
¢≠shŸ
, &
pShm
->
hdr1
, (
BtShmHdr
));

2025 
	}
}

2027 
	$sqlôe4BtLogDbhdrFlush
(
BtLog
 *
pLog
){

2028 
BtPagî
 *
pPagî
 = (BtPagî *)(
pLog
->
pLock
);

2029 
BtPage
 *
pO√
 = 0;

2030 
rc
;

2032 
rc
 = 
	`sqlôe4BtPageGë
(
pPagî
, 1, &
pO√
);

2033 if–
rc
==
SQLITE4_OK
 ){

2034 
rc
 = 
	`sqlôe4BtPageWrôe
(
pO√
);

2036 if–
rc
==
SQLITE4_OK
 ){

2037 
	`btLogUpd©eDbhdr
(
pLog
, 
	`sqlôe4BtPageD©a
(
pO√
));

2039 
	`sqlôe4BtPageRñó£
(
pO√
);

2041  
rc
;

2042 
	}
}

2047 
	$sqlôe4BtLogSëCookõ
(
BtLog
 *
pLog
, 
u32
 
iCookõ
){

2048 
BtPagî
 *
pPagî
 = (BtPagî *)(
pLog
->
pLock
);

2049 
BtPage
 *
pO√
 = 0;

2050 
rc
;

2052 
rc
 = 
	`sqlôe4BtPageGë
(
pPagî
, 1, &
pO√
);

2053 if–
rc
==
SQLITE4_OK
 ){

2054 
rc
 = 
	`sqlôe4BtPageWrôe
(
pO√
);

2056 if–
rc
==
SQLITE4_OK
 ){

2057 
pLog
->
¢≠shŸ
.
dbhdr
.
iCookõ
 = iCookie;

2058 
	`btLogUpd©eDbhdr
(
pLog
, 
	`sqlôe4BtPageD©a
(
pO√
));

2060 
	`sqlôe4BtPageRñó£
(
pO√
);

2062  
rc
;

2063 
	}
}

	@src/bt_main.c

15 
	~"btI¡.h
"

16 
	~<°rög.h
>

17 
	~<as£π.h
>

18 
	~<°ddef.h
>

20 
	#BT_MAX_DEPTH
 32

	)

21 
	#BT_MAX_DIRECT_OVERFLOW
 8

	)

26 
	#BT_MAX_INTERNAL_KEY
 200

	)

32 
	#BT_PGFLAGS_INTERNAL
 0x01

	)

33 
	#BT_PGFLAGS_METATREE
 0x02

	)

34 
	#BT_PGFLAGS_SCHEDULE
 0x04

	)

35 
	#BT_PGFLAGS_LARGEKEYS
 0x08

	)

40 
	#MAX_SUBTREE_DEPTH
 8

	)

44 
BtCurs‹
 
	tBtCurs‹
;

45 
FiCurs‹
 
	tFiCurs‹
;

46 
FiSubCurs‹
 
	tFiSubCurs‹
;

48 
	sbt_db
 {

49 
sqlôe4_ív
 *
	mpEnv
;

50 
sqlôe4_mm
 *
	mpMM
;

51 
BtPagî
 *
	mpPagî
;

52 
bt_curs‹
 *
	mpAŒC§
;

53 
	mnMöMîge
;

54 
	mnScheduÀAŒoc
;

55 
	mbFa°In£πOp
;

57 
BtCurs‹
 *
	mpFªeC§
;

63 
BtOvÊ
 
	tBtOvÊ
;

64 
	sBtOvÊ
 {

65 
	mnKey
;

66 
	mnVÆ
;

67 
sqlôe4_buf„r
 
	mbuf
;

82 
	#CSR_TYPE_BT
 0x0001

	)

83 
	#CSR_TYPE_FAST
 0x0002

	)

84 
	#CSR_NEXT_OK
 0x0004

	)

85 
	#CSR_PREV_OK
 0x0008

	)

86 
	#CSR_VISIT_DEL
 0x0010

	)

88 
	#IsBtC§
(
pC§
Ë((’C§)->
Êags
 & 
CSR_TYPE_BT
)!=0)

	)

93 
	sbt_curs‹
 {

94 
	mÊags
;

95 *
	mpExåa
;

96 
bt_db
 *
	mpDb
;

97 
bt_curs‹
 *
	mpNextC§
;

103 
	sBtCurs‹
 {

104 
bt_curs‹
 
	mba£
;

106 
u32
 
	miRoŸ
;

107 
	mnPg
;

108 
BtOvÊ
 
	movÊ
;

110 
	mbRequúeRe£ek
;

111 
	mbSkùNext
;

112 
	mbSkùPªv
;

114 
BtCurs‹
 *
	mpNextFªe
;

116 
	maiCñl
[
BT_MAX_DEPTH
];

117 
BtPage
 *
	m≠Page
[
BT_MAX_DEPTH
];

123 
	sFiSubCurs‹
 {

124 
u8
 
	maPªfix
[8];

125 
BtCurs‹
 
	mmc§
;

126 
BtCurs‹
 
	mc§
;

128 
	sFiCurs‹
 {

129 
bt_curs‹
 
	mba£
;

130 
	miBt
;

131 
	mnBt
;

132 
FiSubCurs‹
 *
	maSub
;

138 
fiLﬂdSumm¨y
(
bt_db
 *, 
BtCurs‹
 *, c⁄° 
u8
 **, *);

139 
btRódSumm¨y
(c⁄° 
u8
 *, , 
u16
 *, u16 *, u16 *);

140 
btC§D©a
(
BtCurs‹
 *, , , const **, *);

141 
btRódScheduÀ
(
bt_db
 *, 
u8
 *, 
BtScheduÀ
 *);

142 
btC§End
(
BtCurs‹
 *
pC§
, 
bLa°
);

143 
btC§Sãp
(
BtCurs‹
 *
pC§
, 
bNext
);

144 
btC§Key
(
BtCurs‹
 *
pC§
, c⁄° **
µK
, *
≤K
);

145 
sqlôe4BtDebugFa°Tªe
(
bt_db
 *
db
, 
iCÆl
);

151 c⁄° 
u8
 
	gaSumm¨yKey
[] = {0xFF, 0xFF, 0xFF, 0xFF};

153 #i‚de‡
btEº‹Bk±


154 
	$btEº‹Bk±
(
rc
){

155 
îr‹_˙t
 = 0;

156 
îr‹_˙t
++;

157  
rc
;

158 
	}
}

161 #i‡!
deföed
(
NDEBUG
)

162 
	$btCheckPageRefs
(
bt_db
 *
pDb
){

163 
nA˘uÆ
 = 0;

164 
nEx≥˘
 = 0;

165 
bt_curs‹
 *
pC§
;

167 
pC§
=
pDb
->
pAŒC§
;ÖC§;ÖC§ıC§->
pNextC§
){

168 if–
	`IsBtC§
(
pC§
) ){

169 
BtCurs‹
 *
p
 = (BtCurs‹*)
pC§
;

170 if–
p
->
nPg
>0 ) 
nEx≥˘
 +=Ö->nPg;

172 
FiCurs‹
 *
p
 = (FiCurs‹*)
pC§
;

173 
i
;

174 
i
=0; i<
p
->
nBt
; i++){

175 if–
p
->
aSub
[
i
].
mc§
.
nPg
>0 ) 
nEx≥˘
 +=Ö->aSub[i].mcsr.nPg;

176 if–
p
->
aSub
[
i
].
c§
.
nPg
>0 ) 
nEx≥˘
 +=Ö->aSub[i].csr.nPg;

180 
nA˘uÆ
 = 
	`sqlôe4BtPagîRefcou¡
(
pDb
->
pPagî
);

181 
	`as£π
–
nA˘uÆ
==
nEx≥˘
 );

182 
	}
}

184 
	#btCheckPageRefs
(
x
)

	)

191 
u32
 
	$sqlôe4BtGëU32
(c⁄° 
u8
 *
a
){

192  ((
u32
)
a
[0] << 24) + ((u32)a[1] << 16) + ((u32)a[2] << 8) + ((u32)a[3]);

193 
	}
}

194 
	#btGëU32
(
x
Ë
	`sqlôe4BtGëU32
(x)

	)

200 
u16
 
	$btGëU16
(c⁄° 
u8
 *
a
){

201  ((
u32
)
a
[0] << 8) + (u32)a[1];

202 
	}
}

208 
	$btPutU16
(
u8
 *
a
, 
u16
 
i
){

209 
a
[0] = (
u8
)((
i
>>8) & 0xFF);

210 
a
[1] = (
u8
)((
i
>>0) & 0xFF);

211 
	}
}

217 
	$sqlôe4BtPutU32
(
u8
 *
a
, 
u32
 
i
){

218 
a
[0] = (
u8
)((
i
>>24) & 0xFF);

219 
a
[1] = (
u8
)((
i
>>16) & 0xFF);

220 
a
[2] = (
u8
)((
i
>>8) & 0xFF);

221 
a
[3] = (
u8
)((
i
>>0) & 0xFF);

222 
	}
}

223 
	#btPutU32
(
x
,
y
Ë
	`sqlôe4BtPutU32
(x,y)

	)

225 
	sFakePage
 { 
u8
 *
	maD©a
; };

226 
	#btPageD©a
(
pPg
Ë(((
FakePage
*)’Pg))->
aD©a
)

	)

231 
	$sqlôe4BtNew
(
sqlôe4_ív
 *
pEnv
, 
nExåa
, 
bt_db
 **
µDb
){

232 c⁄° 
MIN_MERGE
 = 2;

233 c⁄° 
SCHEDULE_ALLOC
 = 4;

235 
bt_db
 *
db
 = 0;

236 
BtPagî
 *
pPagî
 = 0;

237 
nReq
;

238 
rc
;

240 
nReq
 = (
bt_db
);

241 
rc
 = 
	`sqlôe4BtPagîNew
(
pEnv
, 
nExåa
 + 
nReq
, &
pPagî
);

242 if–
rc
==
SQLITE4_OK
 ){

243 
db
 = (
bt_db
*)
	`sqlôe4BtPagîExåa
(
pPagî
);

244 
db
->
pPagî
 =ÖPager;

245 
db
->
pEnv
 =ÖEnv;

247 
db
->
nMöMîge
 = 
MIN_MERGE
;

248 
db
->
nScheduÀAŒoc
 = 
SCHEDULE_ALLOC
;

251 *
µDb
 = 
db
;

252  
rc
;

253 
	}
}

259 
	$sqlôe4BtClo£
(
bt_db
 *
db
){

260 if–
db
 ){

261 
BtCurs‹
 *
pC§
;

262 
BtCurs‹
 *
pNext
;

263 
pC§
=
db
->
pFªeC§
;ÖC§;ÖC§=
pNext
){

264 
pNext
 = 
pC§
->
pNextFªe
;

265 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
pC§
);

267 
	`sqlôe4BtPagîClo£
(
db
->
pPagî
);

269  
SQLITE4_OK
;

270 
	}
}

276 *
	$sqlôe4BtExåa
(
bt_db
 *
db
){

277  (*)&
db
[1];

278 
	}
}

280 
	$sqlôe4BtO≥n
(
bt_db
 *
db
, c⁄° *
zFûíame
){

281 
rc
;

282 
	`sqlôe4_ív_c⁄fig
(
db
->
pEnv
, 
SQLITE4_ENVCONFIG_GETMM
, &db->
pMM
);

283 
rc
 = 
	`sqlôe4BtPagîO≥n
(
db
->
pPagî
, 
zFûíame
);

284  
rc
;

285 
	}
}

287 
	$sqlôe4BtBegö
(
bt_db
 *
db
, 
iLevñ
){

288 
rc
;

289 
rc
 = 
	`sqlôe4BtPagîBegö
(
db
->
pPagî
, 
iLevñ
);

290  
rc
;

291 
	}
}

293 
	$sqlôe4BtCommô
(
bt_db
 *
db
, 
iLevñ
){

294 
rc
;

295 
rc
 = 
	`sqlôe4BtPagîCommô
(
db
->
pPagî
, 
iLevñ
);

296  
rc
;

297 
	}
}

299 
	$sqlôe4BtRevît
(
bt_db
 *
db
, 
iLevñ
){

300 
rc
;

301 
rc
 = 
	`sqlôe4BtPagîRevît
(
db
->
pPagî
, 
iLevñ
);

302  
rc
;

303 
	}
}

305 
	$sqlôe4BtRﬁlback
(
bt_db
 *
db
, 
iLevñ
){

306 
rc
;

307 
rc
 = 
	`sqlôe4BtPagîRﬁlback
(
db
->
pPagî
, 
iLevñ
);

308  
rc
;

309 
	}
}

311 
	$sqlôe4BtTønß˘i⁄Levñ
(
bt_db
 *
db
){

312  
	`sqlôe4BtPagîTønß˘i⁄Levñ
(
db
->
pPagî
);

313 
	}
}

315 
	$btC§Sëup
(
bt_db
 *
db
, 
u32
 
iRoŸ
, 
BtCurs‹
 *
pC§
){

316 
	`mem£t
(
pC§
, 0, 
	`off£tof
(
BtCurs‹
, 
aiCñl
));

317 
pC§
->
ba£
.
Êags
 = 
CSR_TYPE_BT
;

318 
pC§
->
ba£
.
pExåa
 = (*)&pCsr[1];

319 
pC§
->
ba£
.
pDb
 = 
db
;

320 
pC§
->
iRoŸ
 = iRoot;

321 
pC§
->
ovÊ
.
buf
.
pMM
 = 
db
->pMM;

322 
	}
}

324 
	$sqlôe4BtC§O≥n
(
bt_db
 *
db
, 
nExåa
, 
bt_curs‹
 **
µC§
){

325 
rc
 = 
SQLITE4_OK
;

326 
bt_curs‹
 *
pRë
 = 0;

328 
	`as£π
–
	`sqlôe4BtPagîTønß˘i⁄Levñ
(
db
->
pPagî
)>0 );

330 if–
db
->
bFa°In£πOp
 ){

331 
nByã
 = (
FiCurs‹
Ë+ 
nExåa
;

332 
FiCurs‹
 *
pC§
;

334 
pC§
 = (
FiCurs‹
*)
	`sqlôe4_mÆloc
(
db
->
pEnv
, 
nByã
);

335 if–
pC§
==0 ){

336 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

338 
	`mem£t
(
pC§
, 0, 
nByã
);

339 
pC§
->
ba£
.
Êags
 = 
CSR_TYPE_FAST
;

340 
pC§
->
ba£
.
pExåa
 = (*)&pCsr[1];

341 
pC§
->
ba£
.
pDb
 = 
db
;

342 
pRë
 = (
bt_curs‹
*)
pC§
;

346 
BtCurs‹
 *
pC§
;

347 
u32
 
iRoŸ
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
)->iRoot;

349 if–
db
->
pFªeC§
 ){

350 
pC§
 = 
db
->
pFªeC§
;

351 
db
->
pFªeC§
 = 
pC§
->
pNextFªe
;

353 
nByã
 = (
BtCurs‹
Ë+ 
nExåa
;

354 
pC§
 = (
BtCurs‹
*)
	`sqlôe4_mÆloc
(
db
->
pEnv
, 
nByã
);

355 if–
pC§
==0 ){

356 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

357 
c§_›í_out
;

361 
	`btC§Sëup
(
db
, 
iRoŸ
, 
pC§
);

362 
pRë
 = (
bt_curs‹
*)
pC§
;

365 
	`as£π
–(
pRë
==0)==(
rc
!=
SQLITE4_OK
) );

366 if–
rc
==
SQLITE4_OK
 ){

367 
pRë
->
pNextC§
 = 
db
->
pAŒC§
;

368 
db
->
pAŒC§
 = 
pRë
;

371 
c§_›í_out
:

372 *
µC§
 = 
pRë
;

373 
	`btCheckPageRefs
(
db
);

374 
db
->
bFa°In£πOp
 = 0;

375  
rc
;

376 
	}
}

378 
	$btC§Rñó£AŒ
(
BtCurs‹
 *
pC§
){

379 
i
;

380 
i
=0; i<
pC§
->
nPg
; i++){

381 
	`sqlôe4BtPageRñó£
(
pC§
->
≠Page
[
i
]);

383 
pC§
->
nPg
 = 0;

384 
	}
}

387 
	$btC§Re£t
(
BtCurs‹
 *
pC§
, 
bFªeBuf„r
){

388 
	`btC§Rñó£AŒ
(
pC§
);

389 if–
bFªeBuf„r
 ){

390 
	`sqlôe4_buf„r_˛ór
(&
pC§
->
ovÊ
.
buf
);

392 
pC§
->
bSkùNext
 = 0;

393 
pC§
->
bSkùPªv
 = 0;

394 
pC§
->
bRequúeRe£ek
 = 0;

395 
pC§
->
ovÊ
.
nKey
 = 0;

396 
	}
}

398 
	$fiC§Re£t
(
FiCurs‹
 *
pC§
){

399 
i
;

400 
bt_db
 *
db
 = 
pC§
->
ba£
.
pDb
;

401 
i
=0; i<
pC§
->
nBt
; i++){

402 
	`btC§Re£t
(&
pC§
->
aSub
[
i
].
c§
, 1);

403 
	`btC§Re£t
(&
pC§
->
aSub
[
i
].
mc§
, 1);

405 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
pC§
->
aSub
);

406 
pC§
->
aSub
 = 0;

407 
pC§
->
nBt
 = 0;

408 
pC§
->
iBt
 = -1;

409 
	}
}

411 
	$sqlôe4BtC§Clo£
(
bt_curs‹
 *
pC§
){

412 if–
pC§
 ){

413 
bt_curs‹
 **
µ
;

414 
bt_db
 *
pDb
 = 
pC§
->pDb;

416 
	`btCheckPageRefs
(
pDb
);

419 
µ
=&
pDb
->
pAŒC§
; *µ!=
pC§
;Öp=&(*µ)->
pNextC§
);

420 *
µ
 = 
pC§
->
pNextC§
;

422 if–
	`IsBtC§
(
pC§
) ){

424 
BtCurs‹
 *
p
 = (BtCurs‹*)
pC§
;

425 
	`btC§Re£t
(
p
, 1);

426 
p
->
pNextFªe
 = 
pDb
->
pFªeC§
;

427 
pDb
->
pFªeC§
 = 
p
;

430 
	`fiC§Re£t
((
FiCurs‹
*)
pC§
);

431 
	`sqlôe4_‰ì
(
pDb
->
pEnv
, 
pC§
);

433 
	`btCheckPageRefs
(
pDb
);

435  
SQLITE4_OK
;

436 
	}
}

438 *
	$sqlôe4BtC§Exåa
(
bt_curs‹
 *
pC§
){

439  
pC§
->
pExåa
;

440 
	}
}

445 
	$btC§Des˚nd
(
BtCurs‹
 *
pC§
, 
u32
 
pgno
, 
BtPage
 **
µPg
){

446 
rc
;

447 if–
pC§
->
nPg
>=
BT_MAX_DEPTH
 ){

448 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

450 
	`as£π
–
pC§
->
nPg
>=0 );

451 
rc
 = 
	`sqlôe4BtPageGë
(
pC§
->
ba£
.
pDb
->
pPagî
, 
pgno
, 
µPg
);

452 
	`as£π
–((*
µPg
)==0)==(
rc
!=
SQLITE4_OK
) );

453 
pC§
->
≠Page
[pC§->
nPg
] = *
µPg
;

454 
pC§
->
nPg
++;

456  
rc
;

457 
	}
}

464 
	$btC§As˚nd
(
BtCurs‹
 *
pC§
, 
nLvl
){

465 
i
;

466 
i
=0; i<
nLvl
 && ( 
pC§
->
nPg
>0 ); i++){

467 
pC§
->
nPg
--;

468 
	`sqlôe4BtPageRñó£
(
pC§
->
≠Page
[pC§->
nPg
]);

469 
pC§
->
≠Page
[pC§->
nPg
] = 0;

471  (
pC§
->
nPg
==0 ? 
SQLITE4_NOTFOUND
 : 
SQLITE4_OK
);

472 
	}
}

480 
	$btCñlCou¡
(c⁄° 
u8
 *
aD©a
, 
nD©a
){

481  ()
	`btGëU16
(&
aD©a
[
nD©a
-2]);

482 
	}
}

484 
	$btFªeS∑˚
(c⁄° 
u8
 *
aD©a
, 
nD©a
){

485  ()
	`btGëU16
(&
aD©a
[
nD©a
-4]);

486 
	}
}

488 
	$btFªeOff£t
(c⁄° 
u8
 *
aD©a
, 
nD©a
){

489  ()
	`btGëU16
(&
aD©a
[
nD©a
-6]);

490 
	}
}

492 
	$btFªeC⁄tiguous
(c⁄° 
u8
 *
aD©a
, 
nD©a
){

493 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
nD©a
);

494  
nD©a
 - 
	`btFªeOff£t
(
aD©a
,ÇD©aË- (3+
nCñl
)*2;

495 
	}
}

497 
u8
 
	$btFœgs
(c⁄° 
u8
 *
aD©a
){

498  
aD©a
[0];

499 
	}
}

501 
u8
 *
	$btCñlFöd
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
){

502 
iOff
 = 
	`btGëU16
(&
aD©a
[
nD©a
 - 6 - 
iCñl
*2 - 2]);

503  &
aD©a
[
iOff
];

504 
	}
}

510 
u8
* 
	$btCñlPåFöd
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
){

511  &
aD©a
[
nD©a
 - 6 - 
iCñl
*2 - 2];

512 
	}
}

519 
u32
 
	$btChûdPgno
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
){

520 
u32
 
pgno
;

521 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
nD©a
);

523 if–
iCñl
>=
nCñl
 ){

524 
pgno
 = 
	`btGëU32
(&
aD©a
[1]);

526 
nKey
;

527 
u8
 *
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
nD©a
, 
iCñl
);

528 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKey
);

529 
pCñl
 +
nKey
;

530 
pgno
 = 
	`btGëU32
(
pCñl
);

533  
pgno
;

534 
	}
}

539 
	$sqlôe4BtBufAµídf
(
sqlôe4_buf„r
 *
pBuf
, c⁄° *
zF‹m©
, ...){

540 *
zAµíd
;

541 
va_li°
 
≠
;

543 
	`va_°¨t
(
≠
, 
zF‹m©
);

544 
zAµíd
 = 
	`sqlôe4_vm¥ötf
(0, 
zF‹m©
, 
≠
);

545 
	`va_íd
(
≠
);

547 
	`sqlôe4_buf„r_≠≥nd
(
pBuf
, 
zAµíd
, 
	`°æí
(zAppend));

548 
	`sqlôe4_‰ì
(0, 
zAµíd
);

549 
	}
}

551 
	~<˘y≥.h
>

553 
	$btBuf„rAµídBlob
(

554 
sqlôe4_buf„r
 *
pBuf
,

555 
bAscii
,

556 
u8
 *
pBlob
, 
nBlob


558 
j
;

559 
j
=0; j<
nBlob
; j++){

560 if–
bAscii
 ){

561 
	`sqlôe4BtBufAµídf
(
pBuf
, "%c", 
	`iß um
(()
pBlob
[
j
]) ?ÖBlob[j] : '.');

563 
	`sqlôe4BtBufAµídf
(
pBuf
, "%02X", ()
pBlob
[
j
]);

566 
	}
}

572 
	$btPageToAscii
(

573 
u32
 
pgno
,

574 
bAscii
,

575 
BtPagî
 *
pPagî
,

576 
u8
 *
aD©a
, 
nD©a
,

577 
sqlôe4_buf„r
 *
pBuf


579 
BtDbHdr
 *
pHdr
 = 0;

580 
i
;

581 
nCñl
 = ()
	`btCñlCou¡
(
aD©a
, 
nD©a
);

582 
u8
 
Êags
 = 
	`btFœgs
(
aD©a
);

584 
	`sqlôe4BtBufAµídf
(
pBuf
, "Pagê%d: ", 
pgno
);

586 if–
pPagî
 ) 
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(pPager);

587 if–
pHdr
 && 
pgno
=ıHdr->
iSRoŸ
 ){

588 
i
;

589 
BtScheduÀ
 
s
;

590 
	`sqlôe4BtBufAµídf
(
pBuf
, "(scheduleÖage) ");

591 
	`btRódScheduÀ
(0, 
aD©a
, &
s
);

593 
	`sqlôe4BtBufAµídf
(
pBuf
, "ÉBusy=(%s)\n",

594 
s
.
eBusy
==
BT_SCHEDULE_EMPTY
 ? "empty" :

595 
s
.
eBusy
==
BT_SCHEDULE_BUSY
 ? "busy" :

596 
s
.
eBusy
==
BT_SCHEDULE_DONE
 ? "done" : "!ErroR"

598 
	`sqlôe4BtBufAµídf
(
pBuf
, " iAge=%d\n", ()
s
.
iAge
);

599 
	`sqlôe4BtBufAµídf
(
pBuf
, " iMöLevñ=%d\n", ()
s
.
iMöLevñ
);

600 
	`sqlôe4BtBufAµídf
(
pBuf
, " iMaxLevñ=%d\n", ()
s
.
iMaxLevñ
);

601 
	`sqlôe4BtBufAµídf
(
pBuf
, " iOutLevñ=%d\n", ()
s
.
iOutLevñ
);

602 
	`sqlôe4BtBufAµídf
(
pBuf
, "áBlock=(");

603 
i
=0; 
s
.
aBlock
[i] && i<
	`¨øy_size
(s.aBlock); i++){

604 
	`sqlôe4BtBufAµídf
(
pBuf
, "%s%d", 
i
==0 ? "" : " ", ()
s
.
aBlock
[i]);

606 
	`sqlôe4BtBufAµídf
(
pBuf
, ")\n");

608 
	`sqlôe4BtBufAµídf
(
pBuf
, " iNextPg=%d\n", ()
s
.
iNextPg
);

609 
	`sqlôe4BtBufAµídf
(
pBuf
, " iNextCñl=%d\n", ()
s
.
iNextCñl
);

610 
	`sqlôe4BtBufAµídf
(
pBuf
, " iFªeLi°=%d\n", ()
s
.
iFªeLi°
);

612 
	`sqlôe4BtBufAµídf
(
pBuf
, "áRoot=(");

613 
i
=0; 
s
.
aBlock
[i] && i<
	`¨øy_size
(s.aBlock); i++){

614 
	`sqlôe4BtBufAµídf
(
pBuf
, "%s%d", 
i
==0 ? "" : " ", ()
s
.
aRoŸ
[i]);

616 
	`sqlôe4BtBufAµídf
(
pBuf
, ")\n");

619 
	`sqlôe4BtBufAµídf
(
pBuf
, "nCñl=%d ", 
nCñl
);

620 
	`sqlôe4BtBufAµídf
(
pBuf
, "iFªe=%d ", ()
	`btFªeOff£t
(
aD©a
, 
nD©a
));

621 
	`sqlôe4BtBufAµídf
(
pBuf
, "Êags=%d ", ()
	`btFœgs
(
aD©a
));

622 if–
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
 ){

623 
	`sqlôe4BtBufAµídf
(
pBuf
, "rchûd=%d ", ()
	`btGëU32
(&
aD©a
[1]));

625 
	`sqlôe4BtBufAµídf
(
pBuf
, "cell-offsets=(");

626 
i
=0; i<
nCñl
; i++){

627 
u8
 *
±r
 = 
	`btCñlPåFöd
(
aD©a
, 
nD©a
, 
i
);

628 
	`sqlôe4BtBufAµídf
(
pBuf
, "%s%d", 
i
==0?"":" ", ()
	`btGëU16
(
±r
));

630 
	`sqlôe4BtBufAµídf
(
pBuf
, ")\n");

632 
i
=0; i<
nCñl
; i++){

633 
u8
 *
pCñl
;

634 
nKey
;

635 
u8
 *
pKey
;

636 
nVÆ
;

637 
nDummy
;

638 
u8
 *
pVÆ
 = 0;

639 
˚Œty≥
 = 'A';

641 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
nD©a
, 
i
);

642 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKey
);

643 if–
Êags
 & 
BT_PGFLAGS_INTERNAL
 ){

644 
˚Œty≥
 = 'I';

646 if–
nKey
==0 ){

647 
˚Œty≥
 = 'C';

648 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKey
);

649 }if–
pCñl
[
nKey
]==0 ){

650 
˚Œty≥
 = 'B';

653 
	`sqlôe4BtBufAµídf
(
pBuf
, " Cñ»%d: [%c] ", 
i
, 
˚Œty≥
);

655 
pKey
 = 
pCñl
;

656 
pCñl
 +
nKey
;

657 
	`btBuf„rAµídBlob
(
pBuf
, 
bAscii
, 
pKey
, 
nKey
);

658 
	`sqlôe4BtBufAµídf
(
pBuf
, " ");

660  
˚Œty≥
 ){

662 
	`sqlôe4BtBufAµídf
(
pBuf
, "chûd=%d ", ()
	`btGëU32
(
pCñl
));

666 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nVÆ
);

667 if–
nVÆ
>=2 ){

668 
nVÆ
 -= 2;

669 
pVÆ
 = 
pCñl
;

671 
	`sqlôe4BtBufAµídf
(
pBuf
, "delete-key");

676 
	`as£π
–
pCñl
[0]==0x00 );

677 
pCñl
++;

678 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nVÆ
);

679 
pVÆ
 = 
pCñl
;

680 
pCñl
 +
nVÆ
;

681 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nDummy
);

685 
pVÆ
 = 0;

689 if–
pVÆ
 ){

690 
	`btBuf„rAµídBlob
(
pBuf
, 
bAscii
, 
pVÆ
, 
nVÆ
);

691 if–
Êags
 & 
BT_PGFLAGS_METATREE
 ){

693 if–
nKey
==(
aSumm¨yKey
Ë&& 0==
	`memcmp
(
pKey
,áSummaryKey,ÇKey) ){

694 
u16
 
iMö
, 
nLvl
, 
iMîge
;

695 
j
;

696 
	`sqlôe4BtBufAµídf
(
pBuf
, " [summary:");

697 
j
=0; j<(
nVÆ
/6); j++){

698 
	`btRódSumm¨y
(
pVÆ
, 
j
, &
iMö
, &
nLvl
, &
iMîge
);

699 
	`sqlôe4BtBufAµídf
(
pBuf
, " %d/%d/%d",

700 ()
iMö
, ()
nLvl
, ()
iMîge


703 
	`sqlôe4BtBufAµídf
(
pBuf
, "]");

706 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

707 
u32
 
iAge
 = 
	`btGëU32
(&
pKey
[0]);

708 
u32
 
iLevñ
 = ~
	`btGëU32
(&
pKey
[4]);

709 
u32
 
iRoŸ
 = 
	`btGëU32
(
pVÆ
);

710 
	`sqlôe4BtBufAµídf
(
pBuf
, " [age=%dÜevel=%dÑoot=%d]",

711 ()
iAge
, ()
iLevñ
, ()
iRoŸ


713 
	`sqlôe4BtBufAµídf
(
pBuf
, " (blk=%d)", 1 + (
iRoŸ
 / 
nPgPîBlk
));

718 if–
˚Œty≥
=='B' ){

719 
j
;

720 
u8
 
˘æ
 = *
pCñl
++;

721 
nDúe˘
 = (
˘æ
 & 0x0F);

722 
nDïth
 = ((
˘æ
>>4) & 0x0F);

723 
	`sqlôe4BtBufAµídf
(

724 
pBuf
, " [ovîÊow: dúe˘=%d dïth=%d]", 
nDúe˘
, 
nDïth
);

725 
j
=0; j<=
nDúe˘
; j++){

726 
	`sqlôe4BtBufAµídf
(
pBuf
, " %d", 
	`btGëU32
(&
pCñl
[
j
*4]));

729 
	`sqlôe4BtBufAµídf
(
pBuf
, "\n");

732 if–
pPagî
 && 
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
 ){

733 
i
=0; i<=
	`btCñlCou¡
(
aD©a
, 
nD©a
); i++){

734 
BtPage
 *
pChûd
;

735 
u8
 *
aChûd
;

736 
u32
 
chûd
;

738 
chûd
 = 
	`btChûdPgno
(
aD©a
, 
nD©a
, 
i
);

739 
	`sqlôe4BtPageGë
(
pPagî
, 
chûd
, &
pChûd
);

740 
aChûd
 = 
	`btPageD©a
(
pChûd
);

741 
	`btPageToAscii
(
chûd
, 
bAscii
, 
pPagî
, 
aChûd
, 
nD©a
, 
pBuf
);

742 
	`sqlôe4BtPageRñó£
(
pChûd
);

746 
	`sqlôe4BtBufAµídf
(
pBuf
, "\n");

747 
	}
}

749 
	$btFªñi°ToAscii
(
bt_db
 *
db
, 
u32
 
iFú°
, 
sqlôe4_buf„r
 *
pBuf
){

750 
rc
 = 
SQLITE4_OK
;

751 
u32
 
iTrunk
 = 
iFú°
;

752  
iTrunk
 && 
rc
==
SQLITE4_OK
 ){

753 
BtPage
 *
pPg
 = 0;

754 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
iTrunk
, &
pPg
);

755 if–
rc
==
SQLITE4_OK
 ){

756 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

757 
u32
 
nFªe
 = 
	`btGëU32
(
aD©a
);

758 
u32
 
iNext
 = 
	`btGëU32
(&
aD©a
[4]);

759 
i
;

761 
	`sqlôe4BtBufAµídf
(
pBuf
, "iTrunk=%d ", ()
iTrunk
);

762 
	`sqlôe4BtBufAµídf
(
pBuf
, "nFªe=%d iNext=%d (", ()
nFªe
, ()
iNext
);

763 
i
=0; i<()
nFªe
; i++){

764 
u32
 
pgnoFªe
 = 
	`btGëU32
(&
aD©a
[8 + 
i
*(u32)]);

765 
	`sqlôe4BtBufAµídf
(
pBuf
, "%s%d", (
i
==0)?"": " ", ()
pgnoFªe
);

767 
	`sqlôe4BtBufAµídf
(
pBuf
, ")\n");

769 
	`sqlôe4BtPageRñó£
(
pPg
);

770 
iTrunk
 = 
iNext
;

773  
rc
;

774 
	}
}

776 #i‚de‡
NDEBUG


777 
	~<°dio.h
>

779 
	$¥ötPage
(
FILE
 *
f
, 
u32
 
pgno
, 
u8
 *
aD©a
, 
nD©a
){

780 
sqlôe4_buf„r
 
buf
;

782 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

783 
	`btPageToAscii
(
pgno
, 0, 0, 
aD©a
, 
nD©a
, &
buf
);

784 
	`sqlôe4_buf„r_≠≥nd
(&
buf
, "", 1);

786 
	`Ârötf
(
f
, "%s", (*)
buf
.
p
);

787 
	`sqlôe4_buf„r_˛ór
(&
buf
);

788 
	}
}

790 
	$¥ötPgd©aToStdîr
(
u32
 
pgno
, 
u8
 *
aD©a
, 
nD©a
){

791 
	`¥ötPage
(
°dîr
, 
pgno
, 
aD©a
, 
nD©a
);

793 
	}
}

795 
	$¥ötPgToStdîr
(
BtPage
 *
pPg
){

796 
	`¥ötPage
(
°dîr
, 
	`sqlôe4BtPagePgno
(
pPg
), 
	`btPageD©a
(pPg), 1024);

798 
	}
}

800 
	$btPrötMëaTªe
(
BtPagî
 *
pPagî
, 
bAscii
, 
BtDbHdr
 *
pHdr
){

801 
u8
 *
aD©a
;

802 
nD©a
;

803 
sqlôe4_buf„r
 
buf
;

804 
BtPage
 *
pPg
 = 0;

806 
	`sqlôe4BtPageGë
(
pPagî
, 
pHdr
->
iMRoŸ
, &
pPg
);

807 
aD©a
 = 
	`btPageD©a
(
pPg
);

808 
nD©a
 = 
pHdr
->
pgsz
;

809 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

810 
	`btPageToAscii
(
pHdr
->
iMRoŸ
, 
bAscii
, 
pPagî
, 
aD©a
, 
nD©a
, &
buf
);

811 
	`sqlôe4_buf„r_≠≥nd
(&
buf
, "", 1);

813 
	`Ârötf
(
°dîr
, "%s", (*)
buf
.
p
);

814 
	`sqlôe4_buf„r_˛ór
(&
buf
);

815 
	`sqlôe4BtPageRñó£
(
pPg
);

816 
	}
}

819 
	$btDumpC§
(
sqlôe4_buf„r
 *
pBuf
, 
BtCurs‹
 *
pC§
){

820 
	`as£π
–
pC§
->
nPg
>=0 );

821 if–
pC§
->
nPg
==0 ){

822 
	`sqlôe4BtBufAµídf
(
pBuf
, "EOF");

824 
rc
;

825 c⁄° *
pKey
 = 0;

826 
nKey
 = 0;

828 
rc
 = 
	`btC§Key
(
pC§
, &
pKey
, &
nKey
);

829 
	`as£π
–
rc
==
SQLITE4_OK
 );

830 
	`btBuf„rAµídBlob
(
pBuf
, 0, (
u8
*)
pKey
, 
nKey
);

832 
	}
}

834 
	$fiDumpC§
(
FiCurs‹
 *
pC§
){

835 
iBt
;

837 
sqlôe4_buf„r
 
buf
;

838 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

839 
iBt
=0; iBt<
pC§
->
nBt
; iBt++){

840 
FiSubCurs‹
 *
pSub
 = &
pC§
->
aSub
[
iBt
];

842 
	`sqlôe4BtBufAµídf
(&
buf
, "%dÖªfix: ", 
iBt
);

843 
	`btBuf„rAµídBlob
(&
buf
, 0, 
pSub
->
aPªfix
, (pSub->aPrefix));

845 
	`sqlôe4BtBufAµídf
(&
buf
, "\n%d mc§ : ", 
iBt
);

846 
	`btDumpC§
(&
buf
, &
pSub
->
mc§
);

848 
	`sqlôe4BtBufAµídf
(&
buf
, "\n%d c§ : ", 
iBt
);

849 
	`btDumpC§
(&
buf
, &
pSub
->
c§
);

850 
	`sqlôe4BtBufAµídf
(&
buf
, "\n");

853 
	`sqlôe4_buf„r_≠≥nd
(&
buf
, "", 1);

854 
	`Ârötf
(
°dîr
, "%s", (*)
buf
.
p
);

855 
	`sqlôe4_buf„r_˛ór
(&
buf
);

856 
	}
}

859 #i‚de‡
NDEBUG


867 
	$as£π_summ¨y_ok
(
bt_db
 *
db
, 
¸c
){

868 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

869 
BtCurs‹
 
c§
;

870 
BtCurs‹
 
mc§
;

871 c⁄° 
u8
 *
aSum
; 
nSum
;

872 
i
;

873 
rc
;

875 
	sAgeD©a
 {

876 
iMöLevñ
;

877 
iMaxLevñ
;

878 } 
aD©a
[32];

880 if–
¸c
!=
SQLITE4_OK
 ) ;

882 
i
=0; i<
	`¨øy_size
(
aD©a
); i++){

883 
aD©a
[
i
].
iMöLevñ
 = -1;

884 
aD©a
[
i
].
iMaxLevñ
 = -1;

887 
rc
 = 
	`fiLﬂdSumm¨y
(
db
, &
c§
, &
aSum
, &
nSum
);

888 
	`as£π
–
rc
==
SQLITE4_OK
 );

890 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, &
mc§
);

891 
rc
=
	`btC§End
(&
mc§
, 0);Ñc==
SQLITE4_OK
;Ñc=
	`btC§Sãp
(&mcsr, 1)){

892 c⁄° 
u8
 *
pKey
 = 0; 
nKey
 = 0;

893 
u32
 
iAge
;

894 
u32
 
iLevñ
;

895 
rc
 = 
	`btC§Key
(&
mc§
, (c⁄° **)&
pKey
, &
nKey
);

896 
	`as£π
–
rc
==
SQLITE4_OK
 );

898 if–
nKey
==
	`¨øy_size
(
aSumm¨yKey
Ë&& 
	`memcmp
◊Summ¨yKey, 
pKey
,ÇKey)==0 ){

901 
	`as£π
–
nKey
>=8 );

903 
iAge
 = 
	`btGëU32
(&
pKey
[0]);

904 
iLevñ
 = ~
	`btGëU32
(&
pKey
[4]);

906 if–
aD©a
[
iAge
].
iMöLevñ
<0 ||áD©a[iAge].iMöLevñ>
iLevñ
 ){

907 
aD©a
[
iAge
].
iMöLevñ
 = ()
iLevñ
;

909 if–
aD©a
[
iAge
].
iMaxLevñ
<0 ||áD©a[iAge].iMaxLevñ<
iLevñ
 ){

910 
aD©a
[
iAge
].
iMaxLevñ
 = ()
iLevñ
;

913 
	`as£π
–
rc
==
SQLITE4_OK
 );

915 
i
=0; i<
	`¨øy_size
(
aD©a
); i++){

916 
u16
 
iMö
 = 0;

917 
u16
 
nLevñ
 = 0;

918 
u16
 
iMîge
 = 0;

919 if–
i
<(
nSum
/6) ){

920 
	`btRódSumm¨y
(
aSum
, 
i
, &
iMö
, &
nLevñ
, &
iMîge
);

922 if–
aD©a
[
i
].
iMöLevñ
>=0 ){

923 
nLevñEx≥˘
 = 
aD©a
[
i
].
iMaxLevñ
 -áD©a[i].
iMöLevñ
 + 1;

924 
	`as£π
–()
iMö
==
aD©a
[
i
].
iMöLevñ


925 || (
iMîge
!=0 && ()
iMö
<
aD©a
[
i
].
iMöLevñ
)

927 
	`as£π
–()
nLevñ
==
nLevñEx≥˘


928 || (
iMîge
!=0 && 
nLevñ
>
nLevñEx≥˘
)

931 
	`as£π
–
iMö
==0 && 
nLevñ
==0 );

935 
	`btC§Re£t
(&
c§
, 1);

936 
	`btC§Re£t
(&
mc§
, 1);

937 
	}
}

939 
	$as£π_ficurs‹_ok
(
FiCurs‹
 *
p
, 
¸c
){

940 
iBt
;

942 if–
¸c
!=
SQLITE4_OK
 && crc!=
SQLITE4_NOTFOUND
 && crc!=
SQLITE4_INEXACT
 ) ;

943 if–(
p
->
ba£
.
Êags
 & (
CSR_NEXT_OK
|
CSR_PREV_OK
))==0 ) ;

945 
iBt
=0; iBt<
p
->
nBt
; iBt++){

946 
FiSubCurs‹
 *
pSub
 = &
p
->
aSub
[
iBt
];

948 if–
pSub
->
mc§
.
nPg
>0 ){

949 c⁄° *
pKey
 = 0;

950 
nKey
 = 0;

951 
	`as£π
–
pSub
->
c§
.
nPg
>0 );

953 
	`btC§Key
(&
pSub
->
mc§
, &
pKey
, &
nKey
);

954 
	`as£π
–
nKey
>=8 && 0==
	`memcmp
(
pSub
->
aPªfix
, 
pKey
, 8) );

956 
	`as£π
–
pSub
->
c§
.
nPg
==0 );

959 
	}
}

962 
	#as£π_summ¨y_ok
(
x
, 
rc
)

	)

963 
	#as£π_ficurs‹_ok
(
p
, 
rc
)

	)

978 
	$btCñlKeyCom∑ª
(

979 
BtCurs‹
 *
pC§
,

980 
bLóf
,

981 c⁄° *
aPªfix
,

982 c⁄° *
pK
, 
nK
,

983 *
piRes


985 c⁄° *
pC§Key
;

986 
nC§Key
;

987 
nCmp
;

988 
nAs˚nd
 = 0;

989 
rc
 = 
SQLITE4_OK
;

990 
ªs
;

992 if–
bLóf
 ){

993 
rc
 = 
	`btC§Key
(
pC§
, &
pC§Key
, &
nC§Key
);

995 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

997 
u8
 *
aD©a
 = 
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

998 
u8
 *
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
pC§
->
aiCñl
[pC§->
nPg
-1]);

1000 
pC§Key
 = 
pCñl
 + 
	`sqlôe4BtV¨ötGë32
’Cñl, &
nC§Key
);

1001 if–
nC§Key
==0 ){

1002 
iCñl
 = 
pC§
->
aiCñl
[pC§->
nPg
-1]+1;

1004 
BtPage
 *
pPg
;

1005 
u8
 *
aD©a
 = 
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

1006 
u32
 
pgno
 = 
	`btChûdPgno
(
aD©a
, 
pgsz
, 
iCñl
);

1007 
nAs˚nd
++;

1008 
rc
 = 
	`btC§Des˚nd
(
pC§
, 
pgno
, &
pPg
);

1009 if–
rc
!=
SQLITE4_OK
 ) ;

1010 
aD©a
 = 
	`btPageD©a
(
pPg
);

1011 
pC§
->
aiCñl
[pC§->
nPg
-1] = 0;

1012 if–(
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
)==0 ) ;

1013 
iCñl
 = 0;

1015 
rc
 = 
	`sqlôe4BtC§Key
((
bt_curs‹
*)
pC§
, &
pC§Key
, &
nC§Key
);

1019 if–
rc
==
SQLITE4_OK
 ){

1020 if–
aPªfix
 ){

1021 if–
nC§Key
<8 ){

1022 
ªs
 = 
	`memcmp
(
pC§Key
, 
aPªfix
, 
nC§Key
);

1023 if–
ªs
==0 )Ñes = -1;

1025 
ªs
 = 
	`memcmp
(
pC§Key
, 
aPªfix
, 8);

1026 
nC§Key
 -= 8;

1027 
pC§Key
 = (*)(((
u8
*)pCsrKey) + 8);

1029 if–
ªs
 ) 
keycom∑ª_d⁄e
;

1032 
nCmp
 = 
	`MIN
(
nC§Key
, 
nK
);

1033 
ªs
 = 
	`memcmp
(
pC§Key
, 
pK
, 
nCmp
);

1034 if–
ªs
==0 ){

1035 
ªs
 = 
nC§Key
 - 
nK
;

1039 
keycom∑ª_d⁄e
:

1040 
	`btC§As˚nd
(
pC§
, 
nAs˚nd
);

1041 *
piRes
 = 
ªs
;

1042  
rc
;

1043 
	}
}

1048 
	$btKeyCom∑ª
(

1049 c⁄° *
pKey1
, 
nKey1
,

1050 c⁄° *
pKey2
, 
nKey2


1052 
nCmp
 = 
	`MIN
(
nKey1
, 
nKey2
);

1053 
ªs
;

1055 
ªs
 = 
	`memcmp
(
pKey1
, 
pKey2
, 
nCmp
);

1056 if–
ªs
==0 ){

1057 
ªs
 = 
nKey1
 - 
nKey2
;

1059  
ªs
;

1060 
	}
}

1063 
	#BT_CSRSEEK_SEEK
 0

	)

1064 
	#BT_CSRSEEK_UPDATE
 1

	)

1065 
	#BT_CSRSEEK_RESEEK
 2

	)

1067 
	$btC§Sìk
(

1068 
BtCurs‹
 *
pC§
,

1069 
u8
 *
aPªfix
,

1070 c⁄° *
pK
,

1071 
nK
,

1072 
eSìk
,

1073 
eC§£ek


1075 
BtPagî
 *
pPagî
 = 
pC§
->
ba£
.
pDb
->pPager;

1076 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pPagî
);

1077 
u32
 
pgno
;

1078 
rc
;

1080 
	`as£π
–
eSìk
==
BT_SEEK_EQ
 || 
eC§£ek
!=
BT_CSRSEEK_RESEEK
 );

1081 
	`as£π
–
eSìk
==
BT_SEEK_GE
 || 
eC§£ek
!=
BT_CSRSEEK_UPDATE
 );

1084 
	`btC§Re£t
(
pC§
, 0);

1087 
	`as£π
–
pC§
->
iRoŸ
>1 &&ÖC§->
nPg
==0 );

1088 
pgno
 = 
pC§
->
iRoŸ
;

1092 
BtPage
 *
pPg
;

1093 
rc
 = 
	`sqlôe4BtPageGë
(
pPagî
, 
pgno
, &
pPg
);

1094 
pC§
->
≠Page
[pC§->
nPg
++] = 
pPg
;

1096 if–
rc
==
SQLITE4_OK
 ){

1097 
nCñl
;

1098 
iHi
;

1099 
iLo
;

1100 
ªs
;

1102 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

1103 
u16
 *
aCñlPå
 = (u16*)
	`btCñlPåFöd
(
aD©a
, 
pgsz
, 0);

1104 
bLóf
 = ((
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
)==0);

1106 
iLo
 = 0;

1107 
iHi
 = 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

1109 if–
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_LARGEKEYS
 ){

1110  
iHi
>
iLo
 ){

1111 
iT°
 = (
iHi
+
iLo
)/2;

1112 
u8
 *
pCñl
 = &
aD©a
[
	`btGëU16
((u8*)(
aCñlPå
 - 
iT°
))];

1114 
pC§
->
aiCñl
[pC§->
nPg
-1] = 
iT°
;

1115 
rc
 = 
	`btCñlKeyCom∑ª
(
pC§
, 
bLóf
, 0, 
pK
, 
nK
, &
ªs
);

1117 if–
ªs
<0 ){

1119 
iLo
 = 
iT°
+1;

1122 
iHi
 = 
iT°
;

1123 if–
ªs
==0 ){

1124 
iHi
 +!
bLóf
;

1130  
iHi
>
iLo
 ){

1131 
iT°
 = (
iHi
+
iLo
)/2;

1132 
u8
 *
pCñl
 = &
aD©a
[
	`btGëU16
((u8*)(
aCñlPå
 - 
iT°
))];

1133 
n
 = *
pCñl
;

1135 
ªs
 = 
	`memcmp
(&
pCñl
[1], 
pK
, 
	`MIN
(
nK
, 
n
));

1136 if–
ªs
<0 || (ªs==0 && (ª†
n
 - 
nK
)<0) ){

1138 
iLo
 = 
iT°
+1;

1141 
iHi
 = 
iT°
;

1142 if–
ªs
==0 ){

1143 
iHi
 +!
bLóf
;

1149 if–
rc
!=
SQLITE4_OK
 ) ;

1150 
pC§
->
aiCñl
[pC§->
nPg
-1] = 
iHi
;

1152 if–
bLóf
==0 ){

1153 if–
iHi
==
nCñl
 ) 
pgno
 = 
	`btGëU32
(&
aD©a
[1]);

1155 
u8
 *
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
iHi
);

1156 
pgno
 = 
	`btGëU32
(&
pCñl
[1 + ()*pCell]);

1158 if–
pC§
->
nPg
==
BT_MAX_DEPTH
 ){

1159 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

1164 if–
nCñl
==0 ){

1165 
rc
 = 
SQLITE4_NOTFOUND
;

1166 }if–
ªs
!=0 ){

1167 if–
eSìk
==
BT_SEEK_EQ
 ){

1168 if–
eC§£ek
==
BT_CSRSEEK_RESEEK
 ){

1169 
rc
 = 
SQLITE4_OK
;

1170 if–
iHi
==
nCñl
 ){

1171 
	`as£π
–
pC§
->
aiCñl
[pC§->
nPg
-1]>0 );

1172 
pC§
->
aiCñl
[pC§->
nPg
-1]--;

1173 
pC§
->
bSkùPªv
 = 1;

1175 
pC§
->
bSkùNext
 = 1;

1178 
rc
 = 
SQLITE4_NOTFOUND
;

1181 
	`as£π
–
BT_SEEK_LEFAST
<0 && 
BT_SEEK_LE
<0 );

1182 if–
eSìk
<0 ){

1183 
rc
 = 
	`sqlôe4BtC§Pªv
((
bt_curs‹
*)
pC§
);

1185 if–
iHi
==
nCñl
 ){

1186 if–
eC§£ek
==
BT_CSRSEEK_UPDATE
 ){

1187 
rc
 = 
SQLITE4_NOTFOUND
;

1189 
rc
 = 
	`sqlôe4BtC§Next
((
bt_curs‹
*)
pC§
);

1193 if–
rc
==
SQLITE4_OK
 )Ñ¯
SQLITE4_INEXACT
;

1203 if–
rc
!=
SQLITE4_OK
 &&Ñc!=
SQLITE4_INEXACT
 && 
eC§£ek
!=
BT_CSRSEEK_UPDATE
 ){

1204 
	`btC§Re£t
(
pC§
, 0);

1206  
rc
;

1207 
	}
}

1209 
	$btC§Re£ek
(
BtCurs‹
 *
pC§
){

1210 
rc
 = 
SQLITE4_OK
;

1211 if–
pC§
->
bRequúeRe£ek
 ){

1212 
BtOvÊ
 
o
;

1213 
	`mem˝y
(&
o
, &
pC§
->
ovÊ
, (
BtOvÊ
));

1215 
pC§
->
ovÊ
.
buf
.
n
 = 0;

1216 
pC§
->
ovÊ
.
buf
.
p
 = 0;

1217 
pC§
->
bSkùNext
 = 0;

1218 
pC§
->
bRequúeRe£ek
 = 0;

1220 
rc
 = 
	`btC§Sìk
(
pC§
, 0, 
o
.
buf
.
p
, o.
nKey
, 
BT_SEEK_EQ
, 
BT_CSRSEEK_RESEEK
);

1221 
	`as£π
–
rc
!=
SQLITE4_INEXACT
 );

1222 if–
pC§
->
ovÊ
.
buf
.
p
==0 ){

1223 
pC§
->
ovÊ
.
buf
.
p
 = 
o
.buf.p;

1225 
	`sqlôe4_buf„r_˛ór
(&
o
.
buf
);

1228  
rc
;

1229 
	}
}

1235 
	$btC§Sãp
(
BtCurs‹
 *
pC§
, 
bNext
){

1236 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

1237 
rc
 = 
SQLITE4_OK
;

1238 
bRequúeDes˚¡
 = 0;

1240 
rc
 = 
	`btC§Re£ek
(
pC§
);

1241 if–
rc
==
SQLITE4_OK
 && 
pC§
->
nPg
==0 ){

1242 
rc
 = 
SQLITE4_NOTFOUND
;

1244 
pC§
->
ovÊ
.
nKey
 = 0;

1246 if–(
pC§
->
bSkùNext
 && 
bNext
Ë|| (pC§->
bSkùPªv
 && bNext==0) ){

1247 
pC§
->
bSkùPªv
 =ÖC§->
bSkùNext
 = 0;

1248  
rc
;

1250 
pC§
->
bSkùPªv
 =ÖC§->
bSkùNext
 = 0;

1252  
rc
==
SQLITE4_OK
 ){

1253 
iPg
 = 
pC§
->
nPg
-1;

1254 
iCñl
 = 
pC§
->
aiCñl
[
iPg
];

1256 if–
bNext
 ){

1257 
u8
 *
aD©a
 = (u8*)
	`btPageD©a
(
pC§
->
≠Page
[
iPg
]);

1258 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

1259 
	`as£π
–
bRequúeDes˚¡
==0 || bRequireDescent==1 );

1260 if–
iCñl
<(
nCñl
+
bRequúeDes˚¡
-1) ){

1261 
pC§
->
aiCñl
[
iPg
]++;

1265 if–
pC§
->
aiCñl
[
iPg
]>0 ){

1266 
pC§
->
aiCñl
[
iPg
]--;

1271 
rc
 = 
	`btC§As˚nd
(
pC§
, 1);

1272 
bRequúeDes˚¡
 = 1;

1275 if–
bRequúeDes˚¡
 && 
rc
==
SQLITE4_OK
 ){

1276 
u32
 
pgno
;

1277 
u8
 *
aD©a
 = (u8*)
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

1279 
pgno
 = 
	`btChûdPgno
(
aD©a
, 
pgsz
, 
pC§
->
aiCñl
[pC§->
nPg
-1]);

1282 
BtPage
 *
pPg
;

1283 
rc
 = 
	`btC§Des˚nd
(
pC§
, 
pgno
, &
pPg
);

1284 if–
rc
!=
SQLITE4_OK
 ){

1287 
nCñl
;

1288 
aD©a
 = (
u8
*)
	`btPageD©a
(
pPg
);

1289 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

1290 if–
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
 ){

1291 
pC§
->
aiCñl
[pC§->
nPg
-1] = (
bNext
 ? 0 : 
nCñl
);

1292 
pgno
 = 
	`btChûdPgno
(
aD©a
, 
pgsz
, 
pC§
->
aiCñl
[pC§->
nPg
-1]);

1294 
pC§
->
aiCñl
[pC§->
nPg
-1] = (
bNext
 ? 0 : 
nCñl
-1);

1301  
rc
;

1302 
	}
}

1309 
	$btC§End
(
BtCurs‹
 *
pC§
, 
bLa°
){

1310 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

1311 
rc
 = 
SQLITE4_OK
;

1312 
u32
 
pgno
;

1315 
	`btC§Re£t
(
pC§
, 0);

1318 
	`as£π
–
pC§
->
iRoŸ
>1 &&ÖC§->
nPg
==0 );

1319 
pgno
 = 
pC§
->
iRoŸ
;

1321  
rc
==
SQLITE4_OK
 ){

1323 
BtPage
 *
pPg
;

1324 
rc
 = 
	`btC§Des˚nd
(
pC§
, 
pgno
, &
pPg
);

1325 if–
rc
==
SQLITE4_OK
 ){

1326 
nCñl
;

1327 
nByã
;

1328 
u8
 *
pCñl
;

1329 
u8
 *
aD©a
 = (u8*)
	`btPageD©a
(
pPg
);

1331 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

1332 
pC§
->
aiCñl
[pC§->
nPg
-1] = (
bLa°
 ? 
nCñl
 : 0);

1335 if–(
aD©a
[0] & 
BT_PGFLAGS_INTERNAL
)==0 ){

1336 if–
nCñl
==0 ){

1337 
	`btC§Re£t
(
pC§
, 0);

1338 
rc
 = 
SQLITE4_NOTFOUND
;

1346 if–
bLa°
==0 ){

1347 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 0);

1348 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nByã
);

1349 
pCñl
 +
nByã
;

1350 
pgno
 = 
	`btGëU32
(
pCñl
);

1352 
pgno
 = 
	`btGëU32
(&
aD©a
[1]);

1356 if–
pC§
->
aiCñl
[pC§->
nPg
-1] )ÖCsr->aiCell[pCsr->nPg-1]--;

1357  
rc
;

1358 
	}
}

1361 
	$fiC§AŒoˇãSubs
(
bt_db
 *
db
, 
FiCurs‹
 *
pC§
, 
nBt
){

1362 
rc
 = 
SQLITE4_OK
;

1363 if–
nBt
>
pC§
->nBt ){

1364 
nByã
 = (
FiSubCurs‹
Ë* 
nBt
;

1365 
FiSubCurs‹
 *
aNew
;

1367 
aNew
 = (
FiSubCurs‹
*)
	`sqlôe4_ªÆloc
(
db
->
pEnv
, 
pC§
->
aSub
, 
nByã
);

1368 if–
aNew
 ){

1369 
	`mem£t
(&
aNew
[
pC§
->
nBt
], 0, (
FiSubCurs‹
)*(nBt-pCsr->nBt));

1370 
pC§
->
aSub
 = 
aNew
;

1371 
pC§
->
nBt
 =ÇBt;

1373 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

1377  
rc
;

1378 
	}
}

1383 
u32
 
	$btFú°OfBlock
(
BtDbHdr
 *
pHdr
, 
u32
 
iBlk
){

1384 
	`as£π
–
iBlk
>0 );

1385  (
iBlk
 - 1Ë* (
pHdr
->
blksz
 /ÖHdr->
pgsz
) + 1;

1386 
	}
}

1392 
	$btC§IsDñëe
(
BtCurs‹
 *
pC§
){

1393 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

1394 
bRë
;

1395 
u8
 *
aD©a
;

1396 
u8
 *
pCñl
;

1397 
n
;

1399 
aD©a
 = 
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

1400 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
pC§
->
aiCñl
[pC§->
nPg
-1]);

1402 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

1403 if–
n
==0 ){

1405 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

1406 
pCñl
 +
n
;

1407 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

1408 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

1409 
bRë
 = (
n
==0);

1411 
pCñl
 +
n
;

1412 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

1413 
bRë
 = (
n
==1);

1416  
bRë
;

1417 
	}
}

1419 
	$fiC§IsDñëe
(
FiCurs‹
 *
pC§
){

1420 
ªs
 = 0;

1421 if–(
pC§
->
ba£
.
Êags
 & 
CSR_VISIT_DEL
)==0 ){

1422 
BtCurs‹
 *
p
 = &
pC§
->
aSub
[pC§->
iBt
].
c§
;

1423 
ªs
 = 
	`btC§IsDñëe
(
p
);

1425  
ªs
;

1426 
	}
}

1428 
	$btOvîÊowAºayRód
(

1429 
bt_db
 *
db
,

1430 
u8
 *
pOvÊ
,

1431 
u8
 *
aOut
,

1432 
nOut


1434 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
db
->
pPagî
);

1435 c⁄° 
nPgPå
 = 
pgsz
 / 4;

1436 
rc
 = 
SQLITE4_OK
;

1437 
nDúe˘
;

1438 
nDïth
;

1439 
iOut
;

1440 
iPg
;

1442 
nDúe˘
 = ()(
pOvÊ
[0] & 0x0F);

1443 
nDïth
 = ()(
pOvÊ
[0]>>4);

1445 
iOut
 = 0;

1449 
iPg
=0; 
rc
==
SQLITE4_OK
 && iPg<(
nDúe˘
+(
nDïth
==0)Ë&& 
iOut
<
nOut
; iPg++){

1450 
u32
 
pgno
 = 
	`btGëU32
(&
pOvÊ
[1+
iPg
*4]);

1451 
BtPage
 *
pPg
 = 0;

1452 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pgno
, &
pPg
);

1453 if–
rc
==
SQLITE4_OK
 ){

1454 
nC›y
 = 
	`MIN
(
nOut
-
iOut
, 
pgsz
);

1455 
u8
 *
a
 = 
	`btPageD©a
(
pPg
);

1456 
	`mem˝y
(&
aOut
[
iOut
], 
a
, 
nC›y
);

1457 
	`sqlôe4BtPageRñó£
(
pPg
);

1458 
iOut
 +
nC›y
;

1463 if–
nDïth
>0 ){

1464 
	sHeú
 {

1465 
BtPage
 *
pPg
;

1466 
iCñl
;

1467 } 
≠Hõr
[8];

1468 
i
;

1469 
u32
 
pgno
;

1470 
	`mem£t
(
≠Hõr
, 0, (apHier));

1473 
pgno
 = 
	`btGëU32
(&
pOvÊ
[1+
nDúe˘
*4]);

1474 
i
=0; i<
nDïth
 && 
rc
==
SQLITE4_OK
; i++){

1475 
u8
 *
a
;

1476 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pgno
, &
≠Hõr
[
i
].
pPg
);

1477 if–
rc
==
SQLITE4_OK
 ){

1478 
a
 = 
	`btPageD©a
(
≠Hõr
[
i
].
pPg
);

1479 
pgno
 = 
	`btGëU32
(
a
);

1484  
iOut
<
nOut
 ){

1485 
u8
 *
a
;

1486 
BtPage
 *
pLóf
;

1487 
nC›y
;

1489 
iLvl
;

1491 
nC›y
 = 
	`MIN
(
nOut
-
iOut
, 
pgsz
);

1492 
	`as£π
–
nC›y
>0 );

1495 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pgno
, &
pLóf
);

1496 if–
rc
!=
SQLITE4_OK
 ) ;

1497 
a
 = 
	`btPageD©a
(
pLóf
);

1498 
	`mem˝y
(&
aOut
[
iOut
], 
a
, 
nC›y
);

1499 
	`sqlôe4BtPageRñó£
(
pLóf
);

1500 
iOut
 +
nC›y
;

1503 if–
iOut
>=
nOut
 ) ;

1505 
iLvl
=
nDïth
-1; iLvl>=0; iLvl--){

1506 if–
≠Hõr
[
iLvl
].
iCñl
<(
nPgPå
-1) ) ;

1508 if–
iLvl
<0 ) ;

1509 
≠Hõr
[
iLvl
].
iCñl
++;

1511 ; 
iLvl
<
nDïth
 && 
rc
==
SQLITE4_OK
; iLvl++){

1512 
a
 = 
	`btPageD©a
(
≠Hõr
[
iLvl
].
pPg
);

1513 
pgno
 = 
	`btGëU32
(&
a
[
≠Hõr
[
iLvl
].
iCñl
 * 4]);

1514 if–
iLvl
<(
nDïth
-1) ){

1515 
≠Hõr
[
iLvl
+1].
iCñl
 = 0;

1516 
	`sqlôe4BtPageRñó£
(
≠Hõr
[
iLvl
+1].
pPg
);

1517 
≠Hõr
[
iLvl
+1].
pPg
 = 0;

1518 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pgno
, &
≠Hõr
[
iLvl
+1].
pPg
);

1523 
i
=0; i<
nDïth
 && 
rc
==
SQLITE4_OK
; i++){

1524 
	`sqlôe4BtPageRñó£
(
≠Hõr
[
i
].
pPg
);

1528  
rc
;

1529 
	}
}

1537 
	$btC§Buf„r
(
BtCurs‹
 *
pC§
, 
bVÆ
){

1538 
rc
 = 
SQLITE4_OK
;

1539 if–
pC§
->
ovÊ
.
nKey
<=0 ){

1540 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

1541 
u8
 *
aD©a
;

1542 
u8
 *
pCñl
;

1543 
nReq
;

1544 
u8
 *
aOut
;

1545 
u8
 *
pKLoˇl
 = 0;

1546 
u8
 *
pVLoˇl
 = 0;

1547 
nKLoˇl
 = 0;

1548 
nVLoˇl
 = 0;

1549 
nKOvÊ
 = 0;

1550 
nVOvÊ
 = 0;

1552 
aD©a
 = (
u8
*)
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

1553 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
pC§
->
aiCñl
[pC§->
nPg
-1]);

1554 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKLoˇl
);

1555 if–
nKLoˇl
==0 ){

1557 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKLoˇl
);

1558 
pKLoˇl
 = 
pCñl
;

1559 
pCñl
 +
nKLoˇl
;

1560 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKOvÊ
);

1561 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nVOvÊ
);

1562 if–
nVOvÊ
>0 )ÇVOvfl -= 1;

1565 
pKLoˇl
 = 
pCñl
;

1566 
pCñl
 +
nKLoˇl
;

1567 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nVLoˇl
);

1568 if–
nVLoˇl
==0 ){

1570 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nVLoˇl
);

1571 
pVLoˇl
 = 
pCñl
;

1572 
pCñl
 +
nVLoˇl
;

1573 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nVOvÊ
);

1576 
pVLoˇl
 = 
pCñl
;

1577 
nVLoˇl
 -= 2;

1582 if–
nVLoˇl
<0 )ÇVLocal = 0;

1584 
pC§
->
ovÊ
.
nKey
 = 
nKLoˇl
 + 
nKOvÊ
;

1585 
pC§
->
ovÊ
.
nVÆ
 = 
nVLoˇl
 + 
nVOvÊ
;

1587 
nReq
 = 
pC§
->
ovÊ
.
nKey
 +ÖC§->ovÊ.
nVÆ
;

1588 
	`as£π
–
nReq
>0 );

1589 
rc
 = 
	`sqlôe4_buf„r_ªsize
(&
pC§
->
ovÊ
.
buf
, 
nReq
);

1590 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1593 
aOut
 = (
u8
*)
pC§
->
ovÊ
.
buf
.
p
;

1594 
	`mem˝y
(
aOut
, 
pKLoˇl
, 
nKLoˇl
);

1595 
	`mem˝y
(&
aOut
[
nKLoˇl
], 
pVLoˇl
, 
nVLoˇl
);

1598 if–
nKOvÊ
 || 
nVOvÊ
 ){

1599 
rc
 = 
	`btOvîÊowAºayRód
(

1600 
pC§
->
ba£
.
pDb
, 
pCñl
, &
aOut
[
nKLoˇl
 + 
nVLoˇl
], 
nKOvÊ
 + 
nVOvÊ


1605  
rc
;

1606 
	}
}

1609 
	$btC§Key
(
BtCurs‹
 *
pC§
, c⁄° **
µK
, *
≤K
){

1610 
rc
 = 
SQLITE4_OK
;

1612 if–
pC§
->
bRequúeRe£ek
 ){

1613 *
µK
 = (c⁄° *)
pC§
->
ovÊ
.
buf
.
p
;

1614 *
≤K
 = 
pC§
->
ovÊ
.
nKey
;

1616 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

1617 
u8
 *
aD©a
;

1618 
u8
 *
pCñl
;

1619 
nK
;

1620 
iCñl
 = 
pC§
->
aiCñl
[pC§->
nPg
-1];

1622 
aD©a
 = 
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

1623 
	`as£π
–
	`btCñlCou¡
(
aD©a
, 
pgsz
)>
iCñl
 );

1624 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
iCñl
);

1625 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nK
);

1627 if–
nK
==0 ){

1629 
rc
 = 
	`btC§Buf„r
(
pC§
, 0);

1630 if–
rc
==
SQLITE4_OK
 ){

1631 *
µK
 = 
pC§
->
ovÊ
.
buf
.
p
;

1632 *
≤K
 = 
pC§
->
ovÊ
.
nKey
;

1635 *
µK
 = 
pCñl
;

1636 *
≤K
 = 
nK
;

1640  
rc
;

1641 
	}
}

1644 
	$fiC§SëCuºít
(
FiCurs‹
 *
pC§
){

1645 c⁄° *
pMö
 = 0;

1646 
nMö
 = 0;

1647 
iMö
 = -1;

1648 
i
;

1649 
rc
 = 
SQLITE4_OK
;

1650 
mul
;

1652 
	`as£π
–
pC§
->
ba£
.
Êags
 & (
CSR_NEXT_OK
 | 
CSR_PREV_OK
) );

1653 
mul
 = ((
pC§
->
ba£
.
Êags
 & 
CSR_NEXT_OK
) ? 1 : -1);

1655 
i
=0; i<
pC§
->
nBt
 && 
rc
==
SQLITE4_OK
; i++){

1656 
BtCurs‹
 *
pSub
 = &
pC§
->
aSub
[
i
].
c§
;

1657 if–
pSub
->
nPg
>0 ){

1658 
nKey
;

1659 c⁄° *
pKey
;

1661 
rc
 = 
	`btC§Key
(
pSub
, &
pKey
, &
nKey
);

1662 if–
rc
==
SQLITE4_OK


1663 && (
iMö
<0 || (
mul
 * 
	`btKeyCom∑ª
(
pKey
, 
nKey
, 
pMö
, 
nMö
))<0)

1665 
pMö
 = 
pKey
;

1666 
nMö
 = 
nKey
;

1667 
iMö
 = 
i
;

1672 if–
iMö
<0 && 
rc
==
SQLITE4_OK
 )Ñ¯
SQLITE4_NOTFOUND
;

1673 
pC§
->
iBt
 = 
iMö
;

1674  
rc
;

1675 
	}
}

1677 
	$fiSubC§CheckPªfix
(
FiSubCurs‹
 *
pSub
){

1678 c⁄° 
nPªfix
 = (
pSub
->
aPªfix
);

1679 c⁄° *
pK
 = 0;

1680 
nK
;

1681 
rc
;

1683 
rc
 = 
	`btC§Key
(&
pSub
->
mc§
, &
pK
, &
nK
);

1684 if–
rc
==
SQLITE4_OK
 && (
nK
<
nPªfix
 || 
	`memcmp
(
pK
, 
pSub
->
aPªfix
,ÇPrefix)) ){

1685 
rc
 = 
SQLITE4_NOTFOUND
;

1686 
	`btC§Re£t
(&
pSub
->
mc§
, 0);

1688  
rc
;

1689 
	}
}

1698 
	$fiSubC§Sãp
(

1699 
FiCurs‹
 *
pC§
,

1700 
FiSubCurs‹
 *
pSub
,

1701 
bNext


1703 
rc
;

1705 
rc
 = 
	`btC§Sãp
(&
pSub
->
c§
, 
bNext
);

1706 if–
rc
==
SQLITE4_NOTFOUND
 ){

1707 c⁄° *
pV
;

1708 
nV
;

1710 #i‚de‡
NDEBUG


1711 c⁄° *
pTmp
; 
nTmp
;

1712 
rc
 = 
	`btC§Key
(&
pSub
->
mc§
, &
pTmp
, &
nTmp
);

1713 
	`as£π
–
rc
==
SQLITE4_OK
 && 
	`memcmp
(
pTmp
, 
pSub
->
aPªfix
, 8)==0 );

1716 
rc
 = 
	`btC§Sãp
(&
pSub
->
mc§
, 
bNext
);

1717 if–
rc
==
SQLITE4_OK
 ){

1718 
rc
 = 
	`btC§Key
(&
pSub
->
mc§
, &
pV
, &
nV
);

1720 if–
rc
==
SQLITE4_OK
 ){

1721 
rc
 = 
	`fiSubC§CheckPªfix
(
pSub
);

1723 if–
rc
==
SQLITE4_OK
 ){

1724 
rc
 = 
	`btC§D©a
(&
pSub
->
mc§
, 0, 4, &
pV
, &
nV
);

1726 if–
rc
==
SQLITE4_OK
 ){

1727 
pSub
->
c§
.
iRoŸ
 = 
	`sqlôe4BtGëU32
((c⁄° 
u8
*)
pV
);

1728 
rc
 = 
	`btC§End
(&
pSub
->
c§
, !
bNext
);

1732 if–
bNext
==0 ){

1736 c⁄° *
pMö
; 
nMö
;

1737 c⁄° *
pKey
; 
nKey
;

1739 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`btC§Key
(&
pSub
->
mc§
, &
pMö
, &
nMö
);

1740 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`btC§Key
(&
pSub
->
c§
, &
pKey
, &
nKey
);

1742 if–
rc
==
SQLITE4_OK
 && 
	`btKeyCom∑ª
((
u8
*)
pMö
+8, 
nMö
-8, 
pKey
, 
nKey
)>0 ){

1743 
rc
 = 
SQLITE4_NOTFOUND
;

1744 
	`btC§Re£t
(&
pSub
->
mc§
, 0);

1745 
	`btC§Re£t
(&
pSub
->
c§
, 0);

1749  
rc
;

1750 
	}
}

1757 
	$fiC§Sãp
(
FiCurs‹
 *
pC§
){

1758 
rc
 = 
SQLITE4_OK
;

1759 
bNext
 = (0!=(
pC§
->
ba£
.
Êags
 & 
CSR_NEXT_OK
));

1760 c⁄° *
pKey
; 
nKey
;

1761 
i
;

1763 #i‚de‡
NDEBUG


1764 
sqlôe4_buf„r
 
buf
;

1765 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

1766 
	`sqlôe4BtC§Key
(&
pC§
->
ba£
, &
pKey
, &
nKey
);

1767 
	`sqlôe4_buf„r_£t
(&
buf
, 
pKey
, 
nKey
);

1770 
	`as£π_ficurs‹_ok
(
pC§
, 
rc
);

1771 
	`as£π
–
pC§
->
ba£
.
Êags
 & (
CSR_NEXT_OK
 | 
CSR_PREV_OK
) );

1772 
	`as£π
–
pC§
->
iBt
>=0 );

1777 
rc
 = 
	`sqlôe4BtC§Key
(&
pC§
->
ba£
, &
pKey
, &
nKey
);

1778 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pC§
->
nBt
; i++){

1779 
FiSubCurs‹
 *
pSub
 = &
pC§
->
aSub
[
i
];

1780 if–
i
!=
pC§
->
iBt
 && 
pSub
->
c§
.
nPg
>0 ){

1781 c⁄° *
p
; 
n
;

1782 
rc
 = 
	`btC§Key
(&
pSub
->
c§
, &
p
, &
n
);

1783 if–
rc
==
SQLITE4_OK
 && 
	`btKeyCom∑ª
(
p
, 
n
, 
pKey
, 
nKey
)==0 ){

1784 
rc
 = 
	`fiSubC§Sãp
(
pC§
, 
pSub
, 
bNext
);

1785 if–
rc
==
SQLITE4_NOTFOUND
 ){

1786 
	`as£π
–
pSub
->
c§
.
nPg
==0 );

1787 
rc
 = 
SQLITE4_OK
;

1794 if–
rc
==
SQLITE4_OK
 ){

1795 
rc
 = 
	`fiSubC§Sãp
(
pC§
, &pC§->
aSub
[pC§->
iBt
], 
bNext
);

1796 if–
rc
==
SQLITE4_NOTFOUND
 ){

1797 
	`as£π
–
pC§
->
aSub
[pC§->
iBt
].
c§
.
nPg
==0 );

1798 
rc
 = 
SQLITE4_OK
;

1803 if–
rc
==
SQLITE4_OK
 ){

1804 
rc
 = 
	`fiC§SëCuºít
(
pC§
);

1806 } 
rc
==
SQLITE4_OK
 && 
	`fiC§IsDñëe
(
pC§
) );

1808 #i‚de‡
NDEBUG


1809 if–
rc
==
SQLITE4_OK
 ){

1810 
	`sqlôe4BtC§Key
(&
pC§
->
ba£
, &
pKey
, &
nKey
);

1811 
	`as£π
–
	`btKeyCom∑ª
(
buf
.
p
, buf.
n
, 
pKey
, 
nKey
Ë* (
bNext
?1:-1) < 0 );

1813 
	`sqlôe4_buf„r_˛ór
(&
buf
);

1815 
	`as£π_ficurs‹_ok
(
pC§
, 
rc
);

1817  
rc
;

1818 
	}
}

1820 
FiLevñIãr
 
	tFiLevñIãr
;

1821 
	sFiLevñIãr
 {

1823 
BtCurs‹
 
	mc§
;

1824 c⁄° 
u8
 *
	maSum
;

1825 
	mnSum
;

1828 
	mnSub
;

1829 
	miAge
;

1830 
	miLvl
;

1831 
	miSub
;

1834 
	$fiLevñIãrNext
(
FiLevñIãr
 *
p
){

1835 
u16
 
iMö
, 
nLevñ
;

1837 
p
->
iSub
++;

1838 
p
->
iLvl
--;

1839 
	`btRódSumm¨y
(
p
->
aSum
,Ö->
iAge
, &
iMö
, &
nLevñ
, 0);

1840  
p
->
iLvl
<()
iMö
 ){

1841 
p
->
iAge
++;

1842 if–
p
->
iAge
>=’->
nSum
)/6 )  1;

1843 
	`btRódSumm¨y
(
p
->
aSum
,Ö->
iAge
, &
iMö
, &
nLevñ
, 0);

1844 
p
->
iLvl
 = ()
iMö
 + ()
nLevñ
 - 1;

1847 
	`as£π
–
p
->
iSub
<p->
nSub
 );

1849 
	}
}

1851 
	$fiLevñIãrInô
(
bt_db
 *
db
, 
FiLevñIãr
 *
p
){

1852 
rc
;

1854 
	`mem£t
(
p
, 0, (
FiLevñIãr
));

1855 
rc
 = 
	`fiLﬂdSumm¨y
(
db
, &
p
->
c§
, &p->
aSum
, &p->
nSum
);

1856 if–
rc
==
SQLITE4_OK
 ){

1857 
iAge
;

1858 
iAge
=0; iAge<(
p
->
nSum
/6); iAge++){

1859 
u16
 
iMö
, 
nLevñ
;

1860 
	`btRódSumm¨y
(
p
->
aSum
, 
iAge
, &
iMö
, &
nLevñ
, 0);

1861 
p
->
nSub
 +
nLevñ
;

1862 if–
iAge
==0 ){

1863 
p
->
iLvl
 = (()
iMö
 + 
nLevñ
);

1864 
p
->
iSub
 = -1;

1869  
rc
;

1870 
	}
}

1872 
	$fiLevñIãrCÀ™up
(
FiLevñIãr
 *
p
){

1873 
	`btC§Re£t
(&
p
->
c§
, 1);

1874 
	}
}

1880 
	$fiF‹m©Pªfix
(
u8
 *
aPªfix
, 
u32
 
iAge
, u32 
iLvl
){

1881 
	`btPutU32
(&
aPªfix
[0], 
iAge
);

1882 
	`btPutU32
(&
aPªfix
[4], ~(
u32
)
iLvl
);

1883 
	}
}

1888 
	$fiC§Sìk
(
FiCurs‹
 *
pC§
, c⁄° *
pK
, 
nK
, 
eSìk
){

1889 
rc
 = 
SQLITE4_NOTFOUND
;

1890 
bt_db
 *
db
 = 
pC§
->
ba£
.
pDb
;

1891 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

1893 
	`as£π
–
eSìk
==
BT_SEEK_LE
 ||ÉSìk==
BT_SEEK_EQ
 ||ÉSìk==
BT_SEEK_GE
 );

1894 
	`as£π
–(
pC§
->
ba£
.
Êags
 & 
CSR_VISIT_DEL
)==0 || 
eSìk
==
BT_SEEK_GE
 );

1895 
	`fiC§Re£t
(
pC§
);

1897 if–
pHdr
->
iMRoŸ
 ){

1898 
u8
 *
pKey
;

1899 
FiLevñIãr
 
ôî
;

1902 
rc
 = 
	`fiLevñIãrInô
(
db
, &
ôî
);

1903 if–
rc
!=
SQLITE4_OK
 ) Ñc;

1904 
pKey
 = 
	`sqlôe4_mÆloc
(
db
->
pEnv
, 
nK
+8);

1905 if–
pKey
==0 )  
SQLITE4_NOMEM
;

1907 if–
eSìk
==
BT_SEEK_EQ
 ){

1908 
FiSubCurs‹
 *
pSub
;

1909 
BtCurs‹
 *
pM
;

1911 
pC§
->
ba£
.
Êags
 &~(
CSR_NEXT_OK
 | 
CSR_PREV_OK
);

1919 
rc
 = 
	`fiC§AŒoˇãSubs
(
db
, 
pC§
, 1);

1920 
pSub
 = 
pC§
->
aSub
;

1921 
pM
 = &
pSub
->
mc§
;

1923 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, 
pM
);

1924  0==
	`fiLevñIãrNext
(&
ôî
) ){

1926 
	`fiF‹m©Pªfix
(
pSub
->
aPªfix
, 
ôî
.
iAge
, iãr.
iLvl
);

1927 
	`mem˝y
(
pKey
, 
pSub
->
aPªfix
, (pSub->aPrefix));

1928 
rc
 = 
	`btC§Sìk
(
pM
, 0, 
pKey
, 
nK
+8, 
BT_SEEK_LE
, 
BT_CSRSEEK_SEEK
);

1930 if–
rc
==
SQLITE4_INEXACT
 ){

1931 
rc
 = 
	`fiSubC§CheckPªfix
(
pSub
);

1934 if–
rc
==
SQLITE4_NOTFOUND
 ){

1937 }if–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_INEXACT
 ){

1938 c⁄° *
pV
;

1939 
nV
;

1940 
u32
 
iRoŸ
;

1941 
	`sqlôe4BtC§D©a
(&
pM
->
ba£
, 0, 4, &
pV
, &
nV
);

1942 
iRoŸ
 = 
	`sqlôe4BtGëU32
((c⁄° 
u8
*)
pV
);

1943 
	`btC§Re£t
(&
pSub
->
c§
, 1);

1944 
	`btC§Sëup
(
db
, 
iRoŸ
, &
pSub
->
c§
);

1946 
rc
 = 
	`btC§Sìk
(&
pSub
->
c§
, 0, 
pK
, 
nK
, 
BT_SEEK_EQ
, 
BT_CSRSEEK_SEEK
);

1947 
	`as£π
–
rc
!=
SQLITE4_INEXACT
 );

1948 if–
rc
!=
SQLITE4_NOTFOUND
 ){

1953 
	`as£π
–
pC§
->
iBt
<0 );

1954 if–
rc
==
SQLITE4_OK
 ){

1955 if–0==
	`btC§IsDñëe
(&
pSub
->
c§
) ){

1956 
pC§
->
iBt
 = 0;

1958 
rc
 = 
SQLITE4_NOTFOUND
;

1966 
bM©ch
 = 0;

1967 
bHô
 = 0;

1969 
pC§
->
ba£
.
Êags
 |(
eSìk
==
BT_SEEK_GE
 ? 
CSR_NEXT_OK
 : 
CSR_PREV_OK
);

1972 if–
rc
==
SQLITE4_OK
 ){

1973 
rc
 = 
	`fiC§AŒoˇãSubs
(
db
, 
pC§
, 
ôî
.
nSub
);

1977  
rc
==
SQLITE4_OK
 && 0==
	`fiLevñIãrNext
(&
ôî
) ){

1978 
FiSubCurs‹
 *
pSub
 = &
pC§
->
aSub
[
ôî
.
iSub
];

1979 
BtCurs‹
 *
pM
 = &
pSub
->
mc§
;

1980 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, 
pM
);

1982 
	`fiF‹m©Pªfix
(
pSub
->
aPªfix
, 
ôî
.
iAge
, iãr.
iLvl
);

1983 
	`mem˝y
(
pKey
, 
pSub
->
aPªfix
, (pSub->aPrefix));

1985 
rc
 = 
	`btC§Sìk
(
pM
, 0, 
pKey
, 
nK
+8, 
BT_SEEK_LE
, 
BT_CSRSEEK_SEEK
);

1986 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
	`fiSubC§CheckPªfix
(
pSub
);

1987 if–
rc
==
SQLITE4_NOTFOUND
 && 
eSìk
==
BT_SEEK_GE
 ){

1988 
rc
 = 
	`btC§Sìk
(
pM
, 0, 
pSub
->
aPªfix
, (pSub->aPrefix),

1989 
BT_SEEK_GE
, 
BT_CSRSEEK_SEEK


1991 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
	`fiSubC§CheckPªfix
(
pSub
);

1994 if–
rc
==
SQLITE4_NOTFOUND
 ){

1996 
	`as£π
–
pSub
->
mc§
.
nPg
==0 );

1997 
	`as£π
–
pSub
->
c§
.
nPg
==0 );

1998 
rc
 = 
SQLITE4_OK
;

1999 }if–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_INEXACT
 ){

2000 c⁄° *
pV
; 
nV
;

2001 c⁄° *
pSìk
 = 
pK
;

2002 
nSìk
 = 
nK
;

2004 
u32
 
iRoŸ
;

2005 
	`sqlôe4BtC§D©a
(&
pM
->
ba£
, 0, 4, &
pV
, &
nV
);

2006 
iRoŸ
 = 
	`sqlôe4BtGëU32
((c⁄° 
u8
*)
pV
);

2007 
	`btC§Re£t
(&
pSub
->
c§
, 1);

2008 
	`btC§Sëup
(
db
, 
iRoŸ
, &
pSub
->
c§
);

2010 if–
eSìk
==
BT_SEEK_GE
 ){

2011 c⁄° *
pMö
; 
nMö
;

2012 
rc
 = 
	`btC§Key
(
pM
, &
pMö
, &
nMö
);

2013 if–
rc
!=
SQLITE4_OK
 ) ;

2014 
nMö
 -= 8;

2015 
pMö
 = (c⁄° *)((c⁄° 
u8
*)pMin + 8);

2016 if–
	`btKeyCom∑ª
(
pSìk
, 
nSìk
, 
pMö
, 
nMö
)<0 ){

2017 
pSìk
 = 
pMö
;

2018 
nSìk
 = 
nMö
;

2022 
rc
 = 
	`btC§Sìk
(&
pSub
->
c§
, 0, 
pSìk
, 
nSìk
, 
eSìk
, 
BT_CSRSEEK_SEEK
);

2023 if–
rc
==
SQLITE4_NOTFOUND
 ){

2024 
rc
 = 
	`fiSubC§Sãp
(
pC§
, 
pSub
, (
eSìk
==
BT_SEEK_GE
 ? 1 : 0));

2026 if–
rc
==
SQLITE4_OK
 ) 
bM©ch
 = 1;

2027 if–
rc
==
SQLITE4_INEXACT
 ) 
bHô
 = 1;

2030 if–
rc
==
SQLITE4_INEXACT
 ||Ñc==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

2035 
	`as£π
–
rc
!=
SQLITE4_OK
 || 
ôî
.
iSub
==ôî.
nSub
 );

2037 if–
rc
==
SQLITE4_OK
 ){

2038 
rc
 = 
	`fiC§SëCuºít
(
pC§
);

2039 if–
rc
==
SQLITE4_OK
 ){

2040 if–
	`fiC§IsDñëe
(
pC§
) ){

2041 
rc
 = 
	`fiC§Sãp
(
pC§
);

2042 if–
rc
==
SQLITE4_OK
 )Ñ¯
SQLITE4_INEXACT
;

2043 }if–
bM©ch
==0 ){

2044 
rc
 = (
bHô
 ? 
SQLITE4_INEXACT
 : 
SQLITE4_NOTFOUND
);

2050 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
pKey
);

2051 
	`fiLevñIãrCÀ™up
(&
ôî
);

2054  
rc
;

2055 
	}
}

2057 
	$fiC§End
(
FiCurs‹
 *
pC§
, 
bLa°
){

2058 
bt_db
 *
db
 = 
pC§
->
ba£
.
pDb
;

2059 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

2060 
FiLevñIãr
 
ôî
;

2061 
rc
;

2063 
	`as£π
–(
pC§
->
ba£
.
Êags
 & 
CSR_VISIT_DEL
)==0 );

2065 
rc
 = 
	`fiLevñIãrInô
(
db
, &
ôî
);

2066 if–
rc
==
SQLITE4_OK
 ){

2067 
rc
 = 
	`fiC§AŒoˇãSubs
(
db
, 
pC§
, 
ôî
.
nSub
);

2070  
rc
==
SQLITE4_OK
 && 0==
	`fiLevñIãrNext
(&
ôî
) ){

2071 
FiSubCurs‹
 *
pSub
 = &
pC§
->
aSub
[
ôî
.
iSub
];

2072 c⁄° 
n
 = ()(
pSub
->
aPªfix
);

2074 
	`btPutU32
(
pSub
->
aPªfix
, (
u32
)
ôî
.
iAge
);

2075 
	`btPutU32
(&
pSub
->
aPªfix
[4], ~(
u32
)
ôî
.
iLvl
);

2077 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, &
pSub
->
mc§
);

2078 if–
bLa°
==0 ){

2079 
rc
 = 
	`btC§Sìk
(&
pSub
->
mc§
, 0,ÖSub->
aPªfix
, 
n
, 
BT_SEEK_GE
, 0);

2081 
u8
 
aPªfix
[8];

2082 
	`btPutU32
(
aPªfix
, (
u32
)
ôî
.
iAge
 + (ôî.
iLvl
==0 ? 1 : 0));

2083 
	`btPutU32
(&
aPªfix
[4], ~((
u32
)
ôî
.
iLvl
 - (u32)1));

2084 
rc
 = 
	`btC§Sìk
(&
pSub
->
mc§
, 0, 
aPªfix
, 
n
, 
BT_SEEK_LE
, 0);

2085 if–
rc
==
SQLITE4_OK
 ){

2086 
rc
 = 
	`btC§Sãp
(&
pSub
->
mc§
, 0);

2089 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

2090 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`fiSubC§CheckPªfix
(
pSub
);

2092 if–
rc
==
SQLITE4_OK
 ){

2093 c⁄° *
pV
;

2094 
nV
;

2095 
iRoŸ
;

2096 
	`btC§D©a
(&
pSub
->
mc§
, 0, 4, &
pV
, &
nV
);

2097 
iRoŸ
 = 
	`sqlôe4BtGëU32
((c⁄° 
u8
*)
pV
);

2098 
	`btC§Re£t
(&
pSub
->
c§
, 1);

2099 
	`btC§Sëup
(
db
, 
iRoŸ
, &
pSub
->
c§
);

2100 if–
bLa°
 ){

2101 
rc
 = 
	`btC§End
(&
pSub
->
c§
, 1);

2103 c⁄° *
pK
; 
nK
;

2104 
rc
 = 
	`btC§Key
(&
pSub
->
mc§
, &
pK
, &
nK
);

2105 if–
rc
==
SQLITE4_OK
 ){

2106 
rc
 = 
	`btC§Sìk
(&
pSub
->
c§
, 0, ((
u8
*)
pK
)+8, 
nK
-8, 
BT_SEEK_GE
, 0);

2107 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

2108 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

2111 }if–
rc
==
SQLITE4_NOTFOUND
 ){

2112 
	`btC§Re£t
(&
pSub
->
mc§
, 0);

2113 
rc
 = 
SQLITE4_OK
;

2116 
	`fiLevñIãrCÀ™up
(&
ôî
);

2118 if–
rc
==
SQLITE4_OK
 ){

2119 
pC§
->
ba£
.
Êags
 &~(
CSR_NEXT_OK
 | 
CSR_PREV_OK
);

2120 
pC§
->
ba£
.
Êags
 |(
bLa°
 ? 
CSR_PREV_OK
 : 
CSR_NEXT_OK
);

2121 
rc
 = 
	`fiC§SëCuºít
(
pC§
);

2122 if–
rc
==
SQLITE4_OK
 && 
	`btC§IsDñëe
(&
pC§
->
aSub
[pC§->
iBt
].
c§
) ){

2123 
rc
 = 
	`fiC§Sãp
(
pC§
);

2127  
rc
;

2128 
	}
}

2130 
	$sqlôe4BtC§Sìk
(

2131 
bt_curs‹
 *
pBa£
,

2132 c⁄° *
pK
,

2133 
nK
,

2134 
eSìk


2136 
rc
;

2137 
	`btCheckPageRefs
(
pBa£
->
pDb
);

2138 if–
	`IsBtC§
(
pBa£
) ){

2139 
BtCurs‹
 *
pC§
 = (BtCurs‹*)
pBa£
;

2140 
rc
 = 
	`btC§Sìk
(
pC§
, 0, 
pK
, 
nK
, 
eSìk
, 
BT_CSRSEEK_SEEK
);

2142 
FiCurs‹
 *
pC§
 = (FiCurs‹*)
pBa£
;

2143 
rc
 = 
	`fiC§Sìk
(
pC§
, 
pK
, 
nK
, 
eSìk
);

2144 
	`as£π_ficurs‹_ok
(
pC§
, 
rc
);

2146 
	`btCheckPageRefs
(
pBa£
->
pDb
);

2147  
rc
;

2148 
	}
}

2153 
	$sqlôe4BtC§Fú°
(
bt_curs‹
 *
pBa£
){

2154 
rc
;

2155 if–
	`IsBtC§
(
pBa£
) ){

2156 
rc
 = 
	`btC§End
((
BtCurs‹
*)
pBa£
, 0);

2158 
rc
 = 
	`fiC§End
((
FiCurs‹
*)
pBa£
, 0);

2159 
	`as£π_ficurs‹_ok
((
FiCurs‹
*)
pBa£
, 
rc
);

2161  
rc
;

2162 
	}
}

2167 
	$sqlôe4BtC§La°
(
bt_curs‹
 *
pBa£
){

2168 
rc
;

2169 if–
	`IsBtC§
(
pBa£
) ){

2170 
rc
 = 
	`btC§End
((
BtCurs‹
*)
pBa£
, 1);

2172 
rc
 = 
	`fiC§End
((
FiCurs‹
*)
pBa£
, 1);

2173 
	`as£π_ficurs‹_ok
((
FiCurs‹
*)
pBa£
, 
rc
);

2175  
rc
;

2176 
	}
}

2182 
	$sqlôe4BtC§Next
(
bt_curs‹
 *
pBa£
){

2183 
rc
;

2184 if–
	`IsBtC§
(
pBa£
) ){

2185 
rc
 = 
	`btC§Sãp
((
BtCurs‹
*)
pBa£
, 1);

2187 
rc
 = 
	`fiC§Sãp
((
FiCurs‹
*)
pBa£
);

2189  
rc
;

2190 
	}
}

2195 
	$sqlôe4BtC§Pªv
(
bt_curs‹
 *
pBa£
){

2196 
rc
;

2197 if–
	`IsBtC§
(
pBa£
) ){

2198 
rc
 = 
	`btC§Sãp
((
BtCurs‹
*)
pBa£
, 0);

2200 
rc
 = 
	`fiC§Sãp
((
FiCurs‹
*)
pBa£
);

2202  
rc
;

2203 
	}
}

2211 
	$btOvîÊowTrimåì
(

2212 c⁄° 
pgsz
,

2213 
BtPagî
 *
pPagî
,

2214 
u32
 
pgno
,

2215 
nDïth


2217 
rc
 = 
SQLITE4_OK
;

2219 
	`as£π
–
nDïth
<=8 );

2220 if–
nDïth
>0 ){

2221 c⁄° 
nPgPå
 = 
pgsz
 / 4;

2222 
BtPage
 *
pPg
;

2223 
u8
 *
aD©a
;

2224 
i
;

2226 
rc
 = 
	`sqlôe4BtPageGë
(
pPagî
, 
pgno
, &
pPg
);

2227 if–
rc
!=
SQLITE4_OK
 ) Ñc;

2228 
aD©a
 = 
	`btPageD©a
(
pPg
);

2230 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nPgPå
; i++){

2231 
u32
 
chûd
 = 
	`btGëU32
(&
aD©a
[
i
*4]);

2232 if–
chûd
==0 ) ;

2233 
rc
 = 
	`btOvîÊowTrimåì
(
pgsz
, 
pPagî
, 
chûd
, 
nDïth
-1);

2236 
	`sqlôe4BtPageRñó£
(
pPg
);

2239 
	`sqlôe4BtPageTrimPgno
(
pPagî
, 
pgno
);

2240  
rc
;

2241 
	}
}

2250 
	$btOvîÊowDñëe
(
BtCurs‹
 *
pC§
){

2251 
BtPagî
 *
pPagî
 = 
pC§
->
ba£
.
pDb
->pPager;

2252 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pPagî
);

2253 
u8
 *
aD©a
;

2254 
u8
 *
pCñl
;

2255 
u8
 *
pOvÊ
 = 0;

2256 
iCñl
 = 
pC§
->
aiCñl
[pC§->
nPg
-1];

2257 
n
;

2258 
rc
 = 
SQLITE4_OK
;

2260 
aD©a
 = (
u8
*)
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

2261 
	`as£π
–
	`btCñlCou¡
(
aD©a
, 
pgsz
)>
iCñl
 );

2262 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
iCñl
);

2263 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2265 if–
n
==0 ){

2267 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2268 
pCñl
 +
n
;

2269 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2270 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2271 
pOvÊ
 = 
pCñl
;

2273 
pCñl
 +
n
;

2274 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2275 if–
n
==0 ){

2277 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2278 
pCñl
 +
n
;

2279 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
n
);

2280 
pOvÊ
 = 
pCñl
;

2284 if–
pOvÊ
 ){

2285 
i
;

2286 
nDúe˘
 = ()(
pOvÊ
[0] & 0x0F);

2287 
nDïth
 = ()(
pOvÊ
[0]>>4);

2290 
i
=0; 
rc
==
SQLITE4_OK
 && i<(
nDúe˘
 + (
nDïth
==0)); i++){

2291 
u32
 
pgno
 = 
	`btGëU32
(&
pOvÊ
[1 + 
i
*4]);

2292 
rc
 = 
	`sqlôe4BtPageTrimPgno
(
pPagî
, 
pgno
);

2296 if–
nDïth
>0 ){

2297 
u32
 
roŸpgno
 = 
	`btGëU32
(&
pOvÊ
[1 + 
nDúe˘
*4]);

2298 
rc
 = 
	`btOvîÊowTrimåì
(
pgsz
, 
pPagî
, 
roŸpgno
, 
nDïth
);

2302  
rc
;

2303 
	}
}

2305 
	$btC§D©a
(

2306 
BtCurs‹
 *
pC§
,

2307 
iOff£t
,

2308 
nByã
,

2309 c⁄° **
µV
,

2310 *
≤V


2312 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

2313 
rc
;

2314 
u8
 *
aD©a
;

2315 
u8
 *
pCñl
;

2316 
nK
 = 0;

2317 
nV
 = 0;

2319 
rc
 = 
	`btC§Re£ek
(
pC§
);

2320 if–
rc
==
SQLITE4_OK
 ){

2321 if–
pC§
->
bSkùNext
 ||ÖC§->
bSkùPªv
 ){

2324 *
µV
 = 0;

2325 *
≤V
 = 0;

2327 
iCñl
 = 
pC§
->
aiCñl
[pC§->
nPg
-1];

2329 
aD©a
 = (
u8
*)
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

2330 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
iCñl
);

2331 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nK
);

2332 if–
nK
>0 ){

2333 
pCñl
 +
nK
;

2334 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nV
);

2337 if–
nV
==0 ){

2339 
rc
 = 
	`btC§Buf„r
(
pC§
, 1);

2340 if–
rc
==
SQLITE4_OK
 ){

2341 
u8
 *
aBuf
 = (u8*)
pC§
->
ovÊ
.
buf
.
p
;

2342 *
µV
 = &
aBuf
[
pC§
->
ovÊ
.
nKey
];

2343 *
≤V
 = 
pC§
->
ovÊ
.
nVÆ
;

2347 *
µV
 = 
pCñl
;

2348 *
≤V
 = (
nV
-2);

2351 #i‚de‡
NDEBUG


2352 if–
rc
==
SQLITE4_OK
 ){

2353 c⁄° *
pK
; 
nK
;

2354 
rc
 = 
	`sqlôe4BtC§Key
((
bt_curs‹
*)
pC§
, &
pK
, &
nK
);

2355 if–
rc
==
SQLITE4_OK
 ){

2356 
BtLock
 *
pLock
 = (BtLock*)
pC§
->
ba£
.
pDb
->
pPagî
;

2357 
	`sqlôe4BtDebugKV
(
pLock
, "£À˘", (
u8
*)
pK
, 
nK
, (u8*)*
µV
, *
≤V
);

2364  
rc
;

2365 
	}
}

2367 
	$sqlôe4BtC§Key
(
bt_curs‹
 *
pBa£
, c⁄° **
µK
, *
≤K
){

2368 
rc
 = 
SQLITE4_OK
;

2370 if–
	`IsBtC§
(
pBa£
) ){

2371 
rc
 = 
	`btC§Key
((
BtCurs‹
*)
pBa£
, 
µK
, 
≤K
);

2373 
FiCurs‹
 *
pC§
 = (FiCurs‹*)
pBa£
;

2374 
	`as£π
–
pC§
->
iBt
>=0 );

2375 
rc
 = 
	`btC§Key
(&
pC§
->
aSub
[pC§->
iBt
].
c§
, 
µK
, 
≤K
);

2378  
rc
;

2379 
	}
}

2381 
	$sqlôe4BtC§D©a
(

2382 
bt_curs‹
 *
pBa£
,

2383 
iOff£t
,

2384 
nByã
,

2385 c⁄° **
µV
,

2386 *
≤V


2388 
rc
 = 
SQLITE4_OK
;

2390 if–
	`IsBtC§
(
pBa£
) ){

2391 
rc
 = 
	`btC§D©a
((
BtCurs‹
*)
pBa£
, 
iOff£t
, 
nByã
, 
µV
, 
≤V
);

2393 
FiCurs‹
 *
pC§
 = (FiCurs‹*)
pBa£
;

2394 
	`as£π
–
pC§
->
iBt
>=0 );

2395 
rc
 = 
	`btC§D©a
(&
pC§
->
aSub
[pC§->
iBt
].
c§
, 
iOff£t
, 
nByã
, 
µV
, 
≤V
);

2398  
rc
;

2399 
	}
}

2405 
	$btOvîÊowAºayLí
(
u8
 *
p
){

2406  1 + (()(
p
[0] & 0x0F) + 1) * 4;

2407 
	}
}

2409 
	$btCñlSize
(
u8
 *
pCñl
, 
bLóf
){

2410 
u8
 *
p
 = 
pCñl
;

2411 
nKey
;

2413 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2414 if–
bLóf
==0 ){

2416 
p
 +
nKey
;

2417 
p
 += 4;

2418 }if–
nKey
==0 ){

2420 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2421 
p
 +
nKey
;

2422 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2423 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2424 
p
 +
	`btOvîÊowAºayLí
(p);

2426 
p
 +
nKey
;

2427 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2428 if–
nKey
==0 ){

2430 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2431 
p
 +
nKey
;

2432 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

2433 
p
 +
	`btOvîÊowAºayLí
(p);

2434 }if–
nKey
>=2 ){

2435 
p
 +(
nKey
-2);

2439  (
p
-
pCñl
);

2440 
	}
}

2442 
u8
 *
	$btCñlFödSize
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
, *
≤Byã
){

2443 
u8
 *
pCñl
;

2445 
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
nD©a
, 
iCñl
);

2446 *
≤Byã
 = 
	`btCñlSize
(
pCñl
, 0==(
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
));

2447  
pCñl
;

2448 
	}
}

2454 
	$fiC§Cñl
(
FiCurs‹
 *
pC§
, c⁄° **
µCñl
, *
≤Cñl
){

2455 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

2456 
FiSubCurs‹
 *
pSub
;

2457 
u8
 *
aD©a
;

2458 
iCñl
;

2460 
	`as£π
–
pC§
->
iBt
>=0 );

2461 
pSub
 = &
pC§
->
aSub
[pC§->
iBt
];

2462 
aD©a
 = 
	`btPageD©a
(
pSub
->
c§
.
≠Page
[pSub->c§.
nPg
-1]);

2463 
iCñl
 = 
pSub
->
c§
.
aiCñl
[pSub->c§.
nPg
-1];

2465 *
µCñl
 = 
	`btCñlFödSize
(
aD©a
, 
pgsz
, 
iCñl
, 
≤Cñl
);

2466 
	}
}

2472 
	$btC§OvîÊow
(
BtCurs‹
 *
pC§
){

2473 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

2474 
u8
 *
aD©a
;

2475 
nKey
;

2476 
ªs
;

2478 
aD©a
 = 
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

2479 
aD©a
 = 
	`btCñlFöd
◊D©a, 
pgsz
, 
pC§
->
aiCñl
[pC§->
nPg
-1]);

2481 
aD©a
 +
	`sqlôe4BtV¨ötGë32
◊D©a, &
nKey
);

2482 
ªs
 = (
nKey
==0 || 
aD©a
[nKey]==0);

2483  
ªs
;

2484 
	}
}

2489 
	$btNewBuf„r
(
bt_db
 *
pDb
, 
u8
 **
∑Buf
){

2490 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

2491 
u8
 *
aBuf
;

2493 *
∑Buf
 = 
aBuf
 = 
	`sqlôe4_mÆloc
(
pDb
->
pEnv
, 
pgsz
);

2494 if–
aBuf
==0 )  
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

2496 #i‚de‡
NDEBUG


2499 
	`mem£t
(
aBuf
, 0x66, 
pgsz
);

2502  
SQLITE4_OK
;

2503 
	}
}

2508 
	$btFªeBuf„r
(
bt_db
 *
pDb
, 
u8
 *
aBuf
){

2509 
	`sqlôe4_‰ì
(
pDb
->
pEnv
, 
aBuf
);

2510 
	}
}

2515 
	$btSëBuf„r
(
bt_db
 *
pDb
, 
BtPage
 *
pPg
, 
u8
 *
aBuf
){

2516 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

2517 
rc
;

2518 
rc
 = 
	`sqlôe4BtPageWrôe
(
pPg
);

2519 if–
rc
==
SQLITE4_OK
 ){

2520 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

2521 
	`mem˝y
(
aD©a
, 
aBuf
, 
pgsz
);

2522 
	`sqlôe4_‰ì
(
pDb
->
pEnv
, 
aBuf
);

2524  
rc
;

2525 
	}
}

2531 
	$btDe‰agmítPage
(
bt_db
 *
pDb
, 
BtPage
 *
pPg
){

2532 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

2533 
u8
 *
aD©a
;

2534 
u8
 *
aTmp
;

2535 
nCñl
;

2536 
iWrôe
;

2537 
i
;

2538 
bLóf
;

2539 
nHdr
;

2541 if–
	`btNewBuf„r
(
pDb
, &
aTmp
ËË 
SQLITE4_NOMEM
;

2543 
aD©a
 = 
	`btPageD©a
(
pPg
);

2544 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

2546 
bLóf
 = 0==(
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
);

2547 
nHdr
 = 
bLóf
 ? 1 : 5;

2550 
	`mem˝y
(
aTmp
, 
aD©a
, 
nHdr
);

2552 
iWrôe
 = 
nHdr
;

2553 
i
=0; i<
nCñl
; i++){

2554 
nByã
;

2555 
u8
 *
pCñl
;

2556 
pCñl
 = 
	`btCñlFödSize
(
aD©a
, 
pgsz
, 
i
, &
nByã
);

2558 
	`btPutU16
(
	`btCñlPåFöd
(
aTmp
, 
pgsz
, 
i
), 
iWrôe
);

2559 
	`mem˝y
(&
aTmp
[
iWrôe
], 
pCñl
, 
nByã
);

2560 
iWrôe
 +
nByã
;

2564 
	`btPutU16
(&
aTmp
[
pgsz
-2], 
nCñl
);

2565 
	`btPutU16
(&
aTmp
[
pgsz
-4],Ögsz - (3+
nCñl
)*2 - 
iWrôe
);

2566 
	`btPutU16
(&
aTmp
[
pgsz
-6], 
iWrôe
);

2568 
	`btSëBuf„r
(
pDb
, 
pPg
, 
aTmp
);

2569  
SQLITE4_OK
;

2570 
	}
}

2590 
	#KV_VALUE
 0

	)

2591 
	#KV_CELL
 1

	)

2592 
KeyVÆue
 
	tKeyVÆue
;

2593 
	sKeyVÆue
 {

2594 
	meTy≥
;

2595 c⁄° *
	mpK
; 
	mnK
;

2596 c⁄° *
	mpV
; 
	mnV
;

2597 
u32
 
	mpgno
;

2606 
	$btKVCñlSize
(
KeyVÆue
 *
pKV
){

2607 
nByã
;

2608 
	`as£π
–
pKV
->
eTy≥
==
KV_CELL
 ||ÖKV->eTy≥==
KV_VALUE
 );

2609 if–
pKV
->
eTy≥
==
KV_CELL
 ){

2610 
nByã
 = 
pKV
->
nV
;

2612 if–
pKV
->
pgno
 ){

2613 
nByã
 = 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nK
) +ÖKV->nK + 4;

2615 
	`as£π
–
pKV
->
nV
>=0 ||ÖKV->
pV
==0 );

2616 
nByã
 =

2617 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nK
)

2618 + 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nV
+2)

2619 + 
	`MAX
(
pKV
->
nV
, 0Ë+ÖKV->
nK
;

2622  
nByã
;

2623 
	}
}

2629 
	$btKVCñlWrôe
(
KeyVÆue
 *
pKV
, 
u8
 *
aBuf
){

2630 
i
 = 0;

2631 if–
pKV
->
eTy≥
==
KV_CELL
 ){

2632 
i
 = 
pKV
->
nV
;

2633 
	`mem˝y
(
aBuf
, 
pKV
->
pV
, 
i
);

2635 
i
 +
	`sqlôe4BtV¨ötPut32
(&
aBuf
[i], 
pKV
->
nK
);

2636 
	`mem˝y
(&
aBuf
[
i
], 
pKV
->
pK
,ÖKV->
nK
); i +=ÖKV->nK;

2638 if–
pKV
->
pgno
==0 ){

2639 
i
 +
	`sqlôe4BtV¨ötPut32
(&
aBuf
[i], 
pKV
->
nV
+2);

2640 if–
pKV
->
nV
>0 ){

2641 
	`mem˝y
(&
aBuf
[
i
], 
pKV
->
pV
,ÖKV->
nV
);

2642 
i
 +
pKV
->
nV
;

2645 
	`btPutU32
(&
aBuf
[
i
], 
pKV
->
pgno
);

2646 
i
 += 4;

2650 
	`as£π
–
i
==
	`btKVCñlSize
(
pKV
) );

2651  
i
;

2652 
	}
}

2659 
	$btOvîÊowAºaySz
(
pgsz
, 
nC⁄ã¡
){

2660 
nPg
;

2661 
nPg
 = (
nC⁄ã¡
 + 
pgsz
 - 1) /Ögsz;

2662 if–
nPg
<=
BT_MAX_DIRECT_OVERFLOW
 ){

2663  1 + 
nPg
*4;

2665  1 + (
BT_MAX_DIRECT_OVERFLOW
+1) * 4;

2666 
	}
}

2675 
	$btAŒoˇãN⁄OvîÊow
(
bt_db
 *
db
, 
BtPage
 **
µPg
){

2676 
rc
;

2677 if–
db
->
bFa°In£πOp
 ){

2678 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

2679 
u32
 
iPg
;

2681 
	`sqlôe4BtPagîDbhdrDúty
(
db
->
pPagî
);

2682 
iPg
 = 
pHdr
->
nSubPg
 + 
	`btFú°OfBlock
’Hdr,ÖHdr->
iSubBlock
);

2683 
pHdr
->
nSubPg
++;

2684 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
iPg
, 
µPg
);

2685 if–
rc
==
SQLITE4_OK
 ){

2686 
rc
 = 
	`sqlôe4BtPageWrôe
(*
µPg
);

2687 if–
rc
!=
SQLITE4_OK
 ){

2688 
	`sqlôe4BtPageRñó£
(*
µPg
);

2692 
rc
 = 
	`sqlôe4BtPageAŒoˇã
(
db
->
pPagî
, 
µPg
);

2694  
rc
;

2695 
	}
}

2700 
	$btTrimN⁄OvîÊow
(
bt_db
 *
db
, 
BtPage
 *
pPg
){

2701 
rc
;

2702 if–
db
->
bFa°In£πOp
==0 ){

2703 
rc
 = 
	`sqlôe4BtPageTrim
(
pPg
);

2705 
rc
 = 
	`sqlôe4BtPageRñó£
(
pPg
);

2707  
rc
;

2708 
	}
}

2713 
	$btAŒoˇãAndZîo
(
bt_db
 *
db
, 
BtPage
 **
µPg
){

2714 
BtPage
 *
pPg
 = 0;

2715 
rc
;

2717 
rc
 = 
	`sqlôe4BtPageAŒoˇã
(
db
->
pPagî
, &
pPg
);

2718 if–
rc
==
SQLITE4_OK
 ){

2719 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
db
->
pPagî
);

2720 
	`mem£t
(
	`btPageD©a
(
pPg
), 0, 
pgsz
);

2723 *
µPg
 = 
pPg
;

2724  
rc
;

2725 
	}
}

2727 
	$btOvîÊowAºayP›uœã
(

2728 
bt_db
 *
db
, 
u8
 **
µOut
,

2729 
u8
 *
pBuf1
, 
nBuf1
,

2730 
u8
 *
pBuf2
, 
nBuf2


2732 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
db
->
pPagî
);

2733 c⁄° 
nPgPå
 = 
pgsz
 / 4;

2734 
rc
 = 
SQLITE4_OK
;

2735 
n1
 = 0;

2736 
n2
 = 0;

2737 
iOvÊ
;

2738 
nDúe˘
 = 0;

2739 
nDïth
 = 0;

2740 
nOvÊ
;

2741 
i
;

2742 
u8
 *
aOut
 = *
µOut
;

2744 
	sHeú
 {

2745 
BtPage
 *
pPg
;

2746 
iCñl
;

2747 } 
≠Hõr
[8];

2748 
	`mem£t
(
≠Hõr
, 0, (apHier));

2752 
nOvÊ
 = (
nBuf1
+
nBuf2
+
pgsz
-1) /Ögsz;

2753 
nOvÊ
 -
BT_MAX_DIRECT_OVERFLOW
;

2754  
nOvÊ
>1 ){

2755 
nDïth
++;

2756 
nOvÊ
 = (nOvÊ+
nPgPå
-1) /ÇPgPtr;

2759 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nDïth
; i++){

2760 
u32
 
pgno
;

2761 
rc
 = 
	`btAŒoˇãAndZîo
(
db
, &
≠Hõr
[
i
].
pPg
);

2762 
pgno
 = 
	`sqlôe4BtPagePgno
(
≠Hõr
[
i
].
pPg
);

2763 if–
i
==0 ){

2764 
	`btPutU32
(&
aOut
[1 + 
BT_MAX_DIRECT_OVERFLOW
*4], 
pgno
);

2766 
u8
 *
a
 = 
	`btPageD©a
(
≠Hõr
[
i
-1].
pPg
);

2767 
	`btPutU32
(
a
, 
pgno
);

2768 
≠Hõr
[
i
-1].
iCñl
++;

2772 
iOvÊ
=0; 
rc
==
SQLITE4_OK
 && (
n1
<
nBuf1
 || 
n2
<
nBuf2
); iOvfl++){

2773 
nC›y1
, 
nC›y2
;

2774 
u8
 *
aD©a
;

2775 
BtPage
 *
pPg
;

2776 
u32
 
pgno
;

2778 
rc
 = 
	`sqlôe4BtPageAŒoˇã
(
db
->
pPagî
, &
pPg
);

2779 if–
rc
!=
SQLITE4_OK
 ) ;

2780 
aD©a
 = 
	`btPageD©a
(
pPg
);

2781 
pgno
 = 
	`sqlôe4BtPagePgno
(
pPg
);

2783 
nC›y1
 = 
	`MIN
(
pgsz
, 
nBuf1
 - 
n1
);

2784 
nC›y2
 = 
	`MIN
(
pgsz
 - 
nC›y1
, 
nBuf2
 - 
n2
);

2786 
	`mem˝y
(
aD©a
, &
pBuf1
[
n1
], 
nC›y1
);Ç1 +=ÇCopy1;

2787 
	`mem˝y
(&
aD©a
[
nC›y1
], &
pBuf2
[
n2
], 
nC›y2
);Ç2 +=ÇCopy2;

2788 
rc
 = 
	`sqlôe4BtPageRñó£
(
pPg
);

2789 if–
rc
!=
SQLITE4_OK
 ) ;

2791 if–
iOvÊ
<(
BT_MAX_DIRECT_OVERFLOW
+(
nDïth
==0)) ){

2792 
	`btPutU32
(&
aOut
[1 + 
iOvÊ
*4], 
pgno
);

2793 
nDúe˘
++;

2795 
	`as£π
–
nDïth
>0 );

2796 
i
=
nDïth
-1; 
pgno
 && i>=0; i--){

2797 
u8
 *
a
 = 
	`btPageD©a
(
≠Hõr
[
i
].
pPg
);

2798 if–
≠Hõr
[
i
].
iCñl
==
nPgPå
 ){

2799 
BtPage
 *
pNew
 = 0;

2800 
rc
 = 
	`sqlôe4BtPageRñó£
(
≠Hõr
[
i
].
pPg
);

2801 if–
rc
==
SQLITE4_OK
 ){

2802 
rc
 = 
	`btAŒoˇãAndZîo
(
db
, &
pNew
);

2803 if–
rc
==
SQLITE4_OK
 ){

2804 
u8
 *
a
 = 
	`btPageD©a
(
pNew
);

2805 
	`btPutU32
(
a
, 
pgno
);

2806 
pgno
 = 
	`sqlôe4BtPagePgno
(
pNew
);

2810 if–
rc
!=
SQLITE4_OK
 ){

2811 
pgno
 = 0;

2814 
≠Hõr
[
i
].
pPg
 = 
pNew
;

2815 
≠Hõr
[
i
].
iCñl
 = 1;

2817 
	`btPutU32
(&
a
[
≠Hõr
[
i
].
iCñl
*4], 
pgno
);

2818 
≠Hõr
[
i
].
iCñl
++;

2819 
pgno
 = 0;

2825 
i
=0; i<
nDïth
; i++){

2826 
rc2
 = 
	`sqlôe4BtPageRñó£
(
≠Hõr
[
i
].
pPg
);

2827 if–
rc
==
SQLITE4_OK
 )Ñ¯
rc2
;

2830 if–
rc
==
SQLITE4_OK
 ){

2831 if–
nDïth
==0 ){

2832 
nDúe˘
--;

2834 
	`as£π
–
nDúe˘
>=0 );

2835 
aOut
[0] = (
u8
)
nDúe˘
 | (u8)(
nDïth
<<4) ;

2838 *
µOut
 = &
aOut
[1 + (
nDúe˘
+1)*4];

2839  
rc
;

2840 
	}
}

2850 
	$btOvîÊowAssign
(
bt_db
 *
db
, 
KeyVÆue
 *
pKV
){

2851 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
db
->
pPagî
);

2852 
nMaxSize
 = (
pgsz
 - 1 - 6 - 2);

2853 
nReq
;

2854 
rc
 = 
SQLITE4_OK
;

2856 
	`as£π
–
pKV
->
pgno
==0 &&ÖKV->
eTy≥
==
KV_VALUE
 );

2860 
nReq
 = 
	`btKVCñlSize
(
pKV
);

2861 if–
nReq
 > 
nMaxSize
 ){

2862 
nAºaySz
 = 
	`btOvîÊowAºaySz
(
pgsz
, 
pKV
->
nK
 + 
	`MAX
(0,ÖKV->
nV
));

2863 
u8
 *
pBuf
 = 0;

2864 
nKeyOvÊ
;

2865 
nVÆOvÊ
;

2874 
nReq
 = 1 + 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nK
) +ÖKV->nK

2875 + 1 + 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nV
Ë+ 
nAºaySz
;

2876 if–
nReq
<
nMaxSize
 && 
pKV
->
nV
>=0 ){

2883 
nLVÆ
;

2884 
nSpc
 = (
nMaxSize


2885 - 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nK
Ë-ÖKV->nK - 1 - 
nAºaySz


2887 
nLVÆ
 = 
nSpc
 - 
	`sqlôe4BtV¨ötLí32
(
pgsz
Ë- sqlôe4BtV¨ötLí32(
pKV
->
nV
);

2888 
nKeyOvÊ
 = 0;

2889 
nVÆOvÊ
 = 
pKV
->
nV
 - 
nLVÆ
;

2892 
nLKey
 = 
nMaxSize


2894 - 
	`sqlôe4BtV¨ötLí32
(
pgsz
)

2895 - 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nK
)

2896 - 
	`sqlôe4BtV¨ötLí32
(
pKV
->
nV
+1)

2897 - 
nAºaySz
;

2899 
nVÆOvÊ
 = 
pKV
->
nV
;

2900 
nKeyOvÊ
 = 
pKV
->
nK
 - 
nLKey
;

2907 
rc
 = 
	`btNewBuf„r
(
db
, &
pBuf
);

2909 if–
rc
==
SQLITE4_OK
 ){

2910 
nLVÆ
 = (
pKV
->
nV
 - 
nVÆOvÊ
);

2911 
nLKey
 = (
pKV
->
nK
 - 
nKeyOvÊ
);

2912 
u8
 *
pOut
 = 
pBuf
;

2914 if–
nKeyOvÊ
>0 ){

2915 *
pOut
++ = 0x00;

2917 
pOut
 +
	`sqlôe4BtV¨ötPut32
’Out, 
nLKey
);

2918 
	`mem˝y
(
pOut
, 
pKV
->
pK
, 
nLKey
);

2919 
pOut
 +
nLKey
;

2920 if–
nKeyOvÊ
==0 ){

2922 
	`as£π
–
pKV
->
nV
>=0 );

2923 *
pOut
++ = 0x00;

2924 
pOut
 +
	`sqlôe4BtV¨ötPut32
’Out, 
nLVÆ
);

2925 
	`mem˝y
(
pOut
, 
pKV
->
pV
, 
nLVÆ
);

2926 
pOut
 +
nLVÆ
;

2929 
pOut
 +
	`sqlôe4BtV¨ötPut32
’Out, 
nKeyOvÊ
);

2931 
pOut
 +
	`sqlôe4BtV¨ötPut32
’Out, 
nVÆOvÊ
 + (
nKeyOvÊ
>0));

2933 
rc
 = 
	`btOvîÊowAºayP›uœã
(
db
, &
pOut
,

2934 (
u8
*)(
pKV
->
pK
Ë+ 
nLKey
, 
nKeyOvÊ
,

2935 (
u8
*)(
pKV
->
pV
Ë+ 
nLVÆ
, 
	`MAX
(0, 
nVÆOvÊ
)

2937 if–
rc
==
SQLITE4_OK
 ){

2938 
	`mem£t
(
pKV
, 0, (*pKV));

2939 
pKV
->
pV
 = 
pBuf
;

2940 
pKV
->
nV
 = 
pOut
 - 
pBuf
;

2941 
pKV
->
eTy≥
 = 
KV_CELL
;

2942 
pBuf
 = 0;

2943 
	`as£π
–
pKV
->
nV
<=
nMaxSize
 );

2944 
	`as£π
–
pKV
->
nV
==
	`btCñlSize
((
u8
*ÌKV->
pV
, 1) );

2948 if–
pBuf
 ){

2949 
	`btFªeBuf„r
(
db
, 
pBuf
);

2953  
rc
;

2954 
	}
}

2956 
BÆ™˚Ctx
 
	tBÆ™˚Ctx
;

2957 
	sBÆ™˚Ctx
 {

2958 
	mpgsz
;

2959 
	mbLóf
;

2960 
u8
 
	mÊags
;

2961 
BtCurs‹
 *
	mpC§
;

2962 
	mnKV
;

2963 
KeyVÆue
 *
	m≠KV
;

2966 
	mnIn
;

2967 
BtPage
 *
	m≠Pg
[5];

2969 
	mnCñl
;

2972 *
	m™CñlSz
;

2975 
	m™Out
[5];

2978 
	mnOut
;

2979 
	miOut
;

2980 
u8
 *
	m≠Out
[5];

2981 
KeyVÆue
 
	maPCñl
[5];

2982 
u8
 *
	mpTmp
;

2983 
	miTmp
;

2986 
	$btG©hîSiblögs
(
BÆ™˚Ctx
 *
p
){

2987 
BtCurs‹
 *
pC§
 = 
p
->pCsr;

2988 
bt_db
 * c⁄° 
pDb
 = 
pC§
->
ba£
.pDb;

2989 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

2991 
rc
 = 
SQLITE4_OK
;

2992 
nCñl
;

2993 
u8
 *
aP¨ít
;

2994 
iChûd
;

2995 
nSib
;

2996 
iSib
;

2998 
i
;

3000 
aP¨ít
 = 
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-2]);

3001 
iChûd
 = 
pC§
->
aiCñl
[pC§->
nPg
-2];

3002 
nCñl
 = 
	`btCñlCou¡
(
aP¨ít
, 
pgsz
);

3004 if–
nCñl
<2 ){

3005 
nSib
 = 
nCñl
+1;

3007 
nSib
 = 3;

3010 if–
iChûd
==0 ){

3011 
iSib
 = 0;

3012 }if–
iChûd
==
nCñl
 ){

3013 
iSib
 = 
nCñl
-(
nSib
-1);

3015 
iSib
 = 
iChûd
-1;

3018 
i
=0; i<
nSib
 && 
rc
==
SQLITE4_OK
; i++){

3019 
u32
 
pgno
 = 
	`btChûdPgno
(
aP¨ít
, 
pgsz
, 
iSib
+
i
);

3020 
rc
 = 
	`sqlôe4BtPageGë
(
pDb
->
pPagî
, 
pgno
, &
p
->
≠Pg
[
i
]);

3021 
	`as£π
–(
iSib
+
i
)!=
iChûd
 || 
p
->
≠Pg
[i]==
pC§
->
≠Page
[pC§->
nPg
-1] );

3023 
p
->
nIn
 = 
nSib
;

3025 
pC§
->
aiCñl
[pC§->
nPg
-2] = 
iSib
;

3026  
rc
;

3027 
	}
}

3038 
	$btI¡î«lCñlToKeyVÆue
(
u8
 *
pCñl
, 
KeyVÆue
 *
pKV
){

3039 
pKV
->
pK
 = 
pCñl
 + 
	`sqlôe4BtV¨ötGë32
’Cñl, &pKV->
nK
);

3040 
pKV
->
pgno
 = 
	`btGëU32
(&((
u8
*ÌKV->
pK
)[pKV->
nK
]);

3041 
pKV
->
pV
 = 0;

3042 
pKV
->
nV
 = 0;

3043 
pKV
->
eTy≥
 = 
KV_VALUE
;

3044 
	}
}

3046 
	$btSëChûdPgno
(
bt_db
 *
pDb
, 
BtPage
 *
pPg
, 
iChûd
, 
u32
 
pgno
){

3047 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

3048 
rc
;

3050 
rc
 = 
	`sqlôe4BtPageWrôe
(
pPg
);

3051 if–
rc
==
SQLITE4_OK
 ){

3052 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

3053 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3054 if–
iChûd
>=
nCñl
 ){

3055 
	`btPutU32
(&
aD©a
[1], 
pgno
);

3057 
nKey
;

3058 
u8
 *
pCñl
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
iChûd
);

3059 
pCñl
 +
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKey
);

3060 
pCñl
 +
nKey
;

3061 
	`btPutU32
(
pCñl
, 
pgno
);

3065  
rc
;

3066 
	}
}

3069 
btIn£πAndBÆ™˚
(
BtCurs‹
 *, , 
KeyVÆue
 *);

3070 
btDñëeFromPage
(
BtCurs‹
 *, );

3071 
btBÆ™˚IfUndîfuŒ
(
BtCurs‹
 *
pC§
);

3073 
	$btBÆ™˚Mósuª
(

3074 
BÆ™˚Ctx
 *
p
,

3075 
iCñl
,

3076 
u8
 *
pCñl
, 
nByã
,

3077 
KeyVÆue
 *
pKV


3079 if–
pCñl
 ){

3080 
p
->
™CñlSz
[
iCñl
] = 
nByã
;

3082 
p
->
™CñlSz
[
iCñl
] = 
	`btKVCñlSize
(
pKV
);

3084  
SQLITE4_OK
;

3085 
	}
}

3087 
	$btBÆ™˚Ouçut
(

3088 
BÆ™˚Ctx
 *
p
,

3089 
iCñl
,

3090 
u8
 *
pCñl
, 
nByã
,

3091 
KeyVÆue
 *
pKV


3093 
u8
 *
aOut
 = 
p
->
≠Out
[p->
iOut
];

3094 
iOff
;

3095 
nCñl
;

3097 
	`as£π
–(
pCñl
==0)!=(
pKV
==0) );

3099 if–
p
->
bLóf
==0 && 
iCñl
=ı->
™Out
[p->
iOut
] ){

3110 
nKey
;

3111 
u8
 *
pKey
;

3112 
u8
 *
pC›y
;

3113 
u32
 
pgno
;

3114 
KeyVÆue
 *
pPKey
 = &
p
->
aPCñl
[p->
iOut
];

3116 if–
pCñl
 ){

3117 
pKey
 = 
pCñl
 + 
	`sqlôe4BtV¨ötGë32
’Cñl, &
nKey
);

3118 
pgno
 = 
	`btGëU32
(&
pKey
[
nKey
]);

3120 
	`as£π
–
pKV
->
eTy≥
==
KV_VALUE
 );

3121 
pKey
 = (
u8
*)
pKV
->
pK
;

3122 
nKey
 = 
pKV
->
nK
;

3123 
pgno
 = 
pKV
->pgno;

3126 
pC›y
 = &
p
->
pTmp
[p->
iTmp
];

3127 
p
->
iTmp
 +
nKey
;

3128 
	`mem˝y
(
pC›y
, 
pKey
, 
nKey
);

3129 
pPKey
->
pK
 = 
pC›y
;

3130 
pPKey
->
nK
 = 
nKey
;

3132 
	`btPutU32
(&
aOut
[1], 
pgno
);

3133 
p
->
iOut
++;

3137 
iOff
 = 
	`btFªeOff£t
(
aOut
, 
p
->
pgsz
);

3138 if–
iOff
==0 ) iOf‡(
p
->
bLóf
 ? 1 : 5);

3139 
nCñl
 = 
	`btCñlCou¡
(
aOut
, 
p
->
pgsz
);

3140 
	`btPutU16
(
	`btCñlPåFöd
(
aOut
, 
p
->
pgsz
, 
nCñl
), 
iOff
);

3141 if–
pCñl
 ){

3142 
	`mem˝y
(&
aOut
[
iOff
], 
pCñl
, 
nByã
);

3143 
iOff
 +
nByã
;

3145 
iOff
 +
	`btKVCñlWrôe
(
pKV
, &
aOut
[iOff]);

3147 
	`btPutU16
(&
aOut
[
p
->
pgsz
-2], 
nCñl
+1);

3148 
	`btPutU16
(&
aOut
[
p
->
pgsz
-6], 
iOff
);

3150 if–(
iCñl
+1)==
p
->
™Out
[p->
iOut
] ){

3153 
nFªe
;

3154 
nFªe
 = 
p
->
pgsz
 - 
iOff
 - (6 + 2*(
nCñl
+1));

3155 
aOut
[0] = 
p
->
Êags
;

3156 
	`btPutU16
(&
aOut
[
p
->
pgsz
-4], 
nFªe
);

3162 
p
->
iOut
 +p->
bLóf
;

3166  
SQLITE4_OK
;

3167 
	}
}

3169 
btBÆ™˚VisôCñls
(

3170 
BÆ™˚Ctx
 *
p
,

3171 (*
xVisô
)(
BÆ™˚Ctx
*, , 
u8
*, , 
KeyVÆue
*)

3173 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
p
->
pC§
->
ba£
.
pDb
->
pPagî
);

3174 
rc
 = 
SQLITE4_OK
;

3175 
iPg
;

3176 
iCÆl
 = 0;

3177 
i
;

3179 
BtPage
 *
pIns
 = 
p
->
pC§
->
≠Page
[p->pC§->
nPg
-1];

3180 
iIns
 = 
p
->
pC§
->
aiCñl
[p->pC§->
nPg
-1];

3183 #i‚de‡
NDEBUG


3184 
i
=0; 
p
->
≠Pg
[i]!=
pIns
; i++Ë
	`as£π
–i<p->
nIn
 );

3187 
iPg
=0; iPg<
p
->
nIn
 && 
rc
==
SQLITE4_OK
; iPg++){

3188 
BtPage
 *
pPg
;

3189 
u8
 *
aD©a
;

3190 
nCñl
;

3191 
iCñl
;

3193 
pPg
 = 
p
->
≠Pg
[
iPg
];

3194 
aD©a
 = 
	`btPageD©a
(
pPg
);

3195 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3197 
iCñl
=0; iCñl<
nCñl
 && 
rc
==
SQLITE4_OK
; iCell++){

3198 
nByã
;

3199 
u8
 *
pCñl
;

3201 if–
pPg
==
pIns
 && 
iCñl
==
iIns
 ){

3202 
i
=0; i<
p
->
nKV
; i++){

3203 
	`as£π
–
iCÆl
<
p
->
nCñl
 );

3204 
rc
 = 
	`xVisô
(
p
, 
iCÆl
++, 0, 0, &p->
≠KV
[
i
]);

3205 if–
rc
!=
SQLITE4_OK
 ) ;

3209 
pCñl
 = 
	`btCñlFödSize
(
aD©a
, 
pgsz
, 
iCñl
, &
nByã
);

3210 
rc
 = 
	`xVisô
(
p
, 
iCÆl
++, 
pCñl
, 
nByã
, 0);

3213 if–
pPg
==
pIns
 && 
iIns
==
nCñl
 ){

3214 
i
=0; i<
p
->
nKV
 && 
rc
==
SQLITE4_OK
; i++){

3215 
	`as£π
–
iCÆl
<
p
->
nCñl
 );

3216 
rc
 = 
	`xVisô
(
p
, 
iCÆl
++, 0, 0, &p->
≠KV
[
i
]);

3223 if–
p
->
bLóf
==0 && 
iPg
<’->
nIn
-1Ë&& 
rc
==
SQLITE4_OK
 ){

3224 
iP¨
 = 
p
->
pC§
->
nPg
-2;

3225 
u8
 *
aP¨ít
 = 
	`btPageD©a
(
p
->
pC§
->
≠Page
[
iP¨
]);

3226 
u8
 *
pCñl
 = 
	`btCñlFöd
(
aP¨ít
, 
pgsz
, 
p
->
pC§
->
aiCñl
[
iP¨
] + 
iPg
);

3227 
KeyVÆue
 
kv
;

3228 
	`btI¡î«lCñlToKeyVÆue
(
pCñl
, &
kv
);

3229 
kv
.
pgno
 = 
	`btGëU32
(&
aD©a
[1]);

3230 
rc
 = 
	`xVisô
(
p
, 
iCÆl
++, 0, 0, &
kv
);

3234 
	`as£π
–
rc
!=
SQLITE4_OK
 || 
iCÆl
==
p
->
nCñl
 );

3235  
rc
;

3236 
	}
}

3247 
u8
 *
	$btKeyPªfix
(c⁄° 
pgsz
, 
BtPage
 *
pPg
, 
bLa°
, *
≤Byã
){

3248 
u8
 *
p
;

3249 
n
;

3250 
u8
 *
aD©a
;

3252 
aD©a
 = 
	`btPageD©a
(
pPg
);

3253 
p
 = 
	`btCñlFöd
(
aD©a
, 
pgsz
, 
bLa°
 ? 
	`btCñlCou¡
(aData,Ögsz)-1 : 0);

3254 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
n
);

3255 if–
n
==0 ) 
p
 +
	`sqlôe4BtV¨ötGë32
(p, &n);

3257 *
≤Byã
 = 
n
;

3258  
p
;

3259 
	}
}

3270 
	$btPªfixKey
(

3271 c⁄° 
pgsz
, 
BtPage
 *
pLe·
, BtPagê*
pRight
, 
KeyVÆue
 *
pKV


3273 
nMax
;

3274 
nMaxPªfix
 = 
BT_MAX_INTERNAL_KEY
;

3276 
u8
 *
aLe·
; 
nLe·
;

3277 
u8
 *
aRight
; 
nRight
;

3278 
i
;

3280 
aLe·
 = 
	`btKeyPªfix
(
pgsz
, 
pLe·
, 1, &
nLe·
);

3281 
aRight
 = 
	`btKeyPªfix
(
pgsz
, 
pRight
, 0, &
nRight
);

3283 
nMax
 = 
	`MIN
(
nLe·
, 
nMaxPªfix
);

3284 
i
=0; i<
nMax
 && 
aLe·
[i]==
aRight
[i]; i++);

3285 if–
i
<
nMaxPªfix
 ){

3286 
pKV
->
pK
 = 
aRight
;

3287 
pKV
->
nK
 = 
i
 + 1;

3288 
	`as£π
–
pKV
->
nK
<=
nRight
 );

3290 
	}
}

3292 
	$btBÆ™˚
(

3293 
BtCurs‹
 *
pC§
,

3294 
bLóf
,

3295 
nKV
,

3296 
KeyVÆue
 *
≠KV


3298 
bt_db
 * c⁄° 
pDb
 = 
pC§
->
ba£
.pDb;

3299 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

3300 c⁄° 
nS∑˚PîPage
 = (
pgsz
 - 1 - 6 - (!
bLóf
)*4);

3302 
iPg
;

3303 
iCñl
;

3305 
™ByãOut
[5];

3306 
BtPage
 *
pP¨
;

3307 
iSib
;

3309 
rc
 = 
SQLITE4_OK
;

3311 
BÆ™˚Ctx
 
˘x
;

3312 
	`mem£t
(&
˘x
, 0, (ctx));

3313 
˘x
.
pC§
 =ÖCsr;

3314 
˘x
.
nKV
 =ÇKV;

3315 
˘x
.
≠KV
 =ápKV;

3316 
˘x
.
pgsz
 =Ögsz;

3317 
˘x
.
bLóf
 = bLeaf;

3318 
˘x
.
Êags
 = *(
u8
*)
	`btPageD©a
(
pC§
->
≠Page
[pC§->
nPg
-1]);

3320 
	`mem£t
(
™ByãOut
, 0, (anByteOut));

3324 
	`as£π
–
bLóf
==0 || bLeaf==1 );

3325 
	`as£π
–
pC§
->
nPg
>1 );

3326 
rc
 = 
	`btG©hîSiblögs
(&
˘x
);

3327 if–
rc
!=
SQLITE4_OK
 ) 
ªbÆ™˚_out
;

3328 
pP¨
 = 
pC§
->
≠Page
[pC§->
nPg
-2];

3329 
iSib
 = 
pC§
->
aiCñl
[pC§->
nPg
-2];

3332 
˘x
.
nCñl
 = 
nKV
;

3333 
iPg
=0; iPg<
˘x
.
nIn
; iPg++){

3334 
u8
 *
aD©a
 = 
	`btPageD©a
(
˘x
.
≠Pg
[
iPg
]);

3335 
˘x
.
nCñl
 +
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3337 if–
bLóf
==0 ) 
˘x
.
nCñl
 +(˘x.
nIn
-1);

3338 
	`as£π
–
˘x
.
nCñl
>0 );

3341 
˘x
.
™CñlSz
 = (*)
	`sqlôe4_mÆloc
(
pDb
->
pEnv
, ()*˘x.
nCñl
);

3342 if–
˘x
.
™CñlSz
==0 ){

3343 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

3344 
ªbÆ™˚_out
;

3346 
rc
 = 
	`btBÆ™˚VisôCñls
(&
˘x
, 
btBÆ™˚Mósuª
);

3350 
iCñl
 = 0;

3351 
iPg
=0; 
iCñl
<
˘x
.
nCñl
; iPg++){

3352 
	`as£π
–
iPg
<
	`¨øy_size
(
˘x
.
™Out
) );

3353 if–
bLóf
==0 && 
iPg
!=0 ){

3356 
iCñl
++;

3358 
	`as£π
–
™ByãOut
[
iPg
]==0 );

3359  ; 
iCñl
<
˘x
.
nCñl
; iCell++){

3360 
nByã
 = (
˘x
.
™CñlSz
[
iCñl
] + 2);

3361 if–
nByã
+
™ByãOut
[
iPg
]>
nS∑˚PîPage
 ) ;

3362 
™ByãOut
[
iPg
] +
nByã
;

3364 
˘x
.
™Out
[
iPg
] = 
iCñl
;

3366 
˘x
.
nOut
 = 
iPg
;

3367 
	`as£π
–
˘x
.
™Out
[˘x.
nOut
-1]==˘x.
nCñl
 );

3375 
iCñl
 = 
˘x
.
nCñl
;

3377 
iPg
=(
˘x
.
nOut
-2); iPg>=0; iPg--){

3378 
iR
 = 
iPg
+1;

3380 
nLe·
 = 
˘x
.
™CñlSz
[ ctx.
™Out
[
iPg
]-1 ] + 2;

3381 
nRight
 = (
bLóf
 ? 
nLe·
 : (
˘x
.
™CñlSz
[ ctx.
™Out
[
iPg
] ] + 2));

3383 if–
™ByãOut
[
iPg
]==
nLe·
 || (™ByãOut[
iR
] + 
nRight
) >ánByteOut[iPg] ){

3386 
˘x
.
™Out
[
iPg
]--;

3387 
™ByãOut
[
iPg
] -
nLe·
;

3388 
™ByãOut
[
iR
] +
nRight
;

3392 #ifde‡
BT_STDERR_DEBUG


3394 
iDbg
;

3395 
	`Ârötf
(
°dîr
,

3396 "\nbtBÆ™˚(): bLóf=%dÇIn=%dánIn[] = ", 
˘x
.
bLóf
, ctx.
nIn


3398 
iDbg
=0; iDbg<
˘x
.
nIn
; iDbg++){

3399 
u8
 *
aD©a
 = 
	`btPageD©a
(
˘x
.
≠Pg
[
iDbg
]);

3400 
	`Ârötf
(
°dîr
, "%d ", 
	`btCñlCou¡
(
aD©a
, 
pgsz
));

3402 
	`Ârötf
(
°dîr
, " ->ÇOut=%dánOut[] = ", 
˘x
.
nOut
);

3403 
iDbg
=0; iDbg<
˘x
.
nOut
; iDbg++){

3404 
	`Ârötf
(
°dîr
, "%d ", 
˘x
.
™Out
[
iDbg
]);

3406 
	`Ârötf
(
°dîr
, "\n");

3407 
	`fÊush
(
°dîr
);

3415 
iPg
=0; iPg<
˘x
.
nOut
; iPg++){

3416 
rc
 = 
	`btNewBuf„r
(
pDb
, &
˘x
.
≠Out
[
iPg
]);

3417 if–
rc
!=
SQLITE4_OK
 ) 
ªbÆ™˚_out
;

3418 
	`mem£t
(
˘x
.
≠Out
[
iPg
] + 
pgsz
-6, 0, 6);

3420 if–
bLóf
==0 ){

3421 
rc
 = 
	`btNewBuf„r
(
pDb
, &
˘x
.
pTmp
);

3422 if–
rc
!=
SQLITE4_OK
 ) 
ªbÆ™˚_out
;

3426 
rc
 = 
	`btBÆ™˚VisôCñls
(&
˘x
, 
btBÆ™˚Ouçut
);

3427 if–
rc
!=
SQLITE4_OK
 ) 
ªbÆ™˚_out
;

3429 if–
˘x
.
bLóf
==0 ){

3432 
u8
 *
aRightSiblög
 = 
	`btPageD©a
(
˘x
.
≠Pg
[˘x.
nIn
-1]);

3433 
	`mem˝y
(&(
˘x
.
≠Out
[˘x.
nOut
-1])[1], &
aRightSiblög
[1], 4);

3437 
iPg
=0; iPg<
˘x
.
nOut
; iPg++){

3438 if–
iPg
>=
˘x
.
nIn
 ){

3439 
rc
 = 
	`btAŒoˇãN⁄OvîÊow
(
pDb
, &
˘x
.
≠Pg
[
iPg
]);

3440 if–
rc
!=
SQLITE4_OK
 ) 
ªbÆ™˚_out
;

3442 
	`btSëBuf„r
(
pDb
, 
˘x
.
≠Pg
[
iPg
], ctx.
≠Out
[iPg]);

3443 
˘x
.
≠Out
[
iPg
] = 0;

3445 
iPg
=
˘x
.
nOut
; iPg<˘x.
nIn
; iPg++){

3446 
rc
 = 
	`btTrimN⁄OvîÊow
(
pDb
, 
˘x
.
≠Pg
[
iPg
]);

3447 
˘x
.
≠Pg
[
iPg
] = 0;

3448 if–
rc
!=
SQLITE4_OK
 ) 
ªbÆ™˚_out
;

3451 #ifde‡
BT_STDERR_DEBUG


3453 
iDbg
;

3454 
iDbg
=0; iDbg<
˘x
.
nOut
; iDbg++){

3455 
u8
 *
aD©a
 = 
	`btPageD©a
(
˘x
.
≠Pg
[
iDbg
]);

3456 
	`¥ötPage
(
°dîr
, 
	`sqlôe4BtPagePgno
(
˘x
.
≠Pg
[
iDbg
]), 
aD©a
, 
pgsz
);

3465 
iPg
=0; iPg<(
˘x
.
nOut
-1); iPg++){

3466 
˘x
.
aPCñl
[
iPg
].
pgno
 = 
	`sqlôe4BtPagePgno
(˘x.
≠Pg
[iPg]);

3467 if–
bLóf
 ){

3468 
	`as£π
–
˘x
.
aPCñl
[
iPg
].
nK
==0 );

3469 
	`btPªfixKey
(
pgsz
, 
˘x
.
≠Pg
[
iPg
], ctx.≠Pg[iPg+1], &˘x.
aPCñl
[iPg]);

3473 
rc
 = 
	`btSëChûdPgno
(

3474 
pDb
, 
pP¨
, 
iSib
+
˘x
.
nIn
-1, 
	`sqlôe4BtPagePgno
(˘x.
≠Pg
[˘x.
nOut
-1])

3476 if–
rc
==
SQLITE4_OK
 ){

3477 
	`btC§As˚nd
(
pC§
, 1);

3478 
rc
 = 
	`btDñëeFromPage
(
pC§
, 
˘x
.
nIn
-1);

3480 
iPg
 = 
pC§
->
nPg
;

3481 if–
rc
==
SQLITE4_OK
 && 
˘x
.
nOut
>1 ){

3482 
rc
 = 
	`btIn£πAndBÆ™˚
(
pC§
, 
˘x
.
nOut
-1, ctx.
aPCñl
);

3484 if–
rc
==
SQLITE4_OK
 && 
iPg
==
pC§
->
nPg
 ){

3485 
rc
 = 
	`btBÆ™˚IfUndîfuŒ
(
pC§
);

3488 #ifde‡
BT_STDERR_DEBUG


3490 
u8
 *
aD©a
 = 
	`btPageD©a
(
pP¨
);

3491 
	`¥ötPage
(
°dîr
, 
	`sqlôe4BtPagePgno
(
pP¨
), 
aD©a
, 
pgsz
);

3495 
ªbÆ™˚_out
:

3496 
iPg
=0; iPg<
	`¨øy_size
(
˘x
.
≠Pg
); iPg++){

3497 
	`sqlôe4BtPageRñó£
(
˘x
.
≠Pg
[
iPg
]);

3499 
	`btFªeBuf„r
(
pDb
, 
˘x
.
pTmp
);

3500 
	`sqlôe4_‰ì
(
pDb
->
pEnv
, 
˘x
.
™CñlSz
);

3501  
rc
;

3502 
	}
}

3504 
	$btExãndTªe
(
BtCurs‹
 *
pC§
){

3505 
bt_db
 * c⁄° 
pDb
 = 
pC§
->
ba£
.pDb;

3506 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
pDb
->
pPagî
);

3507 c⁄° 
pgsz
 = 
pHdr
->pgsz;

3508 
rc
;

3509 
BtPage
 *
pNew
;

3510 
BtPage
 *
pRoŸ
 = 
pC§
->
≠Page
[0];

3512 
	`as£π
–
pC§
->
nPg
==1 );

3514 
rc
 = 
	`sqlôe4BtPageWrôe
(
pRoŸ
);

3515 if–
rc
==
SQLITE4_OK
 ){

3516 
rc
 = 
	`btAŒoˇãN⁄OvîÊow
(
pDb
, &
pNew
);

3518 if–
rc
==
SQLITE4_OK
 ){

3519 
u8
 *
aRoŸ
 = 
	`btPageD©a
(
pRoŸ
);

3520 
u8
 *
aD©a
 = 
	`btPageD©a
(
pNew
);

3522 
	`mem˝y
(
aD©a
, 
aRoŸ
, 
pgsz
);

3523 
aRoŸ
[0] = 
BT_PGFLAGS_INTERNAL
;

3524 if–
pHdr
->
iMRoŸ
==
pC§
->
iRoŸ
 ) 
aRoŸ
[0] |
BT_PGFLAGS_METATREE
;

3525 
	`btPutU32
(&
aRoŸ
[1], 
	`sqlôe4BtPagePgno
(
pNew
));

3526 
	`btPutU16
(&
aRoŸ
[
pgsz
-2], 0);

3527 
	`btPutU16
(&
aRoŸ
[
pgsz
-4], 5);

3528 
	`btPutU16
(&
aRoŸ
[
pgsz
-6],Ögsz - 5 - 6);

3530 
pC§
->
nPg
 = 2;

3531 
pC§
->
aiCñl
[1] =ÖCsr->aiCell[0];

3532 
pC§
->
≠Page
[1] = 
pNew
;

3533 
pC§
->
aiCñl
[0] = 0;

3536  
rc
;

3537 
	}
}

3552 
	$btTryAµíd
(
BtCurs‹
 *
pC§
, 
nKV
, 
KeyVÆue
 *
≠KV
){

3553 
rc
 = 
SQLITE4_NOTFOUND
;

3554 if–
nKV
==1 && 
pC§
->
nPg
>1 ){

3555 
bt_db
 *
pDb
 = 
pC§
->
ba£
.pDb;

3556 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pDb
->
pPagî
);

3557 
BtPage
 *
pOld
 = 
pC§
->
≠Page
[pC§->
nPg
-1];

3558 
u8
 *
aD©a
 = 
	`btPageD©a
(
pOld
);

3559 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3560 if–
nCñl
==
pC§
->
aiCñl
[pC§->
nPg
-1] ){

3561 
KeyVÆue
 
kv
;

3562 
BtPage
 *
pNew
 = 0;

3563 
rc
 = 
	`btAŒoˇãN⁄OvîÊow
(
pDb
, &
pNew
);

3564 if–
rc
==
SQLITE4_OK
 ){

3565 
aD©a
 = 
	`btPageD©a
(
pNew
);

3566 
	`btPutU16
(&
aD©a
[
pgsz
-2], 0);

3567 
aD©a
[0] = 0x00;

3568 
pC§
->
≠Page
[pC§->
nPg
-1] = 
pNew
;

3569 
pC§
->
aiCñl
[pC§->
nPg
-1] = 0;

3570 
rc
 = 
	`btIn£πAndBÆ™˚
(
pC§
, 1, 
≠KV
);

3572 if–
rc
==
SQLITE4_OK
 ){

3573 
rc
 = 
	`btSëChûdPgno
(
pDb
,

3574 
pC§
->
≠Page
[pC§->
nPg
-2],ÖC§->
aiCñl
[pCsr->nPg-2],

3575 
	`sqlôe4BtPagePgno
(
pNew
)

3578 if–
rc
==
SQLITE4_OK
 ){

3579 
	`as£π
–
pC§
->
≠Page
[pC§->
nPg
-1]==
pNew
 );

3580 
	`btPªfixKey
(
pgsz
, 
pOld
, 
pNew
, &
kv
);

3581 
kv
.
pgno
 = 
	`sqlôe4BtPagePgno
(
pOld
);

3582 
kv
.
pV
 = 0;

3583 
kv
.
nV
 = 0;

3584 
kv
.
eTy≥
 = 0;

3585 
rc
 = 
	`btC§As˚nd
(
pC§
, 1);

3587 if–
rc
==
SQLITE4_OK
 ){

3588 
rc
 = 
	`btIn£πAndBÆ™˚
(
pC§
, 1, &
kv
);

3590 if–
pNew
 ) 
	`sqlôe4BtPageRñó£
(
pOld
);

3593  
rc
;

3594 
	}
}

3610 
	$btIn£πAndBÆ™˚
(

3611 
BtCurs‹
 *
pC§
,

3612 
nKV
,

3613 
KeyVÆue
 *
≠KV


3615 
rc
 = 
SQLITE4_OK
;

3616 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

3617 
u8
 *
aD©a
;

3618 
nCñl
;

3619 
nFªe
;

3620 
nReq
 = 0;

3621 
iCñl
;

3622 
iWrôe
;

3623 
i
;

3624 
bLóf
;

3625 
BtPage
 *
pLóf
;

3627 
bLóf
 = (
≠KV
[0].
pgno
==0);

3628 
	`as£π
–
bLóf
==0 || 
nKV
==1 );

3631 
i
=0; i<
nKV
; i++){

3632 
nReq
 +
	`btKVCñlSize
(&
≠KV
[
i
]) + 2;

3635 
iCñl
 = 
pC§
->
aiCñl
[pC§->
nPg
-1];

3636 
	`as£π
–
pC§
->
nPg
>0 );

3637 
pLóf
 = 
pC§
->
≠Page
[pC§->
nPg
-1];

3638 
aD©a
 = (
u8
*)
	`btPageD©a
(
pLóf
);

3644 
	`as£π
–
nKV
>0 );

3645 if–(0==(
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
))!=
bLóf
 ){

3646  
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

3649 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3650 
	`as£π
–
iCñl
<=
	`btCñlCou¡
(
aD©a
, 
pgsz
) );

3652 if–
nCñl
==0 ){

3657 
iWrôe
 = (
bLóf
 ? 1 : 5);

3658 
nFªe
 = 
pgsz
 - 
iWrôe
 - 6;

3660 if–
	`btFªeC⁄tiguous
(
aD©a
, 
pgsz
)<
nReq
 && 
	`btFªeS∑˚
(aData,Ögsz)>=nReq ){

3664 
rc
 = 
	`btDe‰agmítPage
(
pC§
->
ba£
.
pDb
, 
pLóf
);

3665 
aD©a
 = 
	`btPageD©a
(
pLóf
);

3668 
iWrôe
 = 
	`btFªeOff£t
(
aD©a
, 
pgsz
);

3669 
nFªe
 = 
	`btFªeC⁄tiguous
(
aD©a
, 
pgsz
);

3672 if–
nFªe
>=
nReq
 ){

3675 
rc
 = 
	`sqlôe4BtPageWrôe
(
pLóf
);

3676 if–
rc
==
SQLITE4_OK
 ){

3677 
aD©a
 = 
	`btPageD©a
(
pLóf
);

3680 if–
iCñl
!=
nCñl
 ){

3681 
u8
 *
aFrom
 = 
	`btCñlPåFöd
(
aD©a
, 
pgsz
, 
nCñl
-1);

3682 
u8
 *
aTo
 = 
	`btCñlPåFöd
(
aD©a
, 
pgsz
, 
nCñl
-1+
nKV
);

3683 
	`memmove
(
aTo
, 
aFrom
, (
nCñl
-
iCñl
) * 2);

3686 
i
=0; i<
nKV
; i++){

3688 
	`btPutU16
(
	`btCñlPåFöd
(
aD©a
, 
pgsz
, 
iCñl
+
i
), 
iWrôe
);

3691 
iWrôe
 +
	`btKVCñlWrôe
(&
≠KV
[
i
], &
aD©a
[iWrite]);

3695 if–
nCñl
==0 ){

3696 
	`btPutU16
(&
aD©a
[
pgsz
-4], 
nFªe
 - 
nReq
);

3698 
	`btPutU16
(&
aD©a
[
pgsz
-4], 
	`btFªeS∑˚
◊D©a,ÖgszË- 
nReq
);

3702 
	`btPutU16
(&
aD©a
[
pgsz
-2], 
nCñl
+
nKV
);

3705 
	`btPutU16
(&
aD©a
[
pgsz
-6], 
iWrôe
);

3712 
bt_db
 *
db
 = 
pC§
->
ba£
.
pDb
;

3713 if–
bLóf
 && 
db
->
bFa°In£πOp
 ){

3717 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

3718 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

3719 if–(
nPgPîBlk
 - 
pHdr
->
nSubPg
Ë< 
pC§
->
nPg
+1 ){

3720 
	`sqlôe4BtPagîDbhdrDúty
(
db
->
pPagî
);

3721 
rc
 = 
BT_BLOCKFULL
;

3722 
pHdr
->
iSubBlock
 = 0;

3725 if–
rc
==
SQLITE4_OK
 && 
pC§
->
nPg
==1 ){

3726 
rc
 = 
	`btExãndTªe
(
pC§
);

3728 if–
rc
==
SQLITE4_OK
 ){

3729 
rc
 = 
	`btBÆ™˚
(
pC§
, 
bLóf
, 
nKV
, 
≠KV
);

3731 if–
bLóf
==0 || 
SQLITE4_NOTFOUND
==(
rc
 = 
	`btTryAµíd
(
pC§
, 
nKV
, 
≠KV
)) ){

3732 
rc
 = 
	`btBÆ™˚
(
pC§
, 
bLóf
, 
nKV
, 
≠KV
);

3738  
rc
;

3739 
	}
}

3741 
	$btDñëeFromPage
(
BtCurs‹
 *
pC§
, 
nDñ
){

3742 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

3743 
rc
 = 
SQLITE4_OK
;

3744 
BtPage
 *
pPg
;

3746 
pPg
 = 
pC§
->
≠Page
[pC§->
nPg
-1];

3747 
rc
 = 
	`sqlôe4BtPageWrôe
(
pPg
);

3748 if–
rc
==
SQLITE4_OK
 ){

3749 
i
;

3750 
u8
 *
aD©a
;

3751 
nCñl
;

3752 
iDñ
;

3753 
nFªed
 = 0;

3755 
iDñ
 = 
pC§
->
aiCñl
[pC§->
nPg
-1];

3756 
aD©a
 = (
u8
*)
	`btPageD©a
(
pPg
);

3757 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3759 
i
=
iDñ
; i<(iDñ+
nDñ
); i++){

3760 
nByã
;

3761 
	`btCñlFödSize
(
aD©a
, 
pgsz
, 
i
, &
nByã
);

3762 
nFªed
 +
nByã
 + 2;

3765 if–(
iDñ
+
nDñ
)<
nCñl
 ){

3766 
u8
 *
aTo
 = 
	`btCñlPåFöd
(
aD©a
, 
pgsz
, 
nCñl
-1-
nDñ
);

3767 
u8
 *
aFrom
 = 
	`btCñlPåFöd
(
aD©a
, 
pgsz
, 
nCñl
-1);

3768 
	`memmove
(
aTo
, 
aFrom
, 2*(
nCñl
-(
iDñ
+
nDñ
)));

3772 
	`btPutU16
(&
aD©a
[
pgsz
-2], 
nCñl
-
nDñ
);

3775 
	`btPutU16
(&
aD©a
[
pgsz
-4], 
	`btFªeS∑˚
◊D©a,ÖgszË+ 
nFªed
);

3778  
rc
;

3779 
	}
}

3781 
	$btBÆ™˚IfUndîfuŒ
(
BtCurs‹
 *
pC§
){

3782 c⁄° 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
pC§
->
ba£
.
pDb
->
pPagî
);

3783 
rc
 = 
SQLITE4_OK
;

3784 
iPg
 = 
pC§
->
nPg
-1;

3785 
BtPage
 *
pPg
 = 
pC§
->
≠Page
[
iPg
];

3786 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

3787 
nCñl
 = 
	`btCñlCou¡
(
aD©a
, 
pgsz
);

3788 
nFªe
 = 
	`btFªeS∑˚
(
aD©a
, 
pgsz
);

3789 
bLóf
 = (0==(
	`btFœgs
(
aD©a
Ë& 
BT_PGFLAGS_INTERNAL
));

3791 if–
iPg
==0 ){

3795 if–
nCñl
==0 && 
bLóf
==0 ){

3796 
BtPagî
 *
pPagî
 = 
pC§
->
ba£
.
pDb
->pPager;

3797 
u32
 
pgno
 = 
	`btChûdPgno
(
aD©a
, 
pgsz
, 0);

3798 
BtPage
 *
pChûd
;

3800 
rc
 = 
	`sqlôe4BtPageWrôe
(
pPg
);

3801 if–
rc
==
SQLITE4_OK
 ){

3802 
rc
 = 
	`sqlôe4BtPageGë
(
pPagî
, 
pgno
, &
pChûd
);

3804 if–
rc
==
SQLITE4_OK
 ){

3805 
u8
 *
a
 = 
	`btPageD©a
(
pChûd
);

3806 
	`mem˝y
(
aD©a
, 
a
, 
pgsz
);

3807 
rc
 = 
	`btTrimN⁄OvîÊow
(
pC§
->
ba£
.
pDb
, 
pChûd
);

3810 }if–
nCñl
==0 || (
nFªe
>(2*
pgsz
/3Ë&& 
bLóf
==0) ){

3811 
rc
 = 
	`btBÆ™˚
(
pC§
, 
bLóf
, 0, 0);

3813  
rc
;

3814 
	}
}

3816 
	$btSaveAŒCurs‹
(
bt_db
 *
pDb
, 
BtCurs‹
 *
pC§
){

3817 
rc
 = 
SQLITE4_OK
;

3818 
bt_curs‹
 *
pIãr
;

3820 
pIãr
=
pDb
->
pAŒC§
; 
rc
==
SQLITE4_OK
 &&ÖIãr;ÖIãrıIãr->
pNextC§
){

3821 if–
	`IsBtC§
(
pIãr
) ){

3822 
BtCurs‹
 *
p
 = (BtCurs‹*)
pIãr
;

3823 if–
p
->
nPg
>0 ){

3824 
	`as£π
–
p
->
bRequúeRe£ek
==0 );

3825 
rc
 = 
	`btC§Buf„r
(
p
, 0);

3826 if–
rc
==
SQLITE4_OK
 ){

3827 
	`as£π
–
p
->
ovÊ
.
buf
.p );

3828 
p
->
bRequúeRe£ek
 = 1;

3829 if–
p
!=
pC§
 ) 
	`btC§Rñó£AŒ
(p);

3837  
rc
;

3838 
	}
}

3840 
btFa°In£πRoŸ
(
bt_db
 *
db
, 
BtDbHdr
 *
pHdr
, 
u32
 *
piRoŸ
);

3841 
btScheduÀMîge
(
bt_db
 *
db
);

3843 
	$btRïœ˚E¡ry
(

3844 
bt_db
 *
db
,

3845 
u32
 
iRoŸ
,

3846 c⁄° *
pK
, 
nK
,

3847 c⁄° *
pV
, 
nV


3849 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

3850 
rc
 = 
SQLITE4_OK
;

3851 
BtCurs‹
 
c§
;

3852 
u32
 
iRoŸPg
 = 
iRoŸ
;

3854 if–
iRoŸ
==0 ){

3855 
rc
 = 
	`btFa°In£πRoŸ
(
db
, 
pHdr
, &
iRoŸPg
);

3857 
	`btC§Sëup
(
db
, 
iRoŸPg
, &
c§
);

3861 if–
rc
==
SQLITE4_OK
 ){

3862 
rc
 = 
	`btC§Sìk
(&
c§
, 0, 
pK
, 
nK
, 
BT_SEEK_GE
, 
BT_CSRSEEK_UPDATE
);

3865 if–
rc
==
SQLITE4_OK
 ){

3869 
rc
 = 
	`sqlôe4BtDñëe
(&
c§
.
ba£
);

3870 if–
rc
==
SQLITE4_OK
 && (
nV
>=0 || 
iRoŸ
==0) ){

3871 
rc
 = 
	`btC§Sìk
(&
c§
, 0, 
pK
, 
nK
, 
BT_SEEK_GE
, 
BT_CSRSEEK_UPDATE
);

3872 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`btEº‹Bk±
(
SQLITE4_CORRUPT
);

3877 if–
rc
==
SQLITE4_NOTFOUND
 ||Ñc==
SQLITE4_INEXACT
 ){

3878 if–
nV
<0 && 
iRoŸ
!=0 ){

3881 
rc
 = 
SQLITE4_OK
;

3883 
KeyVÆue
 
kv
;

3884 
kv
.
pgno
 = 0;

3885 
kv
.
eTy≥
 = 
KV_VALUE
;

3886 
kv
.
pK
 =ÖK; kv.
nK
 =ÇK;

3887 
kv
.
pV
 =ÖV; kv.
nV
 =ÇV;

3889 
rc
 = 
	`btOvîÊowAssign
(
db
, &
kv
);

3890 if–
rc
==
SQLITE4_OK
 ){

3893 
rc
 = 
	`btIn£πAndBÆ™˚
(&
c§
, 1, &
kv
);

3896 if–
rc
!=
BT_BLOCKFULL
 ) ;

3897 
	`as£π
–
iRoŸ
==0 );

3900 
rc
 = 
	`btScheduÀMîge
(
db
);

3902 if–
rc
==
SQLITE4_OK
 ){

3903 
rc
 = 
	`btFa°In£πRoŸ
(
db
, 
pHdr
, &
iRoŸPg
);

3905 if–
rc
==
SQLITE4_OK
 ){

3906 
	`btC§Re£t
(&
c§
, 1);

3907 
	`btC§Sëup
(
db
, 
iRoŸPg
, &
c§
);

3908 
rc
 = 
	`btC§Sìk
(&
c§
, 0, 
pK
, 
nK
, 
BT_SEEK_GE
, 
BT_CSRSEEK_UPDATE
);

3910 } 
rc
==
SQLITE4_NOTFOUND
 ||Ñc==
SQLITE4_INEXACT
 );

3913 if–
kv
.
eTy≥
==
KV_CELL
 ){

3914 
	`sqlôe4_‰ì
(
db
->
pEnv
, (*)
kv
.
pV
);

3919 
	`btC§Re£t
(&
c§
, 1);

3920  
rc
;

3921 
	}
}

3923 
	$btAŒoˇãNewRoŸ
(
bt_db
 *
db
, 
Êag
, 
u32
 *
piNew
){

3924 
u32
 
iNew
 = 0;

3925 
BtPage
 *
pPg
;

3926 
rc
;

3928 
	`as£π
–
Êag
==
BT_PGFLAGS_METATREE
 || fœg==
BT_PGFLAGS_SCHEDULE
 || flag==0 );

3929 
rc
 = 
	`sqlôe4BtPageAŒoˇã
(
db
->
pPagî
, &
pPg
);

3930 if–
rc
==
SQLITE4_OK
 ){

3931 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

3932 
aD©a
[0] = (
Êag
 & 0xFF);

3933 
iNew
 = 
	`sqlôe4BtPagePgno
(
pPg
);

3934 
	`sqlôe4BtPageRñó£
(
pPg
);

3937 *
piNew
 = 
iNew
;

3938  
rc
;

3939 
	}
}

3941 
	$btDecodeMë©ªeKey
(

3942 
BtCurs‹
 *
pC§
,

3943 
u32
 *
piAge
,

3944 
u32
 *
piLevñ
,

3945 
u8
 **
∑Key
,

3946 *
≤Key


3948 
u8
 *
aK
; 
nK
;

3949 
rc
 = 
	`sqlôe4BtC§Key
((
bt_curs‹
*)
pC§
, (c⁄° **)&
aK
, &
nK
);

3950 if–
rc
==
SQLITE4_OK
 ){

3951 *
piAge
 = 
	`btGëU32
(&
aK
[0]);

3952 *
piLevñ
 = ~
	`btGëU32
(&
aK
[4]);

3953 if–
∑Key
 ){

3954 *
∑Key
 = &
aK
[8];

3955 *
≤Key
 = 
nK
-8;

3958  
rc
;

3959 
	}
}

3961 *
	$btMÆloc
(
bt_db
 *
db
, 
nByã
, *
pRc
){

3962 *
pRë
 = 0;

3963 if–*
pRc
==
SQLITE4_OK
 ){

3964 
pRë
 = 
	`sqlôe4_mÆloc
(
db
->
pEnv
, 
nByã
);

3965 if–!
pRë
 ) *
pRc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

3967  
pRë
;

3968 
	}
}

3969 
	$btFªe
(
bt_db
 *
db
, *
p
){

3970 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
p
);

3971 
	}
}

3973 
	$fiLﬂdSumm¨y
(

3974 
bt_db
 *
db
,

3975 
BtCurs‹
 *
p
,

3976 c⁄° 
u8
 **
∑Summ¨y
,

3977 *
≤Summ¨y


3979 c⁄° 
u8
 
aZîo
[] = {0x00, 0x00, 0x00, 0x00, 0x00, 0x00};

3980 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

3981 
rc
;

3983 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, 
p
);

3984 
rc
 = 
	`btC§Sìk
(

3985 
p
, 0, 
aSumm¨yKey
, ◊Summ¨yKey), 
BT_SEEK_EQ
, 
BT_CSRSEEK_SEEK


3987 if–
rc
==
SQLITE4_OK
 ){

3988 
rc
 = 
	`btC§D©a
(
p
, 0, -1, (c⁄° **)
∑Summ¨y
, 
≤Summ¨y
);

3989 }if–
rc
==
SQLITE4_NOTFOUND
 ){

3990 *
∑Summ¨y
 = 
aZîo
;

3991 *
≤Summ¨y
 = (
aZîo
);

3992 
rc
 = 
SQLITE4_OK
;

3995  
rc
;

3996 
	}
}

3998 
	$btRódSumm¨y
(

3999 c⁄° 
u8
 *
aSum
, 
iAge
,

4000 
u16
 *
piMöLevñ
,

4001 
u16
 *
≤Levñ
,

4002 
u16
 *
piMîgeLevñ


4004 if–
piMöLevñ
 ) *piMöLevñ = 
	`btGëU16
(&
aSum
[
iAge
 * 6]);

4005 if–
≤Levñ
 ) *≤Levñ = 
	`btGëU16
(&
aSum
[
iAge
 * 6 + 2]);

4006 if–
piMîgeLevñ
 ) *piMîgeLevñ = 
	`btGëU16
(&
aSum
[
iAge
 * 6 + 4]);

4007 
	}
}

4009 
	$btWrôeSumm¨y
(

4010 
u8
 *
aSum
, 
iAge
,

4011 
u16
 
iMöLevñ
,

4012 
u16
 
nLevñ
,

4013 
u16
 
iMîgeLevñ


4015 
	`btPutU16
(&
aSum
[
iAge
 * 6], 
iMöLevñ
);

4016 
	`btPutU16
(&
aSum
[
iAge
 * 6 + 2], 
nLevñ
);

4017 
	`btPutU16
(&
aSum
[
iAge
 * 6 + 4], 
iMîgeLevñ
);

4018 
	}
}

4024 
	$btAŒoˇãNewLevñ
(

4025 
bt_db
 *
db
,

4026 
BtDbHdr
 *
pHdr
,

4027 
u32
 *
piNext


4030 
rc
;

4031 
BtCurs‹
 
c§
;

4032 
nByã
;

4033 c⁄° 
u8
 *
aByã
;

4034 
u8
 *
aNew
;

4036 
rc
 = 
	`fiLﬂdSumm¨y
(
db
, &
c§
, &
aByã
, &
nByã
);

4038 
aNew
 = (
u8
*)
	`btMÆloc
(
db
, 
nByã
, &
rc
);

4039 if–
rc
==
SQLITE4_OK
 ){

4040 
u16
 
iMö
, 
nLevñ
, 
iMîge
;

4041 
	`btRódSumm¨y
(
aByã
, 0, &
iMö
, &
nLevñ
, &
iMîge
);

4043 
	`mem˝y
(
aNew
, 
aByã
, 
nByã
);

4044 
	`btPutU16
(&
aNew
[2], 
nLevñ
+1);

4045 
rc
 = 
	`btRïœ˚E¡ry
(

4046 
db
, 
pHdr
->
iMRoŸ
, 
aSumm¨yKey
, ◊Summ¨yKey), 
aNew
, 
nByã


4048 
	`btFªe
(
db
, 
aNew
);

4050 *
piNext
 = (
iMö
 + 
nLevñ
);

4053 
	`btC§Re£t
(&
c§
, 1);

4054  
rc
;

4055 
	}
}

4057 
	$btWrôeScheduÀ
(
u8
 *
aD©a
, 
BtScheduÀ
 *
p
, *
pRc
){

4058 if–*
pRc
==
SQLITE4_OK
 ){

4059 
u32
 *
a
 = (u32*)
p
;

4060 
i
;

4061 
i
=0; i<(
BtScheduÀ
)/(
u32
); i++){

4062 
	`btPutU32
(&
aD©a
[
i
*4], 
a
[i]);

4065 
	}
}

4066 
	$btRódScheduÀ
(
bt_db
 *
db
, 
u8
 *
aD©a
, 
BtScheduÀ
 *
p
){

4067 
u32
 *
a
 = (u32*)
p
;

4068 
i
;

4069 
i
=0; i<(
BtScheduÀ
)/(
u32
); i++){

4070 
a
[
i
] = 
	`btGëU32
(&
aD©a
[i*4]);

4072  
SQLITE4_OK
;

4073 
	}
}

4075 
	$btWrôeScheduÀPage
(
BtPage
 *
pPg
, 
BtScheduÀ
 *
p
, *
pRc
){

4076 if–*
pRc
==
SQLITE4_OK
 ){

4077 
rc
 = 
	`sqlôe4BtPageWrôe
(
pPg
);

4078 if–
rc
==
SQLITE4_OK
 ){

4079 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

4080 
	`btWrôeScheduÀ
(
aD©a
, 
p
, &
rc
);

4082 *
pRc
 = 
rc
;

4084 
	}
}

4086 
	$btAŒoˇãBlock
(

4087 
bt_db
 *
db
,

4088 
nBlk
,

4089 
u32
 *
aiBlk


4091  
	`sqlôe4BtBlockAŒoˇã
(
db
->
pPagî
, 
nBlk
, 
aiBlk
);

4092 
	}
}

4098 
	$btFödMîge
(

4099 
bt_db
 *
db
,

4100 
u32
 *
piAge
,

4101 
u32
 *
piMöLevñ
,

4102 
u32
 *
piMaxLevñ
,

4103 
u32
 *
piOutLevñ


4105 
BtCurs‹
 
c§
;

4106 
rc
;

4107 c⁄° 
u8
 *
aSum
;

4108 
nSum
;

4110 
rc
 = 
	`fiLﬂdSumm¨y
(
db
, &
c§
, &
aSum
, &
nSum
);

4111 if–
rc
==
SQLITE4_OK
 ){

4112 
iAge
;

4113 
iBe°Age
 = -1;

4114 
nBe°
 = (
db
->
nMöMîge
-1);

4115 
u16
 
iMö
, 
nLevñ
, 
iMîge
;

4117 
rc
 = 
SQLITE4_NOTFOUND
;

4118 
iAge
=0; iAge<(
nSum
/6); iAge++){

4119 
	`btRódSumm¨y
(
aSum
, 
iAge
, &
iMö
, &
nLevñ
, &
iMîge
);

4120 if–
iMîge
 ){

4121 
n
 = 1 + (
iMîge
-
iMö
);

4122 if–
n
>
nBe°
 ){

4123 *
piMöLevñ
 = 
iMö
;

4124 *
piMaxLevñ
 = 
iMîge
;

4125 *
piAge
 = 
iAge
;

4126 
	`btRódSumm¨y
(
aSum
, 
iAge
+1, &
iMö
, &
nLevñ
, &
iMîge
);

4127 *
piOutLevñ
 = (
iMö
 + 
nLevñ
 - 1);

4128 
rc
 = 
SQLITE4_OK
;

4132 if–
nLevñ
>
nBe°
 ){

4133 
iBe°Age
 = 
iAge
;

4134 
nBe°
 = 
nLevñ
;

4139 if–
rc
==
SQLITE4_NOTFOUND
 && 
iBe°Age
>=0 ){

4140 
u8
 *
aNew
;

4141 
nByã
 = 
nSum
;

4142 if–
iBe°Age
+1>=(
nSum
/6ËË
nByã
 += 6;

4144 
rc
 = 
SQLITE4_OK
;

4145 
aNew
 = (
u8
*)
	`btMÆloc
(
db
, 
nByã
, &
rc
);

4146 if–
rc
==
SQLITE4_OK
 ){

4149 
	`mem˝y
(
aNew
, 
aSum
, 
nSum
);

4150 if–
nByã
>
nSum
 ) 
	`btWrôeSumm¨y
(
aNew
, 
iBe°Age
+1, 0, 0, 0);

4153 
	`btRódSumm¨y
(
aSum
, 
iBe°Age
, &
iMö
, &
nLevñ
, &
iMîge
);

4154 *
piMöLevñ
 = (
u32
)
iMö
;

4155 *
piMaxLevñ
 = (
u32
)(
iMö
 + 
nLevñ
 - 1);

4156 *
piAge
 = 
iBe°Age
;

4159 
	`btRódSumm¨y
(
aNew
, 
iBe°Age
+1, &
iMö
, &
nLevñ
, &
iMîge
);

4160 *
piOutLevñ
 = 
iMö
 + 
nLevñ
;

4165 
	`btC§Re£t
(&
c§
, 1);

4166  
rc
;

4167 
	}
}

4179 
	$btI¡egøãMîge
(
bt_db
 *
db
, 
BtScheduÀ
 *
p
){

4180 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

4181 c⁄° 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

4182 
rc
 = 
SQLITE4_OK
;

4183 
BtCurs‹
 
c§
;

4184 
BtCurs‹
 
mc§
;

4185 c⁄° *
pKey
 = 0;

4186 
nKey
 = 0;

4187 c⁄° 
u8
 *
aSum
; 
nSum
;

4188 
sqlôe4_buf„r
 
buf
;

4189 
u32
 
iLvl
;

4190 
iBlk
;

4195 c⁄° 
bFa°In£πOp
 = 
db
->bFastInsertOp;

4196 
db
->
bFa°In£πOp
 = 0;

4199 
nCÆl
 = 0;ÇCall++;

4200 
	`Ârötf
(
°dîr
, "BEFORE %d\n", 
nCÆl
);

4201 
	`btPrötMëaTªe
(
db
->
pPagî
, 1, 
pHdr
);

4203 
	`as£π_summ¨y_ok
(
db
, 
SQLITE4_OK
);

4205 
	`mem£t
(&
c§
, 0, (csr));

4206 
	`mem£t
(&
mc§
, 0, (mcsr));

4207 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, &
mc§
);

4208 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

4210 if–
p
->
iNextPg
 ){

4211 
	`btC§Sëup
(
db
, 
p
->
iNextPg
, &
c§
);

4212 
rc
 = 
	`btC§End
(&
c§
, 0);

4213 if–
rc
==
SQLITE4_OK
 ){

4214 
c§
.
aiCñl
[0] = 
p
->
iNextCñl
;

4215 
rc
 = 
	`btC§Key
(&
c§
, &
pKey
, &
nKey
);

4219 if–
p
->
iFªeLi°
 ){

4220 
u32
 
iTrunk
 = 
p
->
iFªeLi°
;

4221 
BtCurs‹
 
dñc§
;

4222 
	`mem£t
(&
dñc§
, 0, (
BtCurs‹
));

4223 
dñc§
.
nPg
 = 1;

4224 
dñc§
.
ba£
.
pDb
 = 
db
;

4226  
rc
==
SQLITE4_OK
 && 
iTrunk
!=0 ){

4227 
BtPage
 *
pTrunk
 = 0;

4228 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
iTrunk
, &
pTrunk
);

4229 if–
rc
==
SQLITE4_OK
 ){

4230 
u8
 *
aTD©a
 = 
	`btPageD©a
(
pTrunk
);

4231 
nOvÊ
 = 
	`btGëU32
(
aTD©a
);

4232 
i
;

4234 
i
=0; i<
nOvÊ
; i++){

4235 
u32
 
Õgno
 = 
	`btGëU32
(&
aTD©a
[8 + 
i
*8]);

4236 
dñc§
.
aiCñl
[0] = ()
	`btGëU32
(&
aTD©a
[8 + 
i
*8 + 4]);

4237 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
Õgno
, &
dñc§
.
≠Page
[0]);

4238 if–
rc
==
SQLITE4_OK
 ){

4239 
rc
 = 
	`btOvîÊowDñëe
(&
dñc§
);

4240 
	`sqlôe4BtPageRñó£
(
dñc§
.
≠Page
[0]);

4244 
iTrunk
 = 
	`btGëU32
(&
aTD©a
[4]);

4245 
	`sqlôe4BtPageRñó£
(
pTrunk
);

4254 
iLvl
=
p
->
iMöLevñ
; iLvl<ı->
iMaxLevñ
; iLvl++){

4255 
u8
 
aPªfix
[8];

4256 
u32
 
iRoŸ
 = 0;

4259 
	`btPutU32
(&
aPªfix
[0], 
p
->
iAge
);

4260 
	`btPutU32
(&
aPªfix
[4], ~
iLvl
);

4261 
rc
 = 
	`btC§Sìk
(&
mc§
, 0, 
aPªfix
, ◊Pªfix), 
BT_SEEK_GE
, 0);

4262 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

4270  
rc
==
SQLITE4_OK
 ){

4271 c⁄° 
u8
 *
pMKey
; 
nMKey
;

4272 
rc
 = 
	`btC§Key
(&
mc§
, (c⁄° **)&
pMKey
, &
nMKey
);

4274 if–
rc
==
SQLITE4_OK
 ){

4275 if–
nMKey
<(
aPªfix
Ë|| 
	`memcmp
◊Pªfix, 
pMKey
, (aPrefix)) ){

4276 
rc
 = 
SQLITE4_NOTFOUND
;

4278 
rc
 = 
SQLITE4_OK
;

4281 if–
rc
==
SQLITE4_OK
 ){

4282 if–
pKey
 ){

4283 
ªs
 = 
	`btKeyCom∑ª
(
pMKey
 + 8, 
nMKey
 - 8, 
pKey
, 
nKey
);

4284 if–
ªs
>0 ){

4288 if–
iRoŸ
 ){

4289 
rc
 = 
	`sqlôe4BtBlockTrim
(
db
->
pPagî
, 1 + (
iRoŸ
 / 
nPgPîBlk
));

4293 if–
rc
==
SQLITE4_OK
 ){

4294 c⁄° *
pD©a
; 
nD©a
;

4295 
	`btC§D©a
(&
mc§
, 0, 4, &
pD©a
, &
nD©a
);

4296 
iRoŸ
 = 
	`btGëU32
(
pD©a
);

4297 
rc
 = 
	`sqlôe4BtDñëe
(&
mc§
.
ba£
);

4300 if–
rc
==
SQLITE4_OK
 ){

4302 
rc
 = 
	`btC§Sìk
(&
mc§
, 0, 
aPªfix
, ◊Pªfix), 
BT_SEEK_GE
, 0);

4303 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

4306 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

4308 if–
rc
==
SQLITE4_OK
 && 
iRoŸ
 ){

4309 if–
pKey
 ){

4310 
n
 = (
aPªfix
Ë+ 
nKey
;

4311 
rc
 = 
	`sqlôe4_buf„r_ªsize
(&
buf
, 
n
);

4312 if–
rc
==
SQLITE4_OK
 ){

4313 
u8
 
aD©a
[4];

4314 
u8
 *
a
 = (u8*)
buf
.
p
;

4315 
	`mem˝y
(
a
, 
aPªfix
, (aPrefix));

4316 
	`mem˝y
(&
a
[(
aPªfix
)], 
pKey
, 
nKey
);

4317 
	`btPutU32
(
aD©a
, 
iRoŸ
);

4318 
rc
 = 
	`btRïœ˚E¡ry
(
db
, 
pHdr
->
iMRoŸ
, 
a
, 
n
, 
aD©a
, (aData));

4321 
rc
 = 
	`sqlôe4BtBlockTrim
(
db
->
pPagî
, 1 + (
iRoŸ
 / 
nPgPîBlk
));

4327 
iBlk
=0;

4328 
rc
==
SQLITE4_OK
 && 
iBlk
<
	`¨øy_size
(
p
->
aRoŸ
) &&Ö->aRoot[iBlk];

4329 
iBlk
++

4331 
	`btC§Re£t
(&
c§
, 1);

4332 
	`btC§Sëup
(
db
, 
p
->
aRoŸ
[
iBlk
], &
c§
);

4333 
rc
 = 
	`btC§End
(&
c§
, 0);

4334 if–
rc
==
SQLITE4_OK
 ){

4335 
rc
 = 
	`btC§Key
(&
c§
, &
pKey
, &
nKey
);

4337 if–
rc
==
SQLITE4_OK
 ){

4338 
rc
 = 
	`sqlôe4_buf„r_ªsize
(&
buf
, 
nKey
+8);

4340 if–
rc
==
SQLITE4_OK
 ){

4341 
u8
 
aD©a
[4];

4342 
u8
 *
a
 = (u8*)
buf
.
p
;

4343 
	`btPutU32
(
a
, 
p
->
iAge
+1);

4344 
	`btPutU32
(&
a
[4], ~
p
->
iOutLevñ
);

4345 
	`mem˝y
(&
a
[8], 
pKey
, 
nKey
);

4346 
	`btPutU32
(
aD©a
, 
p
->
aRoŸ
[
iBlk
]);

4347 
rc
 = 
	`btRïœ˚E¡ry
(
db
, 
pHdr
->
iMRoŸ
, 
a
, 
nKey
+8, 
aD©a
, (aData));

4352  
rc
==
SQLITE4_OK
 && 
iBlk
<
	`¨øy_size
(
p
->
aBlock
) &&Ö->aBlock[iBlk] ){

4353 
rc
 = 
	`sqlôe4BtBlockTrim
(
db
->
pPagî
, 
p
->
aBlock
[
iBlk
]);

4354 
iBlk
++;

4358 if–
rc
==
SQLITE4_OK
 ){

4359 
	`btC§Re£t
(&
c§
, 1);

4360 
rc
 = 
	`fiLﬂdSumm¨y
(
db
, &
c§
, &
aSum
, &
nSum
);

4362 if–
rc
==
SQLITE4_OK
 ){

4363 
rc
 = 
	`sqlôe4_buf„r_ªsize
(&
buf
, 
	`MAX
(
nSum
, (
p
->
iAge
+1+1)*6));

4364 if–
rc
==
SQLITE4_OK
 ){

4365 
u16
 
iMöLevñ
 = 0;

4366 
u16
 
nLevñ
 = 0;

4367 
u16
 
iMîgeLevñ
 = 0;

4369 
	`mem˝y
(
buf
.
p
, 
aSum
, 
nSum
);

4370 if–
nSum
>(6*(
p
->
iAge
+1)) ){

4371 
	`btRódSumm¨y
(
aSum
, 
p
->
iAge
+1, &
iMöLevñ
, &
nLevñ
, &
iMîgeLevñ
);

4373 if–(
iMöLevñ
+
nLevñ
)>=
p
->
iOutLevñ
 ){

4374 
nLevñ
 = 
p
->
iOutLevñ
 - 
iMöLevñ
 + 1;

4375 
	`btWrôeSumm¨y
((
u8
*)
buf
.
p
,Ö->
iAge
+1, 
iMöLevñ
, 
nLevñ
, 
iMîgeLevñ
);

4378 
	`btRódSumm¨y
(
aSum
, 
p
->
iAge
, &
iMöLevñ
, &
nLevñ
, &
iMîgeLevñ
);

4379 if–
p
->
iNextPg
==0 ){

4380 
u16
 
nNewLevñ
 = 
nLevñ
 - (1 + 
p
->
iMaxLevñ
 -Ö->
iMöLevñ
);

4381 
iMöLevñ
 = (
nNewLevñ
==0 ? 0 : 
p
->
iMaxLevñ
+1);

4382 
	`btWrôeSumm¨y
((
u8
*)
buf
.
p
,Ö->
iAge
, 
iMöLevñ
, 
nNewLevñ
, 0);

4384 
	`btWrôeSumm¨y
((
u8
*)
buf
.
p
,Ö->
iAge
, 
iMöLevñ
, 
nLevñ
,Ö->
iMaxLevñ
);

4387 
rc
 = 
	`btRïœ˚E¡ry
(

4388 
db
, 
pHdr
->
iMRoŸ
, 
aSumm¨yKey
, ◊Summ¨yKey), 
buf
.
p
, buf.
n


4393 
	`btC§Re£t
(&
c§
, 1);

4394 
	`btC§Re£t
(&
mc§
, 1);

4395 
	`sqlôe4_buf„r_˛ór
(&
buf
);

4398 if–
rc
==
SQLITE4_OK
 ){

4399 
	`btPrötMëaTªe
(
db
->
pPagî
, 1, 
pHdr
);

4400 
	`sqlôe4BtDebugFa°Tªe
(
db
, 
nCÆl
);

4403 
	`as£π_summ¨y_ok
(
db
, 
SQLITE4_OK
);

4404 
db
->
bFa°In£πOp
 = bFastInsertOp;

4405  
rc
;

4406 
	}
}

4416 
	$btScheduÀMîge
(
bt_db
 *
db
){

4417 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

4418 
BtPage
 *
pPg
 = 0;

4419 
u8
 *
aD©a
;

4420 
rc
;

4423 
u32
 
iAge
;

4424 
u32
 
iMö
;

4425 
u32
 
iMax
;

4426 
u32
 
iOutLvl
;

4429 if–
pHdr
->
iSRoŸ
==0 ){

4430 
rc
 = 
	`sqlôe4BtPageAŒoˇã
(
db
->
pPagî
, &
pPg
);

4431 if–
rc
==
SQLITE4_OK
 ){

4432 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

4433 
	`mem£t
(
aD©a
, 0, 
pHdr
->
pgsz
);

4434 
	`sqlôe4BtPagîDbhdrDúty
(
db
->
pPagî
);

4435 
pHdr
->
iSRoŸ
 = 
	`sqlôe4BtPagePgno
(
pPg
);

4438 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pHdr
->
iSRoŸ
, &
pPg
);

4444 if–
rc
==
SQLITE4_OK
 ){

4445 
aD©a
 = 
	`btPageD©a
(
pPg
);

4447  
	`btGëU32
(
aD©a
) ){

4448 
BT_SCHEDULE_BUSY
:

4449 
rc
 = 
SQLITE4_NOTFOUND
;

4452 
BT_SCHEDULE_DONE
: {

4453 
BtScheduÀ
 
s
;

4454 
rc
 = 
	`btRódScheduÀ
(
db
, 
aD©a
, &
s
);

4455 if–
rc
==
SQLITE4_OK
 ){

4456 
rc
 = 
	`btI¡egøãMîge
(
db
, &
s
);

4458 if–
rc
==
SQLITE4_OK
 ){

4459 
s
.
eBusy
 = 
BT_SCHEDULE_EMPTY
;

4460 
	`btWrôeScheduÀPage
(
pPg
, &
s
, &
rc
);

4469 if–
rc
==
SQLITE4_OK
 ){

4470 
rc
 = 
	`btFödMîge
(
db
, &
iAge
, &
iMö
, &
iMax
, &
iOutLvl
);

4474 if–
rc
==
SQLITE4_OK
 ){

4475 
BtScheduÀ
 
s
;

4476 
	`mem£t
(&
s
, 0, (
BtScheduÀ
));

4478 
s
.
eBusy
 = 
BT_SCHEDULE_BUSY
;

4479 
s
.
iAge
 = iAge;

4480 
s
.
iMaxLevñ
 = 
iMax
;

4481 
s
.
iMöLevñ
 = 
iMö
;

4482 
s
.
iOutLevñ
 = 
iOutLvl
;

4483 
rc
 = 
	`btAŒoˇãBlock
(
db
, db->
nScheduÀAŒoc
, 
s
.
aBlock
);

4485 
	`btWrôeScheduÀPage
(
pPg
, &
s
, &
rc
);

4488 
	`sqlôe4BtPageRñó£
(
pPg
);

4489 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

4490  
rc
;

4491 
	}
}

4493 
	$btFa°In£πRoŸ
(

4494 
bt_db
 *
db
,

4495 
BtDbHdr
 *
pHdr
,

4496 
u32
 *
piRoŸ


4498 
rc
 = 
SQLITE4_OK
;

4500 
	`as£π
–
db
->
bFa°In£πOp
 );

4501 
db
->
bFa°In£πOp
 = 0;

4504 if–
pHdr
->
iMRoŸ
==0 ){

4505 
	`sqlôe4BtPagîDbhdrDúty
(
db
->
pPagî
);

4506 
rc
 = 
	`btAŒoˇãNewRoŸ
(
db
, 
BT_PGFLAGS_METATREE
, &
pHdr
->
iMRoŸ
);

4510 if–
rc
==
SQLITE4_OK
 && 
pHdr
->
iSubBlock
==0 ){

4511 
u32
 
iLevñ
;

4512 
u32
 
iSubBlock
;

4514 
rc
 = 
	`btAŒoˇãNewLevñ
(
db
, 
pHdr
, &
iLevñ
);

4515 if–
rc
==
SQLITE4_OK
 ){

4516 
rc
 = 
	`btAŒoˇãBlock
(
db
, 1, &
iSubBlock
);

4519 if–
rc
==
SQLITE4_OK
 ){

4520 
u8
 
aKey
[8];

4521 
u8
 
aVÆ
[4];

4522 
	`sqlôe4BtPagîDbhdrDúty
(
db
->
pPagî
);

4523 
pHdr
->
iSubBlock
 = iSubBlock;

4524 
pHdr
->
nSubPg
 = 1;

4530 
	`btPutU32
(&
aKey
[0], 0);

4531 
	`btPutU32
(&
aKey
[4], ~
iLevñ
);

4532 
	`btPutU32
(&
aVÆ
[0], 
	`btFú°OfBlock
(
pHdr
, 
iSubBlock
));

4533 
rc
 = 
	`btRïœ˚E¡ry
(
db
, 
pHdr
->
iMRoŸ
, 
aKey
, 8, 
aVÆ
, 4);

4536 if–
rc
==
SQLITE4_OK
 ){

4537 
u32
 
iRoŸ
 = 
	`btFú°OfBlock
(
pHdr
,ÖHdr->
iSubBlock
);

4538 
BtPage
 *
pPg
 = 0;

4540 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
iRoŸ
, &
pPg
);

4541 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4BtPageWrôe
(
pPg
);

4542 if–
rc
==
SQLITE4_OK
 ){

4543 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

4544 
	`mem£t
(&
aD©a
[
pHdr
->
pgsz
-6], 0, 6);

4545 
aD©a
[0] = 0;

4547 
	`sqlôe4BtPageRñó£
(
pPg
);

4551 if–
rc
==
SQLITE4_OK
 ){

4552 *
piRoŸ
 = 
	`btFú°OfBlock
(
pHdr
,ÖHdr->
iSubBlock
);

4554 
db
->
bFa°In£πOp
 = 1;

4555  
rc
;

4556 
	}
}

4561 
	$fiSëupMîgeC§
(

4562 
bt_db
 *
db
,

4563 
BtDbHdr
 *
pHdr
,

4564 
BtScheduÀ
 *
p
,

4565 
FiCurs‹
 *
pC§


4567 
iSub
;

4568 
rc
;

4570 
	`mem£t
(
pC§
, 0, (
FiCurs‹
));

4571 
pC§
->
ba£
.
Êags
 = 
CSR_TYPE_FAST
 | 
CSR_NEXT_OK
 | 
CSR_VISIT_DEL
;

4572 
pC§
->
ba£
.
pDb
 = 
db
;

4573 
rc
 = 
	`fiC§AŒoˇãSubs
(
db
, 
pC§
, (
p
->
iMaxLevñ
 -Ö->
iMöLevñ
) + 1);

4574 
	`as£π
–
rc
==
SQLITE4_OK
 || 
pC§
->
nBt
==0 );

4577 
iSub
=0; iSub<
pC§
->
nBt
 && 
rc
==
SQLITE4_OK
; iSub++){

4578 
u32
 
iLvl
 = 
p
->
iMaxLevñ
 - 
iSub
;

4579 
FiSubCurs‹
 *
pSub
 = &
pC§
->
aSub
[
iSub
];

4580 
BtCurs‹
 *
pM
 = &
pSub
->
mc§
;

4581 c⁄° *
pKey
 = 0; 
nKey
 = 0;

4586 
	`fiF‹m©Pªfix
(
pSub
->
aPªfix
, 
p
->
iAge
, 
iLvl
);

4587 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, 
pM
);

4588 
rc
 = 
	`btC§Sìk
(
pM
, 0, 
pSub
->
aPªfix
, ’Sub->aPªfix), 
BT_SEEK_GE
, 0);

4590 if–
rc
==
SQLITE4_INEXACT
 ){

4591 c⁄° 
nPªfix
 = (
pSub
->
aPªfix
);

4592 
rc
 = 
	`btC§Key
(
pM
, &
pKey
, &
nKey
);

4593 if–
rc
==
SQLITE4_OK
 ){

4594 if–
nKey
<
nPªfix
 || 
	`memcmp
(
pKey
, 
pSub
->
aPªfix
,ÇPrefix) ){

4596 
	`btC§Re£t
(
pM
, 0);

4597 
rc
 = 
SQLITE4_NOTFOUND
;

4599 
nKey
 -
nPªfix
;

4600 
pKey
 = (c⁄° *)(((c⁄° 
u8
*ÌKeyË+ 
nPªfix
);

4607 if–
rc
==
SQLITE4_OK
 ){

4608 c⁄° *
pVÆ
 = 0; 
nVÆ
 = 0;

4609 
rc
 = 
	`btC§D©a
(
pM
, 0, 4, &
pVÆ
, &
nVÆ
);

4610 if–
rc
==
SQLITE4_OK
 ){

4611 
u32
 
iRoŸ
 = 
	`sqlôe4BtGëU32
((c⁄° 
u8
*)
pVÆ
);

4612 
	`btC§Sëup
(
db
, 
iRoŸ
, &
pSub
->
c§
);

4613 
rc
 = 
	`btC§Sìk
(&
pSub
->
c§
, 0, 
pKey
, 
nKey
, 
BT_SEEK_GE
, 0);

4614 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

4615 if–
rc
==
SQLITE4_NOTFOUND
 ){

4616 
rc
 = 
	`fiSubC§Sãp
(0, 
pSub
, 1);

4617 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

4620 }if–
rc
==
SQLITE4_NOTFOUND
 ){

4621 
	`as£π
–
pSub
->
c§
.
nPg
==0 );

4622 
	`as£π
–
pSub
->
mc§
.
nPg
==0 );

4623 
rc
 = 
SQLITE4_OK
;

4627 if–
rc
==
SQLITE4_OK
 ){

4628 
rc
 = 
	`fiC§SëCuºít
(
pC§
);

4631  
rc
;

4632 
	}
}

4637 
FiWrôî
 
	tFiWrôî
;

4638 
FiWrôîPg
 
	tFiWrôîPg
;

4639 
	sFiWrôîPg
 {

4640 
	mbAŒoˇãd
;

4641 
	mnCñl
;

4642 
	miFªe
;

4643 
u8
 *
	maBuf
;

4645 
	sFiWrôî
 {

4646 
bt_db
 *
	mdb
;

4647 
BtScheduÀ
 *
	mpSched
;

4648 
	mpgsz
;

4649 
	mnPgPîBlk
;

4650 
u32
 
	miBlk
;

4651 
	mnOvÊPîPage
;

4653 
	mnAŒoc
;

4654 
	mnWrôe
;

4655 
	mnHõr
;

4656 
FiWrôîPg
 
	maHõr
[
MAX_SUBTREE_DEPTH
];

4659 
	mnOvÊ
;

4660 
u8
 *
	maTrunk
;

4666 
	$fiWrôîFlush
(

4667 
FiWrôî
 *
p
,

4668 
FiWrôîPg
 *
pPg
,

4669 
u32
 *
pPgno


4671 
rc
;

4672 
u32
 
pgno
;

4674 
	`as£π
–
pPg
->
bAŒoˇãd
==1 );

4675 
	`as£π
–
p
->
iBlk
>1 );

4677 
pPg
->
bAŒoˇãd
 = 0;

4678 
pgno
 = (
p
->
nPgPîBlk
 * (p->
iBlk
-1Ë+ 1Ë+Ö->
nWrôe
;

4679 
p
->
nWrôe
++;

4680 
	`as£π
–
p
->
nWrôe
<ı->
nAŒoc
 );

4681 
	`as£π
–
p
->
nWrôe
<ı->
nPgPîBlk
 );

4682 
rc
 = 
	`sqlôe4BtPagîRawWrôe
(
p
->
db
->
pPagî
, 
pgno
, 
pPg
->
aBuf
);

4683 *
pPgno
 = 
pgno
;

4684  
rc
;

4685 
	}
}

4687 
	$fiWrôîFlushAŒ
(
FiWrôî
 *
p
){

4688 
i
;

4689 
rc
 = 
SQLITE4_OK
;

4690 
u32
 
pgno
 = 0;

4692 
i
=0; 
rc
==
SQLITE4_OK
 && i<
p
->
nHõr
; i++){

4693 
FiWrôîPg
 *
pPg
 = &
p
->
aHõr
[
i
];

4694 if–
i
!=0 ){

4695 
	`btPutU32
(&
pPg
->
aBuf
[1], 
pgno
);

4697 
rc
 = 
	`fiWrôîFlush
(
p
, 
pPg
, &
pgno
);

4699 
	`btFªeBuf„r
(
p
->
db
, 
pPg
->
aBuf
);

4700 
pPg
->
aBuf
 = 0;

4703 
i
=0; 
p
->
pSched
->
aBlock
[i]!ı->
iBlk
; i++);

4704 
	`as£π
–
p
->
pSched
->
aRoŸ
[
i
]==0 );

4705 
p
->
pSched
->
aRoŸ
[
i
] = 
pgno
;

4707  
rc
;

4708 
	}
}

4710 
	$fiWrôîCÀ™up
(
FiWrôî
 *
p
){

4711 
	}
}

4718 
	$fiWrôîAŒoc
(
FiWrôî
 *
p
, 
bLóf
, 
FiWrôîPg
 *
pPg
){

4719 
rc
 = 
SQLITE4_OK
;

4721 
	`as£π
–
pPg
->
bAŒoˇãd
==0 );

4722 
	`as£π
–
p
->
nAŒoc
<p->
nPgPîBlk
 );

4724 
pPg
->
bAŒoˇãd
 = 1;

4725 
p
->
nAŒoc
++;

4726 
pPg
->
nCñl
 = 0;

4728 if–
pPg
->
aBuf
==0 ){

4729 
rc
 = 
	`btNewBuf„r
(
p
->
db
, &
pPg
->
aBuf
);

4731 if–
rc
==
SQLITE4_OK
 ){

4732 if–
bLóf
 ){

4733 
pPg
->
iFªe
 = 1;

4734 
pPg
->
aBuf
[0] = 0x00;

4736 
pPg
->
iFªe
 = 5;

4737 
pPg
->
aBuf
[0] = 
BT_PGFLAGS_INTERNAL
;

4739 
	`btPutU16
(&
pPg
->
aBuf
[
p
->
pgsz
-2], 0);

4741  
rc
;

4742 
	}
}

4744 
	$fiWrôîPush
(
FiWrôî
 *
p
, c⁄° 
u8
 *
pKey
, 
nKey
){

4745 
rc
 = 
SQLITE4_OK
;

4746 
i
;

4747 
iIns
;

4748 
nByã
;

4749 
iOff
;

4750 
nMaxAŒoc
;

4751 
u32
 
pgno
;

4752 
FiWrôîPg
 *
pPg
;

4754 
nByã
 = 2 + 
	`sqlôe4BtV¨ötLí32
(
nKey
) +ÇKey + 4;

4756 
nMaxAŒoc
 = 
	`MIN
((
p
->
nPgPîBlk
 -Ö->
nAŒoc
), 
MAX_SUBTREE_DEPTH
);

4757 
iIns
=1; iIns<
p
->
nHõr
; iIns++){

4760 
nFªe
;

4761 
pPg
 = &
p
->
aHõr
[
iIns
];

4762 
nFªe
 = 
p
->
pgsz
 - (
pPg
->
iFªe
 + 6 +ÖPg->
nCñl
*2);

4763 if–
nFªe
>=
nByã
 ) ;

4766 if–(
iIns
 + (iIns==
p
->
nHõr
))>=
nMaxAŒoc
 ){

4767 
rc
 = 
BT_BLOCKFULL
;

4769 if–
rc
==
SQLITE4_OK
 && 
iIns
==
p
->
nHõr
 ){

4770 
p
->
nHõr
 = 
iIns
+1;

4771 
rc
 = 
	`fiWrôîAŒoc
(
p
, 0, &p->
aHõr
[
iIns
]);

4774 
i
=0; 
rc
==
SQLITE4_OK
 && i<
iIns
; i++){

4775 
pPg
 = &
p
->
aHõr
[
i
];

4776 if–
i
!=0 ){

4777 
	`btPutU32
(&
pPg
->
aBuf
[1], 
pgno
);

4779 
rc
 = 
	`fiWrôîFlush
(
p
, 
pPg
, &
pgno
);

4780 if–
rc
==
SQLITE4_OK
 ){

4781 
rc
 = 
	`fiWrôîAŒoc
(
p
, (
i
==0), 
pPg
);

4786 if–
rc
==
SQLITE4_OK
 ){

4787 
pPg
 = &
p
->
aHõr
[
iIns
];

4788 
iOff
 = 
pPg
->
iFªe
;

4789 
	`btPutU16
(
	`btCñlPåFöd
(
pPg
->
aBuf
, 
p
->
pgsz
,ÖPg->
nCñl
), (
u16
)
iOff
);

4790 
pPg
->
nCñl
++;

4791 
	`btPutU16
(&
pPg
->
aBuf
[
p
->
pgsz
-2],ÖPg->
nCñl
);

4792 
iOff
 +
	`sqlôe4BtV¨ötPut32
(&
pPg
->
aBuf
[iOff], 
nKey
);

4793 
	`mem˝y
(&
pPg
->
aBuf
[
iOff
], 
pKey
, 
nKey
);

4794 
iOff
 +
nKey
;

4795 
	`btPutU32
(&
pPg
->
aBuf
[
iOff
], 
pgno
);

4796 
iOff
 += 4;

4797 
pPg
->
iFªe
 = 
iOff
;

4800  
rc
;

4801 
	}
}

4808 
	$fiWrôîInô
(

4809 
bt_db
 *
db
,

4810 
BtScheduÀ
 *
pSched
,

4811 
FiWrôî
 *
p
,

4812 *
pRc


4814 if–*
pRc
==
SQLITE4_OK
 ){

4815 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

4816 
i
;

4818 
	`mem£t
(
p
, 0, (
FiWrôî
));

4819 
p
->
db
 = db;

4820 
p
->
pSched
 =ÖSched;

4821 
p
->
pgsz
 = 
pHdr
->pgsz;

4822 
p
->
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

4823 
p
->
nOvÊPîPage
 = ((
pHdr
->
pgsz
 / 8) - 1);

4826 
i
=0; 
pSched
->
aBlock
[i]; i++){

4827 if–
pSched
->
aRoŸ
[
i
]==0 ) ;

4829 if–
pSched
->
aBlock
[
i
]==0 ){

4830 *
pRc
 = 
BT_BLOCKFULL
;

4832 
p
->
iBlk
 = 
pSched
->
aBlock
[
i
];

4835 
	}
}

4837 
	$fiWrôîFlushOvÊ
(
FiWrôî
 *
p
, 
u32
 *
pPgno
){

4838 
u32
 
pgno
;

4839 
rc
;

4842 
	`btPutU32
(
p
->
aTrunk
,Ö->
nOvÊ
);

4845 
pgno
 = (
p
->
nPgPîBlk
 * (p->
iBlk
-1Ë+ 1Ë+Ö->
nWrôe
;

4846 
p
->
nWrôe
++;

4847 
p
->
nAŒoc
++;

4848 
rc
 = 
	`sqlôe4BtPagîRawWrôe
(
p
->
db
->
pPagî
, 
pgno
,Ö->
aTrunk
);

4850 
	`btPutU32
(&
p
->
aTrunk
[4], 
pgno
);

4851 if–
pPgno
 ) *pPgnÿ
pgno
;

4852 
p
->
nOvÊ
 = 0;

4854  
rc
;

4855 
	}
}

4858 
	$fiWrôîFªeOvîÊow
(
FiWrôî
 *
p
, 
FiCurs‹
 *
pC§
){

4859 c⁄° *
pKey
;

4860 
nKey
;

4861 
rc
;

4862 
i
;

4864 
rc
 = 
	`btC§Key
(&
pC§
->
aSub
[pC§->
iBt
].
c§
, &
pKey
, &
nKey
);

4865 
i
=
pC§
->
iBt
+1; i<pC§->
nBt
 && 
rc
==
SQLITE4_OK
; i++){

4866 
BtCurs‹
 *
pSub
 = &
pC§
->
aSub
[
i
].
c§
;

4867 if–
pSub
->
nPg
 ){

4868 c⁄° *
pSKey
;

4869 
nSKey
;

4870 
rc
 = 
	`btC§Key
(
pSub
, &
pSKey
, &
nSKey
);

4871 if–
rc
==
SQLITE4_OK


4872 && 0==
	`btKeyCom∑ª
(
pKey
, 
nKey
, 
pSKey
, 
nSKey
)

4873 && 
	`btC§OvîÊow
(
pSub
)

4875 
u32
 
pgno
 = 
	`sqlôe4BtPagePgno
(
pSub
->
≠Page
[pSub->
nPg
-1]);

4876 
iCñl
 = 
pSub
->
aiCñl
[pSub->
nPg
-1];

4878 if–
p
->
aTrunk
==0 ){

4879 
	`as£π
–
p
->
nOvÊ
==0 );

4880 
rc
 = 
	`btNewBuf„r
(
p
->
db
, &p->
aTrunk
);

4881 if–
rc
==
SQLITE4_OK
 ) 
	`mem£t
(
p
->
aTrunk
, 0, 8);

4882 }if–
p
->
nOvÊPîPage
=ı->
nOvÊ
 ){

4883 
rc
 = 
	`fiWrôîFlushOvÊ
(
p
, 0);

4884 
	`as£π
–
p
->
nOvÊ
==0 );

4886 if–
rc
==
SQLITE4_OK
 ){

4887 
	`as£π
–
p
->
nOvÊ
<p->
nOvÊPîPage
 );

4888 
	`btPutU32
(&
p
->
aTrunk
[8 +Ö->
nOvÊ
*8], 
pgno
);

4889 
	`btPutU32
(&
p
->
aTrunk
[8 +Ö->
nOvÊ
*8 + 4], 
iCñl
);

4890 
p
->
nOvÊ
++;

4896  
rc
;

4897 
	}
}

4904 c⁄° 
u8
 *
	$btKeyPªfixFromCñl
(c⁄° 
u8
 *
aBuf
, *
≤Key
){

4905 
u8
 *
p
 = (u8*)
aBuf
;

4906 
nKey
;

4908 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

4909 if–
nKey
==0 ){

4910 
p
 +
	`sqlôe4BtV¨ötGë32
’, &
nKey
);

4913 *
≤Key
 = 
nKey
;

4914  
p
;

4915 
	}
}

4922 
	$btPªfixLígth
(

4923 
pgsz
,

4924 c⁄° 
u8
 *
pOld
, 
nOld
,

4925 c⁄° 
u8
 *
pNew
, 
nNew


4927 
nPªfix
;

4928 
nCmp
 = 
	`MIN
(
nOld
, 
nNew
);

4929 
nPªfix
=0;ÇPªfix<
nCmp
 && 
pOld
[nPªfix]==
pNew
[nPrefix];ÇPrefix++);

4930 if–
nPªfix
>=(
pgsz
/4) )  0;

4931 
	`as£π
–
nPªfix
<
nNew
 );

4932  
nPªfix
+1;

4933 
	}
}

4935 
	$fiWrôîAdd
(
FiWrôî
 *
p
, c⁄° *
pCñl
, 
nCñl
){

4936 
rc
 = 
SQLITE4_OK
;

4937 
FiWrôîPg
 *
pPg
;

4938 
nReq
;

4939 
nFªe
;

4941 if–
p
->
nHõr
==0 ){

4942 
	`as£π
–
p
->
aHõr
[0].
nCñl
==0 );

4943 
	`as£π
–
p
->
aHõr
[0].
iFªe
==0 );

4944 
p
->
nHõr
++;

4945 
rc
 = 
	`fiWrôîAŒoc
(
p
, 1, &p->
aHõr
[0]);

4946 
	`as£π
–
rc
!=
BT_BLOCKFULL
 );

4948 
pPg
 = &
p
->
aHõr
[0];

4952 
nReq
 = 
nCñl
 + 2;

4953 
nFªe
 = 
p
->
pgsz
 - 
pPg
->
iFªe
 - (6 + 2*pPg->
nCñl
);

4955 if–
nReq
>
nFªe
 ){

4958 c⁄° 
u8
 *
pOld
; 
nOld
;

4959 c⁄° 
u8
 *
pNew
; 
nNew
;

4960 
nPªfix
;

4962 
pOld
 = 
	`btCñlFöd
(
pPg
->
aBuf
, 
p
->
pgsz
, 
	`btCñlCou¡
(pPg->aBuf,Ö->pgsz)-1);

4963 
pOld
 = 
	`btKeyPªfixFromCñl
’Old, &
nOld
);

4964 
pNew
 = 
	`btKeyPªfixFromCñl
(
pCñl
, &
nNew
);

4968 
nPªfix
 = 
	`btPªfixLígth
(
p
->
pgsz
, 
pOld
, 
nOld
, 
pNew
, 
nNew
);

4969 
rc
 = 
	`fiWrôîPush
(
p
, 
pNew
, 
nPªfix
);

4973 if–
rc
==
SQLITE4_OK
 ){

4974 
	`mem˝y
(&
pPg
->
aBuf
[pPg->
iFªe
], 
pCñl
, 
nCñl
);

4975 
	`btPutU16
(
	`btCñlPåFöd
(
pPg
->
aBuf
, 
p
->
pgsz
,ÖPg->
nCñl
),ÖPg->
iFªe
);

4976 
pPg
->
nCñl
++;

4977 
	`btPutU16
(&
pPg
->
aBuf
[
p
->
pgsz
-2],ÖPg->
nCñl
);

4978 
pPg
->
iFªe
 +
nCñl
;

4981  
rc
;

4982 
	}
}

4987 
	$sqlôe4BtMîge
(
bt_db
 *
db
, 
BtDbHdr
 *
pHdr
, 
u8
 *
aSched
){

4988 
BtScheduÀ
 
s
;

4989 
rc
 = 
SQLITE4_OK
;

4992 
	`btRódScheduÀ
(
db
, 
aSched
, &
s
);

4993 if–
s
.
eBusy
==
BT_SCHEDULE_BUSY
 ){

4994 
FiCurs‹
 
fc§
;

4995 
FiWrôî
 
wrôî
;

4997 
rc
 = 
	`fiSëupMîgeC§
(
db
, 
pHdr
, &
s
, &
fc§
);

4998 
	`as£π
–
rc
!=
SQLITE4_NOTFOUND
 );

4999 
	`as£π_ficurs‹_ok
(&
fc§
, 
rc
);

5000 
	`fiWrôîInô
(
db
, &
s
, &
wrôî
, &
rc
);

5005  
rc
==
SQLITE4_OK
 ){

5006 c⁄° *
pCñl
;

5007 
nCñl
;

5010 
	`fiC§Cñl
(&
fc§
, &
pCñl
, &
nCñl
);

5011 
rc
 = 
	`fiWrôîAdd
(&
wrôî
, 
pCñl
, 
nCñl
);

5012 if–
rc
==
BT_BLOCKFULL
 ){

5013 
nOvÊSaved
 = 
wrôî
.
nOvÊ
;

5014 
u8
 *
aTrunkSaved
 = 
wrôî
.
aTrunk
;

5015 
rc
 = 
	`fiWrôîFlushAŒ
(&
wrôî
);

5016 
	`fiWrôîInô
(
db
, &
s
, &
wrôî
, &
rc
);

5017 
wrôî
.
nOvÊ
 = 
nOvÊSaved
;

5018 
wrôî
.
aTrunk
 = 
aTrunkSaved
;

5019 }if–
rc
==
SQLITE4_OK
 ){

5020 
rc
 = 
	`fiWrôîFªeOvîÊow
(&
wrôî
, &
fc§
);

5021 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`fiC§Sãp
(&
fc§
);

5028 if–
rc
==
BT_BLOCKFULL
 ||Ñc==
SQLITE4_NOTFOUND
 ){

5030 if–
rc
==
SQLITE4_NOTFOUND
 ){

5031 
	`as£π
–
fc§
.
iBt
<0 );

5032 
s
.
iNextPg
 = 0;

5033 
s
.
iNextCñl
 = 0;

5035 
BtCurs‹
 *
pC§
 = &
fc§
.
aSub
[fc§.
iBt
].
c§
;

5036 
	`as£π
–
pC§
->
nPg
>0 );

5037 
s
.
iNextPg
 = 
	`sqlôe4BtPagePgno
(
pC§
->
≠Page
[pC§->
nPg
-1]);

5038 
s
.
iNextCñl
 = 
pC§
->
aiCñl
[pC§->
nPg
-1];

5040 
s
.
iFªeLi°
 = 0;

5041 
s
.
eBusy
 = 
BT_SCHEDULE_DONE
;

5043 
	`as£π
–
s
.
iFªeLi°
==0 );

5044 
rc
 = 
SQLITE4_OK
;

5045 if–
wrôî
.
aTrunk
 ){

5046 
rc
 = 
	`fiWrôîFlushOvÊ
(&
wrôî
, &
s
.
iFªeLi°
);

5048 if–
rc
==
SQLITE4_OK
 ){

5049 
rc
 = 
	`fiWrôîFlushAŒ
(&
wrôî
);

5051 if–
rc
==
SQLITE4_OK
 ){

5052 
	`btWrôeScheduÀ
(
aSched
, &
s
, &
rc
);

5056 
	`fiWrôîCÀ™up
(&
wrôî
);

5057 
	`fiC§Re£t
(&
fc§
);

5059  
rc
;

5060 
	}
}

5068 
	$sqlôe4BtRïœ˚
(
bt_db
 *
db
, c⁄° *
pK
, 
nK
, c⁄° *
pV
, 
nV
){

5069 
rc
 = 
SQLITE4_OK
;

5072 
	`sqlôe4BtDebugKV
((
BtLock
*)
db
->
pPagî
, "ª∂a˚", (
u8
*)
pK
, 
nK
, (u8*)
pV
, 
nV
);

5075 
rc
 = 
	`btSaveAŒCurs‹
(
db
, 0);

5076 
	`as£π
–
rc
!=
SQLITE4_NOTFOUND
 &&Ñc!=
SQLITE4_INEXACT
 );

5077 
	`btCheckPageRefs
(
db
);

5082 if–
rc
==
SQLITE4_OK
 ){

5083 
u32
 
iRoŸ
 = 0;

5084 if–!
db
->
bFa°In£πOp
 ){

5085 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5086 
iRoŸ
 = 
pHdr
->iRoot;

5088 if–
rc
==
SQLITE4_OK
 ){

5089 
rc
 = 
	`btRïœ˚E¡ry
(
db
, 
iRoŸ
, 
pK
, 
nK
, 
pV
, 
nV
);

5093 
	`btCheckPageRefs
(
db
);

5094 
db
->
bFa°In£πOp
 = 0;

5095  
rc
;

5096 
	}
}

5098 #i‚de‡
NDEBUG


5099 
	$sqlôe4BtDebugTªe
(
bt_db
 *
db
, 
iCÆl
, 
u32
 
iRoŸ
){

5100 
BtPage
 *
pPg
;

5101 
sqlôe4_buf„r
 
buf
;

5102 
pgsz
;

5104 
pgsz
 = 
	`sqlôe4BtPagîPagesize
(
db
->
pPagî
);

5105 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

5106 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
iRoŸ
, &
pPg
);

5107 
	`btPageToAscii
(
iRoŸ
, 1, 
db
->
pPagî
, 
	`btPageD©a
(
pPg
), 
pgsz
, &
buf
);

5108 
	`Ârötf
(
°dîr
, "%d TREEáà%d:\n", 
iCÆl
, ()
iRoŸ
);

5109 
	`Ârötf
(
°dîr
, "%.*s", 
buf
.
n
, (*)buf.
p
);

5110 
	`sqlôe4_buf„r_˛ór
(&
buf
);

5111 
	`sqlôe4BtPageRñó£
(
pPg
);

5112 
	}
}

5114 
	$sqlôe4BtDebugFa°Tªe
(
bt_db
 *
db
, 
iCÆl
){

5115 
BtDbHdr
 *
pHdr
;

5116 
BtCurs‹
 
mc§
;

5117 
rc
;

5119 
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5120 
	`btC§Sëup
(
db
, 
pHdr
->
iMRoŸ
, &
mc§
);

5121 
rc
=
	`btC§End
(&
mc§
, 0);Ñc==
SQLITE4_OK
;Ñc=
	`btC§Sãp
(&mcsr, 1)){

5122 
u32
 
iSubRoŸ
;

5123 c⁄° *
pK
; 
nK
;

5124 
rc
 = 
	`btC§Key
(&
mc§
, &
pK
, &
nK
);

5125 if–
rc
!=
SQLITE4_OK
 ) ;

5126 if–
nK
==(
aSumm¨yKey
Ë&& 0==
	`memcmp
◊Summ¨yKey, 
pK
,ÇK) ) ;

5127 
rc
 = 
	`btC§D©a
(&
mc§
, 0, 4, &
pK
, &
nK
);

5128 if–
rc
!=
SQLITE4_OK
 ) ;

5130 
iSubRoŸ
 = 
	`btGëU32
((c⁄° 
u8
*)
pK
);

5131 
	`sqlôe4BtDebugTªe
(
db
, 
iCÆl
, 
iSubRoŸ
);

5133 
	`btC§Re£t
(&
mc§
, 1);

5134 
	}
}

5141 
	$sqlôe4BtDñëe
(
bt_curs‹
 *
pBa£
){

5142 
bt_db
 *
db
 = 
pBa£
->
pDb
;

5143 
rc
;

5145 if–
	`IsBtC§
(
pBa£
) ){

5146 
BtCurs‹
 *
pC§
 = (BtCurs‹*)
pBa£
;

5148 
rc
 = 
	`btC§Re£ek
(
pC§
);

5149 if–
rc
==
SQLITE4_OK
 ){

5150 
rc
 = 
	`btSaveAŒCurs‹
(
db
, 
pC§
);

5152 if–
rc
==
SQLITE4_OK
 ){

5153 
rc
 = 
	`btOvîÊowDñëe
(
pC§
);

5155 if–
rc
==
SQLITE4_OK
 ){

5156 
rc
 = 
	`btDñëeFromPage
(
pC§
, 1);

5158 if–
rc
==
SQLITE4_OK
 ){

5159 
rc
 = 
	`btBÆ™˚IfUndîfuŒ
(
pC§
);

5162 
	`btC§Rñó£AŒ
(
pC§
);

5164 
FiCurs‹
 *
pC§
 = (FiCurs‹*)
pBa£
;

5165 
BtCurs‹
 *
pSub
 = &
pC§
->
aSub
[pC§->
iBt
].
c§
;

5167 *
pKey
;

5168 
nKey
;

5170 
rc
 = 
	`btC§Buf„r
(
pSub
, 0);

5171 
pKey
 = 
pSub
->
ovÊ
.
buf
.
p
;

5172 
nKey
 = 
pSub
->
ovÊ
.nKey;

5174 if–
rc
==
SQLITE4_OK
 ){

5175 
bFa°In£πOp
 = 
db
->bFastInsertOp;

5176 
db
->
bFa°In£πOp
 = 1;

5177 
rc
 = 
	`sqlôe4BtRïœ˚
(
db
, 
pKey
, 
nKey
, 0, -1);

5178 
db
->
bFa°In£πOp
 = bFastInsertOp;

5182  
rc
;

5183 
	}
}

5185 
	$sqlôe4BtSëCookõ
(
bt_db
 *
db
, 
iVÆ
){

5186  
	`sqlôe4BtPagîSëCookõ
(
db
->
pPagî
, 
iVÆ
);

5187 
	}
}

5189 
	$sqlôe4BtGëCookõ
(
bt_db
 *
db
, *
piVÆ
){

5190  
	`sqlôe4BtPagîGëCookõ
(
db
->
pPagî
, 
piVÆ
);

5191 
	}
}

5193 
	$btC⁄åﬁTønß˘i⁄
(
bt_db
 *
db
, *
piCtx
){

5194 
rc
 = 
SQLITE4_OK
;

5195 
iTøns
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
db
);

5197 if–
iTøns
==0 ){

5198 
rc
 = 
	`sqlôe4BtBegö
(
db
, 1);

5200 *
piCtx
 = 
iTøns
;

5201  
rc
;

5202 
	}
}

5204 
	$btC⁄åﬁTønß˘i⁄D⁄e
(
bt_db
 *
db
, 
iCtx
){

5205 if–
iCtx
==0 ) 
	`sqlôe4BtCommô
(
db
, 0);

5206 
	}
}

5208 
btCheckF‹PageLóks
(
bt_db
*, 
sqlôe4_buf„r
*);

5210 
	$btC⁄åﬁInfo
(
bt_db
 *
db
, 
bt_öfo
 *
pInfo
){

5211 
rc
 = 
SQLITE4_OK
;

5213  
pInfo
->
eTy≥
 ){

5214 
BT_INFO_PAGEDUMP_ASCII
:

5215 
BT_INFO_PAGEDUMP
: {

5216 
iCtx
;

5217 
rc
 = 
	`btC⁄åﬁTønß˘i⁄
(
db
, &
iCtx
);

5218 if–
rc
==
SQLITE4_OK
 ){

5219 
BtPage
 *
pPg
 = 0;

5220 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pInfo
->
pgno
, &
pPg
);

5221 if–
rc
==
SQLITE4_OK
 ){

5222 
BtPagî
 *
p
 = 
db
->
pPagî
;

5223 
bAscii
 = (
pInfo
->
eTy≥
==
BT_INFO_PAGEDUMP_ASCII
);

5224 
u8
 *
aD©a
;

5225 
nD©a
;

5226 
aD©a
 = 
	`btPageD©a
(
pPg
);

5227 
nD©a
 = 
	`sqlôe4BtPagîPagesize
(
p
);

5228 
	`btPageToAscii
(
pInfo
->
pgno
, 
bAscii
, 
p
, 
aD©a
, 
nD©a
, &pInfo->
ouçut
);

5229 
	`sqlôe4_buf„r_≠≥nd
(&
pInfo
->
ouçut
, "", 1);

5230 
	`sqlôe4BtPageRñó£
(
pPg
);

5232 
	`btC⁄åﬁTønß˘i⁄D⁄e
(
db
, 
iCtx
);

5237 
BT_INFO_FILENAME
: {

5238 c⁄° *
zFûe
;

5239 
zFûe
 = 
	`sqlôe4BtPagîFûíame
(
db
->
pPagî
, 
BT_PAGERFILE_DATABASE
);

5240 
rc
 = 
	`sqlôe4_buf„r_£t
(&
pInfo
->
ouçut
, 
zFûe
, 
	`°æí
(zFile)+1);

5244 
BT_INFO_HDRDUMP
: {

5245 
iCtx
;

5246 
rc
 = 
	`btC⁄åﬁTønß˘i⁄
(
db
, &
iCtx
);

5247 if–
rc
==
SQLITE4_OK
 ){

5248 
rc
 = 
	`sqlôe4BtPagîHdrdump
(
db
->
pPagî
, &
pInfo
->
ouçut
);

5249 
	`btC⁄åﬁTønß˘i⁄D⁄e
(
db
, 
iCtx
);

5254 
BT_INFO_BLOCK_FREELIST
:

5255 
BT_INFO_PAGE_FREELIST
: {

5256 
iCtx
;

5257 
rc
 = 
	`btC⁄åﬁTønß˘i⁄
(
db
, &
iCtx
);

5258 if–
rc
==
SQLITE4_OK
 ){

5259 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5260 
u32
 
iFú°
 = (

5261 
pInfo
->
eTy≥
==
BT_INFO_BLOCK_FREELIST
?
pHdr
->
iFªeBlk
:pHdr->
iFªePg


5263 
rc
 = 
	`btFªñi°ToAscii
(
db
, 
iFú°
, &
pInfo
->
ouçut
);

5264 
	`btC⁄åﬁTønß˘i⁄D⁄e
(
db
, 
iCtx
);

5269 
BT_INFO_PAGE_LEAKS
: {

5270 
iCtx
;

5271 
rc
 = 
	`btC⁄åﬁTønß˘i⁄
(
db
, &
iCtx
);

5272 if–
rc
==
SQLITE4_OK
 ){

5273 
rc
 = 
	`btCheckF‹PageLóks
(
db
, &
pInfo
->
ouçut
);

5274 
	`btC⁄åﬁTønß˘i⁄D⁄e
(
db
, 
iCtx
);

5280 
rc
 = 
SQLITE4_ERROR
;

5284 
	`sqlôe4_buf„r_≠≥nd
(&
pInfo
->
ouçut
, "\0", 1);

5285  
rc
;

5286 
	}
}

5288 
	$sqlôe4BtC⁄åﬁ
(
bt_db
 *
db
, 
›
, *
pArg
){

5289 
rc
 = 
SQLITE4_OK
;

5291  
›
 ){

5292 
BT_CONTROL_INFO
: {

5293 
bt_öfo
 *
pInfo
 = (bt_öfo*)
pArg
;

5294 
rc
 = 
	`btC⁄åﬁInfo
(
db
, 
pInfo
);

5298 
BT_CONTROL_GETVFS
: {

5299 *((
bt_ív
**)
pArg
Ë
	`sqlôe4BtPagîGëEnv
(
db
->
pPagî
);

5303 
BT_CONTROL_SETVFS
: {

5304 
	`sqlôe4BtPagîSëEnv
(
db
->
pPagî
, (
bt_ív
*)
pArg
);

5308 
BT_CONTROL_SAFETY
: {

5309 *
pI¡
 = (*)
pArg
;

5310 
	`sqlôe4BtPagîSëSa„ty
(
db
->
pPagî
, 
pI¡
);

5314 
BT_CONTROL_AUTOCKPT
: {

5315 *
pI¡
 = (*)
pArg
;

5316 
	`sqlôe4BtPagîSëAutock±
(
db
->
pPagî
, 
pI¡
);

5320 
BT_CONTROL_LOGSIZE
: {

5321 *
pI¡
 = (*)
pArg
;

5322 
	`sqlôe4BtPagîLogsize
(
db
->
pPagî
, 
pI¡
);

5326 
BT_CONTROL_MULTIPROC
: {

5327 *
pI¡
 = (*)
pArg
;

5328 
	`sqlôe4BtPagîMu…ùroc
(
db
->
pPagî
, 
pI¡
);

5332 
BT_CONTROL_LOGSIZECB
: {

5333 
bt_logsizecb
 *
p
 = (bt_logsizecb*)
pArg
;

5334 
	`sqlôe4BtPagîLogsizeCb
(
db
->
pPagî
, 
p
);

5338 
BT_CONTROL_CHECKPOINT
: {

5339 
bt_checkpoöt
 *
p
 = (bt_checkpoöt*)
pArg
;

5340 
rc
 = 
	`sqlôe4BtPagîCheckpoöt
(
db
->
pPagî
, 
p
);

5344 
BT_CONTROL_FAST_INSERT_OP
: {

5345 
db
->
bFa°In£πOp
 = 1;

5349 
BT_CONTROL_BLKSZ
: {

5350 *
pI¡
 = (*)
pArg
;

5351 ((
BtLock
*)
db
->
pPagî
)->
nBlksz
 = *
pI¡
;

5355 
BT_CONTROL_PAGESZ
: {

5356 *
pI¡
 = (*)
pArg
;

5357 if–
	`sqlôe4BtPagîFûíame
(
db
->
pPagî
, 
BT_PAGERFILE_DATABASE
) ){

5358 
iCtx
;

5359 
rc
 = 
	`btC⁄åﬁTønß˘i⁄
(
db
, &
iCtx
);

5360 if–
rc
==
SQLITE4_OK
 ){

5361 *
pI¡
 = ()(
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
)->
pgsz
);

5362 
	`btC⁄åﬁTønß˘i⁄D⁄e
(
db
, 
iCtx
);

5365 
BtLock
 *
pLock
 = (BtLock*)
db
->
pPagî
;

5366 
nNew
 = *
pI¡
;

5367 if–((
nNew
-1)&nNew)==0 &&ÇNew>=512 &&ÇNew<=32768 ){

5368 
pLock
->
nPgsz
 = 
nNew
;

5370 *
pI¡
 = 
pLock
->
nPgsz
;

5377  
rc
;

5378 
	}
}

5380 
	$m¨kBlockAsU£d
(

5381 
bt_db
 *
db
,

5382 
u32
 
iBlk
,

5383 
u8
 *
aU£d


5385 if–
iBlk
 ){

5386 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5387 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

5388 
i
;

5390 
i
=0; i<
nPgPîBlk
; i++){

5391 
u32
 
iPg
 = (
iBlk
-1Ë* 
nPgPîBlk
 + 1 + 
i
;

5392 
	`as£π
–
aU£d
[
iPg
]==0 ||áUsed[iPg]==1 );

5393 
aU£d
[
iPg
] = 1;

5396 
	}
}

5402 
	$as£π_∑ges_u£d
(

5403 
bt_db
 *
db
,

5404 
u32
 
iRoŸ
,

5405 c⁄° *
pFú°
, 
nFú°
,

5406 *
pRc


5408 if–*
pRc
==
SQLITE4_OK
 && 
iRoŸ
 ){

5409 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5410 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

5411 
bMëa
 = (
iRoŸ
==
pHdr
->
iMRoŸ
);

5412 
BtLock
 *
pLock
 = (BtLock*)(
db
->
pPagî
);

5413 
u8
 *
aU£d
 = 
pLock
->aUsed;

5414 
rc
;

5415 
BtCurs‹
 
c§
;

5417 
	`btC§Sëup
(
db
, 
iRoŸ
, &
c§
);

5418 if–
nFú°
==0 ){

5419 
rc
 = 
	`btC§End
(&
c§
, 0);

5421 
pLock
->
aU£d
 = 0;

5422 
rc
 = 
	`btC§Sìk
(&
c§
, 0, 
pFú°
, 
nFú°
, 
BT_SEEK_GE
, 
BT_CSRSEEK_SEEK
);

5423 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

5424 
pLock
->
aU£d
 =áUsed;

5425 
c§
.
ovÊ
.
nKey
 = 0;

5428  
rc
==
SQLITE4_OK
 ){

5429 
rc
 = 
	`btC§Buf„r
(&
c§
, 1);

5430 if–
bMëa
 && 
rc
==
SQLITE4_OK
 ){

5431 
u8
 *
aKey
; 
nKey
;

5433 
	`btC§Key
(&
c§
, (c⁄° **)&
aKey
, &
nKey
);

5434 if–
nKey
!=(
aSumm¨yKey
Ë|| 
	`memcmp
(
aKey
,áSummaryKey,ÇKey) ){

5435 
u8
 *
aVÆ
; 
nVÆ
;

5436 
u32
 
iSubRoŸ
;

5437 
u32
 
iBlk
;

5438 
i
;

5439 
	`btC§D©a
(&
c§
, 0, 4, (c⁄° **)&
aVÆ
, &
nVÆ
);

5440 
iSubRoŸ
 = 
	`btGëU32
(
aVÆ
);

5441 
iBlk
 = (
iSubRoŸ
 / 
nPgPîBlk
) + 1;

5442 
	`as£π_∑ges_u£d
(
db
, 
iSubRoŸ
, &
aKey
[8], 
nKey
-8, &
rc
);

5443 
	`m¨kBlockAsU£d
(
db
, 
iBlk
, 
aU£d
);

5446 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`btC§Sãp
(&
c§
, 1);

5449 
	}
}

5451 
	$as£π_‰ìli°_∑ges_u£d
(

5452 
bt_db
 *
db
,

5453 
bBlockli°
,

5454 
u8
 *
aU£d
,

5455 *
pRc


5457 if–*
pRc
==
SQLITE4_OK
 ){

5458 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5459 
u32
 
iTrunk
 = (
bBlockli°
 ? 
pHdr
->
iFªeBlk
 :ÖHdr->
iFªePg
);

5460 
rc
 = 
SQLITE4_OK
;

5462  
rc
==
SQLITE4_OK
 && 
iTrunk
 ){

5463 
BtPage
 *
pPg
 = 0;

5464 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
iTrunk
, &
pPg
);

5465 if–
rc
==
SQLITE4_OK
 ){

5466 
i
;

5467 
u32
 
nFªe
;

5468 
u8
 *
aD©a
 = 
	`btPageD©a
(
pPg
);

5470 
nFªe
 = 
	`btGëU32
(
aD©a
);

5471 
i
=0; i<
nFªe
; i++){

5472 
u32
 
pgno
 = 
	`btGëU32
(&
aD©a
[8 + 
i
*4]);

5473 if–
bBlockli°
 ){

5474 
	`m¨kBlockAsU£d
(
db
, 
pgno
, 
aU£d
);

5476 
aU£d
[
pgno
]++;

5480 
iTrunk
 = 
	`btGëU32
(&
aD©a
[4]);

5481 
	`sqlôe4BtPageRñó£
(
pPg
);

5485 *
pRc
 = 
rc
;

5487 
	}
}

5489 
	$as£π_scheduÀ_∑ge_u£d
(
bt_db
 *
db
, 
u8
 *
aU£d
, *
pRc
){

5490 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5491 if–*
pRc
==
SQLITE4_OK
 && 
pHdr
->
iSRoŸ
!=0 ){

5492 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

5493 
BtPage
 *
pPg
 = 0;

5494 
rc
;

5496 
rc
 = 
	`sqlôe4BtPageGë
(
db
->
pPagî
, 
pHdr
->
iSRoŸ
, &
pPg
);

5497 if–
rc
==
SQLITE4_OK
 ){

5498 
BtScheduÀ
 
s
;

5499 
i
;

5501 
	`btRódScheduÀ
(
db
, 
	`btPageD©a
(
pPg
), &
s
);

5502 
	`sqlôe4BtPageRñó£
(
pPg
);

5504 
	`as£π
–
s
.
eBusy
!=
BT_SCHEDULE_BUSY
 || s.
aRoŸ
[0]==0 );

5505 if–
s
.
eBusy
!=
BT_SCHEDULE_EMPTY
 ){

5506 
i
=0; 
rc
==
SQLITE4_OK
 && i<
	`¨øy_size
(
s
.
aBlock
); i++){

5507 
	`m¨kBlockAsU£d
(
db
, 
s
.
aBlock
[
i
], 
aU£d
);

5512 *
pRc
 = 
rc
;

5514 
	}
}

5521 
	$btCheckF‹PageLóks
(

5522 
bt_db
 *
db
,

5523 
sqlôe4_buf„r
 *
pBuf


5525 
BtLock
 *
pLock
 = (BtLock*)(
db
->
pPagî
);

5527 
nCÆl
 = 0;

5528 
nCÆl
++;

5530 if–
pLock
->
aU£d
==0 ){

5531 
rc
;

5532 
iCtx
;

5533 
rc
 = 
	`btC⁄åﬁTønß˘i⁄
(
db
, &
iCtx
);

5535 if–
rc
==
SQLITE4_OK
 ){

5536 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtPagîDbhdr
(
db
->
pPagî
);

5537 
u8
 *
aU£d
;

5538 
i
;

5540 
aU£d
 = 
	`btMÆloc
(
db
, 
pHdr
->
nPg
, &
rc
);

5541 if–
aU£d
 ) 
	`mem£t
◊U£d, 0, 
pHdr
->
nPg
);

5542 
aU£d
[0] = 1;

5543 
pLock
->
aU£d
 = &aUsed[-1];

5546 
	`as£π_scheduÀ_∑ge_u£d
(
db
, 
pLock
->
aU£d
, &
rc
);

5549 
	`as£π_∑ges_u£d
(
db
, 
pHdr
->
iRoŸ
, 0, 0, &
rc
);

5552 
	`as£π_∑ges_u£d
(
db
, 
pHdr
->
iMRoŸ
, 0, 0, &
rc
);

5555 
	`as£π_‰ìli°_∑ges_u£d
(
db
, 0, 
pLock
->
aU£d
, &
rc
);

5558 
	`as£π_‰ìli°_∑ges_u£d
(
db
, 1, 
pLock
->
aU£d
, &
rc
);

5560 
i
=0; i<
pHdr
->
nPg
; i++){

5561 if–
aU£d
[
i
]!=1 ){

5562 
	`sqlôe4BtBufAµídf
(

5563 
pBuf
, "ªfcou¡ o¿∑gê%d i†%d\n", 
i
+1, ()
aU£d
[i]

5567 
	`btFªe
(
db
, 
aU£d
);

5568 
	`btC⁄åﬁTønß˘i⁄D⁄e
(
db
, 
iCtx
);

5569 
pLock
->
aU£d
 = 0;

5573  
SQLITE4_OK
;

5574 
	}
}

	@src/bt_pager.c

14 
	~"btI¡.h
"

16 
	~<°rög.h
>

17 
	~<as£π.h
>

18 
	~<°dio.h
>

22 
	#BT_DEFAULT_AUTOCKPT
 1000

	)

24 
	#BT_DEFAULT_SAFETY
 
BT_SAFETY_NORMAL


	)

26 
	#BT_DEFAULT_MULTIPROC
 1

	)

28 
BtPageHash
 
	tBtPageHash
;

30 
BtSavïoöt
 
	tBtSavïoöt
;

31 
BtSavïage
 
	tBtSavïage
;

42 
	sBtPageHash
 {

43 
	mnE¡ry
;

44 
	mnHash
;

45 
BtPage
 **
	maHash
;

52 
	sBtSavïoöt
 {

53 
	miLevñ
;

54 
BtSavïage
 *
	mpSavïage
;

55 
BtDbHdr
 
	mhdr
;

58 
	sBtSavïage
 {

59 
BtPage
 *
	mpPg
;

60 
u8
 *
	maD©a
;

61 
BtSavïage
 *
	mpNext
;

62 
	miSavïoöt
;

63 
BtSavïage
 *
	mpNextSavïage
;

70 
	sBtPage
 {

71 
u8
 *
	maD©a
;

72 
BtPagî
 *
	mpPagî
;

73 
u32
 
	mpgno
;

74 
	mnRef
;

75 
	mÊags
;

76 
BtPage
 *
	mpNextHash
;

77 
BtPage
 *
	mpNextDúty
;

78 
BtPage
 *
	mpNextLru
;

79 
BtPage
 *
	mpPªvLru
;

80 
BtSavïage
 *
	mpSavïage
;

86 
	#BT_PAGE_DIRTY
 0x0001

	)

93 
	sBtPagî
 {

94 
BtLock
 
	mbé
;

95 
BtLog
 *
	mpLog
;

96 
	miTønß˘i⁄Levñ
;

97 *
	mzFûe
;

98 
	mnFûe
;

99 
BtPageHash
 
	mhash
;

100 
BtPage
 *
	mpDúty
;

101 
BtPage
 *
	mpLru
;

102 
BtPage
 *
	mpLruTaû
;

103 
	mnPageAŒoc
;

104 
	mnPageLimô
;

105 
	mnTŸÆRef
;

106 
	mbDoAutoCk±
;

107 
BtSavïoöt
 *
	maSavïoöt
;

108 
	mnSavïoöt
;

109 
BtDbHdr
 *
	mpHdr
;

110 
	mbDútyHdr
;

111 *
	mpLogsizeCtx
;

112 (*
	mxLogsize
)(*, );

124 
	$hashkey
(
nHash
, 
u32
 
pgno
){

125  (
pgno
 % 
nHash
);

126 
	}
}

131 
	$btHashAdd
(
BtPagî
 *
p
, 
BtPage
 *
pPg
){

132 
h
;

135 if–
p
->
hash
.
nE¡ry
>ı->hash.
nHash
/2 ){

136 
i
;

137 
nNew
 = (
p
->
hash
.
nHash
 ?Ö->hash.nHash*2 : 256);

138 
BtPage
 **
aNew
;

139 
BtPage
 **
aOld
 = 
p
->
hash
.
aHash
;

141 
aNew
 = (
BtPage
 **)
	`sqlôe4_mÆloc
(
p
->
bé
.
pEnv
, 
nNew
*(BtPage*));

142 if–
aNew
==0 )  
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

143 
	`mem£t
(
aNew
, 0, 
nNew
*(
BtPage
*));

144 
i
=0; i<
p
->
hash
.
nHash
; i++){

145  
aOld
[
i
] ){

146 
BtPage
 *
pShi·
 = 
aOld
[
i
];

147 
aOld
[
i
] = 
pShi·
->
pNextHash
;

148 
h
 = 
	`hashkey
(
nNew
, 
pShi·
->
pgno
);

149 
pShi·
->
pNextHash
 = 
aNew
[
h
];

150 
aNew
[
h
] = 
pShi·
;

153 
p
->
hash
.
aHash
 = 
aNew
;

154 
p
->
hash
.
nHash
 = 
nNew
;

155 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
aOld
);

159 
	`as£π
–
pPg
->
pNextHash
==0 );

160 
h
 = 
	`hashkey
(
p
->
hash
.
nHash
, 
pPg
->
pgno
);

161 
pPg
->
pNextHash
 = 
p
->
hash
.
aHash
[
h
];

162 
p
->
hash
.
aHash
[
h
] = 
pPg
;

163 
p
->
hash
.
nE¡ry
++;

165  
SQLITE4_OK
;

166 
	}
}

171 
	$btHashRemove
(
BtPagî
 *
p
, 
BtPage
 *
pPg
){

172 
BtPage
 **
µ
;

173 
h
 = 
	`hashkey
(
p
->
hash
.
nHash
, 
pPg
->
pgno
);

174 
µ
=&
p
->
hash
.
aHash
[
h
]; *µ!=
pPg
;Ö∞&((*µ)->
pNextHash
));

175 *
µ
 = 
pPg
->
pNextHash
;

176 
p
->
hash
.
nE¡ry
--;

177 
	}
}

183 
BtPage
 *
	$btHashSórch
(
BtPagî
 *
p
, 
u32
 
pgno
){

184 
BtPage
 *
pRë
 = 0;

185 if–
p
->
hash
.
nHash
 ){

186 
h
 = 
	`hashkey
(
p
->
hash
.
nHash
, 
pgno
);

187 
pRë
=
p
->
hash
.
aHash
[
h
];ÖRë &&ÖRë->
pgno
!ıgno;ÖRëıRë->
pNextHash
);

189  
pRë
;

190 
	}
}

196 
	$btHashCÀ¨
(
BtPagî
 *
p
){

197 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
,Ö->
hash
.
aHash
);

198 
	`mem£t
(&
p
->
hash
, 0, (
BtPageHash
));

199 
	}
}

201 #i‚de‡
NDEBUG


202 
btHashIãøã
(

203 
BtPagî
 *
p
,

204 (*
xCÆl
)(*, 
BtPage
*),

205 *
pCtx


207 
i
;

208 
i
=0; i<
p
->
hash
.
nHash
; i++){

209 
BtPage
 *
pPg
;

210 
pPg
=
p
->
hash
.
aHash
[
i
];ÖPg;ÖPgıPg->
pNextHash
){

211 
	`xCÆl
(
pCtx
, 
pPg
);

214 
	}
}

220 
	$btLruAdd
(
BtPagî
 *
pPagî
, 
BtPage
 *
pPg
){

221 
	`as£π
–
pPg
->
pPªvLru
==0 );

222 
	`as£π
–
pPg
->
pNextLru
==0 );

223 if–
pPagî
->
pLru
 ){

224 
pPagî
->
pLruTaû
->
pNextLru
 = 
pPg
;

225 
pPg
->
pPªvLru
 = 
pPagî
->
pLruTaû
;

226 
pPagî
->
pLruTaû
 = 
pPg
;

228 
pPagî
->
pLru
 = 
pPg
;

229 
pPagî
->
pLruTaû
 = 
pPg
;

231 
	}
}

237 
	$btLruRemove
(
BtPagî
 *
pPagî
, 
BtPage
 *
pPg
){

238 
	`as£π
–(
pPg
==
pPagî
->
pLru
)==’Pg->
pPªvLru
==0) );

239 
	`as£π
–(
pPg
==
pPagî
->
pLruTaû
)==’Pg->
pNextLru
==0) );

241 if–
pPg
->
pNextLru
 ){

242 
pPg
->
pNextLru
->
pPªvLru
 =ÖPg->pPrevLru;

244 
pPagî
->
pLruTaû
 = 
pPg
->
pPªvLru
;

246 if–
pPg
->
pPªvLru
 ){

247 
pPg
->
pPªvLru
->
pNextLru
 =ÖPg->pNextLru;

249 
pPagî
->
pLru
 = 
pPg
->
pNextLru
;

252 
pPg
->
pNextLru
 = 0;

253 
pPg
->
pPªvLru
 = 0;

254 
	}
}

259 
	$sqlôe4BtPagîNew
(
sqlôe4_ív
 *
pEnv
, 
nExåa
, 
BtPagî
 **
µ
){

260 
BtPagî
 *
p
;

261 
nByã
;

263 
nByã
 = (
BtPagî
Ë+ 
nExåa
;

264 
p
 = (
BtPagî
*)
	`sqlôe4_mÆloc
(
pEnv
, 
nByã
);

265 if–!
p
 )  
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

266 
	`mem£t
(
p
, 0, 
nByã
);

268 
p
->
bé
.
pEnv
 =ÖEnv;

269 
p
->
bé
.
pVfs
 = 
	`sqlôe4BtEnvDeÁu…
();

270 
p
->
bé
.
iSa„tyLevñ
 = 
BT_DEFAULT_SAFETY
;

271 
p
->
bé
.
nAutoCk±
 = 
BT_DEFAULT_AUTOCKPT
;

272 
p
->
bé
.
bReque°Mu…iProc
 = 
BT_DEFAULT_MULTIPROC
;

273 
p
->
bé
.
nBlksz
 = 
BT_DEFAULT_BLKSZ
;

274 
p
->
bé
.
nPgsz
 = 
BT_DEFAULT_PGSZ
;

275 
p
->
nPageLimô
 = 
BT_DEFAULT_CACHESZ
;

276 *
µ
 = 
p
;

277  
SQLITE4_OK
;

278 
	}
}

280 
	$btFªePage
(
BtPagî
 *
p
, 
BtPage
 *
pPg
){

281 if–
pPg
 ){

282 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
pPg
->
aD©a
);

283 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
pPg
);

285 
	}
}

287 
	$btPurgeCache
(
BtPagî
 *
p
){

288 
i
;

289 
	`as£π
–
p
->
iTønß˘i⁄Levñ
==0 );

290 
	`as£π
–
p
->
nTŸÆRef
==0 );

292 
i
=0; i<
p
->
hash
.
nHash
; i++){

293 
BtPage
 *
pPg
;

294 
BtPage
 *
pNext
;

295 
pPg
=
p
->
hash
.
aHash
[
i
];ÖPg;ÖPg=
pNext
){

296 
pNext
 = 
pPg
->
pNextHash
;

297 
	`btFªePage
(
p
, 
pPg
);

300 
	`btHashCÀ¨
(
p
);

302 
p
->
pLruTaû
 = 0;

303 
p
->
pLru
 = 0;

304 
	}
}

306 
	$btCheckpoöt
(
BtLock
 *
pLock
){

307 
BtPagî
 *
p
 = (BtPagî*)
pLock
;

308 if–
p
->
pLog
==0 )  
SQLITE4_BUSY
;

309  
	`sqlôe4BtLogCheckpoöt
(
p
->
pLog
, 0);

310 
	}
}

312 
	$btCÀ™up
(
BtLock
 *
pLock
){

313 
BtPagî
 *
p
 = (BtPagî*)
pLock
;

314 
rc
 = 
	`sqlôe4BtLogClo£
(
p
->
pLog
, 1);

315 
p
->
pLog
 = 0;

316  
rc
;

317 
	}
}

319 
	$btO≥nSavïoöts
(
BtPagî
 *
p
, 
iLevñ
){

320 
rc
 = 
SQLITE4_OK
;

321 
nReq
 = 
iLevñ
 - 2;

323 if–
nReq
>
p
->
nSavïoöt
 ){

324 
BtSavïoöt
 *
aNew
;

325 
nByã
 = (
nReq
 * (
BtSavïoöt
));

327 
aNew
 = 
	`sqlôe4_ªÆloc
(
p
->
bé
.
pEnv
,Ö->
aSavïoöt
, 
nByã
);

328 if–
aNew
 ){

329 
i
;

330 
i
=
p
->
nSavïoöt
; i<
nReq
; i++){

331 
aNew
[
i
].
pSavïage
 = 0;

332 
aNew
[
i
].
iLevñ
 = i+3;

333 
	`mem˝y
(&
aNew
[
i
].
hdr
, 
p
->
pHdr
, (
BtDbHdr
));

335 
p
->
aSavïoöt
 = 
aNew
;

336 
p
->
nSavïoöt
 = 
nReq
;

338 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

342  
rc
;

343 
	}
}

345 #i‚de‡
NDEBUG


346 
	$btDebugCheckSavïagesInOrdî
(
BtPage
 *
pPg
, 
iMax
){

347 
BtSavïage
 *
p
;

348 
i
 = 
iMax
;

349 
p
=
pPg
->
pSavïage
;Ö;Öı->
pNextSavïage
){

350 
	`as£π
–
p
->
iSavïoöt
<=
i
 );

351 
i
 = 
p
->
iSavïoöt
-1;

353 
	}
}

355 
	#btDebugCheckSavïagesInOrdî
(
a
,
b
)

	)

362 
	$btAddToSavïoöt
(
BtPagî
 *
p
, 
BtPage
 *
pPg
){

363 
rc
 = 
SQLITE4_OK
;

364 
BtSavïage
 *
pSavïage
;

365 
iLevñ
 = 
p
->
iTønß˘i⁄Levñ
;

369 
	`btDebugCheckSavïagesInOrdî
(
pPg
, 
iLevñ
);

371 if–
pPg
->
pSavïage
==0 ||ÖPg->pSavïage->
iSavïoöt
!=
iLevñ
 ){

374 
pSavïage
 = 
	`sqlôe4_mÆloc
(
p
->
bé
.
pEnv
, (
BtSavïage
));

375 if–
pSavïage
==0 ){

376 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

378 
	`mem£t
(
pSavïage
, 0, (
BtSavïage
));

382 if–
rc
==
SQLITE4_OK
 && (1 || (
pPg
->
Êags
 & 
BT_PAGE_DIRTY
)) ){

383 
pSavïage
->
aD©a
 = (
u8
*)
	`sqlôe4_mÆloc
(
p
->
bé
.
pEnv
,Ö->
pHdr
->
pgsz
);

384 if–
pSavïage
->
aD©a
==0 ){

385 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
pSavïage
);

386 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

388 
	`mem˝y
(
pSavïage
->
aD©a
, 
pPg
->aD©a, 
p
->
pHdr
->
pgsz
);

393 if–
rc
==
SQLITE4_OK
 ){

394 
pSavïage
->
pPg
 =ÖPg;

395 
pSavïage
->
iSavïoöt
 = 
iLevñ
;

397 
pSavïage
->
pNextSavïage
 = 
pPg
->pSavepage;

398 
pPg
->
pSavïage
 =ÖSavepage;

400 
	`as£π
–
p
->
aSavïoöt
[
iLevñ
-3].iLevel==iLevel );

401 
pSavïage
->
pNext
 = 
p
->
aSavïoöt
[
iLevñ
-3].pSavepage;

402 
p
->
aSavïoöt
[
iLevñ
-3].
pSavïage
 =ÖSavepage;

406  
rc
;

407 
	}
}

419 
	$btClo£Savïoöts
(

420 
BtPagî
 *
p
,

421 
iLevñ
,

422 
bRﬁlback


424 
nReq
 = 
	`MAX
(0, 
iLevñ
 - 2);

426 if–
nReq
<=
p
->
nSavïoöt
 ){

427 
i
;

428 
i
=
p
->
nSavïoöt
-1; i>=
nReq
; i--){

429 
BtSavïoöt
 *
pSavïoöt
 = &
p
->
aSavïoöt
[
i
];

430 
BtSavïage
 *
pSavïg
;

431 
BtSavïage
 *
pNext
;

435 if–
bRﬁlback
 ){

436 
	`mem˝y
(
p
->
pHdr
, &
pSavïoöt
->
hdr
, (
BtDbHdr
));

442 
pSavïg
=
pSavïoöt
->
pSavïage
;ÖSavïg;ÖSavïg=
pNext
){

443 
BtPage
 *
pPg
 = 
pSavïg
->pPg;

444 
pNext
 = 
pSavïg
->pNext;

446 
	`as£π
–
pSavïg
==
pPg
->
pSavïage
 );

447 
	`as£π
–
pSavïg
->
iSavïoöt
==
pSavïoöt
->
iLevñ
 );

450 if–
bRﬁlback
 ){

451 
	`mem˝y
(
pPg
->
aD©a
, 
pSavïg
->aD©a, 
p
->
pHdr
->
pgsz
);

453 
iNextSaved
 = (

454 
pSavïg
->
pNextSavïage
 ?ÖSavïg->pNextSavïage->
iSavïoöt
 : 2

456 if–
iLevñ
>
iNextSaved
 ){

457 
	`as£π
–
iLevñ
>=3 );

458 
	`as£π
–
p
->
aSavïoöt
[
iLevñ
-3].iLevel==iLevel );

459 
pSavïg
->
pNext
 = 
p
->
aSavïoöt
[
iLevñ
-3].
pSavïage
;

460 
pSavïg
->
iSavïoöt
 = 
iLevñ
;

461 
p
->
aSavïoöt
[
iLevñ
-3].
pSavïage
 = 
pSavïg
;

462 
pSavïg
 = 0;

466 if–
pSavïg
 ){

468 
pPg
->
pSavïage
 = 
pSavïg
->
pNextSavïage
;

471 
	`as£π
–
pSavïg
->
aD©a
 );

472 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
pSavïg
->
aD©a
);

473 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
pSavïg
);

477 
pSavïoöt
->
pSavïage
 = 0;

480 
p
->
nSavïoöt
 = 
nReq
;

483  
SQLITE4_OK
;

484 
	}
}

490 
	$sqlôe4BtPagîClo£
(
BtPagî
 *
p
){

491 
rc
;

493 if–
p
->
bé
.
pFd
 ){

494 
	`sqlôe4BtPagîRﬁlback
(
p
, 0);

497 
rc
 = 
	`sqlôe4BtLockDisc⁄√˘
((
BtLock
*)
p
, 
btCheckpoöt
, 
btCÀ™up
);

498 
p
->
iTønß˘i⁄Levñ
 = 0;

499 
	`btClo£Savïoöts
(
p
, 0, 0);

500 
	`btPurgeCache
(
p
);

501 
	`sqlôe4BtLogClo£
(
p
->
pLog
, 0);

502 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
,Ö->
zFûe
);

503 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
,Ö->
aSavïoöt
);

504 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
,Ö);

505  
rc
;

506 
	}
}

511 *
	$sqlôe4BtPagîExåa
(
BtPagî
 *
p
){

512  (*)&
p
[1];

513 
	}
}

519 
	$btRecovî
(
BtLock
 *
pLock
){

520 
BtPagî
 *
p
 = (BtPagî*)
pLock
;

521 
rc
;

522 
rc
 = 
	`sqlôe4BtLogO≥n
(
p
, 1, &p->
pLog
);

523  
rc
;

524 
	}
}

535 
	$sqlôe4BtPagîO≥n
(
BtPagî
 *
p
, c⁄° *
zFûíame
){

536 
rc
;

537 
sqlôe4_ív
 *
pEnv
 = 
p
->
bé
.pEnv;

538 
bt_ív
 *
pVfs
 = 
p
->
bé
.pVfs;

540 
	`as£π
–
p
->
bé
.
pFd
==0 &&Ö->
zFûe
==0 );

542 
rc
 = 
pVfs
->
	`xFuŒ∑th
(
pEnv
,ÖVfs, 
zFûíame
, &
p
->
zFûe
);

543 if–
rc
==
SQLITE4_OK
 ){

544 
p
->
nFûe
 = 
	`°æí
’->
zFûe
);

545 
rc
 = 
	`sqlôe4BtLockC⁄√˘
((
BtLock
*)
p
, 
btRecovî
);

546 if–
rc
==
SQLITE4_OK
 && 
p
->
pLog
==0 ){

547 
rc
 = 
	`sqlôe4BtLogO≥n
(
p
, 0, &p->
pLog
);

551 if–
rc
!=
SQLITE4_OK
 ){

552 
	`sqlôe4BtLockDisc⁄√˘
((
BtLock
*)
p
, 
btCheckpoöt
, 
btCÀ™up
);

553 
	`sqlôe4BtLogClo£
(
p
->
pLog
, 0);

554 
p
->
pLog
 = 0;

557  
rc
;

558 
	}
}

563 
	$btO≥nRódTønß˘i⁄
(
BtPagî
 *
p
){

564 
rc
;

566 
	`as£π
–
p
->
iTønß˘i⁄Levñ
==0 );

567 
	`as£π
–
p
->
bé
.
pFd
 );

568 
	`as£π
–
p
->
pHdr
==0 );

570 
rc
 = 
	`sqlôe4BtLogS«pshŸO≥n
(
p
->
pLog
);

572 if–
rc
==
SQLITE4_OK
 ){

575 
p
->
iTønß˘i⁄Levñ
 = 1;

576 
p
->
pHdr
 = 
	`sqlôe4BtLogDbhdr
’->
pLog
);

578  
rc
;

579 
	}
}

581 
	$btO≥nWrôeTønß˘i⁄
(
BtPagî
 *
p
){

582 
rc
;

583 
	`as£π
–
p
->
iTønß˘i⁄Levñ
==1 );

584 
	`as£π
–
p
->
bé
.
pFd
 );

586 
rc
 = 
	`sqlôe4BtLogS«pshŸWrôe
(
p
->
pLog
);

587  
rc
;

588 
	}
}

590 
	$btClo£RódTønß˘i⁄
(
BtPagî
 *
p
){

591 
rc
;

592 
	`as£π
–
p
->
iTønß˘i⁄Levñ
==0 );

594 
	`as£π
–
p
->
pHdr
 );

595 
p
->
pHdr
 = 0;

596 
rc
 = 
	`sqlôe4BtLogS«pshŸClo£
(
p
->
pLog
);

599 
	`as£π
–
p
->
pDúty
==0 );

602 if–
rc
==
SQLITE4_OK
 && 
p
->
bDoAutoCk±
 ){

603 
	`sqlôe4BtLogCheckpoöt
(
p
->
pLog
, (p->
bé
.
nAutoCk±
 / 2));

605 
p
->
bDoAutoCk±
 = 0;

607  
rc
;

608 
	}
}

610 
	$btPagîDbhdrFlush
(
BtPagî
 *
p
){

611 
rc
 = 
SQLITE4_OK
;

612 if–
p
->
bDútyHdr
 ){

613 
rc
 = 
	`sqlôe4BtLogDbhdrFlush
(
p
->
pLog
);

614 
p
->
bDútyHdr
 = 0;

616  
rc
;

617 
	}
}

622 
	$btCommôTønß˘i⁄
(
BtPagî
 *
p
){

623 
rc
 = 
SQLITE4_OK
;

624 
nLogsize
;

625 
BtPage
 *
pPg
;

626 
BtPage
 *
pNext
;

627 
	`as£π
–
p
->
iTønß˘i⁄Levñ
>=2 );

629 
rc
 = 
	`btPagîDbhdrFlush
(
p
);

630 
	`btClo£Savïoöts
(
p
, 2, 0);

632 
pPg
=
p
->
pDúty
; 
rc
==
SQLITE4_OK
 &&ÖPg;ÖPg=
pNext
){

633 
nPg
;

634 
pNext
 = 
pPg
->
pNextDúty
;

635 
nPg
 = ((
pNext
==0Ë? 
p
->
pHdr
->nPg : 0);

636 
rc
 = 
	`sqlôe4BtLogWrôe
(
p
->
pLog
, 
pPg
->
pgno
,ÖPg->
aD©a
, 
nPg
);

637 
pPg
->
Êags
 &~(
BT_PAGE_DIRTY
);

638 
pPg
->
pNextDúty
 = 0;

639 if–
pPg
->
nRef
==0 ) 
	`btLruAdd
(
p
,ÖPg);

641 
p
->
pDúty
 = 
pPg
;

642 
	`sqlôe4BtLogS«pshŸEndWrôe
(
p
->
pLog
);

644 
nLogsize
 = 
	`sqlôe4BtLogSize
(
p
->
pLog
);

646 if–
p
->
bé
.
nAutoCk±
 && 
nLogsize
>=p->btl.nAutoCkpt ){

647 
p
->
bDoAutoCk±
 = 1;

649 if–
p
->
xLogsize
 ){

650 
p
->
	`xLogsize
’->
pLogsizeCtx
, 
nLogsize
);

653  
rc
;

654 
	}
}

656 
	$btLﬂdPageD©a
(
BtPagî
 *
p
, 
BtPage
 *
pPg
){

657 
rc
;

663 
rc
 = 
	`sqlôe4BtLogRód
(
p
->
pLog
, 
pPg
->
pgno
,ÖPg->
aD©a
);

666 if–
rc
==
SQLITE4_NOTFOUND
 ){

667 
i64
 
iOff
 = (i64)
p
->
pHdr
->
pgsz
 * (i64)(
pPg
->
pgno
-1);

668 
rc
 = 
p
->
bé
.
pVfs
->
	`xRód
’->bé.
pFd
, 
iOff
, 
pPg
->
aD©a
,Ö->
pHdr
->
pgsz
);

671  
rc
;

672 
	}
}

674 
	$btAŒoˇãPage
(
BtPagî
 *
p
, 
BtPage
 **
µPg
){

675 
rc
 = 
SQLITE4_OK
;

676 
BtPage
 *
pRë
;

678 if–
p
->
hash
.
nE¡ry
>ı->
nPageLimô
 &&Ö->
pLru
 ){

679 
BtPage
 **
µ
;

680 
h
;

683 
pRë
 = 
p
->
pLru
;

684 
	`as£π
–(
pRë
->
pNextLru
==0)==’Rë==
p
->
pLruTaû
) );

685 
p
->
pLru
 = 
pRë
->
pNextLru
;

686 if–
p
->
pLru
==0 ){

687 
p
->
pLruTaû
 = 0;

689 
p
->
pLru
->
pPªvLru
 = 0;

693 
	`btHashRemove
(
p
, 
pRë
);

695 
	`as£π
–
pRë
->
pPªvLru
==0 );

696 
	`as£π
–
pRë
->
nRef
==0 );

697 
	`as£π
–
pRë
->
pSavïage
==0 );

698 
pRë
->
Êags
 = 0;

699 
pRë
->
pNextHash
 = 0;

700 
pRë
->
pNextDúty
 = 0;

701 
pRë
->
pNextLru
 = 0;

703 
u8
 *
aD©a
 = (u8*)
	`sqlôe4_mÆloc
(
p
->
bé
.
pEnv
,Ö->
pHdr
->
pgsz
);

704 
pRë
 = (
BtPage
*)
	`sqlôe4_mÆloc
(
p
->
bé
.
pEnv
, (BtPage));

706 if–
pRë
 && 
aD©a
 ){

707 
	`mem£t
(
pRë
, 0, (
BtPage
));

708 
pRë
->
aD©a
 =áData;

709 
pRë
->
pPagî
 = 
p
;

711 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
pRë
);

712 
	`sqlôe4_‰ì
(
p
->
bé
.
pEnv
, 
aD©a
);

713 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

714 
pRë
 = 0;

718 *
µPg
 = 
pRë
;

719  
rc
;

720 
	}
}

725 
	$btRﬁlbackTønß˘i⁄
(
BtPagî
 *
p
){

726 
rc
 = 
SQLITE4_OK
;

727 
BtPage
 *
pPg
;

728 
BtPage
 *
pNext
;

730 
	`as£π
–
p
->
iTønß˘i⁄Levñ
>=2 );

731 
	`btClo£Savïoöts
(
p
, 2, 0);

735 
pPg
=
p
->
pDúty
;ÖPg;ÖPg=
pNext
){

736 
pNext
 = 
pPg
->
pNextDúty
;

737 
pPg
->
Êags
 &~(
BT_PAGE_DIRTY
);

738 
pPg
->
pNextDúty
 = 0;

739 if–
pPg
->
nRef
==0 ){

740 
	`btHashRemove
(
p
, 
pPg
);

741 
	`btFªePage
(
p
, 
pPg
);

742 }if–
rc
==
SQLITE4_OK
 && (
pPg
->
pgno
<=
p
->
pHdr
->
nPg
) ){

743 
rc
 = 
	`btLﬂdPageD©a
(
p
, 
pPg
);

746 
p
->
pDúty
 = 0;

747 
	`sqlôe4BtLogRñﬂdDbHdr
(
p
->
pLog
);

749  
rc
;

750 
	}
}

756 
	$sqlôe4BtPagîBegö
(
BtPagî
 *
p
, 
iLevñ
){

757 
rc
 = 
SQLITE4_OK
;

758 
	`as£π
–
p
->
bé
.
pFd
 );

760 if–
p
->
iTønß˘i⁄Levñ
<
iLevñ
 ){

762 if–
p
->
iTønß˘i⁄Levñ
==0 ){

763 
rc
 = 
	`btO≥nRódTønß˘i⁄
(
p
);

767 if–
rc
==
SQLITE4_OK
 && 
p
->
iTønß˘i⁄Levñ
<2 && 
iLevñ
>=2 ){

768 
rc
 = 
	`btO≥nWrôeTønß˘i⁄
(
p
);

772 if–
rc
==
SQLITE4_OK
 ){

773 
rc
 = 
	`btO≥nSavïoöts
(
p
, 
iLevñ
);

777 if–
rc
==
SQLITE4_OK
 ){

778 
	`as£π
–
p
->
iTønß˘i⁄Levñ
>=1 && 
iLevñ
>=p->iTransactionLevel );

779 
p
->
iTønß˘i⁄Levñ
 = 
iLevñ
;

783  
rc
;

784 
	}
}

789 
	$sqlôe4BtPagîCommô
(
BtPagî
 *
p
, 
iLevñ
){

790 
rc
 = 
SQLITE4_OK
;

792 
	`as£π
–
p
->
bé
.
pFd
 );

793 if–
p
->
iTønß˘i⁄Levñ
>=
iLevñ
 ){

794 
	`btClo£Savïoöts
(
p
, 
iLevñ
, 0);

796 if–
p
->
iTønß˘i⁄Levñ
>=2 && 
iLevñ
<2 ){

798 
rc
 = 
	`btCommôTønß˘i⁄
(
p
);

800 
p
->
iTønß˘i⁄Levñ
 = 
iLevñ
;

802 if–
iLevñ
==0 ){

803 
rc2
 = 
	`btClo£RódTønß˘i⁄
(
p
);

804 if–
rc
==
SQLITE4_OK
 )Ñ¯
rc2
;

807  
rc
;

808 
	}
}

810 
	$sqlôe4BtPagîRawWrôe
(
BtPagî
 *
p
, 
u32
 
pgno
, 
u8
 *
aBuf
){

811 
pgsz
 = 
p
->
pHdr
->pgsz;

812 
i64
 
iOff
 = (i64)
pgsz
 * (i64)(
pgno
-1);

813  
p
->
bé
.
pVfs
->
	`xWrôe
’->bé.
pFd
, 
iOff
, 
aBuf
, 
pgsz
);

814 
	}
}

816 
	$sqlôe4BtPagîRﬁlback
(
BtPagî
 *
p
, 
iLevñ
){

817 
rc
 = 
SQLITE4_OK
;

819 
	`as£π
–
p
->
bé
.
pFd
 );

820 if–
p
->
iTønß˘i⁄Levñ
>=
iLevñ
 ){

825 if–
p
->
iTønß˘i⁄Levñ
>=2 ){

826 if–
iLevñ
<=2 ){

827 
rc
 = 
	`btRﬁlbackTønß˘i⁄
(
p
);

828 if–
iLevñ
<2 ) 
	`sqlôe4BtLogS«pshŸEndWrôe
(
p
->
pLog
);

830 
rc
 = 
	`btClo£Savïoöts
(
p
, 
iLevñ
-1, 1);

831 
p
->
nSavïoöt
++;

835 if–
p
->
iTønß˘i⁄Levñ
>
iLevñ
 ){

836 
p
->
iTønß˘i⁄Levñ
 = 
iLevñ
;

837 if–
iLevñ
==0 ){

838 
rc2
 = 
	`btClo£RódTønß˘i⁄
(
p
);

839 if–
rc
==
SQLITE4_OK
 )Ñ¯
rc2
;

844  
rc
;

845 
	}
}

847 
	$sqlôe4BtPagîRevît
(
BtPagî
 *
p
, 
iLevñ
){

848 
rc
;

849 
	`as£π
( 0 );

851 
	`as£π
–
p
->
bé
.
pFd
 );

852 
rc
 = 
	`sqlôe4BtPagîRﬁlback
(
p
, 
iLevñ
);

853 if–
rc
==
SQLITE4_OK
 && 
iLevñ
>=2 && 
p
->
iTønß˘i⁄Levñ
==iLevel ){

856  
rc
;

857 
	}
}

862 
	$sqlôe4BtPagîTønß˘i⁄Levñ
(
BtPagî
 *
p
){

863  
p
->
iTønß˘i⁄Levñ
;

864 
	}
}

869 
	$sqlôe4BtPagîPagesize
(
BtPagî
 *
p
){

871  ()
p
->
pHdr
->
pgsz
;

872 
	}
}

877 
BtDbHdr
 *
	$sqlôe4BtPagîDbhdr
(
BtPagî
 *
p
){

878  
p
->
pHdr
;

879 
	}
}

881 
	$sqlôe4BtPagîDbhdrDúty
(
BtPagî
 *
p
){

882 
p
->
bDútyHdr
 = 1;

883 
	}
}

885 
	$sqlôe4BtPagîSëDbhdr
(
BtPagî
 *
p
, 
BtDbHdr
 *
pHdr
){

886 
	`as£π
–
p
->
pHdr
==0 ||ÖHdr==0 );

887 
p
->
pHdr
 =ÖHdr;

888 
	}
}

893 
	$sqlôe4BtPageGë
(
BtPagî
 *
p
, 
u32
 
pgno
, 
BtPage
 **
µPg
){

894 
rc
 = 
SQLITE4_OK
;

895 
BtPage
 *
pRë
;

897 if–
p
->
bé
.
aU£d
 ){

898 
p
->
bé
.
aU£d
[
pgno
]++;

902 
pRë
 = 
	`btHashSórch
(
p
, 
pgno
);

905 if–
pRë
==0 ){

906 
rc
 = 
	`btAŒoˇãPage
(
p
, &
pRë
);

907 if–
rc
==
SQLITE4_OK
 ){

908 
pRë
->
pgno
 =Ögno;

909 if–
pgno
<=
p
->
pHdr
->
nPg
 ){

910 
rc
 = 
	`btLﬂdPageD©a
(
p
, 
pRë
);

912 
	`as£π
–
p
->
iTønß˘i⁄Levñ
>=2 );

913 
	`mem£t
(
pRë
->
aD©a
, 0, 
p
->
pHdr
->
pgsz
);

916 if–
rc
==
SQLITE4_OK
 ){

917 
rc
 = 
	`btHashAdd
(
p
, 
pRë
);

920 if–
rc
!=
SQLITE4_OK
 ){

921 
	`btFªePage
(
p
, 
pRë
);

922 
pRë
 = 0;

924 
	`sqlôe4BtDebugRódPage
(&
p
->
bé
, 
pgno
, 
pRë
->
aD©a
,Ö->
pHdr
->
pgsz
);

927 }if–
pRë
->
nRef
==0 && (pRë->
Êags
 & 
BT_PAGE_DIRTY
)==0 ){

928 
	`btLruRemove
(
p
, 
pRë
);

931 
	`as£π
–(
pRë
!=0)==(
rc
==
SQLITE4_OK
) );

932 if–
rc
==
SQLITE4_OK
 ){

933 
p
->
nTŸÆRef
++;

934 
pRë
->
nRef
++;

936 *
µPg
 = 
pRë
;

937  
rc
;

938 
	}
}

940 
	$sqlôe4BtPageWrôe
(
BtPage
 *
pPg
){

941 
rc
 = 
SQLITE4_OK
;

942 
BtPagî
 *
p
 = 
pPg
->
pPagî
;

945 if–
p
->
nSavïoöt
>0 ){

946 
rc
 = 
	`btAddToSavïoöt
(
p
, 
pPg
);

949 if–(
pPg
->
Êags
 & 
BT_PAGE_DIRTY
)==0 ){

950 
pPg
->
Êags
 |
BT_PAGE_DIRTY
;

951 
pPg
->
pNextDúty
 =ÖPg->
pPagî
->
pDúty
;

952 
pPg
->
pPagî
->
pDúty
 =ÖPg;

954  
rc
;

955 
	}
}

961 
	$btFªñi°Add
(

962 
BtPagî
 *
p
,

963 
bBlock
,

964 
u32
 
pgno


966 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtLogDbhdr
(
p
->
pLog
);

967 
rc
 = 
SQLITE4_OK
;

968 
bD⁄e
 = 0;

969 
u32
 *
piFú°
 = (
bBlock
 ? &
pHdr
->
iFªeBlk
 : &pHdr->
iFªePg
);

974 if–*
piFú°
 ){

975 
BtPage
 *
pTrunk
;

976 
rc
 = 
	`sqlôe4BtPageGë
(
p
, *
piFú°
, &
pTrunk
);

977 if–
rc
==
SQLITE4_OK
 ){

978 c⁄° 
nMax
 = ((
pHdr
->
pgsz
 - 8) / 4);

979 
u8
 *
aD©a
 = 
pTrunk
->aData;

980 
nFªe
 = ()
	`sqlôe4BtGëU32
(
aD©a
);

982 if–
nFªe
<
nMax
 ){

983 
rc
 = 
	`sqlôe4BtPageWrôe
(
pTrunk
);

984 if–
rc
==
SQLITE4_OK
 ){

985 
	`sqlôe4BtPutU32
(&
pTrunk
->
aD©a
[8 + 
nFªe
*4], 
pgno
);

986 
	`sqlôe4BtPutU32
(
pTrunk
->
aD©a
, 
nFªe
+1);

987 
bD⁄e
 = 1;

988 
	`sqlôe4BtDebugPageFªe
((
BtLock
*)
p
, 
bBlock
, "‰ì-li°-Àaf", 
pgno
);

991 
	`sqlôe4BtPageRñó£
(
pTrunk
);

997 if–
rc
==
SQLITE4_OK
 && 
bD⁄e
==0 ){

998 
BtPage
 *
pTrunk
 = 0;

1000 if–
bBlock
 ){

1001 
rc
 = 
	`sqlôe4BtPageAŒoˇã
(
p
, &
pTrunk
);

1003 
rc
 = 
	`sqlôe4BtPageGë
(
p
, 
pgno
, &
pTrunk
);

1004 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4BtPageWrôe
(
pTrunk
);

1006 if–
rc
==
SQLITE4_OK
 ){

1007 
	`sqlôe4BtPagîDbhdrDúty
(
p
);

1008 
	`sqlôe4BtPutU32
(&
pTrunk
->
aD©a
[0], 0);

1009 
	`sqlôe4BtPutU32
(&
pTrunk
->
aD©a
[4], *
piFú°
);

1010 *
piFú°
 = 
pTrunk
->
pgno
;

1011 
	`sqlôe4BtDebugPageFªe
((
BtLock
*)
p
, 0, "‰ì-li°-åunk", 
pTrunk
->
pgno
);

1013 
	`sqlôe4BtPageRñó£
(
pTrunk
);

1014 if–
rc
==
SQLITE4_OK
 && 
bBlock
 ){

1015 
rc
 = 
	`btFªñi°Add
(
p
, 1, 
pgno
);

1019  
rc
;

1020 
	}
}

1025 
	$btFªñi°AŒoc
(

1026 
BtPagî
 *
p
,

1027 
bBlock
,

1028 
u32
 *
pPgno


1030 
BtDbHdr
 *
pHdr
 = 
	`sqlôe4BtLogDbhdr
(
p
->
pLog
);

1031 
rc
 = 
SQLITE4_OK
;

1032 
u32
 *
piFú°
 = (
bBlock
 ? &
pHdr
->
iFªeBlk
 : &pHdr->
iFªePg
);

1033 
u32
 
pgno
 = 0;

1035 
	`as£π
–*
pPgno
==0 );

1036  *
piFú°
 && 
pgno
==0 && 
rc
==
SQLITE4_OK
 ){

1037 
BtPage
 *
pTrunk
 = 0;

1038 
rc
 = 
	`sqlôe4BtPageGë
(
p
, *
piFú°
, &
pTrunk
);

1039 if–
rc
==
SQLITE4_OK
 ){

1040 
rc
 = 
	`sqlôe4BtPageWrôe
(
pTrunk
);

1042 if–
rc
==
SQLITE4_OK
 ){

1043 
u8
 *
aD©a
 = 
pTrunk
->aData;

1044 
u32
 
nFªe
 = 
	`sqlôe4BtGëU32
(
aD©a
);

1045 if–
nFªe
>0 ){

1046 
pgno
 = 
	`sqlôe4BtGëU32
(&
aD©a
[8 + 4*(
nFªe
-1)]);

1047 
	`sqlôe4BtPutU32
(
aD©a
, 
nFªe
-1);

1048 
	`sqlôe4BtDebugPageAŒoc
((
BtLock
*)
p
, "‰ì-li°", 
pgno
);

1050 
u32
 
iNext
 = 
	`sqlôe4BtGëU32
(&
aD©a
[4]);

1051 
	`sqlôe4BtPagîDbhdrDúty
(
p
);

1053 if–
bBlock
 ){

1054 
rc
 = 
	`btFªñi°Add
(
p
, 0, *
piFú°
);

1056 
pgno
 = *
piFú°
;

1057 
	`sqlôe4BtDebugPageAŒoc
((
BtLock
*)
p
, "‰ì-li°-åunk", 
pgno
);

1059 *
piFú°
 = 
iNext
;

1063 
	`sqlôe4BtPageRñó£
(
pTrunk
);

1066 *
pPgno
 = 
pgno
;

1067  
rc
;

1068 
	}
}

1074 
	$sqlôe4BtPageTrim
(
BtPage
 *
pPg
){

1075 
rc
;

1076 
rc
 = 
	`btFªñi°Add
(
pPg
->
pPagî
, 0,ÖPg->
pgno
);

1077 
	`sqlôe4BtPageRñó£
(
pPg
);

1078  
rc
;

1079 
	}
}

1084 
	$sqlôe4BtPageTrimPgno
(
BtPagî
 *
pPagî
, 
u32
 
pgno
){

1085  
	`btFªñi°Add
(
pPagî
, 0, 
pgno
);

1086 
	}
}

1088 
	$sqlôe4BtPageRñó£
(
BtPage
 *
pPg
){

1089 if–
pPg
 ){

1090 
BtPagî
 *
pPagî
 = 
pPg
->pPager;

1092 
	`as£π
–
pPg
->
nRef
>=1 );

1093 
pPg
->
nRef
--;

1094 
pPg
->
pPagî
->
nTŸÆRef
--;

1098 if–
pPg
->
nRef
==0 && (pPg->
Êags
 & 
BT_PAGE_DIRTY
)==0 ){

1099 
	`btLruAdd
(
pPagî
, 
pPg
);

1102  
SQLITE4_OK
;

1103 
	}
}

1105 
	$sqlôe4BtPageRe„ªn˚
(
BtPage
 *
pPg
){

1106 
	`as£π
–
pPg
->
nRef
>=1 );

1107 
pPg
->
nRef
++;

1108 
pPg
->
pPagî
->
nTŸÆRef
++;

1109 
	}
}

1114 
	$sqlôe4BtPageAŒoˇã
(
BtPagî
 *
p
, 
BtPage
 **
µPg
){

1115 
BtPage
 *
pPg
 = 0;

1116 
rc
;

1117 
u32
 
pgno
 = 0;

1122 
rc
 = 
	`btFªñi°AŒoc
(
p
, 0, &
pgno
);

1123 if–
rc
==
SQLITE4_OK
 && 
pgno
==0 ){

1124 
pgno
 = 
p
->
pHdr
->
nPg
+1;

1125 
	`sqlôe4BtDebugPageAŒoc
((
BtLock
*)
p
, "íd-of-fûe", 
pgno
);

1128 
rc
 = 
	`sqlôe4BtPageGë
(
p
, 
pgno
, &
pPg
);

1129 if–
rc
==
SQLITE4_OK
 ){

1130 
rc
 = 
	`sqlôe4BtPageWrôe
(
pPg
);

1131 if–
rc
!=
SQLITE4_OK
 ){

1132 
	`sqlôe4BtPageRñó£
(
pPg
);

1133 
pPg
 = 0;

1135 
p
->
pHdr
->
nPg
 = 
	`MAX
’->pHdr->nPg, 
pgno
);

1139 #ifde‡
BT_STDERR_DEBUG


1140 
	`Ârötf
(
°dîr
, "ÆloˇãdÖagê%d\n", 
pgno
);

1143 *
µPg
 = 
pPg
;

1144  
rc
;

1145 
	}
}

1147 
	$sqlôe4BtBlockAŒoˇã
(
BtPagî
 *
p
, 
nBlk
, 
u32
 *
aiBlk
){

1148 
rc
 = 
SQLITE4_OK
;

1149 
BtDbHdr
 *
pHdr
 = 
p
->pHdr;

1150 
nPgPîBlk
 = (
pHdr
->
blksz
 /ÖHdr->
pgsz
);

1151 
i
;

1153 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nBlk
; i++){

1154 
u32
 
iBlk
 = 0;

1155 
u32
 
iRoŸ
;

1156 
u32
 
iFªe
;

1158 
rc
 = 
	`btFªñi°AŒoc
(
p
, 1, &
iBlk
);

1159 if–
rc
==
SQLITE4_OK
 && 
iBlk
==0 ){

1162 
iBlk
 = 1 + (
pHdr
->
nPg
 + 
nPgPîBlk
 - 1) /ÇPgPerBlk;

1163 
iRoŸ
 = (
iBlk
-1Ë* 
nPgPîBlk
 + 1;

1164 
	`as£π
–
iBlk
>0 );

1166 
iFªe
 = 
pHdr
->
nPg
+1; 
rc
==
SQLITE4_OK
 && iFªe<
iRoŸ
; iFree++){

1167 
rc
 = 
	`sqlôe4BtPageTrimPgno
(
p
, 
iFªe
);

1169 
pHdr
->
nPg
 = 
iBlk
 * 
nPgPîBlk
;

1172 
aiBlk
[
i
] = 
iBlk
;

1175  
rc
;

1176 
	}
}

1181 
	$sqlôe4BtBlockTrim
(
BtPagî
 *
p
, 
u32
 
iBlk
){

1182  
	`btFªñi°Add
(
p
, 1, 
iBlk
);

1183 
	}
}

1188 
u32
 
	$sqlôe4BtPagePgno
(
BtPage
 *
pPg
){

1189  
pPg
->
pgno
;

1190 
	}
}

1195 *
	$sqlôe4BtPageD©a
(
BtPage
 *
pPg
){

1196  
pPg
->
aD©a
;

1197 
	}
}

1202 
	$sqlôe4BtPagîSëCookõ
(
BtPagî
 *
p
, 
u32
 
iVÆ
){

1203 
	`as£π
–
p
->
iTønß˘i⁄Levñ
>=2 );

1204  
	`sqlôe4BtLogSëCookõ
(
p
->
pLog
, 
iVÆ
);

1205 
	}
}

1210 
	$sqlôe4BtPagîGëCookõ
(
BtPagî
 *
p
, 
u32
 *
piVÆ
){

1211 
	`as£π
–
p
->
iTønß˘i⁄Levñ
>=1 );

1212 *
piVÆ
 = 
p
->
pHdr
->
iCookõ
;

1213  
SQLITE4_OK
;

1214 
	}
}

1216 c⁄° *
	$sqlôe4BtPagîFûíame
(
BtPagî
 *
p
, 
ePagîfûe
){

1217 c⁄° *
zTaû
;

1220 if–
p
->
zFûe
==0 )  0;

1222  
ePagîfûe
 ){

1223 
BT_PAGERFILE_DATABASE
:

1224 
zTaû
 = "";

1227 
BT_PAGERFILE_LOG
:

1228 
zTaû
 = "-wal";

1232 
	`as£π
–
ePagîfûe
==
BT_PAGERFILE_SHM
 );

1233 
zTaû
 = "-shm";

1236 
	`mem˝y
(&
p
->
zFûe
[p->
nFûe
], 
zTaû
, 
	`°æí
(zTail)+1);

1237  
p
->
zFûe
;

1238 
	}
}

1240 
bt_ív
 *
	$sqlôe4BtPagîGëEnv
(
BtPagî
 *
p
){

1241  
p
->
bé
.
pVfs
;

1242 
	}
}

1243 
	$sqlôe4BtPagîSëEnv
(
BtPagî
 *
p
, 
bt_ív
 *
pVfs
){

1244 
p
->
bé
.
pVfs
 =ÖVfs;

1245 
	}
}

1247 
	$sqlôe4BtPagîSëSa„ty
(
BtPagî
 *
pPagî
, *
piVÆ
){

1248 
iVÆ
 = *
piVÆ
;

1249 if–
iVÆ
>=0 && iVal<=2 ){

1250 
pPagî
->
bé
.
iSa„tyLevñ
 = 
iVÆ
;

1252 *
piVÆ
 = 
pPagî
->
bé
.
iSa„tyLevñ
;

1253 
	}
}

1255 
	$sqlôe4BtPagîSëAutock±
(
BtPagî
 *
pPagî
, *
piVÆ
){

1256 
iVÆ
 = *
piVÆ
;

1257 if–
iVÆ
>=0 ){

1258 
pPagî
->
bé
.
nAutoCk±
 = 
iVÆ
;

1260 *
piVÆ
 = 
pPagî
->
bé
.
nAutoCk±
;

1261 
	}
}

1263 
	$sqlôe4BtPagîLogsize
(
BtPagî
 *
pPagî
, *
≤Føme
){

1264 *
≤Føme
 = 
	`sqlôe4BtLogSize
(
pPagî
->
pLog
);

1265 
	}
}

1267 
	$sqlôe4BtPagîMu…ùroc
(
BtPagî
 *
pPagî
, *
piVÆ
){

1268 if–*
piVÆ
==0 || *piVal==1 ){

1269 
pPagî
->
bé
.
bReque°Mu…iProc
 = *
piVÆ
;

1271 *
piVÆ
 = 
pPagî
->
bé
.
bReque°Mu…iProc
;

1272 
	}
}

1274 
	$sqlôe4BtPagîLogsizeCb
(
BtPagî
 *
pPagî
, 
bt_logsizecb
 *
p
){

1275 
pPagî
->
xLogsize
 = 
p
->xLogsize;

1276 
pPagî
->
pLogsizeCtx
 = 
p
->
pCtx
;

1277 
	}
}

1279 
	$sqlôe4BtPagîCheckpoöt
(
BtPagî
 *
pPagî
, 
bt_checkpoöt
 *
pCk±
){

1280 
rc
;

1281 
rc
 = 
	`sqlôe4BtLogCheckpoöt
(
pPagî
->
pLog
, 
pCk±
->
nFømeBuf„r
);

1282  
rc
;

1283 
	}
}

1294 
	$sqlôe4BtPagîHdrdump
(
BtPagî
 *
pPagî
, 
sqlôe4_buf„r
 *
pBuf
){

1295 
BtDbHdr
 *
pHdr
 = 
pPagî
->pHdr;

1296 
rc
 = 
SQLITE4_OK
;

1298 
	`sqlôe4BtBufAµídf
(
pBuf
,

1303 
pHdr
->
pgsz
,ÖHdr->
blksz
,ÖHdr->
nPg
,

1304 
pHdr
->
iRoŸ
,ÖHdr->
iMRoŸ
,ÖHdr->
iSRoŸ
,

1305 
pHdr
->
iSubBlock
,ÖHdr->
nSubPg
,

1306 
pHdr
->
iCookõ
,ÖHdr->
iFªePg
,ÖHdr->
iFªeBlk


1309  
rc
;

1310 
	}
}

1312 #i‚de‡
NDEBUG


1313 
	$sqlôe4BtPagîRefcou¡
(
BtPagî
 *
p
){

1314  
p
->
nTŸÆRef
;

1315 
	}
}

	@src/bt_unix.c

15 #i‡
deföed
(
__GNUC__
Ë|| deföed(
__TINYC__
)

17 #i‚de‡
_XOPEN_SOURCE


18 
	#_XOPEN_SOURCE
 500

	)

22 
	~<uni°d.h
>

23 
	~<sys/ty≥s.h
>

25 
	~<sys/°©.h
>

26 
	~<f˙é.h
>

27 
	~<as£π.h
>

28 
	~<°rög.h
>

30 
	~<°dlib.h
>

31 
	~<°d¨g.h
>

32 
	~<°dio.h
>

33 
	~<˘y≥.h
>

35 
	~<uni°d.h
>

36 
	~<î∫o.h
>

38 
	~<sys/mm™.h
>

39 
	~"btI¡.h
"

42 #ifde‡
__ANDROID__


43 
	#fd©async
(
x
Ë
	`fsync
(x)

	)

49 
BtPosixFûe
 
	tBtPosixFûe
;

50 
	sBtPosixFûe
 {

51 
sqlôe4_ív
 *
	mpSqlEnv
;

52 
bt_ív
 *
	mpEnv
;

53 c⁄° *
	mzName
;

54 
	mfd
;

55 
	mshmfd
;

56 
	mnShm
;

57 **
	m≠Shm
;

60 *
	$btPosixShmFûe
(
BtPosixFûe
 *
p
){

61 *
zShm
;

62 
nName
 = 
	`°æí
(
p
->
zName
);

63 
zShm
 = (*)
	`sqlôe4_mÆloc
(
p
->
pSqlEnv
, 
nName
+4+1);

64 if–
zShm
 ){

65 
	`mem˝y
(
zShm
, 
p
->
zName
, 
nName
);

66 
	`mem˝y
(&
zShm
[
nName
], "-shm", 5);

68  
zShm
;

69 
	}
}

71 
	$btPosixOsO≥n
(

72 
sqlôe4_ív
 *
pSqlEnv
,

73 
bt_ív
 *
pEnv
,

74 c⁄° *
zFûe
,

75 
Êags
,

76 
bt_fûe
 **
µFûe


78 
rc
 = 
SQLITE4_OK
;

79 
BtPosixFûe
 *
p
;

81 
p
 = (
BtPosixFûe
*)
	`sqlôe4_mÆloc
(
pSqlEnv
, (BtPosixFile));

82 if–
p
==0 ){

83 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

85 
bRód⁄ly
 = (
Êags
 & 
BT_OPEN_READONLY
);

86 
oÊags
 = (
bRód⁄ly
 ? 
O_RDONLY
 : (
O_RDWR
|
O_CREAT
));

87 
	`mem£t
(
p
, 0, (
BtPosixFûe
));

88 
p
->
zName
 = 
zFûe
;

89 
p
->
pEnv
 =ÖEnv;

90 
p
->
pSqlEnv
 =ÖSqlEnv;

91 
p
->
fd
 = 
	`›í
(
zFûe
, 
oÊags
, 0644);

92 if–
p
->
fd
<0 ){

93 
	`sqlôe4_‰ì
(
pSqlEnv
, 
p
);

94 
p
 = 0;

95 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

99 *
µFûe
 = (
bt_fûe
*)
p
;

100  
rc
;

101 
	}
}

103 
	$btPosixOsSize
(
bt_fûe
 *
pFûe
, 
i64
 *
≤Byã
){

104 
rc
 = 
SQLITE4_OK
;

105 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

106 
°©
 
sBuf
;

108 if–
	`f°©
(
p
->
fd
, &
sBuf
)!=0 ){

109 
rc
 = 
SQLITE4_IOERR_FSTAT
;

111 *
≤Byã
 = 
sBuf
.
°_size
;

114  
rc
;

115 
	}
}

117 
	$btPosixOsWrôe
(

118 
bt_fûe
 *
pFûe
,

119 
i64
 
iOff
,

120 *
pD©a
,

121 
nD©a


123 
rc
 = 
SQLITE4_OK
;

124 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

125 
off_t
 
off£t
;

127 
off£t
 = 
	`l£ek
(
p
->
fd
, (
off_t
)
iOff
, 
SEEK_SET
);

128 if–
off£t
!=
iOff
 ){

129 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

131 
ssize_t
 
¥c
 = 
	`wrôe
(
p
->
fd
, 
pD©a
, (
size_t
)
nD©a
);

132 if–
¥c
<0 ) 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

135  
rc
;

136 
	}
}

138 
	$btPosixOsTrunˇã
(

139 
bt_fûe
 *
pFûe
,

140 
i64
 
nSize


142 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

143 
rc
 = 
SQLITE4_OK
;

144 
¥c
;

145 
°©
 
sSèt
;

147 
¥c
 = 
	`f°©
(
p
->
fd
, &
sSèt
);

148 if–
¥c
==0 && 
sSèt
.
°_size
>
nSize
 ){

149 
¥c
 = 
	`·runˇã
(
p
->
fd
, (
off_t
)
nSize
);

151 if–
¥c
<0 ) 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

153  
rc
;

154 
	}
}

156 
	$btPosixOsRód
(

157 
bt_fûe
 *
pFûe
,

158 
i64
 
iOff
,

159 *
pD©a
,

160 
nD©a


162 
rc
 = 
SQLITE4_OK
;

163 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

164 
off_t
 
off£t
;

166 
off£t
 = 
	`l£ek
(
p
->
fd
, (
off_t
)
iOff
, 
SEEK_SET
);

167 if–
off£t
!=
iOff
 ){

168 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

170 
ssize_t
 
¥c
 = 
	`ªad
(
p
->
fd
, 
pD©a
, (
size_t
)
nD©a
);

171 if–
¥c
<0 ){

172 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

173 }if–
¥c
<
nD©a
 ){

174 
	`mem£t
(&((
u8
 *)
pD©a
)[
¥c
], 0, 
nD©a
 -Örc);

178  
rc
;

179 
	}
}

181 
	$btPosixOsSync
(
bt_fûe
 *
pFûe
){

182 
rc
 = 
SQLITE4_OK
;

183 #i‚de‡
SQLITE_NO_SYNC


184 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

185 
¥c
 = 0;

188 if–
p
->
pM≠
 ){

189 
¥c
 = 
	`msync
(
p
->
pM≠
,Ö->
nM≠
, 
MS_SYNC
);

192 
¥c
 = 
	`fd©async
(
p
->
fd
);

193 if–
¥c
<0 ) 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

195 ()
pFûe
;

198  
rc
;

199 
	}
}

201 
	$btPosixOsSe˘‹Size
(
bt_fûe
 *
pFûe
){

203 
	}
}

205 
	$btPosixOsFuŒ∑th
(

206 
sqlôe4_ív
 *
pSqlEnv
,

207 
bt_ív
 *
pEnv
,

208 c⁄° *
zName
,

209 **
pzOut


211 
rc
 = 
SQLITE4_OK
;

212 *
zOut
 = 0;

213 *
zCwd
 = 0;

214 
nCwd
 = 0;

216 if–
zName
[0]!='/' ){

217 
nTmp
 = 512;

218 *
zTmp
 = (*)
	`sqlôe4_mÆloc
(
pSqlEnv
, 
nTmp
);

219  
zTmp
 ){

220 
zCwd
 = 
	`gëcwd
(
zTmp
, 
nTmp
);

221 if–
zCwd
 || 
î∫o
!=
ERANGE
 ) ;

222 
	`sqlôe4_‰ì
(
pSqlEnv
, 
zTmp
);

223 
nTmp
 =ÇTmp*2;

224 
zTmp
 = 
	`sqlôe4_mÆloc
(
pSqlEnv
, 
nTmp
);

226 if–
zTmp
==0 ){

227 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

228 }if–
zCwd
==0 ){

229 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

231 
	`as£π
–
zCwd
==
zTmp
 );

232 
nCwd
 = 
	`°æí
(
zCwd
);

236 if–
rc
==
SQLITE4_OK
 ){

237 
nReq
 = 
nCwd
 + 1 + 
	`°æí
(
zName
) + 1 + 4;

238 
zOut
 = 
	`sqlôe4_mÆloc
(
pSqlEnv
, 
nReq
);

239 if–
zOut
 ){

240 
nName
 = 
	`°æí
(
zName
);

241 if–
nCwd
 ){

242 
	`mem˝y
(
zOut
, 
zCwd
, 
nCwd
);

243 
zOut
[
nCwd
] = '/';

244 
	`mem˝y
(&
zOut
[
nCwd
+1], 
zName
, 
nName
+1);

246 
	`mem˝y
(
zOut
, 
zName
, 
nName
+1);

249 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

253 
	`sqlôe4_‰ì
(
pSqlEnv
, 
zCwd
);

254 *
pzOut
 = 
zOut
;

255  
rc
;

256 
	}
}

258 
	$btPosixOsU∆ök
(
sqlôe4_ív
 *
pEnv
, 
bt_ív
 *
pVfs
, c⁄° *
zFûe
){

259 
¥c
 = 
	`u∆ök
(
zFûe
);

260  
¥c
 ? 
	`btEº‹Bk±
(
SQLITE4_IOERR
Ë: 
SQLITE4_OK
;

261 
	}
}

263 
	#btPosixLockToByã
(
iLock
Ë(100 + (iLock))

	)

265 
	$btPosixOsLock
(
bt_fûe
 *
pFûe
, 
iLock
, 
eTy≥
){

266 
rc
 = 
SQLITE4_OK
;

267 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

268 c⁄° 
aTy≥
[3] = { 
F_UNLCK
, 
F_RDLCK
, 
F_WRLCK
 };

269 
Êock
 
lock
;

271 
	`as£π
–
aTy≥
[
BT_LOCK_UNLOCK
]==
F_UNLCK
 );

272 
	`as£π
–
aTy≥
[
BT_LOCK_SHARED
]==
F_RDLCK
 );

273 
	`as£π
–
aTy≥
[
BT_LOCK_EXCL
]==
F_WRLCK
 );

274 
	`as£π
–
eTy≥
>=0 &&ÉTy≥<((
aTy≥
)/(aType[0])) );

275 
	`as£π
–
iLock
>=0 && iLock<=32 );

277 
	`mem£t
(&
lock
, 0, (lock));

278 
lock
.
l_whí˚
 = 
SEEK_SET
;

279 
lock
.
l_Àn
 = 1;

280 
lock
.
l_ty≥
 = 
aTy≥
[
eTy≥
];

281 
lock
.
l_°¨t
 = 
	`btPosixLockToByã
(
iLock
);

283 if–
	`f˙é
(
p
->
fd
, 
F_SETLK
, &
lock
) ){

284 
e
 = 
î∫o
;

285 if–
e
==
EACCES
 ||É==
EAGAIN
 ){

286 
rc
 = 
SQLITE4_BUSY
;

288 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

292  
rc
;

293 
	}
}

295 
	$btPosixOsTe°Lock
(
bt_fûe
 *
pFûe
, 
iLock
, 
nLock
, 
eTy≥
){

296 
rc
 = 
SQLITE4_OK
;

297 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

298 c⁄° 
aTy≥
[3] = { 0, 
F_RDLCK
, 
F_WRLCK
 };

299 
Êock
 
lock
;

301 
	`as£π
–
eTy≥
==
BT_LOCK_SHARED
 ||ÉTy≥==
BT_LOCK_EXCL
 );

302 
	`as£π
–
aTy≥
[
BT_LOCK_SHARED
]==
F_RDLCK
 );

303 
	`as£π
–
aTy≥
[
BT_LOCK_EXCL
]==
F_WRLCK
 );

304 
	`as£π
–
eTy≥
>=0 &&ÉTy≥<((
aTy≥
)/(aType[0])) );

305 
	`as£π
–
iLock
>=0 && iLock<=32 );

307 
	`mem£t
(&
lock
, 0, (lock));

308 
lock
.
l_whí˚
 = 
SEEK_SET
;

309 
lock
.
l_Àn
 = 
nLock
;

310 
lock
.
l_ty≥
 = 
aTy≥
[
eTy≥
];

311 
lock
.
l_°¨t
 = 
	`btPosixLockToByã
(
iLock
);

313 if–
	`f˙é
(
p
->
fd
, 
F_GETLK
, &
lock
) ){

314 
rc
 = 
	`btEº‹Bk±
(
SQLITE4_IOERR
);

315 }if–
lock
.
l_ty≥
!=
F_UNLCK
 ){

316 
rc
 = 
SQLITE4_BUSY
;

319  
rc
;

320 
	}
}

322 
	$btPosixOsShmM≠
(
bt_fûe
 *
pFûe
, 
iChunk
, 
sz
, **
µShm
){

323 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

326 if–
p
->
shmfd
<=0 ){

327 *
zShm
 = 
	`btPosixShmFûe
(
p
);

328 if–!
zShm
 )  
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

329 
p
->
shmfd
 = 
	`›í
(
zShm
, 
O_RDWR
|
O_CREAT
, 0644);

330 
	`sqlôe4_‰ì
(
p
->
pSqlEnv
, 
zShm
);

331 if–
p
->
shmfd
<0 ){

332  
	`btEº‹Bk±
(
SQLITE4_IOERR
);

336 if–
µShm
==0 ){

337 
	`as£π
–
p
->
nShm
==0 );

338 if–
p
->
nShm
 )  
	`btEº‹Bk±
(
SQLITE4_MISUSE
);

339 if–
	`·runˇã
(
p
->
shmfd
, 0) ){

340  
	`btEº‹Bk±
(
SQLITE4_IOERR
);

344 *
µShm
 = 0;

345 
	`as£π
–
sz
==
BT_SHM_CHUNK_SIZE
 );

346 if–
iChunk
>=
p
->
nShm
 ){

347 
i
;

348 **
≠New
;

349 
nNew
 = 
iChunk
+1;

350 
off_t
 
nReq
 = 
nNew
 * 
BT_SHM_CHUNK_SIZE
;

351 
°©
 
sSèt
;

355 if–
	`f°©
(
p
->
shmfd
, &
sSèt
) ){

356  
	`btEº‹Bk±
(
SQLITE4_IOERR
);

358 if–
sSèt
.
°_size
<
nReq
 ){

359 if–
	`·runˇã
(
p
->
shmfd
, 
nReq
) ){

360  
	`btEº‹Bk±
(
SQLITE4_IOERR
);

364 
≠New
 = (**)
	`sqlôe4_ªÆloc
(
p
->
pSqlEnv
,Ö->
≠Shm
, (*)*
nNew
);

365 if–!
≠New
 )  
	`btEº‹Bk±
(
SQLITE4_NOMEM
);

366 
i
=
p
->
nShm
; i<
nNew
; i++){

367 
≠New
[
i
] = 0;

369 
p
->
≠Shm
 = 
≠New
;

370 
p
->
nShm
 = 
nNew
;

373 if–
p
->
≠Shm
[
iChunk
]==0 ){

374 
p
->
≠Shm
[
iChunk
] = 
	`mm≠
(0, 
BT_SHM_CHUNK_SIZE
,

375 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
p
->
shmfd
, 
iChunk
*
BT_SHM_CHUNK_SIZE


377 if–
p
->
≠Shm
[
iChunk
]==0 )  
	`btEº‹Bk±
(
SQLITE4_IOERR
);

380 *
µShm
 = 
p
->
≠Shm
[
iChunk
];

382  
SQLITE4_OK
;

383 
	}
}

385 
	$btPosixOsShmB¨rõr
(
bt_fûe
 *
pFûe
){

386 
	}
}

388 
	$btPosixOsShmUnm≠
(
bt_fûe
 *
pFûe
, 
bDñëe
){

389 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

390 if–
p
->
shmfd
>0 ){

391 
i
;

392 
i
=0; i<
p
->
nShm
; i++){

393 if–
p
->
≠Shm
[
i
] ){

394 
	`munm≠
(
p
->
≠Shm
[
i
], 
BT_SHM_CHUNK_SIZE
);

395 
p
->
≠Shm
[
i
] = 0;

398 
	`˛o£
(
p
->
shmfd
);

399 
p
->
shmfd
 = 0;

400 if–
bDñëe
 ){

401 *
zShm
 = 
	`btPosixShmFûe
(
p
);

402 if–
zShm
 ) 
	`u∆ök
(zShm);

403 
	`sqlôe4_‰ì
(
p
->
pSqlEnv
, 
zShm
);

406  
SQLITE4_OK
;

407 
	}
}

410 
	$btPosixOsClo£
(
bt_fûe
 *
pFûe
){

411 
BtPosixFûe
 *
p
 = (BtPosixFûê*)
pFûe
;

412 
	`btPosixOsShmUnm≠
(
pFûe
, 0);

413 
	`˛o£
(
p
->
fd
);

414 
	`sqlôe4_‰ì
(
p
->
pSqlEnv
,Ö->
≠Shm
);

415 
	`sqlôe4_‰ì
(
p
->
pSqlEnv
,Ö);

416  
SQLITE4_OK
;

417 
	}
}

419 
bt_ív
 *
	$sqlôe4BtEnvDeÁu…
(){

420 
bt_ív
 
posix_ív
 = {

422 
btPosixOsFuŒ∑th
,

423 
btPosixOsO≥n
,

424 
btPosixOsSize
,

425 
btPosixOsRód
,

426 
btPosixOsWrôe
,

427 
btPosixOsTrunˇã
,

428 
btPosixOsSync
,

429 
btPosixOsSe˘‹Size
,

430 
btPosixOsClo£
,

431 
btPosixOsU∆ök
,

432 
btPosixOsLock
,

433 
btPosixOsTe°Lock
,

434 
btPosixOsShmM≠
,

435 
btPosixOsShmB¨rõr
,

436 
btPosixOsShmUnm≠


438  &
posix_ív
;

439 
	}
}

	@src/bt_varint.c

16 
	~"btI¡.h
"

26 
	$btSqlôe4GëV¨öt64
(c⁄° *
z
, 
u64
 *
pResu…
){

27 
x
;

28 if–
z
[0]<=240 ){

29 *
pResu…
 = 
z
[0];

32 if–
z
[0]<=248 ){

33 *
pResu…
 = (
z
[0]-241)*256 + z[1] + 240;

36 if–
z
[0]==249 ){

37 *
pResu…
 = 2288 + 256*
z
[1] + z[2];

40 if–
z
[0]==250 ){

41 *
pResu…
 = (
z
[1]<<16) + (z[2]<<8) + z[3];

44 
x
 = (
z
[1]<<24) + (z[2]<<16) + (z[3]<<8) + z[4];

45 if–
z
[0]==251 ){

46 *
pResu…
 = 
x
;

49 if–
z
[0]==252 ){

50 *
pResu…
 = (((
u64
)
x
)<<8Ë+ 
z
[5];

53 if–
z
[0]==253 ){

54 *
pResu…
 = (((
u64
)
x
)<<16Ë+ (
z
[5]<<8) + z[6];

57 if–
z
[0]==254 ){

58 *
pResu…
 = (((
u64
)
x
)<<24Ë+ (
z
[5]<<16) + (z[6]<<8) + z[7];

61 *
pResu…
 = (((
u64
)
x
)<<32) +

62 (0xfffffff‡& ((
z
[5]<<24) + (z[6]<<16) + (z[7]<<8) + z[8]));

64 
	}
}

69 
	$btV¨ötWrôe32
(*
z
, 
y
){

70 
z
[0] = ()(
y
>>24);

71 
z
[1] = ()(
y
>>16);

72 
z
[2] = ()(
y
>>8);

73 
z
[3] = ()(
y
);

74 
	}
}

81 
	$btSqlôe4PutV¨öt64
(*
z
, 
u64
 
x
){

82 
w
, 
y
;

83 if–
x
<=240 ){

84 
z
[0] = ()
x
;

87 if–
x
<=2287 ){

88 
y
 = ()(
x
 - 240);

89 
z
[0] = ()(
y
/256 + 241);

90 
z
[1] = ()(
y
%256);

93 if–
x
<=67823 ){

94 
y
 = ()(
x
 - 2288);

95 
z
[0] = 249;

96 
z
[1] = ()(
y
/256);

97 
z
[2] = ()(
y
%256);

100 
y
 = ()
x
;

101 
w
 = ()(
x
>>32);

102 if–
w
==0 ){

103 if–
y
<=16777215 ){

104 
z
[0] = 250;

105 
z
[1] = ()(
y
>>16);

106 
z
[2] = ()(
y
>>8);

107 
z
[3] = ()(
y
);

110 
z
[0] = 251;

111 
	`btV¨ötWrôe32
(
z
+1, 
y
);

114 if–
w
<=255 ){

115 
z
[0] = 252;

116 
z
[1] = ()
w
;

117 
	`btV¨ötWrôe32
(
z
+2, 
y
);

120 if–
w
<=32767 ){

121 
z
[0] = 253;

122 
z
[1] = ()(
w
>>8);

123 
z
[2] = ()
w
;

124 
	`btV¨ötWrôe32
(
z
+3, 
y
);

127 if–
w
<=16777215 ){

128 
z
[0] = 254;

129 
z
[1] = ()(
w
>>16);

130 
z
[2] = ()(
w
>>8);

131 
z
[3] = ()
w
;

132 
	`btV¨ötWrôe32
(
z
+4, 
y
);

135 
z
[0] = 255;

136 
	`btV¨ötWrôe32
(
z
+1, 
w
);

137 
	`btV¨ötWrôe32
(
z
+5, 
y
);

139 
	}
}

145 
	$sqlôe4BtV¨ötPut64
(
u8
 *
aD©a
, 
i64
 
iVÆ
){

146  
	`btSqlôe4PutV¨öt64
(
aD©a
, (
u64
)
iVÆ
);

147 
	}
}

149 
	$sqlôe4BtV¨ötGë64
(c⁄° 
u8
 *
aD©a
, 
i64
 *
piVÆ
){

150  
	`btSqlôe4GëV¨öt64
(
aD©a
, (
u64
 *)
piVÆ
);

151 
	}
}

153 
	$sqlôe4BtV¨ötPut32
(
u8
 *
aD©a
, 
iVÆ
){

154  
	`btSqlôe4PutV¨öt64
(
aD©a
, (
u64
)
iVÆ
);

155 
	}
}

157 
	$sqlôe4BtV¨ötGë32
(
u8
 *
z
, *
piVÆ
){

158 
u64
 
i
;

159 
ªt
;

161 if–
z
[0]<=240 ){

162 *
piVÆ
 = 
z
[0];

165 if–
z
[0]<=248 ){

166 *
piVÆ
 = (
z
[0]-241)*256 + z[1] + 240;

169 if–
z
[0]==249 ){

170 *
piVÆ
 = 2288 + 256*
z
[1] + z[2];

173 if–
z
[0]==250 ){

174 *
piVÆ
 = (
z
[1]<<16) + (z[2]<<8) + z[3];

178 
ªt
 = 
	`btSqlôe4GëV¨öt64
(
z
, &
i
);

179 *
piVÆ
 = 
i
;

180  
ªt
;

181 
	}
}

183 
	$sqlôe4BtV¨ötLí32
(
n
){

184 
u8
 
aD©a
[9];

185  
	`sqlôe4BtV¨ötPut32
(
aD©a
, 
n
);

186 
	}
}

192 
	$sqlôe4BtV¨ötSize
(
u8
 
c
){

193 if–
c
<241 )  1;

194 if–
c
<249 )  2;

195  ()(
c
 - 246);

196 
	}
}

	@src/build.c

25 
	~"sqlôeI¡.h
"

26 #i‚de‡
SQLITE_OMIT_VECTOR


27 
	~"ve˘‹IndexI¡.h
"

34 
	$sqlôe4BegöP¨£
(
P¨£
 *
pP¨£
, 
ex∂aöFœg
){

35 
pP¨£
->
ex∂aö
 = (
u8
)
ex∂aöFœg
;

36 
pP¨£
->
nV¨
 = 0;

37 
	}
}

50 
	$sqlôe4FöishCodög
(
P¨£
 *
pP¨£
){

51 
sqlôe4
 *
db
;

52 
Vdbe
 *
v
;

54 
db
 = 
pP¨£
->db;

55 if–
db
->
mÆlocFaûed
 ) ;

56 if–
pP¨£
->
√°ed
 ) ;

57 if–
pP¨£
->
nEº
 ) ;

62 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

63 
	`as£π
–!
pP¨£
->
isMu…iWrôe


64 || 
	`sqlôe4VdbeAs£πMayAb‹t
(
v
, 
pP¨£
->
mayAb‹t
));

65 if–
v
 ){

66 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_HÆt
);

74 if–
pP¨£
->
cookõGŸo
>0 ){

75 
yDbMask
 
mask
;

76 
iDb
;

77 
	`sqlôe4VdbeJumpHîe
(
v
, 
pP¨£
->
cookõGŸo
-1);

78 
iDb
=0, 
mask
=1; iDb<
db
->
nDb
; mask<<=1, iDb++){

79 if–(
mask
 & 
pP¨£
->
cookõMask
)==0 ) ;

80 
	`sqlôe4VdbeAddOp2
(
v
,
OP_Tønß˘i⁄
, 
iDb
, (
mask
 & 
pP¨£
->
wrôeMask
)!=0);

81 if–
db
->
öô
.
busy
==0 ){

82 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_VîifyCookõ
,

83 
iDb
, 
pP¨£
->
cookõVÆue
[iDb],

84 
db
->
aDb
[
iDb
].
pSchema
->
iGíî©i⁄
);

87 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


89 
i
;

90 
i
=0; i<
pP¨£
->
nVèbLock
; i++){

91 *
vèb
 = (*)
	`sqlôe4GëVTabÀ
(
db
, 
pP¨£
->
≠VèbLock
[
i
]);

92 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VBegö
, 0, 0, 0, 
vèb
, 
P4_VTAB
);

94 
pP¨£
->
nVèbLock
 = 0;

100 
	`sqlôe4Autoö¸emítBegö
(
pP¨£
);

103 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
pP¨£
->
cookõGŸo
);

110 if–
v
 && 
	`ALWAYS
(
pP¨£
->
nEº
==0Ë&& !
db
->
mÆlocFaûed
 ){

111 #ifde‡
SQLITE4_DEBUG


112 
FILE
 *
åa˚
 = (
db
->
Êags
 & 
SQLITE4_VdbeTø˚
)!=0 ? 
°dout
 : 0;

113 
	`sqlôe4VdbeTø˚
(
v
, 
åa˚
);

115 
	`as£π
–
pP¨£
->
iCacheLevñ
==0 );

118 if–
pP¨£
->
pAöc
!=0 &&ÖP¨£->
nTab
==0 )ÖParse->nTab = 1;

119 
	`sqlôe4VdbeMakeRódy
(
v
, 
pP¨£
);

120 
pP¨£
->
rc
 = 
SQLITE4_DONE
;

121 
pP¨£
->
cﬁNamesSë
 = 0;

123 
pP¨£
->
rc
 = 
SQLITE4_ERROR
;

125 
pP¨£
->
nTab
 = 0;

126 
pP¨£
->
nMem
 = 0;

127 
pP¨£
->
nSë
 = 0;

128 
pP¨£
->
nV¨
 = 0;

129 
pP¨£
->
cookõMask
 = 0;

130 
pP¨£
->
cookõGŸo
 = 0;

131 
	}
}

137 
	$ÆloˇãTabÀNumbî
(

138 
P¨£
 *
pP¨£
,

139 
iDb
,

140 
iReg


142 
Vdbe
 *
v
;

144 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

145 if–
pP¨£
->
iNewidxReg
==0 ){

146 
Schema
 *
pSchema
;

147 
HashEÀm
 *
p
;

148 
maxTab
 = 1;

150 
pSchema
 = 
pP¨£
->
db
->
aDb
[
iDb
].pSchema;

151 
p
=
	`sqlôeHashFú°
(&
pSchema
->
idxHash
);Ö;p=
	`sqlôeHashNext
(p)){

152 
Index
 *
pIdx
 = (Index*)
	`sqlôeHashD©a
(
p
);

153 if–
pIdx
->
äum
!=
KVSTORE_ROOT
 &&ÖIdx->äum > 
maxTab
 ) maxTab =ÖIdx->tnum;

156 
pP¨£
->
iNewidxReg
 = ++pP¨£->
nMem
;

157 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
maxTab
, 
pP¨£
->
iNewidxReg
);

160 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewIdxid
, 
pP¨£
->
iNewidxReg
, 
iDb
);

161 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
pP¨£
->
iNewidxReg
, 
iReg
);

162 
	}
}

176 
	$sqlôe4Ne°edP¨£
(
P¨£
 *
pP¨£
, c⁄° *
zF‹m©
, ...){

177 
va_li°
 
≠
;

178 *
zSql
;

179 *
zEºMsg
 = 0;

180 
sqlôe4
 *
db
 = 
pP¨£
->db;

181 
	#SAVE_SZ
 ((
P¨£
Ë- 
	`off£tof
(P¨£,
nV¨
))

	)

182 
ßveBuf
[
SAVE_SZ
];

184 if–
pP¨£
->
nEº
 ) ;

185 
	`as£π
–
pP¨£
->
√°ed
<10 );

186 
	`va_°¨t
(
≠
, 
zF‹m©
);

187 
zSql
 = 
	`sqlôe4VMPrötf
(
db
, 
zF‹m©
, 
≠
);

188 
	`va_íd
(
≠
);

189 if–
zSql
==0 ){

192 
pP¨£
->
√°ed
++;

193 
	`mem˝y
(
ßveBuf
, &
pP¨£
->
nV¨
, 
SAVE_SZ
);

194 
	`mem£t
(&
pP¨£
->
nV¨
, 0, 
SAVE_SZ
);

195 
	`sqlôe4RunP¨£r
(
pP¨£
, 
zSql
, &
zEºMsg
);

196 
	`sqlôe4DbFªe
(
db
, 
zEºMsg
);

197 
	`sqlôe4DbFªe
(
db
, 
zSql
);

198 
	`mem˝y
(&
pP¨£
->
nV¨
, 
ßveBuf
, 
SAVE_SZ
);

199 
pP¨£
->
√°ed
--;

200 
	}
}

214 
TabÀ
 *
	$sqlôe4FödTabÀ
(
sqlôe4
 *
db
, c⁄° *
zName
, c⁄° *
zD©aba£
){

215 
TabÀ
 *
p
 = 0;

216 
i
;

217 
nName
;

218 
	`as£π
–
zName
!=0 );

219 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

221 
i
=
OMIT_TEMPDB
; i<
db
->
nDb
; i++){

222 
j
 = (
i
<2) ? i^1 : i;

223 if–
zD©aba£
!=0 && 
	`sqlôe4_°ricmp
(zD©aba£, 
db
->
aDb
[
j
].
zName
) ) ;

224 
p
 = 
	`sqlôe4HashFöd
(&
db
->
aDb
[
j
].
pSchema
->
tblHash
, 
zName
, 
nName
);

225 if–
p
 ) ;

227  
p
;

228 
	}
}

240 
TabÀ
 *
	$sqlôe4LoˇãTabÀ
(

241 
P¨£
 *
pP¨£
,

242 
isVõw
,

243 c⁄° *
zName
,

244 c⁄° *
zDba£


246 
TabÀ
 *
p
;

250 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

254 
p
 = 
	`sqlôe4FödTabÀ
(
pP¨£
->
db
, 
zName
, 
zDba£
);

255 if–
p
==0 ){

256 c⁄° *
zMsg
 = 
isVõw
 ? "no such view" : "no suchÅable";

257 if–
zDba£
 ){

258 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s: %s.%s", 
zMsg
, 
zDba£
, 
zName
);

260 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s: %s", 
zMsg
, 
zName
);

262 
pP¨£
->
checkSchema
 = 1;

264  
p
;

265 
	}
}

279 
Index
 *
	$sqlôe4FödIndex
(
sqlôe4
 *
db
, c⁄° *
zName
, c⁄° *
zDb
){

280 
Index
 *
p
 = 0;

281 
i
;

282 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

284 
i
=
OMIT_TEMPDB
; i<
db
->
nDb
; i++){

285 
j
 = (
i
<2) ? i^1 : i;

286 
Schema
 *
pSchema
 = 
db
->
aDb
[
j
].pSchema;

287 
	`as£π
–
pSchema
 );

288 if–
zDb
 && 
	`sqlôe4_°ricmp
(zDb, 
db
->
aDb
[
j
].
zName
) ) ;

289 
p
 = 
	`sqlôe4HashFöd
(&
pSchema
->
idxHash
, 
zName
, 
nName
);

290 if–
p
 ) ;

292  
p
;

293 
	}
}

298 
	$‰ìIndex
(
sqlôe4
 *
db
, 
Index
 *
p
){

299 #i‚de‡
SQLITE4_OMIT_ANALYZE


300 
	`sqlôe4DñëeIndexSam∂es
(
db
, 
p
);

302 
	`sqlôe4Fts5IndexFªe
(
db
, 
p
);

303 
	`sqlôe4DbFªe
(
db
, 
p
->
zCﬁAff
);

304 
	`sqlôe4DbFªe
(
db
, 
p
);

305 
	}
}

313 
	$sqlôe4U∆ökAndDñëeIndex
(
sqlôe4
 *
db
, 
iDb
, c⁄° *
zIdxName
){

314 
Index
 *
pIndex
;

315 
Àn
;

316 
Hash
 *
pHash
;

318 
pHash
 = &
db
->
aDb
[
iDb
].
pSchema
->
idxHash
;

319 
Àn
 = 
	`sqlôe4SåÀn30
(
zIdxName
);

320 
pIndex
 = 
	`sqlôe4HashIn£π
(
pHash
, 
zIdxName
, 
Àn
, 0);

321 if–
	`ALWAYS
(
pIndex
) ){

322 if–
pIndex
->
pTabÀ
->pIndex==pIndex ){

323 
pIndex
->
pTabÀ
->pIndex =ÖIndex->
pNext
;

325 
Index
 *
p
;

328 
p
 = 
pIndex
->
pTabÀ
->pIndex;

329  
	`ALWAYS
(
p
Ë&&Ö->
pNext
!=
pIndex
 ){Ö =Ö->pNext; }

330 if–
	`ALWAYS
(
p
 &&Ö->
pNext
==
pIndex
) ){

331 
p
->
pNext
 = 
pIndex
->pNext;

334 
	`‰ìIndex
(
db
, 
pIndex
);

336 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

337 
	}
}

350 
	$sqlôe4Re£tI¡î«lSchema
(
sqlôe4
 *
db
, 
iDb
){

351 
i
, 
j
;

352 
	`as£π
–
iDb
<
db
->
nDb
 );

354 if–
iDb
>=0 ){

356 
Db
 *
pDb
 = &
db
->
aDb
[
iDb
];

357 
	`as£π
–
pDb
->
pSchema
!=0 );

358 
	`sqlôe4SchemaCÀ¨
(
db
->
pEnv
, 
pDb
->
pSchema
);

364 if–
iDb
!=1 ){

365 
pDb
 = &
db
->
aDb
[1];

366 
	`as£π
–
pDb
->
pSchema
!=0 );

367 
	`sqlôe4SchemaCÀ¨
(
db
->
pEnv
, 
pDb
->
pSchema
);

373 
	`as£π
–
iDb
<0 );

374 
i
=0; i<
db
->
nDb
; i++){

375 
Db
 *
pDb
 = &
db
->
aDb
[
i
];

376 if–
pDb
->
pSchema
 ){

377 
	`sqlôe4SchemaCÀ¨
(
db
->
pEnv
, 
pDb
->
pSchema
);

380 
db
->
Êags
 &~
SQLITE4_I¡înCh™ges
;

381 
	`sqlôe4VèbU∆ockLi°
(
db
);

389 
i
=
j
=2; i<
db
->
nDb
; i++){

390 
Db
 *
pDb
 = &
db
->
aDb
[
i
];

391 if–
pDb
->
pKV
==0 ){

392 
	`sqlôe4DbFªe
(
db
, 
pDb
->
zName
);

393 
pDb
->
zName
 = 0;

396 if–
j
<
i
 ){

397 
db
->
aDb
[
j
] = db->aDb[
i
];

399 
j
++;

401 
	`mem£t
(&
db
->
aDb
[
j
], 0, (db->
nDb
-j)*(db->aDb[j]));

402 
db
->
nDb
 = 
j
;

403 if–
db
->
nDb
<=2 && db->
aDb
!=db->
aDbSètic
 ){

404 
	`mem˝y
(
db
->
aDbSètic
, db->
aDb
, 2*(db->aDb[0]));

405 
	`sqlôe4DbFªe
(
db
, db->
aDb
);

406 
db
->
aDb
 = db->
aDbSètic
;

408 
	}
}

413 
	$sqlôe4CommôI¡î«lCh™ges
(
sqlôe4
 *
db
){

414 
db
->
Êags
 &~
SQLITE4_I¡înCh™ges
;

415 
	}
}

421 
	$sqlôeDñëeCﬁumnNames
(
sqlôe4
 *
db
, 
TabÀ
 *
pTabÀ
){

422 
i
;

423 
Cﬁumn
 *
pCﬁ
;

424 
	`as£π
–
pTabÀ
!=0 );

425 if–(
pCﬁ
 = 
pTabÀ
->
aCﬁ
)!=0 ){

426 
i
=0; i<
pTabÀ
->
nCﬁ
; i++, 
pCﬁ
++){

427 
	`sqlôe4DbFªe
(
db
, 
pCﬁ
->
zName
);

428 
	`sqlôe4Ex¥Dñëe
(
db
, 
pCﬁ
->
pDÊt
);

429 
	`sqlôe4DbFªe
(
db
, 
pCﬁ
->
zDÊt
);

430 
	`sqlôe4DbFªe
(
db
, 
pCﬁ
->
zTy≥
);

431 
	`sqlôe4DbFªe
(
db
, 
pCﬁ
->
zCﬁl
);

433 
	`sqlôe4DbFªe
(
db
, 
pTabÀ
->
aCﬁ
);

435 
	}
}

446 
	$sqlôe4DñëeTabÀ
(
sqlôe4
 *
db
, 
TabÀ
 *
pTabÀ
){

447 
Index
 *
pIndex
, *
pNext
;

449 
	`as£π
–!
pTabÀ
 ||ÖTabÀ->
nRef
>0 );

452 if–!
pTabÀ
 ) ;

453 if–((!
db
 || db->
≤ByãsFªed
==0Ë&& (--
pTabÀ
->
nRef
)>0) ) ;

456 
pIndex
 = 
pTabÀ
->pIndex;ÖIndex;ÖIndex=
pNext
){

457 
pNext
 = 
pIndex
->pNext;

458 
	`as£π
–
pIndex
->
pSchema
==
pTabÀ
->pSchema );

459 if–!
db
 || db->
≤ByãsFªed
==0 ){

460 *
zName
 = 
pIndex
->zName;

461 
	`TESTONLY
 ( 
Index
 *
pOld
 = ) 
	`sqlôe4HashIn£π
(

462 &
pIndex
->
pSchema
->
idxHash
, 
zName
, 
	`sqlôe4SåÀn30
(zName), 0

464 
	`as£π
–
pOld
==
pIndex
 ||ÖOld==0 );

466 
	`‰ìIndex
(
db
, 
pIndex
);

470 
	`sqlôe4FkDñëe
(
db
, 
pTabÀ
);

474 
	`sqlôeDñëeCﬁumnNames
(
db
, 
pTabÀ
);

475 
	`sqlôe4DbFªe
(
db
, 
pTabÀ
->
zName
);

476 
	`sqlôe4DbFªe
(
db
, 
pTabÀ
->
zCﬁAff
);

477 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pTabÀ
->
pSñe˘
);

478 #i‚de‡
SQLITE4_OMIT_CHECK


479 
	`sqlôe4Ex¥Dñëe
(
db
, 
pTabÀ
->
pCheck
);

481 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


482 
	`sqlôe4VèbCÀ¨
(
db
, 
pTabÀ
);

484 
	`sqlôe4DbFªe
(
db
, 
pTabÀ
);

485 
	}
}

491 
	$sqlôe4U∆ökAndDñëeTabÀ
(
sqlôe4
 *
db
, 
iDb
, c⁄° *
zTabName
){

492 
TabÀ
 *
p
;

493 
Db
 *
pDb
;

495 
	`as£π
–
db
!=0 );

496 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

497 
	`as£π
–
zTabName
 );

498 
	`ã°ˇ£
–
zTabName
[0]==0 );

499 
pDb
 = &
db
->
aDb
[
iDb
];

500 
p
 = 
	`sqlôe4HashIn£π
(&
pDb
->
pSchema
->
tblHash
, 
zTabName
,

501 
	`sqlôe4SåÀn30
(
zTabName
),0);

502 
	`sqlôe4DñëeTabÀ
(
db
, 
p
);

503 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

504 
	}
}

519 *
	$sqlôe4NameFromTokí
(
sqlôe4
 *
db
, 
Tokí
 *
pName
){

520 *
zName
;

521 if–
pName
 ){

522 
zName
 = 
	`sqlôe4DbSåNDup
(
db
, (*)
pName
->
z
,ÖName->
n
);

523 
	`sqlôe4DequŸe
(
zName
);

525 
zName
 = 0;

527  
zName
;

528 
	}
}

534 
	$sqlôe4O≥nMa°îTabÀ
(
P¨£
 *
p
, 
iDb
){

535 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
p
);

536 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_O≥nWrôe
, 0, 
MASTER_ROOT
, 
iDb
);

537 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (*)5, 
P4_INT32
);

538 if–
p
->
nTab
==0 ){

539 
p
->
nTab
 = 1;

541 
	}
}

549 
	$sqlôe4FödDbName
(
sqlôe4
 *
db
, c⁄° *
zName
){

550 
i
 = -1;

551 if–
zName
 ){

552 
Db
 *
pDb
;

553 
n
 = 
	`sqlôe4SåÀn30
(
zName
);

554 
i
=(
db
->
nDb
-1), 
pDb
=&db->
aDb
[i]; i>=0; i--,ÖDb--){

555 if–(!
OMIT_TEMPDB
 || 
i
!=1 ) && 
n
==
	`sqlôe4SåÀn30
(
pDb
->
zName
) &&

556 0==
	`sqlôe4_°ricmp
(
pDb
->
zName
, zName) ){

561  
i
;

562 
	}
}

570 
	$sqlôe4FödDb
(
sqlôe4
 *
db
, 
Tokí
 *
pName
){

571 
i
;

572 *
zName
;

573 
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName
);

574 
i
 = 
	`sqlôe4FödDbName
(
db
, 
zName
);

575 
	`sqlôe4DbFªe
(
db
, 
zName
);

576  
i
;

577 
	}
}

595 
	$sqlôe4TwoP¨tName
(

596 
P¨£
 *
pP¨£
,

597 
Tokí
 *
pName1
,

598 
Tokí
 *
pName2
,

599 
Tokí
 **
pUnquÆ


601 
iDb
;

602 
sqlôe4
 *
db
 = 
pP¨£
->db;

604 if–
	`ALWAYS
(
pName2
!=0Ë&&ÖName2->
n
>0 ){

605 if–
db
->
öô
.
busy
 ) {

606 
	`sqlôe4Eº‹Msg
(
pP¨£
, "corrupt database");

607 
pP¨£
->
nEº
++;

610 *
pUnquÆ
 = 
pName2
;

611 
iDb
 = 
	`sqlôe4FödDb
(
db
, 
pName1
);

612 if–
iDb
<0 ){

613 
	`sqlôe4Eº‹Msg
(
pP¨£
, "unknow¿d©aba£ %T", 
pName1
);

614 
pP¨£
->
nEº
++;

618 
	`as£π
–
db
->
öô
.
iDb
==0 || db->öô.
busy
 );

619 
iDb
 = 
db
->
öô
.iDb;

620 *
pUnquÆ
 = 
pName1
;

622  
iDb
;

623 
	}
}

632 
	$sqlôe4CheckObje˘Name
(
P¨£
 *
pP¨£
, c⁄° *
zName
){

633 if–!
pP¨£
->
db
->
öô
.
busy
 &&ÖP¨£->
√°ed
==0

634 && (
pP¨£
->
db
->
Êags
 & 
SQLITE4_WrôeSchema
)==0

635 && 0==
	`sqlôe4_°∫icmp
(
zName
, "sqlite_", 7) ){

636 
	`sqlôe4Eº‹Msg
(
pP¨£
, "obje˘Çamêª£rved f‹ i¡î«»u£: %s", 
zName
);

637  
SQLITE4_ERROR
;

639  
SQLITE4_OK
;

640 
	}
}

658 
	$sqlôe4SèπTabÀ
(

659 
P¨£
 *
pP¨£
,

660 
Tokí
 *
pName1
,

661 
Tokí
 *
pName2
,

662 
isTemp
,

663 
isVõw
,

664 
isVútuÆ
,

665 
noEº


667 
TabÀ
 *
pTabÀ
;

668 *
zName
 = 0;

669 
sqlôe4
 *
db
 = 
pP¨£
->db;

670 
Vdbe
 *
v
;

671 
iDb
;

672 
Tokí
 *
pName
;

691 
iDb
 = 
	`sqlôe4TwoP¨tName
(
pP¨£
, 
pName1
, 
pName2
, &
pName
);

692 if–
iDb
<0 ) ;

693 if–!
OMIT_TEMPDB
 && 
isTemp
 && 
pName2
->
n
>0 && 
iDb
!=1 ){

696 
	`sqlôe4Eº‹Msg
(
pP¨£
, "temporaryÅableÇame must be unqualified");

699 if–!
OMIT_TEMPDB
 && 
isTemp
 ) 
iDb
 = 1;

701 
pP¨£
->
sNameTokí
 = *
pName
;

702 
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName
);

703 if–
zName
==0 ) ;

704 if–
SQLITE4_OK
!=
	`sqlôe4CheckObje˘Name
(
pP¨£
, 
zName
) ){

705 
begö_èbÀ_îr‹
;

707 if–
db
->
öô
.
iDb
==1 ) 
isTemp
 = 1;

708 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


709 
	`as£π
–(
isTemp
 & 1)==isTemp );

711 
code
;

712 *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

713 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_INSERT
, 
	`SCHEMA_TABLE
(
isTemp
), 0, 
zDb
) ){

714 
begö_èbÀ_îr‹
;

716 if–
isVõw
 ){

717 if–!
OMIT_TEMPDB
 && 
isTemp
 ){

718 
code
 = 
SQLITE4_CREATE_TEMP_VIEW
;

720 
code
 = 
SQLITE4_CREATE_VIEW
;

723 if–!
OMIT_TEMPDB
 && 
isTemp
 ){

724 
code
 = 
SQLITE4_CREATE_TEMP_TABLE
;

726 
code
 = 
SQLITE4_CREATE_TABLE
;

729 if–!
isVútuÆ
 && 
	`sqlôe4AuthCheck
(
pP¨£
, 
code
, 
zName
, 0, 
zDb
) ){

730 
begö_èbÀ_îr‹
;

742 if–!
IN_DECLARE_VTAB
 ){

743 *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

744 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

745 
begö_èbÀ_îr‹
;

747 
pTabÀ
 = 
	`sqlôe4FödTabÀ
(
db
, 
zName
, 
zDb
);

748 if–
pTabÀ
 ){

749 if–!
noEº
 ){

750 
	`sqlôe4Eº‹Msg
(
pP¨£
, "èbÀ %TáÃódyÉxi°s", 
pName
);

752 
	`as£π
–!
db
->
öô
.
busy
 );

753 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

755 
begö_èbÀ_îr‹
;

757 if–
	`sqlôe4FödIndex
(
db
, 
zName
, 
zDb
)!=0 ){

758 
	`sqlôe4Eº‹Msg
(
pP¨£
, "thîêi†Æªadyá¿ödexÇamed %s", 
zName
);

759 
begö_èbÀ_îr‹
;

763 
pTabÀ
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
TabÀ
));

764 if–
pTabÀ
==0 ){

765 
db
->
mÆlocFaûed
 = 1;

766 
pP¨£
->
rc
 = 
SQLITE4_NOMEM
;

767 
pP¨£
->
nEº
++;

768 
begö_èbÀ_îr‹
;

770 
pTabÀ
->
zName
 = zName;

771 
pTabÀ
->
pSchema
 = 
db
->
aDb
[
iDb
].pSchema;

772 
pTabÀ
->
nRef
 = 1;

773 
pTabÀ
->
nRowE°
 = 1000000;

774 
	`as£π
–
pP¨£
->
pNewTabÀ
==0 );

775 
pP¨£
->
pNewTabÀ
 = 
pTabÀ
;

781 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


782 if–!
pP¨£
->
√°ed
 && 
	`°rcmp
(
zName
, "sqlite_sequence")==0 ){

783 
pTabÀ
->
pSchema
->
pSeqTab
 =ÖTable;

795 if–!
db
->
öô
.
busy
 && (
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
))!=0 ){

796 
ªg1
, 
ªg3
;

797 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

799 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


800 if–
isVútuÆ
 ){

801 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_VBegö
);

814 
ªg1
 = 
pP¨£
->
ªgRowid
 = ++pP¨£->
nMem
;

815 
ªg3
 = ++
pP¨£
->
nMem
;

817 #i‡!
	`deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed(
SQLITE4_OMIT_VIRTUALTABLE
)

818 if–
isVõw
 || 
isVútuÆ
 ){

819 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªg2
);

823 
äum
 = 
	`fú°AvaûabÀTabÀNumbî
(
db
, 
iDb
);

824 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
äum
, 
ªg2
);

827 
	`sqlôe4O≥nMa°îTabÀ
(
pP¨£
, 
iDb
);

828 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 0, 
ªg1
);

829 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 0, 0, 
ªg1
);

830 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_Clo£
);

837 
begö_èbÀ_îr‹
:

838 
	`sqlôe4DbFªe
(
db
, 
zName
);

840 
	}
}

850 
	#STRICMP
(
x
, 
y
) (\

851 
sqlôe4UµîToLowî
[*(*)(
x
)]== \

852 
sqlôe4UµîToLowî
[*(*)(
y
)] \

853 && 
	`sqlôe4_°ricmp
((
x
)+1,(
y
)+1)==0 )

	)

863 
	$sqlôe4AddCﬁumn
(
P¨£
 *
pP¨£
, 
Tokí
 *
pName
){

864 
TabÀ
 *
p
;

865 
i
;

866 *
z
;

867 
Cﬁumn
 *
pCﬁ
;

868 
sqlôe4
 *
db
 = 
pP¨£
->db;

869 if–(
p
 = 
pP¨£
->
pNewTabÀ
)==0 ) ;

870 #i‡
SQLITE4_MAX_COLUMN


871 if–
p
->
nCﬁ
+1>
db
->
aLimô
[
SQLITE4_LIMIT_COLUMN
] ){

872 
	`sqlôe4Eº‹Msg
(
pP¨£
, "toÿm™y cﬁumn†⁄ %s", 
p
->
zName
);

876 
z
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName
);

877 if–
z
==0 ) ;

878 
i
=0; i<
p
->
nCﬁ
; i++){

879 if–
	`STRICMP
(
z
, 
p
->
aCﬁ
[
i
].
zName
) ){

880 
	`sqlôe4Eº‹Msg
(
pP¨£
, "du∂iˇã cﬁum¿«me: %s", 
z
);

881 
	`sqlôe4DbFªe
(
db
, 
z
);

885 if–(
p
->
nCﬁ
 & 0x7)==0 ){

886 
Cﬁumn
 *
aNew
;

887 
aNew
 = 
	`sqlôe4DbRóŒoc
(
db
,
p
->
aCﬁ
,’->
nCﬁ
+8)*(p->aCol[0]));

888 if–
aNew
==0 ){

889 
	`sqlôe4DbFªe
(
db
, 
z
);

892 
p
->
aCﬁ
 = 
aNew
;

894 
pCﬁ
 = &
p
->
aCﬁ
[p->
nCﬁ
];

895 
	`mem£t
(
pCﬁ
, 0, (
p
->
aCﬁ
[0]));

896 
pCﬁ
->
zName
 = 
z
;

902 
pCﬁ
->
afföôy
 = 
SQLITE4_AFF_NONE
;

903 
p
->
nCﬁ
++;

904 
	}
}

912 
	$sqlôe4AddNŸNuŒ
(
P¨£
 *
pP¨£
, 
⁄Eº‹
){

913 
TabÀ
 *
p
;

914 
p
 = 
pP¨£
->
pNewTabÀ
;

915 if–
p
==0 || 
	`NEVER
’->
nCﬁ
<1) ) ;

916 
p
->
aCﬁ
[p->
nCﬁ
-1].
nŸNuŒ
 = (
u8
)
⁄Eº‹
;

917 
	}
}

944 
	$sqlôe4AfföôyTy≥
(c⁄° *
zIn
){

945 
u32
 
h
 = 0;

946 
aff
 = 
SQLITE4_AFF_NUMERIC
;

948 if–
zIn
 )  zIn[0] ){

949 
h
 = (h<<8Ë+ 
sqlôe4UµîToLowî
[(*
zIn
)&0xff];

950 
zIn
++;

951 if–
h
==(('c'<<24)+('h'<<16)+('a'<<8)+'r') ){

952 
aff
 = 
SQLITE4_AFF_TEXT
;

953 }if–
h
==(('c'<<24)+('l'<<16)+('o'<<8)+'b') ){

954 
aff
 = 
SQLITE4_AFF_TEXT
;

955 }if–
h
==(('t'<<24)+('e'<<16)+('x'<<8)+'t') ){

956 
aff
 = 
SQLITE4_AFF_TEXT
;

957 }if–
h
==(('b'<<24)+('l'<<16)+('o'<<8)+'b')

958 && (
aff
==
SQLITE4_AFF_NUMERIC
 ||áff==
SQLITE4_AFF_REAL
) ){

959 
aff
 = 
SQLITE4_AFF_NONE
;

960 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


961 }if–
h
==(('r'<<24)+('e'<<16)+('a'<<8)+'l')

962 && 
aff
==
SQLITE4_AFF_NUMERIC
 ){

963 
aff
 = 
SQLITE4_AFF_REAL
;

964 }if–
h
==(('f'<<24)+('l'<<16)+('o'<<8)+'a')

965 && 
aff
==
SQLITE4_AFF_NUMERIC
 ){

966 
aff
 = 
SQLITE4_AFF_REAL
;

967 }if–
h
==(('d'<<24)+('o'<<16)+('u'<<8)+'b')

968 && 
aff
==
SQLITE4_AFF_NUMERIC
 ){

969 
aff
 = 
SQLITE4_AFF_REAL
;

971 }if–(
h
&0x00FFFFFF)==(('i'<<16)+('n'<<8)+'t') ){

972 
aff
 = 
SQLITE4_AFF_INTEGER
;

977  
aff
;

978 
	}
}

989 
	$sqlôe4AddCﬁumnTy≥
(
P¨£
 *
pP¨£
, 
Tokí
 *
pTy≥
){

990 
TabÀ
 *
p
;

991 
Cﬁumn
 *
pCﬁ
;

993 
p
 = 
pP¨£
->
pNewTabÀ
;

994 if–
p
==0 || 
	`NEVER
’->
nCﬁ
<1) ) ;

995 
pCﬁ
 = &
p
->
aCﬁ
[p->
nCﬁ
-1];

996 
	`as£π
–
pCﬁ
->
zTy≥
==0 );

997 
pCﬁ
->
zTy≥
 = 
	`sqlôe4NameFromTokí
(
pP¨£
->
db
, 
pTy≥
);

998 
pCﬁ
->
afföôy
 = 
	`sqlôe4AfföôyTy≥
’Cﬁ->
zTy≥
);

999 
	}
}

1011 
	$sqlôe4AddDeÁu…VÆue
(
P¨£
 *
pP¨£
, 
Ex¥S∑n
 *
pS∑n
){

1012 
TabÀ
 *
p
;

1013 
Cﬁumn
 *
pCﬁ
;

1014 
sqlôe4
 *
db
 = 
pP¨£
->db;

1015 
p
 = 
pP¨£
->
pNewTabÀ
;

1016 if–
p
!=0 ){

1017 
pCﬁ
 = &(
p
->
aCﬁ
[p->
nCﬁ
-1]);

1018 if–!
	`sqlôe4Ex¥IsC⁄°™tOrFun˘i⁄
(
pS∑n
->
pEx¥
) ){

1019 
	`sqlôe4Eº‹Msg
(
pP¨£
, "default value of column [%s] isÇot constant",

1020 
pCﬁ
->
zName
);

1026 
	`sqlôe4Ex¥Dñëe
(
db
, 
pCﬁ
->
pDÊt
);

1027 
pCﬁ
->
pDÊt
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pS∑n
->
pEx¥
, 
EXPRDUP_REDUCE
);

1028 
	`sqlôe4DbFªe
(
db
, 
pCﬁ
->
zDÊt
);

1029 
pCﬁ
->
zDÊt
 = 
	`sqlôe4DbSåNDup
(
db
, (*)
pS∑n
->
zSèπ
,

1030 ()(
pS∑n
->
zEnd
 -ÖS∑n->
zSèπ
));

1033 
	`sqlôe4Ex¥Dñëe
(
db
, 
pS∑n
->
pEx¥
);

1034 
	}
}

1045 
	$sqlôe4AddPrim¨yKey
(

1046 
P¨£
 *
pP¨£
,

1047 
Ex¥Li°
 *
pLi°
,

1048 
⁄Eº‹
,

1049 
autoInc
,

1050 
s‹tOrdî


1052 
TabÀ
 *
pTab
 = 
pP¨£
->
pNewTabÀ
;

1053 
Index
 *
pPk
;

1054 *
zTy≥
 = 0;

1055 
iCﬁ
 = -1, 
i
;

1056 if–
pTab
==0 || 
IN_DECLARE_VTAB
 ) 
¥im¨y_key_exô
;

1057 if–
pTab
->
èbFœgs
 & 
TF_HasPrim¨yKey
 ){

1058 
	`sqlôe4Eº‹Msg
(
pP¨£
,

1059 "èbÀ \"%s\" ha†m‹êth™ o√Örim¨y key", 
pTab
->
zName
);

1060 
¥im¨y_key_exô
;

1062 
pTab
->
èbFœgs
 |
TF_HasPrim¨yKey
;

1063 if–
pLi°
==0 ){

1064 
iCﬁ
 = 
pTab
->
nCﬁ
 - 1;

1065 
pTab
->
aCﬁ
[
iCﬁ
].
iPrimKey
 = 1;

1066 
pTab
->
aCﬁ
[
iCﬁ
].
nŸNuŒ
 = 1;

1068 
i
=0; i<
pLi°
->
nEx¥
; i++){

1069 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁ
; iCol++){

1070 if–
	`sqlôe4_°ricmp
(
pLi°
->
a
[
i
].
zName
, 
pTab
->
aCﬁ
[
iCﬁ
].zName)==0 ){

1074 if–
iCﬁ
<
pTab
->
nCﬁ
 ){

1075 
pTab
->
aCﬁ
[
iCﬁ
].
iPrimKey
 = 
i
+1;

1076 
pTab
->
aCﬁ
[
iCﬁ
].
nŸNuŒ
 = 1;

1079 if–
pLi°
->
nEx¥
>1 ) 
iCﬁ
 = -1;

1081 
pPk
 = 
	`sqlôe4Cª©eIndex
(
pP¨£
, 0, 
pLi°
, 0, 
⁄Eº‹
, 0, 
s‹tOrdî
, 1);

1083 if–
iCﬁ
>=0 && iCﬁ<
pTab
->
nCﬁ


1084 && (
zTy≥
 = 
pTab
->
aCﬁ
[
iCﬁ
].zType)!=0

1085 && 
	`sqlôe4_°ricmp
(
zTy≥
, "INTEGER")==0

1086 && 
s‹tOrdî
==
SQLITE4_SO_ASC


1087 && 
pPk


1089 
pPk
->
fIndex
 |
IDX_I¡PK
;

1090 
	`as£π
–
autoInc
==0 ||áutoInc==1 );

1091 
pTab
->
èbFœgs
 |(-
autoInc
)&
TF_Autoö¸emít
;

1092 }if–
autoInc
 ){

1093 
	`sqlôe4Eº‹Msg
(
pP¨£
,

1096 
pLi°
 = 0;

1098 
¥im¨y_key_exô
:

1099 
	`sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
pLi°
);

1101 
	}
}

1106 
	$sqlôe4AddCheckC⁄°øöt
(

1107 
P¨£
 *
pP¨£
,

1108 
Ex¥
 *
pCheckEx¥


1110 
sqlôe4
 *
db
 = 
pP¨£
->db;

1111 #i‚de‡
SQLITE4_OMIT_CHECK


1112 
TabÀ
 *
pTab
 = 
pP¨£
->
pNewTabÀ
;

1113 if–
pTab
 && !
IN_DECLARE_VTAB
 ){

1114 
pTab
->
pCheck
 = 
	`sqlôe4Ex¥And
(
db
,ÖTab->pCheck, 
pCheckEx¥
);

1118 
	`sqlôe4Ex¥Dñëe
(
db
, 
pCheckEx¥
);

1120 
	}
}

1126 
	$sqlôe4AddCﬁœãTy≥
(
P¨£
 *
pP¨£
, 
Tokí
 *
pTokí
){

1127 
TabÀ
 *
p
;

1128 
i
;

1129 *
zCﬁl
;

1130 
sqlôe4
 *
db
;

1132 if–(
p
 = 
pP¨£
->
pNewTabÀ
)==0 ) ;

1133 
i
 = 
p
->
nCﬁ
-1;

1134 
db
 = 
pP¨£
->db;

1135 
zCﬁl
 = 
	`sqlôe4NameFromTokí
(
db
, 
pTokí
);

1136 if–!
zCﬁl
 ) ;

1138 if–
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
zCﬁl
) ){

1139 
Index
 *
pIdx
;

1140 
p
->
aCﬁ
[
i
].
zCﬁl
 = zColl;

1146 
pIdx
=
p
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

1147 
	`as£π
–
pIdx
->
nCﬁumn
==1 );

1148 if–
pIdx
->
aiCﬁumn
[0]==
i
 ){

1149 
pIdx
->
azCﬁl
[0] = 
p
->
aCﬁ
[
i
].
zCﬁl
;

1153 
	`sqlôe4DbFªe
(
db
, 
zCﬁl
);

1155 
	}
}

1177 
CﬁlSeq
 *
	$sqlôe4LoˇãCﬁlSeq
(
P¨£
 *
pP¨£
, c⁄° *
zName
){

1178 
sqlôe4
 *
db
 = 
pP¨£
->db;

1179 
u8
 
öôbusy
 = 
db
->
öô
.
busy
;

1180 
CﬁlSeq
 *
pCﬁl
;

1182 
pCﬁl
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zName
, 
öôbusy
);

1183 if–!
öôbusy
 && (!
pCﬁl
 || !pCﬁl->
xCmp
) ){

1184 
pCﬁl
 = 
	`sqlôe4GëCﬁlSeq
(
db
,ÖCﬁl, 
zName
);

1185 if–!
pCﬁl
 ){

1186 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuch cﬁœti⁄ sequí˚: %s", 
zName
);

1190  
pCﬁl
;

1191 
	}
}

1210 
	$sqlôe4Ch™geCookõ
(
P¨£
 *
pP¨£
, 
iDb
){

1211 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1212 
sqlôe4
 *
db
 = 
pP¨£
->db;

1213 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1214 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
db
->
aDb
[
iDb
].
pSchema
->
schema_cookõ
+1, 
r1
);

1215 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_SëCookõ
, 
iDb
, 0, 
r1
);

1216 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

1217 
	}
}

1227 
	$idítLígth
(c⁄° *
z
){

1228 
n
;

1229 
n
=0; *
z
;Ç++, z++){

1230 if–*
z
=='"' ){ 
n
++; }

1232  
n
 + 2;

1233 
	}
}

1248 
	$idítPut
(*
z
, *
pIdx
, *
zSig√dIdít
){

1249 *
zIdít
 = (*)
zSig√dIdít
;

1250 
i
, 
j
, 
√edQuŸe
;

1251 
i
 = *
pIdx
;

1253 
j
=0; 
zIdít
[j]; j++){

1254 if–!
	`sqlôe4Iß um
(
zIdít
[
j
]) && zIdent[j]!='_' ) ;

1256 
√edQuŸe
 = 
	`sqlôe4Isdigô
(
zIdít
[0]Ë|| 
	`sqlôe4Keyw‹dCode
(zIdít, 
j
)!=
TK_ID
;

1257 if–!
√edQuŸe
 ){

1258 
√edQuŸe
 = 
zIdít
[
j
];

1261 if–
√edQuŸe
 ) 
z
[
i
++] = '"';

1262 
j
=0; 
zIdít
[j]; j++){

1263 
z
[
i
++] = 
zIdít
[
j
];

1264 if–
zIdít
[
j
]=='"' ) 
z
[
i
++] = '"';

1266 if–
√edQuŸe
 ) 
z
[
i
++] = '"';

1267 
z
[
i
] = 0;

1268 *
pIdx
 = 
i
;

1269 
	}
}

1276 *
	$¸óãTabÀStmt
(
sqlôe4
 *
db
, 
TabÀ
 *
p
){

1277 
i
, 
k
, 
n
;

1278 *
zStmt
;

1279 *
zSï
, *
zSï2
, *
zEnd
;

1280 
Cﬁumn
 *
pCﬁ
;

1281 
n
 = 0;

1282 
pCﬁ
 = 
p
->
aCﬁ
, 
i
=0; i<p->
nCﬁ
; i++,ÖCol++){

1283 
n
 +
	`idítLígth
(
pCﬁ
->
zName
) + 5;

1285 
n
 +
	`idítLígth
(
p
->
zName
);

1286 if–
n
<50 ){

1287 
zSï
 = "";

1288 
zSï2
 = ",";

1289 
zEnd
 = ")";

1291 
zSï
 = "\n ";

1292 
zSï2
 = ",\n ";

1293 
zEnd
 = "\n)";

1295 
n
 +35 + 6*
p
->
nCﬁ
;

1296 
zStmt
 = 
	`sqlôe4DbMÆlocRaw
(0, 
n
);

1297 if–
zStmt
==0 ){

1298 
db
->
mÆlocFaûed
 = 1;

1301 
k
 = 
	`sqlôe4_¢¥ötf
(
zStmt
, 
n
, "CREATE TABLE ");

1302 
	`idítPut
(
zStmt
, &
k
, 
p
->
zName
);

1303 
zStmt
[
k
++] = '(';

1304 
pCﬁ
=
p
->
aCﬁ
, 
i
=0; i<p->
nCﬁ
; i++,ÖCol++){

1305 c⁄° * c⁄° 
azTy≥
[] = {

1312 
Àn
;

1313 c⁄° *
zTy≥
;

1315 
k
 +
	`sqlôe4_¢¥ötf
(&
zStmt
[k], 
n
-k, 
zSï
);

1316 
zSï
 = 
zSï2
;

1317 
	`idítPut
(
zStmt
, &
k
, 
pCﬁ
->
zName
);

1318 
	`as£π
–
pCﬁ
->
afföôy
-
SQLITE4_AFF_TEXT
 >= 0 );

1319 
	`as£π
–
pCﬁ
->
afföôy
-
SQLITE4_AFF_TEXT
 < 
	`AºaySize
(
azTy≥
) );

1320 
	`ã°ˇ£
–
pCﬁ
->
afföôy
==
SQLITE4_AFF_TEXT
 );

1321 
	`ã°ˇ£
–
pCﬁ
->
afföôy
==
SQLITE4_AFF_NONE
 );

1322 
	`ã°ˇ£
–
pCﬁ
->
afföôy
==
SQLITE4_AFF_NUMERIC
 );

1323 
	`ã°ˇ£
–
pCﬁ
->
afföôy
==
SQLITE4_AFF_INTEGER
 );

1324 
	`ã°ˇ£
–
pCﬁ
->
afföôy
==
SQLITE4_AFF_REAL
 );

1326 
zTy≥
 = 
azTy≥
[
pCﬁ
->
afföôy
 - 
SQLITE4_AFF_TEXT
];

1327 
Àn
 = 
	`sqlôe4SåÀn30
(
zTy≥
);

1328 
	`as£π
–
pCﬁ
->
afföôy
==
SQLITE4_AFF_NONE


1329 || 
pCﬁ
->
afföôy
==
	`sqlôe4AfföôyTy≥
(
zTy≥
) );

1330 
	`mem˝y
(&
zStmt
[
k
], 
zTy≥
, 
Àn
);

1331 
k
 +
Àn
;

1332 
	`as£π
–
k
<=
n
 );

1334 
	`sqlôe4_¢¥ötf
(&
zStmt
[
k
], 
n
-k, "%s", 
zEnd
);

1335  
zStmt
;

1336 
	}
}

1338 
Index
 *
	$√wIndex
(

1339 
P¨£
 *
pP¨£
,

1340 
TabÀ
 *
pTab
,

1341 c⁄° *
zName
,

1342 
nCﬁ
,

1343 
nCovî
,

1344 
⁄Eº‹
,

1345 
nExåa
,

1346 **
pzExåa


1348 
sqlôe4
 *
db
 = 
pP¨£
->db;

1349 
Index
 *
pIndex
;

1350 *
zExåa
 = 0;

1351 
nName
;

1354 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

1355 
pIndex
 = 
	`sqlôe4DbMÆlocZîo
(
db
,

1356 
	`ROUND8
((
Index
)) +

1357 
	`ROUND8
((
tRow˙t
)*(
nCﬁ
+1)) +

1358 (*)*
nCﬁ
 +

1359 ()*
nCﬁ
 +

1360 ()*
nCovî
 +

1361 (
u8
)*
nCﬁ
 +

1362 
nName
 + 1 +

1363 
nExåa


1365 
	`as£π
–
pIndex
 || 
db
->
mÆlocFaûed
 );

1367 if–
pIndex
 ){

1368 
zExåa
 = (*)
pIndex
;

1369 
pIndex
->
aiRowE°
 = (
tRow˙t
*)&
zExåa
[
	`ROUND8
((
Index
))];

1370 
pIndex
->
azCﬁl
 = (**)

1371 ((*)
pIndex
->
aiRowE°
 + 
	`ROUND8
((
tRow˙t
)*
nCﬁ
+1));

1372 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pIndex
->
aiRowE°
) );

1373 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pIndex
->
azCﬁl
) );

1374 
pIndex
->
aiCﬁumn
 = (*)(&pIndex->
azCﬁl
[
nCﬁ
]);

1375 
pIndex
->
aiCovî
 = (*)(&pIndex->
aiCﬁumn
[
nCﬁ
]);

1376 
pIndex
->
aS‹tOrdî
 = (
u8
 *)(&pIndex->
aiCovî
[
nCovî
]);

1377 
pIndex
->
zName
 = (*)(&pIndex->
aS‹tOrdî
[
nCﬁ
]);

1378 
zExåa
 = (*)(&
pIndex
->
zName
[
nName
+1]);

1379 
	`mem˝y
(
pIndex
->
zName
, zName, 
nName
+1);

1380 
pIndex
->
pTabÀ
 = 
pTab
;

1381 
pIndex
->
nCﬁumn
 = 
nCﬁ
;

1382 
pIndex
->
nCovî
 =ÇCover;

1383 
pIndex
->
⁄Eº‹
 = (
u8
)onError;

1384 
pIndex
->
pSchema
 = 
pTab
->pSchema;

1387 *
pzExåa
 = 
zExåa
;

1388  
pIndex
;

1389 
	}
}

1391 
	$addIndexToHash
(
sqlôe4
 *
db
, 
Index
 *
pIdx
){

1392 if–
db
->
öô
.
busy
 ){

1393 
Hash
 *
pIdxHash
 = &
pIdx
->
pSchema
->
idxHash
;

1394 
nName
 = 
	`sqlôe4SåÀn30
(
pIdx
->
zName
);

1395 
Index
 *
p
;

1396 
p
 = 
	`sqlôe4HashIn£π
(
pIdxHash
, 
pIdx
->
zName
, 
nName
,ÖIdx);

1397 if–
p
 ){

1398 
	`as£π
–
p
==
pIdx
 );

1399 
db
->
mÆlocFaûed
 = 1;

1400  
SQLITE4_NOMEM
;

1403  
SQLITE4_OK
;

1404 
	}
}

1412 
	$addIm∂icôPrim¨yKey
(

1413 
P¨£
 *
pP¨£
,

1414 
TabÀ
 *
pTab
,

1415 
iDb


1417 
sqlôe4
 *
db
 = 
pP¨£
->db;

1418 
Index
 *
pIndex
;

1419 *
zExåa
;

1421 
	`as£π
–!
pTab
->
pIndex
 ||ÖTab->pIndex->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 );

1422 
	`as£π
–
	`sqlôe4SåÀn30
("binary")==6 );

1423 
pIndex
 = 
	`√wIndex
(
pP¨£
, 
pTab
,ÖTab->
zName
, 1, 0, 
OE_Ab‹t
, 1+6, &
zExåa
);

1424 if–
pIndex
 && 
	`addIndexToHash
(
db
,ÖIndex) ){

1425 
	`sqlôe4DbFªe
(
db
, 
pIndex
);

1426 
pIndex
 = 0;

1428 if–
pIndex
 ){

1429 
pIndex
->
aiCﬁumn
[0] = -1;

1430 
pIndex
->
azCﬁl
[0] = 
zExåa
;

1431 
	`mem˝y
(
zExåa
, "binary", 7);

1432 
pIndex
->
eIndexTy≥
 = 
SQLITE4_INDEX_PRIMARYKEY
;

1433 
pIndex
->
pNext
 = 
pTab
->pIndex;

1434 
pTab
->
pIndex
 =ÖIndex;

1435 
	`sqlôe4DeÁu…RowE°
(
pIndex
);

1436 
pTab
->
èbFœgs
 |
TF_HasPrim¨yKey
;

1438 if–
db
->
öô
.
busy
 ){

1439 
pIndex
->
äum
 = 
db
->
öô
.
√wTnum
;

1441 
pIndex
->
äum
 = ++
pP¨£
->
nMem
;

1442 
	`ÆloˇãTabÀNumbî
(
pP¨£
, 
iDb
, 
pIndex
->
äum
);

1445 
	}
}

1467 
	$sqlôe4EndTabÀ
(

1468 
P¨£
 *
pP¨£
,

1469 
Tokí
 *
pC⁄s
,

1470 
Tokí
 *
pEnd
,

1471 
Sñe˘
 *
pSñe˘


1473 
TabÀ
 *
p
;

1474 
sqlôe4
 *
db
 = 
pP¨£
->db;

1475 
iDb
;

1476 
iPkRoŸ
 = 0;

1478 if–(
pEnd
==0 && 
pSñe˘
==0Ë|| 
db
->
mÆlocFaûed
 ){

1481 
p
 = 
pP¨£
->
pNewTabÀ
;

1482 if–
p
==0 ) ;

1484 
	`as£π
–!
db
->
öô
.
busy
 || !
pSñe˘
 );

1485 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
p
->
pSchema
);

1487 if–!
	`IsVõw
(
p
) ){

1488 
Index
 *
pPk
;

1489 if–0==(
p
->
èbFœgs
 & 
TF_HasPrim¨yKey
) ){

1493 
	`addIm∂icôPrim¨yKey
(
pP¨£
, 
p
, 
iDb
);

1495 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
p
, 0);

1496 
	`as£π
–
pPk
 || 
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 );

1497 if–
pPk
 ){

1498 
iPkRoŸ
 = 
pPk
->
äum
;

1499 if–
pP¨£
->
pPKRoŸ
 ){

1504 *
pP¨£
->
pPKRoŸ
 = 
iPkRoŸ
;

1509 #i‚de‡
SQLITE4_OMIT_CHECK


1512 if–
p
->
pCheck
 ){

1513 
SrcLi°
 
sSrc
;

1514 
NameC⁄ãxt
 
sNC
;

1516 
	`mem£t
(&
sNC
, 0, (sNC));

1517 
	`mem£t
(&
sSrc
, 0, (sSrc));

1518 
sSrc
.
nSrc
 = 1;

1519 
sSrc
.
a
[0].
zName
 = 
p
->zName;

1520 
sSrc
.
a
[0].
pTab
 = 
p
;

1521 
sSrc
.
a
[0].
iCurs‹
 = -1;

1522 
sNC
.
pP¨£
 =ÖParse;

1523 
sNC
.
pSrcLi°
 = &
sSrc
;

1524 
sNC
.
isCheck
 = 1;

1525 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
p
->
pCheck
) ){

1537 if–!
db
->
öô
.
busy
 ){

1538 
n
;

1539 
Vdbe
 *
v
;

1540 *
zTy≥
;

1541 *
zTy≥2
;

1542 *
zStmt
;

1544 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1545 if–
	`NEVER
(
v
==0) ) ;

1547 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 0);

1552 if–
p
->
pSñe˘
==0 ){

1554 
zTy≥
 = "table";

1555 
zTy≥2
 = "TABLE";

1556 #i‚de‡
SQLITE4_OMIT_VIEW


1559 
zTy≥
 = "view";

1560 
zTy≥2
 = "VIEW";

1572 if–
pSñe˘
 ){

1573 
Sñe˘De°
 
de°
;

1574 
TabÀ
 *
pSñTab
;

1576 
	`as£π
(
pP¨£
->
nTab
==1);

1577 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_O≥nWrôe
, 1, 
iPkRoŸ
, 
iDb
);

1578 
	`sqlôe4VdbeCh™geP5
(
v
, 1);

1579 
pP¨£
->
nTab
 = 2;

1580 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 
SRT_TabÀ
, 1);

1581 
	`sqlôe4Sñe˘
(
pP¨£
, 
pSñe˘
, &
de°
);

1582 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 1);

1583 if–
pP¨£
->
nEº
==0 ){

1584 
pSñTab
 = 
	`sqlôe4Resu…SëOfSñe˘
(
pP¨£
, 
pSñe˘
);

1585 if–
pSñTab
==0 ) ;

1586 
	`as£π
–
p
->
aCﬁ
==0 );

1587 
p
->
nCﬁ
 = 
pSñTab
->nCol;

1588 
p
->
aCﬁ
 = 
pSñTab
->aCol;

1589 
pSñTab
->
nCﬁ
 = 0;

1590 
pSñTab
->
aCﬁ
 = 0;

1591 
	`sqlôe4DñëeTabÀ
(
db
, 
pSñTab
);

1596 if–
pSñe˘
 ){

1597 
zStmt
 = 
	`¸óãTabÀStmt
(
db
, 
p
);

1599 
n
 = ()(
pEnd
->
z
 - 
pP¨£
->
sNameTokí
.z) + 1;

1600 
zStmt
 = 
	`sqlôe4MPrötf
(
db
,

1601 "CREATE %†%.*s", 
zTy≥2
, 
n
, 
pP¨£
->
sNameTokí
.
z


1609 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

1613 
db
->
aDb
[
iDb
].
zName
, 
	`SCHEMA_TABLE
(iDb),

1614 
zTy≥
,

1615 
p
->
zName
,

1616 
p
->
zName
,

1617 (
iPkRoŸ
 ? "#" : ""), iPkRoot,

1618 
zStmt
,

1619 
pP¨£
->
ªgRowid


1621 
	`sqlôe4DbFªe
(
db
, 
zStmt
);

1622 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

1624 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


1628 if–
p
->
èbFœgs
 & 
TF_Autoö¸emít
 ){

1629 
Db
 *
pDb
 = &
db
->
aDb
[
iDb
];

1630 if–
pDb
->
pSchema
->
pSeqTab
==0 ){

1631 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

1633 
pDb
->
zName


1640 
	`sqlôe4VdbeAddP¨£SchemaOp
(
v
, 
iDb
,

1641 
	`sqlôe4MPrötf
(
db
, "tbl_«me='%q'", 
p
->
zName
));

1647 if–
db
->
öô
.
busy
 ){

1648 
TabÀ
 *
pOld
;

1649 
Schema
 *
pSchema
 = 
p
->pSchema;

1650 
pOld
 = 
	`sqlôe4HashIn£π
(&
pSchema
->
tblHash
, 
p
->
zName
,

1651 
	`sqlôe4SåÀn30
(
p
->
zName
),p);

1652 if–
pOld
 ){

1653 
	`as£π
–
p
==
pOld
 );

1654 
db
->
mÆlocFaûed
 = 1;

1657 
pP¨£
->
pNewTabÀ
 = 0;

1658 
db
->
nTabÀ
++;

1659 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

1661 #i‚de‡
SQLITE4_OMIT_ALTERTABLE


1662 if–!
p
->
pSñe˘
 ){

1663 c⁄° *
zName
 = (c⁄° *)
pP¨£
->
sNameTokí
.
z
;

1664 
nName
;

1665 
	`as£π
–!
pSñe˘
 && 
pC⁄s
 && 
pEnd
 );

1666 if–
pC⁄s
->
z
==0 ){

1667 
pC⁄s
 = 
pEnd
;

1669 
nName
 = ()((c⁄° *)
pC⁄s
->
z
 - 
zName
);

1670 
p
->
addCﬁOff£t
 = 13 + 
	`sqlôe4Utf8Ch¨Lí
(
zName
, 
nName
);

1674 
	}
}

1676 #i‚de‡
SQLITE4_OMIT_VIEW


1680 
	$sqlôe4Cª©eVõw
(

1681 
P¨£
 *
pP¨£
,

1682 
Tokí
 *
pBegö
,

1683 
Tokí
 *
pName1
,

1684 
Tokí
 *
pName2
,

1685 
Sñe˘
 *
pSñe˘
,

1686 
isTemp
,

1687 
noEº


1689 
TabÀ
 *
p
;

1690 
n
;

1691 c⁄° *
z
;

1692 
Tokí
 
sEnd
;

1693 
DbFixî
 
sFix
;

1694 
Tokí
 *
pName
 = 0;

1695 
iDb
;

1696 
sqlôe4
 *
db
 = 
pP¨£
->db;

1698 if–
pP¨£
->
nV¨
>0 ){

1699 
	`sqlôe4Eº‹Msg
(
pP¨£
, "parametersáreÇotállowed in views");

1700 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

1703 
	`sqlôe4SèπTabÀ
(
pP¨£
, 
pName1
, 
pName2
, 
isTemp
, 1, 0, 
noEº
);

1704 
p
 = 
pP¨£
->
pNewTabÀ
;

1705 if–
p
==0 || 
pP¨£
->
nEº
 ){

1706 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

1709 
	`sqlôe4TwoP¨tName
(
pP¨£
, 
pName1
, 
pName2
, &
pName
);

1710 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
p
->
pSchema
);

1711 if–
	`sqlôe4FixInô
(&
sFix
, 
pP¨£
, 
iDb
, "võw", 
pName
)

1712 && 
	`sqlôe4FixSñe˘
(&
sFix
, 
pSñe˘
)

1714 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

1723 
p
->
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
,ÖSñe˘, 
EXPRDUP_REDUCE
);

1724 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

1725 if–
db
->
mÆlocFaûed
 ){

1728 if–!
db
->
öô
.
busy
 ){

1729 
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
, 
p
);

1735 
sEnd
 = 
pP¨£
->
sLa°Tokí
;

1736 if–
	`ALWAYS
(
sEnd
.
z
[0]!=0) && sEnd.z[0]!=';' ){

1737 
sEnd
.
z
 +sEnd.
n
;

1739 
sEnd
.
n
 = 0;

1740 
n
 = ()(
sEnd
.
z
 - 
pBegö
->z);

1741 
z
 = 
pBegö
->z;

1742  
	`ALWAYS
(
n
>0Ë&& 
	`sqlôe4Is•a˚
(
z
[n-1]) ){Ç--; }

1743 
sEnd
.
z
 = &z[
n
-1];

1744 
sEnd
.
n
 = 1;

1747 
	`sqlôe4EndTabÀ
(
pP¨£
, 0, &
sEnd
, 0);

1749 
	}
}

1752 #i‡!
deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed(
SQLITE4_OMIT_VIRTUALTABLE
)

1758 
	$sqlôe4VõwGëCﬁumnNames
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTabÀ
){

1759 
TabÀ
 *
pSñTab
;

1760 
Sñe˘
 *
pSñ
;

1761 
nEº
 = 0;

1762 
n
;

1763 
sqlôe4
 *
db
 = 
pP¨£
->db;

1764 
Auth‹izî
 *
pAuth
;

1766 
	`as£π
–
pTabÀ
 );

1768 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1769 if–
	`sqlôe4VèbCÆlC⁄√˘
(
pP¨£
, 
pTabÀ
) ){

1770  
SQLITE4_ERROR
;

1772 if–
	`IsVútuÆ
(
pTabÀ
) )  0;

1775 #i‚de‡
SQLITE4_OMIT_VIEW


1779 if–
pTabÀ
->
nCﬁ
>0 )  0;

1796 if–
pTabÀ
->
nCﬁ
<0 ){

1797 
	`sqlôe4Eº‹Msg
(
pP¨£
, "võw %†i†cúcuœæy deföed", 
pTabÀ
->
zName
);

1800 
	`as£π
–
pTabÀ
->
nCﬁ
>=0 );

1809 
	`as£π
–
pTabÀ
->
pSñe˘
 );

1810 
pSñ
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
pTabÀ
->
pSñe˘
, 0);

1811 if–
pSñ
 ){

1812 
u8
 
íabÀLookaside
 = 
db
->
lookaside
.
bE«bÀd
;

1813 
n
 = 
pP¨£
->
nTab
;

1814 
	`sqlôe4SrcLi°AssignCurs‹s
(
pP¨£
, 
pSñ
->
pSrc
);

1815 
pTabÀ
->
nCﬁ
 = -1;

1816 
db
->
lookaside
.
bE«bÀd
 = 0;

1817 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


1818 
pAuth
 = 
db
->pAuth;

1819 
db
->
pAuth
 = 0;

1820 
pSñTab
 = 
	`sqlôe4Resu…SëOfSñe˘
(
pP¨£
, 
pSñ
);

1821 
db
->
pAuth
 =ÖAuth;

1823 
pSñTab
 = 
	`sqlôe4Resu…SëOfSñe˘
(
pP¨£
, 
pSñ
);

1825 
db
->
lookaside
.
bE«bÀd
 = 
íabÀLookaside
;

1826 
pP¨£
->
nTab
 = 
n
;

1827 if–
pSñTab
 ){

1828 
	`as£π
–
pTabÀ
->
aCﬁ
==0 );

1829 
pTabÀ
->
nCﬁ
 = 
pSñTab
->nCol;

1830 
pTabÀ
->
aCﬁ
 = 
pSñTab
->aCol;

1831 
pSñTab
->
nCﬁ
 = 0;

1832 
pSñTab
->
aCﬁ
 = 0;

1833 
	`sqlôe4DñëeTabÀ
(
db
, 
pSñTab
);

1834 
pTabÀ
->
pSchema
->
Êags
 |
DB_Uƒe£tVõws
;

1836 
pTabÀ
->
nCﬁ
 = 0;

1837 
nEº
++;

1839 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñ
);

1841 
nEº
++;

1844  
nEº
;

1845 
	}
}

1848 #i‚de‡
SQLITE4_OMIT_VIEW


1852 
	$sqlôeVõwRe£tAŒ
(
sqlôe4
 *
db
, 
idx
){

1853 
HashEÀm
 *
i
;

1854 if–!
	`DbHasPr›îty
(
db
, 
idx
, 
DB_Uƒe£tVõws
) ) ;

1855 
i
=
	`sqlôeHashFú°
(&
db
->
aDb
[
idx
].
pSchema
->
tblHash
); i;i=
	`sqlôeHashNext
(i)){

1856 
TabÀ
 *
pTab
 = 
	`sqlôeHashD©a
(
i
);

1857 if–
pTab
->
pSñe˘
 ){

1858 
	`sqlôeDñëeCﬁumnNames
(
db
, 
pTab
);

1859 
pTab
->
aCﬁ
 = 0;

1860 
pTab
->
nCﬁ
 = 0;

1863 
	`DbCÀ¨Pr›îty
(
db
, 
idx
, 
DB_Uƒe£tVõws
);

1864 
	}
}

1866 
	#sqlôeVõwRe£tAŒ
(
A
,
B
)

	)

1876 
	$de°royRoŸPage
(
P¨£
 *
pP¨£
, 
iTabÀ
, 
iDb
){

1877 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1878 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_CÀ¨
, 
iTabÀ
, 
iDb
);

1880 
	`sqlôe4MayAb‹t
(
pP¨£
);

1882 
	}
}

1890 
	$de°royTabÀ
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
){

1891 
Index
 *
pIdx
;

1892 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

1893 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

1894 
	`de°royRoŸPage
(
pP¨£
, 
pIdx
->
äum
, 
iDb
);

1896 
	}
}

1902 
	$sqlôe4CÀ¨SètTabÀs
(

1903 
P¨£
 *
pP¨£
,

1904 
iDb
,

1905 c⁄° *
zTy≥
,

1906 c⁄° *
zName


1908 
i
;

1909 c⁄° *
zDbName
 = 
pP¨£
->
db
->
aDb
[
iDb
].
zName
;

1910 
i
=1; i<=3; i++){

1911 
zTab
[24];

1912 
	`sqlôe4_¢¥ötf
(
zTab
,(zTab),"sqlôe_°©%d",
i
);

1913 if–
	`sqlôe4FödTabÀ
(
pP¨£
->
db
, 
zTab
, 
zDbName
) ){

1914 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

1916 
zDbName
, 
zTab
, 
zTy≥
, 
zName


1920 
	}
}

1925 
	$sqlôe4CodeDr›TabÀ
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, 
iDb
, 
isVõw
){

1926 
Vdbe
 *
v
;

1927 
sqlôe4
 *
db
 = 
pP¨£
->db;

1928 
Triggî
 *
pTriggî
;

1929 
Db
 *
pDb
 = &
db
->
aDb
[
iDb
];

1931 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1932 
	`as£π
–
v
!=0 );

1933 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 1, 
iDb
);

1935 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1936 if–
	`IsVútuÆ
(
pTab
) ){

1937 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_VBegö
);

1945 
pTriggî
 = 
	`sqlôe4TriggîLi°
(
pP¨£
, 
pTab
);

1946  
pTriggî
 ){

1947 
	`as£π
–
pTriggî
->
pSchema
==
pTab
->pSchema ||

1948 
pTriggî
->
pSchema
==
db
->
aDb
[1].pSchema );

1949 
	`sqlôe4Dr›TriggîPå
(
pP¨£
, 
pTriggî
);

1950 
pTriggî
 =ÖTriggî->
pNext
;

1953 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


1959 if–
pTab
->
èbFœgs
 & 
TF_Autoö¸emít
 ){

1960 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

1962 
pDb
->
zName
, 
pTab
->zName

1974 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

1976 
pDb
->
zName
, 
	`SCHEMA_TABLE
(
iDb
), 
pTab
->zName);

1977 if–!
isVõw
 && !
	`IsVútuÆ
(
pTab
) ){

1978 
	`de°royTabÀ
(
pP¨£
, 
pTab
);

1984 if–
	`IsVútuÆ
(
pTab
) ){

1985 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VDe°roy
, 
iDb
, 0, 0, 
pTab
->
zName
, 0);

1987 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Dr›TabÀ
, 
iDb
, 0, 0, 
pTab
->
zName
, 0);

1988 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

1989 
	`sqlôeVõwRe£tAŒ
(
db
, 
iDb
);

1990 
	}
}

1996 
	$sqlôe4Dr›TabÀ
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pName
, 
isVõw
, 
noEº
){

1997 
TabÀ
 *
pTab
;

1998 
Vdbe
 *
v
;

1999 
sqlôe4
 *
db
 = 
pP¨£
->db;

2000 
iDb
;

2002 if–
db
->
mÆlocFaûed
 ){

2003 
exô_dr›_èbÀ
;

2005 
	`as£π
–
pP¨£
->
nEº
==0 );

2006 
	`as£π
–
pName
->
nSrc
==1 );

2007 if–
noEº
 ) 
db
->
suµªssEº
++;

2008 
pTab
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 
isVõw
,

2009 
pName
->
a
[0].
zName
,ÖName->a[0].
zD©aba£
);

2010 if–
noEº
 ) 
db
->
suµªssEº
--;

2012 if–
pTab
==0 ){

2013 if–
noEº
 ) 
	`sqlôe4CodeVîifyNamedSchema
(
pP¨£
, 
pName
->
a
[0].
zD©aba£
);

2014 
exô_dr›_èbÀ
;

2016 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

2017 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

2022 if–
	`IsVútuÆ
(
pTab
Ë&& 
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
,ÖTab) ){

2023 
exô_dr›_èbÀ
;

2025 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


2027 
code
;

2028 c⁄° *
zTab
 = 
	`SCHEMA_TABLE
(
iDb
);

2029 c⁄° *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

2030 c⁄° *
zArg2
 = 0;

2031 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_DELETE
, 
zTab
, 0, 
zDb
)){

2032 
exô_dr›_èbÀ
;

2034 if–
isVõw
 ){

2035 if–!
OMIT_TEMPDB
 && 
iDb
==1 ){

2036 
code
 = 
SQLITE4_DROP_TEMP_VIEW
;

2038 
code
 = 
SQLITE4_DROP_VIEW
;

2040 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


2041 }if–
	`IsVútuÆ
(
pTab
) ){

2042 
code
 = 
SQLITE4_DROP_VTABLE
;

2043 
zArg2
 = 
	`sqlôe4GëVTabÀ
(
db
, 
pTab
)->
pMod
->
zName
;

2046 if–!
OMIT_TEMPDB
 && 
iDb
==1 ){

2047 
code
 = 
SQLITE4_DROP_TEMP_TABLE
;

2049 
code
 = 
SQLITE4_DROP_TABLE
;

2052 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
code
, 
pTab
->
zName
, 
zArg2
, 
zDb
) ){

2053 
exô_dr›_èbÀ
;

2055 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_DELETE
, 
pTab
->
zName
, 0, 
zDb
) ){

2056 
exô_dr›_èbÀ
;

2060 if–
	`sqlôe4_°∫icmp
(
pTab
->
zName
, "sqlite_", 7)==0

2061 && 
	`sqlôe4_°∫icmp
(
pTab
->
zName
, "sqlite_stat", 11)!=0 ){

2062 
	`sqlôe4Eº‹Msg
(
pP¨£
, "èbÀ %†mayÇŸ bêdr›≥d", 
pTab
->
zName
);

2063 
exô_dr›_èbÀ
;

2066 #i‚de‡
SQLITE4_OMIT_VIEW


2070 if–
isVõw
 && 
pTab
->
pSñe˘
==0 ){

2071 
	`sqlôe4Eº‹Msg
(
pP¨£
, "u£ DROP TABLEÅÿdñëêèbÀ %s", 
pTab
->
zName
);

2072 
exô_dr›_èbÀ
;

2074 if–!
isVõw
 && 
pTab
->
pSñe˘
 ){

2075 
	`sqlôe4Eº‹Msg
(
pP¨£
, "u£ DROP VIEWÅÿdñëêvõw %s", 
pTab
->
zName
);

2076 
exô_dr›_èbÀ
;

2083 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

2084 if–
v
 ){

2085 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 1, 
iDb
);

2086 
	`sqlôe4CÀ¨SètTabÀs
(
pP¨£
, 
iDb
, "tbl", 
pTab
->
zName
);

2087 
	`sqlôe4FkDr›TabÀ
(
pP¨£
, 
pName
, 
pTab
);

2088 
	`sqlôe4CodeDr›TabÀ
(
pP¨£
, 
pTab
, 
iDb
, 
isVõw
);

2091 
exô_dr›_èbÀ
:

2092 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pName
);

2093 
	}
}

2111 
	$sqlôe4Cª©eF‹eignKey
(

2112 
P¨£
 *
pP¨£
,

2113 
Ex¥Li°
 *
pFromCﬁ
,

2114 
Tokí
 *
pTo
,

2115 
Ex¥Li°
 *
pToCﬁ
,

2116 
Êags


2118 
sqlôe4
 *
db
 = 
pP¨£
->db;

2119 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


2120 
FKey
 *
pFKey
 = 0;

2121 
FKey
 *
pNextTo
;

2122 
TabÀ
 *
p
 = 
pP¨£
->
pNewTabÀ
;

2123 
nByã
;

2124 
i
;

2125 
nCﬁ
;

2126 *
z
;

2128 
	`as£π
–
pTo
!=0 );

2129 if–
p
==0 || 
IN_DECLARE_VTAB
 ) 
fk_íd
;

2130 if–
pFromCﬁ
==0 ){

2131 
iCﬁ
 = 
p
->
nCﬁ
-1;

2132 if–
	`NEVER
(
iCﬁ
<0ËË
fk_íd
;

2133 if–
pToCﬁ
 &&ÖToCﬁ->
nEx¥
!=1 ){

2134 
	`sqlôe4Eº‹Msg
(
pP¨£
, "foreign key on %s"

2136 
p
->
aCﬁ
[
iCﬁ
].
zName
, 
pTo
);

2137 
fk_íd
;

2139 
nCﬁ
 = 1;

2140 }if–
pToCﬁ
 &&ÖToCﬁ->
nEx¥
!=
pFromCﬁ
->nExpr ){

2141 
	`sqlôe4Eº‹Msg
(
pP¨£
,

2144 
fk_íd
;

2146 
nCﬁ
 = 
pFromCﬁ
->
nEx¥
;

2148 
nByã
 = (*
pFKey
Ë+ (
nCﬁ
-1)*’FKey->
aCﬁ
[0]Ë+ 
pTo
->
n
 + 1;

2149 if–
pToCﬁ
 ){

2150 
i
=0; i<
pToCﬁ
->
nEx¥
; i++){

2151 
nByã
 +
	`sqlôe4SåÀn30
(
pToCﬁ
->
a
[
i
].
zName
) + 1;

2154 
pFKey
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
 );

2155 if–
pFKey
==0 ){

2156 
fk_íd
;

2158 
pFKey
->
pFrom
 = 
p
;

2159 
pFKey
->
pNextFrom
 = 
p
->pFKey;

2160 
z
 = (*)&
pFKey
->
aCﬁ
[
nCﬁ
];

2161 
pFKey
->
zTo
 = 
z
;

2162 
	`mem˝y
(
z
, 
pTo
->z,ÖTo->
n
);

2163 
z
[
pTo
->
n
] = 0;

2164 
	`sqlôe4DequŸe
(
z
);

2165 
z
 +
pTo
->
n
+1;

2166 
pFKey
->
nCﬁ
 =ÇCol;

2167 if–
pFromCﬁ
==0 ){

2168 
pFKey
->
aCﬁ
[0].
iFrom
 = 
p
->
nCﬁ
-1;

2170 
i
=0; i<
nCﬁ
; i++){

2171 
j
;

2172 
j
=0; j<
p
->
nCﬁ
; j++){

2173 if–
	`sqlôe4_°ricmp
(
p
->
aCﬁ
[
j
].
zName
, 
pFromCﬁ
->
a
[
i
].zName)==0 ){

2174 
pFKey
->
aCﬁ
[
i
].
iFrom
 = 
j
;

2178 if–
j
>=
p
->
nCﬁ
 ){

2179 
	`sqlôe4Eº‹Msg
(
pP¨£
,

2181 
pFromCﬁ
->
a
[
i
].
zName
);

2182 
fk_íd
;

2186 if–
pToCﬁ
 ){

2187 
i
=0; i<
nCﬁ
; i++){

2188 
n
 = 
	`sqlôe4SåÀn30
(
pToCﬁ
->
a
[
i
].
zName
);

2189 
pFKey
->
aCﬁ
[
i
].
zCﬁ
 = 
z
;

2190 
	`mem˝y
(
z
, 
pToCﬁ
->
a
[
i
].
zName
, 
n
);

2191 
z
[
n
] = 0;

2192 
z
 +
n
+1;

2195 
pFKey
->
isDe„ºed
 = 0;

2196 
pFKey
->
aA˘i⁄
[0] = (
u8
)(
Êags
 & 0xff);

2197 
pFKey
->
aA˘i⁄
[1] = (
u8
)((
Êags
 >> 8 ) & 0xff);

2199 
pNextTo
 = (
FKey
 *)
	`sqlôe4HashIn£π
(&
p
->
pSchema
->
fkeyHash
,

2200 
pFKey
->
zTo
, 
	`sqlôe4SåÀn30
(pFKey->zTo), (*)pFKey

2202 if–
pNextTo
==
pFKey
 ){

2203 
db
->
mÆlocFaûed
 = 1;

2204 
fk_íd
;

2206 if–
pNextTo
 ){

2207 
	`as£π
–
pNextTo
->
pPªvTo
==0 );

2208 
pFKey
->
pNextTo
 =ÖNextTo;

2209 
pNextTo
->
pPªvTo
 = 
pFKey
;

2214 
p
->
pFKey
 =ÖFKey;

2215 
pFKey
 = 0;

2217 
fk_íd
:

2218 
	`sqlôe4DbFªe
(
db
, 
pFKey
);

2220 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pFromCﬁ
);

2221 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pToCﬁ
);

2222 
	}
}

2231 
	$sqlôe4De„rF‹eignKey
(
P¨£
 *
pP¨£
, 
isDe„ºed
){

2232 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


2233 
TabÀ
 *
pTab
;

2234 
FKey
 *
pFKey
;

2235 if–(
pTab
 = 
pP¨£
->
pNewTabÀ
)==0 || (
pFKey
 =ÖTab->pFKey)==0 ) ;

2236 
	`as£π
–
isDe„ºed
==0 || isDeferred==1 );

2237 
pFKey
->
isDe„ºed
 = (
u8
)isDeferred;

2239 
	}
}

2247 
	$sqlôe4EncodeIndexVÆue
(

2248 
P¨£
 *
pP¨£
,

2249 
iPkC§
,

2250 
Index
 *
pIdx
,

2251 
ªgOut


2253 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2254 
TabÀ
 *
pTab
 = 
pIdx
->
pTabÀ
;

2255 
i
;

2256 
ªg
;

2258 
ªg
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
pIdx
->
nCovî
);

2259 
i
=0; i<
pIdx
->
nCovî
; i++){

2260 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pTab
, 
iPkC§
, 
pIdx
->
aiCovî
[
i
], 
ªg
+i);

2262 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªg
, 
pIdx
->
nCovî
, 
ªgOut
);

2263 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªg
, 
pIdx
->
nCovî
);

2264 
	}
}

2271 
	$sqlôe4RefûlIndex
(
P¨£
 *
pP¨£
, 
Index
 *
pIdx
, 
bCª©e
){

2272 
TabÀ
 *
pTab
 = 
pIdx
->
pTabÀ
;

2273 
iTab
 = 
pP¨£
->
nTab
++;

2274 
iIdx
 = 
pP¨£
->
nTab
++;

2275 
addr1
;

2276 
Vdbe
 *
v
;

2277 
ªgKey
;

2278 
sqlôe4
 *
db
 = 
pP¨£
->db;

2279 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pIdx
->
pSchema
);

2280 
Index
 *
pPk
;

2282 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


2283 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_REINDEX
, 
pIdx
->
zName
, 0,

2284 
db
->
aDb
[
iDb
].
zName
 ) ){

2289 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

2290 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

2291 if–
v
==0 ) ;

2294 
	`sqlôe4O≥nPrim¨yKey
(
pP¨£
, 
iTab
, 
iDb
, 
pTab
, 
OP_O≥nWrôe
);

2297 if–
bCª©e
==0 ){

2298 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_CÀ¨
, 
pIdx
->
äum
, 
iDb
);

2300 
	`sqlôe4O≥nIndex
(
pP¨£
, 
iIdx
, 
iDb
, 
pIdx
, 
OP_O≥nWrôe
);

2301 if–
bCª©e
 ) 
	`sqlôe4VdbeCh™geP5
(
v
, 1);

2304 
addr1
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
iTab
, 0);

2306 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
 ){

2307 
ªgD©a
;

2308 
i
;

2310 
ªgKey
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
pTab
->
nCﬁ
+1);

2311 
ªgD©a
 = 
ªgKey
+1;

2313 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iTab
, 
ªgKey
);

2314 
i
=0; i<
pTab
->
nCﬁ
; i++){

2315 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iTab
, 
i
, 
ªgD©a
+i);

2317 
	`sqlôe4Fts5CodeUpd©e
(
pP¨£
, 
pIdx
,ÖP¨£->
iNewidxReg
, 
ªgKey
, 
ªgD©a
, 0);

2319 
ªgD©a
 = 0;

2321 
ªgKey
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 2);

2323 if–
pPk
 ){

2325 
	`sqlôe4EncodeIndexKey
(
pP¨£
, 
pPk
, 
iTab
, 
pIdx
, 
iIdx
, 0, 
ªgKey
);

2328 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iTab
, 
ªgKey
);

2330 if–
pIdx
->
⁄Eº‹
!=
OE_N⁄e
 ){

2331 c⁄° *
zEº
 = "indexed columnsáreÇot unique";

2332 
addrTe°
;

2334 
addrTe°
 = 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_IsUnique
, 
iIdx
, 0, 
ªgKey
, 0);

2335 
	`sqlôe4HÆtC⁄°øöt
(
pP¨£
, 
OE_Ab‹t
, (*)
zEº
, 
P4_STATIC
);

2336 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrTe°
);

2338 if–
pIdx
->
nCovî
>0 ){

2339 
ªgD©a
 = 
ªgKey
+1;

2340 
	`sqlôe4EncodeIndexVÆue
(
pP¨£
, 
iTab
, 
pIdx
, 
ªgD©a
);

2342 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iIdx
, 
ªgD©a
, 
ªgKey
);

2343 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgKey
, 2);

2346 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iTab
, 
addr1
+1);

2347 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr1
);

2349 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iTab
);

2350 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iIdx
);

2351 
	}
}

2361 
TabÀ
 *
	$¸óãIndexFödTabÀ
(

2362 
P¨£
 *
pP¨£
,

2363 
Cª©eIndex
 *
p
,

2364 
Tokí
 **
µIdxName
,

2365 **
pzIdxName
,

2366 *
piDb


2368 
DbFixî
 
sFix
;

2369 
sqlôe4
 *
db
 = 
pP¨£
->db;

2370 
Tokí
 *
pName
 = 0;

2371 *
zName
;

2372 
iDb
;

2373 
TabÀ
 *
pTab
;

2378 
iDb
 = 
	`sqlôe4TwoP¨tName
(
pP¨£
, &
p
->
tName1
, &p->
tName2
, &
pName
);

2379 if–
iDb
<0 )  0;

2380 
	`as£π
–
pName
 &&ÖName->
z
 );

2382 #i‚de‡
SQLITE4_OMIT_TEMPDB


2386 if–!
db
->
öô
.
busy
 ){

2387 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
p
->
pTblName
);

2388 if–
p
->
tName2
.
n
==0 && 
pTab
 &&ÖTab->
pSchema
==
db
->
aDb
[1].pSchema ){

2389 
iDb
 = 1;

2394 if–
	`sqlôe4FixInô
(&
sFix
, 
pP¨£
, 
iDb
, "ödex", 
pName
) &&

2395 
	`sqlôe4FixSrcLi°
(&
sFix
, 
p
->
pTblName
)

2399 
	`as£π
(0);

2402 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
p
->
pTblName
);

2403 if–!
pTab
 || 
db
->
mÆlocFaûed
 )  0;

2404 
	`as£π
–
db
->
aDb
[
iDb
].
pSchema
==
pTab
->pSchema );

2405 
	`as£π
–
pP¨£
->
nEº
==0 );

2409 if–
	`sqlôe4_°∫icmp
(
pTab
->
zName
, "sqlite_", 7)==0

2410 && 
	`memcmp
(&
pTab
->
zName
[7],"altertab_",9)!=0

2412 
	`sqlôe4Eº‹Msg
(
pP¨£
, "èbÀ %†mayÇŸ bêödexed", 
pTab
->
zName
);

2418 if–
	`IsVõw
(
pTab
) ){

2419 
	`sqlôe4Eº‹Msg
(
pP¨£
, "views mayÇot be indexed");

2422 if–
	`IsVútuÆ
(
pTab
) ){

2423 
	`sqlôe4Eº‹Msg
(
pP¨£
, "virtualÅables mayÇot be indexed");

2428 
	`as£π
–
pName
->
z
!=0 );

2429 
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName
);

2430 if–
zName
==0 || 
	`sqlôe4CheckObje˘Name
(
pP¨£
, zName) ){

2431 
pTab
 = 0;

2436 if–!
db
->
öô
.
busy
 ){

2437 *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

2438 if–
	`sqlôe4FödTabÀ
(
db
, 
zName
, 
zDb
)!=0 ){

2439 
	`sqlôe4Eº‹Msg
(
pP¨£
, "thîêi†ÆªadyáÅabÀÇamed %s", 
zName
);

2441 if–
	`sqlôe4FödIndex
(
db
, 
zName
, 
zDb
)!=0 ){

2442 if–
p
->
bI‚Ÿexi°
 ){

2443 
	`as£π
–!
db
->
öô
.
busy
 );

2444 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

2445 
pTab
 = 0;

2447 
	`sqlôe4Eº‹Msg
(
pP¨£
, "ödex %†ÆªadyÉxi°s", 
zName
);

2452 if–
pP¨£
->
nEº
 || 
pTab
==0 ){

2453 
	`sqlôe4DbFªe
(
db
, 
zName
);

2454 
pTab
 = 0;

2455 
zName
 = 0;

2457 *
µIdxName
 = 
pName
;

2458 *
pzIdxName
 = 
zName
;

2459 *
piDb
 = 
iDb
;

2460  
pTab
;

2461 
	}
}

2463 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


2469 
	$¸óãIndexAuth
(

2470 
P¨£
 *
pP¨£
,

2471 
TabÀ
 *
pTab
,

2472 c⁄° *
zIdx


2474 
sqlôe4
 *
db
;

2475 
iDb
;

2476 
iOp
;

2477 c⁄° *
zDb
;

2479 
db
 = 
pP¨£
->db;

2480 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

2481 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

2483 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_INSERT
, 
	`SCHEMA_TABLE
(
iDb
), 0, 
zDb
) ){

2487 
iOp
 = (!
OMIT_TEMPDB
 && 
iDb
==1)?
SQLITE4_CREATE_TEMP_INDEX
:
SQLITE4_CREATE_INDEX
;

2488 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
iOp
, 
zIdx
, 
pTab
->
zName
, 
zDb
) ){

2493 
	}
}

2495 
	#¸óãIndexAuth
(
a
, 
b
, 
c
Ë0

	)

2504 
	$¸óãIndexWrôeSchema
(

2505 
P¨£
 *
pP¨£
,

2506 
Index
 *
pIdx
,

2507 
Tokí
 *
pName
,

2508 
Tokí
 *
pEnd


2510 
sqlôe4
 *
db
 = 
pP¨£
->db;

2511 
iDb
;

2513 
	`as£π
–
db
->
öô
.
busy
==0 );

2514 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pIdx
->
pSchema
);

2515 
pIdx
->
äum
 = ++
pP¨£
->
nMem
;

2516 
	`ÆloˇãTabÀNumbî
(
pP¨£
, 
iDb
, 
pIdx
->
äum
);

2518 if–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 ){

2519 
Vdbe
 *
v
;

2520 *
zStmt
;

2522 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

2523 if–
v
==0 ) ;

2525 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 1, 
iDb
);

2530 if–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_UNIQUE
 ){

2531 
n
 = ()(
pEnd
->
z
 - 
pName
->z) +ÖEnd->n;

2532 c⁄° *
zUnique
 = (
pIdx
->
⁄Eº‹
==
OE_N⁄e
 ? "" : " UNIQUE");

2533 
zStmt
 = 
	`sqlôe4MPrötf
(
db
, "CREATE%†INDEX %.*s", 
zUnique
, 
n
, 
pName
->
z
);

2536 
zStmt
 = 0;

2540 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

2542 
db
->
aDb
[
iDb
].
zName
, 
	`SCHEMA_TABLE
(iDb),

2543 
pIdx
->
zName
,

2544 
pIdx
->
pTabÀ
->
zName
,

2545 
pIdx
->
äum
,

2546 
zStmt


2548 
	`sqlôe4DbFªe
(
db
, 
zStmt
);

2553 if–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_UNIQUE
 ){

2554 
	`sqlôe4RefûlIndex
(
pP¨£
, 
pIdx
, 1);

2555 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

2556 
	`sqlôe4VdbeAddP¨£SchemaOp
(
v
, 
iDb
,

2557 
	`sqlôe4MPrötf
(
db
, "«me='%q' ANDÅy≥='ödex'", 
pIdx
->
zName
));

2558 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Expúe
, 0);

2561 
	}
}

2563 
	$sqlôe4Cª©eUsögIndex
(

2564 
P¨£
 *
pP¨£
,

2565 
Cª©eIndex
 *
p
,

2566 
Ex¥Li°
 *
pLi°
,

2567 
Tokí
 *
pUsög
,

2568 
Tokí
 *
pEnd


2570 
sqlôe4
 *
db
 = 
pP¨£
->db;

2571 if–
p
->
bUnique
 ){

2572 
	`sqlôe4Eº‹Msg
(
pP¨£
, "USING %.*s index mayÇot be UNIQUE",

2573 
pUsög
->
n
,ÖUsög->
z


2576 
Index
 *
pIdx
 = 0;

2577 
TabÀ
 *
pTab
;

2578 
Tokí
 *
pIdxName
 = 0;

2579 *
zIdx
 = 0;

2580 
iDb
 = 0;

2582 
pTab
 = 
	`¸óãIndexFödTabÀ
(
pP¨£
, 
p
, &
pIdxName
, &
zIdx
, &
iDb
);

2583 if–
pTab
 && 0==
	`¸óãIndexAuth
(
pP¨£
,ÖTab, 
zIdx
) ){

2584 
nExåa
 = 
	`sqlôe4Fts5IndexSz
();

2585 *
zExåa
 = 0;

2586 
pIdx
 = 
	`√wIndex
(
pP¨£
, 
pTab
, 
zIdx
, 0, 0, 0, 
nExåa
, &
zExåa
);

2587 if–
pIdx
 ){

2588 
pIdx
->
pFts
 = (
Fts5Index
 *)
zExåa
;

2589 
	`sqlôe4Fts5IndexInô
(
pP¨£
, 
pIdx
, 
pLi°
);

2590 
pIdx
->
eIndexTy≥
 = 
SQLITE4_INDEX_FTS5
;

2594 if–
pIdx
 ){

2595 if–
db
->
öô
.
busy
 ){

2596 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

2597 
pIdx
->
äum
 = 
db
->
öô
.
√wTnum
;

2598 
pIdx
->
pNext
 = 
pTab
->
pIndex
;

2599 
pTab
->
pIndex
 = 
pIdx
;

2600 
	`addIndexToHash
(
db
, 
pIdx
);

2601 
pIdx
 = 0;

2603 
	`¸óãIndexWrôeSchema
(
pP¨£
, 
pIdx
, 
pIdxName
, 
pEnd
);

2607 if–
pIdx
 ) 
	`‰ìIndex
(
db
,ÖIdx);

2608 
	`sqlôe4DbFªe
(
db
, 
zIdx
);

2611 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

2612 
	`sqlôe4SrcLi°Dñëe
(
db
, 
p
->
pTblName
);

2613 
	}
}

2621 
	$födTabÀCﬁumn
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, c⁄° *
zName
){

2622 
j
;

2623 
Cﬁumn
 *
pTabCﬁ
;

2625 
j
=0, 
pTabCﬁ
=
pTab
->
aCﬁ
; j<pTab->
nCﬁ
; j++,ÖTabCol++){

2626 if–
	`sqlôe4_°ricmp
(
zName
, 
pTabCﬁ
->zName)==0 ) ;

2628 if–
j
>=
pTab
->
nCﬁ
 ){

2629 
	`sqlôe4Eº‹Msg
(
pP¨£
, "table %s hasÇo columnÇamed %s",

2630 
pTab
->
zName
, zName);

2631 
pP¨£
->
checkSchema
 = 1;

2635  
j
;

2636 
	}
}

2654 
Index
 *
	$sqlôe4Cª©eIndex
(

2655 
P¨£
 *
pP¨£
,

2656 
Cª©eIndex
 *
pCI
,

2657 
Ex¥Li°
 *
pLi°
,

2658 
IdLi°
 *
pCovîög
,

2659 
⁄Eº‹
,

2660 
Tokí
 *
pEnd
,

2661 
s‹tOrdî
,

2662 
bPrim¨yKey


2664 
Index
 *
pRë
 = 0;

2665 
TabÀ
 *
pTab
 = 0;

2666 
Index
 *
pIndex
 = 0;

2667 *
zName
 = 0;

2668 
i
, 
j
;

2669 
Tokí
 
nuŒId
;

2670 
sqlôe4
 *
db
 = 
pP¨£
->db;

2671 
iDb
;

2672 
Tokí
 *
pName
 = 0;

2673 
Ex¥Li°Iãm
 *
pLi°Iãm
;

2674 
nExåa
 = 0;

2675 *
zExåa
;

2677 
nCovî
 = 0;

2678 
Tokí
 *
pSèπ
 = 0;

2679 
SrcLi°
 *
pTblName
 = 0;

2682 
ve˘‹IdxRc
 = 0, 
skùRefûl
 = 0;

2684 if–
pCI
 ){

2685 
pSèπ
 = &
pCI
->
tCª©e
;

2686 
pTblName
 = 
pCI
->pTblName;

2688 if–
pCovîög
 ){

2689 
nCovî
 = 
pCovîög
->
nId
;

2690 if–
nCovî
==0 )ÇCovî = 
pLi°
->
nEx¥
;

2693 
	`as£π
–
pSèπ
==0 || 
pEnd
!=0 );

2694 
	`as£π
–
pP¨£
->
nEº
==0 );

2695 if–
db
->
mÆlocFaûed
 || 
IN_DECLARE_VTAB
 ){

2696 
exô_¸óã_ödex
;

2698 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

2699 
exô_¸óã_ödex
;

2703 if–
pCI
 ){

2704 
pTab
 = 
	`¸óãIndexFödTabÀ
(
pP¨£
, 
pCI
, &
pName
, &
zName
, &
iDb
);

2705 
	`¥ötf
("¸óãIndexFödTabÀ: foundÅabÀ %s\n", 
pTab
 ?ÖTab->
zName
 : "null");

2706 if–!
pTab
 ) 
exô_¸óã_ödex
;

2708 
	`as£π
–
pName
==0 );

2709 
	`as£π
–
pSèπ
==0 );

2710 
pTab
 = 
pP¨£
->
pNewTabÀ
;

2711 if–!
pTab
 ) 
exô_¸óã_ödex
;

2712 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

2715 if–
db
->
öô
.
busy
==0 ){

2716 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

2719 
	`as£π
–
pTab
!=0 );

2720 
	`as£π
–
pP¨£
->
nEº
==0 );

2721 
	`as£π
–
	`IsVútuÆ
(
pTab
)==0 && 
	`IsVõw
(pTab)==0 );

2725 if–
pCI
==0 ){

2726 if–!
bPrim¨yKey
 ){

2727 
n
;

2728 
Index
 *
pLo›
;

2729 
pLo›
=
pTab
->
pIndex
, 
n
=1;ÖLo›;ÖLo›ıLo›->
pNext
,Ç++){}

2730 
zName
 = 
	`sqlôe4MPrötf
(
db
, "sqlôe_%s_unique%d", 
pTab
->zName, 
n
);

2732 
zName
 = 
	`sqlôe4MPrötf
(
db
, "%s", 
pTab
->zName);

2734 if–
zName
==0 ){

2735 
exô_¸óã_ödex
;

2740 if–
bPrim¨yKey
==0 && 
	`¸óãIndexAuth
(
pP¨£
, 
pTab
, 
zName
) ){

2741 
exô_¸óã_ödex
;

2751 if–
pLi°
==0 ){

2752 
	`¥ötf
("createIndex:Åhis isÖrimary key or unique constraint\n");

2753 
nuŒId
.
z
 = 
pTab
->
aCﬁ
[pTab->
nCﬁ
-1].
zName
;

2754 
nuŒId
.
n
 = 
	`sqlôe4SåÀn30
((*ÍuŒId.
z
);

2755 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 0);

2756 if–
pLi°
==0 ) 
exô_¸óã_ödex
;

2757 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
pLi°
, &
nuŒId
, 0);

2758 
pLi°
->
a
[0].
s‹tOrdî
 = (
u8
)sortOrder;

2764 
i
=0; i<
pLi°
->
nEx¥
; i++){

2765 
Ex¥
 *
pEx¥
 = 
pLi°
->
a
[
i
].pExpr;

2766 if–
pEx¥
 ){

2767 
CﬁlSeq
 *
pCﬁl
 = 
pEx¥
->pColl;

2770 if–
	`ALWAYS
(
pCﬁl
) ){

2771 
nExåa
 +(1 + 
	`sqlôe4SåÀn30
(
pCﬁl
->
zName
));

2777 
pIndex
 = 
	`√wIndex
(

2778 
pP¨£
, 
pTab
, 
zName
, 
pLi°
->
nEx¥
, 
nCovî
, 
⁄Eº‹
, 
nExåa
, &
zExåa


2780 if–!
pIndex
 ) 
exô_¸óã_ödex
;

2782 
	`as£π
–
pIndex
->
eIndexTy≥
==
SQLITE4_INDEX_USER
 );

2783 if–
pName
==0 ){

2784 if–
bPrim¨yKey
 ){

2785 
pIndex
->
eIndexTy≥
 = 
SQLITE4_INDEX_PRIMARYKEY
;

2787 
pIndex
->
eIndexTy≥
 = 
SQLITE4_INDEX_UNIQUE
;

2795 
pLi°Iãm
 = 
pLi°
->
a
;

2796 
hasEx¥
 = 0;

2797 
pLi°Iãm
 = 
pLi°
->
a
;

2798 
i
 = 0; i < 
pIndex
->
nCﬁumn
; i++, 
pLi°Iãm
++){

2799 
Ex¥
 *
pEx¥
 = 
pLi°Iãm
->pExpr;

2800 
Ex¥
 *
pCEx¥
 = 
pEx¥
;

2803  
pCEx¥
 &&ÖCEx¥->
›
 =
TK_COLLATE
 ){

2804 
pCEx¥
 =ÖCEx¥->
pLe·
;

2806 if–
pEx¥
 =
NULL
 ){

2810 if–
pCEx¥
 &&ÖCEx¥->
›
 =
TK_COLUMN
 ){

2812 
pIndex
->
aiCﬁumn
[
i
] = (
i16
)
pCEx¥
->
iCﬁumn
;

2815 
pIndex
->
aiCﬁumn
[
i
] = 
XN_EXPR
;

2816 
hasEx¥
 = 1;

2819 
pIndex
->
aS‹tOrdî
[
i
] = (
u8
)
pLi°Iãm
->
s‹tOrdî
;

2823 if–
hasEx¥
 ){

2824 
pIndex
->
aCﬁEx¥
 = 
pLi°
;

2825 
pLi°
 = 0;

2828 if–
pIndex
->
aCﬁEx¥
 ){

2829 
SrcLi°
 
sSrc
;

2830 
NameC⁄ãxt
 
sNC
;

2831 
ii
;

2833 
	`mem£t
(&
sSrc
, 0, (sSrc));

2834 
	`mem£t
(&
sNC
, 0, (sNC));

2836 
sSrc
.
nSrc
 = 1;

2837 
sSrc
.
a
[0].
zName
 = 
pTab
->zName;

2838 
sSrc
.
a
[0].
pTab
 =ÖTab;

2839 
sSrc
.
a
[0].
iCurs‹
 = -1;

2841 
sNC
.
pP¨£
 =ÖParse;

2842 
sNC
.
pSrcLi°
 = &
sSrc
;

2843 
sNC
.
isCheck
 = 0;

2844 
sNC
.
nDïth
 = 1;

2846 
ii
 = 0; iò< 
pIndex
->
aCﬁEx¥
->
nEx¥
; ii++){

2847 
Ex¥
 *
pE
 = 
pIndex
->
aCﬁEx¥
->
a
[
ii
].
pEx¥
;

2848 if–
pE
 ){

2849 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pE
) ){

2850 
exô_¸óã_ödex
;

2856 
	`sqlôe4DeÁu…RowE°
(
pIndex
);

2859 
	`¥ötf
("Creating vector indexÉntering\n");

2861 #i‚de‡
SQLITE_OMIT_VECTOR


2863 
	`¥ötf
("Creating vector index\n");

2864 
ve˘‹IdxRc
 = 
	`ve˘‹IndexCª©e
(
pP¨£
, 
pIndex
, 
db
->
aDb
[
iDb
].
zName
);

2865 
	`¥ötf
("ve˘‹IdxR¯%d\n", 
ve˘‹IdxRc
);

2866 if–
ve˘‹IdxRc
 < 0 ){

2867 
	`¥ötf
("FailedÅo create vector index\n");

2868 
exô_¸óã_ödex
;

2870 if–
ve˘‹IdxRc
 >= 1 ){

2871 
	`¥ötf
("Cª©ed ve˘‹ index %†wôh ve˘‹IdxR¯%d\n", 
pIndex
->
zName
, 
ve˘‹IdxRc
);

2872 
pIndex
->
idxIsVe˘‹
 = 1;

2874 if–
ve˘‹IdxRc
 == 1 ){

2875 
	`¥ötf
("Skip indexÑefill for vector index\n");

2876 
skùRefûl
 = 1;

2878 if–
ve˘‹IdxRc
 == 0 ){

2879 
	`¥ötf
("ve˘‹ index mu°ÇŸ bê¸óãd f‹ %†(ve˘‹IdxR¯%d)\n", 
pIndex
->
zName
, 
ve˘‹IdxRc
);

2884 
i
=0; i<
nCovî
; i++){

2885 if–
pCovîög
->
nId
 ){

2886 
j
 = 
	`födTabÀCﬁumn
(
pP¨£
, 
pTab
, 
pCovîög
->
a
[
i
].
zName
);

2887 if–
j
<0 ) 
exô_¸óã_ödex
;

2888 
pIndex
->
aiCovî
[
i
] = 
j
;

2890 
pIndex
->
aiCovî
[
i
] = i;

2894 if–
pTab
==
pP¨£
->
pNewTabÀ
 ){

2916 
Index
 *
pIdx
;

2917 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

2918 
k
;

2919 
	`as£π
–
pIdx
->
⁄Eº‹
!=
OE_N⁄e
 );

2920 
	`as£π
–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_USER
 );

2921 
	`as£π
–
pIndex
->
⁄Eº‹
!=
OE_N⁄e
 );

2923 if–
pIdx
->
nCﬁumn
!=
pIndex
->nColumn ) ;

2924 
k
=0; k<
pIdx
->
nCﬁumn
; k++){

2925 c⁄° *
z1
;

2926 c⁄° *
z2
;

2927 if–
pIdx
->
aiCﬁumn
[
k
]!=
pIndex
->aiColumn[k] ) ;

2928 
z1
 = 
pIdx
->
azCﬁl
[
k
];

2929 
z2
 = 
pIndex
->
azCﬁl
[
k
];

2930 if–
z1
!=
z2
 && 
	`sqlôe4_°ricmp
(z1, z2) ) ;

2932 if–
k
==
pIdx
->
nCﬁumn
 ){

2933 if–
pIdx
->
⁄Eº‹
!=
pIndex
->onError ){

2941 if–!(
pIdx
->
⁄Eº‹
==
OE_DeÁu…
 || 
pIndex
->onError==OE_Default) ){

2942 
	`sqlôe4Eº‹Msg
(
pP¨£
,

2945 if–
pIdx
->
⁄Eº‹
==
OE_DeÁu…
 ){

2946 
pIdx
->
⁄Eº‹
 = 
pIndex
->onError;

2952 if–
bPrim¨yKey
 ){

2953 
	`as£π
–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_UNIQUE
 );

2954 
pIdx
->
eIndexTy≥
 = 
SQLITE4_INDEX_PRIMARYKEY
;

2956 
exô_¸óã_ödex
;

2964 if–
db
->
öô
.
busy
 ){

2965 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

2966 if–
pTblName
!=0 || 
bPrim¨yKey
 ){

2967 
pIndex
->
äum
 = 
db
->
öô
.
√wTnum
;

2969 if–
	`addIndexToHash
(
db
, 
pIndex
ËË
exô_¸óã_ödex
;

2988 
	`¥ötf
("¸óãIndex: wrôög index %s\n", 
pName
->
z
);

2989 
	`¸óãIndexWrôeSchema
(
pP¨£
, 
pIndex
, 
pName
, 
pEnd
);

2998 if–
db
->
öô
.
busy
 || 
pTblName
==0 ){

2999 if–
⁄Eº‹
!=
OE_Rïœ˚
 || 
pTab
->
pIndex
==0

3000 || 
pTab
->
pIndex
->
⁄Eº‹
==
OE_Rïœ˚
){

3001 
pIndex
->
pNext
 = 
pTab
->pIndex;

3002 
pTab
->
pIndex
 =ÖIndex;

3004 
Index
 *
pOthî
 = 
pTab
->
pIndex
;

3005  
pOthî
->
pNext
 &&ÖOthî->pNext->
⁄Eº‹
!=
OE_Rïœ˚
 ){

3006 
pOthî
 =ÖOthî->
pNext
;

3008 
pIndex
->
pNext
 = 
pOthî
->pNext;

3009 
pOthî
->
pNext
 = 
pIndex
;

3011 
pRë
 = 
pIndex
;

3012 
pIndex
 = 0;

3016 
exô_¸óã_ödex
:

3017 if–
pIndex
 ){

3018 
	`sqlôe4DbFªe
(
db
, 
pIndex
->
zCﬁAff
);

3019 
	`sqlôe4DbFªe
(
db
, 
pIndex
);

3021 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

3022 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pTblName
);

3023 
	`sqlôe4IdLi°Dñëe
(
db
, 
pCovîög
);

3024 
	`sqlôe4DbFªe
(
db
, 
zName
);

3025  
pRë
;

3026 
	}
}

3046 
	$sqlôe4DeÁu…RowE°
(
Index
 *
pIdx
){

3047 
tRow˙t
 *
a
 = 
pIdx
->
aiRowE°
;

3048 
i
;

3049 
tRow˙t
 
n
;

3050 
	`as£π
–
a
!=0 );

3051 
a
[0] = 
pIdx
->
pTabÀ
->
nRowE°
;

3052 if–
a
[0]<10 )á[0] = 10;

3053 
n
 = 10;

3054 
i
=1; i<=
pIdx
->
nCﬁumn
; i++){

3055 
a
[
i
] = 
n
;

3056 if–
n
>5 )Ç--;

3058 if–
pIdx
->
⁄Eº‹
!=
OE_N⁄e
 ){

3059 
a
[
pIdx
->
nCﬁumn
] = 1;

3061 
	}
}

3067 
	$sqlôe4Dr›Index
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pName
, 
ifExi°s
){

3068 
Index
 *
pIndex
;

3069 
Vdbe
 *
v
;

3070 
sqlôe4
 *
db
 = 
pP¨£
->db;

3071 
iDb
;

3073 
	`as£π
–
pP¨£
->
nEº
==0 );

3074 if–
db
->
mÆlocFaûed
 ){

3075 
exô_dr›_ödex
;

3077 
	`as£π
–
pName
->
nSrc
==1 );

3078 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

3079 
exô_dr›_ödex
;

3081 
pIndex
 = 
	`sqlôe4FödIndex
(
db
, 
pName
->
a
[0].
zName
,ÖName->a[0].
zD©aba£
);

3082 if–
pIndex
==0 ){

3083 if–!
ifExi°s
 ){

3084 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuch index: %S", 
pName
, 0);

3086 
	`sqlôe4CodeVîifyNamedSchema
(
pP¨£
, 
pName
->
a
[0].
zD©aba£
);

3088 
pP¨£
->
checkSchema
 = 1;

3089 
exô_dr›_ödex
;

3091 if–
pIndex
->
eIndexTy≥
!=
SQLITE4_INDEX_USER


3092 && 
pIndex
->
eIndexTy≥
!=
SQLITE4_INDEX_FTS5


3094 
	`sqlôe4Eº‹Msg
(
pP¨£
, "indexássociated with UNIQUE "

3096 
exô_dr›_ödex
;

3098 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pIndex
->
pSchema
);

3099 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


3101 
code
 = 
SQLITE4_DROP_INDEX
;

3102 
TabÀ
 *
pTab
 = 
pIndex
->
pTabÀ
;

3103 c⁄° *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

3104 c⁄° *
zTab
 = 
	`SCHEMA_TABLE
(
iDb
);

3105 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_DELETE
, 
zTab
, 0, 
zDb
) ){

3106 
exô_dr›_ödex
;

3108 if–!
OMIT_TEMPDB
 && 
iDb
 ) 
code
 = 
SQLITE4_DROP_TEMP_INDEX
;

3109 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
code
, 
pIndex
->
zName
, 
pTab
->zName, 
zDb
) ){

3110 
exô_dr›_ödex
;

3116 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

3117 if–
v
 ){

3118 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 1, 
iDb
);

3119 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

3121 
db
->
aDb
[
iDb
].
zName
, 
	`SCHEMA_TABLE
(iDb), 
pIndex
->zName

3123 
	`sqlôe4CÀ¨SètTabÀs
(
pP¨£
, 
iDb
, "idx", 
pIndex
->
zName
);

3124 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

3125 
	`de°royRoŸPage
(
pP¨£
, 
pIndex
->
äum
, 
iDb
);

3126 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Dr›Index
, 
iDb
, 0, 0, 
pIndex
->
zName
, 0);

3129 
exô_dr›_ödex
:

3130 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pName
);

3131 
	}
}

3148 *
	$sqlôe4AºayAŒoˇã
(

3149 
sqlôe4
 *
db
,

3150 *
pAºay
,

3151 
szE¡ry
,

3152 
öôSize
,

3153 *
≤E¡ry
,

3154 *
≤AŒoc
,

3155 *
pIdx


3157 *
z
;

3158 if–*
≤E¡ry
 >*
≤AŒoc
 ){

3159 *
pNew
;

3160 
√wSize
;

3161 
√wSize
 = (*
≤AŒoc
)*2 + 
öôSize
;

3162 
pNew
 = 
	`sqlôe4DbRóŒoc
(
db
, 
pAºay
, 
√wSize
*
szE¡ry
);

3163 if–
pNew
==0 ){

3164 *
pIdx
 = -1;

3165  
pAºay
;

3167 *
≤AŒoc
 = 
	`sqlôe4DbMÆlocSize
(
db
, 
pNew
)/
szE¡ry
;

3168 
pAºay
 = 
pNew
;

3170 
z
 = (*)
pAºay
;

3171 
	`mem£t
(&
z
[*
≤E¡ry
 * 
szE¡ry
], 0, szEntry);

3172 *
pIdx
 = *
≤E¡ry
;

3173 ++*
≤E¡ry
;

3174  
pAºay
;

3175 
	}
}

3183 
IdLi°
 *
	$sqlôe4IdLi°Aµíd
(
sqlôe4
 *
db
, 
IdLi°
 *
pLi°
, 
Tokí
 *
pTokí
){

3184 
i
;

3185 if–
pLi°
==0 ){

3186 
pLi°
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
IdLi°
) );

3187 if–
pLi°
==0 )  0;

3188 
pLi°
->
nAŒoc
 = 0;

3190 
pLi°
->
a
 = 
	`sqlôe4AºayAŒoˇã
(

3191 
db
,

3192 
pLi°
->
a
,

3193 (
pLi°
->
a
[0]),

3195 &
pLi°
->
nId
,

3196 &
pLi°
->
nAŒoc
,

3197 &
i


3199 if–
i
<0 ){

3200 
	`sqlôe4IdLi°Dñëe
(
db
, 
pLi°
);

3203 
pLi°
->
a
[
i
].
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pTokí
);

3204  
pLi°
;

3205 
	}
}

3210 
	$sqlôe4IdLi°Dñëe
(
sqlôe4
 *
db
, 
IdLi°
 *
pLi°
){

3211 
i
;

3212 if–
pLi°
==0 ) ;

3213 
i
=0; i<
pLi°
->
nId
; i++){

3214 
	`sqlôe4DbFªe
(
db
, 
pLi°
->
a
[
i
].
zName
);

3216 
	`sqlôe4DbFªe
(
db
, 
pLi°
->
a
);

3217 
	`sqlôe4DbFªe
(
db
, 
pLi°
);

3218 
	}
}

3224 
	$sqlôe4IdLi°Index
(
IdLi°
 *
pLi°
, c⁄° *
zName
){

3225 
i
;

3226 if–
pLi°
==0 )  -1;

3227 
i
=0; i<
pLi°
->
nId
; i++){

3228 if–
	`sqlôe4_°ricmp
(
pLi°
->
a
[
i
].
zName
, zName)==0 )  i;

3231 
	}
}

3252 
SrcLi°
 *
	$sqlôe4SrcLi°E∆¨ge
(

3253 
sqlôe4
 *
db
,

3254 
SrcLi°
 *
pSrc
,

3255 
nExåa
,

3256 
iSèπ


3258 
i
;

3261 
	`as£π
–
iSèπ
>=0 );

3262 
	`as£π
–
nExåa
>=1 );

3263 
	`as£π
–
pSrc
!=0 );

3264 
	`as£π
–
iSèπ
<=
pSrc
->
nSrc
 );

3267 if–
pSrc
->
nSrc
+
nExåa
>pSrc->
nAŒoc
 ){

3268 
SrcLi°
 *
pNew
;

3269 
nAŒoc
 = 
pSrc
->
nSrc
+
nExåa
;

3270 
nGŸ
;

3271 
pNew
 = 
	`sqlôe4DbRóŒoc
(
db
, 
pSrc
,

3272 (*
pSrc
Ë+ (
nAŒoc
-1)*’Src->
a
[0]) );

3273 if–
pNew
==0 ){

3274 
	`as£π
–
db
->
mÆlocFaûed
 );

3275  
pSrc
;

3277 
pSrc
 = 
pNew
;

3278 
nGŸ
 = (
	`sqlôe4DbMÆlocSize
(
db
, 
pNew
Ë- (*
pSrc
))/’Src->
a
[0])+1;

3279 
pSrc
->
nAŒoc
 = (
u16
)
nGŸ
;

3284 
i
=
pSrc
->
nSrc
-1; i>=
iSèπ
; i--){

3285 
pSrc
->
a
[
i
+
nExåa
] =ÖSrc->a[i];

3287 
pSrc
->
nSrc
 +(
i16
)
nExåa
;

3290 
	`mem£t
(&
pSrc
->
a
[
iSèπ
], 0, ’Src->a[0])*
nExåa
);

3291 
i
=
iSèπ
; i<iSèπ+
nExåa
; i++){

3292 
pSrc
->
a
[
i
].
iCurs‹
 = -1;

3296  
pSrc
;

3297 
	}
}

3334 
SrcLi°
 *
	$sqlôe4SrcLi°Aµíd
(

3335 
sqlôe4
 *
db
,

3336 
SrcLi°
 *
pLi°
,

3337 
Tokí
 *
pTabÀ
,

3338 
Tokí
 *
pD©aba£


3340 
SrcLi°Iãm
 *
pIãm
;

3341 
	`as£π
–
pD©aba£
==0 || 
pTabÀ
!=0 );

3342 if–
pLi°
==0 ){

3343 
pLi°
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
SrcLi°
) );

3344 if–
pLi°
==0 )  0;

3345 
pLi°
->
nAŒoc
 = 1;

3347 
pLi°
 = 
	`sqlôe4SrcLi°E∆¨ge
(
db
,ÖLi°, 1,ÖLi°->
nSrc
);

3348 if–
db
->
mÆlocFaûed
 ){

3349 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pLi°
);

3352 
pIãm
 = &
pLi°
->
a
[pLi°->
nSrc
-1];

3353 if–
pD©aba£
 &&ÖD©aba£->
z
==0 ){

3354 
pD©aba£
 = 0;

3356 if–
pD©aba£
 ){

3357 
Tokí
 *
pTemp
 = 
pD©aba£
;

3358 
pD©aba£
 = 
pTabÀ
;

3359 
pTabÀ
 = 
pTemp
;

3361 
pIãm
->
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pTabÀ
);

3362 
pIãm
->
zD©aba£
 = 
	`sqlôe4NameFromTokí
(
db
, 
pD©aba£
);

3363  
pLi°
;

3364 
	}
}

3369 
	$sqlôe4SrcLi°AssignCurs‹s
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pLi°
){

3370 
i
;

3371 
SrcLi°Iãm
 *
pIãm
;

3372 
	`as£π
(
pLi°
 || 
pP¨£
->
db
->
mÆlocFaûed
 );

3373 if–
pLi°
 ){

3374 
i
=0, 
pIãm
=
pLi°
->
a
; i<pLi°->
nSrc
; i++,ÖItem++){

3375 if–
pIãm
->
iCurs‹
>=0 ) ;

3376 
pIãm
->
iCurs‹
 = 
pP¨£
->
nTab
++;

3377 if–
pIãm
->
pSñe˘
 ){

3378 
	`sqlôe4SrcLi°AssignCurs‹s
(
pP¨£
, 
pIãm
->
pSñe˘
->
pSrc
);

3382 
	}
}

3387 
	$sqlôe4SrcLi°Dñëe
(
sqlôe4
 *
db
, 
SrcLi°
 *
pLi°
){

3388 
i
;

3389 
SrcLi°Iãm
 *
pIãm
;

3390 if–
pLi°
==0 ) ;

3391 
pIãm
=
pLi°
->
a
, 
i
=0; i<pLi°->
nSrc
; i++,ÖItem++){

3392 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zD©aba£
);

3393 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zName
);

3394 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zAlüs
);

3395 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zIndex
);

3396 
	`sqlôe4DñëeTabÀ
(
db
, 
pIãm
->
pTab
);

3397 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pIãm
->
pSñe˘
);

3398 
	`sqlôe4Ex¥Dñëe
(
db
, 
pIãm
->
pOn
);

3399 
	`sqlôe4IdLi°Dñëe
(
db
, 
pIãm
->
pUsög
);

3401 
	`sqlôe4DbFªe
(
db
, 
pLi°
);

3402 
	}
}

3420 
SrcLi°
 *
	$sqlôe4SrcLi°AµídFromTîm
(

3421 
P¨£
 *
pP¨£
,

3422 
SrcLi°
 *
p
,

3423 
Tokí
 *
pTabÀ
,

3424 
Tokí
 *
pD©aba£
,

3425 
Tokí
 *
pAlüs
,

3426 
Sñe˘
 *
pSubquîy
,

3427 
Ex¥
 *
pOn
,

3428 
IdLi°
 *
pUsög


3430 
SrcLi°Iãm
 *
pIãm
;

3431 
sqlôe4
 *
db
 = 
pP¨£
->db;

3432 if–!
p
 && (
pOn
 || 
pUsög
) ){

3433 
	`sqlôe4Eº‹Msg
(
pP¨£
, "a JOIN clause isÑequired before %s",

3434 (
pOn
 ? "ON" : "USING")

3436 
≠≥nd_‰om_îr‹
;

3438 
p
 = 
	`sqlôe4SrcLi°Aµíd
(
db
,Ö, 
pTabÀ
, 
pD©aba£
);

3439 if–
p
==0 || 
	`NEVER
’->
nSrc
==0) ){

3440 
≠≥nd_‰om_îr‹
;

3442 
pIãm
 = &
p
->
a
[p->
nSrc
-1];

3443 
	`as£π
–
pAlüs
!=0 );

3444 if–
pAlüs
->
n
 ){

3445 
pIãm
->
zAlüs
 = 
	`sqlôe4NameFromTokí
(
db
, 
pAlüs
);

3447 
pIãm
->
pSñe˘
 = 
pSubquîy
;

3448 
pIãm
->
pOn
 =ÖOn;

3449 
pIãm
->
pUsög
 =ÖUsing;

3450  
p
;

3452 
≠≥nd_‰om_îr‹
:

3453 
	`as£π
–
p
==0 );

3454 
	`sqlôe4Ex¥Dñëe
(
db
, 
pOn
);

3455 
	`sqlôe4IdLi°Dñëe
(
db
, 
pUsög
);

3456 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSubquîy
);

3458 
	}
}

3464 
	$sqlôe4SrcLi°IndexedBy
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
p
, 
Tokí
 *
pIndexedBy
){

3465 
	`as£π
–
pIndexedBy
!=0 );

3466 if–
p
 && 
	`ALWAYS
’->
nSrc
>0) ){

3467 
SrcLi°Iãm
 *
pIãm
 = &
p
->
a
[p->
nSrc
-1];

3468 
	`as£π
–
pIãm
->
nŸIndexed
==0 &&ÖIãm->
zIndex
==0 );

3469 if–
pIndexedBy
->
n
==1 && !pIndexedBy->
z
 ){

3472 
pIãm
->
nŸIndexed
 = 1;

3474 
pIãm
->
zIndex
 = 
	`sqlôe4NameFromTokí
(
pP¨£
->
db
, 
pIndexedBy
);

3477 
	}
}

3494 
	$sqlôe4SrcLi°Shi·JoöTy≥
(
SrcLi°
 *
p
){

3495 if–
p
 ){

3496 
i
;

3497 
	`as£π
–
p
->
a
 ||Ö->
nSrc
==0 );

3498 
i
=
p
->
nSrc
-1; i>0; i--){

3499 
p
->
a
[
i
].
joöty≥
 =Ö->a[i-1].jointype;

3501 
p
->
a
[0].
joöty≥
 = 0;

3503 
	}
}

3508 
	$sqlôe4BegöTønß˘i⁄
(
P¨£
 *
pP¨£
, 
ty≥
){

3509 
sqlôe4
 *
db
;

3510 
Vdbe
 *
v
;

3511 
i
;

3513 
	`as£π
–
pP¨£
!=0 );

3514 
db
 = 
pP¨£
->db;

3515 
	`as£π
–
db
!=0 );

3516 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_TRANSACTION
, "BEGIN", 0, 0) ){

3519 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

3520 if–!
v
 ) ;

3521 if–
ty≥
!=
TK_DEFERRED
 ){

3522 
i
=0; i<
db
->
nDb
; i++){

3523 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Tønß˘i⁄
, 
i
, (
ty≥
==
TK_EXCLUSIVE
)+1);

3524 
	`sqlôe4VdbeU£sSt‹age
(
v
, 
i
);

3527 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Savïoöt
, 
SAVEPOINT_BEGIN
);

3528 
	}
}

3537 
	$sqlôe4EndTønß˘i⁄
(
P¨£
 *
pP¨£
, 
›
){

3538 
Vdbe
 *
v
;

3541 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


3542 c⁄° *
azCmd
[] = { "COMMIT", "ROLLBACK" };

3543 
	`as£π
–
›
==
SAVEPOINT_RELEASE
 || op==
SAVEPOINT_ROLLBACK
 );

3544 
	`as£π
–
SAVEPOINT_RELEASE
==1 && 
SAVEPOINT_ROLLBACK
==2 );

3545 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_TRANSACTION
, 
azCmd
[
›
-1], 0, 0) ) ;

3549 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

3550 if–
v
 ) 
	`sqlôe4VdbeAddOp1
(v, 
OP_Savïoöt
, 
›
);

3551 
	}
}

3557 
	$sqlôe4Savïoöt
(
P¨£
 *
pP¨£
, 
›
, 
Tokí
 *
pName
){

3558 *
zName
 = 
	`sqlôe4NameFromTokí
(
pP¨£
->
db
, 
pName
);

3559 if–
zName
 ){

3560 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

3561 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


3562 c⁄° * c⁄° 
az
[] = { "BEGIN", "RELEASE", "ROLLBACK" };

3563 
	`as£π
–!
SAVEPOINT_BEGIN
 && 
SAVEPOINT_RELEASE
==1 && 
SAVEPOINT_ROLLBACK
==2 );

3565 if–!
v
 || 
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_SAVEPOINT
, 
az
[
›
], 
zName
, 0) ){

3566 
	`sqlôe4DbFªe
(
pP¨£
->
db
, 
zName
);

3569 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Savïoöt
, 
›
, 0, 0, 
zName
, 
P4_DYNAMIC
);

3571 
	}
}

3577 
	$sqlôe4O≥nTempD©aba£
(
P¨£
 *
pP¨£
){

3578 
sqlôe4
 *
db
 = 
pP¨£
->db;

3579 if–
db
->
aDb
[1].
pKV
==0 && !
pP¨£
->
ex∂aö
 ){

3580 
rc
;

3581 
rc
 = 
	`sqlôe4KVSt‹eO≥n
(
db
, "ãmp", ":mem‹y:", &db->
aDb
[1].
pKV
,

3582 
SQLITE4_KVOPEN_TEMPORARY
);

3583 if–
rc
!=
SQLITE4_OK
 ){

3584 
	`sqlôe4Eº‹Msg
(
pP¨£
, "unableÅo openáÅemporary database "

3586 
pP¨£
->
rc
 =Ñc;

3589 
	`as£π
–
db
->
aDb
[1].
pSchema
 );

3592 
	}
}

3616 
	$sqlôe4CodeVîifySchema
(
P¨£
 *
pP¨£
, 
iDb
){

3617 
P¨£
 *
pT›Àvñ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

3619 if–
pT›Àvñ
->
cookõGŸo
==0 ){

3620 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pT›Àvñ
);

3621 if–
v
==0 ) ;

3622 
pT›Àvñ
->
cookõGŸo
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 0)+1;

3624 if–
iDb
>=0 ){

3625 
sqlôe4
 *
db
 = 
pT›Àvñ
->db;

3626 
yDbMask
 
mask
;

3628 
	`as£π
–
iDb
<
db
->
nDb
 );

3629 
	`as£π
–
db
->
aDb
[
iDb
].
pKV
!=0 || iDb==1 );

3630 
	`as£π
–
iDb
<
SQLITE4_MAX_ATTACHED
+2 );

3631 
mask
 = ((
yDbMask
)1)<<
iDb
;

3632 if–(
pT›Àvñ
->
cookõMask
 & 
mask
)==0 ){

3633 
pT›Àvñ
->
cookõMask
 |
mask
;

3634 
pT›Àvñ
->
cookõVÆue
[
iDb
] = 
db
->
aDb
[iDb].
pSchema
->
schema_cookõ
;

3635 if–!
OMIT_TEMPDB
 && 
iDb
==1 ){

3636 
	`sqlôe4O≥nTempD©aba£
(
pT›Àvñ
);

3640 
	}
}

3646 
	$sqlôe4CodeVîifyNamedSchema
(
P¨£
 *
pP¨£
, c⁄° *
zDb
){

3647 
sqlôe4
 *
db
 = 
pP¨£
->db;

3648 
i
;

3649 
i
=0; i<
db
->
nDb
; i++){

3650 
Db
 *
pDb
 = &
db
->
aDb
[
i
];

3651 if–
pDb
->
pKV
 && (!
zDb
 || 0==
	`sqlôe4_°ricmp
(zDb,ÖDb->
zName
)) ){

3652 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
i
);

3655 
	}
}

3670 
	$sqlôe4BegöWrôeO≥øti⁄
(
P¨£
 *
pP¨£
, 
£tSèãmít
, 
iDb
){

3671 
P¨£
 *
pT›Àvñ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

3672 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

3673 
pT›Àvñ
->
wrôeMask
 |((
yDbMask
)1)<<
iDb
;

3674 
pT›Àvñ
->
isMu…iWrôe
 |
£tSèãmít
;

3675 
	}
}

3684 
	$sqlôe4Mu…iWrôe
(
P¨£
 *
pP¨£
){

3685 
P¨£
 *
pT›Àvñ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

3686 
pT›Àvñ
->
isMu…iWrôe
 = 1;

3687 
	}
}

3705 
	$sqlôe4MayAb‹t
(
P¨£
 *
pP¨£
){

3706 
P¨£
 *
pT›Àvñ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

3707 
pT›Àvñ
->
mayAb‹t
 = 1;

3708 
	}
}

3715 
	$sqlôe4HÆtC⁄°øöt
(
P¨£
 *
pP¨£
, 
⁄Eº‹
, *
p4
, 
p4ty≥
){

3716 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

3717 if–
⁄Eº‹
==
OE_Ab‹t
 ){

3718 
	`sqlôe4MayAb‹t
(
pP¨£
);

3720 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_HÆt
, 
SQLITE4_CONSTRAINT
, 
⁄Eº‹
, 0, 
p4
, 
p4ty≥
);

3721 
	}
}

3727 #i‚de‡
SQLITE4_OMIT_REINDEX


3728 
	$cﬁœti⁄M©ch
(c⁄° *
zCﬁl
, 
Index
 *
pIndex
){

3729 
i
;

3730 
	`as£π
–
zCﬁl
!=0 );

3731 
i
=0; i<
pIndex
->
nCﬁumn
; i++){

3732 c⁄° *
z
 = 
pIndex
->
azCﬁl
[
i
];

3733 
	`as£π
–
z
!=0 );

3734 if–0==
	`sqlôe4_°ricmp
(
z
, 
zCﬁl
) ){

3739 
	}
}

3746 #i‚de‡
SQLITE4_OMIT_REINDEX


3747 
	$ªödexTabÀ
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, c⁄° *
zCﬁl
){

3748 
Index
 *
pIndex
;

3750 
pIndex
=
pTab
->pIndex;ÖIndex;ÖIndexıIndex->
pNext
){

3751 if–
pIndex
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ) ;

3752 if–
zCﬁl
==0 || 
	`cﬁœti⁄M©ch
(zCﬁl, 
pIndex
) ){

3753 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

3754 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

3755 
	`sqlôe4RefûlIndex
(
pP¨£
, 
pIndex
, 0);

3758 
	}
}

3766 #i‚de‡
SQLITE4_OMIT_REINDEX


3767 
	$ªödexD©aba£s
(
P¨£
 *
pP¨£
, c⁄° *
zCﬁl
){

3768 
Db
 *
pDb
;

3769 
iDb
;

3770 
sqlôe4
 *
db
 = 
pP¨£
->db;

3771 
HashEÀm
 *
k
;

3772 
TabÀ
 *
pTab
;

3774 
iDb
=0, 
pDb
=
db
->
aDb
; iDb<db->
nDb
; iDb++,ÖDb++){

3775 
	`as£π
–
pDb
!=0 );

3776 
k
=
	`sqlôeHashFú°
(&
pDb
->
pSchema
->
tblHash
); k; k=
	`sqlôeHashNext
(k)){

3777 
pTab
 = (
TabÀ
*)
	`sqlôeHashD©a
(
k
);

3778 
	`ªödexTabÀ
(
pP¨£
, 
pTab
, 
zCﬁl
);

3781 
	}
}

3797 #i‚de‡
SQLITE4_OMIT_REINDEX


3798 
	$sqlôe4Reödex
(
P¨£
 *
pP¨£
, 
Tokí
 *
pName1
, Tokí *
pName2
){

3799 
CﬁlSeq
 *
pCﬁl
;

3800 *
z
;

3801 c⁄° *
zDb
;

3802 
TabÀ
 *
pTab
;

3803 
Index
 *
pIndex
;

3804 
iDb
;

3805 
sqlôe4
 *
db
 = 
pP¨£
->db;

3806 
Tokí
 *
pObjName
;

3810 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

3814 if–
pName1
==0 ){

3815 
	`ªödexD©aba£s
(
pP¨£
, 0);

3817 }if–
	`NEVER
(
pName2
==0Ë||ÖName2->
z
==0 ){

3818 *
zCﬁl
;

3819 
	`as£π
–
pName1
->
z
 );

3820 
zCﬁl
 = 
	`sqlôe4NameFromTokí
(
pP¨£
->
db
, 
pName1
);

3821 if–!
zCﬁl
 ) ;

3822 
pCﬁl
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zCﬁl
, 0);

3823 if–
pCﬁl
 ){

3824 
	`ªödexD©aba£s
(
pP¨£
, 
zCﬁl
);

3825 
	`sqlôe4DbFªe
(
db
, 
zCﬁl
);

3828 
	`sqlôe4DbFªe
(
db
, 
zCﬁl
);

3830 
iDb
 = 
	`sqlôe4TwoP¨tName
(
pP¨£
, 
pName1
, 
pName2
, &
pObjName
);

3831 if–
iDb
<0 ) ;

3832 
z
 = 
	`sqlôe4NameFromTokí
(
db
, 
pObjName
);

3833 if–
z
==0 ) ;

3834 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

3835 
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
z
, 
zDb
);

3836 if–
pTab
 ){

3837 
	`ªödexTabÀ
(
pP¨£
, 
pTab
, 0);

3838 
	`sqlôe4DbFªe
(
db
, 
z
);

3841 
pIndex
 = 
	`sqlôe4FödIndex
(
db
, 
z
, 
zDb
);

3842 
	`sqlôe4DbFªe
(
db
, 
z
);

3843 if–
pIndex
 &&ÖIndex->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 ){

3844 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

3845 
	`sqlôe4RefûlIndex
(
pP¨£
, 
pIndex
, 0);

3848 
	`sqlôe4Eº‹Msg
(
pP¨£
, "unableÅo identifyÅhe objectÅo beÑeindexed");

3849 
	}
}

3862 
KeyInfo
 *
	$sqlôe4IndexKeyöfo
(
P¨£
 *
pP¨£
, 
Index
 *
pIdx
){

3863 
Index
 *
pPk
;

3864 
i
;

3865 
nCﬁ
;

3866 
nByãs
;

3867 
sqlôe4
 *
db
 = 
pP¨£
->db;

3868 
KeyInfo
 *
pKey
;

3869 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY


3870 || 
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_TEMP


3872 
pPk
 = 0;

3874 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pIdx
->
pTabÀ
, 0);

3876 
nCﬁ
 = 
pIdx
->
nCﬁumn
 + (
pPk
 ?ÖPk->nColumn : 0);

3878 
nByãs
 = (
KeyInfo
Ë+ (
nCﬁ
-1)*(
CﬁlSeq
*) +ÇCol;

3879 
pKey
 = (
KeyInfo
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
nByãs
);

3880 if–
pKey
 ){

3881 
pKey
->
aS‹tOrdî
 = (
u8
 *)&’Key->
aCﬁl
[
nCﬁ
]);

3882 
	`as£π
–&
pKey
->
aS‹tOrdî
[
nCﬁ
]==&(((
u8
 *ÌKey)[
nByãs
]) );

3884 
i
=0; i<
pIdx
->
nCﬁumn
; i++){

3885 *
zCﬁl
 = 
pIdx
->
azCﬁl
[
i
];

3886 
	`as£π
–
zCﬁl
 );

3887 
pKey
->
aCﬁl
[
i
] = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
zCﬁl
);

3888 
pKey
->
aS‹tOrdî
[
i
] = 
pIdx
->aSortOrder[i];

3890 if–
pPk
 ){

3891 
i
=0; i<
pPk
->
nCﬁumn
; i++){

3892 *
zCﬁl
 = 
pPk
->
azCﬁl
[
i
];

3893 
	`as£π
–
zCﬁl
 );

3894 
pKey
->
aCﬁl
[
i
+
pIdx
->
nCﬁumn
] = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
zCﬁl
);

3895 
pKey
->
aS‹tOrdî
[
i
+
pIdx
->
nCﬁumn
] = 
pPk
->aSortOrder[i];

3899 
pKey
->
nFõld
 = (
u16
)
nCﬁ
;

3900 if–
pPk
 ){

3901 
pKey
->
nPK
 = 
pPk
->
nCﬁumn
;

3903 
pKey
->
nD©a
 = 
pIdx
->
pTabÀ
->
nCﬁ
;

3907 if–
pP¨£
->
nEº
 ){

3908 
	`sqlôe4DbFªe
(
db
, 
pKey
);

3909 
pKey
 = 0;

3911  
pKey
;

3912 
	}
}

	@src/callback.c

17 
	~"sqlôeI¡.h
"

23 
	$ˇŒCﬁlNìded
(
sqlôe4
 *
db
, c⁄° *
zName
){

24 if–
db
->
xCﬁlNìded
 ){

25 *
zExã∫Æ
 = 
	`sqlôe4DbSåDup
(
db
, 
zName
);

26 if–!
zExã∫Æ
 ) ;

27 
db
->
	`xCﬁlNìded
(db->
pCﬁlNìdedArg
, db, 
zExã∫Æ
);

28 
	`sqlôe4DbFªe
(
db
, 
zExã∫Æ
);

30 
	}
}

46 
CﬁlSeq
 *
	$sqlôe4GëCﬁlSeq
(

47 
sqlôe4
* 
db
,

48 
CﬁlSeq
 *
pCﬁl
,

49 c⁄° *
zName


51 
CﬁlSeq
 *
p
;

53 
p
 = 
pCﬁl
;

54 if–!
p
 ){

55 
p
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zName
, 0);

57 if–!
p
 || !p->
xCmp
 ){

60 
	`ˇŒCﬁlNìded
(
db
, 
zName
);

61 
p
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zName
, 0);

63 if–
p
 && !p->
xCmp
 )Ö = 0;

65 
	`as£π
–!
p
 ||Ö->
xCmp
 );

66  
p
;

67 
	}
}

80 
	$sqlôe4CheckCﬁlSeq
(
P¨£
 *
pP¨£
, 
CﬁlSeq
 *
pCﬁl
){

81 if–
pCﬁl
 ){

82 c⁄° *
zName
 = 
pCﬁl
->zName;

83 
sqlôe4
 *
db
 = 
pP¨£
->db;

84 
CﬁlSeq
 *
p
 = 
	`sqlôe4GëCﬁlSeq
(
db
, 
pCﬁl
, 
zName
);

85 if–!
p
 ){

86 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuch cﬁœti⁄ sequí˚: %s", 
zName
);

87 
pP¨£
->
nEº
++;

88  
SQLITE4_ERROR
;

90 
	`as£π
–
p
==
pCﬁl
 );

92  
SQLITE4_OK
;

93 
	}
}

106 
CﬁlSeq
 *
	$födCﬁlSeqE¡ry
(

107 
sqlôe4
 *
db
,

108 c⁄° *
zName
,

109 
¸óã


111 
CﬁlSeq
 *
pCﬁl
;

112 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

113 
pCﬁl
 = 
	`sqlôe4HashFöd
(&
db
->
aCﬁlSeq
, 
zName
, 
nName
);

115 if–0==
pCﬁl
 && 
¸óã
 ){

116 
CﬁlSeq
 *
pDñ
;

118 
pCﬁl
 = (
CﬁlSeq
*)
	`sqlôe4DbMÆlocZîo
(
db
, (CﬁlSeq)+
nName
+1);

119 if–
pCﬁl
 ){

120 
pCﬁl
->
zName
 = (*)&pColl[1];

121 
	`mem˝y
(
pCﬁl
->
zName
, zName, 
nName
);

126 
pDñ
 = 
	`sqlôe4HashIn£π
(&
db
->
aCﬁlSeq
, 
pCﬁl
[0].
zName
, 
nName
,ÖColl);

127 
	`as£π
–
pDñ
==0 ||ÖDñ==
pCﬁl
 );

128 if–
pDñ
!=0 ){

129 
db
->
mÆlocFaûed
 = 1;

130 
	`sqlôe4DbFªe
(
db
, 
pDñ
);

131 
pCﬁl
 = 0;

135  
pCﬁl
;

136 
	}
}

152 
CﬁlSeq
 *
	$sqlôe4FödCﬁlSeq
(

153 
sqlôe4
 *
db
,

154 c⁄° *
zName
,

155 
¸óã


157 
CﬁlSeq
 *
pCﬁl
;

158 if–
zName
 ){

159 
pCﬁl
 = 
	`födCﬁlSeqE¡ry
(
db
, 
zName
, 
¸óã
);

161 
pCﬁl
 = 
db
->
pDÊtCﬁl
;

163  
pCﬁl
;

164 
	}
}

178 
	$m©chQuÆôy
(
FuncDef
 *
p
, 
nArg
){

179 if–
nArg
<0 && (
p
->
xFunc
 ||Ö->
xSãp
) )  2;

180 if–
p
->
nArg
==nArg )  2;

181 if–
p
->
nArg
<0 )  1;

183 
	}
}

189 
FuncDef
 *
	$fun˘i⁄Sórch
(

190 
FuncDefTabÀ
 *
pFuncTab
,

191 c⁄° *
zFunc
,

192 
nFunc


194 
FuncDef
 *
p
;

195 if–
nFunc
<0 )ÇFun¯
	`sqlôe4SåÀn30
(
zFunc
);

196 
p
=
pFuncTab
->
pFú°
;Ö;Öı->
pNextName
){

197 if–
	`sqlôe4_°∫icmp
(
p
->
zName
, 
zFunc
, 
nFunc
)==0 &&Ö->zName[nFunc]==0 ){

198  
p
;

202 
	}
}

213 
	$sqlôe4FuncDefIn£π
(

214 
FuncDefTabÀ
 *
pFuncTab
,

215 
FuncDef
 *
pDef
,

216 
isBuûtIn


218 
FuncDef
 *
pOthî
;

219 
	`as£π
–
pDef
->
pSameName
==0 || 
isBuûtIn
 );

220 
	`as£π
–
pDef
->
pNextName
==0 || 
isBuûtIn
 );

221 if–
pFuncTab
->
pFú°
==0 ){

222 
pFuncTab
->
pFú°
 = 
pDef
;

223 
pFuncTab
->
pLa°
 = 
pDef
;

224 
pFuncTab
->
pSame
 = 
pDef
;

225 }if–
isBuûtIn


226 && 
	`sqlôe4_°ricmp
(
pDef
->
zName
, 
pFuncTab
->
pLa°
->zName)==0 ){

227 
	`as£π
–
pFuncTab
->
pSame
->
pSameName
==0 ||ÖFuncTab->pSame->pSameName==
pDef
 );

228 
pFuncTab
->
pSame
->
pSameName
 = 
pDef
;

229 
pFuncTab
->
pSame
 = 
pDef
;

230 }if–!
isBuûtIn
 && (
pOthî
=
	`fun˘i⁄Sórch
(
pFuncTab
,
pDef
->
zName
,-1))!=0 ){

231 
pDef
->
pSameName
 = 
pOthî
->pSameName;

232 
pOthî
->
pSameName
 = 
pDef
;

234 
	`as£π
–
pFuncTab
->
pLa°
->
pNextName
==0 ||ÖFuncTab->pLa°->pNextName==
pDef
 );

235 
pFuncTab
->
pLa°
->
pNextName
 = 
pDef
;

236 
pFuncTab
->
pLa°
 = 
pDef
;

237 
pFuncTab
->
pSame
 = 
pDef
;

239 
	}
}

263 
FuncDef
 *
	$sqlôe4FödFun˘i⁄
(

264 
sqlôe4
 *
db
,

265 c⁄° *
zName
,

266 
nName
,

267 
nArg
,

268 
¸óãFœg


270 
FuncDef
 *
p
;

271 
FuncDef
 *
pBe°
 = 0;

272 
be°Sc‹e
 = 0;

276 
p
 = 
	`fun˘i⁄Sórch
(&
db
->
aFunc
, 
zName
, 
nName
);

277  
p
 ){

278 
sc‹e
 = 
	`m©chQuÆôy
(
p
, 
nArg
);

279 if–
sc‹e
>
be°Sc‹e
 ){

280 
pBe°
 = 
p
;

281 
be°Sc‹e
 = 
sc‹e
;

283 
p
 =Ö->
pSameName
;

298 if–!
¸óãFœg
 && (
pBe°
==0 || (
db
->
Êags
 & 
SQLITE4_Pª„rBuûtö
)!=0) ){

299 
FuncDefTabÀ
 *
pFuncTab
 = &
db
->
pEnv
->
aGlobÆFuncs
;

300 
be°Sc‹e
 = 0;

301 
p
 = 
	`fun˘i⁄Sórch
(
pFuncTab
, 
zName
, 
nName
);

302  
p
 ){

303 
sc‹e
 = 
	`m©chQuÆôy
(
p
, 
nArg
);

304 if–
sc‹e
>
be°Sc‹e
 ){

305 
pBe°
 = 
p
;

306 
be°Sc‹e
 = 
sc‹e
;

308 
p
 =Ö->
pSameName
;

316 if–
¸óãFœg
 && (
be°Sc‹e
<2 || 
pBe°
->
nArg
!=nArg) &&

317 (
pBe°
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (*pBe°)+
nName
+1))!=0 ){

318 
pBe°
->
zName
 = (*)&pBest[1];

319 
pBe°
->
nArg
 = (
u16
)nArg;

320 
	`mem˝y
(
pBe°
->
zName
, zName, 
nName
);

321 
pBe°
->
zName
[
nName
] = 0;

322 
	`sqlôe4FuncDefIn£π
(&
db
->
aFunc
, 
pBe°
, 0);

325 if–
pBe°
 && (pBe°->
xSãp
 ||ÖBe°->
xFunc
 || 
¸óãFœg
) ){

326  
pBe°
;

329 
	}
}

339 
	$sqlôe4SchemaCÀ¨
(
sqlôe4_ív
 *
pEnv
, 
Schema
 *
pSchema
){

340 
Hash
 
ãmp1
;

341 
Hash
 
ãmp2
;

342 
HashEÀm
 *
pEÀm
;

344 
ãmp1
 = 
pSchema
->
tblHash
;

345 
ãmp2
 = 
pSchema
->
åigHash
;

346 
	`sqlôe4HashInô
(
pEnv
, &
pSchema
->
åigHash
, 0);

347 
	`sqlôe4HashCÀ¨
(&
pSchema
->
idxHash
);

348 
pEÀm
=
	`sqlôeHashFú°
(&
ãmp2
);ÖEÀm;ÖEÀm=
	`sqlôeHashNext
(pElem)){

349 
	`sqlôe4DñëeTriggî
(0, (
Triggî
*)
	`sqlôeHashD©a
(
pEÀm
));

351 
	`sqlôe4HashCÀ¨
(&
ãmp2
);

352 
	`sqlôe4HashInô
(
pEnv
, &
pSchema
->
tblHash
, 0);

353 
pEÀm
=
	`sqlôeHashFú°
(&
ãmp1
);ÖEÀm;ÖEÀm=
	`sqlôeHashNext
(pElem)){

354 
TabÀ
 *
pTab
 = 
	`sqlôeHashD©a
(
pEÀm
);

355 
	`sqlôe4DñëeTabÀ
(0, 
pTab
);

357 
	`sqlôe4HashCÀ¨
(&
ãmp1
);

358 
	`sqlôe4HashCÀ¨
(&
pSchema
->
fkeyHash
);

359 
pSchema
->
pSeqTab
 = 0;

360 if–
pSchema
->
Êags
 & 
DB_SchemaLﬂded
 ){

361 
pSchema
->
iGíî©i⁄
++;

362 
pSchema
->
Êags
 &~
DB_SchemaLﬂded
;

364 
	}
}

370 
Schema
 *
	$sqlôe4SchemaGë
(
sqlôe4
 *
db
){

371 
Schema
 * 
p
;

372 
p
 = (
Schema
 *)
	`sqlôe4DbMÆlocZîo
(0, (Schema));

373 if–!
p
 ){

374 
db
->
mÆlocFaûed
 = 1;

375 }i‡–0==
p
->
fûe_f‹m©
 ){

376 
	`sqlôe4HashInô
(
db
->
pEnv
, &
p
->
tblHash
, 0);

377 
	`sqlôe4HashInô
(
db
->
pEnv
, &
p
->
idxHash
, 0);

378 
	`sqlôe4HashInô
(
db
->
pEnv
, &
p
->
åigHash
, 0);

379 
	`sqlôe4HashInô
(
db
->
pEnv
, &
p
->
fkeyHash
, 0);

380 
p
->
íc
 = 
SQLITE4_UTF8
;

382  
p
;

383 
	}
}

	@src/complete.c

19 
	~"sqlôeI¡.h
"

20 #i‚de‡
SQLITE4_OMIT_COMPLETE


25 #i‚de‡
SQLITE4_AMALGAMATION


26 #ifde‡
SQLITE4_ASCII


27 
	#IdCh¨
(
C
Ë((
sqlôe4Cty≥M≠
[()C]&0x46)!=0)

	)

29 #ifde‡
SQLITE4_EBCDIC


30 c⁄° 
sqlôe4IsEbcdicIdCh¨
[];

31 
	#IdCh¨
(
C
Ë(((
c
=C)>=0x42 && 
sqlôe4IsEbcdicIdCh¨
[c-0x40]))

	)

40 
	#tkSEMI
 0

	)

41 
	#tkWS
 1

	)

42 
	#tkOTHER
 2

	)

43 #i‚de‡
SQLITE4_OMIT_TRIGGER


44 
	#tkEXPLAIN
 3

	)

45 
	#tkCREATE
 4

	)

46 
	#tkTEMP
 5

	)

47 
	#tkTRIGGER
 6

	)

48 
	#tkEND
 7

	)

104 
	$sqlôe4_com∂ëe
(c⁄° *
zSql
){

105 
u8
 
°©e
 = 0;

106 
u8
 
tokí
;

108 #i‚de‡
SQLITE4_OMIT_TRIGGER


112 c⁄° 
u8
 
å™s
[8][8] = {

128 c⁄° 
u8
 
å™s
[3][3] = {

137  *
zSql
 ){

138  *
zSql
 ){

140 
tokí
 = 
tkSEMI
;

148 
tokí
 = 
tkWS
;

152 if–
zSql
[1]!='*' ){

153 
tokí
 = 
tkOTHER
;

156 
zSql
 += 2;

157  
zSql
[0] && (zSql[0]!='*' || zSql[1]!='/') ){ zSql++; }

158 if–
zSql
[0]==0 )  0;

159 
zSql
++;

160 
tokí
 = 
tkWS
;

164 if–
zSql
[1]!='-' ){

165 
tokí
 = 
tkOTHER
;

168  *
zSql
 && *zSql!='\n' ){ zSql++; }

169 if–*
zSql
==0 )  
°©e
==1;

170 
tokí
 = 
tkWS
;

174 
zSql
++;

175  *
zSql
 && *zSql!=']' ){ zSql++; }

176 if–*
zSql
==0 )  0;

177 
tokí
 = 
tkOTHER
;

183 
c
 = *
zSql
;

184 
zSql
++;

185  *
zSql
 && *zSql!=
c
 ){ zSql++; }

186 if–*
zSql
==0 )  0;

187 
tokí
 = 
tkOTHER
;

191 #ifde‡
SQLITE4_EBCDIC


192 
c
;

194 if–
	`IdCh¨
((
u8
)*
zSql
) ){

196 
nId
;

197 
nId
=1; 
	`IdCh¨
(
zSql
[nId]);ÇId++){}

198 #ifde‡
SQLITE4_OMIT_TRIGGER


199 
tokí
 = 
tkOTHER
;

201  *
zSql
 ){

203 if–
nId
==6 && 
	`sqlôe4_°∫icmp
(
zSql
, "create", 6)==0 ){

204 
tokí
 = 
tkCREATE
;

206 
tokí
 = 
tkOTHER
;

211 if–
nId
==7 && 
	`sqlôe4_°∫icmp
(
zSql
, "trigger", 7)==0 ){

212 
tokí
 = 
tkTRIGGER
;

213 }if–
nId
==4 && 
	`sqlôe4_°∫icmp
(
zSql
, "temp", 4)==0 ){

214 
tokí
 = 
tkTEMP
;

215 }if–
nId
==9 && 
	`sqlôe4_°∫icmp
(
zSql
, "temporary", 9)==0 ){

216 
tokí
 = 
tkTEMP
;

218 
tokí
 = 
tkOTHER
;

223 if–
nId
==3 && 
	`sqlôe4_°∫icmp
(
zSql
, "end", 3)==0 ){

224 
tokí
 = 
tkEND
;

226 #i‚de‡
SQLITE4_OMIT_EXPLAIN


227 if–
nId
==7 && 
	`sqlôe4_°∫icmp
(
zSql
, "explain", 7)==0 ){

228 
tokí
 = 
tkEXPLAIN
;

232 
tokí
 = 
tkOTHER
;

237 
tokí
 = 
tkOTHER
;

242 
zSql
 +
nId
-1;

245 
tokí
 = 
tkOTHER
;

250 
°©e
 = 
å™s
[°©e][
tokí
];

251 
zSql
++;

253  
°©e
==1;

254 
	}
}

256 #i‚de‡
SQLITE4_OMIT_UTF16


262 
	$sqlôe4_com∂ëe16
(c⁄° *
zSql
){

263 
sqlôe4_vÆue
 *
pVÆ
;

264 c⁄° *
zSql8
;

265 
rc
 = 
SQLITE4_NOMEM
;

267 #i‚de‡
SQLITE4_OMIT_AUTOINIT


268 
rc
 = 
	`sqlôe4_öôülize
(0);

269 if–
rc
 ) Ñc;

271 
pVÆ
 = 
	`sqlôe4VÆueNew
(0);

272 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
zSql
, 
SQLITE4_UTF16NATIVE
, 
SQLITE4_STATIC
, 0);

273 
zSql8
 = 
	`sqlôe4VÆueText
(
pVÆ
, 
SQLITE4_UTF8
);

274 if–
zSql8
 ){

275 
rc
 = 
	`sqlôe4_com∂ëe
(
zSql8
);

277 
rc
 = 
SQLITE4_NOMEM
;

279 
	`sqlôe4VÆueFªe
(
pVÆ
);

280  
	`sqlôe4ApiExô
(0, 
rc
);

281 
	}
}

	@src/ctime.c

17 #i‚de‡
SQLITE4_OMIT_COMPILEOPTION_DIAGS


19 
	~"sqlôeI¡.h
"

29 c⁄° * c⁄° 
	gazCompûeO±
[] = {

33 
	#CTIMEOPT_VAL_
(
›t
Ë#›t

	)

34 
	#CTIMEOPT_VAL
(
›t
Ë
	`CTIMEOPT_VAL_
(›t)

	)

36 #ifde‡
SQLITE4_32BIT_ROWID


39 #ifde‡
SQLITE4_4_BYTE_ALIGNED_MALLOC


42 #ifde‡
SQLITE4_CASE_SENSITIVE_LIKE


45 #ifde‡
SQLITE4_CHECK_PAGES


48 #ifde‡
SQLITE4_COVERAGE_TEST


51 #ifde‡
SQLITE4_DEBUG


54 #ifde‡
SQLITE4_DEFAULT_LOCKING_MODE


55 "DEFAULT_LOCKING_MODE=" 
CTIMEOPT_VAL
(
SQLITE4_DEFAULT_LOCKING_MODE
),

57 #ifde‡
SQLITE4_DISABLE_DIRSYNC


60 #ifde‡
SQLITE4_DISABLE_LFS


63 #ifde‡
SQLITE4_ENABLE_ATOMIC_WRITE


66 #ifde‡
SQLITE4_ENABLE_CEROD


69 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


72 #ifde‡
SQLITE4_ENABLE_EXPENSIVE_ASSERT


75 #ifde‡
SQLITE4_ENABLE_FTS1


78 #ifde‡
SQLITE4_ENABLE_FTS2


81 #ifde‡
SQLITE4_ENABLE_FTS3


84 #ifde‡
SQLITE4_ENABLE_FTS3_PARENTHESIS


87 #ifde‡
SQLITE4_ENABLE_FTS4


90 #ifde‡
SQLITE4_ENABLE_ICU


93 #ifde‡
SQLITE4_ENABLE_IOTRACE


96 #ifde‡
SQLITE4_ENABLE_LOAD_EXTENSION


99 #ifde‡
SQLITE4_ENABLE_LOCKING_STYLE


100 "ENABLE_LOCKING_STYLE=" 
CTIMEOPT_VAL
(
SQLITE4_ENABLE_LOCKING_STYLE
),

102 #ifde‡
SQLITE4_ENABLE_MEMSYS3


105 #ifde‡
SQLITE4_ENABLE_MEMSYS5


108 #ifde‡
SQLITE4_ENABLE_OVERSIZE_CELL_CHECK


111 #ifde‡
SQLITE4_ENABLE_RTREE


114 #ifde‡
SQLITE4_ENABLE_STAT3


117 #ifde‡
SQLITE4_ENABLE_UNLOCK_NOTIFY


120 #ifde‡
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT


123 #ifde‡
SQLITE4_HAS_CODEC


126 #ifde‡
SQLITE4_HAVE_ISNAN


129 #ifde‡
SQLITE4_HOMEGROWN_RECURSIVE_MUTEX


132 #ifde‡
SQLITE4_IGNORE_AFP_LOCK_ERRORS


135 #ifde‡
SQLITE4_IGNORE_FLOCK_LOCK_ERRORS


138 #ifde‡
SQLITE4_INT64_TYPE


141 #ifde‡
SQLITE4_LOCK_TRACE


144 #ifde‡
SQLITE4_MAX_SCHEMA_RETRY


145 "MAX_SCHEMA_RETRY=" 
CTIMEOPT_VAL
(
SQLITE4_MAX_SCHEMA_RETRY
),

147 #ifde‡
SQLITE4_MEMDEBUG


150 #ifde‡
SQLITE4_MIXED_ENDIAN_64BIT_FLOAT


153 #ifde‡
SQLITE4_NO_SYNC


156 #ifde‡
SQLITE4_OMIT_ALTERTABLE


159 #ifde‡
SQLITE4_OMIT_ANALYZE


162 #ifde‡
SQLITE4_OMIT_ATTACH


165 #ifde‡
SQLITE4_OMIT_AUTHORIZATION


168 #ifde‡
SQLITE4_OMIT_AUTOINCREMENT


171 #ifde‡
SQLITE4_OMIT_AUTOINIT


174 #ifde‡
SQLITE4_OMIT_AUTOMATIC_INDEX


177 #ifde‡
SQLITE4_OMIT_AUTORESET


180 #ifde‡
SQLITE4_OMIT_BETWEEN_OPTIMIZATION


183 #ifde‡
SQLITE4_OMIT_BLOB_LITERAL


186 #ifde‡
SQLITE4_OMIT_BUILTIN_TEST


189 #ifde‡
SQLITE4_OMIT_CAST


192 #ifde‡
SQLITE4_OMIT_CHECK


200 #ifde‡
SQLITE4_OMIT_COMPLETE


203 #ifde‡
SQLITE4_OMIT_COMPOUND_SELECT


206 #ifde‡
SQLITE4_OMIT_DATETIME_FUNCS


209 #ifde‡
SQLITE4_OMIT_DECLTYPE


212 #ifde‡
SQLITE4_OMIT_DEPRECATED


215 #ifde‡
SQLITE4_OMIT_DISKIO


218 #ifde‡
SQLITE4_OMIT_EXPLAIN


221 #ifde‡
SQLITE4_OMIT_FLAG_PRAGMAS


224 #ifde‡
SQLITE4_OMIT_FLOATING_POINT


227 #ifde‡
SQLITE4_OMIT_FOREIGN_KEY


230 #ifde‡
SQLITE4_OMIT_GET_TABLE


233 #ifde‡
SQLITE4_OMIT_INTEGRITY_CHECK


236 #ifde‡
SQLITE4_OMIT_LIKE_OPTIMIZATION


239 #ifde‡
SQLITE4_OMIT_LOAD_EXTENSION


242 #ifde‡
SQLITE4_OMIT_LOCALTIME


245 #ifde‡
SQLITE4_OMIT_LOOKASIDE


248 #ifde‡
SQLITE4_OMIT_MEMORYDB


251 #ifde‡
SQLITE4_OMIT_OR_OPTIMIZATION


254 #ifde‡
SQLITE4_OMIT_PAGER_PRAGMAS


257 #ifde‡
SQLITE4_OMIT_PRAGMA


260 #ifde‡
SQLITE4_OMIT_PROGRESS_CALLBACK


263 #ifde‡
SQLITE4_OMIT_QUICKBALANCE


266 #ifde‡
SQLITE4_OMIT_REINDEX


269 #ifde‡
SQLITE4_OMIT_SCHEMA_PRAGMAS


272 #ifde‡
SQLITE4_OMIT_SCHEMA_VERSION_PRAGMAS


275 #ifde‡
SQLITE4_OMIT_SUBQUERY


278 #ifde‡
SQLITE4_OMIT_TCL_VARIABLE


281 #ifde‡
SQLITE4_OMIT_TEMPDB


284 #ifde‡
SQLITE4_OMIT_TRACE


287 #ifde‡
SQLITE4_OMIT_TRIGGER


290 #ifde‡
SQLITE4_OMIT_TRUNCATE_OPTIMIZATION


293 #ifde‡
SQLITE4_OMIT_UTF16


296 #ifde‡
SQLITE4_OMIT_VIEW


299 #ifde‡
SQLITE4_OMIT_VIRTUALTABLE


302 #ifde‡
SQLITE4_PERFORMANCE_TRACE


305 #ifde‡
SQLITE4_PROXY_DEBUG


308 #ifde‡
SQLITE4_SECURE_DELETE


311 #ifde‡
SQLITE4_SMALL_STACK


314 #ifde‡
SQLITE4_SOUNDEX


317 #ifde‡
SQLITE4_TCL


320 #ifde‡
SQLITE4_TEMP_STORE


321 "TEMP_STORE=" 
CTIMEOPT_VAL
(
SQLITE4_TEMP_STORE
),

323 #ifde‡
SQLITE4_TEST


326 #ifde‡
SQLITE4_THREADSAFE


327 "THREADSAFE=" 
CTIMEOPT_VAL
(
SQLITE4_THREADSAFE
),

329 #ifde‡
SQLITE4_USE_ALLOCA


332 #ifde‡
SQLITE4_ZERO_MALLOC


344 
	$sqlôe4_compûe›ti⁄_u£d
(c⁄° *
zO±Name
){

345 
i
, 
n
;

346 if–
	`sqlôe4_°∫icmp
(
zO±Name
, "SQLITE4_", 8)==0 ) zOptName += 8;

347 
n
 = 
	`sqlôe4SåÀn30
(
zO±Name
);

351 
i
=0; i<
	`AºaySize
(
azCompûeO±
); i++){

352 if–(
	`sqlôe4_°∫icmp
(
zO±Name
, 
azCompûeO±
[
i
], 
n
)==0)

353 && ( (
azCompûeO±
[
i
][
n
]==0) || (azCompileOpt[i][n]=='=') ) )  1;

356 
	}
}

362 c⁄° *
	$sqlôe4_compûe›ti⁄_gë
(
N
){

363 if–
N
>=0 && N<
	`AºaySize
(
azCompûeO±
) ){

364  
azCompûeO±
[
N
];

367 
	}
}

	@src/date.c

46 
	~"sqlôeI¡.h
"

47 
	~<°dlib.h
>

48 
	~<as£π.h
>

49 
	~<time.h
>

51 #i‚de‡
SQLITE4_OMIT_DATETIME_FUNCS


57 
D©eTime
 
	tD©eTime
;

58 
	sD©eTime
 {

59 
sqlôe4_uöt64
 
	miJD
;

60 
	mY
, 
	mM
, 
	mD
;

61 
	mh
, 
	mm
;

62 
	mtz
;

63 
sqlôe4_num
 
	ms
;

64 
	mvÆidYMD
;

65 
	mvÆidHMS
;

66 
	mvÆidJD
;

67 
	mvÆidTZ
;

84 
	$gëDigôs
(c⁄° *
zD©e
, ...){

85 
va_li°
 
≠
;

86 
vÆ
;

87 
N
;

88 
mö
;

89 
max
;

90 
√xtC
;

91 *
pVÆ
;

92 
˙t
 = 0;

93 
	`va_°¨t
(
≠
, 
zD©e
);

95 
N
 = 
	`va_¨g
(
≠
, );

96 
mö
 = 
	`va_¨g
(
≠
, );

97 
max
 = 
	`va_¨g
(
≠
, );

98 
√xtC
 = 
	`va_¨g
(
≠
, );

99 
pVÆ
 = 
	`va_¨g
(
≠
, *);

100 
vÆ
 = 0;

101  
N
-- ){

102 if–!
	`sqlôe4Isdigô
(*
zD©e
) ){

103 
íd_gëDigôs
;

105 
vÆ
 = vÆ*10 + *
zD©e
 - '0';

106 
zD©e
++;

108 if–
vÆ
<
mö
 || vÆ>
max
 || (
√xtC
!=0 &&ÇextC!=*
zD©e
) ){

109 
íd_gëDigôs
;

111 *
pVÆ
 = 
vÆ
;

112 
zD©e
++;

113 
˙t
++;

114 } 
√xtC
 );

115 
íd_gëDigôs
:

116 
	`va_íd
(
≠
);

117  
˙t
;

118 
	}
}

136 
	$∑r£Timez⁄e
(c⁄° *
zD©e
, 
D©eTime
 *
p
){

137 
sgn
 = 0;

138 
nHr
, 
nMn
;

139 
c
;

140  
	`sqlôe4Is•a˚
(*
zD©e
) ){ zDate++; }

141 
p
->
tz
 = 0;

142 
c
 = *
zD©e
;

143 if–
c
=='-' ){

144 
sgn
 = -1;

145 }if–
c
=='+' ){

146 
sgn
 = +1;

147 }if–
c
=='Z' || c=='z' ){

148 
zD©e
++;

149 
zulu_time
;

151  
c
!=0;

153 
zD©e
++;

154 if–
	`gëDigôs
(
zD©e
, 2, 0, 14, ':', &
nHr
, 2, 0, 59, 0, &
nMn
)!=2 ){

157 
zD©e
 += 5;

158 
p
->
tz
 = 
sgn
*(
nMn
 + 
nHr
*60);

159 
zulu_time
:

160  
	`sqlôe4Is•a˚
(*
zD©e
) ){ zDate++; }

161  *
zD©e
!=0;

162 
	}
}

171 
	$∑r£HhMmSs
(c⁄° *
zD©e
, 
D©eTime
 *
p
){

172 
h
, 
m
, 
s
;

173 
sqlôe4_num
 
ms
 = {0,0,0,0};

174 if–
	`gëDigôs
(
zD©e
, 2, 0, 24, ':', &
h
, 2, 0, 59, 0, &
m
)!=2 ){

177 
zD©e
 += 5;

178 if–*
zD©e
==':' ){

179 
zD©e
++;

180 if–
	`gëDigôs
(
zD©e
, 2, 0, 59, 0, &
s
)!=1 ){

183 
zD©e
 += 2;

185 if–*
zD©e
=='.' ){

186 
iMs
 = 0;

187 
nDigô
 = 1;

188  
	`sqlôe4Isdigô
(
zD©e
[
nDigô
]) ){

189 
iMs
 = iM†* 10 + (
zD©e
[
nDigô
] - '0');

190 
nDigô
++;

192 if–
nDigô
>1 ){

193 
ms
 = 
	`sqlôe4_num_‰om_öt64
(
iMs
);

194 
	`as£π
–
ms
.
e
==0 );

195 
ms
.
e
 +(1-
nDigô
);

196 
zD©e
 +
nDigô
;

200 
s
 = 0;

202 
p
->
vÆidJD
 = 0;

203 
p
->
vÆidHMS
 = 1;

204 
p
->
h
 = h;

205 
p
->
m
 = m;

206 
p
->
s
 = 
	`sqlôe4_num_add
(
	`sqlôe4_num_‰om_öt64
(s), 
ms
);

207 if–
	`∑r£Timez⁄e
(
zD©e
, 
p
) )  1;

208 
p
->
vÆidTZ
 = (p->
tz
!=0)?1:0;

210 
	}
}

218 
	$compuãJD
(
D©eTime
 *
p
){

219 
Y
, 
M
, 
D
, 
A
, 
B
, 
X1
, 
X2
;

221 if–
p
->
vÆidJD
 ) ;

222 if–
p
->
vÆidYMD
 ){

223 
Y
 = 
p
->Y;

224 
M
 = 
p
->M;

225 
D
 = 
p
->D;

227 
Y
 = 2000;

228 
M
 = 1;

229 
D
 = 1;

231 if–
M
<=2 ){

232 
Y
--;

233 
M
 += 12;

235 
A
 = 
Y
/100;

236 
B
 = 2 - 
A
 + (A/4);

237 
X1
 = 36525*(
Y
+4716)/100;

238 
X2
 = 306001*(
M
+1)/10000;

239 
p
->
iJD
 = (
sqlôe4_öt64
)((
X1
 + 
X2
 + 
D
 + 
B
 - 1524.5 ) * 86400000);

240 
p
->
vÆidJD
 = 1;

241 if–
p
->
vÆidHMS
 ){

242 
p
->
iJD
 +p->
h
*3600000 +Ö->
m
*60000;

243 
p
->
iJD
 +
	`sqlôe4_num_to_öt64
(

244 
	`sqlôe4_num_mul
(
p
->
s
, 
	`sqlôe4_num_‰om_öt64
(1000)), 0

246 if–
p
->
vÆidTZ
 ){

247 
p
->
iJD
 -p->
tz
*60000;

248 
p
->
vÆidYMD
 = 0;

249 
p
->
vÆidHMS
 = 0;

250 
p
->
vÆidTZ
 = 0;

253 
	}
}

267 
	$∑r£YyyyMmDd
(c⁄° *
zD©e
, 
D©eTime
 *
p
){

268 
Y
, 
M
, 
D
, 
√g
;

270 if–
zD©e
[0]=='-' ){

271 
zD©e
++;

272 
√g
 = 1;

274 
√g
 = 0;

276 if–
	`gëDigôs
(
zD©e
,4,0,9999,'-',&
Y
,2,1,12,'-',&
M
,2,1,31,0,&
D
)!=3 ){

279 
zD©e
 += 10;

280  
	`sqlôe4Is•a˚
(*
zD©e
Ë|| 'T'==*(
u8
*)zDate ){ zDate++; }

281 if–
	`∑r£HhMmSs
(
zD©e
, 
p
)==0 ){

283 }if–*
zD©e
==0 ){

284 
p
->
vÆidHMS
 = 0;

288 
p
->
vÆidJD
 = 0;

289 
p
->
vÆidYMD
 = 1;

290 
p
->
Y
 = 
√g
 ? -Y : Y;

291 
p
->
M
 = M;

292 
p
->
D
 = D;

293 if–
p
->
vÆidTZ
 ){

294 
	`compuãJD
(
p
);

297 
	}
}

304 
	$£tD©eTimeToCuºít
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
D©eTime
 *
p
){

305 if–
	`sqlôe4OsCuºítTime
(0, &
p
->
iJD
)==
SQLITE4_OK
 ){

306 
p
->
vÆidJD
 = 1;

311 
	}
}

329 
	$∑r£D©eOrTime
(

330 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

331 c⁄° *
zD©e
,

332 
D©eTime
 *
p


334 if–
	`∑r£YyyyMmDd
(
zD©e
,
p
)==0 ){

336 }if–
	`∑r£HhMmSs
(
zD©e
, 
p
)==0 ){

338 }if–
	`sqlôe4_°ricmp
(
zD©e
,"now")==0){

339  
	`£tD©eTimeToCuºít
(
c⁄ãxt
, 
p
);

341 
sqlôe4_num
 
num
;

342 
num
 = 
	`sqlôe4_num_‰om_ãxt
(
zD©e
, -1, 
SQLITE4_IGNORE_WHITESPACE
, 0);

343 if–
	`sqlôe4_num_i¢™
(
num
)==0 ){

344 c⁄° 
sqlôe4_num
 
⁄e_hÆf
 = {0, 0, -1, 5};

346 
num
 = 
	`sqlôe4_num_mul
“um, 
	`sqlôe4_num_‰om_öt64
(86400000));

347 
num
 = 
	`sqlôe4_num_add
“um, 
⁄e_hÆf
);

348 
p
->
iJD
 = 
	`sqlôe4_num_to_öt64
(
num
, 0);

349 
p
->
vÆidJD
 = 1;

354 
	}
}

359 
	$compuãYMD
(
D©eTime
 *
p
){

360 
Z
, 
A
, 
B
, 
C
, 
D
, 
E
, 
X1
;

361 if–
p
->
vÆidYMD
 ) ;

362 if–!
p
->
vÆidJD
 ){

363 
p
->
Y
 = 2000;

364 
p
->
M
 = 1;

365 
p
->
D
 = 1;

367 
Z
 = ()((
p
->
iJD
 + 43200000)/86400000);

368 
A
 = ()((
Z
 - 1867216.25)/36524.25);

369 
A
 = 
Z
 + 1 + A - (A/4);

370 
B
 = 
A
 + 1524;

371 
C
 = ()((
B
 - 122.1)/365.25);

372 
D
 = (36525*
C
)/100;

373 
E
 = ()((
B
-
D
)/30.6001);

374 
X1
 = ()(30.6001*
E
);

375 
p
->
D
 = 
B
 - D - 
X1
;

376 
p
->
M
 = 
E
<14 ? E-1 : E-13;

377 
p
->
Y
 =Ö->
M
>2 ? 
C
 - 4716 : C - 4715;

379 
p
->
vÆidYMD
 = 1;

380 
	}
}

385 
	$compuãHMS
(
D©eTime
 *
p
){

386 
s
;

387 if–
p
->
vÆidHMS
 ) ;

388 
	`compuãJD
(
p
);

389 
s
 = ()((
p
->
iJD
 + 43200000) % 86400000);

390 
p
->
s
 = 
	`sqlôe4_num_div
(

391 
	`sqlôe4_num_‰om_öt64
(
s
), sqlite4_num_from_int64(1000)

393 
s
 = ()
	`sqlôe4_num_to_öt64
(
p
->s, 0);

394 
p
->
s
 = 
	`sqlôe4_num_sub
’->s, 
	`sqlôe4_num_‰om_öt64
(s));

395 
p
->
h
 = 
s
/3600;

396 
s
 -
p
->
h
*3600;

397 
p
->
m
 = 
s
/60;

398 
p
->
s
 = 
	`sqlôe4_num_add
’->s, 
	`sqlôe4_num_‰om_öt64
(†-Ö->
m
*60));

399 
p
->
vÆidHMS
 = 1;

400 
	}
}

405 
	$compuãYMD_HMS
(
D©eTime
 *
p
){

406 
	`compuãYMD
(
p
);

407 
	`compuãHMS
(
p
);

408 
	}
}

413 
	$˛órYMD_HMS_TZ
(
D©eTime
 *
p
){

414 
p
->
vÆidYMD
 = 0;

415 
p
->
vÆidHMS
 = 0;

416 
p
->
vÆidTZ
 = 0;

417 
	}
}

431 #i‡!
deföed
(
HAVE_LOCALTIME_R
Ë&& !deföed(
HAVE_LOCALTIME_S
) && \

432 
deföed
(
_MSC_VER
Ë&& 
	$deföed
(
_CRT_INSECURE_DEPRECATE
)

433 
	#HAVE_LOCALTIME_S
 1

	)

436 #i‚de‡
SQLITE4_OMIT_LOCALTIME


446 
	$osLoˇ…ime
(
time_t
 *
t
, 
tm
 *
pTm
){

447 
rc
;

448 #i‡(!
	`deföed
(
HAVE_LOCALTIME_R
) || !HAVE_LOCALTIME_R) \

449 && (!
	`deföed
(
HAVE_LOCALTIME_S
) || !HAVE_LOCALTIME_S)

450 
tm
 *
pX
;

451 #i‡
SQLITE4_THREADSAFE
>0

452 
sqlôe4_muãx
 *
muãx
 = 
	`sqlôe4MuãxAŒoc
(
SQLITE4_MUTEX_STATIC_MASTER
);

454 
	`sqlôe4_muãx_íãr
(
muãx
);

455 
pX
 = 
	`loˇ…ime
(
t
);

456 #i‚de‡
SQLITE4_OMIT_BUILTIN_TEST


457 if–
sqlôe4DeÁu…Env
.
bLoˇ…imeFau…
 ) 
pX
 = 0;

459 if–
pX
 ) *
pTm
 = *pX;

460 
	`sqlôe4_muãx_Àave
(
muãx
);

461 
rc
 = 
pX
==0;

463 #i‚de‡
SQLITE4_OMIT_BUILTIN_TEST


464 if–
sqlôe4DeÁu…Env
.
bLoˇ…imeFau…
 )  1;

466 #i‡
	`deföed
(
HAVE_LOCALTIME_R
) && HAVE_LOCALTIME_R

467 
rc
 = 
	`loˇ…ime_r
(
t
, 
pTm
)==0;

469 
rc
 = 
	`loˇ…ime_s
(
pTm
, 
t
);

472  
rc
;

473 
	}
}

477 #i‚de‡
SQLITE4_OMIT_LOCALTIME


486 
sqlôe4_öt64
 
	$loˇ…imeOff£t
(

487 
D©eTime
 *
p
,

488 
sqlôe4_c⁄ãxt
 *
pCtx
,

489 *
pRc


491 
D©eTime
 
x
, 
y
;

492 
time_t
 
t
;

493 
tm
 
sLoˇl
;

496 
	`mem£t
(&
sLoˇl
, 0, (sLocal));

498 
x
 = *
p
;

499 
	`compuãYMD_HMS
(&
x
);

500 if–
x
.
Y
<1971 || x.Y>=2038 ){

501 
x
.
Y
 = 2000;

502 
x
.
M
 = 1;

503 
x
.
D
 = 1;

504 
x
.
h
 = 0;

505 
x
.
m
 = 0;

506 
x
.
s
 = 0.0;

508 
s
 = ()(
x
.s + 0.5);

509 
x
.
s
 = s;

511 
x
.
tz
 = 0;

512 
x
.
vÆidJD
 = 0;

513 
	`compuãJD
(&
x
);

514 
t
 = (
time_t
)(
x
.
iJD
/1000 - 21086676*(
i64
)10000);

515 if–
	`osLoˇ…ime
(&
t
, &
sLoˇl
) ){

516 
	`sqlôe4_ªsu…_îr‹
(
pCtx
, "localÅime unavailable", -1);

517 *
pRc
 = 
SQLITE4_ERROR
;

520 
y
.
Y
 = 
sLoˇl
.
tm_yór
 + 1900;

521 
y
.
M
 = 
sLoˇl
.
tm_m⁄
 + 1;

522 
y
.
D
 = 
sLoˇl
.
tm_mday
;

523 
y
.
h
 = 
sLoˇl
.
tm_hour
;

524 
y
.
m
 = 
sLoˇl
.
tm_mö
;

525 
y
.
s
 = 
sLoˇl
.
tm_£c
;

526 
y
.
vÆidYMD
 = 1;

527 
y
.
vÆidHMS
 = 1;

528 
y
.
vÆidJD
 = 0;

529 
y
.
vÆidTZ
 = 0;

530 
	`compuãJD
(&
y
);

531 *
pRc
 = 
SQLITE4_OK
;

532  
y
.
iJD
 - 
x
.iJD;

533 
	}
}

536 
sqlôe4_öt64
 
	$mu…ùlyAndRound
(
sqlôe4_num
 
a
, 
i64
 
b
){

537 c⁄° 
sqlôe4_num
 
aRnd
[2] = { {0, 0, -1, 5}, {1, 0, -1, 5} };

538 
sqlôe4_num
 
ªs
;

540 
ªs
 = 
	`sqlôe4_num_mul
(
a
, 
	`sqlôe4_num_‰om_öt64
(
b
));

541 
	`as£π
–
ªs
.
sign
==0 ||Ñes.sign==1 );

542 
ªs
 = 
	`sqlôe4_num_add
‘es, 
aRnd
[ªs.
sign
]);

543  
	`sqlôe4_num_to_öt64
(
ªs
, 0);

544 
	}
}

570 
	$∑r£Modifõr
(

571 
sqlôe4_c⁄ãxt
 *
pCtx
,

572 c⁄° *
zMod
,

573 
D©eTime
 *
p


575 
rc
 = 1;

576 
n
;

577 *
z
, 
zBuf
[30];

578 
z
 = 
zBuf
;

579 
n
=0;Ç<
	`AºaySize
(
zBuf
)-1 && 
zMod
[n];Ç++){

580 
z
[
n
] = ()
sqlôe4UµîToLowî
[(
u8
)
zMod
[n]];

582 
z
[
n
] = 0;

583  
z
[0] ){

584 #i‚de‡
SQLITE4_OMIT_LOCALTIME


591 if–
	`°rcmp
(
z
, "localtime")==0 ){

592 
	`compuãJD
(
p
);

593 
p
->
iJD
 +
	`loˇ…imeOff£t
’, 
pCtx
, &
rc
);

594 
	`˛órYMD_HMS_TZ
(
p
);

606 if–
	`°rcmp
(
z
, "unixïoch")==0 && 
p
->
vÆidJD
 ){

607 
p
->
iJD
 = (p->iJD + 43200)/86400 + 21086676*(
i64
)10000000;

608 
	`˛órYMD_HMS_TZ
(
p
);

609 
rc
 = 0;

611 #i‚de‡
SQLITE4_OMIT_LOCALTIME


612 if–
	`°rcmp
(
z
, "utc")==0 ){

613 
sqlôe4_öt64
 
c1
;

614 
	`compuãJD
(
p
);

615 
c1
 = 
	`loˇ…imeOff£t
(
p
, 
pCtx
, &
rc
);

616 if–
rc
==
SQLITE4_OK
 ){

617 
p
->
iJD
 -
c1
;

618 
	`˛órYMD_HMS_TZ
(
p
);

619 
p
->
iJD
 +
c1
 - 
	`loˇ…imeOff£t
’, 
pCtx
, &
rc
);

633 if–
	`°∫cmp
(
z
, "weekday ", 8)==0 ){

634 
bLossy
;

635 
iWìkday
;

636 
sqlôe4_öt64
 
Z
;

637 
sqlôe4_num
 
w
;

638 
n
;

640 
n
=8; 
	`sqlôe4Is•a˚
(
z
[n]);Ç++);

641 if–
z
[
n
]==0 ) ;

642 
w
 = 
	`sqlôe4_num_‰om_ãxt
(&
z
[8], -1, 
SQLITE4_IGNORE_WHITESPACE
, 0);

643 if–
	`sqlôe4_num_i¢™
(
w
) ) ;

644 
iWìkday
 = ()
	`sqlôe4_num_to_öt64
(
w
, &
bLossy
);

645 if–
bLossy
 || 
iWìkday
<0 || iWeekday>6 ) ;

647 
	`compuãYMD_HMS
(
p
);

648 
p
->
vÆidTZ
 = 0;

649 
p
->
vÆidJD
 = 0;

650 
	`compuãJD
(
p
);

651 
Z
 = ((
p
->
iJD
 + 129600000)/86400000) % 7;

652 if–
Z
>
iWìkday
 ) Z -= 7;

653 
p
->
iJD
 +(
iWìkday
 - 
Z
)*86400000;

654 
	`˛órYMD_HMS_TZ
(
p
);

655 
rc
 = 0;

666 if–
	`°∫cmp
(
z
, "start of ", 9)!=0 ) ;

667 
z
 += 9;

668 
	`compuãYMD
(
p
);

669 
p
->
vÆidHMS
 = 1;

670 
p
->
h
 =Ö->
m
 = 0;

671 
	`mem£t
(&
p
->
s
, 0, (
sqlôe4_num
));

672 
p
->
vÆidTZ
 = 0;

673 
p
->
vÆidJD
 = 0;

674 if–
	`°rcmp
(
z
,"month")==0 ){

675 
p
->
D
 = 1;

676 
rc
 = 0;

677 }if–
	`°rcmp
(
z
,"year")==0 ){

678 
	`compuãYMD
(
p
);

679 
p
->
M
 = 1;

680 
p
->
D
 = 1;

681 
rc
 = 0;

682 }if–
	`°rcmp
(
z
,"day")==0 ){

683 
rc
 = 0;

699 
sqlôe4_num
 
num
;

701 
n
=1; 
z
[n] && z[n]!=':' && !
	`sqlôe4Is•a˚
(z[n]);Ç++){}

702 
num
 = 
	`sqlôe4_num_‰om_ãxt
(
z
, 
n
, 
SQLITE4_IGNORE_WHITESPACE
, 0);

703 if–
	`sqlôe4_num_i¢™
(
num
) ){

704 
rc
 = 1;

708 if–
z
[
n
]==':' ){

714 c⁄° *
z2
 = 
z
;

715 
D©eTime
 
tx
;

716 
sqlôe4_öt64
 
day
;

717 if–!
	`sqlôe4Isdigô
(*
z2
) ) z2++;

718 
	`mem£t
(&
tx
, 0, (tx));

719 if–
	`∑r£HhMmSs
(
z2
, &
tx
) ) ;

720 
	`compuãJD
(&
tx
);

721 
tx
.
iJD
 -= 43200000;

722 
day
 = 
tx
.
iJD
/86400000;

723 
tx
.
iJD
 -
day
*86400000;

724 if–
z
[0]=='-' ) 
tx
.
iJD
 = -tx.iJD;

725 
	`compuãJD
(
p
);

726 
	`˛órYMD_HMS_TZ
(
p
);

727 
p
->
iJD
 +
tx
.iJD;

728 
rc
 = 0;

732 
z
 +
n
;

733  
	`sqlôe4Is•a˚
(*
z
) ) z++;

734 
n
 = 
	`sqlôe4SåÀn30
(
z
);

735 if–
n
>10 ||Ç<3 ) ;

736 if–
z
[
n
-1]=='s' ){ z[n-1] = 0;Ç--; }

737 
	`compuãJD
(
p
);

738 
rc
 = 0;

740 if–
n
==3 && 
	`°rcmp
(
z
,"day")==0 ){

741 
p
->
iJD
 +
	`mu…ùlyAndRound
(
num
, 86400000);

742 }if–
n
==4 && 
	`°rcmp
(
z
,"hour")==0 ){

743 
p
->
iJD
 +
	`mu…ùlyAndRound
(
num
, 86400000 / 24);

744 }if–
n
==6 && 
	`°rcmp
(
z
,"minute")==0 ){

745 
p
->
iJD
 +
	`mu…ùlyAndRound
(
num
, 86400000 / (24 * 60));

746 }if–
n
==6 && 
	`°rcmp
(
z
,"second")==0 ){

747 
p
->
iJD
 +
	`mu…ùlyAndRound
(
num
, 86400000 / (24 * 60 * 60));

748 }if–
n
==5 && 
	`°rcmp
(
z
,"month")==0 ){

749 
bLossy
;

750 
nM⁄th
;

751 
x
;

752 
nM⁄th
 = 
	`sqlôe4_num_to_öt64
(
num
, &
bLossy
);

753 
	`compuãYMD_HMS
(
p
);

754 
p
->
M
 +
nM⁄th
;

755 
x
 = 
p
->
M
>0 ? (p->M-1)/12 : (p->M-12)/12;

756 
p
->
Y
 +
x
;

757 
p
->
M
 -
x
*12;

758 
p
->
vÆidJD
 = 0;

759 
	`compuãJD
(
p
);

760 if–
bLossy
 ){

761 
num
 = 
	`sqlôe4_num_sub
“um, 
	`sqlôe4_num_‰om_öt64
(
nM⁄th
));

762 
p
->
iJD
 +
	`mu…ùlyAndRound
(
num
, (
i64
)30*86400000);

764 }if–
n
==4 && 
	`°rcmp
(
z
,"year")==0 ){

765 
bLossy
;

766 
nYór
;

767 
nYór
 = 
	`sqlôe4_num_to_öt64
(
num
, &
bLossy
);

768 
	`compuãYMD_HMS
(
p
);

769 
p
->
Y
 +
nYór
;

770 
p
->
vÆidJD
 = 0;

771 
	`compuãJD
(
p
);

772 if–
bLossy
 ){

773 
num
 = 
	`sqlôe4_num_sub
“um, 
	`sqlôe4_num_‰om_öt64
(
nYór
));

774 
p
->
iJD
 +
	`mu…ùlyAndRound
(
num
, (
i64
)365*86400000);

777 
rc
 = 1;

779 
	`˛órYMD_HMS_TZ
(
p
);

786  
rc
;

787 
	}
}

798 
	$isD©e
(

799 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

800 
¨gc
,

801 
sqlôe4_vÆue
 **
¨gv
,

802 
D©eTime
 *
p


804 c⁄° 
sqlôe4_num
 
ms_≥r_day
 = {0, 0, 0, 86400000};

806 
i
;

807 c⁄° *
z
;

808 
eTy≥
;

809 
	`mem£t
(
p
, 0, (*p));

810 if–
¨gc
==0 ){

811  
	`£tD©eTimeToCuºít
(
c⁄ãxt
, 
p
);

813 
eTy≥
 = 
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]);

814 if–
eTy≥
==
SQLITE4_FLOAT
 ||ÉTy≥==
SQLITE4_INTEGER
 ){

815 
sqlôe4_num
 
jd
 = 
	`sqlôe4_num_mul
(
	`sqlôe4_vÆue_num
(
¨gv
[0]), 
ms_≥r_day
);

816 
p
->
iJD
 = 
	`sqlôe4_num_to_öt64
(
	`sqlôe4_num_round
(
jd
, 0), 0);

817 
p
->
vÆidJD
 = 1;

819 
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

820 if–!
z
 || 
	`∑r£D©eOrTime
(
c⁄ãxt
, z, 
p
) ){

824 
i
=1; i<
¨gc
; i++){

825 
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], 0);

826 if–
z
==0 || 
	`∑r£Modifõr
(
c⁄ãxt
, z, 
p
) )  1;

829 
	}
}

842 
	$julündayFunc
(

843 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

844 
¨gc
,

845 
sqlôe4_vÆue
 **
¨gv


847 c⁄° 
sqlôe4_num
 
ms_≥r_day
 = {0, 0, 0, 86400000};

848 
D©eTime
 
x
;

850 if–
	`isD©e
(
c⁄ãxt
, 
¨gc
, 
¨gv
, &
x
)==0 ){

851 
	`compuãJD
(&
x
);

852 
	`sqlôe4_ªsu…_num
(
c⁄ãxt
,

853 
	`sqlôe4_num_div
(
	`sqlôe4_num_‰om_öt64
(
x
.
iJD
), 
ms_≥r_day
)

856 
	}
}

863 
	$d©ëimeFunc
(

864 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

865 
¨gc
,

866 
sqlôe4_vÆue
 **
¨gv


868 
D©eTime
 
x
;

869 if–
	`isD©e
(
c⁄ãxt
, 
¨gc
, 
¨gv
, &
x
)==0 ){

870 
zBuf
[100];

871 
	`compuãYMD_HMS
(&
x
);

872 
	`sqlôe4_¢¥ötf
(
zBuf
,(zBuf), "%04d-%02d-%02d %02d:%02d:%02d",

873 
x
.
Y
, x.
M
, x.
D
, x.
h
, x.
m
, ()(
	`sqlôe4_num_to_öt64
(x.
s
,0))

875 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

877 
	}
}

884 
	$timeFunc
(

885 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

886 
¨gc
,

887 
sqlôe4_vÆue
 **
¨gv


889 
D©eTime
 
x
;

890 if–
	`isD©e
(
c⁄ãxt
, 
¨gc
, 
¨gv
, &
x
)==0 ){

891 
zBuf
[100];

892 
	`compuãHMS
(&
x
);

893 
	`sqlôe4_¢¥ötf
(
zBuf
,(zBuf), "%02d:%02d:%02d", 
x
.
h
, x.
m
,

894 ()(
	`sqlôe4_num_to_öt64
(
x
.
s
,0))

896 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

898 
	}
}

905 
	$d©eFunc
(

906 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

907 
¨gc
,

908 
sqlôe4_vÆue
 **
¨gv


910 
D©eTime
 
x
;

911 if–
	`isD©e
(
c⁄ãxt
, 
¨gc
, 
¨gv
, &
x
)==0 ){

912 
zBuf
[100];

913 
	`compuãYMD
(&
x
);

914 
	`sqlôe4_¢¥ötf
(
zBuf
,(zBuf), "%04d-%02d-%02d", 
x
.
Y
, x.
M
, x.
D
);

915 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

917 
	}
}

938 
	$°r·imeFunc
(

939 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

940 
¨gc
,

941 
sqlôe4_vÆue
 **
¨gv


943 
D©eTime
 
x
;

944 
u64
 
n
;

945 
size_t
 
i
,
j
;

946 *
z
;

947 
sqlôe4
 *
db
;

948 c⁄° *
zFmt
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

949 
zBuf
[100];

950 if–
zFmt
==0 || 
	`isD©e
(
c⁄ãxt
, 
¨gc
-1, 
¨gv
+1, &
x
) ) ;

951 
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

952 
i
=0, 
n
=1; 
zFmt
[i]; i++,Ç++){

953 if–
zFmt
[
i
]=='%' ){

954  
zFmt
[
i
+1] ){

961 
n
++;

967 
n
 += 8;

970 
n
 += 3;

973 
n
 += 8;

977 
n
 += 50;

982 
i
++;

985 
	`ã°ˇ£
–
n
==(
zBuf
)-1 );

986 
	`ã°ˇ£
–
n
==(
zBuf
) );

987 
	`ã°ˇ£
–
n
==(
u64
)
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
]+1 );

988 
	`ã°ˇ£
–
n
==(
u64
)
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] );

989 if–
n
<(
zBuf
) ){

990 
z
 = 
zBuf
;

991 }if–
n
>(
u64
)
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

992 
	`sqlôe4_ªsu…_îr‹_toobig
(
c⁄ãxt
);

995 
z
 = 
	`sqlôe4DbMÆlocRaw
(
db
, ()
n
);

996 if–
z
==0 ){

997 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

1001 
	`compuãJD
(&
x
);

1002 
	`compuãYMD_HMS
(&
x
);

1003 
i
=
j
=0; 
zFmt
[i]; i++){

1004 if–
zFmt
[
i
]!='%' ){

1005 
z
[
j
++] = 
zFmt
[
i
];

1007 
i
++;

1008  
zFmt
[
i
] ){

1009 'd': 
	`sqlôe4_¢¥ötf
(&
z
[
j
],3,"%02d",
x
.
D
); j+=2; ;

1011 
sqlôe4_num
 
∫d
 = 
x
.
s
;

1012 
i1
;

1013 
∫d
.
e
 += 3;

1014 
i1
 = 
	`sqlôe4_num_to_öt64
(
∫d
, 0);

1015 
j
 +
	`sqlôe4_¢¥ötf
(&
z
[j], 7, "%02d.%03d", 
i1
 / 1000, i1 % 1000);

1018 'H': 
	`sqlôe4_¢¥ötf
(&
z
[
j
],3,"%02d",
x
.
h
); j+=2; ;

1021 
nDay
;

1022 
D©eTime
 
y
 = 
x
;

1023 
y
.
vÆidJD
 = 0;

1024 
y
.
M
 = 1;

1025 
y
.
D
 = 1;

1026 
	`compuãJD
(&
y
);

1027 
nDay
 = ()((
x
.
iJD
-
y
.iJD+43200000)/86400000);

1028 if–
zFmt
[
i
]=='W' ){

1029 
wd
;

1030 
wd
 = ()(((
x
.
iJD
+43200000)/86400000)%7);

1031 
	`sqlôe4_¢¥ötf
(&
z
[
j
],3,"%02d",(
nDay
+7-
wd
)/7);

1032 
j
 += 2;

1034 
	`sqlôe4_¢¥ötf
(&
z
[
j
],4,"%03d",
nDay
+1);

1035 
j
 += 3;

1040 
j
 +
	`sqlôe4_¢¥ötf
(&
z
[j],20,"%.16g",
x
.
iJD
/86400000.0);

1043 'm': 
	`sqlôe4_¢¥ötf
(&
z
[
j
],3,"%02d",
x
.
M
); j+=2; ;

1044 'M': 
	`sqlôe4_¢¥ötf
(&
z
[
j
],3,"%02d",
x
.
m
); j+=2; ;

1046 
j
 +
	`sqlôe4_¢¥ötf
(&
z
[j],30,"%lld",

1047 (
i64
)(
x
.
iJD
/1000 - 21086676*(i64)10000));

1051 
	`sqlôe4_¢¥ötf
(&
z
[
j
], 3, "%02d", ()
	`sqlôe4_num_to_öt64
(
x
.
s
, 0));

1052 
j
+=2;

1055 
z
[
j
++] = ()(((
x
.
iJD
+129600000)/86400000) % 7) + '0';

1059 
	`sqlôe4_¢¥ötf
(&
z
[
j
],5,"%04d",
x
.
Y
); j+=
	`sqlôe4SåÀn30
(&z[j]);

1062 : 
z
[
j
++] = '%'; ;

1066 
z
[
j
] = 0;

1067 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
z
, -1,

1068 
z
==
zBuf
 ? 
SQLITE4_TRANSIENT
 : 
SQLITE4_DYNAMIC
, 0);

1069 
	}
}

1076 
	$˘imeFunc
(

1077 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1078 
NŸU£d
,

1079 
sqlôe4_vÆue
 **
NŸU£d2


1081 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

1082 
	`timeFunc
(
c⁄ãxt
, 0, 0);

1083 
	}
}

1090 
	$cd©eFunc
(

1091 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1092 
NŸU£d
,

1093 
sqlôe4_vÆue
 **
NŸU£d2


1095 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

1096 
	`d©eFunc
(
c⁄ãxt
, 0, 0);

1097 
	}
}

1104 
	$˘ime°ampFunc
(

1105 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1106 
NŸU£d
,

1107 
sqlôe4_vÆue
 **
NŸU£d2


1109 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

1110 
	`d©ëimeFunc
(
c⁄ãxt
, 0, 0);

1111 
	}
}

1114 #ifde‡
SQLITE4_OMIT_DATETIME_FUNCS


1126 
	$cuºítTimeFunc
(

1127 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1128 
¨gc
,

1129 
sqlôe4_vÆue
 **
¨gv


1131 
time_t
 
t
;

1132 *
zF‹m©
 = (*)
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
);

1133 
sqlôe4
 *
db
;

1134 
sqlôe4_öt64
 
iT
;

1135 
tm
 *
pTm
;

1136 
tm
 
sNow
;

1137 
zBuf
[20];

1139 
	`UNUSED_PARAMETER
(
¨gc
);

1140 
	`UNUSED_PARAMETER
(
¨gv
);

1142 
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

1143 if–
	`sqlôe4OsCuºítTime
(
db
->
pEnv
, &
iT
) ) ;

1144 
t
 = 
iT
/1000 - 10000*(
sqlôe4_öt64
)21086676;

1145 #ifde‡
HAVE_GMTIME_R


1146 
pTm
 = 
	`gmtime_r
(&
t
, &
sNow
);

1148 
	`sqlôe4_muãx_íãr
(
	`sqlôe4MuãxAŒoc
(
SQLITE4_MUTEX_STATIC_MASTER
));

1149 
pTm
 = 
	`gmtime
(&
t
);

1150 if–
pTm
 ) 
	`mem˝y
(&
sNow
,ÖTm, (sNow));

1151 
	`sqlôe4_muãx_Àave
(
	`sqlôe4MuãxAŒoc
(
SQLITE4_MUTEX_STATIC_MASTER
));

1153 if–
pTm
 ){

1154 
	`°r·ime
(
zBuf
, 20, 
zF‹m©
, &
sNow
);

1155 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

1157 
	}
}

1165 
	$sqlôe4Regi°îD©eTimeFun˘i⁄s
(
sqlôe4_ív
 *
pEnv
){

1166 
FuncDef
 
aD©eTimeFuncs
[] = {

1167 #i‚de‡
SQLITE4_OMIT_DATETIME_FUNCS


1168 
	`FUNCTION
(
julünday
, -1, 0, 0, 
julündayFunc
 ),

1169 
	`FUNCTION
(
d©e
, -1, 0, 0, 
d©eFunc
 ),

1170 
	`FUNCTION
(
time
, -1, 0, 0, 
timeFunc
 ),

1171 
	`FUNCTION
(
d©ëime
, -1, 0, 0, 
d©ëimeFunc
 ),

1172 
	`FUNCTION
(
°r·ime
, -1, 0, 0, 
°r·imeFunc
 ),

1173 
	`FUNCTION
(
cuºít_time
, 0, 0, 0, 
˘imeFunc
 ),

1174 
	`FUNCTION
(
cuºít_time°amp
, 0, 0, 0, 
˘ime°ampFunc
),

1175 
	`FUNCTION
(
cuºít_d©e
, 0, 0, 0, 
cd©eFunc
 ),

1177 
	`STR_FUNCTION
(
cuºít_time
, 0, "%H:%M:%S", 0, 
cuºítTimeFunc
),

1178 
	`STR_FUNCTION
(
cuºít_d©e
, 0, "%Y-%m-%d", 0, 
cuºítTimeFunc
),

1179 
	`STR_FUNCTION
(
cuºít_time°amp
, 0, "%Y-%m-%d %H:%M:%S", 0, 
cuºítTimeFunc
),

1182 
i
;

1183 
FuncDefTabÀ
 *
pFuncTab
 = &
pEnv
->
aGlobÆFuncs
;

1184 
FuncDef
 *
aFunc
 = (FuncDef*)
aD©eTimeFuncs
;

1186 
i
=0; i<
	`AºaySize
(
aD©eTimeFuncs
); i++){

1187 
	`sqlôe4FuncDefIn£π
(
pFuncTab
, &
aFunc
[
i
], 1);

1189 
	}
}

	@src/delete.c

15 
	~"sqlôeI¡.h
"

30 
TabÀ
 *
	$sqlôe4SrcLi°Lookup
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pSrc
){

31 
SrcLi°Iãm
 *
pIãm
 = 
pSrc
->
a
;

32 
TabÀ
 *
pTab
;

33 
	`as£π
–
pIãm
 && 
pSrc
->
nSrc
==1 );

34 
pTab
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 0, 
pIãm
->
zName
,ÖIãm->
zD©aba£
);

35 
	`sqlôe4DñëeTabÀ
(
pP¨£
->
db
, 
pIãm
->
pTab
);

36 
pIãm
->
pTab
 =ÖTab;

37 if–
pTab
 ){

38 
pTab
->
nRef
++;

40 if–
	`sqlôe4IndexedByLookup
(
pP¨£
, 
pIãm
) ){

41 
pTab
 = 0;

43  
pTab
;

44 
	}
}

51 
	$sqlôe4IsRódO∆y
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, 
võwOk
){

62 if––
	`IsVútuÆ
(
pTab
)

63 && 
	`sqlôe4GëVTabÀ
(
pP¨£
->
db
, 
pTab
)->
pMod
->
pModuÀ
->
xUpd©e
==0 )

64 || ( (
pTab
->
èbFœgs
 & 
TF_Ród⁄ly
)!=0

65 && (
pP¨£
->
db
->
Êags
 & 
SQLITE4_WrôeSchema
)==0

66 && 
pP¨£
->
√°ed
==0 )

68 
	`sqlôe4Eº‹Msg
(
pP¨£
, "èbÀ %†mayÇŸ bêmodifõd", 
pTab
->
zName
);

72 #i‚de‡
SQLITE4_OMIT_VIEW


73 if–!
võwOk
 && 
pTab
->
pSñe˘
 ){

74 
	`sqlôe4Eº‹Msg
(
pP¨£
,"ˇ¬Ÿ modify %†beˇu£ iài†®võw",
pTab
->
zName
);

79 
	}
}

82 #i‡!
deföed
(
SQLITE4_OMIT_VIEW
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

88 
	$sqlôe4M©îülizeVõw
(

89 
P¨£
 *
pP¨£
,

90 
TabÀ
 *
pVõw
,

91 
Ex¥
 *
pWhîe
,

92 
iCur


94 
Sñe˘De°
 
de°
;

95 
Sñe˘
 *
pDup
;

96 
sqlôe4
 *
db
 = 
pP¨£
->db;

98 
pDup
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
pVõw
->
pSñe˘
, 0);

99 if–
pWhîe
 ){

100 
SrcLi°
 *
pFrom
;

102 
pWhîe
 = 
	`sqlôe4Ex¥Dup
(
db
,ÖWhere, 0);

103 
pFrom
 = 
	`sqlôe4SrcLi°Aµíd
(
db
, 0, 0, 0);

104 if–
pFrom
 ){

105 
	`as£π
–
pFrom
->
nSrc
==1 );

106 
pFrom
->
a
[0].
zAlüs
 = 
	`sqlôe4DbSåDup
(
db
, 
pVõw
->
zName
);

107 
pFrom
->
a
[0].
pSñe˘
 = 
pDup
;

108 
	`as£π
–
pFrom
->
a
[0].
pOn
==0 );

109 
	`as£π
–
pFrom
->
a
[0].
pUsög
==0 );

111 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pDup
);

113 
pDup
 = 
	`sqlôe4Sñe˘New
(
pP¨£
, 0, 
pFrom
, 
pWhîe
, 0, 0, 0, 0, 0, 0);

115 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 
SRT_EphemTab
, 
iCur
);

116 
	`sqlôe4Sñe˘
(
pP¨£
, 
pDup
, &
de°
);

117 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pDup
);

118 
	}
}

121 #i‡
deföed
(
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT
) \

122 && !
	$deföed
(
SQLITE4_OMIT_SUBQUERY
)

131 
Ex¥
 *
	$sqlôe4LimôWhîe
(

132 
P¨£
 *
pP¨£
,

133 
SrcLi°
 *
pSrc
,

134 
Ex¥
 *
pWhîe
,

135 
Ex¥Li°
 *
pOrdîBy
,

136 
Ex¥
 *
pLimô
,

137 
Ex¥
 *
pOff£t
,

138 *
zStmtTy≥


140 
Ex¥
 *
pWhîeRowid
 = 
NULL
;

141 
Ex¥
 *
pInCœu£
 = 
NULL
;

142 
Ex¥
 *
pSñe˘Rowid
 = 
NULL
;

143 
Ex¥Li°
 *
pELi°
 = 
NULL
;

144 
SrcLi°
 *
pSñe˘Src
 = 
NULL
;

145 
Sñe˘
 *
pSñe˘
 = 
NULL
;

149 if–
pOrdîBy
 && (
pLimô
 == 0) ) {

150 
	`sqlôe4Eº‹Msg
(
pP¨£
, "ORDER BY wôhouàLIMIT o¿%s", 
zStmtTy≥
);

151 
limô_whîe_˛ónup_2
;

157 if–
pLimô
 == 0 ) {

159 
	`as£π
–
pOff£t
 == 0 );

160  
pWhîe
;

172 
pSñe˘Rowid
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ROW
, 0, 0, 0);

173 if–
pSñe˘Rowid
 =0 ) 
limô_whîe_˛ónup_2
;

174 
pELi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
pSñe˘Rowid
);

175 if–
pELi°
 =0 ) 
limô_whîe_˛ónup_2
;

179 
pSñe˘Src
 = 
	`sqlôe4SrcLi°Dup
(
pP¨£
->
db
, 
pSrc
, 0);

180 if–
pSñe˘Src
 == 0 ) {

181 
	`sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
pELi°
);

182 
limô_whîe_˛ónup_2
;

186 
pSñe˘
 = 
	`sqlôe4Sñe˘New
(
pP¨£
,
pELi°
,
pSñe˘Src
,
pWhîe
,0,0,

187 
pOrdîBy
,0,
pLimô
,
pOff£t
);

188 if–
pSñe˘
 == 0 )  0;

191 
pWhîeRowid
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ROW
, 0, 0, 0);

192 if–
pWhîeRowid
 =0 ) 
limô_whîe_˛ónup_1
;

193 
pInCœu£
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_IN
, 
pWhîeRowid
, 0, 0);

194 if–
pInCœu£
 =0 ) 
limô_whîe_˛ónup_1
;

196 
pInCœu£
->
x
.
pSñe˘
 =ÖSelect;

197 
pInCœu£
->
Êags
 |
EP_xIsSñe˘
;

198 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
pInCœu£
);

199  
pInCœu£
;

202 
limô_whîe_˛ónup_1
:

203 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
pSñe˘
);

206 
limô_whîe_˛ónup_2
:

207 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
pWhîe
);

208 
	`sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
pOrdîBy
);

209 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
pLimô
);

210 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
pOff£t
);

212 
	}
}

223 
	$sqlôe4DñëeFrom
(

224 
P¨£
 *
pP¨£
,

225 
SrcLi°
 *
pTabLi°
,

226 
Ex¥
 *
pWhîe


228 
sqlôe4
 *
db
 = 
pP¨£
->db;

229 
Vdbe
 *
v
;

230 
TabÀ
 *
pTab
;

231 c⁄° *
zDb
;

232 
AuthC⁄ãxt
 
sC⁄ãxt
;

233 
NameC⁄ãxt
 
sNC
;

234 
iDb
;

235 
rˇuth
;

236 
iCur
;

237 
Triggî
 *
pTriggî
;

239 
	`mem£t
(&
sC⁄ãxt
, 0, (sContext));

240 
	`mem£t
(&
sNC
, 0, (sNC));

242 
db
 = 
pP¨£
->db;

243 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ){

244 
dñëe_‰om_˛ónup
;

246 
	`as£π
–
pTabLi°
->
nSrc
==1 );

250 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
pTabLi°
);

251 if–
pTab
==0 || 
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
,ÖTab) ){

252 
dñëe_‰om_˛ónup
;

254 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

255 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

258 
pTriggî
 = 
	`sqlôe4TriggîsExi°
(
pP¨£
, 
pTab
, 
TK_DELETE
, 0, 0);

264 if–
	`sqlôe4IsRódO∆y
(
pP¨£
, 
pTab
, 
pTriggî
!=0ËË
dñëe_‰om_˛ónup
;

265 
	`as£π
–!
	`IsVõw
(
pTab
Ë|| 
pTriggî
 );

266 
	`as£π
–!
	`IsVõw
(
pTab
Ë||ÖTab->
pIndex
==0 );

269 
rˇuth
 = 
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_DELETE
, 
pTab
->
zName
, 0, 
zDb
);

270 
	`as£π
–
rˇuth
==
SQLITE4_OK
 ||Ñˇuth==
SQLITE4_DENY


271 || 
rˇuth
==
SQLITE4_IGNORE
 );

272 if–
rˇuth
==
SQLITE4_DENY
 ){

273 
dñëe_‰om_˛ónup
;

285 
pTabLi°
->
a
[0].
iCurs‹
 = 
iCur
 = 
pP¨£
->
nTab
++;

288 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

289 if–
v
==0 ) 
dñëe_‰om_˛ónup
;

290 if–
pP¨£
->
√°ed
==0 ) 
	`sqlôe4VdbeCou¡Ch™ges
(
v
);

291 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 1, 
iDb
);

295 if–
	`IsVõw
(
pTab
) ){

296 
	`sqlôe4AuthC⁄ãxtPush
(
pP¨£
, &
sC⁄ãxt
, 
pTab
->
zName
);

297 
	`sqlôe4M©îülizeVõw
(
pP¨£
, 
pTab
, 
pWhîe
, 
iCur
);

302 
sNC
.
pP¨£
 =ÖParse;

303 
sNC
.
pSrcLi°
 = 
pTabLi°
;

304 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pWhîe
) ){

305 
dñëe_‰om_˛ónup
;

308 #i‚de‡
SQLITE4_OMIT_TRUNCATE_OPTIMIZATION


313 if–
rˇuth
==
SQLITE4_OK
 && 
pWhîe
==0 && !
pTriggî
 && !
	`IsVútuÆ
(
pTab
)

314 && 0==
	`sqlôe4FkRequúed
(
pP¨£
, 
pTab
, 0)

315 && !
	`IsKv°‹e
(
pTab
)

317 
Index
 *
pIdx
;

318 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

319 
	`as£π
–
pIdx
->
pSchema
==
pTab
->pSchema );

320 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_CÀ¨
, 
pIdx
->
äum
, 
iDb
);

321 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

322 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_NCHANGE
);

331 
WhîeInfo
 *
pWInfo
;

332 
ba£Cur
 = 0;

333 
ªgSë
 = ++
pP¨£
->
nMem
;

334 
ªgKey
 = ++
pP¨£
->
nMem
;

335 
addrT›
;

343 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgSë
);

344 
	`VdbeCommít
((
v
, "initialize RowSet"));

345 
pWInfo
 = 
	`sqlôe4WhîeBegö
(

346 
pP¨£
, 
pTabLi°
, 
pWhîe
, 0, 0, 
WHERE_DUPLICATES_OK
, 0

348 if–
pWInfo
==0 ) 
dñëe_‰om_˛ónup
;

349 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iCur
, 
ªgKey
);

350 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_RowSëAdd
, 
ªgSë
, 0, 
ªgKey
);

351 
	`sqlôe4WhîeEnd
(
pWInfo
);

355 if–!
	`IsVõw
(
pTab
) ){

356 
ba£Cur
 = 
pP¨£
->
nTab
;

357 
	`sqlôe4O≥nAŒIndexes
(
pP¨£
, 
pTab
, 
ba£Cur
, 
OP_O≥nWrôe
);

360 
addrT›
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_RowSëRód
, 
ªgSë
, 0, 
ªgKey
);

363 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


364 if–
	`IsVútuÆ
(
pTab
) ){

365 c⁄° *
pVTab
 = (c⁄° *)
	`sqlôe4GëVTabÀ
(
db
, 
pTab
);

366 
	`sqlôe4VèbMakeWrôabÀ
(
pP¨£
, 
pTab
);

367 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VUpd©e
, 0, 1, 
iRowid
, 
pVTab
, 
P4_VTAB
);

368 
	`sqlôe4VdbeCh™geP5
(
v
, 
OE_Ab‹t
);

369 
	`sqlôe4MayAb‹t
(
pP¨£
);

373 
	`sqlôe4Gíî©eRowDñëe
(

374 
pP¨£
, 
pTab
, 
ba£Cur
, 
ªgKey
,ÖP¨£->
√°ed
==0, 
pTriggî
, 
OE_DeÁu…


379 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrT›
);

380 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrT›
);

383 
	`sqlôe4Clo£AŒIndexes
(
pP¨£
, 
pTab
, 
ba£Cur
);

386 
dñëe_‰om_˛ónup
:

387 
	`sqlôe4AuthC⁄ãxtP›
(&
sC⁄ãxt
);

388 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pTabLi°
);

389 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhîe
);

391 
	}
}

412 
	$sqlôe4Gíî©eRowDñëe
(

413 
P¨£
 *
pP¨£
,

414 
TabÀ
 *
pTab
,

415 
ba£Cur
,

416 
ªgKey
,

417 
bCou¡
,

418 
Triggî
 *
pTriggî
,

419 
⁄c⁄f


421 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

422 
ªgOld
 = 0;

423 
iLabñ
;

424 
iPk
;

425 
iPkC§
;

426 
Index
 *
pPk
;

429 
	`as£π
–
v
 );

431 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, &
iPk
);

432 
iPkC§
 = 
ba£Cur
 + 
iPk
;

437 
iLabñ
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

438 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_NŸFound
, 
iPkC§
, 
iLabñ
, 
ªgKey
, 0);

442 if–
	`sqlôe4FkRequúed
(
pP¨£
, 
pTab
, 0Ë|| 
pTriggî
 ){

443 
u32
 
mask
;

444 
iCﬁ
;

454 
mask
 = 
	`sqlôe4TriggîCﬁmask
(

455 
pP¨£
, 
pTriggî
, 0, 0, 
TRIGGER_BEFORE
|
TRIGGER_AFTER
, 
pTab
, 
⁄c⁄f


457 
mask
 |
	`sqlôe4FkOldmask
(
pP¨£
, 
pTab
);

465 
ªgOld
 = 
pP¨£
->
nMem
+1;

466 
pP¨£
->
nMem
 +(
pTab
->
nCﬁ
+1);

467 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁ
; iCol++){

468 if–
mask
==0xfffffff‡|| mask&(1<<
iCﬁ
) ){

469 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pTab
, 
iPkC§
, 
iCﬁ
, 
ªgOld
+iCol+1);

472 
	`as£π
–(
pPk
==0)==
	`IsVõw
(
pTab
) );

473 if–
pPk
 &&ÖPk->
aiCﬁumn
[0]<0 ){

474 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iPkC§
, 
ªgOld
);

478 
	`sqlôe4CodeRowTriggî
(
pP¨£
, 
pTriggî
,

479 
TK_DELETE
, 0, 
TRIGGER_BEFORE
, 
pTab
, 
ªgOld
, 
⁄c⁄f
, 
iLabñ


486 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_NŸFound
, 
iPkC§
, 
iLabñ
, 
ªgKey
, 0);

491 
	`sqlôe4FkCheck
(
pP¨£
, 
pTab
, 
ªgOld
+1, 0);

497 if–!
	`IsVõw
(
pTab
) ){

498 
	`sqlôe4Gíî©eRowIndexDñëe
(
pP¨£
, 
pTab
, 
bCou¡
, 
ba£Cur
, 0);

505 
	`sqlôe4FkA˘i⁄s
(
pP¨£
, 
pTab
, 0, 
ªgOld
);

508 
	`sqlôe4CodeRowTriggî
(
pP¨£
, 
pTriggî
,

509 
TK_DELETE
, 0, 
TRIGGER_AFTER
, 
pTab
, 
ªgOld
, 
⁄c⁄f
, 
iLabñ


515 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iLabñ
);

516 
	}
}

522 
	$sqlôe4EncodeIndexKey
(

523 
P¨£
 *
pP¨£
,

524 
Index
 *
pPk
,

525 
iPkC§
,

526 
Index
 *
pIdx
, 
iIdxC§
,

527 
bAddSeq
,

528 
ªgOut


530 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

531 
nTmpReg
;

532 
ªgTmp
;

533 
i
;

534 
nPkCﬁ
;

537 
	`as£π
–
pIdx
!=
pPk
 );

538 
nPkCﬁ
 = (
pPk
 ?ÖPk->
nCﬁumn
 : 0);

539 
nTmpReg
 = 
pIdx
->
nCﬁumn
 + 
nPkCﬁ
;

540 
ªgTmp
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nTmpReg
);

543 
i
=0; i<
pIdx
->
nCﬁumn
; i++){

544 
ªgVÆ
 = 
ªgTmp
 + 
i
;

545 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iPkC§
, 
pIdx
->
aiCﬁumn
[
i
], 
ªgVÆ
);

547 
i
=0; i<
nPkCﬁ
; i++){

548 
iCﬁ
 = 
pPk
->
aiCﬁumn
[
i
];

549 
ªgVÆ
 = 
pIdx
->
nCﬁumn
 + 
ªgTmp
 + 
i
;

550 if–
iCﬁ
<0 ){

551 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iPkC§
, 
ªgVÆ
);

553 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iPkC§
, 
pPk
->
aiCﬁumn
[
i
], 
ªgVÆ
);

559 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgTmp
, 
nTmpReg
, 
ªgOut
, 
iIdxC§
);

560 if–
bAddSeq
 ) 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_SEQCOUNT
);

563 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgTmp
, 
nTmpReg
);

564 
	}
}

582 
	$sqlôe4Gíî©eRowIndexDñëe
(

583 
P¨£
 *
pP¨£
,

584 
TabÀ
 *
pTab
,

585 
bCou¡
,

586 
ba£Cur
,

587 *
aRegIdx


589 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

590 
Index
 *
pPk
;

591 
iPk
;

592 
iPkC§
;

593 
i
;

594 
ªgKey
;

595 
Index
 *
pIdx
;

597 
ªgKey
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

598 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, &
iPk
);

599 
iPkC§
 = 
ba£Cur
+
iPk
;

601 
i
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, i++){

602 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
 ){

603 
iCﬁ
;

604 
iReg
 = 
pP¨£
->
nMem
+1;

605 
pP¨£
->
nMem
 +(1 + 
pTab
->
nCﬁ
);

606 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁ
; iCol++){

607 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iPkC§
, 
iCﬁ
, 
iReg
+iCol);

609 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iPkC§
, 
iReg
+
pTab
->
nCﬁ
);

610 
	`sqlôe4Fts5CodeUpd©e
(
pP¨£
, 
pIdx
, 0, 
iReg
+
pTab
->
nCﬁ
, iReg, 1);

611 }if–
pIdx
!=
pPk
 && (
aRegIdx
==0 ||áRegIdx[
i
]>0) ){

612 
addrNŸFound
;

613 
	`sqlôe4EncodeIndexKey
(
pP¨£
, 
pPk
, 
ba£Cur
+
iPk
,
pIdx
,ba£Cur+
i
,0,
ªgKey
);

614 
addrNŸFound
 = 
	`sqlôe4VdbeAddOp4
(
v
,

615 
OP_NŸFound
, 
ba£Cur
+
i
, 0, 
ªgKey
, 0, 
P4_INT32


617 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Dñëe
, 
ba£Cur
+
i
);

618 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrNŸFound
);

622 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Dñëe
, 
ba£Cur
+
iPk
, (
bCou¡
 ? 
OPFLAG_NCHANGE
: 0));

623 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgKey
);

624 
	}
}

	@src/env.c

15 
	~"sqlôeI¡.h
"

21 
KVFa˘‹y
 
	gmemFa˘‹y
 = {

24 
sqlôe4KVSt‹eO≥nMem
,

27 
KVFa˘‹y
 
	gbtFa˘‹y
 = {

28 &
memFa˘‹y
,

30 
sqlôe4O≥nBåì
,

33 
KVFa˘‹y
 
	gsqlôe4BuûtöFa˘‹y
 = {

34 &
btFa˘‹y
,

36 
sqlôe4KVSt‹eO≥nLsm
,

44 
sqlôe4_ív
 
	gsqlôe4DeÁu…Env
 = {

45 (
sqlôe4_ív
),

47 
SQLITE4_DEFAULT_MEMSTATUS
,

49 
SQLITE4_THREADSAFE
==1,

53 &
	gsqlôe4MMSy°em
,

59 &
	gsqlôe4BuûtöFa˘‹y
,

60 
	gsqlôe4OsR™dom√ss
,

61 
	gsqlôe4OsCuºítTime
,

79 
sqlôe4_ív
 *
	$sqlôe4_ív_deÁu…
(){  &
sqlôe4DeÁu…Env
; 
	}
}

97 
	$sqlôe4_öôülize
(
sqlôe4_ív
 *
pEnv
){

98 
rc
;

100 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

107 if–
pEnv
->
isInô
 )  
SQLITE4_OK
;

111 
rc
 = 
	`sqlôe4MuãxInô
(
pEnv
);

112 if–
rc
 ){

113 
	`sqlôe4MÆlocEnd
(
pEnv
);

114  
rc
;

119 
rc
 = 
	`sqlôe4MÆlocInô
(
pEnv
);

120 if–
rc
 ) Ñc;

124 if–
pEnv
->
bC‹eMuãx
 ){

125 
pEnv
->
pMemMuãx
 = 
	`sqlôe4MuãxAŒoc
’Env, 
SQLITE4_MUTEX_FAST
);

126 
pEnv
->
pP∫gMuãx
 = 
	`sqlôe4MuãxAŒoc
’Env, 
SQLITE4_MUTEX_FAST
);

127 
pEnv
->
pFa˘‹yMuãx
 = 
	`sqlôe4MuãxAŒoc
’Env, 
SQLITE4_MUTEX_FAST
);

128 if–
pEnv
->
pMemMuãx
==0

129 || 
pEnv
->
pP∫gMuãx
==0

130 || 
pEnv
->
pFa˘‹yMuãx
==0

132 
rc
 = 
SQLITE4_NOMEM
;

135 
pEnv
->
pMemMuãx
 = 0;

136 
pEnv
->
pP∫gMuãx
 = 0;

138 
pEnv
->
isInô
 = 1;

140 
	`sqlôe4OsInô
(
pEnv
);

143 if–
rc
==
SQLITE4_OK
 ){

144 
	`sqlôe4Regi°îGlobÆFun˘i⁄s
(
pEnv
);

152 #i‚de‡
NDEBUG


153 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


155 i‡–
rc
==
SQLITE4_OK
 ){

156 
u64
 
x
 = (((u64)1)<<63)-1;

157 
y
;

158 
	`as£π
((
x
)==8);

159 
	`as£π
((
x
)==(
y
));

160 
	`mem˝y
(&
y
, &
x
, 8);

161 
	`as£π
–
	`sqlôe4IsNaN
(
y
) );

166  
rc
;

167 
	}
}

177 
	$sqlôe4_shutdown
(
sqlôe4_ív
 *
pEnv
){

178 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

179 if–
pEnv
->
isInô
 ){

180 
KVFa˘‹y
 *
pMkr
;

181 
	`sqlôe4_muãx_‰ì
(
pEnv
->
pFa˘‹yMuãx
);

182 
	`sqlôe4_muãx_‰ì
(
pEnv
->
pP∫gMuãx
);

183 
	`sqlôe4_muãx_‰ì
(
pEnv
->
pMemMuãx
);

184 
pEnv
->
pMemMuãx
 = 0;

185  (
pMkr
 = 
pEnv
->
pFa˘‹y
)!=0 &&ÖMkr->
isPîm
==0 ){

186 
KVFa˘‹y
 *
pNext
 = 
pMkr
->pNext;

187 
	`sqlôe4_‰ì
(
pEnv
, 
pMkr
);

188 
pEnv
->
pFa˘‹y
 = 
pNext
;

190 
	`sqlôe4MuãxEnd
(
pEnv
);

191 
	`sqlôe4MÆlocEnd
(
pEnv
);

192 
pEnv
->
isInô
 = 0;

194  
SQLITE4_OK
;

195 
	}
}

200 
	$sqlôe4_ív_size
(){  (
sqlôe4_ív
); 
	}
}

206 
	$sqlôe4_ív_c⁄fig
(
sqlôe4_ív
 *
pEnv
, 
›
, ...){

207 
va_li°
 
≠
;

208 
rc
 = 
SQLITE4_OK
;

210 if–
pEnv
==0 )ÖEnv = 
	`sqlôe4_ív_deÁu…
();

212 
	`va_°¨t
(
≠
, 
›
);

213  
›
 ){

222 
SQLITE4_ENVCONFIG_INIT
: {

224 
sqlôe4_ív
 *
pTem∂©e
 = 
	`va_¨g
(
≠
, sqlite4_env*);

225 
n
 = 
pTem∂©e
->
nByã
;

226 if–
n
>(
sqlôe4_ív
) )Ç = (sqlite4_env);

227 
	`mem˝y
(
pEnv
, 
pTem∂©e
, 
n
);

228 
pEnv
->
pFa˘‹y
 = &
sqlôe4BuûtöFa˘‹y
;

229 
pEnv
->
isInô
 = 0;

236 #i‡
	`deföed
(
SQLITE4_THREADSAFE
) && SQLITE4_THREADSAFE>0

242 
SQLITE4_ENVCONFIG_SINGLETHREAD
: {

244 if–
pEnv
->
isInô
 ){ 
rc
 = 
SQLITE4_MISUSE
; ; }

245 
pEnv
->
bC‹eMuãx
 = 0;

246 
pEnv
->
bFuŒMuãx
 = 0;

257 
SQLITE4_ENVCONFIG_MULTITHREAD
: {

260 if–
pEnv
->
isInô
 ){ 
rc
 = 
SQLITE4_MISUSE
; ; }

261 
pEnv
->
bC‹eMuãx
 = 1;

262 
pEnv
->
bFuŒMuãx
 = 0;

273 
SQLITE4_ENVCONFIG_SERIALIZED
: {

275 if–
pEnv
->
isInô
 ){ 
rc
 = 
SQLITE4_MISUSE
; ; }

276 
pEnv
->
bC‹eMuãx
 = 1;

277 
pEnv
->
bFuŒMuãx
 = 1;

287 
SQLITE4_ENVCONFIG_MUTEX
: {

289 if–
pEnv
->
isInô
 ){ 
rc
 = 
SQLITE4_MISUSE
; ; }

290 
pEnv
->
muãx
 = *
	`va_¨g
(
≠
, 
sqlôe4_muãx_mëhods
*);

300 
SQLITE4_ENVCONFIG_GETMUTEX
: {

302 *
	`va_¨g
(
≠
, 
sqlôe4_muãx_mëhods
*Ë
pEnv
->
muãx
;

313 
SQLITE4_ENVCONFIG_SETMM
: {

314 if–
pEnv
->
isInô
 )  
SQLITE4_MISUSE
;

315 
pEnv
->
pMM
 = 
	`va_¨g
(
≠
, 
sqlôe4_mm
*);

325 
SQLITE4_ENVCONFIG_GETMM
: {

326 *
	`va_¨g
(
≠
, 
sqlôe4_mm
**Ë
pEnv
->
pMM
;

335 
SQLITE4_ENVCONFIG_MEMSTATUS
: {

337 
pEnv
->
bMem°©
 = 
	`va_¨g
(
≠
, );

350 
SQLITE4_ENVCONFIG_LOOKASIDE
: {

351 
pEnv
->
szLookaside
 = 
	`va_¨g
(
≠
, );

352 
pEnv
->
nLookaside
 = 
	`va_¨g
(
≠
, );

362 
SQLITE4_ENVCONFIG_LOG
: {

367 (*
	tLOGFUNC_t
)(*,,const *);

368 
pEnv
->
xLog
 = 
	`va_¨g
(
≠
, 
LOGFUNC_t
);

369 
pEnv
->
pLogArg
 = 
	`va_¨g
(
≠
, *);

379 
SQLITE4_ENVCONFIG_KVSTORE_PUSH
: {

380 c⁄° *
zName
 = 
	`va_¨g
(
≠
, const *);

381 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

382 
KVFa˘‹y
 *
pMkr
 = 
	`sqlôe4_mÆloc
(
pEnv
, (*pMkr)+
nName
+1);

383 *
z
;

384 if–
pMkr
==0 )  
SQLITE4_NOMEM
;

385 
z
 = (*)&
pMkr
[1];

386 
	`mem˝y
(
z
, 
zName
, 
nName
+1);

387 
	`mem£t
(
pMkr
, 0, (*pMkr));

388 
pMkr
->
zName
 = 
z
;

389 
pMkr
->
xFa˘‹y
 = 
	`va_¨g
(
≠
, 
sqlôe4_kvÁ˘‹y
);

390 
	`sqlôe4_muãx_íãr
(
pEnv
->
pFa˘‹yMuãx
);

391 
pMkr
->
pNext
 = 
pEnv
->
pFa˘‹y
;

392 
pEnv
->
pFa˘‹y
 = 
pMkr
;

393 
	`sqlôe4_muãx_Àave
(
pEnv
->
pFa˘‹yMuãx
);

408 
SQLITE4_ENVCONFIG_KVSTORE_POP
:

409 
SQLITE4_ENVCONFIG_KVSTORE_GET
: {

410 (**
	tPxFa˘
)(
	tsqlôe4_ív
*,
	tKVSt‹e
**,const *,);

411 c⁄° *
zName
 = 
	`va_¨g
(
≠
, const *);

412 
KVFa˘‹y
 *
pMkr
, **
µPªv
;

413 
PxFa˘
 
pxFa˘
;

415 
pxFa˘
 = 
	`va_¨g
(
≠
,
PxFa˘
);

416 *
pxFa˘
 = 0;

417 
	`sqlôe4_muãx_íãr
(
pEnv
->
pFa˘‹yMuãx
);

418 
µPªv
 = &
pEnv
->
pFa˘‹y
;

419 
pMkr
 = *
µPªv
;

420  
pMkr
 && 
	`°rcmp
(
zName
,ÖMkr->zName)!=0 ){

421 
µPªv
 = &
pMkr
->
pNext
;

422 
pMkr
 = *
µPªv
;

424 if–
pMkr
 ){

425 *
pxFa˘
 = 
pMkr
->
xFa˘‹y
;

426 if–
›
==
SQLITE4_ENVCONFIG_KVSTORE_POP
 && 
pMkr
->
isPîm
==0 ){

427 *
µPªv
 = 
pMkr
->
pNext
;

428 
	`sqlôe4_‰ì
(
pEnv
, 
pMkr
);

431 
	`sqlôe4_muãx_Àave
(
pEnv
->
pFa˘‹yMuãx
);

437 
rc
 = 
SQLITE4_ERROR
;

441 
	`va_íd
(
≠
);

442  
rc
;

443 
	}
}

	@src/expr.c

15 
	~"sqlôeI¡.h
"

33 
	$sqlôe4Ex¥Afföôy
(
Ex¥
 *
pEx¥
){

34 
›
 = 
pEx¥
->op;

35 if–
›
==
TK_SELECT
 ){

36 
	`as£π
–
pEx¥
->
Êags
&
EP_xIsSñe˘
 );

37  
	`sqlôe4Ex¥Afföôy
(
pEx¥
->
x
.
pSñe˘
->
pELi°
->
a
[0].pExpr);

39 #i‚de‡
SQLITE4_OMIT_CAST


40 if–
›
==
TK_CAST
 ){

41 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

42  
	`sqlôe4AfföôyTy≥
(
pEx¥
->
u
.
zTokí
);

45 if–(
›
==
TK_AGG_COLUMN
 || op==
TK_COLUMN
 || op==
TK_REGISTER
)

46 && 
pEx¥
->
pTab
!=0

50 
j
 = 
pEx¥
->
iCﬁumn
;

51 if–
j
<0 )  
SQLITE4_AFF_INTEGER
;

52 
	`as£π
–
pEx¥
->
pTab
 && 
j
<pEx¥->pTab->
nCﬁ
 );

53  
pEx¥
->
pTab
->
aCﬁ
[
j
].
afföôy
;

55  
pEx¥
->
afföôy
;

56 
	}
}

62 
Ex¥
 *
	$sqlôe4Ex¥SëCﬁl
(
Ex¥
 *
pEx¥
, 
CﬁlSeq
 *
pCﬁl
){

63 if–
pEx¥
 && 
pCﬁl
 ){

64 
pEx¥
->
pCﬁl
 =ÖColl;

65 
pEx¥
->
Êags
 |
EP_ExpCﬁœã
;

67  
pEx¥
;

68 
	}
}

77 
Ex¥
 *
	$sqlôe4Ex¥SëCﬁlByTokí
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
Tokí
 *
pCﬁlName
){

78 *
zCﬁl
 = 0;

79 
CﬁlSeq
 *
pCﬁl
;

80 
sqlôe4
 *
db
 = 
pP¨£
->db;

81 
zCﬁl
 = 
	`sqlôe4NameFromTokí
(
db
, 
pCﬁlName
);

82 
pCﬁl
 = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
zCﬁl
);

83 
	`sqlôe4Ex¥SëCﬁl
(
pEx¥
, 
pCﬁl
);

84 
	`sqlôe4DbFªe
(
db
, 
zCﬁl
);

85  
pEx¥
;

86 
	}
}

92 
CﬁlSeq
 *
	$sqlôe4Ex¥CﬁlSeq
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
){

93 
CﬁlSeq
 *
pCﬁl
 = 0;

94 
Ex¥
 *
p
 = 
pEx¥
;

95  
p
 ){

96 
›
;

97 
pCﬁl
 = 
p
->pColl;

98 if–
pCﬁl
 ) ;

99 
›
 = 
p
->op;

100 if–
p
->
pTab
!=0 && (

101 
›
==
TK_AGG_COLUMN
 || op==
TK_COLUMN
 || op==
TK_REGISTER
 || op==
TK_TRIGGER


105 c⁄° *
zCﬁl
;

106 
j
 = 
p
->
iCﬁumn
;

107 if–
j
>=0 ){

108 
sqlôe4
 *
db
 = 
pP¨£
->db;

109 
zCﬁl
 = 
p
->
pTab
->
aCﬁ
[
j
].zColl;

110 
pCﬁl
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zCﬁl
, 0);

111 
pEx¥
->
pCﬁl
 =ÖColl;

115 if–
›
!=
TK_CAST
 && op!=
TK_UPLUS
 ){

118 
p
 =Ö->
pLe·
;

120 if–
	`sqlôe4CheckCﬁlSeq
(
pP¨£
, 
pCﬁl
) ){

121 
pCﬁl
 = 0;

123  
pCﬁl
;

124 
	}
}

131 
	$sqlôe4Com∑ªAfföôy
(
Ex¥
 *
pEx¥
, 
aff2
){

132 
aff1
 = 
	`sqlôe4Ex¥Afföôy
(
pEx¥
);

133 if–
aff1
 && 
aff2
 ){

137 if–
	`sqlôe4IsNumîicAfföôy
(
aff1
Ë|| sqlôe4IsNumîicAfföôy(
aff2
) ){

138  
SQLITE4_AFF_NUMERIC
;

140  
SQLITE4_AFF_NONE
;

142 }if–!
aff1
 && !
aff2
 ){

146  
SQLITE4_AFF_NONE
;

149 
	`as£π
–
aff1
==0 || 
aff2
==0 );

150  (
aff1
 + 
aff2
);

152 
	}
}

158 
	$com∑ris⁄Afföôy
(
Ex¥
 *
pEx¥
){

159 
aff
;

160 
	`as£π
–
pEx¥
->
›
==
TK_EQ
 ||ÖEx¥->›==
TK_IN
 ||ÖEx¥->›==
TK_LT
 ||

161 
pEx¥
->
›
==
TK_GT
 ||ÖEx¥->›==
TK_GE
 ||ÖEx¥->›==
TK_LE
 ||

162 
pEx¥
->
›
==
TK_NE
 ||ÖEx¥->›==
TK_IS
 ||ÖEx¥->›==
TK_ISNOT
 );

163 
	`as£π
–
pEx¥
->
pLe·
 );

164 
aff
 = 
	`sqlôe4Ex¥Afföôy
(
pEx¥
->
pLe·
);

165 if–
pEx¥
->
pRight
 ){

166 
aff
 = 
	`sqlôe4Com∑ªAfföôy
(
pEx¥
->
pRight
,áff);

167 }if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

168 
aff
 = 
	`sqlôe4Com∑ªAfföôy
(
pEx¥
->
x
.
pSñe˘
->
pELi°
->
a
[0].pExpr,áff);

169 }if–!
aff
 ){

170 
aff
 = 
SQLITE4_AFF_NONE
;

172  
aff
;

173 
	}
}

181 
	$sqlôe4IndexAfföôyOk
(
Ex¥
 *
pEx¥
, 
idx_afföôy
){

182 
aff
 = 
	`com∑ris⁄Afföôy
(
pEx¥
);

183  
aff
 ){

184 
SQLITE4_AFF_NONE
:

186 
SQLITE4_AFF_TEXT
:

187  
idx_afföôy
==
SQLITE4_AFF_TEXT
;

189  
	`sqlôe4IsNumîicAfföôy
(
idx_afföôy
);

191 
	}
}

197 
u8
 
	$bö¨yCom∑ªP5
(
Ex¥
 *
pEx¥1
, Ex¥ *
pEx¥2
, 
jumpIfNuŒ
){

198 
u8
 
aff
 = ()
	`sqlôe4Ex¥Afföôy
(
pEx¥2
);

199 
aff
 = (
u8
)
	`sqlôe4Com∑ªAfföôy
(
pEx¥1
,áffË| (u8)
jumpIfNuŒ
;

200  
aff
;

201 
	}
}

215 
CﬁlSeq
 *
	$sqlôe4Bö¨yCom∑ªCﬁlSeq
(

216 
P¨£
 *
pP¨£
,

217 
Ex¥
 *
pLe·
,

218 
Ex¥
 *
pRight


220 
CﬁlSeq
 *
pCﬁl
;

221 
	`as£π
–
pLe·
 );

222 if–
pLe·
->
Êags
 & 
EP_ExpCﬁœã
 ){

223 
	`as£π
–
pLe·
->
pCﬁl
 );

224 
pCﬁl
 = 
pLe·
->pColl;

225 }if–
pRight
 &&ÖRight->
Êags
 & 
EP_ExpCﬁœã
 ){

226 
	`as£π
–
pRight
->
pCﬁl
 );

227 
pCﬁl
 = 
pRight
->pColl;

229 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pLe·
);

230 if–!
pCﬁl
 ){

231 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pRight
);

234  
pCﬁl
;

235 
	}
}

240 
	$codeCom∑ª
(

241 
P¨£
 *
pP¨£
,

242 
Ex¥
 *
pLe·
,

243 
Ex¥
 *
pRight
,

244 
›code
,

245 
ö1
, 
ö2
,

246 
de°
,

247 
jumpIfNuŒ


249 
p5
;

250 
addr
;

251 
CﬁlSeq
 *
p4
;

253 
p4
 = 
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
pP¨£
, 
pLe·
, 
pRight
);

254 
p5
 = 
	`bö¨yCom∑ªP5
(
pLe·
, 
pRight
, 
jumpIfNuŒ
);

255 
addr
 = 
	`sqlôe4VdbeAddOp4
(
pP¨£
->
pVdbe
, 
›code
, 
ö2
, 
de°
, 
ö1
,

256 (*)
p4
, 
P4_COLLSEQ
);

257 
	`sqlôe4VdbeCh™geP5
(
pP¨£
->
pVdbe
, (
u8
)
p5
);

258  
addr
;

259 
	}
}

261 #i‡
SQLITE4_MAX_EXPR_DEPTH
>0

267 
	$sqlôe4Ex¥CheckHeight
(
P¨£
 *
pP¨£
, 
nHeight
){

268 
rc
 = 
SQLITE4_OK
;

269 
mxHeight
 = 
pP¨£
->
db
->
aLimô
[
SQLITE4_LIMIT_EXPR_DEPTH
];

270 if–
nHeight
>
mxHeight
 ){

271 
	`sqlôe4Eº‹Msg
(
pP¨£
,

272 "Ex¥essi⁄Åªêi†toÿœrgê(maximum dïth %d)", 
mxHeight


274 
rc
 = 
SQLITE4_ERROR
;

276  
rc
;

277 
	}
}

288 
	$heightOfEx¥
(
Ex¥
 *
p
, *
≤Height
){

289 if–
p
 ){

290 if–
p
->
nHeight
>*
≤Height
 ){

291 *
≤Height
 = 
p
->
nHeight
;

294 
	}
}

295 
	$heightOfEx¥Li°
(
Ex¥Li°
 *
p
, *
≤Height
){

296 if–
p
 ){

297 
i
;

298 
i
=0; i<
p
->
nEx¥
; i++){

299 
	`heightOfEx¥
(
p
->
a
[
i
].
pEx¥
, 
≤Height
);

302 
	}
}

303 
	$heightOfSñe˘
(
Sñe˘
 *
p
, *
≤Height
){

304 if–
p
 ){

305 
	`heightOfEx¥
(
p
->
pWhîe
, 
≤Height
);

306 
	`heightOfEx¥
(
p
->
pHavög
, 
≤Height
);

307 
	`heightOfEx¥
(
p
->
pLimô
, 
≤Height
);

308 
	`heightOfEx¥
(
p
->
pOff£t
, 
≤Height
);

309 
	`heightOfEx¥Li°
(
p
->
pELi°
, 
≤Height
);

310 
	`heightOfEx¥Li°
(
p
->
pGroupBy
, 
≤Height
);

311 
	`heightOfEx¥Li°
(
p
->
pOrdîBy
, 
≤Height
);

312 
	`heightOfSñe˘
(
p
->
pPri‹
, 
≤Height
);

314 
	}
}

323 
	$ex¥SëHeight
(
Ex¥
 *
p
){

324 
nHeight
 = 0;

325 
	`heightOfEx¥
(
p
->
pLe·
, &
nHeight
);

326 
	`heightOfEx¥
(
p
->
pRight
, &
nHeight
);

327 if–
	`Ex¥HasPr›îty
(
p
, 
EP_xIsSñe˘
) ){

328 
	`heightOfSñe˘
(
p
->
x
.
pSñe˘
, &
nHeight
);

330 
	`heightOfEx¥Li°
(
p
->
x
.
pLi°
, &
nHeight
);

332 
p
->
nHeight
 =ÇHeight + 1;

333 
	}
}

340 
	$sqlôe4Ex¥SëHeight
(
P¨£
 *
pP¨£
, 
Ex¥
 *
p
){

341 
	`ex¥SëHeight
(
p
);

342 
	`sqlôe4Ex¥CheckHeight
(
pP¨£
, 
p
->
nHeight
);

343 
	}
}

349 
	$sqlôe4Sñe˘Ex¥Height
(
Sñe˘
 *
p
){

350 
nHeight
 = 0;

351 
	`heightOfSñe˘
(
p
, &
nHeight
);

352  
nHeight
;

353 
	}
}

355 
	#ex¥SëHeight
(
y
)

	)

377 
Ex¥
 *
	$sqlôe4Ex¥AŒoc
(

378 
sqlôe4
 *
db
,

379 
›
,

380 c⁄° 
Tokí
 *
pTokí
,

381 
dequŸe


383 
Ex¥
 *
pNew
;

384 
nExåa
 = 0;

385 
iVÆue
 = 0;

387 if–
pTokí
 ){

388 if–
›
!=
TK_INTEGER
 || 
pTokí
->
z
==0

389 || 
	`sqlôe4GëI¡32
(
pTokí
->
z
, &
iVÆue
)==0 ){

390 
nExåa
 = 
pTokí
->
n
+1;

391 
	`as£π
–
iVÆue
>=0 );

394 
pNew
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Ex¥
)+
nExåa
);

395 if–
pNew
 ){

396 
pNew
->
›
 = (
u8
)op;

397 
pNew
->
iAgg
 = -1;

398 if–
pTokí
 ){

399 if–
nExåa
==0 ){

400 
pNew
->
Êags
 |
EP_I¡VÆue
;

401 
pNew
->
u
.
iVÆue
 = iValue;

403 
c
;

404 
pNew
->
u
.
zTokí
 = (*)&pNew[1];

405 
	`as£π
–
pTokí
->
z
!=0 ||ÖTokí->
n
==0 );

406 if–
pTokí
->
n
 ) 
	`mem˝y
(
pNew
->
u
.
zTokí
,ÖTokí->
z
,ÖToken->n);

407 
pNew
->
u
.
zTokí
[
pTokí
->
n
] = 0;

408 if–
dequŸe
 && 
nExåa
>=3

409 && ((
c
 = 
pTokí
->
z
[0])=='\'' || c=='"' || c=='[') ){

410 
	`sqlôe4DequŸe
(
pNew
->
u
.
zTokí
);

414 #i‡
SQLITE4_MAX_EXPR_DEPTH
>0

415 
pNew
->
nHeight
 = 1;

418  
pNew
;

419 
	}
}

425 
Ex¥
 *
	$sqlôe4Ex¥
(

426 
sqlôe4
 *
db
,

427 
›
,

428 c⁄° *
zTokí


430 
Tokí
 
x
;

431 
x
.
z
 = 
zTokí
;

432 
x
.
n
 = 
zTokí
 ? 
	`sqlôe4SåÀn30
(zToken) : 0;

433  
	`sqlôe4Ex¥AŒoc
(
db
, 
›
, &
x
, 0);

434 
	}
}

442 
	$sqlôe4Ex¥AâachSubåìs
(

443 
sqlôe4
 *
db
,

444 
Ex¥
 *
pRoŸ
,

445 
Ex¥
 *
pLe·
,

446 
Ex¥
 *
pRight


448 if–
pRoŸ
==0 ){

449 
	`as£π
–
db
->
mÆlocFaûed
 );

450 
	`sqlôe4Ex¥Dñëe
(
db
, 
pLe·
);

451 
	`sqlôe4Ex¥Dñëe
(
db
, 
pRight
);

453 if–
pRight
 ){

454 
pRoŸ
->
pRight
 =ÖRight;

455 if–
pRight
->
Êags
 & 
EP_ExpCﬁœã
 ){

456 
pRoŸ
->
Êags
 |
EP_ExpCﬁœã
;

457 
pRoŸ
->
pCﬁl
 = 
pRight
->pColl;

460 if–
pLe·
 ){

461 
pRoŸ
->
pLe·
 =ÖLeft;

462 if–
pLe·
->
Êags
 & 
EP_ExpCﬁœã
 ){

463 
pRoŸ
->
Êags
 |
EP_ExpCﬁœã
;

464 
pRoŸ
->
pCﬁl
 = 
pLe·
->pColl;

467 
	`ex¥SëHeight
(
pRoŸ
);

469 
	}
}

478 
Ex¥
 *
	$sqlôe4PEx¥
(

479 
P¨£
 *
pP¨£
,

480 
›
,

481 
Ex¥
 *
pLe·
,

482 
Ex¥
 *
pRight
,

483 c⁄° 
Tokí
 *
pTokí


485 
Ex¥
 *
p
 = 
	`sqlôe4Ex¥AŒoc
(
pP¨£
->
db
, 
›
, 
pTokí
, 1);

486 
	`sqlôe4Ex¥AâachSubåìs
(
pP¨£
->
db
, 
p
, 
pLe·
, 
pRight
);

487 if–
p
 ) {

488 
	`sqlôe4Ex¥CheckHeight
(
pP¨£
, 
p
->
nHeight
);

490  
p
;

491 
	}
}

497 
Ex¥
 *
	$sqlôe4Ex¥And
(
sqlôe4
 *
db
, 
Ex¥
 *
pLe·
, Ex¥ *
pRight
){

498 if–
pLe·
==0 ){

499  
pRight
;

500 }if–
pRight
==0 ){

501  
pLe·
;

503 
Ex¥
 *
pNew
 = 
	`sqlôe4Ex¥AŒoc
(
db
, 
TK_AND
, 0, 0);

504 
	`sqlôe4Ex¥AâachSubåìs
(
db
, 
pNew
, 
pLe·
, 
pRight
);

505  
pNew
;

507 
	}
}

513 
Ex¥
 *
	$sqlôe4Ex¥Fun˘i⁄
(
P¨£
 *
pP¨£
, 
Ex¥Li°
 *
pLi°
, 
Tokí
 *
pTokí
){

514 
Ex¥
 *
pNew
;

515 
sqlôe4
 *
db
 = 
pP¨£
->db;

516 
	`as£π
–
pTokí
 );

517 
pNew
 = 
	`sqlôe4Ex¥AŒoc
(
db
, 
TK_FUNCTION
, 
pTokí
, 1);

518 if–
pNew
==0 ){

519 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

522 
pNew
->
x
.
pLi°
 =ÖList;

523 
	`as£π
–!
	`Ex¥HasPr›îty
(
pNew
, 
EP_xIsSñe˘
) );

524 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
pNew
);

525  
pNew
;

526 
	}
}

544 
	$sqlôe4Ex¥AssignV¨Numbî
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
){

545 
sqlôe4
 *
db
 = 
pP¨£
->db;

546 c⁄° *
z
;

548 if–
pEx¥
==0 ) ;

549 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_I¡VÆue
|
EP_Redu˚d
|
EP_TokíO∆y
) );

550 
z
 = 
pEx¥
->
u
.
zTokí
;

551 
	`as£π
–
z
!=0 );

552 
	`as£π
–
z
[0]!=0 );

553 if–
z
[1]==0 ){

555 
	`as£π
–
z
[0]=='?' );

556 
pEx¥
->
iCﬁumn
 = (
ynV¨
)(++
pP¨£
->
nV¨
);

558 
ynV¨
 
x
 = 0;

559 
u32
 
n
 = 
	`sqlôe4SåÀn30
(
z
);

560 if–
z
[0]=='?' ){

563 
i64
 
i
;

564 
bOk
 = 0==
	`sqlôe4Atoi64
(&
z
[1], &
i
, 
n
-1, 
SQLITE4_UTF8
);

565 
pEx¥
->
iCﬁumn
 = 
x
 = (
ynV¨
)
i
;

566 
	`ã°ˇ£
–
i
==0 );

567 
	`ã°ˇ£
–
i
==1 );

568 
	`ã°ˇ£
–
i
==
db
->
aLimô
[
SQLITE4_LIMIT_VARIABLE_NUMBER
]-1 );

569 
	`ã°ˇ£
–
i
==
db
->
aLimô
[
SQLITE4_LIMIT_VARIABLE_NUMBER
] );

570 if–
bOk
==0 || 
i
<1 || i>
db
->
aLimô
[
SQLITE4_LIMIT_VARIABLE_NUMBER
] ){

571 
	`sqlôe4Eº‹Msg
(
pP¨£
, "variableÇumber must be between ?1ánd ?%d",

572 
db
->
aLimô
[
SQLITE4_LIMIT_VARIABLE_NUMBER
]);

573 
x
 = 0;

575 if–
i
>
pP¨£
->
nV¨
 ){

576 
pP¨£
->
nV¨
 = ()
i
;

583 
ynV¨
 
i
;

584 
i
=0; i<
pP¨£
->
nzV¨
; i++){

585 if–
pP¨£
->
azV¨
[
i
] && 
	`memcmp
’P¨£->azV¨[i],
z
,
n
+1)==0 ){

586 
pEx¥
->
iCﬁumn
 = 
x
 = (
ynV¨
)
i
+1;

590 if–
x
==0 ) x = 
pEx¥
->
iCﬁumn
 = (
ynV¨
)(++
pP¨£
->
nV¨
);

592 if–
x
>0 ){

593 if–
x
>
pP¨£
->
nzV¨
 ){

594 **
a
;

595 
a
 = 
	`sqlôe4DbRóŒoc
(
db
, 
pP¨£
->
azV¨
, 
x
*(a[0]));

596 if–
a
==0 ) ;

597 
pP¨£
->
azV¨
 = 
a
;

598 
	`mem£t
(&
a
[
pP¨£
->
nzV¨
], 0, (
x
-pParse->nzVar)*(a[0]));

599 
pP¨£
->
nzV¨
 = 
x
;

601 if–
z
[0]!='?' || 
pP¨£
->
azV¨
[
x
-1]==0 ){

602 
	`sqlôe4DbFªe
(
db
, 
pP¨£
->
azV¨
[
x
-1]);

603 
pP¨£
->
azV¨
[
x
-1] = 
	`sqlôe4DbSåNDup
(
db
, 
z
, 
n
);

607 if–!
pP¨£
->
nEº
 &&ÖP¨£->
nV¨
>
db
->
aLimô
[
SQLITE4_LIMIT_VARIABLE_NUMBER
] ){

608 
	`sqlôe4Eº‹Msg
(
pP¨£
, "too many SQL variables");

610 
	}
}

615 
	$sqlôe4Ex¥Dñëe
(
sqlôe4
 *
db
, 
Ex¥
 *
p
){

616 if–
p
==0 ) ;

618 
	`as£π
–!
	`Ex¥HasPr›îty
(
p
, 
EP_I¡VÆue
Ë||Ö->
u
.
iVÆue
>=0 );

619 if–!
	`Ex¥HasAnyPr›îty
(
p
, 
EP_TokíO∆y
) ){

620 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pLe·
);

621 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pRight
);

622 if–!
	`Ex¥HasPr›îty
(
p
, 
EP_Redu˚d
Ë&& (p->
Êags2
 & 
EP2_MÆlo˚dTokí
)!=0 ){

623 
	`sqlôe4DbFªe
(
db
, 
p
->
u
.
zTokí
);

625 if–
	`Ex¥HasPr›îty
(
p
, 
EP_xIsSñe˘
) ){

626 
	`sqlôe4Sñe˘Dñëe
(
db
, 
p
->
x
.
pSñe˘
);

628 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
p
->
x
.
pLi°
);

631 if–!
	`Ex¥HasPr›îty
(
p
, 
EP_Sètic
) ){

632 
	`sqlôe4DbFªe
(
db
, 
p
);

634 
	}
}

641 
	$ex¥Såu˘Size
(
Ex¥
 *
p
){

642 if–
	`Ex¥HasPr›îty
(
p
, 
EP_TokíO∆y
ËË 
EXPR_TOKENONLYSIZE
;

643 if–
	`Ex¥HasPr›îty
(
p
, 
EP_Redu˚d
ËË 
EXPR_REDUCEDSIZE
;

644  
EXPR_FULLSIZE
;

645 
	}
}

681 
	$du≥dEx¥Såu˘Size
(
Ex¥
 *
p
, 
Êags
){

682 
nSize
;

683 
	`as£π
–
Êags
==
EXPRDUP_REDUCE
 || flags==0 );

684 if–0==(
Êags
&
EXPRDUP_REDUCE
) ){

685 
nSize
 = 
EXPR_FULLSIZE
;

687 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
p
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

688 
	`as£π
–!
	`Ex¥HasPr›îty
(
p
, 
EP_FromJoö
) );

689 
	`as£π
–(
p
->
Êags2
 & 
EP2_MÆlo˚dTokí
)==0 );

690 
	`as£π
–(
p
->
Êags2
 & 
EP2_IºeducibÀ
)==0 );

691 if–
p
->
pLe·
 ||Ö->
pRight
 ||Ö->
pCﬁl
 ||Ö->
x
.
pLi°
 ){

692 
nSize
 = 
EXPR_REDUCEDSIZE
 | 
EP_Redu˚d
;

694 
nSize
 = 
EXPR_TOKENONLYSIZE
 | 
EP_TokíO∆y
;

697  
nSize
;

698 
	}
}

705 
	$du≥dEx¥NodeSize
(
Ex¥
 *
p
, 
Êags
){

706 
nByã
 = 
	`du≥dEx¥Såu˘Size
(
p
, 
Êags
) & 0xfff;

707 if–!
	`Ex¥HasPr›îty
(
p
, 
EP_I¡VÆue
Ë&&Ö->
u
.
zTokí
 ){

708 
nByã
 +
	`sqlôe4SåÀn30
(
p
->
u
.
zTokí
)+1;

710  
	`ROUND8
(
nByã
);

711 
	}
}

726 
	$du≥dEx¥Size
(
Ex¥
 *
p
, 
Êags
){

727 
nByã
 = 0;

728 if–
p
 ){

729 
nByã
 = 
	`du≥dEx¥NodeSize
(
p
, 
Êags
);

730 if–
Êags
&
EXPRDUP_REDUCE
 ){

731 
nByã
 +
	`du≥dEx¥Size
(
p
->
pLe·
, 
Êags
Ë+ du≥dEx¥Size’->
pRight
, flags);

734  
nByã
;

735 
	}
}

745 
Ex¥
 *
	$ex¥Dup
(
sqlôe4
 *
db
, 
Ex¥
 *
p
, 
Êags
, 
u8
 **
pzBuf„r
){

746 
Ex¥
 *
pNew
 = 0;

747 if–
p
 ){

748 c⁄° 
isRedu˚d
 = (
Êags
&
EXPRDUP_REDUCE
);

749 
u8
 *
zAŒoc
;

750 
u32
 
°©icFœg
 = 0;

752 
	`as£π
–
pzBuf„r
==0 || 
isRedu˚d
 );

755 if–
pzBuf„r
 ){

756 
zAŒoc
 = *
pzBuf„r
;

757 
°©icFœg
 = 
EP_Sètic
;

759 
zAŒoc
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
	`du≥dEx¥Size
(
p
, 
Êags
));

761 
pNew
 = (
Ex¥
 *)
zAŒoc
;

763 if–
pNew
 ){

769 c⁄° 
nSåu˘Size
 = 
	`du≥dEx¥Såu˘Size
(
p
, 
Êags
);

770 c⁄° 
nNewSize
 = 
nSåu˘Size
 & 0xfff;

771 
nTokí
;

772 if–!
	`Ex¥HasPr›îty
(
p
, 
EP_I¡VÆue
Ë&&Ö->
u
.
zTokí
 ){

773 
nTokí
 = 
	`sqlôe4SåÀn30
(
p
->
u
.
zTokí
) + 1;

775 
nTokí
 = 0;

777 if–
isRedu˚d
 ){

778 
	`as£π
–
	`Ex¥HasPr›îty
(
p
, 
EP_Redu˚d
)==0 );

779 
	`mem˝y
(
zAŒoc
, 
p
, 
nNewSize
);

781 
nSize
 = 
	`ex¥Såu˘Size
(
p
);

782 
	`mem˝y
(
zAŒoc
, 
p
, 
nSize
);

783 
	`mem£t
(&
zAŒoc
[
nSize
], 0, 
EXPR_FULLSIZE
-nSize);

787 
pNew
->
Êags
 &~(
EP_Redu˚d
|
EP_TokíO∆y
|
EP_Sètic
);

788 
pNew
->
Êags
 |
nSåu˘Size
 & (
EP_Redu˚d
|
EP_TokíO∆y
);

789 
pNew
->
Êags
 |
°©icFœg
;

792 if–
nTokí
 ){

793 *
zTokí
 = 
pNew
->
u
.zTokí = (*)&
zAŒoc
[
nNewSize
];

794 
	`mem˝y
(
zTokí
, 
p
->
u
.zTokí, 
nTokí
);

797 if–0==((
p
->
Êags
|
pNew
->ÊagsË& 
EP_TokíO∆y
) ){

799 if–
	`Ex¥HasPr›îty
(
p
, 
EP_xIsSñe˘
) ){

800 
pNew
->
x
.
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
p
->x.pSñe˘, 
isRedu˚d
);

802 
pNew
->
x
.
pLi°
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
p
->x.pLi°, 
isRedu˚d
);

807 if–
	`Ex¥HasAnyPr›îty
(
pNew
, 
EP_Redu˚d
|
EP_TokíO∆y
) ){

808 
zAŒoc
 +
	`du≥dEx¥NodeSize
(
p
, 
Êags
);

809 if–
	`Ex¥HasPr›îty
(
pNew
, 
EP_Redu˚d
) ){

810 
pNew
->
pLe·
 = 
	`ex¥Dup
(
db
, 
p
->pLe·, 
EXPRDUP_REDUCE
, &
zAŒoc
);

811 
pNew
->
pRight
 = 
	`ex¥Dup
(
db
, 
p
->pRight, 
EXPRDUP_REDUCE
, &
zAŒoc
);

813 if–
pzBuf„r
 ){

814 *
pzBuf„r
 = 
zAŒoc
;

817 
pNew
->
Êags2
 = 0;

818 if–!
	`Ex¥HasAnyPr›îty
(
p
, 
EP_TokíO∆y
) ){

819 
pNew
->
pLe·
 = 
	`sqlôe4Ex¥Dup
(
db
, 
p
->pLeft, 0);

820 
pNew
->
pRight
 = 
	`sqlôe4Ex¥Dup
(
db
, 
p
->pRight, 0);

826  
pNew
;

827 
	}
}

846 
Ex¥
 *
	$sqlôe4Ex¥Dup
(
sqlôe4
 *
db
, 
Ex¥
 *
p
, 
Êags
){

847  
	`ex¥Dup
(
db
, 
p
, 
Êags
, 0);

848 
	}
}

849 
Ex¥Li°
 *
	$sqlôe4Ex¥Li°Dup
(
sqlôe4
 *
db
, 
Ex¥Li°
 *
p
, 
Êags
){

850 
Ex¥Li°
 *
pNew
;

851 
Ex¥Li°Iãm
 *
pIãm
, *
pOldIãm
;

852 
i
;

853 if–
p
==0 )  0;

854 
pNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (*pNew) );

855 if–
pNew
==0 )  0;

856 
pNew
->
iECurs‹
 = 0;

857 
pNew
->
nEx¥
 =ÖNew->
nAŒoc
 = 
p
->nExpr;

858 
pNew
->
a
 = 
pIãm
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
p
->
nEx¥
*(p->a[0]) );

859 if–
pIãm
==0 ){

860 
	`sqlôe4DbFªe
(
db
, 
pNew
);

863 
pOldIãm
 = 
p
->
a
;

864 
i
=0; i<
p
->
nEx¥
; i++, 
pIãm
++, 
pOldIãm
++){

865 
Ex¥
 *
pOldEx¥
 = 
pOldIãm
->
pEx¥
;

866 
pIãm
->
pEx¥
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pOldEx¥
, 
Êags
);

867 
pIãm
->
zName
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zName);

868 
pIãm
->
zS∑n
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zSpan);

869 
pIãm
->
s‹tOrdî
 = 
pOldIãm
->sortOrder;

870 
pIãm
->
d⁄e
 = 0;

871 
pIãm
->
iOrdîByCﬁ
 = 
pOldIãm
->iOrderByCol;

872 
pIãm
->
iAlüs
 = 
pOldIãm
->iAlias;

874  
pNew
;

875 
	}
}

883 #i‡!
deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed(
SQLITE4_OMIT_TRIGGER
) \

884 || !
	$deföed
(
SQLITE4_OMIT_SUBQUERY
)

885 
SrcLi°
 *
	$sqlôe4SrcLi°Dup
(
sqlôe4
 *
db
, 
SrcLi°
 *
p
, 
Êags
){

886 
SrcLi°
 *
pNew
;

887 
i
;

888 
nByã
;

889 if–
p
==0 )  0;

890 
nByã
 = (*
p
Ë+ (p->
nSrc
>0 ? ’->
a
[0]) * (p->nSrc-1) : 0);

891 
pNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
nByã
 );

892 if–
pNew
==0 )  0;

893 
pNew
->
nSrc
 =ÖNew->
nAŒoc
 = 
p
->nSrc;

894 
i
=0; i<
p
->
nSrc
; i++){

895 
SrcLi°Iãm
 *
pNewIãm
 = &
pNew
->
a
[
i
];

896 
SrcLi°Iãm
 *
pOldIãm
 = &
p
->
a
[
i
];

897 
TabÀ
 *
pTab
;

898 
pNewIãm
->
zD©aba£
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zDatabase);

899 
pNewIãm
->
zName
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zName);

900 
pNewIãm
->
zAlüs
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zAlias);

901 
pNewIãm
->
joöty≥
 = 
pOldIãm
->jointype;

902 
pNewIãm
->
iCurs‹
 = 
pOldIãm
->iCursor;

903 
pNewIãm
->
addrFûlSub
 = 
pOldIãm
->addrFillSub;

904 
pNewIãm
->
ªgRëu∫
 = 
pOldIãm
->regReturn;

905 
pNewIãm
->
isC‹ªœãd
 = 
pOldIãm
->isCorrelated;

906 
pNewIãm
->
zIndex
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zIndex);

907 
pNewIãm
->
nŸIndexed
 = 
pOldIãm
->notIndexed;

908 
pNewIãm
->
pIndex
 = 
pOldIãm
->pIndex;

909 
pTab
 = 
pNewIãm
->pTab = 
pOldIãm
->pTab;

910 if–
pTab
 ){

911 
pTab
->
nRef
++;

913 
pNewIãm
->
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
pOldIãm
->pSñe˘, 
Êags
);

914 
pNewIãm
->
pOn
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pOldIãm
->pOn, 
Êags
);

915 
pNewIãm
->
pUsög
 = 
	`sqlôe4IdLi°Dup
(
db
, 
pOldIãm
->pUsing);

916 
pNewIãm
->
cﬁU£d
 = 
pOldIãm
->colUsed;

918  
pNew
;

919 
	}
}

920 
IdLi°
 *
	$sqlôe4IdLi°Dup
(
sqlôe4
 *
db
, 
IdLi°
 *
p
){

921 
IdLi°
 *
pNew
;

922 
i
;

923 if–
p
==0 )  0;

924 
pNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (*pNew) );

925 if–
pNew
==0 )  0;

926 
pNew
->
nId
 =ÖNew->
nAŒoc
 = 
p
->nId;

927 
pNew
->
a
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
p
->
nId
*(p->a[0]) );

928 if–
pNew
->
a
==0 ){

929 
	`sqlôe4DbFªe
(
db
, 
pNew
);

932 
i
=0; i<
p
->
nId
; i++){

933 
IdLi°Iãm
 *
pNewIãm
 = &
pNew
->
a
[
i
];

934 
IdLi°Iãm
 *
pOldIãm
 = &
p
->
a
[
i
];

935 
pNewIãm
->
zName
 = 
	`sqlôe4DbSåDup
(
db
, 
pOldIãm
->zName);

936 
pNewIãm
->
idx
 = 
pOldIãm
->idx;

938  
pNew
;

939 
	}
}

940 
Sñe˘
 *
	$sqlôe4Sñe˘Dup
(
sqlôe4
 *
db
, 
Sñe˘
 *
p
, 
Êags
){

941 
Sñe˘
 *
pNew
, *
pPri‹
;

942 if–
p
==0 )  0;

943 
pNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (*
p
) );

944 if–
pNew
==0 )  0;

945 
pNew
->
pELi°
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
p
->pELi°, 
Êags
);

946 
pNew
->
pSrc
 = 
	`sqlôe4SrcLi°Dup
(
db
, 
p
->pSrc, 
Êags
);

947 
pNew
->
pWhîe
 = 
	`sqlôe4Ex¥Dup
(
db
, 
p
->pWhîe, 
Êags
);

948 
pNew
->
pGroupBy
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
p
->pGroupBy, 
Êags
);

949 
pNew
->
pHavög
 = 
	`sqlôe4Ex¥Dup
(
db
, 
p
->pHavög, 
Êags
);

950 
pNew
->
pOrdîBy
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
p
->pOrdîBy, 
Êags
);

951 
pNew
->
›
 = 
p
->op;

952 
pNew
->
pPri‹
 =ÖPri‹ = 
	`sqlôe4Sñe˘Dup
(
db
, 
p
->pPri‹, 
Êags
);

953 if–
pPri‹
 )ÖPri‹->
pNext
 = 
pNew
;

954 
pNew
->
pNext
 = 0;

955 
pNew
->
pLimô
 = 
	`sqlôe4Ex¥Dup
(
db
, 
p
->pLimô, 
Êags
);

956 
pNew
->
pOff£t
 = 
	`sqlôe4Ex¥Dup
(
db
, 
p
->pOff£t, 
Êags
);

957 
pNew
->
iLimô
 = 0;

958 
pNew
->
iOff£t
 = 0;

959 
pNew
->
£lFœgs
 = 
p
->£lFœg†& ~
SF_U£sEphemîÆ
;

960 
pNew
->
pRightmo°
 = 0;

961 
pNew
->
addrO≥nEphm
[0] = -1;

962 
pNew
->
addrO≥nEphm
[1] = -1;

963 
pNew
->
addrO≥nEphm
[2] = -1;

964  
pNew
;

965 
	}
}

967 
Sñe˘
 *
	$sqlôe4Sñe˘Dup
(
sqlôe4
 *
db
, 
Sñe˘
 *
p
, 
Êags
){

968 
	`as£π
–
p
==0 );

970 
	}
}

982 
Ex¥Li°
 *
	$sqlôe4Ex¥Li°Aµíd
(

983 
P¨£
 *
pP¨£
,

984 
Ex¥Li°
 *
pLi°
,

985 
Ex¥
 *
pEx¥


987 
sqlôe4
 *
db
 = 
pP¨£
->db;

988 if–
pLi°
==0 ){

989 
pLi°
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Ex¥Li°
) );

990 if–
pLi°
==0 ){

991 
no_mem
;

993 
	`as£π
–
pLi°
->
nAŒoc
==0 );

995 if–
pLi°
->
nAŒoc
<ıLi°->
nEx¥
 ){

996 
Ex¥Li°Iãm
 *
a
;

997 
n
 = 
pLi°
->
nAŒoc
*2 + 4;

998 
a
 = 
	`sqlôe4DbRóŒoc
(
db
, 
pLi°
->a, 
n
*(pList->a[0]));

999 if–
a
==0 ){

1000 
no_mem
;

1002 
pLi°
->
a
 =á;

1003 
pLi°
->
nAŒoc
 = 
	`sqlôe4DbMÆlocSize
(
db
, 
a
)/(a[0]);

1005 
	`as£π
–
pLi°
->
a
!=0 );

1007 
Ex¥Li°Iãm
 *
pIãm
 = &
pLi°
->
a
[pLi°->
nEx¥
++];

1008 
	`mem£t
(
pIãm
, 0, (*pItem));

1009 
pIãm
->
pEx¥
 =ÖExpr;

1011  
pLi°
;

1013 
no_mem
:

1015 
	`sqlôe4Ex¥Dñëe
(
db
, 
pEx¥
);

1016 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

1018 
	}
}

1028 
	$sqlôe4Ex¥Li°SëName
(

1029 
P¨£
 *
pP¨£
,

1030 
Ex¥Li°
 *
pLi°
,

1031 
Tokí
 *
pName
,

1032 
dequŸe


1034 
	`as£π
–
pLi°
!=0 || 
pP¨£
->
db
->
mÆlocFaûed
!=0 );

1035 if–
pLi°
 ){

1036 
Ex¥Li°Iãm
 *
pIãm
;

1037 
	`as£π
–
pLi°
->
nEx¥
>0 );

1038 
pIãm
 = &
pLi°
->
a
[pLi°->
nEx¥
-1];

1039 
	`as£π
–
pIãm
->
zName
==0 );

1040 
pIãm
->
zName
 = 
	`sqlôe4DbSåNDup
(
pP¨£
->
db
, 
pName
->
z
,ÖName->
n
);

1041 if–
dequŸe
 && 
pIãm
->
zName
 ) 
	`sqlôe4DequŸe
(pItem->zName);

1043 
	}
}

1053 
	$sqlôe4Ex¥Li°SëS∑n
(

1054 
P¨£
 *
pP¨£
,

1055 
Ex¥Li°
 *
pLi°
,

1056 
Ex¥S∑n
 *
pS∑n


1058 
sqlôe4
 *
db
 = 
pP¨£
->db;

1059 
	`as£π
–
pLi°
!=0 || 
db
->
mÆlocFaûed
!=0 );

1060 if–
pLi°
 ){

1061 
Ex¥Li°Iãm
 *
pIãm
 = &
pLi°
->
a
[pLi°->
nEx¥
-1];

1062 
	`as£π
–
pLi°
->
nEx¥
>0 );

1063 
	`as£π
–
db
->
mÆlocFaûed
 || 
pIãm
->
pEx¥
==
pS∑n
->pExpr );

1064 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zS∑n
);

1065 
pIãm
->
zS∑n
 = 
	`sqlôe4DbSåNDup
(
db
, (*)
pS∑n
->
zSèπ
,

1066 ()(
pS∑n
->
zEnd
 -ÖS∑n->
zSèπ
));

1068 
	}
}

1074 
	$sqlôe4Ex¥Li°CheckLígth
(

1075 
P¨£
 *
pP¨£
,

1076 
Ex¥Li°
 *
pELi°
,

1077 c⁄° *
zObje˘


1079 
mx
 = 
pP¨£
->
db
->
aLimô
[
SQLITE4_LIMIT_COLUMN
];

1080 
	`ã°ˇ£
–
pELi°
 &&ÖELi°->
nEx¥
==
mx
 );

1081 
	`ã°ˇ£
–
pELi°
 &&ÖELi°->
nEx¥
==
mx
+1 );

1082 if–
pELi°
 &&ÖELi°->
nEx¥
>
mx
 ){

1083 
	`sqlôe4Eº‹Msg
(
pP¨£
, "toÿm™y cﬁumn†ö %s", 
zObje˘
);

1085 
	}
}

1090 
	$sqlôe4Ex¥Li°Dñëe
(
sqlôe4
 *
db
, 
Ex¥Li°
 *
pLi°
){

1091 
i
;

1092 
Ex¥Li°Iãm
 *
pIãm
;

1093 if–
pLi°
==0 ) ;

1094 
	`as£π
–
pLi°
->
a
!=0 || (pLi°->
nEx¥
==0 &&ÖLi°->
nAŒoc
==0) );

1095 
	`as£π
–
pLi°
->
nEx¥
<ıLi°->
nAŒoc
 );

1096 
pIãm
=
pLi°
->
a
, 
i
=0; i<pLi°->
nEx¥
; i++,ÖItem++){

1097 
	`sqlôe4Ex¥Dñëe
(
db
, 
pIãm
->
pEx¥
);

1098 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zName
);

1099 
	`sqlôe4DbFªe
(
db
, 
pIãm
->
zS∑n
);

1101 
	`sqlôe4DbFªe
(
db
, 
pLi°
->
a
);

1102 
	`sqlôe4DbFªe
(
db
, 
pLi°
);

1103 
	}
}

1118 
	$ex¥NodeIsC⁄°™t
(
WÆkî
 *
pWÆkî
, 
Ex¥
 *
pEx¥
){

1123 if–
pWÆkî
->
u
.
i
==3 && 
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_FromJoö
) ){

1124 
pWÆkî
->
u
.
i
 = 0;

1125  
WRC_Ab‹t
;

1128  
pEx¥
->
›
 ){

1131 
TK_FUNCTION
:

1132 if–
pWÆkî
->
u
.
i
==2 )  0;

1134 
TK_ID
:

1135 
TK_MATCH
:

1136 
TK_COLUMN
:

1137 
TK_AGG_FUNCTION
:

1138 
TK_AGG_COLUMN
:

1139 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_ID
 );

1140 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_COLUMN
 );

1141 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_AGG_FUNCTION
 );

1142 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_AGG_COLUMN
 );

1143 
pWÆkî
->
u
.
i
 = 0;

1144  
WRC_Ab‹t
;

1146 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_SELECT
 );

1147 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_EXISTS
 );

1148  
WRC_C⁄töue
;

1150 
	}
}

1151 
	$£À˘NodeIsC⁄°™t
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
NŸU£d
){

1152 
	`UNUSED_PARAMETER
(
NŸU£d
);

1153 
pWÆkî
->
u
.
i
 = 0;

1154  
WRC_Ab‹t
;

1155 
	}
}

1156 
	$ex¥IsC⁄°
(
Ex¥
 *
p
, 
öôFœg
){

1157 
WÆkî
 
w
;

1158 
w
.
u
.
i
 = 
öôFœg
;

1159 
w
.
xEx¥CÆlback
 = 
ex¥NodeIsC⁄°™t
;

1160 
w
.
xSñe˘CÆlback
 = 
£À˘NodeIsC⁄°™t
;

1161 
	`sqlôe4WÆkEx¥
(&
w
, 
p
);

1162  
w
.
u
.
i
;

1163 
	}
}

1173 
	$sqlôe4Ex¥IsC⁄°™t
(
Ex¥
 *
p
){

1174  
	`ex¥IsC⁄°
(
p
, 1);

1175 
	}
}

1183 
	$sqlôe4Ex¥IsC⁄°™tNŸJoö
(
Ex¥
 *
p
){

1184  
	`ex¥IsC⁄°
(
p
, 3);

1185 
	}
}

1196 
	$sqlôe4Ex¥IsC⁄°™tOrFun˘i⁄
(
Ex¥
 *
p
){

1197  
	`ex¥IsC⁄°
(
p
, 2);

1198 
	}
}

1206 
	$sqlôe4Ex¥IsI¡egî
(
Ex¥
 *
p
, *
pVÆue
){

1207 
rc
 = 0;

1211 
	`as£π
–
p
->
›
!=
TK_INTEGER
 || (p->
Êags
 & 
EP_I¡VÆue
)!=0

1212 || 
	`sqlôe4GëI¡32
(
p
->
u
.
zTokí
, &
rc
)==0 );

1214 if–
p
->
Êags
 & 
EP_I¡VÆue
 ){

1215 *
pVÆue
 = 
p
->
u
.
iVÆue
;

1218  
p
->
›
 ){

1219 
TK_UPLUS
: {

1220 
rc
 = 
	`sqlôe4Ex¥IsI¡egî
(
p
->
pLe·
, 
pVÆue
);

1223 
TK_UMINUS
: {

1224 
v
;

1225 if–
	`sqlôe4Ex¥IsI¡egî
(
p
->
pLe·
, &
v
) ){

1226 *
pVÆue
 = -
v
;

1227 
rc
 = 1;

1233  
rc
;

1234 
	}
}

1250 
	$sqlôe4Ex¥C™BeNuŒ
(c⁄° 
Ex¥
 *
p
){

1251 
u8
 
›
;

1252  
p
->
›
==
TK_UPLUS
 ||Ö->›==
TK_UMINUS
 ){Ö =Ö->
pLe·
; }

1253 
›
 = 
p
->op;

1254 if–
›
==
TK_REGISTER
 ) o∞
p
->
›2
;

1255  
›
 ){

1256 
TK_INTEGER
:

1257 
TK_STRING
:

1258 
TK_FLOAT
:

1259 
TK_BLOB
:

1264 
	}
}

1273 
	$sqlôe4Ex¥CodeIsNuŒJump
(

1274 
Vdbe
 *
v
,

1275 c⁄° 
Ex¥
 *
pEx¥
,

1276 
iReg
,

1277 
iDe°


1279 if–
	`sqlôe4Ex¥C™BeNuŒ
(
pEx¥
) ){

1280 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
iReg
, 
iDe°
);

1282 
	}
}

1294 
	$sqlôe4Ex¥NìdsNoAfföôyCh™ge
(c⁄° 
Ex¥
 *
p
, 
aff
){

1295 
u8
 
›
;

1296 if–
aff
==
SQLITE4_AFF_NONE
 )  1;

1297  
p
->
›
==
TK_UPLUS
 ||Ö->›==
TK_UMINUS
 ){Ö =Ö->
pLe·
; }

1298 
›
 = 
p
->op;

1299 if–
›
==
TK_REGISTER
 ) o∞
p
->
›2
;

1300  
›
 ){

1301 
TK_INTEGER
: {

1302  
aff
==
SQLITE4_AFF_INTEGER
 ||áff==
SQLITE4_AFF_NUMERIC
;

1304 
TK_FLOAT
: {

1305  
aff
==
SQLITE4_AFF_REAL
 ||áff==
SQLITE4_AFF_NUMERIC
;

1307 
TK_STRING
: {

1308  
aff
==
SQLITE4_AFF_TEXT
;

1310 
TK_BLOB
: {

1313 
TK_COLUMN
: {

1314 
	`as£π
–
p
->
iTabÀ
>=0 );

1315  
p
->
iCﬁumn
<0

1316 && (
aff
==
SQLITE4_AFF_INTEGER
 ||áff==
SQLITE4_AFF_NUMERIC
);

1322 
	}
}

1328 
	$sqlôe4CodeOn˚
(
P¨£
 *
pP¨£
){

1329 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1330  
	`sqlôe4VdbeAddOp1
(
v
, 
OP_On˚
, 
pP¨£
->
nOn˚
++);

1331 
	}
}

1345 #i‚de‡
SQLITE4_OMIT_SUBQUERY


1346 
	$isC™did©eF‹InO±
(
Sñe˘
 *
p
){

1347 
SrcLi°
 *
pSrc
;

1348 
Ex¥Li°
 *
pELi°
;

1349 
TabÀ
 *
pTab
;

1350 if–
p
==0 )  0;

1351 if–
p
->
pPri‹
 )  0;

1352 if–
p
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
) ){

1353 
	`ã°ˇ£
–(
p
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
))==SF_Distinct );

1354 
	`ã°ˇ£
–(
p
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
))==SF_Aggregate );

1357 
	`as£π
–
p
->
pGroupBy
==0 );

1358 if–
p
->
pLimô
 )  0;

1359 
	`as£π
–
p
->
pOff£t
==0 );

1360 if–
p
->
pWhîe
 )  0;

1361 
pSrc
 = 
p
->pSrc;

1362 
	`as£π
–
pSrc
!=0 );

1363 if–
pSrc
->
nSrc
!=1 )  0;

1364 if–
pSrc
->
a
[0].
pSñe˘
 )  0;

1365 
pTab
 = 
pSrc
->
a
[0].pTab;

1366 if–
	`NEVER
(
pTab
==0) )  0;

1367 
	`as£π
–
pTab
->
pSñe˘
==0 );

1368 if–
	`IsVútuÆ
(
pTab
) )  0;

1369 
pELi°
 = 
p
->pEList;

1370 if–
pELi°
->
nEx¥
!=1 )  0;

1371 if–
pELi°
->
a
[0].
pEx¥
->
›
!=
TK_COLUMN
 )  0;

1373 
	}
}

1375 
Index
 *
	$sqlôe4FödExi°ögInIndex
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pX
, 
bReqUnique
){

1376 
Index
 *
pIdx
 = 0;

1377 
Sñe˘
 *
p
;

1379 
p
 = (
	`Ex¥HasPr›îty
(
pX
, 
EP_xIsSñe˘
Ë?ÖX->
x
.
pSñe˘
 : 0);

1380 if–
	`ALWAYS
(
pP¨£
->
nEº
==0Ë&& 
	`isC™did©eF‹InO±
(
p
) ){

1381 
sqlôe4
 *
db
 = 
pP¨£
->db;

1382 
TabÀ
 *
pTab
 = 
p
->
pSrc
->
a
[0].pTab;

1383 
Ex¥
 *
pRhs
 = 
p
->
pELi°
->
a
[0].
pEx¥
;

1384 
iCﬁ
 = 
pRhs
->
iCﬁumn
;

1385 
CﬁlSeq
 *
pReq
;

1386 
cﬁaff
;

1391 
pReq
 = 
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
pP¨£
, 
pX
->
pLe·
, 
pRhs
);

1392 if–!
pReq
 )ÖReq = 
db
->
pDÊtCﬁl
;

1397 
cﬁaff
 = (
iCﬁ
<0Ë? 
SQLITE4_AFF_NUMERIC
 : 
pTab
->
aCﬁ
[iCﬁ].
afföôy
;

1398 if–0==
	`sqlôe4IndexAfföôyOk
(
pX
, 
cﬁaff
) )  0;

1400 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

1401 if–(
pIdx
->
aiCﬁumn
[0]==
iCﬁ
)

1402 && 
	`sqlôe4FödCﬁlSeq
(
db
, 
pIdx
->
azCﬁl
[0], 0)==
pReq


1403 && (!
bReqUnique
 || (
pIdx
->
nCﬁumn
==1 &&ÖIdx->
⁄Eº‹
!=
OE_N⁄e
))

1410  
pIdx
;

1411 
	}
}

1414 #i‚de‡
SQLITE4_OMIT_SUBQUERY


1498 
	$sqlôe4FödInIndex
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pX
, *
¥NŸFound
, *
piCov
){

1499 
Sñe˘
 *
p
;

1500 
eTy≥
 = 0;

1501 
iTab
 = 
pP¨£
->
nTab
++;

1502 
mu°BeUnique
 = (
¥NŸFound
==0);

1503 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1505 
	`as£π
–
pX
->
›
==
TK_IN
 );

1506 
	`as£π
–
mu°BeUnique
==(
piCov
!=0) );

1511 
	`as£π
(
v
);

1517 
p
 = (
	`Ex¥HasPr›îty
(
pX
, 
EP_xIsSñe˘
Ë?ÖX->
x
.
pSñe˘
 : 0);

1518 if–
	`ALWAYS
(
pP¨£
->
nEº
==0Ë&& 
	`isC™did©eF‹InO±
(
p
) ){

1519 
sqlôe4
 *
db
 = 
pP¨£
->db;

1520 
TabÀ
 *
pTab
;

1521 
Ex¥
 *
pEx¥
;

1522 
iCﬁ
;

1523 
iDb
;

1524 
Index
 *
pIdx
;

1525 
CﬁlSeq
 *
pReq
;

1526 
afföôy
;

1527 
afföôy_ok
;

1529 
	`as£π
–
p
 );

1530 
	`as£π
–
p
->
pELi°
!=0 );

1531 
	`as£π
–
p
->
pELi°
->
a
[0].
pEx¥
!=0 );

1532 
	`as£π
–
p
->
pSrc
!=0 );

1533 
pTab
 = 
p
->
pSrc
->
a
[0].pTab;

1534 
pEx¥
 = 
p
->
pELi°
->
a
[0].pExpr;

1535 
iCﬁ
 = 
pEx¥
->
iCﬁumn
;

1538 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

1539 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

1544 
pReq
 = 
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
pP¨£
, 
pX
->
pLe·
, 
pEx¥
);

1549 
afföôy
 = (
iCﬁ
<0?
SQLITE4_AFF_NUMERIC
:
pTab
->
aCﬁ
[iCol].affinity);

1550 
afföôy_ok
 = 
	`sqlôe4IndexAfföôyOk
(
pX
, 
afföôy
);

1552 
pIdx
=
pTab
->
pIndex
;ÖIdx && 
eTy≥
==0 && 
afföôy_ok
;ÖIdxıIdx->
pNext
){

1553 if–(
pIdx
->
aiCﬁumn
[0]==
iCﬁ
)

1554 && (
iCﬁ
<0 || 
	`sqlôe4FödCﬁlSeq
(
db
, 
pIdx
->
azCﬁl
[0], 0)==
pReq
)

1555 && (!
mu°BeUnique
 || (
pIdx
->
nCﬁumn
==1 &&ÖIdx->
⁄Eº‹
!=
OE_N⁄e
))

1557 
iAddr
;

1559 if–
mu°BeUnique
 ){

1560 if–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 ){

1561 
i
;

1562 
i
=0; i<
pIdx
->
nCovî
; i++){

1563 if–
pIdx
->
aiCovî
[
i
]==
iCﬁ
 ) ;

1565 if–
i
==
pIdx
->
nCovî
 ) ;

1566 *
piCov
 = 
i
;

1568 *
piCov
 = 
iCﬁ
;

1572 
iAddr
 = 
	`sqlôe4CodeOn˚
(
pP¨£
);

1573 
	`sqlôe4O≥nIndex
(
pP¨£
, 
iTab
, 
iDb
, 
pIdx
, 
OP_O≥nRód
);

1574 
	`as£π
–
IN_INDEX_INDEX_DESC
 =
IN_INDEX_INDEX_ASC
+1 );

1575 if–
iCﬁ
<0 ){

1576 
eTy≥
 = 
IN_INDEX_ROWID
;

1578 
eTy≥
 = 
IN_INDEX_INDEX_ASC
 + 
pIdx
->
aS‹tOrdî
[0];

1581 
	`sqlôe4VdbeJumpHîe
(
v
, 
iAddr
);

1582 if–
¥NŸFound
 && !
pTab
->
aCﬁ
[
iCﬁ
].
nŸNuŒ
 ){

1583 *
¥NŸFound
 = ++
pP¨£
->
nMem
;

1584 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, *
¥NŸFound
);

1590 if–
eTy≥
==0 ){

1594 
u32
 
ßvedNQuîyLo›
 = 
pP¨£
->
nQuîyLo›
;

1595 
rMayHaveNuŒ
 = 0;

1596 
eTy≥
 = 
IN_INDEX_EPH
;

1597 if–
¥NŸFound
 ){

1598 *
¥NŸFound
 = 
rMayHaveNuŒ
 = ++
pP¨£
->
nMem
;

1599 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, *
¥NŸFound
);

1601 
	`ã°ˇ£
–
pP¨£
->
nQuîyLo›
>0 );

1602 
pP¨£
->
nQuîyLo›
 = 0;

1603 *
piCov
 = 0;

1605 
	`sqlôe4CodeSub£À˘
(
pP¨£
, 
pX
, 
rMayHaveNuŒ
);

1606 
pP¨£
->
nQuîyLo›
 = 
ßvedNQuîyLo›
;

1608 
pX
->
iTabÀ
 = 
iTab
;

1610  
eTy≥
;

1611 
	}
}

1647 #i‚de‡
SQLITE4_OMIT_SUBQUERY


1648 
	$sqlôe4CodeSub£À˘
(

1649 
P¨£
 *
pP¨£
,

1650 
Ex¥
 *
pEx¥
,

1651 
rMayHaveNuŒ


1653 
ã°Addr
 = -1;

1654 
rReg
 = 0;

1655 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1656 if–
	`NEVER
(
v
==0) )  0;

1657 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

1669 if–!
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_V¨Sñe˘
) ){

1670 
ã°Addr
 = 
	`sqlôe4CodeOn˚
(
pP¨£
);

1673 #i‚de‡
SQLITE4_OMIT_EXPLAIN


1674 if–
pP¨£
->
ex∂aö
==2 ){

1675 *
zMsg
 = 
	`sqlôe4MPrötf
(

1676 
pP¨£
->
db
, "EXECUTE %s%†SUBQUERY %d", 
ã°Addr
>=0?"":"CORRELATED ",

1677 
pEx¥
->
›
==
TK_IN
?"LIST":"SCALAR", 
pP¨£
->
iNextSñe˘Id


1679 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Ex∂aö
, 
pP¨£
->
iSñe˘Id
, 0, 0, 
zMsg
, 
P4_DYNAMIC
);

1683  
pEx¥
->
›
 ){

1684 
TK_IN
: {

1685 
afföôy
;

1686 
KeyInfo
 
keyInfo
;

1687 
addr
;

1688 
Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

1690 if–
rMayHaveNuŒ
 ){

1691 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
rMayHaveNuŒ
);

1694 
afföôy
 = 
	`sqlôe4Ex¥Afföôy
(
pLe·
);

1709 
pEx¥
->
iTabÀ
 = 
pP¨£
->
nTab
++;

1710 
addr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
pEx¥
->
iTabÀ
, 1);

1711 
	`mem£t
(&
keyInfo
, 0, (keyInfo));

1712 
keyInfo
.
nFõld
 = 1;

1714 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

1720 
Sñe˘De°
 
de°
;

1721 
Ex¥Li°
 *
pELi°
;

1723 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 
SRT_Së
, 
pEx¥
->
iTabÀ
);

1724 
de°
.
afföôy
 = (
u8
)affinity;

1725 
	`as£π
–(
pEx¥
->
iTabÀ
&0x0000FFFF)==pExpr->iTable );

1726 
pEx¥
->
x
.
pSñe˘
->
iLimô
 = 0;

1727 if–
	`sqlôe4Sñe˘
(
pP¨£
, 
pEx¥
->
x
.
pSñe˘
, &
de°
) ){

1730 
pELi°
 = 
pEx¥
->
x
.
pSñe˘
->pEList;

1731 if–
	`ALWAYS
(
pELi°
!=0 &&ÖELi°->
nEx¥
>0) ){

1732 
keyInfo
.
aCﬁl
[0] = 
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
pP¨£
, 
pEx¥
->
pLe·
,

1733 
pELi°
->
a
[0].
pEx¥
);

1735 }if–
	`ALWAYS
(
pEx¥
->
x
.
pLi°
!=0) ){

1743 
i
;

1744 
Ex¥Li°
 *
pLi°
 = 
pEx¥
->
x
.pList;

1745 
Ex¥Li°Iãm
 *
pIãm
;

1746 
r1
, 
r2
, 
r3
, 
r4
;

1748 if–!
afföôy
 ){

1749 
afföôy
 = 
SQLITE4_AFF_NONE
;

1751 
keyInfo
.
aCﬁl
[0] = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pEx¥
->
pLe·
);

1754 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1755 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1756 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
r2
);

1757 
i
=
pLi°
->
nEx¥
, 
pIãm
ıLi°->
a
; i>0; i--,ÖItem++){

1758 
Ex¥
 *
pE2
 = 
pIãm
->
pEx¥
;

1759 
iVÆToIns
;

1766 if–
ã°Addr
>=0 && !
	`sqlôe4Ex¥IsC⁄°™t
(
pE2
) ){

1767 
	`sqlôe4VdbeCh™geToNo›
(
v
, 
ã°Addr
);

1768 
ã°Addr
 = -1;

1772 
r3
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pE2
, 
r1
);

1773 
r4
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1774 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Afföôy
, 
r3
, 1, 0, &
afföôy
, 1);

1775 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
r3
, 1, 
r4
, 
pEx¥
->
iTabÀ
);

1776 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
r3
, 1, 
r2
);

1777 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
r3
, 1);

1778 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
pEx¥
->
iTabÀ
, 
r2
, 
r4
);

1779 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r4
);

1781 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

1782 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

1784 
	`sqlôe4VdbeCh™geP4
(
v
, 
addr
, (*)&
keyInfo
, 
P4_KEYINFO
);

1788 
TK_EXISTS
:

1789 
TK_SELECT
:

1797 
Sñe˘
 *
pSñ
;

1798 
Sñe˘De°
 
de°
;

1800 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_EXISTS
 );

1801 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_SELECT
 );

1802 
	`as£π
–
pEx¥
->
›
==
TK_EXISTS
 ||ÖEx¥->›==
TK_SELECT
 );

1804 
	`as£π
–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

1805 
pSñ
 = 
pEx¥
->
x
.
pSñe˘
;

1806 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 0, ++
pP¨£
->
nMem
);

1807 if–
pEx¥
->
›
==
TK_SELECT
 ){

1808 
de°
.
eDe°
 = 
SRT_Mem
;

1809 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
de°
.
iP¨m
);

1810 
	`VdbeCommít
((
v
, "Init subqueryÑesult"));

1812 
de°
.
eDe°
 = 
SRT_Exi°s
;

1813 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
de°
.
iP¨m
);

1814 
	`VdbeCommít
((
v
, "Init EXISTSÑesult"));

1816 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
pSñ
->
pLimô
);

1817 
pSñ
->
pLimô
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_INTEGER
, 0, 0,

1818 &
sqlôe4I¡Tokís
[1]);

1819 
pSñ
->
iLimô
 = 0;

1820 if–
	`sqlôe4Sñe˘
(
pP¨£
, 
pSñ
, &
de°
) ){

1823 
rReg
 = 
de°
.
iP¨m
;

1824 
	`Ex¥SëIºeducibÀ
(
pEx¥
);

1829 if–
ã°Addr
>=0 ){

1830 
	`sqlôe4VdbeJumpHîe
(
v
, 
ã°Addr
);

1832 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

1834  
rReg
;

1835 
	}
}

1838 #i‚de‡
SQLITE4_OMIT_SUBQUERY


1856 
	$sqlôe4Ex¥CodeIN
(

1857 
P¨£
 *
pP¨£
,

1858 
Ex¥
 *
pEx¥
,

1859 
de°IfFÆ£
,

1860 
de°IfNuŒ


1862 
rRhsHasNuŒ
 = 0;

1863 
afföôy
;

1864 
eTy≥
;

1865 
r1
;

1866 
Vdbe
 *
v
;

1871 
v
 = 
pP¨£
->
pVdbe
;

1872 
	`as£π
–
v
!=0 );

1873 
	`VdbeNo›Commít
((
v
, "begin INÉxpr"));

1874 
eTy≥
 = 
	`sqlôe4FödInIndex
(
pP¨£
, 
pEx¥
, &
rRhsHasNuŒ
, 0);

1880 
afföôy
 = 
	`com∑ris⁄Afföôy
(
pEx¥
);

1884 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

1885 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1886 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pEx¥
->
pLe·
, 
r1
);

1891 if–
de°IfNuŒ
==
de°IfFÆ£
 ){

1894 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
r1
, 
de°IfNuŒ
);

1896 
addr1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NŸNuŒ
, 
r1
);

1897 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
pEx¥
->
iTabÀ
, 
de°IfFÆ£
);

1898 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
de°IfNuŒ
);

1899 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr1
);

1902 if–
eTy≥
==
IN_INDEX_ROWID
 ){

1905 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Mu°BeI¡
, 
r1
, 
de°IfFÆ£
);

1906 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NŸExi°s
, 
pEx¥
->
iTabÀ
, 
de°IfFÆ£
, 
r1
);

1910 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Afföôy
, 
r1
, 1, 0, &
afföôy
, 1);

1918 if–
rRhsHasNuŒ
==0 || 
de°IfFÆ£
==
de°IfNuŒ
 ){

1926 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_NŸFound
, 
pEx¥
->
iTabÀ
, 
de°IfFÆ£
, 
r1
, 1);

1933 
j1
, 
j2
, 
j3
;

1939 
j1
 = 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_Found
, 
pEx¥
->
iTabÀ
, 0, 
r1
, 1);

1947 
j2
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NŸNuŒ
, 
rRhsHasNuŒ
);

1948 
j3
 = 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_Found
, 
pEx¥
->
iTabÀ
, 0, 
rRhsHasNuŒ
, 1);

1949 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, -1, 
rRhsHasNuŒ
);

1950 
	`sqlôe4VdbeJumpHîe
(
v
, 
j3
);

1951 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
rRhsHasNuŒ
, 1);

1952 
	`sqlôe4VdbeJumpHîe
(
v
, 
j2
);

1957 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
rRhsHasNuŒ
, 
de°IfNuŒ
);

1958 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
de°IfFÆ£
);

1963 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

1966 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

1967 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

1968 
	`VdbeCommít
((
v
, "end INÉxpr"));

1969 
	}
}

1972 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


1981 
	$codeRól
(
Vdbe
 *
v
, c⁄° *
z
, 
√g©eFœg
, 
iMem
){

1982 if–
	`ALWAYS
(
z
!=0) ){

1983 
s
 = (
sqlôe4_num
);

1984 
sqlôe4_num
 *
p
 = (sqlôe4_num *)
	`sqlôe4DbMÆlocZîo
(
	`sqlôe4VdbeDb
(
v
), 
s
);

1985 if–
p
 ){

1986 *
p
 = 
	`sqlôe4_num_‰om_ãxt
(
z
, -1, 0, 0);

1987 
	`as£π
–
p
->
sign
==0 );

1988 
	`as£π
–
√g©eFœg
==0 ||ÇegateFlag==1 );

1989 
p
->
sign
 = 
√g©eFœg
;

1990 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Num
, 0, 
iMem
, 0, (c⁄° *)
p
, 
P4_NUM
);

1993 
	}
}

2003 
	$codeI¡egî
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
√gFœg
, 
iMem
){

2004 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2005 if–
pEx¥
->
Êags
 & 
EP_I¡VÆue
 ){

2006 
i
 = 
pEx¥
->
u
.
iVÆue
;

2007 
	`as£π
–
i
>=0 );

2008 if–
√gFœg
 ) 
i
 = -i;

2009 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
, 
iMem
);

2011 
sqlôe4_num
 *
p
;

2012 c⁄° *
z
 = 
pEx¥
->
u
.
zTokí
;

2013 
	`as£π
–
z
!=0 );

2015 
p
 = (
sqlôe4_num
 *)
	`sqlôe4DbMÆlocRaw
(
pP¨£
->
db
, (sqlite4_num));

2016 if–
p
 ){

2017 *
p
 = 
	`sqlôe4_num_‰om_ãxt
(
z
, -1, (
√gFœg
 ? 
SQLITE4_NEGATIVE
 : 0), 0);

2018 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Num
, 
p
->
e
==0, 
iMem
, 0, (c⁄° *Ì, 
P4_NUM
);

2021 
	}
}

2026 
	$ˇcheE¡ryCÀ¨
(
P¨£
 *
pP¨£
, 
P¨£YCﬁCache
 *
p
){

2027 if–
p
->
ãmpReg
 ){

2028 if–
pP¨£
->
nTempReg
<
	`AºaySize
’P¨£->
aTempReg
) ){

2029 
pP¨£
->
aTempReg
[pP¨£->
nTempReg
++] = 
p
->
iReg
;

2031 
p
->
ãmpReg
 = 0;

2033 
	}
}

2040 
	$sqlôe4Ex¥CacheSt‹e
(
P¨£
 *
pP¨£
, 
iTab
, 
iCﬁ
, 
iReg
){

2041 
i
;

2042 
möLru
;

2043 
idxLru
;

2044 
P¨£YCﬁCache
 *
p
;

2046 
	`as£π
–
iReg
>0 );

2047 
	`as£π
–
iCﬁ
>=-1 && iCol<32768 );

2053 if–
pP¨£
->
db
->
Êags
 & 
SQLITE4_CﬁumnCache
 ) ;

2060 #i‚de‡
NDEBUG


2061 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2063 if–
p
->
iReg
 &&Ö->
iTabÀ
==
iTab
 &&Ö->
iCﬁumn
==
iCﬁ
 ){

2064 
	`ˇcheE¡ryCÀ¨
(
pP¨£
, 
p
);

2065 
p
->
iLevñ
 = 
pP¨£
->
iCacheLevñ
;

2066 
p
->
iReg
 = iReg;

2067 
p
->
Ãu
 = 
pP¨£
->
iCacheC¡
++;

2071 
	`as£π
–
p
->
iReg
==0 ||Ö->
iTabÀ
!=
iTab
 ||Ö->
iCﬁumn
!=
iCﬁ
 );

2076 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2077 if–
p
->
iReg
==0 ){

2078 
p
->
iLevñ
 = 
pP¨£
->
iCacheLevñ
;

2079 
p
->
iTabÀ
 = 
iTab
;

2080 
p
->
iCﬁumn
 = 
iCﬁ
;

2081 
p
->
iReg
 = iReg;

2082 
p
->
ãmpReg
 = 0;

2083 
p
->
Ãu
 = 
pP¨£
->
iCacheC¡
++;

2089 
möLru
 = 0x7fffffff;

2090 
idxLru
 = -1;

2091 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2092 if–
p
->
Ãu
<
möLru
 ){

2093 
idxLru
 = 
i
;

2094 
möLru
 = 
p
->
Ãu
;

2097 if–
	`ALWAYS
(
idxLru
>=0) ){

2098 
p
 = &
pP¨£
->
aCﬁCache
[
idxLru
];

2099 
p
->
iLevñ
 = 
pP¨£
->
iCacheLevñ
;

2100 
p
->
iTabÀ
 = 
iTab
;

2101 
p
->
iCﬁumn
 = 
iCﬁ
;

2102 
p
->
iReg
 = iReg;

2103 
p
->
ãmpReg
 = 0;

2104 
p
->
Ãu
 = 
pP¨£
->
iCacheC¡
++;

2107 
	}
}

2113 
	$sqlôe4Ex¥CacheRemove
(
P¨£
 *
pP¨£
, 
iReg
, 
nReg
){

2114 
i
;

2115 
iLa°
 = 
iReg
 + 
nReg
 - 1;

2116 
P¨£YCﬁCache
 *
p
;

2117 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2118 
r
 = 
p
->
iReg
;

2119 if–
r
>=
iReg
 &&Ñ<=
iLa°
 ){

2120 
	`ˇcheE¡ryCÀ¨
(
pP¨£
, 
p
);

2121 
p
->
iReg
 = 0;

2124 
	}
}

2131 
	$sqlôe4Ex¥CachePush
(
P¨£
 *
pP¨£
){

2132 
pP¨£
->
iCacheLevñ
++;

2133 
	}
}

2140 
	$sqlôe4Ex¥CacheP›
(
P¨£
 *
pP¨£
, 
N
){

2141 
i
;

2142 
P¨£YCﬁCache
 *
p
;

2143 
	`as£π
–
N
>0 );

2144 
	`as£π
–
pP¨£
->
iCacheLevñ
>=
N
 );

2145 
pP¨£
->
iCacheLevñ
 -
N
;

2146 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2147 if–
p
->
iReg
 &&Ö->
iLevñ
>
pP¨£
->
iCacheLevñ
 ){

2148 
	`ˇcheE¡ryCÀ¨
(
pP¨£
, 
p
);

2149 
p
->
iReg
 = 0;

2152 
	}
}

2160 
	$sqlôe4Ex¥CachePöRegi°î
(
P¨£
 *
pP¨£
, 
iReg
){

2161 
i
;

2162 
P¨£YCﬁCache
 *
p
;

2163 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2164 if–
p
->
iReg
==iReg ){

2165 
p
->
ãmpReg
 = 0;

2168 
	}
}

2173 
	$sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(

2174 
Vdbe
 *
v
,

2175 
TabÀ
 *
pTab
,

2176 
iTabCur
,

2177 
iCﬁ
,

2178 
ªgOut


2180 if–
iCﬁ
<0 ){

2181 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iTabCur
, 
ªgOut
);

2182 }if–
	`IsKv°‹e
(
pTab
) ){

2183 
aOp
[2] = { 
OP_RowKey
, 
OP_RowD©a
 };

2184 
	`as£π
–
iCﬁ
==0 || iCol==1 );

2185 
	`sqlôe4VdbeAddOp2
(
v
, 
aOp
[
iCﬁ
], 
iTabCur
, 
ªgOut
);

2187 
›
 = 
	`IsVútuÆ
(
pTab
Ë? 
OP_VCﬁumn
 : 
OP_Cﬁumn
;

2188 
	`sqlôe4VdbeAddOp3
(
v
, 
›
, 
iTabCur
, 
iCﬁ
, 
ªgOut
);

2190 if–
iCﬁ
>=0 ){

2191 
	`sqlôe4CﬁumnDeÁu…
(
v
, 
pTab
, 
iCﬁ
, 
ªgOut
);

2193 
	}
}

2204 
	$sqlôe4Ex¥CodeGëCﬁumn
(

2205 
P¨£
 *
pP¨£
,

2206 
TabÀ
 *
pTab
,

2207 
iCﬁumn
,

2208 
iTabÀ
,

2209 
iReg


2211 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2212 
i
;

2213 
P¨£YCﬁCache
 *
p
;

2215 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2216 if–
p
->
iReg
>0 &&Ö->
iTabÀ
==iTabÀ &&Ö->
iCﬁumn
==iColumn ){

2217 
p
->
Ãu
 = 
pP¨£
->
iCacheC¡
++;

2218 
	`sqlôe4Ex¥CachePöRegi°î
(
pP¨£
, 
p
->
iReg
);

2219  
p
->
iReg
;

2222 
	`as£π
–
v
!=0 );

2223 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pTab
, 
iTabÀ
, 
iCﬁumn
, 
iReg
);

2224 
	`sqlôe4Ex¥CacheSt‹e
(
pP¨£
, 
iTabÀ
, 
iCﬁumn
, 
iReg
);

2225  
iReg
;

2226 
	}
}

2231 
	$sqlôe4Ex¥CacheCÀ¨
(
P¨£
 *
pP¨£
){

2232 
i
;

2233 
P¨£YCﬁCache
 *
p
;

2235 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2236 if–
p
->
iReg
 ){

2237 
	`ˇcheE¡ryCÀ¨
(
pP¨£
, 
p
);

2238 
p
->
iReg
 = 0;

2241 
	}
}

2247 
	$sqlôe4Ex¥CacheAfföôyCh™ge
(
P¨£
 *
pP¨£
, 
iSèπ
, 
iCou¡
){

2248 
	`sqlôe4Ex¥CacheRemove
(
pP¨£
, 
iSèπ
, 
iCou¡
);

2249 
	}
}

2255 
	$sqlôe4Ex¥CodeMove
(
P¨£
 *
pP¨£
, 
iFrom
, 
iTo
, 
nReg
){

2256 
i
;

2257 
P¨£YCﬁCache
 *
p
;

2258 if–
	`NEVER
(
iFrom
==
iTo
) ) ;

2259 
	`sqlôe4VdbeAddOp3
(
pP¨£
->
pVdbe
, 
OP_Move
, 
iFrom
, 
iTo
, 
nReg
);

2260 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2261 
x
 = 
p
->
iReg
;

2262 if–
x
>=
iFrom
 && x<iFrom+
nReg
 ){

2263 
p
->
iReg
 +
iTo
-
iFrom
;

2266 
	}
}

2272 
	$sqlôe4Ex¥CodeC›y
(
P¨£
 *
pP¨£
, 
iFrom
, 
iTo
, 
nReg
){

2273 
i
;

2274 if–
	`NEVER
(
iFrom
==
iTo
) ) ;

2275 
i
=0; i<
nReg
; i++){

2276 
	`sqlôe4VdbeAddOp2
(
pP¨£
->
pVdbe
, 
OP_C›y
, 
iFrom
+
i
, 
iTo
+i);

2278 
	}
}

2280 #i‡
deföed
(
SQLITE4_DEBUG
Ë|| deföed(
SQLITE4_COVERAGE_TEST
)

2288 
	$u£dAsCﬁumnCache
(
P¨£
 *
pP¨£
, 
iFrom
, 
iTo
){

2289 
i
;

2290 
P¨£YCﬁCache
 *
p
;

2291 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

2292 
r
 = 
p
->
iReg
;

2293 if–
r
>=
iFrom
 &&Ñ<=
iTo
 )  1;

2296 
	}
}

2310 
	$sqlôe4Ex¥CodeT¨gë
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
èrgë
){

2311 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2312 
›
;

2313 
öReg
 = 
èrgë
;

2314 
ªgFªe1
 = 0;

2315 
ªgFªe2
 = 0;

2316 
r1
, 
r2
, 
r3
, 
r4
;

2317 
sqlôe4
 *
db
 = 
pP¨£
->db;

2319 
	`as£π
–
èrgë
>0 &&Å¨gë<=
pP¨£
->
nMem
 );

2320 if–
v
==0 ){

2321 
	`as£π
–
pP¨£
->
db
->
mÆlocFaûed
 );

2325 if–
pEx¥
==0 ){

2326 
›
 = 
TK_NULL
;

2328 
›
 = 
pEx¥
->op;

2330  
›
 ){

2331 
TK_AGG_COLUMN
: {

2332 
AggInfo
 *
pAggInfo
 = 
pEx¥
->pAggInfo;

2333 
AggInfoCﬁ
 *
pCﬁ
 = &
pAggInfo
->
aCﬁ
[
pEx¥
->
iAgg
];

2334 if–!
pAggInfo
->
dúe˘Mode
 ){

2335 
	`as£π
–
pCﬁ
->
iMem
>0 );

2336 
öReg
 = 
pCﬁ
->
iMem
;

2338 }if–
pAggInfo
->
u£S‹tögIdx
 ){

2339 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
pAggInfo
->
s‹tögIdx
,

2340 
pEx¥
->
iAgg
, 
èrgë
);

2345 
TK_COLUMN
: {

2346 if–
pEx¥
->
iTabÀ
<0 ){

2348 
	`as£π
–
pP¨£
->
ckBa£
>0 );

2349 
öReg
 = 
pEx¥
->
iCﬁumn
 + 
pP¨£
->
ckBa£
;

2351 
öReg
 = 
	`sqlôe4Ex¥CodeGëCﬁumn
(
pP¨£
, 
pEx¥
->
pTab
,

2352 
pEx¥
->
iCﬁumn
,ÖEx¥->
iTabÀ
, 
èrgë
);

2356 
TK_INTEGER
: {

2357 
	`codeI¡egî
(
pP¨£
, 
pEx¥
, 0, 
èrgë
);

2360 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


2361 
TK_FLOAT
: {

2362 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2363 
	`codeRól
(
v
, 
pEx¥
->
u
.
zTokí
, 0, 
èrgë
);

2367 
TK_STRING
: {

2368 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2369 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
èrgë
, 0, 
pEx¥
->
u
.
zTokí
, 0);

2372 
TK_NULL
: {

2373 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
èrgë
);

2376 #i‚de‡
SQLITE4_OMIT_BLOB_LITERAL


2377 
TK_BLOB
: {

2378 
n
;

2379 c⁄° *
z
;

2380 *
zBlob
;

2381 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2382 
	`as£π
–
pEx¥
->
u
.
zTokí
[0]=='x' ||ÖExpr->u.zToken[0]=='X' );

2383 
	`as£π
–
pEx¥
->
u
.
zTokí
[1]=='\'' );

2384 
z
 = &
pEx¥
->
u
.
zTokí
[2];

2385 
n
 = 
	`sqlôe4SåÀn30
(
z
) - 1;

2386 
	`as£π
–
z
[
n
]=='\'' );

2387 
zBlob
 = 
	`sqlôe4HexToBlob
(
	`sqlôe4VdbeDb
(
v
), 
z
, 
n
);

2388 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Blob
, 
n
/2, 
èrgë
, 0, 
zBlob
, 
P4_DYNAMIC
);

2392 
TK_VARIABLE
: {

2393 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2394 
	`as£π
–
pEx¥
->
u
.
zTokí
!=0 );

2395 
	`as£π
–
pEx¥
->
u
.
zTokí
[0]!=0 );

2396 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_V¨übÀ
, 
pEx¥
->
iCﬁumn
, 
èrgë
);

2397 if–
pEx¥
->
u
.
zTokí
[1]!=0 ){

2398 
	`as£π
–
pEx¥
->
u
.
zTokí
[0]=='?'

2399 || 
	`°rcmp
(
pEx¥
->
u
.
zTokí
, 
pP¨£
->
azV¨
[pEx¥->
iCﬁumn
-1])==0 );

2400 
	`sqlôe4VdbeCh™geP4
(
v
, -1, 
pP¨£
->
azV¨
[
pEx¥
->
iCﬁumn
-1], 
P4_STATIC
);

2404 
TK_REGISTER
: {

2405 
öReg
 = 
pEx¥
->
iTabÀ
;

2408 
TK_AS
: {

2409 
öReg
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
->
pLe·
, 
èrgë
);

2412 #i‚de‡
SQLITE4_OMIT_CAST


2413 
TK_CAST
: {

2415 
aff
, 
to_›
;

2416 
öReg
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
->
pLe·
, 
èrgë
);

2417 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2418 
aff
 = 
	`sqlôe4AfföôyTy≥
(
pEx¥
->
u
.
zTokí
);

2419 
to_›
 = 
aff
 - 
SQLITE4_AFF_TEXT
 + 
OP_ToText
;

2420 
	`as£π
–
to_›
==
OP_ToText
 || 
aff
!=
SQLITE4_AFF_TEXT
 );

2421 
	`as£π
–
to_›
==
OP_ToBlob
 || 
aff
!=
SQLITE4_AFF_NONE
 );

2422 
	`as£π
–
to_›
==
OP_ToNumîic
 || 
aff
!=
SQLITE4_AFF_NUMERIC
 );

2423 
	`as£π
–
to_›
==
OP_ToI¡
 || 
aff
!=
SQLITE4_AFF_INTEGER
 );

2424 
	`as£π
–
to_›
==
OP_ToRól
 || 
aff
!=
SQLITE4_AFF_REAL
 );

2425 
	`ã°ˇ£
–
to_›
==
OP_ToText
 );

2426 
	`ã°ˇ£
–
to_›
==
OP_ToBlob
 );

2427 
	`ã°ˇ£
–
to_›
==
OP_ToNumîic
 );

2428 
	`ã°ˇ£
–
to_›
==
OP_ToI¡
 );

2429 
	`ã°ˇ£
–
to_›
==
OP_ToRól
 );

2430 if–
öReg
!=
èrgë
 ){

2431 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
öReg
, 
èrgë
);

2432 
öReg
 = 
èrgë
;

2434 
	`sqlôe4VdbeAddOp1
(
v
, 
to_›
, 
öReg
);

2435 
	`ã°ˇ£
–
	`u£dAsCﬁumnCache
(
pP¨£
, 
öReg
, inReg) );

2436 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
öReg
, 1);

2440 
TK_LT
:

2441 
TK_LE
:

2442 
TK_GT
:

2443 
TK_GE
:

2444 
TK_NE
:

2445 
TK_EQ
: {

2446 
	`as£π
–
TK_LT
==
OP_Lt
 );

2447 
	`as£π
–
TK_LE
==
OP_Le
 );

2448 
	`as£π
–
TK_GT
==
OP_Gt
 );

2449 
	`as£π
–
TK_GE
==
OP_Ge
 );

2450 
	`as£π
–
TK_EQ
==
OP_Eq
 );

2451 
	`as£π
–
TK_NE
==
OP_Ne
 );

2452 
	`ã°ˇ£
–
›
==
TK_LT
 );

2453 
	`ã°ˇ£
–
›
==
TK_LE
 );

2454 
	`ã°ˇ£
–
›
==
TK_GT
 );

2455 
	`ã°ˇ£
–
›
==
TK_GE
 );

2456 
	`ã°ˇ£
–
›
==
TK_EQ
 );

2457 
	`ã°ˇ£
–
›
==
TK_NE
 );

2458 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

2459 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

2460 
	`codeCom∑ª
(
pP¨£
, 
pEx¥
->
pLe·
,ÖEx¥->
pRight
, 
›
,

2461 
r1
, 
r2
, 
öReg
, 
SQLITE4_STOREP2
);

2462 
	`ã°ˇ£
–
ªgFªe1
==0 );

2463 
	`ã°ˇ£
–
ªgFªe2
==0 );

2466 
TK_IS
:

2467 
TK_ISNOT
: {

2468 
	`ã°ˇ£
–
›
==
TK_IS
 );

2469 
	`ã°ˇ£
–
›
==
TK_ISNOT
 );

2470 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

2471 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

2472 
›
 = (›==
TK_IS
Ë? 
TK_EQ
 : 
TK_NE
;

2473 
	`codeCom∑ª
(
pP¨£
, 
pEx¥
->
pLe·
,ÖEx¥->
pRight
, 
›
,

2474 
r1
, 
r2
, 
öReg
, 
SQLITE4_STOREP2
 | 
SQLITE4_NULLEQ
);

2475 
	`ã°ˇ£
–
ªgFªe1
==0 );

2476 
	`ã°ˇ£
–
ªgFªe2
==0 );

2479 
TK_AND
:

2480 
TK_OR
:

2481 
TK_PLUS
:

2482 
TK_STAR
:

2483 
TK_MINUS
:

2484 
TK_REM
:

2485 
TK_BITAND
:

2486 
TK_BITOR
:

2487 
TK_SLASH
:

2488 
TK_LSHIFT
:

2489 
TK_RSHIFT
:

2490 
TK_CONCAT
: {

2491 
	`as£π
–
TK_AND
==
OP_And
 );

2492 
	`as£π
–
TK_OR
==
OP_Or
 );

2493 
	`as£π
–
TK_PLUS
==
OP_Add
 );

2494 
	`as£π
–
TK_MINUS
==
OP_Subåa˘
 );

2495 
	`as£π
–
TK_REM
==
OP_Remaödî
 );

2496 
	`as£π
–
TK_BITAND
==
OP_BôAnd
 );

2497 
	`as£π
–
TK_BITOR
==
OP_BôOr
 );

2498 
	`as£π
–
TK_SLASH
==
OP_Divide
 );

2499 
	`as£π
–
TK_LSHIFT
==
OP_Shi·Le·
 );

2500 
	`as£π
–
TK_RSHIFT
==
OP_Shi·Right
 );

2501 
	`as£π
–
TK_CONCAT
==
OP_C⁄ˇt
 );

2502 
	`ã°ˇ£
–
›
==
TK_AND
 );

2503 
	`ã°ˇ£
–
›
==
TK_OR
 );

2504 
	`ã°ˇ£
–
›
==
TK_PLUS
 );

2505 
	`ã°ˇ£
–
›
==
TK_MINUS
 );

2506 
	`ã°ˇ£
–
›
==
TK_REM
 );

2507 
	`ã°ˇ£
–
›
==
TK_BITAND
 );

2508 
	`ã°ˇ£
–
›
==
TK_BITOR
 );

2509 
	`ã°ˇ£
–
›
==
TK_SLASH
 );

2510 
	`ã°ˇ£
–
›
==
TK_LSHIFT
 );

2511 
	`ã°ˇ£
–
›
==
TK_RSHIFT
 );

2512 
	`ã°ˇ£
–
›
==
TK_CONCAT
 );

2513 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

2514 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

2515 
	`sqlôe4VdbeAddOp3
(
v
, 
›
, 
r2
, 
r1
, 
èrgë
);

2516 
	`ã°ˇ£
–
ªgFªe1
==0 );

2517 
	`ã°ˇ£
–
ªgFªe2
==0 );

2520 
TK_UMINUS
: {

2521 
Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

2522 
	`as£π
–
pLe·
 );

2523 if–
pLe·
->
›
==
TK_INTEGER
 ){

2524 
	`codeI¡egî
(
pP¨£
, 
pLe·
, 1, 
èrgë
);

2525 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


2526 }if–
pLe·
->
›
==
TK_FLOAT
 ){

2527 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2528 
	`codeRól
(
v
, 
pLe·
->
u
.
zTokí
, 1, 
èrgë
);

2531 
ªgFªe1
 = 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

2532 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
r1
);

2533 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe2
);

2534 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Subåa˘
, 
r2
, 
r1
, 
èrgë
);

2535 
	`ã°ˇ£
–
ªgFªe2
==0 );

2537 
öReg
 = 
èrgë
;

2540 
TK_BITNOT
:

2541 
TK_NOT
: {

2542 
	`as£π
–
TK_BITNOT
==
OP_BôNŸ
 );

2543 
	`as£π
–
TK_NOT
==
OP_NŸ
 );

2544 
	`ã°ˇ£
–
›
==
TK_BITNOT
 );

2545 
	`ã°ˇ£
–
›
==
TK_NOT
 );

2546 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

2547 
	`ã°ˇ£
–
ªgFªe1
==0 );

2548 
öReg
 = 
èrgë
;

2549 
	`sqlôe4VdbeAddOp2
(
v
, 
›
, 
r1
, 
öReg
);

2552 
TK_ISNULL
:

2553 
TK_NOTNULL
: {

2554 
addr
;

2555 
	`as£π
–
TK_ISNULL
==
OP_IsNuŒ
 );

2556 
	`as£π
–
TK_NOTNULL
==
OP_NŸNuŒ
 );

2557 
	`ã°ˇ£
–
›
==
TK_ISNULL
 );

2558 
	`ã°ˇ£
–
›
==
TK_NOTNULL
 );

2559 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
èrgë
);

2560 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

2561 
	`ã°ˇ£
–
ªgFªe1
==0 );

2562 
addr
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
›
, 
r1
);

2563 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
èrgë
, -1);

2564 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr
);

2567 
TK_AGG_FUNCTION
: {

2568 
AggInfo
 *
pInfo
 = 
pEx¥
->
pAggInfo
;

2569 if–
pInfo
==0 ){

2570 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2571 
	`sqlôe4Eº‹Msg
(
pP¨£
, "misu£ o‡aggªg©e: %s()", 
pEx¥
->
u
.
zTokí
);

2573 
öReg
 = 
pInfo
->
aFunc
[
pEx¥
->
iAgg
].
iMem
;

2577 
TK_CONST_FUNC
:

2578 
TK_FUNCTION
: {

2579 
Ex¥Li°
 *
pF¨g
;

2580 
nF¨g
;

2581 
FuncDef
 *
pDef
;

2582 
nId
;

2583 c⁄° *
zId
;

2584 
c⁄°Mask
 = 0;

2585 
i
;

2586 
CﬁlSeq
 *
pCﬁl
 = 0;

2588 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

2589 
	`ã°ˇ£
–
›
==
TK_CONST_FUNC
 );

2590 
	`ã°ˇ£
–
›
==
TK_FUNCTION
 );

2591 if–
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_TokíO∆y
) ){

2592 
pF¨g
 = 0;

2594 
pF¨g
 = 
pEx¥
->
x
.
pLi°
;

2596 
nF¨g
 = 
pF¨g
 ?ÖF¨g->
nEx¥
 : 0;

2597 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2598 
zId
 = 
pEx¥
->
u
.
zTokí
;

2599 
nId
 = 
	`sqlôe4SåÀn30
(
zId
);

2600 
pDef
 = 
	`sqlôe4FödFun˘i⁄
(
db
, 
zId
, 
nId
, 
nF¨g
, 0);

2601 if–
pDef
==0 ){

2602 
	`sqlôe4Eº‹Msg
(
pP¨£
, "unknow¿fun˘i⁄: %.*s()", 
nId
, 
zId
);

2610 if–
pDef
->
Êags
 & 
SQLITE4_FUNC_COALESCE
 ){

2611 
ídCﬂÀs˚
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2612 
	`as£π
–
nF¨g
>=2 );

2613 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pF¨g
->
a
[0].
pEx¥
, 
èrgë
);

2614 
i
=1; i<
nF¨g
; i++){

2615 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NŸNuŒ
, 
èrgë
, 
ídCﬂÀs˚
);

2616 
	`sqlôe4Ex¥CacheRemove
(
pP¨£
, 
èrgë
, 1);

2617 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

2618 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pF¨g
->
a
[
i
].
pEx¥
, 
èrgë
);

2619 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

2621 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
ídCﬂÀs˚
);

2626 if–
pF¨g
 ){

2627 
r1
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nF¨g
);

2628 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

2629 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pF¨g
, 
r1
, 1);

2630 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

2632 
r1
 = 0;

2634 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


2647 if–
nF¨g
>=2 && (
pEx¥
->
Êags
 & 
EP_InfixFunc
) ){

2648 
pDef
 = 
	`sqlôe4VèbOvîlﬂdFun˘i⁄
(
db
,ÖDef, 
nF¨g
, 
pF¨g
->
a
[1].
pEx¥
);

2649 }if–
nF¨g
>0 ){

2650 
pDef
 = 
	`sqlôe4VèbOvîlﬂdFun˘i⁄
(
db
,ÖDef, 
nF¨g
, 
pF¨g
->
a
[0].
pEx¥
);

2653 
i
=0; i<
nF¨g
; i++){

2654 if–
i
<32 && 
	`sqlôe4Ex¥IsC⁄°™t
(
pF¨g
->
a
[i].
pEx¥
) ){

2655 
c⁄°Mask
 |(1<<
i
);

2657 if–(
pDef
->
Êags
 & 
SQLITE4_FUNC_NEEDCOLL
)!=0 && !
pCﬁl
 ){

2658 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pF¨g
->
a
[
i
].
pEx¥
);

2661 if–
pDef
->
Êags
 & 
SQLITE4_FUNC_NEEDCOLL
 ){

2662 if–!
pCﬁl
 )ÖCﬁ»
db
->
pDÊtCﬁl
;

2663 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_CﬁlSeq
, 0, 0, 0, (*)
pCﬁl
, 
P4_COLLSEQ
);

2665 if–
pDef
->
bM©chöfo
 ){

2666 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Mifun˘i⁄
, 
pF¨g
->
a
[0].
pEx¥
->
iTabÀ
);

2668 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Fun˘i⁄
, 
c⁄°Mask
, 
r1
, 
èrgë
,

2669 (*)
pDef
, 
P4_FUNCDEF
);

2670 
	`sqlôe4VdbeCh™geP5
(
v
, (
u8
)
nF¨g
);

2671 if–
nF¨g
 ){

2672 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
r1
, 
nF¨g
);

2676 #i‚de‡
SQLITE4_OMIT_SUBQUERY


2677 
TK_EXISTS
:

2678 
TK_SELECT
: {

2679 
	`ã°ˇ£
–
›
==
TK_EXISTS
 );

2680 
	`ã°ˇ£
–
›
==
TK_SELECT
 );

2681 
öReg
 = 
	`sqlôe4CodeSub£À˘
(
pP¨£
, 
pEx¥
, 0);

2684 
TK_IN
: {

2685 
de°IfFÆ£
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2686 
de°IfNuŒ
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2687 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
èrgë
);

2688 
	`sqlôe4Ex¥CodeIN
(
pP¨£
, 
pEx¥
, 
de°IfFÆ£
, 
de°IfNuŒ
);

2689 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
èrgë
);

2690 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
de°IfFÆ£
);

2691 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
èrgë
, 0);

2692 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
de°IfNuŒ
);

2709 
TK_BETWEEN
: {

2710 
Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

2711 
Ex¥Li°Iãm
 *
pLIãm
 = 
pEx¥
->
x
.
pLi°
->
a
;

2712 
Ex¥
 *
pRight
 = 
pLIãm
->
pEx¥
;

2714 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pLe·
, &
ªgFªe1
);

2715 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pRight
, &
ªgFªe2
);

2716 
	`ã°ˇ£
–
ªgFªe1
==0 );

2717 
	`ã°ˇ£
–
ªgFªe2
==0 );

2718 
r3
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

2719 
r4
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

2720 
	`codeCom∑ª
(
pP¨£
, 
pLe·
, 
pRight
, 
OP_Ge
,

2721 
r1
, 
r2
, 
r3
, 
SQLITE4_STOREP2
);

2722 
pLIãm
++;

2723 
pRight
 = 
pLIãm
->
pEx¥
;

2724 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe2
);

2725 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pRight
, &
ªgFªe2
);

2726 
	`ã°ˇ£
–
ªgFªe2
==0 );

2727 
	`codeCom∑ª
(
pP¨£
, 
pLe·
, 
pRight
, 
OP_Le
, 
r1
, 
r2
, 
r4
, 
SQLITE4_STOREP2
);

2728 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_And
, 
r3
, 
r4
, 
èrgë
);

2729 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r3
);

2730 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r4
);

2733 
TK_UPLUS
: {

2734 
öReg
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
->
pLe·
, 
èrgë
);

2738 
TK_TRIGGER
: {

2769 
TabÀ
 *
pTab
 = 
pEx¥
->pTab;

2770 
p1
 = 
pEx¥
->
iTabÀ
 * (
pTab
->
nCﬁ
+1Ë+ 1 +ÖEx¥->
iCﬁumn
;

2772 
	`as£π
–
pEx¥
->
iTabÀ
==0 ||ÖExpr->iTable==1 );

2773 
	`as£π
–
pEx¥
->
iCﬁumn
>=-1 &&ÖEx¥->iCﬁumn<
pTab
->
nCﬁ
 );

2774 
	`as£π
–
p1
>=0 &&Ö1<(
pTab
->
nCﬁ
*2+2) );

2776 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_P¨am
, 
p1
, 
èrgë
);

2777 
	`VdbeCommít
((
v
, "%s.%s -> $%d",

2778 (
pEx¥
->
iTabÀ
 ? "new" : "old"),

2779 (
pEx¥
->
iCﬁumn
<0 ? "rowid" :ÖEx¥->
pTab
->
aCﬁ
[pEx¥->iCﬁumn].
zName
),

2780 
èrgë


2783 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


2786 if–
pEx¥
->
iCﬁumn
>=0

2787 && 
pTab
->
aCﬁ
[
pEx¥
->
iCﬁumn
].
afföôy
==
SQLITE4_AFF_REAL


2789 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_RólAfföôy
, 
èrgë
);

2795 
TK_MATCH
: {

2796 
	`sqlôe4Eº‹Msg
(
pP¨£
, "no indexÅoÖrocess MATCH operator");

2822 : 
	`as£π
–
›
==
TK_CASE
 ); {

2823 
ídLabñ
;

2824 
√xtCa£
;

2825 
nEx¥
;

2826 
i
;

2827 
Ex¥Li°
 *
pELi°
;

2828 
Ex¥Li°Iãm
 *
aLi°ñem
;

2829 
Ex¥
 
›Com∑ª
;

2830 
Ex¥
 
ˇcheX
;

2831 
Ex¥
 *
pX
;

2832 
Ex¥
 *
pTe°
 = 0;

2833 
	`VVA_ONLY
–
iCacheLevñ
 = 
pP¨£
->iCacheLevel; )

2835 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
Ë&&ÖEx¥->
x
.
pLi°
 );

2836 
	`as£π
((
pEx¥
->
x
.
pLi°
->
nEx¥
 % 2) == 0);

2837 
	`as£π
(
pEx¥
->
x
.
pLi°
->
nEx¥
 > 0);

2838 
pELi°
 = 
pEx¥
->
x
.
pLi°
;

2839 
aLi°ñem
 = 
pELi°
->
a
;

2840 
nEx¥
 = 
pELi°
->nExpr;

2841 
ídLabñ
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2842 if–(
pX
 = 
pEx¥
->
pLe·
)!=0 ){

2843 
ˇcheX
 = *
pX
;

2844 
	`ã°ˇ£
–
pX
->
›
==
TK_COLUMN
 );

2845 
	`ã°ˇ£
–
pX
->
›
==
TK_REGISTER
 );

2846 
ˇcheX
.
iTabÀ
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pX
, &
ªgFªe1
);

2847 
	`ã°ˇ£
–
ªgFªe1
==0 );

2848 
ˇcheX
.
›
 = 
TK_REGISTER
;

2849 
›Com∑ª
.
›
 = 
TK_EQ
;

2850 
›Com∑ª
.
pLe·
 = &
ˇcheX
;

2851 
pTe°
 = &
›Com∑ª
;

2856 
ªgFªe1
 = 0;

2858 
i
=0; i<
nEx¥
; i=i+2){

2859 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

2860 if–
pX
 ){

2861 
	`as£π
–
pTe°
!=0 );

2862 
›Com∑ª
.
pRight
 = 
aLi°ñem
[
i
].
pEx¥
;

2864 
pTe°
 = 
aLi°ñem
[
i
].
pEx¥
;

2866 
√xtCa£
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2867 
	`ã°ˇ£
–
pTe°
->
›
==
TK_COLUMN
 );

2868 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pTe°
, 
√xtCa£
, 
SQLITE4_JUMPIFNULL
);

2869 
	`ã°ˇ£
–
aLi°ñem
[
i
+1].
pEx¥
->
›
==
TK_COLUMN
 );

2870 
	`ã°ˇ£
–
aLi°ñem
[
i
+1].
pEx¥
->
›
==
TK_REGISTER
 );

2871 
	`sqlôe4Ex¥Code
(
pP¨£
, 
aLi°ñem
[
i
+1].
pEx¥
, 
èrgë
);

2872 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
ídLabñ
);

2873 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

2874 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
√xtCa£
);

2876 if–
pEx¥
->
pRight
 ){

2877 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

2878 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pEx¥
->
pRight
, 
èrgë
);

2879 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

2881 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
èrgë
);

2883 
	`as£π
–
db
->
mÆlocFaûed
 || 
pP¨£
->
nEº
>0

2884 || 
pP¨£
->
iCacheLevñ
==iCacheLevel );

2885 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
ídLabñ
);

2888 #i‚de‡
SQLITE4_OMIT_TRIGGER


2889 
TK_RAISE
: {

2890 
	`as£π
–
pEx¥
->
afföôy
==
OE_Rﬁlback


2891 || 
pEx¥
->
afföôy
==
OE_Ab‹t


2892 || 
pEx¥
->
afföôy
==
OE_Faû


2893 || 
pEx¥
->
afföôy
==
OE_Ign‹e


2895 if–!
pP¨£
->
pTriggîTab
 ){

2896 
	`sqlôe4Eº‹Msg
(
pP¨£
,

2900 if–
pEx¥
->
afföôy
==
OE_Ab‹t
 ){

2901 
	`sqlôe4MayAb‹t
(
pP¨£
);

2903 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

2904 if–
pEx¥
->
afföôy
==
OE_Ign‹e
 ){

2905 
	`sqlôe4VdbeAddOp4
(

2906 
v
, 
OP_HÆt
, 
SQLITE4_OK
, 
OE_Ign‹e
, 0, 
pEx¥
->
u
.
zTokí
,0);

2908 
	`sqlôe4HÆtC⁄°øöt
(
pP¨£
, 
pEx¥
->
afföôy
,ÖEx¥->
u
.
zTokí
, 0);

2915 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe1
);

2916 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe2
);

2917  
öReg
;

2918 
	}
}

2929 
	$sqlôe4Ex¥CodeTemp
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, *
pReg
){

2930 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

2931 
r2
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
, 
r1
);

2932 if–
r2
==
r1
 ){

2933 *
pReg
 = 
r1
;

2935 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

2936 *
pReg
 = 0;

2938  
r2
;

2939 
	}
}

2946 
	$sqlôe4Ex¥Code
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
èrgë
){

2947 
öReg
;

2949 
	`as£π
–
èrgë
>0 &&Å¨gë<=
pP¨£
->
nMem
 );

2950 if–
pEx¥
 &&ÖEx¥->
›
==
TK_REGISTER
 ){

2951 
	`sqlôe4VdbeAddOp2
(
pP¨£
->
pVdbe
, 
OP_C›y
, 
pEx¥
->
iTabÀ
, 
èrgë
);

2953 
öReg
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
, 
èrgë
);

2954 
	`as£π
–
pP¨£
->
pVdbe
 ||ÖP¨£->
db
->
mÆlocFaûed
 );

2955 if–
öReg
!=
èrgë
 && 
pP¨£
->
pVdbe
 ){

2956 
	`sqlôe4VdbeAddOp2
(
pP¨£
->
pVdbe
, 
OP_SC›y
, 
öReg
, 
èrgë
);

2959  
èrgë
;

2960 
	}
}

2974 
	$sqlôe4Ex¥CodeAndCache
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
èrgë
){

2975 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2976 
öReg
;

2977 
öReg
 = 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pEx¥
, 
èrgë
);

2978 
	`as£π
–
èrgë
>0 );

2979 if–
pEx¥
->
›
!=
TK_REGISTER
 ){

2980 
iMem
;

2981 
iMem
 = ++
pP¨£
->
nMem
;

2982 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
öReg
, 
iMem
);

2983 
pEx¥
->
iTabÀ
 = 
iMem
;

2984 
pEx¥
->
›2
 =ÖEx¥->
›
;

2985 
pEx¥
->
›
 = 
TK_REGISTER
;

2987  
öReg
;

2988 
	}
}

2990 #i‡
deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

2994 
	$sqlôe4Ex∂aöEx¥
(
Vdbe
 *
pOut
, 
Ex¥
 *
pEx¥
){

2995 
›
;

2996 c⁄° *
zBöOp
 = 0;

2997 c⁄° *
zUniOp
 = 0;

2998 if–
pEx¥
==0 ){

2999 
›
 = 
TK_NULL
;

3001 
›
 = 
pEx¥
->op;

3003  
›
 ){

3004 
TK_AGG_COLUMN
: {

3005 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "AGG{%d:%d}",

3006 
pEx¥
->
iTabÀ
,ÖEx¥->
iCﬁumn
);

3009 
TK_COLUMN
: {

3010 if–
pEx¥
->
iTabÀ
<0 ){

3012 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "COLUMN(%d)", 
pEx¥
->
iCﬁumn
);

3014 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "{%d:%d}",

3015 
pEx¥
->
iTabÀ
,ÖEx¥->
iCﬁumn
);

3019 
TK_INTEGER
: {

3020 if–
pEx¥
->
Êags
 & 
EP_I¡VÆue
 ){

3021 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "%d", 
pEx¥
->
u
.
iVÆue
);

3023 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "%s", 
pEx¥
->
u
.
zTokí
);

3027 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


3028 
TK_FLOAT
: {

3029 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"%s", 
pEx¥
->
u
.
zTokí
);

3033 
TK_STRING
: {

3034 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"%Q", 
pEx¥
->
u
.
zTokí
);

3037 
TK_NULL
: {

3038 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"NULL");

3041 #i‚de‡
SQLITE4_OMIT_BLOB_LITERAL


3042 
TK_BLOB
: {

3043 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"%s", 
pEx¥
->
u
.
zTokí
);

3047 
TK_VARIABLE
: {

3048 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"VARIABLE(%s,%d)",

3049 
pEx¥
->
u
.
zTokí
,ÖEx¥->
iCﬁumn
);

3052 
TK_REGISTER
: {

3053 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"REGISTER(%d)", 
pEx¥
->
iTabÀ
);

3056 
TK_AS
: {

3057 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pLe·
);

3060 #i‚de‡
SQLITE4_OMIT_CAST


3061 
TK_CAST
: {

3063 c⁄° *
zAff
 = "unk";

3064  
	`sqlôe4AfföôyTy≥
(
pEx¥
->
u
.
zTokí
) ){

3065 
SQLITE4_AFF_TEXT
: 
zAff
 = "TEXT"; ;

3066 
SQLITE4_AFF_NONE
: 
zAff
 = "NONE"; ;

3067 
SQLITE4_AFF_NUMERIC
: 
zAff
 = "NUMERIC"; ;

3068 
SQLITE4_AFF_INTEGER
: 
zAff
 = "INTEGER"; ;

3069 
SQLITE4_AFF_REAL
: 
zAff
 = "REAL"; ;

3071 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "CAST-%s(", 
zAff
);

3072 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pLe·
);

3073 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ")");

3077 
TK_LT
: 
zBöOp
 = "LT"; ;

3078 
TK_LE
: 
zBöOp
 = "LE"; ;

3079 
TK_GT
: 
zBöOp
 = "GT"; ;

3080 
TK_GE
: 
zBöOp
 = "GE"; ;

3081 
TK_NE
: 
zBöOp
 = "NE"; ;

3082 
TK_EQ
: 
zBöOp
 = "EQ"; ;

3083 
TK_IS
: 
zBöOp
 = "IS"; ;

3084 
TK_ISNOT
: 
zBöOp
 = "ISNOT"; ;

3085 
TK_AND
: 
zBöOp
 = "AND"; ;

3086 
TK_OR
: 
zBöOp
 = "OR"; ;

3087 
TK_PLUS
: 
zBöOp
 = "ADD"; ;

3088 
TK_STAR
: 
zBöOp
 = "MUL"; ;

3089 
TK_MINUS
: 
zBöOp
 = "SUB"; ;

3090 
TK_REM
: 
zBöOp
 = "REM"; ;

3091 
TK_BITAND
: 
zBöOp
 = "BITAND"; ;

3092 
TK_BITOR
: 
zBöOp
 = "BITOR"; ;

3093 
TK_SLASH
: 
zBöOp
 = "DIV"; ;

3094 
TK_LSHIFT
: 
zBöOp
 = "LSHIFT"; ;

3095 
TK_RSHIFT
: 
zBöOp
 = "RSHIFT"; ;

3096 
TK_CONCAT
: 
zBöOp
 = "CONCAT"; ;

3098 
TK_UMINUS
: 
zUniOp
 = "UMINUS"; ;

3099 
TK_UPLUS
: 
zUniOp
 = "UPLUS"; ;

3100 
TK_BITNOT
: 
zUniOp
 = "BITNOT"; ;

3101 
TK_NOT
: 
zUniOp
 = "NOT"; ;

3102 
TK_ISNULL
: 
zUniOp
 = "ISNULL"; ;

3103 
TK_NOTNULL
: 
zUniOp
 = "NOTNULL"; ;

3105 
TK_AGG_FUNCTION
:

3106 
TK_CONST_FUNC
:

3107 
TK_FUNCTION
: {

3108 
Ex¥Li°
 *
pF¨g
;

3109 if–
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_TokíO∆y
) ){

3110 
pF¨g
 = 0;

3112 
pF¨g
 = 
pEx¥
->
x
.
pLi°
;

3114 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "%sFUNCTION:%s(",

3115 
›
==
TK_AGG_FUNCTION
 ? "AGG_" : "",

3116 
pEx¥
->
u
.
zTokí
);

3117 if–
pF¨g
 ){

3118 
	`sqlôe4Ex∂aöEx¥Li°
(
pOut
, 
pF¨g
);

3120 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ")");

3123 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3124 
TK_EXISTS
: {

3125 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "EXISTS(");

3126 
	`sqlôe4Ex∂aöSñe˘
(
pOut
, 
pEx¥
->
x
.
pSñe˘
);

3127 
	`sqlôe4Ex∂aöPrötf
(
pOut
,")");

3130 
TK_SELECT
: {

3131 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "(");

3132 
	`sqlôe4Ex∂aöSñe˘
(
pOut
, 
pEx¥
->
x
.
pSñe˘
);

3133 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ")");

3136 
TK_IN
: {

3137 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "IN(");

3138 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pLe·
);

3139 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ",");

3140 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

3141 
	`sqlôe4Ex∂aöSñe˘
(
pOut
, 
pEx¥
->
x
.
pSñe˘
);

3143 
	`sqlôe4Ex∂aöEx¥Li°
(
pOut
, 
pEx¥
->
x
.
pLi°
);

3145 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ")");

3161 
TK_BETWEEN
: {

3162 
Ex¥
 *
pX
 = 
pEx¥
->
pLe·
;

3163 
Ex¥
 *
pY
 = 
pEx¥
->
x
.
pLi°
->
a
[0].pExpr;

3164 
Ex¥
 *
pZ
 = 
pEx¥
->
x
.
pLi°
->
a
[1].pExpr;

3165 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "BETWEEN(");

3166 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pX
);

3167 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ",");

3168 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pY
);

3169 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ",");

3170 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pZ
);

3171 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ")");

3174 
TK_TRIGGER
: {

3182 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "%s(%d)",

3183 
pEx¥
->
iTabÀ
 ? "NEW" : "OLD",ÖEx¥->
iCﬁumn
);

3186 
TK_CASE
: {

3187 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "CASE(");

3188 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pLe·
);

3189 
	`sqlôe4Ex∂aöPrötf
(
pOut
, ",");

3190 
	`sqlôe4Ex∂aöEx¥Li°
(
pOut
, 
pEx¥
->
x
.
pLi°
);

3193 #i‚de‡
SQLITE4_OMIT_TRIGGER


3194 
TK_RAISE
: {

3195 c⁄° *
zTy≥
 = "unk";

3196  
pEx¥
->
afföôy
 ){

3197 
OE_Rﬁlback
: 
zTy≥
 = "rollback"; ;

3198 
OE_Ab‹t
: 
zTy≥
 = "abort"; ;

3199 
OE_Faû
: 
zTy≥
 = "fail"; ;

3200 
OE_Ign‹e
: 
zTy≥
 = "ignore"; ;

3202 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "RAISE-%s(%s)", 
zTy≥
, 
pEx¥
->
u
.
zTokí
);

3207 if–
zBöOp
 ){

3208 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"%s(", 
zBöOp
);

3209 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pLe·
);

3210 
	`sqlôe4Ex∂aöPrötf
(
pOut
,",");

3211 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pRight
);

3212 
	`sqlôe4Ex∂aöPrötf
(
pOut
,")");

3213 }if–
zUniOp
 ){

3214 
	`sqlôe4Ex∂aöPrötf
(
pOut
,"%s(", 
zUniOp
);

3215 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pEx¥
->
pLe·
);

3216 
	`sqlôe4Ex∂aöPrötf
(
pOut
,")");

3218 
	}
}

3221 #i‡
deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

3225 
	$sqlôe4Ex∂aöEx¥Li°
(
Vdbe
 *
pOut
, 
Ex¥Li°
 *
pLi°
){

3226 
i
;

3227 if–
pLi°
==0 ||ÖLi°->
nEx¥
==0 ){

3228 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "(empty-list)");

3230 }if–
pLi°
->
nEx¥
==1 ){

3231 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pLi°
->
a
[0].
pEx¥
);

3233 
	`sqlôe4Ex∂aöPush
(
pOut
);

3234 
i
=0; i<
pLi°
->
nEx¥
; i++){

3235 
	`sqlôe4Ex∂aöPrötf
(
pOut
, "ôem[%d] = ", 
i
);

3236 
	`sqlôe4Ex∂aöPush
(
pOut
);

3237 
	`sqlôe4Ex∂aöEx¥
(
pOut
, 
pLi°
->
a
[
i
].
pEx¥
);

3238 
	`sqlôe4Ex∂aöP›
(
pOut
);

3239 if–
i
<
pLi°
->
nEx¥
-1 ){

3240 
	`sqlôe4Ex∂aöNL
(
pOut
);

3243 
	`sqlôe4Ex∂aöP›
(
pOut
);

3245 
	}
}

3265 
	$isAµr›rüãF‹Fa˘‹ög
(
Ex¥
 *
p
){

3266 if–!
	`sqlôe4Ex¥IsC⁄°™tNŸJoö
(
p
) ){

3269 if–
p
->
›
==
TK_MATCH
 ||Ö->›==
TK_TABLE
 )  0;

3270 if–(
p
->
Êags
 & 
EP_FixedDe°
)==0 ){

3273  
p
->
›
==
TK_UPLUS
 )Ö =Ö->
pLe·
;

3274  
p
->
›
 ){

3275 #i‚de‡
SQLITE4_OMIT_BLOB_LITERAL


3276 
TK_BLOB
:

3278 
TK_VARIABLE
:

3279 
TK_INTEGER
:

3280 
TK_FLOAT
:

3281 
TK_NULL
:

3282 
TK_STRING
: {

3283 
	`ã°ˇ£
–
p
->
›
==
TK_BLOB
 );

3284 
	`ã°ˇ£
–
p
->
›
==
TK_VARIABLE
 );

3285 
	`ã°ˇ£
–
p
->
›
==
TK_INTEGER
 );

3286 
	`ã°ˇ£
–
p
->
›
==
TK_FLOAT
 );

3287 
	`ã°ˇ£
–
p
->
›
==
TK_NULL
 );

3288 
	`ã°ˇ£
–
p
->
›
==
TK_STRING
 );

3295 
TK_UMINUS
: {

3296 if–
p
->
pLe·
->
›
==
TK_FLOAT
 ||Ö->pLe·->›==
TK_INTEGER
 ){

3306 
	}
}

3314 
	$evÆC⁄°Ex¥
(
WÆkî
 *
pWÆkî
, 
Ex¥
 *
pEx¥
){

3315 
P¨£
 *
pP¨£
 = 
pWÆkî
->pParse;

3316  
pEx¥
->
›
 ){

3317 
TK_IN
:

3318 
TK_REGISTER
: {

3319  
WRC_Pru√
;

3321 
TK_FUNCTION
:

3322 
TK_AGG_FUNCTION
:

3323 
TK_CONST_FUNC
: {

3328 
Ex¥Li°
 *
pLi°
 = 
pEx¥
->
x
.pList;

3329 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

3330 if–
pLi°
 ){

3331 
i
 = 
pLi°
->
nEx¥
;

3332 
Ex¥Li°Iãm
 *
pIãm
 = 
pLi°
->
a
;

3333 ; 
i
>0; i--, 
pIãm
++){

3334 if–
	`ALWAYS
(
pIãm
->
pEx¥
ËËpIãm->pEx¥->
Êags
 |
EP_FixedDe°
;

3340 if–
	`isAµr›rüãF‹Fa˘‹ög
(
pEx¥
) ){

3341 
r1
 = ++
pP¨£
->
nMem
;

3342 
r2
;

3343 
r2
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
, 
r1
);

3344 if–
	`NEVER
(
r1
!=
r2
ËË
	`sqlôe4Rñó£TempReg
(
pP¨£
,Ñ1);

3345 
pEx¥
->
›2
 =ÖEx¥->
›
;

3346 
pEx¥
->
›
 = 
TK_REGISTER
;

3347 
pEx¥
->
iTabÀ
 = 
r2
;

3348  
WRC_Pru√
;

3350  
WRC_C⁄töue
;

3351 
	}
}

3369 
	$sqlôe4Ex¥CodeC⁄°™ts
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
){

3370 
WÆkî
 
w
;

3371 if–
pP¨£
->
cookõGŸo
 ) ;

3372 if–(
pP¨£
->
db
->
Êags
 & 
SQLITE4_Fa˘‹OutC⁄°
)!=0 ) ;

3373 
w
.
xEx¥CÆlback
 = 
evÆC⁄°Ex¥
;

3374 
w
.
xSñe˘CÆlback
 = 0;

3375 
w
.
pP¨£
 =ÖParse;

3376 
	`sqlôe4WÆkEx¥
(&
w
, 
pEx¥
);

3377 
	}
}

3386 
	$sqlôe4Ex¥CodeEx¥Li°
(

3387 
P¨£
 *
pP¨£
,

3388 
Ex¥Li°
 *
pLi°
,

3389 
èrgë
,

3390 
doH¨dC›y


3392 
Ex¥Li°Iãm
 *
pIãm
;

3393 
i
, 
n
;

3394 
	`as£π
–
pLi°
!=0 );

3395 
	`as£π
–
èrgë
>0 );

3396 
	`as£π
–
pP¨£
->
pVdbe
!=0 );

3397 
n
 = 
pLi°
->
nEx¥
;

3398 
pIãm
=
pLi°
->
a
, 
i
=0; i<
n
; i++,ÖItem++){

3399 
Ex¥
 *
pEx¥
 = 
pIãm
->pExpr;

3400 
öReg
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pEx¥
, 
èrgë
+
i
);

3401 if–
öReg
!=
èrgë
+
i
 ){

3402 
	`sqlôe4VdbeAddOp2
(
pP¨£
->
pVdbe
, 
doH¨dC›y
 ? 
OP_C›y
 : 
OP_SC›y
,

3403 
öReg
, 
èrgë
+
i
);

3406  
n
;

3407 
	}
}

3421 
	$ex¥CodeBëwìn
(

3422 
P¨£
 *
pP¨£
,

3423 
Ex¥
 *
pEx¥
,

3424 
de°
,

3425 
jumpIfTrue
,

3426 
jumpIfNuŒ


3428 
Ex¥
 
ex¥And
;

3429 
Ex¥
 
compLe·
;

3430 
Ex¥
 
compRight
;

3431 
Ex¥
 
ex¥X
;

3432 
ªgFªe1
 = 0;

3434 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

3435 
ex¥X
 = *
pEx¥
->
pLe·
;

3436 
ex¥And
.
›
 = 
TK_AND
;

3437 
ex¥And
.
pLe·
 = &
compLe·
;

3438 
ex¥And
.
pRight
 = &
compRight
;

3439 
compLe·
.
›
 = 
TK_GE
;

3440 
compLe·
.
pLe·
 = &
ex¥X
;

3441 
compLe·
.
pRight
 = 
pEx¥
->
x
.
pLi°
->
a
[0].pExpr;

3442 
compRight
.
›
 = 
TK_LE
;

3443 
compRight
.
pLe·
 = &
ex¥X
;

3444 
compRight
.
pRight
 = 
pEx¥
->
x
.
pLi°
->
a
[1].pExpr;

3445 
ex¥X
.
iTabÀ
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, &ex¥X, &
ªgFªe1
);

3446 
ex¥X
.
›
 = 
TK_REGISTER
;

3447 if–
jumpIfTrue
 ){

3448 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, &
ex¥And
, 
de°
, 
jumpIfNuŒ
);

3450 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, &
ex¥And
, 
de°
, 
jumpIfNuŒ
);

3452 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe1
);

3455 
	`ã°ˇ£
–
jumpIfTrue
==0 && 
jumpIfNuŒ
==0 && 
ªgFªe1
==0 );

3456 
	`ã°ˇ£
–
jumpIfTrue
==0 && 
jumpIfNuŒ
==0 && 
ªgFªe1
!=0 );

3457 
	`ã°ˇ£
–
jumpIfTrue
==0 && 
jumpIfNuŒ
!=0 && 
ªgFªe1
==0 );

3458 
	`ã°ˇ£
–
jumpIfTrue
==0 && 
jumpIfNuŒ
!=0 && 
ªgFªe1
!=0 );

3459 
	`ã°ˇ£
–
jumpIfTrue
!=0 && 
jumpIfNuŒ
==0 && 
ªgFªe1
==0 );

3460 
	`ã°ˇ£
–
jumpIfTrue
!=0 && 
jumpIfNuŒ
==0 && 
ªgFªe1
!=0 );

3461 
	`ã°ˇ£
–
jumpIfTrue
!=0 && 
jumpIfNuŒ
!=0 && 
ªgFªe1
==0 );

3462 
	`ã°ˇ£
–
jumpIfTrue
!=0 && 
jumpIfNuŒ
!=0 && 
ªgFªe1
!=0 );

3463 
	}
}

3479 
	$sqlôe4Ex¥IfTrue
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
de°
, 
jumpIfNuŒ
){

3480 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3481 
›
 = 0;

3482 
ªgFªe1
 = 0;

3483 
ªgFªe2
 = 0;

3484 
r1
, 
r2
;

3486 
	`as£π
–
jumpIfNuŒ
==
SQLITE4_JUMPIFNULL
 || jumpIfNull==0 );

3487 if–
	`NEVER
(
v
==0) ) ;

3488 if–
	`NEVER
(
pEx¥
==0) ) ;

3489 
›
 = 
pEx¥
->op;

3490  
›
 ){

3491 
TK_AND
: {

3492 
d2
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3493 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3494 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

3495 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pEx¥
->
pLe·
, 
d2
,
jumpIfNuŒ
^
SQLITE4_JUMPIFNULL
);

3496 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, 
pEx¥
->
pRight
, 
de°
, 
jumpIfNuŒ
);

3497 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
d2
);

3498 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

3501 
TK_OR
: {

3502 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3503 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, 
pEx¥
->
pLe·
, 
de°
, 
jumpIfNuŒ
);

3504 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, 
pEx¥
->
pRight
, 
de°
, 
jumpIfNuŒ
);

3507 
TK_NOT
: {

3508 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3509 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pEx¥
->
pLe·
, 
de°
, 
jumpIfNuŒ
);

3512 
TK_LT
:

3513 
TK_LE
:

3514 
TK_GT
:

3515 
TK_GE
:

3516 
TK_NE
:

3517 
TK_EQ
: {

3518 
	`as£π
–
TK_LT
==
OP_Lt
 );

3519 
	`as£π
–
TK_LE
==
OP_Le
 );

3520 
	`as£π
–
TK_GT
==
OP_Gt
 );

3521 
	`as£π
–
TK_GE
==
OP_Ge
 );

3522 
	`as£π
–
TK_EQ
==
OP_Eq
 );

3523 
	`as£π
–
TK_NE
==
OP_Ne
 );

3524 
	`ã°ˇ£
–
›
==
TK_LT
 );

3525 
	`ã°ˇ£
–
›
==
TK_LE
 );

3526 
	`ã°ˇ£
–
›
==
TK_GT
 );

3527 
	`ã°ˇ£
–
›
==
TK_GE
 );

3528 
	`ã°ˇ£
–
›
==
TK_EQ
 );

3529 
	`ã°ˇ£
–
›
==
TK_NE
 );

3530 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3531 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

3532 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

3533 
	`codeCom∑ª
(
pP¨£
, 
pEx¥
->
pLe·
,ÖEx¥->
pRight
, 
›
,

3534 
r1
, 
r2
, 
de°
, 
jumpIfNuŒ
);

3535 
	`ã°ˇ£
–
ªgFªe1
==0 );

3536 
	`ã°ˇ£
–
ªgFªe2
==0 );

3539 
TK_IS
:

3540 
TK_ISNOT
: {

3541 
	`ã°ˇ£
–
›
==
TK_IS
 );

3542 
	`ã°ˇ£
–
›
==
TK_ISNOT
 );

3543 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

3544 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

3545 
›
 = (›==
TK_IS
Ë? 
TK_EQ
 : 
TK_NE
;

3546 
	`codeCom∑ª
(
pP¨£
, 
pEx¥
->
pLe·
,ÖEx¥->
pRight
, 
›
,

3547 
r1
, 
r2
, 
de°
, 
SQLITE4_NULLEQ
);

3548 
	`ã°ˇ£
–
ªgFªe1
==0 );

3549 
	`ã°ˇ£
–
ªgFªe2
==0 );

3552 
TK_ISNULL
:

3553 
TK_NOTNULL
: {

3554 
	`as£π
–
TK_ISNULL
==
OP_IsNuŒ
 );

3555 
	`as£π
–
TK_NOTNULL
==
OP_NŸNuŒ
 );

3556 
	`ã°ˇ£
–
›
==
TK_ISNULL
 );

3557 
	`ã°ˇ£
–
›
==
TK_NOTNULL
 );

3558 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

3559 
	`sqlôe4VdbeAddOp2
(
v
, 
›
, 
r1
, 
de°
);

3560 
	`ã°ˇ£
–
ªgFªe1
==0 );

3563 
TK_BETWEEN
: {

3564 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3565 
	`ex¥CodeBëwìn
(
pP¨£
, 
pEx¥
, 
de°
, 1, 
jumpIfNuŒ
);

3568 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3569 
TK_IN
: {

3570 
de°IfFÆ£
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3571 
de°IfNuŒ
 = 
jumpIfNuŒ
 ? 
de°
 : 
de°IfFÆ£
;

3572 
	`sqlôe4Ex¥CodeIN
(
pP¨£
, 
pEx¥
, 
de°IfFÆ£
, 
de°IfNuŒ
);

3573 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
de°
);

3574 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
de°IfFÆ£
);

3579 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
, &
ªgFªe1
);

3580 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_If
, 
r1
, 
de°
, 
jumpIfNuŒ
!=0);

3581 
	`ã°ˇ£
–
ªgFªe1
==0 );

3582 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3586 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe1
);

3587 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe2
);

3588 
	}
}

3599 
	$sqlôe4Ex¥IfFÆ£
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
, 
de°
, 
jumpIfNuŒ
){

3600 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3601 
›
 = 0;

3602 
ªgFªe1
 = 0;

3603 
ªgFªe2
 = 0;

3604 
r1
, 
r2
;

3606 
	`as£π
–
jumpIfNuŒ
==
SQLITE4_JUMPIFNULL
 || jumpIfNull==0 );

3607 if–
	`NEVER
(
v
==0) ) ;

3608 if–
pEx¥
==0 ) ;

3628 
›
 = ((
pEx¥
->›+(
TK_ISNULL
&1))^1)-(TK_ISNULL&1);

3632 
	`as£π
–
pEx¥
->
›
!=
TK_ISNULL
 || op==
OP_NŸNuŒ
 );

3633 
	`as£π
–
pEx¥
->
›
!=
TK_NOTNULL
 || op==
OP_IsNuŒ
 );

3634 
	`as£π
–
pEx¥
->
›
!=
TK_NE
 || op==
OP_Eq
 );

3635 
	`as£π
–
pEx¥
->
›
!=
TK_EQ
 || op==
OP_Ne
 );

3636 
	`as£π
–
pEx¥
->
›
!=
TK_LT
 || op==
OP_Ge
 );

3637 
	`as£π
–
pEx¥
->
›
!=
TK_LE
 || op==
OP_Gt
 );

3638 
	`as£π
–
pEx¥
->
›
!=
TK_GT
 || op==
OP_Le
 );

3639 
	`as£π
–
pEx¥
->
›
!=
TK_GE
 || op==
OP_Lt
 );

3641  
pEx¥
->
›
 ){

3642 
TK_AND
: {

3643 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3644 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pEx¥
->
pLe·
, 
de°
, 
jumpIfNuŒ
);

3645 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pEx¥
->
pRight
, 
de°
, 
jumpIfNuŒ
);

3648 
TK_OR
: {

3649 
d2
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3650 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3651 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

3652 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, 
pEx¥
->
pLe·
, 
d2
, 
jumpIfNuŒ
^
SQLITE4_JUMPIFNULL
);

3653 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pEx¥
->
pRight
, 
de°
, 
jumpIfNuŒ
);

3654 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
d2
);

3655 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

3658 
TK_NOT
: {

3659 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3660 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, 
pEx¥
->
pLe·
, 
de°
, 
jumpIfNuŒ
);

3663 
TK_LT
:

3664 
TK_LE
:

3665 
TK_GT
:

3666 
TK_GE
:

3667 
TK_NE
:

3668 
TK_EQ
: {

3669 
	`ã°ˇ£
–
›
==
TK_LT
 );

3670 
	`ã°ˇ£
–
›
==
TK_LE
 );

3671 
	`ã°ˇ£
–
›
==
TK_GT
 );

3672 
	`ã°ˇ£
–
›
==
TK_GE
 );

3673 
	`ã°ˇ£
–
›
==
TK_EQ
 );

3674 
	`ã°ˇ£
–
›
==
TK_NE
 );

3675 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3676 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

3677 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

3678 
	`codeCom∑ª
(
pP¨£
, 
pEx¥
->
pLe·
,ÖEx¥->
pRight
, 
›
,

3679 
r1
, 
r2
, 
de°
, 
jumpIfNuŒ
);

3680 
	`ã°ˇ£
–
ªgFªe1
==0 );

3681 
	`ã°ˇ£
–
ªgFªe2
==0 );

3684 
TK_IS
:

3685 
TK_ISNOT
: {

3686 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_IS
 );

3687 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_ISNOT
 );

3688 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

3689 
r2
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pRight
, &
ªgFªe2
);

3690 
›
 = (
pEx¥
->›==
TK_IS
Ë? 
TK_NE
 : 
TK_EQ
;

3691 
	`codeCom∑ª
(
pP¨£
, 
pEx¥
->
pLe·
,ÖEx¥->
pRight
, 
›
,

3692 
r1
, 
r2
, 
de°
, 
SQLITE4_NULLEQ
);

3693 
	`ã°ˇ£
–
ªgFªe1
==0 );

3694 
	`ã°ˇ£
–
ªgFªe2
==0 );

3697 
TK_ISNULL
:

3698 
TK_NOTNULL
: {

3699 
	`ã°ˇ£
–
›
==
TK_ISNULL
 );

3700 
	`ã°ˇ£
–
›
==
TK_NOTNULL
 );

3701 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
->
pLe·
, &
ªgFªe1
);

3702 
	`sqlôe4VdbeAddOp2
(
v
, 
›
, 
r1
, 
de°
);

3703 
	`ã°ˇ£
–
ªgFªe1
==0 );

3706 
TK_BETWEEN
: {

3707 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3708 
	`ex¥CodeBëwìn
(
pP¨£
, 
pEx¥
, 
de°
, 0, 
jumpIfNuŒ
);

3711 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3712 
TK_IN
: {

3713 if–
jumpIfNuŒ
 ){

3714 
	`sqlôe4Ex¥CodeIN
(
pP¨£
, 
pEx¥
, 
de°
, dest);

3716 
de°IfNuŒ
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3717 
	`sqlôe4Ex¥CodeIN
(
pP¨£
, 
pEx¥
, 
de°
, 
de°IfNuŒ
);

3718 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
de°IfNuŒ
);

3724 
r1
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pEx¥
, &
ªgFªe1
);

3725 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_IfNŸ
, 
r1
, 
de°
, 
jumpIfNuŒ
!=0);

3726 
	`ã°ˇ£
–
ªgFªe1
==0 );

3727 
	`ã°ˇ£
–
jumpIfNuŒ
==0 );

3731 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe1
);

3732 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgFªe2
);

3733 
	}
}

3751 
	$sqlôe4Ex¥Com∑ª
(
Ex¥
 *
pA
, Ex¥ *
pB
){

3752 if–
pA
==0||
pB
==0 ){

3753  
pB
==
pA
 ? 0 : 2;

3755 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
pA
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

3756 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
pB
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

3757 if–
	`Ex¥HasPr›îty
(
pA
, 
EP_xIsSñe˘
Ë|| Ex¥HasPr›îty(
pB
, EP_xIsSelect) ){

3760 if–(
pA
->
Êags
 & 
EP_Di°ö˘
)!=(
pB
->flags & EP_Distinct) )  2;

3761 if–
pA
->
›
!=
pB
->op )  2;

3762 if–
	`sqlôe4Ex¥Com∑ª
(
pA
->
pLe·
, 
pB
->pLeft) )  2;

3763 if–
	`sqlôe4Ex¥Com∑ª
(
pA
->
pRight
, 
pB
->pRight) )  2;

3764 if–
	`sqlôe4Ex¥Li°Com∑ª
(
pA
->
x
.
pLi°
, 
pB
->x.pList) )  2;

3765 if–
pA
->
iTabÀ
!=
pB
->iTabÀ ||ÖA->
iCﬁumn
!=pB->iColumn )  2;

3766 if–
	`Ex¥HasPr›îty
(
pA
, 
EP_I¡VÆue
) ){

3767 if–!
	`Ex¥HasPr›îty
(
pB
, 
EP_I¡VÆue
Ë|| 
pA
->
u
.
iVÆue
!=pB->u.iValue ){

3770 }if–
pA
->
›
!=
TK_COLUMN
 &&ÖA->
u
.
zTokí
 ){

3771 if–
	`Ex¥HasPr›îty
(
pB
, 
EP_I¡VÆue
Ë|| 
	`NEVER
’B->
u
.
zTokí
==0) )  2;

3772 if–
	`°rcmp
(
pA
->
u
.
zTokí
,
pB
->u.zToken)!=0 ){

3776 if–(
pA
->
Êags
 & 
EP_ExpCﬁœã
)!=(
pB
->flags & EP_ExpCollate) )  1;

3777 if–(
pA
->
Êags
 & 
EP_ExpCﬁœã
)!=0 &&ÖA->
pCﬁl
!=
pB
->pColl )  2;

3779 
	}
}

3793 
	$sqlôe4Ex¥Li°Com∑ª
(
Ex¥Li°
 *
pA
, Ex¥Li° *
pB
){

3794 
i
;

3795 if–
pA
==0 && 
pB
==0 )  0;

3796 if–
pA
==0 || 
pB
==0 )  1;

3797 if–
pA
->
nEx¥
!=
pB
->nExpr )  1;

3798 
i
=0; i<
pA
->
nEx¥
; i++){

3799 
Ex¥
 *
pEx¥A
 = 
pA
->
a
[
i
].
pEx¥
;

3800 
Ex¥
 *
pEx¥B
 = 
pB
->
a
[
i
].
pEx¥
;

3801 if–
pA
->
a
[
i
].
s‹tOrdî
!=
pB
->a[i].sortOrder )  1;

3802 if–
	`sqlôe4Ex¥Com∑ª
(
pEx¥A
, 
pEx¥B
) )  1;

3805 
	}
}

3811 
	$addAggInfoCﬁumn
(
sqlôe4
 *
db
, 
AggInfo
 *
pInfo
){

3812 
i
;

3813 
pInfo
->
aCﬁ
 = 
	`sqlôe4AºayAŒoˇã
(

3814 
db
,

3815 
pInfo
->
aCﬁ
,

3816 (
pInfo
->
aCﬁ
[0]),

3818 &
pInfo
->
nCﬁumn
,

3819 &
pInfo
->
nCﬁumnAŒoc
,

3820 &
i


3822  
i
;

3823 
	}
}

3829 
	$addAggInfoFunc
(
sqlôe4
 *
db
, 
AggInfo
 *
pInfo
){

3830 
i
;

3831 
pInfo
->
aFunc
 = 
	`sqlôe4AºayAŒoˇã
(

3832 
db
,

3833 
pInfo
->
aFunc
,

3834 (
pInfo
->
aFunc
[0]),

3836 &
pInfo
->
nFunc
,

3837 &
pInfo
->
nFuncAŒoc
,

3838 &
i


3840  
i
;

3841 
	}
}

3848 
	$™ÆyzeAggªg©e
(
WÆkî
 *
pWÆkî
, 
Ex¥
 *
pEx¥
){

3849 
i
;

3850 
NameC⁄ãxt
 *
pNC
 = 
pWÆkî
->
u
.pNC;

3851 
P¨£
 *
pP¨£
 = 
pNC
->pParse;

3852 
SrcLi°
 *
pSrcLi°
 = 
pNC
->pSrcList;

3853 
AggInfo
 *
pAggInfo
 = 
pNC
->pAggInfo;

3855  
pEx¥
->
›
 ){

3856 
TK_AGG_COLUMN
:

3857 
TK_COLUMN
: {

3858 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_AGG_COLUMN
 );

3859 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_COLUMN
 );

3862 if–
	`ALWAYS
(
pSrcLi°
!=0) ){

3863 
SrcLi°Iãm
 *
pIãm
 = 
pSrcLi°
->
a
;

3864 
i
=0; i<
pSrcLi°
->
nSrc
; i++, 
pIãm
++){

3865 
AggInfoCﬁ
 *
pCﬁ
;

3866 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

3867 if–
pEx¥
->
iTabÀ
==
pIãm
->
iCurs‹
 ){

3874 
k
;

3875 
pCﬁ
 = 
pAggInfo
->
aCﬁ
;

3876 
k
=0; k<
pAggInfo
->
nCﬁumn
; k++, 
pCﬁ
++){

3877 if–
pCﬁ
->
iTabÀ
==
pEx¥
->iTable &&

3878 
pCﬁ
->
iCﬁumn
==
pEx¥
->iColumn ){

3882 if–(
k
>=
pAggInfo
->
nCﬁumn
)

3883 && (
k
 = 
	`addAggInfoCﬁumn
(
pP¨£
->
db
, 
pAggInfo
))>=0

3885 
pCﬁ
 = &
pAggInfo
->
aCﬁ
[
k
];

3886 
pCﬁ
->
pTab
 = 
pEx¥
->pTab;

3887 
pCﬁ
->
iTabÀ
 = 
pEx¥
->iTable;

3888 
pCﬁ
->
iCﬁumn
 = 
pEx¥
->iColumn;

3889 
pCﬁ
->
iMem
 = ++
pP¨£
->
nMem
;

3890 
pCﬁ
->
iS‹ãrCﬁumn
 = -1;

3891 
pCﬁ
->
pEx¥
 =ÖExpr;

3892 if–
pAggInfo
->
pGroupBy
 ){

3893 
j
, 
n
;

3894 
Ex¥Li°
 *
pGB
 = 
pAggInfo
->
pGroupBy
;

3895 
Ex¥Li°Iãm
 *
pTîm
 = 
pGB
->
a
;

3896 
n
 = 
pGB
->
nEx¥
;

3897 
j
=0; j<
n
; j++, 
pTîm
++){

3898 
Ex¥
 *
pE
 = 
pTîm
->
pEx¥
;

3899 if–
pE
->
›
==
TK_COLUMN
 &&ÖE->
iTabÀ
==
pEx¥
->iTable &&

3900 
pE
->
iCﬁumn
==
pEx¥
->iColumn ){

3901 
pCﬁ
->
iS‹ãrCﬁumn
 = 
j
;

3906 if–
pCﬁ
->
iS‹ãrCﬁumn
<0 ){

3907 
pCﬁ
->
iS‹ãrCﬁumn
 = 
pAggInfo
->
nS‹tögCﬁumn
++;

3915 
	`Ex¥SëIºeducibÀ
(
pEx¥
);

3916 
pEx¥
->
pAggInfo
 =ÖAggInfo;

3917 
pEx¥
->
›
 = 
TK_AGG_COLUMN
;

3918 
pEx¥
->
iAgg
 = (
i16
)
k
;

3923  
WRC_Pru√
;

3925 
TK_AGG_FUNCTION
: {

3928 if–
pNC
->
nDïth
==0 ){

3932 
AggInfoFunc
 *
pIãm
 = 
pAggInfo
->
aFunc
;

3933 
i
=0; i<
pAggInfo
->
nFunc
; i++, 
pIãm
++){

3934 if–
	`sqlôe4Ex¥Com∑ª
(
pIãm
->
pEx¥
,ÖExpr)==0 ){

3938 if–
i
>=
pAggInfo
->
nFunc
 ){

3941 
i
 = 
	`addAggInfoFunc
(
pP¨£
->
db
, 
pAggInfo
);

3942 if–
i
>=0 ){

3943 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

3944 
pIãm
 = &
pAggInfo
->
aFunc
[
i
];

3945 
pIãm
->
pEx¥
 =ÖExpr;

3946 
pIãm
->
iMem
 = ++
pP¨£
->
nMem
;

3947 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

3948 
pIãm
->
pFunc
 = 
	`sqlôe4FödFun˘i⁄
(
pP¨£
->
db
,

3949 
pEx¥
->
u
.
zTokí
, 
	`sqlôe4SåÀn30
(pExpr->u.zToken),

3950 
pEx¥
->
x
.
pLi°
 ?ÖEx¥->x.pLi°->
nEx¥
 : 0, 0);

3951 if–
pEx¥
->
Êags
 & 
EP_Di°ö˘
 ){

3952 
pIãm
->
iDi°ö˘
 = 
pP¨£
->
nTab
++;

3954 
pIãm
->
iDi°ö˘
 = -1;

3960 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

3961 
	`Ex¥SëIºeducibÀ
(
pEx¥
);

3962 
pEx¥
->
iAgg
 = (
i16
)
i
;

3963 
pEx¥
->
pAggInfo
 =ÖAggInfo;

3964  
WRC_Pru√
;

3968  
WRC_C⁄töue
;

3969 
	}
}

3970 
	$™ÆyzeAggªg©esInSñe˘
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
pSñe˘
){

3971 
NameC⁄ãxt
 *
pNC
 = 
pWÆkî
->
u
.pNC;

3972 if–
pNC
->
nDïth
==0 ){

3973 
pNC
->
nDïth
++;

3974 
	`sqlôe4WÆkSñe˘
(
pWÆkî
, 
pSñe˘
);

3975 
pNC
->
nDïth
--;

3976  
WRC_Pru√
;

3978  
WRC_C⁄töue
;

3980 
	}
}

3990 
	$sqlôe4Ex¥A«lyzeAggªg©es
(
NameC⁄ãxt
 *
pNC
, 
Ex¥
 *
pEx¥
){

3991 
WÆkî
 
w
;

3992 
w
.
xEx¥CÆlback
 = 
™ÆyzeAggªg©e
;

3993 
w
.
xSñe˘CÆlback
 = 
™ÆyzeAggªg©esInSñe˘
;

3994 
w
.
u
.
pNC
 =ÖNC;

3995 
	`as£π
–
pNC
->
pSrcLi°
!=0 );

3996 
	`sqlôe4WÆkEx¥
(&
w
, 
pEx¥
);

3997 
	}
}

4005 
	$sqlôe4Ex¥A«lyzeAggLi°
(
NameC⁄ãxt
 *
pNC
, 
Ex¥Li°
 *
pLi°
){

4006 
Ex¥Li°Iãm
 *
pIãm
;

4007 
i
;

4008 if–
pLi°
 ){

4009 
pIãm
=
pLi°
->
a
, 
i
=0; i<pLi°->
nEx¥
; i++,ÖItem++){

4010 
	`sqlôe4Ex¥A«lyzeAggªg©es
(
pNC
, 
pIãm
->
pEx¥
);

4013 
	}
}

4018 
	$sqlôe4GëTempReg
(
P¨£
 *
pP¨£
){

4019 if–
pP¨£
->
nTempReg
==0 ){

4020  ++
pP¨£
->
nMem
;

4022  
pP¨£
->
aTempReg
[--pP¨£->
nTempReg
];

4023 
	}
}

4033 
	$sqlôe4Rñó£TempReg
(
P¨£
 *
pP¨£
, 
iReg
){

4034 if–
iReg
 && 
pP¨£
->
nTempReg
<
	`AºaySize
’P¨£->
aTempReg
) ){

4035 
i
;

4036 
P¨£YCﬁCache
 *
p
;

4037 
i
=0, 
p
=
pP¨£
->
aCﬁCache
; i<
SQLITE4_N_COLCACHE
; i++,Ö++){

4038 if–
p
->
iReg
==iReg ){

4039 
p
->
ãmpReg
 = 1;

4043 
pP¨£
->
aTempReg
[pP¨£->
nTempReg
++] = 
iReg
;

4045 
	}
}

4050 
	$sqlôe4GëTempR™ge
(
P¨£
 *
pP¨£
, 
nReg
){

4051 
i
, 
n
;

4052 
i
 = 
pP¨£
->
iR™geReg
;

4053 
n
 = 
pP¨£
->
nR™geReg
;

4054 if–
nReg
<=
n
 ){

4055 
	`as£π
–!
	`u£dAsCﬁumnCache
(
pP¨£
, 
i
, i+
n
-1) );

4056 
pP¨£
->
iR™geReg
 +
nReg
;

4057 
pP¨£
->
nR™geReg
 -
nReg
;

4059 
i
 = 
pP¨£
->
nMem
+1;

4060 
pP¨£
->
nMem
 +
nReg
;

4062  
i
;

4063 
	}
}

4064 
	$sqlôe4Rñó£TempR™ge
(
P¨£
 *
pP¨£
, 
iReg
, 
nReg
){

4065 
	`sqlôe4Ex¥CacheRemove
(
pP¨£
, 
iReg
, 
nReg
);

4066 if–
nReg
>
pP¨£
->
nR™geReg
 ){

4067 
pP¨£
->
nR™geReg
 = 
nReg
;

4068 
pP¨£
->
iR™geReg
 = 
iReg
;

4070 
	}
}

4075 
	$sqlôe4CÀ¨TempRegCache
(
P¨£
 *
pP¨£
){

4076 
pP¨£
->
nTempReg
 = 0;

4077 
pP¨£
->
nR™geReg
 = 0;

4078 
	}
}

	@src/fault.c

27 
	~"sqlôeI¡.h
"

29 #i‚de‡
SQLITE4_OMIT_BUILTIN_TEST


35 
	$sqlôe4BegöBíignMÆloc
(
sqlôe4_ív
 *
pEnv
){

36 
	`sqlôe4_mm_bíign_Áûuªs
(
pEnv
->
pMM
, 1);

37 
	}
}

38 
	$sqlôe4EndBíignMÆloc
(
sqlôe4_ív
 *
pEnv
){

39 
	`sqlôe4_mm_bíign_Áûuªs
(
pEnv
->
pMM
, 0);

40 
	}
}

	@src/fkey.c

14 
	~"sqlôeI¡.h
"

16 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


17 #i‚de‡
SQLITE4_OMIT_TRIGGER


180 
	$loˇãFkeyIndex
(

181 
P¨£
 *
pP¨£
,

182 
TabÀ
 *
pP¨ít
,

183 
FKey
 *
pFKey
,

184 
Index
 **
µIdx
,

185 **
∑iCﬁ


187 
Index
 *
pIdx
 = 0;

188 *
aiCﬁ
 = 0;

189 
nCﬁ
 = 
pFKey
->nCol;

190 
bIm∂icô
;

193 
	`as£π
–
µIdx
 && *ppIdx==0 );

194 
	`as£π
–!
∑iCﬁ
 || *paiCol==0 );

195 
	`as£π
–
pP¨£
 );

197 
bIm∂icô
 = (
pFKey
->
aCﬁ
[0].
zCﬁ
==0);

202 if–
∑iCﬁ
 && 
nCﬁ
>1 ){

203 
	`as£π
–
nCﬁ
>1 );

204 
aiCﬁ
 = (*)
	`sqlôe4DbMÆlocRaw
(
pP¨£
->
db
, 
nCﬁ
*());

205 if–!
aiCﬁ
 )  1;

206 *
∑iCﬁ
 = 
aiCﬁ
;

209 
pIdx
=
pP¨ít
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

210 if–
pIdx
->
nCﬁumn
==
nCﬁ


211 && 
pIdx
->
⁄Eº‹
!=
OE_N⁄e


212 && 
pIdx
->
aiCﬁumn
[0]!=-1

218 if–
bIm∂icô
 ){

219 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

220 if–
aiCﬁ
 ){

221 
i
;

222 
i
=0; i<
nCﬁ
; i++Ë
aiCﬁ
[i] = 
pFKey
->
aCﬁ
[i].
iFrom
;

231 
i
, 
j
;

232 
i
=0; i<
nCﬁ
; i++){

233 
iCﬁ
 = 
pIdx
->
aiCﬁumn
[
i
];

234 *
zDÊtCﬁl
;

235 *
zIdxCﬁ
;

240 
zDÊtCﬁl
 = 
pP¨ít
->
aCﬁ
[
iCﬁ
].
zCﬁl
;

241 if–!
zDÊtCﬁl
 ){

242 
zDÊtCﬁl
 = "BINARY";

244 if–
	`sqlôe4_°ricmp
(
pIdx
->
azCﬁl
[
i
], 
zDÊtCﬁl
) ) ;

246 
zIdxCﬁ
 = 
pP¨ít
->
aCﬁ
[
iCﬁ
].
zName
;

247 
j
=0; j<
nCﬁ
; j++){

248 if–
	`sqlôe4_°ricmp
(
pFKey
->
aCﬁ
[
j
].
zCﬁ
, 
zIdxCﬁ
)==0 ){

249 if–
aiCﬁ
 )áiCﬁ[
i
] = 
pFKey
->
aCﬁ
[
j
].
iFrom
;

253 if–
j
==
nCﬁ
 ) ;

255 if–
i
==
nCﬁ
 ) ;

260 if–!
pIdx
 ){

261 if–!
pP¨£
->
dißbÀTriggîs
 ){

262 
	`sqlôe4Eº‹Msg
(
pP¨£
, "foreign key mismatch");

264 
	`sqlôe4DbFªe
(
pP¨£
->
db
, 
aiCﬁ
);

268 *
µIdx
 = 
pIdx
;

270 
	}
}

298 
	$fkLookupP¨ít
(

299 
P¨£
 *
pP¨£
,

300 
iDb
,

301 
TabÀ
 *
pTab
,

302 
Index
 *
pIdx
,

303 
FKey
 *
pFKey
,

304 *
aiCﬁ
,

305 
ªgC⁄ã¡
,

306 
nIn¸
,

307 
isIgn‹e


309 
i
;

310 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

311 
iCur
 = 
pP¨£
->
nTab
 - 1;

312 
iOk
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

314 
	`as£π
–
pIdx
 );

320 if–
nIn¸
<0 ){

321 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkIfZîo
, 
pFKey
->
isDe„ºed
, 
iOk
);

327 
i
=0; i<
pFKey
->
nCﬁ
; i++){

328 
iReg
 = 
aiCﬁ
[
i
] + 
ªgC⁄ã¡
;

329 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
iReg
, 
iOk
);

332 if–
isIgn‹e
==0 ){

333 
nCﬁ
 = 
pFKey
->nCol;

334 
ªgTemp
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nCﬁ
);

335 
ªgRec
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

337 
	`sqlôe4O≥nIndex
(
pP¨£
, 
iCur
, 
iDb
, 
pIdx
, 
OP_O≥nRód
);

341 
i
=0; i<
nCﬁ
; i++){

342 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
aiCﬁ
[
i
]+
ªgC⁄ã¡
, 
ªgTemp
+i);

344 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Afföôy
, 
ªgTemp
, 
nCﬁ
);

345 
	`sqlôe4VdbeCh™geP4
(
v
, -1, 
	`sqlôe4IndexAfföôySå
(v, 
pIdx
), 
P4_TRANSIENT
);

356 if–
pTab
==
pFKey
->
pFrom
 && 
nIn¸
==1 ){

357 
iJump
 = 
	`sqlôe4VdbeCuºítAddr
(
v
Ë+ 
nCﬁ
 + 1;

358 
i
=0; i<
nCﬁ
; i++){

359 
iChûd
 = 
ªgTemp
+
i
;

360 
iP¨ít
 = 
pIdx
->
aiCﬁumn
[
i
]+
ªgC⁄ã¡
;

361 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Ne
, 
iChûd
, 
iJump
, 
iP¨ít
);

362 
	`sqlôe4VdbeCh™geP5
(
v
, 
SQLITE4_JUMPIFNULL
);

363 
	`as£π
–
iChûd
<=
pP¨£
->
nMem
 && 
iP¨ít
<=pParse->nMem );

365 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
iOk
);

368 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgTemp
, 
nCﬁ
, 
ªgRec
, 
iCur
);

369 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_Found
, 
iCur
, 
iOk
, 
ªgRec
, 0);

371 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgRec
);

372 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgTemp
, 
nCﬁ
);

375 if–!
pFKey
->
isDe„ºed
 && !
pP¨£
->
pT›Àvñ
 && !pP¨£->
isMu…iWrôe
 ){

380 
	`as£π
–
nIn¸
==1 );

381 
	`sqlôe4HÆtC⁄°øöt
(

382 
pP¨£
, 
OE_Ab‹t
, "f‹eig¿key c⁄°øöàÁûed", 
P4_STATIC


385 if–
nIn¸
>0 && 
pFKey
->
isDe„ºed
==0 ){

386 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
)->
mayAb‹t
 = 1;

388 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkCou¡î
, 
pFKey
->
isDe„ºed
, 
nIn¸
);

391 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iOk
);

392 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iCur
);

393 
	}
}

423 
	$fkSˇnChûdªn
(

424 
P¨£
 *
pP¨£
,

425 
SrcLi°
 *
pSrc
,

426 
TabÀ
 *
pTab
,

427 
Index
 *
pIdx
,

428 
FKey
 *
pFKey
,

429 *
aiCﬁ
,

430 
ªgD©a
,

431 
nIn¸


433 
sqlôe4
 *
db
 = 
pP¨£
->db;

434 
i
;

435 
Ex¥
 *
pWhîe
 = 0;

436 
NameC⁄ãxt
 
sNameC⁄ãxt
;

437 
WhîeInfo
 *
pWInfo
;

438 
iFkIfZîo
 = 0;

439 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

441 
	`as£π
–
pIdx
 &&ÖIdx->
pTabÀ
==
pTab
 );

443 if–
nIn¸
<0 ){

444 
iFkIfZîo
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkIfZîo
, 
pFKey
->
isDe„ºed
, 0);

455 
i
=0; i<
pFKey
->
nCﬁ
; i++){

456 
Ex¥
 *
pLe·
;

457 
Ex¥
 *
pRight
;

458 
Ex¥
 *
pEq
;

459 
iCﬁ
;

460 c⁄° *
zCﬁ
;

462 
pLe·
 = 
	`sqlôe4Ex¥
(
db
, 
TK_REGISTER
, 0);

463 if–
pLe·
 ){

466 
Cﬁumn
 *
pCﬁ
;

467 
iCﬁ
 = 
pIdx
->
aiCﬁumn
[
i
];

468 
pCﬁ
 = &
pTab
->
aCﬁ
[
iCﬁ
];

469 
pLe·
->
iTabÀ
 = 
ªgD©a
+
iCﬁ
;

470 
pLe·
->
afföôy
 = 
pCﬁ
->affinity;

471 
pLe·
->
pCﬁl
 = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
pCﬁ
->
zCﬁl
);

473 
iCﬁ
 = 
aiCﬁ
 ?áiCﬁ[
i
] : 
pFKey
->
aCﬁ
[0].
iFrom
;

474 
	`as£π
–
iCﬁ
>=0 );

475 
zCﬁ
 = 
pFKey
->
pFrom
->
aCﬁ
[
iCﬁ
].
zName
;

476 
pRight
 = 
	`sqlôe4Ex¥
(
db
, 
TK_ID
, 
zCﬁ
);

477 
pEq
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_EQ
, 
pLe·
, 
pRight
, 0);

478 
pWhîe
 = 
	`sqlôe4Ex¥And
(
db
,ÖWhîe, 
pEq
);

485 if–
pTab
==
pFKey
->
pFrom
 && 
nIn¸
>0 ){

486 
Ex¥
 *
pEq
;

487 
Ex¥
 *
pLe·
;

488 
Ex¥
 *
pRight
;

489 
pLe·
 = 
	`sqlôe4Ex¥
(
db
, 
TK_REGISTER
, 0);

490 
pRight
 = 
	`sqlôe4Ex¥
(
db
, 
TK_COLUMN
, 0);

491 if–
pLe·
 && 
pRight
 ){

492 
pLe·
->
iTabÀ
 = 
ªgD©a
;

493 
pLe·
->
afföôy
 = 
SQLITE4_AFF_INTEGER
;

494 
pRight
->
iTabÀ
 = 
pSrc
->
a
[0].
iCurs‹
;

495 
pRight
->
iCﬁumn
 = -1;

497 
pEq
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NE
, 
pLe·
, 
pRight
, 0);

498 
pWhîe
 = 
	`sqlôe4Ex¥And
(
db
,ÖWhîe, 
pEq
);

502 
	`mem£t
(&
sNameC⁄ãxt
, 0, (
NameC⁄ãxt
));

503 
sNameC⁄ãxt
.
pSrcLi°
 = 
pSrc
;

504 
sNameC⁄ãxt
.
pP¨£
 =ÖParse;

505 
	`sqlôe4ResﬁveEx¥Names
(&
sNameC⁄ãxt
, 
pWhîe
);

510 
pWInfo
 = 
	`sqlôe4WhîeBegö
(
pP¨£
, 
pSrc
, 
pWhîe
, 0, 0, 0, 0);

511 if–
nIn¸
>0 && 
pFKey
->
isDe„ºed
==0 ){

512 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
)->
mayAb‹t
 = 1;

514 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkCou¡î
, 
pFKey
->
isDe„ºed
, 
nIn¸
);

515 if–
pWInfo
 ){

516 
	`sqlôe4WhîeEnd
(
pWInfo
);

520 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhîe
);

521 if–
iFkIfZîo
 ){

522 
	`sqlôe4VdbeJumpHîe
(
v
, 
iFkIfZîo
);

524 
	}
}

540 
FKey
 *
	$sqlôe4FkRe„ªn˚s
(
TabÀ
 *
pTab
){

541 
nName
 = 
	`sqlôe4SåÀn30
(
pTab
->
zName
);

542  (
FKey
 *)
	`sqlôe4HashFöd
(&
pTab
->
pSchema
->
fkeyHash
,ÖTab->
zName
, 
nName
);

543 
	}
}

553 
	$fkTriggîDñëe
(
sqlôe4
 *
dbMem
, 
Triggî
 *
p
){

554 if–
p
 ){

555 
TriggîSãp
 *
pSãp
 = 
p
->
°ï_li°
;

556 
	`sqlôe4Ex¥Dñëe
(
dbMem
, 
pSãp
->
pWhîe
);

557 
	`sqlôe4Ex¥Li°Dñëe
(
dbMem
, 
pSãp
->
pEx¥Li°
);

558 
	`sqlôe4Sñe˘Dñëe
(
dbMem
, 
pSãp
->
pSñe˘
);

559 
	`sqlôe4Ex¥Dñëe
(
dbMem
, 
p
->
pWhí
);

560 
	`sqlôe4DbFªe
(
dbMem
, 
p
);

562 
	}
}

581 
	$sqlôe4FkDr›TabÀ
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pName
, 
TabÀ
 *
pTab
){

582 
sqlôe4
 *
db
 = 
pP¨£
->db;

583 if–(
db
->
Êags
&
SQLITE4_F‹eignKeys
Ë&& !
	`IsVútuÆ
(
pTab
Ë&& !pTab->
pSñe˘
 ){

584 
iSkù
 = 0;

585 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

587 
	`as£π
–
v
 );

588 if–
	`sqlôe4FkRe„ªn˚s
(
pTab
)==0 ){

594 
FKey
 *
p
;

595 
p
=
pTab
->
pFKey
;Ö;Öı->
pNextFrom
){

596 if–
p
->
isDe„ºed
 ) ;

598 if–!
p
 ) ;

599 
iSkù
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

600 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkIfZîo
, 1, 
iSkù
);

603 
pP¨£
->
dißbÀTriggîs
 = 1;

604 
	`sqlôe4DñëeFrom
(
pP¨£
, 
	`sqlôe4SrcLi°Dup
(
db
, 
pName
, 0), 0);

605 
pP¨£
->
dißbÀTriggîs
 = 0;

611 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkIfZîo
, 0, 
	`sqlôe4VdbeCuºítAddr
(v)+2);

612 
	`sqlôe4HÆtC⁄°øöt
(

613 
pP¨£
, 
OE_Ab‹t
, "f‹eig¿key c⁄°øöàÁûed", 
P4_STATIC


616 if–
iSkù
 ){

617 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iSkù
);

620 
	}
}

642 
	$sqlôe4FkCheck
(

643 
P¨£
 *
pP¨£
,

644 
TabÀ
 *
pTab
,

645 
ªgOld
,

646 
ªgNew


648 
sqlôe4
 *
db
 = 
pP¨£
->db;

649 
FKey
 *
pFKey
;

650 
iDb
;

651 c⁄° *
zDb
;

652 
isIgn‹eEº‹s
 = 
pP¨£
->
dißbÀTriggîs
;

655 
	`as£π
–(
ªgOld
==0)!=(
ªgNew
==0) );

658 if–(
db
->
Êags
&
SQLITE4_F‹eignKeys
)==0 ) ;

660 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

661 
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

665 
pFKey
=
pTab
->pFKey;ÖFKey;ÖFKeyıFKey->
pNextFrom
){

666 
TabÀ
 *
pTo
;

667 
Index
 *
pIdx
 = 0;

668 *
aiFªe
 = 0;

669 *
aiCﬁ
;

670 
iCﬁ
;

671 
i
;

672 
isIgn‹e
 = 0;

678 if–
pP¨£
->
dißbÀTriggîs
 ){

679 
pTo
 = 
	`sqlôe4FödTabÀ
(
db
, 
pFKey
->
zTo
, 
zDb
);

681 
pTo
 = 
	`sqlôe4LoˇãTabÀ
(
pP¨£
, 0, 
pFKey
->
zTo
, 
zDb
);

683 if–!
pTo
 || 
	`loˇãFkeyIndex
(
pP¨£
,ÖTo, 
pFKey
, &
pIdx
, &
aiFªe
) ){

684 
	`as£π
–
isIgn‹eEº‹s
==0 || (
ªgOld
!=0 && 
ªgNew
==0) );

685 if–!
isIgn‹eEº‹s
 || 
db
->
mÆlocFaûed
 ) ;

686 if–
pTo
==0 ){

694 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

695 
iJump
 = 
	`sqlôe4VdbeCuºítAddr
(
v
Ë+ 
pFKey
->
nCﬁ
 + 1;

696 
i
=0; i<
pFKey
->
nCﬁ
; i++){

697 
iReg
 = 
pFKey
->
aCﬁ
[
i
].
iFrom
 + 
ªgOld
;

698 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
iReg
, 
iJump
);

700 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_FkCou¡î
, 
pFKey
->
isDe„ºed
, -1);

704 
	`as£π
–
pFKey
->
nCﬁ
==1 || (
aiFªe
 && 
pIdx
) );

706 if–
aiFªe
 ){

707 
aiCﬁ
 = 
aiFªe
;

709 
iCﬁ
 = 
pFKey
->
aCﬁ
[0].
iFrom
;

710 
aiCﬁ
 = &
iCﬁ
;

712 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


713 
i
=0; i<
pFKey
->
nCﬁ
; i++){

717 
rˇuth
;

718 *
zCﬁ
 = 
pTo
->
aCﬁ
[
pIdx
->
aiCﬁumn
[
i
]].
zName
;

719 
rˇuth
 = 
	`sqlôe4AuthRódCﬁ
(
pP¨£
, 
pTo
->
zName
, 
zCﬁ
, 
iDb
);

720 
isIgn‹e
 = (
rˇuth
==
SQLITE4_IGNORE
);

724 
pP¨£
->
nTab
++;

725 if–
ªgOld
!=0 ){

729 
	`fkLookupP¨ít
(
pP¨£
, 
iDb
, 
pTo
, 
pIdx
, 
pFKey
, 
aiCﬁ
, 
ªgOld
, -1,
isIgn‹e
);

731 if–
ªgNew
!=0 ){

734 
	`fkLookupP¨ít
(
pP¨£
, 
iDb
, 
pTo
, 
pIdx
, 
pFKey
, 
aiCﬁ
, 
ªgNew
, +1,
isIgn‹e
);

737 
	`sqlôe4DbFªe
(
db
, 
aiFªe
);

741 
pFKey
 = 
	`sqlôe4FkRe„ªn˚s
(
pTab
);ÖFKey;ÖFKeyıFKey->
pNextTo
){

742 
Index
 *
pIdx
 = 0;

743 
SrcLi°
 *
pSrc
;

744 *
aiCﬁ
 = 0;

746 if–!
pFKey
->
isDe„ºed
 && !
pP¨£
->
pT›Àvñ
 && !pP¨£->
isMu…iWrôe
 ){

747 
	`as£π
–
ªgOld
==0 && 
ªgNew
!=0 );

753 if–
	`loˇãFkeyIndex
(
pP¨£
, 
pTab
, 
pFKey
, &
pIdx
, &
aiCﬁ
) ){

754 if–!
isIgn‹eEº‹s
 || 
db
->
mÆlocFaûed
 ) ;

757 
	`as£π
–
aiCﬁ
 || 
pFKey
->
nCﬁ
==1 );

762 
pSrc
 = 
	`sqlôe4SrcLi°Aµíd
(
db
, 0, 0, 0);

763 if–
pSrc
 ){

764 
SrcLi°Iãm
 *
pIãm
 = 
pSrc
->
a
;

765 
pIãm
->
pTab
 = 
pFKey
->
pFrom
;

766 
pIãm
->
zName
 = 
pFKey
->
pFrom
->zName;

767 
pIãm
->
pTab
->
nRef
++;

768 
pIãm
->
iCurs‹
 = 
pP¨£
->
nTab
++;

770 if–
ªgNew
!=0 ){

771 
	`fkSˇnChûdªn
(
pP¨£
, 
pSrc
, 
pTab
, 
pIdx
, 
pFKey
, 
aiCﬁ
, 
ªgNew
, -1);

773 if–
ªgOld
!=0 ){

780 
	`fkSˇnChûdªn
(
pP¨£
, 
pSrc
, 
pTab
, 
pIdx
, 
pFKey
, 
aiCﬁ
, 
ªgOld
, 1);

782 
pIãm
->
zName
 = 0;

783 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pSrc
);

785 
	`sqlôe4DbFªe
(
db
, 
aiCﬁ
);

787 
	}
}

789 
	#COLUMN_MASK
(
x
Ë(((x)>31Ë? 0xfffffff‡: ((
u32
)1<<(x)))

	)

795 
u32
 
	$sqlôe4FkOldmask
(

796 
P¨£
 *
pP¨£
,

797 
TabÀ
 *
pTab


799 
u32
 
mask
 = 0;

800 if–
pP¨£
->
db
->
Êags
&
SQLITE4_F‹eignKeys
 ){

801 
FKey
 *
p
;

802 
i
;

803 
p
=
pTab
->
pFKey
;Ö;Öı->
pNextFrom
){

804 
i
=0; i<
p
->
nCﬁ
; i++Ë
mask
 |
	`COLUMN_MASK
’->
aCﬁ
[i].
iFrom
);

806 
p
=
	`sqlôe4FkRe„ªn˚s
(
pTab
);Ö;Öı->
pNextTo
){

807 
Index
 *
pIdx
 = 0;

808 
	`loˇãFkeyIndex
(
pP¨£
, 
pTab
, 
p
, &
pIdx
, 0);

809 if–
pIdx
 ){

810 
i
=0; i<
pIdx
->
nCﬁumn
; i++Ë
mask
 |
	`COLUMN_MASK
’Idx->
aiCﬁumn
[i]);

814  
mask
;

815 
	}
}

831 
	$sqlôe4FkRequúed
(

832 
P¨£
 *
pP¨£
,

833 
TabÀ
 *
pTab
,

834 *
aCh™ge


836 if–
pP¨£
->
db
->
Êags
&
SQLITE4_F‹eignKeys
 ){

837 if–!
aCh™ge
 ){

841  (
	`sqlôe4FkRe„ªn˚s
(
pTab
Ë||ÖTab->
pFKey
);

845 
i
;

846 
FKey
 *
p
;

849 
p
=
pTab
->
pFKey
;Ö;Öı->
pNextFrom
){

850 
i
=0; i<
p
->
nCﬁ
; i++){

851 
iChûdKey
 = 
p
->
aCﬁ
[
i
].
iFrom
;

852 if–
aCh™ge
[
iChûdKey
]>=0 )  1;

857 
p
=
	`sqlôe4FkRe„ªn˚s
(
pTab
);Ö;Öı->
pNextTo
){

858 
i
=0; i<
p
->
nCﬁ
; i++){

859 *
zKey
 = 
p
->
aCﬁ
[
i
].
zCﬁ
;

860 
iKey
;

861 
iKey
=0; iKey<
pTab
->
nCﬁ
; iKey++){

862 
Cﬁumn
 *
pCﬁ
 = &
pTab
->
aCﬁ
[
iKey
];

863 if–(
zKey
 ? !
	`sqlôe4_°ricmp
(
pCﬁ
->
zName
,zKeyË:ÖCﬁ->
iPrimKey
>0) ){

864 if–
aCh™ge
[
iKey
]>=0 )  1;

872 
	}
}

903 
Triggî
 *
	$fkA˘i⁄Triggî
(

904 
P¨£
 *
pP¨£
,

905 
TabÀ
 *
pTab
,

906 
FKey
 *
pFKey
,

907 
Ex¥Li°
 *
pCh™ges


909 
sqlôe4
 *
db
 = 
pP¨£
->db;

910 
a˘i⁄
;

911 
Triggî
 *
pTriggî
;

912 
iA˘i⁄
 = (
pCh™ges
!=0);

914 
a˘i⁄
 = 
pFKey
->
aA˘i⁄
[
iA˘i⁄
];

915 
pTriggî
 = 
pFKey
->
≠Triggî
[
iA˘i⁄
];

917 if–
a˘i⁄
!=
OE_N⁄e
 && !
pTriggî
 ){

918 
u8
 
íabÀLookaside
;

919 c⁄° *
zFrom
;

920 
nFrom
;

921 
Index
 *
pIdx
 = 0;

922 *
aiCﬁ
 = 0;

923 
TriggîSãp
 *
pSãp
 = 0;

924 
Ex¥
 *
pWhîe
 = 0;

925 
Ex¥Li°
 *
pLi°
 = 0;

926 
Sñe˘
 *
pSñe˘
 = 0;

927 
i
;

928 
Ex¥
 *
pWhí
 = 0;

930 if–
	`loˇãFkeyIndex
(
pP¨£
, 
pTab
, 
pFKey
, &
pIdx
, &
aiCﬁ
) )  0;

931 
	`as£π
–
aiCﬁ
 || 
pFKey
->
nCﬁ
==1 );

933 
i
=0; i<
pFKey
->
nCﬁ
; i++){

934 
Tokí
 
tOld
 = { "old", 3 };

935 
Tokí
 
tNew
 = { "new", 3 };

936 
Tokí
 
tFromCﬁ
;

937 
Tokí
 
tToCﬁ
;

938 
iFromCﬁ
;

939 
Ex¥
 *
pEq
;

941 
iFromCﬁ
 = 
aiCﬁ
 ?áiCﬁ[
i
] : 
pFKey
->
aCﬁ
[0].
iFrom
;

942 
	`as£π
–
iFromCﬁ
>=0 );

943 
tToCﬁ
.
z
 = 
pIdx
 ? 
pTab
->
aCﬁ
[pIdx->
aiCﬁumn
[
i
]].
zName
 : "oid";

944 
tFromCﬁ
.
z
 = 
pFKey
->
pFrom
->
aCﬁ
[
iFromCﬁ
].
zName
;

946 
tToCﬁ
.
n
 = 
	`sqlôe4SåÀn30
—ToCﬁ.
z
);

947 
tFromCﬁ
.
n
 = 
	`sqlôe4SåÀn30
—FromCﬁ.
z
);

953 
pEq
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_EQ
,

954 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
,

955 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tOld
),

956 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tToCﬁ
)

958 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tFromCﬁ
)

960 
pWhîe
 = 
	`sqlôe4Ex¥And
(
db
,ÖWhîe, 
pEq
);

967 if–
pCh™ges
 ){

968 
pEq
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_IS
,

969 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
,

970 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tOld
),

971 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tToCﬁ
),

973 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
,

974 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tNew
),

975 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tToCﬁ
),

978 
pWhí
 = 
	`sqlôe4Ex¥And
(
db
,ÖWhí, 
pEq
);

981 if–
a˘i⁄
!=
OE_Re°ri˘
 && (a˘i⁄!=
OE_Casˇde
 || 
pCh™ges
) ){

982 
Ex¥
 *
pNew
;

983 if–
a˘i⁄
==
OE_Casˇde
 ){

984 
pNew
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
,

985 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tNew
),

986 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
tToCﬁ
)

988 }if–
a˘i⁄
==
OE_SëDÊt
 ){

989 
Ex¥
 *
pDÊt
 = 
pFKey
->
pFrom
->
aCﬁ
[
iFromCﬁ
].pDflt;

990 if–
pDÊt
 ){

991 
pNew
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pDÊt
, 0);

993 
pNew
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NULL
, 0, 0, 0);

996 
pNew
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NULL
, 0, 0, 0);

998 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,ÖLi°, 
pNew
);

999 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
pLi°
, &
tFromCﬁ
, 0);

1002 
	`sqlôe4DbFªe
(
db
, 
aiCﬁ
);

1004 
zFrom
 = 
pFKey
->
pFrom
->
zName
;

1005 
nFrom
 = 
	`sqlôe4SåÀn30
(
zFrom
);

1007 if–
a˘i⁄
==
OE_Re°ri˘
 ){

1008 
Tokí
 
tFrom
;

1009 
Ex¥
 *
pRai£
;

1011 
tFrom
.
z
 = 
zFrom
;

1012 
tFrom
.
n
 = 
nFrom
;

1013 
pRai£
 = 
	`sqlôe4Ex¥
(
db
, 
TK_RAISE
, "foreign key constraint failed");

1014 if–
pRai£
 ){

1015 
pRai£
->
afföôy
 = 
OE_Ab‹t
;

1017 
pSñe˘
 = 
	`sqlôe4Sñe˘New
(
pP¨£
,

1018 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
pRai£
),

1019 
	`sqlôe4SrcLi°Aµíd
(
db
, 0, &
tFrom
, 0),

1020 
pWhîe
,

1023 
pWhîe
 = 0;

1027 
íabÀLookaside
 = 
db
->
lookaside
.
bE«bÀd
;

1028 
db
->
lookaside
.
bE«bÀd
 = 0;

1030 
pTriggî
 = (
Triggî
 *)
	`sqlôe4DbMÆlocZîo
(
db
,

1031 (
Triggî
) +

1032 (
TriggîSãp
) +

1033 
nFrom
 + 1

1035 if–
pTriggî
 ){

1036 
pSãp
 = 
pTriggî
->
°ï_li°
 = (
TriggîSãp
 *)&pTrigger[1];

1037 
pSãp
->
èrgë
.
z
 = (*)&pStep[1];

1038 
pSãp
->
èrgë
.
n
 = 
nFrom
;

1039 
	`mem˝y
((*)
pSãp
->
èrgë
.
z
, 
zFrom
, 
nFrom
);

1041 
pSãp
->
pWhîe
 = 
	`sqlôe4Ex¥Dup
(
db
,ÖWhîe, 
EXPRDUP_REDUCE
);

1042 
pSãp
->
pEx¥Li°
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
pLi°
, 
EXPRDUP_REDUCE
);

1043 
pSãp
->
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
,ÖSñe˘, 
EXPRDUP_REDUCE
);

1044 if–
pWhí
 ){

1045 
pWhí
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
,ÖWhen, 0, 0);

1046 
pTriggî
->
pWhí
 = 
	`sqlôe4Ex¥Dup
(
db
,ÖWhí, 
EXPRDUP_REDUCE
);

1051 
db
->
lookaside
.
bE«bÀd
 = 
íabÀLookaside
;

1053 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhîe
);

1054 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhí
);

1055 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

1056 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

1057 if–
db
->
mÆlocFaûed
==1 ){

1058 
	`fkTriggîDñëe
(
db
, 
pTriggî
);

1061 
	`as£π
–
pSãp
!=0 );

1063  
a˘i⁄
 ){

1064 
OE_Re°ri˘
:

1065 
pSãp
->
›
 = 
TK_SELECT
;

1067 
OE_Casˇde
:

1068 if–!
pCh™ges
 ){

1069 
pSãp
->
›
 = 
TK_DELETE
;

1073 
pSãp
->
›
 = 
TK_UPDATE
;

1075 
pSãp
->
pTrig
 = 
pTriggî
;

1076 
pTriggî
->
pSchema
 = 
pTab
->pSchema;

1077 
pTriggî
->
pTabSchema
 = 
pTab
->
pSchema
;

1078 
pFKey
->
≠Triggî
[
iA˘i⁄
] = 
pTriggî
;

1079 
pTriggî
->
›
 = (
pCh™ges
 ? 
TK_UPDATE
 : 
TK_DELETE
);

1082  
pTriggî
;

1083 
	}
}

1089 
	$sqlôe4FkA˘i⁄s
(

1090 
P¨£
 *
pP¨£
,

1091 
TabÀ
 *
pTab
,

1092 
Ex¥Li°
 *
pCh™ges
,

1093 
ªgOld


1099 if–
pP¨£
->
db
->
Êags
&
SQLITE4_F‹eignKeys
 ){

1100 
FKey
 *
pFKey
;

1101 
pFKey
 = 
	`sqlôe4FkRe„ªn˚s
(
pTab
);ÖFKey;ÖFKeyıFKey->
pNextTo
){

1102 
Triggî
 *
pA˘i⁄
 = 
	`fkA˘i⁄Triggî
(
pP¨£
, 
pTab
, 
pFKey
, 
pCh™ges
);

1103 if–
pA˘i⁄
 ){

1104 
	`sqlôe4CodeRowTriggîDúe˘
(
pP¨£
, 
pA˘i⁄
, 
pTab
, 
ªgOld
, 
OE_Ab‹t
, 0);

1108 
	}
}

1117 
	$sqlôe4FkDñëe
(
sqlôe4
 *
db
, 
TabÀ
 *
pTab
){

1118 
FKey
 *
pFKey
;

1119 
FKey
 *
pNext
;

1121 
pFKey
=
pTab
->pFKey;ÖFKey;ÖFKey=
pNext
){

1124 if–!
db
 || db->
≤ByãsFªed
==0 ){

1125 if–
pFKey
->
pPªvTo
 ){

1126 
pFKey
->
pPªvTo
->
pNextTo
 =ÖFKey->pNextTo;

1128 *
p
 = (*)
pFKey
->
pNextTo
;

1129 c⁄° *
z
 = (
p
 ? 
pFKey
->
pNextTo
->
zTo
 :ÖFKey->zTo);

1130 
	`sqlôe4HashIn£π
(&
pTab
->
pSchema
->
fkeyHash
, 
z
, 
	`sqlôe4SåÀn30
(z), 
p
);

1132 if–
pFKey
->
pNextTo
 ){

1133 
pFKey
->
pNextTo
->
pPªvTo
 =ÖFKey->pPrevTo;

1140 
	`as£π
–
pFKey
->
isDe„ºed
==0 ||ÖFKey->isDeferred==1 );

1143 #i‚de‡
SQLITE4_OMIT_TRIGGER


1144 
	`fkTriggîDñëe
(
db
, 
pFKey
->
≠Triggî
[0]);

1145 
	`fkTriggîDñëe
(
db
, 
pFKey
->
≠Triggî
[1]);

1148 
pNext
 = 
pFKey
->
pNextFrom
;

1149 
	`sqlôe4DbFªe
(
db
, 
pFKey
);

1151 
	}
}

	@src/fts5.c

14 
	~"sqlôeI¡.h
"

15 
	~"vdbeI¡.h
"

26 
	#SQLITE4_FTS5_NSTREAM
 32

	)

83 
	#FTS5_DEFAULT_NEAR
 10

	)

88 
	#TOKEN_EOF
 0

	)

89 
	#TOKEN_PRIMITIVE
 1

	)

90 
	#TOKEN_STAR
 2

	)

91 
	#TOKEN_PLUS
 3

	)

92 
	#TOKEN_NEAR
 4

	)

93 
	#TOKEN_COLON
 5

	)

94 
	#TOKEN_NOT
 6

	)

95 
	#TOKEN_AND
 7

	)

96 
	#TOKEN_OR
 8

	)

97 
	#TOKEN_LP
 9

	)

98 
	#TOKEN_RP
 10

	)

106 
	sFts5Tokíizî
 {

107 *
	mzName
;

108 *
	mpCtx
;

109 (*
	mxCª©e
)(*, c⁄° **, , 
	msqlôe4_tokíizî
**);

110 (*
	mxTokíize
)(*, 
	msqlôe4_tokíizî
*,

111 c⁄° *, , (*
	mx
)(*, , , const *, , , )

113 (*
	mxDe°roy
)(
	msqlôe4_tokíizî
 *);

114 
Fts5Tokíizî
 *
	mpNext
;

123 
	sFts5Index
 {

124 
	mnTokíizî
;

125 **
	mazTokíizî
;

148 
Fts5Ex¥
 
	tFts5Ex¥
;

149 
Fts5Ex¥Node
 
	tFts5Ex¥Node
;

150 
Fts5Li°
 
	tFts5Li°
;

151 
Fts5M©chIãr
 
	tFts5M©chIãr
;

152 
Fts5P¨£r
 
	tFts5P¨£r
;

153 
Fts5P¨£rTokí
 
	tFts5P¨£rTokí
;

154 
Fts5Phø£
 
	tFts5Phø£
;

155 
Fts5Pªfix
 
	tFts5Pªfix
;

156 
Fts5Size
 
	tFts5Size
;

157 
Fts5Så
 
	tFts5Så
;

158 
Fts5Tokí
 
	tFts5Tokí
;

161 
	sFts5P¨£rTokí
 {

162 
	meTy≥
;

163 
	mn
;

164 c⁄° *
	mz
;

167 
	sFts5P¨£r
 {

168 
Fts5Tokíizî
 *
	mpTokíizî
;

169 
sqlôe4_tokíizî
 *
	mp
;

170 
sqlôe4
 *
	mdb
;

172 *
	mzEº
;

174 c⁄° *
	mzEx¥
;

175 
	miEx¥
;

176 
Fts5P¨£rTokí
 
	m√xt
;

178 **
	mazCﬁ
;

179 
	mnCﬁ
;

180 
	miRoŸ
;

183 *
	maS∑˚
;

184 
	miS∑˚
;

185 
	mnS∑˚
;

188 
	sFts5Li°
 {

189 
u8
 *
	maD©a
;

190 
	mnD©a
;

193 
	sFts5Pªfix
 {

194 
u8
 *
	maPk
;

195 
	mnPk
;

196 
Fts5Pªfix
 *
	mpNext
;

197 
u8
 *
	maLi°
;

198 
	mnLi°
;

199 
	mnAŒoc
;

202 
	sFts5Tokí
 {

205 
	mbPªfix
;

206 
	mn
;

207 *
	mz
;

209 
KVByãAºay
 *
	maPªfix
;

210 
KVSize
 
	mnPªfix
;

211 
KVCurs‹
 *
	mpC§
;

212 
Fts5Pªfix
 *
	mpPªfix
;

215 
	sFts5Så
 {

216 
Fts5Tokí
 *
	maTokí
;

217 
	mnTokí
;

218 
u8
 *
	maLi°
;

219 
	mnLi°
;

220 
	mnLi°AŒoc
;

223 
	sFts5Phø£
 {

224 
	miCﬁ
;

225 
	mnSå
;

226 
Fts5Så
 *
	maSå
;

227 *
	maiNór
;

230 
	sFts5Ex¥Node
 {

231 
	meTy≥
;

232 
Fts5Phø£
 *
	mpPhø£
;

233 
Fts5Ex¥Node
 *
	mpLe·
;

234 
Fts5Ex¥Node
 *
	mpRight
;

235 c⁄° 
u8
 *
	maPk
;

236 
	mnPk
;

239 
	sFts5Ex¥
 {

240 
Fts5Ex¥Node
 *
	mpRoŸ
;

241 
	mnPhø£
;

242 
Fts5Så
 **
	m≠Phø£
;

248 
	sFts5Curs‹
 {

249 
sqlôe4
 *
	mdb
;

250 
Fts5Info
 *
	mpInfo
;

251 
Fts5Ex¥
 *
	mpEx¥
;

252 *
	mzEx¥
;

253 
KVByãAºay
 *
	maKey
;

254 
	mnKeyAŒoc
;

256 
KVCurs‹
 *
	mpC§
;

257 
Mem
 *
	maMem
;

258 
	mbMemVÆid
;

260 
Fts5Size
 *
	mpSz
;

261 
Fts5Size
 *
	mpGlobÆ
;

262 
i64
 
	mnGlobÆ
;

265 *
	m™RowCS
;

266 *
	m™RowC
;

267 *
	m™RowS
;

268 *
	m™Row
;

270 
Fts5M©chIãr
 *
	mpIãr
;

276 
	sFts5Size
 {

277 
	mnCﬁ
;

278 
	mnSåóm
;

279 
i64
 *
	maSz
;

285 
In°™˚Li°
 
	tIn°™˚Li°
;

286 
	sIn°™˚Li°
 {

287 
u8
 *
	maLi°
;

288 
	mnLi°
;

289 
	miLi°
;

292 
	miCﬁ
;

293 
	miSåóm
;

294 
	miOff
;

301 
	sFts5M©chIãr
 {

302 
	mbVÆid
;

303 
	miCuºít
;

304 
	miM©ch
;

305 
In°™˚Li°
 *
	maLi°
;

311 
	$·s5In°™˚Li°Next
(
In°™˚Li°
 *
p
){

312 
i
 = 
p
->
iLi°
;

313 
bRë
 = 1;

315  
bRë
 && 
i
<
p
->
nLi°
 ){

316 
u32
 
iVÆ
;

317 
i
 +
	`gëV¨öt32
(&
p
->
aLi°
[i], 
iVÆ
);

318 if–(
iVÆ
 & 0x03)==0x01 ){

319 
p
->
iCﬁ
 = (
iVÆ
>>2);

320 
p
->
iOff
 = 0;

322 if–(
iVÆ
 & 0x03)==0x03 ){

323 
p
->
iSåóm
 = (
iVÆ
>>2);

326 
p
->
iOff
 +(
iVÆ
>>1);

327 
bRë
 = 0;

330 if–
bRë
 ){

331 
p
->
aLi°
 = 0;

334 
p
->
iLi°
 = 
i
;

335  
bRë
;

336 
	}
}

338 
	$·s5In°™˚Li°Eof
(
In°™˚Li°
 *
p
){

339  (
p
->
aLi°
==0);

340 
	}
}

342 
	$·s5In°™˚Li°Aµíd
(

343 
In°™˚Li°
 *
p
,

344 
iCﬁ
,

345 
iSåóm
,

346 
iOff


348 
	`as£π
–
iCﬁ
>=
p
->iCol );

349 
	`as£π
–
iCﬁ
>
p
->iCﬁ || 
iOff
>=p->iOff );

351 if–
iCﬁ
!=
p
->iCol ){

352 
p
->
iLi°
 +
	`putV¨öt32
(&p->
aLi°
[p->iLi°], (
iCﬁ
<<2)|0x01);

353 
p
->
iCﬁ
 = iCol;

354 
p
->
iOff
 = 0;

357 if–
iSåóm
!=
p
->iStream ){

358 
p
->
iLi°
 +
	`putV¨öt32
(&p->
aLi°
[p->iLi°], (
iSåóm
<<2)|0x03);

359 
p
->
iSåóm
 = iStream;

362 
p
->
iLi°
 +
	`putV¨öt32
(&p->
aLi°
[p->iLi°], (
iOff
-p->iOff)<<1);

363 
p
->
iOff
 = iOff;

365 
	`as£π
–
p
->
iLi°
<ı->
nLi°
 );

366 
	}
}

368 
	$·s5In°™˚Li°Inô
(
u8
 *
aLi°
, 
nLi°
, 
In°™˚Li°
 *
p
){

369 
	`mem£t
(
p
, 0, (
In°™˚Li°
));

370 
p
->
aLi°
 =áList;

371 
p
->
nLi°
 =ÇList;

372 
	}
}

378 
	$·s5IsS≥cül
(
c
){

379  (
c
==':' || c=='(' || c==')' || c=='+' || c=='"' || c=='*');

380 
	}
}

382 
	$·s5NextTokí
(

383 
Fts5P¨£r
 *
pP¨£
,

384 
Fts5P¨£rTokí
 *
p


386 c⁄° *
z
 = 
pP¨£
->
zEx¥
;

387 
c
;

389 
	`mem£t
(
p
, 0, (
Fts5P¨£rTokí
));

392  
	`sqlôe4Is•a˚
(
z
[
pP¨£
->
iEx¥
]) )ÖParse->iExpr++;

394 
c
 = 
z
[
pP¨£
->
iEx¥
];

395 if–
c
=='\0' ){

396 
p
->
eTy≥
 = 
TOKEN_EOF
;

399 if–
c
=='(' ){

400 
pP¨£
->
iEx¥
++;

401 
p
->
eTy≥
 = 
TOKEN_LP
;

404 if–
c
==')' ){

405 
pP¨£
->
iEx¥
++;

406 
p
->
eTy≥
 = 
TOKEN_RP
;

409 if–
c
==':' ){

410 
pP¨£
->
iEx¥
++;

411 
p
->
eTy≥
 = 
TOKEN_COLON
;

414 if–
c
=='+' ){

415 
pP¨£
->
iEx¥
++;

416 
p
->
eTy≥
 = 
TOKEN_PLUS
;

419 if–
c
=='*' ){

420 
pP¨£
->
iEx¥
++;

421 
p
->
eTy≥
 = 
TOKEN_STAR
;

424 if–
c
=='"' ){

425 *
zOut
 = &
pP¨£
->
aS∑˚
[pP¨£->
iS∑˚
];

426 c⁄° *
zPrimôive
 = 
zOut
;

427 
i
 = 
pP¨£
->
iEx¥
+1;

429  
z
[
i
] ){

430 if–
z
[
i
]=='"' ){

431 if–
z
[
i
+1]=='"' ){

432 
i
++;

437 *
zOut
++ = 
z
[
i
];

438 
i
++;

440 if–
z
[
i
]!='"' ){

442  
SQLITE4_ERROR
;

445 
pP¨£
->
iEx¥
 = 
i
+1;

446 
p
->
eTy≥
 = 
TOKEN_PRIMITIVE
;

447 
p
->
z
 = 
zPrimôive
;

448 
p
->
n
 = (
zOut
 - 
zPrimôive
);

449 
pP¨£
->
iS∑˚
 +(
zOut
 - 
zPrimôive
);

453 c⁄° *
zPrimôive
 = &
z
[
pP¨£
->
iEx¥
];

454 
n
 = 0;

455  
zPrimôive
[
n
]

456 && 
	`·s5IsS≥cül
(
zPrimôive
[
n
])==0

457 && 
	`sqlôe4Is•a˚
(
zPrimôive
[
n
])==0

459 
n
++;

461 
pP¨£
->
iEx¥
 +
n
;

463 if–
n
>=4 && 
	`memcmp
(
zPrimôive
, "NEAR", 4)==0 ){

464 
nNór
 = 
FTS5_DEFAULT_NEAR
;

465 if–
n
>4 ){

466 
i
;

467 
nNór
 = 0;

468 
i
=5; i<
n
; i++){

469 if–!
	`sqlôe4Isdigô
(
zPrimôive
[
i
]) ) ;

470 
nNór
 =ÇNór*10 + 
zPrimôive
[
i
]-'0';

472 if–
n
<6 || 
zPrimôive
[4]!='/' || 
i
<n ){

473  
SQLITE4_ERROR
;

476 
p
->
eTy≥
 = 
TOKEN_NEAR
;

477 
p
->
n
 = 
nNór
;

478 
p
->
z
 = 0;

479 }if–
n
==3 && 
	`memcmp
(
zPrimôive
, "NOT", 3)==0 ){

480 
p
->
eTy≥
 = 
TOKEN_NOT
;

482 if–
n
==2 && 
	`memcmp
(
zPrimôive
, "OR", 2)==0 ){

483 
p
->
eTy≥
 = 
TOKEN_OR
;

485 if–
n
==3 && 
	`memcmp
(
zPrimôive
, "AND", 3)==0 ){

486 
p
->
eTy≥
 = 
TOKEN_AND
;

488 
p
->
eTy≥
 = 
TOKEN_PRIMITIVE
;

489 
p
->
z
 = 
zPrimôive
;

490 
p
->
n
 =Ç;

494  
SQLITE4_OK
;

495 
	}
}

497 
	$·s5NextTokí2
(

498 
Fts5P¨£r
 *
pP¨£
,

499 
Fts5P¨£rTokí
 *
p


501 
rc
 = 
SQLITE4_OK
;

502 if–
pP¨£
->
iEx¥
==0 ){

503 
rc
 = 
	`·s5NextTokí
(
pP¨£
, 
p
);

505 *
p
 = 
pP¨£
->
√xt
;

508 if–
rc
==
SQLITE4_OK
 && 
p
->
eTy≥
!=
TOKEN_EOF
 ){

509 
rc
 = 
	`·s5NextTokí
(
pP¨£
, &pP¨£->
√xt
);

512  
rc
;

513 
	}
}

515 
	$·s5Phø£NewSå
(

516 
Fts5P¨£r
 *
pP¨£
,

517 
Fts5Phø£
 *
pPhø£
,

518 
nNór


520 c⁄° 
nIn¸
 = 4;

522 if–(
pPhø£
->
nSå
 % 
nIn¸
)==0 ){

523 
Fts5Så
 *
aNew
;

524 
aNew
 = (
Fts5Så
 *)
	`sqlôe4DbRóŒoc
(
pP¨£
->
db
,

525 
pPhø£
->
aSå
, (pPhø£->
nSå
+
nIn¸
)*(
Fts5Så
)

527 if–!
aNew
 )  
SQLITE4_NOMEM
;

528 
	`mem£t
(&
aNew
[
pPhø£
->
nSå
], 0, 
nIn¸
*(
Fts5Så
));

529 
pPhø£
->
aSå
 = 
aNew
;

531 if–
pPhø£
->
nSå
>0 ){

532 if–((
pPhø£
->
nSå
-1Ë% 
nIn¸
)==0 ){

533 *
aNew
;

534 
aNew
 = (*)
	`sqlôe4DbRóŒoc
(
pP¨£
->
db
,

535 
pPhø£
->
aiNór
, (pPhø£->
nSå
+
nIn¸
-1)*()

537 if–!
aNew
 )  
SQLITE4_NOMEM
;

538 
pPhø£
->
aiNór
 = 
aNew
;

540 
pPhø£
->
aiNór
[pPhø£->
nSå
-1] = 
nNór
;

543 
pPhø£
->
nSå
++;

544  
SQLITE4_OK
;

545 
	}
}

550 
	$·s5Cou¡TokísCb
(

551 *
pCtx
,

552 
iSåóm
,

553 
iOff
,

554 c⁄° *
z
, 
n
,

555 
iSrc
, 
nSrc


557 (*((*)
pCtx
))++;

559 
	}
}

566 
	$·s5Cou¡Tokís
(

567 
Fts5Tokíizî
 *
pTokíizî
,

568 
sqlôe4_tokíizî
 *
p
,

569 c⁄° *
zDoc
,

570 
nDoc
,

571 *
≤Tokí


573 
nTokí
 = 0;

574 
rc
;

575 
rc
 = 
pTokíizî
->
	`xTokíize
((*)&
nTokí
, 
p
, 
zDoc
, 
nDoc
, 
·s5Cou¡TokísCb
);

576 *
≤Tokí
 = 
nTokí
;

577  
rc
;

578 
	}
}

580 
	sAµídTokísCtx
 {

581 
Fts5P¨£r
 *
	mpP¨£
;

582 
Fts5Så
 *
	mpSå
;

585 
	$·s5AµídTokísCb
(

586 *
pCtx
,

587 
iSåóm
,

588 
iOff
,

589 c⁄° *
z
, 
n
,

590 
iSrc
, 
nSrc


592 
AµídTokísCtx
 *
p
 = (AµídTokísCtx *)
pCtx
;

593 
Fts5P¨£r
 *
pP¨£
 = 
p
->pParse;

594 
Fts5Tokí
 *
pTokí
;

595 *
zS∑˚
;

596 
nU£d
;

598 
pTokí
 = &
p
->
pSå
->
aTokí
[p->pSå->
nTokí
];

600 
zS∑˚
 = &
pP¨£
->
aS∑˚
[pP¨£->
iS∑˚
];

601 
nU£d
 = 
	`putV¨öt32
((
u8
 *)
zS∑˚
, 
pP¨£
->
iRoŸ
);

602 
zS∑˚
[
nU£d
++] = 0x24;

603 
pTokí
->
bPªfix
 = 0;

604 
pTokí
->
pPªfix
 = 0;

605 
pTokí
->
z
 = &
zS∑˚
[
nU£d
];

606 
pTokí
->
n
 =Ç;

607 
	`mem˝y
(
pTokí
->
z
, z, 
n
);

608 
pTokí
->
z
[
n
] = '\0';

610 
nU£d
 +(
n
+1);

611 
pTokí
->
aPªfix
 = (
u8
 *)
zS∑˚
;

612 
pTokí
->
nPªfix
 = 
nU£d
;

613 
pTokí
->
pC§
 = 0;

614 
pP¨£
->
iS∑˚
 +
nU£d
;

615 
p
->
pSå
->
nTokí
++;

617 
	`as£π
–
pP¨£
->
iS∑˚
<ıP¨£->
nS∑˚
 );

619 
	}
}

621 
	$·s5AµídTokís
(

622 
Fts5P¨£r
 *
pP¨£
,

623 
Fts5Så
 *
pSå
, c⁄° *
zPrim
,

624 
nPrim


626 
AµídTokísCtx
 
˘x
;

627 
˘x
.
pP¨£
 =ÖParse;

628 
˘x
.
pSå
 =ÖStr;

630  
pP¨£
->
pTokíizî
->
	`xTokíize
(

631 (*)&
˘x
, 
pP¨£
->
p
 , 
zPrim
, 
nPrim
, 
·s5AµídTokísCb


633 
	}
}

638 
	$·s5Phø£Aµíd
(

639 
Fts5P¨£r
 *
pP¨£
,

640 
Fts5Phø£
 *
pPhø£
,

641 c⁄° *
zPrim
,

642 
nPrim


644 
Fts5Tokíizî
 *
pTok
 = 
pP¨£
->
pTokíizî
;

645 
nTokí
;

646 
rc
;

648 
rc
 = 
	`·s5Cou¡Tokís
(
pTok
, 
pP¨£
->
p
, 
zPrim
, 
nPrim
, &
nTokí
);

649 if–
rc
==
SQLITE4_OK
 && 
nTokí
>0 ){

651 
Fts5Så
 *
pSå
 = &
pPhø£
->
aSå
[pPhø£->
nSå
-1];

653 
pSå
->
aTokí
 = 
	`sqlôe4DbRóŒocOrFªe
(
pP¨£
->
db
,ÖStr->aToken,

654 (
pSå
->
nTokí
 +ÇTokíË* (
Fts5Tokí
)

656 if–!
pSå
->
aTokí
 ){

657 
rc
 = 
SQLITE4_NOMEM
;

659 
rc
 = 
	`·s5AµídTokís
(
pP¨£
, 
pSå
, 
zPrim
, 
nPrim
);

663  
rc
;

664 
	}
}

666 
	$·s5Phø£AµídSèr
(

667 
Fts5P¨£r
 *
pP¨£
,

668 
Fts5Phø£
 *
pPhø£


670 
Fts5Så
 *
pSå
 = &
pPhø£
->
aSå
[pPhø£->
nSå
-1];

671 
Fts5Tokí
 *
p
 = &
pSå
->
aTokí
[pSå->
nTokí
-1];

673 if–
p
->
bPªfix
 ){

674  
SQLITE4_ERROR
;

676 
p
->
bPªfix
 = 1;

677 
p
->
nPªfix
--;

678  
SQLITE4_OK
;

679 
	}
}

681 
	$·s5Phø£Fªe
(
sqlôe4
 *
db
, 
Fts5Phø£
 *
p
){

682 if–
p
 ){

683 
i
;

684 
i
=0; i<
p
->
nSå
; i++){

685 
iTok
;

686 
iTok
=0; iTok<
p
->
aSå
[
i
].
nTokí
; iTok++){

687 
	`sqlôe4KVCurs‹Clo£
(
p
->
aSå
[
i
].
aTokí
[
iTok
].
pC§
);

689 
	`sqlôe4DbFªe
(
db
, 
p
->
aSå
[
i
].
aTokí
);

690 
	`sqlôe4DbFªe
(
db
, 
p
->
aSå
[
i
].
aLi°
);

692 
	`sqlôe4DbFªe
(
db
, 
p
->
aiNór
);

693 
	`sqlôe4DbFªe
(
db
, 
p
->
aSå
);

694 
	`sqlôe4DbFªe
(
db
, 
p
);

696 
	}
}

698 
	$·s5NextTokíOrPhø£
(

699 
Fts5P¨£r
 *
pP¨£
,

700 *
≥Ty≥
,

701 
Fts5Phø£
 **
µPhø£


703 
rc
;

704 
Fts5Phø£
 *
pPhø£
 = 0;

705 
Fts5P¨£rTokí
 
t
;

707 
rc
 = 
	`·s5NextTokí2
(
pP¨£
, &
t
);

708 *
≥Ty≥
 = 
t
.
eTy≥
;

709 if–
rc
==
SQLITE4_OK
 && 
t
.
eTy≥
==
TOKEN_PRIMITIVE
 ){

712 
pPhø£
 = 
	`sqlôe4DbMÆlocZîo
(
pP¨£
->
db
, (
Fts5Phø£
));

713 if–
pPhø£
==0 ){

714 
rc
 = 
SQLITE4_NOMEM
;

715 
tokí_‹_phø£_out
;

717 
pPhø£
->
iCﬁ
 = -1;

720 if–
pP¨£
->
√xt
.
eTy≥
==
TOKEN_COLON
 ){

721 
iCﬁ
;

722 
iCﬁ
=0; iCﬁ<
pP¨£
->
nCﬁ
; iCol++){

723 if–
	`sqlôe4_°∫icmp
(
pP¨£
->
azCﬁ
[
iCﬁ
], 
t
.
z
,Å.
n
)==0 ) ;

725 if–
iCﬁ
==
pP¨£
->
nCﬁ
 ){

726 
pP¨£
->
zEº
 = 
	`sqlôe4MPrötf
’P¨£->
db
,

727 "·s5:Çÿsuch cﬁumn: %.*s", 
t
.
n
,Å.
z


729 
rc
 = 
SQLITE4_ERROR
;

730 
tokí_‹_phø£_out
;

732 
pPhø£
->
iCﬁ
 = iCol;

734 
rc
 = 
	`·s5NextTokí2
(
pP¨£
, &
t
);

735 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s5NextTokí2
(
pP¨£
, &
t
);

736 if–
rc
==
SQLITE4_OK
 && 
t
.
eTy≥
!=
TOKEN_PRIMITIVE
 ){

737 
rc
 = 
SQLITE4_ERROR
;

739 if–
rc
!=
SQLITE4_OK
 ) 
tokí_‹_phø£_out
;

744 
rc
 = 
	`·s5Phø£NewSå
(
pP¨£
, 
pPhø£
, 0);

745 if–
rc
==
SQLITE4_OK
 ){

746 
rc
 = 
	`·s5Phø£Aµíd
(
pP¨£
, 
pPhø£
, 
t
.
z
,Å.
n
);

748 if–
rc
==
SQLITE4_OK
 && 
pP¨£
->
√xt
.
eTy≥
==
TOKEN_STAR
 ){

749 
	`·s5NextTokí2
(
pP¨£
, &
t
);

750 
rc
 = 
	`·s5Phø£AµídSèr
(
pP¨£
, 
pPhø£
);

754  
rc
==
SQLITE4_OK
 &&

755 (
pP¨£
->
√xt
.
eTy≥
==
TOKEN_PLUS
 ||ÖP¨£->√xt.eTy≥==
TOKEN_NEAR
)

757 
rc
 = 
	`·s5NextTokí2
(
pP¨£
, &
t
);

758 if–
rc
==
SQLITE4_OK
 ){

759 if–
t
.
eTy≥
==
TOKEN_NEAR
 ){

760 
rc
 = 
	`·s5Phø£NewSå
(
pP¨£
, 
pPhø£
, 
t
.
n
);

761 if–
rc
!=
SQLITE4_OK
 ) 
tokí_‹_phø£_out
;

763 
rc
 = 
	`·s5NextTokí2
(
pP¨£
, &
t
);

764 if–
rc
!=
SQLITE4_OK
 ) 
tokí_‹_phø£_out
;

765 if–
t
.
eTy≥
!=
TOKEN_PRIMITIVE
 ){

766 
rc
 = 
SQLITE4_ERROR
;

768 
rc
 = 
	`·s5Phø£Aµíd
(
pP¨£
, 
pPhø£
, 
t
.
z
,Å.
n
);

769 if–
rc
==
SQLITE4_OK
 && 
pP¨£
->
√xt
.
eTy≥
==
TOKEN_STAR
 ){

770 
	`·s5NextTokí2
(
pP¨£
, &
t
);

771 
rc
 = 
	`·s5Phø£AµídSèr
(
pP¨£
, 
pPhø£
);

778 
tokí_‹_phø£_out
:

779 if–
rc
!=
SQLITE4_OK
 ){

780 
	`·s5Phø£Fªe
(
pP¨£
->
db
, 
pPhø£
);

782 *
µPhø£
 = 
pPhø£
;

784  
rc
;

785 
	}
}

787 
	$·s5FªeEx¥Node
(
sqlôe4
 *
db
, 
Fts5Ex¥Node
 *
pNode
){

788 if–
pNode
 ){

789 
	`·s5Phø£Fªe
(
db
, 
pNode
->
pPhø£
);

790 
	`·s5FªeEx¥Node
(
db
, 
pNode
->
pLe·
);

791 
	`·s5FªeEx¥Node
(
db
, 
pNode
->
pRight
);

792 
	`sqlôe4DbFªe
(
db
, 
pNode
);

794 
	}
}

796 
	$·s5Ex¥essi⁄Fªe
(
sqlôe4
 *
db
, 
Fts5Ex¥
 *
pEx¥
){

797 if–
pEx¥
 ){

798 
	`·s5FªeEx¥Node
(
db
, 
pEx¥
->
pRoŸ
);

799 
	`sqlôe4DbFªe
(
db
, 
pEx¥
->
≠Phø£
);

800 
	`sqlôe4DbFªe
(
db
, 
pEx¥
);

802 
	}
}

804 
Ex¥Hõr
 
	tEx¥Hõr
;

805 
	sEx¥Hõr
 {

806 
Fts5Ex¥Node
 **
	mµNode
;

807 
	mnO≥n
;

810 
	$·s5GrowEx¥Hõr
(

811 
sqlôe4
 *
db
,

812 *
≤AŒoc
,

813 
Ex¥Hõr
 **
∑Hõr
,

814 
nReq


816 
rc
 = 
SQLITE4_OK
;

817 
nAŒoc
 = *
≤AŒoc
;

818 if–
nAŒoc
<
nReq
 ){

819 
Ex¥Hõr
 *
aNew
;

820 
nAŒoc
 += 8;

821 
aNew
 = (
Ex¥Hõr
 *)
	`sqlôe4DbRóŒocOrFªe
(

822 
db
, *
∑Hõr
, 
nAŒoc
*(
Ex¥Hõr
)

824 if–
aNew
==0 ) 
rc
 = 
SQLITE4_NOMEM
;

825 *
∑Hõr
 = 
aNew
;

827  
rc
;

828 
	}
}

830 
	$·s5AddBö¨y
(

831 
sqlôe4
 *
db
,

832 
eTy≥
,

833 *
≤Hõr
,

834 *
≤HõrAŒoc
,

835 
Ex¥Hõr
 **
∑Hõr


837 
Fts5Ex¥Node
 *
pNode
;

838 
Fts5Ex¥Node
 **
µ
;

839 
rc
;

841 
rc
 = 
	`·s5GrowEx¥Hõr
(
db
, 
≤HõrAŒoc
, 
∑Hõr
, *
≤Hõr
+1);

842 if–
rc
!=
SQLITE4_OK
 ) Ñc;

843 
pNode
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Fts5Ex¥Node
));

844 if–!
pNode
 )  
SQLITE4_NOMEM
;

845 
pNode
->
eTy≥
 =ÉType;

847 
µ
 = (*
∑Hõr
)[*
≤Hõr
-1].
µNode
;

848 
pNode
->
pLe·
 = *
µ
;

849 *
µ
 = 
pNode
;

850 (*
∑Hõr
)[*
≤Hõr
].
µNode
 = &
pNode
->
pRight
;

851 (*
∑Hõr
)[*
≤Hõr
].
nO≥n
 = 0;

852 (*
≤Hõr
)++;

854  
SQLITE4_OK
;

855 
	}
}

857 
	$·s5FödSåögs
(
Fts5Ex¥Node
 *
p
, 
Fts5Så
 ***
∑pSå
){

858 if–
p
 ){

859 if–
p
->
eTy≥
==
TOKEN_PRIMITIVE
 ){

860 
i
;

861 
Fts5Så
 *
aSå
 = 
p
->
pPhø£
->aStr;

862 
i
=0; i<
p
->
pPhø£
->
nSå
; i++){

863 **
∑pSå
 = &
aSå
[
i
];

864 (*
∑pSå
)++;

867 
	`·s5FödSåögs
(
p
->
pLe·
, 
∑pSå
);

868 
	`·s5FödSåögs
(
p
->
pRight
, 
∑pSå
);

870 
	}
}

872 
	$·s5P¨£Ex¥essi⁄
(

873 
sqlôe4
 *
db
,

874 
Fts5Tokíizî
 *
pTokíizî
,

875 
sqlôe4_tokíizî
 *
p
,

876 
iRoŸ
,

877 **
azCﬁ
,

878 
nCﬁ
,

879 c⁄° *
zEx¥
,

880 
Fts5Ex¥
 **
µEx¥
,

881 **
pzEº


883 
rc
 = 
SQLITE4_OK
;

884 
Fts5P¨£r
 
sP¨£
;

885 
nSå
 = 0;

886 
nEx¥
;

887 
i
;

888 
Fts5Ex¥
 *
pEx¥
;

890 
nHõr
 = 0;

891 
nHõrAŒoc
 = 0;

892 
Ex¥Hõr
 *
aHõr
 = 0;

894 
nEx¥
 = 
	`sqlôe4SåÀn30
(
zEx¥
);

895 
	`mem£t
(&
sP¨£
, 0, (
Fts5P¨£r
));

896 
sP¨£
.
zEx¥
 = zExpr;

897 
sP¨£
.
azCﬁ
 =ázCol;

898 
sP¨£
.
nCﬁ
 =ÇCol;

899 
sP¨£
.
pTokíizî
 =ÖTokenizer;

900 
sP¨£
.
p
 =Ö;

901 
sP¨£
.
db
 = db;

902 
sP¨£
.
iRoŸ
 = iRoot;

904 
pEx¥
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Fts5Ex¥
Ë+ 
nEx¥
*4);

905 if–!
pEx¥
 )  
SQLITE4_NOMEM
;

906 
sP¨£
.
aS∑˚
 = (*)&
pEx¥
[1];

907 
sP¨£
.
nS∑˚
 = 
nEx¥
*4;

909 
rc
 = 
	`·s5GrowEx¥Hõr
(
db
, &
nHõrAŒoc
, &
aHõr
, 1);

910 if–
rc
==
SQLITE4_OK
 ){

911 
aHõr
[0].
µNode
 = &
pEx¥
->
pRoŸ
;

912 
aHõr
[0].
nO≥n
 = 0;

913 
nHõr
 = 1;

916  
rc
==
SQLITE4_OK
 ){

917 
eTy≥
 = 0;

918 
Fts5Phø£
 *
pPhø£
 = 0;

919 
Fts5Ex¥Node
 *
pNode
 = 0;

921 
rc
 = 
	`·s5NextTokíOrPhø£
(&
sP¨£
, &
eTy≥
, &
pPhø£
);

922 if–
rc
!=
SQLITE4_OK
 || 
eTy≥
==
TOKEN_EOF
 ) ;

924  
eTy≥
 ){

925 
TOKEN_PRIMITIVE
: {

926 
Fts5Ex¥Node
 **
µ
 = 
aHõr
[
nHõr
-1].
µNode
;

927 if–*
µ
 ){

928 
rc
 = 
	`·s5AddBö¨y
(
db
, 
TOKEN_AND
, &
nHõr
, &
nHõrAŒoc
, &
aHõr
);

929 
µ
 = 
aHõr
[
nHõr
-1].
µNode
;

931 if–
rc
==
SQLITE4_OK
 ){

932 
pNode
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Fts5Ex¥Node
));

933 if–
pNode
==0 ){

934 
rc
 = 
SQLITE4_NOMEM
;

936 
pNode
->
eTy≥
 = 
TOKEN_PRIMITIVE
;

937 
pNode
->
pPhø£
 =ÖPhrase;

938 *
µ
 = 
pNode
;

941 
nSå
 +
pPhø£
->nStr;

945 
TOKEN_AND
:

946 
TOKEN_OR
:

947 
TOKEN_NOT
: {

948 
Fts5Ex¥Node
 **
µ
 = 
aHõr
[
nHõr
-1].
µNode
;

950 if–*
µ
==0 ){

951 
rc
 = 
SQLITE4_ERROR
;

953  
nHõr
>1

954 && 
aHõr
[
nHõr
-1].
nO≥n
==0

955 && (*
aHõr
[
nHõr
-2].
µNode
)->
eTy≥
 <ÉType

957 
nHõr
--;

960 
rc
 = 
	`·s5AddBö¨y
(
db
, 
eTy≥
, &
nHõr
, &
nHõrAŒoc
, &
aHõr
);

965 
TOKEN_LP
: {

966 
Fts5Ex¥Node
 **
µ
 = 
aHõr
[
nHõr
-1].
µNode
;

967 if–*
µ
 ){

968 
rc
 = 
SQLITE4_ERROR
;

970 
aHõr
[
nHõr
-1].
nO≥n
++;

975 
TOKEN_RP
: {

976 
Fts5Ex¥Node
 **
µ
 = 
aHõr
[
nHõr
-1].
µNode
;

977 if–*
µ
==0 ){

978 
rc
 = 
SQLITE4_ERROR
;

980 
i
=
nHõr
-1; i>=0; i--){

981 if–
aHõr
[
i
].
nO≥n
>0 ) ;

983 if–
i
<0 ){

984 
rc
 = 
SQLITE4_ERROR
;

986 
aHõr
[
i
].
nO≥n
--;

987 
nHõr
 = 
i
+1;

994 
rc
 = 
SQLITE4_ERROR
;

998 if–
rc
!=
SQLITE4_OK
 ){

999 
	`sqlôe4DbFªe
(
db
, 
pNode
);

1004 if–
rc
==
SQLITE4_OK
 && *
aHõr
[
nHõr
-1].
µNode
==0 ){

1005 
rc
 = 
SQLITE4_ERROR
;

1007 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nHõr
; i++){

1008 if–
aHõr
[
i
].
nO≥n
>0 ) 
rc
 = 
SQLITE4_ERROR
;

1011 if–
rc
==
SQLITE4_OK
 ){

1012 
pEx¥
->
nPhø£
 = 
nSå
;

1013 
pEx¥
->
≠Phø£
 = (
Fts5Så
**)
	`sqlôe4DbMÆlocZîo
(
db
, (Fts5Så*)*
nSå
);

1014 if–
pEx¥
->
≠Phø£
==0 ){

1015 
rc
 = 
SQLITE4_NOMEM
;

1017 
Fts5Så
 **
a
 = 
pEx¥
->
≠Phø£
;

1018 
	`·s5FödSåögs
(
pEx¥
->
pRoŸ
, &
a
);

1022 if–
rc
!=
SQLITE4_OK
 ){

1023 
	`·s5Ex¥essi⁄Fªe
(
db
, 
pEx¥
);

1024 *
pzEº
 = 
sP¨£
.
zEº
;

1025 
pEx¥
 = 0;

1027 *
µEx¥
 = 
pEx¥
;

1028 
	`sqlôe4DbFªe
(
db
, 
aHõr
);

1029  
rc
;

1030 
	}
}

1036 
Fts5Tokíizî
 *
	$·s5FödTokíizî
(
sqlôe4
 *
db
, c⁄° *
zName
){

1037 
Fts5Tokíizî
 *
p
;

1038 
p
=
db
->
pTokíizî
;Ö;Öı->
pNext
){

1039 if–0==
	`sqlôe4_°ricmp
(
zName
, 
p
->zName) ) ;

1041  
p
;

1042 
	}
}

1044 
	$·s5TokíizîCª©e
(

1045 
P¨£
 *
pP¨£
,

1046 
Fts5Index
 *
pFts
,

1047 
Fts5Tokíizî
 **
µTokíizî
,

1048 
sqlôe4_tokíizî
 **
µ


1050 
Fts5Tokíizî
 *
pTok
;

1051 *
zTok
;

1052 c⁄° **
azArg
;

1053 
nArg
;

1055 if–
pFts
->
nTokíizî
 ){

1056 
zTok
 = 
pFts
->
azTokíizî
[0];

1057 
azArg
 = (c⁄° **)&
pFts
->
azTokíizî
[1];

1058 
nArg
 = 
pFts
->
nTokíizî
-1;

1060 
zTok
 = "simple";

1061 
azArg
 = 0;

1062 
nArg
 = 0;

1065 *
µTokíizî
 = 
pTok
 = 
	`·s5FödTokíizî
(
pP¨£
->
db
, 
zTok
);

1066 if–!
pTok
 ){

1067 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuchÅokíizî: \"%s\"", 
zTok
);

1069 
rc
 = 
pTok
->
	`xCª©e
’Tok->
pCtx
, 
azArg
, 
nArg
, 
µ
);

1070 if–
rc
!=
SQLITE4_OK
 ){

1071 
	`as£π
–*
µ
==0 );

1072 
	`sqlôe4Eº‹Msg
(
pP¨£
, "error creatingÅokenizer");

1075 
	}
}

1077 
	$·s5TokíizîDe°roy
(
Fts5Tokíizî
 *
pTok
, 
sqlôe4_tokíizî
 *
p
){

1078 if–
p
 ) 
pTok
->
	`xDe°roy
(p);

1079 
	}
}

1081 
	$sqlôe4ShutdownFts5
(
sqlôe4
 *
db
){

1082 
Fts5Tokíizî
 *
p
;

1083 
Fts5Tokíizî
 *
pNext
;

1084 
p
=
db
->
pTokíizî
;Ö;Ö=
pNext
){

1085 
pNext
 = 
p
->pNext;

1086 
	`sqlôe4DbFªe
(
db
, 
p
);

1088 
	}
}

1093 
sqlôe4_¸óã_tokíizî
(

1094 
sqlôe4
 *
db
,

1095 c⁄° *
zName
,

1096 *
pCtx
,

1097 (*
xCª©e
)(*, c⁄° **, , 
sqlôe4_tokíizî
**),

1098 (*
xTokíize
)(*, 
sqlôe4_tokíizî
*,

1099 c⁄° *, , (*
x
)(*, , , const *, , , )

1101 (*
xDe°roy
)(
sqlôe4_tokíizî
 *)

1103 
rc
 = 
SQLITE4_OK
;

1104 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

1107 if–
	`·s5FödTokíizî
(
db
, 
zName
) ){

1108 
rc
 = 
SQLITE4_ERROR
;

1110 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

1111 
Fts5Tokíizî
 *
pTokíizî
 = (Fts5Tokíizî *)
	`sqlôe4DbMÆlocZîo
(
db
,

1112 (
Fts5Tokíizî
Ë+ 
nName
+1

1114 if–!
pTokíizî
 ){

1115 
rc
 = 
SQLITE4_NOMEM
;

1117 
pTokíizî
->
pCtx
 =ÖCtx;

1118 
pTokíizî
->
xCª©e
 = xCreate;

1119 
pTokíizî
->
xTokíize
 = xTokenize;

1120 
pTokíizî
->
xDe°roy
 = xDestroy;

1121 
pTokíizî
->
zName
 = (*)&pTokenizer[1];

1122 
	`mem˝y
(
pTokíizî
->
zName
, zName, 
nName
+1);

1124 
pTokíizî
->
pNext
 = 
db
->pTokenizer;

1125 
db
->
pTokíizî
 =ÖTokenizer;

1129 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

1130 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

1131  
rc
;

1132 
	}
}

1137 
	$sqlôe4Fts5IndexSz
(){

1138  (
Fts5Index
);

1139 
	}
}

1145 
	$sqlôe4Fts5IndexInô
(
P¨£
 *
pP¨£
, 
Index
 *
pIdx
, 
Ex¥Li°
 *
pArgs
){

1146 
Fts5Index
 *
pFts
 = 
pIdx
->pFts;

1148 if–
pArgs
 ){

1149 
i
;

1150 
i
=0; 
pP¨£
->
nEº
==0 && i<
pArgs
->
nEx¥
; i++){

1151 *
zArg
 = 
pArgs
->
a
[
i
].
zName
;

1152 *
zVÆ
 = 
pArgs
->
a
[
i
].
pEx¥
->
u
.
zTokí
;

1154 if–
zArg
 && 
	`sqlôe4_°ricmp
(zArg, "tokenizer")==0 ){

1159 
j
;

1160 *
pS∑˚
;

1161 
nByã
 = 
	`sqlôe4SåÀn30
(
zVÆ
) + 1;

1162 
j
=
i
+1; j<
pArgs
->
nEx¥
; j++){

1163 
Ex¥Li°Iãm
 *
pIãm
 = &
pArgs
->
a
[
j
];

1164 if–
pIãm
->
zName
 ) ;

1165 
nByã
 +
	`sqlôe4SåÀn30
(
pIãm
->
pEx¥
->
u
.
zTokí
) + 1;

1167 
nByã
 +(*Ë* (
j
-
i
);

1168 
pFts
->
azTokíizî
 = (**)
	`sqlôe4DbMÆlocZîo
(
pP¨£
->
db
, 
nByã
);

1169 if–
pFts
->
azTokíizî
==0 ) ;

1170 
pFts
->
nTokíizî
 = (
j
-
i
);

1172 
pS∑˚
 = (*)&
pFts
->
azTokíizî
[
j
-
i
];

1173 
j
=
i
; j<
pArgs
->
nEx¥
; j++){

1174 
Ex¥Li°Iãm
 *
pIãm
 = &
pArgs
->
a
[
j
];

1175 if–
pIãm
->
zName
 && 
j
>
i
 ){

1178 
nTokí
 = 
	`sqlôe4SåÀn30
(
pIãm
->
pEx¥
->
u
.
zTokí
);

1179 
	`mem˝y
(
pS∑˚
, 
pIãm
->
pEx¥
->
u
.
zTokí
, 
nTokí
+1);

1180 
pFts
->
azTokíizî
[
j
-
i
] = 
pS∑˚
;

1181 
pS∑˚
 +
nTokí
+1;

1190 if–
pP¨£
->
db
->
öô
.
busy
==0 ){

1191 
Fts5Tokíizî
 *
pTok
 = 0;

1192 
sqlôe4_tokíizî
 *
t
 = 0;

1194 
	`·s5TokíizîCª©e
(
pP¨£
, 
pFts
, &
pTok
, &
t
);

1195 
	`·s5TokíizîDe°roy
(
pTok
, 
t
);

1199 
	`sqlôe4Eº‹Msg
(
pP¨£
,"uƒecognizedárgumít: \"%s\"", 
zArg
?zArg:
zVÆ
);

1203 
	}
}

1205 
	$sqlôe4Fts5IndexFªe
(
sqlôe4
 *
db
, 
Index
 *
pIdx
){

1206 if–
pIdx
->
pFts
 ){

1207 
	`sqlôe4DbFªe
(
db
, 
pIdx
->
pFts
->
azTokíizî
);

1209 
	}
}

1226 
TokíizeCtx
 
	tTokíizeCtx
;

1227 
TokíizeTîm
 
	tTokíizeTîm
;

1228 
	sTokíizeCtx
 {

1229 
	mrc
;

1230 
	miCﬁ
;

1231 
	mnCﬁ
;

1232 
sqlôe4
 *
	mdb
;

1233 
	mnMax
;

1234 
i64
 *
	maSz
;

1235 
	mnSåóm
;

1236 
Hash
 
	mhash
;

1238 
	sTokíizeTîm
 {

1239 
	miSåóm
;

1240 
	miCﬁ
;

1241 
	miOff
;

1242 
	mnTokí
;

1243 
	mnD©a
;

1244 
	mnAŒoc
;

1247 
TokíizeTîm
 *
	$·s5TokíizeAµídI¡
(

1248 
TokíizeCtx
 *
p
,

1249 
TokíizeTîm
 *
pTîm
,

1250 
iVÆ


1252 *
a
;

1253 
nS∑˚
 = 
pTîm
->
nAŒoc
-pTîm->
nD©a
-pTîm->
nTokí
-(
TokíizeTîm
);

1255 if–
nS∑˚
 < 5 ){

1256 
nAŒoc
 = (
pTîm
->nAlloc<256) ? 256 :ÖTerm->nAlloc * 2;

1257 
pTîm
 = 
	`sqlôe4DbRóŒocOrFªe
(
p
->
db
,ÖTîm, 
nAŒoc
);

1258 if–!
pTîm
 )  0;

1259 
pTîm
->
nAŒoc
 = 
	`sqlôe4DbMÆlocSize
(
p
->
db
,ÖTerm);

1262 
a
 = &(((*)&
pTîm
[1])[pTîm->
nTokí
+pTîm->
nD©a
]);

1263 
pTîm
->
nD©a
 +
	`putV¨öt32
(
a
, 
iVÆ
);

1264  
pTîm
;

1265 
	}
}

1267 
	$·s5TokíizeCb
(

1268 *
pCtx
,

1269 
iSåóm
,

1270 
iOff
,

1271 c⁄° *
zTokí
,

1272 
nTokí
,

1273 
iSrc
,

1274 
nSrc


1276 
TokíizeCtx
 *
p
 = (TokíizeCtx *)
pCtx
;

1277 
sqlôe4
 *
db
 = 
p
->db;

1278 
TokíizeTîm
 *
pTîm
 = 0;

1282 if–
nTokí
>
p
->
nMax
 )Ö->nMax =ÇToken;

1284 if–
iSåóm
>=
p
->
nSåóm
 ){

1285 
iCﬁ
;

1286 
nOld
 = 
p
->
nSåóm
;

1287 
nNew
 = 4;

1288 
i64
 *
aNew
;

1290  
nNew
<=
iSåóm
 )ÇNew =ÇNew*2;

1291 
aNew
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nNew
*
p
->
nCﬁ
*(
i64
));

1292 if–
aNew
==0 ) 
tokíize_cb_out
;

1294 
iCﬁ
=0; iCﬁ<
p
->
nCﬁ
; iCol++){

1295 
iSå
;

1296 
iSå
=0; iSå<
nOld
; iStr++){

1297 
aNew
[
nNew
*
iCﬁ
 + 
iSå
] = 
p
->
aSz
[
nOld
*iCol + iStr];

1301 
	`sqlôe4DbFªe
(
db
, 
p
->
aSz
);

1302 
p
->
aSz
 = 
aNew
;

1303 
p
->
nSåóm
 = 
nNew
;

1305 
p
->
aSz
[p->
iCﬁ
 *Ö->
nSåóm
 + 
iSåóm
]++;

1307 
pTîm
 = (
TokíizeTîm
 *)
	`sqlôe4HashFöd
(&
p
->
hash
, 
zTokí
, 
nTokí
);

1308 if–
pTîm
==0 ){

1310 
nAŒoc
 = (
TokíizeTîm
Ë+ 
nTokí
 + 32;

1312 
pTîm
 = 
	`sqlôe4DbMÆlocZîo
(
p
->
db
, 
nAŒoc
);

1313 if–
pTîm
 ){

1314 
pTîm
->
nAŒoc
 = 
	`sqlôe4DbMÆlocSize
(
p
->
db
,ÖTerm);

1315 
pTîm
->
nTokí
 =ÇToken;

1316 
	`mem˝y
(&
pTîm
[1], 
zTokí
, 
nTokí
);

1318 if–
pTîm
==0 ) 
tokíize_cb_out
;

1320 
	`sqlôe4HashIn£π
(&
p
->
hash
, 
zTokí
, 
nTokí
, 0);

1323 if–
iSåóm
!=
pTîm
->iStream ){

1324 
pTîm
 = 
	`·s5TokíizeAµídI¡
(
p
,ÖTîm, (
iSåóm
 << 2) | 0x00000003);

1325 if–!
pTîm
 ) 
tokíize_cb_out
;

1326 
pTîm
->
iSåóm
 = iStream;

1329 if–
pTîm
 && 
p
->
iCﬁ
!=pTerm->iCol ){

1330 
pTîm
 = 
	`·s5TokíizeAµídI¡
(
p
,ÖTîm, (p->
iCﬁ
 << 2) | 0x00000001);

1331 if–!
pTîm
 ) 
tokíize_cb_out
;

1332 
pTîm
->
iCﬁ
 = 
p
->iCol;

1333 
pTîm
->
iOff
 = 0;

1336 
pTîm
 = 
	`·s5TokíizeAµídI¡
(
p
,ÖTîm, (
iOff
-pTerm->iOff) << 1);

1337 if–!
pTîm
 ) 
tokíize_cb_out
;

1338 
pTîm
->
iOff
 = iOff;

1340 
tokíize_cb_out
:

1341 
	`sqlôe4HashIn£π
(&
p
->
hash
, (*)&
pTîm
[1], 
nTokí
,ÖTerm);

1342 if–!
pTîm
 ){

1343 
p
->
rc
 = 
SQLITE4_NOMEM
;

1348 
	}
}

1350 
	$·s5LﬂdSizeRec‹d
(

1351 
sqlôe4
 *
db
,

1352 
u8
 *
aKey
, 
nKey
,

1353 
nMöSåóm
,

1354 
Fts5Info
 *
pInfo
,

1355 
i64
 *
≤Row
,

1356 
Fts5Size
 **
µSz


1358 
Fts5Size
 *
pSz
 = 0;

1359 
KVCurs‹
 *
pC§
 = 0;

1360 
rc
;

1362 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
db
->
aDb
[
pInfo
->
iDb
].
pKV
, &
pC§
);

1363 if–
rc
==
SQLITE4_OK
 ){

1364 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC§
, 
aKey
, 
nKey
, 0);

1365 if–
rc
==
SQLITE4_NOTFOUND
 ){

1366 if–
≤Row
 ){

1367 
nByã
 = (
Fts5Size
Ë+ (
i64
Ë* 
pInfo
->
nCﬁ
 * 
nMöSåóm
;

1368 
pSz
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

1369 if–
pSz
==0 ){

1370 
rc
 = 
SQLITE4_NOMEM
;

1372 
pSz
->
aSz
 = (
i64
 *)&pSz[1];

1373 
pSz
->
nSåóm
 = 
nMöSåóm
;

1374 
pSz
->
nCﬁ
 = 
pInfo
->nCol;

1375 *
≤Row
 = 0;

1376 
rc
 = 
SQLITE4_OK
;

1379 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

1381 }if–
rc
==
SQLITE4_OK
 ){

1382 c⁄° 
u8
 *
aD©a
 = 0;

1383 
nD©a
 = 0;

1384 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pC§
, 0, -1, &
aD©a
, &
nD©a
);

1385 if–
rc
==
SQLITE4_OK
 ){

1386 
iOff
 = 0;

1387 
nSåóm
 = 0;

1388 
nAŒoc
;

1392 if–
≤Row
 ){

1393 
iOff
 +
	`sqlôe4GëV¨öt64
(&
aD©a
[iOff], 
nD©a
-iOff, (
u64
 *)
≤Row
);

1395 
iOff
 +
	`gëV¨öt32
(&
aD©a
[iOff], 
nSåóm
);

1396 
nAŒoc
 = (
nSåóm
 < 
nMöSåóm
 ?ÇMinStream :ÇStream);

1398 
pSz
 = 
	`sqlôe4DbMÆlocZîo
(
db
,

1399 (
Fts5Size
Ë+ (
i64
Ë* 
pInfo
->
nCﬁ
 * 
nAŒoc


1401 if–
pSz
==0 ){

1402 
rc
 = 
SQLITE4_NOMEM
;

1404 
iCﬁ
 = 0;

1405 
pSz
->
aSz
 = (
i64
 *)&pSz[1];

1406 
pSz
->
nCﬁ
 = 
pInfo
->nCol;

1407 
pSz
->
nSåóm
 = 
nAŒoc
;

1408  
iOff
<
nD©a
 ){

1409 
i
;

1410 
i64
 *
aSz
 = &
pSz
->aSz[
iCﬁ
*
nAŒoc
];

1411 
i
=0; i<
nSåóm
; i++){

1412 
iOff
 +
	`sqlôe4GëV¨öt64
(&
aD©a
[iOff],
nD©a
-iOff,(
u64
*)&
aSz
[
i
]);

1414 
iCﬁ
++;

1419 
	`sqlôe4KVCurs‹Clo£
(
pC§
);

1422 *
µSz
 = 
pSz
;

1423  
rc
;

1424 
	}
}

1426 
	$·s5St‹eSizeRec‹d
(

1427 
KVSt‹e
 *
p
,

1428 
u8
 *
aKey
, 
nKey
,

1429 
Fts5Size
 *
pSz
,

1430 
i64
 
nRow
,

1431 
u8
 *
a


1433 
iOff
 = 0;

1434 
iCﬁ
;

1436 if–
nRow
>=0 ){

1437 
iOff
 +
	`sqlôe4PutV¨öt64
(&
a
[iOff], 
nRow
);

1439 
iOff
 +
	`sqlôe4PutV¨öt64
(&
a
[iOff], 
pSz
->
nSåóm
);

1441 
iCﬁ
=0; iCﬁ<
pSz
->
nCﬁ
; iCol++){

1442 
i
;

1443 
i
=0; i<
pSz
->
nSåóm
; i++){

1444 
iOff
 +
	`sqlôe4PutV¨öt64
(&
a
[iOff], 
pSz
->
aSz
[
iCﬁ
*pSz->
nSåóm
+
i
]);

1448  
	`sqlôe4KVSt‹eRïœ˚
(
p
, 
aKey
, 
nKey
, 
a
, 
iOff
);

1449 
	}
}

1451 
	$·s5C§LﬂdGlobÆ
(
Fts5Curs‹
 *
pC§
){

1452 
rc
 = 
SQLITE4_OK
;

1453 if–
pC§
->
pGlobÆ
==0 ){

1454 
nKey
;

1455 
u8
 
aKey
[10];

1456 
nKey
 = 
	`putV¨öt32
(
aKey
, 
pC§
->
pInfo
->
iRoŸ
);

1457 
aKey
[
nKey
++] = 0x00;

1458 
rc
 = 
	`·s5LﬂdSizeRec‹d
(

1459 
pC§
->
db
, 
aKey
, 
nKey
, 0,ÖC§->
pInfo
, &pC§->
nGlobÆ
, &pC§->
pGlobÆ


1462  
rc
;

1463 
	}
}

1465 
	$·s5C§LﬂdSz
(
Fts5Curs‹
 *
pC§
){

1466 
rc
 = 
SQLITE4_OK
;

1467 if–
pC§
->
pSz
==0 ){

1468 
sqlôe4
 *
db
 = 
pC§
->db;

1469 
Fts5Info
 *
pInfo
 = 
pC§
->pInfo;

1470 
u8
 *
aKey
;

1471 
nKey
 = 0;

1472 
nPk
 = 
pC§
->
pEx¥
->
pRoŸ
->nPk;

1474 
aKey
 = (
u8
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 10 + 
nPk
);

1475 if–!
aKey
 )  
SQLITE4_NOMEM
;

1477 
nKey
 = 
	`putV¨öt32
(
aKey
, 
pInfo
->
iRoŸ
);

1478 
aKey
[
nKey
++] = 0x00;

1479 
	`mem˝y
(&
aKey
[
nKey
], 
pC§
->
pEx¥
->
pRoŸ
->
aPk
, 
nPk
);

1480 
nKey
 +
nPk
;

1482 
rc
 = 
	`·s5LﬂdSizeRec‹d
(
pC§
->
db
, 
aKey
, 
nKey
, 0, 
pInfo
, 0, &pC§->
pSz
);

1483 
	`sqlôe4DbFªe
(
db
, 
aKey
);

1486  
rc
;

1487 
	}
}

1493 
	$sqlôe4Fts5Upd©e
(

1494 
sqlôe4
 *
db
,

1495 
Fts5Info
 *
pInfo
,

1496 
iRoŸ
,

1497 
Mem
 *
pKey
,

1498 
Mem
 *
aArg
,

1499 
bDñ
,

1500 **
pzEº


1502 
i
;

1503 
rc
 = 
SQLITE4_OK
;

1504 
KVSt‹e
 *
pSt‹e
;

1505 
TokíizeCtx
 
sCtx
;

1506 
nTnum
 = 0;

1507 
u32
 
dummy
 = 0;

1509 
u8
 *
aS∑˚
 = 0;

1510 
nS∑˚
 = 0;

1512 c⁄° 
u8
 *
pPK
;

1513 
nPK
;

1514 
HashEÀm
 *
pEÀm
;

1516 if–
iRoŸ
==0 ) iRoŸ = 
pInfo
->iRoot;

1517 
pSt‹e
 = 
db
->
aDb
[
pInfo
->
iDb
].
pKV
;

1519 
	`mem£t
(&
sCtx
, 0, (sCtx));

1520 
sCtx
.
db
 = db;

1521 
sCtx
.
nCﬁ
 = 
pInfo
->nCol;

1522 
	`sqlôe4HashInô
(
db
->
pEnv
, &
sCtx
.
hash
, 1);

1524 
pPK
 = (c⁄° 
u8
 *)
	`sqlôe4_vÆue_blob
(
pKey
, &
nPK
);

1526 
nTnum
 = 
	`gëV¨öt32
(
pPK
, 
dummy
);

1527 
nPK
 -
nTnum
;

1528 
pPK
 +
nTnum
;

1530 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pInfo
->
nCﬁ
; i++){

1531 
sqlôe4_vÆue
 *
pArg
 = (sqlôe4_vÆuê*)(&
aArg
[
i
]);

1532 if–
pArg
->
Êags
 & 
MEM_Så
 ){

1533 c⁄° *
zText
;

1534 
nText
;

1536 
zText
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
pArg
, &
nText
);

1537 
sCtx
.
iCﬁ
 = 
i
;

1538 
rc
 = 
pInfo
->
pTokíizî
->
	`xTokíize
(

1539 &
sCtx
, 
pInfo
->
p
, 
zText
, 
nText
, 
·s5TokíizeCb


1555 
nS∑˚
 = (
	`sqlôe4V¨ötLí
(
iRoŸ
Ë+ 2 + 
sCtx
.
nMax
 + 
nPK
) +

1556 (9 * (2 + 
pInfo
->
nCﬁ
 * 
sCtx
.
nSåóm
));

1557 
aS∑˚
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
nS∑˚
);

1558 if–
aS∑˚
==0 ) 
rc
 = 
SQLITE4_NOMEM
;

1560 
pEÀm
=
	`sqlôeHashFú°
(&
sCtx
.
hash
);ÖEÀm;ÖEÀm=
	`sqlôeHashNext
(pElem)){

1561 
TokíizeTîm
 *
pTîm
 = (TokíizeTîm *)
	`sqlôeHashD©a
(
pEÀm
);

1562 if–
rc
==
SQLITE4_OK
 ){

1563 
nTokí
 = 
	`sqlôeHashKeysize
(
pEÀm
);

1564 *
zTokí
 = (*)
	`sqlôeHashKey
(
pEÀm
);

1565 
u8
 *
aKey
 = 
aS∑˚
;

1566 
nKey
;

1568 
nKey
 = 
	`putV¨öt32
(
aKey
, 
iRoŸ
);

1569 
aKey
[
nKey
++] = 0x24;

1570 
	`mem˝y
(&
aKey
[
nKey
], 
zTokí
, 
nTokí
);

1571 
nKey
 +
nTokí
;

1572 
aKey
[
nKey
++] = 0x00;

1573 
	`mem˝y
(&
aKey
[
nKey
], 
pPK
, 
nPK
);

1574 
nKey
 +
nPK
;

1576 if–
bDñ
 ){

1578 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(
pSt‹e
, 
aKey
, 
nKey
, 0, -1);

1581 c⁄° 
KVByãAºay
 *
aD©a
 = (c⁄° KVByãAºay *)&
pTîm
[1];

1582 
aD©a
 +
pTîm
->
nTokí
;

1583 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(
pSt‹e
, 
aKey
, 
nKey
, 
aD©a
, 
pTîm
->
nD©a
);

1586 
	`sqlôe4DbFªe
(
db
, 
pTîm
);

1590 if–
rc
==
SQLITE4_OK
 ){

1591 
u8
 *
aKey
 = 
aS∑˚
;

1592 
nKey
;

1594 
nKey
 = 
	`putV¨öt32
(
aKey
, 
iRoŸ
);

1595 
aKey
[
nKey
++] = 0x00;

1596 
	`mem˝y
(&
aKey
[
nKey
], 
pPK
, 
nPK
);

1597 
nKey
 +
nPK
;

1599 if–
bDñ
==0 ){

1600 
Fts5Size
 
sSz
;

1601 
sSz
.
nCﬁ
 = 
pInfo
->nCol;

1602 
sSz
.
nSåóm
 = 
sCtx
.nStream;

1603 
sSz
.
aSz
 = 
sCtx
.aSz;

1604 
rc
 = 
	`·s5St‹eSizeRec‹d
(
pSt‹e
, 
aKey
, 
nKey
, &
sSz
, -1, &aKey[nKey]);

1606 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(
pSt‹e
, 
aKey
, 
nKey
, 0, -1);

1611 if–
rc
==
SQLITE4_OK
 ){

1612 
Fts5Size
 *
pSz
;

1613 
i64
 
nRow
;

1614 
u8
 *
aKey
 = 
aS∑˚
;

1615 
nKey
;

1617 
nKey
 = 
	`putV¨öt32
(
aKey
, 
iRoŸ
);

1618 
aKey
[
nKey
++] = 0x00;

1619 
rc
 = 
	`·s5LﬂdSizeRec‹d
(
db
, 
aKey
, 
nKey
, 
sCtx
.
nSåóm
, 
pInfo
, &
nRow
, &
pSz
);

1620 
	`as£π
–
rc
!=
SQLITE4_OK
 || 
pSz
->
nSåóm
>=
sCtx
.nStream );

1622 if–
rc
==
SQLITE4_OK
 ){

1623 
iCﬁ
;

1624 
iCﬁ
=0; iCﬁ<
pSz
->
nCﬁ
; iCol++){

1625 
iSå
;

1626 
i64
 *
aIn
 = &
sCtx
.
aSz
[
iCﬁ
 * sCtx.
nSåóm
];

1627 
i64
 *
aOut
 = &
pSz
->
aSz
[
iCﬁ
 *ÖSz->
nSåóm
];

1628 
iSå
=0; iSå<
sCtx
.
nSåóm
; iStr++){

1629 
aOut
[
iSå
] +(
aIn
[iSå] * (
bDñ
?-1:1));

1630 
	`as£π
–
iSå
==0 || 
aOut
[iStr]==0 );

1633 
nRow
 +(
bDñ
?-1:1);

1634 
rc
 = 
	`·s5St‹eSizeRec‹d
(
pSt‹e
, 
aKey
, 
nKey
, 
pSz
, 
nRow
, &aKey[nKey]);

1637 
	`sqlôe4DbFªe
(
db
, 
pSz
);

1640 
	`sqlôe4DbFªe
(
db
, 
aS∑˚
);

1641 
	`sqlôe4DbFªe
(
db
, 
sCtx
.
aSz
);

1642 
	`sqlôe4HashCÀ¨
(&
sCtx
.
hash
);

1643  
rc
;

1644 
	}
}

1646 
Fts5Info
 *
	$·s5InfoCª©e
(
P¨£
 *
pP¨£
, 
Index
 *
pIdx
, 
bCﬁ
){

1647 
sqlôe4
 *
db
 = 
pP¨£
->db;

1648 
Fts5Info
 *
pInfo
;

1649 
nByã
;

1651 
nByã
 = (
Fts5Info
);

1652 if–
bCﬁ
 ){

1653 
i
;

1654 
nCﬁ
 = 
pIdx
->
pTabÀ
->nCol;

1655 
i
=0; i<
nCﬁ
; i++){

1656 c⁄° *
zCﬁ
 = 
pIdx
->
pTabÀ
->
aCﬁ
[
i
].
zName
;

1657 
nByã
 +
	`sqlôe4SåÀn30
(
zCﬁ
) + 1;

1659 
nByã
 +
nCﬁ
 * (*);

1662 
pInfo
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

1663 if–
pInfo
 ){

1664 
pInfo
->
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pIdx
->
pSchema
);

1665 
pInfo
->
iRoŸ
 = 
pIdx
->
äum
;

1666 
pInfo
->
iTbl
 = 
	`sqlôe4FödPrim¨yKey
(
pIdx
->
pTabÀ
, 0)->
äum
;

1667 
pInfo
->
nCﬁ
 = 
pIdx
->
pTabÀ
->nCol;

1668 
	`·s5TokíizîCª©e
(
pP¨£
, 
pIdx
->
pFts
, &
pInfo
->
pTokíizî
, &pInfo->
p
);

1670 if–
pInfo
->
p
==0 ){

1671 
	`as£π
–
pP¨£
->
nEº
 );

1672 
	`sqlôe4DbFªe
(
db
, 
pInfo
);

1673 
pInfo
 = 0;

1675 if–
bCﬁ
 ){

1676 
i
;

1677 *
p
;

1678 
nCﬁ
 = 
pIdx
->
pTabÀ
->nCol;

1680 
pInfo
->
azCﬁ
 = (**)(&pInfo[1]);

1681 
p
 = (*)(&
pInfo
->
azCﬁ
[
nCﬁ
]);

1682 
i
=0; i<
nCﬁ
; i++){

1683 c⁄° *
zCﬁ
 = 
pIdx
->
pTabÀ
->
aCﬁ
[
i
].
zName
;

1684 
n
 = 
	`sqlôe4SåÀn30
(
zCﬁ
) + 1;

1685 
pInfo
->
azCﬁ
[
i
] = 
p
;

1686 
	`mem˝y
(
p
, 
zCﬁ
, 
n
);

1687 
p
 +
n
;

1692  
pInfo
;

1693 
	}
}

1695 
	$sqlôe4Fts5CodeUpd©e
(

1696 
P¨£
 *
pP¨£
,

1697 
Index
 *
pIdx
,

1698 
iRegRoŸ
,

1699 
iRegPk
,

1700 
iRegD©a
,

1701 
bDñ


1703 
Vdbe
 *
v
;

1704 
Fts5Info
 *
pInfo
;

1706 if–0==(
pInfo
 = 
	`·s5InfoCª©e
(
pP¨£
, 
pIdx
, 0)) ) ;

1708 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1709 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_FtsUpd©e
, 
iRegPk
, 
iRegRoŸ
, 
iRegD©a
);

1710 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pInfo
, 
P4_FTS5INFO
);

1711 
	`sqlôe4VdbeCh™geP5
(
v
, (
u8
)
bDñ
);

1712 
	}
}

1714 
	$sqlôe4Fts5CodeQuîy
(

1715 
P¨£
 *
pP¨£
,

1716 
Index
 *
pIdx
,

1717 
iC§
,

1718 
iJump
,

1719 
iRegM©ch


1721 
Vdbe
 *
v
;

1722 
Fts5Info
 *
pInfo
;

1724 if–0==(
pInfo
 = 
	`·s5InfoCª©e
(
pP¨£
, 
pIdx
, 1)) ) ;

1726 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1727 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_FtsO≥n
, 
iC§
, 
iJump
, 
iRegM©ch
);

1728 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pInfo
, 
P4_FTS5INFO
);

1729 
	}
}

1731 
	$sqlôe4Fts5FªeInfo
(
sqlôe4
 *
db
, 
Fts5Info
 *
p
){

1732 if–
db
->
≤ByãsFªed
==0 ){

1733 if–
p
->∞Ëp->
pTokíizî
->
	`xDe°roy
(p->p);

1734 
	`sqlôe4DbFªe
(
db
, 
p
);

1736 
	}
}

1738 
	$sqlôe4Fts5CodeCksum
(

1739 
P¨£
 *
pP¨£
,

1740 
Index
 *
pIdx
,

1741 
iCksum
,

1742 
iReg
,

1743 
bIdx


1745 
Vdbe
 *
v
;

1746 
Fts5Info
 *
pInfo
;

1748 if–0==(
pInfo
 = 
	`·s5InfoCª©e
(
pP¨£
, 
pIdx
, 0)) ) ;

1750 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1751 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_FtsCksum
, 
iCksum
, 0, 
iReg
);

1752 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pInfo
, 
P4_FTS5INFO
);

1753 
	`sqlôe4VdbeCh™geP5
(
v
, 
bIdx
);

1754 
	}
}

1767 
i64
 
	$·s5TîmIn°™˚Cksum
(

1768 c⁄° 
u8
 *
aTîm
, 
nTîm
,

1769 c⁄° 
u8
 *
aPk
, 
nPk
,

1770 
iSåóm
,

1771 
iCﬁ
,

1772 
iOff


1774 
i
;

1775 
i64
 
cksum
 = 0;

1778 
i
=0; i<
nTîm
; i++){

1779 
cksum
 +(cksum << 3Ë+ 
aTîm
[
i
];

1783 
i
=0; i<
nPk
; i++){

1784 
cksum
 +(cksum << 3Ë+ 
aPk
[
i
];

1788 
cksum
 +(cksum << 3Ë+ 
iSåóm
;

1789 
cksum
 +(cksum << 3Ë+ 
iCﬁ
;

1790 
cksum
 +(cksum << 3Ë+ 
iOff
;

1792  
cksum
;

1793 
	}
}

1796 
	$sqlôe4Fts5E¡ryCksum
(

1797 
sqlôe4
 *
db
,

1798 
Fts5Info
 *
p
,

1799 
Mem
 *
pKey
,

1800 
Mem
 *
pVÆ
,

1801 
i64
 *
piCksum


1803 
i64
 
cksum
 = 0;

1804 
u8
 c⁄° *
aKey
; 
nKey
;

1805 
u8
 c⁄° *
aVÆ
; 
nVÆ
;

1806 
u8
 c⁄° *
aTokí
; 
nTokí
;

1807 
u8
 c⁄° *
aPk
; 
nPk
;

1808 
In°™˚Li°
 
sLi°
;

1809 
nTnum
;

1810 
u32
 
äum
;

1812 
aKey
 = (c⁄° 
u8
 *)
	`sqlôe4_vÆue_blob
(
pKey
, &
nKey
);

1813 
aVÆ
 = (c⁄° 
u8
 *)
	`sqlôe4_vÆue_blob
(
pVÆ
, &
nVÆ
);

1816 
nTnum
 = 
	`gëV¨öt32
(
aKey
, 
äum
);

1817 if–
aKey
[
nTnum
]!=0 ){

1818 
aTokí
 = &
aKey
[
nTnum
+1];

1819 
nTokí
 = 
	`sqlôe4SåÀn30
((c⁄° *)
aTokí
);

1820 
aPk
 = &
aTokí
[
nTokí
+1];

1821 
nPk
 = (&
aKey
[
nKey
] - 
aPk
);

1823 
	`·s5In°™˚Li°Inô
((
u8
 *)
aVÆ
, 
nVÆ
, &
sLi°
);

1824  0==
	`·s5In°™˚Li°Next
(&
sLi°
) ){

1825 
i64
 
v
 = 
	`·s5TîmIn°™˚Cksum
(

1826 
aPk
, 
nPk
, 
aTokí
, 
nTokí
, 
sLi°
.
iSåóm
, sLi°.
iCﬁ
, sLi°.
iOff


1828 
cksum
 = cksum ^ 
v
;

1832 *
piCksum
 = 
cksum
;

1833  
SQLITE4_OK
;

1834 
	}
}

1836 
CksumCtx
 
	tCksumCtx
;

1837 
	sCksumCtx
 {

1838 c⁄° 
u8
 *
	mpPK
;

1839 
	mnPK
;

1840 
	miCﬁ
;

1841 
i64
 
	mcksum
;

1844 
	$·s5CksumCb
(

1845 *
pCtx
,

1846 
iSåóm
,

1847 
iOff
,

1848 c⁄° *
zTokí
,

1849 
nTokí
,

1850 
iSrc
,

1851 
nSrc


1853 
CksumCtx
 *
p
 = (CksumCtx *)
pCtx
;

1854 
i64
 
cksum
;

1856 
cksum
 = 
	`·s5TîmIn°™˚Cksum
(
p
->
pPK
,Ö->
nPK
,

1857 (c⁄° 
u8
 *)
zTokí
, 
nTokí
, 
iSåóm
, 
p
->
iCﬁ
, 
iOff


1860 
p
->
cksum
 = (p->cksum ^ cksum);

1862 
	}
}

1864 
	$sqlôe4Fts5RowCksum
(

1865 
sqlôe4
 *
db
,

1866 
Fts5Info
 *
pInfo
,

1867 
Mem
 *
pKey
,

1868 
Mem
 *
aArg
,

1869 
i64
 *
piCksum


1871 
i
;

1872 
rc
 = 
SQLITE4_OK
;

1873 
CksumCtx
 
sCtx
;

1874 
nTnum
 = 0;

1875 
u32
 
dummy
 = 0;

1877 
sCtx
.
cksum
 = 0;

1879 
sCtx
.
pPK
 = (c⁄° 
u8
 *)
	`sqlôe4_vÆue_blob
(
pKey
, &sCtx.
nPK
);

1880 
nTnum
 = 
	`gëV¨öt32
(
sCtx
.
pPK
, 
dummy
);

1881 
sCtx
.
nPK
 -
nTnum
;

1882 
sCtx
.
pPK
 +
nTnum
;

1884 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pInfo
->
nCﬁ
; i++){

1885 
sqlôe4_vÆue
 *
pArg
 = (sqlôe4_vÆuê*)(&
aArg
[
i
]);

1886 if–
pArg
->
Êags
 & 
MEM_Så
 ){

1887 c⁄° *
zText
;

1888 
nText
;

1890 
zText
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
pArg
, &
nText
);

1891 
sCtx
.
iCﬁ
 = 
i
;

1892 
rc
 = 
pInfo
->
pTokíizî
->
	`xTokíize
(

1893 &
sCtx
, 
pInfo
->
p
, 
zText
, 
nText
, 
·s5CksumCb


1898 *
piCksum
 = 
sCtx
.
cksum
;

1899  
rc
;

1900 
	}
}

1911 
	$·s5TokíPk
(
Fts5Tokí
 *
p
, c⁄° 
u8
 **
∑Pk
, *
≤Pk
){

1912 
rc
;

1914 if–
p
->
pC§
 ){

1915 c⁄° 
u8
 *
aKey
;

1916 
nKey
;

1918 
rc
 = 
	`sqlôe4KVCurs‹Key
(
p
->
pC§
, &
aKey
, &
nKey
);

1919 if–
rc
==
SQLITE4_OK
 ){

1920 if–
nKey
<
p
->
nPªfix
 || 
	`memcmp
’->
aPªfix
, 
aKey
,Ö->nPrefix) ){

1921 
rc
 = 
SQLITE4_NOTFOUND
;

1922 }if–
p
->
bPªfix
==0 ){

1923 *
∑Pk
 = &
aKey
[
p
->
nPªfix
];

1924 *
≤Pk
 = 
nKey
 - 
p
->
nPªfix
;

1926 c⁄° 
u8
 *
z
 = &
aKey
[
p
->
nPªfix
];

1927  *(
z
++)!='\0' );

1928 *
∑Pk
 = 
z
;

1929 *
≤Pk
 = 
nKey
 - (
z
-
aKey
);

1933 if–
p
->
pPªfix
 ){

1934 *
∑Pk
 = 
p
->
pPªfix
->
aPk
;

1935 *
≤Pk
 = 
p
->
pPªfix
->
nPk
;

1936 
rc
 = 
SQLITE4_OK
;

1938 
rc
 = 
SQLITE4_NOTFOUND
;

1942  
rc
;

1943 
	}
}

1945 
	$·s5TokíAdv™˚
(
sqlôe4
 *
db
, 
Fts5Tokí
 *
pTokí
){

1946 
rc
;

1947 if–
pTokí
->
pC§
 ){

1948 
rc
 = 
	`sqlôe4KVCurs‹Next
(
pTokí
->
pC§
);

1949 }if–
pTokí
->
pPªfix
 ){

1950 
Fts5Pªfix
 *
pDñ
 = 
pTokí
->
pPªfix
;

1951 
pTokí
->
pPªfix
 = 
pDñ
->
pNext
;

1952 
	`sqlôe4DbFªe
(
db
, 
pDñ
->
aLi°
);

1953 
	`sqlôe4DbFªe
(
db
, 
pDñ
);

1954 
rc
 = 
SQLITE4_OK
;

1956 
rc
 = 
SQLITE4_NOTFOUND
;

1958  
rc
;

1959 
	}
}

1961 
	$·s5TokíD©a
(
Fts5Tokí
 *
pTokí
, c⁄° 
u8
 **
∑D©a
, *
≤D©a
){

1962 
rc
;

1963 if–
pTokí
->
pC§
 ){

1964 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pTokí
->
pC§
, 0, -1, 
∑D©a
, 
≤D©a
);

1965 }if–
pTokí
->
pPªfix
 ){

1966 *
∑D©a
 = 
pTokí
->
pPªfix
->
aLi°
;

1967 *
≤D©a
 = 
pTokí
->
pPªfix
->
nLi°
;

1968 
rc
 = 
SQLITE4_OK
;

1970 
rc
 = 
SQLITE4_NOTFOUND
;

1973  
rc
;

1974 
	}
}

1981 
	$·s5KeyCom∑ª
(

1982 c⁄° 
u8
 *
aLe·
, 
nLe·
,

1983 c⁄° 
u8
 *
aRight
, 
nRight


1985 
ªs
;

1986 
nMö
;

1988 
ªs
 = (
aLe·
==0Ë- (
aRight
==0);

1989 if–
ªs
==0 ){

1990 
nMö
 = (
nLe·
 > 
nRight
) ?ÇRight :ÇLeft;

1991 
ªs
 = 
	`memcmp
(
aLe·
, 
aRight
, 
nMö
);

1993  (
ªs
 ?Ñe†: (
nLe·
-
nRight
));

1994 
	}
}

1996 
	$·s5Li°Mîge
(
sqlôe4
 *
db
, 
Fts5Li°
 *
p1
, Fts5Li° *
p2
, 
bFªe
){

1997 
In°™˚Li°
 
ö1
;

1998 
In°™˚Li°
 
ö2
;

1999 
In°™˚Li°
 
out
;

2001 
	`mem£t
(&
out
, 0, (
In°™˚Li°
));

2002 if–
p1
->
nD©a
==0 && 
p2
->nD©a==0 )  
SQLITE4_OK
;

2003 
out
.
nLi°
 = 
p1
->
nD©a
+
p2
->nData;

2004 
out
.
aLi°
 = 
	`sqlôe4DbMÆlocRaw
(
db
, out.
nLi°
);

2005 if–!
out
.
aLi°
 )  
SQLITE4_NOMEM
;

2006 
	`·s5In°™˚Li°Inô
(
p1
->
aD©a
,Ö1->
nD©a
, &
ö1
);

2007 
	`·s5In°™˚Li°Inô
(
p2
->
aD©a
,Ö2->
nD©a
, &
ö2
);

2009 
	`·s5In°™˚Li°Next
(&
ö1
);

2010 
	`·s5In°™˚Li°Next
(&
ö2
);

2012  
	`·s5In°™˚Li°Eof
(&
ö1
)==0 || fts5In°™˚Li°Eof(&
ö2
)==0 ){

2013 
In°™˚Li°
 *
pAdv
;

2015 if–
	`·s5In°™˚Li°Eof
(&
ö1
) ){

2016 
pAdv
 = &
ö2
;

2017 }if–
	`·s5In°™˚Li°Eof
(&
ö2
) ){

2018 
pAdv
 = &
ö1
;

2019 }if–
ö1
.
iCﬁ
==
ö2
.iCﬁ && in1.
iOff
==in2.iOff ){

2020 
pAdv
 = &
ö1
;

2021 
	`·s5In°™˚Li°Next
(&
ö2
);

2022 }if–
ö1
.
iCﬁ
<
ö2
.iCﬁ || (ö1.iCﬁ==ö2.iCﬁ && in1.
iOff
<in2.iOff) ){

2023 
pAdv
 = &
ö1
;

2025 
pAdv
 = &
ö2
;

2028 
	`·s5In°™˚Li°Aµíd
(&
out
, 
pAdv
->
iCﬁ
,ÖAdv->
iSåóm
,ÖAdv->
iOff
);

2029 
	`·s5In°™˚Li°Next
(
pAdv
);

2032 if–
bFªe
 ){

2033 
	`sqlôe4DbFªe
(
db
, 
p1
->
aD©a
);

2034 
	`sqlôe4DbFªe
(
db
, 
p2
->
aD©a
);

2036 
	`mem£t
(
p2
, 0, (
Fts5Li°
));

2037 
p1
->
aD©a
 = 
out
.
aLi°
;

2038 
p1
->
nD©a
 = 
out
.
iLi°
;

2039  
SQLITE4_OK
;

2040 
	}
}

2042 
	$·s5PªfixMîge
(
Fts5Pªfix
 **
µ
, Fts5Pªfix *
p2
){

2043 
Fts5Pªfix
 *
p1
 = *
µ
;

2044 
Fts5Pªfix
 *
pRë
 = 0;

2045 
Fts5Pªfix
 **
µWrôe
 = &
pRë
;

2047  
p1
 || 
p2
 ){

2048 
Fts5Pªfix
 **
µAdv
 = 0;

2049 if–
p1
==0 ){

2050 
µAdv
 = &
p2
;

2051 }if–
p2
==0 ){

2052 
µAdv
 = &
p1
;

2054 
ªs
 = 
	`·s5KeyCom∑ª
(
p1
->
aPk
,Ö1->
nPk
, 
p2
->aPk,Ö2->nPk);

2055 
	`as£π
–
ªs
!=0 );

2056 if–
ªs
<0 ){

2057 
µAdv
 = &
p1
;

2059 
µAdv
 = &
p2
;

2063 *
µWrôe
 = *
µAdv
;

2064 
µWrôe
 = &((*µWrôe)->
pNext
);

2065 *
µAdv
 = (*µAdv)->
pNext
;

2066 *
µWrôe
 = 0;

2069 *
µ
 = 
pRë
;

2070 
	}
}

2072 
	$·s5FödPªfixes
(
sqlôe4
 *
db
, 
Fts5Info
 *
pInfo
, 
Fts5Tokí
 *
pTokí
){

2073 
rc
 = 
SQLITE4_OK
;

2074 
HashEÀm
 *
pEÀm
;

2075 
Hash
 
hash
;

2077 
	`as£π
–
pTokí
->
bPªfix
 );

2078 
	`as£π
–
pTokí
->
aPªfix
[pTokí->
nPªfix
-1]!='\0' );

2079 
	`sqlôe4HashInô
(
db
->
pEnv
, &
hash
, 1);

2082 c⁄° 
u8
 *
aD©a
;

2083 
nD©a
;

2084 c⁄° 
u8
 *
aPk
;

2085 
nPk
;

2087 
rc
 = 
	`·s5TokíPk
(
pTokí
, &
aPk
, &
nPk
);

2088 if–
rc
==
SQLITE4_OK
 ){

2089 
rc
 = 
	`·s5TokíD©a
(
pTokí
, &
aD©a
, &
nD©a
);

2091 if–
rc
==
SQLITE4_OK
 ){

2092 
Fts5Pªfix
 *
p
;

2094 
p
 = (
Fts5Pªfix
 *)
	`sqlôe4HashFöd
(&
hash
, (c⁄° *)
aPk
, 
nPk
);

2095 if–!
p
 ){

2096 
p
 = (
Fts5Pªfix
 *)
	`sqlôe4DbMÆlocZîo
(
db
, (Fts5PªfixË+ 
nPk
);

2097 if–!
p
 ){

2098 
rc
 = 
SQLITE4_NOMEM
;

2100 *
pFªe
;

2101 
p
->
aPk
 = (
u8
 *)&p[1];

2102 
p
->
nPk
 =ÇPk;

2103 
	`mem˝y
(
p
->
aPk
,áPk, 
nPk
);

2104 
pFªe
 = 
	`sqlôe4HashIn£π
(&
hash
, (c⁄° *)
p
->
aPk
,Ö->
nPk
,Ö);

2105 if–
pFªe
 ){

2106 
	`as£π
–
pFªe
==(*)
p
 );

2107 
rc
 = 
SQLITE4_NOMEM
;

2108 
	`sqlôe4DbFªe
(
db
, 
pFªe
);

2113 if–
rc
==
SQLITE4_OK
 ){

2114 
nReq
 = 
nD©a
 + 
	`sqlôe4V¨ötLí
(nData);

2115  (
p
->
nLi°
 + 
nReq
Ë>Ö->
nAŒoc
 ){

2116 
nAŒoc
 = (
p
->nAlloc ?Ö->nAlloc*2 : 64);

2117 
p
->
aLi°
 = 
	`sqlôe4DbRóŒocOrFªe
(
db
,Ö->aLi°, 
nAŒoc
);

2118 if–!
p
->
aLi°
 ){

2119 
rc
 = 
SQLITE4_NOMEM
;

2122 
p
->
nAŒoc
 =ÇAlloc;

2126 if–
rc
==
SQLITE4_OK
 ){

2127 
p
->
nLi°
 +
	`putV¨öt32
(&p->
aLi°
[p->nLi°], 
nD©a
);

2128 
	`mem˝y
(&
p
->
aLi°
[p->
nLi°
], 
aD©a
, 
nD©a
);

2129 
p
->
nLi°
 +
nD©a
;

2132 if–
rc
==
SQLITE4_OK
 ){

2133 
rc
 = 
	`·s5TokíAdv™˚
(
db
, 
pTokí
);

2136 } 
rc
==
SQLITE4_OK
 );

2137 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

2139 if–
rc
==
SQLITE4_OK
 ){

2140 
Fts5Li°
 *
aMîge
;

2141 
aMîge
 = (
Fts5Li°
 *)
	`sqlôe4DbMÆlocZîo
(
db
, (Fts5List) * 32);

2142 if–!
aMîge
 ) 
rc
 = 
SQLITE4_NOMEM
;

2144 
pEÀm
=
	`sqlôeHashFú°
(&
hash
);ÖEÀm;ÖEÀm=
	`sqlôeHashNext
(pElem)){

2145 
Fts5Pªfix
 *
p
 = (Fts5Pªfix *)
	`sqlôeHashD©a
(
pEÀm
);

2146 
Fts5Li°
 
li°
 = {0, 0};

2147 
i
 = 0;

2148 
iLevñ
;

2150 
	`mem£t
(
aMîge
, 0, (
Fts5Li°
)*32);

2151  
i
<
p
->
nLi°
 && 
rc
==
SQLITE4_OK
 ){

2152 
u32
 
n
;

2153 
i
 +
	`gëV¨öt32
(&
p
->
aLi°
[i], 
n
);

2154 
li°
.
aD©a
 = &
p
->
aLi°
[
i
];

2155 
li°
.
nD©a
 = 
n
;

2156 
i
 +
n
;

2158 
iLevñ
=0; 
rc
==
SQLITE4_OK
 && iLevel<32; iLevel++){

2159 if–
aMîge
[
iLevñ
].
aD©a
==0 ){

2160 
aMîge
[
iLevñ
] = 
li°
;

2163 
rc
 = 
	`·s5Li°Mîge
(
db
, &
li°
, &
aMîge
[
iLevñ
], (iLevel>0));

2166 
	`as£π
–
iLevñ
<32 );

2169 
li°
.
aD©a
 = 0;

2170 
li°
.
nD©a
 = 0;

2171 
iLevñ
=0; 
rc
==
SQLITE4_OK
 && iLevel<32; iLevel++){

2172 
rc
 = 
	`·s5Li°Mîge
(
db
, &
li°
, &
aMîge
[
iLevñ
], (iLevel>0));

2175 if–
rc
==
SQLITE4_OK
 ){

2176 
	`sqlôe4DbFªe
(
db
, 
p
->
aLi°
);

2177 
p
->
aLi°
 = 
li°
.
aD©a
;

2178 
p
->
nAŒoc
 =Ö->
nLi°
 = 
li°
.
nD©a
;

2180 
	`sqlôe4DbFªe
(
db
, 
li°
.
aD©a
);

2184 
	`sqlôe4DbFªe
(
db
, 
aMîge
);

2187 if–
rc
==
SQLITE4_OK
 ){

2188 
Fts5Pªfix
 **
aMîge
;

2189 
Fts5Pªfix
 *
pPªfix
 = 0;

2191 
aMîge
 = (
Fts5Pªfix
 **)
	`sqlôe4DbMÆlocZîo
(
db
, (
Fts5Li°
) * 32);

2192 if–!
aMîge
 ){

2193 
rc
 = 
SQLITE4_NOMEM
;

2195 
iLevñ
;

2196 
pEÀm
=
	`sqlôeHashFú°
(&
hash
);ÖEÀm;ÖEÀm=
	`sqlôeHashNext
(pElem)){

2197 
pPªfix
 = (
Fts5Pªfix
 *)
	`sqlôeHashD©a
(
pEÀm
);

2198 
iLevñ
=0; iLevel<32; iLevel++){

2199 if–
aMîge
[
iLevñ
] ){

2200 
	`·s5PªfixMîge
(&
pPªfix
, 
aMîge
[
iLevñ
]);

2201 
aMîge
[
iLevñ
] = 0;

2203 
aMîge
[
iLevñ
] = 
pPªfix
;

2207 
	`as£π
–
iLevñ
<32 );

2209 
pPªfix
 = 0;

2210 
iLevñ
=0; iLevel<32; iLevel++){

2211 
	`·s5PªfixMîge
(&
pPªfix
, 
aMîge
[
iLevñ
]);

2213 
	`sqlôe4HashCÀ¨
(&
hash
);

2214 
	`sqlôe4DbFªe
(
db
, 
aMîge
);

2216 
pTokí
->
pPªfix
 =ÖPrefix;

2219 
pEÀm
=
	`sqlôeHashFú°
(&
hash
);ÖEÀm;ÖEÀm=
	`sqlôeHashNext
(pElem)){

2220 
Fts5Pªfix
 *
pPªfix
 = (Fts5Pªfix *)
	`sqlôeHashD©a
(
pEÀm
);

2221 
	`sqlôe4DbFªe
(
db
, 
pPªfix
->
aLi°
);

2222 
	`sqlôe4DbFªe
(
db
, 
pPªfix
);

2224 
	`sqlôe4KVCurs‹Clo£
(
pTokí
->
pC§
);

2225 
pTokí
->
pC§
 = 0;

2227  
rc
;

2228 
	}
}

2230 
	$·s5O≥nEx¥Curs‹s
(
sqlôe4
 *
db
, 
Fts5Info
 *
pInfo
, 
Fts5Ex¥Node
 *
p
){

2231 
rc
 = 
SQLITE4_OK
;

2232 if–
p
 ){

2233 if–
p
->
eTy≥
==
TOKEN_PRIMITIVE
 ){

2234 
KVSt‹e
 *
pSt‹e
 = 
db
->
aDb
[
pInfo
->
iDb
].
pKV
;

2235 
Fts5Phø£
 *
pPhø£
 = 
p
->pPhrase;

2236 
iSå
;

2238 
iSå
=0; 
rc
==
SQLITE4_OK
 && iSå<
pPhø£
->
nSå
; iStr++){

2239 
Fts5Så
 *
pSå
 = &
pPhø£
->
aSå
[
iSå
];

2240 
i
;

2241 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pSå
->
nTokí
; i++){

2242 
Fts5Tokí
 *
pTokí
 = &
pSå
->
aTokí
[
i
];

2243 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pSt‹e
, &
pTokí
->
pC§
);

2244 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(

2245 
pTokí
->
pC§
,ÖTokí->
aPªfix
,ÖTokí->
nPªfix
, 1

2247 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

2248 if–
rc
==
SQLITE4_OK
 && 
pTokí
->
bPªfix
 ){

2249 
rc
 = 
	`·s5FödPªfixes
(
db
, 
pInfo
, 
pTokí
);

2254 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s5O≥nEx¥Curs‹s
(
db
, 
pInfo
, 
p
->
pLe·
);

2255 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s5O≥nEx¥Curs‹s
(
db
, 
pInfo
, 
p
->
pRight
);

2258  
rc
;

2259 
	}
}

2264 
	$·s5O≥nCurs‹s
(
sqlôe4
 *
db
, 
Fts5Info
 *
pInfo
, 
Fts5Curs‹
 *
pC§
){

2265  
	`·s5O≥nEx¥Curs‹s
(
db
, 
pInfo
, 
pC§
->
pEx¥
->
pRoŸ
);

2266 
	}
}

2268 
	$sqlôe4Fts5Clo£
(
Fts5Curs‹
 *
pC§
){

2269 if–
pC§
 ){

2270 
sqlôe4
 *
db
 = 
pC§
->db;

2271 if–
pC§
->
aMem
 ){

2272 
i
;

2273 
i
=0; i<
pC§
->
pInfo
->
nCﬁ
; i++){

2274 
	`sqlôe4DbFªe
(
db
, 
pC§
->
aMem
[
i
].
zMÆloc
);

2276 
	`sqlôe4DbFªe
(
db
, 
pC§
->
aMem
);

2279 
	`sqlôe4KVCurs‹Clo£
(
pC§
->pCsr);

2280 
	`·s5Ex¥essi⁄Fªe
(
db
, 
pC§
->
pEx¥
);

2281 
	`sqlôe4DbFªe
(
db
, 
pC§
->
pIãr
);

2282 
	`sqlôe4DbFªe
(
db
, 
pC§
->
aKey
);

2283 
	`sqlôe4DbFªe
(
db
, 
pC§
->
™Row
);

2284 
	`sqlôe4DbFªe
(
db
, 
pC§
);

2286 
	}
}

2288 
	$·s5TokíAdv™˚ToM©ch
(

2289 
In°™˚Li°
 *
p
,

2290 
In°™˚Li°
 *
pFú°
,

2291 
iOff
,

2292 *
pbEof


2294 
iReq
 = 
pFú°
->
iOff
 + iOff;

2296  
p
->
iCﬁ
<
pFú°
->iCﬁ || (p->iCﬁ=ıFú°->iCﬁ &&Ö->
iOff
 < 
iReq
) ){

2297 
bEof
 = 
	`·s5In°™˚Li°Next
(
p
);

2298 if–
bEof
 ){

2299 *
pbEof
 = 1;

2304  (
p
->
iCﬁ
==
pFú°
->iCﬁ &&Ö->
iOff
==
iReq
);

2305 
	}
}

2307 
	$·s5SåögFödIn°™˚s
(
sqlôe4
 *
db
, 
iCﬁ
, 
Fts5Så
 *
pSå
){

2308 
i
;

2309 
rc
 = 
SQLITE4_OK
;

2310 
bEof
 = 0;

2311 
nByã
 = (
In°™˚Li°
Ë* 
pSå
->
nTokí
;

2312 
In°™˚Li°
 *
aIn
;

2313 
In°™˚Li°
 
out
;

2315 
pSå
->
nLi°
 = 0;

2316 
	`mem£t
(&
out
, 0, (
In°™˚Li°
));

2318 
aIn
 = (
In°™˚Li°
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

2319 if–!
aIn
 ) 
rc
 = 
SQLITE4_NOMEM
;

2320 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pSå
->
nTokí
; i++){

2321 c⁄° 
u8
 *
aD©a
;

2322 
nD©a
;

2323 
rc
 = 
	`·s5TokíD©a
(&
pSå
->
aTokí
[
i
], &
aD©a
, &
nD©a
);

2324 if–
rc
==
SQLITE4_OK
 ){

2325 
	`·s5In°™˚Li°Inô
((
u8
 *)
aD©a
, 
nD©a
, &
aIn
[
i
]);

2326 
	`·s5In°™˚Li°Next
(&
aIn
[
i
]);

2331 if–
rc
==
SQLITE4_OK
 ){

2332 
nReq
 = 
aIn
[0].
nLi°
;

2333 if–
nReq
<=
pSå
->
nLi°AŒoc
 ){

2334 
out
.
aLi°
 = 
pSå
->aList;

2335 
out
.
nLi°
 = 
pSå
->
nLi°AŒoc
;

2337 
pSå
->
aLi°
 = 
out
.aLi° = 
	`sqlôe4DbRóŒocOrFªe
(
db
,ÖSå->aLi°, 
nReq
*2);

2338 
pSå
->
nLi°AŒoc
 = 
out
.
nLi°
 = 
nReq
*2;

2339 if–
out
.
aLi°
==0 ) 
rc
 = 
SQLITE4_NOMEM
;

2343  
rc
==
SQLITE4_OK
 && 
bEof
==0 ){

2344 
i
=1; i<
pSå
->
nTokí
; i++){

2345 
bM©ch
 = 
	`·s5TokíAdv™˚ToM©ch
(&
aIn
[
i
], &aIn[0], i, &
bEof
);

2346 if–
bM©ch
==0 || 
bEof
 ) ;

2348 if–
i
==
pSå
->
nTokí
 && (
iCﬁ
<0 || 
aIn
[0].iCol==iCol) ){

2350 
	`·s5In°™˚Li°Aµíd
(&
out
, 
aIn
[0].
iCﬁ
,áIn[0].
iSåóm
,áIn[0].
iOff
);

2352 
bEof
 = 
	`·s5In°™˚Li°Next
(&
aIn
[0]);

2355 
pSå
->
nLi°
 = 
out
.
iLi°
;

2356 
	`sqlôe4DbFªe
(
db
, 
aIn
);

2358  
rc
;

2359 
	}
}

2361 
	$·s5IsNór
(
In°™˚Li°
 *
p1
, In°™˚Li° *
p2
, 
nNór
){

2362 if–
p1
->
iCﬁ
==
p2
->iCﬁ &&Ö1->
iOff
<p2->iOf‡&& (p1->iOff+
nNór
)>=p2->iOff ){

2366 
	}
}

2368 
	$·s5SåögNórTrim
(

2369 
Fts5Så
 *
pTrim
,

2370 
Fts5Så
 *
pNext
,

2371 
nNór


2373 if–
pNext
->
nLi°
==0 ){

2374 
pTrim
->
nLi°
 = 0;

2376 
bEof
 = 0;

2377 
nTøû
 = 
nNór
 + (
pNext
->
nTokí
-1) + 1;

2378 
nLód
 = 
nNór
 + (
pTrim
->
nTokí
-1) + 1;

2380 
In°™˚Li°
 
lNór
;

2381 
In°™˚Li°
 
ö
;

2382 
In°™˚Li°
 
out
;

2384 
	`·s5In°™˚Li°Inô
(
pNext
->
aLi°
,ÖNext->
nLi°
, &
lNór
);

2385 
	`·s5In°™˚Li°Inô
(
pTrim
->
aLi°
,ÖTrim->
nLi°
, &
ö
);

2386 
	`·s5In°™˚Li°Inô
(
pTrim
->
aLi°
,ÖTrim->
nLi°
, &
out
);

2387 
	`·s5In°™˚Li°Next
(&
lNór
);

2388 
	`·s5In°™˚Li°Next
(&
ö
);

2390  
bEof
==0 ){

2391 if–
	`·s5IsNór
(&
lNór
, &
ö
, 
nTøû
)

2392 || 
	`·s5IsNór
(&
ö
, &
lNór
, 
nLód
)

2396 
	`·s5In°™˚Li°Aµíd
(&
out
, 
ö
.
iCﬁ
, in.
iSåóm
, in.
iOff
);

2397 
bEof
 = 
	`·s5In°™˚Li°Next
(&
ö
);

2399 if–
lNór
.
iCﬁ
<
ö
.iCﬁ || (lNór.iCﬁ==ö.iCﬁ &&ÜNór.
iOff
<in.iOff) ){

2400 
bEof
 = 
	`·s5In°™˚Li°Next
(&
lNór
);

2401 }if–
lNór
.
iCﬁ
==
ö
.iCﬁ &&ÜNór.
iOff
==in.iOff ){

2402 
bEof
 = 
	`·s5In°™˚Li°Next
(&
ö
);

2403 if–
	`·s5IsNór
(&
lNór
, &
ö
, 
nTøû
) ){

2404 
	`·s5In°™˚Li°Aµíd
(&
out
, 
lNór
.
iCﬁ
,ÜNór.
iSåóm
,ÜNór.
iOff
);

2407 
bEof
 = 
	`·s5In°™˚Li°Next
(&
ö
);

2412 
pTrim
->
nLi°
 = 
out
.
iLi°
;

2414  
SQLITE4_OK
;

2415 
	}
}

2426 
	$·s5Phø£IsM©ch
(

2427 
sqlôe4
 *
db
,

2428 
Fts5Phø£
 *
pPhø£
,

2429 *
pbM©ch
,

2430 
Fts5Tokí
 **
µAdv™˚


2432 c⁄° 
u8
 *
aPk1
 = 0;

2433 
nPk1
 = 0;

2434 
rc
 = 
SQLITE4_OK
;

2435 
i
;

2437 *
pbM©ch
 = 0;

2438 *
µAdv™˚
 = &
pPhø£
->
aSå
[0].
aTokí
[0];

2440 
rc
 = 
	`·s5TokíPk
(*
µAdv™˚
, &
aPk1
, &
nPk1
);

2441 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pPhø£
->
nSå
; i++){

2442 
j
;

2443 
j
=(
i
==0); j<
pPhø£
->
aSå
[i].
nTokí
; j++){

2444 c⁄° 
u8
 *
aPk
 = 0;

2445 
nPk
 = 0;

2446 
Fts5Tokí
 *
pTokí
 = &
pPhø£
->
aSå
[
i
].
aTokí
[
j
];

2447 
rc
 = 
	`·s5TokíPk
(
pTokí
, &
aPk
, &
nPk
);

2448 if–
rc
==
SQLITE4_OK
 ){

2449 
ªs
 = 
	`·s5KeyCom∑ª
(
aPk1
, 
nPk1
, 
aPk
, 
nPk
);

2450 if–
ªs
<0 ){

2451  
SQLITE4_OK
;

2453 if–
ªs
>0 ){

2454 *
µAdv™˚
 = 
pTokí
;

2455  
SQLITE4_OK
;

2465 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pPhø£
->
nSå
; i++){

2466 
Fts5Så
 *
pSå
 = &
pPhø£
->
aSå
[
i
];

2467 
rc
 = 
	`·s5SåögFödIn°™˚s
(
db
, 
pPhø£
->
iCﬁ
, 
pSå
);

2471 
i
=1; 
rc
==
SQLITE4_OK
 && i<
pPhø£
->
nSå
; i++){

2472 
n
 = 
pPhø£
->
aiNór
[
i
-1];

2473 
rc
 = 
	`·s5SåögNórTrim
(&
pPhø£
->
aSå
[
i
], &pPhø£->aSå[i-1], 
n
);

2475 
i
=
pPhø£
->
nSå
-1; 
rc
==
SQLITE4_OK
 && i>0; i--){

2476 
n
 = 
pPhø£
->
aiNór
[
i
-1];

2477 
rc
 = 
	`·s5SåögNórTrim
(&
pPhø£
->
aSå
[
i
-1], &pPhø£->aSå[i], 
n
);

2480 *
pbM©ch
 = (
pPhø£
->
aSå
[0].
nLi°
>0);

2481  
rc
;

2482 
	}
}

2484 
	$·s5Phø£Adv™˚ToM©ch
(
sqlôe4
 *
db
, 
Fts5Phø£
 *
pPhø£
){

2485 
rc
;

2487 
bM©ch
;

2488 
Fts5Tokí
 *
pAdv™˚
 = 0;

2489 
rc
 = 
	`·s5Phø£IsM©ch
(
db
, 
pPhø£
, &
bM©ch
, &
pAdv™˚
);

2490 if–
rc
!=
SQLITE4_OK
 || 
bM©ch
 ) ;

2491 
rc
 = 
	`·s5TokíAdv™˚
(
db
, 
pAdv™˚
);

2492 } 
rc
==
SQLITE4_OK
 );

2493  
rc
;

2494 
	}
}

2496 
	$·s5Ex¥Adv™˚
(
sqlôe4
 *
db
, 
Fts5Ex¥Node
 *
p
, 
bFú°
){

2497 
rc
 = 
SQLITE4_OK
;

2499  
p
->
eTy≥
 ){

2500 
TOKEN_PRIMITIVE
: {

2501 
Fts5Phø£
 *
pPhø£
 = 
p
->pPhrase;

2502 if–
bFú°
==0 ){

2503 
rc
 = 
	`·s5TokíAdv™˚
(
db
, &
pPhø£
->
aSå
[0].
aTokí
[0]);

2505 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s5Phø£Adv™˚ToM©ch
(
db
, 
pPhø£
);

2506 if–
rc
==
SQLITE4_OK
 ){

2507 
rc
 = 
	`·s5TokíPk
(&
pPhø£
->
aSå
[0].
aTokí
[0], &
p
->
aPk
, &p->
nPk
);

2509 
p
->
aPk
 = 0;

2510 
p
->
nPk
 = 0;

2511 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

2516 
TOKEN_AND
:

2517 
p
->
aPk
 = 0;

2518 
p
->
nPk
 = 0;

2519 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pLe·
, 
bFú°
);

2520 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pRight
, 
bFú°
);

2521  
rc
==
SQLITE4_OK
 && 
p
->
pLe·
->
aPk
 &&Ö->
pRight
->aPk ){

2522 
ªs
 = 
	`·s5KeyCom∑ª
(

2523 
p
->
pLe·
->
aPk
,Ö->pLe·->
nPk
,Ö->
pRight
->aPk,Ö->pRight->nPk

2525 if–
ªs
<0 ){

2526 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pLe·
, 0);

2527 }if–
ªs
>0 ){

2528 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pRight
, 0);

2530 
p
->
aPk
 =Ö->
pLe·
->aPk;

2531 
p
->
nPk
 =Ö->
pLe·
->nPk;

2537 
TOKEN_OR
: {

2538 
ªs
 = 0;

2539 if–
bFú°
==0 ){

2540 
ªs
 = 
	`·s5KeyCom∑ª
(

2541 
p
->
pLe·
->
aPk
,Ö->pLe·->
nPk
,Ö->
pRight
->aPk,Ö->pRight->nPk

2545 if–
ªs
<=0 ) 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pLe·
, 
bFú°
);

2546 if–
rc
==
SQLITE4_OK
 && 
ªs
>=0 ){

2547 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pRight
, 
bFú°
);

2550 
ªs
 = 
	`·s5KeyCom∑ª
(

2551 
p
->
pLe·
->
aPk
,Ö->pLe·->
nPk
,Ö->
pRight
->aPk,Ö->pRight->nPk

2553 if–
ªs
>0 ){

2554 
p
->
aPk
 =Ö->
pRight
->aPk;

2555 
p
->
nPk
 =Ö->
pRight
->nPk;

2557 
p
->
aPk
 =Ö->
pLe·
->aPk;

2558 
p
->
nPk
 =Ö->
pLe·
->nPk;

2560 
	`as£π
–
p
->
aPk
!=0 || (p->
pLe·
->aPk==0 &&Ö->
pRight
->aPk==0) );

2565 : 
	`as£π
–
p
->
eTy≥
==
TOKEN_NOT
 );

2567 
p
->
aPk
 = 0;

2568 
p
->
nPk
 = 0;

2570 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pLe·
, 
bFú°
);

2571 if–
bFú°
 && 
rc
==
SQLITE4_OK
 ){

2572 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pRight
, 
bFú°
);

2575  
rc
==
SQLITE4_OK
 && 
p
->
pLe·
->
aPk
 &&Ö->
pRight
->aPk ){

2576 
ªs
 = 
	`·s5KeyCom∑ª
(

2577 
p
->
pLe·
->
aPk
,Ö->pLe·->
nPk
,Ö->
pRight
->aPk,Ö->pRight->nPk

2579 if–
ªs
<0 ){

2581 }if–
ªs
>0 ){

2582 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pRight
, 0);

2584 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
p
->
pLe·
, 0);

2588 
p
->
aPk
 =Ö->
pLe·
->aPk;

2589 
p
->
nPk
 =Ö->
pLe·
->nPk;

2593 
	`as£π
–
rc
!=
SQLITE4_NOTFOUND
 );

2594  
rc
;

2595 
	}
}

2597 
	$sqlôe4Fts5Next
(
Fts5Curs‹
 *
pC§
){

2598 
	`sqlôe4DbFªe
(
pC§
->
db
,ÖC§->
pSz
);

2599 
pC§
->
pSz
 = 0;

2600 
pC§
->
bMemVÆid
 = 0;

2601  
	`·s5Ex¥Adv™˚
(
pC§
->
db
,ÖC§->
pEx¥
->
pRoŸ
, 0);

2602 
	}
}

2604 
	$sqlôe4Fts5O≥n
(

2605 
sqlôe4
 *
db
,

2606 
Fts5Info
 *
pInfo
,

2607 c⁄° *
zM©ch
,

2608 
bDesc
,

2609 
Fts5Curs‹
 **
µC§
,

2610 **
pzEº


2612 
rc
 = 
SQLITE4_OK
;

2613 
Fts5Curs‹
 *
pC§
;

2614 
nM©ch
 = 
	`sqlôe4SåÀn30
(
zM©ch
);

2616 
pC§
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Fts5Curs‹
Ë+ 
nM©ch
 + 1);

2618 if–!
pC§
 ){

2619 
rc
 = 
SQLITE4_NOMEM
;

2621 
pC§
->
zEx¥
 = (*)&pCsr[1];

2622 
	`mem˝y
(
pC§
->
zEx¥
, 
zM©ch
, 
nM©ch
);

2623 
pC§
->
pInfo
 =ÖInfo;

2624 
pC§
->
db
 = db;

2625 
rc
 = 
	`·s5P¨£Ex¥essi⁄
(
db
, 
pInfo
->
pTokíizî
,ÖInfo->
p
,

2626 
pInfo
->
iRoŸ
,ÖInfo->
azCﬁ
,ÖInfo->
nCﬁ
, 
zM©ch
, &
pC§
->
pEx¥
, 
pzEº


2630 if–
rc
==
SQLITE4_OK
 ){

2633 
rc
 = 
	`·s5O≥nCurs‹s
(
db
, 
pInfo
, 
pC§
);

2635 if–
rc
!=
SQLITE4_OK
 ){

2636 
	`sqlôe4Fts5Clo£
(
pC§
);

2637 
pC§
 = 0;

2639 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
pC§
->
pEx¥
->
pRoŸ
, 1);

2641 *
µC§
 = 
pC§
;

2642  
rc
;

2643 
	}
}

2649 
	$sqlôe4Fts5VÆid
(
Fts5Curs‹
 *
pC§
){

2650 –
pC§
->
pEx¥
->
pRoŸ
->
aPk
!=0 );

2651 
	}
}

2653 
	$sqlôe4Fts5Pk
(

2654 
Fts5Curs‹
 *
pC§
,

2655 
iTbl
,

2656 
KVByãAºay
 **
∑Key
,

2657 
KVSize
 *
≤Key


2659 
i
;

2660 
nReq
;

2661 c⁄° 
u8
 *
aPk
;

2662 
nPk
;

2664 
aPk
 = 
pC§
->
pEx¥
->
pRoŸ
->aPk;

2665 
nPk
 = 
pC§
->
pEx¥
->
pRoŸ
->nPk;

2667 
nReq
 = 
	`sqlôe4V¨ötLí
(
iTbl
Ë+ 
nPk
;

2668 if–
nReq
>
pC§
->
nKeyAŒoc
 ){

2669 
pC§
->
aKey
 = 
	`sqlôe4DbRóŒocOrFªe
’C§->
db
,ÖC§->aKey, 
nReq
*2);

2670 if–!
pC§
->
aKey
 )  
SQLITE4_NOMEM
;

2671 
pC§
->
nKeyAŒoc
 = 
nReq
*2;

2674 
i
 = 
	`putV¨öt32
(
pC§
->
aKey
, 
iTbl
);

2675 
	`mem˝y
(&
pC§
->
aKey
[
i
], 
aPk
, 
nPk
);

2677 *
∑Key
 = 
pC§
->
aKey
;

2678 *
≤Key
 = 
nReq
;

2679  
SQLITE4_OK
;

2680 
	}
}

2682 
	$sqlôe4_mi_cﬁumn_cou¡
(
sqlôe4_c⁄ãxt
 *
pCtx
, *
≤
){

2683 
rc
 = 
SQLITE4_OK
;

2684 if–
pCtx
->
pFts
 ){

2685 *
≤
 = 
pCtx
->
pFts
->
pInfo
->
nCﬁ
;

2687 
rc
 = 
SQLITE4_MISUSE
;

2689  
rc
;

2690 
	}
}

2692 
	$sqlôe4_mi_phø£_cou¡
(
sqlôe4_c⁄ãxt
 *
pCtx
, *
≤
){

2693 
rc
 = 
SQLITE4_OK
;

2694 if–
pCtx
->
pFts
 ){

2695 *
≤
 = 
pCtx
->
pFts
->
pEx¥
->
nPhø£
;

2697 
rc
 = 
SQLITE4_MISUSE
;

2699  
rc
;

2700 
	}
}

2702 
	$sqlôe4_mi_phø£_tokí_cou¡
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
iP
, *
≤
){

2703 
rc
 = 
SQLITE4_OK
;

2704 if–
pCtx
->
pFts
 ){

2705 
Fts5Ex¥
 *
pEx¥
 = 
pCtx
->
pFts
->pExpr;

2706 if–
iP
>
pEx¥
->
nPhø£
 || iP<0 ){

2707 *
≤
 = 0;

2709 *
≤
 = 
pEx¥
->
≠Phø£
[
iP
]->
nTokí
;

2712 
rc
 = 
SQLITE4_MISUSE
;

2714  
rc
;

2715 
	}
}

2717 
	$sqlôe4_mi_°ªam_cou¡
(
sqlôe4_c⁄ãxt
 *
pCtx
, *
≤
){

2718 
rc
 = 
SQLITE4_OK
;

2719 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2720 if–
pC§
 ){

2721 
rc
 = 
	`·s5C§LﬂdGlobÆ
(
pCtx
->
pFts
);

2722 if–
rc
==
SQLITE4_OK
 ) *
≤
 = 
pC§
->
pGlobÆ
->
nSåóm
;

2724 
rc
 = 
SQLITE4_MISUSE
;

2726  
rc
;

2727 
	}
}

2729 
	$·s5GëSize
(
Fts5Size
 *
pSz
, 
iC
, 
iS
){

2730 
nTokí
 = 0;

2731 
i
;

2733 if–
iC
<0 && 
iS
<0 ){

2734 
nFö
 = 
pSz
->
nCﬁ
 *ÖSz->
nSåóm
;

2735 
i
=0; i<
nFö
; i++Ë
nTokí
 +
pSz
->
aSz
[i];

2736 }if–
iC
<0 ){

2737 
i
=0; i<
pSz
->
nCﬁ
; i++Ë
nTokí
 +pSz->
aSz
[i*pSz->
nSåóm
 + 
iS
];

2738 }if–
iS
<0 ){

2739 
i
=0; i<
pSz
->
nSåóm
; i++Ë
nTokí
 +pSz->
aSz
[pSz->nSåóm*
iC
 + i];

2740 }if–
iC
<
pSz
->
nCﬁ
 && 
iS
<pSz->
nSåóm
 ){

2741 
nTokí
 = 
pSz
->
aSz
[
iC
 *ÖSz->
nSåóm
 + 
iS
];

2744  
nTokí
;

2745 
	}
}

2747 
	$sqlôe4_mi_size
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
iC
, 
iS
, *
≤
){

2748 
rc
 = 
SQLITE4_OK
;

2749 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2751 if–
pC§
==0 ){

2752 
rc
 = 
SQLITE4_MISUSE
;

2754 
rc
 = 
	`·s5C§LﬂdSz
(
pC§
);

2755 if–
rc
==
SQLITE4_OK
 ){

2756 *
≤
 = 
	`·s5GëSize
(
pC§
->
pSz
, 
iC
, 
iS
);

2759  
rc
;

2760 
	}
}

2762 
	$sqlôe4_mi_tŸÆ_size
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
iC
, 
iS
, *
≤
){

2763 
rc
 = 
SQLITE4_OK
;

2764 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2766 if–
pC§
==0 ){

2767 
rc
 = 
SQLITE4_MISUSE
;

2769 
rc
 = 
	`·s5C§LﬂdGlobÆ
(
pC§
);

2770 if–
rc
==
SQLITE4_OK
 ){

2771 *
≤
 = 
	`·s5GëSize
(
pC§
->
pGlobÆ
, 
iC
, 
iS
);

2774  
rc
;

2775 
	}
}

2777 
	$sqlôe4_mi_tŸÆ_rows
(
sqlôe4_c⁄ãxt
 *
pCtx
, *
≤
){

2778 
rc
 = 
SQLITE4_OK
;

2779 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2780 if–
pC§
==0 ){

2781 
rc
 = 
SQLITE4_MISUSE
;

2783 
rc
 = 
	`·s5C§LﬂdGlobÆ
(
pC§
);

2784 if–
rc
==
SQLITE4_OK
 ) *
≤
 = 
pC§
->
nGlobÆ
;

2786  
rc
;

2787 
	}
}

2789 
	$sqlôe4_mi_cﬁumn_vÆue
(

2790 
sqlôe4_c⁄ãxt
 *
pCtx
,

2791 
iCﬁ
,

2792 
sqlôe4_vÆue
 **
µVÆ


2794 
rc
 = 
SQLITE4_OK
;

2795 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2796 if–
pC§
==0 ){

2797 
rc
 = 
SQLITE4_MISUSE
;

2799 if–
pC§
->
bMemVÆid
==0 ){

2800 
sqlôe4
 *
db
 = 
pC§
->db;

2802 
Fts5Info
 *
pInfo
 = 
pC§
->pInfo;

2803 if–
pC§
->
aMem
==0 ){

2804 
nByã
 = (
Mem
Ë* 
pInfo
->
nCﬁ
;

2805 
pC§
->
aMem
 = (
Mem
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

2806 if–
pC§
->
aMem
==0 ){

2807 
rc
 = 
SQLITE4_NOMEM
;

2809 
i
;

2810 
i
=0; i<
pInfo
->
nCﬁ
; i++){

2811 
pC§
->
aMem
[
i
].
db
 = db;

2816 if–
pC§
->pC§==0 && 
rc
==
SQLITE4_OK
 ){

2817 
KVSt‹e
 *
pSt‹e
 = 
db
->
aDb
[
pInfo
->
iDb
].
pKV
;

2818 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pSt‹e
, &
pC§
->pCsr);

2821 if–
rc
==
SQLITE4_OK
 ){

2822 
u8
 *
aKey
 = 0; 
nKey
;

2823 c⁄° 
u8
 *
aD©a
; 
nD©a
;

2825 
rc
 = 
	`sqlôe4Fts5Pk
(
pC§
, 
pInfo
->
iTbl
, &
aKey
, &
nKey
);

2826 if–
rc
==
SQLITE4_OK
 ){

2827 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC§
->pC§, 
aKey
, 
nKey
, 0);

2828 if–
rc
==
SQLITE4_NOTFOUND
 ){

2829 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

2833 if–
rc
==
SQLITE4_OK
 ){

2834 
i
;

2835 
RowDecodî
 *
pCodec
;

2837 
rc
 = 
	`sqlôe4VdbeDecodîCª©e
(
db
,0, 
pC§
->pC§, 
pInfo
->
nCﬁ
, &
pCodec
);

2838 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pInfo
->
nCﬁ
; i++){

2839 
rc
 = 
	`sqlôe4VdbeDecodîGëCﬁumn
(
pCodec
, 
i
, 0, &
pC§
->
aMem
[i]);

2841 
	`sqlôe4VdbeDecodîDe°roy
(
pCodec
);

2844 if–
rc
==
SQLITE4_OK
 ) 
pC§
->
bMemVÆid
 = 1;

2848 if–
rc
==
SQLITE4_OK
 ){

2849 
	`as£π
–
pC§
->
bMemVÆid
 );

2850 *
µVÆ
 = &
pC§
->
aMem
[
iCﬁ
];

2854  
rc
;

2855 
	}
}

2857 
sqlôe4_mi_tokíize
(

2858 
sqlôe4_c⁄ãxt
 *
pCtx
,

2859 c⁄° *
zText
,

2860 
nText
,

2861 *
p
,

2862 (*
x
)(*, , , const *, , , )

2864 
rc
 = 
SQLITE4_OK
;

2865 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2867 if–
pC§
==0 ){

2868 
rc
 = 
SQLITE4_MISUSE
;

2870 
Fts5Info
 *
pInfo
 = 
pC§
->pInfo;

2871 
rc
 = 
pInfo
->
pTokíizî
->
	`xTokíize
(
p
,ÖInfo->p, 
zText
, 
nText
, 
x
);

2873  
rc
;

2874 
	}
}

2876 
Fts5Så
 *
	$·s5FödSå
(

2877 c⁄° 
u8
 *
aPk
, 
nPk
,

2878 
Fts5Ex¥Node
 *
p
,

2879 *
piSå


2881 
Fts5Så
 *
pRë
 = 0;

2882 if–
p
->
eTy≥
==
TOKEN_PRIMITIVE
 ){

2883 
iSå
 = *
piSå
;

2884 if–
iSå
<
p
->
pPhø£
->
nSå
 && iStr>=0

2885 && 
p
->
nPk
=ÚPk && 0==
	`memcmp
’->
aPk
,áPk,ÇPk)

2887 
pRë
 = &
p
->
pPhø£
->
aSå
[
iSå
];

2889 *
piSå
 = 
iSå
 - 
p
->
pPhø£
->
nSå
;

2892 
pRë
 = 
	`·s5FödSå
(
aPk
, 
nPk
, 
p
->
pLe·
, 
piSå
);

2893 if–
pRë
==0 )ÖRë = 
	`·s5FödSå
(
aPk
, 
nPk
, 
p
->
pRight
, 
piSå
);

2895  
pRë
;

2896 
	}
}

2898 
	$sqlôe4_mi_m©ch_cou¡
(

2899 
sqlôe4_c⁄ãxt
 *
pCtx
,

2900 
iC
,

2901 
iS
,

2902 
iPhø£
,

2903 *
≤M©ch


2905 
rc
 = 
SQLITE4_OK
;

2906 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

2907 if–
pC§
 ){

2908 
Fts5Ex¥Node
 *
pRoŸ
 = 
pC§
->
pEx¥
->pRoot;

2909 
nM©ch
 = 0;

2910 
Fts5Så
 *
pSå
;

2911 
iC›y
 = 
iPhø£
;

2912 
In°™˚Li°
 
sLi°
;

2914 
pSå
 = 
	`·s5FödSå
(
pRoŸ
->
aPk
,ÖRoŸ->
nPk
,ÖRoŸ, &
iC›y
);

2915 if–
pSå
 ){

2916 
	`·s5In°™˚Li°Inô
(
pSå
->
aLi°
,ÖSå->
nLi°
, &
sLi°
);

2917  0==
	`·s5In°™˚Li°Next
(&
sLi°
) ){

2918 if–(
iC
<0 || 
sLi°
.
iCﬁ
==iCË&& (
iS
<0 || sLi°.
iSåóm
==iSËË
nM©ch
++;

2921 *
≤M©ch
 = 
nM©ch
;

2923 
rc
 = 
SQLITE4_MISUSE
;

2925  
rc
;

2926 
	}
}

2928 
	$sqlôe4_mi_m©ch_off£t
(

2929 
sqlôe4_c⁄ãxt
 *
pCtx
,

2930 
iCﬁ
,

2931 
iPhø£
,

2932 
iM©ch
,

2933 *
piOff


2935  
SQLITE4_OK
;

2936 
	}
}

2938 
	$sqlôe4_mi_tŸÆ_m©ch_cou¡
(

2939 
sqlôe4_c⁄ãxt
 *
pCtx
,

2940 
iCﬁ
,

2941 
iPhø£
,

2942 *
≤M©ch
,

2943 *
≤Doc
,

2944 *
≤Rñev™t


2946  
SQLITE4_OK
;

2947 
	}
}

2949 
	$·s5SåLﬂdRowcou¡s
(

2950 
Fts5Så
 *
pSå
,

2951 
nSåóm
,

2952 *
™Row
,

2953 *
™RowC
,

2954 *
™RowS
,

2955 *
≤RowCS


2957 
u32
 
mask
 = 0;

2958 
iPªvCﬁ
 = -1;

2959 
In°™˚Li°
 
sLi°
;

2961 
	`·s5In°™˚Li°Inô
(
pSå
->
aLi°
,ÖSå->
nLi°
, &
sLi°
);

2962  0==
	`·s5In°™˚Li°Next
(&
sLi°
) ){

2963 if–
iPªvCﬁ
<0 ) (*
≤RowCS
)++;

2964 if–
sLi°
.
iCﬁ
!=
iPªvCﬁ
 ){

2965 
mask
 = 0;

2966 
™RowC
[
sLi°
.
iCﬁ
]++;

2968 if–(
mask
 & (1<<
sLi°
.
iSåóm
))==0 ){

2969 
™Row
[
sLi°
.
iCﬁ
 * 
nSåóm
 + sLi°.
iSåóm
]++;

2970 
mask
 |(1<<
sLi°
.
iSåóm
);

2971 
iPªvCﬁ
 = 
sLi°
.
iCﬁ
;

2974 
	}
}

2976 
	$·s5Ex¥LﬂdRowcou¡s
(

2977 
sqlôe4
 *
db
,

2978 
Fts5Curs‹
 *
pC§
,

2979 
nSåóm
,

2980 
Fts5Ex¥Node
 *
pNode
,

2981 *
piSå


2983 
rc
 = 
SQLITE4_OK
;

2985 if–
pNode
 ){

2986 
Fts5Info
 *
pInfo
 = 
pC§
->pInfo;

2988 if–
pNode
->
eTy≥
==
TOKEN_PRIMITIVE
 ){

2989 
Fts5Phø£
 *
pPhø£
 = 
pNode
->pPhrase;

2990 
iSå
 = *
piSå
;

2992 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
pNode
, 1);

2993  
rc
==
SQLITE4_OK
 && 
pNode
->
aPk
 ){

2994 
i
;

2995 
i
=0; i<
pPhø£
->
nSå
; i++){

2996 *
™Row
 = &
pC§
->™Row[(
iSå
+
i
Ë* 
pInfo
->
nCﬁ
 * 
nSåóm
];

2997 *
™RowC
 = &
pC§
->™RowC[(
iSå
+
i
Ë* 
pInfo
->
nCﬁ
];

2998 *
™RowS
 = &
pC§
->™RowS[(
iSå
+
i
Ë* 
nSåóm
];

2999 *
≤RowCS
 = &
pC§
->
™RowCS
[
iSå
+
i
];

3000 
	`·s5SåLﬂdRowcou¡s
(

3001 &
pPhø£
->
aSå
[
i
], 
nSåóm
, 
™Row
, 
™RowC
, 
™RowS
, 
≤RowCS


3004 
rc
 = 
	`·s5Ex¥Adv™˚
(
db
, 
pNode
, 0);

3007 *
piSå
 = 
iSå
 + 
pPhø£
->
nSå
;

3010 if–
rc
==
SQLITE4_OK
 ){

3011 
rc
 = 
	`·s5Ex¥LﬂdRowcou¡s
(
db
, 
pC§
, 
nSåóm
, 
pNode
->
pLe·
, 
piSå
);

3013 if–
rc
==
SQLITE4_OK
 ){

3014 
rc
 = 
	`·s5Ex¥LﬂdRowcou¡s
(
db
, 
pC§
, 
nSåóm
, 
pNode
->
pRight
, 
piSå
);

3018  
rc
;

3019 
	}
}

3021 
	$·s5C§LﬂdRowcou¡s
(
Fts5Curs‹
 *
pC§
){

3022 
rc
 = 
SQLITE4_OK
;

3024 if–
pC§
->
™Row
==0 ){

3025 
nSåóm
 = 
pC§
->
pGlobÆ
->nStream;

3026 
sqlôe4
 *
db
 = 
pC§
->db;

3027 
Fts5Ex¥
 *
pC›y
;

3028 
Fts5Ex¥
 *
pEx¥
 = 
pC§
->pExpr;

3029 
Fts5Info
 *
pInfo
 = 
pC§
->pInfo;

3030 *
™Row
;

3031 
iPhø£
 = 0;

3033 
pC§
->
™Row
 =ánRow = (*)
	`sqlôe4DbMÆlocZîo
(
db
, () * (

3034 
pEx¥
->
nPhø£
 * 
pInfo
->
nCﬁ
 * 
pC§
->
pGlobÆ
->
nSåóm


3035 + 
pEx¥
->
nPhø£
 * 
pInfo
->
nCﬁ


3036 + 
pEx¥
->
nPhø£
 * 
pC§
->
pGlobÆ
->
nSåóm


3037 + 
pEx¥
->
nPhø£


3039 if–!
™Row
 )  
SQLITE4_NOMEM
;

3040 
pC§
->
™RowC
 = &
™Row
[
pEx¥
->
nPhø£
*
pInfo
->
nCﬁ
*pC§->
pGlobÆ
->
nSåóm
];

3041 
pC§
->
™RowS
 = &pC§->
™RowC
[
pEx¥
->
nPhø£
 * 
pInfo
->
nCﬁ
];

3042 
pC§
->
™RowCS
 = &pC§->
™RowS
[
pEx¥
->
nPhø£
 *ÖC§->
pGlobÆ
->
nSåóm
];

3044 
rc
 = 
	`·s5P¨£Ex¥essi⁄
(
db
, 
pInfo
->
pTokíizî
,ÖInfo->
p
,

3045 
pInfo
->
iRoŸ
,ÖInfo->
azCﬁ
,ÖInfo->
nCﬁ
, 
pC§
->
zEx¥
, &
pC›y
, 0

3047 if–
rc
==
SQLITE4_OK
 ){

3048 
rc
 = 
	`·s5O≥nEx¥Curs‹s
(
db
, 
pInfo
, 
pC›y
->
pRoŸ
);

3050 if–
rc
==
SQLITE4_OK
 ){

3051 
rc
 = 
	`·s5Ex¥LﬂdRowcou¡s
(
db
, 
pC§
, 
nSåóm
, 
pC›y
->
pRoŸ
, &
iPhø£
);

3054 
	`·s5Ex¥essi⁄Fªe
(
db
, 
pC›y
);

3057  
rc
;

3058 
	}
}

3060 
	$sqlôe4_mi_row_cou¡
(

3061 
sqlôe4_c⁄ãxt
 *
pCtx
,

3062 
iC
,

3063 
iS
,

3064 
iP
,

3065 *
≤


3067 
rc
 = 
SQLITE4_OK
;

3068 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

3069 if–
pC§
==0 ){

3070 
rc
 = 
SQLITE4_MISUSE
;

3072 
rc
 = 
	`·s5C§LﬂdGlobÆ
(
pC§
);

3073 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`·s5C§LﬂdRowcou¡s
(
pC§
);

3075 if–
rc
==
SQLITE4_OK
 ){

3076 
i
;

3077 
nRow
 = 0;

3078 
nSåóm
 = 
pC§
->
pGlobÆ
->nStream;

3079 
nCﬁ
 = 
pC§
->
pInfo
->nCol;

3080 *
aRow
 = &
pC§
->
™Row
[
iP
 * 
nSåóm
 * 
nCﬁ
];

3082 if–
iC
<0 && 
iS
<0 ){

3083 
nRow
 = 
pC§
->
™RowCS
[
iP
];

3084 }if–
iC
<0 ){

3085 
i
=0; i<
nCﬁ
; i++Ë
nRow
 +
aRow
[i*
nSåóm
 + 
iS
];

3086 }if–
iS
<0 ){

3087 
nRow
 = 
pC§
->
™RowC
[
iP
*
nCﬁ
 + 
iC
];

3088 }if–
iC
<
nCﬁ
 && 
iS
<
nSåóm
 ){

3089 
nRow
 = 
aRow
[
iC
 * 
nSåóm
 + 
iS
];

3092 *
≤
 = 
nRow
;

3095  
rc
;

3096 
	}
}

3098 
	$·s5IãrSëCuºít
(
Fts5M©chIãr
 *
pIãr
, 
nLi°
){

3099 
In°™˚Li°
 *
pBe°
 = 0;

3100 
i
;

3102 
i
=0; i<
nLi°
; i++){

3103 
In°™˚Li°
 *
p
 = &
pIãr
->
aLi°
[
i
];

3104 if–
	`·s5In°™˚Li°Eof
(
p
)==0 ){

3105 if–(
pBe°
==0)

3106 || (
p
->
iCﬁ
<
pBe°
->iCol)

3107 || (
p
->
iCﬁ
==
pBe°
->iCﬁ &&Ö->
iOff
<pBest->iOff)

3109 
pBe°
 = 
p
;

3114 if–
pBe°
==0 ){

3115 
pIãr
->
iCuºít
 = -1;

3117 
pIãr
->
iCuºít
 = 
pBe°
 -ÖIãr->
aLi°
;

3119 
	}
}

3121 
	$·s5InôEx¥Iãøt‹
(

3122 c⁄° 
u8
 *
aPk
,

3123 
nPk
,

3124 
Fts5Ex¥Node
 *
p
,

3125 
Fts5M©chIãr
 *
pIãr


3127 if–
p
 ){

3128 if–
p
->
eTy≥
==
TOKEN_PRIMITIVE
 ){

3129 if–
p
->
nPk
=ÚPk && 0==
	`memcmp
(
aPk
,Ö->aPk,ÇPk) ){

3130 
i
;

3131 
i
=0; i<
p
->
pPhø£
->
nSå
; i++){

3132 
Fts5Så
 *
pSå
 = &
p
->
pPhø£
->
aSå
[
i
];

3133 
In°™˚Li°
 *
pLi°
 = &
pIãr
->
aLi°
[pIãr->
iCuºít
++];

3134 
	`·s5In°™˚Li°Inô
(
pSå
->
aLi°
,ÖSå->
nLi°
, 
pLi°
);

3135 
	`·s5In°™˚Li°Next
(
pLi°
);

3138 
	`mem£t
(&
pIãr
->
aLi°
[pIãr->
iCuºít
], 0, (
In°™˚Li°
));

3139 
pIãr
->
iCuºít
 +
p
->
pPhø£
->
nSå
;

3142 
	`·s5InôEx¥Iãøt‹
(
aPk
, 
nPk
, 
p
->
pLe·
, 
pIãr
);

3143 
	`·s5InôEx¥Iãøt‹
(
aPk
, 
nPk
, 
p
->
pRight
, 
pIãr
);

3145 
	}
}

3147 
	$·s5InôIãøt‹
(
Fts5Curs‹
 *
pC§
){

3148 
Fts5M©chIãr
 *
pIãr
 = 
pC§
->pIter;

3149 
Fts5Ex¥Node
 *
pRoŸ
 = 
pC§
->
pEx¥
->pRoot;

3151 
pIãr
->
iCuºít
 = 0;

3152 
	`·s5InôEx¥Iãøt‹
(
pRoŸ
->
aPk
,ÖRoŸ->
nPk
,ÖRoŸ, 
pIãr
);

3153 
pIãr
->
iM©ch
 = 0;

3154 
pIãr
->
bVÆid
 = 1;

3155 
	`·s5IãrSëCuºít
(
pIãr
, 
pC§
->
pEx¥
->
nPhø£
);

3156 
	}
}

3158 
	$sqlôe4_mi_m©ch_dëaû
(

3159 
sqlôe4_c⁄ãxt
 *
pCtx
,

3160 
iM©ch
,

3161 *
piOff
,

3162 *
piC
,

3163 *
piS
,

3164 *
piP


3166 
rc
 = 
SQLITE4_OK
;

3167 
Fts5Curs‹
 *
pC§
 = 
pCtx
->
pFts
;

3168 if–
pC§
==0 ){

3169 
rc
 = 
SQLITE4_MISUSE
;

3171 
nPhø£
 = 
pC§
->
pEx¥
->nPhrase;

3172 
Fts5M©chIãr
 *
pIãr
 = 
pC§
->pIter;

3173 if–
pIãr
==0 ){

3174 
pC§
->
pIãr
 =ÖIã∏(
Fts5M©chIãr
 *)
	`sqlôe4DbMÆlocZîo
(

3175 
pC§
->
db
, (
Fts5M©chIãr
Ë+ (
In°™˚Li°
)*
nPhø£


3177 if–
pIãr
 ){

3178 
pIãr
->
aLi°
 = (
In°™˚Li°
 *)&pIter[1];

3180 
rc
 = 
SQLITE4_NOMEM
;

3184 if–
rc
==
SQLITE4_OK
 && (
pIãr
->
bVÆid
==0 || 
iM©ch
<pIter->iMatch) ){

3185 
	`·s5InôIãøt‹
(
pC§
);

3187 
i
;

3188 
i
=0; i<
pC§
->
pEx¥
->
nPhø£
; i++){

3189 
Fts5Så
 *
pSå
 = 
pC§
->
pEx¥
->
≠Phø£
[
i
];

3190 
	`·s5In°™˚Li°Inô
(
pSå
->
aLi°
,ÖSå->
nLi°
, &
pIãr
->aLi°[
i
]);

3191 
	`·s5In°™˚Li°Next
(&
pIãr
->
aLi°
[
i
]);

3193 
pIãr
->
iM©ch
 = 0;

3194 
	`·s5IãrSëCuºít
(
pIãr
, 
pC§
->
pEx¥
->
nPhø£
);

3198 if–
rc
==
SQLITE4_OK
 ){

3199 
	`as£π
–
pIãr
->
iM©ch
<=iMatch );

3200  
pIãr
->
iCuºít
>=0 &&ÖIãr->
iM©ch
<iMatch ){

3201 
	`·s5In°™˚Li°Next
(&
pIãr
->
aLi°
[pIãr->
iCuºít
]);

3202 
	`·s5IãrSëCuºít
(
pIãr
, 
pC§
->
pEx¥
->
nPhø£
);

3203 
pIãr
->
iM©ch
++;

3205 if–
pIãr
->
iCuºít
<0 ){

3206 
rc
 = 
SQLITE4_NOTFOUND
;

3208 
In°™˚Li°
 *
p
 = &
pIãr
->
aLi°
[pIãr->
iCuºít
];

3209 *
piOff
 = 
p
->
iOff
;

3210 *
piC
 = 
p
->
iCﬁ
;

3211 *
piS
 = 
p
->
iSåóm
;

3212 *
piP
 = 
pIãr
->
iCuºít
;

3216  
rc
;

3217 
	}
}

3223 #ifde‡
SQLITE4_TEST


3224 
·s5PrötEx¥Node
(
sqlôe4
 *, c⁄° **, 
Fts5Ex¥Node
 *, **);

3225 
	$·s5PrötEx¥NodeP¨í
(

3226 
sqlôe4
 *
db
, c⁄° **
azCﬁ
,

3227 
Fts5Ex¥Node
 *
pNode
,

3228 **
pzRë


3230 
bP¨í
 = (
pNode
->
eTy≥
!=
TOKEN_PRIMITIVE
 ||ÖNode->
pPhø£
->
nSå
>1);

3231 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_db_ív
(
db
);

3232 *
zRë
 = *
pzRë
;

3234 if–
bP¨í
 ) 
zRë
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%z(", zRet);

3235 
	`·s5PrötEx¥Node
(
db
, 
azCﬁ
, 
pNode
, &
zRë
);

3236 if–
bP¨í
 ) 
zRë
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%z)", zRet);

3238 *
pzRë
 = 
zRë
;

3239  
SQLITE4_OK
;

3240 
	}
}

3241 
	$·s5PrötEx¥Node
(

3242 
sqlôe4
 *
db
,

3243 c⁄° **
azCﬁ
,

3244 
Fts5Ex¥Node
 *
pNode
,

3245 **
pzRë


3247 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_db_ív
(
db
);

3248 *
zRë
 = *
pzRë
;

3250 
	`as£π
(

3251 
pNode
->
eTy≥
==
TOKEN_AND
 ||ÖNode->eTy≥==
TOKEN_OR


3252 || 
pNode
->
eTy≥
==
TOKEN_NOT
 ||ÖNode->eTy≥==
TOKEN_PRIMITIVE


3254 
	`as£π
–(
pNode
->
eTy≥
==
TOKEN_PRIMITIVE
)==’Node->
pPhø£
!=0) );

3256 if–
pNode
->
eTy≥
==
TOKEN_PRIMITIVE
 ){

3257 
iSå
;

3258 
Fts5Phø£
 *
pPhø£
 = 
pNode
->pPhrase;

3259 if–
pPhø£
->
iCﬁ
>=0 ){

3260 
zRë
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%z\"%s\":", zRë, 
azCﬁ
[
pPhø£
->
iCﬁ
]);

3262 
iSå
=0; iSå<
pPhø£
->
nSå
; iStr++){

3263 
iTokí
;

3264 
Fts5Så
 *
pSå
 = &
pPhø£
->
aSå
[
iSå
];

3265 if–
iSå
>0 ){

3266 
zRë
 = 
	`sqlôe4_m¥ötf
(

3267 
pEnv
, "%z NEAR/%d ", 
zRë
, 
pPhø£
->
aiNór
[
iSå
-1]

3270 
iTokí
=0; iTokí<
pSå
->
nTokí
; iToken++){

3271 
nRë
 = 
	`sqlôe4SåÀn30
(
zRë
);

3272 c⁄° *
z
 = 
pSå
->
aTokí
[
iTokí
].z;

3273 
n
 = 
pSå
->
aTokí
[
iTokí
].n;

3274 
i
;

3276 
zRë
 = (*)
	`sqlôe4_ªÆloc
(
pEnv
, zRë, 
nRë
 + 
n
*2+4);

3277 if–
iTokí
>0 ) 
zRë
[
nRë
++] = '+';

3278 
zRë
[
nRë
++] = '"';

3280 
i
=0; i<
n
; i++){

3281 if–
z
[
i
]=='"' ) 
zRë
[
nRë
++] = '"';

3282 
zRë
[
nRë
++] = 
z
[
i
];

3284 
zRë
[
nRë
++] = '"';

3285 if–
pSå
->
aTokí
[
iTokí
].
bPªfix
 ){

3286 
zRë
[
nRë
++] = '*';

3288 
zRë
[
nRë
++] = '\0';

3292 
	`·s5PrötEx¥NodeP¨í
(
db
, 
azCﬁ
, 
pNode
->
pLe·
, &
zRë
);

3293  
pNode
->
eTy≥
 ){

3294 
TOKEN_AND
:

3295 
zRë
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%z AND ", zRet);

3297 
TOKEN_OR
:

3298 
zRë
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%z OR ", zRet);

3300 
TOKEN_NOT
:

3301 
zRë
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%z NOT ", zRet);

3304 
	`·s5PrötEx¥NodeP¨í
(
db
, 
azCﬁ
, 
pNode
->
pRight
, &
zRë
);

3307 *
pzRë
 = 
zRë
;

3308  
SQLITE4_OK
;

3309 
	}
}

3310 
	$·s5PrötEx¥
(

3311 
sqlôe4
 *
db
,

3312 c⁄° **
azCﬁ
,

3313 
Fts5Ex¥
 *
pEx¥
,

3314 **
pzRë


3316  
	`·s5PrötEx¥Node
(
db
, 
azCﬁ
, 
pEx¥
->
pRoŸ
, 
pzRë
);

3317 
	}
}

3324 
	$·s5_∑r£_ex¥
(

3325 
sqlôe4_c⁄ãxt
 *
pCtx
,

3326 
nVÆ
,

3327 
sqlôe4_vÆue
 **
aVÆ


3329 
rc
;

3330 
Fts5Ex¥
 *
pEx¥
 = 0;

3331 
Fts5Tokíizî
 *
pTok
;

3332 
sqlôe4_tokíizî
 *
p
 = 0;

3333 
sqlôe4
 *
db
;

3335 c⁄° *
zTokíizî
;

3336 c⁄° *
zEx¥
;

3337 c⁄° *
zTbl
;

3338 *
zEº
 = 0;

3339 *
zRë
 = 0;

3340 c⁄° **
azCﬁ
 = 0;

3341 
nCﬁ
 = 0;

3342 
sqlôe4_°mt
 *
pStmt
 = 0;

3344 
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pCtx
);

3345 
	`as£π
–
nVÆ
==3 );

3346 
zTokíizî
 = 
	`sqlôe4_vÆue_ãxt
(
aVÆ
[0], 0);

3347 
zEx¥
 = 
	`sqlôe4_vÆue_ãxt
(
aVÆ
[1], 0);

3348 
zTbl
 = 
	`sqlôe4_vÆue_ãxt
(
aVÆ
[2], 0);

3350 if–
	`sqlôe4SåÀn30
(
zTbl
)>0 ){

3351 
i
;

3352 *
zSql
 = 
	`sqlôe4MPrötf
(
db
, "SELECT * FROM '%q'", 
zTbl
);

3353 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

3354 
	`sqlôe4DbFªe
(
db
, 
zSql
);

3355 if–
rc
!=
SQLITE4_OK
 ){

3356 
	`sqlôe4_ªsu…_îr‹
(
pCtx
, 
	`sqlôe4_îrmsg
(
db
), -1);

3357 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

3360 
nCﬁ
 = 
	`sqlôe4_cﬁumn_cou¡
(
pStmt
);

3361 
azCﬁ
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (*)*
nCﬁ
);

3362 
i
=0; i<
nCﬁ
; i++){

3363 
azCﬁ
[
i
] = 
	`sqlôe4_cﬁumn_«me
(
pStmt
, i);

3367 
pTok
 = 
	`·s5FödTokíizî
(
db
, 
zTokíizî
);

3368 if–
pTok
==0 ){

3369 
zEº
 = 
	`sqlôe4MPrötf
(
db
, "nÿsuchÅokíizî: %s", 
zTokíizî
);

3370 
·s5_∑r£_ex¥_out
;

3372 
rc
 = 
pTok
->
	`xCª©e
’Tok->
pCtx
, 0, 0, &
p
);

3373 if–
rc
!=
SQLITE4_OK
 ){

3374 
zEº
 = 
	`sqlôe4MPrötf
(
db
, "îr‹ cª©ögÅokíizî: %d", 
rc
);

3375 
·s5_∑r£_ex¥_out
;

3379 
rc
 = 
	`·s5P¨£Ex¥essi⁄
(

3380 
db
, 
pTok
, 
p
, 0, (**)
azCﬁ
, 
nCﬁ
, 
zEx¥
, &
pEx¥
, &
zEº
);

3381 if–
rc
!=
SQLITE4_OK
 ){

3382 if–
zEº
==0 ){

3383 
zEº
 = 
	`sqlôe4MPrötf
(
db
, "îr‹Ö¨sögÉx¥essi⁄: %d", 
rc
);

3385 
·s5_∑r£_ex¥_out
;

3388 
	`·s5PrötEx¥
(
db
, 
azCﬁ
, 
pEx¥
, &
zRë
);

3389 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
zRë
, -1, 
SQLITE4_TRANSIENT
, 0);

3390 
	`·s5Ex¥essi⁄Fªe
(
db
, 
pEx¥
);

3391 
	`sqlôe4_‰ì
(
	`sqlôe4_db_ív
(
db
), 
zRë
);

3393 
·s5_∑r£_ex¥_out
:

3394 if–
p
 ) 
pTok
->
	`xDe°roy
(p);

3395 
	`sqlôe4DbFªe
(
db
, 
azCﬁ
);

3396 
	`sqlôe4_föÆize
(
pStmt
);

3397 if–
zEº
 ){

3398 
	`sqlôe4_ªsu…_îr‹
(
pCtx
, 
zEº
, -1);

3399 
	`sqlôe4DbFªe
(
db
, 
zEº
);

3401 
	}
}

3407 
	$sqlôe4InôFts5
(
sqlôe4
 *
db
){

3408 #ifde‡
SQLITE4_TEST


3409 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(

3410 
db
, "·s5_∑r£_ex¥", 3, 0, 
·s5_∑r£_ex¥
, 0, 0, 0

3412 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3414  
	`sqlôe4InôFts5Func
(
db
);

3415 
	}
}

	@src/fts5func.c

22 
	~"sqlôeI¡.h
"

23 
	~<m©h.h
>

25 
	$·s5Tﬁowî
(
c
){

26 if–
c
>='A' && c<='Z' ) c = c + ('a' - 'A');

27  
c
;

28 
	}
}

30 
	$·s5Sim∂eCª©e
(

31 *
pCtx
,

32 c⁄° **
azArg
,

33 
nArg
,

34 
sqlôe4_tokíizî
 **
µ


36 *
µ
 = (
sqlôe4_tokíizî
 *)
pCtx
;

37  
SQLITE4_OK
;

38 
	}
}

40 
	$·s5Sim∂eDe°roy
(
sqlôe4_tokíizî
 *
p
){

41  
SQLITE4_OK
;

42 
	}
}

44 
Fts5R™kCtx
 
	tFts5R™kCtx
;

45 
	sFts5R™kCtx
 {

46 
sqlôe4
 *
	mdb
;

47 *
	maAvgdl
;

48 
	mnPhø£
;

49 *
	maIdf
;

52 
	$·s5R™kFªeCtx
(*
pNŸU£d
, *
pCtx
){

53 if–
pCtx
 ){

54 
Fts5R™kCtx
 *
p
 = (Fts5R™kCtx *)
pCtx
;

55 
	`sqlôe4DbFªe
(
p
->
db
,Ö);

57 
	}
}

59 
	#BM25_EXPLAIN
 0x01

	)

60 
	#BM25_FCOLUMNS
 0x02

	)

61 
	#BM25_FSTREAMS
 0x04

	)

63 
	$·s5GëSizeFªqSˇÀ
(

64 
sqlôe4_c⁄ãxt
 *
pCtx
,

65 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
,

66 
bm25mask
,

67 
iPhø£
,

68 
iFõld
,

69 *
≤Size
,

70 *
≤Fªq
,

71 *
pdSˇÀ


73 
rc
;

74 
sˇÀ
 = 1.0;

75 
nSize
 = 0;

76 
nFªq
 = 0;

78 if–
bm25mask
 & 
BM25_FCOLUMNS
 ){

79 
rc
 = 
	`sqlôe4_mi_m©ch_cou¡
(
pCtx
, 
iFõld
, -1, 
iPhø£
, &
nFªq
);

80 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4_mi_size
(
pCtx
, 
iFõld
, -1, &
nSize
);

81 if–
nArg
>
iFõld
 ) 
sˇÀ
 = 
	`sqlôe4_vÆue_doubÀ
(
≠Arg
[iField]);

82 }if–
bm25mask
 & 
BM25_FSTREAMS
 ){

83 
rc
 = 
	`sqlôe4_mi_m©ch_cou¡
(
pCtx
, -1, 
iFõld
, 
iPhø£
, &
nFªq
);

84 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4_mi_size
(
pCtx
, -1, 
iFõld
, &
nSize
);

85 if–
nArg
>
iFõld
 ) 
sˇÀ
 = 
	`sqlôe4_vÆue_doubÀ
(
≠Arg
[iField]);

87 
rc
 = 
	`sqlôe4_mi_m©ch_cou¡
(
pCtx
, -1, -1, 
iPhø£
, &
nFªq
);

88 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4_mi_size
(
pCtx
, -1, -1, &
nSize
);

91 *
≤Size
 = 
nSize
;

92 *
≤Fªq
 = 
nFªq
;

93 *
pdSˇÀ
 = 
sˇÀ
;

94  
rc
;

95 
	}
}

111 
	$·s5R™k
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

112 c⁄° 
b
 = 0.65;

113 c⁄° 
k1
 = 1.6;

115 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pCtx
);

116 
rc
 = 
SQLITE4_OK
;

117 
Fts5R™kCtx
 *
p
;

118 
i
;

119 
ønk
 = 0.0;

121 
bEx∂aö
;

122 *
zEx∂aö
 = 0;

123 
nFõld
 = 1;

125 
bm25mask
 = 
	`SQLITE4_PTR_TO_INT
(
	`sqlôe4_c⁄ãxt_≠pd©a
(
pCtx
));

126 
bEx∂aö
 = (
bm25mask
 & 
BM25_EXPLAIN
);

128 if–
bm25mask
 & 
BM25_FCOLUMNS
 ) 
	`sqlôe4_mi_cﬁumn_cou¡
(
pCtx
, &
nFõld
);

129 if–
bm25mask
 & 
BM25_FSTREAMS
 ) 
	`sqlôe4_mi_°ªam_cou¡
(
pCtx
, &
nFõld
);

131 
p
 = 
	`sqlôe4_auxd©a_„tch
(
pCtx
, 0);

132 if–
p
==0 ){

133 
nPhø£
;

134 
nByã
;

136 
	`sqlôe4_mi_phø£_cou¡
(
pCtx
, &
nPhø£
);

137 
nByã
 = (
Fts5R™kCtx
Ë+ (
nPhø£
+
nFõld
) * ();

138 
p
 = (
Fts5R™kCtx
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

139 
	`sqlôe4_auxd©a_°‹e
(
pCtx
, 0, (*)
p
, 
·s5R™kFªeCtx
, 0);

140 
p
 = 
	`sqlôe4_auxd©a_„tch
(
pCtx
, 0);

142 if–!
p
 ){

143 
rc
 = 
SQLITE4_NOMEM
;

145 
N
;

146 
ni
;

148 
p
->
db
 = db;

149 
p
->
nPhø£
 =ÇPhrase;

150 
p
->
aIdf
 = (*)&p[1];

151 
p
->
aAvgdl
 = &p->
aIdf
[
nPhø£
];

154 
rc
 = 
	`sqlôe4_mi_tŸÆ_rows
(
pCtx
, &
N
);

155 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nPhø£
; i++){

156 
rc
 = 
	`sqlôe4_mi_row_cou¡
(
pCtx
, -1, -1, 
i
, &
ni
);

157 if–
rc
==
SQLITE4_OK
 ){

158 
	`as£π
–
ni
<=
N
 );

159 
p
->
aIdf
[
i
] = 
	`log
((0.5 + 
N
 - 
ni
) / (0.5 +Çi));

165 if–
rc
==
SQLITE4_OK
 ){

166 
iFõld
;

167 
iFõld
=0; iFõld<
nFõld
; iField++){

168 
nTŸÆ
;

169 if–
bm25mask
 & 
BM25_FCOLUMNS
 ){

170 
rc
 = 
	`sqlôe4_mi_tŸÆ_size
(
pCtx
, 
iFõld
, -1, &
nTŸÆ
);

171 }if–
bm25mask
 & 
BM25_FSTREAMS
 ){

172 
rc
 = 
	`sqlôe4_mi_tŸÆ_size
(
pCtx
, -1, 
iFõld
, &
nTŸÆ
);

174 
rc
 = 
	`sqlôe4_mi_tŸÆ_size
(
pCtx
, -1, -1, &
nTŸÆ
);

176 if–
rc
==
SQLITE4_OK
 ){

177 
p
->
aAvgdl
[
iFõld
] = ()
nTŸÆ
 / ()
N
;

184 if–
bEx∂aö
 ){

185 
iFõld
;

186 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

187 
db
, 
zEx∂aö
, "%s<table><tr><th>Stream<th>Scale<th>avgsl<th>sl",

188 
zEx∂aö


190 
i
=0; i<
p
->
nPhø£
; i++){

191 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

192 
db
, 
zEx∂aö
, "%s<th>tf</•™><sub>%d</sub>", zEx∂aö, 
i


195 
iFõld
=0; 
rc
==
SQLITE4_OK
 && iFõld<
nFõld
; iField++){

196 
dl
, 
tf
;

197 
sˇÀ
;

198 
rc
 = 
	`·s5GëSizeFªqSˇÀ
(

199 
pCtx
, 
nArg
, 
≠Arg
, 
bm25mask
, 0, 
iFõld
, &
dl
, &
tf
, &
sˇÀ


201 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

202 
db
, 
zEx∂aö
, "%s<tr><td>%d<td>%.2f<td>%.2f<td>%d",

203 
zEx∂aö
, 
iFõld
, 
sˇÀ
, 
p
->
aAvgdl
[iFõld], 
dl


205 
i
=0; 
rc
==
SQLITE4_OK
 && i<
p
->
nPhø£
; i++){

206 
rc
 = 
	`·s5GëSizeFªqSˇÀ
(

207 
pCtx
, 
nArg
, 
≠Arg
, 
bm25mask
, 
i
, 
iFõld
, &
dl
, &
tf
, &
sˇÀ


209 
zEx∂aö
 = 
	`sqlôe4MAµídf
(
db
, zEx∂aö, "%s<td>%d", zEx∂aö, 
tf
);

212 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

213 
db
, 
zEx∂aö
, "%s</table><table><tr><th>Phrase<th>IDF", zExplain

215 
i
=0; i<
nFõld
; i++){

216 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

217 
db
, 
zEx∂aö
, "%s<th><span style=text-decoration:overline>"

218 "tf</•™><sub>s%d</sub>", 
zEx∂aö
, 
i


221 
zEx∂aö
 = 
	`sqlôe4MAµídf
(
db
, zExplain, "%s<th>rank", zExplain);

224 
i
=0; 
rc
==
SQLITE4_OK
 && i<
p
->
nPhø£
; i++){

225 
iFõld
;

226 
t‚s
 = 0.0;

227 
¥™k
;

229 if–
bEx∂aö
 ){

230 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

231 
db
, 
zEx∂aö
, "%s<å><td>%d<td>%.2f", zEx∂aö, 
i
, 
p
->
aIdf
[i]

235 
iFõld
 = 0; iFõld<
nFõld
; iField++){

236 
sˇÀ
 = 1.0;

237 
tf
;

238 
t‚
;

239 
dl
;

240 
B
;

245 
rc
 = 
	`·s5GëSizeFªqSˇÀ
(

246 
pCtx
, 
nArg
, 
≠Arg
, 
bm25mask
, 
i
, 
iFõld
, &
dl
, &
tf
, &
sˇÀ


249 
B
 = (1.0 - 
b
Ë+ b * ()
dl
 / 
p
->
aAvgdl
[
iFõld
];

250 
t‚
 = 
sˇÀ
 * ()
tf
 / 
B
;

251 
t‚s
 +
t‚
;

254 if–
bEx∂aö
 ){

255 
zEx∂aö
 = 
	`sqlôe4MAµídf
(
db
, zEx∂aö, "%s<td>%.2f", zEx∂aö, 
t‚
);

259 
¥™k
 = 
p
->
aIdf
[
i
] * 
t‚s
 / (
k1
 +Åfns);

260 if–
bEx∂aö
 ){

261 
zEx∂aö
 = 
	`sqlôe4MAµídf
(
db
, zEx∂aö, "%s<td>%.2f", zEx∂aö, 
¥™k
);

265 
ønk
 +
¥™k
;

268 if–
rc
==
SQLITE4_OK
 ){

269 if–
bEx∂aö
 ){

270 
zEx∂aö
 = 
	`sqlôe4MAµídf
(

271 
db
, 
zEx∂aö
, "%s</èbÀ><b>ovîÆ»ønk=%.2f</b>", zEx∂aö, 
ønk


273 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
zEx∂aö
, -1, 
SQLITE4_TRANSIENT
, 0);

275 
	`sqlôe4_ªsu…_doubÀ
(
pCtx
, 
ønk
);

278 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

280 
	`sqlôe4DbFªe
(
db
, 
zEx∂aö
);

281 
	}
}

283 
Snù≥t
 
	tSnù≥t
;

284 
Snù≥tText
 
	tSnù≥tText
;

286 
	sSnù≥t
 {

287 
	miCﬁ
;

288 
	miOff
;

289 
u64
 
	mhlmask
;

292 
	sSnù≥tText
 {

293 *
	mzOut
;

294 
	mnOut
;

295 
	mnAŒoc
;

298 
Snù≥tCtx
 
	tSnù≥tCtx
;

299 
	sSnù≥tCtx
 {

300 
sqlôe4
 *
	mdb
;

301 
	mnTokí
;

302 
	miOff
;

303 
u64
 
	mmask
;

304 c⁄° *
	mzSèπ
;

305 c⁄° *
	mzEnd
;

306 c⁄° *
	mzEŒù£s
;

308 
Snù≥tText
 *
	mpOut
;

310 
	miFrom
;

311 
	miTo
;

312 c⁄° *
	mzText
;

313 
	mrc
;

316 
	$·s5Snù≥tAµíd
(
Snù≥tCtx
 *
p
, c⁄° *
z
, 
n
){

317 if–
p
->
rc
==
SQLITE4_OK
 ){

318 
Snù≥tText
 *
pOut
 = 
p
->pOut;

319 if–
n
<0 )Ç = 
	`°æí
(
z
);

320 if–(
pOut
->
nOut
 + 
n
Ë>ÖOut->
nAŒoc
 ){

321 
nNew
 = (
pOut
->
nOut
+
n
) * 2;

323 
pOut
->
zOut
 = 
	`sqlôe4DbRóŒocOrFªe
(
p
->
db
,ÖOut->zOut, 
nNew
);

324 if–
pOut
->
zOut
==0 ){

325 
p
->
rc
 = 
SQLITE4_NOMEM
;

328 
pOut
->
nAŒoc
 = 
	`sqlôe4DbMÆlocSize
(
p
->
db
,ÖOut->
zOut
);

331 
	`mem˝y
(&
pOut
->
zOut
[pOut->
nOut
], 
z
, 
n
);

332 
pOut
->
nOut
 +
n
;

334 
	}
}

336 
	$·s5Snù≥tCb
(

337 *
pCtx
,

338 
iSåóm
,

339 
iOff
,

340 c⁄° *
z
, 
n
,

341 
iSrc
, 
nSrc


343 
Snù≥tCtx
 *
p
 = (Snù≥tCtx *)
pCtx
;

345 if–
iOff
<
p
->iOff ){

347 }if–
iOff
>=(
p
->iOf‡+Ö->
nTokí
) ){

348 
	`·s5Snù≥tAµíd
(
p
, &p->
zText
[p->
iFrom
],Ö->
iTo
 -Ö->iFrom);

349 
	`·s5Snù≥tAµíd
(
p
,Ö->
zEŒù£s
, -1);

350 
p
->
iFrom
 = -1;

353 
bHighlight
;

355 
bHighlight
 = (
p
->
mask
 & ((
u64
)1 << (
iOff
-p->iOff))) ? 1 : 0;

357 if–
p
->
iFrom
==0 &&Ö->
iOff
!=0 ){

358 
p
->
iFrom
 = 
iSrc
;

359 if–
p
->
pOut
->
nOut
==0 ) 
	`·s5Snù≥tAµíd
’,Ö->
zEŒù£s
, -1);

362 if–
bHighlight
 ){

363 
	`·s5Snù≥tAµíd
(
p
, &p->
zText
[p->
iFrom
], 
iSrc
 -Ö->iFrom);

364 
	`·s5Snù≥tAµíd
(
p
,Ö->
zSèπ
, -1);

365 
	`·s5Snù≥tAµíd
(
p
, &p->
zText
[
iSrc
], 
nSrc
);

366 
	`·s5Snù≥tAµíd
(
p
,Ö->
zEnd
, -1);

367 
p
->
iTo
 =Ö->
iFrom
 = 
iSrc
+
nSrc
;

369 
p
->
iTo
 = 
iSrc
 + 
nSrc
;

374 
	}
}

376 
	$·s5Snù≥tText
(

377 
sqlôe4_c⁄ãxt
 *
pCtx
,

378 
Snù≥t
 *
pSnù
,

379 
Snù≥tText
 *
pText
,

380 
nTokí
,

381 c⁄° *
zSèπ
,

382 c⁄° *
zEnd
,

383 c⁄° *
zEŒù£s


385 
rc
;

386 
sqlôe4_vÆue
 *
pVÆ
 = 0;

388 
u64
 
mask
 = 
pSnù
->
hlmask
;

389 
iOff
 = 
pSnù
->iOff;

390 
iCﬁ
 = 
pSnù
->iCol;

392 
rc
 = 
	`sqlôe4_mi_cﬁumn_vÆue
(
pCtx
, 
iCﬁ
, &
pVÆ
);

393 if–
rc
==
SQLITE4_OK
 ){

394 
Snù≥tCtx
 
sCtx
;

395 
nText
;

397 
	`mem£t
(&
sCtx
, 0, (sCtx));

398 
sCtx
.
zText
 = 
	`sqlôe4_vÆue_ãxt
(
pVÆ
, &
nText
);

399 
sCtx
.
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pCtx
);

400 
sCtx
.
nTokí
 =ÇToken;

401 
sCtx
.
iOff
 = iOff;

402 
sCtx
.
mask
 = mask;

403 
sCtx
.
zSèπ
 = zStart;

404 
sCtx
.
zEnd
 = zEnd;

405 
sCtx
.
zEŒù£s
 = zEllipses;

406 
sCtx
.
pOut
 = 
pText
;

408 
	`sqlôe4_mi_tokíize
(
pCtx
, 
sCtx
.
zText
, 
nText
, &sCtx, 
·s5Snù≥tCb
);

409 if–
sCtx
.
rc
==
SQLITE4_OK
 && sCtx.
iFrom
>0 ){

410 
	`·s5Snù≥tAµíd
(&
sCtx
, &sCtx.
zText
[sCtx.
iFrom
], 
nText
 - sCtx.iFrom);

412 
rc
 = 
sCtx
.rc;

415  
rc
;

416 
	}
}

418 
	$·s5Be°Snù≥t
(

419 
sqlôe4_c⁄ãxt
 *
pCtx
,

420 
iCﬁumn
,

421 
u64
 *
pMask
,

422 
nTokí
,

423 
Snù≥t
 *
pSnù


425 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pCtx
);

426 
nPhø£
;

427 
rc
 = 
SQLITE4_OK
;

428 
i
;

429 
iPªv
 = 0;

430 
iPªvCﬁ
 = 0;

431 
u64
 *
aMask
;

432 
u64
 
mask
 = *
pMask
;

433 
u64
 
Ælmask
 = 0;

435 
iBe°Off
 = 
nTokí
-1;

436 
iBe°Cﬁ
 = (
iCﬁumn
 >= 0 ? iColumn : 0);

437 
nBe°
 = 0;

438 
u64
 
hlmask
 = 0;

439 
u64
 
missmask
 = 0;

441 
	`sqlôe4_mi_phø£_cou¡
(
pCtx
, &
nPhø£
);

442 
aMask
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
u64
Ë* 
nPhø£
);

443 if–!
aMask
 )  
SQLITE4_NOMEM
;

446 
i
=0; 
rc
==
SQLITE4_OK
; i++){

447 
iOff
;

448 
iCﬁ
;

449 
iSåóm
;

450 
iPhø£
;

452 
rc
 = 
	`sqlôe4_mi_m©ch_dëaû
(
pCtx
, 
i
, &
iOff
, &
iCﬁ
, &
iSåóm
, &
iPhø£
);

453 if–
rc
==
SQLITE4_OK
 ){

454 
u64
 
tmask
 = 0;

455 
u64
 
miss
 = 0;

456 
iMask
;

457 
nShi·
;

458 
nSc‹e
 = 0;

460 
nPTok
;

461 
iPTok
;

463 if–
iCﬁumn
>=0 && iCﬁumn!=
iCﬁ
 ) ;

465 
Ælmask
 |((
u64
)1 << 
iPhø£
);

467 
nShi·
 = ((
iPªvCﬁ
==
iCﬁ
Ë? (
iOff
-
iPªv
) : 100);

469 
iMask
=0; iMask<
nPhø£
; iMask++){

470 if–
nShi·
<64){

471 
aMask
[
iMask
] =áMask[iMask] >> 
nShi·
;

473 
aMask
[
iMask
] = 0;

476 
	`sqlôe4_mi_phø£_tokí_cou¡
(
pCtx
, 
iPhø£
, &
nPTok
);

477 
iPTok
=0; iPTok<
nPTok
; iPTok++){

478 
aMask
[
iPhø£
] =áMask[iPhø£] | ((
u64
)1 << (
nTokí
-1+
iPTok
));

481 
iMask
=0; iMask<
nPhø£
; iMask++){

482 
iBô
;

483 if–
aMask
[
iMask
] ){

484 
nSc‹e
 +((((
u64
)1 << 
iMask
Ë& 
mask
) ? 100 : 1);

486 
miss
 |((
u64
)1 << 
iMask
);

488 
tmask
 =Åmask | 
aMask
[
iMask
];

491 
iBô
=0; iBô<
nTokí
; iBit++){

492 if–
tmask
 & ((
u64
)1 << 
iBô
ËË
nSc‹e
++;

496 if–
nSc‹e
>
nBe°
 ){

497 
hlmask
 = 
tmask
;

498 
missmask
 = 
miss
;

499 
nBe°
 = 
nSc‹e
;

500 
iBe°Off
 = 
iOff
;

501 
iBe°Cﬁ
 = 
iCﬁ
;

504 
iPªv
 = 
iOff
;

505 
iPªvCﬁ
 = 
iCﬁ
;

508 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

510 
pSnù
->
iOff
 = 
iBe°Off
-
nTokí
+1;

511 
pSnù
->
iCﬁ
 = 
iBe°Cﬁ
;

512 
pSnù
->
hlmask
 = hlmask;

513 *
pMask
 = 
mask
 & 
missmask
 & 
Ælmask
;

515 
	`sqlôe4DbFªe
(
db
, 
aMask
);

516  
rc
;

517 
	}
}

519 
	$·s5Snù≥tIm¥ove
(

520 
sqlôe4_c⁄ãxt
 *
pCtx
,

521 
nTokí
,

522 
nSz
,

523 
Snù≥t
 *
pSnù


525 
i
;

526 
nLód
 = 0;

527 
nShi·
 = 0;

529 
u64
 
mask
 = 
pSnù
->
hlmask
;

530 
iOff
 = 
pSnù
->iOff;

532 if–
mask
==0 ) ;

533 
	`as£π
–
mask
 & ((
u64
)1 << (
nTokí
-1)) );

535 
i
=0; (
mask
 & ((
u64
)1 << i))==0; i++);

536 
nLód
 = 
i
;

538 
nShi·
 = (
nLód
/2);

539 if–
iOff
+
nShi·
 > 
nSz
-
nTokí
 )ÇShift = (nSz-nToken) - iOff;

540 if–
iOff
+
nShi·
 < 0 )ÇShift = -1 * iOff;

542 
iOff
 +
nShi·
;

543 
mask
 = mask >> 
nShi·
;

545 
pSnù
->
iOff
 = iOff;

546 
pSnù
->
hlmask
 = 
mask
;

547 
	}
}

554 
	$·s5Snù≥tS‹t
(
Snù≥t
 *
aSnù
, 
nSnù
){

555 
Snù≥t
 
aTmp
[4];

556 
i
;

558 
	`as£π
–
nSnù
<=4 &&ÇSnip>=1 );

560 
i
=0; i<
nSnù
; i++){

561 
iBe°
 = -1;

562 
iTry
;

563 
iTry
=0; iTry<
nSnù
; iTry++){

564 
Snù≥t
 *
pTry
 = &
aSnù
[
iTry
];

565 if–
pTry
->
iCﬁ
>=0 && (
iBe°
<0

566 || 
pTry
->
iCﬁ
<
aSnù
[
iBe°
].iCol

567 || (
pTry
->
iCﬁ
==
aSnù
[
iBe°
].iCﬁ &&ÖTry->
iOff
<aSnip[iBest].iOff)

569 
iBe°
 = 
iTry
;

573 
	`as£π
–
iBe°
>=0 );

574 
	`mem˝y
(&
aTmp
[
i
], &
aSnù
[
iBe°
], (
Snù≥t
));

575 
aSnù
[
iBe°
].
iCﬁ
 = -1;

578 
	`mem˝y
(
aSnù
, 
aTmp
, (
Snù≥t
)*
nSnù
);

579 
	}
}

582 
	$·s5Snù≥t
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

583 
Snù≥t
 
aSnù
[4];

584 
nSnù
;

585 
iCﬁ
 = -1;

586 
nTokí
 = -15;

587 
rc
;

588 
nPhø£
;

590 c⁄° *
zSèπ
 = "<b>";

591 c⁄° *
zEnd
 = "</b>";

592 c⁄° *
zEŒù£s
 = "...";

594 if–
nArg
>0 ) 
zSèπ
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠Arg
[0], 0);

595 if–
nArg
>1 ) 
zEnd
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠Arg
[1], 0);

596 if–
nArg
>2 ) 
zEŒù£s
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
≠Arg
[2], 0);

597 if–
nArg
>3 ) 
iCﬁ
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[3]);

598 if–
nArg
>4 ) 
nTokí
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[4]);

600 
rc
 = 
	`sqlôe4_mi_phø£_cou¡
(
pCtx
, &
nPhø£
);

601 
nSnù
=1; 
rc
==
SQLITE4_OK
 &&ÇSnip<5;ÇSnip = ((nSnip==2) ? 3 : (nSnip+1))){

602 
nTok
;

603 
i
;

604 
u64
 
mask
 = ((u64)1 << 
nPhø£
) - 1;

606 if–
nTokí
<0 ){

607 
nTok
 = 
nTokí
 * -1;

609 
nTok
 = (
nTokí
 + (
nSnù
-1)) /ÇSnip;

612 
	`mem£t
(
aSnù
, 0, (aSnip));

613 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nSnù
; i++){

614 
rc
 = 
	`·s5Be°Snù≥t
(
pCtx
, 
iCﬁ
, &
mask
, 
nTok
, &
aSnù
[
i
]);

616 if–
mask
==0 || 
nSnù
==4 ){

617 
Snù≥tText
 
ãxt
 = {0, 0, 0};

618 
	`·s5Snù≥tS‹t
(
aSnù
, 
nSnù
);

619 
i
=0; 
rc
==
SQLITE4_OK
 && i<
nSnù
; i++){

620 
nSz
;

621 
rc
 = 
	`sqlôe4_mi_size
(
pCtx
, 
aSnù
[
i
].
iCﬁ
, -1, &
nSz
);

622 if–
rc
==
SQLITE4_OK
 ){

623 
	`·s5Snù≥tIm¥ove
(
pCtx
, 
nTok
, 
nSz
, &
aSnù
[
i
]);

624 
rc
 = 
	`·s5Snù≥tText
(

625 
pCtx
, &
aSnù
[
i
], &
ãxt
, 
nTok
, 
zSèπ
, 
zEnd
, 
zEŒù£s


629 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
ãxt
.
zOut
,Åext.
nOut
, 
SQLITE4_TRANSIENT
, 0);

630 
	`sqlôe4DbFªe
(
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pCtx
), 
ãxt
.
zOut
);

635 if–
rc
!=
SQLITE4_OK
 ){

636 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

638 
	}
}

640 
·s5Sim∂eTokíize
(

641 *
pCtx
, 
sqlôe4_tokíizî
 *
p
,

642 c⁄° *
zDoc
,

643 
nDoc
,

644 (*
x
)(*, , , const *, , , )

646 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív *)
p
;

647 *
aBuf
;

648 
nBuf
;

649 
iBuf
;

650 
i
;

651 
brk
 = 0;

652 
iOff
 = 0;

654 
nBuf
 = 128;

655 
aBuf
 = (*)
	`sqlôe4_mÆloc
(
pEnv
, 
nBuf
);

656 if–!
aBuf
 )  
SQLITE4_NOMEM
;

658 
iBuf
 = 0;

659 
i
=0; 
brk
==0 && i<
nDoc
; i++){

660 if–
	`sqlôe4Iß um
(
zDoc
[
i
]) ){

661 
aBuf
[
iBuf
++] = 
	`·s5Tﬁowî
(
zDoc
[
i
]);

662 }if–
iBuf
>0 ){

663 
brk
 = 
	`x
(
pCtx
, 0, 
iOff
++, 
aBuf
, 
iBuf
, 
i
-iBuf, iBuf);

664 
iBuf
 = 0;

667 if–
iBuf
>0 ) 
	`x
(
pCtx
, 0, 
iOff
++, 
aBuf
, iBuf, 
i
-iBuf, iBuf);

669 
	`sqlôe4_‰ì
(
pEnv
, 
aBuf
);

670  
SQLITE4_OK
;

671 
	}
}

673 
	$sqlôe4InôFts5Func
(
sqlôe4
 *
db
){

674 
rc
;

675 
i
;

676 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_db_ív
(
db
);

678 
	sR™kFun˘i⁄
 {

679 c⁄° *
zName
;

680 
mask
;

681 } 
aR™k
[] = {

683 { "î™k", 
BM25_EXPLAIN
 },

684 { "ønkc", 
BM25_FCOLUMNS
 },

685 { "î™kc", 
BM25_FCOLUMNS
|
BM25_EXPLAIN
 },

686 { "ønks", 
BM25_FSTREAMS
 },

687 { "î™ks", 
BM25_FSTREAMS
|
BM25_EXPLAIN
 }

690 
rc
 = 
	`sqlôe4_¸óã_tokíizî
(
db
, "sim∂e", (*)
pEnv
,

691 
·s5Sim∂eCª©e
, 
·s5Sim∂eTokíize
, 
·s5Sim∂eDe°roy


693 if–
rc
==
SQLITE4_OK
 ){

694 
rc
 = 
	`sqlôe4_¸óã_mi_fun˘i⁄
(

695 
db
, "¢ù≥t", -1, 
SQLITE4_UTF8
, 0, 
·s5Snù≥t
, 0);

698 
i
=0; 
rc
==
SQLITE4_OK
 && i<
	`AºaySize
(
aR™k
); i++){

699 *
p
 = 
	`SQLITE4_INT_TO_PTR
(
aR™k
[
i
].
mask
);

700 c⁄° *
z
 = 
aR™k
[
i
].
zName
;

701 
rc
 = 
	`sqlôe4_¸óã_mi_fun˘i⁄
(
db
, 
z
, -1, 
SQLITE4_UTF8
, 
p
, 
·s5R™k
, 0);

704  
rc
;

705 
	}
}

	@src/func.c

19 
	~"sqlôeI¡.h
"

20 
	~<°dlib.h
>

21 
	~<as£π.h
>

22 
	~"vdbeI¡.h
"

27 
CﬁlSeq
 *
	$sqlôe4GëFuncCﬁlSeq
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

28  
c⁄ãxt
->
pCﬁl
;

29 
	}
}

34 
	$mömaxFunc
(

35 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

36 
¨gc
,

37 
sqlôe4_vÆue
 **
¨gv


39 
i
;

40 
mask
;

41 
iBe°
;

42 
CﬁlSeq
 *
pCﬁl
;

44 
	`as£π
–
¨gc
>1 );

45 
mask
 = 
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
)==0 ? 0 : -1;

46 
pCﬁl
 = 
	`sqlôe4GëFuncCﬁlSeq
(
c⁄ãxt
);

47 
	`as£π
–
pCﬁl
 );

48 
	`as£π
–
mask
==-1 || mask==0 );

49 
iBe°
 = 0;

50 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ) ;

51 
i
=1; i<
¨gc
; i++){

52 
ªs
, 
rc
;

53 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[
i
])==
SQLITE4_NULL
 ) ;

54 
rc
 = 
	`sqlôe4MemCom∑ª
(
¨gv
[
iBe°
],árgv[
i
], 
pCﬁl
, &
ªs
);

55 if–
rc
!=
SQLITE4_OK
 ){

56 
	`sqlôe4_ªsu…_îr‹_code
(
c⁄ãxt
, 
rc
);

59 if–(
ªs
^
mask
)>=0 ){

60 
	`ã°ˇ£
–
mask
==0 );

61 
iBe°
 = 
i
;

64 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[
iBe°
]);

65 
	}
}

70 
	$ty≥ofFunc
(

71 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

72 
NŸU£d
,

73 
sqlôe4_vÆue
 **
¨gv


75 c⁄° *
z
 = 0;

76 
	`UNUSED_PARAMETER
(
NŸU£d
);

77  
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]) ){

78 
SQLITE4_INTEGER
: 
z
 = "integer"; ;

79 
SQLITE4_TEXT
: 
z
 = "text"; ;

80 
SQLITE4_FLOAT
: 
z
 = "real"; ;

81 
SQLITE4_BLOB
: 
z
 = "blob"; ;

82 : 
z
 = "null"; ;

84 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
z
, -1, 
SQLITE4_STATIC
, 0);

85 
	}
}

91 
	$ÀngthFunc
(

92 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

93 
¨gc
,

94 
sqlôe4_vÆue
 **
¨gv


96 
	`as£π
–
¨gc
==1 );

97 
	`UNUSED_PARAMETER
(
¨gc
);

98  
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]) ){

99 
SQLITE4_BLOB
: {

100 
nBlob
;

101 
	`sqlôe4_vÆue_blob
(
¨gv
[0], &
nBlob
);

102 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
nBlob
);

106 
SQLITE4_INTEGER
:

107 
SQLITE4_FLOAT
:

108 
SQLITE4_TEXT
: {

109 c⁄° *
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

110 if–
z
 ){

111 
nCh¨
;

112 
nCh¨
=0; *
z
;ÇChar++){

113 
	`SQLITE4_SKIP_UTF8
(
z
);

115 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
nCh¨
);

121 
	`sqlôe4_ªsu…_nuŒ
(
c⁄ãxt
);

125 
	}
}

133 
	$absFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

134 
	`as£π
–
¨gc
==1 );

135 
	`UNUSED_PARAMETER
(
¨gc
);

137  
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]) ){

138 
SQLITE4_INTEGER
: {

139 
i64
 
iVÆ
 = 
	`sqlôe4_vÆue_öt64
(
¨gv
[0]);

140 if–
iVÆ
<0 ){

141 if–(
iVÆ
<<1)==0 ){

145 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "integer overflow", -1);

148 
iVÆ
 = -iVal;

150 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
iVÆ
);

153 
SQLITE4_NULL
: {

155 
	`sqlôe4_ªsu…_nuŒ
(
c⁄ãxt
);

163 
sqlôe4_num
 
num
 = 
	`sqlôe4_vÆue_num
(
¨gv
[0]);

164 
num
.
sign
 = 0;

165 
	`sqlôe4_ªsu…_num
(
c⁄ãxt
, 
num
);

169 
	}
}

183 
	$sub°rFunc
(

184 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

185 
¨gc
,

186 
sqlôe4_vÆue
 **
¨gv


188 c⁄° *
z
;

189 c⁄° *
z2
;

190 
Àn
;

191 
p0ty≥
;

192 
i64
 
p1
, 
p2
;

193 
√gP2
 = 0;

195 
	`as£π
–
¨gc
==3 ||árgc==2 );

196 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[1])==
SQLITE4_NULL


197 || (
¨gc
==3 && 
	`sqlôe4_vÆue_ty≥
(
¨gv
[2])==
SQLITE4_NULL
)

201 
p0ty≥
 = 
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]);

202 
p1
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[1]);

203 if–
p0ty≥
==
SQLITE4_BLOB
 ){

204 
z
 = 
	`sqlôe4_vÆue_blob
(
¨gv
[0], &
Àn
);

205 if–
z
==0 ) ;

207 
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

208 if–
z
==0 ) ;

209 
Àn
 = 0;

210 if–
p1
<0 ){

211 
z2
=
z
; *z2; 
Àn
++){

212 
	`SQLITE4_SKIP_UTF8
(
z2
);

216 if–
¨gc
==3 ){

217 
p2
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[2]);

218 if–
p2
<0 ){

219 
p2
 = -p2;

220 
√gP2
 = 1;

223 
p2
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
)->
aLimô
[
SQLITE4_LIMIT_LENGTH
];

225 if–
p1
<0 ){

226 
p1
 +
Àn
;

227 if–
p1
<0 ){

228 
p2
 +
p1
;

229 if–
p2
<0 )Ö2 = 0;

230 
p1
 = 0;

232 }if–
p1
>0 ){

233 
p1
--;

234 }if–
p2
>0 ){

235 
p2
--;

237 if–
√gP2
 ){

238 
p1
 -
p2
;

239 if–
p1
<0 ){

240 
p2
 +
p1
;

241 
p1
 = 0;

244 
	`as£π
–
p1
>=0 && 
p2
>=0 );

245 if–
p0ty≥
!=
SQLITE4_BLOB
 ){

246  *
z
 && 
p1
 ){

247 
	`SQLITE4_SKIP_UTF8
(
z
);

248 
p1
--;

250 
z2
=
z
; *z2 && 
p2
;Ö2--){

251 
	`SQLITE4_SKIP_UTF8
(
z2
);

253 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, (*)
z
, ()(
z2
-z), 
SQLITE4_TRANSIENT
, 0);

255 if–
p1
+
p2
>
Àn
 ){

256 
p2
 = 
Àn
-
p1
;

257 if–
p2
<0 )Ö2 = 0;

259 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, (*)&
z
[
p1
], ()
p2
, 
SQLITE4_TRANSIENT
, 0);

261 
	}
}

266 
	$roundFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

267 
n
 = 0;

268 
	`as£π
–
¨gc
==1 ||árgc==2 );

269 if–
¨gc
==2 ){

270 if–
SQLITE4_NULL
==
	`sqlôe4_vÆue_ty≥
(
¨gv
[1]) ) ;

271 
n
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[1]);

272 if–
n
>30 )Ç = 30;

273 if–
n
<0 )Ç = 0;

275 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ) ;

277 
	`sqlôe4_ªsu…_num
(
c⁄ãxt
, 
	`sqlôe4_num_round
(
	`sqlôe4_vÆue_num
(
¨gv
[0]), 
n
));

278 
	}
}

287 *
	$c⁄ãxtMÆloc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
i64
 
nByã
){

288 *
z
;

289 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

290 
	`as£π
–
nByã
>0 );

291 
	`ã°ˇ£
–
nByã
==
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] );

292 
	`ã°ˇ£
–
nByã
==
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
]+1 );

293 if–
nByã
>
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

294 
	`sqlôe4_ªsu…_îr‹_toobig
(
c⁄ãxt
);

295 
z
 = 0;

297 
z
 = 
	`sqlôe4MÆloc
(
db
->
pEnv
, ()
nByã
);

298 if–!
z
 ){

299 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

302  
z
;

303 
	}
}

308 
	$uµîFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

309 *
z1
;

310 c⁄° *
z2
;

311 
i
, 
n
;

312 
	`UNUSED_PARAMETER
(
¨gc
);

313 
z2
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
n
);

314 if–
z2
 ){

315 
z1
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, ((
i64
)
n
)+1);

316 if–
z1
 ){

317 
i
=0; i<
n
; i++){

318 
z1
[
i
] = ()
	`sqlôe4Touµî
(
z2
[i]);

320 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
z1
, 
n
, 
SQLITE4_DYNAMIC
, 0);

323 
	}
}

324 
	$lowîFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

325 *
z1
;

326 c⁄° *
z2
;

327 
i
, 
n
;

328 
	`UNUSED_PARAMETER
(
¨gc
);

329 
z2
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
n
);

330 if–
z2
 ){

331 
z1
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, ((
i64
)
n
)+1);

332 if–
z1
 ){

333 
i
=0; i<
n
; i++){

334 
z1
[
i
] = 
	`sqlôe4Tﬁowî
(
z2
[i]);

336 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
z1
, 
n
, 
SQLITE4_DYNAMIC
, 0);

339 
	}
}

354 
	$i‚uŒFunc
(

355 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

356 
¨gc
,

357 
sqlôe4_vÆue
 **
¨gv


359 
i
;

360 
i
=0; i<
¨gc
; i++){

361 if–
SQLITE4_NULL
!=
	`sqlôe4_vÆue_ty≥
(
¨gv
[
i
]) ){

362 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[
i
]);

366 
	}
}

368 
	#i‚uŒFunc
 
vîsi⁄Func


	)

373 
	$øndomFunc
(

374 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

375 
NŸU£d
,

376 
sqlôe4_vÆue
 **
NŸU£d2


378 
sqlôe4_öt64
 
r
;

379 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

380 
	`sqlôe4_øndom√ss
(
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
), (
r
), &r);

381 if–
r
<0 ){

390 
r
 = -‘ ^ (((
sqlôe4_öt64
)1)<<63));

392 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
r
);

393 
	}
}

399 
	$øndomBlob
(

400 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

401 
¨gc
,

402 
sqlôe4_vÆue
 **
¨gv


404 
n
;

405 *
p
;

406 
	`as£π
–
¨gc
==1 );

407 
	`UNUSED_PARAMETER
(
¨gc
);

408 
n
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[0]);

409 if–
n
<1 ){

410 
n
 = 1;

412 
p
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, 
n
);

413 if–
p
 ){

414 
	`sqlôe4_øndom√ss
(
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
), 
n
, 
p
);

415 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, (*)
p
, 
n
, 
SQLITE4_DYNAMIC
, 0);

417 
	}
}

426 
	$ch™ges
(

427 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

428 
NŸU£d
,

429 
sqlôe4_vÆue
 **
NŸU£d2


431 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

432 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

433 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
	`sqlôe4_ch™ges
(
db
));

434 
	}
}

440 
	$tŸÆ_ch™ges
(

441 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

442 
NŸU£d
,

443 
sqlôe4_vÆue
 **
NŸU£d2


445 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

446 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

449 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
	`sqlôe4_tŸÆ_ch™ges
(
db
));

450 
	}
}

455 
	scom∑ªInfo
 {

456 
u8
 
	mm©chAŒ
;

457 
u8
 
	mm©chO√
;

458 
u8
 
	mm©chSë
;

459 
u8
 
	mnoCa£
;

468 #i‡
deföed
(
SQLITE4_EBCDIC
)

469 
	#sqlôe4Utf8Ród
(
A
,
C
Ë(*(A++))

	)

470 
	#GlogUµîToLowî
(
A
ËA = 
sqlôe4UµîToLowî
[A]

	)

472 
	#GlogUµîToLowî
(
A
Ëif–!((A)&~0x7fË){ A = 
sqlôe4UµîToLowî
[A]; }

	)

475 c⁄° 
com∑ªInfo
 
	gglobInfo
 = { '*', '?', '[', 0 };

478 c⁄° 
com∑ªInfo
 
	glikeInfoN‹m
 = { '%', '_', 0, 1 };

481 c⁄° 
com∑ªInfo
 
	glikeInfoA…
 = { '%', '_', 0, 0 };

511 
	$∑âînCom∑ª
(

512 c⁄° *
zP©ã∫
,

513 c⁄° *
zSåög
,

514 c⁄° 
com∑ªInfo
 *
pInfo
,

515 
u32
 
esc


517 
u32
 
c
, 
c2
;

518 
övît
;

519 
£í
;

520 
u8
 
m©chO√
 = 
pInfo
->matchOne;

521 
u8
 
m©chAŒ
 = 
pInfo
->matchAll;

522 
u8
 
m©chSë
 = 
pInfo
->matchSet;

523 
u8
 
noCa£
 = 
pInfo
->noCase;

524 
¥evEsˇ≥
 = 0;

526  (
c
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
,&zPattern))!=0 ){

527 if–!
¥evEsˇ≥
 && 
c
==
m©chAŒ
 ){

528  (
c
=
	`sqlôe4Utf8Ród
(
zP©ã∫
,&zP©ã∫)Ë=
m©chAŒ


529 || 
c
 =
m©chO√
 ){

530 if–
c
==
m©chO√
 && 
	`sqlôe4Utf8Ród
(
zSåög
, &zString)==0 ){

534 if–
c
==0 ){

536 }if–
c
==
esc
 ){

537 
c
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
, &zPattern);

538 if–
c
==0 ){

541 }if–
c
==
m©chSë
 ){

542 
	`as£π
–
esc
==0 );

543 
	`as£π
–
m©chSë
<0x80 );

544  *
zSåög
 && 
	`∑âînCom∑ª
(&
zP©ã∫
[-1],zSåög,
pInfo
,
esc
)==0 ){

545 
	`SQLITE4_SKIP_UTF8
(
zSåög
);

547  *
zSåög
!=0;

549  (
c2
 = 
	`sqlôe4Utf8Ród
(
zSåög
,&zString))!=0 ){

550 if–
noCa£
 ){

551 
	`GlogUµîToLowî
(
c2
);

552 
	`GlogUµîToLowî
(
c
);

553  
c2
 !0 && c2 !
c
 ){

554 
c2
 = 
	`sqlôe4Utf8Ród
(
zSåög
, &zString);

555 
	`GlogUµîToLowî
(
c2
);

558  
c2
 !0 && c2 !
c
 ){

559 
c2
 = 
	`sqlôe4Utf8Ród
(
zSåög
, &zString);

562 if–
c2
==0 )  0;

563 if–
	`∑âînCom∑ª
(
zP©ã∫
,
zSåög
,
pInfo
,
esc
) )  1;

566 }if–!
¥evEsˇ≥
 && 
c
==
m©chO√
 ){

567 if–
	`sqlôe4Utf8Ród
(
zSåög
, &zString)==0 ){

570 }if–
c
==
m©chSë
 ){

571 
u32
 
¥i‹_c
 = 0;

572 
	`as£π
–
esc
==0 );

573 
£í
 = 0;

574 
övît
 = 0;

575 
c
 = 
	`sqlôe4Utf8Ród
(
zSåög
, &zString);

576 if–
c
==0 )  0;

577 
c2
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
, &zPattern);

578 if–
c2
=='^' ){

579 
övît
 = 1;

580 
c2
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
, &zPattern);

582 if–
c2
==']' ){

583 if–
c
==']' ) 
£í
 = 1;

584 
c2
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
, &zPattern);

586  
c2
 && c2!=']' ){

587 if–
c2
=='-' && 
zP©ã∫
[0]!=']' && zP©ã∫[0]!=0 && 
¥i‹_c
>0 ){

588 
c2
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
, &zPattern);

589 if–
c
>=
¥i‹_c
 && c<=
c2
 ) 
£í
 = 1;

590 
¥i‹_c
 = 0;

592 if–
c
==
c2
 ){

593 
£í
 = 1;

595 
¥i‹_c
 = 
c2
;

597 
c2
 = 
	`sqlôe4Utf8Ród
(
zP©ã∫
, &zPattern);

599 if–
c2
==0 || (
£í
 ^ 
övît
)==0 ){

602 }if–
esc
==
c
 && !
¥evEsˇ≥
 ){

603 
¥evEsˇ≥
 = 1;

605 
c2
 = 
	`sqlôe4Utf8Ród
(
zSåög
, &zString);

606 if–
noCa£
 ){

607 
	`GlogUµîToLowî
(
c
);

608 
	`GlogUµîToLowî
(
c2
);

610 if–
c
!=
c2
 ){

613 
¥evEsˇ≥
 = 0;

616  *
zSåög
==0;

617 
	}
}

624 #ifde‡
SQLITE4_TEST


625 
	gsqlôe4_like_cou¡
 = 0;

641 
	$likeFunc
(

642 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

643 
¨gc
,

644 
sqlôe4_vÆue
 **
¨gv


646 c⁄° *
zA
, *
zB
;

647 
u32
 
esˇ≥
 = 0;

648 
nP©
;

649 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

651 
zB
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
nP©
);

652 
zA
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0);

657 
	`ã°ˇ£
–
nP©
==
db
->
aLimô
[
SQLITE4_LIMIT_LIKE_PATTERN_LENGTH
] );

658 
	`ã°ˇ£
–
nP©
==
db
->
aLimô
[
SQLITE4_LIMIT_LIKE_PATTERN_LENGTH
]+1 );

659 if–
nP©
 > 
db
->
aLimô
[
SQLITE4_LIMIT_LIKE_PATTERN_LENGTH
] ){

660 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "LIKE or GLOBÖatternÅoo complex", -1);

664 if–
¨gc
==3 ){

668 c⁄° *
zEsc
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[2], 0);

669 if–
zEsc
==0 ) ;

670 if–
	`sqlôe4Utf8Ch¨Lí
(
zEsc
, -1)!=1 ){

671 c⁄° *
zEº
 = "ESCAPEÉxpression must beá single character";

672 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

675 
esˇ≥
 = 
	`sqlôe4Utf8Ród
(
zEsc
, &zEsc);

677 if–
zA
 && 
zB
 ){

678 
com∑ªInfo
 *
pInfo
 = 
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
);

679 #ifde‡
SQLITE4_TEST


680 
sqlôe4_like_cou¡
++;

683 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
	`∑âînCom∑ª
(
zB
, 
zA
, 
pInfo
, 
esˇ≥
));

685 
	}
}

692 
	$nuŒifFunc
(

693 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

694 
NŸU£d
,

695 
sqlôe4_vÆue
 **
¨gv


697 
rc
, 
ªs
;

698 
CﬁlSeq
 *
pCﬁl
 = 
	`sqlôe4GëFuncCﬁlSeq
(
c⁄ãxt
);

699 
	`UNUSED_PARAMETER
(
NŸU£d
);

700 
rc
 = 
	`sqlôe4MemCom∑ª
(
¨gv
[0],árgv[1], 
pCﬁl
, &
ªs
);

701 if–
rc
!=
SQLITE4_OK
 ){

702 
	`sqlôe4_ªsu…_îr‹_code
(
c⁄ãxt
, 
rc
);

703 }if–
ªs
 ){

704 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[0]);

706 
	}
}

712 
	$vîsi⁄Func
(

713 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

714 
NŸU£d
,

715 
sqlôe4_vÆue
 **
NŸU£d2


717 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

720 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
	`sqlôe4_libvîsi⁄
(), -1, 
SQLITE4_STATIC
, 0);

721 
	}
}

728 
	$sour˚idFunc
(

729 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

730 
NŸU£d
,

731 
sqlôe4_vÆue
 **
NŸU£d2


733 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

736 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
	`sqlôe4_sour˚id
(), -1, 
SQLITE4_STATIC
, 0);

737 
	}
}

744 
	$îæogFunc
(

745 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

746 
¨gc
,

747 
sqlôe4_vÆue
 **
¨gv


749 
r˛og
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[0]);

750 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
);

751 
	`sqlôe4_log
(
pEnv
, 
r˛og
, "%s", 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0));

752 
	`UNUSED_PARAMETER
(
¨gc
);

753 
	}
}

760 #i‚de‡
SQLITE4_OMIT_COMPILEOPTION_DIAGS


761 
	$compûe›ti⁄u£dFunc
(

762 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

763 
¨gc
,

764 
sqlôe4_vÆue
 **
¨gv


766 c⁄° *
zO±Name
;

767 
	`as£π
–
¨gc
==1 );

768 
	`UNUSED_PARAMETER
(
¨gc
);

773 if–(
zO±Name
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0))!=0 ){

774 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
	`sqlôe4_compûe›ti⁄_u£d
(
zO±Name
));

776 
	}
}

784 #i‚de‡
SQLITE4_OMIT_COMPILEOPTION_DIAGS


785 
	$compûe›ti⁄gëFunc
(

786 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

787 
¨gc
,

788 
sqlôe4_vÆue
 **
¨gv


790 
n
;

791 
	`as£π
–
¨gc
==1 );

792 
	`UNUSED_PARAMETER
(
¨gc
);

796 
n
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[0]);

797 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
	`sqlôe4_compûe›ti⁄_gë
(
n
), -1,

798 
SQLITE4_STATIC
, 0);

799 
	}
}

813 
	$quŸeFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

814 
	`as£π
–
¨gc
==1 );

815 
	`UNUSED_PARAMETER
(
¨gc
);

816  
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]) ){

817 
SQLITE4_INTEGER
:

818 
SQLITE4_FLOAT
: {

819 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[0]);

822 
SQLITE4_BLOB
: {

823 
nBlob
;

824 *
zText
 = 0;

825 c⁄° *
zBlob
 = 
	`sqlôe4_vÆue_blob
(
¨gv
[0], &
nBlob
);

826 
zText
 = (*)
	`c⁄ãxtMÆloc
(
c⁄ãxt
, (2*(
i64
)
nBlob
)+4);

827 if–
zText
 ){

828 
zText
[0] = 'x';

829 
zText
[1] = '\'';

830 
	`sqlôe4BlobToHex
(
nBlob
, (c⁄° 
u8
*)
zBlob
, 
zText
+2);

831 
zText
[(
nBlob
*2)+2] = '\'';

832 
zText
[(
nBlob
*2)+3] = 0;

833 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zText
, -1, 
SQLITE4_TRANSIENT
, 0);

834 
	`sqlôe4_‰ì
(
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
), 
zText
);

838 
SQLITE4_TEXT
: {

839 
i
,
j
;

840 
u64
 
n
;

841 c⁄° *
zArg
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

842 *
z
;

844 if–
zArg
==0 ) ;

845 
i
=0, 
n
=0; 
zArg
[i]; i++){ if( zArg[i]=='\'' )Ç++; }

846 
z
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, ((
i64
)
i
)+((i64)
n
)+3);

847 if–
z
 ){

848 
z
[0] = '\'';

849 
i
=0, 
j
=1; 
zArg
[i]; i++){

850 
z
[
j
++] = 
zArg
[
i
];

851 if–
zArg
[
i
]=='\'' ){

852 
z
[
j
++] = '\'';

855 
z
[
j
++] = '\'';

856 
z
[
j
] = 0;

857 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
z
, 
j
, 
SQLITE4_DYNAMIC
, 0);

862 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 );

863 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, "NULL", 4, 
SQLITE4_STATIC
, 0);

867 
	}
}

873 
	$hexFunc
(

874 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

875 
¨gc
,

876 
sqlôe4_vÆue
 **
¨gv


878 
i
, 
n
;

879 c⁄° *
pBlob
;

880 *
zHex
;

881 
	`as£π
–
¨gc
==1 );

882 
	`UNUSED_PARAMETER
(
¨gc
);

883 
pBlob
 = 
	`sqlôe4_vÆue_blob
(
¨gv
[0], &
n
);

884 
zHex
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, ((
i64
)
n
)*2 + 1);

885 if–
zHex
 ){

886 
	`sqlôe4BlobToHex
(
n
, (c⁄° 
u8
*)
pBlob
, 
zHex
);

887 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zHex
, 
n
*2, 
SQLITE4_DYNAMIC
, 0);

889 
	}
}

897 
	$ª∂a˚Func
(

898 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

899 
¨gc
,

900 
sqlôe4_vÆue
 **
¨gv


902 c⁄° *
zSå
;

903 c⁄° *
zP©ã∫
;

904 c⁄° *
zRï
;

905 *
zOut
;

906 
nSå
;

907 
nP©ã∫
;

908 
nRï
;

909 
i64
 
nOut
;

910 
lo›Limô
;

911 
i
, 
j
;

913 
	`as£π
–
¨gc
==3 );

914 
	`UNUSED_PARAMETER
(
¨gc
);

915 
zSå
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
nSå
);

916 if–
zSå
==0 ) ;

917 
zP©ã∫
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], &
nP©ã∫
);

918 if–
zP©ã∫
==0 ){

919 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨gv
[1])==
SQLITE4_NULL


920 || 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
)->
mÆlocFaûed
 );

923 if–
zP©ã∫
[0]==0 ){

924 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨gv
[1])!=
SQLITE4_NULL
 );

925 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[0]);

928 
zRï
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[2], &
nRï
);

929 if–
zRï
==0 ) ;

930 
nOut
 = 
nSå
 + 1;

931 
	`as£π
–
nOut
<
SQLITE4_MAX_LENGTH
 );

932 
zOut
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, (
i64
)
nOut
);

933 if–
zOut
==0 ){

936 
lo›Limô
 = 
nSå
 - 
nP©ã∫
;

937 
i
=
j
=0; i<=
lo›Limô
; i++){

938 if–
zSå
[
i
]!=
zP©ã∫
[0] || 
	`memcmp
(&zSå[i], zP©ã∫, 
nP©ã∫
) ){

939 
zOut
[
j
++] = 
zSå
[
i
];

941 *
zOld
;

942 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

943 
nOut
 +
nRï
 - 
nP©ã∫
;

944 
	`ã°ˇ£
–
nOut
-1==
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] );

945 
	`ã°ˇ£
–
nOut
-2==
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] );

946 if–
nOut
-1>
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

947 
	`sqlôe4_ªsu…_îr‹_toobig
(
c⁄ãxt
);

948 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zOut
);

951 
zOld
 = 
zOut
;

952 
zOut
 = 
	`sqlôe4_ªÆloc
(
db
->
pEnv
, zOut, ()
nOut
);

953 if–
zOut
==0 ){

954 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

955 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zOld
);

958 
	`mem˝y
(&
zOut
[
j
], 
zRï
, 
nRï
);

959 
j
 +
nRï
;

960 
i
 +
nP©ã∫
-1;

963 
	`as£π
–
j
+
nSå
-
i
+1==
nOut
 );

964 
	`mem˝y
(&
zOut
[
j
], &
zSå
[
i
], 
nSå
-i);

965 
j
 +
nSå
 - 
i
;

966 
	`as£π
–
j
<=
nOut
 );

967 
zOut
[
j
] = 0;

968 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zOut
, 
j
, 
SQLITE4_DYNAMIC
, 0);

969 
	}
}

975 
	$åimFunc
(

976 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

977 
¨gc
,

978 
sqlôe4_vÆue
 **
¨gv


980 c⁄° *
zIn
;

981 c⁄° *
zCh¨Së
;

982 
nIn
;

983 
Êags
;

984 
i
;

985 
u8
 *
aLí
 = 0;

986 **
azCh¨
 = 0;

987 
nCh¨
;

989 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ){

992 
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
nIn
);

993 if–
zIn
==0 ) ;

994 if–
¨gc
==1 ){

995 c⁄° 
ÀnO√
[] = { 1 };

996 * c⁄° 
azO√
[] = { " " };

997 
nCh¨
 = 1;

998 
aLí
 = (
u8
*)
ÀnO√
;

999 
azCh¨
 = (**)
azO√
;

1000 
zCh¨Së
 = 0;

1001 }if–(
zCh¨Së
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0))==0 ){

1004 c⁄° *
z
;

1005 
z
=
zCh¨Së
, 
nCh¨
=0; *z;ÇChar++){

1006 
	`SQLITE4_SKIP_UTF8
(
z
);

1008 if–
nCh¨
>0 ){

1009 
azCh¨
 = 
	`c⁄ãxtMÆloc
(
c⁄ãxt
, ((
i64
)
nCh¨
)*((*)+1));

1010 if–
azCh¨
==0 ){

1013 
aLí
 = (*)&
azCh¨
[
nCh¨
];

1014 
z
=
zCh¨Së
, 
nCh¨
=0; *z;ÇChar++){

1015 
azCh¨
[
nCh¨
] = (*)
z
;

1016 
	`SQLITE4_SKIP_UTF8
(
z
);

1017 
aLí
[
nCh¨
] = (
u8
)(
z
 - 
azCh¨
[nChar]);

1021 if–
nCh¨
>0 ){

1022 
Êags
 = 
	`SQLITE4_PTR_TO_INT
(
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
));

1023 if–
Êags
 & 1 ){

1024  
nIn
>0 ){

1025 
Àn
 = 0;

1026 
i
=0; i<
nCh¨
; i++){

1027 
Àn
 = 
aLí
[
i
];

1028 if–
Àn
<=
nIn
 && 
	`memcmp
(
zIn
, 
azCh¨
[
i
],Üen)==0 ) ;

1030 if–
i
>=
nCh¨
 ) ;

1031 
zIn
 +
Àn
;

1032 
nIn
 -
Àn
;

1035 if–
Êags
 & 2 ){

1036  
nIn
>0 ){

1037 
Àn
 = 0;

1038 
i
=0; i<
nCh¨
; i++){

1039 
Àn
 = 
aLí
[
i
];

1040 if–
Àn
<=
nIn
 && 
	`memcmp
(&
zIn
[nIn-Àn],
azCh¨
[
i
],len)==0 ) ;

1042 if–
i
>=
nCh¨
 ) ;

1043 
nIn
 -
Àn
;

1046 if–
zCh¨Së
 ){

1047 
	`sqlôe4_‰ì
(
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
), 
azCh¨
);

1050 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zIn
, 
nIn
, 
SQLITE4_TRANSIENT
, 0);

1051 
	}
}

1058 #ifde‡
SQLITE4_SOUNDEX


1065 
	$soundexFunc
(

1066 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1067 
¨gc
,

1068 
sqlôe4_vÆue
 **
¨gv


1070 
zResu…
[8];

1071 c⁄° 
u8
 *
zIn
;

1072 
i
, 
j
;

1073 c⁄° 
iCode
[] = {

1083 
	`as£π
–
¨gc
==1 );

1084 
zIn
 = (
u8
*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

1085 if–
zIn
==0 ) zI¿(
u8
*)"";

1086 
i
=0; 
zIn
[i] && !
	`sqlôe4IßÕha
(zIn[i]); i++){}

1087 if–
zIn
[
i
] ){

1088 
u8
 
¥evcode
 = 
iCode
[
zIn
[
i
]&0x7f];

1089 
zResu…
[0] = 
	`sqlôe4Touµî
(
zIn
[
i
]);

1090 
j
=1; j<4 && 
zIn
[
i
]; i++){

1091 
code
 = 
iCode
[
zIn
[
i
]&0x7f];

1092 if–
code
>0 ){

1093 if–
code
!=
¥evcode
 ){

1094 
¥evcode
 = 
code
;

1095 
zResu…
[
j
++] = 
code
 + '0';

1098 
¥evcode
 = 0;

1101  
j
<4 ){

1102 
zResu…
[
j
++] = '0';

1104 
zResu…
[
j
] = 0;

1105 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zResu…
, 4, 
SQLITE4_TRANSIENT
, 0);

1109 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, "?000", 4, 
SQLITE4_STATIC
, 0);

1111 
	}
}

1118 
	$lﬂdExt
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1119 c⁄° *
zFûe
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0]);

1120 c⁄° *
zProc
;

1121 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

1122 *
zEºMsg
 = 0;

1124 if–
¨gc
==2 ){

1125 
zProc
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1]);

1127 
zProc
 = 0;

1129 if–
zFûe
 && 
	`sqlôe4_lﬂd_exãnsi⁄
(
db
, zFûe, 
zProc
, &
zEºMsg
) ){

1130 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEºMsg
, -1);

1131 
	`sqlôe4_‰ì
(
zEºMsg
);

1133 
	}
}

1141 
SumCtx
 
	tSumCtx
;

1142 
	sSumCtx
 {

1143 
sqlôe4_num
 
	msum
;

1144 
i64
 
	m˙t
;

1145 
u8
 
	m≠¥ox
;

1158 
	$sumSãp
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1159 
SumCtx
 *
p
;

1160 
ty≥
;

1161 
	`as£π
–
¨gc
==1 );

1162 
	`UNUSED_PARAMETER
(
¨gc
);

1163 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*p));

1164 
ty≥
 = 
	`sqlôe4_vÆue_numîic_ty≥
(
¨gv
[0]);

1165 if–
p
 && 
ty≥
!=
SQLITE4_NULL
 ){

1166 
p
->
˙t
++;

1167 
p
->
sum
 = 
	`sqlôe4_num_add
’->sum, 
	`sqlôe4_vÆue_num
(
¨gv
[0]));

1168 if–
ty≥
!=
SQLITE4_INTEGER
 ){

1169 
p
->
≠¥ox
 = 1;

1172 
	}
}

1173 
	$sumFöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

1174 
SumCtx
 *
p
;

1175 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, 0);

1176 if–
p
 &&Ö->
˙t
>0 ){

1177 if–
p
->
≠¥ox
==0 ){

1178 
bLossy
;

1179 
i64
 
iVÆ
 = 
	`sqlôe4_num_to_öt64
(
p
->
sum
, &
bLossy
);

1180 if–
bLossy
 ){

1181 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "integer overflow", -1);

1183 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
iVÆ
);

1186 
	`sqlôe4_ªsu…_num
(
c⁄ãxt
, 
p
->
sum
);

1189 
	}
}

1190 
	$avgFöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

1191 
SumCtx
 *
p
;

1192 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, 0);

1193 if–
p
 &&Ö->
˙t
>0 ){

1194 
	`sqlôe4_ªsu…_num
(
c⁄ãxt
,

1195 
	`sqlôe4_num_div
(
p
->
sum
, 
	`sqlôe4_num_‰om_öt64
’->
˙t
))

1198 
	}
}

1199 
	$tŸÆFöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

1200 
SumCtx
 *
p
;

1201 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, 0);

1202 
	`sqlôe4_ªsu…_num
(
c⁄ãxt
, (
p
 ?Ö->
sum
 : 
	`sqlôe4_num_‰om_öt64
(0)));

1203 
	}
}

1209 
Cou¡Ctx
 
	tCou¡Ctx
;

1210 
	sCou¡Ctx
 {

1211 
i64
 
	mn
;

1217 
	$cou¡Sãp
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1218 
Cou¡Ctx
 *
p
;

1219 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*p));

1220 if–(
¨gc
==0 || 
SQLITE4_NULL
!=
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])Ë&& 
p
 ){

1221 
p
->
n
++;

1223 
	}
}

1224 
	$cou¡FöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

1225 
Cou¡Ctx
 *
p
;

1226 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, 0);

1227 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
p
 ?Ö->
n
 : 0);

1228 
	}
}

1233 
	$mömaxSãp
(

1234 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1235 
NŸU£d
,

1236 
sqlôe4_vÆue
 **
¨gv


1238 
Mem
 *
pArg
 = (Mem *)
¨gv
[0];

1239 
Mem
 *
pBe°
;

1240 
	`UNUSED_PARAMETER
(
NŸU£d
);

1242 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ) ;

1243 
pBe°
 = (
Mem
 *)
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*pBest));

1244 if–!
pBe°
 ) ;

1246 if–
pBe°
->
Êags
 ){

1247 
max
;

1248 
cmp
;

1249 
rc
;

1250 
CﬁlSeq
 *
pCﬁl
 = 
	`sqlôe4GëFuncCﬁlSeq
(
c⁄ãxt
);

1259 
max
 = 
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
)!=0;

1260 
rc
 = 
	`sqlôe4MemCom∑ª
(
pBe°
, 
pArg
, 
pCﬁl
, &
cmp
);

1261 if–
rc
!=
SQLITE4_OK
 ){

1262 
	`sqlôe4_ªsu…_îr‹_code
(
c⁄ãxt
, 
rc
);

1265 if–(
max
 && 
cmp
<0) || (!max && cmp>0) ){

1266 
	`sqlôe4VdbeMemC›y
(
pBe°
, 
pArg
);

1269 
	`sqlôe4VdbeMemC›y
(
pBe°
, 
pArg
);

1271 
	}
}

1272 
	$möMaxFöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

1273 
sqlôe4_vÆue
 *
pRes
;

1274 
pRes
 = (
sqlôe4_vÆue
 *)
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, 0);

1275 if–
pRes
 ){

1276 if–
	`ALWAYS
(
pRes
->
Êags
) ){

1277 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
pRes
);

1279 
	`sqlôe4VdbeMemRñó£
(
pRes
);

1281 
	}
}

1286 
	$groupC⁄ˇtSãp
(

1287 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1288 
¨gc
,

1289 
sqlôe4_vÆue
 **
¨gv


1291 c⁄° *
zVÆ
;

1292 
SåAccum
 *
pAccum
;

1293 c⁄° *
zSï
;

1294 
nVÆ
, 
nSï
;

1295 
	`as£π
–
¨gc
==1 ||árgc==2 );

1296 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ) ;

1297 
pAccum
 = (
SåAccum
*)
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*pAccum));

1299 if–
pAccum
 ){

1300 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
c⁄ãxt
);

1301 
fú°Tîm
 = 
pAccum
->
u£MÆloc
==0;

1302 
pAccum
->
u£MÆloc
 = 2;

1303 
pAccum
->
pEnv
 = 
db
->pEnv;

1304 
pAccum
->
mxAŒoc
 = 
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
];

1305 if–!
fú°Tîm
 ){

1306 if–
¨gc
==2 ){

1307 
zSï
 = (*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], &
nSï
);

1309 
zSï
 = ",";

1310 
nSï
 = 1;

1312 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
zSï
, 
nSï
);

1314 
zVÆ
 = (*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
nVÆ
);

1315 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
zVÆ
, 
nVÆ
);

1317 
	}
}

1318 
	$groupC⁄ˇtFöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

1319 
SåAccum
 *
pAccum
;

1320 
pAccum
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, 0);

1321 if–
pAccum
 ){

1322 if–
pAccum
->
tooBig
 ){

1323 
	`sqlôe4_ªsu…_îr‹_toobig
(
c⁄ãxt
);

1324 }if–
pAccum
->
mÆlocFaûed
 ){

1325 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

1327 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
	`sqlôe4SåAccumFöish
(
pAccum
), -1,

1328 
SQLITE4_DYNAMIC
, 0);

1331 
	}
}

1338 
	$sqlôe4Regi°îBuûtöFun˘i⁄s
(
sqlôe4
 *
db
){

1339 
rc
 = 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "MATCH", 2);

1340 
	`as£π
–
rc
==
SQLITE4_NOMEM
 ||Ñc==
SQLITE4_OK
 );

1341 if–
rc
==
SQLITE4_NOMEM
 ){

1342 
db
->
mÆlocFaûed
 = 1;

1344 
	}
}

1349 
	$£tLikeO±Fœg
(
sqlôe4
 *
db
, c⁄° *
zName
, 
u8
 
ÊagVÆ
){

1350 
FuncDef
 *
pDef
;

1351 
pDef
 = 
	`sqlôe4FödFun˘i⁄
(
db
, 
zName
, 
	`sqlôe4SåÀn30
(zName), 2, 0);

1352 if–
	`ALWAYS
(
pDef
) ){

1353 
pDef
->
Êags
 = 
ÊagVÆ
;

1355 
	}
}

1362 
	$sqlôe4Regi°îLikeFun˘i⁄s
(
sqlôe4
 *
db
, 
ˇ£Sísôive
){

1363 
com∑ªInfo
 *
pInfo
;

1364 if–
ˇ£Sísôive
 ){

1365 
pInfo
 = (
com∑ªInfo
*)&
likeInfoA…
;

1367 
pInfo
 = (
com∑ªInfo
*)&
likeInfoN‹m
;

1369 
	`sqlôe4Cª©eFunc
(
db
, "like", 2, 
pInfo
, 
likeFunc
, 0, 0, 0);

1370 
	`sqlôe4Cª©eFunc
(
db
, "like", 3, 
pInfo
, 
likeFunc
, 0, 0, 0);

1371 
	`sqlôe4Cª©eFunc
(
db
, "glob", 2,

1372 (
com∑ªInfo
*)&
globInfo
, 
likeFunc
, 0, 0, 0);

1373 
	`£tLikeO±Fœg
(
db
, "glob", 
SQLITE4_FUNC_LIKE
 | 
SQLITE4_FUNC_CASE
);

1374 
	`£tLikeO±Fœg
(
db
, "like",

1375 
ˇ£Sísôive
 ? (
SQLITE4_FUNC_LIKE
 | 
SQLITE4_FUNC_CASE
) : SQLITE4_FUNC_LIKE);

1376 
	}
}

1385 
	$sqlôe4IsLikeFun˘i⁄
(
sqlôe4
 *
db
, 
Ex¥
 *
pEx¥
, *
pIsNoˇ£
, *
aWc
){

1386 
FuncDef
 *
pDef
;

1387 if–
pEx¥
->
›
!=
TK_FUNCTION


1388 || !
pEx¥
->
x
.
pLi°


1389 || 
pEx¥
->
x
.
pLi°
->
nEx¥
!=2

1393 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

1394 
pDef
 = 
	`sqlôe4FödFun˘i⁄
(
db
, 
pEx¥
->
u
.
zTokí
,

1395 
	`sqlôe4SåÀn30
(
pEx¥
->
u
.
zTokí
), 2, 0);

1396 if–
	`NEVER
(
pDef
==0Ë|| (pDef->
Êags
 & 
SQLITE4_FUNC_LIKE
)==0 ){

1404 
	`mem˝y
(
aWc
, 
pDef
->
pU£rD©a
, 3);

1405 
	`as£π
–(*)&
likeInfoA…
 =(*)&likeInfoA….
m©chAŒ
 );

1406 
	`as£π
–&((*)&
likeInfoA…
)[1] =(*)&likeInfoA….
m©chO√
 );

1407 
	`as£π
–&((*)&
likeInfoA…
)[2] =(*)&likeInfoA….
m©chSë
 );

1408 *
pIsNoˇ£
 = (
pDef
->
Êags
 & 
SQLITE4_FUNC_CASE
)==0;

1410 
	}
}

1419 
	$sqlôe4Regi°îGlobÆFun˘i⁄s
(
sqlôe4_ív
 *
pEnv
){

1427 
FuncDef
 
aBuûtöFunc
[] = {

1428 
	`FUNCTION
(
…rim
, 1, 1, 0, 
åimFunc
 ),

1429 
	`FUNCTION
(
…rim
, 2, 1, 0, 
åimFunc
 ),

1430 
	`FUNCTION
(
πrim
, 1, 2, 0, 
åimFunc
 ),

1431 
	`FUNCTION
(
πrim
, 2, 2, 0, 
åimFunc
 ),

1432 
	`FUNCTION
(
åim
, 1, 3, 0, 
åimFunc
 ),

1433 
	`FUNCTION
(
åim
, 2, 3, 0, 
åimFunc
 ),

1434 
	`FUNCTION
(
mö
, -1, 0, 1, 
mömaxFunc
 ),

1435 
	`FUNCTION
(
mö
, 0, 0, 1, 0 ),

1436 
	`AGGREGATE
(
mö
, 1, 0, 1, 
mömaxSãp
, 
möMaxFöÆize
 ),

1437 
	`FUNCTION
(
max
, -1, 1, 1, 
mömaxFunc
 ),

1438 
	`FUNCTION
(
max
, 0, 1, 1, 0 ),

1439 
	`AGGREGATE
(
max
, 1, 1, 1, 
mömaxSãp
, 
möMaxFöÆize
 ),

1440 
	`FUNCTION
(
ty≥of
, 1, 0, 0, 
ty≥ofFunc
 ),

1441 
	`FUNCTION
(
Àngth
, 1, 0, 0, 
ÀngthFunc
 ),

1442 
	`FUNCTION
(
sub°r
, 2, 0, 0, 
sub°rFunc
 ),

1443 
	`FUNCTION
(
sub°r
, 3, 0, 0, 
sub°rFunc
 ),

1444 
	`FUNCTION
(
abs
, 1, 0, 0, 
absFunc
 ),

1445 
	`FUNCTION
(
round
, 1, 0, 0, 
roundFunc
 ),

1446 
	`FUNCTION
(
round
, 2, 0, 0, 
roundFunc
 ),

1447 
	`FUNCTION
(
uµî
, 1, 0, 0, 
uµîFunc
 ),

1448 
	`FUNCTION
(
lowî
, 1, 0, 0, 
lowîFunc
 ),

1449 
	`FUNCTION
(
cﬂÀs˚
, 1, 0, 0, 0 ),

1450 
	`FUNCTION
(
cﬂÀs˚
, 0, 0, 0, 0 ),

1452 {-1,
SQLITE4_FUNC_COALESCE
,0,0,
i‚uŒFunc
,0,0,"coalesce",0,0},

1453 
	`FUNCTION
(
hex
, 1, 0, 0, 
hexFunc
 ),

1455 {2,
SQLITE4_FUNC_COALESCE
,0,0,
i‚uŒFunc
,0,0,"ifnull",0,0},

1456 
	`FUNCTION
(
øndom
, 0, 0, 0, 
øndomFunc
 ),

1457 
	`FUNCTION
(
øndomblob
, 1, 0, 0, 
øndomBlob
 ),

1458 
	`FUNCTION
(
nuŒif
, 2, 0, 1, 
nuŒifFunc
 ),

1459 
	`FUNCTION
(
sqlôe_vîsi⁄
, 0, 0, 0, 
vîsi⁄Func
 ),

1460 
	`FUNCTION
(
sqlôe_sour˚_id
, 0, 0, 0, 
sour˚idFunc
 ),

1461 
	`FUNCTION
(
sqlôe_log
, 2, 0, 0, 
îæogFunc
 ),

1462 #i‚de‡
SQLITE4_OMIT_COMPILEOPTION_DIAGS


1463 
	`FUNCTION
(
sqlôe_compûe›ti⁄_u£d
,1, 0, 0, 
compûe›ti⁄u£dFunc
 ),

1464 
	`FUNCTION
(
sqlôe_compûe›ti⁄_gë
, 1, 0, 0, 
compûe›ti⁄gëFunc
 ),

1466 
	`FUNCTION
(
quŸe
, 1, 0, 0, 
quŸeFunc
 ),

1467 
	`FUNCTION
(
ch™ges
, 0, 0, 0, changes ),

1468 
	`FUNCTION
(
tŸÆ_ch™ges
, 0, 0, 0,Åotal_changes ),

1469 
	`FUNCTION
(
ª∂a˚
, 3, 0, 0, 
ª∂a˚Func
 ),

1470 #ifde‡
SQLITE4_SOUNDEX


1471 
	`FUNCTION
(
soundex
, 1, 0, 0, 
soundexFunc
 ),

1474 
	`FUNCTION
(
lﬂd_exãnsi⁄
, 1, 0, 0, 
lﬂdExt
 ),

1475 
	`FUNCTION
(
lﬂd_exãnsi⁄
, 2, 0, 0, 
lﬂdExt
 ),

1477 
	`AGGREGATE
(
sum
, 1, 0, 0, 
sumSãp
, 
sumFöÆize
 ),

1478 
	`AGGREGATE
(
tŸÆ
, 1, 0, 0, 
sumSãp
, 
tŸÆFöÆize
 ),

1479 
	`AGGREGATE
(
avg
, 1, 0, 0, 
sumSãp
, 
avgFöÆize
 ),

1481 {0,
SQLITE4_FUNC_COUNT
,0,0,0,
cou¡Sãp
,
cou¡FöÆize
,"count",0,0},

1482 
	`AGGREGATE
(
cou¡
, 1, 0, 0, 
cou¡Sãp
, 
cou¡FöÆize
 ),

1483 
	`AGGREGATE
(
group_c⁄ˇt
, 1, 0, 0, 
groupC⁄ˇtSãp
, 
groupC⁄ˇtFöÆize
),

1484 
	`AGGREGATE
(
group_c⁄ˇt
, 2, 0, 0, 
groupC⁄ˇtSãp
, 
groupC⁄ˇtFöÆize
),

1486 
	`LIKEFUNC
(
glob
, 2, &
globInfo
, 
SQLITE4_FUNC_LIKE
|
SQLITE4_FUNC_CASE
),

1487 #ifde‡
SQLITE4_CASE_SENSITIVE_LIKE


1488 
	`LIKEFUNC
(
like
, 2, &
likeInfoA…
, 
SQLITE4_FUNC_LIKE
|
SQLITE4_FUNC_CASE
),

1489 
	`LIKEFUNC
(
like
, 3, &
likeInfoA…
, 
SQLITE4_FUNC_LIKE
|
SQLITE4_FUNC_CASE
),

1491 
	`LIKEFUNC
(
like
, 2, &
likeInfoN‹m
, 
SQLITE4_FUNC_LIKE
),

1492 
	`LIKEFUNC
(
like
, 3, &
likeInfoN‹m
, 
SQLITE4_FUNC_LIKE
),

1496 
i
;

1497 
FuncDefTabÀ
 *
pFuncTab
 = &
pEnv
->
aGlobÆFuncs
;

1498 
FuncDef
 *
aFunc
 = (FuncDef*)
aBuûtöFunc
;

1500 
i
=0; i<
	`AºaySize
(
aBuûtöFunc
); i++){

1501 
	`sqlôe4FuncDefIn£π
(
pFuncTab
, &
aFunc
[
i
], 1);

1503 
	`sqlôe4Regi°îD©eTimeFun˘i⁄s
(
pEnv
);

1504 #i‚de‡
SQLITE4_OMIT_ALTERTABLE


1505 
	`sqlôe4A…îFun˘i⁄s
(
pEnv
);

1507 #i‚de‡
SQLITE4_OMIT_VECTOR


1508 
	`sqlôe4Regi°îVe˘‹Fun˘i⁄s
(
pEnv
);

1510 
	}
}

	@src/global.c

15 
	~"sqlôeI¡.h
"

24 c⁄° 
	gsqlôe4UµîToLowî
[] = {

25 #ifde‡
SQLITE4_ASCII


42 #ifde‡
SQLITE4_EBCDIC


92 #ifde‡
SQLITE4_ASCII


93 c⁄° 
	gsqlôe4Cty≥M≠
[256] = {

136 c⁄° 
Tokí
 
	gsqlôe4I¡Tokís
[] = {

141 
	~"›codes.h
"

148 c⁄° 
	gsqlôe4OpcodePr›îty
[] = 
OPFLG_INITIALIZER
;

	@src/hash.c

15 
	~"sqlôeI¡.h
"

16 
	~<as£π.h
>

21 
	$°rHash
(c⁄° *
z
, 
nKey
){

22 
h
 = 0;

23 
	`as£π
–
nKey
>=0 );

24  
nKey
 > 0 ){

25 
h
 = (h<<3Ë^ h ^ 
sqlôe4UµîToLowî
[()*
z
++];

26 
nKey
--;

28  
h
;

29 
	}
}

31 
	$°rCmp
(c⁄° *
z1
, c⁄° *
z2
, 
n
){

32  
	`sqlôe4_°∫icmp
(
z1
, 
z2
, 
n
);

33 
	}
}

35 
	$böHash
(c⁄° *
z
, 
nKey
){

36 
h
 = 0;

37 
	`as£π
–
nKey
>=0 );

38  
nKey
 > 0 ){

39 
h
 = (h<<3Ë^ h ^ (()*
z
++);

40 
nKey
--;

42  
h
;

43 
	}
}

45 
	$böCmp
(c⁄° *
z1
, c⁄° *
z2
, 
n
){

46  
	`memcmp
(
z1
, 
z2
, 
n
);

47 
	}
}

54 
	$sqlôe4HashInô
(
sqlôe4_ív
 *
pEnv
, 
Hash
 *
pNew
, 
bBö
){

55 
	`as£π
–
pNew
!=0 );

56 
pNew
->
fú°
 = 0;

57 
pNew
->
cou¡
 = 0;

58 
pNew
->
htsize
 = 0;

59 
pNew
->
ht
 = 0;

60 
pNew
->
pEnv
 =ÖEnv;

61 if–
bBö
 ){

62 
pNew
->
xHash
 = 
böHash
;

63 
pNew
->
xCmp
 = 
böCmp
;

65 
pNew
->
xHash
 = 
°rHash
;

66 
pNew
->
xCmp
 = 
°rCmp
;

68 
	}
}

74 
	$sqlôe4HashCÀ¨
(
Hash
 *
pH
){

75 
HashEÀm
 *
ñem
;

77 
	`as£π
–
pH
!=0 );

78 
ñem
 = 
pH
->
fú°
;

79 
pH
->
fú°
 = 0;

80 
	`sqlôe4_‰ì
(
pH
->
pEnv
,ÖH->
ht
);

81 
pH
->
ht
 = 0;

82 
pH
->
htsize
 = 0;

83  
ñem
 ){

84 
HashEÀm
 *
√xt_ñem
 = 
ñem
->
√xt
;

85 
	`sqlôe4_‰ì
(
pH
->
pEnv
, 
ñem
);

86 
ñem
 = 
√xt_ñem
;

88 
pH
->
cou¡
 = 0;

89 
	}
}

94 
	$ö£πEÀmít
(

95 
Hash
 *
pH
,

96 
_ht
 *
pE¡ry
,

97 
HashEÀm
 *
pNew


99 
HashEÀm
 *
pHód
;

100 if–
pE¡ry
 ){

101 
pHód
 = 
pE¡ry
->
cou¡
 ?ÖE¡ry->
chaö
 : 0;

102 
pE¡ry
->
cou¡
++;

103 
pE¡ry
->
chaö
 = 
pNew
;

105 
pHód
 = 0;

107 if–
pHód
 ){

108 
pNew
->
√xt
 = 
pHód
;

109 
pNew
->
¥ev
 = 
pHód
->prev;

110 if–
pHód
->
¥ev
 ){ÖHód->¥ev->
√xt
 = 
pNew
; }

111 { 
pH
->
fú°
 = 
pNew
; }

112 
pHód
->
¥ev
 = 
pNew
;

114 
pNew
->
√xt
 = 
pH
->
fú°
;

115 if–
pH
->
fú°
 ){ÖH->fú°->
¥ev
 = 
pNew
; }

116 
pNew
->
¥ev
 = 0;

117 
pH
->
fú°
 = 
pNew
;

119 
	}
}

128 
	$ªhash
(
Hash
 *
pH
, 
√w_size
){

129 
_ht
 *
√w_ht
;

130 
HashEÀm
 *
ñem
, *
√xt_ñem
;

132 #i‡
SQLITE4_MALLOC_SOFT_LIMIT
>0

133 if–
√w_size
*(
_ht
)>
SQLITE4_MALLOC_SOFT_LIMIT
 ){

134 
√w_size
 = 
SQLITE4_MALLOC_SOFT_LIMIT
/(
_ht
);

136 if–
√w_size
==
pH
->
htsize
 )  0;

143 
	`sqlôe4BegöBíignMÆloc
(
pH
->
pEnv
);

144 
√w_ht
 = (
_ht
 *)
	`sqlôe4MÆloc
(
pH
->
pEnv
, 
√w_size
*(_ht) );

145 
	`sqlôe4EndBíignMÆloc
(
pH
->
pEnv
);

147 if–
√w_ht
==0 )  0;

148 
	`sqlôe4_‰ì
(
pH
->
pEnv
,ÖH->
ht
);

149 
pH
->
ht
 = 
√w_ht
;

150 
pH
->
htsize
 = 
√w_size
 = 
	`sqlôe4MÆlocSize
’H->
pEnv
, 
√w_ht
)/(
_ht
);

151 
	`mem£t
(
√w_ht
, 0, 
√w_size
*(
_ht
));

152 
ñem
=
pH
->
fú°
,ÖH->fú°=0;ÉÀm;ÉÀm = 
√xt_ñem
){

153 
h
 = 
pH
->
	`xHash
(
ñem
->
pKey
,ÉÀm->
nKey
Ë% 
√w_size
;

154 
√xt_ñem
 = 
ñem
->
√xt
;

155 
	`ö£πEÀmít
(
pH
, &
√w_ht
[
h
], 
ñem
);

158 
	}
}

164 
HashEÀm
 *
	$födEÀmítGivíHash
(

165 c⁄° 
Hash
 *
pH
,

166 c⁄° *
pKey
,

167 
nKey
,

168 
h


170 
HashEÀm
 *
ñem
;

171 
cou¡
;

173 if–
pH
->
ht
 ){

174 
_ht
 *
pE¡ry
 = &
pH
->
ht
[
h
];

175 
ñem
 = 
pE¡ry
->
chaö
;

176 
cou¡
 = 
pE¡ry
->count;

178 
ñem
 = 
pH
->
fú°
;

179 
cou¡
 = 
pH
->count;

181  
cou¡
-- && 
	`ALWAYS
(
ñem
) ){

182 if–
ñem
->
nKey
=ÚKey && 
pH
->
	`xCmp
”Àm->
pKey
,pKey,nKey)==0 ){

183  
ñem
;

185 
ñem
 =ÉÀm->
√xt
;

188 
	}
}

193 
	$ªmoveEÀmítGivíHash
(

194 
Hash
 *
pH
,

195 
HashEÀm
* 
ñem
,

196 
h


198 
_ht
 *
pE¡ry
;

199 if–
ñem
->
¥ev
 ){

200 
ñem
->
¥ev
->
√xt
 =Élem->next;

202 
pH
->
fú°
 = 
ñem
->
√xt
;

204 if–
ñem
->
√xt
 ){

205 
ñem
->
√xt
->
¥ev
 =Élem->prev;

207 if–
pH
->
ht
 ){

208 
pE¡ry
 = &
pH
->
ht
[
h
];

209 if–
pE¡ry
->
chaö
==
ñem
 ){

210 
pE¡ry
->
chaö
 = 
ñem
->
√xt
;

212 
pE¡ry
->
cou¡
--;

213 
	`as£π
–
pE¡ry
->
cou¡
>=0 );

215 
	`sqlôe4_‰ì
(
pH
->
pEnv
, 
ñem
);

216 
pH
->
cou¡
--;

217 if–
pH
->
cou¡
<=0 ){

218 
	`as£π
–
pH
->
fú°
==0 );

219 
	`as£π
–
pH
->
cou¡
==0 );

220 
	`sqlôe4HashCÀ¨
(
pH
);

222 
	}
}

228 *
	$sqlôe4HashFöd
(c⁄° 
Hash
 *
pH
, c⁄° *
pKey
, 
nKey
){

229 
HashEÀm
 *
ñem
;

230 
h
;

232 
	`as£π
–
pH
!=0 );

233 
	`as£π
–
pKey
!=0 );

234 
	`as£π
–
nKey
>=0 );

235 if–
pH
->
ht
 ){

236 
h
 = 
pH
->
	`xHash
(
pKey
, 
nKey
Ë%ÖH->
htsize
;

238 
h
 = 0;

240 
ñem
 = 
	`födEÀmítGivíHash
(
pH
, 
pKey
, 
nKey
, 
h
);

241  
ñem
 ?ÉÀm->
d©a
 : 0;

242 
	}
}

258 *
	$sqlôe4HashIn£π
(
Hash
 *
pH
, c⁄° *
pKey
, 
nKey
, *
d©a
){

259 
h
;

260 
HashEÀm
 *
ñem
;

261 
HashEÀm
 *
√w_ñem
;

263 
	`as£π
–
pH
!=0 );

264 
	`as£π
–
pKey
!=0 );

265 
	`as£π
–
nKey
>=0 );

266 if–
pH
->
htsize
 ){

267 
h
 = 
pH
->
	`xHash
(
pKey
, 
nKey
Ë%ÖH->
htsize
;

269 
h
 = 0;

271 
ñem
 = 
	`födEÀmítGivíHash
(
pH
,
pKey
,
nKey
,
h
);

272 if–
ñem
 ){

273 *
ﬁd_d©a
 = 
ñem
->
d©a
;

274 if–
d©a
==0 ){

275 
	`ªmoveEÀmítGivíHash
(
pH
,
ñem
,
h
);

277 
ñem
->
d©a
 = data;

278 
ñem
->
pKey
 =ÖKey;

279 
	`as£π
(
nKey
==
ñem
->nKey);

281  
ﬁd_d©a
;

283 if–
d©a
==0 )  0;

284 
√w_ñem
 = (
HashEÀm
*)
	`sqlôe4MÆloc
(
pH
->
pEnv
, (HashElem) );

285 if–
√w_ñem
==0 )  
d©a
;

286 
√w_ñem
->
pKey
 =ÖKey;

287 
√w_ñem
->
nKey
 =ÇKey;

288 
√w_ñem
->
d©a
 = data;

289 
pH
->
cou¡
++;

290 if–
pH
->
cou¡
>=10 &&ÖH->cou¡ > 2*pH->
htsize
 ){

291 if–
	`ªhash
(
pH
,ÖH->
cou¡
*2) ){

292 
	`as£π
–
pH
->
htsize
>0 );

293 
h
 = 
pH
->
	`xHash
(
pKey
, 
nKey
Ë%ÖH->
htsize
;

296 if–
pH
->
ht
 ){

297 
	`ö£πEÀmít
(
pH
, &pH->
ht
[
h
], 
√w_ñem
);

299 
	`ö£πEÀmít
(
pH
, 0, 
√w_ñem
);

302 
	}
}

	@src/hash.h

15 #i‚de‡
_SQLITE4_HASH_H_


16 
	#_SQLITE4_HASH_H_


	)

19 
Hash
 
	tHash
;

20 
HashEÀm
 
	tHashEÀm
;

43 
	sHash
 {

44 
sqlôe4_ív
 *
	mpEnv
;

45 (*
	mxHash
)(const *, );

46 (*
	mxCmp
)(const *, const *, );

47 
	mhtsize
;

48 
	mcou¡
;

49 
HashEÀm
 *
	mfú°
;

50 
	s_ht
 {

51 
	mcou¡
;

52 
HashEÀm
 *
	mchaö
;

53 } *
	mht
;

62 
	sHashEÀm
 {

63 
HashEÀm
 *
	m√xt
, *
	m¥ev
;

64 *
	md©a
;

65 c⁄° *
	mpKey
; 
	mnKey
;

71 
sqlôe4HashInô
(
sqlôe4_ív
 *
pEnv
, 
Hash
*, );

72 *
sqlôe4HashIn£π
(
Hash
*, c⁄° *
pKey
, 
nKey
, *
pD©a
);

73 *
sqlôe4HashFöd
(c⁄° 
Hash
*, c⁄° *
pKey
, 
nKey
);

74 
sqlôe4HashCÀ¨
(
Hash
*);

88 
	#sqlôeHashFú°
(
H
Ë((H)->
fú°
)

	)

89 
	#sqlôeHashNext
(
E
Ë((E)->
√xt
)

	)

90 
	#sqlôeHashD©a
(
E
Ë((E)->
d©a
)

	)

91 
	#sqlôeHashKey
(
E
Ë((E)->
pKey
)

	)

92 
	#sqlôeHashKeysize
(
E
Ë((E)->
nKey
)

	)

	@src/hwtime.h

16 #i‚de‡
_HWTIME_H_


17 
	#_HWTIME_H_


	)

25 #i‡(
deföed
(
__GNUC__
Ë|| deföed(
_MSC_VER
)) && \

26 (
deföed
(
i386
Ë|| deföed(
__i386__
Ë|| 
	$deföed
(
_M_IX86
))

28 #i‡
	`deföed
(
__GNUC__
)

30 
__ölöe__
 
sqlôe_uöt64
 
	$sqlôe4Hwtime
(){

31 
lo
, 
hi
;

32 
__asm__
 
	`__vﬁ©ûe__
 ("rdtsc" : "˜" (
lo
), "=d" (
hi
));

33  (
sqlôe_uöt64
)
hi
 << 32 | 
lo
;

34 
	}
}

36 #ñi‡
deföed
(
_MSC_VER
)

38 
	$__de˛•ec
(
«ked
Ë
__ölöe
 
sqlôe_uöt64
 
__cde˛
 
	$sqlôe4Hwtime
(){

39 
__asm
 {

40 
rdtsc


41 
ªt
 ;  
vÆue
 
©
 
EDX
:
EAX


43 
	}
}

47 #ñi‡(
deföed
(
__GNUC__
Ë&& deföed(
__x86_64__
))

49 
__ölöe__
 
sqlôe_uöt64
 
	$sqlôe4Hwtime
(){

50 
vÆ
;

51 
__asm__
 
	`__vﬁ©ûe__
 ("rdtsc" : "=A" (
vÆ
));

52  
vÆ
;

53 
	}
}

55 #ñi‡(
deföed
(
__GNUC__
Ë&& deföed(
__µc__
))

57 
__ölöe__
 
sqlôe_uöt64
 
	$sqlôe4Hwtime
(){

58 
ªtvÆ
;

59 
junk
;

60 
__asm__
 
	`__vﬁ©ûe__
 ("\n\
1: mftbu %1\n\
 %L0\n\
 %0\n\
 %0,%1\n\
 1b"

66 : "Ù" (
ªtvÆ
), "Ù" (
junk
));

67  
ªtvÆ
;

68 
	}
}

72 #îr‹ 
Nìd
 
im∂emíèti⁄
 
of
 
sqlôe4Hwtime
(Ë
your
 
∂©f‹m
.

81 
sqlôe_uöt64
 
	$sqlôe4Hwtime
(){  ((
sqlôe_uöt64
)0); 
	}
}

	@src/insert.c

15 
	~"sqlôeI¡.h
"

20 
	$sqlôe4O≥nTabÀ
(

21 
P¨£
 *
p
,

22 
iCur
,

23 
iDb
,

24 
TabÀ
 *
pTab
,

25 
›code


27 
Index
 *
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

28 
	`¥ötf
("sqlôe4O≥nTabÀ: o≥nögÅabÀ %†wôh opcodê%d\n", 
pTab
->
zName
, 
›code
);

29 
	`sqlôe4O≥nIndex
(
p
, 
iCur
, 
iDb
, 
pPk
, 
›code
);

30 
	}
}

36 
	$sqlôe4O≥nIndex
(

37 
P¨£
 *
p
,

38 
iCur
,

39 
iDb
,

40 
Index
 *
pIdx
,

41 
›code


43 
KeyInfo
 *
pKey
;

44 
Vdbe
 *
v
;

46 
	`as£π
–
›code
==
OP_O≥nWrôe
 || opcode==
OP_O≥nRód
 );

47 
	`as£π
–
pIdx
->
äum
>0 );

49 
v
 = 
	`sqlôe4GëVdbe
(
p
);

50 
pKey
 = 
	`sqlôe4IndexKeyöfo
(
p
, 
pIdx
);

51 i‡(
pKey
 == 0) {

52 
	`¥ötf
("Error: couldÇot get KeyInfo for index\n");

54 
	`ã°ˇ£
–
pKey
==0 );

56 
	`sqlôe4VdbeAddOp3
(
v
, 
›code
, 
iCur
, 
pIdx
->
äum
, 
iDb
);

57 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pKey
, 
P4_KEYINFO_HANDOFF
);

58 
	`VdbeCommít
((
v
, "%s", 
pIdx
->
zName
));

59 
	`¥ötf
("sqlôe4O≥nIndex: o≥√d index %s, idxIsVe˘‹ %d\n", 
pIdx
->
zName
,ÖIdx->
idxIsVe˘‹
);

60 
	}
}

65 
KeyInfo
 *
	$sqlôe4TabÀPrim¨yKeyöfo
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
){

66 
sqlôe4
 *
db
 = 
pP¨£
->db;

67 
i
, 
j
;

68 
nPk
 = 0;

71 
i
=0; i<
pTab
->
nCﬁ
; i++){

72 if–
pTab
->
aCﬁ
[
i
].
iPrimKey
 ) 
nPk
++;

74 if–
nPk
==0 ){

79 
nByã
 = (
KeyInfo
Ë+ (
nPk
-1)*()(
CﬁlSeq
*Ë+ÇPk*()(
u8
);

80 
KeyInfo
 *
pKey
 = (KeyInfo*)
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

81 if–
pKey
==0 )  0;

83 
pKey
->
nFõld
 = (
u16
)
nPk
;

84 
pKey
->
nPK
 = (
u16
)
nPk
;

85 
pKey
->
nD©a
 = (
u16
)
pTab
->
nCﬁ
;

87 
pKey
->
aS‹tOrdî
 = (
u8
*)&pKey->
aCﬁl
[
nPk
];

88 
	`mem£t
(
pKey
->
aS‹tOrdî
, 0, 
nPk
);

91 
j
=1; j<=
nPk
; j++){

92 
CﬁlSeq
 *
pCﬁl
 = 0;

93 
i
=0; i<
pTab
->
nCﬁ
; i++){

94 if–
pTab
->
aCﬁ
[
i
].
iPrimKey
==
j
 ){

95 c⁄° *
zCﬁl
 = 
pTab
->
aCﬁ
[
i
].zColl;

96 if–
zCﬁl
 && zColl[0] ){

97 
pCﬁl
 = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
zCﬁl
);

99 if–
pCﬁl
==0 ){

100 
pCﬁl
 = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, "binary");

105 if–
pCﬁl
==0 ){

106 
	`sqlôe4DbFªe
(
db
, 
pKey
);

109 
pKey
->
aCﬁl
[
j
-1] = 
pCﬁl
;

112  
pKey
;

113 
	}
}

120 
	$sqlôe4O≥nPrim¨yKey
(

121 
P¨£
 *
p
,

122 
iCur
,

123 
iDb
,

124 
TabÀ
 *
pTab
,

125 
›code


127 
	`as£π
–
›code
==
OP_O≥nWrôe
 || opcode==
OP_O≥nRód
 );

128 if–
	`IsVútuÆ
(
pTab
)==0 ){

129 
Index
 *
pIdx
;

131 
pIdx
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

132 if–
pIdx
 ){

133 
	`sqlôe4O≥nIndex
(
p
, 
iCur
, 
iDb
, 
pIdx
, 
›code
);

134 
	`as£π
–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 );

136 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
p
);

137 
KeyInfo
 *
pKey
;

138 
äum
;

139 if–
v
==0 ){

140 
	`¥ötf
("Error: couldÇot get Vdbe\n");

143 
äum
 = 
pTab
->tnum;

144 
pKey
 = 
	`sqlôe4TabÀPrim¨yKeyöfo
(
p
, 
pTab
);

145 i‡(
pKey
 == 0) {

146 
	`¥ötf
("Error: couldÇot get KeyInfo forÅableÖrimary key\n");

149 
	`sqlôe4VdbeAddOp3
(
v
, 
›code
, 
iCur
, 
äum
, 
iDb
);

150 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pKey
, 
P4_KEYINFO_HANDOFF
);

151 
	`VdbeCommít
((
v
, "%s", 
pTab
->
zName
));

154 
	}
}

177 c⁄° *
	$sqlôe4IndexAfföôySå
(
Vdbe
 *
v
, 
Index
 *
pIdx
){

183 if–!
pIdx
->
zCﬁAff
 ){

184 
sqlôe4
 *
db
 = 
	`sqlôe4VdbeDb
(
v
);

185 
TabÀ
 *
pTab
 = 
pIdx
->
pTabÀ
;

186 
n
;

187 
Index
 *
pPk
;

188 
Index
 *
p
;

189 *
zAff
;

190 
nAff
;

196 
nAff
 = 
pIdx
->
nCﬁumn
;

197 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

198 if–
pPk
 && 
pIdx
!=pPk ){

199 
nAff
 +
pPk
->
nCﬁumn
;

203 
zAff
 = 
pIdx
->
zCﬁAff
 = (*)
	`sqlôe4DbMÆlocRaw
(0, 
nAff
+1);

204 if–!
zAff
 ){

205 
db
->
mÆlocFaûed
 = 1;

214 
n
=0, 
p
=
pIdx
;Ö;Ö=’==
pPk
 ? (
Index
*)0 :ÖPk)){

215 
i
;

216 
i
=0; i<
p
->
nCﬁumn
; i++){

217 
iCﬁ
 = 
p
->
aiCﬁumn
[
i
];

218 
zAff
[
n
++] = (
iCﬁ
<0Ë? 
SQLITE4_AFF_INTEGER
 : 
pTab
->
aCﬁ
[iCﬁ].
afföôy
;

221 
zAff
[
n
] = 0;

224  
pIdx
->
zCﬁAff
;

225 
	}
}

241 
	$sqlôe4TabÀAfföôySå
(
Vdbe
 *
v
, 
TabÀ
 *
pTab
){

249 if–!
pTab
->
zCﬁAff
 ){

250 *
zCﬁAff
;

251 
i
;

252 
sqlôe4
 *
db
 = 
	`sqlôe4VdbeDb
(
v
);

254 
zCﬁAff
 = (*)
	`sqlôe4DbMÆlocRaw
(0, 
pTab
->
nCﬁ
+1);

255 if–!
zCﬁAff
 ){

256 
db
->
mÆlocFaûed
 = 1;

260 
i
=0; i<
pTab
->
nCﬁ
; i++){

261 
zCﬁAff
[
i
] = 
pTab
->
aCﬁ
[i].
afföôy
;

263 
zCﬁAff
[
pTab
->
nCﬁ
] = '\0';

265 
pTab
->
zCﬁAff
 = zColAff;

268 
	`sqlôe4VdbeCh™geP4
(
v
, -1, 
pTab
->
zCﬁAff
, 
P4_TRANSIENT
);

269 
	}
}

280 
	$ªadsTabÀ
(
P¨£
 *
p
, 
iSèπAddr
, 
iDb
, 
TabÀ
 *
pTab
){

281 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
p
);

282 
i
;

283 
iEnd
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

284 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


285 
VTabÀ
 *
pVTab
 = 
	`IsVútuÆ
(
pTab
Ë? 
	`sqlôe4GëVTabÀ
(
p
->
db
,ÖTab) : 0;

288 
i
=
iSèπAddr
; i<
iEnd
; i++){

289 
VdbeOp
 *
pOp
 = 
	`sqlôe4VdbeGëOp
(
v
, 
i
);

290 
	`as£π
–
pOp
!=0 );

291 if–
pOp
->
›code
==
OP_O≥nRód
 &&ÖOp->
p3
==
iDb
 ){

292 
Index
 *
pIndex
;

293 
äum
 = 
pOp
->
p2
;

294 if–
äum
==
KVSTORE_ROOT
 )  1;

295 
pIndex
=
pTab
->pIndex;ÖIndex;ÖIndexıIndex->
pNext
){

296 if–
äum
==
pIndex
->tnum ){

301 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


302 if–
pOp
->
›code
==
OP_VO≥n
 &&ÖOp->
p4
.
pVèb
==
pVTab
 ){

303 
	`as£π
–
pOp
->
p4
.
pVèb
!=0 );

304 
	`as£π
–
pOp
->
p4ty≥
==
P4_VTAB
 );

310 
	}
}

312 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


333 
	$autoIncBegö
(

334 
P¨£
 *
pP¨£
,

335 
iDb
,

336 
TabÀ
 *
pTab


338 
memId
 = 0;

339 if–
pTab
->
èbFœgs
 & 
TF_Autoö¸emít
 ){

340 
P¨£
 *
pT›Àvñ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

341 
AutoöcInfo
 *
pInfo
;

343 
pInfo
 = 
pT›Àvñ
->
pAöc
;

344  
pInfo
 &&ÖInfo->
pTab
!ıTab ){ÖInfÿpInfo->
pNext
; }

345 if–
pInfo
==0 ){

346 
pInfo
 = 
	`sqlôe4DbMÆlocRaw
(
pP¨£
->
db
, (*pInfo));

347 if–
pInfo
==0 )  0;

348 
pInfo
->
pNext
 = 
pT›Àvñ
->
pAöc
;

349 
pT›Àvñ
->
pAöc
 = 
pInfo
;

350 
pInfo
->
pTab
 =ÖTab;

351 
pInfo
->
iDb
 = iDb;

352 
pT›Àvñ
->
nMem
++;

353 
pInfo
->
ªgCå
 = ++
pT›Àvñ
->
nMem
;

354 
pT›Àvñ
->
nMem
++;

356 
memId
 = 
pInfo
->
ªgCå
;

358  
memId
;

359 
	}
}

365 
	$sqlôe4Autoö¸emítBegö
(
P¨£
 *
pP¨£
){

366 
AutoöcInfo
 *
p
;

367 
sqlôe4
 *
db
 = 
pP¨£
->db;

368 
Db
 *
pDb
;

369 
memId
;

370 
addr
;

371 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

375 
	`as£π
–
pP¨£
->
pTriggîTab
==0 );

376 
	`as£π
–
pP¨£
==
	`sqlôe4P¨£T›Àvñ
(pParse) );

378 
	`as£π
–
v
 );

379 
p
 = 
pP¨£
->
pAöc
;Ö;Ö =Ö->
pNext
){

380 
pDb
 = &
db
->
aDb
[
p
->
iDb
];

381 
memId
 = 
p
->
ªgCå
;

382 
	`sqlôe4O≥nTabÀ
(
pP¨£
, 0, 
p
->
iDb
, 
pDb
->
pSchema
->
pSeqTab
, 
OP_O≥nRód
);

383 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NuŒ
, 0, 
memId
, memId+1);

384 
addr
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

385 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
memId
-1, 0, 
p
->
pTab
->
zName
, 0);

386 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 0, 
addr
+9);

387 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 0, 0, 
memId
);

388 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Ne
, 
memId
-1, 
addr
+7, memId);

389 
	`sqlôe4VdbeCh™geP5
(
v
, 
SQLITE4_JUMPIFNULL
);

390 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 0, 
memId
+1);

391 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 0, 1, 
memId
);

392 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addr
+9);

393 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 0, 
addr
+2);

394 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
memId
);

395 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_Clo£
);

397 
	}
}

407 
	$autoIncSãp
(
P¨£
 *
pP¨£
, 
memId
, 
ªgRowid
){

408 if–
memId
>0 ){

409 
	`sqlôe4VdbeAddOp2
(
pP¨£
->
pVdbe
, 
OP_MemMax
, 
memId
, 
ªgRowid
);

411 
	}
}

420 
	$sqlôe4Autoö¸emítEnd
(
P¨£
 *
pP¨£
){

421 
AutoöcInfo
 *
p
;

422 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

423 
sqlôe4
 *
db
 = 
pP¨£
->db;

425 
	`as£π
–
v
 );

426 
p
 = 
pP¨£
->
pAöc
;Ö;Ö =Ö->
pNext
){

427 
Db
 *
pDb
 = &
db
->
aDb
[
p
->
iDb
];

428 
j1
, 
j2
, 
j3
, 
j4
, 
j5
;

429 
iRec
;

430 
memId
 = 
p
->
ªgCå
;

432 
iRec
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

433 
	`sqlôe4O≥nTabÀ
(
pP¨£
, 0, 
p
->
iDb
, 
pDb
->
pSchema
->
pSeqTab
, 
OP_O≥nWrôe
);

434 
j1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NŸNuŒ
, 
memId
+1);

435 
j2
 = 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_Rewöd
);

436 
j3
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 0, 0, 
iRec
);

437 
j4
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Eq
, 
memId
-1, 0, 
iRec
);

438 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 0, 
j3
);

439 
	`sqlôe4VdbeJumpHîe
(
v
, 
j2
);

440 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 0, 
memId
+1);

441 
j5
 = 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_GŸo
);

442 
	`sqlôe4VdbeJumpHîe
(
v
, 
j4
);

443 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 0, 
memId
+1);

444 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

445 
	`sqlôe4VdbeJumpHîe
(
v
, 
j5
);

446 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
memId
-1, 2, 
iRec
);

447 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 0, 
iRec
, 
memId
+1);

448 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_Clo£
);

449 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
iRec
);

451 
	}
}

457 
	#autoIncBegö
(
A
,
B
,
C
Ë(0)

	)

458 
	#autoIncSãp
(
A
,
B
,
C
)

	)

463  
x„rO±imiz©i⁄
(

464 
P¨£
 *
pP¨£
,

465 
TabÀ
 *
pDe°
,

466 
Sñe˘
 *
pSñe˘
,

467 
⁄Eº‹
,

468 
iDbDe°


573 
	$sqlôe4In£π
(

574 
P¨£
 *
pP¨£
,

575 
SrcLi°
 *
pTabLi°
,

576 
Ex¥Li°
 *
pLi°
,

577 
Sñe˘
 *
pSñe˘
,

578 
IdLi°
 *
pCﬁumn
,

579 
⁄Eº‹


581 
sqlôe4
 *
db
;

582 
TabÀ
 *
pTab
;

583 *
zTab
;

584 c⁄° *
zDb
;

585 
i
, 
j
, 
idx
;

586 
Vdbe
 *
v
;

587 
Index
 *
pIdx
;

588 
nCﬁumn
;

589 
nHiddí
 = 0;

590 
ba£Cur
 = 0;

591 
ídOfLo›
;

592 
u£TempTabÀ
 = 0;

593 
§cTab
 = 0;

594 
addrInsT›
 = 0;

595 
addrC⁄t
 = 0;

596 
addrSñe˘
 = 0;

597 
Sñe˘De°
 
de°
;

598 
iDb
;

599 
Db
 *
pDb
;

600 
≠≥ndFœg
 = 0;

601 
iPk
;

602 
Index
 *
pPk
;

603 
iI¡PKCﬁ
 = -1;

604 
bIm∂icôPK
;

607 
ªgFromSñe˘
 = 0;

608 
ªgEof
 = 0;

609 *
aRegIdx
 = 0;

610 
ªgC⁄ã¡
;

611 
ªgRowid
;

612 
ªgAutoöc
;

614 #i‚de‡
SQLITE4_OMIT_TRIGGER


615 
isVõw
;

616 
Triggî
 *
pTriggî
;

617 
tmask
;

620 
db
 = 
pP¨£
->db;

621 
	`mem£t
(&
de°
, 0, (dest));

622 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ){

623 
ö£π_˛ónup
;

627 
	`as£π
–
pTabLi°
->
nSrc
==1 );

628 
zTab
 = 
pTabLi°
->
a
[0].
zName
;

629 if–
	`NEVER
(
zTab
==0ËË
ö£π_˛ónup
;

630 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
pTabLi°
);

631 if–
pTab
==0 ){

632 
ö£π_˛ónup
;

634 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

635 
	`as£π
–
iDb
<
db
->
nDb
 );

636 
pDb
 = &
db
->
aDb
[
iDb
];

637 
zDb
 = 
pDb
->
zName
;

638 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_INSERT
, 
pTab
->
zName
, 0, 
zDb
) ){

639 
ö£π_˛ónup
;

646 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, &
iPk
);

647 
	`as£π
–(
pPk
==0)==
	`IsVõw
(
pTab
) );

648 if–
pPk
 ){

649 
bIm∂icôPK
 = 
pPk
->
aiCﬁumn
[0]==(-1);

650 if–
pPk
->
fIndex
 & 
IDX_I¡PK
 ){

651 
	`as£π
–
pPk
->
nCﬁumn
==1 );

652 
iI¡PKCﬁ
 = 
pPk
->
aiCﬁumn
[0];

655 
bIm∂icôPK
 = 0;

661 #i‚de‡
SQLITE4_OMIT_TRIGGER


662 
pTriggî
 = 
	`sqlôe4TriggîsExi°
(
pP¨£
, 
pTab
, 
TK_INSERT
, 0, &
tmask
);

663 
isVõw
 = 
pTab
->
pSñe˘
!=0;

665 
	#pTriggî
 0

	)

666 
	#tmask
 0

	)

667 
	#isVõw
 0

	)

669 #ifde‡
SQLITE4_OMIT_VIEW


670 #unde‡
isVõw


671 
	#isVõw
 0

	)

673 
	`as£π
–(
pTriggî
 && 
tmask
) || (pTrigger==0 &&Åmask==0) );

678 if–
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
, 
pTab
) ){

679 
ö£π_˛ónup
;

686 if–
	`sqlôe4IsRódO∆y
(
pP¨£
, 
pTab
, 
tmask
) ){

687 
ö£π_˛ónup
;

691 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

692 if–
v
==0 ) 
ö£π_˛ónup
;

693 if–
pP¨£
->
√°ed
==0 ) 
	`sqlôe4VdbeCou¡Ch™ges
(
v
);

694 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 
pSñe˘
 || 
pTriggî
, 
iDb
);

699 
ªgAutoöc
 = 
	`autoIncBegö
(
pP¨£
, 
iDb
, 
pTab
);

706 if–
pSñe˘
 ){

729 
rc
, 
j1
;

731 
ªgEof
 = ++
pP¨£
->
nMem
;

732 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgEof
);

733 
	`VdbeCommít
((
v
, "SELECTÉof flag"));

734 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 
SRT_C‹outöe
, ++
pP¨£
->
nMem
);

735 
addrSñe˘
 = 
	`sqlôe4VdbeCuºítAddr
(
v
)+2;

736 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
addrSñe˘
-1, 
de°
.
iP¨m
);

737 
j1
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 0);

738 
	`VdbeCommít
((
v
, "Jump over SELECT coroutine"));

741 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
pSñe˘
, &
de°
);

742 
	`as£π
–
pP¨£
->
nEº
==0 || 
rc
 );

743 if–
rc
 || 
	`NEVER
(
pP¨£
->
nEº
Ë|| 
db
->
mÆlocFaûed
 ){

744 
ö£π_˛ónup
;

746 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
ªgEof
);

747 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
de°
.
iP¨m
);

748 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_HÆt
, 
SQLITE4_INTERNAL
, 
OE_Ab‹t
);

749 
	`VdbeCommít
((
v
, "End of SELECT coroutine"));

750 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

752 
ªgFromSñe˘
 = 
de°
.
iMem
;

753 
	`as£π
–
pSñe˘
->
pELi°
 );

754 
nCﬁumn
 = 
pSñe˘
->
pELi°
->
nEx¥
;

755 
	`as£π
–
de°
.
nMem
==
nCﬁumn
 );

766 if–
pTriggî


767 || 
	`IsKv°‹e
(
pTab
)

768 || 
	`ªadsTabÀ
(
pP¨£
, 
addrSñe˘
, 
iDb
, 
pTab
)

770 
u£TempTabÀ
 = 1;

773 if–
u£TempTabÀ
 ){

785 
ªgRec
;

786 
ªgTempRowid
;

787 
addrT›
;

788 
addrIf
;

790 
§cTab
 = 
pP¨£
->
nTab
++;

791 
ªgRec
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

792 
ªgTempRowid
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

793 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
§cTab
, 
nCﬁumn
);

794 
addrT›
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
de°
.
iP¨m
);

795 
addrIf
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_If
, 
ªgEof
);

796 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgFromSñe˘
, 
nCﬁumn
, 
ªgRec
);

797 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
§cTab
, 
ªgTempRowid
);

798 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
§cTab
, 
ªgRec
, 
ªgTempRowid
);

799 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrT›
);

800 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrIf
);

801 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgRec
);

802 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgTempRowid
);

808 
NameC⁄ãxt
 
sNC
;

809 
	`mem£t
(&
sNC
, 0, (sNC));

810 
sNC
.
pP¨£
 =ÖParse;

811 
§cTab
 = -1;

812 
	`as£π
–
u£TempTabÀ
==0 );

813 
nCﬁumn
 = 
pLi°
 ?ÖLi°->
nEx¥
 : 0;

814 
i
=0; i<
nCﬁumn
; i++){

815 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pLi°
->
a
[
i
].
pEx¥
) ){

816 
ö£π_˛ónup
;

824 if–
	`IsVútuÆ
(
pTab
) ){

825 
i
=0; i<
pTab
->
nCﬁ
; i++){

826 
nHiddí
 +(
	`IsHiddíCﬁumn
(&
pTab
->
aCﬁ
[
i
]) ? 1 : 0);

829 if–
pCﬁumn
==0 && 
nCﬁumn
 &&ÇCﬁumn!=(
pTab
->
nCﬁ
-
nHiddí
) ){

830 
	`sqlôe4Eº‹Msg
(
pP¨£
,

832 
pTabLi°
, 0, 
pTab
->
nCﬁ
-
nHiddí
, 
nCﬁumn
);

833 
ö£π_˛ónup
;

835 if–
pCﬁumn
!=0 && 
nCﬁumn
!ıCﬁumn->
nId
 ){

836 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%d vÆue†f‹ %d cﬁumns", 
nCﬁumn
, 
pCﬁumn
->
nId
);

837 
ö£π_˛ónup
;

845 if–
pCﬁumn
 ){

846 
i
=0; i<
pCﬁumn
->
nId
; i++){

847 
pCﬁumn
->
a
[
i
].
idx
 = -1;

849 
i
=0; i<
pCﬁumn
->
nId
; i++){

850 *
zTe°
 = 
pCﬁumn
->
a
[
i
].
zName
;

851 
j
=0; j<
pTab
->
nCﬁ
; j++){

852 if–
	`sqlôe4_°ricmp
(
zTe°
, 
pTab
->
aCﬁ
[
j
].
zName
)==0 ){

853 
pCﬁumn
->
a
[
i
].
idx
 = 
j
;

857 if–
j
==
pTab
->
nCﬁ
 ){

858 
	`sqlôe4Eº‹Msg
(
pP¨£
, "table %S hasÇo columnÇamed %s",

859 
pTabLi°
, 0, 
pCﬁumn
->
a
[
i
].
zName
);

860 
pP¨£
->
checkSchema
 = 1;

861 
ö£π_˛ónup
;

874 if–!
isVõw
 ){

875 
nIdx
;

877 
ba£Cur
 = 
pP¨£
->
nTab
;

878 
nIdx
 = 
	`sqlôe4O≥nAŒIndexes
(
pP¨£
, 
pTab
, 
ba£Cur
, 
OP_O≥nWrôe
);

879 
aRegIdx
 = 
	`sqlôe4DbMÆlocRaw
(
db
, ()*(
nIdx
+1));

880 if–
aRegIdx
==0 ){

881 
ö£π_˛ónup
;

883 
i
=0; i<
nIdx
; i++){

884 
aRegIdx
[
i
] = ++
pP¨£
->
nMem
;

885 
pP¨£
->
nMem
++;

890 if–
u£TempTabÀ
 ){

900 
addrInsT›
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rewöd
, 
§cTab
);

901 
addrC⁄t
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

902 }if–
pSñe˘
 ){

912 
addrC⁄t
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
de°
.
iP¨m
);

913 
addrInsT›
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_If
, 
ªgEof
);

920 
ªgRowid
 = ++
pP¨£
->
nMem
;

921 
ªgC⁄ã¡
 = 
pP¨£
->
nMem
+1;

922 
pP¨£
->
nMem
 +
pTab
->
nCﬁ
;

924 if–
	`IsVútuÆ
(
pTab
) ){

926 
ªgC⁄ã¡
++;

927 
ªgRowid
++;

928 
pP¨£
->
nMem
++;

931 
ídOfLo›
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

933 
i
=0; i<
pTab
->
nCﬁ
; i++){

934 
ªgDe°
 = 
ªgC⁄ã¡
+
i
;

935 
j
 = 
i
;

936 if–
pCﬁumn
 ){

937 
j
=0; j<
pCﬁumn
->
nId
; j++){

938 if–
pCﬁumn
->
a
[
j
].
idx
==
i
 ) ;

942 if–
nCﬁumn
==0 || (
pCﬁumn
 && 
j
>ıCﬁumn->
nId
) ){

943 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pTab
->
aCﬁ
[
i
].
pDÊt
, 
ªgDe°
);

944 }if–
u£TempTabÀ
 ){

945 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
§cTab
, 
j
, 
ªgDe°
);

946 }if–
pSñe˘
 ){

947 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
ªgFromSñe˘
+
j
, 
ªgDe°
);

949 
	`as£π
–
pSñe˘
==0 );

950 
	`sqlôe4Ex¥CodeAndCache
(
pP¨£
, 
pLi°
->
a
[
j
].
pEx¥
, 
ªgDe°
);

954 if–!
isVõw
 ){

955 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Afföôy
, 
ªgC⁄ã¡
, 
pTab
->
nCﬁ
);

956 
	`sqlôe4TabÀAfföôySå
(
v
, 
pTab
);

960 if–
pTriggî
 ){

961 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, -1, 
ªgRowid
);

962 
	`VdbeCommít
((
v
, "new.rowid value for BEFOREÅriggers"));

963 
	`sqlôe4CodeRowTriggî
(

964 
pP¨£
, 
pTriggî
, 
TK_INSERT
, 0, 
TRIGGER_BEFORE
,

965 
pTab
, (
ªgRowid
 -ÖTab->
nCﬁ
 - 1), 
⁄Eº‹
, 
ídOfLo›


969 if–
iI¡PKCﬁ
>=0 ){

970 
ªgDe°
 = 
ªgC⁄ã¡
+
iI¡PKCﬁ
;

971 
a1
;

972 
a1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NŸNuŒ
, 
ªgDe°
);

973 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NewRowid
, 
ba£Cur
, 
ªgDe°
, 
ªgAutoöc
);

974 
	`sqlôe4VdbeJumpHîe
(
v
, 
a1
);

975 
	`autoIncSãp
(
pP¨£
, 
ªgAutoöc
, 
ªgDe°
);

978 if–
bIm∂icôPK
 ){

979 
	`as£π
–!
isVõw
 );

980 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
ba£Cur
+
iPk
, 
ªgRowid
);

983 if–!
isVõw
 ){

984 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


985 if–
	`IsVútuÆ
(
pTab
) ){

986 c⁄° *
pVTab
 = (c⁄° *)
	`sqlôe4GëVTabÀ
(
db
, 
pTab
);

987 
	`sqlôe4VèbMakeWrôabÀ
(
pP¨£
, 
pTab
);

988 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VUpd©e
, 1, 
pTab
->
nCﬁ
+2, 
ªgIns
, 
pVTab
, 
P4_VTAB
);

989 
	`sqlôe4VdbeCh™geP5
(
v
, 
⁄Eº‹
==
OE_DeÁu…
 ? 
OE_Ab‹t
 : onError);

990 
	`sqlôe4MayAb‹t
(
pP¨£
);

996 
isRïœ˚
;

997 
	`sqlôe4Gíî©eC⁄°øötChecks
(
pP¨£
, 
pTab
, 
ba£Cur
,

998 
ªgC⁄ã¡
, 
aRegIdx
, 0, 0, 
⁄Eº‹
, 
ídOfLo›
, &
isRïœ˚


1000 
	`sqlôe4FkCheck
(
pP¨£
, 
pTab
, 0, 
ªgC⁄ã¡
);

1001 
	`sqlôe4Com∂ëeIn£πi⁄
(
pP¨£
, 
pTab
, 
ba£Cur
,

1002 
ªgC⁄ã¡
, 
aRegIdx
, 0, 
≠≥ndFœg
, 
isRïœ˚
==0

1008 
	`sqlôe4CodeRowTriggî
(

1009 
pP¨£
, 
pTriggî
, 
TK_INSERT
, 0, 
TRIGGER_AFTER
,

1010 
pTab
, 
ªgRowid
 -ÖTab->
nCﬁ
 - 1, 
⁄Eº‹
, 
ídOfLo›


1016 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
ídOfLo›
);

1017 if–
u£TempTabÀ
 ){

1018 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
§cTab
, 
addrC⁄t
);

1019 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrInsT›
);

1020 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
§cTab
);

1021 }if–
pSñe˘
 ){

1022 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrC⁄t
);

1023 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrInsT›
);

1026 if–!
	`IsVútuÆ
(
pTab
Ë&& !
isVõw
 ){

1028 
idx
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, idx++){

1029 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
idx
+
ba£Cur
);

1037 if–
pP¨£
->
√°ed
==0 &&ÖP¨£->
pTriggîTab
==0 ){

1038 
	`sqlôe4Autoö¸emítEnd
(
pP¨£
);

1041 
ö£π_˛ónup
:

1042 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pTabLi°
);

1043 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

1044 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

1045 
	`sqlôe4IdLi°Dñëe
(
db
, 
pCﬁumn
);

1046 
	`sqlôe4DbFªe
(
db
, 
aRegIdx
);

1047 
	}
}

1052 #ifde‡
isVõw


1053 #unde‡
isVõw


1055 #ifde‡
pTriggî


1056 #unde‡
pTriggî


1058 #ifde‡
tmask


1059 #unde‡
tmask


1065 c⁄° *
	$ödexCﬁumnName
(
Index
 *
pIdx
, 
iCﬁ
){

1066 
iTbl
 = 
pIdx
->
aiCﬁumn
[
iCﬁ
];

1067 
	`as£π
–
iTbl
>=-1 && iTbl<
pIdx
->
pTabÀ
->
nCﬁ
 );

1068 if–
iTbl
<0 ){

1069 
	`as£π
–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 &&ÖIdx->
nCﬁumn
==1 );

1072  
pIdx
->
pTabÀ
->
aCﬁ
[
iTbl
].
zName
;

1073 
	}
}

1075 
	$gíî©eNŸNuŒChecks
(

1076 
P¨£
 *
pP¨£
,

1077 
TabÀ
 *
pTab
,

1078 
ªgC⁄ã¡
,

1079 
ovîrideEº‹
,

1080 
ign‹eDe°


1082 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1083 
i
;

1085 
i
=0; i<
pTab
->
nCﬁ
; i++){

1086 
⁄Eº‹
 = 
pTab
->
aCﬁ
[
i
].
nŸNuŒ
;

1087 if–
⁄Eº‹
 ){

1088 if–
ovîrideEº‹
!=
OE_DeÁu…
 ){

1089 
⁄Eº‹
 = 
ovîrideEº‹
;

1090 }if–
⁄Eº‹
==
OE_DeÁu…
 ){

1091 
⁄Eº‹
 = 
OE_Ab‹t
;

1093 if–
⁄Eº‹
==
OE_Rïœ˚
 && 
pTab
->
aCﬁ
[
i
].
pDÊt
==0 ){

1094 
⁄Eº‹
 = 
OE_Ab‹t
;

1097  
⁄Eº‹
 ){

1098 
OE_Ab‹t
:

1099 
	`sqlôe4MayAb‹t
(
pP¨£
);

1100 
OE_Rﬁlback
:

1101 
OE_Faû
: {

1102 *
zMsg
 = 
	`sqlôe4MPrötf
(
pP¨£
->
db
, "%s.%s mayÇot be NULL",

1103 
pTab
->
zName
,ÖTab->
aCﬁ
[
i
].zName

1105 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_HÆtIfNuŒ
,

1106 
SQLITE4_CONSTRAINT
, 
⁄Eº‹
, 
ªgC⁄ã¡
+
i
, 
zMsg
, 
P4_DYNAMIC


1111 
OE_Ign‹e
:

1112 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
ªgC⁄ã¡
+
i
, 
ign‹eDe°
);

1116 
j1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NŸNuŒ
, 
ªgC⁄ã¡
+
i
);

1117 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pTab
->
aCﬁ
[
i
].
pDÊt
, 
ªgC⁄ã¡
+i);

1118 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

1119 
	`as£π
–
⁄Eº‹
==
OE_Rïœ˚
 );

1125 
	}
}

1127 #i‚de‡
SQLITE4_OMIT_CHECK


1128 
	$gíî©eCheckChecks
(

1129 
P¨£
 *
pP¨£
,

1130 
TabÀ
 *
pTab
,

1131 
ªgC⁄ã¡
,

1132 
ovîrideEº‹
,

1133 
ign‹eDe°


1135 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1137 if–
pTab
->
pCheck
 && (
pP¨£
->
db
->
Êags
 & 
SQLITE4_Ign‹eChecks
)==0 ){

1138 
⁄Eº‹
;

1139 
ÆlOk
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1140 
pP¨£
->
ckBa£
 = 
ªgC⁄ã¡
;

1141 
	`sqlôe4Ex¥IfTrue
(
pP¨£
, 
pTab
->
pCheck
, 
ÆlOk
, 
SQLITE4_JUMPIFNULL
);

1142 
⁄Eº‹
 = 
ovîrideEº‹
!=
OE_DeÁu…
 ? ovîrideEº‹ : 
OE_Ab‹t
;

1143 if–
⁄Eº‹
==
OE_Ign‹e
 ){

1144 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
ign‹eDe°
);

1146 if–
⁄Eº‹
==
OE_Rïœ˚
 ) onEº‹ = 
OE_Ab‹t
;

1147 
	`sqlôe4HÆtC⁄°øöt
(
pP¨£
, 
⁄Eº‹
, 0, 0);

1149 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
ÆlOk
);

1151 
	}
}

1153 
	#gíî©eCheckChecks
(
a
,
b
,
c
,
d
,
e
)

	)

1159 
Index
 *
	$sqlôe4FödPrim¨yKey
(

1160 
TabÀ
 *
pTab
,

1161 *
piPk


1163 
Index
 *
p
;

1164 
iPk
 = 0;

1165 
iPkroŸ
 = 0;

1166 
p
=
pTab
->
pIndex
;Ö &&Ö->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
;Öı->
pNext
){

1167 
iPk
++;

1169 if–
piPk
 ) {

1170 *
piPk
 = 
iPk
;

1172 
iPkroŸ
 = 
pTab
->
äum
;

1173 
	`as£π
–
iPkroŸ
>0 );

1175  
p
;

1176 
	}
}

1185 *
	$nŸUniqueMesßge
(

1186 
P¨£
 *
pP¨£
,

1187 
Index
 *
pIdx


1189 c⁄° 
nCﬁ
 = 
pIdx
->
nCﬁumn
;

1190 
SåAccum
 
îrMsg
;

1191 
iCﬁ
;

1193 
	`sqlôe4SåAccumInô
(&
îrMsg
, 0, 0, 200);

1194 
îrMsg
.
db
 = 
pP¨£
->db;

1195 
îrMsg
.
pEnv
 =ÉºMsg.
db
->pEnv;

1196 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

1197 
	`sqlôe4SåAccumAµíd
(&
îrMsg
, "PRIMARY KEY must be unique", -1);

1199 
	`sqlôe4SåAccumAµíd
(&
îrMsg
, (
nCﬁ
>1 ? "columns " : "column "), -1);

1200 
iCﬁ
=0; iCﬁ<
pIdx
->
nCﬁumn
; iCol++){

1201 c⁄° *
zCﬁ
 = 
	`ödexCﬁumnName
(
pIdx
, 
iCﬁ
);

1202 
	`sqlôe4SåAccumAµíd
(&
îrMsg
, (
iCﬁ
==0 ? "" : ", "), -1);

1203 
	`sqlôe4SåAccumAµíd
(&
îrMsg
, 
zCﬁ
, -1);

1205 
	`sqlôe4SåAccumAµíd
(&
îrMsg
, (
nCﬁ
>1 ? "áre" : " is"), -1);

1206 
	`sqlôe4SåAccumAµíd
(&
îrMsg
, "Çot unique", -1);

1208  
	`sqlôe4SåAccumFöish
(&
îrMsg
);

1209 
	}
}

1326 
	$sqlôe4Gíî©eC⁄°øötChecks
(

1327 
P¨£
 *
pP¨£
,

1328 
TabÀ
 *
pTab
,

1329 
ba£Cur
,

1330 
ªgC⁄ã¡
,

1331 *
aRegIdx
,

1332 
ªgOldKey
,

1333 
isUpd©e
,

1334 
ovîrideEº‹
,

1335 
ign‹eDe°
,

1336 *
pbMayRïœ˚


1338 
u8
 
aPkRoŸ
[10];

1339 
nPkRoŸ
;

1340 
Index
 *
pPk
;

1341 
i
;

1342 
Vdbe
 *
v
;

1343 
⁄Eº‹
;

1344 
iCur
;

1345 
Index
 *
pIdx
;

1346 
£íRïœ˚
 = 0;

1348 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1349 
	`as£π
–
v
!=0 );

1350 
	`as£π
–
pTab
->
pSñe˘
==0 );

1351 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

1352 
nPkRoŸ
 = 
	`sqlôe4PutV¨öt64
(
aPkRoŸ
, 
pPk
->
äum
);

1354 
	`as£π
–
pPk
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 );

1357 
	`gíî©eNŸNuŒChecks
(
pP¨£
, 
pTab
, 
ªgC⁄ã¡
, 
ovîrideEº‹
, 
ign‹eDe°
);

1360 
	`gíî©eCheckChecks
(
pP¨£
, 
pTab
, 
ªgC⁄ã¡
, 
ovîrideEº‹
, 
ign‹eDe°
);

1366 
iCur
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, iCur++){

1367 
nTmpReg
;

1368 
ªgTmp
;

1369 
ªgPk
;

1370 
ªgKey
 = 
aRegIdx
[
iCur
];

1371 
iIdx
 = 
ba£Cur
+
iCur
;

1374 if–
ªgKey
==0 ) ;

1379 if–
pIdx
->
äum
==
KVSTORE_ROOT
 ){

1382 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
ªgC⁄ã¡
, 
ªgKey
);

1383 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_ToBlob
, 
ªgKey
);

1384 
ªgPk
 = 
ªgKey
;

1386 
nTmpReg
 = 1 + 
pIdx
->
nCﬁumn
 + (pIdx==
pPk
 ? 0 :ÖPk->nColumn);

1387 
ªgTmp
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nTmpReg
);

1388 
ªgPk
 = 
ªgTmp
 + 
nTmpReg
 - 1;

1390 
i
=0; i<
pIdx
->
nCﬁumn
; i++){

1391 
idx
 = 
pIdx
->
aiCﬁumn
[
i
];

1392 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
ªgC⁄ã¡
+
idx
, 
ªgTmp
+
i
);

1394 if–
pIdx
!=
pPk
 ){

1395 
i
=0; i<
pPk
->
nCﬁumn
; i++){

1396 
idx
 = 
pPk
->
aiCﬁumn
[
i
];

1397 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
ªgC⁄ã¡
+
idx
,
ªgTmp
+
i
+
pIdx
->
nCﬁumn
);

1400 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgTmp
, 
nTmpReg
-1, 
ªgKey
, 
iIdx
);

1402 
	`VdbeCommít
((
v
, "key f‹ %s", 
pIdx
->
zName
));

1408 
⁄Eº‹
 = 
pIdx
->onError;

1409 if–
⁄Eº‹
!=
OE_N⁄e
 ){

1410 
iLabñ
;

1416 if–
ovîrideEº‹
!=
OE_DeÁu…
 ){

1417 
⁄Eº‹
 = 
ovîrideEº‹
;

1418 }if–
⁄Eº‹
==
OE_DeÁu…
 ){

1419 
⁄Eº‹
 = 
OE_Ab‹t
;

1421 if–
£íRïœ˚
 ){

1422 if–
⁄Eº‹
==
OE_Ign‹e
 ) onEº‹ = 
OE_Rïœ˚
;

1423 if–
⁄Eº‹
==
OE_Faû
 ) onEº‹ = 
OE_Ab‹t
;

1426 
iLabñ
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1427 if–
pIdx
!=
pPk
 ){

1428 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_IsNuŒ
, 
ªgTmp
, 
iLabñ
, 
pIdx
->
nCﬁumn
);

1429 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Blob
, 
nPkRoŸ
, 
ªgPk
, 0,(*)
aPkRoŸ
,nPkRoot);

1431 if–
ªgOldKey
 && 
pIdx
==
pPk
 ){

1432 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Eq
, 
ªgOldKey
, 
iLabñ
, 
ªgKey
);

1434 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_IsUnique
, 
iIdx
, 
iLabñ
, 
ªgKey
, 
ªgPk
);

1435 if–
ªgOldKey
 && 
pIdx
!=
pPk
 ){

1436 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Eq
, 
ªgOldKey
, 
iLabñ
, 
ªgPk
);

1439  
⁄Eº‹
 ){

1440 
OE_Rﬁlback
:

1441 
OE_Ab‹t
:

1442 
OE_Faû
: {

1443 *
zEº
 = 
	`nŸUniqueMesßge
(
pP¨£
, 
pIdx
);

1444 
	`sqlôe4HÆtC⁄°øöt
(
pP¨£
, 
⁄Eº‹
, 
zEº
, 0);

1445 
	`sqlôe4DbFªe
(
pP¨£
->
db
, 
zEº
);

1449 
OE_Ign‹e
: {

1450 
	`as£π
–
£íRïœ˚
==0 );

1451 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
ign‹eDe°
);

1455 
Triggî
 *
pTriggî
;

1456 
	`as£π
–
⁄Eº‹
==
OE_Rïœ˚
 );

1457 
	`sqlôe4Mu…iWrôe
(
pP¨£
);

1458 
pTriggî
 = 
	`sqlôe4TriggîsExi°
(
pP¨£
, 
pTab
, 
TK_DELETE
, 0, 0);

1459 
	`sqlôe4Gíî©eRowDñëe
(

1460 
pP¨£
, 
pTab
, 
ba£Cur
, 
ªgPk
, 0, 
pTriggî
, 
OE_Rïœ˚


1462 
£íRïœ˚
 = 1;

1467 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iLabñ
);

1470 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgTmp
, 
nTmpReg
);

1473 if–
pbMayRïœ˚
 ){

1474 *
pbMayRïœ˚
 = 
£íRïœ˚
;

1476 
	}
}

1495 
	$sqlôe4Com∂ëeIn£πi⁄
(

1496 
P¨£
 *
pP¨£
,

1497 
TabÀ
 *
pTab
,

1498 
ba£Cur
,

1499 
ªgC⁄ã¡
,

1500 *
aRegIdx
,

1501 
isUpd©e
,

1502 
≠≥ndBüs
,

1503 
u£SìkResu…


1505 
i
;

1506 
Vdbe
 *
v
;

1507 
Index
 *
pIdx
;

1508 
u8
 
pik_Êags
;

1509 
ªgRec
;

1510 
ªgCovî
;

1512 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1513 
	`as£π
–
v
!=0 );

1514 
	`as£π
–
pTab
->
pSñe˘
==0 );

1516 if–
pP¨£
->
√°ed
 ){

1517 
pik_Êags
 = 0;

1519 
pik_Êags
 = 
OPFLAG_NCHANGE
 | (
isUpd©e
?
OPFLAG_ISUPDATE
:0);

1527 
ªgRec
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1528 if–
	`IsKv°‹e
(
pTab
) ){

1529 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
ªgC⁄ã¡
+1, 
ªgRec
);

1530 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_ToBlob
, 
ªgRec
);

1532 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgC⁄ã¡
, 
pTab
->
nCﬁ
, 
ªgRec
);

1533 
	`sqlôe4TabÀAfföôySå
(
v
, 
pTab
);

1534 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
ªgC⁄ã¡
, 
pTab
->
nCﬁ
);

1536 
ªgCovî
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1539 
i
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx; i++,ÖIdxıIdx->
pNext
){

1540 
	`as£π
–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 || 
aRegIdx
[
i
] );

1541 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
 ){

1542 
iPK
;

1543 
	`sqlôe4FödPrim¨yKey
(
pTab
, &
iPK
);

1544 
	`sqlôe4Fts5CodeUpd©e
(
pP¨£
, 
pIdx
, 0, 
aRegIdx
[
iPK
], 
ªgC⁄ã¡
, 0);

1546 if–
aRegIdx
[
i
] ){

1547 
ªgD©a
 = 0;

1548 
Êags
 = 0;

1549 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

1550 
ªgD©a
 = 
ªgRec
;

1551 
Êags
 = 
pik_Êags
;

1552 }if–
pIdx
->
nCovî
>0 ){

1553 
nByã
 = ()*
pIdx
->
nCovî
;

1554 *
aiPîmuã
 = (*)
	`sqlôe4DbMÆlocRaw
(
pP¨£
->
db
, 
nByã
);

1556 if–
aiPîmuã
 ){

1557 
	`mem˝y
(
aiPîmuã
, 
pIdx
->
aiCovî
, 
nByã
);

1558 
	`sqlôe4VdbeAddOp4
(

1559 
v
, 
OP_Pîmuèti⁄
, 
pIdx
->
nCovî
, 0, 0,

1560 (*)
aiPîmuã
, 
P4_INTARRAY


1563 
ªgD©a
 = 
ªgCovî
;

1564 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgC⁄ã¡
, 
pIdx
->
nCovî
, 
ªgD©a
);

1566 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
ba£Cur
+
i
, 
ªgD©a
, 
aRegIdx
[i]);

1567 
	`sqlôe4VdbeCh™geP5
(
v
, 
Êags
);

1570 
	}
}

1579 
	$sqlôe4O≥nAŒIndexes
(

1580 
P¨£
 *
pP¨£
,

1581 
TabÀ
 *
pTab
,

1582 
ba£Cur
,

1583 
›


1585 
i
 = 0;

1586 if–
	`IsVútuÆ
(
pTab
)==0 ){

1587 
iDb
;

1588 
Index
 *
pIdx
;

1590 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

1591 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

1592 
	`sqlôe4O≥nIndex
(
pP¨£
, 
ba£Cur
+
i
, 
iDb
, 
pIdx
, 
›
);

1593 
i
++;

1595 if–
pP¨£
->
nTab
<
ba£Cur
+
i
 ){

1596 
pP¨£
->
nTab
 = 
ba£Cur
+
i
;

1599  
i
;

1600 
	}
}

1602 
	$sqlôe4Clo£AŒIndexes
(

1603 
P¨£
 *
pP¨£
,

1604 
TabÀ
 *
pTab
,

1605 
ba£Cur


1607 
i
;

1608 
Index
 *
pIdx
;

1609 
Vdbe
 *
v
;

1611 
	`as£π
–
pTab
->
pIndex
==0 || 
	`IsVútuÆ
(pTab)==0 );

1612 
	`as£π
–
pTab
->
pIndex
==0 || 
	`IsVõw
(pTab)==0 );

1614 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1615 
i
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, i++){

1616 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
ba£Cur
+
i
);

1618 
	}
}

1621 #ifde‡
SQLITE4_TEST


1628 
	gsqlôe4_x„r›t_cou¡
;

	@src/kv.c

18 
	~"sqlôeI¡.h
"

23 c⁄° *
	$kvEºName
(
e
){

24 c⁄° *
zName
;

25  
e
 ){

26 
SQLITE4_OK
: 
zName
 = "OK"; ;

27 
SQLITE4_ERROR
: 
zName
 = "ERROR"; ;

28 
SQLITE4_INTERNAL
: 
zName
 = "INTERNAL"; ;

29 
SQLITE4_PERM
: 
zName
 = "PERM"; ;

30 
SQLITE4_ABORT
: 
zName
 = "ABORT"; ;

31 
SQLITE4_BUSY
: 
zName
 = "BUSY"; ;

32 
SQLITE4_LOCKED
: 
zName
 = "LOCKED"; ;

33 
SQLITE4_NOMEM
: 
zName
 = "NOMEM"; ;

34 
SQLITE4_READONLY
: 
zName
 = "READONLY"; ;

35 
SQLITE4_INTERRUPT
: 
zName
 = "INTERRUPT"; ;

36 
SQLITE4_IOERR
: 
zName
 = "IOERR"; ;

37 
SQLITE4_CORRUPT
: 
zName
 = "CORRUPT"; ;

38 
SQLITE4_NOTFOUND
: 
zName
 = "NOTFOUND"; ;

39 
SQLITE4_FULL
: 
zName
 = "FULL"; ;

40 
SQLITE4_CANTOPEN
: 
zName
 = "CANTOPEN"; ;

41 
SQLITE4_PROTOCOL
: 
zName
 = "PROTOCOL"; ;

42 
SQLITE4_EMPTY
: 
zName
 = "EMPTY"; ;

43 
SQLITE4_SCHEMA
: 
zName
 = "SCHEMA"; ;

44 
SQLITE4_TOOBIG
: 
zName
 = "TOOBIG"; ;

45 
SQLITE4_CONSTRAINT
: 
zName
 = "CONSTRAINT"; ;

46 
SQLITE4_MISMATCH
: 
zName
 = "MISMATCH"; ;

47 
SQLITE4_MISUSE
: 
zName
 = "MISUSE"; ;

48 
SQLITE4_NOLFS
: 
zName
 = "NOLFS"; ;

49 
SQLITE4_AUTH
: 
zName
 = "AUTH"; ;

50 
SQLITE4_FORMAT
: 
zName
 = "FORMAT"; ;

51 
SQLITE4_RANGE
: 
zName
 = "RANGE"; ;

52 
SQLITE4_NOTADB
: 
zName
 = "NOTADB"; ;

53 
SQLITE4_ROW
: 
zName
 = "ROW"; ;

54 
SQLITE4_DONE
: 
zName
 = "DONE"; ;

55 
SQLITE4_INEXACT
: 
zName
 = "INEXACT"; ;

56 : 
zName
 = "???"; ;

58  
zName
;

59 
	}
}

64 
	$kvTø˚
(
KVSt‹e
 *
p
, c⁄° *
zF‹m©
, ...){

65 if–
p
->
fTø˚
 ){

66 
va_li°
 
≠
;

67 *
z
;

69 
	`va_°¨t
(
≠
, 
zF‹m©
);

70 
z
 = 
	`sqlôe4_vm¥ötf
(
p
->
pEnv
, 
zF‹m©
, 
≠
);

71 
	`va_íd
(
≠
);

72 
	`¥ötf
("%s.%s\n", 
p
->
zKVName
, 
z
);

73 
	`fÊush
(
°dout
);

74 
	`sqlôe4_‰ì
(
p
->
pEnv
, 
z
);

76 
	}
}

81 
	$sqlôe4KVSt‹eO≥n
(

82 
sqlôe4
 *
db
,

83 c⁄° *
zName
,

84 c⁄° *
zUri
,

85 
KVSt‹e
 **
µKVSt‹e
,

86 
Êags


88 
KVSt‹e
 *
pNew
 = 0;

89 
rc
;

90 
sqlôe4_ív
 *
pEnv
 = &
sqlôe4DeÁu…Env
;

91 c⁄° *
zSt‹ageName
;

92 
KVFa˘‹y
 *
pMkr
;

93 
sqlôe4_kvÁ˘‹y
 
xFa˘‹y
;

95 if–(
Êags
 & 
SQLITE4_KVOPEN_TEMPORARY
)!=0 || 
zUri
==0 || zUri[0]==0 ){

96 
zSt‹ageName
 = "temp";

98 
zSt‹ageName
 = 
	`sqlôe4_uri_∑ømëî
(
zUri
, "kv");

99 if–
zSt‹ageName
==0 ){

100 if–
	`memcmp
(":mem‹y:", 
zUri
, 8)==0 ){

101 
zSt‹ageName
 = "temp";

103 
zSt‹ageName
 = "main";

107 *
µKVSt‹e
 = 0;

108 
	`sqlôe4_muãx_íãr
(
pEnv
->
pFa˘‹yMuãx
);

109 
pMkr
=
pEnv
->
pFa˘‹y
;ÖMk∏&& 
	`°rcmp
(
zSt‹ageName
,pMkr->
zName
);

110 
pMkr
ıMkr->
pNext
){}

111 
xFa˘‹y
 = 
pMkr
 ?ÖMkr->xFactory : 0;

112 
	`sqlôe4_muãx_Àave
(
pEnv
->
pFa˘‹yMuãx
);

113 if–
xFa˘‹y
==0 ){

114  
SQLITE4_ERROR
;

116 
rc
 = 
	`xFa˘‹y
(
pEnv
, &
pNew
, 
zUri
, 
Êags
);

117 *
µKVSt‹e
 = 
pNew
;

118 if–
pNew
 ){

119 
	`sqlôe4_øndom√ss
(
pEnv
, (
pNew
->
kvId
), &pNew->kvId);

120 
	`sqlôe4_¢¥ötf
(
pNew
->
zKVName
, (pNew->zKVName),

121 "%s", 
zName
);

122 
pNew
->
fTø˚
 = (
db
->
Êags
 & 
SQLITE4_KvTø˚
)!=0;

123 
	`kvTø˚
(
pNew
, "›í(%s,%d,0x%04x)", 
zUri
,ÖNew->
kvId
, 
Êags
);

125  
rc
;

126 
	}
}

129 
	$böToHex
(*
zOut
, 
mxOut
, c⁄° 
KVByãAºay
 *
a
, 
KVSize
 
n
){

130 
i
;

131 if–
n
>
mxOut
/2-1 )Ç = mxOut/2-1;

132 
i
=0; i<
n
; i++){

133 
zOut
[
i
*2] = "0123456789abcdef"[(
a
[i]>>4)&0xf];

134 
zOut
[
i
*2+1] = "0123456789abcdef"[
a
[i]&0xf];

136 
zOut
[
i
*2] = 0;

137 
	}
}

143 
	$sqlôe4KVSt‹eRïœ˚
(

144 
KVSt‹e
 *
p
,

145 c⁄° 
KVByãAºay
 *
pKey
, 
KVSize
 
nKey
,

146 c⁄° 
KVByãAºay
 *
pD©a
, 
KVSize
 
nD©a


148 if–
p
->
fTø˚
 ){

149 
zKey
[52], 
zD©a
[52];

150 
	`böToHex
(
zKey
, (zKey), 
pKey
, 
nKey
);

151 
	`böToHex
(
zD©a
, (zD©a), 
pD©a
, 
nD©a
);

152 
	`kvTø˚
(
p
, "xReplace(%d,%s,%d,%s,%d)",

153 
p
->
kvId
, 
zKey
, ()
nKey
, 
zD©a
, ()
nD©a
);

155  
p
->
pSt‹eVfunc
->
	`xRïœ˚
’,
pKey
,
nKey
,
pD©a
,
nD©a
);

156 
	}
}

157 
	$sqlôe4KVSt‹eO≥nCurs‹
(
KVSt‹e
 *
p
, 
KVCurs‹
 **
µKVCurs‹
){

158 
KVCurs‹
 *
pCur
;

159 
rc
;

161 
rc
 = 
p
->
pSt‹eVfunc
->
	`xO≥nCurs‹
’, &
pCur
);

162 *
µKVCurs‹
 = 
pCur
;

163 if–
pCur
 ){

164 
	`sqlôe4_øndom√ss
(
pCur
->
pEnv
, ’Cur->
curId
), &pCur->curId);

165 
pCur
->
fTø˚
 = 
p
->fTrace;

166 
pCur
->
pSt‹e
 = 
p
;

168 
	`kvTø˚
(
p
, "xOpenCursor(%d,%d) -> %s",

169 
p
->
kvId
, 
pCur
?pCur->
curId
:-1, 
	`kvEºName
(
rc
));

170  
rc
;

171 
	}
}

172 
	$sqlôe4KVCurs‹Sìk
(

173 
KVCurs‹
 *
p
,

174 c⁄° 
KVByãAºay
 *
pKey
, 
KVSize
 
nKey
,

175 
dú


177 
rc
;

178 
	`as£π
–
dú
==0 || dir==(+1) || dir==(-1) || dir==(-2) );

179 
rc
 = 
p
->
pSt‹eVfunc
->
	`xSìk
’,
pKey
,
nKey
,
dú
);

180 if–
p
->
fTø˚
 ){

181 
zKey
[52];

182 
	`böToHex
(
zKey
, (zKey), 
pKey
, 
nKey
);

183 
	`kvTø˚
(
p
->
pSt‹e
, "xSeek(%d,%s,%d,%d) -> %s",

184 
p
->
curId
, 
zKey
, ()
nKey
, 
dú
, 
	`kvEºName
(
rc
));

186  
rc
;

187 
	}
}

188 
	$sqlôe4KVCurs‹Next
(
KVCurs‹
 *
p
){

189 
rc
;

190 
rc
 = 
p
->
pSt‹eVfunc
->
	`xNext
(p);

191 
	`kvTø˚
(
p
->
pSt‹e
, "xNext(%dË-> %s",Ö->
curId
, 
	`kvEºName
(
rc
));

192  
rc
;

193 
	}
}

194 
	$sqlôe4KVCurs‹Pªv
(
KVCurs‹
 *
p
){

195 
rc
;

196 
rc
 = 
p
->
pSt‹eVfunc
->
	`xPªv
(p);

197 
	`kvTø˚
(
p
->
pSt‹e
, "xPªv(%dË-> %s",Ö->
curId
, 
	`kvEºName
(
rc
));

198  
rc
;

199 
	}
}

200 
	$sqlôe4KVCurs‹Dñëe
(
KVCurs‹
 *
p
){

201 
rc
;

202 
rc
 = 
p
->
pSt‹eVfunc
->
	`xDñëe
(p);

203 
	`kvTø˚
(
p
->
pSt‹e
, "xDñëe(%dË-> %s",Ö->
curId
, 
	`kvEºName
(
rc
));

204  
rc
;

205 
	}
}

206 
	$sqlôe4KVCurs‹Re£t
(
KVCurs‹
 *
p
){

207 
rc
;

208 
rc
 = 
p
->
pSt‹eVfunc
->
	`xRe£t
(p);

209 
	`kvTø˚
(
p
->
pSt‹e
, "xRe£t(%dË-> %s",Ö->
curId
, 
	`kvEºName
(
rc
));

210  
rc
;

211 
	}
}

212 
	$sqlôe4KVCurs‹Key
(
KVCurs‹
 *
p
, c⁄° 
KVByãAºay
 **
µKey
, 
KVSize
 *
≤Key
){

213 
rc
;

214 
rc
 = 
p
->
pSt‹eVfunc
->
	`xKey
’, 
µKey
, 
≤Key
);

215 if–
p
->
fTø˚
 ){

216 if–
rc
==
SQLITE4_OK
 ){

217 
zKey
[52];

218 
	`böToHex
(
zKey
, (zKey), *
µKey
, *
≤Key
);

219 
	`kvTø˚
(
p
->
pSt‹e
, "xKey(%d,%s,%d)",Ö->
curId
, 
zKey
, ()*
≤Key
);

221 
	`kvTø˚
(
p
->
pSt‹e
, "xKey(%d,<îr‹-%d>)",Ö->
curId
, 
rc
);

224  
rc
;

225 
	}
}

226 
	$sqlôe4KVCurs‹D©a
(

227 
KVCurs‹
 *
p
,

228 
KVSize
 
of°
,

229 
KVSize
 
n
,

230 c⁄° 
KVByãAºay
 **
µD©a
,

231 
KVSize
 *
≤D©a


233 
rc
;

234 
rc
 = 
p
->
pSt‹eVfunc
->
	`xD©a
’, 
of°
, 
n
, 
µD©a
, 
≤D©a
);

235 if–
p
->
fTø˚
 ){

236 if–
rc
==
SQLITE4_OK
 ){

237 
zD©a
[52];

238 
	`böToHex
(
zD©a
, (zD©a), *
µD©a
, *
≤D©a
);

239 
	`kvTø˚
(
p
->
pSt‹e
, "xData(%d,%d,%d,%s,%d)",

240 
p
->
curId
, ()
of°
, ()
n
, 
zD©a
, ()*
≤D©a
);

242 
	`kvTø˚
(
p
->
pSt‹e
, "xData(%d,%d,%d,<error-%d>)",

243 
p
->
curId
, ()
of°
, ()
n
, 
rc
);

246  
rc
;

247 
	}
}

248 
	$sqlôe4KVCurs‹Clo£
(
KVCurs‹
 *
p
){

249 
rc
 = 
SQLITE4_OK
;

250 if–
p
 ){

251 
KVSt‹e
 *
pSt‹e
 = 
p
->pStore;

252 
curId
 = 
p
->curId;

253 
rc
 = 
p
->
pSt‹eVfunc
->
	`xClo£Curs‹
(p);

254 
	`kvTø˚
(
pSt‹e
, "xClo£Curs‹(%dË-> %s", 
curId
, 
	`kvEºName
(
rc
));

256  
rc
;

257 
	}
}

258 
	$sqlôe4KVSt‹eBegö
(
KVSt‹e
 *
p
, 
iLevñ
){

259 
rc
;

260 
rc
 = 
p
->
pSt‹eVfunc
->
	`xBegö
’, 
iLevñ
);

261 
	`kvTø˚
(
p
, "xBegö(%d,%dË-> %s",Ö->
kvId
, 
iLevñ
, 
	`kvEºName
(
rc
));

262 
	`as£π
–
p
->
iTønsLevñ
==
iLevñ
 || 
rc
!=
SQLITE4_OK
 );

263  
rc
;

264 
	}
}

265 
	$sqlôe4KVSt‹eCommôPha£O√
(
KVSt‹e
 *
p
, 
iLevñ
){

266 
rc
;

267 
	`as£π
–
iLevñ
>=0 );

268 
	`as£π
–
iLevñ
<=
p
->
iTønsLevñ
 );

269 if–
p
->
iTønsLevñ
==
iLevñ
 )  
SQLITE4_OK
;

270 if–
p
->
pSt‹eVfunc
->
xCommôPha£O√
 ){

271 
rc
 = 
p
->
pSt‹eVfunc
->
	`xCommôPha£O√
’, 
iLevñ
);

273 
rc
 = 
SQLITE4_OK
;

275 
	`kvTø˚
(
p
, "xCommôPha£O√(%d,%dË-> %s",Ö->
kvId
, 
iLevñ
, 
	`kvEºName
(
rc
));

276 
	`as£π
–
p
->
iTønsLevñ
>
iLevñ
 );

277  
rc
;

278 
	}
}

279 
	$sqlôe4KVSt‹eCommôPha£Two
(
KVSt‹e
 *
p
, 
iLevñ
){

280 
rc
;

281 
	`as£π
–
iLevñ
>=0 );

282 
	`as£π
–
iLevñ
<=
p
->
iTønsLevñ
 );

283 if–
p
->
iTønsLevñ
==
iLevñ
 )  
SQLITE4_OK
;

284 
rc
 = 
p
->
pSt‹eVfunc
->
	`xCommôPha£Two
’, 
iLevñ
);

285 
	`kvTø˚
(
p
, "xCommôPha£Two(%d,%dË-> %s",Ö->
kvId
, 
iLevñ
, 
	`kvEºName
(
rc
));

286 
	`as£π
–
p
->
iTønsLevñ
==
iLevñ
 || 
rc
!=
SQLITE4_OK
 );

287  
rc
;

288 
	}
}

289 
	$sqlôe4KVSt‹eCommô
(
KVSt‹e
 *
p
, 
iLevñ
){

290 
rc
;

291 
rc
 = 
	`sqlôe4KVSt‹eCommôPha£O√
(
p
, 
iLevñ
);

292 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4KVSt‹eCommôPha£Two
(
p
, 
iLevñ
);

293  
rc
;

294 
	}
}

295 
	$sqlôe4KVSt‹eRﬁlback
(
KVSt‹e
 *
p
, 
iLevñ
){

296 
rc
;

297 
	`as£π
–
iLevñ
>=0 );

298 
	`as£π
–
iLevñ
<=
p
->
iTønsLevñ
 );

299 
rc
 = 
p
->
pSt‹eVfunc
->
	`xRﬁlback
’, 
iLevñ
);

300 
	`kvTø˚
(
p
, "xRﬁlback(%d,%dË-> %s",Ö->
kvId
, 
iLevñ
, 
	`kvEºName
(
rc
));

301 
	`as£π
–
p
->
iTønsLevñ
==
iLevñ
 || 
rc
!=
SQLITE4_OK
 );

302  
rc
;

303 
	}
}

304 
	$sqlôe4KVSt‹eRevît
(
KVSt‹e
 *
p
, 
iLevñ
){

305 
rc
;

306 
	`as£π
–
iLevñ
>0 );

307 
	`as£π
–
iLevñ
<=
p
->
iTønsLevñ
 );

308 if–
p
->
pSt‹eVfunc
->
xRevît
 ){

309 
rc
 = 
p
->
pSt‹eVfunc
->
	`xRevît
’, 
iLevñ
);

310 
	`kvTø˚
(
p
, "xRevît(%d,%dË-> %s",Ö->
kvId
, 
iLevñ
, 
	`kvEºName
(
rc
));

312 
rc
 = 
	`sqlôe4KVSt‹eRﬁlback
(
p
, 
iLevñ
-1);

313 if–
rc
==
SQLITE4_OK
 ){

314 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
p
, 
iLevñ
);

317 
	`as£π
–
p
->
iTønsLevñ
==
iLevñ
 || 
rc
!=
SQLITE4_OK
 );

318  
rc
;

319 
	}
}

320 
	$sqlôe4KVSt‹eClo£
(
KVSt‹e
 *
p
){

321 
rc
;

322 if–
p
 ){

323 
	`kvTø˚
(
p
, "xClo£(%d)",Ö->
kvId
);

324 
rc
 = 
p
->
pSt‹eVfunc
->
	`xClo£
(p);

326  
rc
;

327 
	}
}

332 c⁄° 
KVByãAºay
 
	gmëad©aKey
[] = { 0x00, 0x00 };

334 
	$wrôeMëaAºay
(
KVByãAºay
 *
aMëa
, 
iEÀm
, 
u32
 
iVÆ
){

335 
i
 = (
u32
Ë* 
iEÀm
;

336 
aMëa
[
i
+0] = (
iVÆ
>>24)&0xff;

337 
aMëa
[
i
+1] = (
iVÆ
>>16)&0xff;

338 
aMëa
[
i
+2] = (
iVÆ
>>8) &0xff;

339 
aMëa
[
i
+3] = (
iVÆ
>>0) &0xff;

340 
	}
}

345 
	$sqlôe4KVSt‹eGëMëa
(
KVSt‹e
 *
p
, 
iSèπ
, 
nMëa
, *
a
){

346 
KVCurs‹
 *
pCur
;

347 
rc
;

348 
i
, 
j
;

349 
KVSize
 
nD©a
;

350 c⁄° 
KVByãAºay
 *
aD©a
;

352 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
p
, &
pCur
);

353 if–
rc
==
SQLITE4_OK
 ){

354 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
mëad©aKey
, (metadataKey), 0);

355 if–
rc
==
SQLITE4_NOTFOUND
 ){

356 
rc
 = 
SQLITE4_OK
;

357 
nD©a
 = 0;

358 }if–
rc
==
SQLITE4_OK
 ){

359 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pCur
, 0, -1, &
aD©a
, &
nD©a
);

361 if–
rc
==
SQLITE4_OK
 ){

362 
i
 = 0;

363 
j
 = 
iSèπ
*4;

364  
i
<
nMëa
 && 
j
+3<
nD©a
 ){

365 
a
[
i
] = (
aD©a
[
j
]<<24) | (aData[j+1]<<16)

366 | (
aD©a
[
j
+2]<<8) |áData[j+3];

367 
i
++;

368 
j
 += 4;

370  
i
<
nMëa
 ) 
a
[i++] = 0;

372 
	`sqlôe4KVCurs‹Clo£
(
pCur
);

374  
rc
;

375 
	}
}

380 
	$sqlôe4KVSt‹ePutSchema
(
KVSt‹e
 *
p
, 
iVÆ
){

381 
	`kvTø˚
(
p
, "xPutMëa(%d,%d)",Ö->
kvId
, ()
iVÆ
);

382  
p
->
pSt‹eVfunc
->
	`xPutMëa
’, 
iVÆ
);

383 
	}
}

388 
	$sqlôe4KVSt‹eGëSchema
(
KVSt‹e
 *
p
, *
piVÆ
){

389 
rc
 = 
p
->
pSt‹eVfunc
->
	`xGëMëa
’, 
piVÆ
);

390 
	`kvTø˚
(
p
, "xGëMëa(%dË-> %d",Ö->
kvId
, ()*
piVÆ
);

391  
rc
;

392 
	}
}

397 
	$sqlôe4KVSt‹ePutMëa
(

398 
sqlôe4
 *
db
,

399 
KVSt‹e
 *
p
,

400 
iSèπ
,

401 
nMëa
,

402 *
a


404 
KVCurs‹
 *
pCur
;

405 
rc
;

408 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
p
, &
pCur
);

409 if–
rc
==
SQLITE4_OK
 ){

410 c⁄° 
KVByãAºay
 *
aD©a
;

411 
KVSize
 
nD©a
;

412 
KVByãAºay
 *
aNew
;

413 
KVSize
 
nNew
;

416 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
mëad©aKey
, (metadataKey), 0);

417 if–
rc
==
SQLITE4_OK
 ){

418 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pCur
, 0, -1, &
aD©a
, &
nD©a
);

419 }if–
rc
==
SQLITE4_NOTFOUND
 ){

420 
nD©a
 = 0;

421 
aD©a
 = 0;

422 
rc
 = 
SQLITE4_OK
;

426 if–
rc
==
SQLITE4_OK
 ){

427 
nNew
 = (
a
[0]Ë* (
iSèπ
+
nMëa
);

428 if–
nNew
<
nD©a
 )ÇNew =ÇData;

429 
aNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
nNew
);

430 if–
aNew
==0 ){

431 
rc
 = 
SQLITE4_NOMEM
;

433 
i
;

434 
	`mem˝y
(
aNew
, 
aD©a
, 
nD©a
);

435 
i
=
iSèπ
; i<iSèπ+
nMëa
; i++){

436 
	`wrôeMëaAºay
(
aNew
, 
i
, 
a
[i]);

438 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(
p
, 
mëad©aKey
, (metadataKey),

439 
aNew
, 
nNew
);

440 
	`sqlôe4DbFªe
(
db
, 
aNew
);

444 
	`sqlôe4KVCurs‹Clo£
(
pCur
);

446  
rc
;

447 
	}
}

449 #i‡
deföed
(
SQLITE4_DEBUG
)

453 
	$ouçutBö¨y
(

454 
KVByãAºay
 c⁄° *
a
,

455 
KVSize
 
n
,

456 c⁄° *
zPªfix


458 
i
;

459 
zOut
[80];

460 c⁄° 
ba£16
[] = "0123456789abcdef";

461 
	`mem£t
(
zOut
, ' ', (zOut));

462 
zOut
[16*3+3+16] = 0;

463  
n
>=0 ){

464 
i
=0; i<16 && i<
n
; i++){

465 
v
 = 
a
[
i
];

466 
zOut
[
i
*3] = 
ba£16
[
v
>>4];

467 
zOut
[
i
*3+1] = 
ba£16
[
v
&0xf];

468 
zOut
[16*3+3+
i
] = (
v
>=0x20 && v<=0x7e) ? v : '.';

470  
i
<16 ){

471 
zOut
[
i
*3] = ' ';

472 
zOut
[
i
*3+1] = ' ';

473 
zOut
[16*3+3+
i
] = ' ';

474 
i
++;

476 
	`sqlôe4DebugPrötf
("%.3†%s\n", 
zPªfix
, 
zOut
);

477 
n
 -= 16;

478 if–
n
<=0 ) ;

479 
a
 += 16;

480 
zPªfix
 = " ";

482 
	}
}

487 
	$sqlôe4KVSt‹eDump
(
KVSt‹e
 *
pSt‹e
){

488 
rc
;

489 
nRow
 = 0;

490 
KVCurs‹
 *
pCur
;

491 
KVSize
 
nKey
, 
nD©a
;

492 
KVByãAºay
 c⁄° *
aKey
;

493 
KVByãAºay
 c⁄° *
aD©a
;

494 c⁄° 
KVByãAºay
 
aProbe
[] = { 0x00 };

496 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pSt‹e
, &
pCur
);

497 if–
rc
==
SQLITE4_OK
 ){

498 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
aProbe
, 1, +1);

499  
rc
!=
SQLITE4_NOTFOUND
 ){

500 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pCur
, &
aKey
, &
nKey
);

501 if–
rc
 ) ;

502 if–
nRow
>0 ) 
	`sqlôe4DebugPrötf
("\n");

503 
nRow
++;

504 
	`ouçutBö¨y
(
aKey
, 
nKey
, "K: ");

505 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pCur
, 0, -1, &
aD©a
, &
nD©a
);

506 if–
rc
 ) ;

507 
	`ouçutBö¨y
(
aD©a
, 
nD©a
, "V: ");

508 
rc
 = 
	`sqlôe4KVCurs‹Next
(
pCur
);

510 
	`sqlôe4KVCurs‹Clo£
(
pCur
);

512 
	}
}

521 
	$sqlôe4KVIn¸blobCurs‹
(
KVCurs‹
 *
pCur
){

522 
pCur
->
pSt‹e
->
hasIn¸blobCur
 = 1;

523 
	}
}

	@src/kv.h

155 
sqlôe4_kv°‹e
 
	tKVSt‹e
;

156 
sqlôe4_kv_mëhods
 
	tKVSt‹eMëhods
;

157 
sqlôe4_kvcurs‹
 
	tKVCurs‹
;

158 
	tKVByãAºay
;

159 
sqlôe4_kvsize
 
	tKVSize
;

161 
sqlôe4O≥nBåì
(
sqlôe4_ív
*, 
KVSt‹e
**, const *, );

162 
sqlôe4KVSt‹eO≥nMem
(
sqlôe4_ív
*, 
KVSt‹e
**, const *, );

163 
sqlôe4KVSt‹eO≥nLsm
(
sqlôe4_ív
*, 
KVSt‹e
**, const *, );

164 
sqlôe4KVSt‹eO≥n
(

165 
sqlôe4
*,

166 c⁄° *
zLabñ
,

167 c⁄° *
zUri
,

168 
KVSt‹e
**,

169 
Êags


171 
sqlôe4KVSt‹eRïœ˚
(

172 
KVSt‹e
*,

173 c⁄° 
KVByãAºay
 *
pKey
, 
KVSize
 
nKey
,

174 c⁄° 
KVByãAºay
 *
pD©a
, 
KVSize
 
nD©a


176 
sqlôe4KVSt‹eO≥nCurs‹
(
KVSt‹e
 *
p
, 
KVCurs‹
 **
µKVCurs‹
);

177 
sqlôe4KVCurs‹Sìk
(

178 
KVCurs‹
 *
p
,

179 c⁄° 
KVByãAºay
 *
pKey
, 
KVSize
 
nKey
,

180 
dú


182 
sqlôe4KVCurs‹Next
(
KVCurs‹
 *
p
);

183 
sqlôe4KVCurs‹Pªv
(
KVCurs‹
 *
p
);

184 
sqlôe4KVCurs‹Dñëe
(
KVCurs‹
 *
p
);

185 
sqlôe4KVCurs‹Re£t
(
KVCurs‹
 *
p
);

186 
sqlôe4KVCurs‹Key
(
KVCurs‹
 *
p
, c⁄° 
KVByãAºay
 **
µKey
, 
KVSize
 *
≤Key
);

187 
sqlôe4KVCurs‹D©a
(

188 
KVCurs‹
 *
p
,

189 
KVSize
 
of°
,

190 
KVSize
 
n
,

191 c⁄° 
KVByãAºay
 **
µD©a
,

192 
KVSize
 *
≤D©a


194 
sqlôe4KVCurs‹Clo£
(
KVCurs‹
 *
p
);

195 
sqlôe4KVSt‹eBegö
(
KVSt‹e
 *
p
, 
iLevñ
);

196 
sqlôe4KVSt‹eCommôPha£O√
(
KVSt‹e
 *
p
, 
iLevñ
);

197 
sqlôe4KVSt‹eCommôPha£Two
(
KVSt‹e
 *
p
, 
iLevñ
);

198 
sqlôe4KVSt‹eCommô
(
KVSt‹e
 *
p
, 
iLevñ
);

199 
sqlôe4KVSt‹eRﬁlback
(
KVSt‹e
 *
p
, 
iLevñ
);

200 
sqlôe4KVSt‹eRevît
(
KVSt‹e
 *
p
, 
iLevñ
);

201 
sqlôe4KVSt‹eClo£
(
KVSt‹e
 *
p
);

203 
sqlôe4KVSt‹eGëMëa
(
KVSt‹e
 *
p
, , , *);

204 
sqlôe4KVSt‹ePutMëa
(
sqlôe4
*, 
KVSt‹e
 *
p
, , , *);

206 
sqlôe4KVSt‹ePutSchema
(
KVSt‹e
 *
p
, 
iVÆ
);

207 
sqlôe4KVSt‹eGëSchema
(
KVSt‹e
 *
p
, *
piVÆ
);

209 #ifde‡
SQLITE4_DEBUG


210 
sqlôe4KVSt‹eDump
(
KVSt‹e
 *
p
);

214 
sqlôe4KVIn¸blobCurs‹
(
KVCurs‹
 *
pCur
);

	@src/kvbt.c

17 
	~"sqlôeI¡.h
"

18 
	~"bt.h
"

21 
KVBt
 
	tKVBt
;

22 
KVBtC§
 
	tKVBtC§
;

27 
	sKVBt
 {

28 
KVSt‹e
 
	mba£
;

29 *
	mzFûíame
;

30 
	mbO≥n
;

31 
	m›írc
;

32 
bt_db
 *
	mpDb
;

39 
	sKVBtC§
 {

40 
KVCurs‹
 
	mba£
;

41 
bt_curs‹
 *
	mpC§
;

47 
	$btBegö
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

48 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

49 
rc
;

50 if–
p
->
›írc
 ) Ö->openrc;

51 if–
p
->
bO≥n
==0 ){

52 
p
->
›írc
 = 
rc
 = 
	`sqlôe4BtO≥n
’->
pDb
,Ö->
zFûíame
);

53 if–
rc
!=
SQLITE4_OK
 ){

54  
rc
;

56 
p
->
bO≥n
 = 1;

58 
rc
 = 
	`sqlôe4BtBegö
(
p
->
pDb
, 
iLevñ
);

59 
pKVSt‹e
->
iTønsLevñ
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pDb
);

60  
rc
;

61 
	}
}

66 
	$btCommôPha£O√
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

67  
SQLITE4_OK
;

68 
	}
}

69 
	$btCommôPha£Two
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

70 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

71 
rc
;

72 
	`as£π
–
p
->
bO≥n
==1 );

73 
rc
 = 
	`sqlôe4BtCommô
(
p
->
pDb
, 
iLevñ
);

74 
pKVSt‹e
->
iTønsLevñ
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pDb
);

75  
rc
;

76 
	}
}

81 
	$btRﬁlback
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

82 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

83 
rc
 = 
SQLITE4_OK
;

84 if–
p
->
bO≥n
==1 ){

85 
rc
 = 
	`sqlôe4BtRﬁlback
(
p
->
pDb
, 
iLevñ
);

86 
pKVSt‹e
->
iTønsLevñ
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pDb
);

88  
rc
;

89 
	}
}

95 
	$btRevît
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

96 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

97 
rc
;

98 
rc
 = 
	`sqlôe4BtRevît
(
p
->
pDb
, 
iLevñ
);

99 
pKVSt‹e
->
iTønsLevñ
 = 
	`sqlôe4BtTønß˘i⁄Levñ
(
p
->
pDb
);

100  
rc
;

101 
	}
}

107 
	$btRïœ˚
(

108 
KVSt‹e
 *
pKVSt‹e
,

109 c⁄° 
KVByãAºay
 *
aKey
, 
KVSize
 
nKey
,

110 c⁄° 
KVByãAºay
 *
aD©a
, 
KVSize
 
nD©a


112 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

113 
	`as£π
–
p
->
bO≥n
==1 );

114  
	`sqlôe4BtRïœ˚
(
p
->
pDb
, 
aKey
, 
nKey
, 
aD©a
, 
nD©a
);

115 
	}
}

120 
	$btO≥nCurs‹
(
KVSt‹e
 *
pKVSt‹e
, 
KVCurs‹
 **
µKVCurs‹
){

121 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

122 
rc
 = 
SQLITE4_OK
;

123 
bt_curs‹
 *
pC§
;

124 
KVBtC§
 *
pBtc§
;

126 
	`as£π
–
p
->
bO≥n
==1 );

127 
rc
 = 
	`sqlôe4BtC§O≥n
(
p
->
pDb
, (
KVBtC§
), &
pC§
);

128 if–
rc
!=
SQLITE4_OK
 ){

129 
pBtc§
 = 0;

131 
pBtc§
 = (
KVBtC§
*)
	`sqlôe4BtC§Exåa
(
pC§
);

132 
	`mem£t
(
pBtc§
, 0, (
KVBtC§
));

133 
pBtc§
->
ba£
.
pSt‹e
 = 
pKVSt‹e
;

134 
pBtc§
->
ba£
.
pSt‹eVfunc
 = 
pKVSt‹e
->pStoreVfunc;

135 
pBtc§
->
pC§
 =ÖCsr;

138 *
µKVCurs‹
 = (
KVCurs‹
*)
pBtc§
;

139  
rc
;

140 
	}
}

145 
	$btRe£t
(
KVCurs‹
 *
pKVCurs‹
){

146  
SQLITE4_OK
;

147 
	}
}

152 
	$btClo£Curs‹
(
KVCurs‹
 *
pKVCurs‹
){

153 
KVBtC§
 *
pBtc§
 = (KVBtC§ *)
pKVCurs‹
;

154 
	`sqlôe4BtC§Clo£
(
pBtc§
->
pC§
);

155  
SQLITE4_OK
;

156 
	}
}

161 
	$btNextE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

162 
KVBtC§
 *
pBtc§
 = (KVBtC§ *)
pKVCurs‹
;

163  
	`sqlôe4BtC§Next
(
pBtc§
->
pC§
);

164 
	}
}

169 
	$btPªvE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

170 
KVBtC§
 *
pBtc§
 = (KVBtC§ *)
pKVCurs‹
;

171  
	`sqlôe4BtC§Pªv
(
pBtc§
->
pC§
);

172 
	}
}

177 
	$btSìk
(

178 
KVCurs‹
 *
pKVCurs‹
,

179 c⁄° 
KVByãAºay
 *
aKey
,

180 
KVSize
 
nKey
,

181 
dú


183 
KVBtC§
 *
pC§
 = (KVBtC§ *)
pKVCurs‹
;

185 
	`as£π
–
dú
==0 || dir==1 || dir==-1 || dir==-2 );

186 
	`as£π
–
BT_SEEK_EQ
==0 && 
BT_SEEK_GE
==1 && 
BT_SEEK_LE
==-1 );

187 
	`as£π
–
BT_SEEK_LEFAST
==-2 );

189  
	`sqlôe4BtC§Sìk
(
pC§
->pC§, (*)
aKey
, 
nKey
, 
dú
);

190 
	}
}

200 
	$btDñëe
(
KVCurs‹
 *
pKVCurs‹
){

201 
KVBtC§
 *
pBtc§
 = (KVBtC§ *)
pKVCurs‹
;

202  
	`sqlôe4BtDñëe
(
pBtc§
->
pC§
);

203 
	}
}

208 
	$btKey
(

209 
KVCurs‹
 *
pKVCurs‹
,

210 c⁄° 
KVByãAºay
 **
∑Key
,

211 
KVSize
 *
pN


213 
KVBtC§
 *
pC§
 = (KVBtC§ *)
pKVCurs‹
;

214  
	`sqlôe4BtC§Key
(
pC§
->pC§, (c⁄° **)
∑Key
, (*)
pN
);

215 
	}
}

220 
	$btD©a
(

221 
KVCurs‹
 *
pKVCurs‹
,

222 
KVSize
 
of°
,

223 
KVSize
 
n
,

224 c⁄° 
KVByãAºay
 **
∑D©a
,

225 
KVSize
 *
pN


227 
KVBtC§
 *
pC§
 = (KVBtC§ *)
pKVCurs‹
;

228  
	`sqlôe4BtC§D©a
(
pC§
->pC§, 
of°
, 
n
, (c⁄° **)
∑D©a
, (*)
pN
);

229 
	}
}

234 
	$btClo£
(
KVSt‹e
 *
pKVSt‹e
){

235 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

236 
	`sqlôe4_‰ì
(
pKVSt‹e
->
pEnv
, 
p
->
zFûíame
);

237  
	`sqlôe4BtClo£
(
p
->
pDb
);

238 
	}
}

240 
	$btC⁄åﬁ
(
KVSt‹e
 *
pKVSt‹e
, 
›
, *
pArg
){

241 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

242  
	`sqlôe4BtC⁄åﬁ
(
p
->
pDb
, 
›
, 
pArg
);

243 
	}
}

245 
	$btGëMëa
(
KVSt‹e
 *
pKVSt‹e
, *
piVÆ
){

246 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

247 
	`as£π
–
p
->
bO≥n
==1 );

248  
	`sqlôe4BtGëCookõ
(
p
->
pDb
, 
piVÆ
);

249 
	}
}

251 
	$btPutMëa
(
KVSt‹e
 *
pKVSt‹e
, 
iVÆ
){

252 
KVBt
 *
p
 = (KVBà*)
pKVSt‹e
;

253 
	`as£π
–
p
->
bO≥n
==1 );

254  
	`sqlôe4BtSëCookõ
(
p
->
pDb
, 
iVÆ
);

255 
	}
}

257 
BtPøgmaCtx
 
	tBtPøgmaCtx
;

258 
	sBtPøgmaCtx
 {

259 
sqlôe4_kv°‹e
 *
	mpKVSt‹e
;

260 
	mePøgma
;

266 
	#BTPRAGMA_PAGESZ
 1

	)

267 
	#BTPRAGMA_CHECKPOINT
 2

	)

269 
	$btPøgmaDe°roy
(*
pArg
){

270 
BtPøgmaCtx
 *
p
 = (BtPøgmaCtx*)
pArg
;

271 
	`sqlôe4_‰ì
(
p
->
pKVSt‹e
->
pEnv
,Ö);

272 
	}
}

274 
	$btPøgma
(

275 
sqlôe4_c⁄ãxt
 *
pCtx
,

276 
nVÆ
,

277 
sqlôe4_vÆue
 **
≠VÆ


279 
rc
 = 
SQLITE4_OK
;

280 
BtPøgmaCtx
 *
p
 = (BtPøgmaCtx*)
	`sqlôe4_c⁄ãxt_≠pd©a
(
pCtx
);

281 
bt_db
 *
db
 = ((
KVBt
*)(
p
->
pKVSt‹e
))->
pDb
;

283  
p
->
ePøgma
 ){

284 
BTPRAGMA_PAGESZ
: {

285 
pgsz
 = -1;

286 if–
nVÆ
>0 ){

287 
pgsz
 = 
	`sqlôe4_vÆue_öt
(
≠VÆ
[0]);

289 
	`sqlôe4BtC⁄åﬁ
(
db
, 
BT_CONTROL_PAGESZ
, (*)&
pgsz
);

290 
	`sqlôe4_ªsu…_öt
(
pCtx
, 
pgsz
);

294 
BTPRAGMA_CHECKPOINT
: {

295 
bt_checkpoöt
 
ck±
;

296 
ck±
.
nFømeBuf„r
 = 0;

297 
ck±
.
nCk±
 = 0;

298 
rc
 = 
	`sqlôe4BtC⁄åﬁ
(
db
, 
BT_CONTROL_CHECKPOINT
, (*)&
ck±
);

299 if–
rc
!=
SQLITE4_OK
 ){

300 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

302 
	`sqlôe4_ªsu…_öt
(
pCtx
, 
ck±
.
nCk±
);

308 
	`as£π
( 0 );

310 
	}
}

313 
btGëMëhod
(

314 
sqlôe4_kv°‹e
 *
pKVSt‹e
,

315 c⁄° *
zMëhod
,

316 **
µArg
,

317 (**
pxFunc
)(
sqlôe4_c⁄ãxt
 *, , 
sqlôe4_vÆue
 **),

318 (**
pxDe°roy
)(*)

320 
	sPøgmaMëhod
 {

321 c⁄° *
zPøgma
;

322 
ePøgma
;

323 } 
aPøgma
[] = {

324 { "∑ge_size", 
BTPRAGMA_PAGESZ
 },

325 { "checkpoöt", 
BTPRAGMA_CHECKPOINT
 },

327 
i
;

328 
i
=0; i<
	`AºaySize
(
aPøgma
); i++){

329 if–
	`sqlôe4_°ricmp
(
aPøgma
[
i
].
zPøgma
, 
zMëhod
)==0 ){

330 
BtPøgmaCtx
 *
pCtx
 = 
	`sqlôe4_mÆloc
(
pKVSt‹e
->
pEnv
, (BtPragmaCtx));

331 if–
pCtx
==0 )  
SQLITE4_NOMEM
;

332 
pCtx
->
ePøgma
 = 
aPøgma
[
i
].ePragma;

333 
pCtx
->
pKVSt‹e
 =ÖKVStore;

334 *
µArg
 = (*)
pCtx
;

335 *
pxFunc
 = 
btPøgma
;

336 *
pxDe°roy
 = 
btPøgmaDe°roy
;

337  
SQLITE4_OK
;

340  
SQLITE4_NOTFOUND
;

341 
	}
}

343 
	$sqlôe4O≥nBåì
(

344 
sqlôe4_ív
 *
pEnv
,

345 
sqlôe4_kv°‹e
 **
µKVSt‹e
,

346 c⁄° *
zFûíame
,

347 
Êags


349 c⁄° 
sqlôe4_kv_mëhods
 
bt_mëhods
 = {

351 (
sqlôe4_kv_mëhods
),

352 
btRïœ˚
,

353 
btO≥nCurs‹
,

354 
btSìk
,

355 
btNextE¡ry
,

356 
btPªvE¡ry
,

357 
btDñëe
,

358 
btKey
,

359 
btD©a
,

360 
btRe£t
,

361 
btClo£Curs‹
,

362 
btBegö
,

363 
btCommôPha£O√
,

364 
btCommôPha£Two
,

365 
btRﬁlback
,

367 
btClo£
,

368 
btC⁄åﬁ
,

369 
btGëMëa
,

370 
btPutMëa
,

371 
btGëMëhod


374 
KVBt
 *
pNew
 = 0;

375 
bt_db
 *
pDb
 = 0;

376 
rc
;

378 
rc
 = 
	`sqlôe4BtNew
(
pEnv
, (
KVBt
), &
pDb
);

379 if–
rc
==
SQLITE4_OK
 ){

380 
bt_ív
 *
pBãnv
 = 0;

381 
pNew
 = (
KVBt
*)
	`sqlôe4BtExåa
(
pDb
);

382 
pNew
->
ba£
.
pSt‹eVfunc
 = &
bt_mëhods
;

383 
pNew
->
ba£
.
pEnv
 =ÖEnv;

384 
pNew
->
pDb
 =ÖDb;

385 
	`sqlôe4BtC⁄åﬁ
(
pDb
, 
BT_CONTROL_GETVFS
, (*)&
pBãnv
);

386 
rc
 = 
pBãnv
->
	`xFuŒ∑th
(
pEnv
,ÖBãnv, 
zFûíame
, &
pNew
->zFilename);

389 if–
rc
!=
SQLITE4_OK
 && 
pDb
 ){

390 
	`sqlôe4BtClo£
(
pDb
);

391 
pNew
 = 0;

393 *
µKVSt‹e
 = 
pNew
;

394  
rc
;

395 
	}
}

	@src/kvlsm.c

16 
	~"sqlôeI¡.h
"

17 
	~"lsm.h
"

20 
KVLsm
 
	tKVLsm
;

21 
KVLsmC§
 
	tKVLsmC§
;

26 
	sKVLsm
 {

27 
KVSt‹e
 
	mba£
;

28 
lsm_db
 *
	mpDb
;

29 
lsm_curs‹
 *
	mpC§
;

36 
	sKVLsmC§
 {

37 
KVCurs‹
 
	mba£
;

38 
lsm_curs‹
 *
	mpC§
;

54 
	$kvlsmBegö
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

55 
rc
 = 
SQLITE4_OK
;

56 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

58 
	`as£π
–
iLevñ
>0 );

59 if–
p
->
pC§
==0 ){

60 
rc
 = 
	`lsm_c§_›í
(
p
->
pDb
, &p->
pC§
);

62 if–
rc
==
SQLITE4_OK
 && 
iLevñ
>=2 && iLevñ>=
pKVSt‹e
->
iTønsLevñ
 ){

63 
rc
 = 
	`lsm_begö
(
p
->
pDb
, 
iLevñ
-1);

66 if–
rc
==
SQLITE4_OK
 ){

67 
pKVSt‹e
->
iTønsLevñ
 = 
	`SQLITE4_MAX
(
iLevñ
,ÖKVStore->iTransLevel);

68 }if–
pKVSt‹e
->
iTønsLevñ
==0 ){

69 
	`lsm_c§_˛o£
(
p
->
pC§
);

70 
p
->
pC§
 = 0;

73  
rc
;

74 
	}
}

91 
	$kvlsmCommôPha£O√
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

92  
SQLITE4_OK
;

93 
	}
}

94 
	$kvlsmCommôPha£Two
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

95 
rc
 = 
SQLITE4_OK
;

96 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

98 if–
pKVSt‹e
->
iTønsLevñ
>
iLevñ
 ){

99 if–
pKVSt‹e
->
iTønsLevñ
>=2 ){

100 
rc
 = 
	`lsm_commô
(
p
->
pDb
, 
	`SQLITE4_MAX
(0, 
iLevñ
-1));

102 if–
iLevñ
==0 ){

103 
	`lsm_c§_˛o£
(
p
->
pC§
);

104 
p
->
pC§
 = 0;

106 if–
rc
==
SQLITE4_OK
 ){

107 
pKVSt‹e
->
iTønsLevñ
 = 
iLevñ
;

110  
rc
;

111 
	}
}

123 
	$kvlsmRﬁlback
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

124 
rc
 = 
SQLITE4_OK
;

125 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

127 if–
pKVSt‹e
->
iTønsLevñ
>=
iLevñ
 ){

128 if–
pKVSt‹e
->
iTønsLevñ
>=2 ){

129 
rc
 = 
	`lsm_rﬁlback
(
p
->
pDb
, 
	`SQLITE4_MAX
(0, 
iLevñ
-1));

131 if–
iLevñ
==0 ){

132 
	`lsm_c§_˛o£
(
p
->
pC§
);

133 
p
->
pC§
 = 0;

135 if–
rc
==
SQLITE4_OK
 ){

136 
pKVSt‹e
->
iTønsLevñ
 = 
iLevñ
;

139  
rc
;

140 
	}
}

145 
	$kvlsmRevît
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

146  
SQLITE4_OK
;

147 
	}
}

162 
	$kvlsmRïœ˚
(

163 
KVSt‹e
 *
pKVSt‹e
,

164 c⁄° 
KVByãAºay
 *
aKey
, 
KVSize
 
nKey
,

165 c⁄° 
KVByãAºay
 *
aD©a
, 
KVSize
 
nD©a


167 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

168  
	`lsm_ö£π
(
p
->
pDb
, (*)
aKey
, 
nKey
, (*)
aD©a
, 
nD©a
);

169 
	}
}

174 
	$kvlsmO≥nCurs‹
(
KVSt‹e
 *
pKVSt‹e
, 
KVCurs‹
 **
µKVCurs‹
){

175 
rc
 = 
SQLITE4_OK
;

176 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

177 
KVLsmC§
 *
pC§
;

179 
pC§
 = (
KVLsmC§
 *)
	`sqlôe4_mÆloc
(
pKVSt‹e
->
pEnv
, (KVLsmCsr));

180 if–
pC§
==0 ){

181 
rc
 = 
SQLITE4_NOMEM
;

183 
	`mem£t
(
pC§
, 0, (
KVLsmC§
));

184 
rc
 = 
	`lsm_c§_›í
(
p
->
pDb
, &
pC§
->pCsr);

186 if–
rc
==
SQLITE4_OK
 ){

187 
pC§
->
ba£
.
pSt‹e
 = 
pKVSt‹e
;

188 
pC§
->
ba£
.
pSt‹eVfunc
 = 
pKVSt‹e
->pStoreVfunc;

190 
	`sqlôe4_‰ì
(
pC§
->
ba£
.
pEnv
,ÖCsr);

191 
pC§
 = 0;

195 *
µKVCurs‹
 = (
KVCurs‹
*)
pC§
;

196  
rc
;

197 
	}
}

202 
	$kvlsmRe£t
(
KVCurs‹
 *
pKVCurs‹
){

203  
SQLITE4_OK
;

204 
	}
}

209 
	$kvlsmClo£Curs‹
(
KVCurs‹
 *
pKVCurs‹
){

210 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

211 
	`lsm_c§_˛o£
(
pC§
->pCsr);

212 
	`sqlôe4_‰ì
(
pC§
->
ba£
.
pEnv
,ÖCsr);

213  
SQLITE4_OK
;

214 
	}
}

219 
	$kvlsmNextE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

220 
rc
;

221 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

223 if–
	`lsm_c§_vÆid
(
pC§
->pC§)==0 )  
SQLITE4_NOTFOUND
;

224 
rc
 = 
	`lsm_c§_√xt
(
pC§
->pCsr);

225 if–
rc
==
LSM_OK
 && 
	`lsm_c§_vÆid
(
pC§
->pCsr)==0 ){

226 
rc
 = 
SQLITE4_NOTFOUND
;

228  
rc
;

229 
	}
}

234 
	$kvlsmPªvE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

235 
rc
;

236 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

238 if–
	`lsm_c§_vÆid
(
pC§
->pC§)==0 )  
SQLITE4_NOTFOUND
;

239 
rc
 = 
	`lsm_c§_¥ev
(
pC§
->pCsr);

240 if–
rc
==
LSM_OK
 && 
	`lsm_c§_vÆid
(
pC§
->pCsr)==0 ){

241 
rc
 = 
SQLITE4_NOTFOUND
;

243  
rc
;

244 
	}
}

249 
	$kvlsmSìk
(

250 
KVCurs‹
 *
pKVCurs‹
,

251 c⁄° 
KVByãAºay
 *
aKey
,

252 
KVSize
 
nKey
,

253 
dú


255 
rc
;

256 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

258 
	`as£π
–
dú
==0 || dir==1 || dir==-1 || dir==-2 );

259 
	`as£π
–
LSM_SEEK_EQ
==0 && 
LSM_SEEK_GE
==1 && 
LSM_SEEK_LE
==-1 );

260 
	`as£π
–
LSM_SEEK_LEFAST
==-2 );

262 
rc
 = 
	`lsm_c§_£ek
(
pC§
->pC§, (*)
aKey
, 
nKey
, 
dú
);

263 if–
rc
==
SQLITE4_OK
 ){

264 if–
	`lsm_c§_vÆid
(
pC§
->pCsr)==0 ){

265 
rc
 = 
SQLITE4_NOTFOUND
;

267 c⁄° *
pDbKey
;

268 
nDbKey
;

270 
rc
 = 
	`lsm_c§_key
(
pC§
->pC§, &
pDbKey
, &
nDbKey
);

271 if–
rc
==
SQLITE4_OK
 && (
nDbKey
!=
nKey
 || 
	`memcmp
(
pDbKey
, 
aKey
,ÇKey)) ){

272 
rc
 = 
SQLITE4_INEXACT
;

277  
rc
;

278 
	}
}

288 
	$kvlsmDñëe
(
KVCurs‹
 *
pKVCurs‹
){

289 
rc
;

290 c⁄° *
pKey
;

291 
nKey
;

292 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

294 
	`as£π
–
	`lsm_c§_vÆid
(
pC§
->pCsr) );

295 
rc
 = 
	`lsm_c§_key
(
pC§
->pC§, &
pKey
, &
nKey
);

296 if–
rc
==
SQLITE4_OK
 ){

297 
rc
 = 
	`lsm_dñëe
(((
KVLsm
 *)(
pKVCurs‹
->
pSt‹e
))->
pDb
, 
pKey
, 
nKey
);

300  
SQLITE4_OK
;

301 
	}
}

306 
	$kvlsmKey
(

307 
KVCurs‹
 *
pKVCurs‹
,

308 c⁄° 
KVByãAºay
 **
∑Key
,

309 
KVSize
 *
pN


311 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

312 if–0==
	`lsm_c§_vÆid
(
pC§
->pC§ËË 
SQLITE4_DONE
;

313  
	`lsm_c§_key
(
pC§
->pC§, (c⁄° **)
∑Key
, (*)
pN
);

314 
	}
}

319 
	$kvlsmD©a
(

320 
KVCurs‹
 *
pKVCurs‹
,

321 
KVSize
 
of°
,

322 
KVSize
 
n
,

323 c⁄° 
KVByãAºay
 **
∑D©a
,

324 
KVSize
 *
pND©a


326 
KVLsmC§
 *
pC§
 = (KVLsmC§ *)
pKVCurs‹
;

327 
rc
;

328 *
pD©a
;

329 
nD©a
;

331 
rc
 = 
	`lsm_c§_vÆue
(
pC§
->pC§, (c⁄° **)&
pD©a
, &
nD©a
);

332 if–
rc
==
SQLITE4_OK
 ){

333 if–
n
<0 ){

334 *
∑D©a
 = 
pD©a
;

335 *
pND©a
 = 
nD©a
;

337 
nOut
 = 
n
;

338 if–(
of°
+
n
)>
nD©a
 ) 
nOut
 =ÇData - ofst;

339 if–
nOut
<0 )ÇOut = 0;

341 *
∑D©a
 = &((
u8
 *)
pD©a
)[
n
];

342 *
pND©a
 = 
nOut
;

346  
rc
;

347 
	}
}

352 
	$kvlsmClo£
(
KVSt‹e
 *
pKVSt‹e
){

353 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

358 
	`kvlsmRﬁlback
(
pKVSt‹e
, 0);

359 
	`as£π
–
p
->
pC§
==0 );

361 
	`lsm_˛o£
(
p
->
pDb
);

362 
	`sqlôe4_‰ì
(
p
->
ba£
.
pEnv
,Ö);

363  
SQLITE4_OK
;

364 
	}
}

366 
	$kvlsmC⁄åﬁ
(
KVSt‹e
 *
pKVSt‹e
, 
›
, *
pArg
){

367 
rc
 = 
SQLITE4_OK
;

368 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

370  
›
 ){

371 
SQLITE4_KVCTRL_LSM_HANDLE
: {

372 
lsm_db
 **
µOut
 = (lsm_db **)
pArg
;

373 *
µOut
 = 
p
->
pDb
;

377 
SQLITE4_KVCTRL_SYNCHRONOUS
: {

378 *
≥Sa„ty
 = (*)
pArg
;

379 
eP¨am
 = *
≥Sa„ty
 + 1;

380 
	`lsm_c⁄fig
(
p
->
pDb
, 
LSM_CONFIG_SAFETY
, &
eP¨am
);

381 *
≥Sa„ty
 = 
eP¨am
-1;

385 
SQLITE4_KVCTRL_LSM_FLUSH
: {

386 
	`lsm_Êush
(
p
->
pDb
);

390 
SQLITE4_KVCTRL_LSM_MERGE
: {

391 
nPage
 = *(*)
pArg
;

392 
nWrôe
 = 0;

393 
	`lsm_w‹k
(
p
->
pDb
, 0, 
nPage
, &
nWrôe
);

394 *(*)
pArg
 = 
nWrôe
;

398 
SQLITE4_KVCTRL_LSM_CHECKPOINT
: {

399 
	`lsm_checkpoöt
(
p
->
pDb
, 0);

405 
rc
 = 
SQLITE4_NOTFOUND
;

409  
rc
;

410 
	}
}

412 
	$kvlsmGëMëa
(
KVSt‹e
 *
pKVSt‹e
, *
piVÆ
){

413 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

414  
	`lsm_gë_u£r_vîsi⁄
(
p
->
pDb
, 
piVÆ
);

415 
	}
}

417 
	$kvlsmPutMëa
(
KVSt‹e
 *
pKVSt‹e
, 
iVÆ
){

418 
KVLsm
 *
p
 = (KVLsm *)
pKVSt‹e
;

419  
	`lsm_£t_u£r_vîsi⁄
(
p
->
pDb
, 
iVÆ
);

420 
	}
}

422 
PøgmaCtx
 
	tPøgmaCtx
;

423 
	sPøgmaCtx
 {

424 
lsm_db
 *
	mpDb
;

425 
	mePøgma
;

428 
	#KVLSM_LSM_FLUSH
 1

	)

429 
	#KVLSM_LSM_WORK
 2

	)

430 
	#KVLSM_LSM_CHECKPOINT
 3

	)

432 
	$kvlsmPøgmaDe°roy
(*
p
){

433 
	`sqlôe4_‰ì
(0, 
p
);

434 
	}
}

436 
	$kvlsmPøgma
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
≠Arg
){

437 
PøgmaCtx
 *
p
 = (PøgmaCtx *)
	`sqlôe4_c⁄ãxt_≠pd©a
(
˘x
);

438 
rc
 = 
SQLITE4_OK
;

440  
p
->
ePøgma
 ){

441 
KVLSM_LSM_FLUSH
:

442 if–
nArg
!=0 ) 
wr⁄g_num_¨gs
;

443 
rc
 = 
	`lsm_Êush
(
p
->
pDb
);

446 
KVLSM_LSM_WORK
:

447 if–
nArg
!=2 ){

448 
wr⁄g_num_¨gs
;

450 
nMîge
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[0]);

451 
nWrôe
 = 
	`sqlôe4_vÆue_öt
(
≠Arg
[1]);

452 
rc
 = 
	`lsm_w‹k
(
p
->
pDb
, 
nMîge
, 
nWrôe
, &nWrite);

453 
	`sqlôe4_ªsu…_öt
(
˘x
, 
nWrôe
);

457 
KVLSM_LSM_CHECKPOINT
: {

458 
nKB
;

459 if–
nArg
!=0 ) 
wr⁄g_num_¨gs
;

460 
rc
 = 
	`lsm_checkpoöt
(
p
->
pDb
, &
nKB
);

461 
	`sqlôe4_ªsu…_öt
(
˘x
, 
nKB
);

466 if–
rc
!=
SQLITE4_OK
 ){

467 
	`sqlôe4_ªsu…_îr‹_code
(
˘x
, 
rc
);

471 
wr⁄g_num_¨gs
:

472 
	`sqlôe4_ªsu…_îr‹
(
˘x
, "wrongÇumber ofárguments", -1);

473 
	}
}

475 
kvlsmGëMëhod
(

476 
sqlôe4_kv°‹e
 *
pKVSt‹e
,

477 c⁄° *
zMëhod
,

478 **
µArg
,

479 (**
pxFunc
)(
sqlôe4_c⁄ãxt
 *, , 
sqlôe4_vÆue
 **),

480 (**
pxDe°roy
)(*)

482 
KVLsm
 *
pLsm
 = (KVLsm *)
pKVSt‹e
;

483 
PøgmaCtx
 *
p
;

484 
ePøgma
 = 0;

486 if–0==
	`sqlôe4_°∫icmp
(
zMëhod
, "lsm_flush", 9) ){

487 
ePøgma
 = 
KVLSM_LSM_FLUSH
;

489 if–0==
	`sqlôe4_°∫icmp
(
zMëhod
, "lsm_work", 8) ){

490 
ePøgma
 = 
KVLSM_LSM_WORK
;

492 if–0==
	`sqlôe4_°∫icmp
(
zMëhod
, "lsm_checkpoint", 14) ){

493 
ePøgma
 = 
KVLSM_LSM_CHECKPOINT
;

495  
SQLITE4_NOTFOUND
;

498 
p
 = 
	`sqlôe4_mÆloc
(0, (
PøgmaCtx
));

499 if–
p
==0 )  
SQLITE4_NOMEM
;

500 
p
->
ePøgma
 =ÉPragma;

501 
p
->
pDb
 = 
pLsm
->pDb;

503 *
µArg
 = (*)
p
;

504 *
pxFunc
 = 
kvlsmPøgma
;

505 *
pxDe°roy
 = 
kvlsmPøgmaDe°roy
;

506  
SQLITE4_OK
;

507 
	}
}

512 
	$sqlôe4KVSt‹eO≥nLsm
(

513 
sqlôe4_ív
 *
pEnv
,

514 
KVSt‹e
 **
µKVSt‹e
,

515 c⁄° *
zName
,

516 
›íFœgs


520 c⁄° 
KVSt‹eMëhods
 
kvlsmMëhods
 = {

522 (
KVSt‹eMëhods
),

523 
kvlsmRïœ˚
,

524 
kvlsmO≥nCurs‹
,

525 
kvlsmSìk
,

526 
kvlsmNextE¡ry
,

527 
kvlsmPªvE¡ry
,

528 
kvlsmDñëe
,

529 
kvlsmKey
,

530 
kvlsmD©a
,

531 
kvlsmRe£t
,

532 
kvlsmClo£Curs‹
,

533 
kvlsmBegö
,

534 
kvlsmCommôPha£O√
,

535 
kvlsmCommôPha£Two
,

536 
kvlsmRﬁlback
,

537 
kvlsmRevît
,

538 
kvlsmClo£
,

539 
kvlsmC⁄åﬁ
,

540 
kvlsmGëMëa
,

541 
kvlsmPutMëa
,

542 
kvlsmGëMëhod


545 
KVLsm
 *
pNew
;

546 
rc
 = 
SQLITE4_OK
;

548 
pNew
 = (
KVLsm
 *)
	`sqlôe4_mÆloc
(
pEnv
, (KVLsm));

549 if–
pNew
==0 ){

550 
rc
 = 
SQLITE4_NOMEM
;

552 
	sC⁄fig
 {

553 c⁄° *
zP¨am
;

554 
eP¨am
;

555 } 
aC⁄fig
[] = {

556 { "lsm_mm≠", 
LSM_CONFIG_MMAP
 },

557 { "lsm_∑ge_size", 
LSM_CONFIG_PAGE_SIZE
 },

558 { "lsm_block_size", 
LSM_CONFIG_BLOCK_SIZE
 },

559 { "lsm_mu…ùÀ_¥o˚s£s", 
LSM_CONFIG_MULTIPLE_PROCESSES
 },

560 { "lsm_automîge", 
LSM_CONFIG_AUTOMERGE
 }

563 
	`mem£t
(
pNew
, 0, (
KVLsm
));

564 
pNew
->
ba£
.
pSt‹eVfunc
 = &
kvlsmMëhods
;

565 
pNew
->
ba£
.
pEnv
 =ÖEnv;

566 
rc
 = 
	`lsm_√w
(0, &
pNew
->
pDb
);

567 if–
rc
==
SQLITE4_OK
 ){

568 
i
;

569 
i
=0; i<
	`AºaySize
(
aC⁄fig
); i++){

570 c⁄° *
zVÆ
 = 
	`sqlôe4_uri_∑ømëî
(
zName
, 
aC⁄fig
[
i
].
zP¨am
);

571 if–
zVÆ
 ){

572 
nVÆ
 = 
	`sqlôe4Atoi
(
zVÆ
);

573 
	`lsm_c⁄fig
(
pNew
->
pDb
, 
aC⁄fig
[
i
].
eP¨am
, &
nVÆ
);

577 
rc
 = 
	`lsm_›í
(
pNew
->
pDb
, 
zName
);

580 if–
rc
!=
SQLITE4_OK
 ){

581 
	`lsm_˛o£
(
pNew
->
pDb
);

582 
	`sqlôe4_‰ì
(
pEnv
, 
pNew
);

583 
pNew
 = 0;

587 *
µKVSt‹e
 = (
KVSt‹e
*)
pNew
;

588  
rc
;

589 
	}
}

	@src/kvmem.c

16 
	~"sqlôeI¡.h
"

19 
KVMemNode
 
	tKVMemNode
;

20 
KVMemChng
 
	tKVMemChng
;

21 
KVMem
 
	tKVMem
;

22 
KVMemCurs‹
 
	tKVMemCurs‹
;

23 
KVMemD©a
 
	tKVMemD©a
;

28 
	sKVMemD©a
 {

29 
	mnRef
;

30 
KVSize
 
	mn
;

31 
KVByãAºay
 
	ma
[8];

38 
	sKVMemNode
 {

39 
KVMemD©a
 *
	mpD©a
;

40 
KVMemNode
 *
	mpBef‹e
;

41 
KVMemNode
 *
	mpA·î
;

42 
KVMemNode
 *
	mpUp
;

43 
	mheight
;

44 
	mimbÆ™˚
;

45 
	mmxTøns
;

46 
	mnRef
;

47 
KVSize
 
	mnKey
;

48 
KVByãAºay
 
	maKey
[2];

55 
	sKVMemChng
 {

56 
KVMemChng
 *
	mpNext
;

57 
KVMemNode
 *
	mpNode
;

58 
KVMemD©a
 *
	mpD©a
;

59 
	mﬁdTøns
;

66 
	sKVMem
 {

67 
KVSt‹e
 
	mba£
;

68 
KVMemNode
 *
	mpRoŸ
;

69 
	m›íFœgs
;

70 
KVMemChng
 **
	m≠Log
;

71 
	mnCurs‹
;

72 
	miMagicKVMemBa£
;

73 
	miMëa
;

75 
	#SQLITE4_KVMEMBASE_MAGIC
 0xbfcd47d0

	)

80 
	sKVMemCurs‹
 {

81 
KVCurs‹
 
	mba£
;

82 
KVMem
 *
	mpOw√r
;

83 
KVMemNode
 *
	mpNode
;

84 
KVMemD©a
 *
	mpD©a
;

85 
	miMagicKVMemCur
;

87 
	#SQLITE4_KVMEMCUR_MAGIC
 0xb19bdc1b

	)

98 
	$kvmemRecompuãHeight
(
KVMemNode
 *
p
){

99 
hBef‹e
 = 
p
->
pBef‹e
 ?Ö->pBef‹e->
height
 : 0;

100 
hA·î
 = 
p
->
pA·î
 ?Ö->pA·î->
height
 : 0;

101 
p
->
imbÆ™˚
 = 
hBef‹e
 - 
hA·î
;

102 
p
->
height
 = (
hBef‹e
>
hA·î
 ? hBefore : hAfter)+1;

103 
	}
}

113 
KVMemNode
 *
	$kvmemRŸ©eBef‹e
(
KVMemNode
 *
pP
){

114 
KVMemNode
 *
pB
 = 
pP
->
pBef‹e
;

115 
KVMemNode
 *
pY
 = 
pB
->
pA·î
;

116 
pB
->
pUp
 = 
pP
->pUp;

117 
pB
->
pA·î
 = 
pP
;

118 
pP
->
pUp
 = 
pB
;

119 
pP
->
pBef‹e
 = 
pY
;

120 if–
pY
 )ÖY->
pUp
 = 
pP
;

121 
	`kvmemRecompuãHeight
(
pP
);

122 
	`kvmemRecompuãHeight
(
pB
);

123  
pB
;

124 
	}
}

134 
KVMemNode
 *
	$kvmemRŸ©eA·î
(
KVMemNode
 *
pP
){

135 
KVMemNode
 *
pA
 = 
pP
->
pA·î
;

136 
KVMemNode
 *
pY
 = 
pA
->
pBef‹e
;

137 
pA
->
pUp
 = 
pP
->pUp;

138 
pA
->
pBef‹e
 = 
pP
;

139 
pP
->
pUp
 = 
pA
;

140 
pP
->
pA·î
 = 
pY
;

141 if–
pY
 )ÖY->
pUp
 = 
pP
;

142 
	`kvmemRecompuãHeight
(
pP
);

143 
	`kvmemRecompuãHeight
(
pA
);

144  
pA
;

145 
	}
}

151 
KVMemNode
 **
	$kvmemFromPå
(
KVMemNode
 *
p
, KVMemNodê**
µ
){

152 
KVMemNode
 *
pUp
 = 
p
->pUp;

153 if–
pUp
==0 )  
µ
;

154 
	`as£π
–
pUp
->
pA·î
==
p
 ||ÖUp->
pBef‹e
==p );

155 if–
pUp
->
pA·î
==
p
 )  &pUp->pAfter;

156  &
pUp
->
pBef‹e
;

157 
	}
}

163 
KVMemNode
 *
	$kvmemBÆ™˚
(
KVMemNode
 *
p
){

164 
KVMemNode
 *
pT›
 = 
p
;

165 
KVMemNode
 **
µ
;

166  
p
 ){

167 
	`kvmemRecompuãHeight
(
p
);

168 if–
p
->
imbÆ™˚
>=2 ){

169 
KVMemNode
 *
pB
 = 
p
->
pBef‹e
;

170 if–
pB
->
imbÆ™˚
<0 ) 
p
->
pBef‹e
 = 
	`kvmemRŸ©eA·î
(pB);

171 
µ
 = 
	`kvmemFromPå
(
p
,&p);

172 
p
 = *
µ
 = 
	`kvmemRŸ©eBef‹e
(p);

173 }if–
p
->
imbÆ™˚
<=(-2) ){

174 
KVMemNode
 *
pA
 = 
p
->
pA·î
;

175 if–
pA
->
imbÆ™˚
>0 ) 
p
->
pA·î
 = 
	`kvmemRŸ©eBef‹e
(pA);

176 
µ
 = 
	`kvmemFromPå
(
p
,&p);

177 
p
 = *
µ
 = 
	`kvmemRŸ©eA·î
(p);

179 
pT›
 = 
p
;

180 
p
 =Ö->
pUp
;

182  
pT›
;

183 
	}
}

188 
	$kvmemKeyCom∑ª
(

189 c⁄° 
KVByãAºay
 *
aK1
, 
KVSize
 
nK1
,

190 c⁄° 
KVByãAºay
 *
aK2
, 
KVSize
 
nK2


192 
c
;

193 
c
 = 
	`memcmp
(
aK1
, 
aK2
, 
nK1
<
nK2
 ?ÇK1 :ÇK2);

194 if–
c
==0 ) c = 
nK1
 - 
nK2
;

195  
c
;

196 
	}
}

201 
KVMemD©a
 *
	$kvmemD©aNew
(

202 
sqlôe4_ív
 *
pEnv
,

203 c⁄° 
KVByãAºay
 *
aD©a
,

204 
KVSize
 
nD©a


206 
KVMemD©a
 *
p
 = 
	`sqlôe4_mÆloc
(
pEnv
, (*pË+ 
nD©a
 - 8 );

207 if–
p
 ) {

208 
p
->
nRef
 = 1;

209 
p
->
n
 = 
nD©a
;

210 
	`mem˝y
(
p
->
a
, 
aD©a
, 
nD©a
);

212  
p
;

213 
	}
}

218 
KVMemD©a
 *
	$kvmemD©aRef
(
KVMemD©a
 *
p
){

219 if–
p
 )Ö->
nRef
++;

220  
p
;

221 
	}
}

226 
	$kvmemD©aUƒef
(
sqlôe4_ív
 *
pEnv
, 
KVMemD©a
 *
p
){

227 if–
p
 && (--p->
nRef
)<=0 ) 
	`sqlôe4_‰ì
(
pEnv
,Ö);

228 
	}
}

233 
KVMemNode
 *
	$kvmemNodeRef
(
KVMemNode
 *
p
){

234 if–
p
 )Ö->
nRef
++;

235  
p
;

236 
	}
}

241 
	$kvmemNodeUƒef
(
sqlôe4_ív
 *
pEnv
, 
KVMemNode
 *
p
){

242 if–
p
 && (--p->
nRef
)<=0 ){

243 
	`kvmemD©aUƒef
(
pEnv
, 
p
->
pD©a
);

244 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

246 
	}
}

251 
	$kvmemCÀ¨Tªe
(
sqlôe4_ív
 *
pEnv
, 
KVMemNode
 *
pNode
){

252 if–
pNode
==0 ) ;

253 
	`kvmemCÀ¨Tªe
(
pEnv
, 
pNode
->
pBef‹e
);

254 
	`kvmemCÀ¨Tªe
(
pEnv
, 
pNode
->
pA·î
);

255 
	`kvmemNodeUƒef
(
pEnv
, 
pNode
);

256 
	}
}

261 
	#kvmemTønß˘i⁄Æ
(
P
) \

262 (((
P
)->
›íFœgs
 & 
SQLITE4_KVOPEN_NO_TRANSACTIONS
)==0)

	)

272 
KVMemNode
 *
	$kvmemFú°
(
KVMemNode
 *
p
){

273 if–
p
 ) Ö->
pBef‹e
 )Ö =Ö->pBefore;

274  
p
;

275 
	}
}

279 
KVMemNode
 *
	$kvmemNext
(
KVMemNode
 *
p
){

280 
KVMemNode
 *
pPªv
 = 0;

281  
p
 &&Ö->
pA·î
==
pPªv
 ){

282 
pPªv
 = 
p
;

283 
p
 =Ö->
pUp
;

285 if–
p
 && 
pPªv
==0 ){

286 
p
 = 
	`kvmemFú°
’->
pA·î
);

288  
p
;

289 
	}
}

293 
KVMemNode
 *
	$kvmemLa°
(
KVMemNode
 *
p
){

294 if–
p
 ) Ö->
pA·î
 )Ö =Ö->pAfter;

295  
p
;

296 
	}
}

300 
KVMemNode
 *
	$kvmemPªv
(
KVMemNode
 *
p
){

301 
KVMemNode
 *
pPri‹
 = 0;

302  
p
 &&Ö->
pBef‹e
==
pPri‹
 ){

303 
pPri‹
 = 
p
;

304 
p
 =Ö->
pUp
;

306 if–
p
 && 
pPri‹
==0 ){

307 
p
 = 
	`kvmemLa°
’->
pBef‹e
);

309  
p
;

310 
	}
}

315 
KVMemChng
 *
	$kvmemNewChng
(
KVMem
 *
p
, 
KVMemNode
 *
pNode
){

316 
KVMemChng
 *
pChng
;

317 
	`as£π
–
p
->
ba£
.
iTønsLevñ
>=2 );

318 
pChng
 = 
	`sqlôe4_mÆloc
(
p
->
ba£
.
pEnv
, (*pChng) );

319 if–
pChng
 ){

320 
pChng
->
pNext
 = 
p
->
≠Log
[p->
ba£
.
iTønsLevñ
-2];

321 
p
->
≠Log
[p->
ba£
.
iTønsLevñ
-2] = 
pChng
;

322 
pChng
->
pNode
 =ÖNode;

323 
pChng
->
ﬁdTøns
 = 
pNode
->
mxTøns
;

324 
pNode
->
mxTøns
 = 
p
->
ba£
.
iTønsLevñ
;

325 
pChng
->
pD©a
 = 
pNode
->pData;

326 
pNode
->
pD©a
 = 0;

328  
pChng
;

329 
	}
}

333 
KVMemNode
 *
	$kvmemNewNode
(

334 
KVMem
 *
p
,

335 c⁄° 
KVByãAºay
 *
aKey
,

336 
KVSize
 
nKey


338 
KVMemNode
 *
pNode
;

339 
KVMemChng
 *
pChng
;

340 
	`as£π
–
p
->
ba£
.
iTønsLevñ
>=2 );

341 
pNode
 = 
	`sqlôe4_mÆloc
(
p
->
ba£
.
pEnv
, (*pNode)+
nKey
-2 );

342 if–
pNode
 ){

343 
	`mem£t
(
pNode
, 0, (*pNode));

344 
	`mem˝y
(
pNode
->
aKey
,áKey, 
nKey
);

345 
pNode
->
nKey
 =ÇKey;

346 
pNode
->
nRef
 = 1;

347 if–
	`kvmemTønß˘i⁄Æ
(
p
) ){

348 
pChng
 = 
	`kvmemNewChng
(
p
, 
pNode
);

349 if–
pChng
==0 ){

350 
	`sqlôe4_‰ì
(
p
->
ba£
.
pEnv
, 
pNode
);

351 
pNode
 = 0;

353 
	`as£π
–
pChng
==0 ||ÖChng->
pD©a
==0 );

356  
pNode
;

357 
	}
}

359 #ifde‡
SQLITE4_DEBUG


366 
	$cou¡NodeOccuªn˚s
(
KVMemNode
 *
pSub
, KVMemNodê*
pNode
){

367 
iRë
 = (
pSub
==
pNode
);

368 if–
pSub
 ){

369 
iRë
 +
	`cou¡NodeOccuªn˚s
(
pSub
->
pBef‹e
, 
pNode
);

370 
iRë
 +
	`cou¡NodeOccuªn˚s
(
pSub
->
pA·î
, 
pNode
);

372  
iRë
;

373 
	}
}

380 
	$as£πUpPoöãrs
(
KVMemNode
 *
pSub
){

381 if–
pSub
 ){

382 
	`as£π
–
pSub
->
pBef‹e
==0 ||ÖSub->pBef‹e->
pUp
==pSub );

383 
	`as£π
–
pSub
->
pA·î
==0 ||ÖSub->pA·î->
pUp
==pSub );

384 
	`as£πUpPoöãrs
(
pSub
->
pBef‹e
);

385 
	`as£πUpPoöãrs
(
pSub
->
pA·î
);

387 
	}
}

390 
	#as£πUpPoöãrs
(
x
)

	)

395 
	$kvmemRemoveNode
(
KVMem
 *
p
, 
KVMemNode
 *
pOld
){

396 
KVMemNode
 **
µP¨ít
;

397 
KVMemNode
 *
pBÆ™˚
;

398 
	`kvmemD©aUƒef
(
p
->
ba£
.
pEnv
, 
pOld
->
pD©a
);

399 
pOld
->
pD©a
 = 0;

400 
µP¨ít
 = 
	`kvmemFromPå
(
pOld
, &
p
->
pRoŸ
);

401 if–
pOld
->
pBef‹e
==0 &&ÖOld->
pA·î
==0 ){

402 *
µP¨ít
 = 0;

403 
pBÆ™˚
 = 
pOld
->
pUp
;

404 }if–
pOld
->
pBef‹e
 &&ÖOld->
pA·î
 ){

405 
KVMemNode
 *
pX
;

406 
KVMemNode
 *
pY
;

407 
pX
 = 
	`kvmemFú°
(
pOld
->
pA·î
);

408 
	`as£π
–
pX
->
pBef‹e
==0 );

409 if–
pX
==
pOld
->
pA·î
 ){

410 
pBÆ™˚
 = 
pX
;

412 *
	`kvmemFromPå
(
pX
, 0ËpX->
pA·î
;

413 if–
pX
->
pA·î
 )ÖX->pA·î->
pUp
 =ÖX->pUp;

414 
pBÆ™˚
 = 
pX
->
pUp
;

415 
pX
->
pA·î
 = 
pOld
->pAfter;

416 if–
pX
->
pA·î
 ){

417 
pX
->
pA·î
->
pUp
 =ÖX;

419 
	`as£π
–
pBÆ™˚
==
pOld
 );

420 
pBÆ™˚
 = 
pX
;

423 
pX
->
pBef‹e
 = 
pY
 = 
pOld
->pBefore;

424 if–
pY
 )ÖY->
pUp
 = 
pX
;

425 
pX
->
pUp
 = 
pOld
->pUp;

426 *
µP¨ít
 = 
pX
;

427 }if–
pOld
->
pBef‹e
==0 ){

428 *
µP¨ít
 = 
pBÆ™˚
 = 
pOld
->
pA·î
;

429 
pBÆ™˚
->
pUp
 = 
pOld
->pUp;

430 }if–
pOld
->
pA·î
==0 ){

431 *
µP¨ít
 = 
pBÆ™˚
 = 
pOld
->
pBef‹e
;

432 
pBÆ™˚
->
pUp
 = 
pOld
->pUp;

434 
p
->
pRoŸ
 = 
	`kvmemBÆ™˚
(
pBÆ™˚
);

435 
	`kvmemNodeUƒef
(
p
->
ba£
.
pEnv
, 
pOld
);

436 
	}
}

457 
	$kvmemBegö
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

458 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

459 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

460 
	`as£π
–
iLevñ
>0 );

461 
	`as£π
–
iLevñ
==2 || iLevñ==
p
->
ba£
.
iTønsLevñ
+1 );

462 if–
iLevñ
>=2 ){

463 
KVMemChng
 **
≠NewLog
;

464 
≠NewLog
 = 
	`sqlôe4_ªÆloc
(
p
->
ba£
.
pEnv
,Ö->
≠Log
,

465 (
≠NewLog
[0])*(
iLevñ
-1) );

466 if–
≠NewLog
==0 )  
SQLITE4_NOMEM
;

467 
p
->
≠Log
 = 
≠NewLog
;

468 
p
->
≠Log
[
iLevñ
-2] = 0;

470 
p
->
ba£
.
iTønsLevñ
 = 
iLevñ
;

471  
SQLITE4_OK
;

472 
	}
}

489 
	$kvmemCommôPha£O√
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

490  
SQLITE4_OK
;

491 
	}
}

492 
	$kvmemCommôPha£Two
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

493 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

494 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

495 
	`as£π
–
iLevñ
>=0 );

496 
	`as£π
–
iLevñ
<
p
->
ba£
.
iTønsLevñ
 );

497 
	`as£πUpPoöãrs
(
p
->
pRoŸ
);

498 if–!
	`kvmemTønß˘i⁄Æ
(
p
ËË 
SQLITE4_OK
;

499  
p
->
ba£
.
iTønsLevñ
>
iLevñ
 &&Ö->base.iTransLevel>1 ){

500 
KVMemChng
 *
pChng
, *
pNext
;

502 if–
iLevñ
<2 ){

503 
pChng
=
p
->
≠Log
[p->
ba£
.
iTønsLevñ
-2];ÖChng;ÖChng=
pNext
){

504 
KVMemNode
 *
pNode
 = 
pChng
->pNode;

505 if–
pNode
->
pD©a
 ){

506 
pNode
->
mxTøns
 = 
pChng
->
ﬁdTøns
;

508 
	`kvmemRemoveNode
(
p
, 
pNode
);

510 
	`kvmemD©aUƒef
(
p
->
ba£
.
pEnv
, 
pChng
->
pD©a
);

511 
pNext
 = 
pChng
->pNext;

512 
	`sqlôe4_‰ì
(
p
->
ba£
.
pEnv
, 
pChng
);

515 
KVMemChng
 **
µ
;

516 
iFrom
 = 
p
->
ba£
.
iTønsLevñ
-2;

517 
iTo
 = 
p
->
ba£
.
iTønsLevñ
-3;

518 
	`as£π
–
iTo
>=0 );

520 
µ
=&
p
->
≠Log
[
iFrom
]; *µ;Öp=&((*µ)->
pNext
)){

521 
	`as£π
–(*
µ
)->
pNode
->
mxTøns
==
p
->
ba£
.
iTønsLevñ


522 || (*
µ
)->
pNode
->
mxTøns
==(
p
->
ba£
.
iTønsLevñ
-1)

524 (*
µ
)->
pNode
->
mxTøns
 = 
p
->
ba£
.
iTønsLevñ
 - 1;

526 *
µ
 = 
p
->
≠Log
[
iTo
];

527 
p
->
≠Log
[
iTo
] =Ö->≠Log[
iFrom
];

530 
p
->
≠Log
[p->
ba£
.
iTønsLevñ
-2] = 0;

531 
p
->
ba£
.
iTønsLevñ
--;

533 
	`as£πUpPoöãrs
(
p
->
pRoŸ
);

534 
p
->
ba£
.
iTønsLevñ
 = 
iLevñ
;

535  
SQLITE4_OK
;

536 
	}
}

548 
	$kvmemRﬁlback
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

549 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

550 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

551 
	`as£π
–
iLevñ
>=0 );

552 if–!
	`kvmemTønß˘i⁄Æ
(
p
ËË 
SQLITE4_OK
;

553  
p
->
ba£
.
iTønsLevñ
>
iLevñ
 &&Ö->base.iTransLevel>1 ){

554 
KVMemChng
 *
pChng
, *
pNext
;

555 
pChng
=
p
->
≠Log
[p->
ba£
.
iTønsLevñ
-2];ÖChng;ÖChng=
pNext
){

556 
KVMemNode
 *
pNode
 = 
pChng
->pNode;

557 if–
pChng
->
pD©a
 ||ÖChng->
ﬁdTøns
>0 ){

558 
	`kvmemD©aUƒef
(
p
->
ba£
.
pEnv
, 
pNode
->
pD©a
);

559 
pNode
->
pD©a
 = 
pChng
->pData;

560 
pNode
->
mxTøns
 = 
pChng
->
ﬁdTøns
;

562 
	`kvmemRemoveNode
(
p
, 
pNode
);

564 
pNext
 = 
pChng
->pNext;

565 
	`sqlôe4_‰ì
(
p
->
ba£
.
pEnv
, 
pChng
);

567 
p
->
≠Log
[p->
ba£
.
iTønsLevñ
-2] = 0;

568 
p
->
ba£
.
iTønsLevñ
--;

570 
p
->
ba£
.
iTønsLevñ
 = 
iLevñ
;

571  
SQLITE4_OK
;

572 
	}
}

577 
	$kvmemRevît
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

578 
rc
 = 
	`kvmemRﬁlback
(
pKVSt‹e
, 
iLevñ
-1);

579 if–
rc
==
SQLITE4_OK
 ){

580 
rc
 = 
	`kvmemBegö
(
pKVSt‹e
, 
iLevñ
);

582  
rc
;

583 
	}
}

598 
	$kvmemRïœ˚
(

599 
KVSt‹e
 *
pKVSt‹e
,

600 c⁄° 
KVByãAºay
 *
aKey
, 
KVSize
 
nKey
,

601 c⁄° 
KVByãAºay
 *
aD©a
, 
KVSize
 
nD©a


603 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

604 
KVMemNode
 *
pNew
, *
pNode
;

605 
KVMemD©a
 *
pD©a
;

606 
KVMemChng
 *
pChng
;

607 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

608 
	`as£π
–
p
->
ba£
.
iTønsLevñ
>=2 );

609 
pD©a
 = 
	`kvmemD©aNew
(
p
->
ba£
.
pEnv
, 
aD©a
, 
nD©a
);

610 if–
pD©a
==0 )  
SQLITE4_NOMEM
;

611 if–
p
->
pRoŸ
==0 ){

612 
pNode
 = 
pNew
 = 
	`kvmemNewNode
(
p
, 
aKey
, 
nKey
);

613 if–
pNew
==0 ) 
KVMemRïœ˚_nomem
;

614 
pNew
->
pUp
 = 0;

616 
pNode
 = 
p
->
pRoŸ
;

617  
pNode
 ){

618 
c
 = 
	`kvmemKeyCom∑ª
(
aKey
, 
nKey
, 
pNode
->aKey,ÖNode->nKey);

619 if–
c
<0 ){

620 if–
pNode
->
pBef‹e
 ){

621 
pNode
 =ÖNode->
pBef‹e
;

623 
pNode
->
pBef‹e
 = 
pNew
 = 
	`kvmemNewNode
(
p
, 
aKey
, 
nKey
);

624 if–
pNew
==0 ) 
KVMemRïœ˚_nomem
;

625 
pNew
->
pUp
 = 
pNode
;

628 }if–
c
>0 ){

629 if–
pNode
->
pA·î
 ){

630 
pNode
 =ÖNode->
pA·î
;

632 
pNode
->
pA·î
 = 
pNew
 = 
	`kvmemNewNode
(
p
, 
aKey
, 
nKey
);

633 if–
pNew
==0 ) 
KVMemRïœ˚_nomem
;

634 
pNew
->
pUp
 = 
pNode
;

638 if–
	`kvmemTønß˘i⁄Æ
(
p
Ë&& 
pNode
->
mxTøns
!ı->
ba£
.
iTønsLevñ
 ){

639 
pChng
 = 
	`kvmemNewChng
(
p
, 
pNode
);

640 if–
pChng
==0 ) 
KVMemRïœ˚_nomem
;

642 
	`kvmemD©aUƒef
(
p
->
ba£
.
pEnv
, 
pNode
->
pD©a
);

644 
pNode
->
pD©a
 =ÖData;

645  
SQLITE4_OK
;

649 
pNew
->
pD©a
 =ÖData;

650 
pNew
->
height
 = 1;

651 
p
->
pRoŸ
 = 
	`kvmemBÆ™˚
(
pNew
);

652  
SQLITE4_OK
;

654 
KVMemRïœ˚_nomem
:

655 
	`kvmemD©aUƒef
(
p
->
ba£
.
pEnv
, 
pD©a
);

656  
SQLITE4_NOMEM
;

657 
	}
}

662 
	$kvmemO≥nCurs‹
(
KVSt‹e
 *
pKVSt‹e
, 
KVCurs‹
 **
µKVCurs‹
){

663 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

664 
KVMemCurs‹
 *
pCur
;

665 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

666 
pCur
 = 
	`sqlôe4_mÆloc
(
p
->
ba£
.
pEnv
, (*pCur) );

667 if–
pCur
==0 ){

668 *
µKVCurs‹
 = 0;

669  
SQLITE4_NOMEM
;

671 
	`mem£t
(
pCur
, 0, (*pCur));

672 
pCur
->
pOw√r
 = 
p
;

673 
p
->
nCurs‹
++;

674 
pCur
->
iMagicKVMemCur
 = 
SQLITE4_KVMEMCUR_MAGIC
;

675 
pCur
->
ba£
.
pSt‹e
 = 
pKVSt‹e
;

676 
pCur
->
ba£
.
pSt‹eVfunc
 = 
pKVSt‹e
->pStoreVfunc;

677 *
µKVCurs‹
 = (
KVCurs‹
*)
pCur
;

678  
SQLITE4_OK
;

679 
	}
}

684 
	$kvmemRe£t
(
KVCurs‹
 *
pKVCurs‹
){

685 
KVMemCurs‹
 *
pCur
 = (KVMemCurs‹*)
pKVCurs‹
;

686 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

687 
	`kvmemD©aUƒef
(
pCur
->
ba£
.
pEnv
,ÖCur->
pD©a
);

688 
pCur
->
pD©a
 = 0;

689 
	`kvmemNodeUƒef
(
pCur
->
ba£
.
pEnv
,ÖCur->
pNode
);

690 
pCur
->
pNode
 = 0;

691  
SQLITE4_OK
;

692 
	}
}

697 
	$kvmemClo£Curs‹
(
KVCurs‹
 *
pKVCurs‹
){

698 
KVMemCurs‹
 *
pCur
 = (KVMemCurs‹*)
pKVCurs‹
;

699 if–
pCur
 ){

700 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

701 
	`as£π
–
pCur
->
pOw√r
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

702 
pCur
->
pOw√r
->
nCurs‹
--;

703 
	`kvmemRe£t
(
pKVCurs‹
);

704 
	`mem£t
(
pCur
, 0, (*pCur));

705 
	`sqlôe4_‰ì
(
pCur
->
ba£
.
pEnv
,ÖCur);

707  
SQLITE4_OK
;

708 
	}
}

713 
	$kvmemNextE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

714 
KVMemCurs‹
 *
pCur
;

715 
KVMemNode
 *
pNode
;

717 
pCur
 = (
KVMemCurs‹
*)
pKVCurs‹
;

718 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

719 
pNode
 = 
pCur
->pNode;

720 
	`kvmemRe£t
(
pKVCurs‹
);

722 
pNode
 = 
	`kvmemNext
(pNode);

723 } 
pNode
 &&ÖNode->
pD©a
==0 );

724 if–
pNode
 ){

725 
pCur
->
pNode
 = 
	`kvmemNodeRef
(pNode);

726 
pCur
->
pD©a
 = 
	`kvmemD©aRef
(
pNode
->pData);

728  
pNode
 ? 
SQLITE4_OK
 : 
SQLITE4_NOTFOUND
;

729 
	}
}

734 
	$kvmemPªvE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

735 
KVMemCurs‹
 *
pCur
;

736 
KVMemNode
 *
pNode
;

738 
pCur
 = (
KVMemCurs‹
*)
pKVCurs‹
;

739 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

740 
pNode
 = 
pCur
->pNode;

741 
	`kvmemRe£t
(
pKVCurs‹
);

743 
pNode
 = 
	`kvmemPªv
(pNode);

744 } 
pNode
 &&ÖNode->
pD©a
==0 );

745 if–
pNode
 ){

746 
pCur
->
pNode
 = 
	`kvmemNodeRef
(pNode);

747 
pCur
->
pD©a
 = 
	`kvmemD©aRef
(
pNode
->pData);

749  
pNode
 ? 
SQLITE4_OK
 : 
SQLITE4_NOTFOUND
;

750 
	}
}

755 
	$kvmemSìk
(

756 
KVCurs‹
 *
pKVCurs‹
,

757 c⁄° 
KVByãAºay
 *
aKey
,

758 
KVSize
 
nKey
,

759 
dúe˘i⁄


761 
KVMemCurs‹
 *
pCur
;

762 
KVMemNode
 *
pNode
;

763 
KVMemNode
 *
pBe°
 = 0;

764 
c
;

765 
rc
 = 
SQLITE4_NOTFOUND
;

767 
	`kvmemRe£t
(
pKVCurs‹
);

768 
pCur
 = (
KVMemCurs‹
*)
pKVCurs‹
;

769 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

771 
pNode
 = 
pCur
->
pOw√r
->
pRoŸ
;

772  
pNode
 ){

773 
c
 = 
	`kvmemKeyCom∑ª
(
aKey
, 
nKey
, 
pNode
->aKey,ÖNode->nKey);

774 if–
c
==0 ){

775 
pBe°
 = 
pNode
;

776 
rc
 = 
SQLITE4_OK
;

777 
pNode
 = 0;

778 }if–
c
>0 ){

779 if–
dúe˘i⁄
<0 ){

780 
pBe°
 = 
pNode
;

781 
rc
 = 
SQLITE4_INEXACT
;

783 
pNode
 =ÖNode->
pA·î
;

785 if–
dúe˘i⁄
>0 ){

786 
pBe°
 = 
pNode
;

787 
rc
 = 
SQLITE4_INEXACT
;

789 
pNode
 =ÖNode->
pBef‹e
;

792 
	`kvmemNodeUƒef
(
pCur
->
ba£
.
pEnv
,ÖCur->
pNode
);

793 
	`kvmemD©aUƒef
(
pCur
->
ba£
.
pEnv
,ÖCur->
pD©a
);

794 if–
pBe°
 ){

795 
pCur
->
pNode
 = 
	`kvmemNodeRef
(
pBe°
);

796 
pCur
->
pD©a
 = 
	`kvmemD©aRef
(
pBe°
->pData);

802 if–
pCur
->
pD©a
==0 ){

803 if–
dúe˘i⁄
==0 ){

804 
rc
 = 
SQLITE4_NOTFOUND
;

806 if–(
dúe˘i⁄
>0 ? 
kvmemNextE¡ry
 : 
kvmemPªvE¡ry
)(
pKVCurs‹
) ){

807 
rc
 = 
SQLITE4_NOTFOUND
;

809 
rc
 = 
SQLITE4_INEXACT
;

815 
pCur
->
pNode
 = 0;

816 
pCur
->
pD©a
 = 0;

818 
	`as£π
–
rc
!=
SQLITE4_DONE
 );

819  
rc
;

820 
	}
}

830 
	$kvmemDñëe
(
KVCurs‹
 *
pKVCurs‹
){

831 
KVMemCurs‹
 *
pCur
;

832 
KVMemNode
 *
pNode
;

833 
KVMemChng
 *
pChng
;

834 
KVMem
 *
p
;

836 
pCur
 = (
KVMemCurs‹
*)
pKVCurs‹
;

837 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

838 
p
 = 
pCur
->
pOw√r
;

839 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

840 
	`as£π
–
p
->
ba£
.
iTønsLevñ
>=2 );

841 
pNode
 = 
pCur
->pNode;

842 if–
pNode
==0 )  
SQLITE4_OK
;

843 if–!
	`kvmemTønß˘i⁄Æ
(
p
) ){

844 
	`kvmemNodeUƒef
(
p
->
ba£
.
pEnv
, 
pNode
);

845 
pCur
->
pNode
 = 0;

846 
	`kvmemRemoveNode
(
p
, 
pNode
);

847 }if–
pNode
->
pD©a
==0 ){

849 }if–
pNode
->
mxTøns
<
p
->
ba£
.
iTønsLevñ
 ){

850 
pChng
 = 
	`kvmemNewChng
(
p
, 
pNode
);

851 if–
pChng
==0 )  
SQLITE4_NOMEM
;

852 
	`as£π
–
pNode
->
pD©a
==0 );

854 
	`kvmemD©aUƒef
(
pCur
->
ba£
.
pEnv
, 
pNode
->
pD©a
);

855 
pNode
->
pD©a
 = 0;

857  
SQLITE4_OK
;

858 
	}
}

863 
	$kvmemKey
(

864 
KVCurs‹
 *
pKVCurs‹
,

865 c⁄° 
KVByãAºay
 **
∑Key
,

866 
KVSize
 *
pN


868 
KVMemCurs‹
 *
pCur
;

869 
KVMemNode
 *
pNode
;

871 
pCur
 = (
KVMemCurs‹
*)
pKVCurs‹
;

872 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

873 
pNode
 = 
pCur
->pNode;

874 if–
pNode
==0 ){

875 *
∑Key
 = 0;

876 *
pN
 = 0;

877  
SQLITE4_DONE
;

879 *
∑Key
 = 
pNode
->
aKey
;

880 *
pN
 = 
pNode
->
nKey
;

881  
SQLITE4_OK
;

882 
	}
}

887 
	$kvmemD©a
(

888 
KVCurs‹
 *
pKVCurs‹
,

889 
KVSize
 
of°
,

890 
KVSize
 
n
,

891 c⁄° 
KVByãAºay
 **
∑D©a
,

892 
KVSize
 *
pND©a


894 
KVMemCurs‹
 *
pCur
;

895 
KVMemD©a
 *
pD©a
;

897 
pCur
 = (
KVMemCurs‹
*)
pKVCurs‹
;

898 
	`as£π
–
pCur
->
iMagicKVMemCur
==
SQLITE4_KVMEMCUR_MAGIC
 );

899 
pD©a
 = 
pCur
->pData;

900 if–
pD©a
==0 ){

901 *
∑D©a
 = 0;

902 *
pND©a
 = 0;

903  
SQLITE4_DONE
;

905 *
∑D©a
 = 
pD©a
->
a
 + 
of°
;

906 *
pND©a
 = 
pD©a
->
n
 - 
of°
;

907  
SQLITE4_OK
;

908 
	}
}

913 
	$kvmemClo£
(
KVSt‹e
 *
pKVSt‹e
){

914 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

915 
sqlôe4_ív
 *
pEnv
;

916 if–
p
==0 )  
SQLITE4_OK
;

917 
	`as£π
–
p
->
iMagicKVMemBa£
==
SQLITE4_KVMEMBASE_MAGIC
 );

918 
	`as£π
–
p
->
nCurs‹
==0 );

919 
pEnv
 = 
p
->
ba£
.pEnv;

920 if–
p
->
ba£
.
iTønsLevñ
 ){

921 
	`kvmemCommôPha£O√
(
pKVSt‹e
, 0);

922 
	`kvmemCommôPha£Two
(
pKVSt‹e
, 0);

924 
	`sqlôe4_‰ì
(
pEnv
, 
p
->
≠Log
);

925 
	`kvmemCÀ¨Tªe
(
pEnv
, 
p
->
pRoŸ
);

926 
	`mem£t
(
p
, 0, (*p));

927 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

928  
SQLITE4_OK
;

929 
	}
}

931 
	$kvmemC⁄åﬁ
(
KVSt‹e
 *
pKVSt‹e
, 
›
, *
pArg
){

932  
SQLITE4_NOTFOUND
;

933 
	}
}

935 
	$kvmemGëMëa
(
KVSt‹e
 *
pKVSt‹e
, *
piVÆ
){

936 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

937 *
piVÆ
 = 
p
->
iMëa
;

938  
SQLITE4_OK
;

939 
	}
}

941 
	$kvmemPutMëa
(
KVSt‹e
 *
pKVSt‹e
, 
iVÆ
){

942 
KVMem
 *
p
 = (KVMem*)
pKVSt‹e
;

943 
p
->
iMëa
 = 
iVÆ
;

944  
SQLITE4_OK
;

945 
	}
}

948 c⁄° 
KVSt‹eMëhods
 
	gkvmemMëhods
 = {

950 (
KVSt‹eMëhods
),

951 
kvmemRïœ˚
,

952 
kvmemO≥nCurs‹
,

953 
kvmemSìk
,

954 
kvmemNextE¡ry
,

955 
kvmemPªvE¡ry
,

956 
kvmemDñëe
,

957 
kvmemKey
,

958 
kvmemD©a
,

959 
kvmemRe£t
,

960 
kvmemClo£Curs‹
,

961 
kvmemBegö
,

962 
kvmemCommôPha£O√
,

963 
kvmemCommôPha£Two
,

964 
kvmemRﬁlback
,

965 
kvmemRevît
,

966 
kvmemClo£
,

967 
kvmemC⁄åﬁ
,

968 
kvmemGëMëa
,

969 
kvmemPutMëa


975 
	$sqlôe4KVSt‹eO≥nMem
(

976 
sqlôe4_ív
 *
pEnv
,

977 
KVSt‹e
 **
µKVSt‹e
,

978 c⁄° *
zName
,

979 
›íFœgs


981 
KVMem
 *
pNew
 = 
	`sqlôe4_mÆloc
(
pEnv
, (*pNew) );

982 if–
pNew
==0 )  
SQLITE4_NOMEM
;

983 
	`mem£t
(
pNew
, 0, (*pNew));

984 
pNew
->
ba£
.
pSt‹eVfunc
 = &
kvmemMëhods
;

985 
pNew
->
ba£
.
pEnv
 =ÖEnv;

986 
pNew
->
iMagicKVMemBa£
 = 
SQLITE4_KVMEMBASE_MAGIC
;

987 
pNew
->
›íFœgs
 = openFlags;

988 *
µKVSt‹e
 = (
KVSt‹e
*)
pNew
;

989  
SQLITE4_OK
;

990 
	}
}

	@src/legacy.c

18 
	~"sqlôeI¡.h
"

30 
sqlôe4_exec
(

31 
sqlôe4
 *
db
,

32 c⁄° *
zSql
,

33 (*
xCÆl
)(*,,
sqlôe4_vÆue
**,const **),

34 *
pArg


36 
rc
 = 
SQLITE4_OK
;

37 
nRëry
 = 0;

38 
bAb‹t
 = 0;

40 if–!
	`sqlôe4Sa„tyCheckOk
(
db
ËË 
SQLITE4_MISUSE_BKPT
;

41 if–
zSql
==0 ) zSql = "";

43 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

44 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_OK
, 0);

48  
zSql
[0] && 
bAb‹t
==0

49 && (
rc
==
SQLITE4_OK
 || (rc==
SQLITE4_SCHEMA
 && (++
nRëry
)<2))

51 
nU£d
;

52 
nCﬁ
;

53 
sqlôe4_°mt
 *
pStmt
 = 0;

54 c⁄° **
azCﬁ
 = 0;

55 
sqlôe4_vÆue
 **
≠VÆ
 = 0;

57 
pStmt
 = 0;

58 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, &
nU£d
);

59 
	`as£π
–
rc
==
SQLITE4_OK
 || 
pStmt
==0 );

60 if–
rc
!=
SQLITE4_OK
 ){

63 if–!
pStmt
 ){

65 
zSql
 +
nU£d
;

69 
nCﬁ
 = 
	`sqlôe4_cﬁumn_cou¡
(
pStmt
);

73 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

74 if–
xCÆl
 && 
SQLITE4_ROW
==
rc
 ){

75 if–
azCﬁ
==0 ){

76 
nAŒoc
;

78 
nAŒoc
 = ((*Ë+ (
sqlôe4_vÆue
 *)Ë* 
nCﬁ
;

79 
azCﬁ
 = (c⁄° **)
	`sqlôe4DbMÆlocZîo
(
db
, 
nAŒoc
);

80 if–
azCﬁ
 ){

81 
i
;

82 
≠VÆ
 = (
sqlôe4_vÆue
 **)&
azCﬁ
[
nCﬁ
];

83 
i
=0; i<
nCﬁ
; i++){

84 
azCﬁ
[
i
] = 
	`sqlôe4_cﬁumn_«me
(
pStmt
, i);

87 
	`as£π
–
azCﬁ
[
i
]!=0 );

92 if–
azCﬁ
 ){

93 
i
;

94 
i
=0; i<
nCﬁ
; i++){

95 
≠VÆ
[
i
] = 
	`sqlôe4CﬁumnVÆue
(
pStmt
, i);

96 
	`as£π
–
≠VÆ
[
i
]!=0 );

98 
bAb‹t
 = 
	`xCÆl
(
pArg
, 
nCﬁ
, 
≠VÆ
, 
azCﬁ
);

102 if–
bAb‹t
 || 
rc
!=
SQLITE4_ROW
 ){

103 
rc
 = 
	`sqlôe4VdbeFöÆize
((
Vdbe
 *)
pStmt
);

104 
pStmt
 = 0;

105 if–
rc
!=
SQLITE4_SCHEMA
 ){

106 
nRëry
 = 0;

107 
zSql
 +
nU£d
;

108  
	`sqlôe4Is•a˚
(
zSql
[0]) ) zSql++;

110 
	`as£π
–
rc
!=
SQLITE4_ROW
 );

112 } 
rc
==
SQLITE4_ROW
 );

114 
	`sqlôe4DbFªe
(
db
, 
azCﬁ
);

117 if–
bAb‹t
 ) 
rc
 = 
SQLITE4_ABORT
;

118 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

120 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

121  
rc
;

122 
	}
}

	@src/lempar.c

12 
	~<°dio.h
>

13 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

24 
	}
%%

27 #i‚de‡
INTERFACE


28 
	#INTERFACE
 1

	)

64 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

65 #
deföe
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

66 #
deföe
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

67 #
deföe
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

71 c⁄° 
YYMINORTYPE
 
	gyyzîomö‹
 = { 0 };

81 #
i‚def
 
yyã°ˇ£


82 #
deföe
 
	`yyã°ˇ£
(
X
)

83 #
ídif


133 
	}
%%

145 #ifde‡
YYFALLBACK


146 c⁄° 
YYCODETYPE
 
	gyyFÆlback
[] = {

147 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

149 #
ídif


163 
	syySèckE¡ry
 {

164 
YYACTIONTYPE
 
	m°©ío
;

165 
YYCODETYPE
 
	mmaj‹
;

167 
YYMINORTYPE
 
	mmö‹
;

170 
yySèckE¡ry
 
	tyySèckE¡ry
;

174 
	syyP¨£r
 {

175 
	myyidx
;

176 #
ifdef
 
YYTRACKMAXSTACKDEPTH


177 
	myyidxMax
;

178 #
ídif


179 
	myyîr˙t
;

180 
	mP¨£ARG_SDECL


181 #
YYSTACKDEPTH
<=0

182 
	myy°ksz
;

183 
yySèckE¡ry
 *
	myy°ack
;

185 
yySèckE¡ry
 
	myy°ack
[
YYSTACKDEPTH
];

186 #
ídif


187 *
	mpEnv
;

189 
yyP¨£r
 
	tyyP¨£r
;

191 #
i‚def
 
NDEBUG


192 #
ö˛ude
 <
°dio
.
h
>

193 
FILE
 *
	gyyTø˚FILE
 = 0;

194 *
	gyyTø˚Prom±
 = 0;

195 #
ídif


197 #
i‚def
 
NDEBUG


215 
	`P¨£Tø˚
(
FILE
 *
	gTø˚FILE
, *
	gzTø˚Prom±
){

216 
	gyyTø˚FILE
 = 
Tø˚FILE
;

217 
	gyyTø˚Prom±
 = 
zTø˚Prom±
;

218 if–
	gyyTø˚FILE
==0 ) 
yyTø˚Prom±
 = 0;

219 if–
	gyyTø˚Prom±
==0 ) 
yyTø˚FILE
 = 0;

221 #
ídif


223 #
i‚def
 
NDEBUG


226 c⁄° *c⁄° 
	gyyTokíName
[] = {

227 
	}
%%

231 #i‚de‡
NDEBUG


234 c⁄° *c⁄° 
	gyyRuÀName
[] = {

235 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

237 #
ídif


240 #
YYSTACKDEPTH
<=0

244 
	`yyGrowSèck
(
yyP¨£r
 *
	gp
){

245 
	g√wSize
;

246 
yySèckE¡ry
 *
	gpNew
;

248 
	g√wSize
 = 
p
->
yy°ksz
*2 + 100;

249 
	gpNew
 = 
	`ªÆloc
(
p
->
yy°ack
, 
√wSize
*(pNew[0]));

250 if–
	gpNew
 ){

251 
	gp
->
	gyy°ack
 = 
pNew
;

252 
	gp
->
	gyy°ksz
 = 
√wSize
;

253 #
i‚def
 
NDEBUG


254 if–
	gyyTø˚FILE
 ){

255 
	`Ârötf
(
	gyyTø˚FILE
,"%sStack growsÅo %dÉntries!\n",

256 
	gyyTø˚Prom±
, 
	gp
->
	gyy°ksz
);

258 #
ídif


261 #
ídif


275 *
	`P¨£AŒoc
(*(*
	gmÆlocProc
)(*,
	gsize_t
), *
	gpEnv
){

276 
yyP¨£r
 *
	gpP¨£r
;

277 
	gpP¨£r
 = (
yyP¨£r
*)(*
mÆlocProc
)(
pEnv
, (
	gsize_t
)(
	gyyP¨£r
) );

278 if–
	gpP¨£r
 ){

279 
	gpP¨£r
->
	gyyidx
 = -1;

280 #
ifdef
 
YYTRACKMAXSTACKDEPTH


281 
	gpP¨£r
->
	gyyidxMax
 = 0;

282 #
ídif


283 #
YYSTACKDEPTH
<=0

284 
	gpP¨£r
->
	gyy°ack
 = 
NULL
;

285 
	gpP¨£r
->
	gyy°ksz
 = 0;

286 
	`yyGrowSèck
(
	gpP¨£r
);

287 #
ídif


288 
	gpP¨£r
->
	gpEnv
 = 
pEnv
;

290  
	gpP¨£r
;

298 
	`yy_de°ru˘‹
(

299 
yyP¨£r
 *
	gyypP¨£r
,

300 
YYCODETYPE
 
	gyymaj‹
,

301 
YYMINORTYPE
 *
	gyypmö‹


303 
	gP¨£ARG_FETCH
;

304  
	gyymaj‹
 ){

315 
	}
%%

328 
	$yy_p›_∑r£r_°ack
(
yyP¨£r
 *
pP¨£r
){

329 
YYCODETYPE
 
yymaj‹
;

330 
yySèckE¡ry
 *
yytos
 = &
pP¨£r
->
yy°ack
[pP¨£r->
yyidx
];

334 if–
	`NEVER
(
pP¨£r
->
yyidx
<0) )  0;

335 #i‚de‡
NDEBUG


336 if–
yyTø˚FILE
 && 
pP¨£r
->
yyidx
>=0 ){

337 
	`Ârötf
(
yyTø˚FILE
,"%sPopping %s\n",

338 
yyTø˚Prom±
,

339 
yyTokíName
[
yytos
->
maj‹
]);

342 
yymaj‹
 = 
yytos
->
maj‹
;

343 
	`yy_de°ru˘‹
(
pP¨£r
, 
yymaj‹
, &
yytos
->
mö‹
);

344 
pP¨£r
->
yyidx
--;

345  
yymaj‹
;

346 
	}
}

360 
P¨£Fªe
(

361 *
p
,

362 (*
‰ìProc
)(*,*)

364 
yyP¨£r
 *
pP¨£r
 = (yyP¨£r*)
p
;

367 if–
	`NEVER
(
pP¨£r
==0) ) ;

368  
pP¨£r
->
yyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(pParser);

369 #i‡
YYSTACKDEPTH
<=0

370 
	`‰ì
(
pP¨£r
->
yy°ack
);

372 (*
‰ìProc
)(
pP¨£r
->
pEnv
, (*)pParser);

373 
	}
}

378 #ifde‡
YYTRACKMAXSTACKDEPTH


379 
	$P¨£SèckPók
(*
p
){

380 
yyP¨£r
 *
pP¨£r
 = (yyP¨£r*)
p
;

381  
pP¨£r
->
yyidxMax
;

382 
	}
}

393 
	$yy_föd_shi·_a˘i⁄
(

394 
yyP¨£r
 *
pP¨£r
,

395 
YYCODETYPE
 
iLookAhód


397 
i
;

398 
°©ío
 = 
pP¨£r
->
yy°ack
[pP¨£r->
yyidx
].stateno;

400 if–
°©ío
>
YY_SHIFT_COUNT


401 || (
i
 = 
yy_shi·_of°
[
°©ío
])==
YY_SHIFT_USE_DFLT
 ){

402  
yy_deÁu…
[
°©ío
];

404 
	`as£π
–
iLookAhód
!=
YYNOCODE
 );

405 
i
 +
iLookAhód
;

406 if–
i
<0 || i>=
YY_ACTTAB_COUNT
 || 
yy_lookahód
[i]!=
iLookAhód
 ){

407 if–
iLookAhód
>0 ){

408 #ifde‡
YYFALLBACK


409 
YYCODETYPE
 
iFÆlback
;

410 if–
iLookAhód
<(
yyFÆlback
)/(yyFallback[0])

411 && (
iFÆlback
 = 
yyFÆlback
[
iLookAhód
])!=0 ){

412 #i‚de‡
NDEBUG


413 if–
yyTø˚FILE
 ){

414 
	`Ârötf
(
yyTø˚FILE
, "%sFALLBACK %s => %s\n",

415 
yyTø˚Prom±
, 
yyTokíName
[
iLookAhód
], yyTokíName[
iFÆlback
]);

418  
	`yy_föd_shi·_a˘i⁄
(
pP¨£r
, 
iFÆlback
);

421 #ifde‡
YYWILDCARD


423 
j
 = 
i
 - 
iLookAhód
 + 
YYWILDCARD
;

425 #i‡
YY_SHIFT_MIN
+
YYWILDCARD
<0

426 
j
>=0 &&

428 #i‡
YY_SHIFT_MAX
+
YYWILDCARD
>=
YY_ACTTAB_COUNT


429 
j
<
YY_ACTTAB_COUNT
 &&

431 
yy_lookahód
[
j
]==
YYWILDCARD


433 #i‚de‡
NDEBUG


434 if–
yyTø˚FILE
 ){

435 
	`Ârötf
(
yyTø˚FILE
, "%sWILDCARD %s => %s\n",

436 
yyTø˚Prom±
, 
yyTokíName
[
iLookAhód
], yyTokíName[
YYWILDCARD
]);

439  
yy_a˘i⁄
[
j
];

444  
yy_deÁu…
[
°©ío
];

446  
yy_a˘i⁄
[
i
];

448 
	}
}

458 
	$yy_föd_ªdu˚_a˘i⁄
(

459 
°©ío
,

460 
YYCODETYPE
 
iLookAhód


462 
i
;

463 #ifde‡
YYERRORSYMBOL


464 if–
°©ío
>
YY_REDUCE_COUNT
 ){

465  
yy_deÁu…
[
°©ío
];

468 
	`as£π
–
°©ío
<=
YY_REDUCE_COUNT
 );

470 
i
 = 
yy_ªdu˚_of°
[
°©ío
];

471 
	`as£π
–
i
!=
YY_REDUCE_USE_DFLT
 );

472 
	`as£π
–
iLookAhód
!=
YYNOCODE
 );

473 
i
 +
iLookAhód
;

474 #ifde‡
YYERRORSYMBOL


475 if–
i
<0 || i>=
YY_ACTTAB_COUNT
 || 
yy_lookahód
[i]!=
iLookAhód
 ){

476  
yy_deÁu…
[
°©ío
];

479 
	`as£π
–
i
>=0 && i<
YY_ACTTAB_COUNT
 );

480 
	`as£π
–
yy_lookahód
[
i
]==
iLookAhód
 );

482  
yy_a˘i⁄
[
i
];

483 
	}
}

488 
	$yySèckOvîÊow
(
yyP¨£r
 *
yypP¨£r
, 
YYMINORTYPE
 *
yypMö‹
){

489 
P¨£ARG_FETCH
;

490 
yypP¨£r
->
yyidx
--;

491 #i‚de‡
NDEBUG


492 if–
yyTø˚FILE
 ){

493 
	`Ârötf
(
yyTø˚FILE
,"%sSèck OvîÊow!\n",
yyTø˚Prom±
);

496  
yypP¨£r
->
yyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(yypParser);

499 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

500 
P¨£ARG_STORE
;

501 
	}
}

506 
	`yy_shi·
(

507 
yyP¨£r
 *
	gyypP¨£r
,

508 
	gyyNewSèã
,

509 
	gyyMaj‹
,

510 
YYMINORTYPE
 *
	gyypMö‹


512 
yySèckE¡ry
 *
	gyytos
;

513 
	gyypP¨£r
->
	gyyidx
++;

514 #
ifdef
 
YYTRACKMAXSTACKDEPTH


515 if–
	gyypP¨£r
->
	gyyidx
>yypP¨£r->
	gyyidxMax
 ){

516 
	gyypP¨£r
->
	gyyidxMax
 = 
yypP¨£r
->
yyidx
;

518 #
ídif


519 #
YYSTACKDEPTH
>0

520 if–
	gyypP¨£r
->
	gyyidx
>=
YYSTACKDEPTH
 ){

521 
	`yySèckOvîÊow
(
yypP¨£r
, 
yypMö‹
);

525 if–
	gyypP¨£r
->
	gyyidx
>=
yypP¨£r
->
yy°ksz
 ){

526 
	`yyGrowSèck
(
yypP¨£r
);

527 if–
	gyypP¨£r
->
	gyyidx
>=
yypP¨£r
->
yy°ksz
 ){

528 
	`yySèckOvîÊow
(
yypP¨£r
, 
yypMö‹
);

532 #
ídif


533 
	gyytos
 = &
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
];

534 
	gyytos
->
	g°©ío
 = (
YYACTIONTYPE
)
yyNewSèã
;

535 
	gyytos
->
	gmaj‹
 = (
YYCODETYPE
)
yyMaj‹
;

536 
	gyytos
->
	gmö‹
 = *
yypMö‹
;

537 #
i‚def
 
NDEBUG


538 if–
	gyyTø˚FILE
 && 
	gyypP¨£r
->
	gyyidx
>0 ){

539 
	gi
;

540 
	`Ârötf
(
	gyyTø˚FILE
,"%sShi· %d\n",
	gyyTø˚Prom±
,
	gyyNewSèã
);

541 
	`Ârötf
(
	gyyTø˚FILE
,"%sSèck:",
	gyyTø˚Prom±
);

542 
	gi
=1; i<=
yypP¨£r
->
yyidx
; i++)

543 
	`Ârötf
(
	gyyTø˚FILE
," %s",
	gyyTokíName
[
yypP¨£r
->
yy°ack
[
i
].
	gmaj‹
]);

544 
	`Ârötf
(
	gyyTø˚FILE
,"\n");

546 #
ídif


553 
YYCODETYPE
 
	mlhs
;

554 
	mƒhs
;

555 } 
	gyyRuÀInfo
[] = {

556 
	}
%%

559 
yy_ac˚±
(
yyP¨£r
*);

565 
	$yy_ªdu˚
(

566 
yyP¨£r
 *
yypP¨£r
,

567 
yyruÀno


569 
yygŸo
;

570 
yya˘
;

571 
YYMINORTYPE
 
yygŸomö‹
;

572 
yySèckE¡ry
 *
yym•
;

573 
yysize
;

574 
P¨£ARG_FETCH
;

575 
yym•
 = &
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
];

576 #i‚de‡
NDEBUG


577 if–
yyTø˚FILE
 && 
yyruÀno
>=0

578 && 
yyruÀno
<()((
yyRuÀName
)/(yyRuleName[0])) ){

579 
	`Ârötf
(
yyTø˚FILE
, "%sRedu˚ [%s].\n", 
yyTø˚Prom±
,

580 
yyRuÀName
[
yyruÀno
]);

599 
yygŸomö‹
 = 
yyzîomö‹
;

602  
yyruÀno
 ){

611 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

612 
	}
};

613 
	gyygŸo
 = 
yyRuÀInfo
[
yyruÀno
].
lhs
;

614 
	gyysize
 = 
yyRuÀInfo
[
yyruÀno
].
ƒhs
;

615 
	gyypP¨£r
->
	gyyidx
 -
yysize
;

616 
	gyya˘
 = 
	`yy_föd_ªdu˚_a˘i⁄
(
yym•
[-
yysize
].
°©ío
,(
	gYYCODETYPE
)
	gyygŸo
);

617 if–
	gyya˘
 < 
	gYYNSTATE
 ){

618 #
ifdef
 
NDEBUG


623 if–
	gyysize
 ){

624 
	gyypP¨£r
->
	gyyidx
++;

625 
	gyym•
 -
yysize
-1;

626 
	gyym•
->
	g°©ío
 = (
YYACTIONTYPE
)
yya˘
;

627 
	gyym•
->
	gmaj‹
 = (
YYCODETYPE
)
yygŸo
;

628 
	gyym•
->
	gmö‹
 = 
yygŸomö‹
;

630 #
ídif


632 
	`yy_shi·
(
	gyypP¨£r
,
	gyya˘
,
	gyygŸo
,&
	gyygŸomö‹
);

635 
	`as£π
–
	gyya˘
 =
YYNSTATE
 + 
YYNRULE
 + 1 );

636 
	`yy_ac˚±
(
	gyypP¨£r
);

643 #
i‚def
 
YYNOERRORRECOVERY


644 
	`yy_∑r£_Áûed
(

645 
yyP¨£r
 *
	gyypP¨£r


647 
	gP¨£ARG_FETCH
;

648 #
i‚def
 
NDEBUG


649 if–
	gyyTø˚FILE
 ){

650 
	`Ârötf
(
	gyyTø˚FILE
,"%sFaû!\n",
	gyyTø˚Prom±
);

652 #
ídif


653  
	gyypP¨£r
->
	gyyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(
yypP¨£r
);

656 
	}
%%

657 
	gP¨£ARG_STORE
;

664 
	$yy_sy¡ax_îr‹
(

665 
yyP¨£r
 *
yypP¨£r
,

666 
yymaj‹
,

667 
YYMINORTYPE
 
yymö‹


669 
P¨£ARG_FETCH
;

670 
	#TOKEN
 (
yymö‹
.
yy0
)

	)

671 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

672 
P¨£ARG_STORE
;

673 
	}
}

678 
	`yy_ac˚±
(

679 
yyP¨£r
 *
	gyypP¨£r


681 
	gP¨£ARG_FETCH
;

682 #
i‚def
 
NDEBUG


683 if–
	gyyTø˚FILE
 ){

684 
	`Ârötf
(
	gyyTø˚FILE
,"%sAc˚±!\n",
	gyyTø˚Prom±
);

686 #
ídif


687  
	gyypP¨£r
->
	gyyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(
yypP¨£r
);

690 
	}
%%

691 
	gP¨£ARG_STORE
;

713 
	$P¨£
(

714 *
yyp
,

715 
yymaj‹
,

716 
P¨£TOKENTYPE
 
yymö‹


717 
P¨£ARG_PDECL


719 
YYMINORTYPE
 
yymö‹uni⁄
;

720 
yya˘
;

721 #i‡!
	`deföed
(
YYERRORSYMBOL
Ë&& !deföed(
YYNOERRORRECOVERY
)

722 
yyídoföput
;

724 #ifde‡
YYERRORSYMBOL


725 
yyîr‹hô
 = 0;

727 
yyP¨£r
 *
yypP¨£r
;

730 
yypP¨£r
 = (
yyP¨£r
*)
yyp
;

731 if–
yypP¨£r
->
yyidx
<0 ){

732 #i‡
YYSTACKDEPTH
<=0

733 if–
yypP¨£r
->
yy°ksz
 <=0 ){

735 
yymö‹uni⁄
 = 
yyzîomö‹
;

736 
	`yySèckOvîÊow
(
yypP¨£r
, &
yymö‹uni⁄
);

740 
yypP¨£r
->
yyidx
 = 0;

741 
yypP¨£r
->
yyîr˙t
 = -1;

742 
yypP¨£r
->
yy°ack
[0].
°©ío
 = 0;

743 
yypP¨£r
->
yy°ack
[0].
maj‹
 = 0;

745 
yymö‹uni⁄
.
yy0
 = 
yymö‹
;

746 #i‡!
	`deföed
(
YYERRORSYMBOL
Ë&& !deföed(
YYNOERRORRECOVERY
)

747 
yyídoföput
 = (
yymaj‹
==0);

749 
P¨£ARG_STORE
;

751 #i‚de‡
NDEBUG


752 if–
yyTø˚FILE
 ){

753 
	`Ârötf
(
yyTø˚FILE
,"%sI≈uà%s\n",
yyTø˚Prom±
,
yyTokíName
[
yymaj‹
]);

758 
yya˘
 = 
	`yy_föd_shi·_a˘i⁄
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
);

759 if–
yya˘
<
YYNSTATE
 ){

760 
	`yy_shi·
(
yypP¨£r
,
yya˘
,
yymaj‹
,&
yymö‹uni⁄
);

761 
yypP¨£r
->
yyîr˙t
--;

762 
yymaj‹
 = 
YYNOCODE
;

763 }if–
yya˘
 < 
YYNSTATE
 + 
YYNRULE
 ){

764 
	`yy_ªdu˚
(
yypP¨£r
,
yya˘
-
YYNSTATE
);

766 
	`as£π
–
yya˘
 =
YY_ERROR_ACTION
 );

767 #ifde‡
YYERRORSYMBOL


768 
yymx
;

770 #i‚de‡
NDEBUG


771 if–
yyTø˚FILE
 ){

772 
	`Ârötf
(
yyTø˚FILE
,"%sSy¡ax Eº‹!\n",
yyTø˚Prom±
);

775 #ifde‡
YYERRORSYMBOL


795 if–
yypP¨£r
->
yyîr˙t
<0 ){

796 
	`yy_sy¡ax_îr‹
(
yypP¨£r
,
yymaj‹
,
yymö‹uni⁄
);

798 
yymx
 = 
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
].
maj‹
;

799 if–
yymx
==
YYERRORSYMBOL
 || 
yyîr‹hô
 ){

800 #i‚de‡
NDEBUG


801 if–
yyTø˚FILE
 ){

802 
	`Ârötf
(
yyTø˚FILE
,"%sDiscard inputÅoken %s\n",

803 
yyTø˚Prom±
,
yyTokíName
[
yymaj‹
]);

806 
	`yy_de°ru˘‹
(
yypP¨£r
, (
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

807 
yymaj‹
 = 
YYNOCODE
;

810 
yypP¨£r
->
yyidx
 >= 0 &&

811 
yymx
 !
YYERRORSYMBOL
 &&

812 (
yya˘
 = 
	`yy_föd_ªdu˚_a˘i⁄
(

813 
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
].
°©ío
,

814 
YYERRORSYMBOL
)Ë>
YYNSTATE


816 
	`yy_p›_∑r£r_°ack
(
yypP¨£r
);

818 if–
yypP¨£r
->
yyidx
 < 0 || 
yymaj‹
==0 ){

819 
	`yy_de°ru˘‹
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

820 
	`yy_∑r£_Áûed
(
yypP¨£r
);

821 
yymaj‹
 = 
YYNOCODE
;

822 }if–
yymx
!=
YYERRORSYMBOL
 ){

823 
YYMINORTYPE
 
u2
;

824 
u2
.
YYERRSYMDT
 = 0;

825 
	`yy_shi·
(
yypP¨£r
,
yya˘
,
YYERRORSYMBOL
,&
u2
);

828 
yypP¨£r
->
yyîr˙t
 = 3;

829 
yyîr‹hô
 = 1;

830 #ñi‡
	`deföed
(
YYNOERRORRECOVERY
)

838 
	`yy_sy¡ax_îr‹
(
yypP¨£r
,
yymaj‹
,
yymö‹uni⁄
);

839 
	`yy_de°ru˘‹
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

840 
yymaj‹
 = 
YYNOCODE
;

852 if–
yypP¨£r
->
yyîr˙t
<=0 ){

853 
	`yy_sy¡ax_îr‹
(
yypP¨£r
,
yymaj‹
,
yymö‹uni⁄
);

855 
yypP¨£r
->
yyîr˙t
 = 3;

856 
	`yy_de°ru˘‹
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

857 if–
yyídoföput
 ){

858 
	`yy_∑r£_Áûed
(
yypP¨£r
);

860 
yymaj‹
 = 
YYNOCODE
;

863 } 
yymaj‹
!=
YYNOCODE
 && 
yypP¨£r
->
yyidx
>=0 );

865 
	}
}

	@src/lsm.h

15 #i‚de‡
_LSM_H


16 
	#_LSM_H


	)

17 
	~<°ddef.h
>

18 
	~"sqlôe4.h
"

19 #ifde‡
__˝lu•lus


26 
lsm_com¥ess
 
	tlsm_com¥ess
;

27 
lsm_com¥ess_Á˘‹y
 
	tlsm_com¥ess_Á˘‹y
;

28 
lsm_curs‹
 
	tlsm_curs‹
;

29 
lsm_db
 
	tlsm_db
;

30 
lsm_ív
 
	tlsm_ív
;

31 
lsm_fûe
 
	tlsm_fûe
;

32 
lsm_muãx
 
	tlsm_muãx
;

35 
	tlsm_i64
;

38 
	#LSM_LOCK_UNLOCK
 0

	)

39 
	#LSM_LOCK_SHARED
 1

	)

40 
	#LSM_LOCK_EXCL
 2

	)

43 
	#LSM_OPEN_READONLY
 0x0001

	)

50 
	slsm_ív
 {

51 
nByã
;

52 
iVîsi⁄
;

54 *
pVfsCtx
;

55 (*
xFuŒ∑th
)(
lsm_ív
*, const *, *, *);

56 (*
xO≥n
)(
lsm_ív
*, c⁄° *, 
Êags
, 
lsm_fûe
 **);

57 (*
xRód
)(
lsm_fûe
 *, 
lsm_i64
, *, );

58 (*
xWrôe
)(
lsm_fûe
 *, 
lsm_i64
, *, );

59 (*
xTrunˇã
)(
lsm_fûe
 *, 
lsm_i64
);

60 (*
xSync
)(
lsm_fûe
 *);

61 (*
xSe˘‹Size
)(
lsm_fûe
 *);

62 (*
xRem≠
)(
lsm_fûe
 *, 
lsm_i64
, **,Üsm_i64*);

63 (*
xFûeid
)(
lsm_fûe
 *, *
pBuf
, *
≤Buf
);

64 (*
xClo£
)(
lsm_fûe
 *);

65 (*
xU∆ök
)(
lsm_ív
*, const *);

66 (*
xLock
)(
lsm_fûe
*, , );

67 (*
xTe°Lock
)(
lsm_fûe
*, , , );

68 (*
xShmM≠
)(
lsm_fûe
*, , , **);

69 (*
xShmB¨rõr
)();

70 (*
xShmUnm≠
)(
lsm_fûe
*, );

72 *
pMemCtx
;

73 *(*
xMÆloc
)(
lsm_ív
*, );

74 *(*
xRóŒoc
)(
lsm_ív
*, *, );

75 (*
xFªe
)(
lsm_ív
*, *);

76 
sqlôe4_size_t
 (*
xSize
)(
lsm_ív
*, *);

78 *
pMuãxCtx
;

79 (*
xMuãxSètic
)(
lsm_ív
*,,
lsm_muãx
**);

80 (*
xMuãxNew
)(
lsm_ív
*, 
lsm_muãx
**);

81 (*
xMuãxDñ
)(
lsm_muãx
 *);

82 (*
xMuãxE¡î
)(
lsm_muãx
 *);

83 (*
xMuãxTry
)(
lsm_muãx
 *);

84 (*
xMuãxLóve
)(
lsm_muãx
 *);

85 (*
xMuãxHñd
)(
lsm_muãx
 *);

86 (*
xMuãxNŸHñd
)(
lsm_muãx
 *);

88 (*
xSÀï
)(
lsm_ív
*, 
mi¸o£c⁄ds
);

97 
	#LSM_MUTEX_GLOBAL
 1

	)

98 
	#LSM_MUTEX_HEAP
 2

	)

103 
	#LSM_OK
 0

	)

104 
	#LSM_ERROR
 1

	)

105 
	#LSM_BUSY
 5

	)

106 
	#LSM_NOMEM
 7

	)

107 
	#LSM_READONLY
 8

	)

108 
	#LSM_IOERR
 10

	)

109 
	#LSM_CORRUPT
 11

	)

110 
	#LSM_FULL
 13

	)

111 
	#LSM_CANTOPEN
 14

	)

112 
	#LSM_PROTOCOL
 15

	)

113 
	#LSM_MISUSE
 21

	)

115 
	#LSM_MISMATCH
 50

	)

118 
	#LSM_IOERR_NOENT
 (
LSM_IOERR
 | (1<<8))

	)

125 
lsm_√w
(
lsm_ív
*, 
lsm_db
 **
µDb
);

126 
lsm_˛o£
(
lsm_db
 *
pDb
);

131 
lsm_›í
(
lsm_db
 *
pDb
, c⁄° *
zFûíame
);

140 
lsm_ív
 *
lsm_gë_ív
(
lsm_db
 *
pDb
);

146 
lsm_ív
 *
lsm_deÁu…_ív
();

154 
lsm_c⁄fig
(
lsm_db
 *, , ...);

285 
	#LSM_CONFIG_AUTOFLUSH
 1

	)

286 
	#LSM_CONFIG_PAGE_SIZE
 2

	)

287 
	#LSM_CONFIG_SAFETY
 3

	)

288 
	#LSM_CONFIG_BLOCK_SIZE
 4

	)

289 
	#LSM_CONFIG_AUTOWORK
 5

	)

290 
	#LSM_CONFIG_MMAP
 7

	)

291 
	#LSM_CONFIG_USE_LOG
 8

	)

292 
	#LSM_CONFIG_AUTOMERGE
 9

	)

293 
	#LSM_CONFIG_MAX_FREELIST
 10

	)

294 
	#LSM_CONFIG_MULTIPLE_PROCESSES
 11

	)

295 
	#LSM_CONFIG_AUTOCHECKPOINT
 12

	)

296 
	#LSM_CONFIG_SET_COMPRESSION
 13

	)

297 
	#LSM_CONFIG_GET_COMPRESSION
 14

	)

298 
	#LSM_CONFIG_SET_COMPRESSION_FACTORY
 15

	)

299 
	#LSM_CONFIG_READONLY
 16

	)

301 
	#LSM_SAFETY_OFF
 0

	)

302 
	#LSM_SAFETY_NORMAL
 1

	)

303 
	#LSM_SAFETY_FULL
 2

	)

308 
	slsm_com¥ess
 {

309 *
pCtx
;

310 
iId
;

311 (*
xBound
)(*, 
nSrc
);

312 (*
xCom¥ess
)(*, *, *, const *, );

313 (*
xUncom¥ess
)(*, *, *, const *, );

314 (*
xFªe
)(*
pCtx
);

317 
	slsm_com¥ess_Á˘‹y
 {

318 *
pCtx
;

319 (*
xFa˘‹y
)(*, 
lsm_db
 *, );

320 (*
xFªe
)(*
pCtx
);

323 
	#LSM_COMPRESSION_EMPTY
 0

	)

324 
	#LSM_COMPRESSION_NONE
 1

	)

333 *
lsm_mÆloc
(
lsm_ív
*, 
size_t
);

334 *
lsm_ªÆloc
(
lsm_ív
*, *, 
size_t
);

335 
lsm_‰ì
(
lsm_ív
*, *);

342 
lsm_öfo
(
lsm_db
 *, , ...);

344 
lsm_gë_u£r_vîsi⁄
(
lsm_db
 *, *);

345 
lsm_£t_u£r_vîsi⁄
(
lsm_db
 *, );

464 
	#LSM_INFO_NWRITE
 1

	)

465 
	#LSM_INFO_NREAD
 2

	)

466 
	#LSM_INFO_DB_STRUCTURE
 3

	)

467 
	#LSM_INFO_LOG_STRUCTURE
 4

	)

468 
	#LSM_INFO_ARRAY_STRUCTURE
 5

	)

469 
	#LSM_INFO_PAGE_ASCII_DUMP
 6

	)

470 
	#LSM_INFO_PAGE_HEX_DUMP
 7

	)

471 
	#LSM_INFO_FREELIST
 8

	)

472 
	#LSM_INFO_ARRAY_PAGES
 9

	)

473 
	#LSM_INFO_CHECKPOINT_SIZE
 10

	)

474 
	#LSM_INFO_TREE_SIZE
 11

	)

475 
	#LSM_INFO_FREELIST_SIZE
 12

	)

476 
	#LSM_INFO_COMPRESSION_ID
 13

	)

505 
lsm_begö
(
lsm_db
 *
pDb
, 
iLevñ
);

506 
lsm_commô
(
lsm_db
 *
pDb
, 
iLevñ
);

507 
lsm_rﬁlback
(
lsm_db
 *
pDb
, 
iLevñ
);

515 
lsm_ö£π
(
lsm_db
*, c⁄° *
pKey
, 
nKey
, c⁄° *
pVÆ
, 
nVÆ
);

521 
lsm_dñëe
(
lsm_db
 *, c⁄° *
pKey
, 
nKey
);

530 
lsm_dñëe_ønge
(
lsm_db
 *,

531 c⁄° *
pKey1
, 
nKey1
, c⁄° *
pKey2
, 
nKey2


539 
lsm_w‹k
(
lsm_db
 *
pDb
, 
nMîge
, 
nKB
, *
≤Wrôe
);

541 
lsm_Êush
(
lsm_db
 *
pDb
);

554 
lsm_checkpoöt
(
lsm_db
 *
pDb
, *
≤KB
);

561 
lsm_c§_›í
(
lsm_db
 *
pDb
, 
lsm_curs‹
 **
µC§
);

562 
lsm_c§_˛o£
(
lsm_curs‹
 *
pC§
);

606 
lsm_c§_£ek
(
lsm_curs‹
 *
pC§
, c⁄° *
pKey
, 
nKey
, 
eSìk
);

608 
lsm_c§_fú°
(
lsm_curs‹
 *
pC§
);

609 
lsm_c§_œ°
(
lsm_curs‹
 *
pC§
);

634 
lsm_c§_√xt
(
lsm_curs‹
 *
pC§
);

635 
lsm_c§_¥ev
(
lsm_curs‹
 *
pC§
);

640 
	#LSM_SEEK_LEFAST
 -2

	)

641 
	#LSM_SEEK_LE
 -1

	)

642 
	#LSM_SEEK_EQ
 0

	)

643 
	#LSM_SEEK_GE
 1

	)

650 
lsm_c§_vÆid
(
lsm_curs‹
 *
pC§
);

651 
lsm_c§_key
(
lsm_curs‹
 *
pC§
, c⁄° **
µKey
, *
≤Key
);

652 
lsm_c§_vÆue
(
lsm_curs‹
 *
pC§
, c⁄° **
µVÆ
, *
≤VÆ
);

665 
lsm_c§_cmp
(
lsm_curs‹
 *
pC§
, c⁄° *
pKey
, 
nKey
, *
piRes
);

673 
lsm_c⁄fig_log
(
lsm_db
 *, (*)(*, , const *), *);

679 
lsm_c⁄fig_w‹k_hook
(
lsm_db
 *, (*)(lsm_db *, *), *);

682 #ifde‡
__˝lu•lus


	@src/lsmInt.h

14 #i‚de‡
_LSM_INT_H


15 
	#_LSM_INT_H


	)

17 
	~"lsm.h
"

18 
	~<as£π.h
>

19 
	~<°rög.h
>

21 
	~<°d¨g.h
>

22 
	~<°dlib.h
>

23 
	~<°dio.h
>

24 
	~<˘y≥.h
>

26 
	~<uni°d.h
>

28 #ifde‡
NDEBUG


29 #ifde‡
LSM_DEBUG_EXPENSIVE


30 #unde‡
LSM_DEBUG_EXPENSIVE


32 #ifde‡
LSM_DEBUG


33 #unde‡
LSM_DEBUG


36 #i‚de‡
LSM_DEBUG


37 
	#LSM_DEBUG


	)

45 
	#LSM_DFLT_PAGE_SIZE
 (4 * 1024)

	)

46 
	#LSM_DFLT_BLOCK_SIZE
 (1 * 1024 * 1024)

	)

47 
	#LSM_DFLT_AUTOFLUSH
 (1 * 1024 * 1024)

	)

48 
	#LSM_DFLT_AUTOCHECKPOINT
 (
i64
)(2 * 1024 * 1024)

	)

49 
	#LSM_DFLT_AUTOWORK
 1

	)

50 
	#LSM_DFLT_LOG_SIZE
 (128*1024)

	)

51 
	#LSM_DFLT_AUTOMERGE
 4

	)

52 
	#LSM_DFLT_SAFETY
 
LSM_SAFETY_NORMAL


	)

53 
	#LSM_DFLT_MMAP
 (
LSM_IS_64_BIT
 ? 1 : 32768)

	)

54 
	#LSM_DFLT_MULTIPLE_PROCESSES
 1

	)

55 
	#LSM_DFLT_USE_LOG
 1

	)

59 
	#LSM_CKSUM0_INIT
 42

	)

60 
	#LSM_CKSUM1_INIT
 42

	)

62 
	#LSM_META_PAGE_SIZE
 4096

	)

66 
	#LSM_IS_64_BIT
 ((*)==8)

	)

68 
	#LSM_AUTOWORK_QUANT
 32

	)

70 
D©aba£
 
	tD©aba£
;

71 
DbLog
 
	tDbLog
;

72 
FûeSy°em
 
	tFûeSy°em
;

73 
Fªñi°
 
	tFªñi°
;

74 
Fªñi°E¡ry
 
	tFªñi°E¡ry
;

75 
Levñ
 
	tLevñ
;

76 
LogM¨k
 
	tLogM¨k
;

77 
LogRegi⁄
 
	tLogRegi⁄
;

78 
LogWrôî
 
	tLogWrôî
;

79 
LsmSåög
 
	tLsmSåög
;

80 
Mempoﬁ
 
	tMempoﬁ
;

81 
Mîge
 
	tMîge
;

82 
MîgeI≈ut
 
	tMîgeI≈ut
;

83 
MëaPage
 
	tMëaPage
;

84 
Mu…iCurs‹
 
	tMu…iCurs‹
;

85 
Page
 
	tPage
;

86 
Redúe˘
 
	tRedúe˘
;

87 
Segmít
 
	tSegmít
;

88 
SegmítMîgî
 
	tSegmítMîgî
;

89 
ShmChunk
 
	tShmChunk
;

90 
ShmHódî
 
	tShmHódî
;

91 
ShmRódî
 
	tShmRódî
;

92 
S«pshŸ
 
	tS«pshŸ
;

93 
TønsM¨k
 
	tTønsM¨k
;

94 
Tªe
 
	tTªe
;

95 
TªeCurs‹
 
	tTªeCurs‹
;

96 
TªeHódî
 
	tTªeHódî
;

97 
TªeM¨k
 
	tTªeM¨k
;

98 
TªeRoŸ
 
	tTªeRoŸ
;

100 #i‚de‡
_SQLITEINT_H_


101 
	tu8
;

102 
	tu16
;

103 
	tu32
;

104 
lsm_i64
 
	ti64
;

105 
	tu64
;

109 
i64
 
	tPgno
;

111 #ifde‡
LSM_DEBUG


112 
lsmEº‹Bk±
();

114 
	#lsmEº‹Bk±
(
x
Ë(x)

	)

117 
	#LSM_PROTOCOL_BKPT
 
	`lsmEº‹Bk±
(
LSM_PROTOCOL
)

	)

118 
	#LSM_IOERR_BKPT
 
	`lsmEº‹Bk±
(
LSM_IOERR
)

	)

119 
	#LSM_NOMEM_BKPT
 
	`lsmEº‹Bk±
(
LSM_NOMEM
)

	)

120 
	#LSM_CORRUPT_BKPT
 
	`lsmEº‹Bk±
(
LSM_CORRUPT
)

	)

121 
	#LSM_MISUSE_BKPT
 
	`lsmEº‹Bk±
(
LSM_MISUSE
)

	)

123 
	#unu£d_∑ømëî
(
x
Ë()(x)

	)

124 
	#¨øy_size
(
x
Ë((x)/(x[0]))

	)

128 
	#LSM_SHM_CHUNK_SIZE
 (32*1024)

	)

131 
	#LSM_SHM_CHUNK_HDR
 ((
ShmChunk
))

	)

134 
	#LSM_LOCK_NREADER
 6

	)

137 
	#LSM_LOCK_NRWCLIENT
 16

	)

141 
	#LSM_LOCK_DMS1
 1

	)

142 
	#LSM_LOCK_DMS2
 2

	)

143 
	#LSM_LOCK_DMS3
 3

	)

144 
	#LSM_LOCK_WRITER
 4

	)

145 
	#LSM_LOCK_WORKER
 5

	)

146 
	#LSM_LOCK_CHECKPOINTER
 6

	)

147 
	#LSM_LOCK_ROTRANS
 7

	)

148 
	#LSM_LOCK_READER
(
i
Ë((iË+ 
LSM_LOCK_ROTRANS
 + 1)

	)

149 
	#LSM_LOCK_RWCLIENT
(
i
Ë((iË+ 
	`LSM_LOCK_READER
(
LSM_LOCK_NREADER
))

	)

156 
	#LSM_MAX_FREELIST_ENTRIES
 24

	)

158 
	#LSM_MAX_BLOCK_REDIRECTS
 16

	)

160 
	#LSM_ATTEMPTS_BEFORE_PROTOCOL
 10000

	)

167 
	#LSM_START_DELETE
 0x01

	)

168 
	#LSM_END_DELETE
 0x02

	)

169 
	#LSM_POINT_DELETE
 0x04

	)

170 
	#LSM_INSERT
 0x08

	)

171 
	#LSM_SEPARATOR
 0x10

	)

172 
	#LSM_SYSTEMKEY
 0x20

	)

174 
	#LSM_CONTIGUOUS
 0x40

	)

179 
	sLsmSåög
 {

180 
lsm_ív
 *
	mpEnv
;

181 
	mn
;

182 
	mnAŒoc
;

183 *
	mz
;

186 
LsmFûe
 
	tLsmFûe
;

187 
	sLsmFûe
 {

188 
lsm_fûe
 *
	mpFûe
;

189 
LsmFûe
 *
	mpNext
;

202 
I¡Aºay
 
	tI¡Aºay
;

203 
	sI¡Aºay
 {

204 
	mnAŒoc
;

205 
	mnAºay
;

206 
u32
 *
	maAºay
;

209 
	sRedúe˘
 {

210 
	mn
;

211 
	sRedúe˘E¡ry
 {

212 
	miFrom
;

213 
	miTo
;

214 } *
	ma
;

222 
	sTªeM¨k
 {

223 
u32
 
	miRoŸ
;

224 
u32
 
	mnHeight
;

225 
u32
 
	miWrôe
;

226 
u32
 
	mnChunk
;

227 
u32
 
	miFú°
;

228 
u32
 
	miNextShmid
;

229 
	miRﬁlback
;

235 
	sLogM¨k
 {

236 
i64
 
	miOff
;

237 
	mnBuf
;

238 
u8
 
	maBuf
[8];

239 
u32
 
	mcksum0
;

240 
u32
 
	mcksum1
;

243 
	sTønsM¨k
 {

244 
TªeM¨k
 
	måì
;

245 
LogM¨k
 
	mlog
;

253 
	sLogRegi⁄
 {

254 
i64
 
	miSèπ
;

255 
i64
 
	miEnd
;

258 
	sDbLog
 {

259 
u32
 
	mcksum0
;

260 
u32
 
	mcksum1
;

261 
i64
 
	miS«pshŸId
;

262 
LogRegi⁄
 
	maRegi⁄
[3];

265 
	sTªeRoŸ
 {

266 
u32
 
	miRoŸ
;

267 
u32
 
	mnHeight
;

268 
u32
 
	mnByã
;

269 
u32
 
	miTønsId
;

275 
	sTªeHódî
 {

276 
u32
 
	miU£dShmid
;

277 
u32
 
	miNextShmid
;

278 
u32
 
	miFú°
;

279 
u32
 
	mnChunk
;

280 
TªeRoŸ
 
	mroŸ
;

281 
u32
 
	miWrôe
;

282 
TªeRoŸ
 
	mﬁdroŸ
;

283 
u32
 
	miOldShmid
;

284 
u32
 
	miU§Vîsi⁄
;

285 
i64
 
	miOldLog
;

286 
u32
 
	mﬁdcksum0
;

287 
u32
 
	mﬁdcksum1
;

288 
DbLog
 
	mlog
;

289 
u32
 
	maCksum
[2];

323 
	slsm_db
 {

326 
lsm_ív
 *
	mpEnv
;

327 (*
	mxCmp
)(*, , *, );

330 
	meSa„ty
;

331 
	mbAutow‹k
;

332 
	mnTªeLimô
;

333 
	mnMîge
;

334 
	mbU£Log
;

335 
	mnDÊtPgsz
;

336 
	mnDÊtBlksz
;

337 
	mnMaxFªñi°
;

338 
	miMm≠
;

339 
i64
 
	mnAutock±
;

340 
	mbMu…iProc
;

341 
	mbRód⁄ly
;

342 
lsm_com¥ess
 
	mcom¥ess
;

343 
lsm_com¥ess_Á˘‹y
 
	mÁ˘‹y
;

346 
FûeSy°em
 *
	mpFS
;

347 
D©aba£
 *
	mpD©aba£
;

349 
	miRw˛õ¡
;

352 
S«pshŸ
 *
	mpClõ¡
;

353 
	miRódî
;

354 
	mbRoTøns
;

355 
Mu…iCurs‹
 *
	mpC§
;

356 
LogWrôî
 *
	mpLogWrôî
;

357 
	mnTønsO≥n
;

358 
	mnTønsAŒoc
;

359 
TønsM¨k
 *
	maTøns
;

360 
I¡Aºay
 
	mrﬁlback
;

361 
	mbDisˇrdOld
;

363 
Mu…iCurs‹
 *
	mpC§Cache
;

366 
S«pshŸ
 *
	mpW‹kî
;

367 
Fªñi°
 *
	mpFªñi°
;

368 
	mbU£Fªñi°
;

369 
	mbIn¸Mîge
;

371 
	mbInFa˘‹y
;

374 (*
	mxLog
)(*, , const *);

375 *
	mpLogCtx
;

378 (*
	mxW‹k
)(
	mlsm_db
 *, *);

379 *
	mpW‹kCtx
;

381 
u64
 
	mmLock
;

382 
lsm_db
 *
	mpNext
;

384 
	mnShm
;

385 **
	m≠Shm
;

386 
ShmHódî
 *
	mpShmhdr
;

387 
TªeHódî
 
	måìhdr
;

388 
u32
 
	maS«pshŸ
[
LSM_META_PAGE_SIZE
 / (u32)];

391 
	sSegmít
 {

392 
Pgno
 
	miFú°
;

393 
Pgno
 
	miLa°Pg
;

394 
Pgno
 
	miRoŸ
;

395 
	mnSize
;

397 
Redúe˘
 *
	mpRedúe˘
;

405 
	sLevñ
 {

406 
Segmít
 
	mlhs
;

407 
	mnRight
;

408 
Segmít
 *
	maRhs
;

409 
	miS∂ôT›ic
;

410 *
	mpS∂ôKey
;

411 
	mnS∂ôKey
;

413 
u16
 
	miAge
;

414 
u16
 
	mÊags
;

415 
Mîge
 *
	mpMîge
;

416 
Levñ
 *
	mpNext
;

429 
	#LEVEL_FREELIST_ONLY
 0x0001

	)

430 
	#LEVEL_INCOMPLETE
 0x0002

	)

445 
	sMîgeI≈ut
 {

446 
Pgno
 
	miPg
;

447 
	miCñl
;

449 
	sMîge
 {

450 
	mnI≈ut
;

451 
MîgeI≈ut
 *
	maI≈ut
;

452 
MîgeI≈ut
 
	m•lôkey
;

453 
	mnSkù
;

454 
	miOuçutOff
;

455 
Pgno
 
	miCuºítPå
;

463 
	#£gmítHasSï¨©‹s
(
pSegmít
Ë(’Segmít)->
£p
.
iFú°
>0)

	)

468 
	sShmRódî
 {

469 
u32
 
	miTªeId
;

470 
i64
 
	miLsmId
;

493 
	sShmHódî
 {

494 
u32
 
	maS«p1
[
LSM_META_PAGE_SIZE
 / 4];

495 
u32
 
	maS«p2
[
LSM_META_PAGE_SIZE
 / 4];

496 
u32
 
	mbWrôî
;

497 
u32
 
	miMëaPage
;

498 
TªeHódî
 
	mhdr1
;

499 
TªeHódî
 
	mhdr2
;

500 
ShmRódî
 
	maRódî
[
LSM_LOCK_NREADER
];

507 
	sShmChunk
 {

508 
u32
 
	miShmid
;

509 
u32
 
	miNext
;

516 
	#LSM_MAX_SHMCHUNKS
 (1<<30)

	)

519 
	#shm_£quí˚_ge
(
a
, 
b
Ë(((
u32
Ô-(u32)bË< 
LSM_MAX_SHMCHUNKS
)

	)

521 
	#LSM_APPLIST_SZ
 4

	)

545 
	sFªñi°
 {

546 
Fªñi°E¡ry
 *
	maE¡ry
;

547 
	mnE¡ry
;

548 
	mnAŒoc
;

550 
	sFªñi°E¡ry
 {

551 
u32
 
	miBlk
;

552 
i64
 
	miId
;

560 
	sS«pshŸ
 {

561 
D©aba£
 *
	mpD©aba£
;

562 
u32
 
	miCmpId
;

563 
Levñ
 *
	mpLevñ
;

564 
i64
 
	miId
;

565 
i64
 
	miLogOff
;

566 
Redúe˘
 
	mªdúe˘
;

569 
	mnBlock
;

570 
Pgno
 
	maiAµíd
[
LSM_APPLIST_SZ
];

571 
Fªñi°
 
	m‰ìli°
;

572 
u32
 
	mnWrôe
;

574 
	#LSM_INITIAL_SNAPSHOT_ID
 11

	)

579 
lsmCheckpoötWrôe
(
lsm_db
 *, , 
u32
 *);

580 
lsmCheckpoötLevñs
(
lsm_db
 *, , **, *);

581 
lsmCheckpoötLﬂdLevñs
(
lsm_db
 *
pDb
, *
pVÆ
, 
nVÆ
);

583 
lsmCheckpoötRecovî
(
lsm_db
 *);

584 
lsmCheckpoötDe£rülize
(
lsm_db
 *, , 
u32
 *, 
S«pshŸ
 **);

586 
lsmCheckpoötLﬂdW‹kî
(
lsm_db
 *
pDb
);

587 
lsmCheckpoötSt‹e
(
lsm_db
 *
pDb
, );

589 
lsmCheckpoötLﬂd
(
lsm_db
 *
pDb
, *);

590 
lsmCheckpoötLﬂdOk
(
lsm_db
 *
pDb
, );

591 
lsmCheckpoötClõ¡CacheOk
(
lsm_db
 *);

593 
u32
 
lsmCheckpoötNBlock
(u32 *);

594 
i64
 
lsmCheckpoötId
(
u32
 *, );

595 
u32
 
lsmCheckpoötNWrôe
(u32 *, );

596 
i64
 
lsmCheckpoötLogOff£t
(
u32
 *);

597 
lsmCheckpoötPgsz
(
u32
 *);

598 
lsmCheckpoötBlksz
(
u32
 *);

599 
lsmCheckpoötLogoff£t
(
u32
 *
aCk±
, 
DbLog
 *
pLog
);

600 
lsmCheckpoötZîoLogoff£t
(
lsm_db
 *);

602 
lsmCheckpoötSaveW‹kî
(
lsm_db
 *
pDb
, );

603 
lsmD©aba£FuŒ
(
lsm_db
 *
pDb
);

604 
lsmCheckpoötSyn˚d
(
lsm_db
 *
pDb
, 
i64
 *
piId
, i64 *
piLog
, 
u32
 *
≤Wrôe
);

606 
lsmCheckpoötSize
(
lsm_db
 *
db
, *
≤Byã
);

608 
lsmInfoCom¥essi⁄Id
(
lsm_db
 *
db
, 
u32
 *
piCmpId
);

613 
lsmTªeNew
(
lsm_ív
 *, (*)(*, , *, ), 
Tªe
 **
µTªe
);

614 
	`lsmTªeRñó£
(
lsm_ív
 *, 
Tªe
 *);

615 
	`lsmTªeInô
(
lsm_db
 *);

616 
	`lsmTªeRïaú
(
lsm_db
 *);

618 
	`lsmTªeMakeOld
(
lsm_db
 *
pDb
);

619 
	`lsmTªeDisˇrdOld
(
lsm_db
 *
pDb
);

620 
	`lsmTªeHasOld
(
lsm_db
 *
pDb
);

622 
	`lsmTªeSize
(
lsm_db
 *);

623 
	`lsmTªeEndTønß˘i⁄
(
lsm_db
 *
pDb
, 
bCommô
);

624 
	`lsmTªeLﬂdHódî
(
lsm_db
 *
pDb
, *);

625 
	`lsmTªeLﬂdHódîOk
(
lsm_db
 *, );

627 
	`lsmTªeIn£π
(
lsm_db
 *
pDb
, *
pKey
, 
nKey
, *
pVÆ
, 
nVÆ
);

628 
	`lsmTªeDñëe
(
lsm_db
 *
db
, *
pKey1
, 
nKey1
, *
pKey2
, 
nKey2
);

629 
	`lsmTªeRﬁlback
(
lsm_db
 *
pDb
, 
TªeM¨k
 *
pM¨k
);

630 
	`lsmTªeM¨k
(
lsm_db
 *
pDb
, 
TªeM¨k
 *
pM¨k
);

632 
	`lsmTªeCurs‹New
(
lsm_db
 *
pDb
, , 
TªeCurs‹
 **);

633 
	`lsmTªeCurs‹De°roy
(
TªeCurs‹
 *);

635 
	`lsmTªeCurs‹Sìk
(
TªeCurs‹
 *
pC§
, *
pKey
, 
nKey
, *
pRes
);

636 
	`lsmTªeCurs‹Next
(
TªeCurs‹
 *
pC§
);

637 
	`lsmTªeCurs‹Pªv
(
TªeCurs‹
 *
pC§
);

638 
	`lsmTªeCurs‹End
(
TªeCurs‹
 *
pC§
, 
bLa°
);

639 
	`lsmTªeCurs‹Re£t
(
TªeCurs‹
 *
pC§
);

640 
	`lsmTªeCurs‹Key
(
TªeCurs‹
 *
pC§
, *
pFœgs
, **
µKey
, *
≤Key
);

641 
	`lsmTªeCurs‹Fœgs
(
TªeCurs‹
 *
pC§
);

642 
	`lsmTªeCurs‹VÆue
(
TªeCurs‹
 *
pC§
, **
µVÆ
, *
≤VÆ
);

643 
	`lsmTªeCurs‹VÆid
(
TªeCurs‹
 *
pC§
);

644 
	`lsmTªeCurs‹Save
(
TªeCurs‹
 *
pC§
);

646 
	`lsmFœgsToSåög
(
Êags
, *
zFœgs
);

651 *
	`lsmMÆloc
(
lsm_ív
*, 
size_t
);

652 
	`lsmFªe
(
lsm_ív
*, *);

653 *
	`lsmRóŒoc
(
lsm_ív
*, *, 
size_t
);

654 *
	`lsmRóŒocOrFªe
(
lsm_ív
*, *, 
size_t
);

655 *
	`lsmRóŒocOrFªeRc
(
lsm_ív
 *, *, 
size_t
, *);

657 *
	`lsmMÆlocZîoRc
(
lsm_ív
*, 
size_t
, *);

658 *
	`lsmMÆlocRc
(
lsm_ív
*, 
size_t
, *);

660 *
	`lsmMÆlocZîo
(
lsm_ív
 *
pEnv
, 
size_t
);

661 *
	`lsmMÆlocSådup
(
lsm_ív
 *
pEnv
, const *);

666 
	`lsmMuãxSètic
(
lsm_ív
*, , 
lsm_muãx
 **);

667 
	`lsmMuãxNew
(
lsm_ív
*, 
lsm_muãx
 **);

668 
	`lsmMuãxDñ
(
lsm_ív
*, 
lsm_muãx
 *);

669 
	`lsmMuãxE¡î
(
lsm_ív
*, 
lsm_muãx
 *);

670 
	`lsmMuãxTry
(
lsm_ív
*, 
lsm_muãx
 *);

671 
	`lsmMuãxLóve
(
lsm_ív
*, 
lsm_muãx
 *);

673 #i‚de‡
NDEBUG


674 
	`lsmMuãxHñd
(
lsm_ív
 *, 
lsm_muãx
 *);

675 
	`lsmMuãxNŸHñd
(
lsm_ív
 *, 
lsm_muãx
 *);

681 
	`lsmFsO≥n
(
lsm_db
 *, const *, );

682 
	`lsmFsO≥nLog
(
lsm_db
 *, *);

683 
	`lsmFsClo£Log
(
lsm_db
 *);

684 
	`lsmFsClo£
(
FûeSy°em
 *);

686 
	`lsmFsC⁄figuª
(
lsm_db
 *
db
);

688 
	`lsmFsBlockSize
(
FûeSy°em
 *);

689 
	`lsmFsSëBlockSize
(
FûeSy°em
 *, );

691 
	`lsmFsPageSize
(
FûeSy°em
 *);

692 
	`lsmFsSëPageSize
(
FûeSy°em
 *, );

694 
	`lsmFsFûeid
(
lsm_db
 *
pDb
, **
µId
, *
≤Id
);

697 
	`lsmFsGobbÀ
(
lsm_db
 *, 
Segmít
 *, 
Pgno
 *, );

698 
	`lsmFsS‹ãdDñëe
(
FûeSy°em
 *, 
S«pshŸ
 *, , 
Segmít
 *);

699 
	`lsmFsS‹ãdFöish
(
FûeSy°em
 *, 
Segmít
 *);

700 
	`lsmFsS‹ãdAµíd
(
FûeSy°em
 *, 
S«pshŸ
 *, 
Levñ
 *, , 
Page
 **);

701 
	`lsmFsS‹ãdPaddög
(
FûeSy°em
 *, 
S«pshŸ
 *, 
Segmít
 *);

704 
lsm_ív
 *
	`lsmFsEnv
(
FûeSy°em
 *);

705 
lsm_ív
 *
	`lsmPageEnv
(
Page
 *);

706 
FûeSy°em
 *
	`lsmPageFS
(
Page
 *);

708 
	`lsmFsSe˘‹Size
(
FûeSy°em
 *);

710 
	`lsmS‹ãdS∂ôkey
(
lsm_db
 *, 
Levñ
 *, *);

713 
	`lsmFsDbPageLa°
(
FûeSy°em
 *
pFS
, 
Segmít
 *
pSeg
, 
Page
 **
µPg
);

714 
	`lsmFsDbPageGë
(
FûeSy°em
 *, 
Segmít
 *, 
Pgno
, 
Page
 **);

715 
	`lsmFsDbPageNext
(
Segmít
 *, 
Page
 *, 
eDú
, Page **);

717 
u8
 *
	`lsmFsPageD©a
(
Page
 *, *);

718 
	`lsmFsPageRñó£
(
Page
 *);

719 
	`lsmFsPagePîsi°
(
Page
 *);

720 
	`lsmFsPageRef
(
Page
 *);

721 
Pgno
 
	`lsmFsPageNumbî
(
Page
 *);

723 
	`lsmFsNRód
(
FûeSy°em
 *);

724 
	`lsmFsNWrôe
(
FûeSy°em
 *);

726 
	`lsmFsMëaPageGë
(
FûeSy°em
 *, , , 
MëaPage
 **);

727 
	`lsmFsMëaPageRñó£
(
MëaPage
 *);

728 
u8
 *
	`lsmFsMëaPageD©a
(
MëaPage
 *, *);

730 #ifde‡
LSM_DEBUG


731 
	`lsmFsDbPageIsLa°
(
Segmít
 *
pSeg
, 
Page
 *
pPg
);

732 
	`lsmFsI¡egrôyCheck
(
lsm_db
 *);

735 
Pgno
 
	`lsmFsRedúe˘Page
(
FûeSy°em
 *, 
Redúe˘
 *, Pgno);

737 
	`lsmFsPageWrôabÀ
(
Page
 *);

740 
	`lsmFsWrôeLog
(
FûeSy°em
 *
pFS
, 
i64
 
iOff
, 
LsmSåög
 *
pSå
);

741 
	`lsmFsSyncLog
(
FûeSy°em
 *
pFS
);

742 
	`lsmFsRódLog
(
FûeSy°em
 *
pFS
, 
i64
 
iOff
, 
nRód
, 
LsmSåög
 *
pSå
);

743 
	`lsmFsTrunˇãLog
(
FûeSy°em
 *
pFS
, 
i64
 
nByã
);

744 
	`lsmFsTrunˇãDb
(
FûeSy°em
 *
pFS
, 
i64
 
nByã
);

745 
	`lsmFsClo£AndDñëeLog
(
FûeSy°em
 *
pFS
);

747 
LsmFûe
 *
	`lsmFsDe„rClo£
(
FûeSy°em
 *
pFS
);

750 
	`lsmFsSyncDb
(
FûeSy°em
 *, );

752 
	`lsmFsFlushWaôög
(
FûeSy°em
 *, *);

755 
	`lsmInfoAºaySåu˘uª
(
lsm_db
 *
pDb
, 
bBlock
, 
Pgno
 
iFú°
, **
pzOut
);

756 
	`lsmInfoAºayPages
(
lsm_db
 *
pDb
, 
Pgno
 
iFú°
, **
pzOut
);

757 
	`lsmC⁄figMm≠
(
lsm_db
 *
pDb
, *
piP¨am
);

759 
	`lsmEnvO≥n
(
lsm_ív
 *, c⁄° *, , 
lsm_fûe
 **);

760 
	`lsmEnvClo£
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
);

761 
	`lsmEnvLock
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
, 
iLock
, 
eLock
);

762 
	`lsmEnvTe°Lock
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
, 
iLock
, 
nLock
, );

764 
	`lsmEnvShmM≠
(
lsm_ív
 *, 
lsm_fûe
 *, , , **);

765 
	`lsmEnvShmB¨rõr
(
lsm_ív
 *);

766 
	`lsmEnvShmUnm≠
(
lsm_ív
 *, 
lsm_fûe
 *, );

768 
	`lsmEnvSÀï
(
lsm_ív
 *, );

770 
	`lsmFsRódSyn˚dId
(
lsm_db
 *
db
, , 
i64
 *
piVÆ
);

772 
	`lsmFsSegmítC⁄èösPg
(
FûeSy°em
 *
pFS
, 
Segmít
 *, 
Pgno
, *);

774 
	`lsmFsPurgeCache
(
FûeSy°em
 *);

783 
	`lsmInfoPageDump
(
lsm_db
 *, 
Pgno
, , **);

784 
	`lsmS‹ãdCÀ™up
(
lsm_db
 *);

785 
	`lsmS‹ãdAutoW‹k
(
lsm_db
 *, 
nUnô
);

787 
	`lsmS‹ãdWÆkFªñi°
(
lsm_db
 *, , (*)(*, , 
i64
), *);

789 
	`lsmSaveW‹kî
(
lsm_db
 *, );

791 
	`lsmFlushTªeToDisk
(
lsm_db
 *
pDb
);

793 
	`lsmS‹ãdRem≠
(
lsm_db
 *
pDb
);

795 
	`lsmS‹ãdFªeLevñ
(
lsm_ív
 *
pEnv
, 
Levñ
 *);

797 
	`lsmS‹ãdAdv™˚AŒ
(
lsm_db
 *
pDb
);

799 
	`lsmS‹ãdLﬂdMîge
(
lsm_db
 *, 
Levñ
 *, 
u32
 *, *);

800 
	`lsmS‹ãdLﬂdFªñi°
(
lsm_db
 *
pDb
, **, *);

802 *
	`lsmS‹ãdS∂ôKey
(
Levñ
 *
pLevñ
, *
≤Byã
);

804 
	`lsmS‹ãdSaveTªeCurs‹s
(
lsm_db
 *);

806 
	`lsmMCurs‹New
(
lsm_db
 *, 
Mu…iCurs‹
 **);

807 
	`lsmMCurs‹Clo£
(
Mu…iCurs‹
 *, );

808 
	`lsmMCurs‹Sìk
(
Mu…iCurs‹
 *, , *, , );

809 
	`lsmMCurs‹Fú°
(
Mu…iCurs‹
 *);

810 
	`lsmMCurs‹Pªv
(
Mu…iCurs‹
 *);

811 
	`lsmMCurs‹La°
(
Mu…iCurs‹
 *);

812 
	`lsmMCurs‹VÆid
(
Mu…iCurs‹
 *);

813 
	`lsmMCurs‹Next
(
Mu…iCurs‹
 *);

814 
	`lsmMCurs‹Key
(
Mu…iCurs‹
 *, **, *);

815 
	`lsmMCurs‹VÆue
(
Mu…iCurs‹
 *, **, *);

816 
	`lsmMCurs‹Ty≥
(
Mu…iCurs‹
 *, *);

817 
lsm_db
 *
	`lsmMCurs‹Db
(
Mu…iCurs‹
 *);

818 
	`lsmMCurs‹FªeCache
(
lsm_db
 *);

820 
	`lsmSaveCurs‹s
(
lsm_db
 *
pDb
);

821 
	`lsmRe°‹eCurs‹s
(
lsm_db
 *
pDb
);

823 
	`lsmS‹ãdDumpSåu˘uª
(
lsm_db
 *
pDb
, 
S«pshŸ
 *, , , const *);

824 
	`lsmFsDumpBlockli°s
(
lsm_db
 *);

826 
	`lsmS‹ãdEx∑ndBåìPage
(
Page
 *
pPg
, 
nOrig
);

828 
	`lsmPutU32
(
u8
 *, 
u32
);

829 
u32
 
	`lsmGëU32
(
u8
 *);

830 
u64
 
	`lsmGëU64
(
u8
 *);

835 
	`lsmV¨ötPut32
(
u8
 *, );

836 
	`lsmV¨ötGë32
(
u8
 *, *);

837 
	`lsmV¨ötPut64
(
u8
 *
aD©a
, 
i64
 
iVÆ
);

838 
	`lsmV¨ötGë64
(c⁄° 
u8
 *
aD©a
, 
i64
 *
piVÆ
);

840 
	`lsmV¨ötLí32
();

841 
	`lsmV¨ötSize
(
u8
 
c
);

846 
	`lsmLogMesßge
(
lsm_db
 *, , const *, ...);

847 
	`lsmInfoFªñi°
(
lsm_db
 *
pDb
, **
pzOut
);

852 
	`lsmLogBegö
(
lsm_db
 *
pDb
);

853 
	`lsmLogWrôe
(
lsm_db
 *, *, , *, );

854 
	`lsmLogCommô
(
lsm_db
 *);

855 
	`lsmLogEnd
(
lsm_db
 *
pDb
, 
bCommô
);

856 
	`lsmLogTñl
(
lsm_db
 *, 
LogM¨k
 *);

857 
	`lsmLogSìk
(
lsm_db
 *, 
LogM¨k
 *);

858 
	`lsmLogClo£
(
lsm_db
 *);

860 
	`lsmLogRecovî
(
lsm_db
 *);

861 
	`lsmInfoLogSåu˘uª
(
lsm_db
 *
pDb
, **
pzVÆ
);

868 
	`lsmDbD©aba£C⁄√˘
(
lsm_db
*, const *);

869 
	`lsmDbD©aba£Rñó£
(
lsm_db
 *);

871 
	`lsmBegöRódTøns
(
lsm_db
 *);

872 
	`lsmBegöWrôeTøns
(
lsm_db
 *);

873 
	`lsmBegöFlush
(
lsm_db
 *);

875 
	`lsmDëe˘RoTøns
(
lsm_db
 *
db
, *);

876 
	`lsmBegöRoTøns
(
lsm_db
 *
db
);

878 
	`lsmBegöW‹k
(
lsm_db
 *);

879 
	`lsmFöishW‹k
(
lsm_db
 *, , *);

881 
	`lsmFöishRecovîy
(
lsm_db
 *);

882 
	`lsmFöishRódTøns
(
lsm_db
 *);

883 
	`lsmFöishWrôeTøns
(
lsm_db
 *, );

884 
	`lsmFöishFlush
(
lsm_db
 *, );

886 
	`lsmS«pshŸSëFªñi°
(
lsm_db
 *, *, );

888 
S«pshŸ
 *
	`lsmDbS«pshŸClõ¡
(
lsm_db
 *);

889 
S«pshŸ
 *
	`lsmDbS«pshŸW‹kî
(
lsm_db
 *);

891 
	`lsmS«pshŸSëCk±id
(
S«pshŸ
 *, 
i64
);

893 
Levñ
 *
	`lsmDbS«pshŸLevñ
(
S«pshŸ
 *);

894 
	`lsmDbS«pshŸSëLevñ
(
S«pshŸ
 *, 
Levñ
 *);

896 
	`lsmDbRecovîyCom∂ëe
(
lsm_db
 *, );

898 
	`lsmBlockAŒoˇã
(
lsm_db
 *, , *);

899 
	`lsmBlockFªe
(
lsm_db
 *, );

900 
	`lsmBlockRe‰ì
(
lsm_db
 *, );

902 
	`lsmFªñi°DñèBegö
(
lsm_db
 *);

903 
	`lsmFªñi°DñèEnd
(
lsm_db
 *);

904 
	`lsmFªñi°Dñè
(
lsm_db
 *
pDb
);

906 
DbLog
 *
	`lsmD©aba£Log
(
lsm_db
 *
pDb
);

908 #ifde‡
LSM_DEBUG


909 
	`lsmHﬁdögClõ¡Muãx
(
lsm_db
 *
pDb
);

910 
	`lsmShmAs£πLock
(
lsm_db
 *
db
, 
iLock
, 
eOp
);

911 
	`lsmShmAs£πW‹kî
(
lsm_db
 *
db
);

914 
	`lsmFªeS«pshŸ
(
lsm_ív
 *, 
S«pshŸ
 *);

918 
	#LSM_LOCK_UNLOCK
 0

	)

919 
	#LSM_LOCK_SHARED
 1

	)

920 
	#LSM_LOCK_EXCL
 2

	)

922 
	`lsmShmCacheChunks
(
lsm_db
 *
db
, 
nChunk
);

923 
	`lsmShmLock
(
lsm_db
 *
db
, 
iLock
, 
eOp
, 
bBlock
);

924 
	`lsmShmTe°Lock
(
lsm_db
 *
db
, 
iLock
, 
nLock
, 
eOp
);

925 
	`lsmShmB¨rõr
(
lsm_db
 *
db
);

927 #ifde‡
LSM_DEBUG


928 
	`lsmShmHasLock
(
lsm_db
 *
db
, 
iLock
, 
eOp
);

930 
	#lsmShmHasLock
(
x
,
y
,
z
)

	)

933 
	`lsmRódlock
(
lsm_db
 *, 
i64
 
iLsm
, 
u32
 
iShmMö
, u32 
iShmMax
);

935 
	`lsmLsmInU£
(
lsm_db
 *
db
, 
i64
 
iLsmId
, *
pbInU£
);

936 
	`lsmTªeInU£
(
lsm_db
 *
db
, 
u32
 
iLsmId
, *
pbInU£
);

937 
	`lsmFªñi°Aµíd
(
lsm_ív
 *
pEnv
, 
Fªñi°
 *
p
, 
iBlk
, 
i64
 
iId
);

939 
	`lsmDbMu…iProc
(
lsm_db
 *);

940 
	`lsmDbDe„ºedClo£
(
lsm_db
 *, 
lsm_fûe
 *, 
LsmFûe
 *);

941 
LsmFûe
 *
	`lsmDbRecy˛eFd
(
lsm_db
 *);

943 
	`lsmWÆkFªñi°
(
lsm_db
 *, , (*)(*, , 
i64
), *);

945 
	`lsmCheckCom¥essi⁄Id
(
lsm_db
 *, 
u32
);

951 
	`lsmSåögInô
(
LsmSåög
*, 
lsm_ív
 *
pEnv
);

952 
	`lsmSåögExãnd
(
LsmSåög
*, );

953 
	`lsmSåögAµíd
(
LsmSåög
*, const *, );

954 
	`lsmSåögVAµídf
(
LsmSåög
*, c⁄° *
zF‹m©
, 
va_li°
, va_list);

955 
	`lsmSåögAµídf
(
LsmSåög
*, c⁄° *
zF‹m©
, ...);

956 
	`lsmSåögCÀ¨
(
LsmSåög
*);

957 *
	`lsmMÆlocPrötf
(
lsm_ív
*, const *, ...);

958 
	`lsmSåögBöAµíd
(
LsmSåög
 *
pSå
, c⁄° 
u8
 *
a
, 
n
);

960 
	`lsmSåÀn
(c⁄° *
zName
);

968 
	#ROUND8
(
x
Ë(((x)+7)&~7)

	)

970 
	#LSM_MIN
(
x
,
y
Ë((x)>(yË? (yË: (x))

	)

971 
	#LSM_MAX
(
x
,
y
Ë((x)>(yË? (xË: (y))

	)

	@src/lsm_ckpt.c

21 
	~"lsmI¡.h
"

138 
	#LSM_MAX_RHS_SEGMENTS
 40

	)

175 
	#BYTESWAP32
(
x
) ( \

176 (((
x
)&0x000000FF)<<24) + (((x)&0x0000FF00)<<8) \

177 + (((
x
)&0x00FF0000)>>8) + (((x)&0xFF000000)>>24) \

178 )

	)

180 c⁄° 
	g⁄e
 = 1;

181 
	#LSM_LITTLE_ENDIAN
 (*(
u8
 *)(&
⁄e
))

	)

184 
	#CKPT_HDR_SIZE
 9

	)

185 
	#CKPT_LOGPTR_SIZE
 4

	)

186 
	#CKPT_APPENDLIST_SIZE
 (
LSM_APPLIST_SZ
 * 2)

	)

189 
	#CKPT_HDR_ID_MSW
 0

	)

190 
	#CKPT_HDR_ID_LSW
 1

	)

191 
	#CKPT_HDR_NCKPT
 2

	)

192 
	#CKPT_HDR_CMPID
 3

	)

193 
	#CKPT_HDR_NBLOCK
 4

	)

194 
	#CKPT_HDR_BLKSZ
 5

	)

195 
	#CKPT_HDR_NLEVEL
 6

	)

196 
	#CKPT_HDR_PGSZ
 7

	)

197 
	#CKPT_HDR_NWRITE
 8

	)

199 
	#CKPT_HDR_LO_MSW
 9

	)

200 
	#CKPT_HDR_LO_LSW
 10

	)

201 
	#CKPT_HDR_LO_CKSUM1
 11

	)

202 
	#CKPT_HDR_LO_CKSUM2
 12

	)

204 
Ck±Buf„r
 
	tCk±Buf„r
;

209 
	sCk±Buf„r
 {

210 
lsm_ív
 *
	mpEnv
;

211 
	mnAŒoc
;

212 
u32
 *
	maCk±
;

224 
	$ck±Checksum
(
u32
 *
aCk±
, u32 
nCk±
, u32 *
piCksum1
, u32 *
piCksum2
){

225 
i
;

226 
u32
 
cksum1
 = 1;

227 
u32
 
cksum2
 = 2;

229 if–
nCk±
 % 2 ){

230 
cksum1
 +
aCk±
[
nCk±
-3] & 0x0000FFFF;

231 
cksum2
 +
aCk±
[
nCk±
-3] & 0xFFFF0000;

234 
i
=0; (i+3)<
nCk±
; i+=2){

235 
cksum1
 +
cksum2
 + 
aCk±
[
i
];

236 
cksum2
 +
cksum1
 + 
aCk±
[
i
+1];

239 *
piCksum1
 = 
cksum1
;

240 *
piCksum2
 = 
cksum2
;

241 
	}
}

246 
	$ck±SëVÆue
(
Ck±Buf„r
 *
p
, 
iIdx
, 
u32
 
iVÆ
, *
pRc
){

247 if–*
pRc
 ) ;

248 if–
iIdx
>=
p
->
nAŒoc
 ){

249 
nNew
 = 
	`LSM_MAX
(8, 
iIdx
*2);

250 
p
->
aCk±
 = (
u32
 *)
	`lsmRóŒocOrFªe
’->
pEnv
,Ö->aCk±, 
nNew
*(u32));

251 if–!
p
->
aCk±
 ){

252 *
pRc
 = 
LSM_NOMEM_BKPT
;

255 
p
->
nAŒoc
 = 
nNew
;

257 
p
->
aCk±
[
iIdx
] = 
iVÆ
;

258 
	}
}

264 
	$ck±Ch™geEndü¬ess
(
u32
 *
aI¡
, 
nI¡
){

265 if–
LSM_LITTLE_ENDIAN
 ){

266 
i
;

267 
i
=0; i<
nI¡
; i++Ë
aI¡
[i] = 
	`BYTESWAP32
(aInt[i]);

269 
	}
}

276 
	$ck±AddChecksum
(
Ck±Buf„r
 *
p
, 
nCk±
, *
pRc
){

277 if–*
pRc
==
LSM_OK
 ){

278 
u32
 
aCksum
[2] = {0, 0};

279 
	`ck±Checksum
(
p
->
aCk±
, 
nCk±
+2, &
aCksum
[0], &aCksum[1]);

280 
	`ck±SëVÆue
(
p
, 
nCk±
, 
aCksum
[0], 
pRc
);

281 
	`ck±SëVÆue
(
p
, 
nCk±
+1, 
aCksum
[1], 
pRc
);

283 
	}
}

285 
	$ck±Aµíd64
(
Ck±Buf„r
 *
p
, *
piOut
, 
i64
 
iVÆ
, *
pRc
){

286 
iOut
 = *
piOut
;

287 
	`ck±SëVÆue
(
p
, 
iOut
++, (
iVÆ
 >> 32Ë& 0xFFFFFFFF, 
pRc
);

288 
	`ck±SëVÆue
(
p
, 
iOut
++, (
iVÆ
 & 0xFFFFFFFF), 
pRc
);

289 *
piOut
 = 
iOut
;

290 
	}
}

292 
i64
 
	$ck±Ród64
(
u32
 *
a
){

293  (((
i64
)
a
[0]) << 32) + (i64)a[1];

294 
	}
}

296 
i64
 
	$ck±GobbÀ64
(
u32
 *
a
, *
piIn
){

297 
iIn
 = *
piIn
;

298 *
piIn
 += 2;

299  
	`ck±Ród64
(&
a
[
iIn
]);

300 
	}
}

307 
	$ck±Exp‹tSegmít
(

308 
Segmít
 *
pSeg
,

309 
Ck±Buf„r
 *
p
,

310 *
piOut
,

311 *
pRc


313 
	`ck±Aµíd64
(
p
, 
piOut
, 
pSeg
->
iFú°
, 
pRc
);

314 
	`ck±Aµíd64
(
p
, 
piOut
, 
pSeg
->
iLa°Pg
, 
pRc
);

315 
	`ck±Aµíd64
(
p
, 
piOut
, 
pSeg
->
iRoŸ
, 
pRc
);

316 
	`ck±Aµíd64
(
p
, 
piOut
, 
pSeg
->
nSize
, 
pRc
);

317 
	}
}

319 
	$ck±Exp‹tLevñ
(

320 
Levñ
 *
pLevñ
,

321 
Ck±Buf„r
 *
p
,

322 *
piOut
,

323 *
pRc


325 
iOut
 = *
piOut
;

326 
Mîge
 *
pMîge
;

328 
pMîge
 = 
pLevñ
->pMerge;

329 
	`ck±SëVÆue
(
p
, 
iOut
++, (
u32
)
pLevñ
->
iAge
 + (u32)’Levñ->
Êags
<<16), 
pRc
);

330 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pLevñ
->
nRight
, 
pRc
);

331 
	`ck±Exp‹tSegmít
(&
pLevñ
->
lhs
, 
p
, &
iOut
, 
pRc
);

333 
	`as£π
–(
pLevñ
->
nRight
>0)==(
pMîge
!=0) );

334 if–
pMîge
 ){

335 
i
;

336 
i
=0; i<
pLevñ
->
nRight
; i++){

337 
	`ck±Exp‹tSegmít
(&
pLevñ
->
aRhs
[
i
], 
p
, &
iOut
, 
pRc
);

339 
	`as£π
–
pMîge
->
nI≈ut
==
pLevñ
->
nRight


340 || 
pMîge
->
nI≈ut
==
pLevñ
->
nRight
+1

342 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pMîge
->
nI≈ut
, 
pRc
);

343 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pMîge
->
nSkù
, 
pRc
);

344 
i
=0; i<
pMîge
->
nI≈ut
; i++){

345 
	`ck±Aµíd64
(
p
, &
iOut
, 
pMîge
->
aI≈ut
[
i
].
iPg
, 
pRc
);

346 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pMîge
->
aI≈ut
[
i
].
iCñl
, 
pRc
);

348 
	`ck±Aµíd64
(
p
, &
iOut
, 
pMîge
->
•lôkey
.
iPg
, 
pRc
);

349 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pMîge
->
•lôkey
.
iCñl
, 
pRc
);

350 
	`ck±Aµíd64
(
p
, &
iOut
, 
pMîge
->
iCuºítPå
, 
pRc
);

353 *
piOut
 = 
iOut
;

354 
	}
}

359 
	$ck±Exp‹tLog
(

360 
lsm_db
 *
pDb
,

361 
bFlush
,

362 
Ck±Buf„r
 *
p
,

363 *
piOut
,

364 *
pRc


366 
iOut
 = *
piOut
;

368 
	`as£π
–
iOut
==
CKPT_HDR_LO_MSW
 );

370 if–
bFlush
 ){

371 
i64
 
iOff
 = 
pDb
->
åìhdr
.
iOldLog
;

372 
	`ck±Aµíd64
(
p
, &
iOut
, 
iOff
, 
pRc
);

373 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pDb
->
åìhdr
.
ﬁdcksum0
, 
pRc
);

374 
	`ck±SëVÆue
(
p
, 
iOut
++, 
pDb
->
åìhdr
.
ﬁdcksum1
, 
pRc
);

376 ; 
iOut
<=
CKPT_HDR_LO_CKSUM2
; iOut++){

377 
	`ck±SëVÆue
(
p
, 
iOut
, 
pDb
->
pShmhdr
->
aS«p2
[iOut], 
pRc
);

381 
	`as£π
–*
pRc
 || 
iOut
==
CKPT_HDR_LO_CKSUM2
+1 );

382 *
piOut
 = 
iOut
;

383 
	}
}

385 
	$ck±Exp‹tAµídli°
(

386 
lsm_db
 *
db
,

387 
Ck±Buf„r
 *
p
,

388 *
piOut
,

389 *
pRc


391 
i
;

392 
Pgno
 *
aiAµíd
 = 
db
->
pW‹kî
->aiAppend;

394 
i
=0; i<
LSM_APPLIST_SZ
; i++){

395 
	`ck±Aµíd64
(
p
, 
piOut
, 
aiAµíd
[
i
], 
pRc
);

397 
	}
};

399 
	$ck±Exp‹tS«pshŸ
(

400 
lsm_db
 *
pDb
,

401 
bLog
,

402 
i64
 
iId
,

403 
bCksum
,

404 **
µCk±
,

405 *
≤Ck±


407 
rc
 = 
LSM_OK
;

408 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

409 
S«pshŸ
 *
pS«p
 = 
pDb
->
pW‹kî
;

410 
nLevñ
 = 0;

411 
iLevñ
;

412 
iOut
 = 0;

413 
Levñ
 *
pLevñ
;

414 
i
;

415 
Ck±Buf„r
 
ck±
;

418 
	`mem£t
(&
ck±
, 0, (
Ck±Buf„r
));

419 
ck±
.
pEnv
 = 
pDb
->pEnv;

420 
iOut
 = 
CKPT_HDR_SIZE
;

423 
	`ck±Exp‹tLog
(
pDb
, 
bLog
, &
ck±
, &
iOut
, &
rc
);

426 
	`ck±Exp‹tAµídli°
(
pDb
, &
ck±
, &
iOut
, &
rc
);

429 
pLevñ
=
	`lsmDbS«pshŸLevñ
(
pS«p
);ÖLevñ;ÖLevñıLevñ->
pNext
Ë
nLevñ
++;

432 
iLevñ
 = 0;

433 
pLevñ
=
	`lsmDbS«pshŸLevñ
(
pS«p
); 
iLevñ
<
nLevñ
;ÖLevñıLevñ->
pNext
){

434 
	`ck±Exp‹tLevñ
(
pLevñ
, &
ck±
, &
iOut
, &
rc
);

435 
iLevñ
++;

439 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, 
pS«p
->
ªdúe˘
.
n
, &
rc
);

440 
i
=0; i<
pS«p
->
ªdúe˘
.
n
; i++){

441 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, 
pS«p
->
ªdúe˘
.
a
[
i
].
iFrom
, &
rc
);

442 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, 
pS«p
->
ªdúe˘
.
a
[
i
].
iTo
, &
rc
);

446 
	`as£π
–
pS«p
->
‰ìli°
.
nE¡ry
<=
pDb
->
nMaxFªñi°
 );

447 if–
rc
==
LSM_OK
 ){

448 
nFªe
 = 
pS«p
->
‰ìli°
.
nE¡ry
;

449 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, 
nFªe
, &
rc
);

450 
i
=0; i<
nFªe
; i++){

451 
Fªñi°E¡ry
 *
p
 = &
pS«p
->
‰ìli°
.
aE¡ry
[
i
];

452 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, 
p
->
iBlk
, &
rc
);

453 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, (
p
->
iId
 >> 32Ë& 0xFFFFFFFF, &
rc
);

454 
	`ck±SëVÆue
(&
ck±
, 
iOut
++, 
p
->
iId
 & 0xFFFFFFFF, &
rc
);

459 
	`as£π
–
iId
>=0 );

460 
	`as£π
–
pS«p
->
iCmpId
==
pDb
->
com¥ess
.
iId


461 || 
pS«p
->
iCmpId
==
LSM_COMPRESSION_EMPTY


463 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_ID_MSW
, (
u32
)(
iId
>>32), &
rc
);

464 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_ID_LSW
, (
u32
)(
iId
&0xFFFFFFFF), &
rc
);

465 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_NCKPT
, 
iOut
+2, &
rc
);

466 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_CMPID
, 
pDb
->
com¥ess
.
iId
, &
rc
);

467 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_NBLOCK
, 
pS«p
->
nBlock
, &
rc
);

468 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_BLKSZ
, 
	`lsmFsBlockSize
(
pFS
), &
rc
);

469 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_NLEVEL
, 
nLevñ
, &
rc
);

470 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_PGSZ
, 
	`lsmFsPageSize
(
pFS
), &
rc
);

471 
	`ck±SëVÆue
(&
ck±
, 
CKPT_HDR_NWRITE
, 
pS«p
->
nWrôe
, &
rc
);

473 if–
bCksum
 ){

474 
	`ck±AddChecksum
(&
ck±
, 
iOut
, &
rc
);

476 
	`ck±SëVÆue
(&
ck±
, 
iOut
, 0, &
rc
);

477 
	`ck±SëVÆue
(&
ck±
, 
iOut
+1, 0, &
rc
);

479 
iOut
 += 2;

480 
	`as£π
–
iOut
<=1024 );

482 #ifde‡
LSM_LOG_FREELIST


483 
	`lsmLogMesßge
(
pDb
, 
rc
,

484 "ck±Exp‹tS«pshŸ(): id=%Œd fªñi°: %d", 
iId
, 
pS«p
->
‰ìli°
.
nE¡ry


486 
i
=0; i<
pS«p
->
‰ìli°
.
nE¡ry
; i++){

487 
	`lsmLogMesßge
(
pDb
, 
rc
,

489 
pS«p
->
‰ìli°
.
aE¡ry
[
i
].
iBlk
,

490 
pS«p
->
‰ìli°
.
aE¡ry
[
i
].
iId


495 *
µCk±
 = (*)
ck±
.
aCk±
;

496 if–
≤Ck±
 ) *≤Ck± = (
u32
)*
iOut
;

497  
rc
;

498 
	}
}

504 
	$ck±NewSegmít
(

505 
u32
 *
aIn
,

506 *
piIn
,

507 
Segmít
 *
pSegmít


509 
	`as£π
–
pSegmít
->
iFú°
==0 &&ÖSegmít->
iLa°Pg
==0 );

510 
	`as£π
–
pSegmít
->
nSize
==0 &&ÖSegmít->
iRoŸ
==0 );

511 
pSegmít
->
iFú°
 = 
	`ck±GobbÀ64
(
aIn
, 
piIn
);

512 
pSegmít
->
iLa°Pg
 = 
	`ck±GobbÀ64
(
aIn
, 
piIn
);

513 
pSegmít
->
iRoŸ
 = 
	`ck±GobbÀ64
(
aIn
, 
piIn
);

514 
pSegmít
->
nSize
 = 
	`ck±GobbÀ64
(
aIn
, 
piIn
);

515 
	`as£π
–
pSegmít
->
iFú°
 );

516 
	}
}

518 
	$ck±SëupMîge
(
lsm_db
 *
pDb
, 
u32
 *
aI¡
, *
piIn
, 
Levñ
 *
pLevñ
){

519 
Mîge
 *
pMîge
;

520 
nI≈ut
;

521 
iIn
 = *
piIn
;

522 
i
;

523 
nByã
;

526 
nI≈ut
 = ()
aI¡
[
iIn
++];

527 
nByã
 = (
Mîge
Ë+ (
MîgeI≈ut
Ë* 
nI≈ut
;

528 
pMîge
 = (
Mîge
 *)
	`lsmMÆlocZîo
(
pDb
->
pEnv
, 
nByã
);

529 if–!
pMîge
 )  
LSM_NOMEM_BKPT
;

530 
pLevñ
->
pMîge
 =ÖMerge;

533 
pMîge
->
aI≈ut
 = (
MîgeI≈ut
 *)&pMerge[1];

534 
pMîge
->
nI≈ut
 =ÇInput;

535 
pMîge
->
iOuçutOff
 = -1;

536 
pMîge
->
nSkù
 = ()
aI¡
[
iIn
++];

537 
i
=0; i<
nI≈ut
; i++){

538 
pMîge
->
aI≈ut
[
i
].
iPg
 = 
	`ck±GobbÀ64
(
aI¡
, &
iIn
);

539 
pMîge
->
aI≈ut
[
i
].
iCñl
 = ()
aI¡
[
iIn
++];

541 
pMîge
->
•lôkey
.
iPg
 = 
	`ck±GobbÀ64
(
aI¡
, &
iIn
);

542 
pMîge
->
•lôkey
.
iCñl
 = ()
aI¡
[
iIn
++];

543 
pMîge
->
iCuºítPå
 = 
	`ck±GobbÀ64
(
aI¡
, &
iIn
);

546 *
piIn
 = 
iIn
;

547  
LSM_OK
;

548 
	}
}

551 
	$ck±LﬂdLevñs
(

552 
lsm_db
 *
pDb
,

553 
u32
 *
aIn
,

554 *
piIn
,

555 
nLevñ
,

556 
Levñ
 **
µLevñ


558 
i
;

559 
rc
 = 
LSM_OK
;

560 
Levñ
 *
pRë
 = 0;

561 
Levñ
 **
µNext
;

562 
iIn
 = *
piIn
;

564 
µNext
 = &
pRë
;

565 
i
=0; 
rc
==
LSM_OK
 && i<
nLevñ
; i++){

566 
iRight
;

567 
Levñ
 *
pLevñ
;

570 
pLevñ
 = (
Levñ
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (Levñ), &
rc
);

571 if–
rc
==
LSM_OK
 ){

572 
pLevñ
->
iAge
 = (
u16
)(
aIn
[
iIn
] & 0x0000FFFF);

573 
pLevñ
->
Êags
 = (
u16
)((
aIn
[
iIn
]>>16) & 0x0000FFFF);

574 
iIn
++;

575 
pLevñ
->
nRight
 = 
aIn
[
iIn
++];

576 if–
pLevñ
->
nRight
 ){

577 
nByã
 = (
Segmít
Ë* 
pLevñ
->
nRight
;

578 
pLevñ
->
aRhs
 = (
Segmít
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, 
nByã
, &
rc
);

580 if–
rc
==
LSM_OK
 ){

581 *
µNext
 = 
pLevñ
;

582 
µNext
 = &
pLevñ
->
pNext
;

585 
	`ck±NewSegmít
(
aIn
, &
iIn
, &
pLevñ
->
lhs
);

588 
iRight
=0; iRight<
pLevñ
->
nRight
; iRight++){

589 
	`ck±NewSegmít
(
aIn
, &
iIn
, &
pLevñ
->
aRhs
[
iRight
]);

593 if–
pLevñ
->
nRight
>0 ){

594 
rc
 = 
	`ck±SëupMîge
(
pDb
, 
aIn
, &
iIn
, 
pLevñ
);

600 if–
rc
!=
LSM_OK
 ){

603 
	`lsmS‹ãdFªeLevñ
(
pDb
->
pEnv
, 
pRë
);

604 
pRë
 = 0;

607 *
µLevñ
 = 
pRë
;

608 *
piIn
 = 
iIn
;

609  
rc
;

610 
	}
}

613 
	$lsmCheckpoötLﬂdLevñs
(
lsm_db
 *
pDb
, *
pVÆ
, 
nVÆ
){

614 
rc
 = 
LSM_OK
;

615 if–
nVÆ
>0 ){

616 
u32
 *
aIn
;

618 
aIn
 = 
	`lsmMÆlocRc
(
pDb
->
pEnv
, 
nVÆ
, &
rc
);

619 if–
aIn
 ){

620 
Levñ
 *
pLevñ
 = 0;

621 
Levñ
 *
pP¨ít
;

623 
nIn
;

624 
nLevñ
;

625 
iIn
 = 1;

626 
	`mem˝y
(
aIn
, 
pVÆ
, 
nVÆ
);

627 
nIn
 = 
nVÆ
 / (
u32
);

629 
	`ck±Ch™geEndü¬ess
(
aIn
, 
nIn
);

630 
nLevñ
 = 
aIn
[0];

631 
rc
 = 
	`ck±LﬂdLevñs
(
pDb
, 
aIn
, &
iIn
, 
nLevñ
, &
pLevñ
);

632 
	`lsmFªe
(
pDb
->
pEnv
, 
aIn
);

633 
	`as£π
–
rc
==
LSM_OK
 || 
pLevñ
==0 );

634 if–
rc
==
LSM_OK
 ){

635 
pP¨ít
 = 
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);

636 
	`as£π
–
pP¨ít
 );

637  
pP¨ít
->
pNext
 )ÖParent =ÖParent->pNext;

638 
pP¨ít
->
pNext
 = 
pLevñ
;

643  
rc
;

644 
	}
}

654 
	$lsmCheckpoötLevñs
(

655 
lsm_db
 *
pDb
,

656 
nLevñ
,

657 **
∑VÆ
,

658 *
≤VÆ


660 
Levñ
 *
p
;

661 
nAŒ
= 0;

662 
rc
;

663 
i
;

664 
iOut
;

665 
Ck±Buf„r
 
ck±
;

666 
	`as£π
–
nLevñ
>0 );

668 
p
=
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);Ö;Öı->
pNext
Ë
nAŒ
++;

670 
	`as£π
–
nAŒ
>
nLevñ
 );

671 
nAŒ
 -
nLevñ
;

672 
p
=
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);Ö && 
nAŒ
>0;Öı->
pNext
)ÇAll--;

674 
	`mem£t
(&
ck±
, 0, (
Ck±Buf„r
));

675 
ck±
.
pEnv
 = 
pDb
->pEnv;

677 
	`ck±SëVÆue
(&
ck±
, 0, 
nLevñ
, &
rc
);

678 
iOut
 = 1;

679 
i
=0; 
rc
==
LSM_OK
 && i<
nLevñ
; i++){

680 
	`ck±Exp‹tLevñ
(
p
, &
ck±
, &
iOut
, &
rc
);

681 
p
 =Ö->
pNext
;

683 
	`as£π
–
rc
!=
LSM_OK
 || 
p
==0 );

685 if–
rc
==
LSM_OK
 ){

686 
	`ck±Ch™geEndü¬ess
(
ck±
.
aCk±
, 
iOut
);

687 *
∑VÆ
 = (*)
ck±
.
aCk±
;

688 *
≤VÆ
 = 
iOut
 * (
u32
);

690 *
≤VÆ
 = 0;

691 *
∑VÆ
 = 0;

694  
rc
;

695 
	}
}

700 
i64
 
	$ck±LﬂdId
(
MëaPage
 *
pPg
){

701 
i64
 
ªt
 = 0;

702 if–
pPg
 ){

703 
nD©a
;

704 
u8
 *
aD©a
 = 
	`lsmFsMëaPageD©a
(
pPg
, &
nD©a
);

705 
ªt
 = (((
i64
)
	`lsmGëU32
(&
aD©a
[
CKPT_HDR_ID_MSW
*4])) << 32) +

706 ((
i64
)
	`lsmGëU32
(&
aD©a
[
CKPT_HDR_ID_LSW
*4]));

708  
ªt
;

709 
	}
}

715 
	$ck±ChecksumOk
(
u32
 *
aCk±
){

716 
u32
 
nCk±
 = 
aCk±
[
CKPT_HDR_NCKPT
];

717 
u32
 
cksum1
;

718 
u32
 
cksum2
;

720 if–
nCk±
<
CKPT_HDR_NCKPT
 ||ÇCk±>(
LSM_META_PAGE_SIZE
)/(
u32
) )  0;

721 
	`ck±Checksum
(
aCk±
, 
nCk±
, &
cksum1
, &
cksum2
);

722  (
cksum1
==
aCk±
[
nCk±
-2] && 
cksum2
==aCkpt[nCkpt-1]);

723 
	}
}

737 
	$ck±TryLﬂd
(
lsm_db
 *
pDb
, 
MëaPage
 *
pPg
, 
u32
 
iMëa
, *
pRc
){

738 
bLﬂded
 = 0;

739 if–*
pRc
==
LSM_OK
 ){

740 
rc
 = 
LSM_OK
;

741 
u32
 *
aCk±
 = 0;

742 
u32
 
nCk±
;

743 
nD©a
;

744 
u8
 *
aD©a
;

746 
aD©a
 = 
	`lsmFsMëaPageD©a
(
pPg
, &
nD©a
);

747 
nCk±
 = (
u32
)
	`lsmGëU32
(&
aD©a
[
CKPT_HDR_NCKPT
*(u32)]);

748 if–
nCk±
<=
nD©a
/(
u32
Ë&&ÇCk±>
CKPT_HDR_NCKPT
 ){

749 
aCk±
 = (
u32
 *)
	`lsmMÆlocRc
(
pDb
->
pEnv
, 
nCk±
*(u32), &
rc
);

751 if–
aCk±
 ){

752 
	`mem˝y
(
aCk±
, 
aD©a
, 
nCk±
*(
u32
));

753 
	`ck±Ch™geEndü¬ess
(
aCk±
, 
nCk±
);

754 if–
	`ck±ChecksumOk
(
aCk±
) ){

755 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

756 
	`mem˝y
(
pShm
->
aS«p1
, 
aCk±
, 
nCk±
*(
u32
));

757 
	`mem˝y
(
pShm
->
aS«p2
, 
aCk±
, 
nCk±
*(
u32
));

758 
	`mem˝y
(
pDb
->
aS«pshŸ
, 
aCk±
, 
nCk±
*(
u32
));

759 
pShm
->
iMëaPage
 = 
iMëa
;

760 
bLﬂded
 = 1;

764 
	`lsmFªe
(
pDb
->
pEnv
, 
aCk±
);

765 *
pRc
 = 
rc
;

767  
bLﬂded
;

768 
	}
}

774 
	$ck±LﬂdEm±y
(
lsm_db
 *
pDb
){

775 
u32
 
aCk±
[] = {

779 
LSM_COMPRESSION_EMPTY
,

791 
u32
 
nCk±
 = 
	`¨øy_size
(
aCk±
);

792 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

794 
aCk±
[
CKPT_HDR_NCKPT
] = 
nCk±
;

795 
aCk±
[
CKPT_HDR_BLKSZ
] = 
pDb
->
nDÊtBlksz
;

796 
aCk±
[
CKPT_HDR_PGSZ
] = 
pDb
->
nDÊtPgsz
;

797 
	`ck±Checksum
(
aCk±
, 
	`¨øy_size
◊Ck±), &aCk±[
nCk±
-2], &aCkpt[nCkpt-1]);

799 
	`mem˝y
(
pShm
->
aS«p1
, 
aCk±
, 
nCk±
*(
u32
));

800 
	`mem˝y
(
pShm
->
aS«p2
, 
aCk±
, 
nCk±
*(
u32
));

801 
	`mem˝y
(
pDb
->
aS«pshŸ
, 
aCk±
, 
nCk±
*(
u32
));

802 
	}
}

808 
	$lsmCheckpoötRecovî
(
lsm_db
 *
pDb
){

809 
rc
 = 
LSM_OK
;

810 
i64
 
iId1
;

811 
i64
 
iId2
;

812 
bLﬂded
 = 0;

813 
cmp
;

814 
MëaPage
 *
≠Pg
[2] = {0, 0};

816 
rc
 = 
	`lsmFsMëaPageGë
(
pDb
->
pFS
, 0, 1, &
≠Pg
[0]);

817 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmFsMëaPageGë
(
pDb
->
pFS
, 0, 2, &
≠Pg
[1]);

819 
iId1
 = 
	`ck±LﬂdId
(
≠Pg
[0]);

820 
iId2
 = 
	`ck±LﬂdId
(
≠Pg
[1]);

821 
cmp
 = (
iId2
 > 
iId1
);

822 
bLﬂded
 = 
	`ck±TryLﬂd
(
pDb
, 
≠Pg
[
cmp
?1:0], (cmp?2:1), &
rc
);

823 if–
bLﬂded
==0 ){

824 
bLﬂded
 = 
	`ck±TryLﬂd
(
pDb
, 
≠Pg
[
cmp
?0:1], (cmp?1:2), &
rc
);

829 if–
bLﬂded
==0 ){

830 
	`ck±LﬂdEm±y
(
pDb
);

833 
	`lsmFsMëaPageRñó£
(
≠Pg
[0]);

834 
	`lsmFsMëaPageRñó£
(
≠Pg
[1]);

836  
rc
;

837 
	}
}

842 
	$lsmCheckpoötSt‹e
(
lsm_db
 *
pDb
, 
iMëa
){

843 
MëaPage
 *
pPg
 = 0;

844 
rc
;

846 
	`as£π
–
iMëa
==1 || iMeta==2 );

847 
rc
 = 
	`lsmFsMëaPageGë
(
pDb
->
pFS
, 1, 
iMëa
, &
pPg
);

848 if–
rc
==
LSM_OK
 ){

849 
u8
 *
aD©a
;

850 
nD©a
;

851 
nCk±
;

853 
nCk±
 = ()
pDb
->
aS«pshŸ
[
CKPT_HDR_NCKPT
];

854 
aD©a
 = 
	`lsmFsMëaPageD©a
(
pPg
, &
nD©a
);

855 
	`mem˝y
(
aD©a
, 
pDb
->
aS«pshŸ
, 
nCk±
*(
u32
));

856 
	`ck±Ch™geEndü¬ess
((
u32
 *)
aD©a
, 
nCk±
);

857 
rc
 = 
	`lsmFsMëaPageRñó£
(
pPg
);

860  
rc
;

861 
	}
}

866 
	$lsmCheckpoötLﬂd
(
lsm_db
 *
pDb
, *
piRód
){

867 
nRem
 = 
LSM_ATTEMPTS_BEFORE_PROTOCOL
;

868 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

869  (
nRem
--)>0 ){

870 
nI¡
;

872 
nI¡
 = 
pShm
->
aS«p1
[
CKPT_HDR_NCKPT
];

873 if–
nI¡
<=(
LSM_META_PAGE_SIZE
 / (
u32
)) ){

874 
	`mem˝y
(
pDb
->
aS«pshŸ
, 
pShm
->
aS«p1
, 
nI¡
*(
u32
));

875 if–
	`ck±ChecksumOk
(
pDb
->
aS«pshŸ
) ){

876 if–
piRód
 ) *piRead = 1;

877  
LSM_OK
;

881 
nI¡
 = 
pShm
->
aS«p2
[
CKPT_HDR_NCKPT
];

882 if–
nI¡
<=(
LSM_META_PAGE_SIZE
 / (
u32
)) ){

883 
	`mem˝y
(
pDb
->
aS«pshŸ
, 
pShm
->
aS«p2
, 
nI¡
*(
u32
));

884 if–
	`ck±ChecksumOk
(
pDb
->
aS«pshŸ
) ){

885 if–
piRód
 ) *piRead = 2;

886  
LSM_OK
;

890 
	`lsmShmB¨rõr
(
pDb
);

892  
LSM_PROTOCOL_BKPT
;

893 
	}
}

895 
	$lsmInfoCom¥essi⁄Id
(
lsm_db
 *
db
, 
u32
 *
piCmpId
){

896 
rc
;

898 
	`as£π
–
db
->
pClõ¡
==0 && db->
pW‹kî
==0 );

899 
rc
 = 
	`lsmCheckpoötLﬂd
(
db
, 0);

900 if–
rc
==
LSM_OK
 ){

901 *
piCmpId
 = 
db
->
aS«pshŸ
[
CKPT_HDR_CMPID
];

904  
rc
;

905 
	}
}

907 
	$lsmCheckpoötLﬂdOk
(
lsm_db
 *
pDb
, 
iS«p
){

908 
u32
 *
aShm
;

909 
	`as£π
–
iS«p
==1 || iSnap==2 );

910 
aShm
 = (
iS«p
==1Ë? 
pDb
->
pShmhdr
->
aS«p1
 :ÖDb->pShmhdr->
aS«p2
;

911  (
	`lsmCheckpoötId
(
pDb
->
aS«pshŸ
, 0)=ˆsmCheckpoötId(
aShm
, 0) );

912 
	}
}

914 
	$lsmCheckpoötClõ¡CacheOk
(
lsm_db
 *
pDb
){

915  ( 
pDb
->
pClõ¡


916 && 
pDb
->
pClõ¡
->
iId
==
	`lsmCheckpoötId
’Db->
aS«pshŸ
, 0)

917 && 
pDb
->
pClõ¡
->
iId
==
	`lsmCheckpoötId
’Db->
pShmhdr
->
aS«p1
, 0)

918 && 
pDb
->
pClõ¡
->
iId
==
	`lsmCheckpoötId
’Db->
pShmhdr
->
aS«p2
, 0)

920 
	}
}

922 
	$lsmCheckpoötLﬂdW‹kî
(
lsm_db
 *
pDb
){

923 
rc
;

924 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

925 
nI¡1
;

926 
nI¡2
;

929 
	`as£π
(

930 
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_WORKER
, 
LSM_LOCK_EXCL
)

931 || 
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_EXCL
)

935 
nI¡1
 = 
pShm
->
aS«p1
[
CKPT_HDR_NCKPT
];

936 
nI¡2
 = 
pShm
->
aS«p2
[
CKPT_HDR_NCKPT
];

937 if–
nI¡1
!=
nI¡2
 || 
	`memcmp
(
pShm
->
aS«p1
,ÖShm->
aS«p2
,ÇI¡2*(
u32
)) ){

938 if–
	`ck±ChecksumOk
(
pShm
->
aS«p1
) ){

939 
	`mem˝y
(
pShm
->
aS«p2
,ÖShm->
aS«p1
, (
u32
)*
nI¡1
);

940 }if–
	`ck±ChecksumOk
(
pShm
->
aS«p2
) ){

941 
	`mem˝y
(
pShm
->
aS«p1
,ÖShm->
aS«p2
, (
u32
)*
nI¡2
);

943  
LSM_PROTOCOL_BKPT
;

947 
rc
 = 
	`lsmCheckpoötDe£rülize
(
pDb
, 1, 
pShm
->
aS«p1
, &pDb->
pW‹kî
);

948 if–
pDb
->
pW‹kî
 )ÖDb->pW‹kî->
pD©aba£
 =ÖDb->pDatabase;

950 if–
rc
==
LSM_OK
 ){

951 
rc
 = 
	`lsmCheckCom¥essi⁄Id
(
pDb
,ÖDb->
pW‹kî
->
iCmpId
);

955 
	`as£π
–
rc
!=
LSM_OK
 || 
	`lsmFsI¡egrôyCheck
(
pDb
) );

957  
rc
;

958 
	}
}

960 
	$lsmCheckpoötDe£rülize
(

961 
lsm_db
 *
pDb
,

962 
bIn˛Fªñi°
,

963 
u32
 *
aCk±
,

964 
S«pshŸ
 **
µS«p


966 
rc
 = 
LSM_OK
;

967 
S«pshŸ
 *
pNew
;

969 
pNew
 = (
S«pshŸ
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (S«pshŸ), &
rc
);

970 if–
rc
==
LSM_OK
 ){

971 
Levñ
 *
pLvl
;

972 
nFªe
;

973 
i
;

974 
nLevñ
 = ()
aCk±
[
CKPT_HDR_NLEVEL
];

975 
iIn
 = 
CKPT_HDR_SIZE
 + 
CKPT_APPENDLIST_SIZE
 + 
CKPT_LOGPTR_SIZE
;

977 
pNew
->
iId
 = 
	`lsmCheckpoötId
(
aCk±
, 0);

978 
pNew
->
nBlock
 = 
aCk±
[
CKPT_HDR_NBLOCK
];

979 
pNew
->
nWrôe
 = 
aCk±
[
CKPT_HDR_NWRITE
];

980 
rc
 = 
	`ck±LﬂdLevñs
(
pDb
, 
aCk±
, &
iIn
, 
nLevñ
, &
pNew
->
pLevñ
);

981 
pNew
->
iLogOff
 = 
	`lsmCheckpoötLogOff£t
(
aCk±
);

982 
pNew
->
iCmpId
 = 
aCk±
[
CKPT_HDR_CMPID
];

985 
i
=0; i<
LSM_APPLIST_SZ
; i++){

986 
u32
 *
a
 = &
aCk±
[
CKPT_HDR_SIZE
 + 
CKPT_LOGPTR_SIZE
 + 
i
*2];

987 
pNew
->
aiAµíd
[
i
] = 
	`ck±Ród64
(
a
);

991 
pNew
->
ªdúe˘
.
n
 = 
aCk±
[
iIn
++];

992 if–
pNew
->
ªdúe˘
.
n
 ){

993 
pNew
->
ªdúe˘
.
a
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
,

994 ((
Redúe˘E¡ry
Ë* 
LSM_MAX_BLOCK_REDIRECTS
), &
rc


996 if–
rc
==
LSM_OK
 ){

997 
i
=0; i<
pNew
->
ªdúe˘
.
n
; i++){

998 
pNew
->
ªdúe˘
.
a
[
i
].
iFrom
 = 
aCk±
[
iIn
++];

999 
pNew
->
ªdúe˘
.
a
[
i
].
iTo
 = 
aCk±
[
iIn
++];

1002 
pLvl
=
pNew
->
pLevñ
;ÖLvl->
pNext
;ÖLvl=pLvl->pNext);

1003 if–
pLvl
->
nRight
 ){

1004 
pLvl
->
aRhs
[pLvl->
nRight
-1].
pRedúe˘
 = &
pNew
->
ªdúe˘
;

1006 
pLvl
->
lhs
.
pRedúe˘
 = &
pNew
->
ªdúe˘
;

1011 if–
rc
==
LSM_OK
 && 
bIn˛Fªñi°
 ){

1012 
nFªe
 = 
aCk±
[
iIn
++];

1013 if–
nFªe
 ){

1014 
pNew
->
‰ìli°
.
aE¡ry
 = (
Fªñi°E¡ry
 *)
	`lsmMÆlocZîoRc
(

1015 
pDb
->
pEnv
, (
Fªñi°E¡ry
)*
nFªe
, &
rc


1017 if–
rc
==
LSM_OK
 ){

1018 
i
;

1019 
i
=0; i<
nFªe
; i++){

1020 
Fªñi°E¡ry
 *
p
 = &
pNew
->
‰ìli°
.
aE¡ry
[
i
];

1021 
p
->
iBlk
 = 
aCk±
[
iIn
++];

1022 
p
->
iId
 = ((
i64
)(
aCk±
[
iIn
])<<32) +áCkpt[iIn+1];

1023 
iIn
 += 2;

1025 
pNew
->
‰ìli°
.
nE¡ry
 =ÖNew->‰ìli°.
nAŒoc
 = 
nFªe
;

1031 if–
rc
!=
LSM_OK
 ){

1032 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
, 
pNew
);

1033 
pNew
 = 0;

1036 *
µS«p
 = 
pNew
;

1037  
rc
;

1038 
	}
}

1051 
	$lsmD©aba£FuŒ
(
lsm_db
 *
pDb
){

1052 
Levñ
 *
p
;

1053 
nRhs
 = 0;

1055 
	`as£π
–
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_WORKER
, 
LSM_LOCK_EXCL
) );

1056 
	`as£π
–
pDb
->
pW‹kî
 );

1058 
p
=
pDb
->
pW‹kî
->
pLevñ
;Ö;Öı->
pNext
){

1059 
nRhs
 +(
p
->
nRight
 ?Ö->nRight : 1);

1062  (
nRhs
 >
LSM_MAX_RHS_SEGMENTS
);

1063 
	}
}

1076 
	$lsmCheckpoötSaveW‹kî
(
lsm_db
 *
pDb
, 
bFlush
){

1077 
S«pshŸ
 *
pS«p
 = 
pDb
->
pW‹kî
;

1078 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

1079 *
p
 = 0;

1080 
n
 = 0;

1081 
rc
;

1083 
pS«p
->
iId
++;

1084 
rc
 = 
	`ck±Exp‹tS«pshŸ
(
pDb
, 
bFlush
, 
pS«p
->
iId
, 1, &
p
, &
n
);

1085 if–
rc
!=
LSM_OK
 ) Ñc;

1086 
	`as£π
–
	`ck±ChecksumOk
((
u32
 *)
p
) );

1088 
	`as£π
–
n
<=
LSM_META_PAGE_SIZE
 );

1089 
	`mem˝y
(
pShm
->
aS«p2
, 
p
, 
n
);

1090 
	`lsmShmB¨rõr
(
pDb
);

1091 
	`mem˝y
(
pShm
->
aS«p1
, 
p
, 
n
);

1092 
	`lsmFªe
(
pDb
->
pEnv
, 
p
);

1094 
	`as£π
–
	`lsmFsI¡egrôyCheck
(
pDb
) );

1095  
LSM_OK
;

1096 
	}
}

1109 
	$lsmCheckpoötSyn˚d
(
lsm_db
 *
pDb
, 
i64
 *
piId
, i64 *
piLog
, 
u32
 *
≤Wrôe
){

1110 
rc
 = 
LSM_OK
;

1111 
MëaPage
 *
pPg
;

1112 
u32
 
iMëa
;

1114 
iMëa
 = 
pDb
->
pShmhdr
->
iMëaPage
;

1115 if–
iMëa
==1 || iMeta==2 ){

1116 
rc
 = 
	`lsmFsMëaPageGë
(
pDb
->
pFS
, 0, 
iMëa
, &
pPg
);

1117 if–
rc
==
LSM_OK
 ){

1118 
nCk±
;

1119 
nD©a
;

1120 
u8
 *
aD©a
;

1122 
aD©a
 = 
	`lsmFsMëaPageD©a
(
pPg
, &
nD©a
);

1123 
	`as£π
–
nD©a
==
LSM_META_PAGE_SIZE
 );

1124 
nCk±
 = 
	`lsmGëU32
(&
aD©a
[
CKPT_HDR_NCKPT
*(
u32
)]);

1125 if–
nCk±
<(
LSM_META_PAGE_SIZE
/(
u32
)) ){

1126 
u32
 *
aC›y
 = 
	`lsmMÆlocRc
(
pDb
->
pEnv
, (u32Ë* 
nCk±
, &
rc
);

1127 if–
aC›y
 ){

1128 
	`mem˝y
(
aC›y
, 
aD©a
, 
nCk±
*(
u32
));

1129 
	`ck±Ch™geEndü¬ess
(
aC›y
, 
nCk±
);

1130 if–
	`ck±ChecksumOk
(
aC›y
) ){

1131 if–
piId
 ) *piId = 
	`lsmCheckpoötId
(
aC›y
, 0);

1132 if–
piLog
 ) *piLog = (
	`lsmCheckpoötLogOff£t
(
aC›y
) >> 1);

1133 if–
≤Wrôe
 ) *≤Wrôê
aC›y
[
CKPT_HDR_NWRITE
];

1135 
	`lsmFªe
(
pDb
->
pEnv
, 
aC›y
);

1138 
	`lsmFsMëaPageRñó£
(
pPg
);

1142 if–(
iMëa
!=1 && iMëa!=2Ë|| 
rc
!=
LSM_OK
 || 
pDb
->
pShmhdr
->
iMëaPage
!=iMeta ){

1143 if–
piId
 ) *piId = 0;

1144 if–
piLog
 ) *piLog = 0;

1145 if–
≤Wrôe
 ) *pnWrite = 0;

1147  
rc
;

1148 
	}
}

1156 
i64
 
	$lsmCheckpoötId
(
u32
 *
aCk±
, 
bDisk
){

1157 
i64
 
iId
;

1158 if–
bDisk
 ){

1159 
u8
 *
aD©a
 = (u8 *)
aCk±
;

1160 
iId
 = (((
i64
)
	`lsmGëU32
(&
aD©a
[
CKPT_HDR_ID_MSW
*4])) << 32);

1161 
iId
 +((
i64
)
	`lsmGëU32
(&
aD©a
[
CKPT_HDR_ID_LSW
*4]));

1163 
iId
 = ((
i64
)
aCk±
[
CKPT_HDR_ID_MSW
] << 32Ë+ (i64ÔCk±[
CKPT_HDR_ID_LSW
];

1165  
iId
;

1166 
	}
}

1168 
u32
 
	$lsmCheckpoötNBlock
(
u32
 *
aCk±
){

1169  
aCk±
[
CKPT_HDR_NBLOCK
];

1170 
	}
}

1172 
u32
 
	$lsmCheckpoötNWrôe
(
u32
 *
aCk±
, 
bDisk
){

1173 if–
bDisk
 ){

1174  
	`lsmGëU32
((
u8
 *)&
aCk±
[
CKPT_HDR_NWRITE
]);

1176  
aCk±
[
CKPT_HDR_NWRITE
];

1178 
	}
}

1180 
i64
 
	$lsmCheckpoötLogOff£t
(
u32
 *
aCk±
){

1181  ((
i64
)
aCk±
[
CKPT_HDR_LO_MSW
] << 32Ë+ (i64ÔCk±[
CKPT_HDR_LO_LSW
];

1182 
	}
}

1184 
	$lsmCheckpoötPgsz
(
u32
 *
aCk±
){  (ÔCk±[
CKPT_HDR_PGSZ
]; 
	}
}

1186 
	$lsmCheckpoötBlksz
(
u32
 *
aCk±
){  (ÔCk±[
CKPT_HDR_BLKSZ
]; 
	}
}

1188 
	$lsmCheckpoötLogoff£t
(

1189 
u32
 *
aCk±
,

1190 
DbLog
 *
pLog


1192 
pLog
->
aRegi⁄
[2].
iSèπ
 = (
	`lsmCheckpoötLogOff£t
(
aCk±
) >> 1);

1194 
pLog
->
cksum0
 = 
aCk±
[
CKPT_HDR_LO_CKSUM1
];

1195 
pLog
->
cksum1
 = 
aCk±
[
CKPT_HDR_LO_CKSUM2
];

1196 
pLog
->
iS«pshŸId
 = 
	`lsmCheckpoötId
(
aCk±
, 0);

1197 
	}
}

1199 
	$lsmCheckpoötZîoLogoff£t
(
lsm_db
 *
pDb
){

1200 
u32
 
nCk±
;

1202 
nCk±
 = 
pDb
->
aS«pshŸ
[
CKPT_HDR_NCKPT
];

1203 
	`as£π
–
nCk±
>
CKPT_HDR_NCKPT
 );

1204 
	`as£π
–
nCk±
==
pDb
->
pShmhdr
->
aS«p1
[
CKPT_HDR_NCKPT
] );

1205 
	`as£π
–0==
	`memcmp
(
pDb
->
aS«pshŸ
,ÖDb->
pShmhdr
->
aS«p1
, 
nCk±
*(
u32
)) );

1206 
	`as£π
–0==
	`memcmp
(
pDb
->
aS«pshŸ
,ÖDb->
pShmhdr
->
aS«p2
, 
nCk±
*(
u32
)) );

1208 
pDb
->
aS«pshŸ
[
CKPT_HDR_LO_MSW
] = 0;

1209 
pDb
->
aS«pshŸ
[
CKPT_HDR_LO_LSW
] = 0;

1210 
	`ck±Checksum
(
pDb
->
aS«pshŸ
, 
nCk±
,

1211 &
pDb
->
aS«pshŸ
[
nCk±
-2], &pDb->aSnapshot[nCkpt-1]

1214 
	`mem˝y
(
pDb
->
pShmhdr
->
aS«p1
,ÖDb->
aS«pshŸ
, 
nCk±
*(
u32
));

1215 
	`mem˝y
(
pDb
->
pShmhdr
->
aS«p2
,ÖDb->
aS«pshŸ
, 
nCk±
*(
u32
));

1216 
	}
}

1222 
	$lsmCheckpoötSize
(
lsm_db
 *
db
, *
≤KB
){

1223 
rc
 = 
LSM_OK
;

1224 
u32
 
nSyn˚d
;

1228 
rc
 = 
	`lsmCheckpoötSyn˚d
(
db
, 0, 0, &
nSyn˚d
);

1230 if–
rc
==
LSM_OK
 ){

1231 
u32
 
nPgsz
 = 
db
->
pShmhdr
->
aS«p1
[
CKPT_HDR_PGSZ
];

1232 
u32
 
nWrôe
 = 
db
->
pShmhdr
->
aS«p1
[
CKPT_HDR_NWRITE
];

1233 *
≤KB
 = ()(–((
i64
)(
nWrôe
 - 
nSyn˚d
Ë* 
nPgsz
) + 1023) / 1024);

1236  
rc
;

1237 
	}
}

	@src/lsm_file.c

150 
	~"lsmI¡.h
"

152 
	~<sys/ty≥s.h
>

153 
	~<sys/°©.h
>

154 
	~<f˙é.h
>

211 
	sFûeSy°em
 {

212 
lsm_db
 *
	mpDb
;

213 
lsm_ív
 *
	mpEnv
;

214 *
	mzDb
;

215 *
	mzLog
;

216 
	mnMëasize
;

217 
	mnPagesize
;

218 
	mnBlocksize
;

221 
LsmFûe
 *
	mpLsmFûe
;

222 
lsm_fûe
 *
	mfdDb
;

223 
lsm_fûe
 *
	mfdLog
;

224 
	mszSe˘‹
;

228 
lsm_com¥ess
 *
	mpCom¥ess
;

229 
u8
 *
	maIBuf„r
;

230 
u8
 *
	maOBuf„r
;

231 
	mnBuf„r
;

234 
i64
 
	mnM≠Limô
;

235 *
	mpM≠
;

236 
i64
 
	mnM≠
;

237 
Page
 *
	mpFªe
;

238 
Page
 *
	mpM≠≥d
;

241 
	mnCacheMax
;

242 
	mnCacheAŒoc
;

243 
Page
 *
	mpLruFú°
;

244 
Page
 *
	mpLruLa°
;

245 
	mnHash
;

246 
Page
 **
	m≠Hash
;

247 
Page
 *
	mpWaôög
;

250 
	mnOut
;

251 
	mnWrôe
;

252 
	mnRód
;

268 
	sPage
 {

269 
u8
 *
	maD©a
;

270 
	mnD©a
;

271 
Pgno
 
	miPg
;

272 
	mnRef
;

273 
	mÊags
;

274 
Page
 *
	mpHashNext
;

275 
Page
 *
	mpLruNext
;

276 
Page
 *
	mpLruPªv
;

277 
FûeSy°em
 *
	mpFS
;

280 
	mnCom¥ess
;

281 
	mnCom¥essPªv
;

282 
Segmít
 *
	mpSeg
;

285 
Page
 *
	mpWaôögNext
;

286 
Page
 *
	mpFªeNext
;

287 
Page
 *
	mpM≠≥dNext
;

294 
	sMëaPage
 {

295 
	miPg
;

296 
	mbWrôe
;

297 
u8
 *
	maD©a
;

298 
FûeSy°em
 *
	mpFS
;

304 
	#PAGE_DIRTY
 0x00000001

	)

305 
	#PAGE_FREE
 0x00000002

	)

306 
	#PAGE_HASPREV
 0x00000004

	)

312 
	#BLOCK1_HDR_SIZE
(
pgsz
Ë
	`LSM_MAX
(1, 8192/’gsz))

	)

318 #i‚de‡
NDEBUG


319 
	$lsmI€ºBk±
(){

320 
nEº
 = 0;

321 
nEº
++;

322 
	}
}

323 
	$IOERR_WRAPPER
(
rc
){

324 if–
rc
!=
LSM_OK
 ) 
	`lsmI€ºBk±
();

325  
rc
;

326 
	}
}

328 
	#IOERR_WRAPPER
(
rc
Ë‘c)

	)

331 #ifde‡
NDEBUG


332 
	#as£π_li°s_¨e_ok
(
x
)

	)

334 
Page
 *
fsPageFödInHash
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
, *
piHash
);

336 
	$as£π_li°s_¨e_ok
(
FûeSy°em
 *
pFS
){

338 
Page
 *
p
;

340 
	`as£π
–
pFS
->
nM≠Limô
>=0 );

344 
p
=
pFS
->
pLruFú°
;Ö;Öı->
pLruNext
){

345 
	`as£π
–
p
==
pFS
->
pLruFú°
 ||Ö->
pLruPªv
!=0 );

346 
	`as£π
–
p
==
pFS
->
pLruLa°
 ||Ö->
pLruNext
!=0 );

347 
	`as£π
–
p
->
pLruPªv
==0 ||Ö->pLruPªv->
pLruNext
==p );

348 
	`as£π
–
p
->
pLruNext
==0 ||Ö->pLruNext->
pLruPªv
==p );

349 
	`as£π
–
p
->
nRef
==0 );

350 
	`as£π
–
p
->
Êags
 & 
PAGE_FREE
 );

351 
	`as£π
–
p
==
	`fsPageFödInHash
(
pFS
,Ö->
iPg
, 0) );

354 
	}
}

370 
	$lsmEnvO≥n
(
lsm_ív
 *
pEnv
, c⁄° *
zFûe
, 
Êags
, 
lsm_fûe
 **
µNew
){

371  
pEnv
->
	`xO≥n
’Env, 
zFûe
, 
Êags
, 
µNew
);

372 
	}
}

374 
	$lsmEnvRód
(

375 
lsm_ív
 *
pEnv
,

376 
lsm_fûe
 *
pFûe
,

377 
lsm_i64
 
iOff
,

378 *
pRód
,

379 
nRód


381  
	`IOERR_WRAPPER
–
pEnv
->
	`xRód
(
pFûe
, 
iOff
, 
pRód
, 
nRód
) );

382 
	}
}

384 
	$lsmEnvWrôe
(

385 
lsm_ív
 *
pEnv
,

386 
lsm_fûe
 *
pFûe
,

387 
lsm_i64
 
iOff
,

388 c⁄° *
pWrôe
,

389 
nWrôe


391  
	`IOERR_WRAPPER
–
pEnv
->
	`xWrôe
(
pFûe
, 
iOff
, (*)
pWrôe
, 
nWrôe
) );

392 
	}
}

394 
	$lsmEnvSync
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
){

395  
	`IOERR_WRAPPER
–
pEnv
->
	`xSync
(
pFûe
) );

396 
	}
}

398 
	$lsmEnvSe˘‹Size
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
){

399  
pEnv
->
	`xSe˘‹Size
(
pFûe
);

400 
	}
}

402 
	$lsmEnvClo£
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
){

403  
	`IOERR_WRAPPER
–
pEnv
->
	`xClo£
(
pFûe
) );

404 
	}
}

406 
	$lsmEnvTrunˇã
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
, 
lsm_i64
 
nByã
){

407  
	`IOERR_WRAPPER
–
pEnv
->
	`xTrunˇã
(
pFûe
, 
nByã
) );

408 
	}
}

410 
	$lsmEnvU∆ök
(
lsm_ív
 *
pEnv
, c⁄° *
zDñ
){

411  
	`IOERR_WRAPPER
–
pEnv
->
	`xU∆ök
’Env, 
zDñ
) );

412 
	}
}

414 
	$lsmEnvRem≠
(

415 
lsm_ív
 *
pEnv
,

416 
lsm_fûe
 *
pFûe
,

417 
i64
 
szMö
,

418 **
µM≠
,

419 
i64
 *
pszM≠


421  
pEnv
->
	`xRem≠
(
pFûe
, 
szMö
, 
µM≠
, 
pszM≠
);

422 
	}
}

424 
	$lsmEnvLock
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
, 
iLock
, 
eLock
){

425 if–
pFûe
==0 )  
LSM_OK
;

426  
pEnv
->
	`xLock
(
pFûe
, 
iLock
, 
eLock
);

427 
	}
}

429 
	$lsmEnvTe°Lock
(

430 
lsm_ív
 *
pEnv
,

431 
lsm_fûe
 *
pFûe
,

432 
iLock
,

433 
nLock
,

434 
eLock


436  
pEnv
->
	`xTe°Lock
(
pFûe
, 
iLock
, 
nLock
, 
eLock
);

437 
	}
}

439 
	$lsmEnvShmM≠
(

440 
lsm_ív
 *
pEnv
,

441 
lsm_fûe
 *
pFûe
,

442 
iChunk
,

443 
sz
,

444 **
µOut


446  
pEnv
->
	`xShmM≠
(
pFûe
, 
iChunk
, 
sz
, 
µOut
);

447 
	}
}

449 
	$lsmEnvShmB¨rõr
(
lsm_ív
 *
pEnv
){

450  
pEnv
->
	`xShmB¨rõr
();

451 
	}
}

453 
	$lsmEnvShmUnm≠
(
lsm_ív
 *
pEnv
, 
lsm_fûe
 *
pFûe
, 
bDñ
){

454 
pEnv
->
	`xShmUnm≠
(
pFûe
, 
bDñ
);

455 
	}
}

457 
	$lsmEnvSÀï
(
lsm_ív
 *
pEnv
, 
nUs
){

458 
pEnv
->
	`xSÀï
’Env, 
nUs
);

459 
	}
}

466 
	$lsmFsWrôeLog
(
FûeSy°em
 *
pFS
, 
i64
 
iOff
, 
LsmSåög
 *
pSå
){

467 
	`as£π
–
pFS
->
fdLog
 );

468  
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdLog
, 
iOff
, 
pSå
->
z
,ÖSå->
n
);

469 
	}
}

474 
	$lsmFsSyncLog
(
FûeSy°em
 *
pFS
){

475 
	`as£π
–
pFS
->
fdLog
 );

476  
	`lsmEnvSync
(
pFS
->
pEnv
,ÖFS->
fdLog
);

477 
	}
}

483 
	$lsmFsRódLog
(
FûeSy°em
 *
pFS
, 
i64
 
iOff
, 
nRód
, 
LsmSåög
 *
pSå
){

484 
rc
;

485 
	`as£π
–
pFS
->
fdLog
 );

486 
rc
 = 
	`lsmSåögExãnd
(
pSå
, 
nRód
);

487 if–
rc
==
LSM_OK
 ){

488 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdLog
, 
iOff
, &
pSå
->
z
[pSå->
n
], 
nRód
);

489 
pSå
->
n
 +
nRód
;

491  
rc
;

492 
	}
}

497 
	$lsmFsTrunˇãLog
(
FûeSy°em
 *
pFS
, 
i64
 
nByã
){

498 if–
pFS
->
fdLog
==0 )  
LSM_OK
;

499  
	`lsmEnvTrunˇã
(
pFS
->
pEnv
,ÖFS->
fdLog
, 
nByã
);

500 
	}
}

505 
	$lsmFsTrunˇãDb
(
FûeSy°em
 *
pFS
, 
i64
 
nByã
){

506 if–
pFS
->
fdDb
==0 )  
LSM_OK
;

507  
	`lsmEnvTrunˇã
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
nByã
);

508 
	}
}

514 
	$lsmFsClo£AndDñëeLog
(
FûeSy°em
 *
pFS
){

515 *
zDñ
;

517 if–
pFS
->
fdLog
 ){

518 
	`lsmEnvClo£
(
pFS
->
pEnv
,ÖFS->
fdLog
 );

519 
pFS
->
fdLog
 = 0;

522 
zDñ
 = 
	`lsmMÆlocPrötf
(
pFS
->
pEnv
, "%s-log",ÖFS->
zDb
);

523 if–
zDñ
 ){

524 
	`lsmEnvU∆ök
(
pFS
->
pEnv
, 
zDñ
);

525 
	`lsmFªe
(
pFS
->
pEnv
, 
zDñ
);

527  
LSM_OK
;

528 
	}
}

534 
	$fsMm≠Page
(
FûeSy°em
 *
pFS
, 
Pgno
 
iRól
){

535  ((
i64
)
iRól
*
pFS
->
nPagesize
 <pFS->
nM≠Limô
);

536 
	}
}

542 
	$fsHashKey
(
nHash
, 
iPg
){

543  (
iPg
 % 
nHash
);

544 
	}
}

550 
lsm_fûe
 *
	$fsO≥nFûe
(

551 
FûeSy°em
 *
pFS
,

552 
bRód⁄ly
,

553 
bLog
,

554 *
pRc


556 
lsm_fûe
 *
pFûe
 = 0;

557 if–*
pRc
==
LSM_OK
 ){

558 
Êags
 = (
bRód⁄ly
 ? 
LSM_OPEN_READONLY
 : 0);

559 c⁄° *
zP©h
 = (
bLog
 ? 
pFS
->
zLog
 :ÖFS->
zDb
);

561 *
pRc
 = 
	`lsmEnvO≥n
(
pFS
->
pEnv
, 
zP©h
, 
Êags
, &
pFûe
);

563  
pFûe
;

564 
	}
}

577 
	$lsmFsO≥nLog
(
lsm_db
 *
db
, *
pbO≥n
){

578 
rc
 = 
LSM_OK
;

579 
FûeSy°em
 *
pFS
 = 
db
->pFS;

581 if–0==
pFS
->
fdLog
 ){

582 
pFS
->
fdLog
 = 
	`fsO≥nFûe
’FS, 
db
->
bRód⁄ly
, 1, &
rc
);

584 if–
rc
==
LSM_IOERR_NOENT
 && 
db
->
bRód⁄ly
 ){

585 
rc
 = 
LSM_OK
;

589 if–
pbO≥n
 ) *pbO≥¿(
pFS
->
fdLog
!=0);

590  
rc
;

591 
	}
}

596 
	$lsmFsClo£Log
(
lsm_db
 *
db
){

597 
FûeSy°em
 *
pFS
 = 
db
->pFS;

598 if–
pFS
->
fdLog
 ){

599 
	`lsmEnvClo£
(
pFS
->
pEnv
,ÖFS->
fdLog
);

600 
pFS
->
fdLog
 = 0;

602 
	}
}

617 
	$lsmFsO≥n
(

618 
lsm_db
 *
pDb
,

619 c⁄° *
zDb
,

620 
bRód⁄ly


622 
FûeSy°em
 *
pFS
;

623 
rc
 = 
LSM_OK
;

624 
nDb
 = 
	`°æí
(
zDb
);

625 
nByã
;

627 
	`as£π
–
pDb
->
pFS
==0 );

628 
	`as£π
–
pDb
->
pW‹kî
==0 &&ÖDb->
pClõ¡
==0 );

630 
nByã
 = (
FûeSy°em
Ë+ 
nDb
+1 +ÇDb+4+1;

631 
pFS
 = (
FûeSy°em
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, 
nByã
, &
rc
);

632 if–
pFS
 ){

633 
LsmFûe
 *
pLsmFûe
;

634 
pFS
->
zDb
 = (*)&pFS[1];

635 
pFS
->
zLog
 = &pFS->
zDb
[
nDb
+1];

636 
pFS
->
nPagesize
 = 
LSM_DFLT_PAGE_SIZE
;

637 
pFS
->
nBlocksize
 = 
LSM_DFLT_BLOCK_SIZE
;

638 
pFS
->
nMëasize
 = 4 * 1024;

639 
pFS
->
pDb
 =ÖDb;

640 
pFS
->
pEnv
 = 
pDb
->pEnv;

643 
	`mem˝y
(
pFS
->
zDb
, zDb, 
nDb
+1);

644 
	`mem˝y
(
pFS
->
zLog
, 
zDb
, 
nDb
);

645 
	`mem˝y
(&
pFS
->
zLog
[
nDb
], "-log", 5);

649 
pFS
->
nCacheMax
 = 2048*1024 /ÖFS->
nPagesize
;

650 
pFS
->
nHash
 = 4096;

651 
pFS
->
≠Hash
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
Page
 *Ë*ÖFS->
nHash
, &
rc
);

654 
pLsmFûe
 = 
	`lsmDbRecy˛eFd
(
pDb
);

655 if–
pLsmFûe
 ){

656 
pFS
->
pLsmFûe
 =ÖLsmFile;

657 
pFS
->
fdDb
 = 
pLsmFûe
->
pFûe
;

658 
	`mem£t
(
pLsmFûe
, 0, (
LsmFûe
));

660 
pFS
->
pLsmFûe
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
LsmFûe
), &
rc
);

661 if–
rc
==
LSM_OK
 ){

662 
pFS
->
fdDb
 = 
	`fsO≥nFûe
’FS, 
bRód⁄ly
, 0, &
rc
);

666 if–
rc
!=
LSM_OK
 ){

667 
	`lsmFsClo£
(
pFS
);

668 
pFS
 = 0;

670 
pFS
->
szSe˘‹
 = 
	`lsmEnvSe˘‹Size
’FS->
pEnv
,ÖFS->
fdDb
);

674 
pDb
->
pFS
 =ÖFS;

675  
rc
;

676 
	}
}

682 
	$lsmFsC⁄figuª
(
lsm_db
 *
db
){

683 
FûeSy°em
 *
pFS
 = 
db
->pFS;

684 if–
pFS
 ){

685 
lsm_ív
 *
pEnv
 = 
pFS
->pEnv;

686 
Page
 *
pPg
;

688 
	`as£π
–
pFS
->
nOut
==0 );

689 
	`as£π
–
pFS
->
pWaôög
==0 );

690 
	`as£π
–
pFS
->
pM≠≥d
==0 );

693 
	`lsmFªe
(
pEnv
, 
pFS
->
aIBuf„r
);

694 
	`lsmFªe
(
pEnv
, 
pFS
->
aOBuf„r
);

695 
pFS
->
nBuf„r
 = 0;

698 if–
pFS
->
pM≠
 ){

699 
	`lsmEnvRem≠
(
pEnv
, 
pFS
->
fdDb
, -1, &pFS->
pM≠
, &pFS->
nM≠
);

700 
pFS
->
nM≠Limô
 = 0;

704 
pPg
 = 
pFS
->
pLruFú°
;

705  
pPg
 ){

706 
Page
 *
pNext
 = 
pPg
->
pLruNext
;

707 
	`as£π
–
pPg
->
Êags
 & 
PAGE_FREE
 );

708 
	`lsmFªe
(
pEnv
, 
pPg
->
aD©a
);

709 
	`lsmFªe
(
pEnv
, 
pPg
);

710 
pPg
 = 
pNext
;

713 
pPg
 = 
pFS
->
pFªe
;

714  
pPg
 ){

715 
Page
 *
pNext
 = 
pPg
->
pFªeNext
;

716 
	`lsmFªe
(
pEnv
, 
pPg
);

717 
pPg
 = 
pNext
;

721 
pFS
->
nCacheAŒoc
 = 0;

722 
pFS
->
pLruFú°
 = 0;

723 
pFS
->
pLruLa°
 = 0;

724 
pFS
->
pFªe
 = 0;

725 if–
pFS
->
≠Hash
 ){

726 
	`mem£t
(
pFS
->
≠Hash
, 0,ÖFS->
nHash
*(pFS->apHash[0]));

730 if–
db
->
com¥ess
.
xCom¥ess
 ){

731 
pFS
->
pCom¥ess
 = &
db
->
com¥ess
;

732 
pFS
->
nM≠Limô
 = 0;

734 
pFS
->
pCom¥ess
 = 0;

735 if–
db
->
iMm≠
==1 ){

737 
pFS
->
nM≠Limô
 = (
i64
)1 << 60;

740 
pFS
->
nM≠Limô
 = (
i64
)
db
->
iMm≠
 * 1024;

745  
LSM_OK
;

746 
	}
}

751 
	$lsmFsClo£
(
FûeSy°em
 *
pFS
){

752 if–
pFS
 ){

753 
Page
 *
pPg
;

754 
lsm_ív
 *
pEnv
 = 
pFS
->pEnv;

756 
	`as£π
–
pFS
->
nOut
==0 );

757 
pPg
 = 
pFS
->
pLruFú°
;

758  
pPg
 ){

759 
Page
 *
pNext
 = 
pPg
->
pLruNext
;

760 if–
pPg
->
Êags
 & 
PAGE_FREE
 ) 
	`lsmFªe
(
pEnv
,ÖPg->
aD©a
);

761 
	`lsmFªe
(
pEnv
, 
pPg
);

762 
pPg
 = 
pNext
;

765 
pPg
 = 
pFS
->
pFªe
;

766  
pPg
 ){

767 
Page
 *
pNext
 = 
pPg
->
pFªeNext
;

768 if–
pPg
->
Êags
 & 
PAGE_FREE
 ) 
	`lsmFªe
(
pEnv
,ÖPg->
aD©a
);

769 
	`lsmFªe
(
pEnv
, 
pPg
);

770 
pPg
 = 
pNext
;

773 if–
pFS
->
fdDb
 ) 
	`lsmEnvClo£
’FS->
pEnv
,ÖFS->fdDb );

774 if–
pFS
->
fdLog
 ) 
	`lsmEnvClo£
’FS->
pEnv
,ÖFS->fdLog );

775 
	`lsmFªe
(
pEnv
, 
pFS
->
pLsmFûe
);

776 
	`lsmFªe
(
pEnv
, 
pFS
->
≠Hash
);

777 
	`lsmFªe
(
pEnv
, 
pFS
->
aIBuf„r
);

778 
	`lsmFªe
(
pEnv
, 
pFS
->
aOBuf„r
);

779 
	`lsmFªe
(
pEnv
, 
pFS
);

781 
	}
}

804 
LsmFûe
 *
	$lsmFsDe„rClo£
(
FûeSy°em
 *
pFS
){

805 
LsmFûe
 *
p
 = 
pFS
->
pLsmFûe
;

806 
	`as£π
–
p
->
pNext
==0 );

807 
p
->
pFûe
 = 
pFS
->
fdDb
;

808 
pFS
->
fdDb
 = 0;

809 
pFS
->
pLsmFûe
 = 0;

810  
p
;

811 
	}
}

820 
	$lsmFsFûeid
(
lsm_db
 *
pDb
, **
µId
, *
≤Id
){

821 
lsm_ív
 *
pEnv
 = 
pDb
->pEnv;

822 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

823 
rc
;

824 
nId
 = 0;

825 *
pId
;

827 
rc
 = 
pEnv
->
	`xFûeid
(
pFS
->
fdDb
, 0, &
nId
);

828 
pId
 = 
	`lsmMÆlocZîoRc
(
pEnv
, 
nId
, &
rc
);

829 if–
rc
==
LSM_OK
 )Ñ¯
pEnv
->
	`xFûeid
(
pFS
->
fdDb
, 
pId
, &
nId
);

831 if–
rc
!=
LSM_OK
 ){

832 
	`lsmFªe
(
pEnv
, 
pId
);

833 
pId
 = 0;

834 
nId
 = 0;

837 *
µId
 = 
pId
;

838 *
≤Id
 = 
nId
;

839  
rc
;

840 
	}
}

846 
	$lsmFsPageSize
(
FûeSy°em
 *
pFS
){

847  
pFS
->
nPagesize
;

848 
	}
}

853 
	$lsmFsBlockSize
(
FûeSy°em
 *
pFS
){

854  
pFS
->
nBlocksize
;

855 
	}
}

861 
	$lsmFsSëPageSize
(
FûeSy°em
 *
pFS
, 
nPgsz
){

862 
pFS
->
nPagesize
 = 
nPgsz
;

863 
pFS
->
nCacheMax
 = 2048*1024 /ÖFS->
nPagesize
;

864 
	}
}

869 
	$lsmFsSëBlockSize
(
FûeSy°em
 *
pFS
, 
nBlocksize
){

870 
pFS
->
nBlocksize
 =ÇBlocksize;

871 
	}
}

881 
Pgno
 
	$fsFú°PageOnBlock
(
FûeSy°em
 *
pFS
, 
iBlock
){

882 
Pgno
 
iPg
;

883 if–
pFS
->
pCom¥ess
 ){

884 if–
iBlock
==1 ){

885 
iPg
 = 
pFS
->
nMëasize
 * 2 + 4;

887 
iPg
 = 
pFS
->
nBlocksize
 * (
Pgno
)(
iBlock
-1) + 4;

890 c⁄° 
nPagePîBlock
 = (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
);

891 if–
iBlock
==1 ){

892 
iPg
 = 1 + ((
pFS
->
nMëasize
*2 +ÖFS->
nPagesize
 - 1) /ÖFS->nPagesize);

894 
iPg
 = 1 + (
iBlock
-1Ë* 
nPagePîBlock
;

897  
iPg
;

898 
	}
}

908 
Pgno
 
	$fsLa°PageOnBlock
(
FûeSy°em
 *
pFS
, 
iBlock
){

909 if–
pFS
->
pCom¥ess
 ){

910  
pFS
->
nBlocksize
 * (
Pgno
)
iBlock
 - 1 - 4;

912 c⁄° 
nPagePîBlock
 = (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
);

913  
iBlock
 * 
nPagePîBlock
;

915 
	}
}

921 
	$fsPageToBlock
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
){

922 if–
pFS
->
pCom¥ess
 ){

923  (
iPg
 / 
pFS
->
nBlocksize
) + 1;

925  1 + ((
iPg
-1Ë/ (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
));

927 
	}
}

934 
	$fsIsLa°
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
){

935 c⁄° 
nPagePîBlock
 = (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
);

936 
	`as£π
–!
pFS
->
pCom¥ess
 );

937  ( 
iPg
 && (iPg % 
nPagePîBlock
)==0 );

938 
	}
}

945 
	$fsIsFú°
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
){

946 c⁄° 
nPagePîBlock
 = (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
);

947 
	`as£π
–!
pFS
->
pCom¥ess
 );

948  ( (
iPg
 % 
nPagePîBlock
)==1

949 || (
iPg
<
nPagePîBlock
 && iPg==
	`fsFú°PageOnBlock
(
pFS
, 1))

951 
	}
}

958 
u8
 *
	$lsmFsPageD©a
(
Page
 *
pPage
, *
≤D©a
){

959 if–
≤D©a
 ){

960 *
≤D©a
 = 
pPage
->
nD©a
;

962  
pPage
->
aD©a
;

963 
	}
}

968 
Pgno
 
	$lsmFsPageNumbî
(
Page
 *
pPage
){

970  
pPage
 ?ÖPage->
iPg
 : 0;

971 
	}
}

978 
	$fsPageRemoveFromLru
(
FûeSy°em
 *
pFS
, 
Page
 *
pPg
){

979 
	`as£π
–
pPg
->
pLruNext
 ||ÖPg==
pFS
->
pLruLa°
 );

980 
	`as£π
–
pPg
->
pLruPªv
 ||ÖPg==
pFS
->
pLruFú°
 );

981 if–
pPg
->
pLruNext
 ){

982 
pPg
->
pLruNext
->
pLruPªv
 =ÖPg->pLruPrev;

984 
pFS
->
pLruLa°
 = 
pPg
->
pLruPªv
;

986 if–
pPg
->
pLruPªv
 ){

987 
pPg
->
pLruPªv
->
pLruNext
 =ÖPg->pLruNext;

989 
pFS
->
pLruFú°
 = 
pPg
->
pLruNext
;

991 
pPg
->
pLruPªv
 = 0;

992 
pPg
->
pLruNext
 = 0;

993 
	}
}

998 
	$fsPageAddToLru
(
FûeSy°em
 *
pFS
, 
Page
 *
pPg
){

999 
	`as£π
–
pPg
->
pLruNext
==0 &&ÖPg->
pLruPªv
==0 );

1000 
pPg
->
pLruPªv
 = 
pFS
->
pLruLa°
;

1001 if–
pPg
->
pLruPªv
 ){

1002 
pPg
->
pLruPªv
->
pLruNext
 =ÖPg;

1004 
pFS
->
pLruFú°
 = 
pPg
;

1006 
pFS
->
pLruLa°
 = 
pPg
;

1007 
	}
}

1012 
	$fsPageRemoveFromHash
(
FûeSy°em
 *
pFS
, 
Page
 *
pPg
){

1013 
iHash
;

1014 
Page
 **
µ
;

1016 
iHash
 = 
	`fsHashKey
(
pFS
->
nHash
, 
pPg
->
iPg
);

1017 
µ
=&
pFS
->
≠Hash
[
iHash
]; *µ!=
pPg
;Öp=&(*µ)->
pHashNext
);

1018 *
µ
 = 
pPg
->
pHashNext
;

1019 
pPg
->
pHashNext
 = 0;

1020 
	}
}

1025 
	$fsPageBuf„rFªe
(
Page
 *
pPg
){

1026 
pPg
->
pFS
->
nCacheAŒoc
--;

1027 
	`lsmFªe
(
pPg
->
pFS
->
pEnv
,ÖPg->
aD©a
);

1028 
	`lsmFªe
(
pPg
->
pFS
->
pEnv
,ÖPg);

1029 
	}
}

1035 
	$lsmFsPurgeCache
(
FûeSy°em
 *
pFS
){

1036 
Page
 *
pPg
;

1038 
pPg
 = 
pFS
->
pLruFú°
;

1039  
pPg
 ){

1040 
Page
 *
pNext
 = 
pPg
->
pLruNext
;

1041 
	`as£π
–
pPg
->
Êags
 & 
PAGE_FREE
 );

1042 
	`fsPageRemoveFromHash
(
pFS
, 
pPg
);

1043 
	`fsPageBuf„rFªe
(
pPg
);

1044 
pPg
 = 
pNext
;

1046 
pFS
->
pLruFú°
 = 0;

1047 
pFS
->
pLruLa°
 = 0;

1049 
	`as£π
–
pFS
->
nCacheAŒoc
<ıFS->
nOut
 &&ÖFS->nCacheAlloc>=0 );

1050 
	}
}

1059 
Page
 *
	$fsPageFödInHash
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
, *
piHash
){

1060 
Page
 *
p
;

1061 
iHash
 = 
	`fsHashKey
(
pFS
->
nHash
, 
iPg
);

1063 if–
piHash
 ) *piHash = 
iHash
;

1064 
p
=
pFS
->
≠Hash
[
iHash
];Ö;Öı->
pHashNext
){

1065 if–
p
->
iPg
==iPg) ;

1067  
p
;

1068 
	}
}

1075 
	$fsPageBuf„r
(

1076 
FûeSy°em
 *
pFS
,

1077 
Page
 **
µOut


1079 
rc
 = 
LSM_OK
;

1080 
Page
 *
pPage
 = 0;

1081 if–
pFS
->
pLruFú°
==0 ||ÖFS->
nCacheAŒoc
<pFS->
nCacheMax
 ){

1083 
pPage
 = 
	`lsmMÆlocZîo
(
pFS
->
pEnv
, (
Page
));

1084 if–!
pPage
 ){

1085 
rc
 = 
LSM_NOMEM_BKPT
;

1087 
pPage
->
aD©a
 = (
u8
 *)
	`lsmMÆloc
(
pFS
->
pEnv
,ÖFS->
nPagesize
);

1088 if–!
pPage
->
aD©a
 ){

1089 
	`lsmFªe
(
pFS
->
pEnv
, 
pPage
);

1090 
rc
 = 
LSM_NOMEM_BKPT
;

1091 
pPage
 = 0;

1093 
pFS
->
nCacheAŒoc
++;

1098 
u8
 *
aD©a
;

1099 
pPage
 = 
pFS
->
pLruFú°
;

1100 
aD©a
 = 
pPage
->aData;

1101 
	`fsPageRemoveFromLru
(
pFS
, 
pPage
);

1102 
	`fsPageRemoveFromHash
(
pFS
, 
pPage
);

1104 
	`mem£t
(
pPage
, 0, (
Page
));

1105 
pPage
->
aD©a
 =áData;

1108 if–
pPage
 ){

1109 
pPage
->
Êags
 = 
PAGE_FREE
;

1111 *
µOut
 = 
pPage
;

1112  
rc
;

1113 
	}
}

1127 
	$fsGrowM≠pög
(

1128 
FûeSy°em
 *
pFS
,

1129 
i64
 
iSz
,

1130 *
pRc


1132 
	`as£π
–
pFS
->
pCom¥ess
==0 );

1133 
	`as£π
–
PAGE_HASPREV
==4 );

1135 if–*
pRc
==
LSM_OK
 && 
iSz
>
pFS
->
nM≠
 ){

1136 
rc
;

1137 
u8
 *
aOld
 = 
pFS
->
pM≠
;

1138 
rc
 = 
	`lsmEnvRem≠
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iSz
, &pFS->
pM≠
, &pFS->
nM≠
);

1139 if–
rc
==
LSM_OK
 && 
pFS
->
pM≠
!=
aOld
 ){

1140 
Page
 *
pFix
;

1141 
i64
 
iOff
 = (
u8
 *)
pFS
->
pM≠
 - 
aOld
;

1142 
pFix
=
pFS
->
pM≠≥d
;ÖFix;ÖFixıFix->
pM≠≥dNext
){

1143 
pFix
->
aD©a
 +
iOff
;

1145 
	`lsmS‹ãdRem≠
(
pFS
->
pDb
);

1147 *
pRc
 = 
rc
;

1149 
	}
}

1154 
	$lsmFsSyncDb
(
FûeSy°em
 *
pFS
, 
nBlock
){

1155  
	`lsmEnvSync
(
pFS
->
pEnv
,ÖFS->
fdDb
);

1156 
	}
}

1163 
	$fsRedúe˘Block
(
Redúe˘
 *
p
, 
iBlk
){

1164 if–
p
 ){

1165 
i
;

1166 
i
=0; i<
p
->
n
; i++){

1167 if–
iBlk
==
p
->
a
[
i
].
iFrom
 ) Ö->a[i].
iTo
;

1170 
	`as£π
–
iBlk
!=0 );

1171  
iBlk
;

1172 
	}
}

1179 
Pgno
 
	$lsmFsRedúe˘Page
(
FûeSy°em
 *
pFS
, 
Redúe˘
 *
pRedú
, 
Pgno
 
iPg
){

1180 
Pgno
 
iRól
 = 
iPg
;

1182 if–
pRedú
 ){

1183 c⁄° 
nPagePîBlock
 = (

1184 
pFS
->
pCom¥ess
 ?ÖFS->
nBlocksize
 : (pFS->nBlocksizê/ÖFS->
nPagesize
)

1186 
iBlk
 = 
	`fsPageToBlock
(
pFS
, 
iPg
);

1187 
i
;

1188 
i
=0; i<
pRedú
->
n
; i++){

1189 
iFrom
 = 
pRedú
->
a
[
i
].iFrom;

1190 if–
iFrom
>
iBlk
 ) ;

1191 if–
iFrom
==
iBlk
 ){

1192 
iTo
 = 
pRedú
->
a
[
i
].iTo;

1193 
iRól
 = 
iPg
 - (
Pgno
)(
iFrom
 - 
iTo
Ë* 
nPagePîBlock
;

1194 if–
iTo
==1 ){

1195 
iRól
 +(
	`fsFú°PageOnBlock
(
pFS
, 1)-1);

1202 
	`as£π
–
iRól
!=0 );

1203  
iRól
;

1204 
	}
}

1207 
fsPageGë
(
FûeSy°em
 *, 
Segmít
 *, 
Pgno
, , 
Page
 **, *);

1215 
	$fsBlockNext
(

1216 
FûeSy°em
 *
pFS
,

1217 
Segmít
 *
pSeg
,

1218 
iBlock
,

1219 *
piNext


1221 
rc
;

1222 
iRód
;

1224 if–
pSeg
 ){

1225 
iRód
 = 
	`fsRedúe˘Block
(
pSeg
->
pRedúe˘
, 
iBlock
);

1227 
iRód
 = 
iBlock
;

1230 
	`as£π
–
pFS
->
nM≠Limô
==0 ||ÖFS->
pCom¥ess
==0 );

1231 if–
pFS
->
pCom¥ess
 ){

1232 
i64
 
iOff
;

1233 
u8
 
aNext
[4];

1235 
iOff
 = (
i64
)
iRód
 * 
pFS
->
nBlocksize
 - (
aNext
);

1236 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
aNext
, (aNext));

1237 if–
rc
==
LSM_OK
 ){

1238 *
piNext
 = ()
	`lsmGëU32
(
aNext
);

1241 c⁄° 
nPagePîBlock
 = (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
);

1242 
Page
 *
pLa°
;

1243 
rc
 = 
	`fsPageGë
(
pFS
, 0, 
iRód
*
nPagePîBlock
, 0, &
pLa°
, 0);

1244 if–
rc
==
LSM_OK
 ){

1245 *
piNext
 = 
	`lsmGëU32
(&
pLa°
->
aD©a
[
pFS
->
nPagesize
-4]);

1246 
	`lsmFsPageRñó£
(
pLa°
);

1250 if–
pSeg
 ){

1251 *
piNext
 = 
	`fsRedúe˘Block
(
pSeg
->
pRedúe˘
, *piNext);

1253  
rc
;

1254 
	}
}

1259 
Pgno
 
	$fsLa°PageOnPagesBlock
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
){

1260  
	`fsLa°PageOnBlock
(
pFS
, 
	`fsPageToBlock
’FS, 
iPg
));

1261 
	}
}

1273 
	$fsRódD©a
(

1274 
FûeSy°em
 *
pFS
,

1275 
Segmít
 *
pSeg
,

1276 
i64
 
iOff
,

1277 
u8
 *
aD©a
,

1278 
nD©a


1280 
i64
 
iEob
;

1281 
nRód
;

1282 
rc
;

1284 
	`as£π
–
pFS
->
pCom¥ess
 );

1286 
iEob
 = 
	`fsLa°PageOnPagesBlock
(
pFS
, 
iOff
) + 1;

1287 
nRód
 = 
	`LSM_MIN
(
iEob
 - 
iOff
, 
nD©a
);

1289 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
aD©a
, 
nRód
);

1290 if–
rc
==
LSM_OK
 && 
nRód
!=
nD©a
 ){

1291 
iBlk
;

1293 
rc
 = 
	`fsBlockNext
(
pFS
, 
pSeg
, 
	`fsPageToBlock
’FS, 
iOff
), &
iBlk
);

1294 if–
rc
==
LSM_OK
 ){

1295 
i64
 
iOff2
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
);

1296 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff2
, &
aD©a
[
nRód
], 
nD©a
-nRead);

1300  
rc
;

1301 
	}
}

1309 
	$fsBlockPªv
(

1310 
FûeSy°em
 *
pFS
,

1311 
Segmít
 *
pSeg
,

1312 
iBlock
,

1313 *
piPªv


1315 
rc
 = 
LSM_OK
;

1317 
	`as£π
–
pFS
->
nM≠Limô
==0 ||ÖFS->
pCom¥ess
==0 );

1318 
	`as£π
–
iBlock
>0 );

1320 if–
pFS
->
pCom¥ess
 ){

1321 
i64
 
iOff
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlock
) - 4;

1322 
u8
 
aPªv
[4];

1323 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
aPªv
, (aPrev));

1324 if–
rc
==
LSM_OK
 ){

1325 
Redúe˘
 *
pRedú
 = (
pSeg
 ?ÖSeg->
pRedúe˘
 : 0);

1326 *
piPªv
 = 
	`fsRedúe˘Block
(
pRedú
, ()
	`lsmGëU32
(
aPªv
));

1329 
	`as£π
( 0 );

1331  
rc
;

1332 
	}
}

1337 
	$putRec‹dSize
(
u8
 *
aBuf
, 
nByã
, 
bFªe
){

1338 
aBuf
[0] = (
u8
)(
nByã
 >> 14) | 0x80;

1339 
aBuf
[1] = ((
u8
)(
nByã
 >> 7Ë& 0x7FË| (
bFªe
 ? 0x00 : 0x80);

1340 
aBuf
[2] = (
u8
)
nByã
 | 0x80;

1341 
	}
}

1342 
	$gëRec‹dSize
(
u8
 *
aBuf
, *
pbFªe
){

1343 
nByã
;

1344 
nByã
 = (
aBuf
[0] & 0x7F) << 14;

1345 
nByã
 +(
aBuf
[1] & 0x7F) << 7;

1346 
nByã
 +(
aBuf
[2] & 0x7F);

1347 *
pbFªe
 = !(
aBuf
[1] & 0x80);

1348  
nByã
;

1349 
	}
}

1361 
	$fsSubåa˘Off£t
(

1362 
FûeSy°em
 *
pFS
,

1363 
Segmít
 *
pSeg
,

1364 
i64
 
iOff
,

1365 
iSub
,

1366 
i64
 *
piRes


1368 
i64
 
iSèπ
;

1369 
iBlk
 = 0;

1370 
rc
;

1372 
	`as£π
–
pFS
->
pCom¥ess
 );

1374 
iSèπ
 = 
	`fsFú°PageOnBlock
(
pFS
, 
	`fsPageToBlock
’FS, 
iOff
));

1375 if–(
iOff
-
iSub
)>=
iSèπ
 ){

1376 *
piRes
 = (
iOff
-
iSub
);

1377  
LSM_OK
;

1380 
rc
 = 
	`fsBlockPªv
(
pFS
, 
pSeg
, 
	`fsPageToBlock
’FS, 
iOff
), &
iBlk
);

1381 *
piRes
 = 
	`fsLa°PageOnBlock
(
pFS
, 
iBlk
Ë- 
iSub
 + (
iOff
 - 
iSèπ
 + 1);

1382  
rc
;

1383 
	}
}

1395 
	$fsAddOff£t
(

1396 
FûeSy°em
 *
pFS
,

1397 
Segmít
 *
pSeg
,

1398 
i64
 
iOff
,

1399 
iAdd
,

1400 
i64
 *
piRes


1402 
i64
 
iEob
;

1403 
iBlk
;

1404 
rc
;

1406 
	`as£π
–
pFS
->
pCom¥ess
 );

1408 
iEob
 = 
	`fsLa°PageOnPagesBlock
(
pFS
, 
iOff
);

1409 if–(
iOff
+
iAdd
)<=
iEob
 ){

1410 *
piRes
 = (
iOff
+
iAdd
);

1411  
LSM_OK
;

1414 
rc
 = 
	`fsBlockNext
(
pFS
, 
pSeg
, 
	`fsPageToBlock
’FS, 
iOff
), &
iBlk
);

1415 *
piRes
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
Ë+ 
iAdd
 - (
iEob
 - 
iOff
 + 1);

1416  
rc
;

1417 
	}
}

1424 
	$fsAŒoˇãBuf„r
(
FûeSy°em
 *
pFS
, 
bWrôe
){

1425 
u8
 **
µ
;

1427 
	`as£π
–
pFS
->
pCom¥ess
 );

1431 if–
pFS
->
nBuf„r
==0 ){

1432 
	`as£π
–
pFS
->
aIBuf„r
==0 &&ÖFS->
aOBuf„r
==0 );

1433 
pFS
->
nBuf„r
 =ÖFS->
pCom¥ess
->
	`xBound
’FS->pCom¥ess->
pCtx
,ÖFS->
nPagesize
);

1434 if–
pFS
->
nBuf„r
<’FS->
szSe˘‹
+6) ){

1435 
pFS
->
nBuf„r
 =ÖFS->
szSe˘‹
+6;

1439 
µ
 = (
bWrôe
 ? &
pFS
->
aOBuf„r
 : &pFS->
aIBuf„r
);

1440 if–*
µ
==0 ){

1441 *
µ
 = 
	`lsmMÆloc
(
pFS
->
pEnv
, 
	`LSM_MAX
’FS->
nBuf„r
,ÖFS->
nPagesize
));

1442 if–*
µ
==0 )  
LSM_NOMEM_BKPT
;

1445  
LSM_OK
;

1446 
	}
}

1459 
	$fsRódPaged©a
(

1460 
FûeSy°em
 *
pFS
,

1461 
Segmít
 *
pSeg
,

1462 
Page
 *
pPg
,

1463 *
≤S∑˚


1465 
lsm_com¥ess
 *
p
 = 
pFS
->
pCom¥ess
;

1466 
i64
 
iOff
 = 
pPg
->
iPg
;

1467 
u8
 
aSz
[3];

1468 
rc
;

1470 
	`as£π
–
p
 && 
pPg
->
nCom¥ess
==0 );

1472 if–
	`fsAŒoˇãBuf„r
(
pFS
, 0ËË 
LSM_NOMEM
;

1474 
rc
 = 
	`fsRódD©a
(
pFS
, 
pSeg
, 
iOff
, 
aSz
, (aSz));

1476 if–
rc
==
LSM_OK
 ){

1477 
bFªe
;

1478 if–
aSz
[0] & 0x80 ){

1479 
pPg
->
nCom¥ess
 = ()
	`gëRec‹dSize
(
aSz
, &
bFªe
);

1481 
pPg
->
nCom¥ess
 = ()
aSz
[0] - (aSz)*2;

1482 
bFªe
 = 1;

1484 if–
bFªe
 ){

1485 if–
≤S∑˚
 ){

1486 *
≤S∑˚
 = 
pPg
->
nCom¥ess
 + (
aSz
)*2;

1488 
rc
 = 
LSM_CORRUPT_BKPT
;

1491 
rc
 = 
	`fsAddOff£t
(
pFS
, 
pSeg
, 
iOff
, 3, &iOff);

1492 if–
rc
==
LSM_OK
 ){

1493 if–
pPg
->
nCom¥ess
>
pFS
->
nBuf„r
 ){

1494 
rc
 = 
LSM_CORRUPT_BKPT
;

1496 
rc
 = 
	`fsRódD©a
(
pFS
, 
pSeg
, 
iOff
,ÖFS->
aIBuf„r
, 
pPg
->
nCom¥ess
);

1498 if–
rc
==
LSM_OK
 ){

1499 
n
 = 
pFS
->
nPagesize
;

1500 
rc
 = 
p
->
	`xUncom¥ess
’->
pCtx
,

1501 (*)
pPg
->
aD©a
, &
n
,

1502 (c⁄° *)
pFS
->
aIBuf„r
, 
pPg
->
nCom¥ess


1504 if–
rc
==
LSM_OK
 && 
n
!=
pPg
->
pFS
->
nPagesize
 ){

1505 
rc
 = 
LSM_CORRUPT_BKPT
;

1511  
rc
;

1512 
	}
}

1524 
	$fsPageGë
(

1525 
FûeSy°em
 *
pFS
,

1526 
Segmít
 *
pSeg
,

1527 
Pgno
 
iPg
,

1528 
noC⁄ã¡
,

1529 
Page
 **
µPg
,

1530 *
≤S∑˚


1532 
Page
 *
p
;

1533 
iHash
;

1534 
rc
 = 
LSM_OK
;

1539 
Pgno
 
iRól
 = 
	`lsmFsRedúe˘Page
(
pFS
, (
pSeg
 ?ÖSeg->
pRedúe˘
 : 0), 
iPg
);

1541 
	`as£π_li°s_¨e_ok
(
pFS
);

1542 
	`as£π
–
iPg
>=
	`fsFú°PageOnBlock
(
pFS
, 1) );

1543 
	`as£π
–
iRól
>=
	`fsFú°PageOnBlock
(
pFS
, 1) );

1544 *
µPg
 = 0;

1547 
p
 = 
	`fsPageFödInHash
(
pFS
, 
iRól
, &
iHash
);

1549 if–
p
 ){

1550 
	`as£π
–
p
->
Êags
 & 
PAGE_FREE
 );

1551 if–
p
->
nRef
==0 ) 
	`fsPageRemoveFromLru
(
pFS
,Ö);

1554 if–
	`fsMm≠Page
(
pFS
, 
iRól
) ){

1555 
i64
 
iEnd
 = (i64)
iRól
 * 
pFS
->
nPagesize
;

1556 
	`fsGrowM≠pög
(
pFS
, 
iEnd
, &
rc
);

1557 if–
rc
!=
LSM_OK
 ) Ñc;

1559 if–
pFS
->
pFªe
 ){

1560 
p
 = 
pFS
->
pFªe
;

1561 
pFS
->
pFªe
 = 
p
->
pFªeNext
;

1562 
	`as£π
–
p
->
nRef
==0 );

1564 
p
 = 
	`lsmMÆlocZîoRc
(
pFS
->
pEnv
, (
Page
), &
rc
);

1565 if–
rc
 ) Ñc;

1566 
p
->
pFS
 =ÖFS;

1568 
p
->
aD©a
 = &((
u8
 *)
pFS
->
pM≠
)[pFS->
nPagesize
 * (
iRól
-1)];

1569 
p
->
iPg
 = 
iRól
;

1573 
	`as£π
–
p
->
pM≠≥dNext
==0 );

1574 
p
->
pM≠≥dNext
 = 
pFS
->
pM≠≥d
;

1575 
pFS
->
pM≠≥d
 = 
p
;

1577 
	`as£π
–
pFS
->
pCom¥ess
==0 );

1578 
	`as£π
–(
p
->
Êags
 & 
PAGE_FREE
)==0 );

1580 
rc
 = 
	`fsPageBuf„r
(
pFS
, &
p
);

1581 if–
rc
==
LSM_OK
 ){

1582 
nS∑˚
 = 0;

1583 
p
->
iPg
 = 
iRól
;

1584 
p
->
nRef
 = 0;

1585 
p
->
pFS
 =ÖFS;

1586 
	`as£π
–
p
->
Êags
==0 ||Ö->Êags==
PAGE_FREE
 );

1588 #ifde‡
LSM_DEBUG


1589 
	`mem£t
(
p
->
aD©a
, 0x56, 
pFS
->
nPagesize
);

1591 
	`as£π
–
p
->
pLruNext
==0 &&Ö->
pLruPªv
==0 );

1592 if–
noC⁄ã¡
==0 ){

1593 if–
pFS
->
pCom¥ess
 ){

1594 
rc
 = 
	`fsRódPaged©a
(
pFS
, 
pSeg
, 
p
, &
nS∑˚
);

1596 
nByã
 = 
pFS
->
nPagesize
;

1597 
i64
 
iOff
 = (i64)(
iRól
-1Ë* 
pFS
->
nPagesize
;

1598 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
p
->
aD©a
, 
nByã
);

1600 
pFS
->
nRód
++;

1606 if–
rc
==
LSM_OK
 && 
nS∑˚
==0 ){

1607 
p
->
pHashNext
 = 
pFS
->
≠Hash
[
iHash
];

1608 
pFS
->
≠Hash
[
iHash
] = 
p
;

1610 
	`fsPageBuf„rFªe
(
p
);

1611 
p
 = 0;

1612 if–
≤S∑˚
 ) *≤S∑˚ = 
nS∑˚
;

1617 
	`as£π
–(
rc
==
LSM_OK
 && (
p
 || (
≤S∑˚
 && *pnSpace)))

1618 || (
rc
!=
LSM_OK
 && 
p
==0)

1622 if–
rc
==
LSM_OK
 && 
p
 ){

1623 if–
pFS
->
pCom¥ess
==0 && (
	`fsIsLa°
’FS, 
iRól
Ë|| 
	`fsIsFú°
(pFS, iReal)) ){

1624 
p
->
nD©a
 = 
pFS
->
nPagesize
 - 4;

1625 if–
	`fsIsFú°
(
pFS
, 
iRól
Ë&& 
p
->
nRef
==0 ){

1626 
p
->
aD©a
 += 4;

1627 
p
->
Êags
 |
PAGE_HASPREV
;

1630 
p
->
nD©a
 = 
pFS
->
nPagesize
;

1632 
pFS
->
nOut
 +(
p
->
nRef
==0);

1633 
p
->
nRef
++;

1635 *
µPg
 = 
p
;

1636  
rc
;

1637 
	}
}

1649 
	$lsmFsRódSyn˚dId
(
lsm_db
 *
db
, 
iMëa
, 
i64
 *
piVÆ
){

1650 
FûeSy°em
 *
pFS
 = 
db
->pFS;

1651 
rc
 = 
LSM_OK
;

1653 
	`as£π
–
iMëa
==1 || iMeta==2 );

1654 if–
pFS
->
nM≠Limô
>0 ){

1655 
	`fsGrowM≠pög
(
pFS
, 
iMëa
*
LSM_META_PAGE_SIZE
, &
rc
);

1656 if–
rc
==
LSM_OK
 ){

1657 *
piVÆ
 = (
i64
)
	`lsmGëU64
(&((
u8
 *)
pFS
->
pM≠
)[(
iMëa
-1)*
LSM_META_PAGE_SIZE
]);

1660 
MëaPage
 *
pMëa
 = 0;

1661 
rc
 = 
	`lsmFsMëaPageGë
(
pFS
, 0, 
iMëa
, &
pMëa
);

1662 if–
rc
==
LSM_OK
 ){

1663 *
piVÆ
 = (
i64
)
	`lsmGëU64
(
pMëa
->
aD©a
);

1664 
	`lsmFsMëaPageRñó£
(
pMëa
);

1668  
rc
;

1669 
	}
}

1676 
	$fsRunEndsBëwìn
(

1677 
Segmít
 *
pRun
,

1678 
Segmít
 *
pIgn‹e
,

1679 
Pgno
 
iFú°
,

1680 
Pgno
 
iLa°


1682  (
pRun
!=
pIgn‹e
 && (

1683 (
pRun
->
iFú°
>=iFú° &&ÖRun->iFú°<=
iLa°
)

1684 || (
pRun
->
iLa°Pg
>=
iFú°
 &&ÖRun->iLa°Pg<=
iLa°
)

1686 
	}
}

1692 
	$fsLevñEndsBëwìn
(

1693 
Levñ
 *
pLevñ
,

1694 
Segmít
 *
pIgn‹e
,

1695 
Pgno
 
iFú°
,

1696 
Pgno
 
iLa°


1698 
i
;

1700 if–
	`fsRunEndsBëwìn
(&
pLevñ
->
lhs
, 
pIgn‹e
, 
iFú°
, 
iLa°
) ){

1703 
i
=0; i<
pLevñ
->
nRight
; i++){

1704 if–
	`fsRunEndsBëwìn
(&
pLevñ
->
aRhs
[
i
], 
pIgn‹e
, 
iFú°
, 
iLa°
) ){

1710 
	}
}

1716 
	$fsFªeBlock
(

1717 
FûeSy°em
 *
pFS
,

1718 
S«pshŸ
 *
pS«pshŸ
,

1719 
Segmít
 *
pIgn‹e
,

1720 
iBlk


1722 
rc
 = 
LSM_OK
;

1723 
iFú°
;

1724 
iLa°
;

1725 
Levñ
 *
pLevñ
;

1727 
iIn
;

1728 
iOut
 = 0;

1729 
Pgno
 *
aAµ
 = 
pS«pshŸ
->
aiAµíd
;

1731 
iFú°
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
);

1732 
iLa°
 = 
	`fsLa°PageOnBlock
(
pFS
, 
iBlk
);

1736 
pLevñ
=
	`lsmDbS«pshŸLevñ
(
pS«pshŸ
);ÖLevñ;ÖLevñıLevñ->
pNext
){

1737 if–
	`fsLevñEndsBëwìn
(
pLevñ
, 
pIgn‹e
, 
iFú°
, 
iLa°
) ){

1738  
LSM_OK
;

1743 
iIn
=0; iIn<
LSM_APPLIST_SZ
; iIn++){

1744 if–
aAµ
[
iIn
]<
iFú°
 ||áAµ[iIn]>
iLa°
 ){

1745 
aAµ
[
iOut
++] =áAµ[
iIn
];

1748  
iOut
<
LSM_APPLIST_SZ
 ) 
aAµ
[iOut++] = 0;

1750 if–
rc
==
LSM_OK
 ){

1751 
rc
 = 
	`lsmBlockFªe
(
pFS
->
pDb
, 
iBlk
);

1753  
rc
;

1754 
	}
}

1759 
	$lsmFsS‹ãdDñëe
(

1760 
FûeSy°em
 *
pFS
,

1761 
S«pshŸ
 *
pS«pshŸ
,

1762 
bZîo
,

1763 
Segmít
 *
pDñ


1765 if–
pDñ
->
iFú°
 ){

1766 
rc
 = 
LSM_OK
;

1768 
iBlk
;

1769 
iLa°Blk
;

1771 
iBlk
 = 
	`fsPageToBlock
(
pFS
, 
pDñ
->
iFú°
);

1772 
iLa°Blk
 = 
	`fsPageToBlock
(
pFS
, 
pDñ
->
iLa°Pg
);

1775  
iBlk
 && 
rc
==
LSM_OK
 ){

1776 
iNext
 = 0;

1777 if–
iBlk
!=
iLa°Blk
 ){

1778 
rc
 = 
	`fsBlockNext
(
pFS
, 
pDñ
, 
iBlk
, &
iNext
);

1779 }if–
bZîo
==0 && 
pDñ
->
iLa°Pg
!=
	`fsLa°PageOnBlock
(
pFS
, 
iLa°Blk
) ){

1782 
rc
 = 
	`fsFªeBlock
(
pFS
, 
pS«pshŸ
, 
pDñ
, 
iBlk
);

1783 
iBlk
 = 
iNext
;

1786 if–
pDñ
->
pRedúe˘
 ){

1787 
	`as£π
–
pDñ
->
pRedúe˘
==&
pS«pshŸ
->
ªdúe˘
 );

1788 
pS«pshŸ
->
ªdúe˘
.
n
 = 0;

1791 if–
bZîo
 ) 
	`mem£t
(
pDñ
, 0, (
Segmít
));

1793  
LSM_OK
;

1794 
	}
}

1801 
Pgno
 
	$fú°OnBlock
(
FûeSy°em
 *
pFS
, 
iBlk
, 
Pgno
 *
aPgno
, 
nPgno
){

1802 
Pgno
 
iRë
 = 0;

1803 
i
;

1804 
i
=0; i<
nPgno
; i++){

1805 
Pgno
 
iPg
 = 
aPgno
[
i
];

1806 if–
	`fsPageToBlock
(
pFS
, 
iPg
)==
iBlk
 && (
iRë
==0 || iPg<iRet) ){

1807 
iRë
 = 
iPg
;

1810  
iRë
;

1811 
	}
}

1813 #i‚de‡
NDEBUG


1818 
	$fsPageRedúe˘s
(
FûeSy°em
 *
pFS
, 
Segmít
 *
p
, 
Pgno
 
iPg
){

1819  (
iPg
!=0 && iPg!=
	`lsmFsRedúe˘Page
(
pFS
, 
p
->
pRedúe˘
, iPg));

1820 
	}
}

1826 
	$fsSegmítRedúe˘s
(
FûeSy°em
 *
pFS
, 
Segmít
 *
p
){

1827  (
p
 && (

1828 
	`fsPageRedúe˘s
(
pFS
, 
p
,Ö->
iFú°
)

1829 || 
	`fsPageRedúe˘s
(
pFS
, 
p
,Ö->
iRoŸ
)

1830 || 
	`fsPageRedúe˘s
(
pFS
, 
p
,Ö->
iLa°Pg
)

1832 
	}
}

1841 
	$lsmFsGobbÀ
(

1842 
lsm_db
 *
pDb
,

1843 
Segmít
 *
pRun
,

1844 
Pgno
 *
aPgno
,

1845 
nPgno


1847 
rc
 = 
LSM_OK
;

1848 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

1849 
S«pshŸ
 *
pS«pshŸ
 = 
pDb
->
pW‹kî
;

1850 
iBlk
;

1852 
	`as£π
–
pRun
->
nSize
>0 );

1853 
	`as£π
–0==
	`fsSegmítRedúe˘s
(
pFS
, 
pRun
) );

1854 
	`as£π
–
nPgno
>0 && 0==
	`fsPageRedúe˘s
(
pFS
, 
pRun
, 
aPgno
[0]) );

1856 
iBlk
 = 
	`fsPageToBlock
(
pFS
, 
pRun
->
iFú°
);

1857 
pRun
->
nSize
 +’Run->
iFú°
 - 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
));

1859  
rc
==
LSM_OK
 ){

1860 
iNext
 = 0;

1861 
Pgno
 
iFú°
 = 
	`fú°OnBlock
(
pFS
, 
iBlk
, 
aPgno
, 
nPgno
);

1862 if–
iFú°
 ){

1863 
pRun
->
iFú°
 = iFirst;

1866 
rc
 = 
	`fsBlockNext
(
pFS
, 
pRun
, 
iBlk
, &
iNext
);

1867 if–
rc
==
LSM_OK
 )Ñ¯
	`fsFªeBlock
(
pFS
, 
pS«pshŸ
, 
pRun
, 
iBlk
);

1868 
pRun
->
nSize
 -= (

1869 1 + 
	`fsLa°PageOnBlock
(
pFS
, 
iBlk
Ë- 
	`fsFú°PageOnBlock
(pFS, iBlk)

1871 
iBlk
 = 
iNext
;

1874 
pRun
->
nSize
 -’Run->
iFú°
 - 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
));

1875 
	`as£π
–
pRun
->
nSize
>0 );

1876 
	}
}

1892 
	$fsNextPageOff£t
(

1893 
FûeSy°em
 *
pFS
,

1894 
Segmít
 *
pSeg
,

1895 
Pgno
 
iPg
,

1896 
nByã
,

1897 
Pgno
 *
piNext


1899 
Pgno
 
iNext
;

1900 
rc
;

1902 
	`as£π
–
pFS
->
pCom¥ess
 );

1904 
rc
 = 
	`fsAddOff£t
(
pFS
, 
pSeg
, 
iPg
, 
nByã
-1, &
iNext
);

1905 if–
pSeg
 && 
iNext
=ıSeg->
iLa°Pg
 ){

1906 
iNext
 = 0;

1907 }if–
rc
==
LSM_OK
 ){

1908 
rc
 = 
	`fsAddOff£t
(
pFS
, 
pSeg
, 
iNext
, 1, &iNext);

1911 *
piNext
 = 
iNext
;

1912  
rc
;

1913 
	}
}

1926 
	$fsGëPageBef‹e
(

1927 
FûeSy°em
 *
pFS
,

1928 
Segmít
 *
pSeg
,

1929 
Pgno
 
iPg
,

1930 
Pgno
 *
piPªv


1932 
u8
 
aSz
[3];

1933 
rc
;

1934 
i64
 
iRód
;

1936 
	`as£π
–
pFS
->
pCom¥ess
 );

1938 
rc
 = 
	`fsSubåa˘Off£t
(
pFS
, 
pSeg
, 
iPg
, (
aSz
), &
iRód
);

1939 if–
rc
==
LSM_OK
 )Ñ¯
	`fsRódD©a
(
pFS
, 
pSeg
, 
iRód
, 
aSz
, (aSz));

1941 if–
rc
==
LSM_OK
 ){

1942 
bFªe
;

1943 
nSz
;

1944 if–
aSz
[2] & 0x80 ){

1945 
nSz
 = 
	`gëRec‹dSize
(
aSz
, &
bFªe
) + (aSz)*2;

1947 
nSz
 = ()(
aSz
[2] & 0x7F);

1948 
bFªe
 = 1;

1950 
rc
 = 
	`fsSubåa˘Off£t
(
pFS
, 
pSeg
, 
iPg
, 
nSz
, 
piPªv
);

1953  
rc
;

1954 
	}
}

1977 
	$lsmFsDbPageNext
(
Segmít
 *
pRun
, 
Page
 *
pPg
, 
eDú
, Pagê**
µNext
){

1978 
rc
 = 
LSM_OK
;

1979 
FûeSy°em
 *
pFS
 = 
pPg
->pFS;

1980 
Pgno
 
iPg
 = 
pPg
->iPg;

1982 
	`as£π
–0==
	`fsSegmítRedúe˘s
(
pFS
, 
pRun
) );

1983 if–
pFS
->
pCom¥ess
 ){

1984 
nS∑˚
 = 
pPg
->
nCom¥ess
 + 2*3;

1987 if–
eDú
>0 ){

1988 
rc
 = 
	`fsNextPageOff£t
(
pFS
, 
pRun
, 
iPg
, 
nS∑˚
, &iPg);

1990 if–
iPg
==
pRun
->
iFú°
 ){

1991 
iPg
 = 0;

1993 
rc
 = 
	`fsGëPageBef‹e
(
pFS
, 
pRun
, 
iPg
, &iPg);

1997 
nS∑˚
 = 0;

1998 if–
iPg
!=0 ){

1999 
rc
 = 
	`fsPageGë
(
pFS
, 
pRun
, 
iPg
, 0, 
µNext
, &
nS∑˚
);

2000 
	`as£π
–(*
µNext
==0)==(
rc
!=
LSM_OK
 || 
nS∑˚
>0) );

2002 *
µNext
 = 0;

2004 } 
nS∑˚
>0 && 
rc
==
LSM_OK
 );

2007 
Redúe˘
 *
pRedú
 = 
pRun
 ?ÖRun->
pRedúe˘
 : 0;

2008 
	`as£π
–
eDú
==1 ||ÉDir==-1 );

2009 if–
eDú
<0 ){

2010 if–
pRun
 && 
iPg
=ıRun->
iFú°
 ){

2011 *
µNext
 = 0;

2012  
LSM_OK
;

2013 }if–
	`fsIsFú°
(
pFS
, 
iPg
) ){

2014 
	`as£π
–
pPg
->
Êags
 & 
PAGE_HASPREV
 );

2015 
iPg
 = 
	`fsLa°PageOnBlock
(
pFS
, 
	`lsmGëU32
(&
pPg
->
aD©a
[-4]));

2017 
iPg
--;

2020 if–
pRun
 ){

2021 if–
iPg
==
pRun
->
iLa°Pg
 ){

2022 *
µNext
 = 0;

2023  
LSM_OK
;

2027 if–
	`fsIsLa°
(
pFS
, 
iPg
) ){

2028 
iBlk
 = 
	`fsRedúe˘Block
(

2029 
pRedú
, 
	`lsmGëU32
(&
pPg
->
aD©a
[
pFS
->
nPagesize
-4])

2031 
iPg
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
);

2033 
iPg
++;

2036 
rc
 = 
	`fsPageGë
(
pFS
, 
pRun
, 
iPg
, 0, 
µNext
, 0);

2039  
rc
;

2040 
	}
}

2052 
Pgno
 
	$födAµídPoöt
(
FûeSy°em
 *
pFS
, 
Levñ
 *
pLvl
){

2053 
i
;

2054 
Pgno
 *
aiAµíd
 = 
pFS
->
pDb
->
pW‹kî
->aiAppend;

2055 
Pgno
 
iRë
 = 0;

2057 
i
=
LSM_APPLIST_SZ
-1; 
iRë
==0 && i>=0; i--){

2058 if–(
iRë
 = 
aiAµíd
[
i
]) ){

2059 if–
pLvl
 ){

2060 
iBlk
 = 
	`fsPageToBlock
(
pFS
, 
iRë
);

2061 
j
;

2062 
j
=0; 
iRë
 && j<
pLvl
->
nRight
; j++){

2063 if–
	`fsPageToBlock
(
pFS
, 
pLvl
->
aRhs
[
j
].
iLa°Pg
)==
iBlk
 ){

2064 
iRë
 = 0;

2068 if–
iRë
 ) 
aiAµíd
[
i
] = 0;

2071  
iRë
;

2072 
	}
}

2079 
	$lsmFsS‹ãdAµíd
(

2080 
FûeSy°em
 *
pFS
,

2081 
S«pshŸ
 *
pS«pshŸ
,

2082 
Levñ
 *
pLvl
,

2083 
bDe„r
,

2084 
Page
 **
µOut


2086 
rc
 = 
LSM_OK
;

2087 
Page
 *
pPg
 = 0;

2088 *
µOut
 = 0;

2089 
iAµ
 = 0;

2090 
iNext
 = 0;

2091 
Segmít
 *
p
 = &
pLvl
->
lhs
;

2092 
iPªv
 = 
p
->
iLa°Pg
;

2094 
	`as£π
–
p
->
pRedúe˘
==0 );

2096 if–
pFS
->
pCom¥ess
 || 
bDe„r
 ){

2100 
rc
 = 
	`fsPageBuf„r
(
pFS
, &
pPg
);

2101 if–
rc
==
LSM_OK
 ){

2102 
pPg
->
pFS
 =ÖFS;

2103 
pPg
->
pSeg
 = 
p
;

2104 
pPg
->
iPg
 = 0;

2105 
pPg
->
Êags
 |
PAGE_DIRTY
;

2106 
pPg
->
nD©a
 = 
pFS
->
nPagesize
;

2107 
	`as£π
–
pPg
->
aD©a
 );

2108 if–
pFS
->
pCom¥ess
==0 ) 
pPg
->
nD©a
 -= 4;

2110 
pPg
->
nRef
 = 1;

2111 
pFS
->
nOut
++;

2114 if–
iPªv
==0 ){

2115 
iAµ
 = 
	`födAµídPoöt
(
pFS
, 
pLvl
);

2116 }if–
	`fsIsLa°
(
pFS
, 
iPªv
) ){

2117 
iNext
;

2118 
rc
 = 
	`fsBlockNext
(
pFS
, 0, 
	`fsPageToBlock
’FS, 
iPªv
), &
iNext
);

2119 if–
rc
!=
LSM_OK
 ) Ñc;

2120 
iAµ
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iNext
);

2122 
iAµ
 = 
iPªv
 + 1;

2127 if–
iAµ
==0 || 
	`fsIsLa°
(
pFS
, iApp) ){

2128 
iNew
;

2130 
rc
 = 
	`lsmBlockAŒoˇã
(
pFS
->
pDb
, 0, &
iNew
);

2131 if–
rc
!=
LSM_OK
 ) Ñc;

2132 if–
iAµ
==0 ){

2133 
iAµ
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iNew
);

2135 
iNext
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iNew
);

2140 
pPg
 = 0;

2141 
rc
 = 
	`fsPageGë
(
pFS
, 0, 
iAµ
, 1, &
pPg
, 0);

2142 
	`as£π
–
rc
==
LSM_OK
 || 
pPg
==0 );

2146 if–
rc
==
LSM_OK
 ){

2147 
p
->
nSize
++;

2148 
p
->
iLa°Pg
 = 
iAµ
;

2149 if–
p
->
iFú°
==0 )Ö->iFú° = 
iAµ
;

2150 
pPg
->
Êags
 |
PAGE_DIRTY
;

2152 if–
	`fsIsLa°
(
pFS
, 
iAµ
) ){

2153 
	`lsmPutU32
(&
pPg
->
aD©a
[
pFS
->
nPagesize
-4], 
	`fsPageToBlock
’FS, 
iNext
));

2154 }if–
	`fsIsFú°
(
pFS
, 
iAµ
) ){

2155 
	`lsmPutU32
(&
pPg
->
aD©a
[-4], 
	`fsPageToBlock
(
pFS
, 
iPªv
));

2160 *
µOut
 = 
pPg
;

2161  
rc
;

2162 
	}
}

2171 
	$lsmFsS‹ãdFöish
(
FûeSy°em
 *
pFS
, 
Segmít
 *
p
){

2172 
rc
 = 
LSM_OK
;

2173 if–
p
 &&Ö->
iLa°Pg
 ){

2174 
	`as£π
–
p
->
pRedúe˘
==0 );

2183 if–
	`fsLa°PageOnPagesBlock
(
pFS
, 
p
->
iLa°Pg
)!=p->iLastPg ){

2184 
i
;

2185 
Pgno
 *
aiAµíd
 = 
pFS
->
pDb
->
pW‹kî
->aiAppend;

2186 
i
=0; i<
LSM_APPLIST_SZ
; i++){

2187 if–
aiAµíd
[
i
]==0 ){

2188 
aiAµíd
[
i
] = 
p
->
iLa°Pg
+1;

2192 }if–
pFS
->
pCom¥ess
==0 ){

2193 
Page
 *
pLa°
;

2194 
rc
 = 
	`fsPageGë
(
pFS
, 0, 
p
->
iLa°Pg
, 0, &
pLa°
, 0);

2195 if–
rc
==
LSM_OK
 ){

2196 
iBlk
 = ()
	`lsmGëU32
(&
pLa°
->
aD©a
[
pFS
->
nPagesize
-4]);

2197 
	`lsmBlockRe‰ì
(
pFS
->
pDb
, 
iBlk
);

2198 
	`lsmFsPageRñó£
(
pLa°
);

2201 
iBlk
 = 0;

2202 
rc
 = 
	`fsBlockNext
(
pFS
, 
p
, 
	`fsPageToBlock
’FS,Ö->
iLa°Pg
), &
iBlk
);

2203 if–
rc
==
LSM_OK
 ){

2204 
	`lsmBlockRe‰ì
(
pFS
->
pDb
, 
iBlk
);

2208  
rc
;

2209 
	}
}

2216 
	$lsmFsDbPageGë
(
FûeSy°em
 *
pFS
, 
Segmít
 *
pSeg
, 
Pgno
 
iPg
, 
Page
 **
µPg
){

2217  
	`fsPageGë
(
pFS
, 
pSeg
, 
iPg
, 0, 
µPg
, 0);

2218 
	}
}

2226 
	$lsmFsDbPageLa°
(
FûeSy°em
 *
pFS
, 
Segmít
 *
pSeg
, 
Page
 **
µPg
){

2227 
rc
;

2228 
Pgno
 
iPg
 = 
pSeg
->
iLa°Pg
;

2229 if–
pFS
->
pCom¥ess
 ){

2230 
nS∑˚
;

2231 
iPg
++;

2233 
nS∑˚
 = 0;

2234 
rc
 = 
	`fsGëPageBef‹e
(
pFS
, 
pSeg
, 
iPg
, &iPg);

2235 if–
rc
==
LSM_OK
 ){

2236 
rc
 = 
	`fsPageGë
(
pFS
, 
pSeg
, 
iPg
, 0, 
µPg
, &
nS∑˚
);

2238 } 
rc
==
LSM_OK
 && 
nS∑˚
>0 );

2241 
rc
 = 
	`fsPageGë
(
pFS
, 
pSeg
, 
iPg
, 0, 
µPg
, 0);

2243  
rc
;

2244 
	}
}

2254 
	$lsmFsMëaPageGë
(

2255 
FûeSy°em
 *
pFS
,

2256 
bWrôe
,

2257 
iPg
,

2258 
MëaPage
 **
µPg


2260 
rc
 = 
LSM_OK
;

2261 
MëaPage
 *
pPg
;

2262 
	`as£π
–
iPg
==1 || iPg==2 );

2264 
pPg
 = 
	`lsmMÆlocZîoRc
(
pFS
->
pEnv
, (
Page
), &
rc
);

2266 if–
pPg
 ){

2267 
i64
 
iOff
 = (
iPg
-1Ë* 
pFS
->
nMëasize
;

2268 if–
pFS
->
nM≠Limô
>0 ){

2269 
	`fsGrowM≠pög
(
pFS
, 2*pFS->
nMëasize
, &
rc
);

2270 
pPg
->
aD©a
 = (
u8
 *)(
pFS
->
pM≠
Ë+ 
iOff
;

2272 
pPg
->
aD©a
 = 
	`lsmMÆlocRc
(
pFS
->
pEnv
,ÖFS->
nMëasize
, &
rc
);

2273 if–
rc
==
LSM_OK
 && 
bWrôe
==0 ){

2274 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
pPg
->
aD©a
,ÖFS->
nMëasize
);

2276 #i‚de‡
NDEBUG


2282 if–
rc
==
LSM_OK
 ){

2283 
	`mem£t
–
pPg
->
aD©a
, 0x77, 
pFS
->
nMëasize
 );

2288 if–
rc
!=
LSM_OK
 ){

2289 if–
pFS
->
nM≠Limô
==0 ) 
	`lsmFªe
’FS->
pEnv
, 
pPg
->
aD©a
);

2290 
	`lsmFªe
(
pFS
->
pEnv
, 
pPg
);

2291 
pPg
 = 0;

2293 
pPg
->
iPg
 = iPg;

2294 
pPg
->
bWrôe
 = bWrite;

2295 
pPg
->
pFS
 =ÖFS;

2299 *
µPg
 = 
pPg
;

2300  
rc
;

2301 
	}
}

2306 
	$lsmFsMëaPageRñó£
(
MëaPage
 *
pPg
){

2307 
rc
 = 
LSM_OK
;

2308 if–
pPg
 ){

2309 
FûeSy°em
 *
pFS
 = 
pPg
->pFS;

2311 if–
pFS
->
nM≠Limô
==0 ){

2312 if–
pPg
->
bWrôe
 ){

2313 
i64
 
iOff
 = (
pPg
->
iPg
==2 ? 
pFS
->
nMëasize
 : 0);

2314 
nWrôe
 = 
pFS
->
nMëasize
;

2315 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
pPg
->
aD©a
, 
nWrôe
);

2317 
	`lsmFªe
(
pFS
->
pEnv
, 
pPg
->
aD©a
);

2320 
	`lsmFªe
(
pFS
->
pEnv
, 
pPg
);

2322  
rc
;

2323 
	}
}

2330 
u8
 *
	$lsmFsMëaPageD©a
(
MëaPage
 *
pPg
, *
≤D©a
){

2331 if–
≤D©a
 ) *≤D©®
pPg
->
pFS
->
nMëasize
;

2332  
pPg
->
aD©a
;

2333 
	}
}

2339 #i‚de‡
NDEBUG


2340 
	$lsmFsPageWrôabÀ
(
Page
 *
pPg
){

2341  (
pPg
->
Êags
 & 
PAGE_DIRTY
) ? 1 : 0;

2342 
	}
}

2350 
	$fsMovePage
(

2351 
FûeSy°em
 *
pFS
,

2352 
iTo
,

2353 
iFrom
,

2354 
Pgno
 *
piPg


2356 
Pgno
 
iPg
 = *
piPg
;

2357 if–
iFrom
==
	`fsPageToBlock
(
pFS
, 
iPg
) ){

2358 c⁄° 
nPagePîBlock
 = (

2359 
pFS
->
pCom¥ess
 ?ÖFS ->
nBlocksize
 : (pFS->nBlocksizê/ÖFS->
nPagesize
)

2361 *
piPg
 = 
iPg
 - (
Pgno
)(
iFrom
 - 
iTo
Ë* 
nPagePîBlock
;

2363 
	}
}

2372 
	$lsmFsMoveBlock
(
FûeSy°em
 *
pFS
, 
Segmít
 *
pSeg
, 
iTo
, 
iFrom
){

2373 
S«pshŸ
 *
p
 = 
pFS
->
pDb
->
pW‹kî
;

2374 
rc
 = 
LSM_OK
;

2375 
i
;

2376 
i64
 
nM≠
;

2378 
i64
 
iFromOff
 = (i64)(
iFrom
-1Ë* 
pFS
->
nBlocksize
;

2379 
i64
 
iToOff
 = (i64)(
iTo
-1Ë* 
pFS
->
nBlocksize
;

2381 
	`as£π
–
iTo
!=1 );

2382 
	`as£π
–
iFrom
>
iTo
 );

2385 
nM≠
 = 
	`LSM_MIN
(
pFS
->
nM≠Limô
, (
i64
)
iFrom
 *ÖFS->
nBlocksize
);

2386 
	`fsGrowM≠pög
(
pFS
, 
nM≠
, &
rc
);

2388 if–
rc
==
LSM_OK
 ){

2389 c⁄° 
nPagePîBlock
 = (
pFS
->
nBlocksize
 /ÖFS->
nPagesize
);

2390 
nSz
 = 
pFS
->
nPagesize
;

2391 
u8
 *
aBuf
 = 0;

2392 
u8
 *
aD©a
 = 0;

2394 
i
=0; 
rc
==
LSM_OK
 && i<
nPagePîBlock
; i++){

2395 
i64
 
iOff
 = 
iFromOff
 + 
i
*
nSz
;

2398 if–(
iOff
+
nSz
)<=
pFS
->
nM≠Limô
 ){

2399 
u8
 *
aM≠
 = (u8 *)(
pFS
->
pM≠
);

2400 
aD©a
 = &
aM≠
[
iOff
];

2402 if–
aBuf
==0 ){

2403 
aBuf
 = (
u8
 *)
	`lsmMÆlocRc
(
pFS
->
pEnv
, 
nSz
, &
rc
);

2404 if–
aBuf
==0 ) ;

2406 
aD©a
 = 
aBuf
;

2407 
rc
 = 
	`lsmEnvRód
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
aD©a
, 
nSz
);

2411 if–
rc
==
LSM_OK
 ){

2412 
iOff
 = 
iToOff
 + 
i
*
nSz
;

2413 if–(
iOff
+
nSz
)<=
pFS
->
nM≠Limô
 ){

2414 
u8
 *
aM≠
 = (u8 *)(
pFS
->
pM≠
);

2415 
	`mem˝y
(&
aM≠
[
iOff
], 
aD©a
, 
nSz
);

2417 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
aD©a
, 
nSz
);

2421 
	`lsmFªe
(
pFS
->
pEnv
, 
aBuf
);

2422 
	`lsmFsPurgeCache
(
pFS
);

2426 
i
=0; i<
LSM_APPLIST_SZ
; i++){

2427 
	`fsMovePage
(
pFS
, 
iTo
, 
iFrom
, &
p
->
aiAµíd
[
i
]);

2431 
	`fsMovePage
(
pFS
, 
iTo
, 
iFrom
, &
pSeg
->
iFú°
);

2432 
	`fsMovePage
(
pFS
, 
iTo
, 
iFrom
, &
pSeg
->
iLa°Pg
);

2433 
	`fsMovePage
(
pFS
, 
iTo
, 
iFrom
, &
pSeg
->
iRoŸ
);

2435  
rc
;

2436 
	}
}

2445 
Pgno
 
	$fsAµídD©a
(

2446 
FûeSy°em
 *
pFS
,

2447 
Segmít
 *
pSeg
,

2448 c⁄° 
u8
 *
aD©a
,

2449 
nD©a
,

2450 *
pRc


2452 
Pgno
 
iRë
 = 0;

2453 
rc
 = *
pRc
;

2454 
	`as£π
–
pFS
->
pCom¥ess
 );

2455 if–
rc
==
LSM_OK
 ){

2456 
nRem
;

2457 
nWrôe
;

2458 
Pgno
 
iLa°OnBlock
;

2459 
Pgno
 
iAµ
 = 
pSeg
->
iLa°Pg
+1;

2463 if–
iAµ
==1 ){

2464 
pSeg
->
iFú°
 = 
iAµ
 = 
	`födAµídPoöt
(
pFS
, 0);

2465 if–
iAµ
==0 ){

2466 
iBlk
;

2467 
rc
 = 
	`lsmBlockAŒoˇã
(
pFS
->
pDb
, 0, &
iBlk
);

2468 
pSeg
->
iFú°
 = 
iAµ
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
);

2471 
iRë
 = 
iAµ
;

2474 
iLa°OnBlock
 = 
	`fsLa°PageOnPagesBlock
(
pFS
, 
iAµ
);

2475 if–
rc
==
LSM_OK
 ){

2476 
nS∑˚
 = 
iLa°OnBlock
 - 
iAµ
 + 1;

2477 
nWrôe
 = 
	`LSM_MIN
(
nD©a
, 
nS∑˚
);

2478 
nRem
 = 
nD©a
 - 
nWrôe
;

2479 
	`as£π
–
nWrôe
>=0 );

2480 if–
nWrôe
!=0 ){

2481 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iAµ
, 
aD©a
, 
nWrôe
);

2483 
iAµ
 +
nWrôe
;

2489 
	`as£π
–
nRem
<=0 || (
iAµ
-1)==
iLa°OnBlock
 );

2490 if–
rc
==
LSM_OK
 && (
iAµ
-1)==
iLa°OnBlock
 ){

2491 
u8
 
aPå
[4];

2492 
iBlk
;

2494 if–
nWrôe
>0 ){

2496 
rc
 = 
	`lsmBlockAŒoˇã
(
pFS
->
pDb
, 0, &
iBlk
);

2499 if–
rc
==
LSM_OK
 ){

2500 
	`as£π
–
iAµ
==(
	`fsPageToBlock
(
pFS
, iAµ)*pFS->
nBlocksize
)-4 );

2501 
	`lsmPutU32
(
aPå
, 
iBlk
);

2502 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iAµ
, 
aPå
, (aPtr));

2506 if–
rc
==
LSM_OK
 ){

2507 
Pgno
 
iWrôe
;

2508 
	`lsmPutU32
(
aPå
, 
	`fsPageToBlock
(
pFS
, 
iAµ
));

2509 
iWrôe
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
);

2510 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iWrôe
-4, 
aPå
, (aPtr));

2511 if–
nRem
>0 ) 
iAµ
 = 
iWrôe
;

2515 
	`as£π
–
nRem
>0 );

2516 
	`as£π
–
pSeg
->
pRedúe˘
==0 );

2517 
rc
 = 
	`fsBlockNext
(
pFS
, 0, 
	`fsPageToBlock
’FS, 
iAµ
), &
iBlk
);

2518 
iRë
 = 
iAµ
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
);

2522 if–
rc
==
LSM_OK
 && 
nRem
>0 ){

2523 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iAµ
, &
aD©a
[
nWrôe
], 
nRem
);

2524 
iAµ
 +
nRem
;

2528 
pSeg
->
iLa°Pg
 = 
iAµ
-1;

2529 *
pRc
 = 
rc
;

2532  
iRë
;

2533 
	}
}

2544 
	$fsCom¥essI¡oBuf„r
(
FûeSy°em
 *
pFS
, 
Page
 *
pPg
){

2545 
lsm_com¥ess
 *
p
 = 
pFS
->
pCom¥ess
;

2547 if–
	`fsAŒoˇãBuf„r
(
pFS
, 1ËË 
LSM_NOMEM
;

2548 
	`as£π
–
pPg
->
nD©a
==
pFS
->
nPagesize
 );

2550 
pPg
->
nCom¥ess
 = 
pFS
->
nBuf„r
;

2551  
p
->
	`xCom¥ess
’->
pCtx
,

2552 (*)
pFS
->
aOBuf„r
, &
pPg
->
nCom¥ess
,

2553 (c⁄° *)
pPg
->
aD©a
,ÖPg->
nD©a


2555 
	}
}

2573 
	$fsAµídPage
(

2574 
FûeSy°em
 *
pFS
,

2575 
Segmít
 *
pSeg
,

2576 
Pgno
 *
piNew
,

2577 *
piPªv
,

2578 *
piNext


2580 
Pgno
 
iPªv
 = 
pSeg
->
iLa°Pg
;

2581 
rc
;

2582 
	`as£π
–
iPªv
!=0 );

2584 *
piPªv
 = 0;

2585 *
piNext
 = 0;

2587 if–
	`fsIsLa°
(
pFS
, 
iPªv
) ){

2592 
iNext
;

2593 
iBlk
 = 
	`fsPageToBlock
(
pFS
, 
iPªv
);

2594 
	`as£π
–
pSeg
->
pRedúe˘
==0 );

2595 
rc
 = 
	`fsBlockNext
(
pFS
, 0, 
iBlk
, &
iNext
);

2596 if–
rc
!=
LSM_OK
 ) Ñc;

2597 *
piNew
 = 
	`fsFú°PageOnBlock
(
pFS
, 
iNext
);

2598 *
piPªv
 = 
iBlk
;

2600 *
piNew
 = 
iPªv
+1;

2601 if–
	`fsIsLa°
(
pFS
, *
piNew
) ){

2603 
iBlk
;

2604 
rc
 = 
	`lsmBlockAŒoˇã
(
pFS
->
pDb
, 0, &
iBlk
);

2605 if–
rc
!=
LSM_OK
 ) Ñc;

2606 *
piNext
 = 
iBlk
;

2610 
pSeg
->
nSize
++;

2611 
pSeg
->
iLa°Pg
 = *
piNew
;

2612  
LSM_OK
;

2613 
	}
}

2618 
	$lsmFsFlushWaôög
(
FûeSy°em
 *
pFS
, *
pRc
){

2619 
rc
 = *
pRc
;

2620 
Page
 *
pPg
;

2622 
pPg
 = 
pFS
->
pWaôög
;

2623 
pFS
->
pWaôög
 = 0;

2625  
pPg
 ){

2626 
Page
 *
pNext
 = 
pPg
->
pWaôögNext
;

2627 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmFsPagePîsi°
(
pPg
);

2628 
	`as£π
–
pPg
->
nRef
==1 );

2629 
	`lsmFsPageRñó£
(
pPg
);

2630 
pPg
 = 
pNext
;

2632 *
pRc
 = 
rc
;

2633 
	}
}

2638 
	$fsRemoveHashE¡ry
(
FûeSy°em
 *
pFS
, 
Pgno
 
iPg
){

2639 
Page
 *
p
;

2640 
iHash
 = 
	`fsHashKey
(
pFS
->
nHash
, 
iPg
);

2642 
p
=
pFS
->
≠Hash
[
iHash
];Ö &&Ö->
iPg
!=iPg;Öı->
pHashNext
);

2644 if–
p
 ){

2645 
	`as£π
–
p
->
nRef
==0 || (p->
Êags
 & 
PAGE_FREE
)==0 );

2646 
	`fsPageRemoveFromHash
(
pFS
, 
p
);

2647 
p
->
iPg
 = 0;

2648 
iHash
 = 
	`fsHashKey
(
pFS
->
nHash
, 0);

2649 
p
->
pHashNext
 = 
pFS
->
≠Hash
[
iHash
];

2650 
pFS
->
≠Hash
[
iHash
] = 
p
;

2652 
	}
}

2662 
	$lsmFsPagePîsi°
(
Page
 *
pPg
){

2663 
rc
 = 
LSM_OK
;

2664 if–
pPg
 && (pPg->
Êags
 & 
PAGE_DIRTY
) ){

2665 
FûeSy°em
 *
pFS
 = 
pPg
->pFS;

2667 if–
pFS
->
pCom¥ess
 ){

2668 
iHash
;

2669 
u8
 
aSz
[3];

2670 
	`as£π
–
pPg
->
pSeg
 &&ÖPg->
iPg
==0 &&ÖPg->
nCom¥ess
==0 );

2673 
rc
 = 
	`fsCom¥essI¡oBuf„r
(
pFS
, 
pPg
);

2676 
	`putRec‹dSize
(
aSz
, 
pPg
->
nCom¥ess
, 0);

2679 
pPg
->
iPg
 = 
	`fsAµídD©a
(
pFS
,ÖPg->
pSeg
, 
aSz
, ◊Sz), &
rc
);

2680 
	`fsAµídD©a
(
pFS
, 
pPg
->
pSeg
,ÖFS->
aOBuf„r
,ÖPg->
nCom¥ess
, &
rc
);

2681 
	`fsAµídD©a
(
pFS
, 
pPg
->
pSeg
, 
aSz
, ◊Sz), &
rc
);

2684 
iHash
 = 
	`fsHashKey
(
pFS
->
nHash
, 
pPg
->
iPg
);

2685 
pPg
->
pHashNext
 = 
pFS
->
≠Hash
[
iHash
];

2686 
pFS
->
≠Hash
[
iHash
] = 
pPg
;

2688 
pPg
->
pSeg
->
nSize
 +((
aSz
Ë* 2Ë+ÖPg->
nCom¥ess
;

2690 
pPg
->
Êags
 &~
PAGE_DIRTY
;

2691 
pFS
->
nWrôe
++;

2694 if–
pPg
->
iPg
==0 ){

2702 
Page
 **
µ
;

2703 
iPªv
 = 0;

2704 
iNext
 = 0;

2705 
iHash
;

2707 
	`as£π
–
pPg
->
pSeg
->
iFú°
 );

2708 
	`as£π
–
pPg
->
Êags
 & 
PAGE_FREE
 );

2709 
	`as£π
–(
pPg
->
Êags
 & 
PAGE_HASPREV
)==0 );

2710 
	`as£π
–
pPg
->
nD©a
==
pFS
->
nPagesize
-4 );

2712 
rc
 = 
	`fsAµídPage
(
pFS
, 
pPg
->
pSeg
, &pPg->
iPg
, &
iPªv
, &
iNext
);

2713 if–
rc
!=
LSM_OK
 ) Ñc;

2715 
	`as£π
–
pPg
->
Êags
 & 
PAGE_FREE
 );

2716 
iHash
 = 
	`fsHashKey
(
pFS
->
nHash
, 
pPg
->
iPg
);

2717 
	`fsRemoveHashE¡ry
(
pFS
, 
pPg
->
iPg
);

2718 
pPg
->
pHashNext
 = 
pFS
->
≠Hash
[
iHash
];

2719 
pFS
->
≠Hash
[
iHash
] = 
pPg
;

2720 
	`as£π
–
pPg
->
pHashNext
==0 ||ÖPg->pHashNext->
iPg
!=pPg->iPg );

2722 if–
iPªv
 ){

2723 
	`as£π
–
iNext
==0 );

2724 
	`memmove
(&
pPg
->
aD©a
[4],ÖPg->aD©a,ÖPg->
nD©a
);

2725 
	`lsmPutU32
(
pPg
->
aD©a
, 
iPªv
);

2726 
pPg
->
Êags
 |
PAGE_HASPREV
;

2727 
pPg
->
aD©a
 += 4;

2728 }if–
iNext
 ){

2729 
	`as£π
–
iPªv
==0 );

2730 
	`lsmPutU32
(&
pPg
->
aD©a
[pPg->
nD©a
], 
iNext
);

2732 
nD©a
 = 
pPg
->nData;

2733 
pPg
->
nD©a
 += 4;

2734 
	`lsmS‹ãdEx∑ndBåìPage
(
pPg
, 
nD©a
);

2737 
pPg
->
nRef
++;

2738 
µ
=&
pFS
->
pWaôög
; *µ;Öp=&(*µ)->
pWaôögNext
);

2739 *
µ
 = 
pPg
;

2740 
	`as£π
–
pPg
->
pWaôögNext
==0 );

2743 
i64
 
iOff
;

2745 
iOff
 = (
i64
)
pFS
->
nPagesize
 * (i64)(
pPg
->
iPg
-1);

2746 if–
	`fsMm≠Page
(
pFS
, 
pPg
->
iPg
)==0 ){

2747 
u8
 *
aD©a
 = 
pPg
->aD©®- (pPg->
Êags
 & 
PAGE_HASPREV
);

2748 
rc
 = 
	`lsmEnvWrôe
(
pFS
->
pEnv
,ÖFS->
fdDb
, 
iOff
, 
aD©a
,ÖFS->
nPagesize
);

2749 }if–
pPg
->
Êags
 & 
PAGE_FREE
 ){

2750 
	`fsGrowM≠pög
(
pFS
, 
iOff
 +ÖFS->
nPagesize
, &
rc
);

2751 if–
rc
==
LSM_OK
 ){

2752 
u8
 *
aTo
 = &((u8 *)(
pFS
->
pM≠
))[
iOff
];

2753 
u8
 *
aFrom
 = 
pPg
->
aD©a
 - (pPg->
Êags
 & 
PAGE_HASPREV
);

2754 
	`mem˝y
(
aTo
, 
aFrom
, 
pFS
->
nPagesize
);

2755 
	`lsmFªe
(
pFS
->
pEnv
, 
aFrom
);

2756 
pFS
->
nCacheAŒoc
--;

2757 
pPg
->
aD©a
 = 
aTo
 + (pPg->
Êags
 & 
PAGE_HASPREV
);

2758 
pPg
->
Êags
 &~
PAGE_FREE
;

2759 
	`fsPageRemoveFromHash
(
pFS
, 
pPg
);

2760 
pPg
->
pM≠≥dNext
 = 
pFS
->
pM≠≥d
;

2761 
pFS
->
pM≠≥d
 = 
pPg
;

2765 
	`lsmFsFlushWaôög
(
pFS
, &
rc
);

2766 
pPg
->
Êags
 &~
PAGE_DIRTY
;

2767 
pFS
->
nWrôe
++;

2772  
rc
;

2773 
	}
}

2785 
	$lsmFsS‹ãdPaddög
(

2786 
FûeSy°em
 *
pFS
,

2787 
S«pshŸ
 *
pS«pshŸ
,

2788 
Segmít
 *
pSeg


2790 
rc
 = 
LSM_OK
;

2791 if–
pFS
->
pCom¥ess
 ){

2792 
Pgno
 
iLa°2
;

2793 
Pgno
 
iLa°
 = 
pSeg
->
iLa°Pg
;

2794 
nPad
;

2795 
u8
 
aSz
[3];

2797 
iLa°2
 = (1 + 
iLa°
/
pFS
->
szSe˘‹
) *ÖFS->szSector - 1;

2798 
	`as£π
–
	`fsPageToBlock
(
pFS
, 
iLa°
)==fsPageToBlock’FS, 
iLa°2
) );

2799 
nPad
 = 
iLa°2
 - 
iLa°
;

2801 if–
iLa°2
>
	`fsLa°PageOnPagesBlock
(
pFS
, 
iLa°
) ){

2802 
nPad
 -= 4;

2804 
	`as£π
–
nPad
>=0 );

2806 if–
nPad
>=6 ){

2807 
pSeg
->
nSize
 +
nPad
;

2808 
nPad
 -= 6;

2809 
	`putRec‹dSize
(
aSz
, 
nPad
, 1);

2810 
	`fsAµídD©a
(
pFS
, 
pSeg
, 
aSz
, ◊Sz), &
rc
);

2811 
	`mem£t
(
pFS
->
aOBuf„r
, 0, 
nPad
);

2812 
	`fsAµídD©a
(
pFS
, 
pSeg
,ÖFS->
aOBuf„r
, 
nPad
, &
rc
);

2813 
	`fsAµídD©a
(
pFS
, 
pSeg
, 
aSz
, ◊Sz), &
rc
);

2814 }if–
nPad
>0 ){

2815 
u8
 
aBuf
[5] = {0,0,0,0,0};

2816 
aBuf
[0] = (
u8
)
nPad
;

2817 
aBuf
[
nPad
-1] = (
u8
)nPad;

2818 
	`fsAµídD©a
(
pFS
, 
pSeg
, 
aBuf
, 
nPad
, &
rc
);

2821 
	`as£π
–
rc
!=
LSM_OK


2822 || 
pSeg
->
iLa°Pg
==
	`fsLa°PageOnPagesBlock
(
pFS
,ÖSeg->iLastPg)

2823 || ((
pSeg
->
iLa°Pg
 + 1Ë% 
pFS
->
szSe˘‹
)==0

2827  
rc
;

2828 
	}
}

2835 
	$lsmFsPageRef
(
Page
 *
pPg
){

2836 if–
pPg
 ){

2837 
pPg
->
nRef
++;

2839 
	}
}

2844 
	$lsmFsPageRñó£
(
Page
 *
pPg
){

2845 
rc
 = 
LSM_OK
;

2846 if–
pPg
 ){

2847 
	`as£π
–
pPg
->
nRef
>0 );

2848 
pPg
->
nRef
--;

2849 if–
pPg
->
nRef
==0 ){

2850 
FûeSy°em
 *
pFS
 = 
pPg
->pFS;

2851 
rc
 = 
	`lsmFsPagePîsi°
(
pPg
);

2852 
pFS
->
nOut
--;

2854 
	`as£π
–
pPg
->
pFS
->
pCom¥ess


2855 || 
	`fsIsFú°
(
pPg
->
pFS
,ÖPg->
iPg
)==0

2856 || (
pPg
->
Êags
 & 
PAGE_HASPREV
)

2858 
pPg
->
aD©a
 -’Pg->
Êags
 & 
PAGE_HASPREV
);

2859 
pPg
->
Êags
 &~
PAGE_HASPREV
;

2861 if–(
pPg
->
Êags
 & 
PAGE_FREE
)==0 ){

2863 
Page
 **
µ
;

2864 
µ
=&
pFS
->
pM≠≥d
; (*µ)!=
pPg
;Öp=&(*µ)->
pM≠≥dNext
);

2865 *
µ
 = 
pPg
->
pM≠≥dNext
;

2866 
pPg
->
pM≠≥dNext
 = 0;

2869 
pPg
->
pFªeNext
 = 
pFS
->
pFªe
;

2870 
pFS
->
pFªe
 = 
pPg
;

2872 
	`fsPageAddToLru
(
pFS
, 
pPg
);

2877  
rc
;

2878 
	}
}

2883 
	$lsmFsNRód
(
FûeSy°em
 *
pFS
){ ÖFS->
nRód
; 
	}
}

2888 
	$lsmFsNWrôe
(
FûeSy°em
 *
pFS
){ ÖFS->
nWrôe
; 
	}
}

2893 
lsm_ív
 *
	$lsmFsEnv
(
FûeSy°em
 *
pFS
){

2894  
pFS
->
pEnv
;

2895 
	}
}

2901 
lsm_ív
 *
	$lsmPageEnv
(
Page
 *
pPg
) {

2902  
pPg
->
pFS
->
pEnv
;

2903 
	}
}

2909 
FûeSy°em
 *
	$lsmPageFS
(
Page
 *
pPg
){

2910  
pPg
->
pFS
;

2911 
	}
}

2916 
	$lsmFsSe˘‹Size
(
FûeSy°em
 *
pFS
){

2917  
pFS
->
szSe˘‹
;

2918 
	}
}

2923 
Segmít
 *
	$°¨tsWôh
(
Segmít
 *
pRun
, 
Pgno
 
iFú°
){

2924  (
iFú°
==
pRun
->iFirst) ?ÖRun : 0;

2925 
	}
}

2931 
Segmít
 *
	$födSegmít
(
S«pshŸ
 *
pW‹kî
, 
Pgno
 
iFú°
){

2932 
Levñ
 *
pLvl
;

2933 
Segmít
 *
pSeg
 = 0;

2935 
pLvl
=
	`lsmDbS«pshŸLevñ
(
pW‹kî
);ÖLv»&& 
pSeg
==0;ÖLvlıLvl->
pNext
){

2936 if–0==(
pSeg
 = 
	`°¨tsWôh
(&
pLvl
->
lhs
, 
iFú°
)) ){

2937 
i
;

2938 
i
=0; i<
pLvl
->
nRight
; i++){

2939 if–(
pSeg
 = 
	`°¨tsWôh
(&
pLvl
->
aRhs
[
i
], 
iFú°
)) ) ;

2944  
pSeg
;

2945 
	}
}

2955 
	$lsmInfoAºaySåu˘uª
(

2956 
lsm_db
 *
pDb
,

2957 
bBlock
,

2958 
Pgno
 
iFú°
,

2959 **
pzOut


2961 
rc
 = 
LSM_OK
;

2962 
S«pshŸ
 *
pW‹kî
;

2963 
Segmít
 *
pAºay
 = 0;

2964 
bU∆ock
 = 0;

2966 *
pzOut
 = 0;

2967 if–
iFú°
==0 )  
LSM_ERROR
;

2970 
pW‹kî
 = 
pDb
->pWorker;

2971 if–!
pW‹kî
 ){

2972 
rc
 = 
	`lsmBegöW‹k
(
pDb
);

2973 if–
rc
!=
LSM_OK
 ) Ñc;

2974 
pW‹kî
 = 
pDb
->pWorker;

2975 
bU∆ock
 = 1;

2979 
pAºay
 = 
	`födSegmít
(
pW‹kî
, 
iFú°
);

2981 if–
pAºay
==0 ){

2983 
rc
 = 
LSM_ERROR
;

2985 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

2986 
LsmSåög
 
°r
;

2987 
iBlk
;

2988 
iLa°Blk
;

2990 
iBlk
 = 
	`fsPageToBlock
(
pFS
, 
pAºay
->
iFú°
);

2991 
iLa°Blk
 = 
	`fsPageToBlock
(
pFS
, 
pAºay
->
iLa°Pg
);

2993 
	`lsmSåögInô
(&
°r
, 
pDb
->
pEnv
);

2994 if–
bBlock
 ){

2995 
	`lsmSåögAµídf
(&
°r
, "%d", 
iBlk
);

2996  
iBlk
!=
iLa°Blk
 ){

2997 
	`fsBlockNext
(
pFS
, 
pAºay
, 
iBlk
, &iBlk);

2998 
	`lsmSåögAµídf
(&
°r
, " %d", 
iBlk
);

3001 
	`lsmSåögAµídf
(&
°r
, "%d", 
pAºay
->
iFú°
);

3002  
iBlk
!=
iLa°Blk
 ){

3003 
	`lsmSåögAµídf
(&
°r
, " %d", 
	`fsLa°PageOnBlock
(
pFS
, 
iBlk
));

3004 
	`fsBlockNext
(
pFS
, 
pAºay
, 
iBlk
, &iBlk);

3005 
	`lsmSåögAµídf
(&
°r
, " %d", 
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
));

3007 
	`lsmSåögAµídf
(&
°r
, " %d", 
pAºay
->
iLa°Pg
);

3010 *
pzOut
 = 
°r
.
z
;

3013 if–
bU∆ock
 ){

3014 
rcw‹k
 = 
LSM_BUSY
;

3015 
	`lsmFöishW‹k
(
pDb
, 0, &
rcw‹k
);

3017  
rc
;

3018 
	}
}

3020 
	$lsmFsSegmítC⁄èösPg
(

3021 
FûeSy°em
 *
pFS
,

3022 
Segmít
 *
pSeg
,

3023 
Pgno
 
iPg
,

3024 *
pbRes


3026 
Redúe˘
 *
pRedú
 = 
pSeg
->
pRedúe˘
;

3027 
rc
 = 
LSM_OK
;

3028 
iBlk
;

3029 
iLa°Blk
;

3030 
iPgBlock
;

3032 
iPgBlock
 = 
	`fsPageToBlock
(
pFS
, 
pSeg
->
iFú°
);

3033 
iBlk
 = 
	`fsRedúe˘Block
(
pRedú
, 
	`fsPageToBlock
(
pFS
, 
pSeg
->
iFú°
));

3034 
iLa°Blk
 = 
	`fsRedúe˘Block
(
pRedú
, 
	`fsPageToBlock
(
pFS
, 
pSeg
->
iLa°Pg
));

3036  
iBlk
!=
iLa°Blk
 && iBlk!=
iPgBlock
 && 
rc
==
LSM_OK
 ){

3037 
rc
 = 
	`fsBlockNext
(
pFS
, 
pSeg
, 
iBlk
, &iBlk);

3040 *
pbRes
 = (
iBlk
==
iPgBlock
);

3041  
rc
;

3042 
	}
}

3052 
	$lsmInfoAºayPages
(
lsm_db
 *
pDb
, 
Pgno
 
iFú°
, **
pzOut
){

3053 
rc
 = 
LSM_OK
;

3054 
S«pshŸ
 *
pW‹kî
;

3055 
Segmít
 *
pSeg
 = 0;

3056 
bU∆ock
 = 0;

3058 *
pzOut
 = 0;

3059 if–
iFú°
==0 )  
LSM_ERROR
;

3062 
pW‹kî
 = 
pDb
->pWorker;

3063 if–!
pW‹kî
 ){

3064 
rc
 = 
	`lsmBegöW‹k
(
pDb
);

3065 if–
rc
!=
LSM_OK
 ) Ñc;

3066 
pW‹kî
 = 
pDb
->pWorker;

3067 
bU∆ock
 = 1;

3071 
pSeg
 = 
	`födSegmít
(
pW‹kî
, 
iFú°
);

3073 if–
pSeg
==0 ){

3075 
rc
 = 
LSM_ERROR
;

3077 
Page
 *
pPg
 = 0;

3078 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

3079 
LsmSåög
 
°r
;

3081 
	`lsmSåögInô
(&
°r
, 
pDb
->
pEnv
);

3082 
rc
 = 
	`lsmFsDbPageGë
(
pFS
, 
pSeg
, 
iFú°
, &
pPg
);

3083  
rc
==
LSM_OK
 && 
pPg
 ){

3084 
Page
 *
pNext
 = 0;

3085 
	`lsmSåögAµídf
(&
°r
, " %Œd", 
	`lsmFsPageNumbî
(
pPg
));

3086 
rc
 = 
	`lsmFsDbPageNext
(
pSeg
, 
pPg
, 1, &
pNext
);

3087 
	`lsmFsPageRñó£
(
pPg
);

3088 
pPg
 = 
pNext
;

3091 if–
rc
!=
LSM_OK
 ){

3092 
	`lsmFªe
(
pDb
->
pEnv
, 
°r
.
z
);

3094 *
pzOut
 = 
°r
.
z
;

3098 if–
bU∆ock
 ){

3099 
rcw‹k
 = 
LSM_BUSY
;

3100 
	`lsmFöishW‹k
(
pDb
, 0, &
rcw‹k
);

3102  
rc
;

3103 
	}
}

3123 
	#INTEGRITY_CHECK_FIRST_PG
 0x01

	)

3124 
	#INTEGRITY_CHECK_LAST_PG
 0x02

	)

3125 
	#INTEGRITY_CHECK_USED
 0x04

	)

3126 
	#INTEGRITY_CHECK_FREE
 0x08

	)

3131 
	$checkBlocks
(

3132 
FûeSy°em
 *
pFS
,

3133 
Segmít
 *
pSeg
,

3134 
bExåa
,

3135 
nU£d
,

3136 
u8
 *
aU£d


3138 if–
pSeg
 ){

3139 if–
pSeg
 &&ÖSeg->
nSize
>0 ){

3140 
rc
;

3141 
iBlk
;

3142 
iLa°Blk
;

3143 
iFú°Blk
;

3144 
bLa°IsLa°OnBlock
;

3146 
	`as£π
–0==
	`fsSegmítRedúe˘s
(
pFS
, 
pSeg
) );

3147 
iBlk
 = 
iFú°Blk
 = 
	`fsPageToBlock
(
pFS
, 
pSeg
->
iFú°
);

3148 
iLa°Blk
 = 
	`fsPageToBlock
(
pFS
, 
pSeg
->
iLa°Pg
);

3150 
bLa°IsLa°OnBlock
 = (
	`fsLa°PageOnBlock
(
pFS
, 
iLa°Blk
)==
pSeg
->
iLa°Pg
);

3151 
	`as£π
–
iBlk
>0 );

3155 
aU£d
[
iBlk
-1] |
INTEGRITY_CHECK_USED
;

3160 if–
	`fsFú°PageOnBlock
(
pFS
, 
iBlk
)==
pSeg
->
iFú°
 || iBlk!=
iFú°Blk
 ){

3161 
	`as£π
–(
aU£d
[
iBlk
-1] & 
INTEGRITY_CHECK_FIRST_PG
)==0 );

3162 
aU£d
[
iBlk
-1] |
INTEGRITY_CHECK_FIRST_PG
;

3167 if–
iBlk
!=
iLa°Blk
 || 
bLa°IsLa°OnBlock
 ){

3168 
	`as£π
–(
aU£d
[
iBlk
-1] & 
INTEGRITY_CHECK_LAST_PG
)==0 );

3169 
aU£d
[
iBlk
-1] |
INTEGRITY_CHECK_LAST_PG
;

3176 if–
iBlk
==
iLa°Blk
 && 
bLa°IsLa°OnBlock
 && 
bExåa
 ){

3177 
iExåa
 = 0;

3178 
rc
 = 
	`fsBlockNext
(
pFS
, 
pSeg
, 
iBlk
, &
iExåa
);

3179 
	`as£π
–
rc
==
LSM_OK
 );

3181 
	`as£π
–
aU£d
[
iExåa
-1]==0 );

3182 
aU£d
[
iExåa
-1] |
INTEGRITY_CHECK_USED
;

3183 
aU£d
[
iExåa
-1] |
INTEGRITY_CHECK_FIRST_PG
;

3184 
aU£d
[
iExåa
-1] |
INTEGRITY_CHECK_LAST_PG
;

3190 if–
iBlk
==
iLa°Blk
 ){

3191 
iBlk
 = 0;

3193 
rc
 = 
	`fsBlockNext
(
pFS
, 
pSeg
, 
iBlk
, &iBlk);

3194 
	`as£π
–
rc
==
LSM_OK
 );

3196 } 
iBlk
 );

3199 
	}
}

3201 
CheckFªñi°Ctx
 
	tCheckFªñi°Ctx
;

3202 
	sCheckFªñi°Ctx
 {

3203 
u8
 *
	maU£d
;

3204 
	mnBlock
;

3206 
	$checkFªñi°Cb
(*
pCtx
, 
iBlk
, 
i64
 
iS«pshŸ
){

3207 
CheckFªñi°Ctx
 *
p
 = (CheckFªñi°Ctx *)
pCtx
;

3209 
	`as£π
–
iBlk
>=1 );

3210 
	`as£π
–
iBlk
<=
p
->
nBlock
 );

3211 
	`as£π
–
p
->
aU£d
[
iBlk
-1]==0 );

3212 
p
->
aU£d
[
iBlk
-1] = 
INTEGRITY_CHECK_FREE
;

3214 
	}
}

3229 
	$lsmFsI¡egrôyCheck
(
lsm_db
 *
pDb
){

3230 
CheckFªñi°Ctx
 
˘x
;

3231 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

3232 
i
;

3233 
rc
;

3234 
Fªñi°
 
‰ìli°
 = {0, 0, 0};

3235 
u8
 *
aU£d
;

3236 
Levñ
 *
pLevñ
;

3237 
S«pshŸ
 *
pW‹kî
 = 
pDb
->pWorker;

3238 
nBlock
 = 
pW‹kî
->nBlock;

3241 
nCÆl
 = 0;

3242 
nCÆl
++;

3243 
	`¥ötf
("%d cÆls\n", 
nCÆl
);

3246 
aU£d
 = 
	`lsmMÆlocZîo
(
pDb
->
pEnv
, 
nBlock
);

3247 if–
aU£d
==0 ){

3255 
pLevñ
=
pW‹kî
->pLevñ;ÖLevñ;ÖLevñıLevñ->
pNext
){

3256 
i
;

3257 
	`checkBlocks
(
pFS
, &
pLevñ
->
lhs
, (pLevñ->
nRight
!=0), 
nBlock
, 
aU£d
);

3258 
i
=0; i<
pLevñ
->
nRight
; i++){

3259 
	`checkBlocks
(
pFS
, &
pLevñ
->
aRhs
[
i
], 0, 
nBlock
, 
aU£d
);

3264 
˘x
.
aU£d
 =áUsed;

3265 
˘x
.
nBlock
 =ÇBlock;

3266 
rc
 = 
	`lsmWÆkFªñi°
(
pDb
, 0, 
checkFªñi°Cb
, (*)&
˘x
);

3268 if–
rc
==
LSM_OK
 ){

3269 
i
=0; i<
nBlock
; i++Ë
	`as£π
–
aU£d
[i]!=0 );

3272 
	`lsmFªe
(
pDb
->
pEnv
, 
aU£d
);

3273 
	`lsmFªe
(
pDb
->
pEnv
, 
‰ìli°
.
aE¡ry
);

3276 
	}
}

3278 #i‚de‡
NDEBUG


3283 
	$lsmFsDbPageIsLa°
(
Segmít
 *
pSeg
, 
Page
 *
pPg
){

3284 if–
pPg
->
pFS
->
pCom¥ess
 ){

3285 
Pgno
 
iNext
 = 0;

3286 
rc
;

3287 
rc
 = 
	`fsNextPageOff£t
(
pPg
->
pFS
, 
pSeg
,ÖPg->
iPg
,ÖPg->
nCom¥ess
+6, &
iNext
);

3288  (
rc
!=
LSM_OK
 || 
iNext
==0);

3290  (
pPg
->
iPg
==
pSeg
->
iLa°Pg
);

3291 
	}
}

	@src/lsm_log.c

189 #i‚de‡
_LSM_INT_H


190 
	~"lsmI¡.h
"

194 
	#LSM_LOG_EOF
 0x00

	)

195 
	#LSM_LOG_PAD1
 0x01

	)

196 
	#LSM_LOG_PAD2
 0x02

	)

197 
	#LSM_LOG_COMMIT
 0x03

	)

198 
	#LSM_LOG_JUMP
 0x04

	)

200 
	#LSM_LOG_WRITE
 0x06

	)

201 
	#LSM_LOG_WRITE_CKSUM
 0x07

	)

202 
	#LSM_LOG_DELETE
 0x08

	)

203 
	#LSM_LOG_DELETE_CKSUM
 0x09

	)

206 
	#LSM_CKSUM_MAXDATA
 (32*1024)

	)

209 
	#LSM_MIN_LOGWRAP
 (128*1024)

	)

218 
	sLogWrôî
 {

219 
u32
 
	mcksum0
;

220 
u32
 
	mcksum1
;

221 
	miCksumBuf
;

222 
i64
 
	miOff
;

223 
	mszSe˘‹
;

224 
LogRegi⁄
 
	mjump
;

225 
i64
 
	miRegi⁄1End
;

226 
i64
 
	miRegi⁄2Sèπ
;

227 
LsmSåög
 
	mbuf
;

234 
u32
 
	$gëU32À
(
u8
 *
aIn
){

235  ((
u32
)
aIn
[3] << 24)

236 + ((
u32
)
aIn
[2] << 16)

237 + ((
u32
)
aIn
[1] << 8)

238 + ((
u32
)
aIn
[0]);

239 
	}
}

247 
	$logCksumU«lig√d
(

248 *
z
,

249 
n
,

250 
u32
 *
pCksum0
,

251 
u32
 *
pCksum1


253 
u8
 *
a
 = (u8 *)
z
;

254 
u32
 
cksum0
 = *
pCksum0
;

255 
u32
 
cksum1
 = *
pCksum1
;

256 
nIn
 = (
n
/8) * 8;

257 
i
;

259 
	`as£π
–
n
>0 );

260 
i
=0; i<
nIn
; i+=8){

261 
cksum0
 +
	`gëU32À
(&
a
[
i
]Ë+ 
cksum1
;

262 
cksum1
 +
	`gëU32À
(&
a
[
i
+4]Ë+ 
cksum0
;

265 if–
nIn
!=
n
 ){

266 
u8
 
aBuf
[8] = {0, 0, 0, 0, 0, 0, 0, 0};

267 
	`as£π
–(
n
-
nIn
)<8 &&Ç>nIn );

268 
	`mem˝y
(
aBuf
, &
a
[
nIn
], 
n
-nIn);

269 
cksum0
 +
	`gëU32À
(
aBuf
Ë+ 
cksum1
;

270 
cksum1
 +
	`gëU32À
(&
aBuf
[4]Ë+ 
cksum0
;

273 *
pCksum0
 = 
cksum0
;

274 *
pCksum1
 = 
cksum1
;

275 
	}
}

281 
	$logUpd©eCksum
(
LogWrôî
 *
pLog
, 
nBuf
){

282 
	`as£π
–(
pLog
->
iCksumBuf
 % 8)==0 );

283 
	`as£π
–
pLog
->
iCksumBuf
<=
nBuf
 );

284 
	`as£π
–(
nBuf
 % 8)==0 ||ÇBuf==
pLog
->
buf
.
n
 );

285 if–
nBuf
>
pLog
->
iCksumBuf
 ){

286 
	`logCksumU«lig√d
(

287 &
pLog
->
buf
.
z
[pLog->
iCksumBuf
], 
nBuf
-pLog->iCksumBuf,

288 &
pLog
->
cksum0
, &pLog->
cksum1


291 
pLog
->
iCksumBuf
 = 
nBuf
;

292 
	}
}

294 
i64
 
	$fú°ByãOnSe˘‹
(
LogWrôî
 *
pLog
, 
i64
 
iOff
){

295  (
iOff
 / 
pLog
->
szSe˘‹
) *ÖLog->szSector;

296 
	}
}

297 
i64
 
	$œ°ByãOnSe˘‹
(
LogWrôî
 *
pLog
, 
i64
 
iOff
){

298  
	`fú°ByãOnSe˘‹
(
pLog
, 
iOff
Ë+ÖLog->
szSe˘‹
 - 1;

299 
	}
}

306 
	$logRe˛aimS∑˚
(
lsm_db
 *
pDb
){

307 
rc
;

308 
iMëa
;

309 
bRŸøns
;

313 
rc
 = 
	`lsmDëe˘RoTøns
(
pDb
, &
bRŸøns
);

314 if–
rc
!=
LSM_OK
 || 
bRŸøns
 ) Ñc;

316 
iMëa
 = ()
pDb
->
pShmhdr
->
iMëaPage
;

317 if–
iMëa
==1 || iMeta==2 ){

318 
DbLog
 *
pLog
 = &
pDb
->
åìhdr
.
log
;

319 
i64
 
iSyn˚dId
;

328 
rc
 = 
	`lsmFsRódSyn˚dId
(
pDb
, 
iMëa
, &
iSyn˚dId
);

330 if–
rc
==
LSM_OK
 && 
pLog
->
iS«pshŸId
!=
iSyn˚dId
 ){

331 
i64
 
iS«pshŸId
 = 0;

332 
i64
 
iOff
 = 0;

333 
rc
 = 
	`lsmCheckpoötSyn˚d
(
pDb
, &
iS«pshŸId
, &
iOff
, 0);

334 if–
rc
==
LSM_OK
 && 
pLog
->
iS«pshŸId
<iSnapshotId ){

335 
iRegi⁄
;

336 
iRegi⁄
=0; iRegion<3; iRegion++){

337 
LogRegi⁄
 *
p
 = &
pLog
->
aRegi⁄
[
iRegi⁄
];

338 if–
iOff
>=
p
->
iSèπ
 && iOff<ı->
iEnd
 ) ;

339 
p
->
iSèπ
 = 0;

340 
p
->
iEnd
 = 0;

342 
	`as£π
–
iRegi⁄
<3 );

343 
pLog
->
aRegi⁄
[
iRegi⁄
].
iSèπ
 = 
iOff
;

344 
pLog
->
iS«pshŸId
 = iSnapshotId;

348  
rc
;

349 
	}
}

360 
	$lsmLogBegö
(
lsm_db
 *
pDb
){

361 
rc
 = 
LSM_OK
;

362 
LogWrôî
 *
pNew
;

363 
LogRegi⁄
 *
aReg
;

365 if–
pDb
->
bU£Log
==0 )  
LSM_OK
;

369 
rc
 = 
	`lsmFsO≥nLog
(
pDb
, 0);

370 if–
pDb
->
pLogWrôî
==0 ){

371 
pNew
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
LogWrôî
), &
rc
);

372 if–
pNew
 ){

373 
	`lsmSåögInô
(&
pNew
->
buf
, 
pDb
->
pEnv
);

374 
rc
 = 
	`lsmSåögExãnd
(&
pNew
->
buf
, 2);

377 
pNew
 = 
pDb
->
pLogWrôî
;

378 
	`as£π
–(
u8
 *)(&
pNew
[1])==(u8 *)(&((&pNew->
buf
)[1])) );

379 
	`mem£t
(
pNew
, 0, ((
u8
 *)&pNew->
buf
) - (u8 *)pNew);

380 
pNew
->
buf
.
n
 = 0;

383 if–
rc
==
LSM_OK
 ){

395 
rc
 = 
	`logRe˛aimS∑˚
(
pDb
);

397 if–
rc
!=
LSM_OK
 ){

398 
	`lsmLogClo£
(
pDb
);

399  
rc
;

405 if–
pDb
->
eSa„ty
==
LSM_SAFETY_FULL
 ){

406 
pNew
->
szSe˘‹
 = 
	`lsmFsSe˘‹Size
(
pDb
->
pFS
);

407 
	`as£π
–
pNew
->
szSe˘‹
>0 );

409 
pNew
->
szSe˘‹
 = 1;

424 
aReg
 = &
pDb
->
åìhdr
.
log
.
aRegi⁄
[0];

426 
	`as£π
–
aReg
[0].
iEnd
==0 ||áReg[0].iEnd>aReg[0].
iSèπ
 );

427 
	`as£π
–
aReg
[1].
iEnd
==0 ||áReg[1].iEnd>aReg[1].
iSèπ
 );

429 
pNew
->
cksum0
 = 
pDb
->
åìhdr
.
log
.cksum0;

430 
pNew
->
cksum1
 = 
pDb
->
åìhdr
.
log
.cksum1;

432 if–
aReg
[0].
iEnd
==0 &&áReg[1].iEnd==0 &&áReg[2].
iSèπ
>=
LSM_MIN_LOGWRAP
 ){

436 
u8
 
aJump
[] = {

437 
LSM_LOG_PAD2
, 0x04, 0x00, 0x00, 0x00, 0x00, 
LSM_LOG_JUMP
, 0x00

440 
	`lsmSåögBöAµíd
(&
pNew
->
buf
, 
aJump
, (aJump));

441 
	`logUpd©eCksum
(
pNew
,ÖNew->
buf
.
n
);

442 
rc
 = 
	`lsmFsWrôeLog
(
pDb
->
pFS
, 
aReg
[2].
iEnd
, &
pNew
->
buf
);

443 
pNew
->
iCksumBuf
 =ÖNew->
buf
.
n
 = 0;

445 
aReg
[2].
iEnd
 += 8;

446 
pNew
->
jump
 = 
aReg
[0] =áReg[2];

447 
aReg
[2].
iSèπ
 =áReg[2].
iEnd
 = 0;

448 }if–
aReg
[1].
iEnd
==0 &&áReg[2].iEnd<aReg[0].iEnd ){

450 
pNew
->
iOff
 = 
aReg
[2].
iEnd
;

451 
pNew
->
jump
 = 
aReg
[0];

454 
	`as£π
–
aReg
[2].
iSèπ
>˜Reg[0].
iEnd
 &&áReg[2].iStart>=aReg[1].iEnd );

455 
pNew
->
iOff
 = 
aReg
[2].
iEnd
;

458 if–
pNew
->
jump
.
iSèπ
 ){

459 
i64
 
iRound
;

460 
	`as£π
–
pNew
->
jump
.
iSèπ
>pNew->
iOff
 );

462 
iRound
 = 
	`fú°ByãOnSe˘‹
(
pNew
,ÖNew->
jump
.
iSèπ
);

463 if–
iRound
>
pNew
->
iOff
 )ÖNew->
jump
.
iSèπ
 = iRound;

464 
pNew
->
jump
.
iEnd
 = 
	`œ°ByãOnSe˘‹
(pNew,ÖNew->jump.iEnd);

467 
pDb
->
pLogWrôî
 = 
pNew
;

468  
rc
;

469 
	}
}

481 
	$lsmLogEnd
(
lsm_db
 *
pDb
, 
bCommô
){

482 
DbLog
 *
pLog
;

483 
LogWrôî
 *
p
;

484 
p
 = 
pDb
->
pLogWrôî
;

486 if–
p
==0 ) ;

487 
pLog
 = &
pDb
->
åìhdr
.
log
;

489 if–
bCommô
 ){

490 
pLog
->
aRegi⁄
[2].
iEnd
 = 
p
->
iOff
;

491 
pLog
->
cksum0
 = 
p
->cksum0;

492 
pLog
->
cksum1
 = 
p
->cksum1;

493 if–
p
->
iRegi⁄1End
 ){

496 
	`as£π
–
pLog
->
aRegi⁄
[1].
iEnd
==0 );

497 
	`as£π
–
pLog
->
aRegi⁄
[2].
iSèπ
<
p
->
iRegi⁄1End
 );

498 
pLog
->
aRegi⁄
[1].
iSèπ
 =ÖLog->aRegion[2].iStart;

499 
pLog
->
aRegi⁄
[1].
iEnd
 = 
p
->
iRegi⁄1End
;

500 
pLog
->
aRegi⁄
[2].
iSèπ
 = 
p
->
iRegi⁄2Sèπ
;

503 
	}
}

505 
	$jumpIfRequúed
(

506 
lsm_db
 *
pDb
,

507 
LogWrôî
 *
pLog
,

508 
nReq
,

509 *
pbJump


517 if–(
pLog
->
jump
.
iSèπ
 > (pLog->
iOff
 +ÖLog->
buf
.
n
))

518 && (
pLog
->
jump
.
iSèπ
 < (pLog->
iOff
 +ÖLog->
buf
.
n
 + (
nReq
 + 17)))

520 
rc
;

521 
i64
 
iJump
;

522 
u8
 
aJump
[10];

523 
nJump
;

524 
nPad
;

527 
iJump
 = 
pLog
->
jump
.
iEnd
+1;

528 
aJump
[0] = 
LSM_LOG_JUMP
;

529 
nJump
 = 1 + 
	`lsmV¨ötPut64
(&
aJump
[1], 
iJump
);

535 
nPad
 = (
pLog
->
buf
.
n
 + 
nJump
) % 8;

536 if–
nPad
 ){

537 
u8
 
aPad
[7] = {0,0,0,0,0,0,0};

538 
nPad
 = 8-nPad;

539 if–
nPad
==1 ){

540 
aPad
[0] = 
LSM_LOG_PAD1
;

542 
aPad
[0] = 
LSM_LOG_PAD2
;

543 
aPad
[1] = (
nPad
-2);

545 
rc
 = 
	`lsmSåögBöAµíd
(&
pLog
->
buf
, 
aPad
, 
nPad
);

546 if–
rc
!=
LSM_OK
 ) Ñc;

553 
rc
 = 
	`lsmSåögBöAµíd
(&
pLog
->
buf
, 
aJump
, 
nJump
);

554 if–
rc
!=
LSM_OK
 ) Ñc;

555 
	`as£π
–(
pLog
->
buf
.
n
 % 8)==0 );

556 
rc
 = 
	`lsmFsWrôeLog
(
pDb
->
pFS
, 
pLog
->
iOff
, &pLog->
buf
);

557 if–
rc
!=
LSM_OK
 ) Ñc;

558 
	`logUpd©eCksum
(
pLog
,ÖLog->
buf
.
n
);

559 
pLog
->
iRegi⁄1End
 = (pLog->
iOff
 +ÖLog->
buf
.
n
);

560 
pLog
->
iRegi⁄2Sèπ
 = 
iJump
;

561 
pLog
->
iOff
 = 
iJump
;

562 
pLog
->
iCksumBuf
 =ÖLog->
buf
.
n
 = 0;

563 if–
pbJump
 ) *pbJump = 1;

566  
LSM_OK
;

567 
	}
}

569 
	$logCksumAndFlush
(
lsm_db
 *
pDb
){

570 
rc
;

571 
LogWrôî
 *
pLog
 = 
pDb
->
pLogWrôî
;

574 
	`logUpd©eCksum
(
pLog
,ÖLog->
buf
.
n
);

575 
	`lsmPutU32
((
u8
 *)&
pLog
->
buf
.
z
[pLog->buf.
n
],ÖLog->
cksum0
);

576 
pLog
->
buf
.
n
 += 4;

577 
	`lsmPutU32
((
u8
 *)&
pLog
->
buf
.
z
[pLog->buf.
n
],ÖLog->
cksum1
);

578 
pLog
->
buf
.
n
 += 4;

581 
rc
 = 
	`lsmFsWrôeLog
(
pDb
->
pFS
, 
pLog
->
iOff
, &pLog->
buf
);

582 
pLog
->
iOff
 +pLog->
buf
.
n
;

583 
pLog
->
iCksumBuf
 =ÖLog->
buf
.
n
 = 0;

585  
rc
;

586 
	}
}

592 
	$logFlush
(
lsm_db
 *
pDb
, 
eTy≥
){

593 
rc
;

594 
nReq
;

595 
LogWrôî
 *
pLog
 = 
pDb
->
pLogWrôî
;

597 
	`as£π
–
eTy≥
==
LSM_LOG_COMMIT
 );

598 
	`as£π
–
pLog
 );

601 
nReq
 = 9;

602 if–
eTy≥
==
LSM_LOG_COMMIT
 && 
pLog
->
szSe˘‹
>1 ) 
nReq
 +=ÖLog->szSector + 17;

603 
rc
 = 
	`jumpIfRequúed
(
pDb
, 
pLog
, 
nReq
, 0);

609 if–
eTy≥
==
LSM_LOG_COMMIT
 && 
pLog
->
szSe˘‹
>1 ){

610 
nPad
;

613 
nPad
 = ((
pLog
->
iOff
 +ÖLog->
buf
.
n
 + 9Ë%ÖLog->
szSe˘‹
);

614 if–
nPad
 )ÇPad = 
pLog
->
szSe˘‹
 -ÇPad;

615 
rc
 = 
	`lsmSåögExãnd
(&
pLog
->
buf
, 
nPad
);

616 if–
rc
!=
LSM_OK
 ) Ñc;

618  
nPad
 ){

619 if–
nPad
==1 ){

620 
pLog
->
buf
.
z
[pLog->buf.
n
++] = 
LSM_LOG_PAD1
;

621 
nPad
 = 0;

623 
n
 = 
	`LSM_MIN
(200, 
nPad
-2);

624 
pLog
->
buf
.
z
[pLog->buf.
n
++] = 
LSM_LOG_PAD2
;

625 
pLog
->
buf
.
z
[pLog->buf.
n
++] =Ç;

626 
nPad
 -= 2;

627 
	`mem£t
(&
pLog
->
buf
.
z
[pLog->buf.
n
], 0x2B,Ç);

628 
pLog
->
buf
.
n
 +=Ç;

629 
nPad
 -
n
;

636 
rc
 = 
	`lsmSåögExãnd
(&
pLog
->
buf
, 9);

637 if–
rc
!=
LSM_OK
 ) Ñc;

638 
pLog
->
buf
.
z
[pLog->buf.
n
++] = 
eTy≥
;

639 
	`mem£t
(&
pLog
->
buf
.
z
[pLog->buf.
n
], 0, 8);

641 
rc
 = 
	`logCksumAndFlush
(
pDb
);

644 if–
rc
==
LSM_OK
 && 
eTy≥
==
LSM_LOG_COMMIT
 && 
pDb
->
eSa„ty
==
LSM_SAFETY_FULL
 ){

645 
rc
 = 
	`lsmFsSyncLog
(
pDb
->
pFS
);

647  
rc
;

648 
	}
}

654 
	$lsmLogWrôe
(

655 
lsm_db
 *
pDb
,

656 *
pKey
, 
nKey
,

657 *
pVÆ
, 
nVÆ


659 
rc
 = 
LSM_OK
;

660 
LogWrôî
 *
pLog
;

661 
nReq
;

662 
bCksum
 = 0;

664 if–
pDb
->
bU£Log
==0 )  
LSM_OK
;

665 
pLog
 = 
pDb
->
pLogWrôî
;

669 
nReq
 = 1 + 
	`lsmV¨ötLí32
(
nKey
) + 8 +ÇKey;

670 if–
nVÆ
>=0 ) 
nReq
 +
	`lsmV¨ötLí32
(nVal) +ÇVal;

677 
rc
 = 
	`jumpIfRequúed
(
pDb
, 
pLog
, 
nReq
, &
bCksum
);

678 if–(
pLog
->
buf
.
n
+
nReq
Ë> 
LSM_CKSUM_MAXDATA
 ) 
bCksum
 = 1;

680 if–
rc
==
LSM_OK
 ){

681 
rc
 = 
	`lsmSåögExãnd
(&
pLog
->
buf
, 
nReq
);

683 if–
rc
==
LSM_OK
 ){

684 
u8
 *
a
 = (u8 *)&
pLog
->
buf
.
z
[pLog->buf.
n
];

688 
	`as£π
–
LSM_LOG_WRITE_CKSUM
 =(
LSM_LOG_WRITE
 | 0x0001) );

689 
	`as£π
–
LSM_LOG_DELETE_CKSUM
 =(
LSM_LOG_DELETE
 | 0x0001) );

690 *(
a
++Ë(
nVÆ
>=0 ? 
LSM_LOG_WRITE
 : 
LSM_LOG_DELETE
Ë| (
u8
)
bCksum
;

691 
a
 +
	`lsmV¨ötPut32
◊, 
nKey
);

692 if–
nVÆ
>=0 ) 
a
 +
	`lsmV¨ötPut32
(a,ÇVal);

694 if–
bCksum
 ){

695 
pLog
->
buf
.
n
 = (
a
 - (
u8
 *ÌLog->buf.
z
);

696 
rc
 = 
	`logCksumAndFlush
(
pDb
);

697 
a
 = (
u8
 *)&
pLog
->
buf
.
z
[pLog->buf.
n
];

700 
	`mem˝y
(
a
, 
pKey
, 
nKey
);

701 
a
 +
nKey
;

702 if–
nVÆ
>=0 ){

703 
	`mem˝y
(
a
, 
pVÆ
, 
nVÆ
);

704 
a
 +
nVÆ
;

706 
pLog
->
buf
.
n
 = 
a
 - (
u8
 *ÌLog->buf.
z
;

707 
	`as£π
–
pLog
->
buf
.
n
<ıLog->buf.
nAŒoc
 );

710  
rc
;

711 
	}
}

716 
	$lsmLogCommô
(
lsm_db
 *
pDb
){

717 if–
pDb
->
bU£Log
==0 )  
LSM_OK
;

718  
	`logFlush
(
pDb
, 
LSM_LOG_COMMIT
);

719 
	}
}

727 
	$lsmLogTñl
(

728 
lsm_db
 *
pDb
,

729 
LogM¨k
 *
pM¨k


731 
LogWrôî
 *
pLog
;

732 
nCksum
;

734 if–
pDb
->
bU£Log
==0 ) ;

735 
pLog
 = 
pDb
->
pLogWrôî
;

736 
nCksum
 = 
pLog
->
buf
.
n
 & 0xFFFFFFF8;

737 
	`logUpd©eCksum
(
pLog
, 
nCksum
);

738 
	`as£π
–
pLog
->
iCksumBuf
==
nCksum
 );

739 
pM¨k
->
nBuf
 = 
pLog
->
buf
.
n
 - 
nCksum
;

740 
	`mem˝y
(
pM¨k
->
aBuf
, &
pLog
->
buf
.
z
[
nCksum
],ÖM¨k->
nBuf
);

742 
pM¨k
->
iOff
 = 
pLog
->iOf‡+ÖLog->
buf
.
n
;

743 
pM¨k
->
cksum0
 = 
pLog
->cksum0;

744 
pM¨k
->
cksum1
 = 
pLog
->cksum1;

745 
	}
}

751 
	$lsmLogSìk
(

752 
lsm_db
 *
pDb
,

753 
LogM¨k
 *
pM¨k


755 
LogWrôî
 *
pLog
;

757 if–
pDb
->
bU£Log
==0 ) ;

758 
pLog
 = 
pDb
->
pLogWrôî
;

760 
	`as£π
–
pM¨k
->
iOff
<=
pLog
->iOff+pLog->
buf
.
n
 );

761 if–(
pM¨k
->
iOff
 & 0xFFFFFFF8)>=
pLog
->iOff ){

762 
pLog
->
buf
.
n
 = 
pM¨k
->
iOff
 -ÖLog->iOff;

763 
pLog
->
iCksumBuf
 = (pLog->
buf
.
n
 & 0xFFFFFFF8);

765 
pLog
->
buf
.
n
 = 
pM¨k
->
nBuf
;

766 
	`mem˝y
(
pLog
->
buf
.
z
, 
pM¨k
->
aBuf
,ÖM¨k->
nBuf
);

767 
pLog
->
iCksumBuf
 = 0;

768 
pLog
->
iOff
 = 
pM¨k
->iOf‡-ÖM¨k->
nBuf
;

770 
pLog
->
cksum0
 = 
pM¨k
->cksum0;

771 
pLog
->
cksum1
 = 
pM¨k
->cksum1;

773 if–
pM¨k
->
iOff
 > 
pLog
->
iRegi⁄1End
 )ÖLog->iRegion1End = 0;

774 if–
pM¨k
->
iOff
 > 
pLog
->
iRegi⁄2Sèπ
 )ÖLog->iRegion2Start = 0;

775 
	}
}

780 
	$lsmInfoLogSåu˘uª
(
lsm_db
 *
pDb
, **
pzVÆ
){

781 
rc
 = 
LSM_OK
;

782 *
zVÆ
 = 0;

790 if–
pDb
->
pC§
==0 &&ÖDb->
nTønsO≥n
==0 ){

791 
rc
 = 
	`lsmTªeLﬂdHódî
(
pDb
, 0);

792 if–
rc
==
LSM_OK
 )Ñ¯
	`logRe˛aimS∑˚
(
pDb
);

795 if–
rc
==
LSM_OK
 ){

796 
DbLog
 *
pLog
 = &
pDb
->
åìhdr
.
log
;

797 
zVÆ
 = 
	`lsmMÆlocPrötf
(
pDb
->
pEnv
,

799 ()
pLog
->
aRegi⁄
[0].
iSèπ
, (ÌLog->aRegi⁄[0].
iEnd
,

800 ()
pLog
->
aRegi⁄
[1].
iSèπ
, (ÌLog->aRegi⁄[1].
iEnd
,

801 ()
pLog
->
aRegi⁄
[2].
iSèπ
, (ÌLog->aRegi⁄[2].
iEnd


803 if–!
zVÆ
 ) 
rc
 = 
LSM_NOMEM_BKPT
;

806 *
pzVÆ
 = 
zVÆ
;

807  
rc
;

808 
	}
}

814 
LogRódî
 
	tLogRódî
;

815 
	sLogRódî
 {

816 
FûeSy°em
 *
	mpFS
;

817 
i64
 
	miOff
;

818 
	miBuf
;

819 
LsmSåög
 
	mbuf
;

821 
	miCksumBuf
;

822 
u32
 
	mcksum0
;

823 
u32
 
	mcksum1
;

826 
	$logRódîBlob
(

827 
LogRódî
 *
p
,

828 
LsmSåög
 *
pBuf
,

829 
nBlob
,

830 
u8
 **
µBlob
,

831 *
pRc


833 c⁄° 
LOG_READ_SIZE
 = 512;

834 
rc
 = *
pRc
;

835 
nReq
 = 
nBlob
;

837  
rc
==
LSM_OK
 && 
nReq
>0 ){

838 
nAvaû
;

839 if–
p
->
buf
.
n
=ı->
iBuf
 ){

840 
nCksum
;

841 
nC¨ry
 = 0;

843 
nCksum
 = 
p
->
iBuf
 -Ö->
iCksumBuf
;

844 if–
nCksum
>0 ){

845 
nC¨ry
 = 
nCksum
 % 8;

846 
nCksum
 = ((nCksum / 8) * 8);

847 if–
nCksum
>0 ){

848 
	`logCksumU«lig√d
(

849 &
p
->
buf
.
z
[p->
iCksumBuf
], 
nCksum
, &p->
cksum0
, &p->
cksum1


853 if–
nC¨ry
>0 ) 
	`mem˝y
(
p
->
buf
.
z
, &p->buf.z[p->
iBuf
-nCarry],ÇCarry);

854 
p
->
buf
.
n
 = 
nC¨ry
;

855 
p
->
iBuf
 = 
nC¨ry
;

857 
rc
 = 
	`lsmFsRódLog
(
p
->
pFS
,Ö->
iOff
, 
LOG_READ_SIZE
, &p->
buf
);

858 if–
rc
!=
LSM_OK
 ) ;

859 
p
->
iCksumBuf
 = 0;

860 
p
->
iOff
 +
LOG_READ_SIZE
;

863 
nAvaû
 = 
p
->
buf
.
n
 -Ö->
iBuf
;

864 if–
µBlob
 && 
nReq
==
nBlob
 &&ÇBlob<=
nAvaû
 ){

865 *
µBlob
 = (
u8
 *)&
p
->
buf
.
z
[p->
iBuf
];

866 
p
->
iBuf
 +
nBlob
;

867 
nReq
 = 0;

869 
nC›y
 = 
	`LSM_MIN
(
nAvaû
, 
nReq
);

870 if–
nBlob
==
nReq
 ){

871 if–
µBlob
 ) *µBlob = (
u8
 *)
pBuf
->
z
;

872 
pBuf
->
n
 = 0;

874 
rc
 = 
	`lsmSåögBöAµíd
(
pBuf
, (
u8
 *)&
p
->
buf
.
z
[p->
iBuf
], 
nC›y
);

875 
nReq
 -
nC›y
;

876 
p
->
iBuf
 +
nC›y
;

880 *
pRc
 = 
rc
;

881 
	}
}

883 
	$logRódîV¨öt
(

884 
LogRódî
 *
p
,

885 
LsmSåög
 *
pBuf
,

886 *
piVÆ
,

887 *
pRc


889 if–*
pRc
==
LSM_OK
 ){

890 
u8
 *
aV¨öt
;

891 if–
p
->
buf
.
n
=ı->
iBuf
 ){

892 
	`logRódîBlob
(
p
, 0, 10, &
aV¨öt
, 
pRc
);

893 if–
LSM_OK
==*
pRc
 ) 
p
->
iBuf
 -(10 - 
	`lsmV¨ötGë32
(
aV¨öt
, 
piVÆ
));

895 
	`logRódîBlob
(
p
, 
pBuf
, 
	`lsmV¨ötSize
’->
buf
.
z
[p->
iBuf
]), &
aV¨öt
, 
pRc
);

896 if–
LSM_OK
==*
pRc
 ) 
	`lsmV¨ötGë32
(
aV¨öt
, 
piVÆ
);

899 
	}
}

901 
	$logRódîByã
(
LogRódî
 *
p
, 
u8
 *
pByã
, *
pRc
){

902 
u8
 *
pPå
 = 0;

903 
	`logRódîBlob
(
p
, 0, 1, &
pPå
, 
pRc
);

904 if–
pPå
 ) *
pByã
 = *pPtr;

905 
	}
}

907 
	$logRódîCksum
(
LogRódî
 *
p
, 
LsmSåög
 *
pBuf
, *
pbEof
, *
pRc
){

908 if–*
pRc
==
LSM_OK
 ){

909 
u8
 *
pPå
 = 0;

910 
u32
 
cksum0
, 
cksum1
;

911 
nCksum
 = 
p
->
iBuf
 -Ö->
iCksumBuf
;

914 
	`as£π
–
nCksum
>=0 );

915 
	`logCksumU«lig√d
(&
p
->
buf
.
z
[p->
iCksumBuf
], 
nCksum
, &p->
cksum0
, &p->
cksum1
);

916 
p
->
iCksumBuf
 =Ö->
iBuf
 + 8;

917 
	`logRódîBlob
(
p
, 
pBuf
, 8, &
pPå
, 
pRc
);

920 if–
pPå
 ){

921 
cksum0
 = 
	`lsmGëU32
(
pPå
);

922 
cksum1
 = 
	`lsmGëU32
(&
pPå
[4]);

923 *
pbEof
 = (
cksum0
!=
p
->cksum0 || 
cksum1
!=p->cksum1);

924 
p
->
iCksumBuf
 =Ö->
iBuf
;

927 
	}
}

929 
	$logRódîInô
(

930 
lsm_db
 *
pDb
,

931 
DbLog
 *
pLog
,

932 
bInôBuf
,

933 
LogRódî
 *
p


935 
p
->
pFS
 = 
pDb
->pFS;

936 
p
->
iOff
 = 
pLog
->
aRegi⁄
[2].
iSèπ
;

937 
p
->
cksum0
 = 
pLog
->cksum0;

938 
p
->
cksum1
 = 
pLog
->cksum1;

939 if–
bInôBuf
 ){ 
	`lsmSåögInô
(&
p
->
buf
, 
pDb
->
pEnv
); }

940 
p
->
buf
.
n
 = 0;

941 
p
->
iCksumBuf
 = 0;

942 
p
->
iBuf
 = 0;

943 
	}
}

951 
	$logRequúeCksum
(
LogRódî
 *
p
, 
nByã
){

952  ((
p
->
iBuf
 + 
nByã
 -Ö->
iCksumBuf
Ë> 
LSM_CKSUM_MAXDATA
);

953 
	}
}

958 
	$lsmLogRecovî
(
lsm_db
 *
pDb
){

959 
LsmSåög
 
buf1
;

960 
LsmSåög
 
buf2
;

961 
LogRódî
 
ªadî
;

962 
rc
 = 
LSM_OK
;

963 
nCommô
 = 0;

964 
iPass
;

965 
nJump
 = 0;

966 
DbLog
 *
pLog
;

967 
bO≥n
;

969 
rc
 = 
	`lsmFsO≥nLog
(
pDb
, &
bO≥n
);

970 if–
rc
!=
LSM_OK
 ) Ñc;

972 
rc
 = 
	`lsmTªeInô
(
pDb
);

973 if–
rc
!=
LSM_OK
 ) Ñc;

975 
pLog
 = &
pDb
->
åìhdr
.
log
;

976 
	`lsmCheckpoötLogoff£t
(
pDb
->
pShmhdr
->
aS«p2
, 
pLog
);

978 
	`logRódîInô
(
pDb
, 
pLog
, 1, &
ªadî
);

979 
	`lsmSåögInô
(&
buf1
, 
pDb
->
pEnv
);

980 
	`lsmSåögInô
(&
buf2
, 
pDb
->
pEnv
);

986 if–
bO≥n
 ){

987 
iPass
=0; iPass<2 && 
rc
==
LSM_OK
; iPass++){

988 
bEof
 = 0;

990  
rc
==
LSM_OK
 && !
bEof
 ){

991 
u8
 
eTy≥
 = 0;

992 
	`logRódîByã
(&
ªadî
, &
eTy≥
, &
rc
);

994  
eTy≥
 ){

995 
LSM_LOG_PAD1
:

998 
LSM_LOG_PAD2
: {

999 
nPad
;

1000 
	`logRódîV¨öt
(&
ªadî
, &
buf1
, &
nPad
, &
rc
);

1001 
	`logRódîBlob
(&
ªadî
, &
buf1
, 
nPad
, 0, &
rc
);

1005 
LSM_LOG_WRITE
:

1006 
LSM_LOG_WRITE_CKSUM
: {

1007 
nKey
;

1008 
nVÆ
;

1009 
u8
 *
aVÆ
;

1010 
	`logRódîV¨öt
(&
ªadî
, &
buf1
, &
nKey
, &
rc
);

1011 
	`logRódîV¨öt
(&
ªadî
, &
buf2
, &
nVÆ
, &
rc
);

1013 if–
eTy≥
==
LSM_LOG_WRITE_CKSUM
 ){

1014 
	`logRódîCksum
(&
ªadî
, &
buf1
, &
bEof
, &
rc
);

1016 
bEof
 = 
	`logRequúeCksum
(&
ªadî
, 
nKey
+
nVÆ
);

1018 if–
bEof
 ) ;

1020 
	`logRódîBlob
(&
ªadî
, &
buf1
, 
nKey
, 0, &
rc
);

1021 
	`logRódîBlob
(&
ªadî
, &
buf2
, 
nVÆ
, &
aVÆ
, &
rc
);

1022 if–
iPass
==1 && 
rc
==
LSM_OK
 ){

1023 
rc
 = 
	`lsmTªeIn£π
(
pDb
, (
u8
 *)
buf1
.
z
, 
nKey
, 
aVÆ
, 
nVÆ
);

1028 
LSM_LOG_DELETE
:

1029 
LSM_LOG_DELETE_CKSUM
: {

1030 
nKey
; 
u8
 *
aKey
;

1031 
	`logRódîV¨öt
(&
ªadî
, &
buf1
, &
nKey
, &
rc
);

1033 if–
eTy≥
==
LSM_LOG_DELETE_CKSUM
 ){

1034 
	`logRódîCksum
(&
ªadî
, &
buf1
, &
bEof
, &
rc
);

1036 
bEof
 = 
	`logRequúeCksum
(&
ªadî
, 
nKey
);

1038 if–
bEof
 ) ;

1040 
	`logRódîBlob
(&
ªadî
, &
buf1
, 
nKey
, &
aKey
, &
rc
);

1041 if–
iPass
==1 && 
rc
==
LSM_OK
 ){

1042 
rc
 = 
	`lsmTªeIn£π
(
pDb
, 
aKey
, 
nKey
, 
NULL
, -1);

1047 
LSM_LOG_COMMIT
:

1048 
	`logRódîCksum
(&
ªadî
, &
buf1
, &
bEof
, &
rc
);

1049 if–
bEof
==0 ){

1050 
nCommô
++;

1051 
	`as£π
–
nCommô
>0 || 
iPass
==1 );

1052 if–
nCommô
==0 ) 
bEof
 = 1;

1056 
LSM_LOG_JUMP
: {

1057 
iOff
 = 0;

1058 
	`logRódîV¨öt
(&
ªadî
, &
buf1
, &
iOff
, &
rc
);

1059 if–
rc
==
LSM_OK
 ){

1060 if–
iPass
==1 ){

1061 if–
pLog
->
aRegi⁄
[2].
iSèπ
==0 ){

1062 
	`as£π
–
pLog
->
aRegi⁄
[1].
iSèπ
==0 );

1063 
pLog
->
aRegi⁄
[1].
iEnd
 = 
ªadî
.
iOff
;

1065 
	`as£π
–
pLog
->
aRegi⁄
[0].
iSèπ
==0 );

1066 
pLog
->
aRegi⁄
[0].
iSèπ
 =ÖLog->aRegion[2].iStart;

1067 
pLog
->
aRegi⁄
[0].
iEnd
 = 
ªadî
.
iOff
-ªadî.
buf
.
n
+ªadî.
iBuf
;

1069 
pLog
->
aRegi⁄
[2].
iSèπ
 = 
iOff
;

1071 if–(
nJump
++)==2 ){

1072 
bEof
 = 1;

1076 
ªadî
.
iOff
 = iOff;

1077 
ªadî
.
buf
.
n
 =Ñódî.
iBuf
;

1084 
bEof
 = 1;

1089 if–
rc
==
LSM_OK
 && 
iPass
==0 ){

1090 if–
nCommô
==0 ){

1091 if–
pLog
->
aRegi⁄
[2].
iSèπ
==0 ){

1092 
iPass
 = 1;

1094 
pLog
->
aRegi⁄
[2].
iSèπ
 = 0;

1095 
iPass
 = -1;

1096 
	`lsmCheckpoötZîoLogoff£t
(
pDb
);

1099 
	`logRódîInô
(
pDb
, 
pLog
, 0, &
ªadî
);

1100 
nCommô
 =ÇCommit * -1;

1106 if–
rc
==
LSM_OK
 ){

1107 
pLog
->
aRegi⁄
[2].
iEnd
 = 
ªadî
.
iOff
 -Ñódî.
buf
.
n
 +Ñódî.
iBuf
;

1108 
pLog
->
cksum0
 = 
ªadî
.cksum0;

1109 
pLog
->
cksum1
 = 
ªadî
.cksum1;

1112 if–
rc
==
LSM_OK
 ){

1113 
rc
 = 
	`lsmFöishRecovîy
(
pDb
);

1115 
	`lsmFöishRecovîy
(
pDb
);

1118 if–
pDb
->
bRoTøns
 ){

1119 
	`lsmFsClo£Log
(
pDb
);

1122 
	`lsmSåögCÀ¨
(&
buf1
);

1123 
	`lsmSåögCÀ¨
(&
buf2
);

1124 
	`lsmSåögCÀ¨
(&
ªadî
.
buf
);

1125  
rc
;

1126 
	}
}

1128 
	$lsmLogClo£
(
lsm_db
 *
db
){

1129 if–
db
->
pLogWrôî
 ){

1130 
	`lsmFªe
(
db
->
pEnv
, db->
pLogWrôî
->
buf
.
z
);

1131 
	`lsmFªe
(
db
->
pEnv
, db->
pLogWrôî
);

1132 
db
->
pLogWrôî
 = 0;

1134 
	}
}

	@src/lsm_main.c

15 
	~"lsmI¡.h
"

18 #ifde‡
LSM_DEBUG


27 
	$lsmEº‹Bk±
(
rc
){

29  
rc
;

30 
	}
}

36 
	$as£π_db_°©e
(
lsm_db
 *
pDb
){

43 
	`as£π
–(
pDb
->
pC§
!=0||pDb->
nTønsO≥n
>0)==’Db->
iRódî
>=0||pDb->
bRoTøns
) );

45 
	`as£π
–(
pDb
->
iRódî
<0 &&ÖDb->
bRoTøns
==0Ë||ÖDb->
pClõ¡
!=0 );

47 
	`as£π
–
pDb
->
nTønsO≥n
>=0 );

48 
	}
}

50 
	#as£π_db_°©e
(
x
)

	)

56 
	$xCmp
(*
p1
, 
n1
, *
p2
, 
n2
){

57 
ªs
;

58 
ªs
 = 
	`memcmp
(
p1
, 
p2
, 
	`LSM_MIN
(
n1
, 
n2
));

59 if–
ªs
==0 )Ñe†(
n1
-
n2
);

60  
ªs
;

61 
	}
}

63 
	$xLog
(*
pCtx
, 
rc
, c⁄° *
z
){

64 ()(
rc
);

65 ()(
pCtx
);

66 
	`Ârötf
(
°dîr
, "%s\n", 
z
);

67 
	`fÊush
(
°dîr
);

68 
	}
}

73 
	$lsm_√w
(
lsm_ív
 *
pEnv
, 
lsm_db
 **
µDb
){

74 
lsm_db
 *
pDb
;

77 if–
pEnv
==0 )ÖEnv = 
	`lsm_deÁu…_ív
();

78 
	`as£π
–
pEnv
 );

81 *
µDb
 = 
pDb
 = (
lsm_db
 *)
	`lsmMÆlocZîo
(
pEnv
, (lsm_db));

82 if–
pDb
==0 )  
LSM_NOMEM_BKPT
;

85 
pDb
->
pEnv
 =ÖEnv;

86 
pDb
->
nTªeLimô
 = 
LSM_DFLT_AUTOFLUSH
;

87 
pDb
->
nAutock±
 = 
LSM_DFLT_AUTOCHECKPOINT
;

88 
pDb
->
bAutow‹k
 = 
LSM_DFLT_AUTOWORK
;

89 
pDb
->
eSa„ty
 = 
LSM_DFLT_SAFETY
;

90 
pDb
->
xCmp
 = xCmp;

91 
pDb
->
nDÊtPgsz
 = 
LSM_DFLT_PAGE_SIZE
;

92 
pDb
->
nDÊtBlksz
 = 
LSM_DFLT_BLOCK_SIZE
;

93 
pDb
->
nMîge
 = 
LSM_DFLT_AUTOMERGE
;

94 
pDb
->
nMaxFªñi°
 = 
LSM_MAX_FREELIST_ENTRIES
;

95 
pDb
->
bU£Log
 = 
LSM_DFLT_USE_LOG
;

96 
pDb
->
iRódî
 = -1;

97 
pDb
->
iRw˛õ¡
 = -1;

98 
pDb
->
bMu…iProc
 = 
LSM_DFLT_MULTIPLE_PROCESSES
;

99 
pDb
->
iMm≠
 = 
LSM_DFLT_MMAP
;

100 
pDb
->
xLog
 = xLog;

101 
pDb
->
com¥ess
.
iId
 = 
LSM_COMPRESSION_NONE
;

102  
LSM_OK
;

103 
	}
}

105 
lsm_ív
 *
	$lsm_gë_ív
(
lsm_db
 *
pDb
){

106 
	`as£π
–
pDb
->
pEnv
 );

107  
pDb
->
pEnv
;

108 
	}
}

114 
	$dbRñó£Clõ¡S«pshŸ
(
lsm_db
 *
pDb
){

115 if–
pDb
->
nTønsO≥n
==0 &&ÖDb->
pC§
==0 ){

116 
	`lsmFöishRódTøns
(
pDb
);

118 
	}
}

120 
	$gëFuŒ∑th«me
(

121 
lsm_ív
 *
pEnv
,

122 c⁄° *
zRñ
,

123 **
pzAbs


125 
nAŒoc
 = 0;

126 *
zAŒoc
 = 0;

127 
nReq
 = 0;

128 
rc
;

131 
nAŒoc
 = 
nReq
;

132 
rc
 = 
pEnv
->
	`xFuŒ∑th
’Env, 
zRñ
, 
zAŒoc
, &
nReq
);

133 if–
nReq
>
nAŒoc
 ){

134 
zAŒoc
 = 
	`lsmRóŒocOrFªeRc
(
pEnv
, zAŒoc, 
nReq
, &
rc
);

136 } 
nReq
>
nAŒoc
 && 
rc
==
LSM_OK
 );

138 if–
rc
!=
LSM_OK
 ){

139 
	`lsmFªe
(
pEnv
, 
zAŒoc
);

140 
zAŒoc
 = 0;

142 *
pzAbs
 = 
zAŒoc
;

143  
rc
;

144 
	}
}

150 
	$as£πRw˛õ¡LockVÆue
(
lsm_db
 *
db
){

151 #i‚de‡
NDEBUG


152 
u64
 
msk
;

153 
u64
 
rw˛õ¡
 = 0;

155 if–
db
->
iRw˛õ¡
>=0 ){

156 
rw˛õ¡
 = ((
u64
)1 << (
	`LSM_LOCK_RWCLIENT
(
db
->
iRw˛õ¡
)-1));

158 
msk
 = ((
u64
)1 << (
	`LSM_LOCK_RWCLIENT
(
LSM_LOCK_NRWCLIENT
)-1)) - 1;

159 
msk
 -(((
u64
)1 << (
	`LSM_LOCK_RWCLIENT
(0)-1)) - 1);

161 
	`as£π
–(
db
->
mLock
 & 
msk
)==
rw˛õ¡
 );

163 
	}
}

168 
	$lsm_›í
(
lsm_db
 *
pDb
, c⁄° *
zFûíame
){

169 
rc
;

171 if–
pDb
->
pD©aba£
 ){

172 
rc
 = 
LSM_MISUSE
;

174 *
zFuŒ
;

183 
rc
 = 
	`gëFuŒ∑th«me
(
pDb
->
pEnv
, 
zFûíame
, &
zFuŒ
);

184 
	`as£π
–
rc
==
LSM_OK
 || 
zFuŒ
==0 );

187 if–
rc
==
LSM_OK
 ){

188 
rc
 = 
	`lsmDbD©aba£C⁄√˘
(
pDb
, 
zFuŒ
);

191 if–
pDb
->
bRód⁄ly
==0 ){

197 if–
rc
==
LSM_OK
 && LSM_OK==‘¯
	`lsmCheckpoötLﬂd
(
pDb
, 0)) ){

198 
	`lsmFsSëPageSize
(
pDb
->
pFS
, 
	`lsmCheckpoötPgsz
’Db->
aS«pshŸ
));

199 
	`lsmFsSëBlockSize
(
pDb
->
pFS
, 
	`lsmCheckpoötBlksz
’Db->
aS«pshŸ
));

203 
	`lsmFªe
(
pDb
->
pEnv
, 
zFuŒ
);

204 
	`as£πRw˛õ¡LockVÆue
(
pDb
);

207 
	`as£π
–
pDb
->
bRód⁄ly
==0 ||ÖDb->bReadonly==1 );

208 
	`as£π
–
rc
!=
LSM_OK
 || (
pDb
->
pShmhdr
==0)==’Db->
bRód⁄ly
==1) );

210  
rc
;

211 
	}
}

213 
	$lsm_˛o£
(
lsm_db
 *
pDb
){

214 
rc
 = 
LSM_OK
;

215 if–
pDb
 ){

216 
	`as£π_db_°©e
(
pDb
);

217 if–
pDb
->
pC§
 ||ÖDb->
nTønsO≥n
 ){

218 
rc
 = 
LSM_MISUSE_BKPT
;

220 
	`lsmMCurs‹FªeCache
(
pDb
);

221 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
,ÖDb->
pClõ¡
);

222 
pDb
->
pClõ¡
 = 0;

224 
	`as£πRw˛õ¡LockVÆue
(
pDb
);

226 
	`lsmDbD©aba£Rñó£
(
pDb
);

227 
	`lsmLogClo£
(
pDb
);

228 
	`lsmFsClo£
(
pDb
->
pFS
);

229 
	`as£π
–
pDb
->
mLock
==0 );

233 if–
pDb
->
Á˘‹y
.
xFªe
 )ÖDb->Á˘‹y.
	`xFªe
’Db->Á˘‹y.
pCtx
);

234 if–
pDb
->
com¥ess
.
xFªe
 )ÖDb->com¥ess.
	`xFªe
’Db->com¥ess.
pCtx
);

236 
	`lsmFªe
(
pDb
->
pEnv
,ÖDb->
rﬁlback
.
aAºay
);

237 
	`lsmFªe
(
pDb
->
pEnv
,ÖDb->
aTøns
);

238 
	`lsmFªe
(
pDb
->
pEnv
,ÖDb->
≠Shm
);

239 
	`lsmFªe
(
pDb
->
pEnv
,ÖDb);

242  
rc
;

243 
	}
}

245 
	$lsm_c⁄fig
(
lsm_db
 *
pDb
, 
eP¨am
, ...){

246 
rc
 = 
LSM_OK
;

247 
va_li°
 
≠
;

248 
	`va_°¨t
(
≠
, 
eP¨am
);

250  
eP¨am
 ){

251 
LSM_CONFIG_AUTOFLUSH
: {

254 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

255 
iVÆ
 = *
piVÆ
;

256 if–
iVÆ
>=0 && iVal<=(1024*1024) ){

257 
pDb
->
nTªeLimô
 = 
iVÆ
*1024;

259 *
piVÆ
 = (
pDb
->
nTªeLimô
 / 1024);

263 
LSM_CONFIG_AUTOWORK
: {

264 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

265 if–*
piVÆ
>=0 ){

266 
pDb
->
bAutow‹k
 = *
piVÆ
;

268 *
piVÆ
 = 
pDb
->
bAutow‹k
;

272 
LSM_CONFIG_AUTOCHECKPOINT
: {

275 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

276 if–*
piVÆ
>=0 ){

277 
iVÆ
 = *
piVÆ
;

278 
pDb
->
nAutock±
 = (
i64
)
iVÆ
 * 1024;

280 *
piVÆ
 = ()(
pDb
->
nAutock±
 / 1024);

284 
LSM_CONFIG_PAGE_SIZE
: {

285 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

286 if–
pDb
->
pD©aba£
 ){

290 *
piVÆ
 = 
	`lsmFsPageSize
(
pDb
->
pFS
);

292 if–*
piVÆ
>=256 && *piVal<=65536 && ((*piVal-1) & *piVal)==0 ){

293 
pDb
->
nDÊtPgsz
 = *
piVÆ
;

295 *
piVÆ
 = 
pDb
->
nDÊtPgsz
;

301 
LSM_CONFIG_BLOCK_SIZE
: {

304 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

305 if–
pDb
->
pD©aba£
 ){

309 *
piVÆ
 = 
	`lsmFsBlockSize
(
pDb
->
pFS
) / 1024;

311 
iVÆ
 = *
piVÆ
;

312 if–
iVÆ
>=64 && iVal<=65536 && ((iVal-1) & iVal)==0 ){

313 
pDb
->
nDÊtBlksz
 = 
iVÆ
 * 1024;

315 *
piVÆ
 = 
pDb
->
nDÊtBlksz
 / 1024;

321 
LSM_CONFIG_SAFETY
: {

322 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

323 if–*
piVÆ
>=0 && *piVal<=2 ){

324 
pDb
->
eSa„ty
 = *
piVÆ
;

326 *
piVÆ
 = 
pDb
->
eSa„ty
;

330 
LSM_CONFIG_MMAP
: {

331 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

332 if–
pDb
->
iRódî
<0 && *
piVÆ
>=0 ){

333 
pDb
->
iMm≠
 = *
piVÆ
;

334 
rc
 = 
	`lsmFsC⁄figuª
(
pDb
);

336 *
piVÆ
 = 
pDb
->
iMm≠
;

340 
LSM_CONFIG_USE_LOG
: {

341 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

342 if–
pDb
->
nTønsO≥n
==0 && (*
piVÆ
==0 || *piVal==1) ){

343 
pDb
->
bU£Log
 = *
piVÆ
;

345 *
piVÆ
 = 
pDb
->
bU£Log
;

349 
LSM_CONFIG_AUTOMERGE
: {

350 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

351 if–*
piVÆ
>1 ) 
pDb
->
nMîge
 = *piVal;

352 *
piVÆ
 = 
pDb
->
nMîge
;

356 
LSM_CONFIG_MAX_FREELIST
: {

357 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

358 if–*
piVÆ
>=2 && *piVÆ<=
LSM_MAX_FREELIST_ENTRIES
 ){

359 
pDb
->
nMaxFªñi°
 = *
piVÆ
;

361 *
piVÆ
 = 
pDb
->
nMaxFªñi°
;

365 
LSM_CONFIG_MULTIPLE_PROCESSES
: {

366 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

367 if–
pDb
->
pD©aba£
 ){

371 *
piVÆ
 = 
	`lsmDbMu…iProc
(
pDb
);

373 
pDb
->
bMu…iProc
 = *
piVÆ
 = (*piVal!=0);

378 
LSM_CONFIG_READONLY
: {

379 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

381 if–
pDb
->
pD©aba£
==0 && *
piVÆ
>=0 ){

382 
pDb
->
bRód⁄ly
 = *
piVÆ
 = (*piVal!=0);

384 *
piVÆ
 = 
pDb
->
bRód⁄ly
;

388 
LSM_CONFIG_SET_COMPRESSION
: {

389 
lsm_com¥ess
 *
p
 = 
	`va_¨g
(
≠
,Üsm_compress *);

390 if–
pDb
->
iRódî
>=0 &&ÖDb->
bInFa˘‹y
==0 ){

392 
rc
 = 
LSM_MISUSE_BKPT
;

394 if–
pDb
->
com¥ess
.
xFªe
 ){

396 
pDb
->
com¥ess
.
	`xFªe
’Db->com¥ess.
pCtx
);

398 if–
p
->
xBound
==0 ){

399 
	`mem£t
(&
pDb
->
com¥ess
, 0, (
lsm_com¥ess
));

400 
pDb
->
com¥ess
.
iId
 = 
LSM_COMPRESSION_NONE
;

402 
	`mem˝y
(&
pDb
->
com¥ess
, 
p
, (
lsm_com¥ess
));

404 
rc
 = 
	`lsmFsC⁄figuª
(
pDb
);

409 
LSM_CONFIG_SET_COMPRESSION_FACTORY
: {

410 
lsm_com¥ess_Á˘‹y
 *
p
 = 
	`va_¨g
(
≠
,Üsm_compress_factory *);

411 if–
pDb
->
Á˘‹y
.
xFªe
 ){

413 
pDb
->
Á˘‹y
.
	`xFªe
’Db->Á˘‹y.
pCtx
);

415 
	`mem˝y
(&
pDb
->
Á˘‹y
, 
p
, (
lsm_com¥ess_Á˘‹y
));

419 
LSM_CONFIG_GET_COMPRESSION
: {

420 
lsm_com¥ess
 *
p
 = 
	`va_¨g
(
≠
,Üsm_compress *);

421 
	`mem˝y
(
p
, &
pDb
->
com¥ess
, (
lsm_com¥ess
));

426 
rc
 = 
LSM_MISUSE
;

430 
	`va_íd
(
≠
);

431  
rc
;

432 
	}
}

434 
	$lsmAµídSegmítLi°
(
LsmSåög
 *
pSå
, *
zPª
, 
Segmít
 *
pSeg
){

435 
	`lsmSåögAµídf
(
pSå
, "%s{%d %d %d %d}", 
zPª
,

436 
pSeg
->
iFú°
,ÖSeg->
iLa°Pg
,ÖSeg->
iRoŸ
,ÖSeg->
nSize


438 
	}
}

440 
	$öfoGëW‹kî
(
lsm_db
 *
pDb
, 
S«pshŸ
 **
µ
, *
pbU∆ock
){

441 
rc
 = 
LSM_OK
;

443 
	`as£π
–*
pbU∆ock
==0 );

444 if–!
pDb
->
pW‹kî
 ){

445 
rc
 = 
	`lsmBegöW‹k
(
pDb
);

446 if–
rc
!=
LSM_OK
 ) Ñc;

447 *
pbU∆ock
 = 1;

449 if–
µ
 ) *µ = 
pDb
->
pW‹kî
;

450  
rc
;

451 
	}
}

453 
	$öfoFªeW‹kî
(
lsm_db
 *
pDb
, 
bU∆ock
){

454 if–
bU∆ock
 ){

455 
rcdummy
 = 
LSM_BUSY
;

456 
	`lsmFöishW‹k
(
pDb
, 0, &
rcdummy
);

458 
	}
}

460 
	$lsmSåu˘Li°
(

461 
lsm_db
 *
pDb
,

462 **
pzOut


464 
Levñ
 *
pT›Levñ
 = 0;

465 
rc
 = 
LSM_OK
;

466 
Levñ
 *
p
;

467 
LsmSåög
 
s
;

468 
S«pshŸ
 *
pW‹kî
;

469 
bU∆ock
 = 0;

472 
rc
 = 
	`öfoGëW‹kî
(
pDb
, &
pW‹kî
, &
bU∆ock
);

473 if–
rc
!=
LSM_OK
 ) Ñc;

476 
pT›Levñ
 = 
	`lsmDbS«pshŸLevñ
(
pW‹kî
);

477 
	`lsmSåögInô
(&
s
, 
pDb
->
pEnv
);

478 
p
=
pT›Levñ
; 
rc
==
LSM_OK
 &&Ö;Öı->
pNext
){

479 
i
;

480 
	`lsmSåögAµídf
(&
s
, "%s{%d", (s.
n
 ? " " : ""), ()
p
->
iAge
);

481 
	`lsmAµídSegmítLi°
(&
s
, " ", &
p
->
lhs
);

482 
i
=0; 
rc
==
LSM_OK
 && i<
p
->
nRight
; i++){

483 
	`lsmAµídSegmítLi°
(&
s
, " ", &
p
->
aRhs
[
i
]);

485 
	`lsmSåögAµíd
(&
s
, "}", 1);

487 
rc
 = 
s
.
n
>=0 ? 
LSM_OK
 : 
LSM_NOMEM
;

490 
	`öfoFªeW‹kî
(
pDb
, 
bU∆ock
);

491 *
pzOut
 = 
s
.
z
;

492  
rc
;

493 
	}
}

495 
	$öfoFªñi°Cb
(*
pCtx
, 
iBlk
, 
i64
 
iS«pshŸ
){

496 
LsmSåög
 *
pSå
 = (LsmSåög *)
pCtx
;

497 
	`lsmSåögAµídf
(
pSå
, "%s{%d %Œd}", (pSå->
n
?" ":""), 
iBlk
, 
iS«pshŸ
);

499 
	}
}

501 
	$lsmInfoFªñi°
(
lsm_db
 *
pDb
, **
pzOut
){

502 
S«pshŸ
 *
pW‹kî
;

503 
bU∆ock
 = 0;

504 
LsmSåög
 
s
;

505 
rc
;

508 
rc
 = 
	`öfoGëW‹kî
(
pDb
, &
pW‹kî
, &
bU∆ock
);

509 if–
rc
!=
LSM_OK
 ) Ñc;

511 
	`lsmSåögInô
(&
s
, 
pDb
->
pEnv
);

512 
rc
 = 
	`lsmWÆkFªñi°
(
pDb
, 0, 
öfoFªñi°Cb
, &
s
);

513 if–
rc
!=
LSM_OK
 ){

514 
	`lsmFªe
(
pDb
->
pEnv
, 
s
.
z
);

516 *
pzOut
 = 
s
.
z
;

520 
	`öfoFªeW‹kî
(
pDb
, 
bU∆ock
);

521  
rc
;

522 
	}
}

524 
	$öfoTªeSize
(
lsm_db
 *
db
, *
≤OldKB
, *
≤NewKB
){

525 
ShmHódî
 *
pShm
 = 
db
->
pShmhdr
;

526 
TªeHódî
 *
p
 = &
pShm
->
hdr1
;

547 *
≤NewKB
 = (()
p
->
roŸ
.
nByã
 + 1023) / 1024;

548 if–
p
->
iOldShmid
 ){

549 if–
p
->
iOldLog
==
	`lsmCheckpoötLogOff£t
(
pShm
->
aS«p1
) ){

550 *
≤OldKB
 = 0;

552 *
≤OldKB
 = (()
p
->
ﬁdroŸ
.
nByã
 + 1023) / 1024;

555 *
≤OldKB
 = 0;

558  
LSM_OK
;

559 
	}
}

561 
	$lsm_öfo
(
lsm_db
 *
pDb
, 
eP¨am
, ...){

562 
rc
 = 
LSM_OK
;

563 
va_li°
 
≠
;

564 
	`va_°¨t
(
≠
, 
eP¨am
);

566  
eP¨am
 ){

567 
LSM_INFO_NWRITE
: {

568 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

569 *
piVÆ
 = 
	`lsmFsNWrôe
(
pDb
->
pFS
);

573 
LSM_INFO_NREAD
: {

574 *
piVÆ
 = 
	`va_¨g
(
≠
, *);

575 *
piVÆ
 = 
	`lsmFsNRód
(
pDb
->
pFS
);

579 
LSM_INFO_DB_STRUCTURE
: {

580 **
pzVÆ
 = 
	`va_¨g
(
≠
, **);

581 
rc
 = 
	`lsmSåu˘Li°
(
pDb
, 
pzVÆ
);

585 
LSM_INFO_ARRAY_STRUCTURE
: {

586 
Pgno
 
pgno
 = 
	`va_¨g
(
≠
, Pgno);

587 **
pzVÆ
 = 
	`va_¨g
(
≠
, **);

588 
rc
 = 
	`lsmInfoAºaySåu˘uª
(
pDb
, 0, 
pgno
, 
pzVÆ
);

592 
LSM_INFO_ARRAY_PAGES
: {

593 
Pgno
 
pgno
 = 
	`va_¨g
(
≠
, Pgno);

594 **
pzVÆ
 = 
	`va_¨g
(
≠
, **);

595 
rc
 = 
	`lsmInfoAºayPages
(
pDb
, 
pgno
, 
pzVÆ
);

599 
LSM_INFO_PAGE_HEX_DUMP
:

600 
LSM_INFO_PAGE_ASCII_DUMP
: {

601 
Pgno
 
pgno
 = 
	`va_¨g
(
≠
, Pgno);

602 **
pzVÆ
 = 
	`va_¨g
(
≠
, **);

603 
bU∆ock
 = 0;

604 
rc
 = 
	`öfoGëW‹kî
(
pDb
, 0, &
bU∆ock
);

605 if–
rc
==
LSM_OK
 ){

606 
bHex
 = (
eP¨am
==
LSM_INFO_PAGE_HEX_DUMP
);

607 
rc
 = 
	`lsmInfoPageDump
(
pDb
, 
pgno
, 
bHex
, 
pzVÆ
);

609 
	`öfoFªeW‹kî
(
pDb
, 
bU∆ock
);

613 
LSM_INFO_LOG_STRUCTURE
: {

614 **
pzVÆ
 = 
	`va_¨g
(
≠
, **);

615 
rc
 = 
	`lsmInfoLogSåu˘uª
(
pDb
, 
pzVÆ
);

619 
LSM_INFO_FREELIST
: {

620 **
pzVÆ
 = 
	`va_¨g
(
≠
, **);

621 
rc
 = 
	`lsmInfoFªñi°
(
pDb
, 
pzVÆ
);

625 
LSM_INFO_CHECKPOINT_SIZE
: {

626 *
≤KB
 = 
	`va_¨g
(
≠
, *);

627 
rc
 = 
	`lsmCheckpoötSize
(
pDb
, 
≤KB
);

631 
LSM_INFO_TREE_SIZE
: {

632 *
≤Old
 = 
	`va_¨g
(
≠
, *);

633 *
≤New
 = 
	`va_¨g
(
≠
, *);

634 
rc
 = 
	`öfoTªeSize
(
pDb
, 
≤Old
, 
≤New
);

638 
LSM_INFO_COMPRESSION_ID
: {

639 *
piOut
 = 
	`va_¨g
(
≠
, *);

640 if–
pDb
->
pClõ¡
 ){

641 *
piOut
 = 
pDb
->
pClõ¡
->
iCmpId
;

643 
rc
 = 
	`lsmInfoCom¥essi⁄Id
(
pDb
, 
piOut
);

649 
rc
 = 
LSM_MISUSE
;

653 
	`va_íd
(
≠
);

654  
rc
;

655 
	}
}

657 
	$doWrôeOp
(

658 
lsm_db
 *
pDb
,

659 
bDñëeR™ge
,

660 c⁄° *
pKey
, 
nKey
,

661 c⁄° *
pVÆ
, 
nVÆ


663 
rc
 = 
LSM_OK
;

664 
bCommô
 = 0;

666 if–
pDb
->
nTønsO≥n
==0 ){

667 
bCommô
 = 1;

668 
rc
 = 
	`lsm_begö
(
pDb
, 1);

671 if–
rc
==
LSM_OK
 ){

672 if–
bDñëeR™ge
==0 ){

673 
rc
 = 
	`lsmLogWrôe
(
pDb
, (*)
pKey
, 
nKey
, (*)
pVÆ
, 
nVÆ
);

679 
	`lsmS‹ãdSaveTªeCurs‹s
(
pDb
);

681 if–
rc
==
LSM_OK
 ){

682 
pgsz
 = 
	`lsmFsPageSize
(
pDb
->
pFS
);

683 
nQu™t
 = 
LSM_AUTOWORK_QUANT
 * 
pgsz
;

684 
nBef‹e
;

685 
nA·î
;

686 
nDiff
;

688 if–
nQu™t
>
pDb
->
nTªeLimô
 ){

689 
nQu™t
 = 
pDb
->
nTªeLimô
;

692 
nBef‹e
 = 
	`lsmTªeSize
(
pDb
);

693 if–
bDñëeR™ge
 ){

694 
rc
 = 
	`lsmTªeDñëe
(
pDb
, (*)
pKey
, 
nKey
, (*)
pVÆ
, 
nVÆ
);

696 
rc
 = 
	`lsmTªeIn£π
(
pDb
, (*)
pKey
, 
nKey
, (*)
pVÆ
, 
nVÆ
);

699 
nA·î
 = 
	`lsmTªeSize
(
pDb
);

700 
nDiff
 = (
nA·î
/
nQu™t
Ë- (
nBef‹e
/nQuant);

701 if–
rc
==
LSM_OK
 && 
pDb
->
bAutow‹k
 && 
nDiff
!=0 ){

702 
rc
 = 
	`lsmS‹ãdAutoW‹k
(
pDb
, 
nDiff
 * 
LSM_AUTOWORK_QUANT
);

708 if–
bCommô
 ){

709 if–
rc
==
LSM_OK
 ){

710 
rc
 = 
	`lsm_commô
(
pDb
, 0);

712 
	`lsm_rﬁlback
(
pDb
, 0);

716  
rc
;

717 
	}
}

722 
	$lsm_ö£π
(

723 
lsm_db
 *
db
,

724 c⁄° *
pKey
, 
nKey
,

725 c⁄° *
pVÆ
, 
nVÆ


727  
	`doWrôeOp
(
db
, 0, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

728 
	}
}

733 
	$lsm_dñëe
(
lsm_db
 *
db
, c⁄° *
pKey
, 
nKey
){

734  
	`doWrôeOp
(
db
, 0, 
pKey
, 
nKey
, 0, -1);

735 
	}
}

740 
	$lsm_dñëe_ønge
(

741 
lsm_db
 *
db
,

742 c⁄° *
pKey1
, 
nKey1
,

743 c⁄° *
pKey2
, 
nKey2


745 
rc
 = 
LSM_OK
;

746 if–
db
->
	`xCmp
((*)
pKey1
, 
nKey1
, (*)
pKey2
, 
nKey2
)<0 ){

747 
rc
 = 
	`doWrôeOp
(
db
, 1, 
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
);

749  
rc
;

750 
	}
}

758 
	$lsm_c§_›í
(
lsm_db
 *
pDb
, 
lsm_curs‹
 **
µC§
){

759 
rc
 = 
LSM_OK
;

760 
Mu…iCurs‹
 *
pC§
 = 0;

763 
	`as£π_db_°©e
(
pDb
);

765 if–
pDb
->
pShmhdr
==0 ){

766 
	`as£π
–
pDb
->
bRód⁄ly
 );

767 
rc
 = 
	`lsmBegöRoTøns
(
pDb
);

768 }if–
pDb
->
iRódî
<0 ){

769 
rc
 = 
	`lsmBegöRódTøns
(
pDb
);

773 if–
rc
==
LSM_OK
 ){

774 
rc
 = 
	`lsmMCurs‹New
(
pDb
, &
pC§
);

780 if–
rc
!=
LSM_OK
 ){

781 
	`lsmMCurs‹Clo£
(
pC§
, 0);

782 
	`dbRñó£Clõ¡S«pshŸ
(
pDb
);

785 
	`as£π_db_°©e
(
pDb
);

786 *
µC§
 = (
lsm_curs‹
 *)
pC§
;

787  
rc
;

788 
	}
}

793 
	$lsm_c§_˛o£
(
lsm_curs‹
 *
p
){

794 if–
p
 ){

795 
lsm_db
 *
pDb
 = 
	`lsmMCurs‹Db
((
Mu…iCurs‹
 *)
p
);

796 
	`as£π_db_°©e
(
pDb
);

797 
	`lsmMCurs‹Clo£
((
Mu…iCurs‹
 *)
p
, 1);

798 
	`dbRñó£Clõ¡S«pshŸ
(
pDb
);

799 
	`as£π_db_°©e
(
pDb
);

801  
LSM_OK
;

802 
	}
}

809 
	$lsm_c§_£ek
(
lsm_curs‹
 *
pC§
, c⁄° *
pKey
, 
nKey
, 
eSìk
){

810  
	`lsmMCurs‹Sìk
((
Mu…iCurs‹
 *)
pC§
, 0, (*)
pKey
, 
nKey
, 
eSìk
);

811 
	}
}

813 
	$lsm_c§_√xt
(
lsm_curs‹
 *
pC§
){

814  
	`lsmMCurs‹Next
((
Mu…iCurs‹
 *)
pC§
);

815 
	}
}

817 
	$lsm_c§_¥ev
(
lsm_curs‹
 *
pC§
){

818  
	`lsmMCurs‹Pªv
((
Mu…iCurs‹
 *)
pC§
);

819 
	}
}

821 
	$lsm_c§_fú°
(
lsm_curs‹
 *
pC§
){

822  
	`lsmMCurs‹Fú°
((
Mu…iCurs‹
 *)
pC§
);

823 
	}
}

825 
	$lsm_c§_œ°
(
lsm_curs‹
 *
pC§
){

826  
	`lsmMCurs‹La°
((
Mu…iCurs‹
 *)
pC§
);

827 
	}
}

829 
	$lsm_c§_vÆid
(
lsm_curs‹
 *
pC§
){

830  
	`lsmMCurs‹VÆid
((
Mu…iCurs‹
 *)
pC§
);

831 
	}
}

833 
	$lsm_c§_key
(
lsm_curs‹
 *
pC§
, c⁄° **
µKey
, *
≤Key
){

834  
	`lsmMCurs‹Key
((
Mu…iCurs‹
 *)
pC§
, (**)
µKey
, 
≤Key
);

835 
	}
}

837 
	$lsm_c§_vÆue
(
lsm_curs‹
 *
pC§
, c⁄° **
µVÆ
, *
≤VÆ
){

838  
	`lsmMCurs‹VÆue
((
Mu…iCurs‹
 *)
pC§
, (**)
µVÆ
, 
≤VÆ
);

839 
	}
}

841 
lsm_c⁄fig_log
(

842 
lsm_db
 *
pDb
,

843 (*
xLog
)(*, , const *),

844 *
pCtx


846 
pDb
->
xLog
 = xLog;

847 
pDb
->
pLogCtx
 = 
pCtx
;

848 
	}
}

850 
lsm_c⁄fig_w‹k_hook
(

851 
lsm_db
 *
pDb
,

852 (*
xW‹k
)(
lsm_db
 *, *),

853 *
pCtx


855 
pDb
->
xW‹k
 = xWork;

856 
pDb
->
pW‹kCtx
 = 
pCtx
;

857 
	}
}

859 
	$lsmLogMesßge
(
lsm_db
 *
pDb
, 
rc
, c⁄° *
zF‹m©
, ...){

860 if–
pDb
->
xLog
 ){

861 
LsmSåög
 
s
;

862 
va_li°
 
≠
, 
≠2
;

863 
	`lsmSåögInô
(&
s
, 
pDb
->
pEnv
);

864 
	`va_°¨t
(
≠
, 
zF‹m©
);

865 
	`va_°¨t
(
≠2
, 
zF‹m©
);

866 
	`lsmSåögVAµídf
(&
s
, 
zF‹m©
, 
≠
, 
≠2
);

867 
	`va_íd
(
≠
);

868 
	`va_íd
(
≠2
);

869 
pDb
->
	`xLog
’Db->
pLogCtx
, 
rc
, 
s
.
z
);

870 
	`lsmSåögCÀ¨
(&
s
);

872 
	}
}

874 
	$lsm_begö
(
lsm_db
 *
pDb
, 
iLevñ
){

875 
rc
;

877 
	`as£π_db_°©e
–
pDb
 );

878 
rc
 = (
pDb
->
bRód⁄ly
 ? 
LSM_READONLY
 : 
LSM_OK
);

881 if–
iLevñ
<0 ) iLevñ = 
pDb
->
nTønsO≥n
 + 1;

882 if–
iLevñ
>
pDb
->
nTønsO≥n
 ){

883 
i
;

886 if–
rc
==
LSM_OK
 && 
pDb
->
nTønsAŒoc
<
iLevñ
 ){

887 
TønsM¨k
 *
aNew
;

888 
nByã
 = (
TønsM¨k
Ë* (
iLevñ
+1);

889 
aNew
 = (
TønsM¨k
 *)
	`lsmRóŒoc
(
pDb
->
pEnv
,ÖDb->
aTøns
, 
nByã
);

890 if–!
aNew
 ){

891 
rc
 = 
LSM_NOMEM
;

893 
nByã
 = (
TønsM¨k
Ë* (
iLevñ
+1 - 
pDb
->
nTønsAŒoc
);

894 
	`mem£t
(&
aNew
[
pDb
->
nTønsAŒoc
], 0, 
nByã
);

895 
pDb
->
nTønsAŒoc
 = 
iLevñ
+1;

896 
pDb
->
aTøns
 = 
aNew
;

900 if–
rc
==
LSM_OK
 && 
pDb
->
nTønsO≥n
==0 ){

901 
rc
 = 
	`lsmBegöWrôeTøns
(
pDb
);

904 if–
rc
==
LSM_OK
 ){

905 
i
=
pDb
->
nTønsO≥n
; i<
iLevñ
; i++){

906 
	`lsmTªeM¨k
(
pDb
, &pDb->
aTøns
[
i
].
åì
);

907 
	`lsmLogTñl
(
pDb
, &pDb->
aTøns
[
i
].
log
);

909 
pDb
->
nTønsO≥n
 = 
iLevñ
;

913  
rc
;

914 
	}
}

916 
	$lsm_commô
(
lsm_db
 *
pDb
, 
iLevñ
){

917 
rc
 = 
LSM_OK
;

919 
	`as£π_db_°©e
–
pDb
 );

922 if–
iLevñ
<0 ) iLevñ = 
	`LSM_MAX
(0, 
pDb
->
nTønsO≥n
 - 1);

924 if–
iLevñ
<
pDb
->
nTønsO≥n
 ){

925 if–
iLevñ
==0 ){

927 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmLogCommô
(
pDb
);

928 if–
rc
==
LSM_OK
 && 
pDb
->
eSa„ty
==
LSM_SAFETY_FULL
 ){

929 
rc
 = 
	`lsmFsSyncLog
(
pDb
->
pFS
);

931 
	`lsmFöishWrôeTøns
(
pDb
, (
rc
==
LSM_OK
));

933 
pDb
->
nTønsO≥n
 = 
iLevñ
;

935 
	`dbRñó£Clõ¡S«pshŸ
(
pDb
);

936  
rc
;

937 
	}
}

939 
	$lsm_rﬁlback
(
lsm_db
 *
pDb
, 
iLevñ
){

940 
rc
 = 
LSM_OK
;

941 
	`as£π_db_°©e
–
pDb
 );

943 if–
pDb
->
nTønsO≥n
 ){

945 if–
iLevñ
<0 ) iLevñ = 
	`LSM_MAX
(0, 
pDb
->
nTønsO≥n
 - 1);

947 if–
iLevñ
<=
pDb
->
nTønsO≥n
 ){

948 
TønsM¨k
 *
pM¨k
 = &
pDb
->
aTøns
[(
iLevñ
==0 ? 0 : iLevel-1)];

949 
	`lsmTªeRﬁlback
(
pDb
, &
pM¨k
->
åì
);

950 if–
iLevñ
 ) 
	`lsmLogSìk
(
pDb
, &
pM¨k
->
log
);

951 
pDb
->
nTønsO≥n
 = 
iLevñ
;

954 if–
pDb
->
nTønsO≥n
==0 ){

955 
	`lsmFöishWrôeTøns
(
pDb
, 0);

957 
	`dbRñó£Clõ¡S«pshŸ
(
pDb
);

960  
rc
;

961 
	}
}

963 
	$lsm_gë_u£r_vîsi⁄
(
lsm_db
 *
pDb
, *
piU§
){

964 
rc
 = 
LSM_OK
;

967 
	`as£π_db_°©e
(
pDb
);

968 if–
pDb
->
pShmhdr
==0 ){

969 
	`as£π
–
pDb
->
bRód⁄ly
 );

970 
rc
 = 
	`lsmBegöRoTøns
(
pDb
);

971 }if–
pDb
->
iRódî
<0 ){

972 
rc
 = 
	`lsmBegöRódTøns
(
pDb
);

976 if–
rc
==
LSM_OK
 ){

977 *
piU§
 = 
pDb
->
åìhdr
.
iU§Vîsi⁄
;

980 
	`dbRñó£Clõ¡S«pshŸ
(
pDb
);

981 
	`as£π_db_°©e
(
pDb
);

982  
rc
;

983 
	}
}

985 
	$lsm_£t_u£r_vîsi⁄
(
lsm_db
 *
pDb
, 
iU§
){

986 
rc
 = 
LSM_OK
;

987 
bCommô
 = 0;

989 if–
pDb
->
nTønsO≥n
==0 ){

990 
bCommô
 = 1;

991 
rc
 = 
	`lsm_begö
(
pDb
, 1);

994 if–
rc
==
LSM_OK
 ){

995 
pDb
->
åìhdr
.
iU§Vîsi⁄
 = 
iU§
;

1000 if–
bCommô
 ){

1001 if–
rc
==
LSM_OK
 ){

1002 
rc
 = 
	`lsm_commô
(
pDb
, 0);

1004 
	`lsm_rﬁlback
(
pDb
, 0);

1008  
rc
;

1009 
	}
}

	@src/lsm_mem.c

15 
	~"lsmI¡.h
"

21 *
	$lsmMÆloc
(
lsm_ív
 *
pEnv
, 
size_t
 
N
){

22 
	`as£π
–
pEnv
 );

23  
pEnv
->
	`xMÆloc
’Env, 
N
);

24 
	}
}

25 
	$lsmFªe
(
lsm_ív
 *
pEnv
, *
p
){

26 
	`as£π
–
pEnv
 );

27 
pEnv
->
	`xFªe
’Env, 
p
);

28 
	}
}

29 *
	$lsmRóŒoc
(
lsm_ív
 *
pEnv
, *
p
, 
size_t
 
N
){

30 
	`as£π
–
pEnv
 );

31  
pEnv
->
	`xRóŒoc
’Env, 
p
, 
N
);

32 
	}
}

37 *
	$lsm_mÆloc
(
lsm_ív
 *
pEnv
, 
size_t
 
N
){

38  
	`lsmMÆloc
(
pEnv
 ?ÖEnv : 
	`lsm_deÁu…_ív
(), 
N
);

39 
	}
}

40 
	$lsm_‰ì
(
lsm_ív
 *
pEnv
, *
p
){

41 
	`lsmFªe
(
pEnv
 ?ÖEnv : 
	`lsm_deÁu…_ív
(), 
p
);

42 
	}
}

43 *
	$lsm_ªÆloc
(
lsm_ív
 *
pEnv
, *
p
, 
size_t
 
N
){

44  
	`lsmRóŒoc
(
pEnv
 ?ÖEnv : 
	`lsm_deÁu…_ív
(), 
p
, 
N
);

45 
	}
}

47 *
	$lsmMÆlocZîo
(
lsm_ív
 *
pEnv
, 
size_t
 
N
){

48 *
pRë
;

49 
	`as£π
–
pEnv
 );

50 
pRë
 = 
	`lsmMÆloc
(
pEnv
, 
N
);

51 if–
pRë
 ) 
	`mem£t
’Rë, 0, 
N
);

52  
pRë
;

53 
	}
}

55 *
	$lsmMÆlocRc
(
lsm_ív
 *
pEnv
, 
size_t
 
N
, *
pRc
){

56 *
pRë
 = 0;

57 if–*
pRc
==
LSM_OK
 ){

58 
pRë
 = 
	`lsmMÆloc
(
pEnv
, 
N
);

59 if–
pRë
==0 ){

60 *
pRc
 = 
LSM_NOMEM_BKPT
;

63  
pRë
;

64 
	}
}

66 *
	$lsmMÆlocZîoRc
(
lsm_ív
 *
pEnv
, 
size_t
 
N
, *
pRc
){

67 *
pRë
 = 0;

68 if–*
pRc
==
LSM_OK
 ){

69 
pRë
 = 
	`lsmMÆlocZîo
(
pEnv
, 
N
);

70 if–
pRë
==0 ){

71 *
pRc
 = 
LSM_NOMEM_BKPT
;

74  
pRë
;

75 
	}
}

77 *
	$lsmRóŒocOrFªe
(
lsm_ív
 *
pEnv
, *
p
, 
size_t
 
N
){

78 *
pNew
;

79 
pNew
 = 
	`lsm_ªÆloc
(
pEnv
, 
p
, 
N
);

80 if–!
pNew
 ) 
	`lsm_‰ì
(
pEnv
, 
p
);

81  
pNew
;

82 
	}
}

84 *
	$lsmRóŒocOrFªeRc
(
lsm_ív
 *
pEnv
, *
p
, 
size_t
 
N
, *
pRc
){

85 *
pRë
 = 0;

86 if–*
pRc
 ){

87 
	`lsmFªe
(
pEnv
, 
p
);

89 
pRë
 = 
	`lsmRóŒocOrFªe
(
pEnv
, 
p
, 
N
);

90 if–!
pRë
 ) *
pRc
 = 
LSM_NOMEM_BKPT
;

92  
pRë
;

93 
	}
}

95 *
	$lsmMÆlocSådup
(
lsm_ív
 *
pEnv
, c⁄° *
zIn
){

96 
nByã
;

97 *
zRë
;

98 
nByã
 = 
	`°æí
(
zIn
);

99 
zRë
 = 
	`lsmMÆloc
(
pEnv
, 
nByã
+1);

100 if–
zRë
 ){

101 
	`mem˝y
(
zRë
, 
zIn
, 
nByã
+1);

103  
zRë
;

104 
	}
}

	@src/lsm_mutex.c

15 
	~"lsmI¡.h
"

20 
	$lsmMuãxNew
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 **
µNew
){

21  
pEnv
->
	`xMuãxNew
’Env, 
µNew
);

22 
	}
}

27 
	$lsmMuãxSètic
(
lsm_ív
 *
pEnv
, 
iMuãx
, 
lsm_muãx
 **
µSètic
){

28  
pEnv
->
	`xMuãxSètic
’Env, 
iMuãx
, 
µSètic
);

29 
	}
}

34 
	$lsmMuãxDñ
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 *
pMuãx
){

35 if–
pMuãx
 ) 
pEnv
->
	`xMuãxDñ
(pMutex);

36 
	}
}

41 
	$lsmMuãxE¡î
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 *
pMuãx
){

42 
pEnv
->
	`xMuãxE¡î
(
pMuãx
);

43 
	}
}

53 
	$lsmMuãxTry
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 *
pMuãx
){

54  
pEnv
->
	`xMuãxTry
(
pMuãx
);

55 
	}
}

60 
	$lsmMuãxLóve
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 *
pMuãx
){

61 
pEnv
->
	`xMuãxLóve
(
pMuãx
);

62 
	}
}

64 #i‚de‡
NDEBUG


73 
	$lsmMuãxHñd
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 *
pMuãx
){

74  
pEnv
->
xMuãxHñd
 ?ÖEnv->
	`xMuãxHñd
(
pMuãx
) : 1;

75 
	}
}

85 
	$lsmMuãxNŸHñd
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 *
pMuãx
){

86  
pEnv
->
xMuãxNŸHñd
 ?ÖEnv->
	`xMuãxNŸHñd
(
pMuãx
) : 1;

87 
	}
}

	@src/lsm_shared.c

16 
	~"lsmI¡.h
"

27 
	sSh¨edD©a
 {

28 
D©aba£
 *
	mpD©aba£
;

29 } 
	ggSh¨ed
;

44 
	sD©aba£
 {

46 *
	mzName
;

47 
	mnName
;

48 
	mnDbRef
;

49 
D©aba£
 *
	mpDbNext
;

52 
	mbRód⁄ly
;

53 
	mbMu…iProc
;

54 
lsm_fûe
 *
	mpFûe
;

55 
LsmFûe
 *
	mpLsmFûe
;

56 
lsm_muãx
 *
	mpClõ¡Muãx
;

57 
	mnShmChunk
;

58 **
	m≠ShmChunk
;

59 
lsm_db
 *
	mpC⁄n
;

66 
	$íãrGlobÆMuãx
(
lsm_ív
 *
pEnv
){

67 
lsm_muãx
 *
p
;

68 
rc
 = 
	`lsmMuãxSètic
(
pEnv
, 
LSM_MUTEX_GLOBAL
, &
p
);

69 if–
rc
==
LSM_OK
 ) 
	`lsmMuãxE¡î
(
pEnv
, 
p
);

70  
rc
;

71 
	}
}

72 
	$ÀaveGlobÆMuãx
(
lsm_ív
 *
pEnv
){

73 
lsm_muãx
 *
p
;

74 
	`lsmMuãxSètic
(
pEnv
, 
LSM_MUTEX_GLOBAL
, &
p
);

75 
	`lsmMuãxLóve
(
pEnv
, 
p
);

76 
	}
}

78 #ifde‡
LSM_DEBUG


79 
	$hﬁdögGlobÆMuãx
(
lsm_ív
 *
pEnv
){

80 
lsm_muãx
 *
p
;

81 
	`lsmMuãxSètic
(
pEnv
, 
LSM_MUTEX_GLOBAL
, &
p
);

82  
	`lsmMuãxHñd
(
pEnv
, 
p
);

83 
	}
}

84 
	$as£πNŸInFªñi°
(
Fªñi°
 *
p
, 
iBlk
){

85 
i
;

86 
i
=0; i<
p
->
nE¡ry
; i++){

87 
	`as£π
–
p
->
aE¡ry
[
i
].
iBlk
!=iBlk );

89 
	}
}

91 
	#as£πNŸInFªñi°
(
x
,
y
)

	)

97 
	$‰ìli°Aµíd
(
lsm_db
 *
db
, 
iBlk
, 
i64
 
iId
){

98 
lsm_ív
 *
pEnv
 = 
db
->pEnv;

99 
Fªñi°
 *
p
;

100 
i
;

102 
	`as£π
–
iId
==-1 || iId>=0 );

103 
p
 = 
db
->
bU£Fªñi°
 ? db->
pFªñi°
 : &db->
pW‹kî
->
‰ìli°
;

106 
	`as£π
–
p
->
nAŒoc
>ı->
nE¡ry
 );

107 if–
p
->
nAŒoc
=ı->
nE¡ry
 ){

108 
nNew
;

109 
nByã
;

110 
Fªñi°E¡ry
 *
aNew
;

112 
nNew
 = (
p
->
nAŒoc
==0 ? 4 :Ö->nAlloc*2);

113 
nByã
 = (
Fªñi°E¡ry
Ë* 
nNew
;

114 
aNew
 = (
Fªñi°E¡ry
 *)
	`lsmRóŒoc
(
pEnv
, 
p
->
aE¡ry
, 
nByã
);

115 if–!
aNew
 )  
LSM_NOMEM_BKPT
;

116 
p
->
nAŒoc
 = 
nNew
;

117 
p
->
aE¡ry
 = 
aNew
;

120 
i
=0; i<
p
->
nE¡ry
; i++){

121 
	`as£π
–
i
==0 || 
p
->
aE¡ry
[i].
iBlk
 >Ö->aEntry[i-1].iBlk );

122 if–
p
->
aE¡ry
[
i
].
iBlk
>=iBlk ) ;

125 if–
i
<
p
->
nE¡ry
 &&Ö->
aE¡ry
[i].
iBlk
==iBlk ){

127 
p
->
aE¡ry
[
i
].
iId
 = iId;

130 
nByã
 = (
Fªñi°E¡ry
)*(
p
->
nE¡ry
-
i
);

131 
	`memmove
(&
p
->
aE¡ry
[
i
+1], &p->aE¡ry[i], 
nByã
);

132 
p
->
aE¡ry
[
i
].
iBlk
 = iBlk;

133 
p
->
aE¡ry
[
i
].
iId
 = iId;

134 
p
->
nE¡ry
++;

137  
LSM_OK
;

138 
	}
}

144 
	$‰ìD©aba£
(
lsm_ív
 *
pEnv
, 
D©aba£
 *
p
){

145 
	`as£π
–
	`hﬁdögGlobÆMuãx
(
pEnv
) );

146 if–
p
 ){

148 
	`lsmMuãxDñ
(
pEnv
, 
p
->
pClõ¡Muãx
);

150 if–
p
->
pFûe
 ){

151 
	`lsmEnvClo£
(
pEnv
, 
p
->
pFûe
);

155 
	`lsmFªe
(
pEnv
, 
p
->
≠ShmChunk
);

158 
	`lsmFªe
(
pEnv
, 
p
);

160 
	}
}

162 
DbTrunˇãCtx
 
	tDbTrunˇãCtx
;

163 
	sDbTrunˇãCtx
 {

164 
	mnBlock
;

165 
i64
 
	miInU£
;

168 
	$dbTrunˇãCb
(*
pCtx
, 
iBlk
, 
i64
 
iS«pshŸ
){

169 
DbTrunˇãCtx
 *
p
 = (DbTrunˇãCtx *)
pCtx
;

170 if–
iBlk
!=
p
->
nBlock
 || (p->
iInU£
>=0 && 
iS«pshŸ
>=p->iInUse) )  1;

171 
p
->
nBlock
--;

173 
	}
}

175 
	$dbTrunˇã
(
lsm_db
 *
pDb
, 
i64
 
iInU£
){

176 
rc
 = 
LSM_OK
;

178 
i
;

179 
DbTrunˇãCtx
 
˘x
;

181 
	`as£π
–
pDb
->
pW‹kî
 );

182 
˘x
.
nBlock
 = 
pDb
->
pW‹kî
->nBlock;

183 
˘x
.
iInU£
 = iInUse;

185 
rc
 = 
	`lsmWÆkFªñi°
(
pDb
, 1, 
dbTrunˇãCb
, (*)&
˘x
);

186 
i
=
˘x
.
nBlock
+1; 
rc
==
LSM_OK
 && i<=
pDb
->
pW‹kî
->nBlock; i++){

187 
rc
 = 
	`‰ìli°Aµíd
(
pDb
, 
i
, -1);

190 if–
rc
==
LSM_OK
 ){

191 #ifde‡
LSM_LOG_FREELIST


192 if–
˘x
.
nBlock
!=
pDb
->
pW‹kî
->nBlock ){

193 
	`lsmLogMesßge
(
pDb
, 0,

194 "dbTrunˇã():Årunˇãd dbÅÿ%d blocks",
˘x
.
nBlock


198 
pDb
->
pW‹kî
->
nBlock
 = 
˘x
.nBlock;

201  
rc
;

202 
	}
}

211 
	$dbTrunˇãFûe
(
lsm_db
 *
pDb
){

212 
rc
;

214 
	`as£π
–
pDb
->
pW‹kî
==0 );

215 
	`as£π
–
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_EXCL
) );

216 
rc
 = 
	`lsmCheckpoötLﬂdW‹kî
(
pDb
);

218 if–
rc
==
LSM_OK
 ){

219 
DbTrunˇãCtx
 
˘x
;

224 
˘x
.
nBlock
 = 
pDb
->
pW‹kî
->nBlock;

225 
˘x
.
iInU£
 = -1;

226 
rc
 = 
	`lsmWÆkFªñi°
(
pDb
, 1, 
dbTrunˇãCb
, (*)&
˘x
);

230 if–
rc
==
LSM_OK
 && 
˘x
.
nBlock
!=
pDb
->
pW‹kî
->nBlock ){

231 
rc
 = 
	`lsmFsTrunˇãDb
(

232 
pDb
->
pFS
, (
i64
)
˘x
.
nBlock
*
	`lsmFsBlockSize
(pDb->pFS)

237 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
,ÖDb->
pW‹kî
);

238 
pDb
->
pW‹kî
 = 0;

239  
rc
;

240 
	}
}

242 
	$doDbDisc⁄√˘
(
lsm_db
 *
pDb
){

243 
rc
;

245 if–
pDb
->
bRód⁄ly
 ){

246 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS3
, 
LSM_LOCK_UNLOCK
, 0);

250 
rc
 = 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_EXCL
, 1);

251 if–
rc
==
LSM_OK
 ){

256 
rc
 = 
	`lsmShmTe°Lock
(
pDb
, 
LSM_LOCK_DMS2
, 1, 
LSM_LOCK_EXCL
);

257 if–
rc
==
LSM_OK
 ){

258 
rc
 = 
	`lsmShmTe°Lock
(
pDb
, 
LSM_LOCK_CHECKPOINTER
, 1, 
LSM_LOCK_EXCL
);

260 if–
rc
==
LSM_OK
 ){

261 
bRód⁄ly
 = 0;

273 
rc
 = 
	`lsmTªeLﬂdHódî
(
pDb
, 0);

274 if–
rc
==
LSM_OK
 && (
	`lsmTªeHasOld
(
pDb
Ë|| 
	`lsmTªeSize
(pDb)>0) ){

275 
rc
 = 
	`lsmFlushTªeToDisk
(
pDb
);

281 if–
rc
==
LSM_OK
 ){

282 
rc
 = 
	`lsmShmTe°Lock
(
pDb
, 
LSM_LOCK_DMS3
, 1, 
LSM_LOCK_EXCL
);

283 if–
rc
==
LSM_BUSY
 ){

284 
bRód⁄ly
 = 1;

285 
rc
 = 
LSM_OK
;

290 if–
rc
==
LSM_OK
 ){

291 
rc
 = 
	`lsmCheckpoötWrôe
(
pDb
, (
bRód⁄ly
==0), 0);

296 if–
rc
==
LSM_OK
 ){

297 
bRŸøns
 = 0;

298 
D©aba£
 *
p
 = 
pDb
->
pD©aba£
;

302 
rc
 = 
	`lsmDëe˘RoTøns
(
pDb
, &
bRŸøns
);

303 if–
rc
==
LSM_OK
 && 
bRŸøns
==0 ){

304 
	`lsmFsClo£AndDñëeLog
(
pDb
->
pFS
);

309 if–
bRód⁄ly
==0 && 
bRŸøns
==0 ){

310 
	`dbTrunˇãFûe
(
pDb
);

311 if–
p
->
pFûe
 &&Ö->
bMu…iProc
 ){

312 
	`lsmEnvShmUnm≠
(
pDb
->
pEnv
, 
p
->
pFûe
, 1);

319 if–
pDb
->
iRw˛õ¡
>=0 ){

320 
	`lsmShmLock
(
pDb
, 
	`LSM_LOCK_RWCLIENT
’Db->
iRw˛õ¡
), 
LSM_LOCK_UNLOCK
, 0);

321 
pDb
->
iRw˛õ¡
 = -1;

324 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS2
, 
LSM_LOCK_UNLOCK
, 0);

325 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_UNLOCK
, 0);

327 
pDb
->
pShmhdr
 = 0;

328 
	}
}

330 
	$doDbC⁄√˘
(
lsm_db
 *
pDb
){

331 c⁄° 
nUsMax
 = 100000;

332 
nUs
 = 1000;

333 
rc
;

336 
	`as£π
–
pDb
->
pShmhdr
==0 );

337 
	`as£π
–
pDb
->
bRód⁄ly
==0 );

338 
rc
 = 
	`lsmShmCacheChunks
(
pDb
, 1);

339 if–
rc
!=
LSM_OK
 ) Ñc;

340 
pDb
->
pShmhdr
 = (
ShmHódî
 *ÌDb->
≠Shm
[0];

345 
rc
 = 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_EXCL
, 1);

346 if–
rc
!=
LSM_BUSY
 ) ;

347 
	`lsmEnvSÀï
(
pDb
->
pEnv
, 
nUs
);

348 
nUs
 =ÇUs * 2;

349 if–
nUs
>
nUsMax
 )ÇUs =ÇUsMax;

351 if–
rc
!=
LSM_OK
 ){

352 
pDb
->
pShmhdr
 = 0;

353  
rc
;

359 
	`as£π
–
LSM_LOCK_DMS3
==1+
LSM_LOCK_DMS2
 );

360 
rc
 = 
	`lsmShmTe°Lock
(
pDb
, 
LSM_LOCK_DMS2
, 2, 
LSM_LOCK_EXCL
);

361 if–
rc
==
LSM_OK
 ){

362 
	`mem£t
(
pDb
->
pShmhdr
, 0, (
ShmHódî
));

363 
rc
 = 
	`lsmCheckpoötRecovî
(
pDb
);

364 if–
rc
==
LSM_OK
 ){

365 
rc
 = 
	`lsmLogRecovî
(
pDb
);

367 if–
rc
==
LSM_OK
 ){

368 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

369 
pShm
->
aRódî
[0].
iLsmId
 = 
	`lsmCheckpoötId
’Shm->
aS«p1
, 0);

370 
pShm
->
aRódî
[0].
iTªeId
 = 
pDb
->
åìhdr
.
iU£dShmid
;

372 }if–
rc
==
LSM_BUSY
 ){

373 
rc
 = 
LSM_OK
;

385 if–
rc
==
LSM_OK
 ){

386 
rc
 = 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS2
, 
LSM_LOCK_SHARED
, 0);

391 if–
rc
!=
LSM_OK
 ){

392 
pDb
->
pShmhdr
 = 0;

394 
i
;

395 
i
=0; i<
LSM_LOCK_NRWCLIENT
; i++){

396 
rc2
 = 
	`lsmShmLock
(
pDb
, 
	`LSM_LOCK_RWCLIENT
(
i
), 
LSM_LOCK_EXCL
, 0);

397 if–
rc2
==
LSM_OK
 ) 
pDb
->
iRw˛õ¡
 = 
i
;

398 if–
rc2
!=
LSM_BUSY
 ){

399 
rc
 = 
rc2
;

404 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_UNLOCK
, 0);

406  
rc
;

407 
	}
}

409 
	$dbO≥nSh¨edFd
(
lsm_ív
 *
pEnv
, 
D©aba£
 *
p
, 
bRoOk
){

410 
rc
;

412 
rc
 = 
	`lsmEnvO≥n
(
pEnv
, 
p
->
zName
, 0, &p->
pFûe
);

413 if–
rc
==
LSM_IOERR
 && 
bRoOk
 ){

414 
rc
 = 
	`lsmEnvO≥n
(
pEnv
, 
p
->
zName
, 
LSM_OPEN_READONLY
, &p->
pFûe
);

415 
p
->
bRód⁄ly
 = 1;

418  
rc
;

419 
	}
}

434 
	$lsmDbD©aba£C⁄√˘
(

435 
lsm_db
 *
pDb
,

436 c⁄° *
zName


438 
lsm_ív
 *
pEnv
 = 
pDb
->pEnv;

439 
rc
;

440 
D©aba£
 *
p
 = 0;

441 
nName
 = 
	`lsmSåÀn
(
zName
);

443 
	`as£π
–
pDb
->
pD©aba£
==0 );

444 
rc
 = 
	`íãrGlobÆMuãx
(
pEnv
);

445 if–
rc
==
LSM_OK
 ){

450 
p
=
gSh¨ed
.
pD©aba£
;Ö;Öı->
pDbNext
){

451 if–
nName
==
p
->nNamê&& 0==
	`memcmp
(
zName
,Ö->zName,ÇName) ) ;

455 if–
p
==0 ){

456 
p
 = (
D©aba£
 *)
	`lsmMÆlocZîoRc
(
pEnv
, (D©aba£)+
nName
+1, &
rc
);

460 if–
rc
==
LSM_OK
 ){

461 
p
->
bMu…iProc
 = 
pDb
->bMultiProc;

462 
p
->
zName
 = (*)&p[1];

463 
p
->
nName
 =ÇName;

464 
	`mem˝y
((*)
p
->
zName
, zName, 
nName
+1);

465 
rc
 = 
	`lsmMuãxNew
(
pEnv
, &
p
->
pClõ¡Muãx
);

471 if–
rc
==
LSM_OK
 ){

472 
bRód⁄ly
 = (
pDb
->bRód⁄ly &&ÖDb->
bMu…iProc
);

473 
rc
 = 
	`dbO≥nSh¨edFd
(
pDb
->
pEnv
, 
p
, 
bRód⁄ly
);

476 if–
rc
==
LSM_OK
 && 
p
->
bMu…iProc
==0 ){

477 
	`as£π
–
p
->
bRód⁄ly
==0 );

478 
rc
 = 
	`lsmEnvLock
(
pDb
->
pEnv
, 
p
->
pFûe
, 
LSM_LOCK_DMS2
, 
LSM_LOCK_EXCL
);

481 if–
rc
==
LSM_OK
 ){

482 
p
->
pDbNext
 = 
gSh¨ed
.
pD©aba£
;

483 
gSh¨ed
.
pD©aba£
 = 
p
;

485 
	`‰ìD©aba£
(
pEnv
, 
p
);

486 
p
 = 0;

490 if–
p
 ){

491 
p
->
nDbRef
++;

493 
	`ÀaveGlobÆMuãx
(
pEnv
);

495 if–
p
 ){

496 
	`lsmMuãxE¡î
(
pDb
->
pEnv
, 
p
->
pClõ¡Muãx
);

497 
pDb
->
pNext
 = 
p
->
pC⁄n
;

498 
p
->
pC⁄n
 = 
pDb
;

499 
	`lsmMuãxLóve
(
pDb
->
pEnv
, 
p
->
pClõ¡Muãx
);

503 
pDb
->
pD©aba£
 = 
p
;

504 if–
rc
==
LSM_OK
 ){

505 
	`as£π
–
p
 );

506 
rc
 = 
	`lsmFsO≥n
(
pDb
, 
zName
, 
p
->
bRód⁄ly
);

513 if–
pDb
->
bRód⁄ly
==0 ){

514 if–
rc
==
LSM_OK
 ){

515 
rc
 = 
	`lsmFsC⁄figuª
(
pDb
);

517 if–
rc
==
LSM_OK
 ){

518 
rc
 = 
	`doDbC⁄√˘
(
pDb
);

522  
rc
;

523 
	}
}

525 
	$dbDe„rClo£
(
lsm_db
 *
pDb
){

526 if–
pDb
->
pFS
 ){

527 
LsmFûe
 *
pLsmFûe
;

528 
D©aba£
 *
p
 = 
pDb
->
pD©aba£
;

529 
pLsmFûe
 = 
	`lsmFsDe„rClo£
(
pDb
->
pFS
);

530 
pLsmFûe
->
pNext
 = 
p
->pLsmFile;

531 
p
->
pLsmFûe
 =ÖLsmFile;

533 
	}
}

535 
LsmFûe
 *
	$lsmDbRecy˛eFd
(
lsm_db
 *
db
){

536 
LsmFûe
 *
pRë
;

537 
D©aba£
 *
p
 = 
db
->
pD©aba£
;

538 
	`lsmMuãxE¡î
(
db
->
pEnv
, 
p
->
pClõ¡Muãx
);

539 if–(
pRë
 = 
p
->
pLsmFûe
)!=0 ){

540 
p
->
pLsmFûe
 = 
pRë
->
pNext
;

542 
	`lsmMuãxLóve
(
db
->
pEnv
, 
p
->
pClõ¡Muãx
);

543  
pRë
;

544 
	}
}

551 
	$lsmDbD©aba£Rñó£
(
lsm_db
 *
pDb
){

552 
D©aba£
 *
p
 = 
pDb
->
pD©aba£
;

553 if–
p
 ){

554 
lsm_db
 **
µDb
;

556 if–
pDb
->
pShmhdr
 ){

557 
	`doDbDisc⁄√˘
(
pDb
);

560 
	`lsmMuãxE¡î
(
pDb
->
pEnv
, 
p
->
pClõ¡Muãx
);

561 
µDb
=&
p
->
pC⁄n
; *µDb!=
pDb
;ÖpDb=&((*µDb)->
pNext
));

562 *
µDb
 = 
pDb
->
pNext
;

563 
	`dbDe„rClo£
(
pDb
);

564 
	`lsmMuãxLóve
(
pDb
->
pEnv
, 
p
->
pClõ¡Muãx
);

566 
	`íãrGlobÆMuãx
(
pDb
->
pEnv
);

567 
p
->
nDbRef
--;

568 if–
p
->
nDbRef
==0 ){

569 
LsmFûe
 *
pIãr
;

570 
LsmFûe
 *
pNext
;

571 
D©aba£
 **
µ
;

574 
µ
=&
gSh¨ed
.
pD©aba£
; *µ!=
p
;Öp=&((*µ)->
pDbNext
));

575 *
µ
 = 
p
->
pDbNext
;

578 if–
p
->
bMu…iProc
==0 ){

579 
i
;

580 
i
=0; i<
p
->
nShmChunk
; i++){

581 
	`lsmFªe
(
pDb
->
pEnv
, 
p
->
≠ShmChunk
[
i
]);

586 
pIãr
=
p
->
pLsmFûe
;ÖIãr;ÖIãr=
pNext
){

587 
pNext
 = 
pIãr
->pNext;

588 
	`lsmEnvClo£
(
pDb
->
pEnv
, 
pIãr
->
pFûe
);

589 
	`lsmFªe
(
pDb
->
pEnv
, 
pIãr
);

591 
	`‰ìD©aba£
(
pDb
->
pEnv
, 
p
);

593 
	`ÀaveGlobÆMuãx
(
pDb
->
pEnv
);

595 
	}
}

597 
Levñ
 *
	$lsmDbS«pshŸLevñ
(
S«pshŸ
 *
pS«pshŸ
){

598  
pS«pshŸ
->
pLevñ
;

599 
	}
}

601 
	$lsmDbS«pshŸSëLevñ
(
S«pshŸ
 *
pS«p
, 
Levñ
 *
pLevñ
){

602 
pS«p
->
pLevñ
 =ÖLevel;

603 
	}
}

606 
fú°S«pshŸInU£
(
lsm_db
 *, 
i64
 *);

611 
WÆkFªñi°Ctx
 
	tWÆkFªñi°Ctx
;

612 
	sWÆkFªñi°Ctx
 {

613 
lsm_db
 *
	mpDb
;

614 
	mbRevî£
;

615 
Fªñi°
 *
	mpFªñi°
;

616 
	miFªe
;

617 (*
	mxU§
)(*, , 
	mi64
);

618 *
	mpU§˘x
;

619 
	mbD⁄e
;

625 
	$wÆkFªñi°Cb
(*
pCtx
, 
iBlk
, 
i64
 
iS«pshŸ
){

626 
WÆkFªñi°Ctx
 *
p
 = (WÆkFªñi°Ctx *)
pCtx
;

627 c⁄° 
iDú
 = (
p
->
bRevî£
 ? -1 : 1);

628 
Fªñi°
 *
pFªe
 = 
p
->
pFªñi°
;

630 
	`as£π
–
p
->
bD⁄e
==0 );

631 if–
pFªe
 ){

632  (
p
->
iFªe
 < 
pFªe
->
nE¡ry
) &&Ö->iFree>=0 ){

633 
Fªñi°E¡ry
 *
pE¡ry
 = &
pFªe
->
aE¡ry
[
p
->
iFªe
];

634 if–(
p
->
bRevî£
==0 && 
pE¡ry
->
iBlk
>iBlk)

635 || (
p
->
bRevî£
!=0 && 
pE¡ry
->
iBlk
<iBlk)

639 
p
->
iFªe
 +
iDú
;

640 if–
pE¡ry
->
iId
>=0

641 && 
p
->
	`xU§
’->
pU§˘x
, 
pE¡ry
->
iBlk
,ÖE¡ry->
iId
)

643 
p
->
bD⁄e
 = 1;

646 if–
pE¡ry
->
iBlk
==iBlk )  0;

651 if–
p
->
	`xU§
’->
pU§˘x
, 
iBlk
, 
iS«pshŸ
) ){

652 
p
->
bD⁄e
 = 1;

656 
	}
}

669 
lsmWÆkFªñi°
(

670 
lsm_db
 *
pDb
,

671 
bRevî£
,

672 (*
x
)(*, , 
i64
),

673 *
pCtx


675 c⁄° 
iDú
 = (
bRevî£
 ? -1 : 1);

676 
rc
;

677 
iCtx
;

679 
WÆkFªñi°Ctx
 
˘x
[2];

681 
˘x
[0].
pDb
 =ÖDb;

682 
˘x
[0].
bRevî£
 = bReverse;

683 
˘x
[0].
pFªñi°
 = &
pDb
->
pW‹kî
->
‰ìli°
;

684 if–
˘x
[0].
pFªñi°
 && 
bRevî£
 ){

685 
˘x
[0].
iFªe
 = ctx[0].
pFªñi°
->
nE¡ry
-1;

687 
˘x
[0].
iFªe
 = 0;

689 
˘x
[0].
xU§
 = 
wÆkFªñi°Cb
;

690 
˘x
[0].
pU§˘x
 = (*)&ctx[1];

691 
˘x
[0].
bD⁄e
 = 0;

693 
˘x
[1].
pDb
 =ÖDb;

694 
˘x
[1].
bRevî£
 = bReverse;

695 
˘x
[1].
pFªñi°
 = 
pDb
->pFreelist;

696 if–
˘x
[1].
pFªñi°
 && 
bRevî£
 ){

697 
˘x
[1].
iFªe
 = ctx[1].
pFªñi°
->
nE¡ry
-1;

699 
˘x
[1].
iFªe
 = 0;

701 
˘x
[1].
xU§
 = 
x
;

702 
˘x
[1].
pU§˘x
 = 
pCtx
;

703 
˘x
[1].
bD⁄e
 = 0;

705 
rc
 = 
	`lsmS‹ãdWÆkFªñi°
(
pDb
, 
bRevî£
, 
wÆkFªñi°Cb
, (*)&
˘x
[0]);

707 if–
˘x
[0].
bD⁄e
==0 ){

708 
iCtx
=0; iCtx<2; iCtx++){

709 
i
;

710 
WÆkFªñi°Ctx
 *
p
 = &
˘x
[
iCtx
];

711 
i
=
p
->
iFªe
;

712 
p
->
pFªñi°
 && 
rc
==
LSM_OK
 && 
i
<p->pFªñi°->
nE¡ry
 && i>=0;

713 
i
 +
iDú


715 
Fªñi°E¡ry
 *
pE¡ry
 = &
p
->
pFªñi°
->
aE¡ry
[
i
];

716 if–
pE¡ry
->
iId
>=0 && 
p
->
	`xU§
’->
pU§˘x
,ÖE¡ry->
iBlk
,ÖEntry->iId) ){

717  
LSM_OK
;

723  
rc
;

724 
	}
}

727 
FödFªeblockCtx
 
	tFödFªeblockCtx
;

728 
	sFödFªeblockCtx
 {

729 
i64
 
	miInU£
;

730 
	miRë
;

731 
	mbNŸO√
;

734 
	$födFªeblockCb
(*
pCtx
, 
iBlk
, 
i64
 
iS«pshŸ
){

735 
FödFªeblockCtx
 *
p
 = (FödFªeblockCtx *)
pCtx
;

736 if–
iS«pshŸ
<
p
->
iInU£
 && (
iBlk
!=1 ||Ö->
bNŸO√
==0) ){

737 
p
->
iRë
 = 
iBlk
;

741 
	}
}

743 
	$födFªeblock
(
lsm_db
 *
pDb
, 
i64
 
iInU£
, 
bNŸO√
, *
piRë
){

744 
rc
;

745 
FödFªeblockCtx
 
˘x
;

747 
˘x
.
iInU£
 = iInUse;

748 
˘x
.
iRë
 = 0;

749 
˘x
.
bNŸO√
 = bNotOne;

750 
rc
 = 
	`lsmWÆkFªñi°
(
pDb
, 0, 
födFªeblockCb
, (*)&
˘x
);

751 *
piRë
 = 
˘x
.
iRë
;

753  
rc
;

754 
	}
}

764 
	$lsmBlockAŒoˇã
(
lsm_db
 *
pDb
, 
iBef‹e
, *
piBlk
){

765 
S«pshŸ
 *
p
 = 
pDb
->
pW‹kî
;

766 
iRë
 = 0;

767 
rc
 = 
LSM_OK
;

768 
i64
 
iInU£
 = 0;

769 
i64
 
iSyn˚d
 = 0;

771 
	`as£π
–
p
 );

773 #ifde‡
LSM_LOG_FREELIST


775 
nCÆl
 = 0;

776 *
zFªe
 = 0;

777 
nCÆl
++;

778 
rc
 = 
	`lsmInfoFªñi°
(
pDb
, &
zFªe
);

779 if–
rc
!=
LSM_OK
 ) Ñc;

780 
	`lsmLogMesßge
(
pDb
, 0, "lsmBlockAŒoˇã(): %d fªñi°: %s", 
nCÆl
, 
zFªe
);

781 
	`lsmFªe
(
pDb
->
pEnv
, 
zFªe
);

792 
rc
 = 
	`lsmCheckpoötSyn˚d
(
pDb
, &
iSyn˚d
, 0, 0);

793 if–
rc
==
LSM_OK
 && 
iSyn˚d
==0 ) iSyn˚d = 
p
->
iId
;

794 
iInU£
 = 
iSyn˚d
;

795 if–
rc
==
LSM_OK
 && 
pDb
->
iRódî
>=0 ){

796 
	`as£π
–
pDb
->
pClõ¡
 );

797 
iInU£
 = 
	`LSM_MIN
(iInU£, 
pDb
->
pClõ¡
->
iId
);

799 if–
rc
==
LSM_OK
 )Ñ¯
	`fú°S«pshŸInU£
(
pDb
, &
iInU£
);

801 #ifde‡
LSM_LOG_FREELIST


803 
	`lsmLogMesßge
(
pDb
, 0, "lsmBlockAllocate(): "

805 
iInU£
, 
iSyn˚d
, (
pDb
->
iRódî
>=0 ?ÖDb->
pClõ¡
->
iId
 : 0)

819 if–
rc
==
LSM_OK
 ){

820 
bRŸøns
;

821 
rc
 = 
	`lsmDëe˘RoTøns
(
pDb
, &
bRŸøns
);

823 if–
rc
==
LSM_OK
 && 
bRŸøns
==0 ){

824 
rc
 = 
	`födFªeblock
(
pDb
, 
iInU£
, (
iBef‹e
>0), &
iRë
);

828 if–
iBef‹e
>0 && (
iRë
<=0 || iRet>=iBefore) ){

829 
iRë
 = 0;

831 }if–
rc
==
LSM_OK
 ){

835 if–
iRë
>0 ){

836 #ifde‡
LSM_LOG_FREELIST


837 
	`lsmLogMesßge
(
pDb
, 0,

838 "ªusög block %d (¢≠shŸ-ö-u£=%Œd)", 
iRë
, 
iInU£
);

840 
rc
 = 
	`‰ìli°Aµíd
(
pDb
, 
iRë
, -1);

841 if–
rc
==
LSM_OK
 ){

842 
rc
 = 
	`dbTrunˇã
(
pDb
, 
iInU£
);

845 
iRë
 = ++(
p
->
nBlock
);

846 #ifde‡
LSM_LOG_FREELIST


847 
	`lsmLogMesßge
(
pDb
, 0, "exãndög fûêtÿ%d blocks", 
iRë
);

852 
	`as£π
–
iBef‹e
>0 || 
iRë
>0 || 
rc
!=
LSM_OK
 );

853 *
piBlk
 = 
iRë
;

854  
rc
;

855 
	}
}

864 
	$lsmBlockFªe
(
lsm_db
 *
pDb
, 
iBlk
){

865 
S«pshŸ
 *
p
 = 
pDb
->
pW‹kî
;

866 
	`as£π
–
	`lsmShmAs£πW‹kî
(
pDb
) );

868 #ifde‡
LSM_LOG_FREELIST


869 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "lsmBlockFªe(): Fªêblock %d", 
iBlk
);

872  
	`‰ìli°Aµíd
(
pDb
, 
iBlk
, 
p
->
iId
);

873 
	}
}

885 
	$lsmBlockRe‰ì
(
lsm_db
 *
pDb
, 
iBlk
){

886 
rc
 = 
LSM_OK
;

888 #ifde‡
LSM_LOG_FREELIST


889 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "lsmBlockRe‰ì(): Re‰ì block %d", 
iBlk
);

892 
rc
 = 
	`‰ìli°Aµíd
(
pDb
, 
iBlk
, 0);

893  
rc
;

894 
	}
}

905 
	$lsmCheckpoötWrôe
(
lsm_db
 *
pDb
, 
bTrunˇã
, 
u32
 *
≤Wrôe
){

906 
rc
;

907 
u32
 
nWrôe
 = 0;

909 
	`as£π
–
pDb
->
pW‹kî
==0 );

910 
	`as£π
–1 || 
pDb
->
pClõ¡
==0 );

911 
	`as£π
–
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_WORKER
, 
LSM_LOCK_UNLOCK
) );

913 
rc
 = 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_CHECKPOINTER
, 
LSM_LOCK_EXCL
, 0);

914 if–
rc
!=
LSM_OK
 ) Ñc;

916 
rc
 = 
	`lsmCheckpoötLﬂd
(
pDb
, 0);

917 if–
rc
==
LSM_OK
 ){

918 
nBlock
 = 
	`lsmCheckpoötNBlock
(
pDb
->
aS«pshŸ
);

919 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

920 
bD⁄e
 = 0;

924 if–
pShm
->
iMëaPage
 ){

925 
MëaPage
 *
pPg
;

926 
u8
 *
aD©a
;

927 
nD©a
;

928 
i64
 
iCk±
;

929 
i64
 
iDisk
;

930 
iCk±
 = 
	`lsmCheckpoötId
(
pDb
->
aS«pshŸ
, 0);

931 
rc
 = 
	`lsmFsMëaPageGë
(
pDb
->
pFS
, 0, 
pShm
->
iMëaPage
, &
pPg
);

932 if–
rc
==
LSM_OK
 ){

933 
aD©a
 = 
	`lsmFsMëaPageD©a
(
pPg
, &
nD©a
);

934 
iDisk
 = 
	`lsmCheckpoötId
((
u32
 *)
aD©a
, 1);

935 
nWrôe
 = 
	`lsmCheckpoötNWrôe
((
u32
 *)
aD©a
, 1);

936 
	`lsmFsMëaPageRñó£
(
pPg
);

938 
bD⁄e
 = (
iDisk
>=
iCk±
);

941 if–
rc
==
LSM_OK
 && 
bD⁄e
==0 ){

942 
iMëa
 = (
pShm
->
iMëaPage
 % 2) + 1;

943 if–
pDb
->
eSa„ty
!=
LSM_SAFETY_OFF
 ){

944 
rc
 = 
	`lsmFsSyncDb
(
pDb
->
pFS
, 
nBlock
);

946 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmCheckpoötSt‹e
(
pDb
, 
iMëa
);

947 if–
rc
==
LSM_OK
 && 
pDb
->
eSa„ty
!=
LSM_SAFETY_OFF
){

948 
rc
 = 
	`lsmFsSyncDb
(
pDb
->
pFS
, 0);

950 if–
rc
==
LSM_OK
 ){

951 
pShm
->
iMëaPage
 = 
iMëa
;

952 
nWrôe
 = 
	`lsmCheckpoötNWrôe
(
pDb
->
aS«pshŸ
, 0) -ÇWrite;

954 #ifde‡
LSM_LOG_WORK


955 
	`lsmLogMesßge
(
pDb
, 0, "finish checkpoint %d",

956 ()
	`lsmCheckpoötId
(
pDb
->
aS«pshŸ
, 0)

961 if–
rc
==
LSM_OK
 && 
bTrunˇã
 && 
nBlock
>0 ){

962 
rc
 = 
	`lsmFsTrunˇãDb
(
pDb
->
pFS
, (
i64
)
nBlock
*
	`lsmFsBlockSize
(pDb->pFS));

966 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_CHECKPOINTER
, 
LSM_LOCK_UNLOCK
, 0);

967 if–
≤Wrôe
 && 
rc
==
LSM_OK
 ) *≤Wrôê
nWrôe
;

968  
rc
;

969 
	}
}

971 
	$lsmBegöW‹k
(
lsm_db
 *
pDb
){

972 
rc
;

975 
rc
 = 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_WORKER
, 
LSM_LOCK_EXCL
, 0);

978 if–
rc
==
LSM_OK
 ){

979 
rc
 = 
	`lsmCheckpoötLﬂdW‹kî
(
pDb
);

981  
rc
;

982 
	}
}

984 
	$lsmFªeS«pshŸ
(
lsm_ív
 *
pEnv
, 
S«pshŸ
 *
p
){

985 if–
p
 ){

986 
	`lsmS‹ãdFªeLevñ
(
pEnv
, 
p
->
pLevñ
);

987 
	`lsmFªe
(
pEnv
, 
p
->
‰ìli°
.
aE¡ry
);

988 
	`lsmFªe
(
pEnv
, 
p
->
ªdúe˘
.
a
);

989 
	`lsmFªe
(
pEnv
, 
p
);

991 
	}
}

1010 
	$dbSëRódLock
(
lsm_db
 *
db
, 
i64
 
iLsm
, 
u32
 
iShm
){

1011 
rc
 = 
LSM_OK
;

1012 
ShmHódî
 *
pShm
 = 
db
->
pShmhdr
;

1013 
i
;

1016 
i
=0; i<
LSM_LOCK_NREADER
; i++){

1017 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1018 if–
p
->
iLsmId
==
iLsm
 &&Ö->
iTªeId
==
iShm
 )  
LSM_OK
;

1024 
i
=0; 
rc
==
LSM_OK
 && i<
LSM_LOCK_NREADER
; i++){

1025 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_EXCL
, 0);

1026 if–
rc
==
LSM_BUSY
 ){

1027 
rc
 = 
LSM_OK
;

1029 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1030 
p
->
iLsmId
 = 
iLsm
;

1031 
p
->
iTªeId
 = 
iShm
;

1032 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_UNLOCK
, 0);

1037  
rc
;

1038 
	}
}

1043 
	$dbRñó£Ródlock
(
lsm_db
 *
db
){

1044 
rc
 = 
LSM_OK
;

1045 if–
db
->
iRódî
>=0 ){

1046 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(db->
iRódî
), 
LSM_LOCK_UNLOCK
, 0);

1047 
db
->
iRódî
 = -1;

1049 
db
->
bRoTøns
 = 0;

1050  
rc
;

1051 
	}
}

1060 
	$lsmFöishW‹k
(
lsm_db
 *
pDb
, 
bFlush
, *
pRc
){

1061 
rc
 = *
pRc
;

1062 
	`as£π
–
rc
!=0 || 
pDb
->
pW‹kî
 );

1063 if–
pDb
->
pW‹kî
 ){

1066 if–
rc
==
LSM_OK
 ){

1067 
rc
 = 
	`lsmSaveW‹kî
(
pDb
, 
bFlush
);

1072 if–
rc
==
LSM_OK
 ){

1073 if–
pDb
->
iRódî
<0 ){

1074 
rc
 = 
	`lsmTªeLﬂdHódî
(
pDb
, 0);

1076 if–
rc
==
LSM_OK
 ){

1077 
rc
 = 
	`dbSëRódLock
(
pDb
,ÖDb->
pW‹kî
->
iId
,ÖDb->
åìhdr
.
iU£dShmid
);

1082 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
,ÖDb->
pW‹kî
);

1083 
pDb
->
pW‹kî
 = 0;

1086 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_WORKER
, 
LSM_LOCK_UNLOCK
, 0);

1087 *
pRc
 = 
rc
;

1088 
	}
}

1093 
	$lsmFöishRecovîy
(
lsm_db
 *
pDb
){

1094 
	`lsmTªeEndTønß˘i⁄
(
pDb
, 1);

1095  
LSM_OK
;

1096 
	}
}

1112 
	$lsmCheckCom¥essi⁄Id
(
lsm_db
 *
pDb
, 
u32
 
iReq
){

1113 if–
iReq
!=
LSM_COMPRESSION_EMPTY
 && 
pDb
->
com¥ess
.
iId
!=iReq ){

1114 if–
pDb
->
Á˘‹y
.
xFa˘‹y
 ){

1115 
pDb
->
bInFa˘‹y
 = 1;

1116 
pDb
->
Á˘‹y
.
	`xFa˘‹y
’Db->Á˘‹y.
pCtx
,ÖDb, 
iReq
);

1117 
pDb
->
bInFa˘‹y
 = 0;

1119 if–
pDb
->
com¥ess
.
iId
!=
iReq
 ){

1121  
LSM_MISMATCH
;

1125  
LSM_OK
;

1126 
	}
}

1132 
	$lsmBegöRódTøns
(
lsm_db
 *
pDb
){

1133 c⁄° 
MAX_READLOCK_ATTEMPTS
 = 10;

1134 c⁄° 
nMaxAâem±
 = (
pDb
->
bRoTøns
 ? 1 : 
MAX_READLOCK_ATTEMPTS
);

1136 
rc
 = 
LSM_OK
;

1137 
iAâem±
 = 0;

1139 
	`as£π
–
pDb
->
pW‹kî
==0 );

1141  
rc
==
LSM_OK
 && 
pDb
->
iRódî
<0 && (
iAâem±
++)<
nMaxAâem±
 ){

1142 
iTªehdr
 = 0;

1143 
iS«p
 = 0;

1144 
	`as£π
–
pDb
->
pC§
==0 &&ÖDb->
nTønsO≥n
==0 );

1147 
rc
 = 
	`lsmTªeLﬂdHódî
(
pDb
, &
iTªehdr
);

1150 if–
rc
==
LSM_OK
 ){

1151 if–
	`lsmCheckpoötClõ¡CacheOk
(
pDb
)==0 ){

1152 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
,ÖDb->
pClõ¡
);

1153 
pDb
->
pClõ¡
 = 0;

1154 
	`lsmMCurs‹FªeCache
(
pDb
);

1155 
	`lsmFsPurgeCache
(
pDb
->
pFS
);

1156 
rc
 = 
	`lsmCheckpoötLﬂd
(
pDb
, &
iS«p
);

1158 
iS«p
 = 1;

1166 if–
rc
==
LSM_OK
 ){

1167 
u32
 
iShmMax
 = 
pDb
->
åìhdr
.
iU£dShmid
;

1168 
u32
 
iShmMö
 = 
pDb
->
åìhdr
.
iNextShmid
+1-
LSM_MAX_SHMCHUNKS
;

1169 
rc
 = 
	`lsmRódlock
(

1170 
pDb
, 
	`lsmCheckpoötId
’Db->
aS«pshŸ
, 0), 
iShmMö
, 
iShmMax


1172 if–
rc
==
LSM_OK
 ){

1173 if–
	`lsmTªeLﬂdHódîOk
(
pDb
, 
iTªehdr
)

1174 && 
	`lsmCheckpoötLﬂdOk
(
pDb
, 
iS«p
)

1180 if–
pDb
->
pClõ¡
==0 ){

1181 
rc
 = 
	`lsmCheckpoötDe£rülize
(
pDb
, 0,ÖDb->
aS«pshŸ
,&pDb->
pClõ¡
);

1183 
	`as£π
–(
rc
==
LSM_OK
)==(
pDb
->
pClõ¡
!=0) );

1184 
	`as£π
–
pDb
->
iRódî
>=0 );

1188 if–
rc
==
LSM_OK
 ){

1189 
rc
 = 
	`lsmCheckCom¥essi⁄Id
(
pDb
,ÖDb->
pClõ¡
->
iCmpId
);

1192 
rc
 = 
	`dbRñó£Ródlock
(
pDb
);

1196 if–
rc
==
LSM_BUSY
 ){

1197 
rc
 = 
LSM_OK
;

1201 if–
rc
==
LSM_OK
 && 
pDb
->
pClõ¡
 ){

1202 
	`Ârötf
(
°dîr
,

1204 (*)
pDb
,

1205 ()
pDb
->
pClõ¡
->
iId
, (ÌDb->
åìhdr
.
iU£dShmid
,

1206 ()
pDb
->
åìhdr
.
roŸ
.
iTønsId
,

1207 ()
pDb
->
åìhdr
.
iOldShmid


1213 if–
rc
==
LSM_OK
 ){

1214 
rc
 = 
	`lsmShmCacheChunks
(
pDb
,ÖDb->
åìhdr
.
nChunk
);

1216 if–
rc
!=
LSM_OK
 ){

1217 
	`dbRñó£Ródlock
(
pDb
);

1219 if–
pDb
->
pClõ¡
==0 && 
rc
==
LSM_OK
 )Ñ¯
LSM_BUSY
;

1220  
rc
;

1221 
	}
}

1234 
	$lsmDëe˘RoTøns
(
lsm_db
 *
db
, *
pbExi°
){

1235 
rc
;

1238 
	`as£π
–
db
->
bRód⁄ly
==0 );

1240 
rc
 = 
	`lsmShmTe°Lock
(
db
, 
LSM_LOCK_ROTRANS
, 1, 
LSM_LOCK_EXCL
);

1241 if–
rc
==
LSM_BUSY
 ){

1242 *
pbExi°
 = 1;

1243 
rc
 = 
LSM_OK
;

1245 *
pbExi°
 = 0;

1248  
rc
;

1249 
	}
}

1256 
	$lsmBegöRoTøns
(
lsm_db
 *
db
){

1257 
rc
 = 
LSM_OK
;

1259 
	`as£π
–
db
->
bRód⁄ly
 && db->
pShmhdr
==0 );

1260 
	`as£π
–
db
->
iRódî
<0 );

1262 if–
db
->
bRoTøns
==0 ){

1265 
rc
 = 
	`lsmShmLock
(
db
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_SHARED
, 0);

1266 if–
rc
!=
LSM_OK
 ) Ñc;

1268 
rc
 = 
	`lsmShmTe°Lock
(

1269 
db
, 
	`LSM_LOCK_RWCLIENT
(0), 
LSM_LOCK_NREADER
, 
LSM_LOCK_SHARED


1271 if–
rc
==
LSM_OK
 ){

1276 
rc
 = 
	`lsmShmLock
(
db
, 
LSM_LOCK_ROTRANS
, 
LSM_LOCK_SHARED
, 0);

1277 
	`lsmShmLock
(
db
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_UNLOCK
, 0);

1279 if–
rc
==
LSM_OK
 ){

1280 
db
->
bRoTøns
 = 1;

1281 
rc
 = 
	`lsmShmCacheChunks
(
db
, 1);

1282 if–
rc
==
LSM_OK
 ){

1283 
db
->
pShmhdr
 = (
ShmHódî
 *)db->
≠Shm
[0];

1284 
	`mem£t
(
db
->
pShmhdr
, 0, (
ShmHódî
));

1285 
rc
 = 
	`lsmCheckpoötRecovî
(
db
);

1286 if–
rc
==
LSM_OK
 ){

1287 
rc
 = 
	`lsmLogRecovî
(
db
);

1291 }if–
rc
==
LSM_BUSY
 ){

1293 
rc
 = 
	`lsmShmLock
(
db
, 
LSM_LOCK_DMS3
, 
LSM_LOCK_SHARED
, 0);

1294 
	`lsmShmLock
(
db
, 
LSM_LOCK_DMS1
, 
LSM_LOCK_UNLOCK
, 0);

1295 if–
rc
==
LSM_OK
 ){

1296 
rc
 = 
	`lsmShmCacheChunks
(
db
, 1);

1297 if–
rc
==
LSM_OK
 ){

1298 
db
->
pShmhdr
 = (
ShmHódî
 *)db->
≠Shm
[0];

1303 if–
rc
==
LSM_OK
 ){

1304 
rc
 = 
	`lsmBegöRódTøns
(
db
);

1308  
rc
;

1309 
	}
}

1314 
	$lsmFöishRódTøns
(
lsm_db
 *
pDb
){

1320 
	`as£π
–
pDb
->
pW‹kî
==0 );

1321 
	`as£π
–
pDb
->
pC§
==0 &&ÖDb->
nTønsO≥n
==0 );

1323 if–
pDb
->
bRoTøns
 ){

1324 
i
;

1325 
i
=0; i<
pDb
->
nShm
; i++){

1326 
	`lsmFªe
(
pDb
->
pEnv
,ÖDb->
≠Shm
[
i
]);

1328 
	`lsmFªe
(
pDb
->
pEnv
,ÖDb->
≠Shm
);

1329 
pDb
->
≠Shm
 = 0;

1330 
pDb
->
nShm
 = 0;

1331 
pDb
->
pShmhdr
 = 0;

1333 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_ROTRANS
, 
LSM_LOCK_UNLOCK
, 0);

1335 
	`dbRñó£Ródlock
(
pDb
);

1336 
	}
}

1341 
	$lsmBegöWrôeTøns
(
lsm_db
 *
pDb
){

1342 
rc
 = 
LSM_OK
;

1343 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

1345 
	`as£π
–
pDb
->
nTønsO≥n
==0 );

1346 
	`as£π
–
pDb
->
bDisˇrdOld
==0 );

1347 
	`as£π
–
pDb
->
bRód⁄ly
==0 );

1350 if–
pDb
->
iRódî
<0 ){

1351 
rc
 = 
	`lsmBegöRódTøns
(
pDb
);

1355 if–
rc
==
LSM_OK
 ){

1356 
rc
 = 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_WRITER
, 
LSM_LOCK_EXCL
, 0);

1360 if–
rc
==
LSM_OK
 && 
pShm
->
bWrôî
 ){

1361 
rc
 = 
	`lsmTªeRïaú
(
pDb
);

1362 if–
rc
==
LSM_OK
 ) 
pShm
->
bWrôî
 = 0;

1367 if–
rc
==
LSM_OK
 && 
	`memcmp
(&
pShm
->
hdr1
, &
pDb
->
åìhdr
, (
TªeHódî
)) ){

1368 
rc
 = 
LSM_BUSY
;

1371 if–
rc
==
LSM_OK
 ){

1372 
rc
 = 
	`lsmLogBegö
(
pDb
);

1378 if–
rc
==
LSM_OK
 ){

1379 
TªeHódî
 *
p
 = &
pDb
->
åìhdr
;

1380 
pShm
->
bWrôî
 = 1;

1381 
p
->
roŸ
.
iTønsId
++;

1382 if–
	`lsmTªeHasOld
(
pDb
Ë&& 
p
->
iOldLog
=ıDb->
pClõ¡
->
iLogOff
 ){

1383 
	`lsmTªeDisˇrdOld
(
pDb
);

1384 
pDb
->
bDisˇrdOld
 = 1;

1387 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_WRITER
, 
LSM_LOCK_UNLOCK
, 0);

1388 if–
pDb
->
pC§
==0 ) 
	`lsmFöishRódTøns
(pDb);

1390  
rc
;

1391 
	}
}

1406 
	$lsmFöishWrôeTøns
(
lsm_db
 *
pDb
, 
bCommô
){

1407 
rc
 = 
LSM_OK
;

1408 
bFlush
 = 0;

1410 
	`lsmLogEnd
(
pDb
, 
bCommô
);

1411 if–
rc
==
LSM_OK
 && 
bCommô
 && 
	`lsmTªeSize
(
pDb
)>pDb->
nTªeLimô
 ){

1412 
bFlush
 = 1;

1413 
	`lsmTªeMakeOld
(
pDb
);

1415 
	`lsmTªeEndTønß˘i⁄
(
pDb
, 
bCommô
);

1417 if–
rc
==
LSM_OK
 ){

1418 if–
bFlush
 && 
pDb
->
bAutow‹k
 ){

1419 
rc
 = 
	`lsmS‹ãdAutoW‹k
(
pDb
, 1);

1420 }if–
bCommô
 && 
pDb
->
bDisˇrdOld
 ){

1421 
rc
 = 
	`dbSëRódLock
(
pDb
,ÖDb->
pClõ¡
->
iId
,ÖDb->
åìhdr
.
iU£dShmid
);

1424 
pDb
->
bDisˇrdOld
 = 0;

1425 
	`lsmShmLock
(
pDb
, 
LSM_LOCK_WRITER
, 
LSM_LOCK_UNLOCK
, 0);

1427 if–
bFlush
 && 
pDb
->
bAutow‹k
==0 &&ÖDb->
xW‹k
 ){

1428 
pDb
->
	`xW‹k
’Db,ÖDb->
pW‹kCtx
);

1430  
rc
;

1431 
	}
}

1437 #ifde‡
LSM_DEBUG


1438 
	$lsmHﬁdögClõ¡Muãx
(
lsm_db
 *
pDb
){

1439  
	`lsmMuãxHñd
(
pDb
->
pEnv
,ÖDb->
pD©aba£
->
pClõ¡Muãx
);

1440 
	}
}

1443 
	$¶ŸIsUßbÀ
(
ShmRódî
 *
p
, 
i64
 
iLsm
, 
u32
 
iShmMö
, u32 
iShmMax
){

1445 
p
->
iLsmId
 &&Ö->iLsmId<=
iLsm


1446 && 
	`shm_£quí˚_ge
(
iShmMax
, 
p
->
iTªeId
)

1447 && 
	`shm_£quí˚_ge
(
p
->
iTªeId
, 
iShmMö
)

1449 
	}
}

1456 
	$lsmRódlock
(
lsm_db
 *
db
, 
i64
 
iLsm
, 
u32
 
iShmMö
, u32 
iShmMax
){

1457 
rc
 = 
LSM_OK
;

1458 
ShmHódî
 *
pShm
 = 
db
->
pShmhdr
;

1459 
i
;

1461 
	`as£π
–
db
->
iRódî
<0 );

1462 
	`as£π
–
	`shm_£quí˚_ge
(
iShmMax
, 
iShmMö
) );

1465 if–
db
->
bRoTøns
 ){

1466 
db
->
iRódî
 = 0;

1467  
LSM_OK
;

1471 
i
=0; 
db
->
iRódî
<0 && 
rc
==
LSM_OK
 && i<
LSM_LOCK_NREADER
; i++){

1472 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1473 if–
p
->
iLsmId
==
iLsm
 &&Ö->
iTªeId
==
iShmMax
 ){

1474 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_SHARED
, 0);

1475 if–
rc
==
LSM_OK
 && 
p
->
iLsmId
==
iLsm
 &&Ö->
iTªeId
==
iShmMax
 ){

1476 
db
->
iRódî
 = 
i
;

1477 }if–
rc
==
LSM_BUSY
 ){

1478 
rc
 = 
LSM_OK
;

1485 
i
=0; 
db
->
iRódî
<0 && 
rc
==
LSM_OK
 && i<
LSM_LOCK_NREADER
; i++){

1486 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_EXCL
, 0);

1487 if–
rc
==
LSM_BUSY
 ){

1488 
rc
 = 
LSM_OK
;

1490 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1491 
p
->
iLsmId
 = 
iLsm
;

1492 
p
->
iTªeId
 = 
iShmMax
;

1493 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_SHARED
, 0);

1494 
	`as£π
–
rc
!=
LSM_BUSY
 );

1495 if–
rc
==
LSM_OK
 ) 
db
->
iRódî
 = 
i
;

1500 
i
=0; 
db
->
iRódî
<0 && 
rc
==
LSM_OK
 && i<
LSM_LOCK_NREADER
; i++){

1501 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1502 if–
	`¶ŸIsUßbÀ
(
p
, 
iLsm
, 
iShmMö
, 
iShmMax
) ){

1503 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_SHARED
, 0);

1504 if–
rc
==
LSM_OK
 && 
	`¶ŸIsUßbÀ
(
p
, 
iLsm
, 
iShmMö
, 
iShmMax
) ){

1505 
db
->
iRódî
 = 
i
;

1506 }if–
rc
==
LSM_BUSY
 ){

1507 
rc
 = 
LSM_OK
;

1512 if–
rc
==
LSM_OK
 && 
db
->
iRódî
<0 ){

1513 
rc
 = 
LSM_BUSY
;

1515  
rc
;

1516 
	}
}

1529 
	$isInU£
(
lsm_db
 *
db
, 
i64
 
iLsmId
, 
u32
 
iShmid
, *
pbInU£
){

1530 
ShmHódî
 *
pShm
 = 
db
->
pShmhdr
;

1531 
i
;

1532 
rc
 = 
LSM_OK
;

1534 
i
=0; 
rc
==
LSM_OK
 && i<
LSM_LOCK_NREADER
; i++){

1535 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1536 if–
p
->
iLsmId
 ){

1537 if–(
iLsmId
!=0 && 
p
->iLsmId!=0 && iLsmId>=p->iLsmId)

1538 || (
iLsmId
==0 && 
	`shm_£quí˚_ge
(
p
->
iTªeId
, 
iShmid
))

1540 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_EXCL
, 0);

1541 if–
rc
==
LSM_OK
 ){

1542 
p
->
iLsmId
 = 0;

1543 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_UNLOCK
, 0);

1549 if–
rc
==
LSM_BUSY
 ){

1550 *
pbInU£
 = 1;

1551  
LSM_OK
;

1553 *
pbInU£
 = 0;

1554  
rc
;

1555 
	}
}

1563 
	$fú°S«pshŸInU£
(

1564 
lsm_db
 *
db
,

1565 
i64
 *
piInU£


1567 
ShmHódî
 *
pShm
 = 
db
->
pShmhdr
;

1568 
i64
 
iInU£
 = *
piInU£
;

1569 
i
;

1571 
	`as£π
–
iInU£
>0 );

1572 
i
=0; i<
LSM_LOCK_NREADER
; i++){

1573 
ShmRódî
 *
p
 = &
pShm
->
aRódî
[
i
];

1574 if–
p
->
iLsmId
 ){

1575 
i64
 
iThis
 = 
p
->
iLsmId
;

1576 if–
iThis
!=0 && 
iInU£
>iThis ){

1577 
rc
 = 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_EXCL
, 0);

1578 if–
rc
==
LSM_OK
 ){

1579 
p
->
iLsmId
 = 0;

1580 
	`lsmShmLock
(
db
, 
	`LSM_LOCK_READER
(
i
), 
LSM_LOCK_UNLOCK
, 0);

1581 }if–
rc
==
LSM_BUSY
 ){

1582 
iInU£
 = 
iThis
;

1586  
rc
;

1592 *
piInU£
 = 
iInU£
;

1593  
LSM_OK
;

1594 
	}
}

1596 
	$lsmTªeInU£
(
lsm_db
 *
db
, 
u32
 
iShmid
, *
pbInU£
){

1597 if–
db
->
åìhdr
.
iU£dShmid
==
iShmid
 ){

1598 *
pbInU£
 = 1;

1599  
LSM_OK
;

1601  
	`isInU£
(
db
, 0, 
iShmid
, 
pbInU£
);

1602 
	}
}

1604 
	$lsmLsmInU£
(
lsm_db
 *
db
, 
i64
 
iLsmId
, *
pbInU£
){

1605 if–
db
->
pClõ¡
 && db->pClõ¡->
iId
<=
iLsmId
 ){

1606 *
pbInU£
 = 1;

1607  
LSM_OK
;

1609  
	`isInU£
(
db
, 
iLsmId
, 0, 
pbInU£
);

1610 
	}
}

1617 
	$lsmDbMu…iProc
(
lsm_db
 *
pDb
){

1618  
pDb
->
pD©aba£
 &&ÖDb->pD©aba£->
bMu…iProc
;

1619 
	}
}

1633 
	$lsmShmCacheChunks
(
lsm_db
 *
db
, 
nChunk
){

1634 
rc
 = 
LSM_OK
;

1635 if–
nChunk
>
db
->
nShm
 ){

1636 c⁄° 
NINCR
 = 16;

1637 
D©aba£
 *
p
 = 
db
->
pD©aba£
;

1638 
lsm_ív
 *
pEnv
 = 
db
->pEnv;

1639 
nAŒoc
;

1640 
i
;

1646 
nAŒoc
 = ((
db
->
nShm
 + 
NINCR
 - 1) / NINCR) * NINCR;

1647  
nChunk
>=
nAŒoc
 ){

1648 **
≠Shm
;

1649 
nAŒoc
 +
NINCR
;

1650 
≠Shm
 = 
	`lsmRóŒoc
(
pEnv
, 
db
->≠Shm, (*)*
nAŒoc
);

1651 if–!
≠Shm
 )  
LSM_NOMEM_BKPT
;

1652 
db
->
≠Shm
 =ápShm;

1655 if–
db
->
bRoTøns
 ){

1656 
i
=
db
->
nShm
; 
rc
==
LSM_OK
 && i<
nChunk
; i++){

1657 
db
->
≠Shm
[
i
] = 
	`lsmMÆlocZîoRc
(
pEnv
, 
LSM_SHM_CHUNK_SIZE
, &
rc
);

1658 
db
->
nShm
++;

1664 
	`lsmMuãxE¡î
(
pEnv
, 
p
->
pClõ¡Muãx
);

1668 
nAŒoc
 = ((
p
->
nShmChunk
 + 
NINCR
 - 1) / NINCR) * NINCR;

1669  
nChunk
>=
nAŒoc
 ){

1670 **
≠Shm
;

1671 
nAŒoc
 +
NINCR
;

1672 
≠Shm
 = 
	`lsmRóŒoc
(
pEnv
, 
p
->
≠ShmChunk
, (*)*
nAŒoc
);

1673 if–!
≠Shm
 ){

1674 
rc
 = 
LSM_NOMEM_BKPT
;

1677 
p
->
≠ShmChunk
 = 
≠Shm
;

1680 
i
=
db
->
nShm
; 
rc
==
LSM_OK
 && i<
nChunk
; i++){

1681 if–
i
>=
p
->
nShmChunk
 ){

1682 *
pChunk
 = 0;

1683 if–
p
->
bMu…iProc
==0 ){

1685 
pChunk
 = 
	`lsmMÆlocZîoRc
(
pEnv
, 
LSM_SHM_CHUNK_SIZE
, &
rc
);

1688 
rc
 = 
	`lsmEnvShmM≠
(
pEnv
, 
p
->
pFûe
, 
i
, 
LSM_SHM_CHUNK_SIZE
, &
pChunk
);

1690 if–
rc
==
LSM_OK
 ){

1691 
p
->
≠ShmChunk
[
i
] = 
pChunk
;

1692 
p
->
nShmChunk
++;

1695 if–
rc
==
LSM_OK
 ){

1696 
db
->
≠Shm
[
i
] = 
p
->
≠ShmChunk
[i];

1697 
db
->
nShm
++;

1702 
	`lsmMuãxLóve
(
pEnv
, 
p
->
pClõ¡Muãx
);

1706  
rc
;

1707 
	}
}

1709 
	$lockSh¨edFûe
(
lsm_ív
 *
pEnv
, 
D©aba£
 *
p
, 
iLock
, 
eOp
){

1710 
rc
 = 
LSM_OK
;

1711 if–
p
->
bMu…iProc
 ){

1712 
rc
 = 
	`lsmEnvLock
(
pEnv
, 
p
->
pFûe
, 
iLock
, 
eOp
);

1714  
rc
;

1715 
	}
}

1728 
	$lsmShmTe°Lock
(

1729 
lsm_db
 *
db
,

1730 
iLock
,

1731 
nLock
,

1732 
eOp


1734 
rc
 = 
LSM_OK
;

1735 
lsm_db
 *
pIãr
;

1736 
D©aba£
 *
p
 = 
db
->
pD©aba£
;

1737 
i
;

1738 
u64
 
mask
 = 0;

1740 
i
=
iLock
; i<(iLock+
nLock
); i++){

1741 
mask
 |((
u64
)1 << (
iLock
-1));

1742 if–
eOp
==
LSM_LOCK_EXCL
 ) 
mask
 |((
u64
)1 << (
iLock
+32-1));

1745 
	`lsmMuãxE¡î
(
db
->
pEnv
, 
p
->
pClõ¡Muãx
);

1746 
pIãr
=
p
->
pC⁄n
;ÖIãr;ÖIãrıIãr->
pNext
){

1747 if–
pIãr
!=
db
 && (pIãr->
mLock
 & 
mask
) ) ;

1750 if–
pIãr
 ){

1751 
rc
 = 
LSM_BUSY
;

1752 }if–
p
->
bMu…iProc
 ){

1753 
rc
 = 
	`lsmEnvTe°Lock
(
db
->
pEnv
, 
p
->
pFûe
, 
iLock
, 
nLock
, 
eOp
);

1756 
	`lsmMuãxLóve
(
db
->
pEnv
, 
p
->
pClõ¡Muãx
);

1757  
rc
;

1758 
	}
}

1769 
	$lsmShmLock
(

1770 
lsm_db
 *
db
,

1771 
iLock
,

1772 
eOp
,

1773 
bBlock


1775 
lsm_db
 *
pIãr
;

1776 c⁄° 
u64
 
me
 = ((u64)1 << (
iLock
-1));

1777 c⁄° 
u64
 
ms
 = ((u64)1 << (
iLock
+32-1));

1778 
rc
 = 
LSM_OK
;

1779 
D©aba£
 *
p
 = 
db
->
pD©aba£
;

1781 
	`as£π
–
eOp
!=
LSM_LOCK_EXCL
 || 
p
->
bRód⁄ly
==0 );

1782 
	`as£π
–
iLock
>=1 && iLock<=
	`LSM_LOCK_RWCLIENT
(
LSM_LOCK_NRWCLIENT
-1) );

1783 
	`as£π
–
	`LSM_LOCK_RWCLIENT
(
LSM_LOCK_NRWCLIENT
-1)<=32 );

1784 
	`as£π
–
eOp
==
LSM_LOCK_UNLOCK
 ||ÉOp==
LSM_LOCK_SHARED
 ||ÉOp==
LSM_LOCK_EXCL
 );

1787 if–(
eOp
==
LSM_LOCK_UNLOCK
 && (
db
->
mLock
 & (
me
|
ms
))!=0)

1788 || (
eOp
==
LSM_LOCK_SHARED
 && (
db
->
mLock
 & (
me
|
ms
))!=ms)

1789 || (
eOp
==
LSM_LOCK_EXCL
 && (
db
->
mLock
 & 
me
)==0)

1791 
nEx˛
 = 0;

1792 
nSh¨ed
 = 0;

1793 
	`lsmMuãxE¡î
(
db
->
pEnv
, 
p
->
pClõ¡Muãx
);

1797 
pIãr
=
p
->
pC⁄n
;ÖIãr;ÖIãrıIãr->
pNext
){

1798 
	`as£π
–(
pIãr
->
mLock
 & 
me
)==0 || (pIãr->mLock & 
ms
)!=0 );

1799 if–
pIãr
!=
db
 ){

1800 if–
pIãr
->
mLock
 & 
me
 ){

1801 
nEx˛
++;

1802 }if–
pIãr
->
mLock
 & 
ms
 ){

1803 
nSh¨ed
++;

1807 
	`as£π
–
nEx˛
==0 ||ÇExcl==1 );

1808 
	`as£π
–
nEx˛
==0 || 
nSh¨ed
==0 );

1809 
	`as£π
–
nEx˛
==0 || (
db
->
mLock
 & (
me
|
ms
))==0 );

1811  
eOp
 ){

1812 
LSM_LOCK_UNLOCK
:

1813 if–
nSh¨ed
==0 ){

1814 
	`lockSh¨edFûe
(
db
->
pEnv
, 
p
, 
iLock
, 
LSM_LOCK_UNLOCK
);

1816 
db
->
mLock
 &~(
me
|
ms
);

1819 
LSM_LOCK_SHARED
:

1820 if–
nEx˛
 ){

1821 
rc
 = 
LSM_BUSY
;

1823 if–
nSh¨ed
==0 ){

1824 
rc
 = 
	`lockSh¨edFûe
(
db
->
pEnv
, 
p
, 
iLock
, 
LSM_LOCK_SHARED
);

1826 if–
rc
==
LSM_OK
 ){

1827 
db
->
mLock
 |
ms
;

1828 
db
->
mLock
 &~
me
;

1834 
	`as£π
–
eOp
==
LSM_LOCK_EXCL
 );

1835 if–
nEx˛
 || 
nSh¨ed
 ){

1836 
rc
 = 
LSM_BUSY
;

1838 
rc
 = 
	`lockSh¨edFûe
(
db
->
pEnv
, 
p
, 
iLock
, 
LSM_LOCK_EXCL
);

1839 if–
rc
==
LSM_OK
 ){

1840 
db
->
mLock
 |(
me
|
ms
);

1846 
	`lsmMuãxLóve
(
db
->
pEnv
, 
p
->
pClõ¡Muãx
);

1849  
rc
;

1850 
	}
}

1852 #ifde‡
LSM_DEBUG


1854 
	$shmLockTy≥
(
lsm_db
 *
db
, 
iLock
){

1855 c⁄° 
u64
 
me
 = ((u64)1 << (
iLock
-1));

1856 c⁄° 
u64
 
ms
 = ((u64)1 << (
iLock
+32-1));

1858 if–
db
->
mLock
 & 
me
 )  
LSM_LOCK_EXCL
;

1859 if–
db
->
mLock
 & 
ms
 )  
LSM_LOCK_SHARED
;

1860  
LSM_LOCK_UNLOCK
;

1861 
	}
}

1874 
	$lsmShmAs£πLock
(
lsm_db
 *
db
, 
iLock
, 
eOp
){

1875 
ªt
;

1876 
eHave
;

1878 
	`as£π
–
iLock
>=1 && iLock<=
	`LSM_LOCK_READER
(
LSM_LOCK_NREADER
-1) );

1879 
	`as£π
–
iLock
<=16 );

1880 
	`as£π
–
eOp
==
LSM_LOCK_UNLOCK
 ||ÉOp==
LSM_LOCK_SHARED
 ||ÉOp==
LSM_LOCK_EXCL
 );

1882 
eHave
 = 
	`shmLockTy≥
(
db
, 
iLock
);

1884  
eOp
 ){

1885 
LSM_LOCK_UNLOCK
:

1886 
ªt
 = (
eHave
==
LSM_LOCK_UNLOCK
);

1888 
LSM_LOCK_SHARED
:

1889 
ªt
 = (
eHave
!=
LSM_LOCK_UNLOCK
);

1891 
LSM_LOCK_EXCL
:

1892 
ªt
 = (
eHave
==
LSM_LOCK_EXCL
);

1895 
	`as£π
( !"badÉOp valueÖassedÅoÜsmShmAssertLock()" );

1899  
ªt
;

1900 
	}
}

1902 
	$lsmShmAs£πW‹kî
(
lsm_db
 *
db
){

1903  
	`lsmShmAs£πLock
(
db
, 
LSM_LOCK_WORKER
, 
LSM_LOCK_EXCL
Ë&& db->
pW‹kî
;

1904 
	}
}

1918 
	$¥öt_db_locks
(
lsm_db
 *
db
){

1919 
iLock
;

1920 
iLock
=0; iLock<16; iLock++){

1921 
bO√
 = 0;

1922 c⁄° *
azLock
[] = {0, "shared", "exclusive"};

1923 c⁄° *
azName
[] = {

1927 
eHave
 = 
	`shmLockTy≥
(
db
, 
iLock
);

1928 if–
azLock
[
eHave
] ){

1929 
	`¥ötf
("%s(%†⁄ %s)", (
bO√
?" ":""), 
azLock
[
eHave
], 
azName
[
iLock
]);

1930 
bO√
 = 1;

1933 
	`¥ötf
("\n");

1934 
	}
}

1935 
	$¥öt_Æl_db_locks
(
lsm_db
 *
db
){

1936 
lsm_db
 *
p
;

1937 
p
=
db
->
pD©aba£
->
pC⁄n
;Ö;Öı->
pNext
){

1938 
	`¥ötf
("%†c⁄√˘i⁄ %∞", ((
p
==
db
)?"*":""),Ö);

1939 
	`¥öt_db_locks
(
p
);

1941 
	}
}

1944 
	$lsmShmB¨rõr
(
lsm_db
 *
db
){

1945 
	`lsmEnvShmB¨rõr
(
db
->
pEnv
);

1946 
	}
}

1948 
	$lsm_checkpoöt
(
lsm_db
 *
pDb
, *
≤KB
){

1949 
rc
;

1950 
u32
 
nWrôe
 = 0;

1954 
rc
 = 
	`lsmCheckpoötWrôe
(
pDb
, 0, &
nWrôe
);

1958 if–
≤KB
 ){

1959 
nKB
 = 0;

1960 if–
rc
==
LSM_OK
 && 
nWrôe
 ){

1961 
nKB
 = (((
i64
)
nWrôe
 * 
	`lsmFsPageSize
(
pDb
->
pFS
)) + 1023) / 1024;

1963 *
≤KB
 = 
nKB
;

1966  
rc
;

1967 
	}
}

	@src/lsm_sorted.c

70 #i‚de‡
_LSM_INT_H


71 
	~"lsmI¡.h
"

73 
	~"sqlôe4.h
"

75 
	#LSM_LOG_STRUCTURE
 0

	)

76 
	#LSM_LOG_DATA
 0

	)

81 
	#πT›ic
(
eTy≥
Ë(”Ty≥Ë& 
LSM_SYSTEMKEY
)

	)

82 
	#πIsDñëe
(
eTy≥
Ë((”Ty≥Ë& 0x0F)==
LSM_POINT_DELETE
)

	)

84 
	#πIsSï¨©‹
(
eTy≥
Ë((”Ty≥Ë& 
LSM_SEPARATOR
)!=0)

	)

85 
	#πIsWrôe
(
eTy≥
Ë((”Ty≥Ë& 
LSM_INSERT
)!=0)

	)

86 
	#πIsSy°em
(
eTy≥
Ë((”Ty≥Ë& 
LSM_SYSTEMKEY
)!=0)

	)

91 
	#SEGMENT_NRECORD_OFFSET
(
pgsz
Ë(’gszË- 2)

	)

92 
	#SEGMENT_FLAGS_OFFSET
(
pgsz
Ë(’gszË- 2 - 2)

	)

93 
	#SEGMENT_POINTER_OFFSET
(
pgsz
Ë(’gszË- 2 - 2 - 8)

	)

94 
	#SEGMENT_CELLPTR_OFFSET
(
pgsz
, 
iCñl
Ë(’gszË- 2 - 2 - 8 - 2 - (iCñl)*2)

	)

96 
	#SEGMENT_EOF
(
pgsz
, 
nE¡ry
Ë
	`SEGMENT_CELLPTR_OFFSET
’gsz,ÇE¡ry)

	)

98 
	#SEGMENT_BTREE_FLAG
 0x0001

	)

99 
	#PGFTR_SKIP_NEXT_FLAG
 0x0002

	)

100 
	#PGFTR_SKIP_THIS_FLAG
 0x0004

	)

102 
SegmítPå
 
	tSegmítPå
;

103 
Blob
 
	tBlob
;

105 
	sBlob
 {

106 
lsm_ív
 *
	mpEnv
;

107 *
	mpD©a
;

108 
	mnD©a
;

109 
	mnAŒoc
;

120 
	sSegmítPå
 {

121 
Levñ
 *
	mpLevñ
;

122 
Segmít
 *
	mpSeg
;

125 
Page
 *
	mpPg
;

126 
u16
 
	mÊags
;

127 
	mnCñl
;

128 
Pgno
 
	miPå
;

131 
	miCñl
;

132 
	meTy≥
;

133 
Pgno
 
	miPgPå
;

134 *
	mpKey
; 
	mnKey
;

135 *
	mpVÆ
; 
	mnVÆ
;

138 
Blob
 
	mblob1
;

139 
Blob
 
	mblob2
;

153 
BåìPg
 
	tBåìPg
;

154 
BåìCurs‹
 
	tBåìCurs‹
;

155 
	sBåìPg
 {

156 
Page
 *
	mpPage
;

157 
	miCñl
;

159 
	sBåìCurs‹
 {

160 
Segmít
 *
	mpSeg
;

161 
FûeSy°em
 *
	mpFS
;

162 
	mnDïth
;

163 
	miPg
;

164 
BåìPg
 *
	maPg
;

167 *
	mpKey
;

168 
	mnKey
;

169 
	meTy≥
;

170 
Pgno
 
	miPå
;

173 
Blob
 
	mblob
;

196 
	sMu…iCurs‹
 {

197 
lsm_db
 *
	mpDb
;

198 
Mu…iCurs‹
 *
	mpNext
;

199 
	mÊags
;

201 
	meTy≥
;

202 
Blob
 
	mkey
;

203 
Blob
 
	mvÆ
;

206 
TªeCurs‹
 *
	m≠TªeC§
[2];

207 
	miFªe
;

208 
SegmítPå
 *
	maPå
;

209 
	mnPå
;

210 
BåìCurs‹
 *
	mpBtC§
;

213 
	mnTªe
;

214 *
	maTªe
;

217 *
	mpSy°emVÆ
;

220 
Pgno
 *
	mpPªvMîgePå
;

227 
	#CURSOR_DATA_TREE0
 0

	)

228 
	#CURSOR_DATA_TREE1
 1

	)

229 
	#CURSOR_DATA_SYSTEM
 2

	)

230 
	#CURSOR_DATA_SEGMENT
 3

	)

258 
	#CURSOR_IGNORE_DELETE
 0x00000001

	)

259 
	#CURSOR_FLUSH_FREELIST
 0x00000002

	)

260 
	#CURSOR_IGNORE_SYSTEM
 0x00000010

	)

261 
	#CURSOR_NEXT_OK
 0x00000020

	)

262 
	#CURSOR_PREV_OK
 0x00000040

	)

263 
	#CURSOR_READ_SEPARATORS
 0x00000080

	)

264 
	#CURSOR_SEEK_EQ
 0x00000100

	)

266 
MîgeW‹kî
 
	tMîgeW‹kî
;

267 
Hõørchy
 
	tHõørchy
;

269 
	sHõørchy
 {

270 
Page
 **
	m≠Hõr
;

271 
	mnHõr
;

286 
	sMîgeW‹kî
 {

287 
lsm_db
 *
	mpDb
;

288 
Levñ
 *
	mpLevñ
;

289 
Mu…iCurs‹
 *
	mpC§
;

290 
	mbFlush
;

291 
Hõørchy
 
	mhõr
;

292 
Page
 *
	mpPage
;

293 
	mnW‹k
;

294 
Pgno
 *
	maGobbÀ
;

296 
Pgno
 
	miIndúe˘
;

297 
	sSavedPgno
 {

298 
Pgno
 
	miPgno
;

299 
	mbSt‹e
;

300 } 
	maSave
[2];

303 #ifde‡
LSM_DEBUG_EXPENSIVE


304 
as£πPoöãrsOk
(
lsm_db
 *, 
Segmít
 *, Segment *, );

305 
as£πBåìOk
(
lsm_db
 *, 
Segmít
 *);

306 
as£πRunInOrdî
(
lsm_db
 *
pDb
, 
Segmít
 *
pSeg
);

308 
	#as£πRunInOrdî
(
x
,
y
)

	)

309 
	#as£πBåìOk
(
x
,
y
)

	)

313 
	sFûePage
 { 
u8
 *
	maD©a
; 
	mnD©a
; };

314 
u8
 *
	$fsPageD©a
(
Page
 *
pPg
, *
≤D©a
){

315 *
≤D©a
 = ((
FûePage
 *)(
pPg
))->
nD©a
;

316  ((
FûePage
 *)(
pPg
))->
aD©a
;

317 
	}
}

325 
	$lsmPutU16
(
u8
 *
aOut
, 
u16
 
nVÆ
){

326 
aOut
[0] = (
u8
)((
nVÆ
>>8) & 0xFF);

327 
aOut
[1] = (
u8
)(
nVÆ
 & 0xFF);

328 
	}
}

330 
	$lsmPutU32
(
u8
 *
aOut
, 
u32
 
nVÆ
){

331 
aOut
[0] = (
u8
)((
nVÆ
>>24) & 0xFF);

332 
aOut
[1] = (
u8
)((
nVÆ
>>16) & 0xFF);

333 
aOut
[2] = (
u8
)((
nVÆ
>> 8) & 0xFF);

334 
aOut
[3] = (
u8
)((
nVÆ
 ) & 0xFF);

335 
	}
}

337 
	$lsmGëU16
(
u8
 *
aOut
){

338  (
aOut
[0] << 8) +áOut[1];

339 
	}
}

341 
u32
 
	$lsmGëU32
(
u8
 *
aOut
){

342  ((
u32
)
aOut
[0] << 24)

343 + ((
u32
)
aOut
[1] << 16)

344 + ((
u32
)
aOut
[2] << 8)

345 + ((
u32
)
aOut
[3]);

346 
	}
}

348 
u64
 
	$lsmGëU64
(
u8
 *
aOut
){

349  ((
u64
)
aOut
[0] << 56)

350 + ((
u64
)
aOut
[1] << 48)

351 + ((
u64
)
aOut
[2] << 40)

352 + ((
u64
)
aOut
[3] << 32)

353 + ((
u64
)
aOut
[4] << 24)

354 + ((
u32
)
aOut
[5] << 16)

355 + ((
u32
)
aOut
[6] << 8)

356 + ((
u32
)
aOut
[7]);

357 
	}
}

359 
	$lsmPutU64
(
u8
 *
aOut
, 
u64
 
nVÆ
){

360 
aOut
[0] = (
u8
)((
nVÆ
>>56) & 0xFF);

361 
aOut
[1] = (
u8
)((
nVÆ
>>48) & 0xFF);

362 
aOut
[2] = (
u8
)((
nVÆ
>>40) & 0xFF);

363 
aOut
[3] = (
u8
)((
nVÆ
>>32) & 0xFF);

364 
aOut
[4] = (
u8
)((
nVÆ
>>24) & 0xFF);

365 
aOut
[5] = (
u8
)((
nVÆ
>>16) & 0xFF);

366 
aOut
[6] = (
u8
)((
nVÆ
>> 8) & 0xFF);

367 
aOut
[7] = (
u8
)((
nVÆ
 ) & 0xFF);

368 
	}
}

370 
	$s‹ãdBlobGrow
(
lsm_ív
 *
pEnv
, 
Blob
 *
pBlob
, 
nD©a
){

371 
	`as£π
–
pBlob
->
pEnv
=ıEnv || (pBlob->pEnv==0 &&ÖBlob->
pD©a
==0) );

372 if–
pBlob
->
nAŒoc
<
nD©a
 ){

373 
pBlob
->
pD©a
 = 
	`lsmRóŒocOrFªe
(
pEnv
,ÖBlob->pD©a, 
nD©a
);

374 if–!
pBlob
->
pD©a
 )  
LSM_NOMEM_BKPT
;

375 
pBlob
->
nAŒoc
 = 
nD©a
;

376 
pBlob
->
pEnv
 =ÖEnv;

378  
LSM_OK
;

379 
	}
}

381 
	$s‹ãdBlobSë
(
lsm_ív
 *
pEnv
, 
Blob
 *
pBlob
, *
pD©a
, 
nD©a
){

382 if–
	`s‹ãdBlobGrow
(
pEnv
, 
pBlob
, 
nD©a
ËË 
LSM_NOMEM
;

383 
	`mem˝y
(
pBlob
->
pD©a
,ÖD©a, 
nD©a
);

384 
pBlob
->
nD©a
 =ÇData;

385  
LSM_OK
;

386 
	}
}

389 
	$s‹ãdBlobC›y
(
Blob
 *
pDe°
, Blob *
pSrc
){

390  
	`s‹ãdBlobSë
(
pDe°
, 
pSrc
->
pD©a
,ÖSrc->
nD©a
);

391 
	}
}

394 
	$s‹ãdBlobFªe
(
Blob
 *
pBlob
){

395 
	`as£π
–
pBlob
->
pEnv
 ||ÖBlob->
pD©a
==0 );

396 if–
pBlob
->
pD©a
 ) 
	`lsmFªe
’Blob->
pEnv
,ÖBlob->pData);

397 
	`mem£t
(
pBlob
, 0, (
Blob
));

398 
	}
}

400 
	$s‹ãdRódD©a
(

401 
Segmít
 *
pSeg
,

402 
Page
 *
pPg
,

403 
iOff
,

404 
nByã
,

405 **
µD©a
,

406 
Blob
 *
pBlob


408 
rc
 = 
LSM_OK
;

409 
iEnd
;

410 
nD©a
;

411 
nCñl
;

412 
u8
 *
aD©a
;

414 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

415 
nCñl
 = 
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)]);

416 
iEnd
 = 
	`SEGMENT_EOF
(
nD©a
, 
nCñl
);

417 
	`as£π
–
iEnd
>0 && iEnd<
nD©a
 );

419 if–
iOff
+
nByã
<=
iEnd
 ){

420 *
µD©a
 = (*)&
aD©a
[
iOff
];

422 
nRem
 = 
nByã
;

423 
i
 = 
iOff
;

424 
u8
 *
aDe°
;

427 
rc
 = 
	`s‹ãdBlobGrow
(
	`lsmPageEnv
(
pPg
), 
pBlob
, 
nByã
);

428 if–
rc
!=
LSM_OK
 ) Ñc;

429 
pBlob
->
nD©a
 = 
nByã
;

430 
aDe°
 = (
u8
 *)
pBlob
->
pD©a
;

431 *
µD©a
 = 
pBlob
->
pD©a
;

434 
	`lsmFsPageRef
(
pPg
);

436  
rc
==
LSM_OK
 ){

437 
Page
 *
pNext
;

438 
Êags
;

441 
nC›y
 = 
	`LSM_MIN
(
nRem
, 
iEnd
-
i
);

442 if–
nC›y
>0 ){

443 
	`mem˝y
(&
aDe°
[
nByã
-
nRem
], &
aD©a
[
i
], 
nC›y
);

444 
nRem
 -
nC›y
;

445 
i
 +
nC›y
;

446 
	`as£π
–
nRem
==0 || 
i
==
iEnd
 );

448 
	`as£π
–
nRem
>=0 );

449 if–
nRem
==0 ) ;

450 
i
 -
iEnd
;

455 
rc
 = 
	`lsmFsDbPageNext
(
pSeg
, 
pPg
, 1, &
pNext
);

456 if–
rc
==
LSM_OK
 && 
pNext
==0 ){

457 
rc
 = 
LSM_CORRUPT_BKPT
;

459 if–
rc
 ) ;

460 
	`lsmFsPageRñó£
(
pPg
);

461 
pPg
 = 
pNext
;

462 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

463 
Êags
 = 
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_FLAGS_OFFSET
(
nD©a
)]);

464 } 
Êags
&
SEGMENT_BTREE_FLAG
 );

466 
iEnd
 = 
	`SEGMENT_EOF
(
nD©a
, 
	`lsmGëU16
(&
aD©a
[nData-2]));

467 
	`as£π
–
iEnd
>0 && iEnd<
nD©a
 );

470 
	`lsmFsPageRñó£
(
pPg
);

473  
rc
;

474 
	}
}

476 
	$∑geGëNRec
(
u8
 *
aD©a
, 
nD©a
){

477  ()
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)]);

478 
	}
}

480 
Pgno
 
	$∑geGëPå
(
u8
 *
aD©a
, 
nD©a
){

481  (
Pgno
)
	`lsmGëU64
(&
aD©a
[
	`SEGMENT_POINTER_OFFSET
(
nD©a
)]);

482 
	}
}

484 
	$∑geGëFœgs
(
u8
 *
aD©a
, 
nD©a
){

485  ()
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_FLAGS_OFFSET
(
nD©a
)]);

486 
	}
}

488 
u8
 *
	$∑geGëCñl
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
){

489  &
aD©a
[
	`lsmGëU16
(&aD©a[
	`SEGMENT_CELLPTR_OFFSET
(
nD©a
, 
iCñl
)])];

490 
	}
}

495 
	$∑geObjGëNRec
(
Page
 *
pPg
){

496 
nD©a
;

497 
u8
 *
aD©a
 = 
	`lsmFsPageD©a
(
pPg
, &
nD©a
);

498  
	`∑geGëNRec
(
aD©a
, 
nD©a
);

499 
	}
}

505 
Pgno
 
	$∑geGëRec‹dPå
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
){

506 
Pgno
 
iRë
;

507 
u8
 *
aCñl
;

509 
	`as£π
–
iCñl
<
	`∑geGëNRec
(
aD©a
, 
nD©a
) && iCell>=0 );

510 
aCñl
 = 
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
iCñl
);

511 
	`lsmV¨ötGë64
(&
aCñl
[1], &
iRë
);

512  
iRë
;

513 
	}
}

515 
u8
 *
	$∑geGëKey
(

516 
Segmít
 *
pSeg
,

517 
Page
 *
pPg
,

518 
iCñl
,

519 *
piT›ic
,

520 *
≤Key
,

521 
Blob
 *
pBlob


523 
u8
 *
pKey
;

524 
nDummy
;

525 
eTy≥
;

526 
u8
 *
aD©a
;

527 
nD©a
;

529 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

531 
	`as£π
–!(
	`∑geGëFœgs
(
aD©a
, 
nD©a
Ë& 
SEGMENT_BTREE_FLAG
) );

532 
	`as£π
–
iCñl
<
	`∑geGëNRec
(
aD©a
, 
nD©a
) );

534 
pKey
 = 
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
iCñl
);

535 
eTy≥
 = *
pKey
++;

536 
pKey
 +
	`lsmV¨ötGë32
’Key, &
nDummy
);

537 
pKey
 +
	`lsmV¨ötGë32
’Key, 
≤Key
);

538 if–
	`πIsWrôe
(
eTy≥
) ){

539 
pKey
 +
	`lsmV¨ötGë32
’Key, &
nDummy
);

541 *
piT›ic
 = 
	`πT›ic
(
eTy≥
);

543 
	`s‹ãdRódD©a
(
pSeg
, 
pPg
, 
pKey
-
aD©a
, *
≤Key
, (**)&pKey, 
pBlob
);

544  
pKey
;

545 
	}
}

547 
	$∑geGëKeyC›y
(

548 
lsm_ív
 *
pEnv
,

549 
Segmít
 *
pSeg
,

550 
Page
 *
pPg
,

551 
iCñl
,

552 *
piT›ic
,

553 
Blob
 *
pBlob


555 
rc
 = 
LSM_OK
;

556 
nKey
;

557 
u8
 *
aKey
;

559 
aKey
 = 
	`∑geGëKey
(
pSeg
, 
pPg
, 
iCñl
, 
piT›ic
, &
nKey
, 
pBlob
);

560 
	`as£π
–(*)
aKey
!=
pBlob
->
pD©a
 || 
nKey
=ıBlob->
nD©a
 );

561 if–(*)
aKey
!=
pBlob
->
pD©a
 ){

562 
rc
 = 
	`s‹ãdBlobSë
(
pEnv
, 
pBlob
, 
aKey
, 
nKey
);

565  
rc
;

566 
	}
}

568 
Pgno
 
	$∑geGëBåìRef
(
Page
 *
pPg
, 
iKey
){

569 
Pgno
 
iRef
;

570 
u8
 *
aD©a
;

571 
nD©a
;

572 
u8
 *
aCñl
;

574 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

575 
aCñl
 = 
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
iKey
);

576 
	`as£π
–
aCñl
[0]==0 );

577 
aCñl
++;

578 
aCñl
 +
	`lsmV¨ötGë64
◊Cñl, &
iRef
);

579 
	`lsmV¨ötGë64
(
aCñl
, &
iRef
);

580 
	`as£π
–
iRef
>0 );

581  
iRef
;

582 
	}
}

584 
	#GETVARINT64
(
a
, 
i
Ë(((i)=((
u8
*)◊))[0])<=240?1:
	`lsmV¨ötGë64
(◊), &(i)))

	)

585 
	#GETVARINT32
(
a
, 
i
Ë(((i)=((
u8
*)◊))[0])<=240?1:
	`lsmV¨ötGë32
(◊), &(i)))

	)

587 
	$∑geGëBåìKey
(

588 
Segmít
 *
pSeg
,

589 
Page
 *
pPg
,

590 
iKey
,

591 
Pgno
 *
piPå
,

592 *
piT›ic
,

593 **
µKey
,

594 *
≤Key
,

595 
Blob
 *
pBlob


597 
u8
 *
aD©a
;

598 
nD©a
;

599 
u8
 *
aCñl
;

600 
eTy≥
;

602 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

603 
	`as£π
–
SEGMENT_BTREE_FLAG
 & 
	`∑geGëFœgs
(
aD©a
, 
nD©a
) );

604 
	`as£π
–
iKey
>=0 && iKey<
	`∑geGëNRec
(
aD©a
, 
nD©a
) );

606 
aCñl
 = 
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
iKey
);

607 
eTy≥
 = *
aCñl
++;

608 
aCñl
 +
	`GETVARINT64
◊Cñl, *
piPå
);

610 if–
eTy≥
==0 ){

611 
rc
;

612 
Pgno
 
iRef
;

613 
Page
 *
pRef
;

614 
aCñl
 +
	`GETVARINT64
◊Cñl, 
iRef
);

615 
rc
 = 
	`lsmFsDbPageGë
(
	`lsmPageFS
(
pPg
), 
pSeg
, 
iRef
, &
pRef
);

616 if–
rc
!=
LSM_OK
 ) Ñc;

617 
	`∑geGëKeyC›y
(
	`lsmPageEnv
(
pPg
), 
pSeg
, 
pRef
, 0, &
eTy≥
, 
pBlob
);

618 
	`lsmFsPageRñó£
(
pRef
);

619 *
µKey
 = 
pBlob
->
pD©a
;

620 *
≤Key
 = 
pBlob
->
nD©a
;

622 
aCñl
 +
	`GETVARINT32
◊Cñl, *
≤Key
);

623 *
µKey
 = 
aCñl
;

625 if–
piT›ic
 ) *piT›i¯
	`πT›ic
(
eTy≥
);

627  
LSM_OK
;

628 
	}
}

630 
	$båìCurs‹LﬂdKey
(
BåìCurs‹
 *
pC§
){

631 
rc
 = 
LSM_OK
;

632 if–
pC§
->
iPg
<0 ){

633 
pC§
->
pKey
 = 0;

634 
pC§
->
nKey
 = 0;

635 
pC§
->
eTy≥
 = 0;

637 
Pgno
 
dummy
;

638 
iPg
 = 
pC§
->iPg;

639 
iCñl
 = 
pC§
->
aPg
[
iPg
].iCell;

640  
iCñl
<0 && (--
iPg
)>=0 ){

641 
iCñl
 = 
pC§
->
aPg
[
iPg
].iCell-1;

643 if–
iPg
<0 || 
iCñl
<0 )  
LSM_CORRUPT_BKPT
;

645 
rc
 = 
	`∑geGëBåìKey
(

646 
pC§
->
pSeg
,

647 
pC§
->
aPg
[
iPg
].
pPage
, 
iCñl
,

648 &
dummy
, &
pC§
->
eTy≥
, &pC§->
pKey
, &pC§->
nKey
, &pC§->
blob


650 
pC§
->
eTy≥
 |
LSM_SEPARATOR
;

653  
rc
;

654 
	}
}

656 
	$båìCurs‹På
(
u8
 *
aD©a
, 
nD©a
, 
iCñl
){

657 
nCñl
;

659 
nCñl
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

660 if–
iCñl
>=
nCñl
 ){

661  
	`∑geGëPå
(
aD©a
, 
nD©a
);

663  
	`∑geGëRec‹dPå
(
aD©a
, 
nD©a
, 
iCñl
);

664 
	}
}

666 
	$båìCurs‹Next
(
BåìCurs‹
 *
pC§
){

667 
rc
 = 
LSM_OK
;

669 
BåìPg
 *
pPg
 = &
pC§
->
aPg
[pC§->
iPg
];

670 
nCñl
;

671 
u8
 *
aD©a
;

672 
nD©a
;

674 
	`as£π
–
pC§
->
iPg
>=0 );

675 
	`as£π
–
pC§
->
iPg
=ıC§->
nDïth
-1 );

677 
aD©a
 = 
	`fsPageD©a
(
pPg
->
pPage
, &
nD©a
);

678 
nCñl
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

679 
	`as£π
–
pPg
->
iCñl
<=
nCñl
 );

680 
pPg
->
iCñl
++;

681 if–
pPg
->
iCñl
==
nCñl
 ){

682 
Pgno
 
iLﬂd
;

685 
	`lsmFsPageRñó£
(
pPg
->
pPage
);

686 
pPg
->
pPage
 = 0;

687 
pC§
->
iPg
--;

688  
pC§
->
iPg
>=0 ){

689 
pPg
 = &
pC§
->
aPg
[pC§->
iPg
];

690 
aD©a
 = 
	`fsPageD©a
(
pPg
->
pPage
, &
nD©a
);

691 if–
pPg
->
iCñl
<
	`∑geGëNRec
(
aD©a
, 
nD©a
) ) ;

692 
	`lsmFsPageRñó£
(
pPg
->
pPage
);

693 
pC§
->
iPg
--;

697 
rc
 = 
	`båìCurs‹LﬂdKey
(
pC§
);

701 if–
pC§
->
iPg
>=0 ){

702 
pC§
->
aPg
[pC§->
iPg
].
iCñl
++;

704 
iLﬂd
 = 
	`båìCurs‹På
(
aD©a
, 
nD©a
, 
pPg
->
iCñl
);

706 
Page
 *
pLﬂd
;

707 
pC§
->
iPg
++;

708 
rc
 = 
	`lsmFsDbPageGë
(
pC§
->
pFS
,ÖC§->
pSeg
, 
iLﬂd
, &
pLﬂd
);

709 
pC§
->
aPg
[pC§->
iPg
].
pPage
 = 
pLﬂd
;

710 
pC§
->
aPg
[pC§->
iPg
].
iCñl
 = 0;

711 if–
rc
==
LSM_OK
 ){

712 if–
pC§
->
iPg
==’C§->
nDïth
-1) ) ;

713 
aD©a
 = 
	`fsPageD©a
(
pLﬂd
, &
nD©a
);

714 
iLﬂd
 = 
	`båìCurs‹På
(
aD©a
, 
nD©a
, 0);

716 } 
rc
==
LSM_OK
 && 
pC§
->
iPg
<’C§->
nDïth
-1) );

717 
pC§
->
aPg
[pC§->
iPg
].
iCñl
 = -1;

721 
rc
 = 
	`båìCurs‹LﬂdKey
(
pC§
);

724 if–
rc
==
LSM_OK
 && 
pC§
->
iPg
>=0 ){

725 
aD©a
 = 
	`fsPageD©a
(
pC§
->
aPg
[pC§->
iPg
].
pPage
, &
nD©a
);

726 
pC§
->
iPå
 = 
	`båìCurs‹På
(
aD©a
, 
nD©a
,ÖC§->
aPg
[pC§->
iPg
].
iCñl
+1);

729  
rc
;

730 
	}
}

732 
	$båìCurs‹Fªe
(
BåìCurs‹
 *
pC§
){

733 if–
pC§
 ){

734 
i
;

735 
lsm_ív
 *
pEnv
 = 
	`lsmFsEnv
(
pC§
->
pFS
);

736 
i
=0; i<=
pC§
->
iPg
; i++){

737 
	`lsmFsPageRñó£
(
pC§
->
aPg
[
i
].
pPage
);

739 
	`s‹ãdBlobFªe
(&
pC§
->
blob
);

740 
	`lsmFªe
(
pEnv
, 
pC§
->
aPg
);

741 
	`lsmFªe
(
pEnv
, 
pC§
);

743 
	}
}

745 
	$båìCurs‹Fú°
(
BåìCurs‹
 *
pC§
){

746 
rc
;

748 
Page
 *
pPg
 = 0;

749 
FûeSy°em
 *
pFS
 = 
pC§
->pFS;

750 
iPg
 = 
pC§
->
pSeg
->
iRoŸ
;

753 
rc
 = 
	`lsmFsDbPageGë
(
pFS
, 
pC§
->
pSeg
, 
iPg
, &
pPg
);

754 
	`as£π
–(
rc
==
LSM_OK
)==(
pPg
!=0) );

755 if–
rc
==
LSM_OK
 ){

756 
u8
 *
aD©a
;

757 
nD©a
;

758 
Êags
;

760 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

761 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

762 if–(
Êags
 & 
SEGMENT_BTREE_FLAG
)==0 ) ;

764 if–(
pC§
->
nDïth
 % 8)==0 ){

765 
nNew
 = 
pC§
->
nDïth
 + 8;

766 
pC§
->
aPg
 = (
BåìPg
 *)
	`lsmRóŒocOrFªeRc
(

767 
	`lsmFsEnv
(
pFS
), 
pC§
->
aPg
, (
BåìPg
Ë* 
nNew
, &
rc


769 if–
rc
==
LSM_OK
 ){

770 
	`mem£t
(&
pC§
->
aPg
[pC§->
nDïth
], 0, (
BåìPg
) * 8);

774 if–
rc
==
LSM_OK
 ){

775 
	`as£π
–
pC§
->
aPg
[pC§->
nDïth
].
iCñl
==0 );

776 
pC§
->
aPg
[pC§->
nDïth
].
pPage
 = 
pPg
;

777 
pC§
->
nDïth
++;

778 
iPg
 = 
	`∑geGëRec‹dPå
(
aD©a
, 
nD©a
, 0);

781 } 
rc
==
LSM_OK
 );

782 
	`lsmFsPageRñó£
(
pPg
);

783 
pC§
->
iPg
 =ÖC§->
nDïth
-1;

785 if–
rc
==
LSM_OK
 && 
pC§
->
nDïth
 ){

786 
pC§
->
aPg
[pC§->
iPg
].
iCñl
 = -1;

787 
rc
 = 
	`båìCurs‹Next
(
pC§
);

790  
rc
;

791 
	}
}

793 
	$båìCurs‹Posôi⁄
(
BåìCurs‹
 *
pC§
, 
MîgeI≈ut
 *
p
){

794 if–
pC§
->
iPg
>=0 ){

795 
p
->
iPg
 = 
	`lsmFsPageNumbî
(
pC§
->
aPg
[pC§->iPg].
pPage
);

796 
p
->
iCñl
 = ((
pC§
->
aPg
[pC§->
iPg
].iCñ»+ 1Ë<< 8Ë+ÖC§->
nDïth
;

798 
p
->
iPg
 = 0;

799 
p
->
iCñl
 = 0;

801 
	}
}

803 
	$båìCurs‹S∂ôkey
(
BåìCurs‹
 *
pC§
, 
MîgeI≈ut
 *
p
){

804 
iCñl
 = 
pC§
->
aPg
[pC§->
iPg
].iCell;

805 if–
iCñl
>=0 ){

806 
p
->
iCñl
 = iCell;

807 
p
->
iPg
 = 
	`lsmFsPageNumbî
(
pC§
->
aPg
[pC§->iPg].
pPage
);

809 
i
;

810 
i
=
pC§
->
iPg
-1; i>=0; i--){

811 if–
pC§
->
aPg
[
i
].
iCñl
>0 ) ;

813 
	`as£π
–
i
>=0 );

814 
p
->
iCñl
 = 
pC§
->
aPg
[
i
].iCell-1;

815 
p
->
iPg
 = 
	`lsmFsPageNumbî
(
pC§
->
aPg
[
i
].
pPage
);

817 
	}
}

819 
s‹ãdKeyCom∑ª
(

820 (*
xCmp
)(*, , *, ),

821 
iLhsT›ic
, *
pLhsKey
, 
nLhsKey
,

822 
iRhsT›ic
, *
pRhsKey
, 
nRhsKey


824 
ªs
 = 
iLhsT›ic
 - 
iRhsT›ic
;

825 if–
ªs
==0 ){

826 
ªs
 = 
	`xCmp
(
pLhsKey
, 
nLhsKey
, 
pRhsKey
, 
nRhsKey
);

828  
ªs
;

829 
	}
}

831 
båìCurs‹Re°‹e
(

832 
BåìCurs‹
 *
pC§
,

833 (*
xCmp
)(*, , *, ),

834 
MîgeI≈ut
 *
p


836 
rc
 = 
LSM_OK
;

838 if–
p
->
iPg
 ){

839 
lsm_ív
 *
pEnv
 = 
	`lsmFsEnv
(
pC§
->
pFS
);

840 
iCñl
;

841 
Pgno
 
iLóf
;

842 
nDïth
;

843 
Segmít
 *
pSeg
 = 
pC§
->pSeg;

846 
iLóf
 = 
p
->
iPg
;

847 
nDïth
 = (
p
->
iCñl
 & 0x00FF);

848 
iCñl
 = (
p
->iCell >> 8) - 1;

851 
	`as£π
–
pC§
->
aPg
==0 );

852 
pC§
->
aPg
 = (
BåìPg
 *)
	`lsmMÆlocZîoRc
(
pEnv
, (BåìPgË* 
nDïth
, &
rc
);

855 if–
rc
==
LSM_OK
 ){

856 
Page
 **
µ
 = &
pC§
->
aPg
[
nDïth
-1].
pPage
;

857 
pC§
->
iPg
 = 
nDïth
-1;

858 
pC§
->
nDïth
 =ÇDepth;

859 
pC§
->
aPg
[pC§->
iPg
].
iCñl
 = iCell;

860 
rc
 = 
	`lsmFsDbPageGë
(
pC§
->
pFS
, 
pSeg
, 
iLóf
, 
µ
);

864 if–
rc
==
LSM_OK
 && 
nDïth
>1 ){

865 
Blob
 
blob
 = {0,0,0};

866 *
pSìk
;

867 
nSìk
;

868 
iT›icSìk
;

869 
iPg
 = 0;

870 
iLﬂd
 = 
pSeg
->
iRoŸ
;

871 
Page
 *
pPg
 = 
pC§
->
aPg
[
nDïth
-1].
pPage
;

873 if–
	`∑geObjGëNRec
(
pPg
)==0 ){

877 
	`as£π
–
iCñl
==-1 );

878 
iT›icSìk
 = 1000;

879 
pSìk
 = 0;

880 
nSìk
 = 0;

882 
Pgno
 
dummy
;

883 
rc
 = 
	`∑geGëBåìKey
(
pSeg
, 
pPg
,

884 0, &
dummy
, &
iT›icSìk
, &
pSìk
, &
nSìk
, &
pC§
->
blob


889 
Page
 *
pPg
;

890 
rc
 = 
	`lsmFsDbPageGë
(
pC§
->
pFS
, 
pSeg
, 
iLﬂd
, &
pPg
);

891 
	`as£π
–
rc
==
LSM_OK
 || 
pPg
==0 );

892 if–
rc
==
LSM_OK
 ){

893 
u8
 *
aD©a
;

894 
nD©a
;

895 
iMö
;

896 
iMax
;

897 
iCñl
;

899 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

900 
	`as£π
–(
	`∑geGëFœgs
(
aD©a
, 
nD©a
Ë& 
SEGMENT_BTREE_FLAG
) );

902 
iLﬂd
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

903 
iCñl
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

904 
iMax
 = 
iCñl
-1;

905 
iMö
 = 0;

907  
iMax
>=
iMö
 ){

908 
iTry
 = (
iMö
+
iMax
)/2;

909 *
pKey
; 
nKey
;

910 
iT›ic
;

911 
Pgno
 
iPå
;

912 
ªs
;

914 
rc
 = 
	`∑geGëBåìKey
(

915 
pSeg
, 
pPg
, 
iTry
, &
iPå
, &
iT›ic
, &
pKey
, &
nKey
, &
blob


917 if–
rc
!=
LSM_OK
 ) ;

919 
ªs
 = 
	`s‹ãdKeyCom∑ª
(

920 
xCmp
, 
iT›icSìk
, 
pSìk
, 
nSìk
, 
iT›ic
, 
pKey
, 
nKey


922 
	`as£π
–
ªs
!=0 );

924 if–
ªs
<0 ){

925 
iLﬂd
 = 
iPå
;

926 
iCñl
 = 
iTry
;

927 
iMax
 = 
iTry
-1;

929 
iMö
 = 
iTry
+1;

933 
pC§
->
aPg
[
iPg
].
pPage
 = 
pPg
;

934 
pC§
->
aPg
[
iPg
].
iCñl
 = iCell;

935 
iPg
++;

936 
	`as£π
–
iPg
!=
nDïth
-1

937 || 
	`lsmFsRedúe˘Page
(
pC§
->
pFS
, 
pSeg
->
pRedúe˘
, 
iLﬂd
)==
iLóf


940 } 
rc
==
LSM_OK
 && 
iPg
<(
nDïth
-1) );

941 
	`s‹ãdBlobFªe
(&
blob
);

945 if–
rc
==
LSM_OK
 ){

946 
BåìPg
 *
pBåìPg
;

947 
u8
 *
aD©a
;

948 
nD©a
;

950 
pBåìPg
 = &
pC§
->
aPg
[pC§->
iPg
];

951 
aD©a
 = 
	`fsPageD©a
(
pBåìPg
->
pPage
, &
nD©a
);

952 
pC§
->
iPå
 = 
	`båìCurs‹På
(
aD©a
, 
nD©a
, 
pBåìPg
->
iCñl
+1);

953 if–
pBåìPg
->
iCñl
<0 ){

954 
Pgno
 
dummy
;

955 
i
;

956 
i
=
pC§
->
iPg
-1; i>=0; i--){

957 if–
pC§
->
aPg
[
i
].
iCñl
>0 ) ;

959 
	`as£π
–
i
>=0 );

960 
rc
 = 
	`∑geGëBåìKey
(
pSeg
,

961 
pC§
->
aPg
[
i
].
pPage
,ÖC§->aPg[i].
iCñl
-1,

962 &
dummy
, &
pC§
->
eTy≥
, &pC§->
pKey
, &pC§->
nKey
, &pC§->
blob


964 
pC§
->
eTy≥
 |
LSM_SEPARATOR
;

967 
rc
 = 
	`båìCurs‹LﬂdKey
(
pC§
);

971  
rc
;

972 
	}
}

974 
	$båìCurs‹New
(

975 
lsm_db
 *
pDb
,

976 
Segmít
 *
pSeg
,

977 
BåìCurs‹
 **
µC§


979 
rc
 = 
LSM_OK
;

980 
BåìCurs‹
 *
pC§
;

982 
	`as£π
–
pSeg
->
iRoŸ
 );

983 
pC§
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
BåìCurs‹
), &
rc
);

984 if–
pC§
 ){

985 
pC§
->
pFS
 = 
pDb
->pFS;

986 
pC§
->
pSeg
 =ÖSeg;

987 
pC§
->
iPg
 = -1;

990 *
µC§
 = 
pC§
;

991  
rc
;

992 
	}
}

994 
	$£gmítPåSëPage
(
SegmítPå
 *
pPå
, 
Page
 *
pNext
){

995 
	`lsmFsPageRñó£
(
pPå
->
pPg
);

996 if–
pNext
 ){

997 
nD©a
;

998 
u8
 *
aD©a
 = 
	`fsPageD©a
(
pNext
, &
nD©a
);

999 
pPå
->
nCñl
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

1000 
pPå
->
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

1001 
pPå
->
iPå
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

1003 
pPå
->
pPg
 = 
pNext
;

1004 
	}
}

1009 
	$£gmítPåLﬂdPage
(

1010 
FûeSy°em
 *
pFS
,

1011 
SegmítPå
 *
pPå
,

1012 
iNew


1014 
Page
 *
pPg
 = 0;

1015 
rc
;

1017 
rc
 = 
	`lsmFsDbPageGë
(
pFS
, 
pPå
->
pSeg
, 
iNew
, &
pPg
);

1018 
	`as£π
–
rc
==
LSM_OK
 || 
pPg
==0 );

1019 
	`£gmítPåSëPage
(
pPå
, 
pPg
);

1021  
rc
;

1022 
	}
}

1024 
	$£gmítPåRódD©a
(

1025 
SegmítPå
 *
pPå
,

1026 
iOff
,

1027 
nByã
,

1028 **
µD©a
,

1029 
Blob
 *
pBlob


1031  
	`s‹ãdRódD©a
(
pPå
->
pSeg
,ÖPå->
pPg
, 
iOff
, 
nByã
, 
µD©a
, 
pBlob
);

1032 
	}
}

1034 
	$£gmítPåNextPage
(

1035 
SegmítPå
 *
pPå
,

1036 
eDú


1038 
Page
 *
pNext
;

1039 
rc
;

1041 
	`as£π
–
eDú
==1 ||ÉDir==-1 );

1042 
	`as£π
–
pPå
->
pPg
 );

1043 
	`as£π
–
pPå
->
pSeg
 || 
eDú
>0 );

1045 
rc
 = 
	`lsmFsDbPageNext
(
pPå
->
pSeg
,ÖPå->
pPg
, 
eDú
, &
pNext
);

1046 
	`as£π
–
rc
==
LSM_OK
 || 
pNext
==0 );

1047 
	`£gmítPåSëPage
(
pPå
, 
pNext
);

1048  
rc
;

1049 
	}
}

1051 
	$£gmítPåLﬂdCñl
(

1052 
SegmítPå
 *
pPå
,

1053 
iNew


1055 
rc
 = 
LSM_OK
;

1056 if–
pPå
->
pPg
 ){

1057 
u8
 *
aD©a
;

1058 
iOff
;

1059 
nPgsz
;

1061 
	`as£π
–
iNew
<
pPå
->
nCñl
 );

1062 
pPå
->
iCñl
 = 
iNew
;

1063 
aD©a
 = 
	`fsPageD©a
(
pPå
->
pPg
, &
nPgsz
);

1064 
iOff
 = 
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_CELLPTR_OFFSET
(
nPgsz
, 
pPå
->
iCñl
)]);

1065 
pPå
->
eTy≥
 = 
aD©a
[
iOff
];

1066 
iOff
++;

1067 
iOff
 +
	`GETVARINT64
(&
aD©a
[iOff], 
pPå
->
iPgPå
);

1068 
iOff
 +
	`GETVARINT32
(&
aD©a
[iOff], 
pPå
->
nKey
);

1069 if–
	`πIsWrôe
(
pPå
->
eTy≥
) ){

1070 
iOff
 +
	`GETVARINT32
(&
aD©a
[iOff], 
pPå
->
nVÆ
);

1072 
	`as£π
–
pPå
->
nKey
>=0 );

1074 
rc
 = 
	`£gmítPåRódD©a
(

1075 
pPå
, 
iOff
,ÖPå->
nKey
, &pPå->
pKey
, &pPå->
blob1


1077 if–
rc
==
LSM_OK
 && 
	`πIsWrôe
(
pPå
->
eTy≥
) ){

1078 
rc
 = 
	`£gmítPåRódD©a
(

1079 
pPå
, 
iOff
+pPå->
nKey
,ÖPå->
nVÆ
, &pPå->
pVÆ
, &pPå->
blob2


1082 
pPå
->
nVÆ
 = 0;

1083 
pPå
->
pVÆ
 = 0;

1087  
rc
;

1088 
	}
}

1091 
Segmít
 *
	$s‹ãdS∂ôkeySegmít
(
Levñ
 *
pLevñ
){

1092 
Mîge
 *
pMîge
 = 
pLevñ
->pMerge;

1093 
MîgeI≈ut
 *
p
 = &
pMîge
->
•lôkey
;

1094 
Segmít
 *
pSeg
;

1095 
i
;

1097 
i
=0; i<
pMîge
->
nI≈ut
; i++){

1098 if–
p
->
iPg
==
pMîge
->
aI≈ut
[
i
].iPg ) ;

1100 if–
pMîge
->
nI≈ut
==(
pLevñ
->
nRight
+1Ë&& 
i
>=(pMerge->nInput-1) ){

1101 
pSeg
 = &
pLevñ
->
pNext
->
lhs
;

1103 
pSeg
 = &
pLevñ
->
aRhs
[
i
];

1106  
pSeg
;

1107 
	}
}

1109 
	$s‹ãdS∂ôkey
(
lsm_db
 *
pDb
, 
Levñ
 *
pLevñ
, *
pRc
){

1110 
Segmít
 *
pSeg
;

1111 
Page
 *
pPg
 = 0;

1112 
lsm_ív
 *
pEnv
 = 
pDb
->pEnv;

1113 
rc
 = *
pRc
;

1114 
Mîge
 *
pMîge
 = 
pLevñ
->pMerge;

1116 
pSeg
 = 
	`s‹ãdS∂ôkeySegmít
(
pLevñ
);

1117 if–
rc
==
LSM_OK
 ){

1118 
rc
 = 
	`lsmFsDbPageGë
(
pDb
->
pFS
, 
pSeg
, 
pMîge
->
•lôkey
.
iPg
, &
pPg
);

1120 if–
rc
==
LSM_OK
 ){

1121 
iT›ic
;

1122 
Blob
 
blob
 = {0, 0, 0, 0};

1123 
u8
 *
aD©a
;

1124 
nD©a
;

1126 
aD©a
 = 
	`lsmFsPageD©a
(
pPg
, &
nD©a
);

1127 if–
	`∑geGëFœgs
(
aD©a
, 
nD©a
Ë& 
SEGMENT_BTREE_FLAG
 ){

1128 *
pKey
;

1129 
nKey
;

1130 
Pgno
 
dummy
;

1131 
rc
 = 
	`∑geGëBåìKey
(
pSeg
,

1132 
pPg
, 
pMîge
->
•lôkey
.
iCñl
, &
dummy
, &
iT›ic
, &
pKey
, &
nKey
, &
blob


1134 if–
rc
==
LSM_OK
 && 
blob
.
pD©a
!=
pKey
 ){

1135 
rc
 = 
	`s‹ãdBlobSë
(
pEnv
, &
blob
, 
pKey
, 
nKey
);

1138 
rc
 = 
	`∑geGëKeyC›y
(

1139 
pEnv
, 
pSeg
, 
pPg
, 
pMîge
->
•lôkey
.
iCñl
, &
iT›ic
, &
blob


1143 
pLevñ
->
iS∂ôT›ic
 = 
iT›ic
;

1144 
pLevñ
->
pS∂ôKey
 = 
blob
.
pD©a
;

1145 
pLevñ
->
nS∂ôKey
 = 
blob
.
nD©a
;

1146 
	`lsmFsPageRñó£
(
pPg
);

1149 *
pRc
 = 
rc
;

1150 
	}
}

1152 
	$£gmítPåRe£t
(
SegmítPå
 *
pPå
){

1153 
	`lsmFsPageRñó£
(
pPå
->
pPg
);

1154 
pPå
->
pPg
 = 0;

1155 
pPå
->
nCñl
 = 0;

1156 
pPå
->
pKey
 = 0;

1157 
pPå
->
nKey
 = 0;

1158 
pPå
->
pVÆ
 = 0;

1159 
pPå
->
nVÆ
 = 0;

1160 
pPå
->
eTy≥
 = 0;

1161 
pPå
->
iCñl
 = 0;

1162 
	`s‹ãdBlobFªe
(&
pPå
->
blob1
);

1163 
	`s‹ãdBlobFªe
(&
pPå
->
blob2
);

1164 
	}
}

1166 
	$£gmítPåIgn‹eSï¨©‹s
(
Mu…iCurs‹
 *
pC§
, 
SegmítPå
 *
pPå
){

1167  (
pC§
->
Êags
 & 
CURSOR_READ_SEPARATORS
)==0

1168 || (
pPå
!=&
pC§
->
aPå
[pC§->
nPå
-1]);

1169 
	}
}

1171 
	$£gmítPåAdv™˚
(

1172 
Mu…iCurs‹
 *
pC§
,

1173 
SegmítPå
 *
pPå
,

1174 
bRevî£


1176 
eDú
 = (
bRevî£
 ? -1 : 1);

1177 
Levñ
 *
pLvl
 = 
pPå
->
pLevñ
;

1179 
rc
;

1180 
iCñl
;

1181 
svFœgs
 = 0;

1183 
iCñl
 = 
pPå
->iCñ»+ 
eDú
;

1184 
	`as£π
–
pPå
->
pPg
 );

1185 
	`as£π
–
iCñl
<=
pPå
->
nCñl
 && iCell>=-1 );

1187 if–
bRevî£
 && 
pPå
->
pSeg
!=&pPå->
pLevñ
->
lhs
 ){

1188 
svFœgs
 = 
pPå
->
eTy≥
;

1189 
	`as£π
–
svFœgs
 );

1192 if–
iCñl
>=
pPå
->
nCñl
 || iCell<0 ){

1194 
rc
 = 
	`£gmítPåNextPage
(
pPå
, 
eDú
);

1195 } 
rc
==
LSM_OK


1196 && 
pPå
->
pPg


1197 && (
pPå
->
nCñl
==0 || (pPå->
Êags
 & 
SEGMENT_BTREE_FLAG
) )

1199 if–
rc
!=
LSM_OK
 ) Ñc;

1200 
iCñl
 = 
bRevî£
 ? (
pPå
->
nCñl
-1) : 0;

1202 
rc
 = 
	`£gmítPåLﬂdCñl
(
pPå
, 
iCñl
);

1203 if–
rc
!=
LSM_OK
 ) Ñc;

1205 if–
svFœgs
 && 
pPå
->
pPg
 ){

1206 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

1207 
	`πT›ic
(
pPå
->
eTy≥
),ÖPå->
pKey
,ÖPå->
nKey
,

1208 
pLvl
->
iS∂ôT›ic
,ÖLvl->
pS∂ôKey
,ÖLvl->
nS∂ôKey


1210 if–
ªs
<0 ) 
	`£gmítPåRe£t
(
pPå
);

1213 if–
pPå
->
pPg
==0 && (
svFœgs
 & 
LSM_END_DELETE
) ){

1214 
Segmít
 *
pSeg
 = 
pPå
->pSeg;

1215 
rc
 = 
	`lsmFsDbPageGë
(
pC§
->
pDb
->
pFS
, 
pSeg
,ÖSeg->
iFú°
, &
pPå
->
pPg
);

1216 if–
rc
!=
LSM_OK
 ) Ñc;

1217 
pPå
->
eTy≥
 = 
LSM_START_DELETE
 | 
LSM_POINT_DELETE
;

1218 
pPå
->
eTy≥
 |(
pLvl
->
iS∂ôT›ic
 ? 
LSM_SYSTEMKEY
 : 0);

1219 
pPå
->
pKey
 = 
pLvl
->
pS∂ôKey
;

1220 
pPå
->
nKey
 = 
pLvl
->
nS∂ôKey
;

1223 } 
pC§


1224 && 
pPå
->
pPg


1225 && 
	`£gmítPåIgn‹eSï¨©‹s
(
pC§
, 
pPå
)

1226 && 
	`πIsSï¨©‹
(
pPå
->
eTy≥
)

1229  
LSM_OK
;

1230 
	}
}

1232 
	$£gmítPåEndPage
(

1233 
FûeSy°em
 *
pFS
,

1234 
SegmítPå
 *
pPå
,

1235 
bLa°
,

1236 *
pRc


1238 if–*
pRc
==
LSM_OK
 ){

1239 
Segmít
 *
pSeg
 = 
pPå
->pSeg;

1240 
Page
 *
pNew
 = 0;

1241 if–
bLa°
 ){

1242 *
pRc
 = 
	`lsmFsDbPageLa°
(
pFS
, 
pSeg
, &
pNew
);

1244 *
pRc
 = 
	`lsmFsDbPageGë
(
pFS
, 
pSeg
,ÖSeg->
iFú°
, &
pNew
);

1246 
	`£gmítPåSëPage
(
pPå
, 
pNew
);

1248 
	}
}

1259 
	$£gmítPåEnd
(
Mu…iCurs‹
 *
pC§
, 
SegmítPå
 *
pPå
, 
bLa°
){

1260 
Levñ
 *
pLvl
 = 
pPå
->
pLevñ
;

1261 
rc
 = 
LSM_OK
;

1262 
FûeSy°em
 *
pFS
 = 
pC§
->
pDb
->pFS;

1263 
bIgn‹e
;

1265 
	`£gmítPåEndPage
(
pFS
, 
pPå
, 
bLa°
, &
rc
);

1266  
rc
==
LSM_OK
 && 
pPå
->
pPg


1267 && (
pPå
->
nCñl
==0 || (pPå->
Êags
 & 
SEGMENT_BTREE_FLAG
))

1269 
rc
 = 
	`£gmítPåNextPage
(
pPå
, (
bLa°
 ? -1 : 1));

1272 if–
rc
==
LSM_OK
 && 
pPå
->
pPg
 ){

1273 
rc
 = 
	`£gmítPåLﬂdCñl
(
pPå
, 
bLa°
 ? (pPå->
nCñl
-1) : 0);

1274 if–
rc
==
LSM_OK
 && 
bLa°
 && 
pPå
->
pSeg
!=&
pLvl
->
lhs
 ){

1275 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

1276 
	`πT›ic
(
pPå
->
eTy≥
),ÖPå->
pKey
,ÖPå->
nKey
,

1277 
pLvl
->
iS∂ôT›ic
,ÖLvl->
pS∂ôKey
,ÖLvl->
nS∂ôKey


1279 if–
ªs
<0 ) 
	`£gmítPåRe£t
(
pPå
);

1283 
bIgn‹e
 = 
	`£gmítPåIgn‹eSï¨©‹s
(
pC§
, 
pPå
);

1284 if–
rc
==
LSM_OK
 && 
pPå
->
pPg
 && 
bIgn‹e
 && 
	`πIsSï¨©‹
’På->
eTy≥
) ){

1285 
rc
 = 
	`£gmítPåAdv™˚
(
pC§
, 
pPå
, 
bLa°
);

1289 if–
bLa°
 && 
rc
==
LSM_OK
 && 
pPå
->
pPg


1290 && 
pPå
->
pSeg
==&
pLvl
->
lhs


1291 && 
pLvl
->
nRight
 && (
pPå
->
eTy≥
 & 
LSM_START_DELETE
)

1293 
pPå
->
iCñl
++;

1294 
pPå
->
eTy≥
 = 
LSM_END_DELETE
 | (
pLvl
->
iS∂ôT›ic
);

1295 
pPå
->
pKey
 = 
pLvl
->
pS∂ôKey
;

1296 
pPå
->
nKey
 = 
pLvl
->
nS∂ôKey
;

1297 
pPå
->
pVÆ
 = 0;

1298 
pPå
->
nVÆ
 = 0;

1302  
rc
;

1303 
	}
}

1305 
	$£gmítPåKey
(
SegmítPå
 *
pPå
, **
µKey
, *
≤Key
){

1306 
	`as£π
–
pPå
->
pPg
 );

1307 *
µKey
 = 
pPå
->
pKey
;

1308 *
≤Key
 = 
pPå
->
nKey
;

1309 
	}
}

1311 #ifde‡
LSM_DEBUG


1313 *
	$keyToSåög
(
lsm_ív
 *
pEnv
, *
pKey
, 
nKey
){

1314 
i
;

1315 
u8
 *
aKey
 = (u8 *)
pKey
;

1316 *
zRë
 = (*)
	`lsmMÆloc
(
pEnv
, 
nKey
+1);

1318 
i
=0; i<
nKey
; i++){

1319 
zRë
[
i
] = ()(
	`iß um
(
aKey
[i]) ?áKey[i] : '.');

1321 
zRë
[
nKey
] = '\0';

1322  
zRë
;

1323 
	}
}

1330 
	$as£πKeyLoˇti⁄
(

1331 
Mu…iCurs‹
 *
pC§
,

1332 
SegmítPå
 *
pPå
,

1333 *
pKey
, 
nKey


1335 
lsm_ív
 *
pEnv
 = 
	`lsmFsEnv
(
pC§
->
pDb
->
pFS
);

1336 
Blob
 
blob
 = {0, 0, 0};

1337 
eDú
;

1338 
iT›ic
 = 0;

1340 
eDú
=-1;ÉDir<=1;ÉDir+=2){

1341 
Page
 *
pTe°
 = 
pPå
->
pPg
;

1343 
	`lsmFsPageRef
(
pTe°
);

1344  
pTe°
 ){

1345 
Segmít
 *
pSeg
 = 
pPå
->pSeg;

1346 
Page
 *
pNext
;

1348 
rc
 = 
	`lsmFsDbPageNext
(
pSeg
, 
pTe°
, 
eDú
, &
pNext
);

1349 
	`lsmFsPageRñó£
(
pTe°
);

1350 if–
rc
 )  1;

1351 
pTe°
 = 
pNext
;

1353 if–
pTe°
 ){

1354 
nD©a
;

1355 
u8
 *
aD©a
 = 
	`fsPageD©a
(
pTe°
, &
nD©a
);

1356 
nCñl
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

1357 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

1358 if–
nCñl
 && 0==(
Êags
&
SEGMENT_BTREE_FLAG
) ){

1359 
nPgKey
;

1360 
iPgT›ic
;

1361 
u8
 *
pPgKey
;

1362 
ªs
;

1363 
iCñl
;

1365 
iCñl
 = ((
eDú
 < 0Ë? (
nCñl
-1) : 0);

1366 
pPgKey
 = 
	`∑geGëKey
(
pSeg
, 
pTe°
, 
iCñl
, &
iPgT›ic
, &
nPgKey
, &
blob
);

1367 
ªs
 = 
iT›ic
 - 
iPgT›ic
;

1368 if–
ªs
==0 )Ñe†
pC§
->
pDb
->
	`xCmp
(
pKey
, 
nKey
, 
pPgKey
, 
nPgKey
);

1369 if–(
eDú
==1 && 
ªs
>0) || (eDir==-1 &&Ñes<0) ){

1371 *
zMsg
 = 
	`lsmMÆlocPrötf
(
pEnv
, "Key \"%s\" isÇot onÖage %d",

1372 
	`keyToSåög
(
pEnv
, 
pKey
, 
nKey
), 
	`lsmFsPageNumbî
(
pPå
->
pPg
)

1374 
	`Ârötf
(
°dîr
, "%s\n", 
zMsg
);

1375 
	`as£π
( !"assertKeyLocation() failed" );

1377 
	`lsmFsPageRñó£
(
pTe°
);

1378 
pTe°
 = 0;

1384 
	`s‹ãdBlobFªe
(&
blob
);

1386 
	}
}

1389 #i‚de‡
NDEBUG


1390 
	$as£πSìkResu…
(

1391 
Mu…iCurs‹
 *
pC§
,

1392 
SegmítPå
 *
pPå
,

1393 
iT›ic
,

1394 *
pKey
,

1395 
nKey
,

1396 
eSìk


1398 if–
pPå
->
pPg
 ){

1399 
ªs
;

1400 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
, 
iT›ic
, 
pKey
, 
nKey
,

1401 
	`πT›ic
(
pPå
->
eTy≥
),ÖPå->
pKey
,ÖPå->
nKey


1404 if–
eSìk
==
LSM_SEEK_EQ
 )  (
ªs
==0);

1405 if–
eSìk
==
LSM_SEEK_LE
 )  (
ªs
>=0);

1406 if–
eSìk
==
LSM_SEEK_GE
 )  (
ªs
<=0);

1410 
	}
}

1413 
	$£gmítPåSórchOvîsized
(

1414 
Mu…iCurs‹
 *
pC§
,

1415 
SegmítPå
 *
pPå
,

1416 
iT›ic
,

1417 *
pKey
, 
nKey


1419 (*
xCmp
)(*, , *, Ë
pC§
->
pDb
->xCmp;

1420 
rc
 = 
LSM_OK
;

1428  
rc
==
LSM_OK
 && (
pPå
->
Êags
 & 
PGFTR_SKIP_NEXT_FLAG
) ){

1429 
u8
 *
pLa°Key
;

1430 
nLa°Key
;

1431 
iLa°T›ic
;

1432 
ªs
;

1433 
Page
 *
pNext
;

1436 
pLa°Key
 = 
	`∑geGëKey
(
pPå
->
pSeg
,

1437 
pPå
->
pPg
,ÖPå->
nCñl
-1, &
iLa°T›ic
, &
nLa°Key
, &pPå->
blob1


1443 
ªs
 = 
	`s‹ãdKeyCom∑ª
(

1444 
xCmp
, 
iLa°T›ic
, 
pLa°Key
, 
nLa°Key
, 
iT›ic
, 
pKey
, 
nKey


1446 if–
ªs
>=0 ) ;

1449 
pNext
 = 
pPå
->
pPg
;

1450 
	`lsmFsPageRef
(
pNext
);

1452 
Page
 *
pLﬂd
;

1453 
u8
 *
aD©a
; 
nD©a
;

1455 
rc
 = 
	`lsmFsDbPageNext
(
pPå
->
pSeg
, 
pNext
, 1, &
pLﬂd
);

1456 
	`lsmFsPageRñó£
(
pNext
);

1457 
pNext
 = 
pLﬂd
;

1458 if–
pNext
==0 ) ;

1460 
	`as£π
–
rc
==
LSM_OK
 );

1461 
aD©a
 = 
	`lsmFsPageD©a
(
pNext
, &
nD©a
);

1462 if–(
	`∑geGëFœgs
(
aD©a
, 
nD©a
Ë& 
SEGMENT_BTREE_FLAG
)==0

1463 && 
	`∑geGëNRec
(
aD©a
, 
nD©a
)>0

1468 if–
pNext
==0 ) ;

1469 
	`£gmítPåSëPage
(
pPå
, 
pNext
);

1472 
	`as£π
–
rc
!=
LSM_OK
 || (
pPå
->
Êags
 & 
PGFTR_SKIP_THIS_FLAG
) );

1475  
rc
;

1476 
	}
}

1478 
	$±rFwdPoöãr
(

1479 
Page
 *
pPage
,

1480 
iCñl
,

1481 
Segmít
 *
pSeg
,

1482 
Pgno
 *
piPå
,

1483 *
pbFound


1485 
Page
 *
pPg
 = 
pPage
;

1486 
iFú°
 = 
iCñl
;

1487 
rc
 = 
LSM_OK
;

1490 
Page
 *
pNext
 = 0;

1491 
u8
 *
aD©a
;

1492 
nD©a
;

1494 
aD©a
 = 
	`lsmFsPageD©a
(
pPg
, &
nD©a
);

1495 if–(
	`∑geGëFœgs
(
aD©a
, 
nD©a
Ë& 
SEGMENT_BTREE_FLAG
)==0 ){

1496 
i
;

1497 
nCñl
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

1498 
i
=
iFú°
; i<
nCñl
; i++){

1499 
u8
 
eTy≥
 = *
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
i
);

1500 if–(
eTy≥
 & 
LSM_START_DELETE
)==0 ){

1501 *
pbFound
 = 1;

1502 *
piPå
 = 
	`∑geGëRec‹dPå
(
aD©a
, 
nD©a
, 
i
Ë+ 
	`∑geGëPå
(aData,ÇData);

1503 
	`lsmFsPageRñó£
(
pPg
);

1504  
LSM_OK
;

1509 
rc
 = 
	`lsmFsDbPageNext
(
pSeg
, 
pPg
, 1, &
pNext
);

1510 
	`lsmFsPageRñó£
(
pPg
);

1511 
pPg
 = 
pNext
;

1512 
iFú°
 = 0;

1513 } 
pPg
 && 
rc
==
LSM_OK
 );

1514 
	`lsmFsPageRñó£
(
pPg
);

1516 *
pbFound
 = 0;

1517  
rc
;

1518 
	}
}

1520 
	$s‹ãdRhsFú°
(
Mu…iCurs‹
 *
pC§
, 
Levñ
 *
pLvl
, 
SegmítPå
 *
pPå
){

1521 
rc
;

1522 
rc
 = 
	`£gmítPåEnd
(
pC§
, 
pPå
, 0);

1523  
pPå
->
pPg
 && 
rc
==
LSM_OK
 ){

1524 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

1525 
pLvl
->
iS∂ôT›ic
,ÖLvl->
pS∂ôKey
,ÖLvl->
nS∂ôKey
,

1526 
	`πT›ic
(
pPå
->
eTy≥
),ÖPå->
pKey
,ÖPå->
nKey


1528 if–
ªs
<=0 ) ;

1529 
rc
 = 
	`£gmítPåAdv™˚
(
pC§
, 
pPå
, 0);

1531  
rc
;

1532 
	}
}

1564 
	$£gmítPåFwdPoöãr
(

1565 
Mu…iCurs‹
 *
pC§
,

1566 
SegmítPå
 *
pPå
,

1567 
Pgno
 *
piPå


1569 
Levñ
 *
pLvl
 = 
pPå
->
pLevñ
;

1570 
Levñ
 *
pNext
 = 
pLvl
->pNext;

1571 
Page
 *
pPg
 = 
pPå
->pPg;

1572 
rc
;

1573 
bFound
;

1574 
Pgno
 
iOut
 = 0;

1576 if–
pPå
->
pSeg
==&
pLvl
->
lhs
 ||ÖPå->pSeg==&pLvl->
aRhs
[pLvl->
nRight
-1] ){

1577 if–
pNext
==0

1578 || (
pNext
->
nRight
==0 &&ÖNext->
lhs
.
iRoŸ
)

1579 || (
pNext
->
nRight
!=0 &&ÖNext->
aRhs
[0].
iRoŸ
)

1582  
LSM_OK
;

1585 if–
pPå
[1].
pSeg
->
iRoŸ
 ){

1586  
LSM_OK
;

1591 
	`lsmFsPageRef
(
pPg
);

1592 
rc
 = 
	`±rFwdPoöãr
(
pPg
, 
pPå
->
iCñl
,ÖPå->
pSeg
, &
iOut
, &
bFound
);

1594 if–
rc
==
LSM_OK
 && 
bFound
==0 ){

1600 
SegmítPå
 
±r
;

1602 if–
pPå
->
pLevñ
->
nRight
==0 ||ÖPå->
pSeg
!=&pPå->pLevñ->
lhs
 ){

1603  
LSM_CORRUPT_BKPT
;

1606 
	`mem£t
(&
±r
, 0, (
SegmítPå
));

1607 
±r
.
pLevñ
 = 
pPå
->pLevel;

1608 
±r
.
pSeg
 = &±r.
pLevñ
->
aRhs
[±r.pLevñ->
nRight
-1];

1609 
rc
 = 
	`s‹ãdRhsFú°
(
pC§
, 
±r
.
pLevñ
, &ptr);

1610 if–
rc
==
LSM_OK
 ){

1611 
rc
 = 
	`±rFwdPoöãr
(
±r
.
pPg
,Öå.
iCñl
,Öå.
pSeg
, &
iOut
, &
bFound
);

1612 
±r
.
pPg
 = 0;

1614 
	`£gmítPåRe£t
(&
±r
);

1617 *
piPå
 = 
iOut
;

1618  
rc
;

1619 
	}
}

1621 
	$£gmítPåSìk
(

1622 
Mu…iCurs‹
 *
pC§
,

1623 
SegmítPå
 *
pPå
,

1624 
iT›ic
,

1625 *
pKey
, 
nKey
,

1626 
eSìk
,

1627 *
piPå
,

1628 *
pbSt›


1630 (*
xCmp
)(*, , *, Ë
pC§
->
pDb
->xCmp;

1631 
ªs
;

1632 
rc
 = 
LSM_OK
;

1633 
iMö
;

1634 
iMax
;

1635 
Pgno
 
iPåOut
 = 0;

1641 
rc
 = 
	`£gmítPåSórchOvîsized
(
pC§
, 
pPå
, 
iT›ic
, 
pKey
, 
nKey
);

1642 
iPåOut
 = 
pPå
->
iPå
;

1653 
	`as£π
–
	`as£πKeyLoˇti⁄
(
pC§
, 
pPå
, 
pKey
, 
nKey
) );

1656 
	`as£π
–
pPå
->
nCñl
>0

1657 || 
pPå
->
pSeg
->
nSize
==1

1658 || 
	`lsmFsDbPageIsLa°
(
pPå
->
pSeg
,ÖPå->
pPg
)

1660 if–
pPå
->
nCñl
==0 ){

1661 
	`£gmítPåRe£t
(
pPå
);

1663 
iMö
 = 0;

1664 
iMax
 = 
pPå
->
nCñl
-1;

1667 
iTry
 = (
iMö
+
iMax
)/2;

1668 *
pKeyT
; 
nKeyT
;

1669 
iT›icT
;

1671 
	`as£π
–
iTry
<
iMax
 || 
iMö
==iMax );

1673 
rc
 = 
	`£gmítPåLﬂdCñl
(
pPå
, 
iTry
);

1674 if–
rc
!=
LSM_OK
 ) ;

1676 
	`£gmítPåKey
(
pPå
, &
pKeyT
, &
nKeyT
);

1677 
iT›icT
 = 
	`πT›ic
(
pPå
->
eTy≥
);

1679 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
xCmp
, 
iT›icT
, 
pKeyT
, 
nKeyT
, 
iT›ic
, 
pKey
, 
nKey
);

1680 if–
ªs
<=0 ){

1681 
iPåOut
 = 
pPå
->
iPå
 +ÖPå->
iPgPå
;

1684 if–
ªs
==0 || 
iMö
==
iMax
 ){

1686 }if–
ªs
>0 ){

1687 
iMax
 = 
	`LSM_MAX
(
iTry
-1, 
iMö
);

1689 
iMö
 = 
iTry
+1;

1693 if–
rc
==
LSM_OK
 ){

1694 
	`as£π
–
ªs
==0 || (
iMö
==
iMax
 && iMö>=0 && iMö<
pPå
->
nCñl
) );

1695 if–
ªs
 ){

1696 
rc
 = 
	`£gmítPåLﬂdCñl
(
pPå
, 
iMö
);

1698 
	`as£π
–
rc
!=
LSM_OK
 || 
ªs
>0 || 
iPåOut
==(
pPå
->
iPå
 +ÖPå->
iPgPå
) );

1700 if–
rc
==
LSM_OK
 ){

1701  
eSìk
 ){

1702 
LSM_SEEK_EQ
: {

1703 
eTy≥
 = 
pPå
->eType;

1704 if–(
ªs
<0 && (
eTy≥
 & 
LSM_START_DELETE
))

1705 || (
ªs
>0 && (
eTy≥
 & 
LSM_END_DELETE
))

1706 || (
ªs
==0 && (
eTy≥
 & 
LSM_POINT_DELETE
))

1708 *
pbSt›
 = 1;

1709 }if–
ªs
==0 && (
eTy≥
 & 
LSM_INSERT
) ){

1710 
lsm_ív
 *
pEnv
 = 
pC§
->
pDb
->pEnv;

1711 *
pbSt›
 = 1;

1712 
pC§
->
eTy≥
 = 
pPå
->eType;

1713 
rc
 = 
	`s‹ãdBlobSë
(
pEnv
, &
pC§
->
key
, 
pPå
->
pKey
,ÖPå->
nKey
);

1714 if–
rc
==
LSM_OK
 ){

1715 
rc
 = 
	`s‹ãdBlobSë
(
pEnv
, &
pC§
->
vÆ
, 
pPå
->
pVÆ
,ÖPå->
nVÆ
);

1717 
pC§
->
Êags
 |
CURSOR_SEEK_EQ
;

1719 
	`£gmítPåRe£t
(
pPå
);

1722 
LSM_SEEK_LE
:

1723 if–
ªs
>0 ) 
rc
 = 
	`£gmítPåAdv™˚
(
pC§
, 
pPå
, 1);

1725 
LSM_SEEK_GE
: {

1727 if–(
ªs
<=0 && (
pPå
->
eTy≥
 & 
LSM_START_DELETE
))

1728 || (
ªs
>0 && (
pPå
->
eTy≥
 & 
LSM_END_DELETE
))

1730 
rc
 = 
	`£gmítPåFwdPoöãr
(
pC§
, 
pPå
, &
iPåOut
);

1732 if–
ªs
<0 && 
rc
==
LSM_OK
 ){

1733 
rc
 = 
	`£gmítPåAdv™˚
(
pC§
, 
pPå
, 0);

1743 if–
rc
==
LSM_OK
 && 
pPå
->
pPg


1744 && 
	`£gmítPåIgn‹eSï¨©‹s
(
pC§
, 
pPå
)

1745 && 
	`πIsSï¨©‹
(
pPå
->
eTy≥
)

1747 
	`as£π
–
eSìk
!=
LSM_SEEK_EQ
 );

1748 
rc
 = 
	`£gmítPåAdv™˚
(
pC§
, 
pPå
, 
eSìk
==
LSM_SEEK_LE
);

1752 
	`as£π
–
rc
!=
LSM_OK
 || 
	`as£πSìkResu…
(
pC§
,
pPå
,
iT›ic
,
pKey
,
nKey
,
eSìk
) );

1753 *
piPå
 = 
iPåOut
;

1754  
rc
;

1755 
	}
}

1757 
	$£ekInBåì
(

1758 
Mu…iCurs‹
 *
pC§
,

1759 
Segmít
 *
pSeg
,

1760 
iT›ic
,

1761 *
pKey
, 
nKey
,

1762 
Pgno
 *
aPg
,

1763 
Page
 **
µPg


1765 
i
 = 0;

1766 
rc
;

1767 
iPg
;

1768 
Page
 *
pPg
 = 0;

1769 
Blob
 
blob
 = {0, 0, 0};

1771 
iPg
 = 
pSeg
->
iRoŸ
;

1773 
Pgno
 *
piFú°
 = 0;

1774 if–
aPg
 ){

1775 
aPg
[
i
++] = 
iPg
;

1776 
piFú°
 = &
aPg
[
i
];

1779 
rc
 = 
	`lsmFsDbPageGë
(
pC§
->
pDb
->
pFS
, 
pSeg
, 
iPg
, &
pPg
);

1780 
	`as£π
–
rc
==
LSM_OK
 || 
pPg
==0 );

1781 if–
rc
==
LSM_OK
 ){

1782 
u8
 *
aD©a
;

1783 
nD©a
;

1784 
iMö
;

1785 
iMax
;

1786 
nRec
;

1787 
Êags
;

1789 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

1790 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

1791 if–(
Êags
 & 
SEGMENT_BTREE_FLAG
)==0 ) ;

1793 
iPg
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

1794 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

1796 
iMö
 = 0;

1797 
iMax
 = 
nRec
-1;

1798  
iMax
>=
iMö
 ){

1799 
iTry
 = (
iMö
+
iMax
)/2;

1800 *
pKeyT
; 
nKeyT
;

1801 
iT›icT
;

1802 
Pgno
 
iPå
;

1803 
ªs
;

1805 
rc
 = 
	`∑geGëBåìKey
(

1806 
pSeg
, 
pPg
, 
iTry
, &
iPå
, &
iT›icT
, &
pKeyT
, &
nKeyT
, &
blob


1808 if–
rc
!=
LSM_OK
 ) ;

1809 if–
piFú°
 && 
pKeyT
==
blob
.
pD©a
 ){

1810 *
piFú°
 = 
	`∑geGëBåìRef
(
pPg
, 
iTry
);

1811 
piFú°
 = 0;

1812 
i
++;

1815 
ªs
 = 
	`s‹ãdKeyCom∑ª
(

1816 
pC§
->
pDb
->
xCmp
, 
iT›ic
, 
pKey
, 
nKey
, 
iT›icT
, 
pKeyT
, 
nKeyT


1818 if–
ªs
<0 ){

1819 
iPg
 = 
iPå
;

1820 
iMax
 = 
iTry
-1;

1822 
iMö
 = 
iTry
+1;

1825 
	`lsmFsPageRñó£
(
pPg
);

1826 
pPg
 = 0;

1828 } 
rc
==
LSM_OK
 );

1830 
	`s‹ãdBlobFªe
(&
blob
);

1831 
	`as£π
–(
rc
==
LSM_OK
)==(
pPg
!=0) );

1832 if–
µPg
 ){

1833 *
µPg
 = 
pPg
;

1835 
	`lsmFsPageRñó£
(
pPg
);

1837  
rc
;

1838 
	}
}

1840 
	$£ekInSegmít
(

1841 
Mu…iCurs‹
 *
pC§
,

1842 
SegmítPå
 *
pPå
,

1843 
iT›ic
,

1844 *
pKey
, 
nKey
,

1845 
iPg
,

1846 
eSìk
,

1847 *
piPå
,

1848 *
pbSt›


1850 
iPå
 = 
iPg
;

1851 
rc
 = 
LSM_OK
;

1853 if–
pPå
->
pSeg
->
iRoŸ
 ){

1854 
Page
 *
pPg
;

1855 
	`as£π
–
pPå
->
pSeg
->
iRoŸ
!=0 );

1856 
rc
 = 
	`£ekInBåì
(
pC§
, 
pPå
->
pSeg
, 
iT›ic
, 
pKey
, 
nKey
, 0, &
pPg
);

1857 if–
rc
==
LSM_OK
 ) 
	`£gmítPåSëPage
(
pPå
, 
pPg
);

1859 if–
iPå
==0 ){

1860 
iPå
 = 
pPå
->
pSeg
->
iFú°
;

1862 if–
rc
==
LSM_OK
 ){

1863 
rc
 = 
	`£gmítPåLﬂdPage
(
pC§
->
pDb
->
pFS
, 
pPå
, 
iPå
);

1867 if–
rc
==
LSM_OK
 ){

1868 
rc
 = 
	`£gmítPåSìk
(
pC§
, 
pPå
, 
iT›ic
, 
pKey
, 
nKey
, 
eSìk
, 
piPå
, 
pbSt›
);

1870  
rc
;

1871 
	}
}

1887 
	$£ekInLevñ
(

1888 
Mu…iCurs‹
 *
pC§
,

1889 
SegmítPå
 *
aPå
,

1890 
eSìk
,

1891 
iT›ic
,

1892 *
pKey
, 
nKey
,

1893 
Pgno
 *
piPgno
,

1894 *
pbSt›


1896 
Levñ
 *
pLvl
 = 
aPå
[0].
pLevñ
;

1897 
rc
 = 
LSM_OK
;

1898 
iOut
 = 0;

1899 
ªs
 = -1;

1900 
nRhs
 = 
pLvl
->
nRight
;

1901 
bSt›
 = 0;

1906 if–
nRhs
 ){

1907 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
, 
iT›ic
, 
pKey
, 
nKey
,

1908 
pLvl
->
iS∂ôT›ic
,ÖLvl->
pS∂ôKey
,ÖLvl->
nS∂ôKey


1915 if–
ªs
<0 ){

1916 
iPå
 = 0;

1917 if–
nRhs
==0 ) 
iPå
 = *
piPgno
;

1919 
rc
 = 
	`£ekInSegmít
(

1920 
pC§
, &
aPå
[0], 
iT›ic
, 
pKey
, 
nKey
, 
iPå
, 
eSìk
, &
iOut
, &
bSt›


1922 if–
rc
==
LSM_OK
 && 
nRhs
>0 && 
eSìk
==
LSM_SEEK_GE
 && 
aPå
[0].
pPg
==0 ){

1923 
ªs
 = 0;

1927 if–
ªs
>=0 ){

1928 
bHô
 = 0;

1929 
iPå
 = *
piPgno
;

1930 
i
;

1931 
i
=1; 
rc
==
LSM_OK
 && i<=
nRhs
 && 
bSt›
==0; i++){

1932 
SegmítPå
 *
pPå
 = &
aPå
[
i
];

1933 
iOut
 = 0;

1934 
rc
 = 
	`£ekInSegmít
(

1935 
pC§
, 
pPå
, 
iT›ic
, 
pKey
, 
nKey
, 
iPå
, 
eSìk
, &
iOut
, &
bSt›


1937 
iPå
 = 
iOut
;

1941 if–
pPå
->
pPg
 ){

1942 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

1943 
	`πT›ic
(
pPå
->
eTy≥
),ÖPå->
pKey
,ÖPå->
nKey
,

1944 
pLvl
->
iS∂ôT›ic
,ÖLvl->
pS∂ôKey
,ÖLvl->
nS∂ôKey


1946 if–
ªs
<0 ) 
	`£gmítPåRe£t
(
pPå
);

1949 if–
aPå
[
i
].
pKey
 ) 
bHô
 = 1;

1952 if–
rc
==
LSM_OK
 && 
eSìk
==
LSM_SEEK_LE
 && 
bHô
==0 ){

1953 
rc
 = 
	`£gmítPåEnd
(
pC§
, &
aPå
[0], 1);

1957 
	`as£π
–
eSìk
==
LSM_SEEK_EQ
 || 
bSt›
==0 );

1958 *
piPgno
 = 
iOut
;

1959 *
pbSt›
 = 
bSt›
;

1960  
rc
;

1961 
	}
}

1963 
	$mu…iCurs‹GëKey
(

1964 
Mu…iCurs‹
 *
pC§
,

1965 
iKey
,

1966 *
≥Ty≥
,

1967 **
µKey
,

1968 *
≤Key


1970 
nKey
 = 0;

1971 *
pKey
 = 0;

1972 
eTy≥
 = 0;

1974  
iKey
 ){

1975 
CURSOR_DATA_TREE0
:

1976 
CURSOR_DATA_TREE1
: {

1977 
TªeCurs‹
 *
pTªeC§
 = 
pC§
->
≠TªeC§
[
iKey
-
CURSOR_DATA_TREE0
];

1978 if–
	`lsmTªeCurs‹VÆid
(
pTªeC§
) ){

1979 
	`lsmTªeCurs‹Key
(
pTªeC§
, &
eTy≥
, &
pKey
, &
nKey
);

1984 
CURSOR_DATA_SYSTEM
: {

1985 
S«pshŸ
 *
pW‹kî
 = 
pC§
->
pDb
->pWorker;

1986 if–
pW‹kî
 && (
pC§
->
Êags
 & 
CURSOR_FLUSH_FREELIST
) ){

1987 
nE¡ry
 = 
pW‹kî
->
‰ìli°
.nEntry;

1988 if–
pC§
->
iFªe
 < (
nE¡ry
*2) ){

1989 
Fªñi°E¡ry
 *
aE¡ry
 = 
pW‹kî
->
‰ìli°
.aEntry;

1990 
i
 = 
nE¡ry
 - 1 - (
pC§
->
iFªe
 / 2);

1991 
u32
 
iKey
 = 0;

1993 if–(
pC§
->
iFªe
 % 2) ){

1994 
eTy≥
 = 
LSM_END_DELETE
|
LSM_SYSTEMKEY
;

1995 
iKey
 = 
aE¡ry
[
i
].
iBlk
-1;

1996 }if–
aE¡ry
[
i
].
iId
>=0 ){

1997 
eTy≥
 = 
LSM_INSERT
|
LSM_SYSTEMKEY
;

1998 
iKey
 = 
aE¡ry
[
i
].
iBlk
;

2003 if–
i
<(
nE¡ry
-1Ë&& 
aE¡ry
[i+1].
iBlk
==
iKey
+1 &&áE¡ry[i+1].
iId
<0 ){

2004 
eTy≥
 |
LSM_END_DELETE
;

2008 
eTy≥
 = 
LSM_START_DELETE
|
LSM_SYSTEMKEY
;

2009 
iKey
 = 
aE¡ry
[
i
].
iBlk
 + 1;

2015 if–
i
>0 && 
aE¡ry
[i-1].
iBlk
==
iKey
-1 &&áE¡ry[i-1].
iId
<0 ){

2016 
eTy≥
 |
LSM_START_DELETE
;

2019 
pKey
 = 
pC§
->
pSy°emVÆ
;

2020 
nKey
 = 4;

2021 
	`lsmPutU32
(
pKey
, ~
iKey
);

2028 
iPå
 = 
iKey
 - 
CURSOR_DATA_SEGMENT
;

2029 
	`as£π
–
iPå
>=0 );

2030 if–
iPå
==
pC§
->
nPå
 ){

2031 if–
pC§
->
pBtC§
 ){

2032 
pKey
 = 
pC§
->
pBtC§
->pKey;

2033 
nKey
 = 
pC§
->
pBtC§
->nKey;

2034 
eTy≥
 = 
pC§
->
pBtC§
->eType;

2036 }if–
iPå
<
pC§
->
nPå
 ){

2037 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
iPå
];

2038 if–
pPå
->
pPg
 ){

2039 
pKey
 = 
pPå
->pKey;

2040 
nKey
 = 
pPå
->nKey;

2041 
eTy≥
 = 
pPå
->eType;

2048 if–
≥Ty≥
 ) *≥Ty≥ = 
eTy≥
;

2049 if–
≤Key
 ) *≤Key = 
nKey
;

2050 if–
µKey
 ) *µKey = 
pKey
;

2051 
	}
}

2053 
	$s‹ãdDbKeyCom∑ª
(

2054 
Mu…iCurs‹
 *
pC§
,

2055 
iLhsFœgs
, *
pLhsKey
, 
nLhsKey
,

2056 
iRhsFœgs
, *
pRhsKey
, 
nRhsKey


2058 (*
xCmp
)(*, , *, Ë
pC§
->
pDb
->xCmp;

2059 
ªs
;

2062 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
xCmp
,

2063 
	`πT›ic
(
iLhsFœgs
), 
pLhsKey
, 
nLhsKey
,

2064 
	`πT›ic
(
iRhsFœgs
), 
pRhsKey
, 
nRhsKey


2071 if–
ªs
==0 && (
pC§
->
Êags
 & 
CURSOR_IGNORE_DELETE
) ){

2072 c⁄° 
m
 = 
LSM_POINT_DELETE
|
LSM_INSERT
|
LSM_END_DELETE
 |
LSM_START_DELETE
;

2073 
iDñ1
 = 0;

2074 
iDñ2
 = 0;

2076 if–
LSM_START_DELETE
==(
iLhsFœgs
 & 
m
ËË
iDñ1
 = +1;

2077 if–
LSM_END_DELETE
 ==(
iLhsFœgs
 & 
m
ËË
iDñ1
 = -1;

2078 if–
LSM_START_DELETE
==(
iRhsFœgs
 & 
m
ËË
iDñ2
 = +1;

2079 if–
LSM_END_DELETE
 ==(
iRhsFœgs
 & 
m
ËË
iDñ2
 = -1;

2081 
ªs
 = (
iDñ1
 - 
iDñ2
);

2084  
ªs
;

2085 
	}
}

2087 
	$mu…iCurs‹DoCom∑ª
(
Mu…iCurs‹
 *
pC§
, 
iOut
, 
bRevî£
){

2088 
i1
;

2089 
i2
;

2090 
iRes
;

2091 *
pKey1
; 
nKey1
; 
eTy≥1
;

2092 *
pKey2
; 
nKey2
; 
eTy≥2
;

2093 c⁄° 
mul
 = (
bRevî£
 ? -1 : 1);

2095 
	`as£π
–
pC§
->
aTªe
 && 
iOut
<pC§->
nTªe
 );

2096 if–
iOut
>=(
pC§
->
nTªe
/2) ){

2097 
i1
 = (
iOut
 - 
pC§
->
nTªe
/2) * 2;

2098 
i2
 = 
i1
 + 1;

2100 
i1
 = 
pC§
->
aTªe
[
iOut
*2];

2101 
i2
 = 
pC§
->
aTªe
[
iOut
*2+1];

2104 
	`mu…iCurs‹GëKey
(
pC§
, 
i1
, &
eTy≥1
, &
pKey1
, &
nKey1
);

2105 
	`mu…iCurs‹GëKey
(
pC§
, 
i2
, &
eTy≥2
, &
pKey2
, &
nKey2
);

2107 if–
pKey1
==0 ){

2108 
iRes
 = 
i2
;

2109 }if–
pKey2
==0 ){

2110 
iRes
 = 
i1
;

2112 
ªs
;

2115 
ªs
 = 
	`s‹ãdDbKeyCom∑ª
(
pC§
,

2116 
eTy≥1
, 
pKey1
, 
nKey1
, 
eTy≥2
, 
pKey2
, 
nKey2


2119 
ªs
 =Ñe†* 
mul
;

2120 if–
ªs
==0 ){

2125 
nc1
 = (
eTy≥1
 & (
LSM_INSERT
|
LSM_POINT_DELETE
))==0;

2126 
nc2
 = (
eTy≥2
 & (
LSM_INSERT
|
LSM_POINT_DELETE
))==0;

2127 
iRes
 = (
nc1
 > 
nc2
Ë? 
i2
 : 
i1
;

2128 }if–
ªs
<0 ){

2129 
iRes
 = 
i1
;

2131 
iRes
 = 
i2
;

2135 
pC§
->
aTªe
[
iOut
] = 
iRes
;

2136 
	}
}

2150 
	$£gmítCurs‹Adv™˚
(

2151 
Mu…iCurs‹
 *
pC§
,

2152 
iPå
,

2153 
bRevî£


2155 
rc
;

2156 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
iPå
];

2157 
Levñ
 *
pLvl
 = 
pPå
->
pLevñ
;

2158 
bComposôe
;

2161 
rc
 = 
	`£gmítPåAdv™˚
(
pC§
, 
pPå
, 
bRevî£
);

2162 if–
rc
!=
LSM_OK
 ) Ñc;

2164 
bComposôe
 = (
pLvl
->
nRight
>0 && 
pC§
->
nPå
>pLvl->nRight);

2165 if–
bComposôe
 && 
pPå
->
pPg
==0 ){

2166 
bFix
 = 0;

2167 if–(
bRevî£
==0)==(
pPå
->
pSeg
==&
pLvl
->
lhs
) ){

2168 
i
;

2169 if–
bRevî£
 ){

2170 
SegmítPå
 *
pLhs
 = &
pC§
->
aPå
[
iPå
 - 1 - (
pPå
->
pSeg
 - 
pLvl
->
aRhs
)];

2171 
i
=0; i<
pLvl
->
nRight
; i++){

2172 if–
pLhs
[
i
+1].
pPg
 ) ;

2174 if–
i
==
pLvl
->
nRight
 ){

2175 
bFix
 = 1;

2176 
rc
 = 
	`£gmítPåEnd
(
pC§
, 
pLhs
, 1);

2179 
bFix
 = 1;

2180 
i
=0; 
rc
==
LSM_OK
 && i<
pLvl
->
nRight
; i++){

2181 
rc
 = 
	`s‹ãdRhsFú°
(
pC§
, 
pLvl
, &pC§->
aPå
[
iPå
+1+
i
]);

2186 if–
bFix
 ){

2187 
i
;

2188 
i
=
pC§
->
nTªe
-1; i>0; i--){

2189 
	`mu…iCurs‹DoCom∑ª
(
pC§
, 
i
, 
bRevî£
);

2195 if–
bComposôe
 && 
pPå
->
pSeg
==&
pLvl
->
lhs


2196 && 
bRevî£
==0

2197 && 
pPå
->
pPg
==0

2199 
i
;

2200 
i
=0; 
rc
==
LSM_OK
 && i<
pLvl
->
nRight
; i++){

2201 
rc
 = 
	`s‹ãdRhsFú°
(
pC§
, 
pLvl
, &pC§->
aPå
[
iPå
+1+
i
]);

2203 
i
=
pC§
->
nTªe
-1; i>0; i--){

2204 
	`mu…iCurs‹DoCom∑ª
(
pC§
, 
i
, 0);

2209  
rc
;

2210 
	}
}

2212 
	$mcurs‹FªeComp⁄íts
(
Mu…iCurs‹
 *
pC§
){

2213 
i
;

2214 
lsm_ív
 *
pEnv
 = 
pC§
->
pDb
->pEnv;

2217 
	`lsmTªeCurs‹De°roy
(
pC§
->
≠TªeC§
[0]);

2218 
	`lsmTªeCurs‹De°roy
(
pC§
->
≠TªeC§
[1]);

2221 
i
=0; i<
pC§
->
nPå
; i++){

2222 
	`£gmítPåRe£t
(&
pC§
->
aPå
[
i
]);

2226 
	`båìCurs‹Fªe
(
pC§
->
pBtC§
);

2229 
	`lsmFªe
(
pEnv
, 
pC§
->
aPå
);

2230 
	`lsmFªe
(
pEnv
, 
pC§
->
aTªe
);

2231 
	`lsmFªe
(
pEnv
, 
pC§
->
pSy°emVÆ
);

2234 
pC§
->
nPå
 = 0;

2235 
pC§
->
aPå
 = 0;

2236 
pC§
->
nTªe
 = 0;

2237 
pC§
->
aTªe
 = 0;

2238 
pC§
->
pSy°emVÆ
 = 0;

2239 
pC§
->
≠TªeC§
[0] = 0;

2240 
pC§
->
≠TªeC§
[1] = 0;

2241 
pC§
->
pBtC§
 = 0;

2242 
	}
}

2244 
	$lsmMCurs‹FªeCache
(
lsm_db
 *
pDb
){

2245 
Mu…iCurs‹
 *
p
;

2246 
Mu…iCurs‹
 *
pNext
;

2247 
p
=
pDb
->
pC§Cache
;Ö;Ö=
pNext
){

2248 
pNext
 = 
p
->pNext;

2249 
	`lsmMCurs‹Clo£
(
p
, 0);

2251 
pDb
->
pC§Cache
 = 0;

2252 
	}
}

2260 
	$lsmMCurs‹Clo£
(
Mu…iCurs‹
 *
pC§
, 
bCache
){

2261 if–
pC§
 ){

2262 
lsm_db
 *
pDb
 = 
pC§
->pDb;

2263 
Mu…iCurs‹
 **
µ
;

2267 
µ
=&
pDb
->
pC§
; *µ;Öp=&((*µ)->
pNext
)){

2268 if–*
µ
==
pC§
 ){

2269 *
µ
 = 
pC§
->
pNext
;

2274 if–
bCache
 ){

2275 
i
;

2278 
	`as£π
–!
pC§
->
pBtC§
 );

2279 
i
=0; i<
pC§
->
nPå
; i++){

2280 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
i
];

2281 
	`lsmFsPageRñó£
(
pPå
->
pPg
);

2282 
pPå
->
pPg
 = 0;

2286 
	`lsmTªeCurs‹Re£t
(
pC§
->
≠TªeC§
[0]);

2287 
	`lsmTªeCurs‹Re£t
(
pC§
->
≠TªeC§
[1]);

2290 
pC§
->
pNext
 = 
pDb
->
pC§Cache
;

2291 
pDb
->
pC§Cache
 = 
pC§
;

2294 
	`s‹ãdBlobFªe
(&
pC§
->
key
);

2295 
	`s‹ãdBlobFªe
(&
pC§
->
vÆ
);

2298 
	`mcurs‹FªeComp⁄íts
(
pC§
);

2301 
	`lsmFªe
(
pDb
->
pEnv
, 
pC§
);

2304 
	}
}

2306 
	#TREE_NONE
 0

	)

2307 
	#TREE_OLD
 1

	)

2308 
	#TREE_BOTH
 2

	)

2313 
	$mu…iCurs‹AddTªe
(
Mu…iCurs‹
 *
pC§
, 
S«pshŸ
 *
pS«p
, 
eTªe
){

2314 
rc
 = 
LSM_OK
;

2315 
lsm_db
 *
db
 = 
pC§
->
pDb
;

2318 if–
eTªe
!=
TREE_NONE


2319 && 
	`lsmTªeHasOld
(
db
)

2320 && 
db
->
åìhdr
.
iOldLog
!=
pS«p
->
iLogOff


2322 
rc
 = 
	`lsmTªeCurs‹New
(
db
, 1, &
pC§
->
≠TªeC§
[1]);

2326 if–
rc
==
LSM_OK
 && 
eTªe
==
TREE_BOTH
 ){

2327 
rc
 = 
	`lsmTªeCurs‹New
(
db
, 0, &
pC§
->
≠TªeC§
[0]);

2330  
rc
;

2331 
	}
}

2333 
	$mu…iCurs‹AddRhs
(
Mu…iCurs‹
 *
pC§
, 
Levñ
 *
pLvl
){

2334 
i
;

2335 
nRhs
 = 
pLvl
->
nRight
;

2337 
	`as£π
–
pLvl
->
nRight
>0 );

2338 
	`as£π
–
pC§
->
aPå
==0 );

2339 
pC§
->
aPå
 = 
	`lsmMÆlocZîo
’C§->
pDb
->
pEnv
, (
SegmítPå
Ë* 
nRhs
);

2340 if–!
pC§
->
aPå
 )  
LSM_NOMEM_BKPT
;

2341 
pC§
->
nPå
 = 
nRhs
;

2343 
i
=0; i<
nRhs
; i++){

2344 
pC§
->
aPå
[
i
].
pSeg
 = &
pLvl
->
aRhs
[i];

2345 
pC§
->
aPå
[
i
].
pLevñ
 = 
pLvl
;

2348  
LSM_OK
;

2349 
	}
}

2351 
	$mu…iCurs‹AddO√
(
Mu…iCurs‹
 *
pC§
, 
Levñ
 *
pLvl
, *
pRc
){

2352 if–*
pRc
==
LSM_OK
 ){

2353 
iPå
 = 
pC§
->
nPå
;

2354 
i
;

2355 
pC§
->
aPå
[
iPå
].
pLevñ
 = 
pLvl
;

2356 
pC§
->
aPå
[
iPå
].
pSeg
 = &
pLvl
->
lhs
;

2357 
iPå
++;

2358 
i
=0; i<
pLvl
->
nRight
; i++){

2359 
pC§
->
aPå
[
iPå
].
pLevñ
 = 
pLvl
;

2360 
pC§
->
aPå
[
iPå
].
pSeg
 = &
pLvl
->
aRhs
[
i
];

2361 
iPå
++;

2364 if–
pLvl
->
nRight
 &&ÖLvl->
pS∂ôKey
==0 ){

2365 
	`s‹ãdS∂ôkey
(
pC§
->
pDb
, 
pLvl
, 
pRc
);

2367 
pC§
->
nPå
 = 
iPå
;

2369 
	}
}

2371 
	$mu…iCurs‹AddAŒ
(
Mu…iCurs‹
 *
pC§
, 
S«pshŸ
 *
pS«p
){

2372 
Levñ
 *
pLvl
;

2373 
nPå
 = 0;

2374 
rc
 = 
LSM_OK
;

2376 
pLvl
=
pS«p
->
pLevñ
;ÖLvl;ÖLvlıLvl->
pNext
){

2382 if–
pLvl
->
Êags
 & 
LEVEL_INCOMPLETE
 ) ;

2383 
nPå
 +(1 + 
pLvl
->
nRight
);

2386 
	`as£π
–
pC§
->
aPå
==0 );

2387 
pC§
->
aPå
 = 
	`lsmMÆlocZîoRc
’C§->
pDb
->
pEnv
, (
SegmítPå
Ë* 
nPå
, &
rc
);

2389 
pLvl
=
pS«p
->
pLevñ
;ÖLvl;ÖLvlıLvl->
pNext
){

2390 if–(
pLvl
->
Êags
 & 
LEVEL_INCOMPLETE
)==0 ){

2391 
	`mu…iCurs‹AddO√
(
pC§
, 
pLvl
, &
rc
);

2395  
rc
;

2396 
	}
}

2398 
	$mu…iCurs‹Inô
(
Mu…iCurs‹
 *
pC§
, 
S«pshŸ
 *
pS«p
){

2399 
rc
;

2400 
rc
 = 
	`mu…iCurs‹AddAŒ
(
pC§
, 
pS«p
);

2401 if–
rc
==
LSM_OK
 ){

2402 
rc
 = 
	`mu…iCurs‹AddTªe
(
pC§
, 
pS«p
, 
TREE_BOTH
);

2404 
pC§
->
Êags
 |(
CURSOR_IGNORE_SYSTEM
 | 
CURSOR_IGNORE_DELETE
);

2405  
rc
;

2406 
	}
}

2408 
Mu…iCurs‹
 *
	$mu…iCurs‹New
(
lsm_db
 *
db
, *
pRc
){

2409 
Mu…iCurs‹
 *
pC§
;

2410 
pC§
 = (
Mu…iCurs‹
 *)
	`lsmMÆlocZîoRc
(
db
->
pEnv
, (Mu…iCurs‹), 
pRc
);

2411 if–
pC§
 ){

2412 
pC§
->
pNext
 = 
db
->pCsr;

2413 
db
->
pC§
 =ÖCsr;

2414 
pC§
->
pDb
 = 
db
;

2416  
pC§
;

2417 
	}
}

2420 
	$lsmS‹ãdRem≠
(
lsm_db
 *
pDb
){

2421 
Mu…iCurs‹
 *
pC§
;

2422 
pC§
=
pDb
->pC§;ÖC§;ÖC§ıC§->
pNext
){

2423 
iPå
;

2424 if–
pC§
->
pBtC§
 ){

2425 
	`båìCurs‹LﬂdKey
(
pC§
->
pBtC§
);

2427 
iPå
=0; iPå<
pC§
->
nPå
; iPtr++){

2428 
	`£gmítPåLﬂdCñl
(&
pC§
->
aPå
[
iPå
],ÖC§->aPå[iPå].
iCñl
);

2431 
	}
}

2433 
	$mu…iCurs‹RódSï¨©‹s
(
Mu…iCurs‹
 *
pC§
){

2434 if–
pC§
->
nPå
>0 ){

2435 
pC§
->
Êags
 |
CURSOR_READ_SEPARATORS
;

2437 
	}
}

2442 
	$mu…iCurs‹Ign‹eDñëe
(
Mu…iCurs‹
 *
pC§
){

2443 if–
pC§
 )ÖC§->
Êags
 |
CURSOR_IGNORE_DELETE
;

2444 
	}
}

2451 
	$mu…iCurs‹VisôFªñi°
(
Mu…iCurs‹
 *
pC§
){

2452 
rc
 = 
LSM_OK
;

2453 
pC§
->
Êags
 |
CURSOR_FLUSH_FREELIST
;

2454 
pC§
->
pSy°emVÆ
 = 
	`lsmMÆlocRc
’C§->
pDb
->
pEnv
, 4 + 8, &
rc
);

2455  
rc
;

2456 
	}
}

2464 
	$lsmMCurs‹New
(

2465 
lsm_db
 *
pDb
,

2466 
Mu…iCurs‹
 **
µC§


2468 
Mu…iCurs‹
 *
pC§
 = 0;

2469 
rc
 = 
LSM_OK
;

2471 if–
pDb
->
pC§Cache
 ){

2472 
bOld
;

2475 
pC§
 = 
pDb
->
pC§Cache
;

2476 
pDb
->
pC§Cache
 = 
pC§
->
pNext
;

2477 
pC§
->
pNext
 = 
pDb
->pCsr;

2478 
pDb
->
pC§
 =ÖCsr;

2483 
bOld
 = (
	`lsmTªeHasOld
(
pDb
Ë&&ÖDb->
åìhdr
.
iOldLog
!ıDb->
pClõ¡
->
iLogOff
);

2484 if–!
bOld
 && 
pC§
->
≠TªeC§
[1] ){

2485 
	`lsmTªeCurs‹De°roy
(
pC§
->
≠TªeC§
[1]);

2486 
pC§
->
≠TªeC§
[1] = 0;

2487 }if–
bOld
 && !
pC§
->
≠TªeC§
[1] ){

2488 
rc
 = 
	`lsmTªeCurs‹New
(
pDb
, 1, &
pC§
->
≠TªeC§
[1]);

2491 
pC§
->
Êags
 = (
CURSOR_IGNORE_SYSTEM
 | 
CURSOR_IGNORE_DELETE
);

2494 
pC§
 = 
	`mu…iCurs‹New
(
pDb
, &
rc
);

2495 if–
rc
==
LSM_OK
 )Ñ¯
	`mu…iCurs‹Inô
(
pC§
, 
pDb
->
pClõ¡
);

2498 if–
rc
!=
LSM_OK
 ){

2499 
	`lsmMCurs‹Clo£
(
pC§
, 0);

2500 
pC§
 = 0;

2502 
	`as£π
–(
rc
==
LSM_OK
)==(
pC§
!=0) );

2503 *
µC§
 = 
pC§
;

2504  
rc
;

2505 
	}
}

2507 
	$mu…iCurs‹GëVÆ
(

2508 
Mu…iCurs‹
 *
pC§
,

2509 
iVÆ
,

2510 **
µVÆ
,

2511 *
≤VÆ


2513 
rc
 = 
LSM_OK
;

2515 *
µVÆ
 = 0;

2516 *
≤VÆ
 = 0;

2518  
iVÆ
 ){

2519 
CURSOR_DATA_TREE0
:

2520 
CURSOR_DATA_TREE1
: {

2521 
TªeCurs‹
 *
pTªeC§
 = 
pC§
->
≠TªeC§
[
iVÆ
-
CURSOR_DATA_TREE0
];

2522 if–
	`lsmTªeCurs‹VÆid
(
pTªeC§
) ){

2523 
	`lsmTªeCurs‹VÆue
(
pTªeC§
, 
µVÆ
, 
≤VÆ
);

2525 *
µVÆ
 = 0;

2526 *
≤VÆ
 = 0;

2531 
CURSOR_DATA_SYSTEM
: {

2532 
S«pshŸ
 *
pW‹kî
 = 
pC§
->
pDb
->pWorker;

2533 if–
pW‹kî


2534 && (
pC§
->
iFªe
 % 2)==0

2535 && 
pC§
->
iFªe
 < (
pW‹kî
->
‰ìli°
.
nE¡ry
*2)

2537 
iE¡ry
 = 
pW‹kî
->
‰ìli°
.
nE¡ry
 - 1 - (
pC§
->
iFªe
 / 2);

2538 
u8
 *
aVÆ
 = &((u8 *)(
pC§
->
pSy°emVÆ
))[4];

2539 
	`lsmPutU64
(
aVÆ
, 
pW‹kî
->
‰ìli°
.
aE¡ry
[
iE¡ry
].
iId
);

2540 *
µVÆ
 = 
aVÆ
;

2541 *
≤VÆ
 = 8;

2547 
iPå
 = 
iVÆ
-
CURSOR_DATA_SEGMENT
;

2548 if–
iPå
<
pC§
->
nPå
 ){

2549 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
iPå
];

2550 if–
pPå
->
pPg
 ){

2551 *
µVÆ
 = 
pPå
->
pVÆ
;

2552 *
≤VÆ
 = 
pPå
->
nVÆ
;

2558 
	`as£π
–
rc
==
LSM_OK
 || (*
µVÆ
==0 && *
≤VÆ
==0) );

2559  
rc
;

2560 
	}
}

2562 
mu…iCurs‹Adv™˚
(
Mu…iCurs‹
 *
pC§
, 
bRevî£
);

2568 
lsmS‹ãdWÆkFªñi°
(

2569 
lsm_db
 *
pDb
,

2570 
bRevî£
,

2571 (*
x
)(*, , 
i64
),

2572 *
pCtx


2574 
Mu…iCurs‹
 *
pC§
;

2575 
rc
 = 
LSM_OK
;

2576 
S«pshŸ
 *
pS«p
 = 0;

2578 
	`as£π
–
pDb
->
pW‹kî
 );

2579 if–
pDb
->
bIn¸Mîge
 ){

2580 
rc
 = 
	`lsmCheckpoötDe£rülize
(
pDb
, 0,ÖDb->
pShmhdr
->
aS«p1
, &
pS«p
);

2581 if–
rc
!=
LSM_OK
 ) Ñc;

2583 
pS«p
 = 
pDb
->
pW‹kî
;

2586 
pC§
 = 
	`mu…iCurs‹New
(
pDb
, &
rc
);

2587 if–
pC§
 ){

2588 
rc
 = 
	`mu…iCurs‹AddAŒ
(
pC§
, 
pS«p
);

2589 
pC§
->
Êags
 |
CURSOR_IGNORE_DELETE
;

2592 if–
rc
==
LSM_OK
 ){

2593 if–
bRevî£
==0 ){

2594 
rc
 = 
	`lsmMCurs‹La°
(
pC§
);

2596 
rc
 = 
	`lsmMCurs‹Sìk
(
pC§
, 1, "", 0, 
LSM_SEEK_GE
);

2599  
rc
==
LSM_OK
 && 
	`lsmMCurs‹VÆid
(
pC§
Ë&& 
	`πIsSy°em
’C§->
eTy≥
) ){

2600 *
pKey
; 
nKey
;

2601 *
pVÆ
; 
nVÆ
;

2603 
rc
 = 
	`lsmMCurs‹Key
(
pC§
, &
pKey
, &
nKey
);

2604 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmMCurs‹VÆue
(
pC§
, &
pVÆ
, &
nVÆ
);

2605 if–
rc
==
LSM_OK
 && (
nKey
!=4 || 
nVÆ
!=8ËËr¯
LSM_CORRUPT_BKPT
;

2607 if–
rc
==
LSM_OK
 ){

2608 
iBlk
;

2609 
i64
 
iS«p
;

2610 
iBlk
 = ()(~(
	`lsmGëU32
((
u8
 *)
pKey
)));

2611 
iS«p
 = (
i64
)
	`lsmGëU64
((
u8
 *)
pVÆ
);

2612 if–
	`x
(
pCtx
, 
iBlk
, 
iS«p
) ) ;

2613 
rc
 = 
	`mu…iCurs‹Adv™˚
(
pC§
, !
bRevî£
);

2618 
	`lsmMCurs‹Clo£
(
pC§
, 0);

2619 if–
pS«p
!=
pDb
->
pW‹kî
 ){

2620 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
, 
pS«p
);

2623  
rc
;

2624 
	}
}

2626 
	$lsmS‹ãdLﬂdFªñi°
(

2627 
lsm_db
 *
pDb
,

2628 **
µVÆ
,

2629 *
≤VÆ


2631 
Mu…iCurs‹
 *
pC§
;

2632 
rc
 = 
LSM_OK
;

2634 
	`as£π
–
pDb
->
pW‹kî
 );

2635 
	`as£π
–*
µVÆ
==0 && *
≤VÆ
==0 );

2637 
pC§
 = 
	`mu…iCurs‹New
(
pDb
, &
rc
);

2638 if–
pC§
 ){

2639 
rc
 = 
	`mu…iCurs‹AddAŒ
(
pC§
, 
pDb
->
pW‹kî
);

2640 
pC§
->
Êags
 |
CURSOR_IGNORE_DELETE
;

2643 if–
rc
==
LSM_OK
 ){

2644 
rc
 = 
	`lsmMCurs‹La°
(
pC§
);

2645 if–
rc
==
LSM_OK


2646 && 
	`πIsWrôe
(
pC§
->
eTy≥
Ë&& 
	`πIsSy°em
(pCsr->eType)

2647 && 
pC§
->
key
.
nD©a
==8

2648 && 0==
	`memcmp
(
pC§
->
key
.
pD©a
, "FREELIST", 8)

2650 *
pVÆ
; 
nVÆ
;

2651 
rc
 = 
	`lsmMCurs‹VÆue
(
pC§
, &
pVÆ
, &
nVÆ
);

2652 if–
rc
==
LSM_OK
 ){

2653 *
µVÆ
 = 
	`lsmMÆlocRc
(
pDb
->
pEnv
, 
nVÆ
, &
rc
);

2654 if–*
µVÆ
 ){

2655 
	`mem˝y
(*
µVÆ
, 
pVÆ
, 
nVÆ
);

2656 *
≤VÆ
 = 
nVÆ
;

2661 
	`lsmMCurs‹Clo£
(
pC§
, 0);

2664  
rc
;

2665 
	}
}

2667 
	$mu…iCurs‹AŒocTªe
(
Mu…iCurs‹
 *
pC§
){

2668 
rc
 = 
LSM_OK
;

2669 if–
pC§
->
aTªe
==0 ){

2670 
nByã
;

2671 
nMö
;

2673 
nMö
 = 
CURSOR_DATA_SEGMENT
 + 
pC§
->
nPå
 + (pC§->
pBtC§
!=0);

2674 
pC§
->
nTªe
 = 2;

2675  
pC§
->
nTªe
<
nMö
 ){

2676 
pC§
->
nTªe
 =ÖCsr->nTree*2;

2679 
nByã
 = ()*
pC§
->
nTªe
*2;

2680 
pC§
->
aTªe
 = (*)
	`lsmMÆlocZîoRc
’C§->
pDb
->
pEnv
, 
nByã
, &
rc
);

2682  
rc
;

2683 
	}
}

2685 
	$mu…iCurs‹CacheKey
(
Mu…iCurs‹
 *
pC§
, *
pRc
){

2686 if–*
pRc
==
LSM_OK
 ){

2687 *
pKey
;

2688 
nKey
;

2689 
	`mu…iCurs‹GëKey
(
pC§
,ÖC§->
aTªe
[1], &pC§->
eTy≥
, &
pKey
, &
nKey
);

2690 *
pRc
 = 
	`s‹ãdBlobSë
(
pC§
->
pDb
->
pEnv
, &pC§->
key
, 
pKey
, 
nKey
);

2692 
	}
}

2694 #ifde‡
LSM_DEBUG_EXPENSIVE


2695 
	$as£πCurs‹Tªe
(
Mu…iCurs‹
 *
pC§
){

2696 
bRev
 = !!(
pC§
->
Êags
 & 
CURSOR_PREV_OK
);

2697 *
aSave
 = 
pC§
->
aTªe
;

2698 
nSave
 = 
pC§
->
nTªe
;

2699 
rc
;

2701 
pC§
->
aTªe
 = 0;

2702 
pC§
->
nTªe
 = 0;

2703 
rc
 = 
	`mu…iCurs‹AŒocTªe
(
pC§
);

2704 if–
rc
==
LSM_OK
 ){

2705 
i
;

2706 
i
=
pC§
->
nTªe
-1; i>0; i--){

2707 
	`mu…iCurs‹DoCom∑ª
(
pC§
, 
i
, 
bRev
);

2710 
	`as£π
–
nSave
==
pC§
->
nTªe


2711 && 0==
	`memcmp
(
aSave
, 
pC§
->
aTªe
, ()*
nSave
)

2714 
	`lsmFªe
(
pC§
->
pDb
->
pEnv
,ÖC§->
aTªe
);

2717 
pC§
->
aTªe
 = 
aSave
;

2718 
pC§
->
nTªe
 = 
nSave
;

2719 
	}
}

2721 
	#as£πCurs‹Tªe
(
x
)

	)

2724 
	$mcurs‹Loˇti⁄Ok
(
Mu…iCurs‹
 *
pC§
, 
bDñëeOk
){

2725 
eTy≥
 = 
pC§
->eType;

2726 
iKey
;

2727 
i
;

2728 
rdmask
;

2730 
	`as£π
–
pC§
->
Êags
 & (
CURSOR_NEXT_OK
|
CURSOR_PREV_OK
) );

2731 
	`as£πCurs‹Tªe
(
pC§
);

2733 
rdmask
 = (
pC§
->
Êags
 & 
CURSOR_NEXT_OK
Ë? 
LSM_END_DELETE
 : 
LSM_START_DELETE
;

2738 if–(
pC§
->
Êags
 & 
CURSOR_IGNORE_DELETE
Ë&& 
bDñëeOk
==0 ){

2739 if–(
eTy≥
 & 
LSM_INSERT
)==0 )  0;

2744 if–(
pC§
->
Êags
 & 
CURSOR_IGNORE_SYSTEM
Ë&& 
	`πT›ic
(
eTy≥
)!=0 ){

2748 #i‚de‡
NDEBUG


2755 
i
=0; i<
pC§
->
nPå
; i++){

2756 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
i
];

2757 
Levñ
 *
pLvl
 = 
pPå
->
pLevñ
;

2758 if–
pLvl
->
nRight
 && 
pPå
->
pPg
 ){

2759 if–
pPå
->
pSeg
==&
pLvl
->
lhs
 ){

2760 
j
;

2761 
j
=0; j<
pLvl
->
nRight
; j++Ë
	`as£π
–
pPå
[j+1].
pPg
==0 );

2763 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

2764 
	`πT›ic
(
pPå
->
eTy≥
),ÖPå->
pKey
,ÖPå->
nKey
,

2765 
pLvl
->
iS∂ôT›ic
,ÖLvl->
pS∂ôKey
,ÖLvl->
nS∂ôKey


2767 
	`as£π
–
ªs
>=0 );

2801 
iKey
 = 
pC§
->
aTªe
[1];

2802 
i
=0; i<
iKey
; i++){

2803 
c§Êags
;

2804 
	`mu…iCurs‹GëKey
(
pC§
, 
i
, &
c§Êags
, 0, 0);

2805 if–(
rdmask
 & 
c§Êags
) ){

2806 c⁄° 
SD_ED
 = (
LSM_START_DELETE
|
LSM_END_DELETE
);

2807 if–(
c§Êags
 & 
SD_ED
)==SD_ED

2808 || (
pC§
->
Êags
 & 
CURSOR_IGNORE_DELETE
)==0

2810 *
pKey
; 
nKey
;

2811 
	`mu…iCurs‹GëKey
(
pC§
, 
i
, 0, &
pKey
, &
nKey
);

2812 if–0==
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

2813 
	`πT›ic
(
eTy≥
), 
pC§
->
key
.
pD©a
,ÖC§->key.
nD©a
,

2814 
	`πT›ic
(
c§Êags
), 
pKey
, 
nKey


2825 
	}
}

2827 
	$mu…iCurs‹SëupTªe
(
Mu…iCurs‹
 *
pC§
, 
bRev
){

2828 
rc
;

2830 
rc
 = 
	`mu…iCurs‹AŒocTªe
(
pC§
);

2831 if–
rc
==
LSM_OK
 ){

2832 
i
;

2833 
i
=
pC§
->
nTªe
-1; i>0; i--){

2834 
	`mu…iCurs‹DoCom∑ª
(
pC§
, 
i
, 
bRev
);

2838 
	`as£πCurs‹Tªe
(
pC§
);

2839 
	`mu…iCurs‹CacheKey
(
pC§
, &
rc
);

2841 if–
rc
==
LSM_OK
 && 
	`mcurs‹Loˇti⁄Ok
(
pC§
, 0)==0 ){

2842 
rc
 = 
	`mu…iCurs‹Adv™˚
(
pC§
, 
bRev
);

2844  
rc
;

2845 
	}
}

2848 
	$mu…iCurs‹End
(
Mu…iCurs‹
 *
pC§
, 
bLa°
){

2849 
rc
 = 
LSM_OK
;

2850 
i
;

2852 
pC§
->
Êags
 &~(
CURSOR_NEXT_OK
 | 
CURSOR_PREV_OK
);

2853 
pC§
->
Êags
 |(
bLa°
 ? 
CURSOR_PREV_OK
 : 
CURSOR_NEXT_OK
);

2854 
pC§
->
iFªe
 = 0;

2857 
i
=0; 
rc
==
LSM_OK
 && i<2; i++){

2858 if–
pC§
->
≠TªeC§
[
i
] ){

2859 
rc
 = 
	`lsmTªeCurs‹End
(
pC§
->
≠TªeC§
[
i
], 
bLa°
);

2863 
i
=0; 
rc
==
LSM_OK
 && i<
pC§
->
nPå
; i++){

2864 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
i
];

2865 
Levñ
 *
pLvl
 = 
pPå
->
pLevñ
;

2866 
iRhs
;

2867 
bHô
 = 0;

2869 if–
bLa°
 ){

2870 
iRhs
=0; iRhs<
pLvl
->
nRight
 && 
rc
==
LSM_OK
; iRhs++){

2871 
rc
 = 
	`£gmítPåEnd
(
pC§
, &
pPå
[
iRhs
+1], 1);

2872 if–
pPå
[
iRhs
+1].
pPg
 ) 
bHô
 = 1;

2874 if–
bHô
==0 && 
rc
==
LSM_OK
 ){

2875 
rc
 = 
	`£gmítPåEnd
(
pC§
, 
pPå
, 1);

2877 
	`£gmítPåRe£t
(
pPå
);

2880 
bLhs
 = (
pPå
->
pSeg
==&
pLvl
->
lhs
);

2881 
	`as£π
–
pPå
->
pSeg
==&
pLvl
->
lhs
 ||ÖPå->pSeg==&pLvl->
aRhs
[0] );

2883 if–
bLhs
 ){

2884 
rc
 = 
	`£gmítPåEnd
(
pC§
, 
pPå
, 0);

2885 if–
pPå
->
pKey
 ) 
bHô
 = 1;

2887 
iRhs
=0; iRhs<
pLvl
->
nRight
 && 
rc
==
LSM_OK
; iRhs++){

2888 if–
bHô
 ){

2889 
	`£gmítPåRe£t
(&
pPå
[
iRhs
+1]);

2891 
rc
 = 
	`s‹ãdRhsFú°
(
pC§
, 
pLvl
, &
pPå
[
iRhs
+
bLhs
]);

2895 
i
 +
pLvl
->
nRight
;

2899 if–
rc
==
LSM_OK
 && 
pC§
->
pBtC§
 ){

2900 
	`as£π
–
bLa°
==0 );

2901 
rc
 = 
	`båìCurs‹Fú°
(
pC§
->
pBtC§
);

2904 if–
rc
==
LSM_OK
 ){

2905 
rc
 = 
	`mu…iCurs‹SëupTªe
(
pC§
, 
bLa°
);

2908  
rc
;

2909 
	}
}

2912 
	$mcurs‹Save
(
Mu…iCurs‹
 *
pC§
){

2913 
rc
 = 
LSM_OK
;

2914 if–
pC§
->
aTªe
 ){

2915 
iTªe
 = 
pC§
->
aTªe
[1];

2916 if–
iTªe
==
CURSOR_DATA_TREE0
 || iTªe==
CURSOR_DATA_TREE1
 ){

2917 
	`mu…iCurs‹CacheKey
(
pC§
, &
rc
);

2920 
	`mcurs‹FªeComp⁄íts
(
pC§
);

2921  
rc
;

2922 
	}
}

2924 
	$mcurs‹Re°‹e
(
lsm_db
 *
pDb
, 
Mu…iCurs‹
 *
pC§
){

2925 
rc
;

2926 
rc
 = 
	`mu…iCurs‹Inô
(
pC§
, 
pDb
->
pClõ¡
);

2927 if–
rc
==
LSM_OK
 && 
pC§
->
key
.
pD©a
 ){

2928 
rc
 = 
	`lsmMCurs‹Sìk
(
pC§
,

2929 
	`πT›ic
(
pC§
->
eTy≥
),ÖC§->
key
.
pD©a
,ÖC§->key.
nD©a
, +1

2932  
rc
;

2933 
	}
}

2935 
	$lsmSaveCurs‹s
(
lsm_db
 *
pDb
){

2936 
rc
 = 
LSM_OK
;

2937 
Mu…iCurs‹
 *
pC§
;

2939 
pC§
=
pDb
->pC§; 
rc
==
LSM_OK
 &&ÖC§;ÖC§ıC§->
pNext
){

2940 
rc
 = 
	`mcurs‹Save
(
pC§
);

2942  
rc
;

2943 
	}
}

2945 
	$lsmRe°‹eCurs‹s
(
lsm_db
 *
pDb
){

2946 
rc
 = 
LSM_OK
;

2947 
Mu…iCurs‹
 *
pC§
;

2949 
pC§
=
pDb
->pC§; 
rc
==
LSM_OK
 &&ÖC§;ÖC§ıC§->
pNext
){

2950 
rc
 = 
	`mcurs‹Re°‹e
(
pDb
, 
pC§
);

2952  
rc
;

2953 
	}
}

2955 
	$lsmMCurs‹Fú°
(
Mu…iCurs‹
 *
pC§
){

2956  
	`mu…iCurs‹End
(
pC§
, 0);

2957 
	}
}

2959 
	$lsmMCurs‹La°
(
Mu…iCurs‹
 *
pC§
){

2960  
	`mu…iCurs‹End
(
pC§
, 1);

2961 
	}
}

2963 
lsm_db
 *
	$lsmMCurs‹Db
(
Mu…iCurs‹
 *
pC§
){

2964  
pC§
->
pDb
;

2965 
	}
}

2967 
	$lsmMCurs‹Re£t
(
Mu…iCurs‹
 *
pC§
){

2968 
i
;

2969 
	`lsmTªeCurs‹Re£t
(
pC§
->
≠TªeC§
[0]);

2970 
	`lsmTªeCurs‹Re£t
(
pC§
->
≠TªeC§
[1]);

2971 
i
=0; i<
pC§
->
nPå
; i++){

2972 
	`£gmítPåRe£t
(&
pC§
->
aPå
[
i
]);

2974 
pC§
->
key
.
nD©a
 = 0;

2975 
	}
}

2977 
	$åìCurs‹Sìk
(

2978 
Mu…iCurs‹
 *
pC§
,

2979 
TªeCurs‹
 *
pTªeC§
,

2980 *
pKey
, 
nKey
,

2981 
eSìk
,

2982 *
pbSt›


2984 
rc
 = 
LSM_OK
;

2985 if–
pTªeC§
 ){

2986 
ªs
 = 0;

2987 
	`lsmTªeCurs‹Sìk
(
pTªeC§
, 
pKey
, 
nKey
, &
ªs
);

2988  
eSìk
 ){

2989 
LSM_SEEK_EQ
: {

2990 
eTy≥
 = 
	`lsmTªeCurs‹Fœgs
(
pTªeC§
);

2991 if–(
ªs
<0 && (
eTy≥
 & 
LSM_START_DELETE
))

2992 || (
ªs
>0 && (
eTy≥
 & 
LSM_END_DELETE
))

2993 || (
ªs
==0 && (
eTy≥
 & 
LSM_POINT_DELETE
))

2995 *
pbSt›
 = 1;

2996 }if–
ªs
==0 && (
eTy≥
 & 
LSM_INSERT
) ){

2997 
lsm_ív
 *
pEnv
 = 
pC§
->
pDb
->pEnv;

2998 *
p
; 
n
;

2999 *
pbSt›
 = 1;

3000 
pC§
->
Êags
 |
CURSOR_SEEK_EQ
;

3001 
rc
 = 
	`lsmTªeCurs‹Key
(
pTªeC§
, &
pC§
->
eTy≥
, &
p
, &
n
);

3002 if–
rc
==
LSM_OK
 )Ñ¯
	`s‹ãdBlobSë
(
pEnv
, &
pC§
->
key
, 
p
, 
n
);

3003 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmTªeCurs‹VÆue
(
pTªeC§
, &
p
, &
n
);

3004 if–
rc
==
LSM_OK
 )Ñ¯
	`s‹ãdBlobSë
(
pEnv
, &
pC§
->
vÆ
, 
p
, 
n
);

3006 
	`lsmTªeCurs‹Re£t
(
pTªeC§
);

3009 
LSM_SEEK_GE
:

3010 if–
ªs
<0 && 
	`lsmTªeCurs‹VÆid
(
pTªeC§
) ){

3011 
	`lsmTªeCurs‹Next
(
pTªeC§
);

3015 if–
ªs
>0 ){

3016 
	`as£π
–
	`lsmTªeCurs‹VÆid
(
pTªeC§
) );

3017 
	`lsmTªeCurs‹Pªv
(
pTªeC§
);

3022  
rc
;

3023 
	}
}

3029 
	$lsmMCurs‹Sìk
(

3030 
Mu…iCurs‹
 *
pC§
,

3031 
iT›ic
,

3032 *
pKey
, 
nKey
,

3033 
eSìk


3035 
eESìk
 = 
eSìk
;

3036 
bSt›
 = 0;

3037 
rc
 = 
LSM_OK
;

3038 
iPå
 = 0;

3039 
Pgno
 
iPgno
 = 0;

3041 
	`as£π
–
pC§
->
≠TªeC§
[0]==0 || 
iT›ic
==0 );

3042 
	`as£π
–
pC§
->
≠TªeC§
[1]==0 || 
iT›ic
==0 );

3044 if–
eESìk
==
LSM_SEEK_LEFAST
 )ÉESìk = 
LSM_SEEK_LE
;

3046 
	`as£π
–
eESìk
==
LSM_SEEK_EQ
 ||ÉESìk==
LSM_SEEK_LE
 ||ÉESìk==
LSM_SEEK_GE
 );

3047 
	`as£π
–(
pC§
->
Êags
 & 
CURSOR_FLUSH_FREELIST
)==0 );

3048 
	`as£π
–
pC§
->
nPå
==0 ||ÖC§->
aPå
[0].
pLevñ
 );

3050 
pC§
->
Êags
 &~(
CURSOR_NEXT_OK
 | 
CURSOR_PREV_OK
 | 
CURSOR_SEEK_EQ
);

3051 
rc
 = 
	`åìCurs‹Sìk
(
pC§
,ÖC§->
≠TªeC§
[0], 
pKey
, 
nKey
, 
eESìk
, &
bSt›
);

3052 if–
rc
==
LSM_OK
 && 
bSt›
==0 ){

3053 
rc
 = 
	`åìCurs‹Sìk
(
pC§
,ÖC§->
≠TªeC§
[1], 
pKey
, 
nKey
, 
eESìk
, &
bSt›
);

3057 
iPå
=0; iPå<
pC§
->
nPå
 && 
rc
==
LSM_OK
 && 
bSt›
==0; iPtr++){

3058 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
iPå
];

3059 
	`as£π
–
pPå
->
pSeg
==&pPå->
pLevñ
->
lhs
 );

3060 
rc
 = 
	`£ekInLevñ
(
pC§
, 
pPå
, 
eESìk
, 
iT›ic
, 
pKey
, 
nKey
, &
iPgno
, &
bSt›
);

3061 
iPå
 +
pPå
->
pLevñ
->
nRight
;

3064 if–
eSìk
!=
LSM_SEEK_EQ
 ){

3065 if–
rc
==
LSM_OK
 ){

3066 
rc
 = 
	`mu…iCurs‹AŒocTªe
(
pC§
);

3068 if–
rc
==
LSM_OK
 ){

3069 
i
;

3070 
i
=
pC§
->
nTªe
-1; i>0; i--){

3071 
	`mu…iCurs‹DoCom∑ª
(
pC§
, 
i
, 
eESìk
==
LSM_SEEK_LE
);

3073 if–
eSìk
==
LSM_SEEK_GE
 ) 
pC§
->
Êags
 |
CURSOR_NEXT_OK
;

3074 if–
eSìk
==
LSM_SEEK_LE
 ) 
pC§
->
Êags
 |
CURSOR_PREV_OK
;

3077 
	`mu…iCurs‹CacheKey
(
pC§
, &
rc
);

3078 if–
rc
==
LSM_OK
 && 
eSìk
!=
LSM_SEEK_LEFAST
 && 0==
	`mcurs‹Loˇti⁄Ok
(
pC§
, 0) ){

3079  
eESìk
 ){

3080 
LSM_SEEK_EQ
:

3081 
	`lsmMCurs‹Re£t
(
pC§
);

3083 
LSM_SEEK_GE
:

3084 
rc
 = 
	`lsmMCurs‹Next
(
pC§
);

3087 
rc
 = 
	`lsmMCurs‹Pªv
(
pC§
);

3093  
rc
;

3094 
	}
}

3096 
	$lsmMCurs‹VÆid
(
Mu…iCurs‹
 *
pC§
){

3097 
ªs
 = 0;

3098 if–
pC§
->
Êags
 & 
CURSOR_SEEK_EQ
 ){

3099 
ªs
 = 1;

3100 }if–
pC§
->
aTªe
 ){

3101 
iKey
 = 
pC§
->
aTªe
[1];

3102 if–
iKey
==
CURSOR_DATA_TREE0
 || iKey==
CURSOR_DATA_TREE1
 ){

3103 
ªs
 = 
	`lsmTªeCurs‹VÆid
(
pC§
->
≠TªeC§
[
iKey
-
CURSOR_DATA_TREE0
]);

3105 *
pKey
;

3106 
	`mu…iCurs‹GëKey
(
pC§
, 
iKey
, 0, &
pKey
, 0);

3107 
ªs
 = 
pKey
!=0;

3110  
ªs
;

3111 
	}
}

3113 
	$mcurs‹Adv™˚Ok
(

3114 
Mu…iCurs‹
 *
pC§
,

3115 
bRevî£
,

3116 *
pRc


3118 *
pNew
;

3119 
nNew
;

3120 
eNewTy≥
;

3122 if–*
pRc
 )  1;

3128 
	`mu…iCurs‹GëKey
(
pC§
,ÖC§->
aTªe
[1], &
eNewTy≥
, &
pNew
, &
nNew
);

3129 if–
pNew
 ){

3130 
ty≥mask
 = (
pC§
->
Êags
 & 
CURSOR_IGNORE_DELETE
Ë? ~(0Ë: 
LSM_SYSTEMKEY
;

3131 
ªs
 = 
	`s‹ãdDbKeyCom∑ª
(
pC§
,

3132 
eNewTy≥
 & 
ty≥mask
, 
pNew
, 
nNew
,

3133 
pC§
->
eTy≥
 & 
ty≥mask
,ÖC§->
key
.
pD©a
,ÖC§->key.
nD©a


3136 if–(
bRevî£
==0 && 
ªs
<=0) || (bReverse!=0 &&Ñes>=0) ){

3140 
	`mu…iCurs‹CacheKey
(
pC§
, 
pRc
);

3141 
	`as£π
–
pC§
->
eTy≥
==
eNewTy≥
 );

3150 if–*
pRc
==
LSM_OK
 && 0==
	`mcurs‹Loˇti⁄Ok
(
pC§
, 0) )  0;

3153 
	}
}

3155 
	$ÊC§Adv™˚
(
Mu…iCurs‹
 *
pC§
){

3156 
	`as£π
–
pC§
->
Êags
 & 
CURSOR_FLUSH_FREELIST
 );

3157 if–
pC§
->
iFªe
 % 2 ){

3158 
pC§
->
iFªe
++;

3160 
nE¡ry
 = 
pC§
->
pDb
->
pW‹kî
->
‰ìli°
.nEntry;

3161 
Fªñi°E¡ry
 *
aE¡ry
 = 
pC§
->
pDb
->
pW‹kî
->
‰ìli°
.aEntry;

3163 
i
 = 
nE¡ry
 - 1 - (
pC§
->
iFªe
 / 2);

3167 if–
aE¡ry
[
i
].
iId
<0 ){

3169 if–
i
==0 || 
aE¡ry
[i-1].
iBlk
!=aEntry[i].iBlk-1 ){

3170 
pC§
->
iFªe
--;

3173 if–
aE¡ry
[
i
-1].
iId
>=0 ) ;

3174 
pC§
->
iFªe
 += 2;

3175 
i
--;

3178 
pC§
->
iFªe
 += 2;

3180 
	}
}

3182 
	$mu…iCurs‹Adv™˚
(
Mu…iCurs‹
 *
pC§
, 
bRevî£
){

3183 
rc
 = 
LSM_OK
;

3184 if–
	`lsmMCurs‹VÆid
(
pC§
) ){

3186 
iKey
 = 
pC§
->
aTªe
[1];

3188 
	`as£πCurs‹Tªe
(
pC§
);

3193 if–
pC§
->
pPªvMîgePå
 ){

3194 if–
iKey
==(
CURSOR_DATA_SEGMENT
+
pC§
->
nPå
) ){

3195 
	`as£π
–
pC§
->
pBtC§
 );

3196 *
pC§
->
pPªvMîgePå
 =ÖC§->
pBtC§
->
iPå
;

3197 }if–
pC§
->
pBtC§
==0 &&ÖC§->
nPå
>0

3198 && 
iKey
==(
CURSOR_DATA_SEGMENT
+
pC§
->
nPå
-1)

3200 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
iKey
-
CURSOR_DATA_SEGMENT
];

3201 *
pC§
->
pPªvMîgePå
 = 
pPå
->
iPå
+pPå->
iPgPå
;

3205 if–
iKey
==
CURSOR_DATA_TREE0
 || iKey==
CURSOR_DATA_TREE1
 ){

3206 
TªeCurs‹
 *
pTªeC§
 = 
pC§
->
≠TªeC§
[
iKey
-
CURSOR_DATA_TREE0
];

3207 if–
bRevî£
 ){

3208 
rc
 = 
	`lsmTªeCurs‹Pªv
(
pTªeC§
);

3210 
rc
 = 
	`lsmTªeCurs‹Next
(
pTªeC§
);

3212 }if–
iKey
==
CURSOR_DATA_SYSTEM
 ){

3213 
	`as£π
–
pC§
->
Êags
 & 
CURSOR_FLUSH_FREELIST
 );

3214 
	`as£π
–
bRevî£
==0 );

3215 
	`ÊC§Adv™˚
(
pC§
);

3216 }if–
iKey
==(
CURSOR_DATA_SEGMENT
+
pC§
->
nPå
) ){

3217 
	`as£π
–
bRevî£
==0 && 
pC§
->
pBtC§
 );

3218 
rc
 = 
	`båìCurs‹Next
(
pC§
->
pBtC§
);

3220 
rc
 = 
	`£gmítCurs‹Adv™˚
(
pC§
, 
iKey
-
CURSOR_DATA_SEGMENT
, 
bRevî£
);

3222 if–
rc
==
LSM_OK
 ){

3223 
i
;

3224 
i
=(
iKey
+
pC§
->
nTªe
)/2; i>0; i=i/2){

3225 
	`mu…iCurs‹DoCom∑ª
(
pC§
, 
i
, 
bRevî£
);

3227 
	`as£πCurs‹Tªe
(
pC§
);

3229 } 
	`mcurs‹Adv™˚Ok
(
pC§
, 
bRevî£
, &
rc
)==0 );

3231  
rc
;

3232 
	}
}

3234 
	$lsmMCurs‹Next
(
Mu…iCurs‹
 *
pC§
){

3235 if–(
pC§
->
Êags
 & 
CURSOR_NEXT_OK
)==0 )  
LSM_MISUSE_BKPT
;

3236  
	`mu…iCurs‹Adv™˚
(
pC§
, 0);

3237 
	}
}

3239 
	$lsmMCurs‹Pªv
(
Mu…iCurs‹
 *
pC§
){

3240 if–(
pC§
->
Êags
 & 
CURSOR_PREV_OK
)==0 )  
LSM_MISUSE_BKPT
;

3241  
	`mu…iCurs‹Adv™˚
(
pC§
, 1);

3242 
	}
}

3244 
	$lsmMCurs‹Key
(
Mu…iCurs‹
 *
pC§
, **
µKey
, *
≤Key
){

3245 if–(
pC§
->
Êags
 & 
CURSOR_SEEK_EQ
Ë||ÖC§->
aTªe
==0 ){

3246 *
≤Key
 = 
pC§
->
key
.
nD©a
;

3247 *
µKey
 = 
pC§
->
key
.
pD©a
;

3249 
iKey
 = 
pC§
->
aTªe
[1];

3251 if–
iKey
==
CURSOR_DATA_TREE0
 || iKey==
CURSOR_DATA_TREE1
 ){

3252 
TªeCurs‹
 *
pTªeC§
 = 
pC§
->
≠TªeC§
[
iKey
-
CURSOR_DATA_TREE0
];

3253 
	`lsmTªeCurs‹Key
(
pTªeC§
, 0, 
µKey
, 
≤Key
);

3255 
nKey
;

3257 #i‚de‡
NDEBUG


3258 *
pKey
;

3259 
eTy≥
;

3260 
	`mu…iCurs‹GëKey
(
pC§
, 
iKey
, &
eTy≥
, &
pKey
, &
nKey
);

3261 
	`as£π
–
eTy≥
==
pC§
->eType );

3262 
	`as£π
–
nKey
==
pC§
->
key
.
nD©a
 );

3263 
	`as£π
–
	`memcmp
(
pKey
, 
pC§
->
key
.
pD©a
, 
nKey
)==0 );

3266 
nKey
 = 
pC§
->
key
.
nD©a
;

3267 if–
nKey
==0 ){

3268 *
µKey
 = 0;

3270 *
µKey
 = 
pC§
->
key
.
pD©a
;

3272 *
≤Key
 = 
nKey
;

3275  
LSM_OK
;

3276 
	}
}

3282 
	$lsm_c§_cmp
(
lsm_curs‹
 *
c§
, c⁄° *
pKey
, 
nKey
, *
piRes
){

3283 
Mu…iCurs‹
 *
pC§
 = (Mu…iCurs‹ *)
c§
;

3284 *
pC§key
; 
nC§key
;

3285 
rc
;

3286 
rc
 = 
	`lsmMCurs‹Key
(
pC§
, &
pC§key
, &
nC§key
);

3287 if–
rc
==
LSM_OK
 ){

3288 (*
xCmp
)(*, , *, Ë
pC§
->
pDb
->xCmp;

3289 *
piRes
 = 
	`s‹ãdKeyCom∑ª
(
xCmp
, 0, 
pC§key
, 
nC§key
, 0, (*)
pKey
, 
nKey
);

3291  
rc
;

3292 
	}
}

3294 
	$lsmMCurs‹VÆue
(
Mu…iCurs‹
 *
pC§
, **
µVÆ
, *
≤VÆ
){

3295 *
pVÆ
;

3296 
nVÆ
;

3297 
rc
;

3298 if–(
pC§
->
Êags
 & 
CURSOR_SEEK_EQ
Ë||ÖC§->
aTªe
==0 ){

3299 
rc
 = 
LSM_OK
;

3300 
nVÆ
 = 
pC§
->
vÆ
.
nD©a
;

3301 
pVÆ
 = 
pC§
->
vÆ
.
pD©a
;

3304 
	`as£π
–
pC§
->
aTªe
 );

3305 
	`as£π
–
	`mcurs‹Loˇti⁄Ok
(
pC§
, (pC§->
Êags
 & 
CURSOR_IGNORE_DELETE
)) );

3307 
rc
 = 
	`mu…iCurs‹GëVÆ
(
pC§
,ÖC§->
aTªe
[1], &
pVÆ
, &
nVÆ
);

3308 if–
pVÆ
 && 
rc
==
LSM_OK
 ){

3309 
rc
 = 
	`s‹ãdBlobSë
(
pC§
->
pDb
->
pEnv
, &pC§->
vÆ
, 
pVÆ
, 
nVÆ
);

3310 
pVÆ
 = 
pC§
->
vÆ
.
pD©a
;

3313 if–
rc
!=
LSM_OK
 ){

3314 
pVÆ
 = 0;

3315 
nVÆ
 = 0;

3318 *
µVÆ
 = 
pVÆ
;

3319 *
≤VÆ
 = 
nVÆ
;

3320  
rc
;

3321 
	}
}

3323 
	$lsmMCurs‹Ty≥
(
Mu…iCurs‹
 *
pC§
, *
≥Ty≥
){

3324 
	`as£π
–
pC§
->
aTªe
 );

3325 
	`mu…iCurs‹GëKey
(
pC§
,ÖC§->
aTªe
[1], 
≥Ty≥
, 0, 0);

3326  
LSM_OK
;

3327 
	}
}

3335 
	$mîgeW‹kîPageOff£t
(
u8
 *
aD©a
, 
nD©a
){

3336 
nRec
;

3337 
iOff
;

3338 
nKey
;

3339 
eTy≥
;

3341 
nRec
 = 
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)]);

3342 
iOff
 = 
	`lsmGëU16
(&
aD©a
[
	`SEGMENT_CELLPTR_OFFSET
(
nD©a
, 
nRec
-1)]);

3343 
eTy≥
 = 
aD©a
[
iOff
++];

3344 
	`as£π
–
eTy≥
==0

3345 || 
eTy≥
==(
LSM_SYSTEMKEY
|
LSM_SEPARATOR
)

3346 || 
eTy≥
==(
LSM_SEPARATOR
)

3349 
iOff
 +
	`lsmV¨ötGë32
(&
aD©a
[iOff], &
nKey
);

3350 
iOff
 +
	`lsmV¨ötGë32
(&
aD©a
[iOff], &
nKey
);

3352  
iOff
 + (
eTy≥
 ? 
nKey
 : 0);

3353 
	}
}

3370 
	$mîgeW‹kîMoveHõørchy
(

3371 
MîgeW‹kî
 *
pMW
,

3372 
bSï


3374 
lsm_db
 *
pDb
 = 
pMW
->pDb;

3375 
rc
 = 
LSM_OK
;

3376 
i
;

3377 
Page
 **
≠Hõr
 = 
pMW
->
hõr
.apHier;

3378 
nHõr
 = 
pMW
->
hõr
.nHier;

3380 
i
=0; 
rc
==
LSM_OK
 && i<
nHõr
; i++){

3381 
Page
 *
pNew
 = 0;

3382 
rc
 = 
	`lsmFsS‹ãdAµíd
(
pDb
->
pFS
,ÖDb->
pW‹kî
, 
pMW
->
pLevñ
, 1, &
pNew
);

3383 
	`as£π
–
rc
==
LSM_OK
 );

3385 if–
rc
==
LSM_OK
 ){

3386 
u8
 *
a1
; 
n1
;

3387 
u8
 *
a2
; 
n2
;

3389 
a1
 = 
	`fsPageD©a
(
pNew
, &
n1
);

3390 
a2
 = 
	`fsPageD©a
(
≠Hõr
[
i
], &
n2
);

3392 
	`as£π
–
n1
==
n2
 ||Ç1+4==n2 );

3394 if–
n1
==
n2
 ){

3395 
	`mem˝y
(
a1
, 
a2
, 
n2
);

3397 
nE¡ry
 = 
	`∑geGëNRec
(
a2
, 
n2
);

3398 
iEof1
 = 
	`SEGMENT_EOF
(
n1
, 
nE¡ry
);

3399 
iEof2
 = 
	`SEGMENT_EOF
(
n2
, 
nE¡ry
);

3401 
	`mem˝y
(
a1
, 
a2
, 
iEof2
 - 4);

3402 
	`mem˝y
(&
a1
[
iEof1
], &
a2
[
iEof2
], 
n2
 - iEof2);

3405 
	`lsmFsPageRñó£
(
≠Hõr
[
i
]);

3406 
≠Hõr
[
i
] = 
pNew
;

3409 
	`as£π
–
n1
==
n2
 ||Ç1+4==n2 ||Ç2+4==n1 );

3410 if–
n1
>=
n2
 ){

3416 
nE¡ry
 = 
	`∑geGëNRec
(
a2
, 
n2
);

3417 
iEof1
 = 
	`SEGMENT_EOF
(
n1
, 
nE¡ry
);

3418 
iEof2
 = 
	`SEGMENT_EOF
(
n2
, 
nE¡ry
);

3419 
	`mem˝y
(
a1
, 
a2
, 
iEof2
);

3420 
	`mem˝y
(&
a1
[
iEof1
], &
a2
[
iEof2
], 
n2
 - iEof2);

3421 
	`lsmFsPageRñó£
(
≠Hõr
[
i
]);

3422 
≠Hõr
[
i
] = 
pNew
;

3424 
	`lsmPutU16
(&
a1
[
	`SEGMENT_FLAGS_OFFSET
(
n1
)], 
SEGMENT_BTREE_FLAG
);

3425 
	`lsmPutU16
(&
a1
[
	`SEGMENT_NRECORD_OFFSET
(
n1
)], 0);

3426 
	`lsmPutU64
(&
a1
[
	`SEGMENT_POINTER_OFFSET
(
n1
)], 0);

3427 
i
 = i - 1;

3428 
	`lsmFsPageRñó£
(
pNew
);

3434 #ifde‡
LSM_DEBUG


3435 if–
rc
==
LSM_OK
 ){

3436 
i
=0; i<
nHõr
; i++Ë
	`as£π
–
	`lsmFsPageWrôabÀ
(
≠Hõr
[i]) );

3440  
rc
;

3441 
	}
}

3446 
	$mîgeW‹kîLﬂdHõørchy
(
MîgeW‹kî
 *
pMW
){

3447 
rc
 = 
LSM_OK
;

3448 
Segmít
 *
pSeg
;

3449 
Hõørchy
 *
p
;

3451 
pSeg
 = &
pMW
->
pLevñ
->
lhs
;

3452 
p
 = &
pMW
->
hõr
;

3454 if–
p
->
≠Hõr
==0 && 
pSeg
->
iRoŸ
!=0 ){

3455 
FûeSy°em
 *
pFS
 = 
pMW
->
pDb
->pFS;

3456 
lsm_ív
 *
pEnv
 = 
pMW
->
pDb
->pEnv;

3457 
Page
 **
≠Hõr
 = 0;

3458 
nHõr
 = 0;

3459 
iPg
 = 
pSeg
->
iRoŸ
;

3462 
Page
 *
pPg
 = 0;

3463 
u8
 *
aD©a
;

3464 
nD©a
;

3465 
Êags
;

3467 
rc
 = 
	`lsmFsDbPageGë
(
pFS
, 
pSeg
, 
iPg
, &
pPg
);

3468 if–
rc
!=
LSM_OK
 ) ;

3470 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

3471 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

3472 if–
Êags
&
SEGMENT_BTREE_FLAG
 ){

3473 
Page
 **
≠New
 = (Pagê**)
	`lsmRóŒoc
(

3474 
pEnv
, 
≠Hõr
, (
Page
 *)*(
nHõr
+1)

3476 if–
≠New
==0 ){

3477 
rc
 = 
LSM_NOMEM_BKPT
;

3480 
≠Hõr
 = 
≠New
;

3481 
	`memmove
(&
≠Hõr
[1], &≠Hõr[0], (
Page
 *Ë* 
nHõr
);

3482 
nHõr
++;

3484 
≠Hõr
[0] = 
pPg
;

3485 
iPg
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

3487 
	`lsmFsPageRñó£
(
pPg
);

3492 if–
rc
==
LSM_OK
 ){

3493 
u8
 *
aD©a
;

3494 
nD©a
;

3495 
aD©a
 = 
	`fsPageD©a
(
≠Hõr
[0], &
nD©a
);

3496 
pMW
->
aSave
[0].
iPgno
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

3497 
p
->
nHõr
 =ÇHier;

3498 
p
->
≠Hõr
 =ápHier;

3499 
rc
 = 
	`mîgeW‹kîMoveHõørchy
(
pMW
, 0);

3501 
i
;

3502 
i
=0; i<
nHõr
; i++){

3503 
	`lsmFsPageRñó£
(
≠Hõr
[
i
]);

3505 
	`lsmFªe
(
pEnv
, 
≠Hõr
);

3509  
rc
;

3510 
	}
}

3552 
	$mîgeW‹kîBåìWrôe
(

3553 
MîgeW‹kî
 *
pMW
,

3554 
u8
 
eTy≥
,

3555 
Pgno
 
iPå
,

3556 
Pgno
 
iKeyPg
,

3557 *
pKey
,

3558 
nKey


3560 
Hõørchy
 *
p
 = &
pMW
->
hõr
;

3561 
lsm_db
 *
pDb
 = 
pMW
->pDb;

3562 
rc
 = 
LSM_OK
;

3563 
iLevñ
;

3564 
nD©a
;

3565 
u8
 *
aD©a
;

3566 
iOff
;

3567 
nRec
;

3571 
	`as£π
–(
eTy≥
==0)==(
iKeyPg
!=0) );

3581 
iLevñ
=0; iLevñ<=
p
->
nHõr
; iLevel++){

3582 
nByã
;

3584 if–
iLevñ
==
p
->
nHõr
 ){

3586 
Page
 **
aNew
;

3587 
aNew
 = (
Page
 **)
	`lsmRóŒoc
(

3588 
pMW
->
pDb
->
pEnv
, 
p
->
≠Hõr
, (
Page
 *)*’->
nHõr
+1)

3590 if–!
aNew
 ){

3591  
LSM_NOMEM_BKPT
;

3593 
p
->
≠Hõr
 = 
aNew
;

3595 
Page
 *
pOld
;

3596 
nFªe
;

3600 
pOld
 = 
p
->
≠Hõr
[
iLevñ
];

3601 
	`as£π
–
	`lsmFsPageWrôabÀ
(
pOld
) );

3602 
aD©a
 = 
	`fsPageD©a
(
pOld
, &
nD©a
);

3603 if–
eTy≥
==0 ){

3604 
nByã
 = 2 + 1 + 
	`lsmV¨ötLí32
(
iPå
Ë+ÜsmV¨ötLí32(
iKeyPg
);

3606 
nByã
 = 2 + 1 + 
	`lsmV¨ötLí32
(
iPå
Ë+ÜsmV¨ötLí32(
nKey
) +ÇKey;

3608 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

3609 
nFªe
 = 
	`SEGMENT_EOF
(
nD©a
, 
nRec
Ë- 
	`mîgeW‹kîPageOff£t
(
aD©a
,ÇData);

3610 if–
nByã
<=
nFªe
 ) ;

3614 
	`lsmPutU64
(&
aD©a
[
	`SEGMENT_POINTER_OFFSET
(
nD©a
)], 
iPå
);

3615 
	`as£π
–
	`lsmFsPageNumbî
(
pOld
)==0 );

3616 
rc
 = 
	`lsmFsPagePîsi°
(
pOld
);

3617 if–
rc
==
LSM_OK
 ){

3618 
iPå
 = 
	`lsmFsPageNumbî
(
pOld
);

3619 
	`lsmFsPageRñó£
(
pOld
);

3624 
p
->
≠Hõr
[
iLevñ
] = 0;

3625 if–
rc
==
LSM_OK
 ){

3626 
rc
 = 
	`lsmFsS‹ãdAµíd
(

3627 
pDb
->
pFS
,ÖDb->
pW‹kî
, 
pMW
->
pLevñ
, 1, &
p
->
≠Hõr
[
iLevñ
]

3630 if–
rc
!=
LSM_OK
 ) Ñc;

3632 
aD©a
 = 
	`fsPageD©a
(
p
->
≠Hõr
[
iLevñ
], &
nD©a
);

3633 
	`mem£t
(
aD©a
, 0, 
nD©a
);

3634 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_FLAGS_OFFSET
(
nD©a
)], 
SEGMENT_BTREE_FLAG
);

3635 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)], 0);

3637 if–
iLevñ
==
p
->
nHõr
 ){

3638 
p
->
nHõr
++;

3644 
aD©a
 = 
	`fsPageD©a
(
p
->
≠Hõr
[
iLevñ
], &
nD©a
);

3645 
iOff
 = 
	`mîgeW‹kîPageOff£t
(
aD©a
, 
nD©a
);

3646 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

3647 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_CELLPTR_OFFSET
(
nD©a
, 
nRec
)], 
iOff
);

3648 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)], 
nRec
+1);

3649 if–
eTy≥
==0 ){

3650 
aD©a
[
iOff
++] = 0x00;

3651 
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
iPå
);

3652 
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
iKeyPg
);

3654 
aD©a
[
iOff
++] = 
eTy≥
;

3655 
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
iPå
);

3656 
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
nKey
);

3657 
	`mem˝y
(&
aD©a
[
iOff
], 
pKey
, 
nKey
);

3660  
rc
;

3661 
	}
}

3663 
	$mîgeW‹kîBåìIndúe˘
(
MîgeW‹kî
 *
pMW
){

3664 
rc
 = 
LSM_OK
;

3665 if–
pMW
->
iIndúe˘
 ){

3666 
Pgno
 
iKeyPg
 = 
pMW
->
aSave
[1].
iPgno
;

3667 
rc
 = 
	`mîgeW‹kîBåìWrôe
(
pMW
, 0,ÖMW->
iIndúe˘
, 
iKeyPg
, 0, 0);

3668 
pMW
->
iIndúe˘
 = 0;

3670  
rc
;

3671 
	}
}

3680 
	$mîgeW‹kîPushHõørchy
(

3681 
MîgeW‹kî
 *
pMW
,

3682 
iT›ic
,

3683 *
pKey
,

3684 
nKey


3686 
rc
 = 
LSM_OK
;

3687 
Pgno
 
iPå
;

3689 
	`as£π
–
pMW
->
aSave
[0].
bSt‹e
==0 );

3690 
	`as£π
–
pMW
->
aSave
[1].
bSt‹e
==0 );

3691 
rc
 = 
	`mîgeW‹kîBåìIndúe˘
(
pMW
);

3696 
iPå
 = 
pMW
->
aSave
[0].
iPgno
;

3697 
	`as£π
–
iPå
!=0 );

3700 if–(
nKey
*4 > 
	`lsmFsPageSize
(
pMW
->
pDb
->
pFS
)) ){

3701 
pMW
->
iIndúe˘
 = 
iPå
;

3702 
pMW
->
aSave
[1].
bSt‹e
 = 1;

3704 
rc
 = 
	`mîgeW‹kîBåìWrôe
(

3705 
pMW
, (
u8
)(
iT›ic
 | 
LSM_SEPARATOR
), 
iPå
, 0, 
pKey
, 
nKey


3710  
rc
;

3711 
	}
}

3713 
	$mîgeW‹kîFöishHõørchy
(

3714 
MîgeW‹kî
 *
pMW


3716 
i
;

3717 
rc
 = 
LSM_OK
;

3718 
Pgno
 
iPå
;

3720 
iPå
 = 
pMW
->
aSave
[0].
iPgno
;

3721 
i
=0; i<
pMW
->
hõr
.
nHõr
 && 
rc
==
LSM_OK
; i++){

3722 
Page
 *
pPg
 = 
pMW
->
hõr
.
≠Hõr
[
i
];

3723 
nD©a
;

3724 
u8
 *
aD©a
;

3726 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

3727 
	`lsmPutU64
(&
aD©a
[
	`SEGMENT_POINTER_OFFSET
(
nD©a
)], 
iPå
);

3729 
rc
 = 
	`lsmFsPagePîsi°
(
pPg
);

3730 
iPå
 = 
	`lsmFsPageNumbî
(
pPg
);

3731 
	`lsmFsPageRñó£
(
pPg
);

3734 if–
pMW
->
hõr
.
nHõr
 ){

3735 
pMW
->
pLevñ
->
lhs
.
iRoŸ
 = 
iPå
;

3736 
	`lsmFªe
(
pMW
->
pDb
->
pEnv
,ÖMW->
hõr
.
≠Hõr
);

3737 
pMW
->
hõr
.
≠Hõr
 = 0;

3738 
pMW
->
hõr
.
nHõr
 = 0;

3741  
rc
;

3742 
	}
}

3744 
	$mîgeW‹kîAddPaddög
(

3745 
MîgeW‹kî
 *
pMW


3747 
FûeSy°em
 *
pFS
 = 
pMW
->
pDb
->pFS;

3748  
	`lsmFsS‹ãdPaddög
(
pFS
, 
pMW
->
pDb
->
pW‹kî
, &pMW->
pLevñ
->
lhs
);

3749 
	}
}

3756 
	$mîgeW‹kîRñó£AŒ
(
MîgeW‹kî
 *
pMW
){

3757 
i
;

3758 
	`lsmFsPageRñó£
(
pMW
->
pPage
);

3759 
pMW
->
pPage
 = 0;

3761 
i
=0; i<
pMW
->
hõr
.
nHõr
; i++){

3762 
	`lsmFsPageRñó£
(
pMW
->
hõr
.
≠Hõr
[
i
]);

3763 
pMW
->
hõr
.
≠Hõr
[
i
] = 0;

3765 
	`lsmFªe
(
pMW
->
pDb
->
pEnv
,ÖMW->
hõr
.
≠Hõr
);

3766 
pMW
->
hõr
.
≠Hõr
 = 0;

3767 
pMW
->
hõr
.
nHõr
 = 0;

3768 
	}
}

3770 
	$keyszToSkù
(
FûeSy°em
 *
pFS
, 
nKey
){

3771 
nPgsz
;

3772 
nPgsz
 = 
	`lsmFsPageSize
(
pFS
);

3773  
	`LSM_MIN
(((
nKey
 * 4Ë/ 
nPgsz
), 3);

3774 
	}
}

3781 
	$mîgeW‹kîPîsi°AndRñó£
(
MîgeW‹kî
 *
pMW
){

3782 
rc
;

3783 
i
;

3785 
	`as£π
–
pMW
->
pPage
 || (pMW->
aSave
[0].
bSt‹e
==0 &&ÖMW->aSave[1].bStore==0) );

3788 
rc
 = 
	`lsmFsPagePîsi°
(
pMW
->
pPage
);

3791 
i
=0; i<2; i++){

3792 if–
pMW
->
aSave
[
i
].
bSt‹e
 ){

3793 
pMW
->
aSave
[
i
].
iPgno
 = 
	`lsmFsPageNumbî
’MW->
pPage
);

3794 
pMW
->
aSave
[
i
].
bSt‹e
 = 0;

3799 
	`lsmFsPageRñó£
(
pMW
->
pPage
);

3800 
pMW
->
pPage
 = 0;

3801  
rc
;

3802 
	}
}

3812 
	$mîgeW‹kîNextPage
(

3813 
MîgeW‹kî
 *
pMW
,

3814 
Pgno
 
iFPå


3816 
rc
 = 
LSM_OK
;

3817 
Page
 *
pNext
 = 0;

3818 
lsm_db
 *
pDb
 = 
pMW
->pDb;

3820 
rc
 = 
	`lsmFsS‹ãdAµíd
(
pDb
->
pFS
,ÖDb->
pW‹kî
, 
pMW
->
pLevñ
, 0, &
pNext
);

3821 
	`as£π
–
rc
 || 
pMW
->
pLevñ
->
lhs
.
iFú°
>0 ||ÖMW->
pDb
->
com¥ess
.
xCom¥ess
 );

3823 if–
rc
==
LSM_OK
 ){

3824 
u8
 *
aD©a
;

3825 
nD©a
;

3827 
rc
 = 
	`mîgeW‹kîPîsi°AndRñó£
(
pMW
);

3829 
pMW
->
pPage
 = 
pNext
;

3830 
pMW
->
pLevñ
->
pMîge
->
iOuçutOff
 = 0;

3831 
aD©a
 = 
	`fsPageD©a
(
pNext
, &
nD©a
);

3832 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)], 0);

3833 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_FLAGS_OFFSET
(
nD©a
)], 0);

3834 
	`lsmPutU64
(&
aD©a
[
	`SEGMENT_POINTER_OFFSET
(
nD©a
)], 
iFPå
);

3835 
pMW
->
nW‹k
++;

3838  
rc
;

3839 
	}
}

3848 
	$mîgeW‹kîD©a
(

3849 
MîgeW‹kî
 *
pMW
,

3850 
bSï
,

3851 
iFPå
,

3852 
u8
 *
aWrôe
,

3853 
nWrôe


3855 
rc
 = 
LSM_OK
;

3856 
nRem
 = 
nWrôe
;

3858  
nRem
>0 ){

3859 
Mîge
 *
pMîge
 = 
pMW
->
pLevñ
->pMerge;

3860 
nC›y
;

3861 
u8
 *
aD©a
;

3862 
nD©a
;

3863 
nRec
;

3864 
iOff
;

3866 
	`as£π
–
	`lsmFsPageWrôabÀ
(
pMW
->
pPage
) );

3868 
aD©a
 = 
	`fsPageD©a
(
pMW
->
pPage
, &
nD©a
);

3869 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

3870 
iOff
 = 
pMîge
->
iOuçutOff
;

3871 
nC›y
 = 
	`LSM_MIN
(
nRem
, 
	`SEGMENT_EOF
(
nD©a
, 
nRec
Ë- 
iOff
);

3873 
	`mem˝y
(&
aD©a
[
iOff
], &
aWrôe
[
nWrôe
-
nRem
], 
nC›y
);

3874 
nRem
 -
nC›y
;

3876 if–
nRem
>0 ){

3877 
rc
 = 
	`mîgeW‹kîNextPage
(
pMW
, 
iFPå
);

3879 
pMîge
->
iOuçutOff
 = 
iOff
 + 
nC›y
;

3883  
rc
;

3884 
	}
}

3892 
	$mîgeW‹kîFú°Page
(
MîgeW‹kî
 *
pMW
){

3893 
rc
 = 
LSM_OK
;

3894 
Page
 *
pPg
 = 0;

3895 
iFPå
 = 0;

3896 
Mu…iCurs‹
 *
pC§
 = 
pMW
->pCsr;

3898 
	`as£π
–
pMW
->
pPage
==0 );

3900 if–
pC§
->
pBtC§
 ){

3901 
rc
 = 
LSM_OK
;

3902 
iFPå
 = 
pMW
->
pLevñ
->
pNext
->
lhs
.
iFú°
;

3903 }if–
pC§
->
nPå
>0 ){

3904 
Segmít
 *
pSeg
;

3905 
pSeg
 = 
pC§
->
aPå
[pC§->
nPå
-1].pSeg;

3906 
rc
 = 
	`lsmFsDbPageGë
(
pMW
->
pDb
->
pFS
, 
pSeg
,ÖSeg->
iFú°
, &
pPg
);

3907 if–
rc
==
LSM_OK
 ){

3908 
u8
 *
aD©a
;

3909 
nD©a
;

3910 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

3911 
iFPå
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

3912 
	`lsmFsPageRñó£
(
pPg
);

3916 if–
rc
==
LSM_OK
 ){

3917 
rc
 = 
	`mîgeW‹kîNextPage
(
pMW
, 
iFPå
);

3918 if–
pC§
->
pPªvMîgePå
 ) *pC§->pPªvMîgePå = 
iFPå
;

3919 
pMW
->
aSave
[0].
bSt‹e
 = 1;

3922  
rc
;

3923 
	}
}

3925 
	$mîgeW‹kîWrôe
(

3926 
MîgeW‹kî
 *
pMW
,

3927 
eTy≥
,

3928 *
pKey
, 
nKey
,

3929 *
pVÆ
, 
nVÆ
,

3930 
iPå


3932 
rc
 = 
LSM_OK
;

3933 
Mîge
 *
pMîge
;

3934 
nHdr
;

3935 
Page
 *
pPg
;

3936 
u8
 *
aD©a
;

3937 
nD©a
;

3938 
nRec
;

3939 
iFPå
;

3940 
iRPå
 = 0;

3941 
iOff
;

3942 
Segmít
 *
pSeg
;

3943 
Êags
 = 0;

3944 
bFú°
 = 0;

3946 
pMîge
 = 
pMW
->
pLevñ
->pMerge;

3947 
pSeg
 = &
pMW
->
pLevñ
->
lhs
;

3949 if–
pSeg
->
iFú°
==0 && 
pMW
->
pPage
==0 ){

3950 
rc
 = 
	`mîgeW‹kîFú°Page
(
pMW
);

3951 
bFú°
 = 1;

3953 
pPg
 = 
pMW
->
pPage
;

3954 if–
pPg
 ){

3955 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

3956 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

3957 
iFPå
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

3958 
iRPå
 = 
iPå
 - 
iFPå
;

3975 if–
rc
==
LSM_OK
 ){

3976 
nHdr
 = 1 + 
	`lsmV¨ötLí32
(
iRPå
Ë+ÜsmV¨ötLí32(
nKey
);

3977 if–
	`πIsWrôe
(
eTy≥
ËË
nHdr
 +
	`lsmV¨ötLí32
(
nVÆ
);

3981 
iOff
 = 
pMîge
->
iOuçutOff
;

3982 if–
iOff
<0 || 
pPg
==0 || iOff+
nHdr
 > 
	`SEGMENT_EOF
(
nD©a
, 
nRec
+1) ){

3983 
iFPå
 = *
pMW
->
pC§
->
pPªvMîgePå
;

3984 
iRPå
 = 
iPå
 - 
iFPå
;

3985 
iOff
 = 0;

3986 
nRec
 = 0;

3987 
rc
 = 
	`mîgeW‹kîNextPage
(
pMW
, 
iFPå
);

3988 
pPg
 = 
pMW
->
pPage
;

3996 if–
rc
==
LSM_OK
 && 
nRec
==0 && 
bFú°
==0 ){

3997 
	`as£π
–
pMîge
->
nSkù
>=0 );

3999 if–
pMîge
->
nSkù
==0 ){

4000 
rc
 = 
	`mîgeW‹kîPushHõørchy
(
pMW
, 
	`πT›ic
(
eTy≥
), 
pKey
, 
nKey
);

4001 
	`as£π
–
pMW
->
aSave
[0].
bSt‹e
==0 );

4002 
pMW
->
aSave
[0].
bSt‹e
 = 1;

4003 
pMîge
->
nSkù
 = 
	`keyszToSkù
(
pMW
->
pDb
->
pFS
, 
nKey
);

4005 
pMîge
->
nSkù
--;

4006 
Êags
 = 
PGFTR_SKIP_THIS_FLAG
;

4009 if–
pMîge
->
nSkù
 ) 
Êags
 |
PGFTR_SKIP_NEXT_FLAG
;

4013 if–
rc
==
LSM_OK
 ){

4014 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

4017 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_NRECORD_OFFSET
(
nD©a
)], 
nRec
+1);

4018 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_CELLPTR_OFFSET
(
nD©a
, 
nRec
)], 
iOff
);

4019 if–
Êags
 ) 
	`lsmPutU16
(&
aD©a
[
	`SEGMENT_FLAGS_OFFSET
(
nD©a
)], flags);

4022 
aD©a
[
iOff
++] = 
eTy≥
;

4023 
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
iRPå
);

4024 
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
nKey
);

4025 if–
	`πIsWrôe
(
eTy≥
ËË
iOff
 +
	`lsmV¨ötPut32
(&
aD©a
[iOff], 
nVÆ
);

4026 
pMîge
->
iOuçutOff
 = 
iOff
;

4029 
	`as£π
–
iFPå
==
	`∑geGëPå
(
aD©a
, 
nD©a
) );

4030 
rc
 = 
	`mîgeW‹kîD©a
(
pMW
, 0, 
iFPå
+
iRPå
, 
pKey
, 
nKey
);

4031 if–
rc
==
LSM_OK
 && 
	`πIsWrôe
(
eTy≥
) ){

4032 if–
rc
==
LSM_OK
 ){

4033 
rc
 = 
	`mîgeW‹kîD©a
(
pMW
, 0, 
iFPå
+
iRPå
, 
pVÆ
, 
nVÆ
);

4038  
rc
;

4039 
	}
}

4045 
	$mîgeW‹kîShutdown
(
MîgeW‹kî
 *
pMW
, *
pRc
){

4046 
i
;

4047 
rc
 = *
pRc
;

4048 
Mu…iCurs‹
 *
pC§
 = 
pMW
->pCsr;

4053 if–
rc
==
LSM_OK
 && 
pC§
 && 
	`lsmMCurs‹VÆid
(pCsr) ){

4054 
Mîge
 *
pMîge
 = 
pMW
->
pLevñ
->pMerge;

4055 
bBåì
 = (
pC§
->
pBtC§
!=0);

4056 
iPå
;

4059 
	`as£π
–
pMîge
->
nI≈ut
==0 || 
pMW
->
pLevñ
->
nRight
>0 );

4060 
	`as£π
–
pMîge
->
nI≈ut
==0 ||ÖMîge->nI≈ut==(
pC§
->
nPå
+
bBåì
) );

4062 
i
=0; i<(
pMîge
->
nI≈ut
-
bBåì
); i++){

4063 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[
i
];

4064 if–
pPå
->
pPg
 ){

4065 
pMîge
->
aI≈ut
[
i
].
iPg
 = 
	`lsmFsPageNumbî
(
pPå
->
pPg
);

4066 
pMîge
->
aI≈ut
[
i
].
iCñl
 = 
pPå
->iCell;

4068 
pMîge
->
aI≈ut
[
i
].
iPg
 = 0;

4069 
pMîge
->
aI≈ut
[
i
].
iCñl
 = 0;

4072 if–
bBåì
 && 
pMîge
->
nI≈ut
 ){

4073 
	`as£π
–
i
==
pC§
->
nPå
 );

4074 
	`båìCurs‹Posôi⁄
(
pC§
->
pBtC§
, &
pMîge
->
aI≈ut
[
i
]);

4078 
iPå
 = 
pC§
->
aTªe
[1] - 
CURSOR_DATA_SEGMENT
;

4079 if–
iPå
<
pC§
->
nPå
 ){

4080 
pMîge
->
•lôkey
 =ÖMîge->
aI≈ut
[
iPå
];

4082 
	`båìCurs‹S∂ôkey
(
pC§
->
pBtC§
, &
pMîge
->
•lôkey
);

4085 
pMîge
->
iOuçutOff
 = -1;

4088 
	`lsmMCurs‹Clo£
(
pC§
, 0);

4091 if–
rc
==
LSM_OK
 )Ñ¯
	`mîgeW‹kîPîsi°AndRñó£
(
pMW
);

4092 if–
rc
==
LSM_OK
 )Ñ¯
	`mîgeW‹kîBåìIndúe˘
(
pMW
);

4093 if–
rc
==
LSM_OK
 )Ñ¯
	`mîgeW‹kîFöishHõørchy
(
pMW
);

4094 if–
rc
==
LSM_OK
 )Ñ¯
	`mîgeW‹kîAddPaddög
(
pMW
);

4095 
	`lsmFsFlushWaôög
(
pMW
->
pDb
->
pFS
, &
rc
);

4096 
	`mîgeW‹kîRñó£AŒ
(
pMW
);

4098 
	`lsmFªe
(
pMW
->
pDb
->
pEnv
,ÖMW->
aGobbÀ
);

4099 
pMW
->
aGobbÀ
 = 0;

4100 
pMW
->
pC§
 = 0;

4102 *
pRc
 = 
rc
;

4103 
	}
}

4114 
	$mîgeR™geDñëes
(
Mu…iCurs‹
 *
pC§
, *
piVÆ
, *
piFœgs
){

4115 
f
 = *
piFœgs
;

4116 
iKey
 = 
pC§
->
aTªe
[1];

4117 
i
;

4119 
	`as£π
–
pC§
->
Êags
 & 
CURSOR_NEXT_OK
 );

4120 if–
pC§
->
Êags
 & 
CURSOR_IGNORE_DELETE
 ){

4124 
	`as£π
–(
f
 & 
LSM_POINT_DELETE
)==0 );

4125 
f
 &~(
LSM_START_DELETE
|
LSM_END_DELETE
);

4127 
i
=0; i<(
CURSOR_DATA_SEGMENT
 + 
pC§
->
nPå
); i++){

4128 if–
i
!=
iKey
 ){

4129 
eTy≥
;

4130 *
pKey
;

4131 
nKey
;

4132 
ªs
;

4133 
	`mu…iCurs‹GëKey
(
pC§
, 
i
, &
eTy≥
, &
pKey
, &
nKey
);

4135 if–
pKey
 ){

4136 
ªs
 = 
	`s‹ãdKeyCom∑ª
(
pC§
->
pDb
->
xCmp
,

4137 
	`πT›ic
(
pC§
->
eTy≥
),ÖC§->
key
.
pD©a
,ÖC§->key.
nD©a
,

4138 
	`πT›ic
(
eTy≥
), 
pKey
, 
nKey


4140 
	`as£π
–
ªs
<=0 );

4141 if–
ªs
==0 ){

4142 if–(
f
 & (
LSM_INSERT
|
LSM_POINT_DELETE
))==0 ){

4143 if–
eTy≥
 & 
LSM_INSERT
 ){

4144 
f
 |
LSM_INSERT
;

4145 *
piVÆ
 = 
i
;

4147 if–
eTy≥
 & 
LSM_POINT_DELETE
 ){

4148 
f
 |
LSM_POINT_DELETE
;

4151 
f
 |(
eTy≥
 & (
LSM_END_DELETE
|
LSM_START_DELETE
));

4154 if–
i
>
iKey
 && (
eTy≥
 & 
LSM_END_DELETE
Ë&& 
ªs
<0 ){

4155 if–
f
 & (
LSM_INSERT
|
LSM_POINT_DELETE
) ){

4156 
f
 |(
LSM_END_DELETE
|
LSM_START_DELETE
);

4158 
f
 = 0;

4166 
	`as£π
–(
f
 & 
LSM_INSERT
)==0 || (‡& 
LSM_POINT_DELETE
)==0 );

4167 if–(
f
 & 
LSM_START_DELETE
)

4168 && (
f
 & 
LSM_END_DELETE
)

4169 && (
f
 & 
LSM_POINT_DELETE
 )

4171 
f
 = 0;

4175 *
piFœgs
 = 
f
;

4176 
	}
}

4178 
	$mîgeW‹kîSãp
(
MîgeW‹kî
 *
pMW
){

4179 
lsm_db
 *
pDb
 = 
pMW
->pDb;

4180 
Mu…iCurs‹
 *
pC§
;

4181 
rc
 = 
LSM_OK
;

4182 
eTy≥
;

4183 *
pKey
; 
nKey
;

4184 
Pgno
 
iPå
;

4185 
iVÆ
;

4187 
pC§
 = 
pMW
->pCsr;

4190 
	`lsmMCurs‹Key
(
pC§
, &
pKey
, &
nKey
);

4191 
eTy≥
 = 
pC§
->eType;

4199 
iPå
 = (
pC§
->
pPªvMîgePå
 ? *pCsr->pPrevMergePtr : 0);

4200 if–
pC§
->
pBtC§
 ){

4201 
BåìCurs‹
 *
pBtC§
 = 
pC§
->pBtCsr;

4202 if–
pBtC§
->
pKey
 ){

4203 
ªs
 = 
	`πT›ic
(
pBtC§
->
eTy≥
) -ÑtTopic(eType);

4204 if–
ªs
==0 )Ñe†
pDb
->
	`xCmp
(
pBtC§
->
pKey
,ÖBtC§->
nKey
,ÖKey,ÇKey);

4205 if–0==
ªs
 ) 
iPå
 = 
pBtC§
->iPtr;

4206 
	`as£π
–
ªs
>=0 );

4208 }if–
pC§
->
nPå
 ){

4209 
SegmítPå
 *
pPå
 = &
pC§
->
aPå
[pC§->
nPå
-1];

4210 if–
pPå
->
pPg


4211 && 0==
pDb
->
	`xCmp
(
pPå
->
pKey
,ÖPå->
nKey
,ÖKey,ÇKey)

4213 
iPå
 = 
pPå
->iPå+pPå->
iPgPå
;

4217 
iVÆ
 = 
pC§
->
aTªe
[1];

4218 
	`mîgeR™geDñëes
(
pC§
, &
iVÆ
, &
eTy≥
);

4220 if–
eTy≥
!=0 ){

4221 if–
pMW
->
aGobbÀ
 ){

4222 
iGobbÀ
 = 
pC§
->
aTªe
[1] - 
CURSOR_DATA_SEGMENT
;

4223 if–
iGobbÀ
<
pC§
->
nPå
 && iGobble>=0 ){

4224 
SegmítPå
 *
pGobbÀ
 = &
pC§
->
aPå
[
iGobbÀ
];

4225 if–(
pGobbÀ
->
Êags
 & 
PGFTR_SKIP_THIS_FLAG
)==0 ){

4226 
pMW
->
aGobbÀ
[
iGobbÀ
] = 
	`lsmFsPageNumbî
(
pGobbÀ
->
pPg
);

4234 if–
rc
==
LSM_OK
 && (
	`πIsSï¨©‹
(
eTy≥
)==0 || 
iPå
!=0) ){

4236 *
pVÆ
; 
nVÆ
;

4237 
rc
 = 
	`mu…iCurs‹GëVÆ
(
pC§
, 
iVÆ
, &
pVÆ
, &
nVÆ
);

4238 if–
pVÆ
 && 
rc
==
LSM_OK
 ){

4239 
	`as£π
–
nVÆ
>=0 );

4240 
rc
 = 
	`s‹ãdBlobSë
(
pDb
->
pEnv
, &
pC§
->
vÆ
, 
pVÆ
, 
nVÆ
);

4241 
pVÆ
 = 
pC§
->
vÆ
.
pD©a
;

4243 if–
rc
==
LSM_OK
 ){

4244 
rc
 = 
	`mîgeW‹kîWrôe
(
pMW
, 
eTy≥
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, 
iPå
);

4250 
	`as£π
–
	`lsmMCurs‹VÆid
(
pMW
->
pC§
) );

4251 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmMCurs‹Next
(
pMW
->
pC§
);

4253  
rc
;

4254 
	}
}

4256 
	$mîgeW‹kîD⁄e
(
MîgeW‹kî
 *
pMW
){

4257  
pMW
->
pC§
==0 || !
	`lsmMCurs‹VÆid
(pMW->pCsr);

4258 
	}
}

4260 
	$s‹ãdFªeLevñ
(
lsm_ív
 *
pEnv
, 
Levñ
 *
p
){

4261 if–
p
 ){

4262 
	`lsmFªe
(
pEnv
, 
p
->
pS∂ôKey
);

4263 
	`lsmFªe
(
pEnv
, 
p
->
pMîge
);

4264 
	`lsmFªe
(
pEnv
, 
p
->
aRhs
);

4265 
	`lsmFªe
(
pEnv
, 
p
);

4267 
	}
}

4269 
	$s‹ãdInvokeW‹kHook
(
lsm_db
 *
pDb
){

4270 if–
pDb
->
xW‹k
 ){

4271 
pDb
->
	`xW‹k
’Db,ÖDb->
pW‹kCtx
);

4273 
	}
}

4275 
	$s‹ãdNewT›Àvñ
(

4276 
lsm_db
 *
pDb
,

4277 
eTªe
,

4278 *
≤Wrôe


4280 
rc
 = 
LSM_OK
;

4281 
Mu…iCurs‹
 *
pC§
 = 0;

4282 
Levñ
 *
pNext
 = 0;

4283 
Levñ
 *
pNew
;

4284 
Segmít
 *
pLöked
 = 0;

4285 
Levñ
 *
pDñ
 = 0;

4286 
nWrôe
 = 0;

4287 
Fªñi°
 
‰ìli°
;

4289 if–
eTªe
!=
TREE_NONE
 ){

4290 
rc
 = 
	`lsmShmCacheChunks
(
pDb
,ÖDb->
åìhdr
.
nChunk
);

4293 
	`as£π
–
pDb
->
bU£Fªñi°
==0 );

4294 
pDb
->
pFªñi°
 = &
‰ìli°
;

4295 
pDb
->
bU£Fªñi°
 = 1;

4296 
	`mem£t
(&
‰ìli°
, 0, (freelist));

4299 
pNext
 = 
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);

4300 
pNew
 = (
Levñ
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (Levñ), &
rc
);

4301 if–
pNew
 ){

4302 
pNew
->
pNext
 =ÖNext;

4303 
	`lsmDbS«pshŸSëLevñ
(
pDb
->
pW‹kî
, 
pNew
);

4309 
pC§
 = 
	`mu…iCurs‹New
(
pDb
, &
rc
);

4310 if–
pC§
 ){

4311 
pC§
->
pDb
 =ÖDb;

4312 
rc
 = 
	`mu…iCurs‹VisôFªñi°
(
pC§
);

4313 if–
rc
==
LSM_OK
 ){

4314 
rc
 = 
	`mu…iCurs‹AddTªe
(
pC§
, 
pDb
->
pW‹kî
, 
eTªe
);

4316 if–
rc
==
LSM_OK
 && 
pNext
 &&ÖNext->
pMîge
==0 ){

4317 if–(
pNext
->
Êags
 & 
LEVEL_FREELIST_ONLY
) ){

4318 
pDñ
 = 
pNext
;

4319 
pC§
->
aPå
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
SegmítPå
), &
rc
);

4320 
	`mu…iCurs‹AddO√
(
pC§
, 
pNext
, &
rc
);

4321 }if–
eTªe
!=
TREE_NONE
 && 
pNext
->
lhs
.
iRoŸ
 ){

4322 
pLöked
 = &
pNext
->
lhs
;

4323 
rc
 = 
	`båìCurs‹New
(
pDb
, 
pLöked
, &
pC§
->
pBtC§
);

4329 if–
pNext
==0 ){

4330 
	`mu…iCurs‹Ign‹eDñëe
(
pC§
);

4334 if–
rc
!=
LSM_OK
 ){

4335 
	`lsmMCurs‹Clo£
(
pC§
, 0);

4337 
Pgno
 
iLe·På
 = 0;

4338 
Mîge
 
mîge
;

4339 
MîgeW‹kî
 
mîgew‹kî
;

4341 
	`mem£t
(&
mîge
, 0, (
Mîge
));

4342 
	`mem£t
(&
mîgew‹kî
, 0, (
MîgeW‹kî
));

4344 
pNew
->
pMîge
 = &
mîge
;

4345 
pNew
->
Êags
 |
LEVEL_INCOMPLETE
;

4346 
mîgew‹kî
.
pDb
 =ÖDb;

4347 
mîgew‹kî
.
pLevñ
 = 
pNew
;

4348 
mîgew‹kî
.
pC§
 =ÖCsr;

4349 
pC§
->
pPªvMîgePå
 = &
iLe·På
;

4352 
mîgew‹kî
.
bFlush
 = 1;

4355 if–
rc
==
LSM_OK
 )Ñ¯
	`lsmMCurs‹Fú°
(
pC§
);

4356  
rc
==
LSM_OK
 && 
	`mîgeW‹kîD⁄e
(&
mîgew‹kî
)==0 ){

4357 
rc
 = 
	`mîgeW‹kîSãp
(&
mîgew‹kî
);

4359 
	`mîgeW‹kîShutdown
(&
mîgew‹kî
, &
rc
);

4360 
	`as£π
–
rc
!=
LSM_OK
 || 
mîgew‹kî
.
nW‹k
==0 || 
pNew
->
lhs
.
iFú°
 );

4361 if–
rc
==
LSM_OK
 && 
pNew
->
lhs
.
iFú°
 ){

4362 
rc
 = 
	`lsmFsS‹ãdFöish
(
pDb
->
pFS
, &
pNew
->
lhs
);

4364 
nWrôe
 = 
mîgew‹kî
.
nW‹k
;

4365 
pNew
->
Êags
 &~
LEVEL_INCOMPLETE
;

4366 if–
eTªe
==
TREE_NONE
 ){

4367 
pNew
->
Êags
 |
LEVEL_FREELIST_ONLY
;

4369 
pNew
->
pMîge
 = 0;

4372 if–
rc
!=
LSM_OK
 || 
pNew
->
lhs
.
iFú°
==0 ){

4373 
	`as£π
–
rc
!=
LSM_OK
 || 
pDb
->
pW‹kî
->
‰ìli°
.
nE¡ry
==0 );

4374 
	`lsmDbS«pshŸSëLevñ
(
pDb
->
pW‹kî
, 
pNext
);

4375 
	`s‹ãdFªeLevñ
(
pDb
->
pEnv
, 
pNew
);

4377 if–
pLöked
 ){

4378 
pLöked
->
iRoŸ
 = 0;

4379 }if–
pDñ
 ){

4380 
	`as£π
–
pNew
->
pNext
==
pDñ
 );

4381 
pNew
->
pNext
 = 
pDñ
->pNext;

4382 
	`lsmFsS‹ãdDñëe
(
pDb
->
pFS
,ÖDb->
pW‹kî
, 1, &
pDñ
->
lhs
);

4383 
	`s‹ãdFªeLevñ
(
pDb
->
pEnv
, 
pDñ
);

4386 #i‡
LSM_LOG_STRUCTURE


4387 
	`lsmS‹ãdDumpSåu˘uª
(
pDb
,ÖDb->
pW‹kî
, 
LSM_LOG_DATA
, 0, "new-toplevel");

4390 if–
‰ìli°
.
nE¡ry
 ){

4391 
Fªñi°
 *
p
 = &
pDb
->
pW‹kî
->
‰ìli°
;

4392 
	`lsmFªe
(
pDb
->
pEnv
, 
p
->
aE¡ry
);

4393 
	`mem˝y
(
p
, &
‰ìli°
, (freelist));

4394 
‰ìli°
.
aE¡ry
 = 0;

4396 
pDb
->
pW‹kî
->
‰ìli°
.
nE¡ry
 = 0;

4399 
	`as£πBåìOk
(
pDb
, &
pNew
->
lhs
);

4400 
	`s‹ãdInvokeW‹kHook
(
pDb
);

4403 if–
≤Wrôe
 ) *≤Wrôê
nWrôe
;

4404 
pDb
->
pW‹kî
->
nWrôe
 +=ÇWrite;

4405 
pDb
->
pFªñi°
 = 0;

4406 
pDb
->
bU£Fªñi°
 = 0;

4407 
	`lsmFªe
(
pDb
->
pEnv
, 
‰ìli°
.
aE¡ry
);

4408  
rc
;

4409 
	}
}

4420 
	$s‹ãdMîgeSëup
(

4421 
lsm_db
 *
pDb
,

4422 
Levñ
 *
pLevñ
,

4423 
nMîge
,

4424 
Levñ
 **
µNew


4426 
rc
 = 
LSM_OK
;

4427 
Levñ
 *
pNew
;

4428 
bU£Next
 = 0;

4429 
Mîge
 *
pMîge
;

4430 
nByã
;

4432 #ifde‡
LSM_DEBUG


4433 
iLevñ
;

4434 
Levñ
 *
pX
 = 
pLevñ
;

4435 
iLevñ
=0; iLevñ<
nMîge
; iLevel++){

4436 
	`as£π
–
pX
->
nRight
==0 );

4437 
pX
 =ÖX->
pNext
;

4442 
pNew
 = (
Levñ
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (Levñ), &
rc
);

4443 if–
pNew
 ){

4444 
pNew
->
aRhs
 = (
Segmít
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
,

4445 
nMîge
 * (
Segmít
), &
rc
);

4449 if–
rc
==
LSM_OK
 ){

4450 
Levñ
 *
pNext
 = 0;

4451 
i
;

4452 
bFªeO∆y
 = 1;

4453 
Levñ
 *
pT›Levñ
;

4454 
Levñ
 *
p
 = 
pLevñ
;

4455 
Levñ
 **
µ
;

4456 
pNew
->
nRight
 = 
nMîge
;

4457 
pNew
->
iAge
 = 
pLevñ
->iAge+1;

4458 
i
=0; i<
nMîge
; i++){

4459 
	`as£π
–
p
->
nRight
==0 );

4460 
pNext
 = 
p
->pNext;

4461 
pNew
->
aRhs
[
i
] = 
p
->
lhs
;

4462 if–(
p
->
Êags
 & 
LEVEL_FREELIST_ONLY
)==0 ) 
bFªeO∆y
 = 0;

4463 
	`s‹ãdFªeLevñ
(
pDb
->
pEnv
, 
p
);

4464 
p
 = 
pNext
;

4467 if–
bFªeO∆y
 ) 
pNew
->
Êags
 |
LEVEL_FREELIST_ONLY
;

4470 
pT›Levñ
 = 
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);

4471 
pNew
->
pNext
 = 
p
;

4472 
µ
=&
pT›Levñ
; *µ!=
pLevñ
;Öp=&((*µ)->
pNext
));

4473 *
µ
 = 
pNew
;

4474 
	`lsmDbS«pshŸSëLevñ
(
pDb
->
pW‹kî
, 
pT›Levñ
);

4477 if–
pNext
 &&ÖNext->
pMîge
==0 &&ÖNext->
lhs
.
iRoŸ
 &&ÖNext

4478 && (
bFªeO∆y
==0 || (
pNext
->
Êags
 & 
LEVEL_FREELIST_ONLY
))

4480 
bU£Next
 = 1;

4485 
nByã
 = (
Mîge
Ë+ (
MîgeI≈ut
Ë* (
nMîge
 + 
bU£Next
);

4486 
pMîge
 = (
Mîge
 *)
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, 
nByã
, &
rc
);

4487 if–
pMîge
 ){

4488 
pMîge
->
aI≈ut
 = (
MîgeI≈ut
 *)&pMerge[1];

4489 
pMîge
->
nI≈ut
 = 
nMîge
 + 
bU£Next
;

4490 
pNew
->
pMîge
 =ÖMerge;

4493 *
µNew
 = 
pNew
;

4494  
rc
;

4495 
	}
}

4497 
	$mîgeW‹kîInô
(

4498 
lsm_db
 *
pDb
,

4499 
Levñ
 *
pLevñ
,

4500 
MîgeW‹kî
 *
pMW


4502 
rc
 = 
LSM_OK
;

4503 
Mîge
 *
pMîge
 = 
pLevñ
->pMerge;

4504 
Mu…iCurs‹
 *
pC§
 = 0;

4505 
Levñ
 *
pNext
 = 
pLevñ
->pNext;

4507 
	`as£π
–
pDb
->
pW‹kî
 );

4508 
	`as£π
–
pLevñ
->
pMîge
 );

4509 
	`as£π
–
pLevñ
->
nRight
>0 );

4511 
	`mem£t
(
pMW
, 0, (
MîgeW‹kî
));

4512 
pMW
->
pDb
 =ÖDb;

4513 
pMW
->
pLevñ
 =ÖLevel;

4514 
pMW
->
aGobbÀ
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
Pgno
Ë* 
pLevñ
->
nRight
, &
rc
);

4526 
pC§
 = 
	`mu…iCurs‹New
(
pDb
, &
rc
);

4527 if–
pC§
 ){

4528 
pC§
->
Êags
 |
CURSOR_NEXT_OK
;

4529 
rc
 = 
	`mu…iCurs‹AddRhs
(
pC§
, 
pLevñ
);

4531 if–
rc
==
LSM_OK
 && 
pMîge
->
nI≈ut
 > 
pLevñ
->
nRight
 ){

4532 
rc
 = 
	`båìCurs‹New
(
pDb
, &
pNext
->
lhs
, &
pC§
->
pBtC§
);

4533 }if–
pNext
 ){

4534 
	`mu…iCurs‹RódSï¨©‹s
(
pC§
);

4536 
	`mu…iCurs‹Ign‹eDñëe
(
pC§
);

4539 
	`as£π
–
rc
!=
LSM_OK
 || 
pMîge
->
nI≈ut
==(
pC§
->
nPå
+’C§->
pBtC§
!=0)) );

4540 
pMW
->
pC§
 =ÖCsr;

4543 if–
rc
==
LSM_OK
 )Ñ¯
	`mîgeW‹kîLﬂdHõørchy
(
pMW
);

4544 if–
rc
==
LSM_OK
 && 
pMW
->
hõr
.
nHõr
==0 ){

4545 
pMW
->
aSave
[0].
iPgno
 = 
pLevñ
->
lhs
.
iFú°
;

4549 if–
rc
==
LSM_OK
 ){

4550 
pC§
->
pPªvMîgePå
 = &
pMîge
->
iCuºítPå
;

4551 if–
pLevñ
->
lhs
.
iFú°
==0 ){

4554 
rc
 = 
	`mu…iCurs‹End
(
pC§
, 0);

4558 
i
;

4559 
i
=0; 
rc
==
LSM_OK
 && i<
pC§
->
nPå
; i++){

4560 
MîgeI≈ut
 *
pI≈ut
 = &
pMîge
->
aI≈ut
[
i
];

4561 if–
pI≈ut
->
iPg
 ){

4562 
SegmítPå
 *
pPå
;

4563 
	`as£π
–
pC§
->
aPå
[
i
].
pPg
==0 );

4564 
pPå
 = &
pC§
->
aPå
[
i
];

4565 
rc
 = 
	`£gmítPåLﬂdPage
(
pDb
->
pFS
, 
pPå
, 
pI≈ut
->
iPg
);

4566 if–
rc
==
LSM_OK
 && 
pPå
->
nCñl
>0 ){

4567 
rc
 = 
	`£gmítPåLﬂdCñl
(
pPå
, 
pI≈ut
->
iCñl
);

4572 if–
rc
==
LSM_OK
 && 
pC§
->
pBtC§
 ){

4573 (*
xCmp
)(*, , *, Ë
pC§
->
pDb
->xCmp;

4574 
	`as£π
–
i
==
pC§
->
nPå
 );

4575 
rc
 = 
	`båìCurs‹Re°‹e
(
pC§
->
pBtC§
, 
xCmp
, &
pMîge
->
aI≈ut
[
i
]);

4578 if–
rc
==
LSM_OK
 ){

4579 
rc
 = 
	`mu…iCurs‹SëupTªe
(
pC§
, 0);

4582 
pC§
->
Êags
 |
CURSOR_NEXT_OK
;

4585  
rc
;

4586 
	}
}

4588 
	$s‹ãdBåìGobbÀ
(

4589 
lsm_db
 *
pDb
,

4590 
Mu…iCurs‹
 *
pC§
,

4591 
iGobbÀ


4593 
rc
 = 
LSM_OK
;

4594 if–
	`πT›ic
(
pC§
->
eTy≥
)==0 ){

4595 
Segmít
 *
pSeg
 = 
pC§
->
aPå
[
iGobbÀ
].pSeg;

4596 
Pgno
 *
aPg
;

4597 
nPg
;

4604 
	`as£π
–
pSeg
->
iRoŸ
>0 );

4605 
aPg
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, (
Pgno
)*32, &
rc
);

4606 if–
rc
==
LSM_OK
 ){

4607 
rc
 = 
	`£ekInBåì
(
pC§
, 
pSeg
,

4608 
	`πT›ic
(
pC§
->
eTy≥
),ÖC§->
key
.
pD©a
,ÖC§->key.
nD©a
, 
aPg
, 0

4612 if–
rc
==
LSM_OK
 ){

4613 
nPg
=0; 
aPg
[nPg];ÇPg++);

4614 
	`lsmFsGobbÀ
(
pDb
, 
pSeg
, 
aPg
, 
nPg
);

4617 
	`lsmFªe
(
pDb
->
pEnv
, 
aPg
);

4619  
rc
;

4620 
	}
}

4626 
	$s‹ãdCou¡Levñs
(
Levñ
 *
p
){

4627 
iAge
 = 
p
->iAge;

4628 
nRë
 = 0;

4630 
nRë
++;

4631 
p
 =Ö->
pNext
;

4632 } 
p
 &&Ö->
iAge
==iAge );

4633  
nRë
;

4634 
	}
}

4636 
	$s‹ãdSñe˘Levñ
(
lsm_db
 *
pDb
, 
nMîge
, 
Levñ
 **
µOut
){

4637 
Levñ
 *
pT›Levñ
 = 
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);

4638 
rc
 = 
LSM_OK
;

4639 
Levñ
 *
pLevñ
 = 0;

4640 
Levñ
 *
pBe°
 = 0;

4641 
nBe°
;

4642 
Levñ
 *
pThis
 = 0;

4643 
nThis
 = 0;

4645 
	`as£π
–
nMîge
>=1 );

4646 
nBe°
 = 
	`LSM_MAX
(1, 
nMîge
-1);

4651 
pLevñ
=
pT›Levñ
;ÖLevñ;ÖLevñıLevñ->
pNext
){

4652 if–
pLevñ
->
nRight
==0 && 
pThis
 &&ÖLevñ->
iAge
==pThis->iAge ){

4653 
nThis
++;

4655 if–
nThis
>
nBe°
 ){

4656 if–(
pLevñ
->
iAge
!=
pThis
->iAge+1)

4657 || (
pLevñ
->
nRight
==0 && 
	`s‹ãdCou¡Levñs
’Levñ)<=
pDb
->
nMîge
)

4659 
pBe°
 = 
pThis
;

4660 
nBe°
 = 
nThis
;

4663 if–
pLevñ
->
nRight
 ){

4664 if–
pLevñ
->
nRight
>
nBe°
 ){

4665 
nBe°
 = 
pLevñ
->
nRight
;

4666 
pBe°
 = 
pLevñ
;

4668 
nThis
 = 0;

4669 
pThis
 = 0;

4671 
pThis
 = 
pLevñ
;

4672 
nThis
 = 1;

4676 if–
nThis
>
nBe°
 ){

4677 
	`as£π
–
pThis
 );

4678 
pBe°
 = 
pThis
;

4679 
nBe°
 = 
nThis
;

4682 if–
pBe°
==0 && 
nMîge
==1 ){

4683 
nFªe
 = 0;

4684 
nU§
 = 0;

4685 
pLevñ
=
pT›Levñ
;ÖLevñ;ÖLevñıLevñ->
pNext
){

4686 
	`as£π
–!
pLevñ
->
nRight
 );

4687 if–
pLevñ
->
Êags
 & 
LEVEL_FREELIST_ONLY
 ){

4688 
nFªe
++;

4690 
nU§
++;

4693 if–
nU§
>1 ){

4694 
pBe°
 = 
pT›Levñ
;

4695 
nBe°
 = 
nFªe
 + 
nU§
;

4699 if–
pBe°
 ){

4700 if–
pBe°
->
nRight
==0 ){

4701 
rc
 = 
	`s‹ãdMîgeSëup
(
pDb
, 
pBe°
, 
nBe°
, 
µOut
);

4703 *
µOut
 = 
pBe°
;

4707  
rc
;

4708 
	}
}

4710 
	$s‹ãdDbIsFuŒ
(
lsm_db
 *
pDb
){

4711 
Levñ
 *
pT›
 = 
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);

4713 if–
	`lsmD©aba£FuŒ
(
pDb
) )  1;

4714 if–
pT›
 &&ÖT›->
iAge
==0

4715 && (
pT›
->
nRight
 || 
	`s‹ãdCou¡Levñs
’T›)>=
pDb
->
nMîge
)

4720 
	}
}

4722 
MoveBlockCtx
 
	tMoveBlockCtx
;

4723 
	sMoveBlockCtx
 {

4724 
	miSìn
;

4725 
	miFrom
;

4728 
	$moveBlockCb
(*
pCtx
, 
iBlk
, 
i64
 
iS«pshŸ
){

4729 
MoveBlockCtx
 *
p
 = (MoveBlockCtx *)
pCtx
;

4730 
	`as£π
–
p
->
iFrom
==0 );

4731 if–
iBlk
==(
p
->
iSìn
-1) ){

4732 
p
->
iSìn
 = 
iBlk
;

4735 
p
->
iFrom
 =Ö->
iSìn
-1;

4737 
	}
}

4746 
	$s‹ãdMoveBlock
(
lsm_db
 *
pDb
, *
≤Wrôe
){

4747 
S«pshŸ
 *
p
 = 
pDb
->
pW‹kî
;

4748 
Levñ
 *
pLvl
 = 
	`lsmDbS«pshŸLevñ
(
p
);

4749 
iFrom
;

4750 
iTo
;

4751 
rc
;

4753 
MoveBlockCtx
 
sCtx
;

4755 
	`as£π
–
pLvl
->
pNext
==0 &&ÖLvl->
nRight
==0 );

4756 
	`as£π
–
p
->
ªdúe˘
.
n
<=
LSM_MAX_BLOCK_REDIRECTS
 );

4758 *
≤Wrôe
 = 0;

4762 if–
p
->
ªdúe˘
.
n
>=
LSM_MAX_BLOCK_REDIRECTS
 )  
LSM_OK
;

4769 
sCtx
.
iSìn
 = 
p
->
nBlock
+1;

4770 
sCtx
.
iFrom
 = 0;

4771 
rc
 = 
	`lsmWÆkFªñi°
(
pDb
, 1, 
moveBlockCb
, &
sCtx
);

4772 if–
rc
!=
LSM_OK
 || 
sCtx
.
iFrom
==0 ) Ñc;

4773 
iFrom
 = 
sCtx
.iFrom;

4777 
rc
 = 
	`lsmBlockAŒoˇã
(
pDb
, 
iFrom
, &
iTo
);

4778 if–
rc
!=
LSM_OK
 || 
iTo
==0 ) Ñc;

4779 
	`as£π
–
iTo
!=1 && iTo<
iFrom
 );

4781 
rc
 = 
	`lsmFsMoveBlock
(
pDb
->
pFS
, &
pLvl
->
lhs
, 
iTo
, 
iFrom
);

4782 if–
rc
==
LSM_OK
 ){

4783 if–
p
->
ªdúe˘
.
a
==0 ){

4784 
nByã
 = (
Redúe˘E¡ry
Ë* 
LSM_MAX_BLOCK_REDIRECTS
;

4785 
p
->
ªdúe˘
.
a
 = 
	`lsmMÆlocZîoRc
(
pDb
->
pEnv
, 
nByã
, &
rc
);

4787 if–
rc
==
LSM_OK
 ){

4790 
i
;

4791 
i
=0; i<
p
->
ªdúe˘
.
n
; i++){

4792 if–
p
->
ªdúe˘
.
a
[
i
].
iTo
==
iFrom
 ) ;

4795 if–
i
==
p
->
ªdúe˘
.
n
 ){

4797 
	`memmove
(&
p
->
ªdúe˘
.
a
[1], &p->redirect.a[0],

4798 (
Redúe˘E¡ry
Ë* 
p
->
ªdúe˘
.
n


4800 
p
->
ªdúe˘
.
a
[0].
iFrom
 = iFrom;

4801 
p
->
ªdúe˘
.
a
[0].
iTo
 = iTo;

4802 
p
->
ªdúe˘
.
n
++;

4805 
p
->
ªdúe˘
.
a
[
i
].
iTo
 = iTo;

4808 
rc
 = 
	`lsmBlockFªe
(
pDb
, 
iFrom
);

4810 *
≤Wrôe
 = 
	`lsmFsBlockSize
(
pDb
->
pFS
Ë/ 
	`lsmFsPageSize
(pDb->pFS);

4811 
pLvl
->
lhs
.
pRedúe˘
 = &
p
->
ªdúe˘
;

4815 #i‡
LSM_LOG_STRUCTURE


4816 if–
rc
==
LSM_OK
 ){

4817 
aBuf
[64];

4818 
	`•rötf
(
aBuf
, "move-block %d/%d", 
p
->
ªdúe˘
.
n
-1, 
LSM_MAX_BLOCK_REDIRECTS
);

4819 
	`lsmS‹ãdDumpSåu˘uª
(
pDb
,ÖDb->
pW‹kî
, 
LSM_LOG_DATA
, 0, 
aBuf
);

4822  
rc
;

4823 
	}
}

4827 
	$mîgeIn£πFªñi°Segmíts
(

4828 
lsm_db
 *
pDb
,

4829 
nFªe
,

4830 
MîgeW‹kî
 *
pMW


4832 
rc
 = 
LSM_OK
;

4833 if–
nFªe
>0 ){

4834 
Mu…iCurs‹
 *
pC§
 = 
pMW
->pCsr;

4835 
Levñ
 *
pLvl
 = 
pMW
->
pLevñ
;

4836 
SegmítPå
 *
aNew1
;

4837 
Segmít
 *
aNew2
;

4839 
Levñ
 *
pIãr
;

4840 
Levñ
 *
pNext
;

4841 
i
 = 0;

4843 
aNew1
 = (
SegmítPå
 *)
	`lsmMÆlocZîoRc
(

4844 
pDb
->
pEnv
, (
SegmítPå
Ë* (
pC§
->
nPå
+
nFªe
), &
rc


4846 if–
rc
 ) Ñc;

4847 
	`mem˝y
(&
aNew1
[
nFªe
], 
pC§
->
aPå
, (
SegmítPå
)*pC§->
nPå
);

4848 
pC§
->
nPå
 +
nFªe
;

4849 
	`lsmFªe
(
pDb
->
pEnv
, 
pC§
->
aTªe
);

4850 
	`lsmFªe
(
pDb
->
pEnv
, 
pC§
->
aPå
);

4851 
pC§
->
aTªe
 = 0;

4852 
pC§
->
aPå
 = 
aNew1
;

4854 
aNew2
 = (
Segmít
 *)
	`lsmMÆlocZîoRc
(

4855 
pDb
->
pEnv
, (
Segmít
Ë* (
pLvl
->
nRight
+
nFªe
), &
rc


4857 if–
rc
 ) Ñc;

4858 
	`mem˝y
(&
aNew2
[
nFªe
], 
pLvl
->
aRhs
, (
Segmít
)*pLvl->
nRight
);

4859 
pLvl
->
nRight
 +
nFªe
;

4860 
	`lsmFªe
(
pDb
->
pEnv
, 
pLvl
->
aRhs
);

4861 
pLvl
->
aRhs
 = 
aNew2
;

4863 
pIãr
=
pDb
->
pW‹kî
->
pLevñ
; 
rc
==
LSM_OK
 &&ÖIãr!=
pLvl
;ÖIãr=
pNext
){

4864 
Segmít
 *
pSeg
 = &
pLvl
->
aRhs
[
i
];

4865 
	`mem˝y
(
pSeg
, &
pIãr
->
lhs
, (
Segmít
));

4867 
pC§
->
aPå
[
i
].
pSeg
 =ÖSeg;

4868 
pC§
->
aPå
[
i
].
pLevñ
 = 
pLvl
;

4869 
rc
 = 
	`£gmítPåEnd
(
pC§
, &pC§->
aPå
[
i
], 0);

4871 
pDb
->
pW‹kî
->
pLevñ
 = 
pNext
 = 
pIãr
->pNext;

4872 
	`s‹ãdFªeLevñ
(
pDb
->
pEnv
, 
pIãr
);

4873 
i
++;

4875 
	`as£π
–
i
==
nFªe
 );

4876 
	`as£π
–
rc
!=
LSM_OK
 || 
pDb
->
pW‹kî
->
pLevñ
==
pLvl
 );

4878 
i
=
nFªe
; i<
pC§
->
nPå
; i++){

4879 
pC§
->
aPå
[
i
].
pSeg
 = &
pLvl
->
aRhs
[i];

4882 
	`lsmFªe
(
pDb
->
pEnv
, 
pMW
->
aGobbÀ
);

4883 
pMW
->
aGobbÀ
 = 0;

4885  
rc
;

4886 
	}
}

4888 
	$s‹ãdW‹k
(

4889 
lsm_db
 *
pDb
,

4890 
nW‹k
,

4891 
nMîge
,

4892 
bFlush
,

4893 *
≤Wrôe


4895 
rc
 = 
LSM_OK
;

4896 
nRemaöög
 = 
nW‹k
;

4897 
S«pshŸ
 *
pW‹kî
 = 
pDb
->pWorker;

4899 
	`as£π
–
pW‹kî
 );

4900 if–
	`lsmDbS«pshŸLevñ
(
pW‹kî
)==0 )  
LSM_OK
;

4902  
nRemaöög
>0 ){

4903 
Levñ
 *
pLevñ
 = 0;

4906 
rc
 = 
	`s‹ãdSñe˘Levñ
(
pDb
, 
nMîge
, &
pLevñ
);

4907 
	`as£π
–
rc
==
LSM_OK
 || 
pLevñ
==0 );

4909 if–
pLevñ
==0 ){

4910 
nD⁄e
 = 0;

4911 
Levñ
 *
pT›Levñ
 = 
	`lsmDbS«pshŸLevñ
(
pDb
->
pW‹kî
);

4912 if–
bFlush
==0 && 
nMîge
==1 && 
pT›Levñ
 &&ÖT›Levñ->
pNext
==0 ){

4913 
rc
 = 
	`s‹ãdMoveBlock
(
pDb
, &
nD⁄e
);

4915 
nRemaöög
 -
nD⁄e
;

4918 if–
nD⁄e
==0 ) ;

4920 
bSave
 = 0;

4921 
Fªñi°
 
‰ìli°
 = {0, 0, 0};

4922 
MîgeW‹kî
 
mîgew‹kî
;

4924 
	`as£π
–
pDb
->
bIn¸Mîge
==0 );

4925 
	`as£π
–
pDb
->
pFªñi°
==0 &&ÖDb->
bU£Fªñi°
==0 );

4927 
pDb
->
bIn¸Mîge
 = 1;

4928 
rc
 = 
	`mîgeW‹kîInô
(
pDb
, 
pLevñ
, &
mîgew‹kî
);

4929 
	`as£π
–
mîgew‹kî
.
nW‹k
==0 );

4931  
rc
==
LSM_OK


4932 && 0==
	`mîgeW‹kîD⁄e
(&
mîgew‹kî
)

4933 && (
mîgew‹kî
.
nW‹k
<
nRemaöög
 || 
pDb
->
bU£Fªñi°
)

4935 
eTy≥
 = 
	`πT›ic
(
mîgew‹kî
.
pC§
->eType);

4936 
rc
 = 
	`mîgeW‹kîSãp
(&
mîgew‹kî
);

4943 if–
rc
==
LSM_OK
 && 
nMîge
==1 && 
eTy≥
==0

4944 && (
	`πT›ic
(
mîgew‹kî
.
pC§
->
eTy≥
Ë|| 
	`mîgeW‹kîD⁄e
(&mergeworker))

4946 
nFªe
 = 0;

4947 
Levñ
 *
pLvl
;

4948 
	`as£π
–
pDb
->
pFªñi°
==0 &&ÖDb->
bU£Fªñi°
==0 );

4953 
pLvl
=
pDb
->
pW‹kî
->
pLevñ
;

4954 
pLvl
!=
mîgew‹kî
.
pLevñ
 && (pLvl->
Êags
 & 
LEVEL_FREELIST_ONLY
);

4955 
pLvl
ıLvl->
pNext


4957 
	`as£π
–
pLvl
->
nRight
==0 );

4958 
nFªe
++;

4960 if–
pLvl
==
mîgew‹kî
.
pLevñ
 ){

4962 
rc
 = 
	`mîgeIn£πFªñi°Segmíts
(
pDb
, 
nFªe
, &
mîgew‹kî
);

4963 if–
rc
==
LSM_OK
 ){

4964 
rc
 = 
	`mu…iCurs‹VisôFªñi°
(
mîgew‹kî
.
pC§
);

4966 if–
rc
==
LSM_OK
 ){

4967 
rc
 = 
	`mu…iCurs‹SëupTªe
(
mîgew‹kî
.
pC§
, 0);

4968 
pDb
->
pFªñi°
 = &
‰ìli°
;

4969 
pDb
->
bU£Fªñi°
 = 1;

4974 
nRemaöög
 -
	`LSM_MAX
(
mîgew‹kî
.
nW‹k
, 1);

4976 if–
rc
==
LSM_OK
 ){

4981 if–
	`mîgeW‹kîD⁄e
(&
mîgew‹kî
)==0 ){

4982 
i
;

4983 
i
=0; i<
pLevñ
->
nRight
; i++){

4984 
SegmítPå
 *
pGobbÀ
 = &
mîgew‹kî
.
pC§
->
aPå
[
i
];

4985 if–
pGobbÀ
->
pSeg
->
iRoŸ
 ){

4986 
rc
 = 
	`s‹ãdBåìGobbÀ
(
pDb
, 
mîgew‹kî
.
pC§
, 
i
);

4987 }if–
mîgew‹kî
.
aGobbÀ
[
i
] ){

4988 
	`lsmFsGobbÀ
(
pDb
, 
pGobbÀ
->
pSeg
, &
mîgew‹kî
.
aGobbÀ
[
i
], 1);

4992 
i
;

4993 
bEm±y
;

4994 
	`mîgeW‹kîShutdown
(&
mîgew‹kî
, &
rc
);

4995 
bEm±y
 = (
pLevñ
->
lhs
.
iFú°
==0);

4997 if–
bEm±y
==0 && 
rc
==
LSM_OK
 ){

4998 
rc
 = 
	`lsmFsS‹ãdFöish
(
pDb
->
pFS
, &
pLevñ
->
lhs
);

5001 if–
pDb
->
bU£Fªñi°
 ){

5002 
Fªñi°
 *
p
 = &
pDb
->
pW‹kî
->
‰ìli°
;

5003 
	`lsmFªe
(
pDb
->
pEnv
, 
p
->
aE¡ry
);

5004 
	`mem˝y
(
p
, &
‰ìli°
, (freelist));

5005 
pDb
->
bU£Fªñi°
 = 0;

5006 
pDb
->
pFªñi°
 = 0;

5007 
bSave
 = 1;

5010 
i
=0; i<
pLevñ
->
nRight
; i++){

5011 
	`lsmFsS‹ãdDñëe
(
pDb
->
pFS
, 
pW‹kî
, 1, &
pLevñ
->
aRhs
[
i
]);

5014 if–
bEm±y
 ){

5020 
Levñ
 *
pT›
;

5021 
Levñ
 **
µ
;

5023 
	`as£π
–
pLevñ
->
pNext
==0 );

5026 
pT›
 = 
	`lsmDbS«pshŸLevñ
(
pW‹kî
);

5027 
µ
=&
pT›
; *µ!=
pLevñ
;Öp=&((*µ)->
pNext
));

5028 *
µ
 = 
pLevñ
->
pNext
;

5029 
	`lsmDbS«pshŸSëLevñ
(
pW‹kî
, 
pT›
);

5032 
	`s‹ãdFªeLevñ
(
pDb
->
pEnv
, 
pLevñ
);

5036 if–
pLevñ
->
pMîge
->
nI≈ut
 >ÖLevñ->
nRight
 ){

5037 
	`as£π
–
pLevñ
->
pNext
->
lhs
.
iRoŸ
 );

5038 
pLevñ
->
pNext
->
lhs
.
iRoŸ
 = 0;

5042 
	`lsmFªe
(
pDb
->
pEnv
, 
pLevñ
->
aRhs
);

5043 
pLevñ
->
nRight
 = 0;

5044 
pLevñ
->
aRhs
 = 0;

5047 
	`lsmFªe
(
pDb
->
pEnv
, 
pLevñ
->
pMîge
);

5048 
pLevñ
->
pMîge
 = 0;

5051 if–
bSave
 && 
rc
==
LSM_OK
 ){

5052 
pDb
->
bIn¸Mîge
 = 0;

5053 
rc
 = 
	`lsmSaveW‹kî
(
pDb
, 0);

5061 
	`mîgeW‹kîShutdown
(&
mîgew‹kî
, &
rc
);

5062 
pDb
->
bIn¸Mîge
 = 0;

5063 if–
rc
==
LSM_OK
 ) 
	`s‹ãdInvokeW‹kHook
(
pDb
);

5065 #i‡
LSM_LOG_STRUCTURE


5066 
	`lsmS‹ãdDumpSåu˘uª
(
pDb
,ÖDb->
pW‹kî
, 
LSM_LOG_DATA
, 0, "work");

5068 
	`as£πBåìOk
(
pDb
, &
pLevñ
->
lhs
);

5069 
	`as£πRunInOrdî
(
pDb
, &
pLevñ
->
lhs
);

5074 if–
bFlush
 && 
	`s‹ãdDbIsFuŒ
(
pDb
)==0 ) ;

5078 if–
≤Wrôe
 ) *≤Wrôê(
nW‹k
 - 
nRemaöög
);

5079 
pW‹kî
->
nWrôe
 +(
nW‹k
 - 
nRemaöög
);

5081 #ifde‡
LSM_LOG_WORK


5082 
	`lsmLogMesßge
(
pDb
, 
rc
, "s‹ãdW‹k(): %dÖages", (
nW‹k
-
nRemaöög
));

5084  
rc
;

5085 
	}
}

5095 
	$s‹ãdTªeHasOld
(
lsm_db
 *
pDb
, *
pRc
){

5096 
rc
 = 
LSM_OK
;

5097 
bRë
 = 0;

5099 
	`as£π
–
pDb
->
pW‹kî
 );

5100 if–*
pRc
==
LSM_OK
 ){

5101 if–
rc
==
LSM_OK


5102 && 
pDb
->
åìhdr
.
iOldShmid


5103 && 
pDb
->
åìhdr
.
iOldLog
!ıDb->
pW‹kî
->
iLogOff


5105 
bRë
 = 1;

5107 
bRë
 = 0;

5109 *
pRc
 = 
rc
;

5111 
	`as£π
–*
pRc
==
LSM_OK
 || 
bRë
==0 );

5112  
bRë
;

5113 
	}
}

5119 
	$s‹ãdNewFªñi°O∆y
(
lsm_db
 *
pDb
){

5120  
	`s‹ãdNewT›Àvñ
(
pDb
, 
TREE_NONE
, 0);

5121 
	}
}

5123 
	$lsmSaveW‹kî
(
lsm_db
 *
pDb
, 
bFlush
){

5124 
S«pshŸ
 *
p
 = 
pDb
->
pW‹kî
;

5125 if–
p
->
‰ìli°
.
nE¡ry
>
pDb
->
nMaxFªñi°
 ){

5126 
rc
 = 
	`s‹ãdNewFªñi°O∆y
(
pDb
);

5127 if–
rc
!=
LSM_OK
 ) Ñc;

5129  
	`lsmCheckpoötSaveW‹kî
(
pDb
, 
bFlush
);

5130 
	}
}

5132 
	$doLsmSögÀW‹k
(

5133 
lsm_db
 *
pDb
,

5134 
bShutdown
,

5135 
nMîge
,

5136 
nPage
,

5137 *
≤Wrôe
,

5138 *
pbCk±


5140 
S«pshŸ
 *
pW‹kî
;

5141 
rc
 = 
LSM_OK
;

5142 
bDúty
 = 0;

5143 
nMax
 = 
nPage
;

5144 
nRem
 = 
nPage
;

5145 
bCk±
 = 0;

5147 
	`as£π
–
nPage
>0 );

5151 
	`as£π
–
pDb
->
pW‹kî
==0 );

5152 
rc
 = 
	`lsmBegöW‹k
(
pDb
);

5153 if–
rc
!=
LSM_OK
 ) Ñc;

5154 
pW‹kî
 = 
pDb
->pWorker;

5159 if–
bShutdown
==0 && 
pDb
->
nAutock±
 ){

5160 
u32
 
nSync
;

5161 
u32
 
nUnsync
;

5162 
nPgsz
;

5164 
	`lsmCheckpoötSyn˚d
(
pDb
, 0, 0, &
nSync
);

5165 
nUnsync
 = 
	`lsmCheckpoötNWrôe
(
pDb
->
pShmhdr
->
aS«p1
, 0);

5166 
nPgsz
 = 
	`lsmCheckpoötPgsz
(
pDb
->
pShmhdr
->
aS«p1
);

5168 
nMax
 = 
	`LSM_MIN
“Max, (
pDb
->
nAutock±
/
nPgsz
Ë- ()(
nUnsync
-
nSync
));

5169 if–
nMax
<
nRem
 ){

5170 
bCk±
 = 1;

5171 
nRem
 = 
	`LSM_MAX
(
nMax
, 0);

5177 if–
pDb
->
nTønsO≥n
==0 ){

5178 
rc
 = 
	`lsmTªeLﬂdHódî
(
pDb
, 0);

5180 if–
	`s‹ãdTªeHasOld
(
pDb
, &
rc
) ){

5185 if–
	`s‹ãdDbIsFuŒ
(
pDb
) ){

5186 
nPg
 = 0;

5187 
rc
 = 
	`s‹ãdW‹k
(
pDb
, 
nRem
, 
nMîge
, 1, &
nPg
);

5188 
nRem
 -
nPg
;

5189 
	`as£π
–
rc
!=
LSM_OK
 || 
nRem
<=0 || !
	`s‹ãdDbIsFuŒ
(
pDb
) );

5190 
bDúty
 = 1;

5193 if–
rc
==
LSM_OK
 && 
nRem
>0 ){

5194 
nPg
 = 0;

5195 
rc
 = 
	`s‹ãdNewT›Àvñ
(
pDb
, 
TREE_OLD
, &
nPg
);

5196 
nRem
 -
nPg
;

5197 if–
rc
==
LSM_OK
 ){

5198 if–
pDb
->
nTønsO≥n
>0 ){

5199 
	`lsmTªeDisˇrdOld
(
pDb
);

5201 
rc
 = 
	`lsmSaveW‹kî
(
pDb
, 1);

5202 
bDúty
 = 0;

5208 if–
rc
==
LSM_OK
 && 
nRem
>0 && 
bShutdown
==0 ){

5209 
nPg
 = 0;

5210 
rc
 = 
	`s‹ãdW‹k
(
pDb
, 
nRem
, 
nMîge
, 0, &
nPg
);

5211 
nRem
 -
nPg
;

5212 if–
nPg
 ) 
bDúty
 = 1;

5217 if–
rc
==
LSM_OK
 && 
pDb
->
pW‹kî
->
‰ìli°
.
nE¡ry
 >ÖDb->
nMaxFªñi°
 ){

5218 
nPg
 = 0;

5219  
rc
==
LSM_OK
 && 
	`lsmD©aba£FuŒ
(
pDb
) ){

5220 
rc
 = 
	`s‹ãdW‹k
(
pDb
, 16, 
nMîge
, 1, &
nPg
);

5221 
nRem
 -
nPg
;

5223 if–
rc
==
LSM_OK
 ){

5224 
rc
 = 
	`s‹ãdNewFªñi°O∆y
(
pDb
);

5226 
nRem
 -
nPg
;

5227 if–
nPg
 ) 
bDúty
 = 1;

5230 if–
rc
==
LSM_OK
 ){

5231 *
≤Wrôe
 = (
nMax
 - 
nRem
);

5232 *
pbCk±
 = (
bCk±
 && 
nRem
<=0);

5233 if–
nMîge
==1 && 
pDb
->
nAutock±
>0 && *
≤Wrôe
>0

5234 && 
pW‹kî
->
pLevñ


5235 && 
pW‹kî
->
pLevñ
->
nRight
==0

5236 && 
pW‹kî
->
pLevñ
->
pNext
==0

5238 *
pbCk±
 = 1;

5242 if–
rc
==
LSM_OK
 && 
bDúty
 ){

5243 
	`lsmFöishW‹k
(
pDb
, 0, &
rc
);

5245 
rcdummy
 = 
LSM_BUSY
;

5246 
	`lsmFöishW‹k
(
pDb
, 0, &
rcdummy
);

5247 *
≤Wrôe
 = 0;

5249 
	`as£π
–
pDb
->
pW‹kî
==0 );

5250  
rc
;

5251 
	}
}

5253 
	$doLsmW‹k
(
lsm_db
 *
pDb
, 
nMîge
, 
nPage
, *
≤Wrôe
){

5254 
rc
 = 
LSM_OK
;

5255 
nWrôe
 = 0;

5257 
	`as£π
–
nMîge
>=1 );

5259 if–
nPage
!=0 ){

5260 
bCk±
 = 0;

5262 
nThis
 = 0;

5263 
nReq
 = (
nPage
>=0Ë? (nPage-
nWrôe
) : (()0x7FFFFFFF);

5265 
bCk±
 = 0;

5266 
rc
 = 
	`doLsmSögÀW‹k
(
pDb
, 0, 
nMîge
, 
nReq
, &
nThis
, &
bCk±
);

5267 
nWrôe
 +
nThis
;

5268 if–
rc
==
LSM_OK
 && 
bCk±
 ){

5269 
rc
 = 
	`lsm_checkpoöt
(
pDb
, 0);

5271 } 
rc
==
LSM_OK
 && 
bCk±
 && (
nWrôe
<
nPage
 ||ÇPage<0) );

5274 if–
≤Wrôe
 ){

5275 if–
rc
==
LSM_OK
 ){

5276 *
≤Wrôe
 = 
nWrôe
;

5278 *
≤Wrôe
 = 0;

5281  
rc
;

5282 
	}
}

5287 
	$lsm_w‹k
(
lsm_db
 *
pDb
, 
nMîge
, 
nKB
, *
≤Wrôe
){

5288 
rc
;

5289 
nPgsz
;

5290 
nPage
;

5291 
nWrôe
 = 0;

5295 if–
pDb
->
nTønsO≥n
 ||ÖDb->
pC§
 )  
LSM_MISUSE_BKPT
;

5296 if–
nMîge
<=0 )ÇMîgê
pDb
->nMerge;

5298 
	`lsmFsPurgeCache
(
pDb
->
pFS
);

5301 
nPgsz
 = 
	`lsmFsPageSize
(
pDb
->
pFS
);

5302 if–
nKB
>=0 ){

5303 
nPage
 = ((
i64
)
nKB
 * 1024 + 
nPgsz
 - 1) /ÇPgsz;

5305 
nPage
 = -1;

5308 
rc
 = 
	`doLsmW‹k
(
pDb
, 
nMîge
, 
nPage
, &
nWrôe
);

5310 if–
≤Wrôe
 ){

5312 *
≤Wrôe
 = ()(((
i64
)
nWrôe
 * 1024 + 
nPgsz
 - 1) /ÇPgsz);

5314  
rc
;

5315 
	}
}

5317 
	$lsm_Êush
(
lsm_db
 *
db
){

5318 
rc
;

5320 if–
db
->
nTønsO≥n
>0 || db->
pC§
 ){

5321 
rc
 = 
LSM_MISUSE_BKPT
;

5323 
rc
 = 
	`lsmBegöWrôeTøns
(
db
);

5324 if–
rc
==
LSM_OK
 ){

5325 
	`lsmFlushTªeToDisk
(
db
);

5326 
	`lsmTªeDisˇrdOld
(
db
);

5327 
	`lsmTªeMakeOld
(
db
);

5328 
	`lsmTªeDisˇrdOld
(
db
);

5331 if–
rc
==
LSM_OK
 ){

5332 
rc
 = 
	`lsmFöishWrôeTøns
(
db
, 1);

5334 
	`lsmFöishWrôeTøns
(
db
, 0);

5336 
	`lsmFöishRódTøns
(
db
);

5339  
rc
;

5340 
	}
}

5349 
	$lsmS‹ãdAutoW‹k
(

5350 
lsm_db
 *
pDb
,

5351 
nUnô


5353 
rc
 = 
LSM_OK
;

5354 
nDïth
 = 0;

5355 
Levñ
 *
pLevñ
;

5356 
bRe°‹e
 = 0;

5358 
	`as£π
–
pDb
->
pW‹kî
==0 );

5359 
	`as£π
–
pDb
->
nTønsO≥n
>0 );

5363 
pLevñ
=
	`lsmDbS«pshŸLevñ
(
pDb
->
pClõ¡
);ÖLevñ;ÖLevñıLevñ->
pNext
){

5365 
nDïth
 += 1;

5367 if–
	`lsmTªeHasOld
(
pDb
) ){

5368 
nDïth
 += 1;

5369 
bRe°‹e
 = 1;

5370 
rc
 = 
	`lsmSaveCurs‹s
(
pDb
);

5371 if–
rc
!=
LSM_OK
 ) Ñc;

5374 if–
nDïth
>0 ){

5375 
nRemaöög
;

5377 
nRemaöög
 = 
nUnô
 * 
nDïth
;

5378 #ifde‡
LSM_LOG_WORK


5379 
	`lsmLogMesßge
(
pDb
, 
rc
, "lsmSortedAutoWork(): %d*%d = %dÖages",

5380 
nUnô
, 
nDïth
, 
nRemaöög
);

5382 
	`as£π
–
nRemaöög
>=0 );

5383 
rc
 = 
	`doLsmW‹k
(
pDb
,ÖDb->
nMîge
, 
nRemaöög
, 0);

5384 if–
rc
==
LSM_BUSY
 )Ñ¯
LSM_OK
;

5386 if–
bRe°‹e
 && 
pDb
->
pC§
 ){

5387 
	`lsmMCurs‹FªeCache
(
pDb
);

5388 
	`lsmFªeS«pshŸ
(
pDb
->
pEnv
,ÖDb->
pClõ¡
);

5389 
pDb
->
pClõ¡
 = 0;

5390 
rc
 = 
	`lsmCheckpoötLﬂd
(
pDb
, 0);

5391 if–
rc
==
LSM_OK
 ){

5392 
rc
 = 
	`lsmCheckpoötDe£rülize
(
pDb
, 0,ÖDb->
aS«pshŸ
, &pDb->
pClõ¡
);

5394 if–
rc
==
LSM_OK
 ){

5395 
rc
 = 
	`lsmRe°‹eCurs‹s
(
pDb
);

5400  
rc
;

5401 
	}
}

5407 
	$lsmFlushTªeToDisk
(
lsm_db
 *
pDb
){

5408 
rc
;

5410 
rc
 = 
	`lsmBegöW‹k
(
pDb
);

5411  
rc
==
LSM_OK
 && 
	`s‹ãdDbIsFuŒ
(
pDb
) ){

5412 
rc
 = 
	`s‹ãdW‹k
(
pDb
, 256,ÖDb->
nMîge
, 1, 0);

5415 if–
rc
==
LSM_OK
 ){

5416 
rc
 = 
	`s‹ãdNewT›Àvñ
(
pDb
, 
TREE_BOTH
, 0);

5419 
	`lsmFöishW‹k
(
pDb
, 1, &
rc
);

5420  
rc
;

5421 
	}
}

5428 *
	$£gToSåög
(
lsm_ív
 *
pEnv
, 
Segmít
 *
pSeg
, 
nMö
){

5429 
nSize
 = 
pSeg
->nSize;

5430 
Pgno
 
iRoŸ
 = 
pSeg
->iRoot;

5431 
Pgno
 
iFú°
 = 
pSeg
->iFirst;

5432 
Pgno
 
iLa°
 = 
pSeg
->
iLa°Pg
;

5433 *
z
;

5435 *
z1
;

5436 *
z2
;

5437 
nPad
;

5439 
z1
 = 
	`lsmMÆlocPrötf
(
pEnv
, "%d.%d", 
iFú°
, 
iLa°
);

5440 if–
iRoŸ
 ){

5441 
z2
 = 
	`lsmMÆlocPrötf
(
pEnv
, "roŸ=%d", 
iRoŸ
);

5443 
z2
 = 
	`lsmMÆlocPrötf
(
pEnv
, "size=%d", 
nSize
);

5446 
nPad
 = 
nMö
 - 2 - 
	`°æí
(
z1
Ë- 1 - såÀn(
z2
);

5447 
nPad
 = 
	`LSM_MAX
(0,ÇPad);

5449 if–
iRoŸ
 ){

5450 
z
 = 
	`lsmMÆlocPrötf
(
pEnv
, "/%†%*s%s\\", 
z1
, 
nPad
, "", 
z2
);

5452 
z
 = 
	`lsmMÆlocPrötf
(
pEnv
, "|%†%*s%s|", 
z1
, 
nPad
, "", 
z2
);

5454 
	`lsmFªe
(
pEnv
, 
z1
);

5455 
	`lsmFªe
(
pEnv
, 
z2
);

5457  
z
;

5458 
	}
}

5460 
	$fûeToSåög
(

5461 
lsm_db
 *
pDb
,

5462 *
aBuf
,

5463 
nBuf
,

5464 
nMö
,

5465 
Segmít
 *
pSeg


5467 
i
 = 0;

5468 if–
pSeg
 ){

5469 *
zSeg
;

5471 
zSeg
 = 
	`£gToSåög
(
pDb
->
pEnv
, 
pSeg
, 
nMö
);

5472 
i
 +
	`sqlôe4_¢¥ötf
(&
aBuf
[i], 
nBuf
-i, "%s", 
zSeg
);

5473 
	`lsmFªe
(
pDb
->
pEnv
, 
zSeg
);

5475 #ifde‡
LSM_LOG_FREELIST


5476 
	`lsmInfoAºaySåu˘uª
(
pDb
, 1, 
pSeg
->
iFú°
, &
zSeg
);

5477 
i
 +
	`sqlôe4_¢¥ötf
(&
aBuf
[i], 
nBuf
-i, " (%s)", 
zSeg
);

5478 
	`lsmFªe
(
pDb
->
pEnv
, 
zSeg
);

5481 
aBuf
[0] = '\0';

5484  
i
;

5485 
	}
}

5487 
	$s‹ãdDumpPage
(
lsm_db
 *
pDb
, 
Segmít
 *
pRun
, 
Page
 *
pPg
, 
bVÆs
){

5488 
Blob
 
blob
 = {0, 0, 0};

5489 
LsmSåög
 
s
;

5490 
i
;

5492 
nRec
;

5493 
iPå
;

5494 
Êags
;

5495 
u8
 *
aD©a
;

5496 
nD©a
;

5498 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

5500 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

5501 
iPå
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

5502 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

5504 
	`lsmSåögInô
(&
s
, 
pDb
->
pEnv
);

5505 
	`lsmSåögAµídf
(&
s
,"nCñl=%d iPå=%d fœgs=%d {", 
nRec
, 
iPå
, 
Êags
);

5506 if–
Êags
&
SEGMENT_BTREE_FLAG
 ) 
iPå
 = 0;

5508 
i
=0; i<
nRec
; i++){

5509 
Page
 *
pRef
 = 0;

5510 
iCh¨
;

5511 
u8
 *
aKey
; 
nKey
 = 0;

5512 
u8
 *
aVÆ
; 
nVÆ
 = 0;

5513 
iT›ic
;

5514 
u8
 *
aCñl
;

5515 
iPgPå
;

5516 
eTy≥
;

5518 
aCñl
 = 
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
i
);

5519 
eTy≥
 = *
aCñl
++;

5520 
	`as£π
–(
Êags
 & 
SEGMENT_BTREE_FLAG
Ë|| 
eTy≥
!=0 );

5521 
aCñl
 +
	`lsmV¨ötGë32
◊Cñl, &
iPgPå
);

5523 if–
eTy≥
==0 ){

5524 
Pgno
 
iRef
;

5525 
aCñl
 +
	`lsmV¨ötGë64
◊Cñl, &
iRef
);

5526 
	`lsmFsDbPageGë
(
pDb
->
pFS
, 
pRun
, 
iRef
, &
pRef
);

5527 
aKey
 = 
	`∑geGëKey
(
pRun
, 
pRef
, 0, &
iT›ic
, &
nKey
, &
blob
);

5529 
aCñl
 +
	`lsmV¨ötGë32
◊Cñl, &
nKey
);

5530 if–
	`πIsWrôe
(
eTy≥
ËË
aCñl
 +
	`lsmV¨ötGë32
◊Cñl, &
nVÆ
);

5531 
	`s‹ãdRódD©a
(0, 
pPg
, (
aCñl
-
aD©a
), 
nKey
+
nVÆ
, (**)&
aKey
, &
blob
);

5532 
aVÆ
 = &
aKey
[
nKey
];

5533 
iT›ic
 = 
eTy≥
;

5536 
	`lsmSåögAµídf
(&
s
, "%s%2X:", (
i
==0?"":" "), 
iT›ic
);

5537 
iCh¨
=0; iCh¨<
nKey
; iChar++){

5538 
	`lsmSåögAµídf
(&
s
, "%c", 
	`iß um
(
aKey
[
iCh¨
]) ?áKey[iChar] : '.');

5540 if–
nVÆ
>0 && 
bVÆs
 ){

5541 
	`lsmSåögAµídf
(&
s
, "##");

5542 
iCh¨
=0; iCh¨<
nVÆ
; iChar++){

5543 
	`lsmSåögAµídf
(&
s
, "%c", 
	`iß um
(
aVÆ
[
iCh¨
]) ?áVal[iChar] : '.');

5547 
	`lsmSåögAµídf
(&
s
, " %d", 
iPgPå
+
iPå
);

5548 
	`lsmFsPageRñó£
(
pRef
);

5550 
	`lsmSåögAµíd
(&
s
, "}", 1);

5552 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, " Pagê%d: %s", 
	`lsmFsPageNumbî
(
pPg
), 
s
.
z
);

5553 
	`lsmSåögCÀ¨
(&
s
);

5555 
	`s‹ãdBlobFªe
(&
blob
);

5556 
	}
}

5558 
	$öfoCñlDump
(

5559 
lsm_db
 *
pDb
,

5560 
Segmít
 *
pSeg
,

5561 
bIndúe˘
,

5562 
Page
 *
pPg
,

5563 
iCñl
,

5564 *
≥Ty≥
,

5565 *
piPgPå
,

5566 
u8
 **
∑Key
, *
≤Key
,

5567 
u8
 **
∑VÆ
, *
≤VÆ
,

5568 
Blob
 *
pBlob


5570 
u8
 *
aD©a
; 
nD©a
;

5571 
u8
 *
aKey
; 
nKey
 = 0;

5572 
u8
 *
aVÆ
; 
nVÆ
 = 0;

5573 
eTy≥
;

5574 
iPgPå
;

5575 
Page
 *
pRef
 = 0;

5576 
u8
 *
aCñl
;

5578 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

5580 
aCñl
 = 
	`∑geGëCñl
(
aD©a
, 
nD©a
, 
iCñl
);

5581 
eTy≥
 = *
aCñl
++;

5582 
aCñl
 +
	`lsmV¨ötGë32
◊Cñl, &
iPgPå
);

5584 if–
eTy≥
==0 ){

5585 
dummy
;

5586 
Pgno
 
iRef
;

5587 
aCñl
 +
	`lsmV¨ötGë64
◊Cñl, &
iRef
);

5588 if–
bIndúe˘
 ){

5589 
	`lsmFsDbPageGë
(
pDb
->
pFS
, 
pSeg
, 
iRef
, &
pRef
);

5590 
	`∑geGëKeyC›y
(
pDb
->
pEnv
, 
pSeg
, 
pRef
, 0, &
dummy
, 
pBlob
);

5591 
aKey
 = (
u8
 *)
pBlob
->
pD©a
;

5592 
nKey
 = 
pBlob
->
nD©a
;

5593 
	`lsmFsPageRñó£
(
pRef
);

5595 
aKey
 = (
u8
 *)"<indirect>";

5596 
nKey
 = 11;

5599 
aCñl
 +
	`lsmV¨ötGë32
◊Cñl, &
nKey
);

5600 if–
	`πIsWrôe
(
eTy≥
ËË
aCñl
 +
	`lsmV¨ötGë32
◊Cñl, &
nVÆ
);

5601 
	`s‹ãdRódD©a
(
pSeg
, 
pPg
, (
aCñl
-
aD©a
), 
nKey
+
nVÆ
, (**)&
aKey
, 
pBlob
);

5602 
aVÆ
 = &
aKey
[
nKey
];

5605 if–
≥Ty≥
 ) *≥Ty≥ = 
eTy≥
;

5606 if–
piPgPå
 ) *piPgPå = 
iPgPå
;

5607 if–
∑Key
 ) *∑Key = 
aKey
;

5608 if–
∑VÆ
 ) *∑VÆ = 
aVÆ
;

5609 if–
≤Key
 ) *≤Key = 
nKey
;

5610 if–
≤VÆ
 ) *≤VÆ = 
nVÆ
;

5611 
	}
}

5613 
	$öfoAµídBlob
(
LsmSåög
 *
pSå
, 
bHex
, 
u8
 *
z
, 
n
){

5614 
iCh¨
;

5615 
iCh¨
=0; iCh¨<
n
; iChar++){

5616 if–
bHex
 ){

5617 
	`lsmSåögAµídf
(
pSå
, "%02X", 
z
[
iCh¨
]);

5619 
	`lsmSåögAµídf
(
pSå
, "%c", 
	`iß um
(
z
[
iCh¨
]) ?z[iChar] : '.');

5622  
LSM_OK
;

5623 
	}
}

5625 
	#INFO_PAGE_DUMP_DATA
 0x01

	)

5626 
	#INFO_PAGE_DUMP_VALUES
 0x02

	)

5627 
	#INFO_PAGE_DUMP_HEX
 0x04

	)

5628 
	#INFO_PAGE_DUMP_INDIRECT
 0x08

	)

5630 
	$öfoPageDump
(

5631 
lsm_db
 *
pDb
,

5632 
Pgno
 
iPg
,

5633 
Êags
,

5634 **
pzOut


5636 
rc
 = 
LSM_OK
;

5637 
Page
 *
pPg
 = 0;

5638 
i
, 
j
;

5639 c⁄° 
≥rLöe
 = 16;

5640 
Segmít
 *
pSeg
 = 0;

5641 
S«pshŸ
 *
pS«p
;

5643 
bVÆues
 = (
Êags
 & 
INFO_PAGE_DUMP_VALUES
);

5644 
bHex
 = (
Êags
 & 
INFO_PAGE_DUMP_HEX
);

5645 
bD©a
 = (
Êags
 & 
INFO_PAGE_DUMP_DATA
);

5646 
bIndúe˘
 = (
Êags
 & 
INFO_PAGE_DUMP_INDIRECT
);

5648 *
pzOut
 = 0;

5649 if–
iPg
==0 )  
LSM_ERROR
;

5651 
	`as£π
–
pDb
->
pClõ¡
 ||ÖDb->
pW‹kî
 );

5652 
pS«p
 = 
pDb
->
pClõ¡
;

5653 if–
pS«p
==0 )ÖS«∞
pDb
->
pW‹kî
;

5654 if–
pS«p
->
ªdúe˘
.
n
>0 ){

5655 
Levñ
 *
pLvl
;

5656 
bU£
 = 0;

5657 
pLvl
=
pS«p
->
pLevñ
;ÖLvl->
pNext
;ÖLvl=pLvl->pNext);

5658 
pSeg
 = (
pLvl
->
nRight
==0 ? &pLvl->
lhs
 : &pLvl->
aRhs
[pLvl->nRight-1]);

5659 
rc
 = 
	`lsmFsSegmítC⁄èösPg
(
pDb
->
pFS
, 
pSeg
, 
iPg
, &
bU£
);

5660 if–
bU£
==0 ){

5661 
pSeg
 = 0;

5668 if–
rc
==
LSM_OK
 ){

5669 
rc
 = 
	`lsmFsDbPageGë
(
pDb
->
pFS
, 0, 
iPg
, &
pPg
);

5672 if–
rc
==
LSM_OK
 ){

5673 
Blob
 
blob
 = {0, 0, 0, 0};

5674 
nKeyWidth
 = 0;

5675 
LsmSåög
 
°r
;

5676 
nRec
;

5677 
iPå
;

5678 
Êags
;

5679 
iCñl
;

5680 
u8
 *
aD©a
; 
nD©a
;

5682 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

5683 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

5684 
iPå
 = 
	`∑geGëPå
(
aD©a
, 
nD©a
);

5685 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

5687 
	`lsmSåögInô
(&
°r
, 
pDb
->
pEnv
);

5688 
	`lsmSåögAµídf
(&
°r
, "Pagê: %Œd (%d byãs)\n", 
iPg
, 
nD©a
);

5689 
	`lsmSåögAµídf
(&
°r
, "nRe¯: %d\n", 
nRec
);

5690 
	`lsmSåögAµídf
(&
°r
, "iPå : %d\n", 
iPå
);

5691 
	`lsmSåögAµídf
(&
°r
, "Êags: %04x\n", 
Êags
);

5692 
	`lsmSåögAµídf
(&
°r
, "\n");

5694 
iCñl
=0; iCñl<
nRec
; iCell++){

5695 
nKey
;

5696 
	`öfoCñlDump
(

5697 
pDb
, 
pSeg
, 
bIndúe˘
, 
pPg
, 
iCñl
, 0, 0, 0, &
nKey
, 0, 0, &
blob


5699 if–
nKey
>
nKeyWidth
 )ÇKeyWidth =ÇKey;

5701 if–
bHex
 ) 
nKeyWidth
 =ÇKeyWidth * 2;

5703 
iCñl
=0; iCñl<
nRec
; iCell++){

5704 
u8
 *
aKey
; 
nKey
 = 0;

5705 
u8
 *
aVÆ
; 
nVÆ
 = 0;

5706 
iPgPå
;

5707 
eTy≥
;

5708 
Pgno
 
iAbsPå
;

5709 
zFœgs
[8];

5711 
	`öfoCñlDump
(
pDb
, 
pSeg
, 
bIndúe˘
, 
pPg
, 
iCñl
, &
eTy≥
, &
iPgPå
,

5712 &
aKey
, &
nKey
, &
aVÆ
, &
nVÆ
, &
blob


5714 
iAbsPå
 = 
iPgPå
 + ((
Êags
 & 
SEGMENT_BTREE_FLAG
Ë? 0 : 
iPå
);

5716 
	`lsmFœgsToSåög
(
eTy≥
, 
zFœgs
);

5717 
	`lsmSåögAµídf
(&
°r
, "%s %d (%s) ",

5718 
zFœgs
, 
iAbsPå
, (
	`πT›ic
(
eTy≥
) ? "sys" : "usr")

5720 
	`öfoAµídBlob
(&
°r
, 
bHex
, 
aKey
, 
nKey
);

5721 if–
nVÆ
>0 && 
bVÆues
 ){

5722 
	`lsmSåögAµídf
(&
°r
, "%*s", 
nKeyWidth
 - (
nKey
*(1+
bHex
)), "");

5723 
	`lsmSåögAµídf
(&
°r
, " ");

5724 
	`öfoAµídBlob
(&
°r
, 
bHex
, 
aVÆ
, 
nVÆ
);

5726 if–
	`πT›ic
(
eTy≥
) ){

5727 
iBlk
 = ()~
	`lsmGëU32
(
aKey
);

5728 
	`lsmSåögAµídf
(&
°r
, " (block=%d", 
iBlk
);

5729 if–
nVÆ
>0 ){

5730 
i64
 
iS«p
 = 
	`lsmGëU64
(
aVÆ
);

5731 
	`lsmSåögAµídf
(&
°r
, " s«pshŸ=%Œd", 
iS«p
);

5733 
	`lsmSåögAµídf
(&
°r
, ")");

5735 
	`lsmSåögAµídf
(&
°r
, "\n");

5738 if–
bD©a
 ){

5739 
	`lsmSåögAµídf
(&
°r
, "\n-------------------"

5741 
	`lsmSåögAµídf
(&
°r
, "Page %d\n",

5742 
iPg
, (iPg-1)*
nD©a
, iPg*nData - 1);

5743 
i
=0; i<
nD©a
; i +
≥rLöe
){

5744 
	`lsmSåögAµídf
(&
°r
, "%04x: ", 
i
);

5745 
j
=0; j<
≥rLöe
; j++){

5746 if–
i
+
j
>
nD©a
 ){

5747 
	`lsmSåögAµídf
(&
°r
, " ");

5749 
	`lsmSåögAµídf
(&
°r
, "%02x ", 
aD©a
[
i
+
j
]);

5752 
	`lsmSåögAµídf
(&
°r
, " ");

5753 
j
=0; j<
≥rLöe
; j++){

5754 if–
i
+
j
>
nD©a
 ){

5755 
	`lsmSåögAµídf
(&
°r
, " ");

5757 
	`lsmSåögAµídf
(&
°r
,"%c", 
	`i•röt
(
aD©a
[
i
+
j
]) ?áData[i+j] : '.');

5760 
	`lsmSåögAµídf
(&
°r
,"\n");

5764 *
pzOut
 = 
°r
.
z
;

5765 
	`s‹ãdBlobFªe
(&
blob
);

5766 
	`lsmFsPageRñó£
(
pPg
);

5769  
rc
;

5770 
	}
}

5772 
	$lsmInfoPageDump
(

5773 
lsm_db
 *
pDb
,

5774 
Pgno
 
iPg
,

5775 
bHex
,

5776 **
pzOut


5778 
Êags
 = 
INFO_PAGE_DUMP_DATA
 | 
INFO_PAGE_DUMP_VALUES
;

5779 if–
bHex
 ) 
Êags
 |
INFO_PAGE_DUMP_HEX
;

5780  
	`öfoPageDump
(
pDb
, 
iPg
, 
Êags
, 
pzOut
);

5781 
	}
}

5783 
	$s‹ãdDumpSegmít
(
lsm_db
 *
pDb
, 
Segmít
 *
pRun
, 
bVÆs
){

5784 
	`as£π
–
pDb
->
xLog
 );

5785 if–
pRun
 &&ÖRun->
iFú°
 ){

5786 
Êags
 = (
bVÆs
 ? 
INFO_PAGE_DUMP_VALUES
 : 0);

5787 *
zSeg
;

5788 
Page
 *
pPg
;

5790 
zSeg
 = 
	`£gToSåög
(
pDb
->
pEnv
, 
pRun
, 0);

5791 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "Segmít: %s", 
zSeg
);

5792 
	`lsmFªe
(
pDb
->
pEnv
, 
zSeg
);

5794 
	`lsmFsDbPageGë
(
pDb
->
pFS
, 
pRun
,ÖRun->
iFú°
, &
pPg
);

5795  
pPg
 ){

5796 
Page
 *
pNext
;

5797 *
z
 = 0;

5798 
	`öfoPageDump
(
pDb
, 
	`lsmFsPageNumbî
(
pPg
), 
Êags
, &
z
);

5799 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "%s", 
z
);

5800 
	`lsmFªe
(
pDb
->
pEnv
, 
z
);

5802 
	`s‹ãdDumpPage
(
pDb
, 
pRun
, 
pPg
, 
bVÆs
);

5804 
	`lsmFsDbPageNext
(
pRun
, 
pPg
, 1, &
pNext
);

5805 
	`lsmFsPageRñó£
(
pPg
);

5806 
pPg
 = 
pNext
;

5809 
	}
}

5815 
	$lsmS‹ãdDumpSåu˘uª
(

5816 
lsm_db
 *
pDb
,

5817 
S«pshŸ
 *
pS«p
,

5818 
bKeys
,

5819 
bVÆs
,

5820 c⁄° *
zWhy


5822 
S«pshŸ
 *
pDump
 = 
pS«p
;

5823 
Levñ
 *
pT›Levñ
;

5824 *
zFªe
 = 0;

5826 
	`as£π
–
pS«p
 );

5827 
pT›Levñ
 = 
	`lsmDbS«pshŸLevñ
(
pDump
);

5828 if–
pDb
->
xLog
 && 
pT›Levñ
 ){

5829 
nCÆl
 = 0;

5830 
Levñ
 *
pLevñ
;

5831 
iLevñ
 = 0;

5833 
nCÆl
++;

5834 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "D©aba£ såu˘uª %d (%s)", 
nCÆl
, 
zWhy
);

5837 if–
nCÆl
==1031 ||ÇCÆl==1032 ) 
bKeys
=1;

5840 
pLevñ
=
pT›Levñ
;ÖLevñ;ÖLevñıLevñ->
pNext
){

5841 
zLe·
[1024];

5842 
zRight
[1024];

5843 
i
 = 0;

5845 
Segmít
 *
aLe·
[24];

5846 
Segmít
 *
aRight
[24];

5848 
nLe·
 = 0;

5849 
nRight
 = 0;

5851 
Segmít
 *
pSeg
 = &
pLevñ
->
lhs
;

5852 
aLe·
[
nLe·
++] = 
pSeg
;

5854 
i
=0; i<
pLevñ
->
nRight
; i++){

5855 
aRight
[
nRight
++] = &
pLevñ
->
aRhs
[
i
];

5858 #ifde‡
LSM_LOG_FREELIST


5859 if–
nRight
 ){

5860 
	`memmove
(&
aRight
[1],áRight, ◊Right[0])*
nRight
);

5861 
aRight
[0] = 0;

5862 
nRight
++;

5866 
i
=0; i<
nLe·
 || i<
nRight
; i++){

5867 
iPad
 = 0;

5868 
zLevñ
[32];

5869 
zLe·
[0] = '\0';

5870 
zRight
[0] = '\0';

5872 if–
i
<
nLe·
 ){

5873 
	`fûeToSåög
(
pDb
, 
zLe·
, (zLe·), 24, 
aLe·
[
i
]);

5875 if–
i
<
nRight
 ){

5876 
	`fûeToSåög
(
pDb
, 
zRight
, (zRight), 24, 
aRight
[
i
]);

5879 if–
i
==0 ){

5880 
	`sqlôe4_¢¥ötf
(
zLevñ
, (zLevel), "L%d: (age=%d) (flags=%.4x)",

5881 
iLevñ
, ()
pLevñ
->
iAge
, (ÌLevñ->
Êags


5884 
zLevñ
[0] = '\0';

5887 if–
nRight
==0 ){

5888 
iPad
 = 10;

5891 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "% 25s % *s% -35s %s",

5892 
zLevñ
, 
iPad
, "", 
zLe·
, 
zRight


5896 
iLevñ
++;

5899 if–
bKeys
 ){

5900 
pLevñ
=
pT›Levñ
;ÖLevñ;ÖLevñıLevñ->
pNext
){

5901 
i
;

5902 
	`s‹ãdDumpSegmít
(
pDb
, &
pLevñ
->
lhs
, 
bVÆs
);

5903 
i
=0; i<
pLevñ
->
nRight
; i++){

5904 
	`s‹ãdDumpSegmít
(
pDb
, &
pLevñ
->
aRhs
[
i
], 
bVÆs
);

5910 
	`lsmInfoFªñi°
(
pDb
, &
zFªe
);

5911 
	`lsmLogMesßge
(
pDb
, 
LSM_OK
, "Fªñi°: %s", 
zFªe
);

5912 
	`lsmFªe
(
pDb
->
pEnv
, 
zFªe
);

5914 
	`as£π
–
	`lsmFsI¡egrôyCheck
(
pDb
) );

5915 
	}
}

5917 
	$lsmS‹ãdFªeLevñ
(
lsm_ív
 *
pEnv
, 
Levñ
 *
pLevñ
){

5918 
Levñ
 *
pNext
;

5919 
Levñ
 *
p
;

5921 
p
=
pLevñ
;Ö;Ö=
pNext
){

5922 
pNext
 = 
p
->pNext;

5923 
	`s‹ãdFªeLevñ
(
pEnv
, 
p
);

5925 
	}
}

5927 
	$lsmS‹ãdSaveTªeCurs‹s
(
lsm_db
 *
pDb
){

5928 
Mu…iCurs‹
 *
pC§
;

5929 
pC§
=
pDb
->pC§;ÖC§;ÖC§ıC§->
pNext
){

5930 
	`lsmTªeCurs‹Save
(
pC§
->
≠TªeC§
[0]);

5931 
	`lsmTªeCurs‹Save
(
pC§
->
≠TªeC§
[1]);

5933 
	}
}

5935 
	$lsmS‹ãdEx∑ndBåìPage
(
Page
 *
pPg
, 
nOrig
){

5936 
u8
 *
aD©a
;

5937 
nD©a
;

5938 
nE¡ry
;

5939 
iHdr
;

5941 
aD©a
 = 
	`lsmFsPageD©a
(
pPg
, &
nD©a
);

5942 
nE¡ry
 = 
	`∑geGëNRec
(
aD©a
, 
nOrig
);

5943 
iHdr
 = 
	`SEGMENT_EOF
(
nOrig
, 
nE¡ry
);

5944 
	`memmove
(&
aD©a
[
iHdr
 + (
nD©a
-
nOrig
)], &aData[iHdr],ÇOrig-iHdr);

5945 
	}
}

5947 #ifde‡
LSM_DEBUG_EXPENSIVE


5948 
	$as£πRunInOrdî
(
lsm_db
 *
pDb
, 
Segmít
 *
pSeg
){

5949 
Page
 *
pPg
 = 0;

5950 
Blob
 
blob1
 = {0, 0, 0, 0};

5951 
Blob
 
blob2
 = {0, 0, 0, 0};

5953 
	`lsmFsDbPageGë
(
pDb
->
pFS
, 
pSeg
,ÖSeg->
iFú°
, &
pPg
);

5954  
pPg
 ){

5955 
u8
 *
aD©a
; 
nD©a
;

5956 
Page
 *
pNext
;

5958 
aD©a
 = 
	`lsmFsPageD©a
(
pPg
, &
nD©a
);

5959 if–0==(
	`∑geGëFœgs
(
aD©a
, 
nD©a
Ë& 
SEGMENT_BTREE_FLAG
) ){

5960 
i
;

5961 
nRec
 = 
	`∑geGëNRec
(
aD©a
, 
nD©a
);

5962 
i
=0; i<
nRec
; i++){

5963 
iT›ic1
, 
iT›ic2
;

5964 
	`∑geGëKeyC›y
(
pDb
->
pEnv
, 
pSeg
, 
pPg
, 
i
, &
iT›ic1
, &
blob1
);

5966 if–
i
==0 && 
blob2
.
nD©a
 ){

5967 
	`as£π
–
	`s‹ãdKeyCom∑ª
(

5968 
pDb
->
xCmp
, 
iT›ic2
, 
blob2
.
pD©a
, blob2.
nD©a
,

5969 
iT›ic1
, 
blob1
.
pD©a
, blob1.
nD©a


5973 if–
i
<(
nRec
-1) ){

5974 
	`∑geGëKeyC›y
(
pDb
->
pEnv
, 
pSeg
, 
pPg
, 
i
+1, &
iT›ic2
, &
blob2
);

5975 
	`as£π
–
	`s‹ãdKeyCom∑ª
(

5976 
pDb
->
xCmp
, 
iT›ic1
, 
blob1
.
pD©a
, blob1.
nD©a
,

5977 
iT›ic2
, 
blob2
.
pD©a
, blob2.
nD©a


5983 
	`lsmFsDbPageNext
(
pSeg
, 
pPg
, 1, &
pNext
);

5984 
	`lsmFsPageRñó£
(
pPg
);

5985 
pPg
 = 
pNext
;

5988 
	`s‹ãdBlobFªe
(&
blob1
);

5989 
	`s‹ãdBlobFªe
(&
blob2
);

5990 
	}
}

5993 #ifde‡
LSM_DEBUG_EXPENSIVE


6004 
	$as£πPoöãrsOk
(

6005 
lsm_db
 *
pDb
,

6006 
Segmít
 *
pO√
,

6007 
Segmít
 *
pTwo
,

6008 
bRhs


6010 
rc
 = 
LSM_OK
;

6011 
SegmítPå
 
±r1
;

6012 
SegmítPå
 
±r2
;

6013 
Pgno
 
iPªv
;

6015 
	`as£π
–
pO√
 && 
pTwo
 );

6017 
	`mem£t
(&
±r1
, 0, (ptr1));

6018 
	`mem£t
(&
±r2
, 0, (
±r1
));

6019 
±r1
.
pSeg
 = 
pO√
;

6020 
±r2
.
pSeg
 = 
pTwo
;

6021 
	`£gmítPåEndPage
(
pDb
->
pFS
, &
±r1
, 0, &
rc
);

6022 
	`£gmítPåEndPage
(
pDb
->
pFS
, &
±r2
, 0, &
rc
);

6026 
iPªv
 = 
pTwo
->
iFú°
;

6027 if–
±r1
.
iPå
!=
iPªv
 && !
bRhs
 ){

6028 
	`as£π
( 0 );

6031 if–
rc
==
LSM_OK
 && 
±r1
.
nCñl
>0 ){

6032 
rc
 = 
	`£gmítPåLﬂdCñl
(&
±r1
, 0);

6035  
rc
==
LSM_OK
 && 
±r2
.
pPg
 ){

6036 
Pgno
 
iThis
;

6041 
rc
 = 
	`£gmítPåNextPage
(&
±r2
, 1);

6042 
	`as£π
–
rc
==
LSM_OK
 );

6043 } 
rc
==
LSM_OK
 && 
±r2
.
pPg
 &&Öå2.
nCñl
==0 );

6044 if–
rc
!=
LSM_OK
 || 
±r2
.
pPg
==0 ) ;

6045 
iThis
 = 
	`lsmFsPageNumbî
(
±r2
.
pPg
);

6047 if–(
±r2
.
Êags
 & (
PGFTR_SKIP_THIS_FLAG
|
SEGMENT_BTREE_FLAG
))==0 ){

6050 
rc
 = 
	`£gmítPåLﬂdCñl
(&
±r2
, 0);

6055  
rc
==
LSM_OK
 ){

6056 
ªs
 = 
	`πT›ic
(
±r1
.
eTy≥
Ë-ÑtT›ic(
±r2
.eType);

6057 if–
ªs
==0 ){

6058 
ªs
 = 
pDb
->
	`xCmp
(
±r1
.
pKey
,Öå1.
nKey
, 
±r2
.pKey,Ötr2.nKey);

6061 if–
ªs
<0 ){

6062 
	`as£π
–
bRhs
 || 
±r1
.
iPå
+±r1.
iPgPå
==
iPªv
 );

6063 }if–
ªs
>0 ){

6064 
	`as£π
( 0 );

6066 
	`as£π
–
±r1
.
iPå
+±r1.
iPgPå
==
iThis
 );

6067 
iPªv
 = 
iThis
;

6071 
rc
 = 
	`£gmítPåAdv™˚
(0, &
±r1
, 0);

6072 if–
±r1
.
pPg
==0 ){

6073 
	`as£π
( 0 );

6079 
	`£gmítPåRe£t
(&
±r1
);

6080 
	`£gmítPåRe£t
(&
±r2
);

6081  
LSM_OK
;

6082 
	}
}

6092 
	$as£πBåìOk
(

6093 
lsm_db
 *
pDb
,

6094 
Segmít
 *
pSeg


6096 
rc
 = 
LSM_OK
;

6097 if–
pSeg
->
iRoŸ
 ){

6098 
Blob
 
blob
 = {0, 0, 0};

6099 
FûeSy°em
 *
pFS
 = 
pDb
->pFS;

6100 
Page
 *
pPg
 = 0;

6101 
BåìCurs‹
 *
pC§
 = 0;

6103 
rc
 = 
	`båìCurs‹New
(
pDb
, 
pSeg
, &
pC§
);

6104 if–
rc
==
LSM_OK
 ){

6105 
rc
 = 
	`båìCurs‹Fú°
(
pC§
);

6107 if–
rc
==
LSM_OK
 ){

6108 
rc
 = 
	`lsmFsDbPageGë
(
pFS
, 
pSeg
,ÖSeg->
iFú°
, &
pPg
);

6111  
rc
==
LSM_OK
 ){

6112 
Page
 *
pNext
;

6113 
u8
 *
aD©a
;

6114 
nD©a
;

6115 
Êags
;

6117 
rc
 = 
	`lsmFsDbPageNext
(
pSeg
, 
pPg
, 1, &
pNext
);

6118 
	`lsmFsPageRñó£
(
pPg
);

6119 
pPg
 = 
pNext
;

6120 if–
pPg
==0 ) ;

6121 
aD©a
 = 
	`fsPageD©a
(
pPg
, &
nD©a
);

6122 
Êags
 = 
	`∑geGëFœgs
(
aD©a
, 
nD©a
);

6123 if–
rc
==
LSM_OK


6124 && 0==((
SEGMENT_BTREE_FLAG
|
PGFTR_SKIP_THIS_FLAG
Ë& 
Êags
)

6125 && 0!=
	`∑geGëNRec
(
aD©a
, 
nD©a
)

6127 
u8
 *
pKey
;

6128 
nKey
;

6129 
iT›ic
;

6130 
pKey
 = 
	`∑geGëKey
(
pSeg
, 
pPg
, 0, &
iT›ic
, &
nKey
, &
blob
);

6131 
	`as£π
–
nKey
==
pC§
->nKey && 0==
	`memcmp
(
pKey
,ÖCsr->pKey,ÇKey) );

6132 
	`as£π
–
	`lsmFsPageNumbî
(
pPg
)==
pC§
->
iPå
 );

6133 
rc
 = 
	`båìCurs‹Next
(
pC§
);

6136 
	`as£π
–
rc
!=
LSM_OK
 || 
pC§
->
pKey
==0 );

6138 if–
pPg
 ) 
	`lsmFsPageRñó£
(pPg);

6140 
	`båìCurs‹Fªe
(
pC§
);

6141 
	`s‹ãdBlobFªe
(&
blob
);

6144  
rc
;

6145 
	}
}

	@src/lsm_str.c

15 
	~"lsmI¡.h
"

20 
	$lsmSåögInô
(
LsmSåög
 *
pSå
, 
lsm_ív
 *
pEnv
){

21 
	`mem£t
(
pSå
, 0, (pStr[0]));

22 
pSå
->
pEnv
 =ÖEnv;

23 
	}
}

32 
	$lsmSåögExãnd
(
LsmSåög
 *
pSå
, 
nNew
){

33 
	`as£π
–
nNew
>0 );

34 if–
pSå
->
n
<0 )  
LSM_NOMEM
;

35 if–
pSå
->
n
 + 
nNew
 >pSå->
nAŒoc
 ){

36 
nAŒoc
 = 
pSå
->
n
 + 
nNew
 + 100;

37 *
zNew
 = 
	`lsmRóŒoc
(
pSå
->
pEnv
,ÖSå->
z
, 
nAŒoc
);

38 if–
zNew
==0 ){

39 
	`lsmFªe
(
pSå
->
pEnv
,ÖSå->
z
);

40 
nAŒoc
 = 0;

41 
pSå
->
n
 = -1;

42 
pSå
->
z
 = 0;

44 
pSå
->
nAŒoc
 =ÇAlloc;

45 
pSå
->
z
 = 
zNew
;

48  (
pSå
->
z
 ? 
LSM_OK
 : 
LSM_NOMEM_BKPT
);

49 
	}
}

55 
	$lsmSåögCÀ¨
(
LsmSåög
 *
pSå
){

56 
	`lsmFªe
(
pSå
->
pEnv
,ÖSå->
z
);

57 
	`lsmSåögInô
(
pSå
,ÖSå->
pEnv
);

58 
	}
}

66 
	$lsmSåögAµíd
(
LsmSåög
 *
pSå
, c⁄° *
z
, 
N
){

67 
rc
;

68 if–
N
<0 ) N = ()
	`°æí
(
z
);

69 
rc
 = 
	`lsmSåögExãnd
(
pSå
, 
N
+1);

70 if–
pSå
->
nAŒoc
 ){

71 
	`mem˝y
(
pSå
->
z
+pSå->
n
, z, 
N
+1);

72 
pSå
->
n
 +
N
;

74  
rc
;

75 
	}
}

77 
	$lsmSåögBöAµíd
(
LsmSåög
 *
pSå
, c⁄° 
u8
 *
a
, 
n
){

78 
rc
;

79 
rc
 = 
	`lsmSåögExãnd
(
pSå
, 
n
);

80 if–
pSå
->
nAŒoc
 ){

81 
	`mem˝y
(
pSå
->
z
+pSå->
n
, 
a
,Ç);

82 
pSå
->
n
 +=Ç;

84  
rc
;

85 
	}
}

90 
	$lsmSåögVAµídf
(

91 
LsmSåög
 *
pSå
,

92 c⁄° *
zF‹m©
,

93 
va_li°
 
≠1
,

94 
va_li°
 
≠2


96 #i‡(!
	`deföed
(
__STDC_VERSION__
) || (__STDC_VERSION__<199901L)) && \

97 !
	`deföed
(
__APPLE__
)

98 
	`v¢¥ötf
(*
°r
, 
size_t
 
size
, c⁄° *
f‹m©
, 
va_li°
 
≠
)

105 
nWrôe
;

106 
nAvaû
;

108 
nAvaû
 = 
pSå
->
nAŒoc
 -ÖSå->
n
;

109 
nWrôe
 = 
	`v¢¥ötf
(
pSå
->
z
 +ÖSå->
n
, 
nAvaû
, 
zF‹m©
, 
≠1
);

111 if–
nWrôe
>=
nAvaû
 ){

112 
	`lsmSåögExãnd
(
pSå
, 
nWrôe
+1);

113 if–
pSå
->
nAŒoc
==0 ) ;

114 
nWrôe
 = 
	`v¢¥ötf
(
pSå
->
z
 +ÖSå->
n
,ÇWrôe+1, 
zF‹m©
, 
≠2
);

117 
pSå
->
n
 +
nWrôe
;

118 
pSå
->
z
[pSå->
n
] = 0;

119 
	}
}

121 
	$lsmSåögAµídf
(
LsmSåög
 *
pSå
, c⁄° *
zF‹m©
, ...){

122 
va_li°
 
≠
, 
≠2
;

123 
	`va_°¨t
(
≠
, 
zF‹m©
);

124 
	`va_°¨t
(
≠2
, 
zF‹m©
);

125 
	`lsmSåögVAµídf
(
pSå
, 
zF‹m©
, 
≠
, 
≠2
);

126 
	`va_íd
(
≠
);

127 
	`va_íd
(
≠2
);

128 
	}
}

130 
	$lsmSåÀn
(c⁄° *
zName
){

131 
nRë
 = 0;

132  
zName
[
nRë
] )ÇRet++;

133  
nRë
;

134 
	}
}

139 *
	$lsmMÆlocPrötf
(
lsm_ív
 *
pEnv
, c⁄° *
zF‹m©
, ...){

140 
LsmSåög
 
s
;

141 
va_li°
 
≠
, 
≠2
;

142 
	`lsmSåögInô
(&
s
, 
pEnv
);

143 
	`va_°¨t
(
≠
, 
zF‹m©
);

144 
	`va_°¨t
(
≠2
, 
zF‹m©
);

145 
	`lsmSåögVAµídf
(&
s
, 
zF‹m©
, 
≠
, 
≠2
);

146 
	`va_íd
(
≠
);

147 
	`va_íd
(
≠2
);

148 if–
s
.
n
<0 )  0;

149  (*)
	`lsmRóŒocOrFªe
(
pEnv
, 
s
.
z
, s.
n
+1);

150 
	}
}

	@src/lsm_tree.c

84 #i‚de‡
_LSM_INT_H


85 
	~"lsmI¡.h
"

88 
	~<°rög.h
>

90 
	#MAX_DEPTH
 32

	)

92 
TªeKey
 
	tTªeKey
;

93 
TªeNode
 
	tTªeNode
;

94 
TªeLóf
 
	tTªeLóf
;

95 
NodeVîsi⁄
 
	tNodeVîsi⁄
;

97 
	sTªeOld
 {

98 
u32
 
	miShmid
;

99 
u32
 
	miRoŸ
;

100 
u32
 
	mnHeight
;

103 #i‚de‡
NDEBUG


109 
	$lsmAs£πFœgsOk
(
u8
 
keyÊags
){

111 
	`as£π
–
keyÊags
!=0 );

114 
	`as£π
–(
keyÊags
 & 
LSM_POINT_DELETE
)==0 || (keyÊag†& 
LSM_INSERT
)==0 );

119 
	`as£π
–(
keyÊags
 & 
LSM_END_DELETE
)==0

120 || (
keyÊags
 & 
LSM_START_DELETE
)==0

121 || (
keyÊags
 & 
LSM_POINT_DELETE
)==0

125 
	}
}

127 
as£π_dñëe_ønges_m©ch
(
lsm_db
 *);

128 
åìCou¡E¡rõs
(
lsm_db
 *
db
);

130 
	#lsmAs£πFœgsOk
(
x
)

	)

140 
	sTªeKey
 {

141 
	mnKey
;

142 
	mnVÆue
;

143 
u8
 
	mÊags
;

146 
	#TKV_KEY
(
p
Ë((*)&’)[1])

	)

147 
	#TKV_VAL
(
p
Ë((*)(((
u8
 *)&’)[1]Ë+ (p)->
nKey
))

	)

156 
	sTªeNode
 {

157 
u32
 
	maiKeyPå
[3];

160 
u32
 
	maiChûdPå
[4];

163 
u32
 
	miV2
;

164 
u8
 
	miV2Chûd
;

165 
u32
 
	miV2På
;

168 
	sTªeLóf
 {

169 
u32
 
	maiKeyPå
[3];

172 
TªeBlob
 
	tTªeBlob
;

173 
	sTªeBlob
 {

174 
	mn
;

175 
u8
 *
	ma
;

190 
	sTªeCurs‹
 {

191 
lsm_db
 *
	mpDb
;

192 
TªeRoŸ
 *
	mpRoŸ
;

193 
	miNode
;

194 
TªeNode
 *
	m≠TªeNode
[
MAX_DEPTH
];

195 
u8
 
	maiCñl
[
MAX_DEPTH
];

196 
TªeKey
 *
	mpSave
;

197 
TªeBlob
 
	mblob
;

204 
	#WORKING_VERSION
 (1<<30)

	)

206 
	$tblobGrow
(
lsm_db
 *
pDb
, 
TªeBlob
 *
p
, 
n
, *
pRc
){

207 if–
n
>
p
->n ){

208 
	`lsmFªe
(
pDb
->
pEnv
, 
p
->
a
);

209 
p
->
a
 = 
	`lsmMÆlocRc
(
pDb
->
pEnv
, 
n
, 
pRc
);

210 
p
->
n
 =Ç;

212  (
p
->
a
==0);

213 
	}
}

214 
	$tblobFªe
(
lsm_db
 *
pDb
, 
TªeBlob
 *
p
){

215 
	`lsmFªe
(
pDb
->
pEnv
, 
p
->
a
);

216 
	}
}

225 
	$ötAºayAµíd
(
lsm_ív
 *
pEnv
, 
I¡Aºay
 *
p
, 
u32
 
iVÆ
){

226 
	`as£π
–
p
->
nAºay
<ı->
nAŒoc
 );

227 if–
p
->
nAºay
>ı->
nAŒoc
 ){

228 
u32
 *
aNew
;

229 
nNew
 = 
p
->
nAºay
 ?Ö->nArray*2 : 128;

230 
aNew
 = 
	`lsmRóŒoc
(
pEnv
, 
p
->
aAºay
, 
nNew
*(
u32
));

231 if–!
aNew
 )  
LSM_NOMEM_BKPT
;

232 
p
->
aAºay
 = 
aNew
;

233 
p
->
nAŒoc
 = 
nNew
;

236 
p
->
aAºay
[p->
nAºay
++] = 
iVÆ
;

237  
LSM_OK
;

238 
	}
}

243 
	$ötAºayFªe
(
lsm_ív
 *
pEnv
, 
I¡Aºay
 *
p
){

244 
p
->
nAºay
 = 0;

245 
	}
}

250 
	$ötAºaySize
(
I¡Aºay
 *
p
){

251  
p
->
nAºay
;

252 
	}
}

257 
u32
 
	$ötAºayE¡ry
(
I¡Aºay
 *
p
, 
iIdx
){

258  
p
->
aAºay
[
iIdx
];

259 
	}
}

265 
	$ötAºayTrunˇã
(
I¡Aºay
 *
p
, 
nVÆ
){

266 
p
->
nAºay
 = 
nVÆ
;

267 
	}
}

271 
	$åìKeycmp
(*
p1
, 
n1
, *
p2
, 
n2
){

272 
ªs
;

273 
ªs
 = 
	`memcmp
(
p1
, 
p2
, 
	`LSM_MIN
(
n1
, 
n2
));

274 if–
ªs
==0 )Ñe†(
n1
-
n2
);

275  
ªs
;

276 
	}
}

283 
u32
 
	$gëChûdPå
(
TªeNode
 *
p
, 
iVîsi⁄
, 
iCñl
){

284 
	`as£π
–
iCñl
>=0 && iCñl<=
	`¨øy_size
(
p
->
aiChûdPå
) );

285 if–
p
->
iV2
 &&Ö->iV2<=
iVîsi⁄
 && 
iCñl
=ı->
iV2Chûd
 ) Ö->
iV2På
;

286  
p
->
aiChûdPå
[
iCñl
];

287 
	}
}

292 
	$åìOff£tToChunk
(
u32
 
iOff
){

293 
	`as£π
–
LSM_SHM_CHUNK_SIZE
==(1<<15) );

294  ()(
iOff
>>15);

295 
	}
}

297 
	#åìShm±rUnß„
(
pDb
, 
iPå
) \

298 (&((
u8
*)((
pDb
)->
≠Shm
[(
iPå
)>>15]))[(iPåË& (
LSM_SHM_CHUNK_SIZE
-1)])

	)

304 *
	$åìShm±r
(
lsm_db
 *
pDb
, 
u32
 
iPå
){

306 
	`as£π
–(
iPå
>>15)<
pDb
->
nShm
 );

307 
	`as£π
–
pDb
->
≠Shm
[
iPå
>>15] );

309  
iPå
 ? 
	`åìShm±rUnß„
(
pDb
, iPtr) : 0;

310 
	}
}

312 
ShmChunk
 * 
	$åìShmChunk
(
lsm_db
 *
pDb
, 
iChunk
){

313  (
ShmChunk
 *)(
pDb
->
≠Shm
[
iChunk
]);

314 
	}
}

316 
ShmChunk
 * 
	$åìShmChunkRc
(
lsm_db
 *
pDb
, 
iChunk
, *
pRc
){

317 
	`as£π
–*
pRc
==
LSM_OK
 );

318 if–
iChunk
<
pDb
->
nShm
 || 
LSM_OK
==(*
pRc
 = 
	`lsmShmCacheChunks
(pDb, iChunk+1)) ){

319  (
ShmChunk
 *)(
pDb
->
≠Shm
[
iChunk
]);

322 
	}
}

325 #i‚de‡
NDEBUG


326 
	$as£πIsW‹kögChûd
(

327 
lsm_db
 *
db
,

328 
TªeNode
 *
pNode
,

329 
TªeNode
 *
pP¨ít
,

330 
iCñl


332 
TªeNode
 *
p
;

333 
u32
 
iPå
 = 
	`gëChûdPå
(
pP¨ít
, 
WORKING_VERSION
, 
iCñl
);

334 
p
 = 
	`åìShm±r
(
db
, 
iPå
);

335 
	`as£π
–
p
==
pNode
 );

336 
	}
}

338 
	#as£πIsW‹kögChûd
(
w
,
x
,
y
,
z
)

	)

342 
	#TKV_LOADKEY
 1

	)

343 
	#TKV_LOADVAL
 2

	)

345 
TªeKey
 *
	$åìShmkey
(

346 
lsm_db
 *
pDb
,

347 
u32
 
iPå
,

348 
eLﬂd
,

349 
TªeBlob
 *
pBlob
,

350 *
pRc


352 
TªeKey
 *
pRë
;

354 
	`as£π
–
eLﬂd
==
TKV_LOADKEY
 ||ÉLﬂd==
TKV_LOADVAL
 );

355 
pRë
 = (
TªeKey
 *)
	`åìShm±r
(
pDb
, 
iPå
);

356 if–
pRë
 ){

357 
nReq
;

358 
nAvaû
;

360 
nReq
 = (
TªeKey
Ë+ 
pRë
->
nKey
;

361 if–
eLﬂd
==
TKV_LOADVAL
 && 
pRë
->
nVÆue
>0 ){

362 
nReq
 +
pRë
->
nVÆue
;

364 
	`as£π
–
LSM_SHM_CHUNK_SIZE
==(1<<15) );

365 
nAvaû
 = 
LSM_SHM_CHUNK_SIZE
 - (
iPå
 & (LSM_SHM_CHUNK_SIZE-1));

367 if–
nAvaû
<
nReq
 ){

368 if–
	`tblobGrow
(
pDb
, 
pBlob
, 
nReq
, 
pRc
)==0 ){

369 
nLﬂd
 = 0;

370  *
pRc
==
LSM_OK
 ){

371 
ShmChunk
 *
pChunk
;

372 *
p
 = 
	`åìShm±r
(
pDb
, 
iPå
);

373 
n
 = 
	`LSM_MIN
(
nAvaû
, 
nReq
-
nLﬂd
);

375 
	`mem˝y
(&
pBlob
->
a
[
nLﬂd
], 
p
, 
n
);

376 
nLﬂd
 +
n
;

377 if–
nLﬂd
==
nReq
 ) ;

379 
pChunk
 = 
	`åìShmChunk
(
pDb
, 
	`åìOff£tToChunk
(
iPå
));

380 
	`as£π
–
pChunk
 );

381 
iPå
 = (
pChunk
->
iNext
 * 
LSM_SHM_CHUNK_SIZE
Ë+ 
LSM_SHM_CHUNK_HDR
;

382 
nAvaû
 = 
LSM_SHM_CHUNK_SIZE
 - 
LSM_SHM_CHUNK_HDR
;

385 
pRë
 = (
TªeKey
 *)(
pBlob
->
a
);

389  
pRë
;

390 
	}
}

392 #i‡
deföed
(
LSM_DEBUG
Ë&& deföed(
LSM_EXPENSIVE_ASSERT
)

393 
	$as£π_Àaf_looks_ok
(
TªeNode
 *
pNode
){

394 
	`as£π
–
pNode
->
≠Key
[1] );

395 
	}
}

397 
	$as£π_node_looks_ok
(
TªeNode
 *
pNode
, 
nHeight
){

398 if–
pNode
 ){

399 
	`as£π
–
pNode
->
≠Key
[1] );

400 if–
nHeight
>1 ){

401 
i
;

402 
	`as£π
–
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 1) );

403 
	`as£π
–
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 2) );

404 
i
=0; i<4; i++){

405 
	`as£π_node_looks_ok
(
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 
i
), 
nHeight
-1);

409 
	}
}

417 
	$as£π_åì_looks_ok
(
rc
, 
Tªe
 *
pTªe
){

418 
	}
}

420 
	#as£π_åì_looks_ok
(
x
,
y
)

	)

423 
	$lsmFœgsToSåög
(
Êags
, *
zFœgs
){

425 
zFœgs
[0] = (
Êags
 & 
LSM_END_DELETE
) ? ']' : '.';

429  
Êags
 & (
LSM_POINT_DELETE
|
LSM_INSERT
|
LSM_SEPARATOR
) ){

430 0: 
zFœgs
[1] = '.'; ;

431 
LSM_POINT_DELETE
: 
zFœgs
[1] = '-'; ;

432 
LSM_INSERT
: 
zFœgs
[1] = '+'; ;

433 
LSM_SEPARATOR
: 
zFœgs
[1] = '^'; ;

434 : 
zFœgs
[1] = '?'; ;

437 
zFœgs
[2] = (
Êags
 & 
LSM_SYSTEMKEY
) ? '*' : '.';

438 
zFœgs
[3] = (
Êags
 & 
LSM_START_DELETE
) ? '[' : '.';

439 
zFœgs
[4] = '\0';

440 
	}
}

442 #ifde‡
LSM_DEBUG


451 
	$lsmAµídSåBlob
(
LsmSåög
 *
pSå
, *
pBlob
, 
nBlob
){

452 
i
;

453 
	`lsmSåögExãnd
(
pSå
, 
nBlob
*2);

454 if–
pSå
->
nAŒoc
==0 ) ;

455 
i
=0; i<
nBlob
; i++){

456 
u8
 
c
 = ((u8*)
pBlob
)[
i
];

457 if–
c
>='a' && c<='z' ){

458 
pSå
->
z
[pSå->
n
++] = 
c
;

459 }if–
c
!=0 || 
nBlob
==1 || 
i
!=(nBlob-1) ){

460 
pSå
->
z
[pSå->
n
++] = "0123456789abcdef"[(
c
>>4)&0xf];

461 
pSå
->
z
[pSå->
n
++] = "0123456789abcdef"[
c
&0xf];

464 
pSå
->
z
[pSå->
n
] = 0;

465 
	}
}

470 
	$lsmAµídIndít
(
LsmSåög
 *
pSå
, 
nIndít
){

471 
i
;

472 
	`lsmSåögExãnd
(
pSå
, 
nIndít
);

473 
i
=0; i<
nIndít
; i++Ë
	`lsmSåögAµíd
(
pSå
, " ", 1);

474 
	}
}

476 
	$°rAµídFœgs
(
LsmSåög
 *
pSå
, 
u8
 
Êags
){

477 
zFœgs
[8];

479 
	`lsmFœgsToSåög
(
Êags
, 
zFœgs
);

480 
zFœgs
[4] = ':';

482 
	`lsmSåögAµíd
(
pSå
, 
zFœgs
, 5);

483 
	}
}

485 
	$dump_node_c⁄ã¡s
(

486 
lsm_db
 *
pDb
,

487 
u32
 
iNode
,

488 *
zP©h
,

489 
nP©h
,

490 
nHeight


492 c⁄° *
zS∑˚
 = " ";

493 
i
;

494 
rc
 = 
LSM_OK
;

495 
LsmSåög
 
s
;

496 
TªeNode
 *
pNode
;

497 
TªeBlob
 
b
 = {0, 0};

499 
pNode
 = (
TªeNode
 *)
	`åìShm±r
(
pDb
, 
iNode
);

501 if–
nHeight
==0 ){

503 
	`lsmSåögInô
(&
s
, 
pDb
->
pEnv
);

506 
i
=0; i<3; i++){

507 
u32
 
iPå
 = 
pNode
->
aiKeyPå
[
i
];

508 if–
iPå
 ){

509 
TªeKey
 *
pKey
 = 
	`åìShmkey
(
pDb
, 
pNode
->
aiKeyPå
[
i
],
TKV_LOADKEY
, &
b
,&
rc
);

510 
	`°rAµídFœgs
(&
s
, 
pKey
->
Êags
);

511 
	`lsmAµídSåBlob
(&
s
, 
	`TKV_KEY
(
pKey
),ÖKey->
nKey
);

512 
	`lsmSåögAµíd
(&
s
, " ", -1);

516 
	`¥ötf
("% 6d %.*sleaf%.*s: %s\n",

517 
iNode
, 
nP©h
, 
zP©h
, 20-nP©h-4, 
zS∑˚
, 
s
.
z


519 
	`lsmSåögCÀ¨
(&
s
);

521 
i
=0; i<4 && 
nHeight
>0; i++){

522 
u32
 
iPå
 = 
	`gëChûdPå
(
pNode
, 
pDb
->
åìhdr
.
roŸ
.
iTønsId
, 
i
);

523 
zP©h
[
nP©h
] = 
i
+'0';

524 
zP©h
[
nP©h
+1] = '/';

526 if–
iPå
 ){

527 
	`dump_node_c⁄ã¡s
(
pDb
, 
iPå
, 
zP©h
, 
nP©h
+2, 
nHeight
-1);

529 if–
i
!=3 && 
pNode
->
aiKeyPå
[i] ){

530 
TªeKey
 *
pKey
 = 
	`åìShmkey
(
pDb
, 
pNode
->
aiKeyPå
[
i
], 
TKV_LOADKEY
,&
b
,&
rc
);

531 
	`lsmSåögInô
(&
s
, 
pDb
->
pEnv
);

532 
	`°rAµídFœgs
(&
s
, 
pKey
->
Êags
);

533 
	`lsmAµídSåBlob
(&
s
, 
	`TKV_KEY
(
pKey
),ÖKey->
nKey
);

534 
	`¥ötf
("% 6d %.*s%.*s: %s\n",

535 
iNode
, 
nP©h
+1, 
zP©h
, 20-nP©h-1, 
zS∑˚
, 
s
.
z
);

536 
	`lsmSåögCÀ¨
(&
s
);

541 
	`tblobFªe
(
pDb
, &
b
);

542 
	}
}

544 
	$dump_åì_c⁄ã¡s
(
lsm_db
 *
pDb
, c⁄° *
zC≠ti⁄
){

545 
zP©h
[64];

546 
TªeRoŸ
 *
p
 = &
pDb
->
åìhdr
.
roŸ
;

547 
	`¥ötf
("\n%s\n", 
zC≠ti⁄
);

548 
zP©h
[0] = '/';

549 if–
p
->
iRoŸ
 ){

550 
	`dump_node_c⁄ã¡s
(
pDb
, 
p
->
iRoŸ
, 
zP©h
, 1,Ö->
nHeight
-1);

552 
	`fÊush
(
°dout
);

553 
	}
}

561 
	$åìCurs‹Inô
(
lsm_db
 *
pDb
, 
bOld
, 
TªeCurs‹
 *
pC§
){

562 
	`mem£t
(
pC§
, 0, (
TªeCurs‹
));

563 
pC§
->
pDb
 =ÖDb;

564 if–
bOld
 ){

565 
pC§
->
pRoŸ
 = &
pDb
->
åìhdr
.
ﬁdroŸ
;

567 
pC§
->
pRoŸ
 = &
pDb
->
åìhdr
.
roŸ
;

569 
pC§
->
iNode
 = -1;

570 
	}
}

576 
TªeKey
 *
	$c§GëKey
(
TªeCurs‹
 *
pC§
, 
TªeBlob
 *
pBlob
, *
pRc
){

577 
TªeKey
 *
pRë
;

578 
lsm_db
 *
pDb
 = 
pC§
->pDb;

579 
u32
 
iPå
 = 
pC§
->
≠TªeNode
[pC§->
iNode
]->
aiKeyPå
[pC§->
aiCñl
[pCsr->iNode]];

581 
	`as£π
–
iPå
 );

582 
pRë
 = (
TªeKey
*)
	`åìShm±rUnß„
(
pDb
, 
iPå
);

583 if–!(
pRë
->
Êags
 & 
LSM_CONTIGUOUS
) ){

584 
pRë
 = 
	`åìShmkey
(
pDb
, 
iPå
, 
TKV_LOADVAL
, 
pBlob
, 
pRc
);

587  
pRë
;

588 
	}
}

593 
	$lsmTªeCurs‹Save
(
TªeCurs‹
 *
pC§
){

594 
rc
 = 
LSM_OK
;

595 if–
pC§
 &&ÖC§->
pSave
==0 ){

596 
iNode
 = 
pC§
->iNode;

597 if–
iNode
>=0 ){

598 
pC§
->
pSave
 = 
	`c§GëKey
’C§, &pC§->
blob
, &
rc
);

600 
pC§
->
iNode
 = -1;

602  
rc
;

603 
	}
}

608 
	$åìCurs‹Re°‹e
(
TªeCurs‹
 *
pC§
, *
pRes
){

609 
rc
 = 
LSM_OK
;

610 if–
pC§
->
pSave
 ){

611 
TªeKey
 *
pKey
 = 
pC§
->
pSave
;

612 
pC§
->
pSave
 = 0;

613 if–
pRes
 ){

614 
rc
 = 
	`lsmTªeCurs‹Sìk
(
pC§
, 
	`TKV_KEY
(
pKey
),ÖKey->
nKey
, 
pRes
);

617  
rc
;

618 
	}
}

625 
u32
 
	$åìShmÆloc
(
lsm_db
 *
pDb
, 
bAlign
, 
nByã
, *
pRc
){

626 
u32
 
iRë
 = 0;

627 if–*
pRc
==
LSM_OK
 ){

628 c⁄° 
CHUNK_SIZE
 = 
LSM_SHM_CHUNK_SIZE
;

629 c⁄° 
CHUNK_HDR
 = 
LSM_SHM_CHUNK_HDR
;

630 
u32
 
iWrôe
;

631 
u32
 
iEof
;

632 
iChunk
;

634 
	`as£π
–
nByã
 <(
CHUNK_SIZE
-
CHUNK_HDR
) );

639 
iWrôe
 = 
pDb
->
åìhdr
.iWrite;

640 if–
bAlign
 ){

641 
iWrôe
 = (iWrite + 3) & ~0x0003;

642 
	`as£π
–(
iWrôe
 % 4)==0 );

645 
	`as£π
–
iWrôe
 );

646 
iChunk
 = 
	`åìOff£tToChunk
(
iWrôe
-1);

647 
iEof
 = (
iChunk
+1Ë* 
CHUNK_SIZE
;

648 
	`as£π
–
iEof
>=
iWrôe
 && (iEof-iWrôe)<
CHUNK_SIZE
 );

649 if–(
iWrôe
+
nByã
)>
iEof
 ){

650 
ShmChunk
 *
pHdr
;

651 
ShmChunk
 *
pFú°
;

652 
ShmChunk
 *
pNext
;

653 
iNext
 = 0;

654 
rc
 = 
LSM_OK
;

656 
pFú°
 = 
	`åìShmChunk
(
pDb
,ÖDb->
åìhdr
.
iFú°
);

658 
	`as£π
–
	`shm_£quí˚_ge
(
pDb
->
åìhdr
.
iU£dShmid
, 
pFú°
->
iShmid
) );

659 
	`as£π
–(
pDb
->
åìhdr
.
iNextShmid
+1-pDb->åìhdr.
nChunk
)==
pFú°
->
iShmid
 );

664 if–
pDb
->
åìhdr
.
iU£dShmid
!=
pFú°
->
iShmid
 ){

665 
bInU£
;

666 
rc
 = 
	`lsmTªeInU£
(
pDb
, 
pFú°
->
iShmid
, &
bInU£
);

667 if–
rc
!=
LSM_OK
 ){

668 *
pRc
 = 
rc
;

671 if–
bInU£
==0 ){

672 
iNext
 = 
pDb
->
åìhdr
.
iFú°
;

673 
pDb
->
åìhdr
.
iFú°
 = 
pFú°
->
iNext
;

674 
	`as£π
–
pDb
->
åìhdr
.
iFú°
 );

677 if–
iNext
==0 ) iNexà
pDb
->
åìhdr
.
nChunk
++;

680 
pNext
 = 
	`åìShmChunkRc
(
pDb
, 
iNext
, &
rc
);

681 if–
pNext
 ){

682 
pNext
->
iNext
 = 0;

683 
pNext
->
iShmid
 = (
pDb
->
åìhdr
.
iNextShmid
++);

685 *
pRc
 = 
rc
;

690 
pHdr
 = (
ShmChunk
 *)
	`åìShm±r
(
pDb
, 
iChunk
*
CHUNK_SIZE
);

691 
pHdr
->
iNext
 = iNext;

694 
iWrôe
 = 
iNext
 * 
CHUNK_SIZE
 + 
CHUNK_HDR
;

698 
iRë
 = 
iWrôe
;

699 
pDb
->
åìhdr
.
iWrôe
 = iWrôê+ 
nByã
;

700 
pDb
->
åìhdr
.
roŸ
.
nByã
 +=ÇByte;

702  
iRë
;

703 
	}
}

708 *
	$åìShmÆlocZîo
(
lsm_db
 *
pDb
, 
nByã
, 
u32
 *
piPå
, *
pRc
){

709 
u32
 
iPå
;

710 *
p
;

711 
iPå
 = 
	`åìShmÆloc
(
pDb
, 1, 
nByã
, 
pRc
);

712 
p
 = 
	`åìShm±r
(
pDb
, 
iPå
);

713 if–
p
 ){

714 
	`as£π
–*
pRc
==
LSM_OK
 );

715 
	`mem£t
(
p
, 0, 
nByã
);

716 *
piPå
 = 
iPå
;

718  
p
;

719 
	}
}

721 
TªeNode
 *
	$√wTªeNode
(
lsm_db
 *
pDb
, 
u32
 *
piPå
, *
pRc
){

722  
	`åìShmÆlocZîo
(
pDb
, (
TªeNode
), 
piPå
, 
pRc
);

723 
	}
}

725 
TªeLóf
 *
	$√wTªeLóf
(
lsm_db
 *
pDb
, 
u32
 *
piPå
, *
pRc
){

726  
	`åìShmÆlocZîo
(
pDb
, (
TªeLóf
), 
piPå
, 
pRc
);

727 
	}
}

729 
TªeKey
 *
	$√wTªeKey
(

730 
lsm_db
 *
pDb
,

731 
u32
 *
piPå
,

732 *
pKey
, 
nKey
,

733 *
pVÆ
, 
nVÆ
,

734 *
pRc


736 
TªeKey
 *
p
;

737 
u32
 
iPå
;

738 
u32
 
iEnd
;

739 
nRem
;

740 
u8
 *
a
;

741 
n
;

744 *
piPå
 = 
iPå
 = 
	`åìShmÆloc
(
pDb
, 1, (
TªeKey
), 
pRc
);

745 
p
 = 
	`åìShm±r
(
pDb
, 
iPå
);

746 if–*
pRc
 )  0;

747 
p
->
nKey
 =ÇKey;

748 
p
->
nVÆue
 = 
nVÆ
;

751 
n
 = 
nRem
 = 
nKey
;

752 
a
 = (
u8
 *)
pKey
;

753  
a
 ){

754  
nRem
>0 ){

755 
u8
 *
aAŒoc
;

756 
nAŒoc
;

757 
u32
 
iWrôe
;

759 
iWrôe
 = (
pDb
->
åìhdr
.iWrôê& (
LSM_SHM_CHUNK_SIZE
-1));

760 
iWrôe
 = 
	`LSM_MAX
(iWrôe, 
LSM_SHM_CHUNK_HDR
);

761 
nAŒoc
 = 
	`LSM_MIN
((
LSM_SHM_CHUNK_SIZE
-
iWrôe
), 
nRem
);

763 
aAŒoc
 = 
	`åìShm±r
(
pDb
, 
	`åìShmÆloc
’Db, 0, 
nAŒoc
, 
pRc
));

764 if–
aAŒoc
==0 ) ;

765 
	`mem˝y
(
aAŒoc
, &
a
[
n
-
nRem
], 
nAŒoc
);

766 
nRem
 -
nAŒoc
;

768 
a
 = 
pVÆ
;

769 
n
 = 
nRem
 = 
nVÆ
;

770 
pVÆ
 = 0;

773 
iEnd
 = 
iPå
 + (
TªeKey
Ë+ 
nKey
 + 
	`LSM_MAX
(0, 
nVÆ
);

774 if–(
iPå
 & ~(
LSM_SHM_CHUNK_SIZE
-1))!=(
iEnd
 & ~(LSM_SHM_CHUNK_SIZE-1)) ){

775 
p
->
Êags
 = 0;

777 
p
->
Êags
 = 
LSM_CONTIGUOUS
;

780 if–*
pRc
 )  0;

782 
	`¥ötf
("°‹e: %d %s\n", ()
iPå
, (*)
pKey
);

784  
p
;

785 
	}
}

787 
TªeNode
 *
	$c›yTªeNode
(

788 
lsm_db
 *
pDb
,

789 
TªeNode
 *
pOld
,

790 
u32
 *
piNew
,

791 *
pRc


793 
TªeNode
 *
pNew
;

795 
pNew
 = 
	`√wTªeNode
(
pDb
, 
piNew
, 
pRc
);

796 if–
pNew
 ){

797 
	`mem˝y
(
pNew
->
aiKeyPå
, 
pOld
->aiKeyPtr, (pNew->aiKeyPtr));

798 
	`mem˝y
(
pNew
->
aiChûdPå
, 
pOld
->aiChildPtr, (pNew->aiChildPtr));

799 if–
pOld
->
iV2
 ) 
pNew
->
aiChûdPå
[pOld->
iV2Chûd
] =ÖOld->
iV2På
;

801  
pNew
;

802 
	}
}

804 
TªeNode
 *
	$c›yTªeLóf
(

805 
lsm_db
 *
pDb
,

806 
TªeLóf
 *
pOld
,

807 
u32
 *
piNew
,

808 *
pRc


810 
TªeLóf
 *
pNew
;

811 
pNew
 = 
	`√wTªeLóf
(
pDb
, 
piNew
, 
pRc
);

812 if–
pNew
 ){

813 
	`mem˝y
(
pNew
, 
pOld
, (
TªeLóf
));

815  (
TªeNode
 *)
pNew
;

816 
	}
}

828 
	$åìUpd©ePå
(
lsm_db
 *
pDb
, 
TªeCurs‹
 *
pC§
, 
u32
 
iNew
){

829 
rc
 = 
LSM_OK
;

830 if–
pC§
->
iNode
<0 ){

832 
pDb
->
åìhdr
.
roŸ
.
iRoŸ
 = 
iNew
;

838 
TªeNode
 *
p
;

839 
iChûdPå
;

841 
p
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

842 
iChûdPå
 = 
pC§
->
aiCñl
[pC§->
iNode
];

844 if–
p
->
iV2
 ){

846 
u32
 
iC›y
;

847 
TªeNode
 *
pC›y
;

848 
pC›y
 = 
	`c›yTªeNode
(
pDb
, 
p
, &
iC›y
, &
rc
);

849 if–
pC›y
 ){

850 
	`as£π
–
rc
==
LSM_OK
 );

851 
pC›y
->
aiChûdPå
[
iChûdPå
] = 
iNew
;

852 
pC§
->
iNode
--;

853 
rc
 = 
	`åìUpd©ePå
(
pDb
, 
pC§
, 
iC›y
);

857 
u32
 
iPå
;

858 
	`as£π
–
pDb
->
åìhdr
.
roŸ
.
iTønsId
>0 );

860 if–
pC§
->
iNode
 ){

861 
iPå
 = 
	`gëChûdPå
(

862 
pC§
->
≠TªeNode
[pC§->
iNode
-1],

863 
pDb
->
åìhdr
.
roŸ
.
iTønsId
, 
pC§
->
aiCñl
[pC§->
iNode
-1]

866 
iPå
 = 
pDb
->
åìhdr
.
roŸ
.
iRoŸ
;

868 
rc
 = 
	`ötAºayAµíd
(
pDb
->
pEnv
, &pDb->
rﬁlback
, 
iPå
);

870 if–
rc
==
LSM_OK
 ){

871 
p
->
iV2
 = 
pDb
->
åìhdr
.
roŸ
.
iTønsId
;

872 
p
->
iV2Chûd
 = (
u8
)
iChûdPå
;

873 
p
->
iV2På
 = 
iNew
;

878  
rc
;

879 
	}
}

893 
	$åìIn£π
(

894 
lsm_db
 *
pDb
,

895 
TªeCurs‹
 *
pC§
,

896 
u32
 
iLe·På
,

897 
u32
 
iTªeKey
,

898 
u32
 
iRightPå
,

899 
iSlŸ


901 
rc
 = 
LSM_OK
;

902 
TªeNode
 *
pNode
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

907 
	`as£π
–
pNode
->
aiKeyPå
[1] );

908 if–
pNode
->
aiKeyPå
[0] &&ÖNode->aiKeyPtr[2] ){

909 
u32
 
iLe·
; 
TªeNode
 *
pLe·
;

910 
u32
 
iRight
; 
TªeNode
 *
pRight
;

912 
pLe·
 = 
	`√wTªeNode
(
pDb
, &
iLe·
, &
rc
);

913 
pRight
 = 
	`√wTªeNode
(
pDb
, &
iRight
, &
rc
);

914 if–
rc
 ) Ñc;

916 
pLe·
->
aiChûdPå
[1] = 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 0);

917 
pLe·
->
aiKeyPå
[1] = 
pNode
->aiKeyPtr[0];

918 
pLe·
->
aiChûdPå
[2] = 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 1);

920 
pRight
->
aiChûdPå
[1] = 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 2);

921 
pRight
->
aiKeyPå
[1] = 
pNode
->aiKeyPtr[2];

922 
pRight
->
aiChûdPå
[2] = 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 3);

924 if–
pC§
->
iNode
==0 ){

926 
u32
 
iRoŸ
; 
TªeNode
 *
pRoŸ
;

928 
pRoŸ
 = 
	`√wTªeNode
(
pDb
, &
iRoŸ
, &
rc
);

929 
pRoŸ
->
aiKeyPå
[1] = 
pNode
->aiKeyPtr[1];

930 
pRoŸ
->
aiChûdPå
[1] = 
iLe·
;

931 
pRoŸ
->
aiChûdPå
[2] = 
iRight
;

933 
pDb
->
åìhdr
.
roŸ
.
iRoŸ
 = iRoot;

934 
pDb
->
åìhdr
.
roŸ
.
nHeight
++;

937 
pC§
->
iNode
--;

938 
rc
 = 
	`åìIn£π
(
pDb
, 
pC§
,

939 
iLe·
, 
pNode
->
aiKeyPå
[1], 
iRight
, 
pC§
->
aiCñl
[pC§->
iNode
]

943 
	`as£π
–
pLe·
->
iV2
==0 );

944 
	`as£π
–
pRight
->
iV2
==0 );

945  
iSlŸ
 ){

947 
pLe·
->
aiKeyPå
[0] = 
iTªeKey
;

948 
pLe·
->
aiChûdPå
[0] = 
iLe·På
;

949 if–
iRightPå
 ) 
pLe·
->
aiChûdPå
[1] = iRightPtr;

952 
pLe·
->
aiChûdPå
[3] = (
iRightPå
 ? iRightPtr :ÖLeft->aiChildPtr[2]);

953 
pLe·
->
aiKeyPå
[2] = 
iTªeKey
;

954 
pLe·
->
aiChûdPå
[2] = 
iLe·På
;

957 
pRight
->
aiKeyPå
[0] = 
iTªeKey
;

958 
pRight
->
aiChûdPå
[0] = 
iLe·På
;

959 if–
iRightPå
 ) 
pRight
->
aiChûdPå
[1] = iRightPtr;

962 
pRight
->
aiChûdPå
[3] = (
iRightPå
 ? iRightPtr :ÖRight->aiChildPtr[2]);

963 
pRight
->
aiKeyPå
[2] = 
iTªeKey
;

964 
pRight
->
aiChûdPå
[2] = 
iLe·På
;

969 
TªeNode
 *
pNew
;

970 
u32
 *
piKey
;

971 
u32
 *
piChûd
;

972 
u32
 
iSt‹e
 = 0;

973 
u32
 
iNew
 = 0;

974 
i
;

977 
pNew
 = 
	`√wTªeNode
(
pDb
, &
iNew
, &
rc
);

978 if–
rc
 ) Ñc;

980 
piKey
 = 
pNew
->
aiKeyPå
;

981 
piChûd
 = 
pNew
->
aiChûdPå
;

983 
i
=0; i<
iSlŸ
; i++){

984 if–
pNode
->
aiKeyPå
[
i
] ){

985 *(
piKey
++Ë
pNode
->
aiKeyPå
[
i
];

986 *(
piChûd
++Ë
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 
i
);

990 *
piKey
++ = 
iTªeKey
;

991 *
piChûd
++ = 
iLe·På
;

993 
iSt‹e
 = 
iRightPå
;

994 
i
=
iSlŸ
; i<3; i++){

995 if–
pNode
->
aiKeyPå
[
i
] ){

996 *(
piKey
++Ë
pNode
->
aiKeyPå
[
i
];

997 *(
piChûd
++Ë
iSt‹e
 ? iSt‹ê: 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 
i
);

998 
iSt‹e
 = 0;

1002 if–
iSt‹e
 ){

1003 *
piChûd
 = 
iSt‹e
;

1005 *
piChûd
 = 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
,

1006 (
pNode
->
aiKeyPå
[2] ? 3 : 2)

1009 
pC§
->
iNode
--;

1010 
rc
 = 
	`åìUpd©ePå
(
pDb
, 
pC§
, 
iNew
);

1013  
rc
;

1014 
	}
}

1016 
	$åìIn£πLóf
(

1017 
lsm_db
 *
pDb
,

1018 
TªeCurs‹
 *
pC§
,

1019 
u32
 
iTªeKey
,

1020 
iSlŸ


1022 
rc
 = 
LSM_OK
;

1023 
TªeNode
 *
pLóf
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

1024 
TªeLóf
 *
pNew
;

1025 
u32
 
iNew
;

1027 
	`as£π
–
iSlŸ
>=0 && iSlot<=4 );

1028 
	`as£π
–
pC§
->
iNode
>0 );

1029 
	`as£π
–
pLóf
->
aiKeyPå
[1] );

1031 
pC§
->
iNode
--;

1033 
pNew
 = 
	`√wTªeLóf
(
pDb
, &
iNew
, &
rc
);

1034 if–
pNew
 ){

1035 if–
pLóf
->
aiKeyPå
[0] &&ÖLeaf->aiKeyPtr[2] ){

1037 
TªeLóf
 *
pRight
;

1038 
u32
 
iRight
;

1039 
pRight
 = 
	`√wTªeLóf
(
pDb
, &
iRight
, &
rc
);

1040 if–
pRight
 ){

1041 
	`as£π
–
rc
==
LSM_OK
 );

1042 
pNew
->
aiKeyPå
[1] = 
pLóf
->aiKeyPtr[0];

1043 
pRight
->
aiKeyPå
[1] = 
pLóf
->aiKeyPtr[2];

1044  
iSlŸ
 ){

1045 0: 
pNew
->
aiKeyPå
[0] = 
iTªeKey
; ;

1046 1: 
pNew
->
aiKeyPå
[2] = 
iTªeKey
; ;

1047 2: 
pRight
->
aiKeyPå
[0] = 
iTªeKey
; ;

1048 3: 
pRight
->
aiKeyPå
[2] = 
iTªeKey
; ;

1051 
rc
 = 
	`åìIn£π
(
pDb
, 
pC§
, 
iNew
, 
pLóf
->
aiKeyPå
[1], 
iRight
,

1052 
pC§
->
aiCñl
[pC§->
iNode
]

1056 
iOut
 = 0;

1057 
i
;

1058 
i
=0; i<4; i++){

1059 if–
i
==
iSlŸ
 ) 
pNew
->
aiKeyPå
[
iOut
++] = 
iTªeKey
;

1060 if–
i
<3 && 
pLóf
->
aiKeyPå
[i] ){

1061 
pNew
->
aiKeyPå
[
iOut
++] = 
pLóf
->aiKeyPå[
i
];

1064 
rc
 = 
	`åìUpd©ePå
(
pDb
, 
pC§
, 
iNew
);

1068  
rc
;

1069 
	}
}

1071 
	$lsmTªeMakeOld
(
lsm_db
 *
pDb
){

1079 
	`as£π
– 
pDb
->
iRódî
>=0 );

1081 if–
pDb
->
åìhdr
.
iOldShmid
==0 ){

1082 
pDb
->
åìhdr
.
iOldLog
 = (pDb->åìhdr.
log
.
aRegi⁄
[2].
iEnd
 << 1);

1083 
pDb
->
åìhdr
.
iOldLog
 |(~’Db->
pClõ¡
->
iLogOff
Ë& (
i64
)0x0001);

1085 
pDb
->
åìhdr
.
ﬁdcksum0
 =ÖDb->åìhdr.
log
.
cksum0
;

1086 
pDb
->
åìhdr
.
ﬁdcksum1
 =ÖDb->åìhdr.
log
.
cksum1
;

1087 
pDb
->
åìhdr
.
iOldShmid
 =ÖDb->åìhdr.
iNextShmid
-1;

1088 
	`mem˝y
(&
pDb
->
åìhdr
.
ﬁdroŸ
, &pDb->åìhdr.
roŸ
, (
TªeRoŸ
));

1090 
pDb
->
åìhdr
.
roŸ
.
iTønsId
 = 1;

1091 
pDb
->
åìhdr
.
roŸ
.
iRoŸ
 = 0;

1092 
pDb
->
åìhdr
.
roŸ
.
nHeight
 = 0;

1093 
pDb
->
åìhdr
.
roŸ
.
nByã
 = 0;

1095 
	}
}

1097 
	$lsmTªeDisˇrdOld
(
lsm_db
 *
pDb
){

1098 
	`as£π
–
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_WRITER
, 
LSM_LOCK_EXCL
)

1099 || 
	`lsmShmAs£πLock
(
pDb
, 
LSM_LOCK_DMS2
, 
LSM_LOCK_EXCL
)

1101 
pDb
->
åìhdr
.
iU£dShmid
 =ÖDb->åìhdr.
iOldShmid
;

1102 
pDb
->
åìhdr
.
iOldShmid
 = 0;

1103 
	}
}

1105 
	$lsmTªeHasOld
(
lsm_db
 *
pDb
){

1106  
pDb
->
åìhdr
.
iOldShmid
!=0;

1107 
	}
}

1115 
	$lsmTªeInô
(
lsm_db
 *
pDb
){

1116 
ShmChunk
 *
pO√
;

1117 
rc
 = 
LSM_OK
;

1119 
	`mem£t
(&
pDb
->
åìhdr
, 0, (
TªeHódî
));

1120 
pDb
->
åìhdr
.
roŸ
.
iTønsId
 = 1;

1121 
pDb
->
åìhdr
.
iFú°
 = 1;

1122 
pDb
->
åìhdr
.
nChunk
 = 2;

1123 
pDb
->
åìhdr
.
iWrôe
 = 
LSM_SHM_CHUNK_SIZE
 + 
LSM_SHM_CHUNK_HDR
;

1124 
pDb
->
åìhdr
.
iNextShmid
 = 2;

1125 
pDb
->
åìhdr
.
iU£dShmid
 = 1;

1127 
pO√
 = 
	`åìShmChunkRc
(
pDb
, 1, &
rc
);

1128 if–
pO√
 ){

1129 
pO√
->
iNext
 = 0;

1130 
pO√
->
iShmid
 = 1;

1132  
rc
;

1133 
	}
}

1135 
	$åìHódîChecksum
(

1136 
TªeHódî
 *
pHdr
,

1137 
u32
 *
aCksum


1139 
u32
 
cksum1
 = 0x12345678;

1140 
u32
 
cksum2
 = 0x9ABCDEF0;

1141 
u32
 *
a
 = (u32 *)
pHdr
;

1142 
i
;

1144 
	`as£π
–(
	`off£tof
(
TªeHódî
, 
aCksum
Ë+ (
u32
)*2)==(TreeHeader) );

1145 
	`as£π
–((
TªeHódî
Ë% ((
u32
)*2))==0 );

1147 
i
=0; i<(
	`off£tof
(
TªeHódî
, 
aCksum
Ë/ (
u32
)); i+=2){

1148 
cksum1
 +
a
[
i
];

1149 
cksum2
 +(
cksum1
 + 
a
[
i
+1]);

1151 
aCksum
[0] = 
cksum1
;

1152 
aCksum
[1] = 
cksum2
;

1153 
	}
}

1159 
	$åìHódîChecksumOk
(
TªeHódî
 *
pHdr
){

1160 
u32
 
aCksum
[2];

1161 
	`åìHódîChecksum
(
pHdr
, 
aCksum
);

1162  (0==
	`memcmp
(
aCksum
, 
pHdr
->aCksum, (aCksum)));

1163 
	}
}

1169 
ShmChunkLoc
 
	tShmChunkLoc
;

1170 
	sShmChunkLoc
 {

1171 
ShmChunk
 *
	mpShm
;

1172 
u32
 
	miLoc
;

1188 
	$åìCheckLökedLi°
(
lsm_db
 *
db
){

1189 
rc
 = 
LSM_OK
;

1190 
nVisô
 = 0;

1191 
ShmChunk
 *
p
;

1193 
p
 = 
	`åìShmChunkRc
(
db
, db->
åìhdr
.
iFú°
, &
rc
);

1194  
rc
==
LSM_OK
 && 
p
 ){

1195 if–
p
->
iNext
 ){

1196 if–
p
->
iNext
>=
db
->
åìhdr
.
nChunk
 ){

1197 
rc
 = 
LSM_CORRUPT_BKPT
;

1199 
ShmChunk
 *
pNext
 = 
	`åìShmChunkRc
(
db
, 
p
->
iNext
, &
rc
);

1200 if–
rc
==
LSM_OK
 ){

1201 if–
pNext
->
iShmid
!=
p
->iShmid+1 ){

1202 
rc
 = 
LSM_CORRUPT_BKPT
;

1204 
p
 = 
pNext
;

1208 
p
 = 0;

1210 
nVisô
++;

1213 if–
rc
==
LSM_OK
 && 
nVisô
!=
db
->
åìhdr
.
nChunk
-1 ){

1214 
rc
 = 
LSM_CORRUPT_BKPT
;

1216  
rc
;

1217 
	}
}

1223 
	$åìRïaúPås
(
lsm_db
 *
db
){

1224 
rc
 = 
LSM_OK
;

1226 if–
db
->
åìhdr
.
roŸ
.
nHeight
>1 ){

1227 
TªeCurs‹
 
c§
;

1228 
u32
 
iTønsId
 = 
db
->
åìhdr
.
roŸ
.iTransId;

1233 
db
->
åìhdr
.
roŸ
.
nHeight
--;

1234 
	`åìCurs‹Inô
(
db
, 0, &
c§
);

1236 
rc
 = 
	`lsmTªeCurs‹End
(&
c§
, 0);

1237  
rc
==
LSM_OK
 && 
	`lsmTªeCurs‹VÆid
(&
c§
) ){

1238 
TªeNode
 *
pNode
 = 
c§
.
≠TªeNode
[c§.
iNode
];

1239 if–
pNode
->
iV2
>
iTønsId
 ){

1240 
pNode
->
iV2Chûd
 = 0;

1241 
pNode
->
iV2På
 = 0;

1242 
pNode
->
iV2
 = 0;

1244 
rc
 = 
	`lsmTªeCurs‹Next
(&
c§
);

1246 
	`tblobFªe
(
c§
.
pDb
, &c§.
blob
);

1248 
db
->
åìhdr
.
roŸ
.
nHeight
++;

1251  
rc
;

1252 
	}
}

1254 
	$åìRïaúLi°
(
lsm_db
 *
db
){

1255 
rc
 = 
LSM_OK
;

1256 
i
;

1257 
ShmChunk
 *
p
;

1258 
ShmChunk
 *
pMö
 = 0;

1259 
u32
 
iMö
 = 0;

1263 
i
=1; 
rc
==
LSM_OK
 && i<
db
->
åìhdr
.
nChunk
; i++){

1264 
p
 = 
	`åìShmChunkRc
(
db
, 
i
, &
rc
);

1265 if–
p
 && (
pMö
==0 || 
	`shm_£quí˚_ge
’Mö->
iShmid
,Ö->iShmid)) ){

1266 
pMö
 = 
p
;

1267 
iMö
 = 
i
;

1275 if–
rc
==
LSM_OK
 ){

1276 
nS‹t
;

1277 
nByã
;

1278 
u32
 
iPªvShmid
;

1279 
ShmChunkLoc
 *
aS‹t
;

1282 
nS‹t
 = 1;

1283  
nS‹t
 < (
db
->
åìhdr
.
nChunk
-1) )ÇSort =ÇSort * 2;

1284 
nByã
 = (
ShmChunkLoc
Ë* 
nS‹t
 * 2;

1285 
aS‹t
 = 
	`lsmMÆlocZîoRc
(
db
->
pEnv
, 
nByã
, &
rc
);

1286 
iPªvShmid
 = 
pMö
->
iShmid
;

1289 if–
rc
==
LSM_OK
 ){

1290 
iPªvShmid
 = 
pMö
->
iShmid
-1;

1291 
i
=1; i<
db
->
åìhdr
.
nChunk
; i++){

1292 
p
 = 
	`åìShmChunk
(
db
, 
i
);

1293 
aS‹t
[
i
-1].
pShm
 = 
p
;

1294 
aS‹t
[
i
-1].
iLoc
 = i;

1295 if–
i
!=
db
->
åìhdr
.
iFú°
 ){

1296 if–
	`shm_£quí˚_ge
(
p
->
iShmid
, 
db
->
åìhdr
.
iNextShmid
) ){

1297 
p
->
iShmid
 = 
iPªvShmid
--;

1301 if–
iMö
!=
db
->
åìhdr
.
iFú°
 ){

1302 
p
 = 
	`åìShmChunk
(
db
, db->
åìhdr
.
iFú°
);

1303 
p
->
iShmid
 = 
iPªvShmid
;

1307 if–
rc
==
LSM_OK
 ){

1308 
ShmChunkLoc
 *
aS∑˚
 = &
aS‹t
[
nS‹t
];

1309 
i
=0; i<
nS‹t
; i++){

1310 if–
aS‹t
[
i
].
pShm
 ){

1311 
	`as£π
–
	`shm_£quí˚_ge
(
aS‹t
[
i
].
pShm
->
iShmid
, 
iPªvShmid
) );

1312 
	`as£π
–
aS∑˚
[
aS‹t
[
i
].
pShm
->
iShmid
 - 
iPªvShmid
].pShm==0 );

1313 
aS∑˚
[
aS‹t
[
i
].
pShm
->
iShmid
 - 
iPªvShmid
] =áSort[i];

1317 if–
aS∑˚
[
nS‹t
-1].
pShm
 )áS∑˚[nS‹t-1].pShm->
iNext
 = 0;

1318 
i
=0; i<
nS‹t
-1; i++){

1319 if–
aS∑˚
[
i
].
pShm
 ){

1320 
aS∑˚
[
i
].
pShm
->
iNext
 =áS∑˚[i+1].
iLoc
;

1324 
rc
 = 
	`åìCheckLökedLi°
(
db
);

1325 
	`lsmFªe
(
db
->
pEnv
, 
aS‹t
);

1329  
rc
;

1330 
	}
}

1337 
	$lsmTªeRïaú
(
lsm_db
 *
db
){

1338 
rc
 = 
LSM_OK
;

1339 
TªeHódî
 
hdr
;

1340 
ShmHódî
 *
pHdr
 = 
db
->
pShmhdr
;

1345 if–
	`memcmp
(&
pHdr
->
hdr1
, &pHdr->
hdr2
, (
TªeHódî
)) ){

1346 if–
	`åìHódîChecksumOk
(&
pHdr
->
hdr1
) ){

1347 
	`mem˝y
(&
pHdr
->
hdr2
, &pHdr->
hdr1
, (
TªeHódî
));

1349 
	`mem˝y
(&
pHdr
->
hdr1
, &pHdr->
hdr2
, (
TªeHódî
));

1355 
	`mem˝y
(&
hdr
, &
db
->
åìhdr
, (
TªeHódî
));

1359 
rc
 = 
	`åìRïaúPås
(
db
);

1362 if–
rc
==
LSM_OK
 ){

1363 
rc
 = 
	`åìRïaúLi°
(
db
);

1366 
	`mem˝y
(&
db
->
åìhdr
, &
hdr
, (
TªeHódî
));

1367  
rc
;

1368 
	}
}

1370 
	$åìOvîwrôeKey
(
lsm_db
 *
db
, 
TªeCurs‹
 *
pC§
, 
u32
 
iKey
, *
pRc
){

1371 if–*
pRc
==
LSM_OK
 ){

1372 
TªeRoŸ
 *
p
 = &
db
->
åìhdr
.
roŸ
;

1373 
TªeNode
 *
pNew
;

1374 
u32
 
iNew
;

1375 
TªeNode
 *
pNode
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

1376 
iCñl
 = 
pC§
->
aiCñl
[pC§->
iNode
];

1379 if–(
pC§
->
iNode
>0 &&ÖC§->iNode==(
p
->
nHeight
-1)) ){

1380 
pNew
 = 
	`c›yTªeLóf
(
db
, (
TªeLóf
 *)
pNode
, &
iNew
, 
pRc
);

1382 
pNew
 = 
	`c›yTªeNode
(
db
, 
pNode
, &
iNew
, 
pRc
);

1385 if–
pNew
 ){

1387 
pNew
->
aiKeyPå
[
iCñl
] = 
iKey
;

1391 
pC§
->
iNode
--;

1392 
	`åìUpd©ePå
(
db
, 
pC§
, 
iNew
);

1395 
	}
}

1397 
	$åìNextIsEndDñëe
(
lsm_db
 *
db
, 
TªeCurs‹
 *
pC§
){

1398 
iNode
 = 
pC§
->iNode;

1399 
iCñl
 = 
pC§
->
aiCñl
[
iNode
]+1;

1402 
	`as£π
–
pC§
->
iNode
==(
db
->
åìhdr
.
roŸ
.
nHeight
-1) );

1404  
iNode
>=0 ){

1405 
TªeNode
 *
pNode
 = 
pC§
->
≠TªeNode
[
iNode
];

1406 if–
iCñl
<3 && 
pNode
->
aiKeyPå
[iCell] ){

1407 
rc
 = 
LSM_OK
;

1408 
TªeKey
 *
pKey
 = 
	`åìShm±r
(
db
, 
pNode
->
aiKeyPå
[
iCñl
]);

1409 
	`as£π
–
rc
==
LSM_OK
 );

1410  ((
pKey
->
Êags
 & 
LSM_END_DELETE
) ? 1 : 0);

1412 
iNode
--;

1413 
iCñl
 = 
pC§
->
aiCñl
[
iNode
];

1417 
	}
}

1419 
	$åìPªvIsSèπDñëe
(
lsm_db
 *
db
, 
TªeCurs‹
 *
pC§
){

1420 
iNode
 = 
pC§
->iNode;

1423 
	`as£π
–
pC§
->
iNode
==(
db
->
åìhdr
.
roŸ
.
nHeight
-1) );

1425  
iNode
>=0 ){

1426 
TªeNode
 *
pNode
 = 
pC§
->
≠TªeNode
[
iNode
];

1427 
iCñl
 = 
pC§
->
aiCñl
[
iNode
]-1;

1428 if–
iCñl
>=0 && 
pNode
->
aiKeyPå
[iCell] ){

1429 
rc
 = 
LSM_OK
;

1430 
TªeKey
 *
pKey
 = 
	`åìShm±r
(
db
, 
pNode
->
aiKeyPå
[
iCñl
]);

1431 
	`as£π
–
rc
==
LSM_OK
 );

1432  ((
pKey
->
Êags
 & 
LSM_START_DELETE
) ? 1 : 0);

1434 
iNode
--;

1438 
	}
}

1441 
	$åìIn£πE¡ry
(

1442 
lsm_db
 *
pDb
,

1443 
Êags
,

1444 *
pKey
,

1445 
nKey
,

1446 *
pVÆ
,

1447 
nVÆ


1449 
rc
 = 
LSM_OK
;

1450 
TªeKey
 *
pTªeKey
;

1451 
u32
 
iTªeKey
;

1452 
TªeRoŸ
 *
p
 = &
pDb
->
åìhdr
.
roŸ
;

1453 
TªeCurs‹
 
c§
;

1454 
ªs
;

1456 
	`as£π
–
nVÆ
>=0 || 
pVÆ
==0 );

1457 
	`as£π_åì_looks_ok
(
LSM_OK
, 
pTªe
);

1458 
	`as£π
–
Êags
==
LSM_INSERT
 || fœgs==
LSM_POINT_DELETE


1459 || 
Êags
==
LSM_START_DELETE
 || fœgs==
LSM_END_DELETE


1461 
	`as£π
–(
Êags
 & 
LSM_CONTIGUOUS
)==0 );

1463 
	`dump_åì_c⁄ã¡s
(
pDb
, "before");

1466 if–
p
->
iRoŸ
 ){

1467 
TªeKey
 *
pRes
;

1468 
	`åìCurs‹Inô
(
pDb
, 0, &
c§
);

1471 
rc
 = 
	`lsmTªeCurs‹Sìk
(&
c§
, 
pKey
, 
nKey
, &
ªs
);

1472 
pRes
 = 
	`c§GëKey
(&
c§
, &c§.
blob
, &
rc
);

1473 if–
rc
!=
LSM_OK
 ) Ñc;

1475 if–
Êags
==
LSM_START_DELETE
 ){

1479 if–(
ªs
<=0 && (
pRes
->
Êags
 & 
LSM_START_DELETE
))

1480 || (
ªs
>0 && 
	`åìPªvIsSèπDñëe
(
pDb
, &
c§
))

1482 
ö£π_íåy_out
;

1484 }if–
Êags
==
LSM_END_DELETE
 ){

1488 if–(
ªs
<0 && 
	`åìNextIsEndDñëe
(
pDb
, &
c§
))

1489 || (
ªs
>=0 && (
pRes
->
Êags
 & 
LSM_END_DELETE
))

1491 
ö£π_íåy_out
;

1495 if–
ªs
==0 && (
Êags
 & (
LSM_END_DELETE
|
LSM_START_DELETE
)) ){

1496 if–
pRes
->
Êags
 & 
LSM_INSERT
 ){

1497 
nVÆ
 = 
pRes
->
nVÆue
;

1498 
pVÆ
 = 
	`TKV_VAL
(
pRes
);

1500 
Êags
 = fœg†| 
pRes
->flags;

1503 if–
Êags
 & (
LSM_INSERT
|
LSM_POINT_DELETE
) ){

1504 if–(
ªs
<0 && (
pRes
->
Êags
 & 
LSM_START_DELETE
))

1505 || (
ªs
>0 && (
pRes
->
Êags
 & 
LSM_END_DELETE
))

1507 
Êags
 = fœg†| (
LSM_END_DELETE
|
LSM_START_DELETE
);

1508 }if–
ªs
==0 ){

1509 
Êags
 = fœg†| (
pRes
->Êag†& (
LSM_END_DELETE
|
LSM_START_DELETE
));

1513 
	`mem£t
(&
c§
, 0, (
TªeCurs‹
));

1517 
pTªeKey
 = 
	`√wTªeKey
(
pDb
, &
iTªeKey
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
, &
rc
);

1518 if–
rc
!=
LSM_OK
 ) Ñc;

1519 
	`as£π
–
pTªeKey
->
Êags
==0 ||ÖTªeKey->Êags==
LSM_CONTIGUOUS
 );

1520 
pTªeKey
->
Êags
 |= flags;

1522 if–
p
->
iRoŸ
==0 ){

1528 
TªeNode
 *
pRoŸ
 = 
	`√wTªeNode
(
pDb
, &
p
->
iRoŸ
, &
rc
);

1529 if–
rc
==
LSM_OK
 ){

1530 
	`as£π
–
p
->
nHeight
==0 );

1531 
pRoŸ
->
aiKeyPå
[1] = 
iTªeKey
;

1532 
p
->
nHeight
 = 1;

1535 if–
ªs
==0 ){

1537 
	`åìOvîwrôeKey
(
pDb
, &
c§
, 
iTªeKey
, &
rc
);

1548 
iSlŸ
 = 
c§
.
aiCñl
[c§.
iNode
] + (
ªs
<0);

1549 if–
c§
.
iNode
==0 ){

1550 
rc
 = 
	`åìIn£π
(
pDb
, &
c§
, 0, 
iTªeKey
, 0, 
iSlŸ
);

1552 
rc
 = 
	`åìIn£πLóf
(
pDb
, &
c§
, 
iTªeKey
, 
iSlŸ
);

1558 
	`dump_åì_c⁄ã¡s
(
pDb
, "after");

1560 
ö£π_íåy_out
:

1561 
	`tblobFªe
(
pDb
, &
c§
.
blob
);

1562 
	`as£π_åì_looks_ok
(
rc
, 
pTªe
);

1563  
rc
;

1564 
	}
}

1573 
	$lsmTªeIn£π
(

1574 
lsm_db
 *
pDb
,

1575 *
pKey
,

1576 
nKey
,

1577 *
pVÆ
,

1578 
nVÆ


1580 
Êags
;

1581 if–
nVÆ
<0 ){

1582 
Êags
 = 
LSM_POINT_DELETE
;

1584 
Êags
 = 
LSM_INSERT
;

1587  
	`åìIn£πE¡ry
(
pDb
, 
Êags
, 
pKey
, 
nKey
, 
pVÆ
, 
nVÆ
);

1588 
	}
}

1590 
	$åìDñëeE¡ry
(
lsm_db
 *
db
, 
TªeCurs‹
 *
pC§
, 
u32
 
iNew±r
){

1591 
TªeRoŸ
 *
p
 = &
db
->
åìhdr
.
roŸ
;

1592 
TªeNode
 *
pNode
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

1593 
iSlŸ
 = 
pC§
->
aiCñl
[pC§->
iNode
];

1594 
bLóf
;

1595 
rc
 = 
LSM_OK
;

1597 
	`as£π
–
pNode
->
aiKeyPå
[1] );

1598 
	`as£π
–
pNode
->
aiKeyPå
[
iSlŸ
] );

1599 
	`as£π
–
iSlŸ
==0 || iSlot==1 || iSlot==2 );

1600 
	`as£π
–(
pC§
->
iNode
==(
db
->
åìhdr
.
roŸ
.
nHeight
-1))==(
iNew±r
==0) );

1602 
bLóf
 = (
pC§
->
iNode
==(
p
->
nHeight
-1) &&Ö->nHeight>1);

1604 if–
pNode
->
aiKeyPå
[0] ||ÖNode->aiKeyPtr[2] ){

1609 
TªeNode
 *
pNew
;

1610 
u32
 
iNew
;

1612 if–
bLóf
 ){

1613 
pNew
 = (
TªeNode
 *)
	`√wTªeLóf
(
db
, &
iNew
, &
rc
);

1615 
pNew
 = 
	`√wTªeNode
(
db
, &
iNew
, &
rc
);

1617 if–
pNew
 ){

1618 
i
;

1619 
iOut
 = 1;

1620 
i
=0; i<4; i++){

1621 if–
i
==
iSlŸ
 ){

1622 
i
++;

1623 if–
bLóf
==0 ) 
pNew
->
aiChûdPå
[
iOut
] = 
iNew±r
;

1624 if–
i
<3 ) 
pNew
->
aiKeyPå
[
iOut
] = 
pNode
->aiKeyPtr[i];

1625 
iOut
++;

1626 }if–
bLóf
 || 
p
->
nHeight
==1 ){

1627 if–
i
<3 && 
pNode
->
aiKeyPå
[i] ){

1628 
pNew
->
aiKeyPå
[
iOut
++] = 
pNode
->aiKeyPå[
i
];

1631 if–
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 
i
) ){

1632 
pNew
->
aiChûdPå
[
iOut
] = 
	`gëChûdPå
(
pNode
, 
WORKING_VERSION
, 
i
);

1633 if–
i
<3 ) 
pNew
->
aiKeyPå
[
iOut
] = 
pNode
->aiKeyPtr[i];

1634 
iOut
++;

1638 
	`as£π
–
iOut
<=4 );

1639 
	`as£π
–
bLóf
 || 
pNew
->
aiChûdPå
[0]==0 );

1640 
pC§
->
iNode
--;

1641 
rc
 = 
	`åìUpd©ePå
(
db
, 
pC§
, 
iNew
);

1644 }if–
pC§
->
iNode
==0 ){

1646 
	`as£π
–
iSlŸ
==1 );

1647 
db
->
åìhdr
.
roŸ
.
iRoŸ
 = 
iNew±r
;

1648 
db
->
åìhdr
.
roŸ
.
nHeight
--;

1655 
TªeNode
 *
pP¨ít
;

1656 
iPSlŸ
;

1657 
u32
 
iPìr
;

1658 
iDú
;

1659 
TªeNode
 *
pPìr
;

1660 
TªeNode
 *
pNew1
; 
u32
 
iNew1
;

1662 
	`as£π
–
iSlŸ
==1 );

1664 
pP¨ít
 = 
pC§
->
≠TªeNode
[pC§->
iNode
-1];

1665 
iPSlŸ
 = 
pC§
->
aiCñl
[pC§->
iNode
-1];

1667 if–
iPSlŸ
>0 && 
	`gëChûdPå
(
pP¨ít
, 
WORKING_VERSION
, iPSlot-1) ){

1668 
iDú
 = -1;

1670 
iDú
 = +1;

1672 
iPìr
 = 
	`gëChûdPå
(
pP¨ít
, 
WORKING_VERSION
, 
iPSlŸ
+
iDú
);

1673 
pPìr
 = (
TªeNode
 *)
	`åìShm±r
(
db
, 
iPìr
);

1674 
	`as£πIsW‹kögChûd
(
db
, 
pNode
, 
pP¨ít
, 
iPSlŸ
);

1677 if–
bLóf
 ){

1678 
pNew1
 = (
TªeNode
 *)
	`√wTªeLóf
(
db
, &
iNew1
, &
rc
);

1680 
pNew1
 = (
TªeNode
 *)
	`√wTªeNode
(
db
, &
iNew1
, &
rc
);

1683 if–
pPìr
->
aiKeyPå
[0] &&ÖPeer->aiKeyPtr[2] ){

1687 
TªeNode
 *
pNew2
; 
u32
 
iNew2
;

1688 
TªeNode
 *
pNewP
; 
u32
 
iNewP
;

1690 if–
bLóf
 ){

1691 
pNew2
 = (
TªeNode
 *)
	`√wTªeLóf
(
db
, &
iNew2
, &
rc
);

1693 
pNew2
 = (
TªeNode
 *)
	`√wTªeNode
(
db
, &
iNew2
, &
rc
);

1695 
pNewP
 = 
	`c›yTªeNode
(
db
, 
pP¨ít
, &
iNewP
, &
rc
);

1697 if–
iDú
==-1 ){

1698 
pNew1
->
aiKeyPå
[1] = 
pPìr
->aiKeyPtr[0];

1699 if–
bLóf
==0 ){

1700 
pNew1
->
aiChûdPå
[1] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 0);

1701 
pNew1
->
aiChûdPå
[2] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 1);

1704 
pNewP
->
aiChûdPå
[
iPSlŸ
-1] = 
iNew1
;

1705 
pNewP
->
aiKeyPå
[
iPSlŸ
-1] = 
pPìr
->aiKeyPtr[1];

1706 
pNewP
->
aiChûdPå
[
iPSlŸ
] = 
iNew2
;

1708 
pNew2
->
aiKeyPå
[0] = 
pPìr
->aiKeyPtr[2];

1709 
pNew2
->
aiKeyPå
[1] = 
pP¨ít
->aiKeyPå[
iPSlŸ
-1];

1710 if–
bLóf
==0 ){

1711 
pNew2
->
aiChûdPå
[0] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 2);

1712 
pNew2
->
aiChûdPå
[1] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 3);

1713 
pNew2
->
aiChûdPå
[2] = 
iNew±r
;

1716 
pNew1
->
aiKeyPå
[1] = 
pP¨ít
->aiKeyPå[
iPSlŸ
];

1717 if–
bLóf
==0 ){

1718 
pNew1
->
aiChûdPå
[1] = 
iNew±r
;

1719 
pNew1
->
aiChûdPå
[2] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 0);

1722 
pNewP
->
aiChûdPå
[
iPSlŸ
] = 
iNew1
;

1723 
pNewP
->
aiKeyPå
[
iPSlŸ
] = 
pPìr
->aiKeyPtr[0];

1724 
pNewP
->
aiChûdPå
[
iPSlŸ
+1] = 
iNew2
;

1726 
pNew2
->
aiKeyPå
[0] = 
pPìr
->aiKeyPtr[1];

1727 
pNew2
->
aiKeyPå
[1] = 
pPìr
->aiKeyPtr[2];

1728 if–
bLóf
==0 ){

1729 
pNew2
->
aiChûdPå
[0] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 1);

1730 
pNew2
->
aiChûdPå
[1] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 2);

1731 
pNew2
->
aiChûdPå
[2] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 3);

1734 
	`as£π
–
pC§
->
iNode
>=1 );

1735 
pC§
->
iNode
 -= 2;

1736 if–
rc
==
LSM_OK
 ){

1737 
	`as£π
–
pNew1
->
aiKeyPå
[1] && 
pNew2
->aiKeyPtr[1] );

1738 
rc
 = 
	`åìUpd©ePå
(
db
, 
pC§
, 
iNewP
);

1741 
iKOut
 = 0;

1742 
iPOut
 = 0;

1743 
i
;

1745 
pC§
->
iNode
--;

1747 if–
iDú
==1 ){

1748 
pNew1
->
aiKeyPå
[
iKOut
++] = 
pP¨ít
->aiKeyPå[
iPSlŸ
];

1749 if–
bLóf
==0 ) 
pNew1
->
aiChûdPå
[
iPOut
++] = 
iNew±r
;

1751 
i
=0; i<3; i++){

1752 if–
pPìr
->
aiKeyPå
[
i
] ){

1753 
pNew1
->
aiKeyPå
[
iKOut
++] = 
pPìr
->aiKeyPå[
i
];

1756 if–
bLóf
==0 ){

1757 
i
=0; i<4; i++){

1758 if–
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 
i
) ){

1759 
pNew1
->
aiChûdPå
[
iPOut
++] = 
	`gëChûdPå
(
pPìr
, 
WORKING_VERSION
, 
i
);

1763 if–
iDú
==-1 ){

1764 
iPSlŸ
--;

1765 
pNew1
->
aiKeyPå
[
iKOut
++] = 
pP¨ít
->aiKeyPå[
iPSlŸ
];

1766 if–
bLóf
==0 ) 
pNew1
->
aiChûdPå
[
iPOut
++] = 
iNew±r
;

1767 
pC§
->
aiCñl
[pC§->
iNode
] = 
iPSlŸ
;

1770 
rc
 = 
	`åìDñëeE¡ry
(
db
, 
pC§
, 
iNew1
);

1774  
rc
;

1775 
	}
}

1795 
	$lsmTªeDñëe
(

1796 
lsm_db
 *
db
,

1797 *
pKey1
, 
nKey1
,

1798 *
pKey2
, 
nKey2


1800 
rc
 = 
LSM_OK
;

1801 
bD⁄e
 = 0;

1802 
TªeRoŸ
 *
p
 = &
db
->
åìhdr
.
roŸ
;

1803 
TªeBlob
 
blob
 = {0, 0};

1806 
	`as£π
–
	`åìKeycmp
(
pKey1
, 
nKey1
, 
pKey2
, 
nKey2
)<0 );

1807 
	`as£π
–
	`as£π_dñëe_ønges_m©ch
(
db
) );

1810 
nCÆl
 = 0;

1811 
	`¥ötf
("\n");

1812 
nCÆl
++;

1813 
	`¥ötf
("%d dñëê%†.. %s\n", 
nCÆl
, (*)
pKey1
, (*)
pKey2
);

1814 
	`dump_åì_c⁄ã¡s
(
db
, "before delete");

1819  
bD⁄e
==0 && 
rc
==
LSM_OK
 ){

1820 
ªs
;

1821 
TªeCurs‹
 
c§
;

1822 *
pDñ
; 
nDñ
;

1823 #i‚de‡
NDEBUG


1824 
nE¡ry
 = 
	`åìCou¡E¡rõs
(
db
);

1828 
	`åìCurs‹Inô
(
db
, 0, &
c§
);

1829 
	`lsmTªeCurs‹Sìk
(&
c§
, 
pKey1
, 
nKey1
, &
ªs
);

1830 if–
ªs
<=0 && 
	`lsmTªeCurs‹VÆid
(&
c§
ËË
	`lsmTªeCurs‹Next
(&csr);

1835 
bD⁄e
 = 1;

1836 if–
	`lsmTªeCurs‹VÆid
(&
c§
) ){

1837 
	`lsmTªeCurs‹Key
(&
c§
, 0, &
pDñ
, &
nDñ
);

1838 if–
	`åìKeycmp
(
pDñ
, 
nDñ
, 
pKey2
, 
nKey2
)<0 ) 
bD⁄e
 = 0;

1841 if–
bD⁄e
==0 ){

1842 if–
c§
.
iNode
==(
p
->
nHeight
-1) ){

1844 
rc
 = 
	`åìDñëeE¡ry
(
db
, &
c§
, 0);

1853 
u32
 
iKey
;

1854 
TªeKey
 *
pKey
;

1855 
iNode
 = 
c§
.iNode;

1856 
	`lsmTªeCurs‹Next
(&
c§
);

1857 
	`as£π
–
c§
.
iNode
==(
p
->
nHeight
-1) );

1859 
iKey
 = 
c§
.
≠TªeNode
[c§.
iNode
]->
aiKeyPå
[c§.
aiCñl
[csr.iNode]];

1860 
	`lsmTªeCurs‹Pªv
(&
c§
);

1862 
	`åìOvîwrôeKey
(
db
, &
c§
, 
iKey
, &
rc
);

1863 
pKey
 = 
	`åìShmkey
(
db
, 
iKey
, 
TKV_LOADKEY
, &
blob
, &
rc
);

1864 if–
pKey
 ){

1865 
rc
 = 
	`lsmTªeCurs‹Sìk
(&
c§
, 
	`TKV_KEY
(
pKey
),ÖKey->
nKey
, &
ªs
);

1867 if–
rc
==
LSM_OK
 ){

1868 
	`as£π
–
ªs
==0 && 
c§
.
iNode
==iNode );

1869 
rc
 = 
	`lsmTªeCurs‹Next
(&
c§
);

1870 if–
rc
==
LSM_OK
 ){

1871 
rc
 = 
	`åìDñëeE¡ry
(
db
, &
c§
, 0);

1878 
	`tblobFªe
(
db
, &
c§
.
blob
);

1880 
	`dump_åì_c⁄ã¡s
(
db
, "ddd delete");

1882 
	`as£π
–
bD⁄e
 || 
	`åìCou¡E¡rõs
(
db
)==(
nE¡ry
-1) );

1886 
	`dump_åì_c⁄ã¡s
(
db
, "during delete");

1890 if–
rc
==
LSM_OK
 ){

1891 
rc
 = 
	`åìIn£πE¡ry
(
db
, 
LSM_START_DELETE
, 
pKey1
, 
nKey1
, 0, -1);

1894 
	`dump_åì_c⁄ã¡s
(
db
, "during delete 2");

1896 if–
rc
==
LSM_OK
 ){

1897 
rc
 = 
	`åìIn£πE¡ry
(
db
, 
LSM_END_DELETE
, 
pKey2
, 
nKey2
, 0, -1);

1901 
	`dump_åì_c⁄ã¡s
(
db
, "after delete");

1904 
	`tblobFªe
(
db
, &
blob
);

1905 
	`as£π
–
	`as£π_dñëe_ønges_m©ch
(
db
) );

1906  
rc
;

1907 
	}
}

1913 
	$lsmTªeSize
(
lsm_db
 *
pDb
){

1914  
pDb
->
åìhdr
.
roŸ
.
nByã
;

1915 
	}
}

1920 
	$lsmTªeCurs‹New
(
lsm_db
 *
pDb
, 
bOld
, 
TªeCurs‹
 **
µC§
){

1921 
TªeCurs‹
 *
pC§
;

1922 *
µC§
 = 
pC§
 = 
	`lsmMÆloc
(
pDb
->
pEnv
, (
TªeCurs‹
));

1923 if–
pC§
 ){

1924 
	`åìCurs‹Inô
(
pDb
, 
bOld
, 
pC§
);

1925  
LSM_OK
;

1927  
LSM_NOMEM_BKPT
;

1928 
	}
}

1933 
	$lsmTªeCurs‹De°roy
(
TªeCurs‹
 *
pC§
){

1934 if–
pC§
 ){

1935 
	`tblobFªe
(
pC§
->
pDb
, &pC§->
blob
);

1936 
	`lsmFªe
(
pC§
->
pDb
->
pEnv
,ÖCsr);

1938 
	}
}

1940 
	$lsmTªeCurs‹Re£t
(
TªeCurs‹
 *
pC§
){

1941 if–
pC§
 ){

1942 
pC§
->
iNode
 = -1;

1943 
pC§
->
pSave
 = 0;

1945 
	}
}

1947 #i‚de‡
NDEBUG


1948 
	$åìC§Com∑ª
(
TªeCurs‹
 *
pC§
, *
pKey
, 
nKey
){

1949 
TªeKey
 *
p
;

1950 
cmp
 = 0;

1951 
rc
 = 
LSM_OK
;

1952 
	`as£π
–
pC§
->
iNode
>=0 );

1953 
p
 = 
	`c§GëKey
(
pC§
, &pC§->
blob
, &
rc
);

1954 if–
p
 ){

1955 
cmp
 = 
	`åìKeycmp
(
	`TKV_KEY
(
p
),Ö->
nKey
, 
pKey
,ÇKey);

1957  
cmp
;

1958 
	}
}

1976 
	$lsmTªeCurs‹Sìk
(
TªeCurs‹
 *
pC§
, *
pKey
, 
nKey
, *
pRes
){

1977 
rc
 = 
LSM_OK
;

1978 
lsm_db
 *
pDb
 = 
pC§
->pDb;

1979 
TªeRoŸ
 *
pRoŸ
 = 
pC§
->pRoot;

1980 
u32
 
iNodePå
;

1983 
	`åìCurs‹Re°‹e
(
pC§
, 0);

1985 
iNodePå
 = 
pRoŸ
->
iRoŸ
;

1986 if–
iNodePå
==0 ){

1988 
	`as£π
–
rc
!=
LSM_OK
 || 
pRoŸ
->
iRoŸ
==0 );

1989 *
pRes
 = -1;

1990 
pC§
->
iNode
 = -1;

1992 
TªeBlob
 
b
 = {0, 0};

1993 
ªs
 = 0;

1994 
iNode
 = -1;

1995  
iNodePå
 ){

1996 
TªeNode
 *
pNode
;

1997 
iTe°
;

1998 
u32
 
iTªeKey
;

1999 
TªeKey
 *
pTªeKey
;

2001 
pNode
 = (
TªeNode
 *)
	`åìShm±rUnß„
(
pDb
, 
iNodePå
);

2002 
iNode
++;

2003 
pC§
->
≠TªeNode
[
iNode
] = 
pNode
;

2008 
pTªeKey
 = (
TªeKey
*)
	`åìShm±rUnß„
(
pDb
, 
pNode
->
aiKeyPå
[1]);

2009 if–!(
pTªeKey
->
Êags
 & 
LSM_CONTIGUOUS
) ){

2010 
pTªeKey
 = 
	`åìShmkey
(
pDb
, 
pNode
->
aiKeyPå
[1], 
TKV_LOADKEY
, &
b
, &
rc
);

2011 if–
rc
!=
LSM_OK
 ) ;

2013 
ªs
 = 
	`åìKeycmp
((*)&
pTªeKey
[1],ÖTªeKey->
nKey
, 
pKey
,ÇKey);

2014 if–
ªs
==0 ){

2015 
pC§
->
aiCñl
[
iNode
] = 1;

2022 
iTe°
 = (
ªs
>0 ? 0 : 2);

2023 
iTªeKey
 = 
pNode
->
aiKeyPå
[
iTe°
];

2024 if–
iTªeKey
 ){

2025 
pTªeKey
 = (
TªeKey
*)
	`åìShm±rUnß„
(
pDb
, 
iTªeKey
);

2026 if–!(
pTªeKey
->
Êags
 & 
LSM_CONTIGUOUS
) ){

2027 
pTªeKey
 = 
	`åìShmkey
(
pDb
, 
iTªeKey
, 
TKV_LOADKEY
, &
b
, &
rc
);

2028 if–
rc
 ) ;

2030 
ªs
 = 
	`åìKeycmp
((*)&
pTªeKey
[1],ÖTªeKey->
nKey
, 
pKey
,ÇKey);

2031 if–
ªs
==0 ){

2032 
pC§
->
aiCñl
[
iNode
] = 
iTe°
;

2036 
iTe°
 = 1;

2039 if–
iNode
<(
pRoŸ
->
nHeight
-1) ){

2040 
iNodePå
 = 
	`gëChûdPå
(
pNode
, 
pRoŸ
->
iTønsId
, 
iTe°
 + (
ªs
<0));

2042 
iNodePå
 = 0;

2044 
pC§
->
aiCñl
[
iNode
] = 
iTe°
 + (
iNodePå
 && (
ªs
<0));

2047 *
pRes
 = 
ªs
;

2048 
pC§
->
iNode
 = iNode;

2049 
	`tblobFªe
(
pDb
, &
b
);

2053 #i‚de‡
NDEBUG


2054 if–
rc
==
LSM_OK
 && 
	`lsmTªeCurs‹VÆid
(
pC§
) ){

2055 
cmp
 = 
	`åìC§Com∑ª
(
pC§
, 
pKey
, 
nKey
);

2056 
	`as£π
–*
pRes
==
cmp
 || (*pRes ^ cmp)>0 );

2060  
rc
;

2061 
	}
}

2063 
	$lsmTªeCurs‹Next
(
TªeCurs‹
 *
pC§
){

2064 #i‚de‡
NDEBUG


2065 
TªeKey
 *
pK1
;

2066 
TªeBlob
 
key1
 = {0, 0};

2068 
lsm_db
 *
pDb
 = 
pC§
->pDb;

2069 
TªeRoŸ
 *
pRoŸ
 = 
pC§
->pRoot;

2070 c⁄° 
iLóf
 = 
pRoŸ
->
nHeight
-1;

2071 
iCñl
;

2072 
rc
 = 
LSM_OK
;

2073 
TªeNode
 *
pNode
;

2076 
iRe°‹e
 = 0;

2077 
	`åìCurs‹Re°‹e
(
pC§
, &
iRe°‹e
);

2078 if–
iRe°‹e
>0 )  
LSM_OK
;

2083 #i‚de‡
NDEBUG


2084 
pK1
 = 
	`c§GëKey
(
pC§
, &
key1
, &
rc
);

2085 if–
rc
!=
LSM_OK
 ) Ñc;

2088 
	`as£π
–
	`lsmTªeCurs‹VÆid
(
pC§
) );

2089 
	`as£π
–
pC§
->
aiCñl
[pC§->
iNode
]<3 );

2091 
pNode
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

2092 
iCñl
 = ++
pC§
->
aiCñl
[pC§->
iNode
];

2097 if–
pC§
->
iNode
<
iLóf
 && 
	`gëChûdPå
(
pNode
, 
pRoŸ
->
iTønsId
, 
iCñl
) ){

2099 
u32
 
iNodePå
;

2100 
pC§
->
iNode
++;

2101 
iNodePå
 = 
	`gëChûdPå
(
pNode
, 
pRoŸ
->
iTønsId
, 
iCñl
);

2102 
pNode
 = (
TªeNode
 *)
	`åìShm±r
(
pDb
, 
iNodePå
);

2103 
pC§
->
≠TªeNode
[pC§->
iNode
] = 
pNode
;

2104 
iCñl
 = 
pC§
->
aiCñl
[pC§->
iNode
] = (
pNode
->
aiKeyPå
[0]==0);

2105 } 
pC§
->
iNode
 < 
iLóf
 );

2111 if–
iCñl
>=3 || 
pNode
->
aiKeyPå
[iCell]==0 ){

2112  (--
pC§
->
iNode
)>=0 ){

2113 
iCñl
 = 
pC§
->
aiCñl
[pC§->
iNode
];

2114 if–
iCñl
<3 && 
pC§
->
≠TªeNode
[pC§->
iNode
]->
aiKeyPå
[iCell] ) ;

2118 #i‚de‡
NDEBUG


2119 if–
pC§
->
iNode
>=0 ){

2120 
TªeKey
 *
pK2
 = 
	`c§GëKey
(
pC§
, &pC§->
blob
, &
rc
);

2121 
	`as£π
–
rc
||
	`åìKeycmp
(
	`TKV_KEY
(
pK2
),pK2->
nKey
,TKV_KEY(
pK1
),pK1->nKey)>=0 );

2123 
	`tblobFªe
(
pDb
, &
key1
);

2126  
rc
;

2127 
	}
}

2129 
	$lsmTªeCurs‹Pªv
(
TªeCurs‹
 *
pC§
){

2130 #i‚de‡
NDEBUG


2131 
TªeKey
 *
pK1
;

2132 
TªeBlob
 
key1
 = {0, 0};

2134 
lsm_db
 *
pDb
 = 
pC§
->pDb;

2135 
TªeRoŸ
 *
pRoŸ
 = 
pC§
->pRoot;

2136 c⁄° 
iLóf
 = 
pRoŸ
->
nHeight
-1;

2137 
iCñl
;

2138 
rc
 = 
LSM_OK
;

2139 
TªeNode
 *
pNode
;

2142 
iRe°‹e
 = 0;

2143 
	`åìCurs‹Re°‹e
(
pC§
, &
iRe°‹e
);

2144 if–
iRe°‹e
<0 )  
LSM_OK
;

2149 #i‚de‡
NDEBUG


2150 
pK1
 = 
	`c§GëKey
(
pC§
, &
key1
, &
rc
);

2151 if–
rc
!=
LSM_OK
 ) Ñc;

2154 
	`as£π
–
	`lsmTªeCurs‹VÆid
(
pC§
) );

2155 
pNode
 = 
pC§
->
≠TªeNode
[pC§->
iNode
];

2156 
iCñl
 = 
pC§
->
aiCñl
[pC§->
iNode
];

2157 
	`as£π
–
iCñl
>=0 && iCell<3 );

2162 if–
pC§
->
iNode
<
iLóf
 && 
	`gëChûdPå
(
pNode
, 
pRoŸ
->
iTønsId
, 
iCñl
) ){

2164 
u32
 
iNodePå
;

2165 
pC§
->
iNode
++;

2166 
iNodePå
 = 
	`gëChûdPå
(
pNode
, 
pRoŸ
->
iTønsId
, 
iCñl
);

2167 
pNode
 = (
TªeNode
 *)
	`åìShm±r
(
pDb
, 
iNodePå
);

2168 if–
rc
!=
LSM_OK
 ) ;

2169 
pC§
->
≠TªeNode
[pC§->
iNode
] = 
pNode
;

2170 
iCñl
 = 1 + (
pNode
->
aiKeyPå
[2]!=0Ë+ (
pC§
->
iNode
 < 
iLóf
);

2171 
pC§
->
aiCñl
[pC§->
iNode
] = 
iCñl
;

2172 } 
pC§
->
iNode
 < 
iLóf
 );

2180 
iCñl
 = 
pC§
->
aiCñl
[pC§->
iNode
]-1;

2181 if–
iCñl
>=0 && 
pC§
->
≠TªeNode
[pC§->
iNode
]->
aiKeyPå
[iCell] ) ;

2182 } (--
pC§
->
iNode
)>=0 );

2183 
pC§
->
aiCñl
[pC§->
iNode
] = 
iCñl
;

2186 #i‚de‡
NDEBUG


2187 if–
pC§
->
iNode
>=0 ){

2188 
TªeKey
 *
pK2
 = 
	`c§GëKey
(
pC§
, &pC§->
blob
, &
rc
);

2189 
	`as£π
–
rc
 || 
	`åìKeycmp
(
	`TKV_KEY
(
pK2
),pK2->
nKey
,TKV_KEY(
pK1
),pK1->nKey)<0 );

2191 
	`tblobFªe
(
pDb
, &
key1
);

2194  
rc
;

2195 
	}
}

2201 
	$lsmTªeCurs‹End
(
TªeCurs‹
 *
pC§
, 
bLa°
){

2202 
lsm_db
 *
pDb
 = 
pC§
->pDb;

2203 
TªeRoŸ
 *
pRoŸ
 = 
pC§
->pRoot;

2204 
rc
 = 
LSM_OK
;

2206 
u32
 
iNodePå
;

2207 
pC§
->
iNode
 = -1;

2210 
	`åìCurs‹Re°‹e
(
pC§
, 0);

2212 
iNodePå
 = 
pRoŸ
->
iRoŸ
;

2213  
iNodePå
 ){

2214 
iCñl
;

2215 
TªeNode
 *
pNode
;

2217 
pNode
 = (
TªeNode
 *)
	`åìShm±r
(
pDb
, 
iNodePå
);

2218 if–
rc
 ) ;

2220 if–
bLa°
 ){

2221 
iCñl
 = ((
pNode
->
aiKeyPå
[2]==0) ? 2 : 3);

2223 
iCñl
 = ((
pNode
->
aiKeyPå
[0]==0) ? 1 : 0);

2225 
pC§
->
iNode
++;

2226 
pC§
->
≠TªeNode
[pC§->
iNode
] = 
pNode
;

2228 if–
pC§
->
iNode
<
pRoŸ
->
nHeight
-1 ){

2229 
iNodePå
 = 
	`gëChûdPå
(
pNode
, 
pRoŸ
->
iTønsId
, 
iCñl
);

2231 
iNodePå
 = 0;

2233 
pC§
->
aiCñl
[pC§->
iNode
] = 
iCñl
 - (
iNodePå
==0 && 
bLa°
);

2236  
rc
;

2237 
	}
}

2239 
	$lsmTªeCurs‹Fœgs
(
TªeCurs‹
 *
pC§
){

2240 
Êags
 = 0;

2241 if–
pC§
 &&ÖC§->
iNode
>=0 ){

2242 
rc
 = 
LSM_OK
;

2243 
TªeKey
 *
pKey
 = (TªeKey *)
	`åìShm±rUnß„
(
pC§
->
pDb
,

2244 
pC§
->
≠TªeNode
[pC§->
iNode
]->
aiKeyPå
[pC§->
aiCñl
[pCsr->iNode]]

2246 
	`as£π
–
rc
==
LSM_OK
 );

2247 
Êags
 = (
pKey
->Êag†& ~
LSM_CONTIGUOUS
);

2249  
Êags
;

2250 
	}
}

2252 
	$lsmTªeCurs‹Key
(
TªeCurs‹
 *
pC§
, *
pFœgs
, **
µKey
, *
≤Key
){

2253 
TªeKey
 *
pTªeKey
;

2254 
rc
 = 
LSM_OK
;

2256 
	`as£π
–
	`lsmTªeCurs‹VÆid
(
pC§
) );

2258 
pTªeKey
 = 
pC§
->
pSave
;

2259 if–!
pTªeKey
 ){

2260 
pTªeKey
 = 
	`c§GëKey
(
pC§
, &pC§->
blob
, &
rc
);

2262 if–
rc
==
LSM_OK
 ){

2263 *
≤Key
 = 
pTªeKey
->
nKey
;

2264 if–
pFœgs
 ) *pFœg†
pTªeKey
->
Êags
;

2265 *
µKey
 = (*)&
pTªeKey
[1];

2268  
rc
;

2269 
	}
}

2271 
	$lsmTªeCurs‹VÆue
(
TªeCurs‹
 *
pC§
, **
µVÆ
, *
≤VÆ
){

2272 
ªs
 = 0;

2273 
rc
;

2275 
rc
 = 
	`åìCurs‹Re°‹e
(
pC§
, &
ªs
);

2276 if–
ªs
==0 ){

2277 
TªeKey
 *
pTªeKey
 = 
	`c§GëKey
(
pC§
, &pC§->
blob
, &
rc
);

2278 if–
rc
==
LSM_OK
 ){

2279 if–
pTªeKey
->
Êags
 & 
LSM_INSERT
 ){

2280 *
≤VÆ
 = 
pTªeKey
->
nVÆue
;

2281 *
µVÆ
 = 
	`TKV_VAL
(
pTªeKey
);

2283 *
µVÆ
 = 0;

2284 *
≤VÆ
 = -1;

2288 *
µVÆ
 = 0;

2289 *
≤VÆ
 = 0;

2292  
rc
;

2293 
	}
}

2298 
	$lsmTªeCurs‹VÆid
(
TªeCurs‹
 *
pC§
){

2299  (
pC§
 && (pC§->
pSave
 ||ÖC§->
iNode
>=0));

2300 
	}
}

2307 
	$lsmTªeM¨k
(
lsm_db
 *
pDb
, 
TªeM¨k
 *
pM¨k
){

2308 
pM¨k
->
iRoŸ
 = 
pDb
->
åìhdr
.
roŸ
.iRoot;

2309 
pM¨k
->
nHeight
 = 
pDb
->
åìhdr
.
roŸ
.nHeight;

2310 
pM¨k
->
iWrôe
 = 
pDb
->
åìhdr
.iWrite;

2311 
pM¨k
->
nChunk
 = 
pDb
->
åìhdr
.nChunk;

2312 
pM¨k
->
iNextShmid
 = 
pDb
->
åìhdr
.iNextShmid;

2313 
pM¨k
->
iRﬁlback
 = 
	`ötAºaySize
(&
pDb
->
rﬁlback
);

2314 
	}
}

2320 
	$lsmTªeRﬁlback
(
lsm_db
 *
pDb
, 
TªeM¨k
 *
pM¨k
){

2321 
iIdx
;

2322 
nIdx
;

2323 
u32
 
iNext
;

2324 
ShmChunk
 *
pChunk
;

2325 
u32
 
iChunk
;

2326 
u32
 
iShmid
;

2329 
nIdx
 = 
	`ötAºaySize
(&
pDb
->
rﬁlback
);

2330 
iIdx
 = 
pM¨k
->
iRﬁlback
; iIdx<
nIdx
; iIdx++){

2331 
TªeNode
 *
pNode
;

2332 
pNode
 = 
	`åìShm±r
(
pDb
, 
	`ötAºayE¡ry
(&pDb->
rﬁlback
, 
iIdx
));

2333 
	`as£π
–
pNode
 );

2334 
pNode
->
iV2
 = 0;

2335 
pNode
->
iV2Chûd
 = 0;

2336 
pNode
->
iV2På
 = 0;

2338 
	`ötAºayTrunˇã
(&
pDb
->
rﬁlback
, 
pM¨k
->
iRﬁlback
);

2341 
	`as£π
–
pM¨k
->
iWrôe
!=0 );

2342 
iChunk
 = 
	`åìOff£tToChunk
(
pM¨k
->
iWrôe
-1);

2343 
pChunk
 = 
	`åìShmChunk
(
pDb
, 
iChunk
);

2344 
iNext
 = 
pChunk
->iNext;

2345 
pChunk
->
iNext
 = 0;

2347 
pChunk
 = 
	`åìShmChunk
(
pDb
,ÖDb->
åìhdr
.
iFú°
);

2348 
iShmid
 = 
pChunk
->iShmid-1;

2350  
iNext
 ){

2351 
u32
 
iFªe
 = 
iNext
;

2352 
ShmChunk
 *
pFªe
;

2354 
pFªe
 = 
	`åìShmChunk
(
pDb
, 
iFªe
);

2355 
iNext
 = 
pFªe
->iNext;

2357 if–
iFªe
<
pM¨k
->
nChunk
 ){

2358 
pFªe
->
iNext
 = 
pDb
->
åìhdr
.
iFú°
;

2359 
pFªe
->
iShmid
 = iShmid--;

2360 
pDb
->
åìhdr
.
iFú°
 = 
iFªe
;

2365 
pDb
->
åìhdr
.
roŸ
.
iRoŸ
 = 
pM¨k
->iRoot;

2366 
pDb
->
åìhdr
.
roŸ
.
nHeight
 = 
pM¨k
->nHeight;

2367 
pDb
->
åìhdr
.
iWrôe
 = 
pM¨k
->iWrite;

2368 
pDb
->
åìhdr
.
nChunk
 = 
pM¨k
->nChunk;

2369 
pDb
->
åìhdr
.
iNextShmid
 = 
pM¨k
->iNextShmid;

2370 
	}
}

2380 
	$lsmTªeLﬂdHódî
(
lsm_db
 *
pDb
, *
piRód
){

2381 
nRem
 = 
LSM_ATTEMPTS_BEFORE_PROTOCOL
;

2382  (
nRem
--)>0 ){

2383 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

2385 
	`mem˝y
(&
pDb
->
åìhdr
, &
pShm
->
hdr1
, (
TªeHódî
));

2386 if–
	`åìHódîChecksumOk
(&
pDb
->
åìhdr
) ){

2387 if–
piRód
 ) *piRead = 1;

2388  
LSM_OK
;

2390 
	`mem˝y
(&
pDb
->
åìhdr
, &
pShm
->
hdr2
, (
TªeHódî
));

2391 if–
	`åìHódîChecksumOk
(&
pDb
->
åìhdr
) ){

2392 if–
piRód
 ) *piRead = 2;

2393  
LSM_OK
;

2396 
	`lsmShmB¨rõr
(
pDb
);

2398  
LSM_PROTOCOL_BKPT
;

2399 
	}
}

2401 
	$lsmTªeLﬂdHódîOk
(
lsm_db
 *
pDb
, 
iRód
){

2402 
TªeHódî
 *
p
 = (
iRód
==1Ë? &
pDb
->
pShmhdr
->
hdr1
 : &pDb->pShmhdr->
hdr2
;

2403 
	`as£π
–
iRód
==1 || iRead==2 );

2404  (0==
	`memcmp
(
pDb
->
åìhdr
.
aCksum
, 
p
->aCksum, (
u32
)*2));

2405 
	}
}

2411 
	$lsmTªeEndTønß˘i⁄
(
lsm_db
 *
pDb
, 
bCommô
){

2412 
ShmHódî
 *
pShm
 = 
pDb
->
pShmhdr
;

2414 
	`åìHódîChecksum
(&
pDb
->
åìhdr
,ÖDb->åìhdr.
aCksum
);

2415 
	`mem˝y
(&
pShm
->
hdr2
, &
pDb
->
åìhdr
, (
TªeHódî
));

2416 
	`lsmShmB¨rõr
(
pDb
);

2417 
	`mem˝y
(&
pShm
->
hdr1
, &
pDb
->
åìhdr
, (
TªeHódî
));

2418 
pShm
->
bWrôî
 = 0;

2419 
	`ötAºayFªe
(
pDb
->
pEnv
, &pDb->
rﬁlback
);

2421  
LSM_OK
;

2422 
	}
}

2424 #i‚de‡
NDEBUG


2425 
	$as£π_dñëe_ønges_m©ch
(
lsm_db
 *
db
){

2426 
¥ev
 = 0;

2427 
TªeBlob
 
blob
 = {0, 0};

2428 
TªeCurs‹
 
c§
;

2429 
rc
;

2431 
	`åìCurs‹Inô
(
db
, 0, &
c§
);

2432  
rc
 = 
	`lsmTªeCurs‹End
(&
c§
, 0);

2433 
rc
==
LSM_OK
 && 
	`lsmTªeCurs‹VÆid
(&
c§
);

2434 
rc
 = 
	`lsmTªeCurs‹Next
(&
c§
)

2436 
TªeKey
 *
pKey
 = 
	`c§GëKey
(&
c§
, &
blob
, &
rc
);

2437 if–
rc
!=
LSM_OK
 ) ;

2438 
	`as£π
–((
¥ev
&
LSM_START_DELETE
)==0)==((
pKey
->
Êags
&
LSM_END_DELETE
)==0) );

2439 
¥ev
 = 
pKey
->
Êags
;

2442 
	`tblobFªe
(
c§
.
pDb
, &c§.
blob
);

2443 
	`tblobFªe
(
c§
.
pDb
, &
blob
);

2446 
	}
}

2448 
	$åìCou¡E¡rõs
(
lsm_db
 *
db
){

2449 
TªeCurs‹
 
c§
;

2450 
rc
;

2451 
nE¡ry
 = 0;

2453 
	`åìCurs‹Inô
(
db
, 0, &
c§
);

2454  
rc
 = 
	`lsmTªeCurs‹End
(&
c§
, 0);

2455 
rc
==
LSM_OK
 && 
	`lsmTªeCurs‹VÆid
(&
c§
);

2456 
rc
 = 
	`lsmTªeCurs‹Next
(&
c§
)

2458 
nE¡ry
++;

2461 
	`tblobFªe
(
c§
.
pDb
, &c§.
blob
);

2463  
nE¡ry
;

2464 
	}
}

	@src/lsm_unix.c

15 #i‡
deföed
(
__GNUC__
Ë|| deföed(
__TINYC__
)

17 #i‚de‡
_XOPEN_SOURCE


18 
	#_XOPEN_SOURCE
 500

	)

22 
	~<uni°d.h
>

23 
	~<sys/ty≥s.h
>

25 
	~<sys/°©.h
>

26 
	~<f˙é.h
>

27 
	~<as£π.h
>

28 
	~<°rög.h
>

30 
	~<°dlib.h
>

31 
	~<°d¨g.h
>

32 
	~<°dio.h
>

33 
	~<˘y≥.h
>

35 
	~<uni°d.h
>

36 
	~<î∫o.h
>

38 
	~<sys/mm™.h
>

39 
	~"lsmI¡.h
"

42 #ifde‡
__ANDROID__


43 
	#fd©async
(
x
Ë
	`fsync
(x)

	)

49 
PosixFûe
 
	tPosixFûe
;

50 
	sPosixFûe
 {

51 
lsm_ív
 *
	mpEnv
;

52 c⁄° *
	mzName
;

53 
	mfd
;

54 
	mshmfd
;

55 *
	mpM≠
;

56 
off_t
 
	mnM≠
;

57 
	mnShm
;

58 **
	m≠Shm
;

61 *
	$posixShmFûe
(
PosixFûe
 *
p
){

62 *
zShm
;

63 
nName
 = 
	`°æí
(
p
->
zName
);

64 
zShm
 = (*)
	`lsmMÆloc
(
p
->
pEnv
, 
nName
+4+1);

65 if–
zShm
 ){

66 
	`mem˝y
(
zShm
, 
p
->
zName
, 
nName
);

67 
	`mem˝y
(&
zShm
[
nName
], "-shm", 5);

69  
zShm
;

70 
	}
}

72 
	$lsmPosixOsO≥n
(

73 
lsm_ív
 *
pEnv
,

74 c⁄° *
zFûe
,

75 
Êags
,

76 
lsm_fûe
 **
µFûe


78 
rc
 = 
LSM_OK
;

79 
PosixFûe
 *
p
;

81 
p
 = 
	`lsm_mÆloc
(
pEnv
, (
PosixFûe
));

82 if–
p
==0 ){

83 
rc
 = 
LSM_NOMEM
;

85 
bRód⁄ly
 = (
Êags
 & 
LSM_OPEN_READONLY
);

86 
oÊags
 = (
bRód⁄ly
 ? 
O_RDONLY
 : (
O_RDWR
|
O_CREAT
));

87 
	`mem£t
(
p
, 0, (
PosixFûe
));

88 
p
->
zName
 = 
zFûe
;

89 
p
->
pEnv
 =ÖEnv;

90 
p
->
fd
 = 
	`›í
(
zFûe
, 
oÊags
, 0644);

91 if–
p
->
fd
<0 ){

92 
	`lsm_‰ì
(
pEnv
, 
p
);

93 
p
 = 0;

94 if–
î∫o
==
ENOENT
 ){

95 
rc
 = 
	`lsmEº‹Bk±
(
LSM_IOERR_NOENT
);

97 
rc
 = 
LSM_IOERR_BKPT
;

102 *
µFûe
 = (
lsm_fûe
 *)
p
;

103  
rc
;

104 
	}
}

106 
	$lsmPosixOsWrôe
(

107 
lsm_fûe
 *
pFûe
,

108 
lsm_i64
 
iOff
,

109 *
pD©a
,

110 
nD©a


112 
rc
 = 
LSM_OK
;

113 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

114 
off_t
 
off£t
;

116 
off£t
 = 
	`l£ek
(
p
->
fd
, (
off_t
)
iOff
, 
SEEK_SET
);

117 if–
off£t
!=
iOff
 ){

118 
rc
 = 
LSM_IOERR_BKPT
;

120 
ssize_t
 
¥c
 = 
	`wrôe
(
p
->
fd
, 
pD©a
, (
size_t
)
nD©a
);

121 if–
¥c
<0 ) 
rc
 = 
LSM_IOERR_BKPT
;

124  
rc
;

125 
	}
}

127 
	$lsmPosixOsTrunˇã
(

128 
lsm_fûe
 *
pFûe
,

129 
lsm_i64
 
nSize


131 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

132 
rc
 = 
LSM_OK
;

133 
¥c
;

134 
°©
 
sSèt
;

136 
¥c
 = 
	`f°©
(
p
->
fd
, &
sSèt
);

137 if–
¥c
==0 && 
sSèt
.
°_size
>
nSize
 ){

138 
¥c
 = 
	`·runˇã
(
p
->
fd
, (
off_t
)
nSize
);

140 if–
¥c
<0 ) 
rc
 = 
LSM_IOERR_BKPT
;

142  
rc
;

143 
	}
}

145 
	$lsmPosixOsRód
(

146 
lsm_fûe
 *
pFûe
,

147 
lsm_i64
 
iOff
,

148 *
pD©a
,

149 
nD©a


151 
rc
 = 
LSM_OK
;

152 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

153 
off_t
 
off£t
;

155 
off£t
 = 
	`l£ek
(
p
->
fd
, (
off_t
)
iOff
, 
SEEK_SET
);

156 if–
off£t
!=
iOff
 ){

157 
rc
 = 
LSM_IOERR_BKPT
;

159 
ssize_t
 
¥c
 = 
	`ªad
(
p
->
fd
, 
pD©a
, (
size_t
)
nD©a
);

160 if–
¥c
<0 ){

161 
rc
 = 
LSM_IOERR_BKPT
;

162 }if–
¥c
<
nD©a
 ){

163 
	`mem£t
(&((
u8
 *)
pD©a
)[
¥c
], 0, 
nD©a
 -Örc);

168  
rc
;

169 
	}
}

171 
	$lsmPosixOsSync
(
lsm_fûe
 *
pFûe
){

172 
rc
 = 
LSM_OK
;

174 #i‚de‡
LSM_NO_SYNC


175 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

176 
¥c
 = 0;

178 if–
p
->
pM≠
 ){

179 
¥c
 = 
	`msync
(
p
->
pM≠
,Ö->
nM≠
, 
MS_SYNC
);

181 if–
¥c
==0 )Ör¯
	`fd©async
(
p
->
fd
);

182 if–
¥c
<0 ) 
rc
 = 
LSM_IOERR_BKPT
;

184 ()
pFûe
;

187  
rc
;

188 
	}
}

190 
	$lsmPosixOsSe˘‹Size
(
lsm_fûe
 *
pFûe
){

192 
	}
}

194 
	$lsmPosixOsRem≠
(

195 
lsm_fûe
 *
pFûe
,

196 
lsm_i64
 
iMö
,

197 **
µOut
,

198 
lsm_i64
 *
≤Out


200 
off_t
 
iSz
;

201 
¥c
;

202 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

203 
°©
 
buf
;

207 c⁄° 
aIn¸Sz
[] = {256*1024, 1024*1024};

208 
nIn¸Sz
 = 
aIn¸Sz
[
iMö
>(2*1024*1024)];

210 if–
p
->
pM≠
 ){

211 
	`munm≠
(
p
->
pM≠
,Ö->
nM≠
);

212 *
µOut
 = 
p
->
pM≠
 = 0;

213 *
≤Out
 = 
p
->
nM≠
 = 0;

216 if–
iMö
>=0 ){

217 
	`mem£t
(&
buf
, 0, (buf));

218 
¥c
 = 
	`f°©
(
p
->
fd
, &
buf
);

219 if–
¥c
!=0 )  
LSM_IOERR_BKPT
;

220 
iSz
 = 
buf
.
°_size
;

221 if–
iSz
<
iMö
 ){

222 
iSz
 = ((
iMö
 + 
nIn¸Sz
-1) /ÇIncrSz) *ÇIncrSz;

223 
¥c
 = 
	`·runˇã
(
p
->
fd
, 
iSz
);

224 if–
¥c
!=0 )  
LSM_IOERR_BKPT
;

227 
p
->
pM≠
 = 
	`mm≠
(0, 
iSz
, 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
,Ö->
fd
, 0);

228 
p
->
nM≠
 = 
iSz
;

231 *
µOut
 = 
p
->
pM≠
;

232 *
≤Out
 = 
p
->
nM≠
;

233  
LSM_OK
;

234 
	}
}

236 
	$lsmPosixOsFuŒ∑th
(

237 
lsm_ív
 *
pEnv
,

238 c⁄° *
zName
,

239 *
zOut
,

240 *
≤Out


242 
nBuf
 = *
≤Out
;

243 
nReq
;

245 if–
zName
[0]!='/' ){

246 *
z
;

247 *
zTmp
;

248 
nTmp
 = 512;

249 
zTmp
 = 
	`lsmMÆloc
(
pEnv
, 
nTmp
);

250  
zTmp
 ){

251 
z
 = 
	`gëcwd
(
zTmp
, 
nTmp
);

252 if–
z
 || 
î∫o
!=
ERANGE
 ) ;

253 
nTmp
 =ÇTmp*2;

254 
zTmp
 = 
	`lsmRóŒocOrFªe
(
pEnv
, zTmp, 
nTmp
);

256 if–
zTmp
==0 )  
LSM_NOMEM_BKPT
;

257 if–
z
==0 )  
LSM_IOERR_BKPT
;

258 
	`as£π
–
z
==
zTmp
 );

260 
nTmp
 = 
	`°æí
(
zTmp
);

261 
nReq
 = 
nTmp
 + 1 + 
	`°æí
(
zName
) + 1;

262 if–
nReq
<=
nBuf
 ){

263 
	`mem˝y
(
zOut
, 
zTmp
, 
nTmp
);

264 
zOut
[
nTmp
] = '/';

265 
	`mem˝y
(&
zOut
[
nTmp
+1], 
zName
, 
	`°æí
(zName)+1);

267 
	`lsmFªe
(
pEnv
, 
zTmp
);

269 
nReq
 = 
	`°æí
(
zName
)+1;

270 if–
nReq
<=
nBuf
 ){

271 
	`mem˝y
(
zOut
, 
zName
, 
	`°æí
(zName)+1);

275 *
≤Out
 = 
nReq
;

276  
LSM_OK
;

277 
	}
}

279 
	$lsmPosixOsFûeid
(

280 
lsm_fûe
 *
pFûe
,

281 *
pBuf
,

282 *
≤Buf


284 
¥c
;

285 
nBuf
;

286 
nReq
;

287 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

288 
°©
 
buf
;

290 
nBuf
 = *
≤Buf
;

291 
nReq
 = ((
buf
.
°_dev
Ë+ (buf.
°_öo
));

292 *
≤Buf
 = 
nReq
;

293 if–
nReq
>
nBuf
 )  
LSM_OK
;

295 
	`mem£t
(&
buf
, 0, (buf));

296 
¥c
 = 
	`f°©
(
p
->
fd
, &
buf
);

297 if–
¥c
!=0 )  
LSM_IOERR_BKPT
;

299 
	`mem˝y
(
pBuf
, &
buf
.
°_dev
, (buf.st_dev));

300 
	`mem˝y
(&(((
u8
 *)
pBuf
)[(
buf
.
°_dev
)]), &buf.
°_öo
, (buf.st_ino));

301  
LSM_OK
;

302 
	}
}

304 
	$lsmPosixOsU∆ök
(
lsm_ív
 *
pEnv
, c⁄° *
zFûe
){

305 
¥c
 = 
	`u∆ök
(
zFûe
);

306  
¥c
 ? 
LSM_IOERR_BKPT
 : 
LSM_OK
;

307 
	}
}

309 
	$lsmPosixOsLock
(
lsm_fûe
 *
pFûe
, 
iLock
, 
eTy≥
){

310 
rc
 = 
LSM_OK
;

311 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

312 c⁄° 
aTy≥
[3] = { 
F_UNLCK
, 
F_RDLCK
, 
F_WRLCK
 };

313 
Êock
 
lock
;

315 
	`as£π
–
aTy≥
[
LSM_LOCK_UNLOCK
]==
F_UNLCK
 );

316 
	`as£π
–
aTy≥
[
LSM_LOCK_SHARED
]==
F_RDLCK
 );

317 
	`as£π
–
aTy≥
[
LSM_LOCK_EXCL
]==
F_WRLCK
 );

318 
	`as£π
–
eTy≥
>=0 &&ÉTy≥<
	`¨øy_size
(
aTy≥
) );

319 
	`as£π
–
iLock
>0 && iLock<=32 );

321 
	`mem£t
(&
lock
, 0, (lock));

322 
lock
.
l_whí˚
 = 
SEEK_SET
;

323 
lock
.
l_Àn
 = 1;

324 
lock
.
l_ty≥
 = 
aTy≥
[
eTy≥
];

325 
lock
.
l_°¨t
 = (4096-
iLock
);

327 if–
	`f˙é
(
p
->
fd
, 
F_SETLK
, &
lock
) ){

328 
e
 = 
î∫o
;

329 if–
e
==
EACCES
 ||É==
EAGAIN
 ){

330 
rc
 = 
LSM_BUSY
;

332 
rc
 = 
LSM_IOERR_BKPT
;

336  
rc
;

337 
	}
}

339 
	$lsmPosixOsTe°Lock
(
lsm_fûe
 *
pFûe
, 
iLock
, 
nLock
, 
eTy≥
){

340 
rc
 = 
LSM_OK
;

341 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

342 c⁄° 
aTy≥
[3] = { 0, 
F_RDLCK
, 
F_WRLCK
 };

343 
Êock
 
lock
;

345 
	`as£π
–
eTy≥
==
LSM_LOCK_SHARED
 ||ÉTy≥==
LSM_LOCK_EXCL
 );

346 
	`as£π
–
aTy≥
[
LSM_LOCK_SHARED
]==
F_RDLCK
 );

347 
	`as£π
–
aTy≥
[
LSM_LOCK_EXCL
]==
F_WRLCK
 );

348 
	`as£π
–
eTy≥
>=0 &&ÉTy≥<
	`¨øy_size
(
aTy≥
) );

349 
	`as£π
–
iLock
>0 && iLock<=32 );

351 
	`mem£t
(&
lock
, 0, (lock));

352 
lock
.
l_whí˚
 = 
SEEK_SET
;

353 
lock
.
l_Àn
 = 
nLock
;

354 
lock
.
l_ty≥
 = 
aTy≥
[
eTy≥
];

355 
lock
.
l_°¨t
 = (4096-
iLock
);

357 if–
	`f˙é
(
p
->
fd
, 
F_GETLK
, &
lock
) ){

358 
rc
 = 
LSM_IOERR_BKPT
;

359 }if–
lock
.
l_ty≥
!=
F_UNLCK
 ){

360 
rc
 = 
LSM_BUSY
;

363  
rc
;

364 
	}
}

366 
	$lsmPosixOsShmM≠
(
lsm_fûe
 *
pFûe
, 
iChunk
, 
sz
, **
µShm
){

367 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

369 *
µShm
 = 0;

370 
	`as£π
–
sz
==
LSM_SHM_CHUNK_SIZE
 );

371 if–
iChunk
>=
p
->
nShm
 ){

372 
i
;

373 **
≠New
;

374 
nNew
 = 
iChunk
+1;

375 
off_t
 
nReq
 = 
nNew
 * 
LSM_SHM_CHUNK_SIZE
;

376 
°©
 
sSèt
;

379 if–
p
->
shmfd
<=0 ){

380 *
zShm
 = 
	`posixShmFûe
(
p
);

381 if–!
zShm
 )  
LSM_NOMEM_BKPT
;

382 
p
->
shmfd
 = 
	`›í
(
zShm
, 
O_RDWR
|
O_CREAT
, 0644);

383 
	`lsmFªe
(
p
->
pEnv
, 
zShm
);

384 if–
p
->
shmfd
<0 ){

385  
LSM_IOERR_BKPT
;

391 if–
	`f°©
(
p
->
shmfd
, &
sSèt
) ){

392  
LSM_IOERR_BKPT
;

394 if–
sSèt
.
°_size
<
nReq
 ){

395 if–
	`·runˇã
(
p
->
shmfd
, 
nReq
) ){

396  
LSM_IOERR_BKPT
;

400 
≠New
 = (**)
	`lsmRóŒoc
(
p
->
pEnv
,Ö->
≠Shm
, (*Ë* 
nNew
);

401 if–!
≠New
 )  
LSM_NOMEM_BKPT
;

402 
i
=
p
->
nShm
; i<
nNew
; i++){

403 
≠New
[
i
] = 0;

405 
p
->
≠Shm
 = 
≠New
;

406 
p
->
nShm
 = 
nNew
;

409 if–
p
->
≠Shm
[
iChunk
]==0 ){

410 
p
->
≠Shm
[
iChunk
] = 
	`mm≠
(0, 
LSM_SHM_CHUNK_SIZE
,

411 
PROT_READ
|
PROT_WRITE
, 
MAP_SHARED
, 
p
->
shmfd
, 
iChunk
*
LSM_SHM_CHUNK_SIZE


413 if–
p
->
≠Shm
[
iChunk
]==0 )  
LSM_IOERR_BKPT
;

416 *
µShm
 = 
p
->
≠Shm
[
iChunk
];

417  
LSM_OK
;

418 
	}
}

420 
	$lsmPosixOsShmB¨rõr
(){

421 
	}
}

423 
	$lsmPosixOsShmUnm≠
(
lsm_fûe
 *
pFûe
, 
bDñëe
){

424 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

425 if–
p
->
shmfd
>0 ){

426 
i
;

427 
i
=0; i<
p
->
nShm
; i++){

428 if–
p
->
≠Shm
[
i
] ){

429 
	`munm≠
(
p
->
≠Shm
[
i
], 
LSM_SHM_CHUNK_SIZE
);

430 
p
->
≠Shm
[
i
] = 0;

433 
	`˛o£
(
p
->
shmfd
);

434 
p
->
shmfd
 = 0;

435 if–
bDñëe
 ){

436 *
zShm
 = 
	`posixShmFûe
(
p
);

437 if–
zShm
 ) 
	`u∆ök
(zShm);

438 
	`lsmFªe
(
p
->
pEnv
, 
zShm
);

441  
LSM_OK
;

442 
	}
}

445 
	$lsmPosixOsClo£
(
lsm_fûe
 *
pFûe
){

446 
PosixFûe
 *
p
 = (PosixFûê*)
pFûe
;

447 
	`lsmPosixOsShmUnm≠
(
pFûe
, 0);

448 if–
p
->
pM≠
 ) 
	`munm≠
’->pM≠,Ö->
nM≠
);

449 
	`˛o£
(
p
->
fd
);

450 
	`lsm_‰ì
(
p
->
pEnv
,Ö->
≠Shm
);

451 
	`lsm_‰ì
(
p
->
pEnv
,Ö);

452  
LSM_OK
;

453 
	}
}

455 
	$lsmPosixOsSÀï
(
lsm_ív
 *
pEnv
, 
us
){

458 if–
	`u¶ìp
(
us
ËË 
LSM_IOERR
;

460 
	`u¶ìp
(
us
);

461  
LSM_OK
;

462 
	}
}

467 
	#BLOCK_HDR_SIZE
 
	`ROUND8
–(
sqlôe4_size_t
Ë)

	)

469 *
	$lsmPosixOsMÆloc
(
lsm_ív
 *
pEnv
, 
N
){

470 * 
m
;

471 
N
 +
BLOCK_HDR_SIZE
;

472 
m
 = (*)
	`mÆloc
(
N
);

473 *((
sqlôe4_size_t
*)
m
Ë
N
;

474  
m
 + 
BLOCK_HDR_SIZE
;

475 
	}
}

477 
	$lsmPosixOsFªe
(
lsm_ív
 *
pEnv
, *
p
){

478 if(
p
){

479 
	`‰ì
–((*)
p
Ë- 
BLOCK_HDR_SIZE
 );

481 
	}
}

483 *
	$lsmPosixOsRóŒoc
(
lsm_ív
 *
pEnv
, *
p
, 
N
){

484 * 
m
 = (*)
p
;

485 if(1>
N
){

486 
	`lsmPosixOsFªe
–
pEnv
, 
p
 );

487  
NULL
;

488 }if(
NULL
==
p
){

489  
	`lsmPosixOsMÆloc
(
pEnv
, 
N
);

491 * 
ª
 = 
NULL
;

492 
m
 -
BLOCK_HDR_SIZE
;

494 
sqlôe4_size_t
 * 
sz
 = (sqlôe4_size_t*)
m
;

495 if(*
sz
 >(
sqlôe4_size_t
)
N
){

496  
p
;

499 
ª
 = 
	`ªÆloc
–
m
, 
N
 + 
BLOCK_HDR_SIZE
 );

500 if(
ª
){

501 
m
 = (*)
ª
;

502 *((
sqlôe4_size_t
*)
m
Ë
N
;

503  
m
 + 
BLOCK_HDR_SIZE
;

505  
NULL
;

508 
	}
}

510 
sqlôe4_size_t
 
	$lsmPosixOsMSize
(
lsm_ív
 *
pEnv
, *
p
){

511 * 
m
 = (*)
p
;

512  *((
sqlôe4_size_t
*)(
m
-
BLOCK_HDR_SIZE
));

513 
	}
}

514 #unde‡
BLOCK_HDR_SIZE


517 #ifde‡
LSM_MUTEX_PTHREADS


523 
	~<±hªad.h
>

525 
PthªadMuãx
 
	tPthªadMuãx
;

526 
	sPthªadMuãx
 {

527 
lsm_ív
 *
	mpEnv
;

528 
±hªad_muãx_t
 
	mmuãx
;

529 #ifde‡
LSM_DEBUG


530 
±hªad_t
 
	mow√r
;

534 #ifde‡
LSM_DEBUG


535 
	#LSM_PTHREAD_STATIC_MUTEX
 { 0, 
PTHREAD_MUTEX_INITIALIZER
, 0 }

	)

537 
	#LSM_PTHREAD_STATIC_MUTEX
 { 0, 
PTHREAD_MUTEX_INITIALIZER
 }

	)

540 
	$lsmPosixOsMuãxSètic
(

541 
lsm_ív
 *
pEnv
,

542 
iMuãx
,

543 
lsm_muãx
 **
µSètic


545 
PthªadMuãx
 
sMuãx
[2] = {

546 
LSM_PTHREAD_STATIC_MUTEX
,

547 
LSM_PTHREAD_STATIC_MUTEX


550 
	`as£π
–
iMuãx
==
LSM_MUTEX_GLOBAL
 || iMuãx==
LSM_MUTEX_HEAP
 );

551 
	`as£π
–
LSM_MUTEX_GLOBAL
==1 && 
LSM_MUTEX_HEAP
==2 );

553 *
µSètic
 = (
lsm_muãx
 *)&
sMuãx
[
iMuãx
-1];

554  
LSM_OK
;

555 
	}
}

557 
	$lsmPosixOsMuãxNew
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 **
µNew
){

558 
PthªadMuãx
 *
pMuãx
;

559 
±hªad_muãx©å_t
 
©å
;

561 
pMuãx
 = (
PthªadMuãx
 *)
	`lsmMÆlocZîo
(
pEnv
, (PthreadMutex));

562 if–!
pMuãx
 )  
LSM_NOMEM_BKPT
;

564 
pMuãx
->
pEnv
 =ÖEnv;

565 
	`±hªad_muãx©å_öô
(&
©å
);

566 
	`±hªad_muãx©å_£ây≥
(&
©å
, 
PTHREAD_MUTEX_RECURSIVE
);

567 
	`±hªad_muãx_öô
(&
pMuãx
->
muãx
, &
©å
);

568 
	`±hªad_muãx©å_de°roy
(&
©å
);

570 *
µNew
 = (
lsm_muãx
 *)
pMuãx
;

571  
LSM_OK
;

572 
	}
}

574 
	$lsmPosixOsMuãxDñ
(
lsm_muãx
 *
p
){

575 
PthªadMuãx
 *
pMuãx
 = (PthªadMuãx *)
p
;

576 
	`±hªad_muãx_de°roy
(&
pMuãx
->
muãx
);

577 
	`lsmFªe
(
pMuãx
->
pEnv
,ÖMutex);

578 
	}
}

580 
	$lsmPosixOsMuãxE¡î
(
lsm_muãx
 *
p
){

581 
PthªadMuãx
 *
pMuãx
 = (PthªadMuãx *)
p
;

582 
	`±hªad_muãx_lock
(&
pMuãx
->
muãx
);

584 #ifde‡
LSM_DEBUG


585 
	`as£π
–!
	`±hªad_equÆ
(
pMuãx
->
ow√r
, 
	`±hªad_£lf
()) );

586 
pMuãx
->
ow√r
 = 
	`±hªad_£lf
();

587 
	`as£π
–
	`±hªad_equÆ
(
pMuãx
->
ow√r
, 
	`±hªad_£lf
()) );

589 
	}
}

591 
	$lsmPosixOsMuãxTry
(
lsm_muãx
 *
p
){

592 
ªt
;

593 
PthªadMuãx
 *
pMuãx
 = (PthªadMuãx *)
p
;

594 
ªt
 = 
	`±hªad_muãx_åylock
(&
pMuãx
->
muãx
);

595 #ifde‡
LSM_DEBUG


596 if–
ªt
==0 ){

597 
	`as£π
–!
	`±hªad_equÆ
(
pMuãx
->
ow√r
, 
	`±hªad_£lf
()) );

598 
pMuãx
->
ow√r
 = 
	`±hªad_£lf
();

599 
	`as£π
–
	`±hªad_equÆ
(
pMuãx
->
ow√r
, 
	`±hªad_£lf
()) );

602  
ªt
;

603 
	}
}

605 
	$lsmPosixOsMuãxLóve
(
lsm_muãx
 *
p
){

606 
PthªadMuãx
 *
pMuãx
 = (PthªadMuãx *)
p
;

607 #ifde‡
LSM_DEBUG


608 
	`as£π
–
	`±hªad_equÆ
(
pMuãx
->
ow√r
, 
	`±hªad_£lf
()) );

609 
pMuãx
->
ow√r
 = 0;

610 
	`as£π
–!
	`±hªad_equÆ
(
pMuãx
->
ow√r
, 
	`±hªad_£lf
()) );

612 
	`±hªad_muãx_u∆ock
(&
pMuãx
->
muãx
);

613 
	}
}

615 #ifde‡
LSM_DEBUG


616 
	$lsmPosixOsMuãxHñd
(
lsm_muãx
 *
p
){

617 
PthªadMuãx
 *
pMuãx
 = (PthªadMuãx *)
p
;

618  
pMuãx
 ? 
	`±hªad_equÆ
’Muãx->
ow√r
, 
	`±hªad_£lf
()) : 1;

619 
	}
}

620 
	$lsmPosixOsMuãxNŸHñd
(
lsm_muãx
 *
p
){

621 
PthªadMuãx
 *
pMuãx
 = (PthªadMuãx *)
p
;

622  
pMuãx
 ? !
	`±hªad_equÆ
’Muãx->
ow√r
, 
	`±hªad_£lf
()) : 1;

623 
	}
}

632 
No›Muãx
 
	tNo›Muãx
;

633 
	sNo›Muãx
 {

634 
lsm_ív
 *
	mpEnv
;

635 
	mbHñd
;

636 
	mbSètic
;

638 
No›Muãx
 
	gaSèticNo›Muãx
[2] = {

643 
	$lsmPosixOsMuãxSètic
(

644 
lsm_ív
 *
pEnv
,

645 
iMuãx
,

646 
lsm_muãx
 **
µSètic


648 
	`as£π
–
iMuãx
>=1 && iMuãx<=()
	`¨øy_size
(
aSèticNo›Muãx
) );

649 *
µSètic
 = (
lsm_muãx
 *)&
aSèticNo›Muãx
[
iMuãx
-1];

650  
LSM_OK
;

651 
	}
}

652 
	$lsmPosixOsMuãxNew
(
lsm_ív
 *
pEnv
, 
lsm_muãx
 **
µNew
){

653 
No›Muãx
 *
p
;

654 
p
 = (
No›Muãx
 *)
	`lsmMÆlocZîo
(
pEnv
, (NoopMutex));

655 if–
p
 )Ö->
pEnv
 =ÖEnv;

656 *
µNew
 = (
lsm_muãx
 *)
p
;

657  (
p
 ? 
LSM_OK
 : 
LSM_NOMEM_BKPT
);

658 
	}
}

659 
	$lsmPosixOsMuãxDñ
(
lsm_muãx
 *
pMuãx
) {

660 
No›Muãx
 *
p
 = (No›Muãx *)
pMuãx
;

661 
	`as£π
–
p
->
bSètic
==0 &&Ö->
pEnv
 );

662 
	`lsmFªe
(
p
->
pEnv
,Ö);

663 
	}
}

664 
	$lsmPosixOsMuãxE¡î
(
lsm_muãx
 *
pMuãx
){

665 
No›Muãx
 *
p
 = (No›Muãx *)
pMuãx
;

666 
	`as£π
–
p
->
bHñd
==0 );

667 
p
->
bHñd
 = 1;

668 
	}
}

669 
	$lsmPosixOsMuãxTry
(
lsm_muãx
 *
pMuãx
){

670 
No›Muãx
 *
p
 = (No›Muãx *)
pMuãx
;

671 
	`as£π
–
p
->
bHñd
==0 );

672 
p
->
bHñd
 = 1;

674 
	}
}

675 
	$lsmPosixOsMuãxLóve
(
lsm_muãx
 *
pMuãx
){

676 
No›Muãx
 *
p
 = (No›Muãx *)
pMuãx
;

677 
	`as£π
–
p
->
bHñd
==1 );

678 
p
->
bHñd
 = 0;

679 
	}
}

680 #ifde‡
LSM_DEBUG


681 
	$lsmPosixOsMuãxHñd
(
lsm_muãx
 *
pMuãx
){

682 
No›Muãx
 *
p
 = (No›Muãx *)
pMuãx
;

683  
p
 ?Ö->
bHñd
 : 1;

684 
	}
}

685 
	$lsmPosixOsMuãxNŸHñd
(
lsm_muãx
 *
pMuãx
){

686 
No›Muãx
 *
p
 = (No›Muãx *)
pMuãx
;

687  
p
 ? !p->
bHñd
 : 1;

688 
	}
}

694 #i‚de‡
LSM_DEBUG


695 
	#lsmPosixOsMuãxHñd
 0

	)

696 
	#lsmPosixOsMuãxNŸHñd
 0

	)

699 
lsm_ív
 *
	$lsm_deÁu…_ív
(){

700 
lsm_ív
 
posix_ív
 = {

701 (
lsm_ív
),

705 
lsmPosixOsFuŒ∑th
,

706 
lsmPosixOsO≥n
,

707 
lsmPosixOsRód
,

708 
lsmPosixOsWrôe
,

709 
lsmPosixOsTrunˇã
,

710 
lsmPosixOsSync
,

711 
lsmPosixOsSe˘‹Size
,

712 
lsmPosixOsRem≠
,

713 
lsmPosixOsFûeid
,

714 
lsmPosixOsClo£
,

715 
lsmPosixOsU∆ök
,

716 
lsmPosixOsLock
,

717 
lsmPosixOsTe°Lock
,

718 
lsmPosixOsShmM≠
,

719 
lsmPosixOsShmB¨rõr
,

720 
lsmPosixOsShmUnm≠
,

723 
lsmPosixOsMÆloc
,

724 
lsmPosixOsRóŒoc
,

725 
lsmPosixOsFªe
,

726 
lsmPosixOsMSize
,

729 
lsmPosixOsMuãxSètic
,

730 
lsmPosixOsMuãxNew
,

731 
lsmPosixOsMuãxDñ
,

732 
lsmPosixOsMuãxE¡î
,

733 
lsmPosixOsMuãxTry
,

734 
lsmPosixOsMuãxLóve
,

735 
lsmPosixOsMuãxHñd
,

736 
lsmPosixOsMuãxNŸHñd
,

738 
lsmPosixOsSÀï
,

740  &
posix_ív
;

741 
	}
}

	@src/lsm_varint.c

16 
	~"lsmI¡.h
"

26 
	$lsmSqlôe4GëV¨öt64
(c⁄° *
z
, 
u64
 *
pResu…
){

27 
x
;

28 if–
z
[0]<=240 ){

29 *
pResu…
 = 
z
[0];

32 if–
z
[0]<=248 ){

33 *
pResu…
 = (
z
[0]-241)*256 + z[1] + 240;

36 if–
z
[0]==249 ){

37 *
pResu…
 = 2288 + 256*
z
[1] + z[2];

40 if–
z
[0]==250 ){

41 *
pResu…
 = (
z
[1]<<16) + (z[2]<<8) + z[3];

44 
x
 = (
z
[1]<<24) + (z[2]<<16) + (z[3]<<8) + z[4];

45 if–
z
[0]==251 ){

46 *
pResu…
 = 
x
;

49 if–
z
[0]==252 ){

50 *
pResu…
 = (((
u64
)
x
)<<8Ë+ 
z
[5];

53 if–
z
[0]==253 ){

54 *
pResu…
 = (((
u64
)
x
)<<16Ë+ (
z
[5]<<8) + z[6];

57 if–
z
[0]==254 ){

58 *
pResu…
 = (((
u64
)
x
)<<24Ë+ (
z
[5]<<16) + (z[6]<<8) + z[7];

61 *
pResu…
 = (((
u64
)
x
)<<32) +

62 (0xfffffff‡& ((
z
[5]<<24) + (z[6]<<16) + (z[7]<<8) + z[8]));

64 
	}
}

69 
	$lsmV¨ötWrôe32
(*
z
, 
y
){

70 
z
[0] = ()(
y
>>24);

71 
z
[1] = ()(
y
>>16);

72 
z
[2] = ()(
y
>>8);

73 
z
[3] = ()(
y
);

74 
	}
}

81 
	$lsmSqlôe4PutV¨öt64
(*
z
, 
u64
 
x
){

82 
w
, 
y
;

83 if–
x
<=240 ){

84 
z
[0] = ()
x
;

87 if–
x
<=2287 ){

88 
y
 = ()(
x
 - 240);

89 
z
[0] = ()(
y
/256 + 241);

90 
z
[1] = ()(
y
%256);

93 if–
x
<=67823 ){

94 
y
 = ()(
x
 - 2288);

95 
z
[0] = 249;

96 
z
[1] = ()(
y
/256);

97 
z
[2] = ()(
y
%256);

100 
y
 = ()
x
;

101 
w
 = ()(
x
>>32);

102 if–
w
==0 ){

103 if–
y
<=16777215 ){

104 
z
[0] = 250;

105 
z
[1] = ()(
y
>>16);

106 
z
[2] = ()(
y
>>8);

107 
z
[3] = ()(
y
);

110 
z
[0] = 251;

111 
	`lsmV¨ötWrôe32
(
z
+1, 
y
);

114 if–
w
<=255 ){

115 
z
[0] = 252;

116 
z
[1] = ()
w
;

117 
	`lsmV¨ötWrôe32
(
z
+2, 
y
);

120 if–
w
<=32767 ){

121 
z
[0] = 253;

122 
z
[1] = ()(
w
>>8);

123 
z
[2] = ()
w
;

124 
	`lsmV¨ötWrôe32
(
z
+3, 
y
);

127 if–
w
<=16777215 ){

128 
z
[0] = 254;

129 
z
[1] = ()(
w
>>16);

130 
z
[2] = ()(
w
>>8);

131 
z
[3] = ()
w
;

132 
	`lsmV¨ötWrôe32
(
z
+4, 
y
);

135 
z
[0] = 255;

136 
	`lsmV¨ötWrôe32
(
z
+1, 
w
);

137 
	`lsmV¨ötWrôe32
(
z
+5, 
y
);

139 
	}
}

145 
	$lsmV¨ötPut64
(
u8
 *
aD©a
, 
i64
 
iVÆ
){

146  
	`lsmSqlôe4PutV¨öt64
(
aD©a
, (
u64
)
iVÆ
);

147 
	}
}

149 
	$lsmV¨ötGë64
(c⁄° 
u8
 *
aD©a
, 
i64
 *
piVÆ
){

150  
	`lsmSqlôe4GëV¨öt64
(
aD©a
, (
u64
 *)
piVÆ
);

151 
	}
}

153 
	$lsmV¨ötPut32
(
u8
 *
aD©a
, 
iVÆ
){

154  
	`lsmSqlôe4PutV¨öt64
(
aD©a
, (
u64
)
iVÆ
);

155 
	}
}

157 
	$lsmV¨ötGë32
(
u8
 *
z
, *
piVÆ
){

158 
u64
 
i
;

159 
ªt
;

161 if–
z
[0]<=240 ){

162 *
piVÆ
 = 
z
[0];

165 if–
z
[0]<=248 ){

166 *
piVÆ
 = (
z
[0]-241)*256 + z[1] + 240;

169 if–
z
[0]==249 ){

170 *
piVÆ
 = 2288 + 256*
z
[1] + z[2];

173 if–
z
[0]==250 ){

174 *
piVÆ
 = (
z
[1]<<16) + (z[2]<<8) + z[3];

178 
ªt
 = 
	`lsmSqlôe4GëV¨öt64
(
z
, &
i
);

179 *
piVÆ
 = 
i
;

180  
ªt
;

181 
	}
}

183 
	$lsmV¨ötLí32
(
n
){

184 
u8
 
aD©a
[9];

185  
	`lsmV¨ötPut32
(
aD©a
, 
n
);

186 
	}
}

192 
	$lsmV¨ötSize
(
u8
 
c
){

193 if–
c
<241 )  1;

194 if–
c
<249 )  2;

195  ()(
c
 - 246);

196 
	}
}

	@src/main.c

17 
	~"sqlôeI¡.h
"

19 #ifde‡
SQLITE4_ENABLE_FTS3


20 
	~"·s3.h
"

22 #ifde‡
SQLITE4_ENABLE_RTREE


23 
	~"πªe.h
"

25 #ifde‡
SQLITE4_ENABLE_ICU


26 
	~"sqlôeicu.h
"

32 
	$sqlôe4_dy«mic
(*
pArg
,*
p
){ (ÌArg; (Ì; 
	}
}

37 c⁄° *
	$sqlôe4_libvîsi⁄
(){  
SQLITE4_VERSION
; 
	}
}

43 c⁄° *
	$sqlôe4_sour˚id
(){  
SQLITE4_SOURCE_ID
; 
	}
}

48 
	$sqlôe4_libvîsi⁄_numbî
(){  
SQLITE4_VERSION_NUMBER
; 
	}
}

52 
	$sqlôe4_thªadß„
(
sqlôe4_ív
 *
pEnv
){

53 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

54  
pEnv
->
bC‹eMuãx
 +ÖEnv->
bFuŒMuãx
;

55 
	}
}

57 #i‡!
deföed
(
SQLITE4_OMIT_TRACE
Ë&& deföed(
SQLITE4_ENABLE_IOTRACE
)

64 (*
sqlôe4IoTø˚
)(const *, ...) = 0;

78 
	$£tupLookaside
(
sqlôe4
 *
db
, *
pBuf
, 
sz
, 
˙t
){

79 *
pSèπ
;

80 if–
db
->
lookaside
.
nOut
 ){

81  
SQLITE4_BUSY
;

87 if–
db
->
lookaside
.
bMÆlo˚d
 ){

88 
	`sqlôe4_‰ì
(
db
->
pEnv
, db->
lookaside
.
pSèπ
);

93 
sz
 = 
	`ROUNDDOWN8
(sz);

94 if–
sz
<=()(
LookasideSlŸ
*) ) sz = 0;

95 if–
˙t
<0 ) cnt = 0;

96 if–
sz
==0 || 
˙t
==0 ){

97 
sz
 = 0;

98 
pSèπ
 = 0;

99 }if–
pBuf
==0 ){

100 
	`sqlôe4BegöBíignMÆloc
(
db
->
pEnv
);

101 
pSèπ
 = 
	`sqlôe4MÆloc
(
db
->
pEnv
, 
sz
*
˙t
 );

102 
	`sqlôe4EndBíignMÆloc
(
db
->
pEnv
);

103 if–
pSèπ
 ) 
˙t
 = 
	`sqlôe4MÆlocSize
(
db
->
pEnv
,ÖSèπ)/
sz
;

105 
pSèπ
 = 
pBuf
;

107 
db
->
lookaside
.
pSèπ
 =ÖStart;

108 
db
->
lookaside
.
pFªe
 = 0;

109 
db
->
lookaside
.
sz
 = (
u16
)sz;

110 if–
pSèπ
 ){

111 
i
;

112 
LookasideSlŸ
 *
p
;

113 
	`as£π
–
sz
 > ()(
LookasideSlŸ
*) );

114 
p
 = (
LookasideSlŸ
*)
pSèπ
;

115 
i
=
˙t
-1; i>=0; i--){

116 
p
->
pNext
 = 
db
->
lookaside
.
pFªe
;

117 
db
->
lookaside
.
pFªe
 = 
p
;

118 
p
 = (
LookasideSlŸ
*)&((
u8
*Ì)[
sz
];

120 
db
->
lookaside
.
pEnd
 = 
p
;

121 
db
->
lookaside
.
bE«bÀd
 = 1;

122 
db
->
lookaside
.
bMÆlo˚d
 = 
pBuf
==0 ?1:0;

124 
db
->
lookaside
.
pEnd
 = 0;

125 
db
->
lookaside
.
bE«bÀd
 = 0;

126 
db
->
lookaside
.
bMÆlo˚d
 = 0;

128  
SQLITE4_OK
;

129 
	}
}

134 
sqlôe4_muãx
 *
	$sqlôe4_db_muãx
(
sqlôe4
 *
db
){

135  
db
->
muãx
;

136 
	}
}

142 
	$sqlôe4_db_ªÀa£_mem‹y
(
sqlôe4
 *
db
){

143 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

144 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

145  
SQLITE4_OK
;

146 
	}
}

151 
	$sqlôe4_db_c⁄fig
(
sqlôe4
 *
db
, 
›
, ...){

152 
va_li°
 
≠
;

153 
rc
;

154 
	`va_°¨t
(
≠
, 
›
);

155  
›
 ){

156 
SQLITE4_DBCONFIG_LOOKASIDE
: {

157 *
pBuf
 = 
	`va_¨g
(
≠
, *);

158 
sz
 = 
	`va_¨g
(
≠
, );

159 
˙t
 = 
	`va_¨g
(
≠
, );

160 
rc
 = 
	`£tupLookaside
(
db
, 
pBuf
, 
sz
, 
˙t
);

165 
›
;

166 
u32
 
mask
;

167 } 
aFœgOp
[] = {

168 { 
SQLITE4_DBCONFIG_ENABLE_FKEY
, 
SQLITE4_F‹eignKeys
 },

169 { 
SQLITE4_DBCONFIG_ENABLE_TRIGGER
, 
SQLITE4_E«bÀTriggî
 },

171 
i
;

172 
rc
 = 
SQLITE4_ERROR
;

173 
i
=0; i<
	`AºaySize
(
aFœgOp
); i++){

174 if–
aFœgOp
[
i
].
›
==op ){

175 
⁄off
 = 
	`va_¨g
(
≠
, );

176 *
pRes
 = 
	`va_¨g
(
≠
, *);

177 
ﬁdFœgs
 = 
db
->
Êags
;

178 if–
⁄off
>0 ){

179 
db
->
Êags
 |
aFœgOp
[
i
].
mask
;

180 }if–
⁄off
==0 ){

181 
db
->
Êags
 &~
aFœgOp
[
i
].
mask
;

183 if–
ﬁdFœgs
!=
db
->
Êags
 ){

184 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

186 if–
pRes
 ){

187 *
pRes
 = (
db
->
Êags
 & 
aFœgOp
[
i
].
mask
)!=0;

189 
rc
 = 
SQLITE4_OK
;

196 
	`va_íd
(
≠
);

197  
rc
;

198 
	}
}

204 
	$ÆlS∑˚s
(c⁄° *
z
, 
n
){

205  
n
>0 && 
z
[n-1]==' ' ){Ç--; }

206  
n
==0;

207 
	}
}

216 
	$böCﬁlFunc
(

217 *
∑dFœg
,

218 
sqlôe4_vÆue
 *
p1
,

219 
sqlôe4_vÆue
 *
p2
,

220 *
pRes


222 
n
;

223 
n1
;

224 
n2
;

225 
ªs
;

226 c⁄° *
z1
 = 
	`sqlôe4_vÆue_ãxt
(
p1
, &
n1
);

227 c⁄° *
z2
 = 
	`sqlôe4_vÆue_ãxt
(
p2
, &
n2
);

229 
n
 = (
n1
<
n2
 ?Ç1 :Ç2);

230 
ªs
 = 
	`memcmp
(
z1
, 
z2
, 
n
);

231 if–
ªs
==0 ){

232 if–
∑dFœg
 && 
	`ÆlS∑˚s
(
z1
+
n
, 
n1
-nË&&áŒS∑˚s(
z2
+n, 
n2
-n) ){

235 
ªs
 = 
n1
 - 
n2
;

238 *
pRes
 = 
ªs
;

239  
SQLITE4_OK
;

240 
	}
}

247 
	$cﬁlRåimMkKey
(

248 *
NŸU£d
,

249 
sqlôe4_vÆue
 *
pVÆ
,

250 
nOut
, *
pOut
,

251 *
≤Out


253 
nIn
;

254 c⁄° *
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
pVÆ
, &
nIn
);

256 
nC›y
 = 
nIn
;

257  
nC›y
>0 && 
zIn
[nCopy-1]==' ' )ÇCopy--;

258 if–
nC›y
<=
nOut
 ){

259 
	`mem˝y
(
pOut
, 
zIn
, 
nC›y
);

261 *
≤Out
 = 
nC›y
;

262  
SQLITE4_OK
;

263 
	}
}

274 
	$cﬁlNoˇ£Cmp
(

275 *
NŸU£d
,

276 
sqlôe4_vÆue
 *
p1
,

277 
sqlôe4_vÆue
 *
p2
,

278 *
pRes


280 
n1
;

281 
n2
;

282 
ªs
;

283 c⁄° *
z1
 = 
	`sqlôe4_vÆue_ãxt
(
p1
, &
n1
);

284 c⁄° *
z2
 = 
	`sqlôe4_vÆue_ãxt
(
p2
, &
n2
);

286 
	`UNUSED_PARAMETER
(
NŸU£d
);

288 
ªs
 = 
	`sqlôe4_°∫icmp
(
z1
, 
z2
, (
n1
 < 
n2
 ?Ç1 :Ç2));

289 if–
ªs
==0 )Ñe†
n1
 - 
n2
;

290 *
pRes
 = 
ªs
;

291  
SQLITE4_OK
;

292 
	}
}

294 
	$cﬁlNoˇ£MkKey
(

295 *
NŸU£d
,

296 
sqlôe4_vÆue
 *
pVÆ
,

297 
nOut
, *
pOut
,

298 *
≤Out


300 
nIn
;

301 c⁄° *
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
pVÆ
, &
nIn
);

302 if–
nOut
>=
nIn
 ){

303 
i
;

304 
u8
 *
aIn
 = (u8 *)
zIn
;

305 
u8
 *
aOut
 = (u8 *)
pOut
;

306 
i
=0; i<
nIn
; i++){

307 
aOut
[
i
] = 
	`sqlôe4_tﬁowî
(
aIn
[i]);

311 *
≤Out
 = 
nIn
;

312  
SQLITE4_OK
;

313 
	}
}

318 
	$sqlôe4_ch™ges
(
sqlôe4
 *
db
){

319  
db
->
nCh™ge
;

320 
	}
}

325 
	$sqlôe4_tŸÆ_ch™ges
(
sqlôe4
 *
db
){

326  
db
->
nTŸÆCh™ge
;

327 
	}
}

334 
	$sqlôe4Clo£Savïoöts
(
sqlôe4
 *
db
){

335  
db
->
pSavïoöt
 ){

336 
Savïoöt
 *
pTmp
 = 
db
->
pSavïoöt
;

337 
db
->
pSavïoöt
 = 
pTmp
->
pNext
;

338 
	`sqlôe4DbFªe
(
db
, 
pTmp
);

340 
db
->
nSavïoöt
 = 0;

341 
db
->
nSèãmít
 = 0;

342 
	}
}

348 
	$fun˘i⁄De°roy
(
sqlôe4
 *
db
, 
FuncDef
 *
p
){

349 if–
p
->
xDe°roy
 ){

350 
p
->
	`xDe°roy
’->
pU£rD©a
);

352 
	}
}

357 
	$sqlôe4_˛o£
(
sqlôe4
 *
db
, 
Êags
){

358 
HashEÀm
 *
i
;

359 
j
;

361 
	`UNUSED_PARAMETER
(
Êags
);

362 if–!
db
 ){

363  
SQLITE4_OK
;

365 if–!
	`sqlôe4Sa„tyCheckSickOrOk
(
db
) ){

366  
SQLITE4_MISUSE_BKPT
;

368 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

371 
	`sqlôe4Re£tI¡î«lSchema
(
db
, -1);

380 
	`sqlôe4VèbRﬁlback
(
db
);

383 if–
db
->
pVdbe
 ){

384 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_BUSY
,

386 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

387  
SQLITE4_BUSY
;

389 
	`as£π
–
	`sqlôe4Sa„tyCheckSickOrOk
(
db
) );

392 
	`sqlôe4Clo£Savïoöts
(
db
);

394 
j
=0; j<
db
->
nDb
; j++){

395 
Db
 *
pDb
 = &
db
->
aDb
[
j
];

396 if–
pDb
->
pKV
 ){

397 
	`sqlôe4KVSt‹eClo£
(
pDb
->
pKV
);

398 
pDb
->
pKV
 = 0;

400 
	`sqlôe4DbFªe
(
db
, 
pDb
->
pSchema
);

401 
pDb
->
pSchema
 = 0;

403 
	`sqlôe4Re£tI¡î«lSchema
(
db
, -1);

406 
	`sqlôe4AuthFªeAŒ
(
db
);

411 
	`sqlôe4C⁄√˘i⁄Clo£d
(
db
);

414 
	`sqlôe4_cﬁœti⁄_√eded
(
db
, 0, 0, 0);

415 
	`sqlôe4_¥ofûe
(
db
, 0, 0, 0);

416 
	`sqlôe4_åa˚
(
db
, 0, 0, 0);

419 
	`sqlôe4ShutdownFts5
(
db
);

421 
	`as£π
–
db
->
nDb
<=2 );

422 
	`as£π
–
db
->
aDb
==db->
aDbSètic
 );

424 
FuncDef
 *
pNext
, *
pSame
, *
p
;

425 
p
=
db
->
aFunc
.
pFú°
;Ö;Ö=
pNext
){

426 
pNext
 = 
p
->
pNextName
;

427  
p
 ){

428 
	`fun˘i⁄De°roy
(
db
, 
p
);

429 
pSame
 = 
p
->
pSameName
;

430 
	`sqlôe4DbFªe
(
db
, 
p
);

431 
p
 = 
pSame
;

435 
i
=
	`sqlôeHashFú°
(&
db
->
aCﬁlSeq
); i; i=
	`sqlôeHashNext
(i)){

436 
CﬁlSeq
 *
pCﬁl
 = (CﬁlSeq *)
	`sqlôeHashD©a
(
i
);

437 if–
pCﬁl
->
xDñ
 )ÖCﬁl->
	`xDñ
’Cﬁl->
pU£r
);

438 
	`sqlôe4DbFªe
(
db
, 
pCﬁl
);

440 
	`sqlôe4HashCÀ¨
(&
db
->
aCﬁlSeq
);

441 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


442 
i
=
	`sqlôeHashFú°
(&
db
->
aModuÀ
); i; i=
	`sqlôeHashNext
(i)){

443 
ModuÀ
 *
pMod
 = (ModuÀ *)
	`sqlôeHashD©a
(
i
);

444 if–
pMod
->
xDe°roy
 ){

445 
pMod
->
	`xDe°roy
’Mod->
pAux
);

447 
	`sqlôe4DbFªe
(
db
, 
pMod
);

449 
	`sqlôe4HashCÀ¨
(&
db
->
aModuÀ
);

452 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_OK
, 0);

453 if–
db
->
pEº
 ){

454 
	`sqlôe4VÆueFªe
(
db
->
pEº
);

457 
db
->
magic
 = 
SQLITE4_MAGIC_ERROR
;

458 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

459 
db
->
magic
 = 
SQLITE4_MAGIC_CLOSED
;

460 
	`sqlôe4_muãx_‰ì
(
db
->
muãx
);

461 
	`as£π
–
db
->
lookaside
.
nOut
==0 );

462 if–
db
->
lookaside
.
bMÆlo˚d
 ){

463 
	`sqlôe4_‰ì
(
db
->
pEnv
, db->
lookaside
.
pSèπ
);

465 
	`sqlôe4_‰ì
(
db
->
pEnv
, db);

466  
SQLITE4_OK
;

467 
	}
}

473 c⁄° *
	$sqlôe4EºSå
(
rc
){

474 c⁄° * c⁄° 
aMsg
[] = {

503 
rc
 &= 0xff;

504 if–
	`ALWAYS
(
rc
>=0Ë&&Ñc<()((
aMsg
)/(aMsg[0])) &&áMsg[rc]!=0 ){

505  
aMsg
[
rc
];

509 
	}
}

514 
	$sqlôe4_öãºu±
(
sqlôe4
 *
db
){

515 
db
->
u1
.
isI¡îru±ed
 = 1;

516 
	}
}

525 
sqlôe4Cª©eFunc
(

526 
sqlôe4
 *
db
,

527 c⁄° *
zFun˘i⁄Name
,

528 
nArg
,

529 *
pU£rD©a
,

530 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **),

531 (*
xSãp
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **),

532 (*
xFöÆ
)(
sqlôe4_c⁄ãxt
*),

533 (*
xDe°roy
)(*)

535 
FuncDef
 *
p
;

536 
nName
;

538 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

539 if–
zFun˘i⁄Name
==0 ||

540 (
xFunc
 && (
xFöÆ
 || 
xSãp
)) ||

541 (!
xFunc
 && (
xFöÆ
 && !
xSãp
)) ||

542 (!
xFunc
 && (!
xFöÆ
 && 
xSãp
)) ||

543 (
nArg
<-1 ||ÇArg>
SQLITE4_MAX_FUNCTION_ARG
) ||

544 (255<(
nName
 = 
	`sqlôe4SåÀn30
–
zFun˘i⁄Name
))) ){

545  
SQLITE4_MISUSE_BKPT
;

553 
p
 = 
	`sqlôe4FödFun˘i⁄
(
db
, 
zFun˘i⁄Name
, 
nName
, 
nArg
, 0);

554 if–
p
 &&Ö->
nArg
==nArg ){

555 if–
db
->
a˘iveVdbeC¡
 ){

556 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_BUSY
,

558 
	`as£π
–!
db
->
mÆlocFaûed
 );

559  
SQLITE4_BUSY
;

561 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

565 
p
 = 
	`sqlôe4FödFun˘i⁄
(
db
, 
zFun˘i⁄Name
, 
nName
, 
nArg
, 1);

566 
	`as£π
(
p
 || 
db
->
mÆlocFaûed
);

567 if–!
p
 ){

568  
SQLITE4_NOMEM
;

573 
	`fun˘i⁄De°roy
(
db
, 
p
);

575 
p
->
xDe°roy
 = xDestroy;

576 
p
->
Êags
 = 0;

577 
p
->
xFunc
 = xFunc;

578 
p
->
xSãp
 = xStep;

579 
p
->
xFöÆize
 = 
xFöÆ
;

580 
p
->
pU£rD©a
 =ÖUserData;

581 
p
->
nArg
 = (
u16
)nArg;

582  
SQLITE4_OK
;

583 
	}
}

588 
sqlôe4_¸óã_fun˘i⁄
(

589 
sqlôe4
 *
db
,

590 c⁄° *
zFunc
,

591 
nArg
,

592 *
p
,

593 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **),

594 (*
xSãp
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **),

595 (*
xFöÆ
)(
sqlôe4_c⁄ãxt
*),

596 (*
xDe°roy
)(*)

598 
rc
;

599 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

600 
rc
 = 
	`sqlôe4Cª©eFunc
(

601 
db
, 
zFunc
, 
nArg
, 
p
, 
xFunc
, 
xSãp
, 
xFöÆ
, 
xDe°roy


603 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

604 if–
rc
!=
SQLITE4_OK
 && 
xDe°roy
 ) 
	`xDe°roy
(
p
);

605 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

606  
rc
;

607 
	}
}

609 
sqlôe4_¸óã_mi_fun˘i⁄
(

610 
sqlôe4
 *
db
,

611 c⁄° *
zFunc
,

612 
nArg
,

613 
íc
,

614 *
p
,

615 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **),

616 (*
xDe°roy
)(*)

618 
rc
;

619 
n
;

621 
n
 = 
nArg
 + (nArg>=0);

622 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

623 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zFunc
, 
n
, 
p
, 
xFunc
, 0, 0, 
xDe°roy
);

624 if–
rc
==
SQLITE4_OK
 ){

625 
FuncDef
 *
p
 = 
	`sqlôe4FödFun˘i⁄
(
db
, 
zFunc
, -1, 
n
, 0);

626 
p
->
bM©chöfo
 = 1;

628 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

629 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

630  
rc
;

631 
	}
}

645 
	$sqlôe4_ovîlﬂd_fun˘i⁄
(

646 
sqlôe4
 *
db
,

647 c⁄° *
zName
,

648 
nArg


650 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

651 
rc
 = 
SQLITE4_OK
;

652 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

653 if–
	`sqlôe4FödFun˘i⁄
(
db
, 
zName
, 
nName
, 
nArg
, 0)==0 ){

654 
rc
 = 
	`sqlôe4Cª©eFunc
(
db
, 
zName
, 
nArg
,

655 0, 
sqlôe4InvÆidFun˘i⁄
, 0, 0, 0);

657 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

658 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

659  
rc
;

660 
	}
}

662 #i‚de‡
SQLITE4_OMIT_TRACE


671 
sqlôe4_åa˚
(

672 
sqlôe4
 *
db
,

673 *
pArg
,

674 (*
xTø˚
)(*,const *),

675 (*
xDe°roy
)(*)

677 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

678 if–
db
->
xTø˚De°roy
 ){

679 
db
->
	`xTø˚De°roy
(db->
pTø˚Arg
);

681 
db
->
xTø˚
 = xTrace;

682 
db
->
xTø˚De°roy
 = 
xDe°roy
;

683 
db
->
pTø˚Arg
 = 
pArg
;

684 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

685 
	}
}

694 
sqlôe4_¥ofûe
(

695 
sqlôe4
 *
db
,

696 *
pArg
,

697 (*
xProfûe
)(*,c⁄° *,
sqlôe4_uöt64
),

698 (*
xDe°roy
)(*)

700 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

701 if–
db
->
xProfûeDe°roy
 ){

702 
db
->
	`xProfûeDe°roy
(db->
pProfûeArg
);

704 
db
->
xProfûe
 = xProfile;

705 
db
->
xProfûeDe°roy
 = 
xDe°roy
;

706 
db
->
pProfûeArg
 = 
pArg
;

707 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

708 
	}
}

715 c⁄° *
	$sqlôe4_îrmsg
(
sqlôe4
 *
db
){

716 c⁄° *
z
;

717 if–!
db
 ){

718  
	`sqlôe4EºSå
(
SQLITE4_NOMEM
);

720 if–!
	`sqlôe4Sa„tyCheckSickOrOk
(
db
) ){

721  
	`sqlôe4EºSå
(
SQLITE4_MISUSE_BKPT
);

723 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

724 if–
db
->
mÆlocFaûed
 ){

725 
z
 = 
	`sqlôe4EºSå
(
SQLITE4_NOMEM
);

727 
z
 = (*)
	`sqlôe4_vÆue_ãxt
(
db
->
pEº
, 0);

728 
	`as£π
–!
db
->
mÆlocFaûed
 );

729 if–
z
==0 ){

730 
z
 = 
	`sqlôe4EºSå
(
db
->
îrCode
);

733 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

734  
z
;

735 
	}
}

741 
	$sqlôe4_îrcode
(
sqlôe4
 *
db
){

742 if–
db
 && !
	`sqlôe4Sa„tyCheckSickOrOk
(db) ){

743  
SQLITE4_MISUSE_BKPT
;

745 if–!
db
 || db->
mÆlocFaûed
 ){

746  
SQLITE4_NOMEM
;

748  
db
->
îrCode
;

749 
	}
}

754 
¸óãCﬁœti⁄
(

755 
sqlôe4
* 
db
,

756 c⁄° *
zName
,

757 *
pCtx
,

758 (*
xCom∑ª
)(*, 
sqlôe4_vÆue
*, sqlite4_value*, *),

759 (*
xMakeKey
)(*, 
sqlôe4_vÆue
*, , *, *),

760 (*
xDñ
)(*)

762 
CﬁlSeq
 *
pCﬁl
;

764 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

770 
pCﬁl
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zName
, 0);

771 if–
pCﬁl
 &&ÖCﬁl->
xCmp
 ){

772 if–
db
->
a˘iveVdbeC¡
 ){

773 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_BUSY
,

775  
SQLITE4_BUSY
;

777 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

779 if–
pCﬁl
->
xDñ
 ){

780 
pCﬁl
->
	`xDñ
’Cﬁl->
pU£r
);

782 
pCﬁl
->
xDñ
 = 0;

783 
pCﬁl
->
xCmp
 = 0;

784 
pCﬁl
->
xMkKey
 = 0;

785 
pCﬁl
->
pU£r
 = 0;

788 
pCﬁl
 = 
	`sqlôe4FödCﬁlSeq
(
db
, 
zName
, 1);

789 if–
pCﬁl
==0 )  
SQLITE4_NOMEM
;

790 
pCﬁl
->
xCmp
 = 
xCom∑ª
;

791 
pCﬁl
->
xMkKey
 = 
xMakeKey
;

792 
pCﬁl
->
pU£r
 = 
pCtx
;

793 
pCﬁl
->
xDñ
 = xDel;

794  
SQLITE4_OK
;

795 
	}
}

803 c⁄° 
	gaH¨dLimô
[] = {

804 
SQLITE4_MAX_LENGTH
,

805 
SQLITE4_MAX_SQL_LENGTH
,

806 
SQLITE4_MAX_COLUMN
,

807 
SQLITE4_MAX_EXPR_DEPTH
,

808 
SQLITE4_MAX_COMPOUND_SELECT
,

809 
SQLITE4_MAX_VDBE_OP
,

810 
SQLITE4_MAX_FUNCTION_ARG
,

811 
SQLITE4_MAX_ATTACHED
,

812 
SQLITE4_MAX_LIKE_PATTERN_LENGTH
,

813 
SQLITE4_MAX_VARIABLE_NUMBER
,

814 
SQLITE4_MAX_TRIGGER_DEPTH
,

820 #i‡
SQLITE4_MAX_LENGTH
<100

821 #îr‹ 
SQLITE4_MAX_LENGTH
 
mu°
 
be
 
©
 
Àa°
 100

823 #i‡
SQLITE4_MAX_SQL_LENGTH
<100

824 #îr‹ 
SQLITE4_MAX_SQL_LENGTH
 
mu°
 
be
 
©
 
Àa°
 100

826 #i‡
SQLITE4_MAX_SQL_LENGTH
>
SQLITE4_MAX_LENGTH


827 #îr‹ 
SQLITE4_MAX_SQL_LENGTH
 
mu°
 
nŸ
 
be
 
gª©î
 
th™
 
SQLITE4_MAX_LENGTH


829 #i‡
SQLITE4_MAX_COMPOUND_SELECT
<2

830 #îr‹ 
SQLITE4_MAX_COMPOUND_SELECT
 
mu°
 
be
 
©
 
Àa°
 2

832 #i‡
SQLITE4_MAX_VDBE_OP
<40

833 #îr‹ 
SQLITE4_MAX_VDBE_OP
 
mu°
 
be
 
©
 
Àa°
 40

835 #i‡
SQLITE4_MAX_FUNCTION_ARG
<0 || SQLITE4_MAX_FUNCTION_ARG>1000

836 #îr‹ 
SQLITE4_MAX_FUNCTION_ARG
 
mu°
 
be
 
bëwìn
 0 
™d
 1000

838 #i‡
SQLITE4_MAX_ATTACHED
<0 || SQLITE4_MAX_ATTACHED>62

839 #îr‹ 
SQLITE4_MAX_ATTACHED
 
mu°
 
be
 
bëwìn
 0 
™d
 62

841 #i‡
SQLITE4_MAX_LIKE_PATTERN_LENGTH
<1

842 #îr‹ 
SQLITE4_MAX_LIKE_PATTERN_LENGTH
 
mu°
 
be
 
©
 
Àa°
 1

844 #i‡
SQLITE4_MAX_COLUMN
>32767

845 #îr‹ 
SQLITE4_MAX_COLUMN
 
mu°
 
nŸ
 
ex˚ed
 32767

847 #i‡
SQLITE4_MAX_TRIGGER_DEPTH
<1

848 #îr‹ 
SQLITE4_MAX_TRIGGER_DEPTH
 
mu°
 
be
 
©
 
Àa°
 1

862 
	$sqlôe4_limô
(
sqlôe4
 *
db
, 
limôId
, 
√wLimô
){

863 
ﬁdLimô
;

871 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_LENGTH
]==
SQLITE4_MAX_LENGTH
 );

872 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_SQL_LENGTH
]==
SQLITE4_MAX_SQL_LENGTH
 );

873 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_COLUMN
]==
SQLITE4_MAX_COLUMN
 );

874 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_EXPR_DEPTH
]==
SQLITE4_MAX_EXPR_DEPTH
 );

875 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_COMPOUND_SELECT
]==
SQLITE4_MAX_COMPOUND_SELECT
);

876 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_VDBE_OP
]==
SQLITE4_MAX_VDBE_OP
 );

877 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_FUNCTION_ARG
]==
SQLITE4_MAX_FUNCTION_ARG
 );

878 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_ATTACHED
]==
SQLITE4_MAX_ATTACHED
 );

879 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_LIKE_PATTERN_LENGTH
]==

880 
SQLITE4_MAX_LIKE_PATTERN_LENGTH
 );

881 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_VARIABLE_NUMBER
]==
SQLITE4_MAX_VARIABLE_NUMBER
);

882 
	`as£π
–
aH¨dLimô
[
SQLITE4_LIMIT_TRIGGER_DEPTH
]==
SQLITE4_MAX_TRIGGER_DEPTH
 );

883 
	`as£π
–
SQLITE4_LIMIT_TRIGGER_DEPTH
==(
SQLITE4_N_LIMIT
-1) );

886 if–
limôId
<0 ||ÜimôId>=
SQLITE4_N_LIMIT
 ){

889 
ﬁdLimô
 = 
db
->
aLimô
[
limôId
];

890 if–
√wLimô
>=0 ){

891 if–
√wLimô
>
aH¨dLimô
[
limôId
] ){

892 
√wLimô
 = 
aH¨dLimô
[
limôId
];

894 
db
->
aLimô
[
limôId
] = 
√wLimô
;

896  
ﬁdLimô
;

897 
	}
}

923 
	$sqlôe4P¨£Uri
(

924 
sqlôe4_ív
 *
pEnv
,

925 c⁄° *
zUri
,

926 *
pFœgs
,

927 **
pzFûe
,

928 **
pzEºMsg


930 
rc
 = 
SQLITE4_OK
;

931 
Êags
 = *
pFœgs
;

932 *
zFûe
;

933 
c
;

934 
nUri
 = 
	`sqlôe4SåÀn30
(
zUri
);

936 
	`as£π
–*
pzEºMsg
==0 );

938 if–
nUri
>=5 && 
	`memcmp
(
zUri
, "file:", 5)==0 ){

939 *
zO±
;

940 
eSèã
;

941 
iIn
;

942 
iOut
 = 0;

943 
nByã
 = 
nUri
+2;

945 
iIn
=0; iIn<
nUri
; iIn++Ë
nByã
 +(
zUri
[iIn]=='&');

946 
zFûe
 = 
	`sqlôe4_mÆloc
(
pEnv
, 
nByã
);

947 if–!
zFûe
 )  
SQLITE4_NOMEM
;

950 if–
zUri
[5]=='/' && zUri[6]=='/' ){

951 
iIn
 = 7;

952  
zUri
[
iIn
] && zUri[iIn]!='/' ) iIn++;

954 if–
iIn
!=7 && (iIn!=16 || 
	`memcmp
("loˇlho°", &
zUri
[7], 9)) ){

955 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
pEnv
,"invalid uriáuthority: %.*s",

956 
iIn
-7, &
zUri
[7]);

957 
rc
 = 
SQLITE4_ERROR
;

958 
∑r£_uri_out
;

961 
iIn
 = 5;

974 
eSèã
 = 0;

975  (
c
 = 
zUri
[
iIn
])!=0 && c!='#' ){

976 
iIn
++;

977 if–
c
=='%'

978 && 
	`sqlôe4Isxdigô
(
zUri
[
iIn
])

979 && 
	`sqlôe4Isxdigô
(
zUri
[
iIn
+1])

981 
o˘ë
 = (
	`sqlôe4HexToI¡
(
zUri
[
iIn
++]) << 4);

982 
o˘ë
 +
	`sqlôe4HexToI¡
(
zUri
[
iIn
++]);

984 
	`as£π
–
o˘ë
>=0 && octet<256 );

985 if–
o˘ë
==0 ){

990  (
c
 = 
zUri
[
iIn
])!=0 && c!='#'

991 && (
eSèã
!=0 || 
c
!='?')

992 && (
eSèã
!=1 || (
c
!='=' && c!='&'))

993 && (
eSèã
!=2 || 
c
!='&')

995 
iIn
++;

999 
c
 = 
o˘ë
;

1000 }if–
eSèã
==1 && (
c
=='&' || c=='=') ){

1001 if–
zFûe
[
iOut
-1]==0 ){

1003  
zUri
[
iIn
] && zUri[iIn]!='#' && zUri[iIn-1]!='&' ) iIn++;

1006 if–
c
=='&' ){

1007 
zFûe
[
iOut
++] = '\0';

1009 
eSèã
 = 2;

1011 
c
 = 0;

1012 }if–(
eSèã
==0 && 
c
=='?') || (eState==2 && c=='&') ){

1013 
c
 = 0;

1014 
eSèã
 = 1;

1016 
zFûe
[
iOut
++] = 
c
;

1018 if–
eSèã
==1 ) 
zFûe
[
iOut
++] = '\0';

1019 
zFûe
[
iOut
++] = '\0';

1020 
zFûe
[
iOut
++] = '\0';

1026 
zO±
 = &
zFûe
[
	`sqlôe4SåÀn30
(zFile)+1];

1027  
zO±
[0] ){

1028 
nO±
 = 
	`sqlôe4SåÀn30
(
zO±
);

1029 *
zVÆ
 = &
zO±
[
nO±
+1];

1030 
nVÆ
 = 
	`sqlôe4SåÀn30
(
zVÆ
);

1031 
	sO≥nMode
 {

1032 c⁄° *
z
;

1033 
mode
;

1034 } *
aMode
 = 0;

1035 *
zModeTy≥
 = 0;

1036 
mask
 = 0;

1037 
limô
 = 0;

1039 if–
nO±
==4 && 
	`memcmp
("mode", 
zO±
, 4)==0 ){

1040 
O≥nMode
 
aO≥nMode
[] = {

1041 { "ro", 
SQLITE4_OPEN_READONLY
 },

1042 { "rw", 
SQLITE4_OPEN_READWRITE
 },

1043 { "rwc", 
SQLITE4_OPEN_READWRITE
 | 
SQLITE4_OPEN_CREATE
 },

1047 
mask
 = 
SQLITE4_OPEN_READONLY
|
SQLITE4_OPEN_READWRITE
|
SQLITE4_OPEN_CREATE
;

1048 
aMode
 = 
aO≥nMode
;

1049 
limô
 = 
mask
 & 
Êags
;

1050 
zModeTy≥
 = "access";

1053 if–
aMode
 ){

1054 
i
;

1055 
mode
 = 0;

1056 
i
=0; 
aMode
[i].
z
; i++){

1057 c⁄° *
z
 = 
aMode
[
i
].z;

1058 if–
nVÆ
==
	`sqlôe4SåÀn30
(
z
Ë&& 0==
	`memcmp
(
zVÆ
, z,ÇVal) ){

1059 
mode
 = 
aMode
[
i
].mode;

1063 if–
mode
==0 ){

1064 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "no such %s mode: %s",

1065 
zModeTy≥
, 
zVÆ
);

1066 
rc
 = 
SQLITE4_ERROR
;

1067 
∑r£_uri_out
;

1069 if–
mode
>
limô
 ){

1070 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "%s modeÇotállowed: %s",

1071 
zModeTy≥
, 
zVÆ
);

1072 
rc
 = 
SQLITE4_PERM
;

1073 
∑r£_uri_out
;

1075 
Êags
 = (Êag†& ~
mask
Ë| 
mode
;

1078 
zO±
 = &
zVÆ
[
nVÆ
+1];

1082 
zFûe
 = 
	`sqlôe4_mÆloc
(
pEnv
, 
nUri
+2);

1083 if–!
zFûe
 )  
SQLITE4_NOMEM
;

1084 
	`mem˝y
(
zFûe
, 
zUri
, 
nUri
);

1085 
zFûe
[
nUri
] = '\0';

1086 
zFûe
[
nUri
+1] = '\0';

1089 
∑r£_uri_out
:

1090 if–
rc
!=
SQLITE4_OK
 ){

1091 
	`sqlôe4_‰ì
(
pEnv
, 
zFûe
);

1092 
zFûe
 = 0;

1094 *
pFœgs
 = 
Êags
;

1095 *
pzFûe
 = 
zFûe
;

1096  
rc
;

1097 
	}
}

1104 
	$›íD©aba£
(

1105 
sqlôe4_ív
 *
pEnv
,

1106 c⁄° *
zFûíame
,

1107 
Êags
,

1108 
sqlôe4
 **
µDb
,

1109 
va_li°
 
≠


1111 
sqlôe4
 *
db
;

1112 
rc
;

1113 
isThªadß„
;

1114 *
zO≥n
 = 0;

1115 *
zEºMsg
 = 0;

1117 *
µDb
 = 0;

1118 #i‚de‡
SQLITE4_OMIT_AUTOINIT


1119 
rc
 = 
	`sqlôe4_öôülize
(
pEnv
);

1120 if–
rc
 ) Ñc;

1123 if–
pEnv
->
bC‹eMuãx
==0 ){

1124 
isThªadß„
 = 0;

1126 
isThªadß„
 = 
pEnv
->
bFuŒMuãx
;

1130 
db
 = 
	`sqlôe4MÆlocZîo
(
pEnv
, (
sqlôe4
) );

1131 if–
db
==0 ) 
›ídb_out
;

1132 
db
->
pEnv
 =ÖEnv;

1133 if–
isThªadß„
 ){

1134 
db
->
muãx
 = 
	`sqlôe4MuãxAŒoc
(
pEnv
, 
SQLITE4_MUTEX_RECURSIVE
);

1135 if–
db
->
muãx
==0 ){

1136 
	`sqlôe4_‰ì
(
pEnv
, 
db
);

1137 
db
 = 0;

1138 
›ídb_out
;

1141 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

1142 
db
->
nDb
 = 2;

1143 
db
->
magic
 = 
SQLITE4_MAGIC_BUSY
;

1144 
db
->
aDb
 = db->
aDbSètic
;

1146 
	`as£π
–(
db
->
aLimô
)==(
aH¨dLimô
) );

1147 
	`mem˝y
(
db
->
aLimô
, 
aH¨dLimô
, (db->aLimit));

1148 
db
->
√xtAutovac
 = -1;

1149 
db
->
√xtPagesize
 = 0;

1150 
db
->
Êags
 |
SQLITE4_AutoIndex


1151 | 
SQLITE4_E«bÀTriggî


1152 | 
SQLITE4_F‹eignKeys


1155 
	`sqlôe4HashInô
(
pEnv
, &
db
->
aCﬁlSeq
, 0);

1156 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1157 
	`sqlôe4HashInô
(
pEnv
, &
db
->
aModuÀ
, 0);

1161 
	`¸óãCﬁœti⁄
(
db
, "BINARY", 0, 
böCﬁlFunc
, 0, 0);

1162 
	`¸óãCﬁœti⁄
(
db
, "RTRIM", (*)1, 
böCﬁlFunc
, 
cﬁlRåimMkKey
, 0);

1163 
	`¸óãCﬁœti⁄
(
db
, "NOCASE", 0, 
cﬁlNoˇ£Cmp
, 
cﬁlNoˇ£MkKey
, 0);

1164 if–
db
->
mÆlocFaûed
 ){

1165 
›ídb_out
;

1167 
db
->
pDÊtCﬁl
 = 
	`sqlôe4FödCﬁlSeq
(db, "BINARY", 0);

1168 
	`as£π
–
db
->
pDÊtCﬁl
!=0 );

1171 
rc
 = 
	`sqlôe4P¨£Uri
(
pEnv
, 
zFûíame
, &
Êags
, &
zO≥n
, &
zEºMsg
);

1172 if–
rc
!=
SQLITE4_OK
 ){

1173 if–
rc
==
SQLITE4_NOMEM
 ) 
db
->
mÆlocFaûed
 = 1;

1174 
	`sqlôe4Eº‹
(
db
, 
rc
, 
zEºMsg
 ? "%s" : 0, zErrMsg);

1175 
	`sqlôe4_‰ì
(
pEnv
, 
zEºMsg
);

1176 
›ídb_out
;

1178 
db
->
›íFœgs
 = 
Êags
;

1181 
rc
 = 
	`sqlôe4KVSt‹eO≥n
(
db
, "maö", 
zO≥n
, &db->
aDb
[0].
pKV
, 
Êags
);

1182 if–
rc
!=
SQLITE4_OK
 ){

1183 if–
rc
==
SQLITE4_IOERR_NOMEM
 ){

1184 
rc
 = 
SQLITE4_NOMEM
;

1186 
	`sqlôe4Eº‹
(
db
, 
rc
, 0);

1187 
›ídb_out
;

1189 
db
->
aDb
[0].
pSchema
 = 
	`sqlôe4SchemaGë
(db);

1190 
db
->
aDb
[1].
pSchema
 = 
	`sqlôe4SchemaGë
(db);

1195 
db
->
aDb
[0].
zName
 = "main";

1196 
db
->
aDb
[1].
zName
 = "temp";

1198 
db
->
magic
 = 
SQLITE4_MAGIC_OPEN
;

1199 if–
db
->
mÆlocFaûed
 ){

1200 
›ídb_out
;

1207 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_OK
, 0);

1208 
	`sqlôe4Regi°îBuûtöFun˘i⁄s
(
db
);

1213 
rc
 = 
	`sqlôe4_îrcode
(
db
);

1214 if–
rc
==
SQLITE4_OK
 ){

1216 
rc
 = 
	`sqlôe4_îrcode
(
db
);

1217 if–
rc
!=
SQLITE4_OK
 ){

1218 
›ídb_out
;

1222 if–!
db
->
mÆlocFaûed
 && 
rc
==
SQLITE4_OK
 ){

1223 
rc
 = 
	`sqlôe4InôFts5
(
db
);

1226 #ifde‡
SQLITE4_ENABLE_ICU


1227 if–!
db
->
mÆlocFaûed
 && 
rc
==
SQLITE4_OK
 ){

1228 
rc
 = 
	`sqlôe4IcuInô
(
db
);

1232 #ifde‡
SQLITE4_ENABLE_RTREE


1233 if–!
db
->
mÆlocFaûed
 && 
rc
==
SQLITE4_OK
){

1234 
rc
 = 
	`sqlôe4RåìInô
(
db
);

1238 
	`sqlôe4Eº‹
(
db
, 
rc
, 0);

1241 
	`£tupLookaside
(
db
, 0, 
pEnv
->
szLookaside
,

1242 
pEnv
->
nLookaside
);

1244 
›ídb_out
:

1245 
	`sqlôe4_‰ì
(
pEnv
, 
zO≥n
);

1246 if–
db
 ){

1247 
	`as£π
–
db
->
muãx
!=0 || 
isThªadß„
==0 || 
pEnv
->
bFuŒMuãx
==0 );

1248 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

1250 
rc
 = 
	`sqlôe4_îrcode
(
db
);

1251 
	`as£π
–
db
!=0 || 
rc
==
SQLITE4_NOMEM
 );

1252 if–
rc
==
SQLITE4_NOMEM
 ){

1253 
	`sqlôe4_˛o£
(
db
, 0);

1254 
db
 = 0;

1255 }if–
rc
!=
SQLITE4_OK
 ){

1256 
db
->
magic
 = 
SQLITE4_MAGIC_SICK
;

1258 *
µDb
 = 
db
;

1259  
	`sqlôe4ApiExô
(0, 
rc
);

1260 
	}
}

1265 
	$sqlôe4_›í
(

1266 
sqlôe4_ív
 *
pEnv
,

1267 c⁄° *
zFûíame
,

1268 
sqlôe4
 **
µDb
,

1271 
va_li°
 
≠
;

1272 
rc
;

1273 if–
pEnv
==0 )ÖEnv = 
	`sqlôe4_ív_deÁu…
();

1274 
	`va_°¨t
(
≠
, 
µDb
);

1275 
rc
 = 
	`›íD©aba£
(
pEnv
, 
zFûíame
,

1276 
SQLITE4_OPEN_READWRITE
 | 
SQLITE4_OPEN_CREATE
, 
µDb
, 
≠
);

1277 
	`va_íd
(
≠
);

1278  
rc
;

1279 
	}
}

1284 
sqlôe4_ív
 *
	$sqlôe4_db_ív
(
sqlôe4
 *
db
){

1285  
db
 ? db->
pEnv
 : 
	`sqlôe4_ív_deÁu…
();

1286 
	}
}

1291 
sqlôe4_¸óã_cﬁœti⁄
(

1292 
sqlôe4
* 
db
,

1293 c⁄° *
zName
,

1294 *
pCtx
,

1295 (*
xCom∑ª
)(*, 
sqlôe4_vÆue
*, sqlite4_value*, *),

1296 (*
xMakeKey
)(*, 
sqlôe4_vÆue
*, , *, *),

1297 (*
xDñ
)(*)

1299 
rc
;

1300 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

1301 
	`as£π
–!
db
->
mÆlocFaûed
 );

1302 
rc
 = 
	`¸óãCﬁœti⁄
(
db
, 
zName
, 
pCtx
, 
xCom∑ª
, 
xMakeKey
, 
xDñ
);

1303 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

1304 if–
rc
!=
SQLITE4_OK
 && 
xDñ
 ) 
	`xDñ
(
pCtx
);

1305 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

1306  
rc
;

1307 
	}
}

1313 
sqlôe4_cﬁœti⁄_√eded
(

1314 
sqlôe4
 *
db
,

1315 *
pCﬁlNìdedArg
,

1316 (*
xCﬁlNìded
)(*,
sqlôe4
*,const *),

1317 (*
xDe°roy
)(*)

1319 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

1320 if–
db
->
xCﬁlNìdedDe°roy
 ){

1321 
db
->
	`xCﬁlNìdedDe°roy
(db->
pCﬁlNìdedArg
);

1323 
db
->
xCﬁlNìded
 = xCollNeeded;

1324 
db
->
xCﬁlNìdedDe°roy
 = 
xDe°roy
;

1325 
db
->
pCﬁlNìdedArg
 =ÖCollNeededArg;

1326 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

1327  
SQLITE4_OK
;

1328 
	}
}

1336 
	$sqlôe4_db_å™ß˘i⁄_°©us
(
sqlôe4
 *
db
){

1337  (
db
->
pSavïoöt
!=0);

1338 
	}
}

1351 
	$sqlôe4C‹ru±Eº‹
(
löío
){

1352 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

1353 
	`sqlôe4_log
(0, 
SQLITE4_CORRUPT
,

1355 
löío
, 20+
	`sqlôe4_sour˚id
());

1356  
SQLITE4_CORRUPT
;

1357 
	}
}

1358 
	$sqlôe4Misu£Eº‹
(
löío
){

1359 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

1360 
	`sqlôe4_log
(0, 
SQLITE4_MISUSE
,

1362 
löío
, 20+
	`sqlôe4_sour˚id
());

1363  
SQLITE4_MISUSE
;

1364 
	}
}

1365 
	$sqlôe4C™t›íEº‹
(
löío
){

1366 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

1367 
	`sqlôe4_log
(0, 
SQLITE4_CANTOPEN
,

1369 
löío
, 20+
	`sqlôe4_sour˚id
());

1370  
SQLITE4_CANTOPEN
;

1371 
	}
}

1377 
	$sqlôe4_¶ìp
(
ms
){

1378  
SQLITE4_MISUSE
;

1379 
	}
}

1384 
	$sqlôe4_kv°‹e_c⁄åﬁ
(

1385 
sqlôe4
 *
db
,

1386 c⁄° *
zDbName
,

1387 
›
,

1388 *
pArg


1390 
rc
 = 
SQLITE4_ERROR
;

1391 
KVSt‹e
 *
pKV
 = 0;

1392 
i
;

1394 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

1397 
i
=0; i<
db
->
nDb
; i++){

1398 
Db
 *
pDb
 = &
db
->
aDb
[
i
];

1399 if–
pDb
->
pKV
 && (0==
zDbName
 || 0==
	`sqlôe4_°ricmp
(zDbName,ÖDb->
zName
)) ){

1400 
pKV
 = 
pDb
->pKV;

1406 if–
pKV
 ){

1407 
rc
 = 
pKV
->
pSt‹eVfunc
->
	`xC⁄åﬁ
’KV, 
›
, 
pArg
);

1410 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

1411  
rc
;

1412 
	}
}

1418 
	$sqlôe4_ã°_c⁄åﬁ
(
›
, ...){

1419 
rc
 = 0;

1420 #i‚de‡
SQLITE4_OMIT_BUILTIN_TEST


1421 
va_li°
 
≠
;

1422 
	`va_°¨t
(
≠
, 
›
);

1423  
›
 ){

1435 
SQLITE4_TESTCTRL_ASSERT
: {

1436 vﬁ©ûê
x
 = 0;

1437 
	`as£π
–(
x
 = 
	`va_¨g
(
≠
,))!=0 );

1438 
rc
 = 
x
;

1470 
SQLITE4_TESTCTRL_ALWAYS
: {

1471 
x
 = 
	`va_¨g
(
≠
,);

1472 
rc
 = 
	`ALWAYS
(
x
);

1485 
SQLITE4_TESTCTRL_OPTIMIZATIONS
: {

1486 
sqlôe4
 *
db
 = 
	`va_¨g
(
≠
, sqlite4*);

1487 
x
 = 
	`va_¨g
(
≠
,);

1488 
db
->
Êags
 = (
x
 & 
SQLITE4_O±Mask
) | (db->flags & ~SQLITE4_OptMask);

1492 #ifde‡
SQLITE4_N_KEYWORD


1502 
SQLITE4_TESTCTRL_ISKEYWORD
: {

1503 c⁄° *
zW‹d
 = 
	`va_¨g
(
≠
, const *);

1504 
n
 = 
	`sqlôe4SåÀn30
(
zW‹d
);

1505 
rc
 = (
	`sqlôe4Keyw‹dCode
((
u8
*)
zW‹d
, 
n
)!=
TK_ID
Ë? 
SQLITE4_N_KEYWORD
 : 0;

1516 
SQLITE4_TESTCTRL_LOCALTIME_FAULT
: {

1517 
sqlôe4DeÁu…Env
.
bLoˇ…imeFau…
 = 
	`va_¨g
(
≠
, );

1521 #i‡
	`deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

1529 
SQLITE4_TESTCTRL_EXPLAIN_STMT
: {

1530 
sqlôe4_°mt
 *
pStmt
 = 
	`va_¨g
(
≠
, sqlite4_stmt*);

1531 c⁄° **
pzRë
 = 
	`va_¨g
(
≠
, const **);

1532 *
pzRë
 = 
	`sqlôe4VdbeEx∂™©i⁄
((
Vdbe
*)
pStmt
);

1537 
SQLITE4_TESTCTRL_PRNG_GET
: {

1538 
sqlôe4_ív
 *
pEnv
 = 
	`va_¨g
(
≠
, sqlite4_env *);

1539 
sqlôe4_öt64
 *
piOut
 = 
	`va_¨g
(
≠
, sqlite4_int64 *);

1540 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

1541 *
piOut
 = (
sqlôe4_öt64
)(((
u64
)
pEnv
->
¥ngX
 << 32Ë+ÖEnv->
¥ngY
);

1544 
SQLITE4_TESTCTRL_PRNG_SET
: {

1545 
sqlôe4_ív
 *
pEnv
 = 
	`va_¨g
(
≠
, sqlite4_env *);

1546 
u64
 
iVÆ
 = (u64)
	`va_¨g
(
≠
, 
sqlôe4_öt64
);

1547 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

1548 
pEnv
->
¥ngX
 = (
iVÆ
>>32);

1549 
pEnv
->
¥ngY
 = (
iVÆ
 & 0xFFFFFFFF);

1553 
	`va_íd
(
≠
);

1555  
rc
;

1556 
	}
}

1569 c⁄° *
	$sqlôe4_uri_∑ømëî
(c⁄° *
zFûíame
, c⁄° *
zP¨am
){

1570 if–
zFûíame
==0 )  0;

1571 
zFûíame
 +
	`sqlôe4SåÀn30
(zFilename) + 1;

1572  
zFûíame
[0] ){

1573 
x
 = 
	`°rcmp
(
zFûíame
, 
zP¨am
);

1574 
zFûíame
 +
	`sqlôe4SåÀn30
(zFilename) + 1;

1575 if–
x
==0 )  
zFûíame
;

1576 
zFûíame
 +
	`sqlôe4SåÀn30
(zFilename) + 1;

1579 
	}
}

1584 
	$sqlôe4_uri_boﬁón
(c⁄° *
zFûíame
, c⁄° *
zP¨am
, 
bDÊt
){

1585 c⁄° *
z
 = 
	`sqlôe4_uri_∑ømëî
(
zFûíame
, 
zP¨am
);

1586  
z
 ? 
	`sqlôe4GëBoﬁón
(zË: (
bDÊt
!=0);

1587 
	}
}

1592 
sqlôe4_öt64
 
	$sqlôe4_uri_öt64
(

1593 c⁄° *
zFûíame
,

1594 c⁄° *
zP¨am
,

1595 
sqlôe4_öt64
 
bDÊt


1597 c⁄° *
z
 = 
	`sqlôe4_uri_∑ømëî
(
zFûíame
, 
zP¨am
);

1598 
sqlôe4_öt64
 
v
;

1599 if–
z
 && 
	`sqlôe4Atoi64
(z, &
v
, 
	`sqlôe4SåÀn30
(z), 
SQLITE4_UTF8
)==
SQLITE4_OK
 ){

1600 
bDÊt
 = 
v
;

1602  
bDÊt
;

1603 
	}
}

	@src/malloc.c

15 
	~"sqlôeI¡.h
"

16 
	~<°d¨g.h
>

21 
	$sqlôe4MÆlocInô
(
sqlôe4_ív
 *
pEnv
){

23  
SQLITE4_OK
;

24 
	}
}

29 
	$sqlôe4MÆlocEnd
(
sqlôe4_ív
 *
pEnv
){

32 
	}
}

38 *
	$sqlôe4MÆloc
(
sqlôe4_ív
 *
pEnv
, 
n
){

39 *
p
;

40 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

42 if–
n
<=0

43 || 
n
>=0x7fffff00

50 
p
 = 0;

52 
p
 = 
	`sqlôe4_mm_mÆloc
(
pEnv
->
pMM
, 
n
);

55 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
p
) );

56  
p
;

57 
	}
}

64 *
	$sqlôe4_mÆloc
(
sqlôe4_ív
 *
pEnv
, 
sqlôe4_size_t
 
n
){

65 #i‚de‡
SQLITE4_OMIT_AUTOINIT


66 if–
	`sqlôe4_öôülize
(
pEnv
) )  0;

68  
	`sqlôe4MÆloc
(
pEnv
, ()
n
);

69 
	}
}

75 #i‚de‡
SQLITE4_OMIT_LOOKASIDE


76 
	$isLookaside
(
sqlôe4
 *
db
, *
p
){

77  
p
 &&Ö>=
db
->
lookaside
.
pSèπ
 &&Ö<db->lookaside.
pEnd
;

78 
	}
}

80 
	#isLookaside
(
A
,
B
Ë0

	)

87 
	$sqlôe4MÆlocSize
(
sqlôe4_ív
 *
pEnv
, *
p
){

88 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
p
, 
MEMTYPE_HEAP
) );

89 
	`as£π
–
	`sqlôe4MemdebugNoTy≥
(
p
, 
MEMTYPE_DB
) );

91 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

92  
	`sqlôe4_mm_msize
(
pEnv
->
pMM
, 
p
);

93 
	}
}

94 
	$sqlôe4DbMÆlocSize
(
sqlôe4
 *
db
, *
p
){

95 
	`as£π
–
db
==0 || 
	`sqlôe4_muãx_hñd
(db->
muãx
) );

96 if–
db
 && 
	`isLookaside
(db, 
p
) ){

97  
db
->
lookaside
.
sz
;

99  
	`sqlôe4MÆlocSize
(
	`sqlôe4_db_ív
(
db
), 
p
);

101 
	}
}

106 
	$sqlôe4_‰ì
(
sqlôe4_ív
 *
pEnv
, *
p
){

107 if–
p
==0 ) ;

108 
	`as£π
–
	`sqlôe4MemdebugNoTy≥
(
p
, 
MEMTYPE_DB
) );

109 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
p
, 
MEMTYPE_HEAP
) );

111 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

112 
	`sqlôe4_mm_‰ì
(
pEnv
->
pMM
, 
p
);

113 
	}
}

119 
	$sqlôe4DbFªe
(
sqlôe4
 *
db
, *
p
){

120 
	`as£π
–
db
==0 || 
	`sqlôe4_muãx_hñd
(db->
muãx
) );

121 if–
db
 ){

122 if–
db
->
≤ByãsFªed
 ){

123 *
db
->
≤ByãsFªed
 +
	`sqlôe4DbMÆlocSize
(db, 
p
);

126 if–
	`isLookaside
(
db
, 
p
) ){

127 
LookasideSlŸ
 *
pBuf
 = (LookasideSlŸ*)
p
;

128 
pBuf
->
pNext
 = 
db
->
lookaside
.
pFªe
;

129 
db
->
lookaside
.
pFªe
 = 
pBuf
;

130 
db
->
lookaside
.
nOut
--;

134 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
p
, 
MEMTYPE_DB
) );

135 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
p
, 
MEMTYPE_LOOKASIDE
|
MEMTYPE_HEAP
) );

136 
	`as£π
–
db
!=0 || 
	`sqlôe4MemdebugNoTy≥
(
p
, 
MEMTYPE_LOOKASIDE
) );

137 
	`sqlôe4MemdebugSëTy≥
(
p
, 
MEMTYPE_HEAP
);

138 
	`sqlôe4_‰ì
(
db
==0 ? 0 : db->
pEnv
, 
p
);

139 
	}
}

144 *
	$sqlôe4RóŒoc
(
sqlôe4_ív
 *
pEnv
, *
pOld
, 
nByãs
){

145 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

147 if–
pOld
==0 ){

148  
	`sqlôe4MÆloc
(
pEnv
, 
nByãs
);

150 if–
nByãs
<=0 ){

151 
	`sqlôe4_‰ì
(
pEnv
, 
pOld
);

154 if–
nByãs
>=0x7fffff00 ){

159  
	`sqlôe4_mm_ªÆloc
(
pEnv
->
pMM
, 
pOld
, 
nByãs
);

160 
	}
}

166 *
	$sqlôe4_ªÆloc
(
sqlôe4_ív
 *
pEnv
, *
pOld
, 
sqlôe4_size_t
 
n
){

167 #i‚de‡
SQLITE4_OMIT_AUTOINIT


168 if–
	`sqlôe4_öôülize
(
pEnv
) )  0;

170  
	`sqlôe4RóŒoc
(
pEnv
, 
pOld
, ()
n
);

171 
	}
}

177 *
	$sqlôe4MÆlocZîo
(
sqlôe4_ív
 *
pEnv
, 
n
){

178 *
p
 = 
	`sqlôe4MÆloc
(
pEnv
, 
n
);

179 if–
p
 ){

180 
	`mem£t
(
p
, 0, 
n
);

182  
p
;

183 
	}
}

189 *
	$sqlôe4DbMÆlocZîo
(
sqlôe4
 *
db
, 
n
){

190 *
p
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
n
);

191 if–
p
 ){

192 
	`mem£t
(
p
, 0, 
n
);

194  
p
;

195 
	}
}

215 *
	$sqlôe4DbMÆlocRaw
(
sqlôe4
 *
db
, 
n
){

216 *
p
;

217 
	`as£π
–
db
==0 || 
	`sqlôe4_muãx_hñd
(db->
muãx
) );

218 
	`as£π
–
db
==0 || db->
≤ByãsFªed
==0 );

219 #i‚de‡
SQLITE4_OMIT_LOOKASIDE


220 if–
db
 ){

221 
LookasideSlŸ
 *
pBuf
;

222 if–
db
->
mÆlocFaûed
 ){

225 if–
db
->
lookaside
.
bE«bÀd
 ){

226 if–
n
>
db
->
lookaside
.
sz
 ){

227 
db
->
lookaside
.
™Sèt
[1]++;

228 }if–(
pBuf
 = 
db
->
lookaside
.
pFªe
)==0 ){

229 
db
->
lookaside
.
™Sèt
[2]++;

231 
db
->
lookaside
.
pFªe
 = 
pBuf
->
pNext
;

232 
db
->
lookaside
.
nOut
++;

233 
db
->
lookaside
.
™Sèt
[0]++;

234 if–
db
->
lookaside
.
nOut
>db->lookaside.
mxOut
 ){

235 
db
->
lookaside
.
mxOut
 = db->lookaside.
nOut
;

237  (*)
pBuf
;

242 if–
db
 && db->
mÆlocFaûed
 ){

246 
p
 = 
	`sqlôe4MÆloc
((
db
 ? db->
pEnv
: 0), 
n
);

247 if–!
p
 && 
db
 ){

248 
db
->
mÆlocFaûed
 = 1;

250 
	`sqlôe4MemdebugSëTy≥
(
p
, 
MEMTYPE_DB
 |

251 ((
db
 && db->
lookaside
.
bE«bÀd
Ë? 
MEMTYPE_LOOKASIDE
 : 
MEMTYPE_HEAP
));

252  
p
;

253 
	}
}

259 *
	$sqlôe4DbRóŒoc
(
sqlôe4
 *
db
, *
p
, 
n
){

260 *
pNew
 = 0;

261 
	`as£π
–
db
!=0 );

262 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

263 if–
db
->
mÆlocFaûed
==0 ){

264 if–
p
==0 ){

265  
	`sqlôe4DbMÆlocRaw
(
db
, 
n
);

267 if–
	`isLookaside
(
db
, 
p
) ){

268 if–
n
<=
db
->
lookaside
.
sz
 ){

269  
p
;

271 
pNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
n
);

272 if–
pNew
 ){

273 
	`mem˝y
(
pNew
, 
p
, 
db
->
lookaside
.
sz
);

274 
	`sqlôe4DbFªe
(
db
, 
p
);

277 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
p
, 
MEMTYPE_DB
) );

278 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
p
, 
MEMTYPE_LOOKASIDE
|
MEMTYPE_HEAP
) );

279 
	`sqlôe4MemdebugSëTy≥
(
p
, 
MEMTYPE_HEAP
);

280 
pNew
 = 
	`sqlôe4_ªÆloc
(
db
->
pEnv
, 
p
, 
n
);

281 if–!
pNew
 ){

282 
	`sqlôe4MemdebugSëTy≥
(
p
, 
MEMTYPE_DB
|
MEMTYPE_HEAP
);

283 
db
->
mÆlocFaûed
 = 1;

285 
	`sqlôe4MemdebugSëTy≥
(
pNew
, 
MEMTYPE_DB
 |

286 (
db
->
lookaside
.
bE«bÀd
 ? 
MEMTYPE_LOOKASIDE
 : 
MEMTYPE_HEAP
));

289  
pNew
;

290 
	}
}

296 *
	$sqlôe4DbRóŒocOrFªe
(
sqlôe4
 *
db
, *
p
, 
n
){

297 *
pNew
;

298 
pNew
 = 
	`sqlôe4DbRóŒoc
(
db
, 
p
, 
n
);

299 if–!
pNew
 ){

300 
	`sqlôe4DbFªe
(
db
, 
p
);

302  
pNew
;

303 
	}
}

312 *
	$sqlôe4DbSåDup
(
sqlôe4
 *
db
, c⁄° *
z
){

313 *
zNew
;

314 
size_t
 
n
;

315 if–
z
==0 ){

318 
n
 = 
	`sqlôe4SåÀn30
(
z
) + 1;

319 
	`as£π
–(
n
&0x7fffffff)==n );

320 
zNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, ()
n
);

321 if–
zNew
 ){

322 
	`mem˝y
(
zNew
, 
z
, 
n
);

324  
zNew
;

325 
	}
}

326 *
	$sqlôe4DbSåNDup
(
sqlôe4
 *
db
, c⁄° *
z
, 
n
){

327 *
zNew
;

328 if–
z
==0 ){

331 
	`as£π
–(
n
&0x7fffffff)==n );

332 
zNew
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
n
+1);

333 if–
zNew
 ){

334 
	`mem˝y
(
zNew
, 
z
, 
n
);

335 
zNew
[
n
] = 0;

337  
zNew
;

338 
	}
}

345 
	$sqlôe4SëSåög
(**
pz
, 
sqlôe4
 *
db
, c⁄° *
zF‹m©
, ...){

346 
va_li°
 
≠
;

347 *
z
;

349 
	`va_°¨t
(
≠
, 
zF‹m©
);

350 
z
 = 
	`sqlôe4VMPrötf
(
db
, 
zF‹m©
, 
≠
);

351 
	`va_íd
(
≠
);

352 
	`sqlôe4DbFªe
(
db
, *
pz
);

353 *
pz
 = 
z
;

354 
	}
}

370 
	$sqlôe4ApiExô
(
sqlôe4
* 
db
, 
rc
){

375 
	`as£π
–!
db
 || 
	`sqlôe4_muãx_hñd
(db->
muãx
) );

376 if–
db
 && (db->
mÆlocFaûed
 || 
rc
==
SQLITE4_IOERR_NOMEM
) ){

377 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_NOMEM
, 0);

378 
db
->
mÆlocFaûed
 = 0;

379 
rc
 = 
SQLITE4_NOMEM
;

381  
rc
;

382 
	}
}

	@src/math.c

16 
	~"sqlôeI¡.h
"

18 
	#SQLITE4_MX_EXP
 999

	)

19 
	#SQLITE4_NAN_EXP
 2000

	)

24 
	#TENTH_MAX
 (
LARGEST_UINT64
/10)

	)

30 
	$adju°Exp⁄ít
(
sqlôe4_num
 *
pA
, sqlôe4_num *
pB
){

31 if–
pA
->
e
<
pB
->e ){

32 
sqlôe4_num
 *
t
 = 
pA
;

33 
pA
 = 
pB
;

34 
pB
 = 
t
;

36 if–
pB
->
m
==0 ){

37 
pB
->
e
 = 
pA
->e;

40 if–
pA
->
m
==0 ){

41 
pA
->
e
 = 
pB
->e;

44 if–
pA
->
e
 > 
pB
->e+40 ){

45 
pB
->
≠¥ox
 = 1;

46 
pB
->
e
 = 
pA
->e;

47 
pB
->
m
 = 0;

50  
pA
->
e
>
pB
->ê&&ÖB->
m
%10==0 ){

51 
pB
->
m
 /= 10;

52 
pB
->
e
++;

54  
pA
->
e
>
pB
->ê&&ÖA->
m
<=
TENTH_MAX
 ){

55 
pA
->
m
 *= 10;

56 
pA
->
e
--;

58  
pA
->
e
>
pB
->e ){

59 
pB
->
m
 /= 10;

60 
pB
->
e
++;

61 
pB
->
≠¥ox
 = 1;

63 
	}
}

68 
sqlôe4_num
 
	$sqlôe4_num_add
(
sqlôe4_num
 
A
, sqlôe4_num 
B
){

69 
sqlôe4_uöt64
 
r
;

70 if–
A
.
sign
!=
B
.sign ){

71 if–
A
.
sign
 ){

72 
A
.
sign
 = 0;

73  
	`sqlôe4_num_sub
(
B
,
A
);

75 
B
.
sign
 = 0;

76  
	`sqlôe4_num_sub
(
A
,
B
);

79 if–
A
.
e
>
SQLITE4_MX_EXP
 ){

80 if–
B
.
e
>
SQLITE4_MX_EXP
 && B.
m
==0 )  B;

81  
A
;

83 if–
B
.
e
>
SQLITE4_MX_EXP
 ){

84  
B
;

86 
	`adju°Exp⁄ít
(&
A
, &
B
);

87 
r
 = 
A
.
m
+
B
.m;

88 
A
.
≠¥ox
 |
B
.approx;

89 if–
r
>=
A
.
m
 ){

90 
A
.
m
 = 
r
;

92 if–
A
.
≠¥ox
==0 && (A.
m
%10)!=0 ) A.approx = 1;

93 
A
.
m
 /= 10;

94 
A
.
e
++;

95 if–
A
.
e
>
SQLITE4_MX_EXP
 )  A;

96 if–
A
.
≠¥ox
==0 && (
B
.
m
%10)!=0 ) A.approx = 1;

97 
A
.
m
 +
B
.m/10;

99  
A
;

100 
	}
}

105 
sqlôe4_num
 
	$sqlôe4_num_sub
(
sqlôe4_num
 
A
, sqlôe4_num 
B
){

106 if–
A
.
sign
!=
B
.sign ){

107 
B
.
sign
 = 
A
.sign;

108  
	`sqlôe4_num_add
(
A
,
B
);

110 if–
A
.
e
>
SQLITE4_MX_EXP
 || 
B
.e>SQLITE4_MX_EXP ){

111 
A
.
e
 = 
SQLITE4_NAN_EXP
;

112 
A
.
m
 = 0;

113  
A
;

115 
	`adju°Exp⁄ít
(&
A
, &
B
);

116 if–
B
.
m
 > 
A
.m ){

117 
sqlôe4_num
 
t
 = 
A
;

118 
A
 = 
B
;

119 
B
 = 
t
;

120 
A
.
sign
 = 1-A.sign;

122 
A
.
m
 -
B
.m;

123 
A
.
≠¥ox
 |
B
.approx;

124  
A
;

125 
	}
}

130 
	$mu…WûlOvîÊow
(
sqlôe4_uöt64
 
x
, sqlôe4_uöt64 
y
){

131 
sqlôe4_uöt64
 
xHi
, 
xLo
, 
yHi
, 
yLo
;

132 
xHi
 = 
x
>>32;

133 
yHi
 = 
y
>>32;

134 if–
xHi
*
yHi
 )  1;

135 
xLo
 = 
x
 & 0xffffffff;

136 
yLo
 = 
y
 & 0xffffffff;

137 if–(
xHi
*
yLo
 + 
yHi
*
xLo
 + (xLo*yLo>>32))>0xffffffff )  1;

139 
	}
}

144 
sqlôe4_num
 
	$sqlôe4_num_mul
(
sqlôe4_num
 
A
, sqlôe4_num 
B
){

145 
sqlôe4_num
 
r
;

147 if–
A
.
e
>
SQLITE4_MX_EXP
 || 
B
.e>SQLITE4_MX_EXP ){

148 
r
.
sign
 = 
A
.sig¿^ 
B
.sign;

149 
r
.
m
 = (
A
.m && 
B
.m) ? 1 : 0;

150 
r
.
e
 = 
SQLITE4_MX_EXP
+1;

151 
r
.
≠¥ox
 = 0;

152  
r
;

154 if–
A
.
m
==0 )  A;

155 if–
B
.
m
==0 )  B;

156  
A
.
m
%10==0 ){ A.m /10; A.
e
++; }

157  
B
.
m
%10==0 ){ B.m /10; B.
e
++; }

158  
A
.
m
%5==0 && 
B
.m%2==0 ){ A.m /5; A.
e
++; B.m /= 2; }

159  
B
.
m
%5==0 && 
A
.m%2==0 ){ B.m /5; B.
e
++; A.m /= 2; }

160 
r
.
sign
 = 
A
.sig¿^ 
B
.sign;

161 
r
.
≠¥ox
 = 
A
.≠¥ox | 
B
.approx;

162  
	`mu…WûlOvîÊow
(
A
.
m
, 
B
.m) ){

163 
r
.
≠¥ox
 = 1;

164 if–
A
.
m
>
B
.m ){

165 
A
.
m
 /= 10;

166 
A
.
e
++;

168 
B
.
m
 /= 10;

169 
B
.
e
++;

172 
r
.
m
 = 
A
.m*
B
.m;

173 
r
.
e
 = 
A
.ê+ 
B
.e;

174  
r
;

175 
	}
}

180 
sqlôe4_num
 
	$sqlôe4_num_div
(
sqlôe4_num
 
A
, sqlôe4_num 
B
){

181 
sqlôe4_num
 
r
;

182 if–
A
.
e
>
SQLITE4_MX_EXP
 ){

183 
A
.
m
 = 0;

184  
A
;

186 if–
B
.
e
>
SQLITE4_MX_EXP
 ){

187 if–
B
.
m
!=0 ){

188 
r
.
m
 = 0;

189 
r
.
e
 = 0;

190 
r
.
sign
 = 0;

191 
r
.
≠¥ox
 = 1;

192  
r
;

194  
B
;

196 if–
B
.
m
==0 ){

197 
r
.
sign
 = 
A
.sig¿^ 
B
.sign;

198 
r
.
e
 = 
SQLITE4_NAN_EXP
;

199 
r
.
m
 = 0;

200 
r
.
≠¥ox
 = 1;

201  
r
;

203 if–
A
.
m
==0 ){

204  
A
;

206  
A
.
m
<
TENTH_MAX
 ){

207 
A
.
m
 *= 10;

208 
A
.
e
--;

210  
B
.
m
%10==0 ){

211 
B
.
m
 /= 10;

212 
B
.
e
++;

214 
r
.
sign
 = 
A
.sig¿^ 
B
.sign;

215 
r
.
≠¥ox
 = 
A
.≠¥ox | 
B
.approx;

216 if–
r
.
≠¥ox
==0 && 
A
.
m
%
B
.m!=0 )Ñ.approx = 1;

217 
r
.
m
 = 
A
.m/
B
.m;

218 
r
.
e
 = 
A
.ê- 
B
.e;

219  
r
;

220 
	}
}

225 
	$sqlôe4_num_isöf
(
sqlôe4_num
 
A
){

226  
A
.
e
>
SQLITE4_MX_EXP
 && A.
m
!=0;

227 
	}
}

232 
	$sqlôe4_num_i¢™
(
sqlôe4_num
 
A
){

233  
A
.
e
>
SQLITE4_MX_EXP
 && A.
m
==0;

234 
	}
}

247 
	$sqlôe4_num_com∑ª
(
sqlôe4_num
 
A
, sqlôe4_num 
B
){

248 if–
A
.
e
>
SQLITE4_MX_EXP
 ){

249 if–
A
.
m
==0 )  0;

250 if–
B
.
e
>
SQLITE4_MX_EXP
 ){

251 if–
B
.
m
==0 )  0;

252 if–
B
.
sign
==
A
.sign )  0;

254  
A
.
sign
 ? 1 : 3;

256 if–
B
.
e
>
SQLITE4_MX_EXP
 ){

257 if–
B
.
m
==0 )  0;

258  
B
.
sign
 ? 3 : 1;

260 if–
A
.
sign
!=
B
.sign ){

261 i‡–
A
.
m
==0 && 
B
.m==0 )  2;

262  
A
.
sign
 ? 1 : 3;

264 
	`adju°Exp⁄ít
(&
A
, &
B
);

265 if–
A
.
sign
 ){

266 
sqlôe4_num
 
t
 = 
A
;

267 
A
 = 
B
;

268 
B
 = 
t
;

270 if–
A
.
e
!=
B
.e ){

271  
A
.
e
<
B
.e ? 1 : 3;

273 if–
A
.
m
!=
B
.m ){

274  
A
.
m
<
B
.m ? 1 : 3;

277 
	}
}

283 
sqlôe4_num
 
	$sqlôe4_num_round
(
sqlôe4_num
 
x
, 
N
){

284 if–
N
<0 ) N = 0;

285 if–
x
.
e
 >-
N
 )  x;

286 if–
x
.
e
 < -(
N
+30) ){

287 
	`mem£t
(&
x
, 0, (x));

288  
x
;

290  
x
.
e
 < -(
N
+1) ){

291 
x
.
m
 /= 10;

292 
x
.
e
++;

294 
x
.
m
 = (x.m+5)/10;

295 
x
.
e
++;

296  
x
;

297 
	}
}

319 
sqlôe4_num
 
	$sqlôe4_num_‰om_ãxt
(

320 c⁄° *
zIn
,

321 
nIn
,

322 
Êags
,

323 *
pbRól


326 c⁄° 
sqlôe4_num
 
îr‹_vÆue
 = {0, 0, 
SQLITE4_MX_EXP
+1, 0};

328 c⁄° 
i64
 
L10
 = (
LARGEST_INT64
 / 10);

329 
aMaxFöÆ
[2] = {7, 8};

330 
⁄e
 = 1;

331 
bRnd
 = 1;

332 
bRól
 = 0;

333 
£íRadix
 = 0;

334 
£íDigô
 = 0;

335 
ö¸
 = 1;

336 
sqlôe4_num
 
r
;

337 
c
;

338 
i
;

340 
	`as£π
–
L10
==922337203685477580 );

342 
	`mem£t
(&
r
, 0, (r));

343 if–
nIn
<0 )ÇIn = 1000000000;

344 
c
 = 
Êags
 & 0xf;

345 if–
c
==0 || c==
SQLITE4_UTF8
 ){

346 
ö¸
 = 1;

348 if–
c
==
SQLITE4_UTF16
 ){ c = (3 - *(*)&
⁄e
); }

349 
	`as£π
–
c
==
SQLITE4_UTF16LE
 || c==
SQLITE4_UTF16BE
 );

350 
ö¸
 = 2;

351 if–
c
==
SQLITE4_UTF16BE
 ){

352 
zIn
 += 1;

353 
nIn
 -= 1;

358 
i
 = 0;

359 if–
Êags
 & 
SQLITE4_IGNORE_WHITESPACE
 ){

360  
i
<
nIn
 && 
	`sqlôe4Is•a˚
(
zIn
[i]ËËi+=
ö¸
;

362 if–
nIn
<=
i
 )  
îr‹_vÆue
;

365 if–
zIn
[
i
]=='-' ){

366 
r
.
sign
 = 1;

367 
i
 +
ö¸
;

368 }if–
zIn
[
i
]=='+' ){

369 
i
 +
ö¸
;

370 }if–
Êags
 & 
SQLITE4_NEGATIVE
 ){

371 
r
.
sign
 = 1;

373 if–
nIn
<=
i
 )  
îr‹_vÆue
;

376 if–(
Êags
 & 
SQLITE4_INTEGER_ONLY
)==0

377 && (
nIn
-
i
)>=
ö¸
*3

378 && ((
c
=
zIn
[
i
])=='i' || c=='I')

379 && ((
c
=
zIn
[
i
+
ö¸
])=='n' || c=='N')

380 && ((
c
=
zIn
[
i
+
ö¸
*2])=='f' || c=='F')

382 
r
.
e
 = 
SQLITE4_MX_EXP
+1;

383 
r
.
m
 = 1;

384 
bRól
 = 1;

385 
i
 +
ö¸
*3;

386 
föished
;

389  ; 
i
<
nIn
 && (
c
 = 
zIn
[i])!=0; i+=
ö¸
){

390 if–
c
>='0' && c<='9' ){

391 
iDigô
 = (
c
 - '0');

393 if–
iDigô
==0 && 
£íDigô
==0 ){

397 if–
£íRadix
 ) 
r
.
e
--;

401 
£íDigô
 = 1;

402 if–
r
.
e
>0 ||Ñ.
m
>
L10
 || (r.m==L10 && 
iDigô
>
aMaxFöÆ
[r.
sign
]) ){

404 if–
£íRadix
==0 ) 
r
.
e
++;

405 if–
iDigô
!=0 ){ 
r
.
≠¥ox
 = 1; }

406 if–
bRnd
 ){

407 if–
iDigô
>5 && 
r
.
m
<((
u64
)
LARGEST_INT64
 +Ñ.
sign
))Ñ.m++;

408 
bRnd
 = 0;

410 
bRól
 = 1;

412 if–
£íRadix
 ) 
r
.
e
 -= 1;

413 
r
.
m
 = (r.m*10Ë+ 
iDigô
;

417 if–
Êags
 & 
SQLITE4_INTEGER_ONLY
 ) 
föished
;

419 if–
c
=='.' ){

421 if–
£íRadix
 ) 
föished
;

422 
£íRadix
 = 1;

423 
bRól
 = 1;

424 }if–
c
=='e' || c=='E' ){

425 
f
 = (
Êags
 & (
SQLITE4_PREFIX_ONLY
|
SQLITE4_IGNORE_WHITESPACE
));

426 
sqlôe4_num
 
exp
;

427 if–
ö¸
==2 ) 
f
 |
SQLITE4_UTF16LE
;

428 if–(
i
+
ö¸
)>=
nIn
 ) 
föished
;

429 
i
 +
ö¸
;

430 
exp
 = 
	`sqlôe4_num_‰om_ãxt
(&
zIn
[
i
], 
nIn
-i, 
f
, 0);

431 if–
	`sqlôe4_num_i¢™
(
exp
ËË
föished
;

432 if–
exp
.
e
 ||Éxp.
m
>999 ) 
föished
;

433 
bRól
 = 1;

434 
r
.
e
 +()(
exp
.
m
Ë* (exp.
sign
 ? -1 : 1);

435 
i
 = 
nIn
;

438 
föished
;

443 
föished
:

447 if–(
Êags
 & 
SQLITE4_PREFIX_ONLY
)==0 && 
i
<
nIn
 && 
zIn
[i] ){

448 if–
Êags
 & 
SQLITE4_IGNORE_WHITESPACE
 ){

449  
i
<
nIn
 && 
	`sqlôe4Is•a˚
(
zIn
[i]ËËò+
ö¸
;

451 if–
i
<
nIn
 && 
zIn
[i] ){

452 
r
.
e
 = 
SQLITE4_MX_EXP
+1;

453 
r
.
m
 = 0;

458 if–
pbRól
 ) *pbRó»
bRól
;

459  
r
;

460 
	}
}

465 
sqlôe4_num
 
	$sqlôe4_num_‰om_öt64
(
sqlôe4_öt64
 
n
){

466 
sqlôe4_num
 
r
;

467 
r
.
≠¥ox
 = 0;

468 
r
.
e
 = 0;

469 
r
.
sign
 = 
n
 < 0;

470 if–
n
>=0 ){

471 
r
.
m
 = 
n
;

472 }if–
n
!=
SMALLEST_INT64
 ){

473 
r
.
m
 = -
n
;

475 
r
.
m
 = 1+(
u64
)
LARGEST_INT64
;

477  
r
;

478 
	}
}

486 
sqlôe4_num
 
	$sqlôe4_num_‰om_doubÀ
(
d
){

487 c⁄° 
œrge
 = ()
LARGEST_UINT64
;

488 c⁄° 
œrge10
 = ()
TENTH_MAX
;

489 
sqlôe4_num
 
x
 = {0, 0, 0, 0};

492 
x
.
≠¥ox
 = 1;

494 if–
d
<0.0 ){

495 
x
.
sign
 = 1;

496 
d
 = d*-1.0;

499  
d
>
œrge
 || (d>1.0 && d==(
i64
)d) ){

500 
d
 = d / 10.0;

501 
x
.
e
++;

504  
d
<
œrge10
 && d!=()((
i64
)d) ){

505 
d
 = d * 10.0;

506 
x
.
e
--;

508 
x
.
m
 = (
u64
)
d
;

510  
x
;

511 
	}
}

523 
	$sqlôe4_num_to_öt32
(
sqlôe4_num
 
num
, *
pbLossy
){

524 
sqlôe4_öt64
 
iVÆ
;

525 
iVÆ
 = 
	`sqlôe4_num_to_öt64
(
num
, 
pbLossy
);

526 if–
iVÆ
<
SMALLEST_INT32
 ){

527 if–
pbLossy
 ) *pbLossy = 1;

528  
SMALLEST_INT32
;

529 }if–
iVÆ
>
LARGEST_INT32
 ){

530 if–
pbLossy
 ) *pbLossy = 1;

531  
LARGEST_INT32
;

533  ()
iVÆ
;

535 
	}
}

537 
	$sqlôe4_num_to_doubÀ
(
sqlôe4_num
 
num
, *
¥
){

538 
rRë
;

539 
i
;

540 
rRë
 = 
num
.
m
;

541 if–
num
.
sign
 ) 
rRë
 =ÑRet*-1;

542 
i
=0; i<
num
.
e
; i++){

543 
rRë
 =ÑRet * 10.0;

545 
i
=
num
.
e
; i<0; i++){

546 
rRë
 =ÑRet / 10.0;

548 *
¥
 = 
rRë
;

549  
SQLITE4_OK
;

550 
	}
}

562 
sqlôe4_öt64
 
	$sqlôe4_num_to_öt64
(
sqlôe4_num
 
num
, *
pbLossy
){

563 c⁄° 
i64
 
L10
 = (
LARGEST_INT64
 / 10);

564 
u64
 
iRë
;

565 
i
;

566 
iRë
 = 
num
.
m
;

568 if–
pbLossy
 ) *pbLossy = 
num
.
≠¥ox
;

569 
i
=0; i<
num
.
e
; i++){

570 if–
iRë
>
L10
 ) 
ovîÊow
;

571 
iRë
 = iRet * 10;

573 
i
=
num
.
e
; i<0; i++){

574 if–
pbLossy
 && (
iRë
 % 10) ) *pbLossy = 1;

575 
iRë
 = iRet / 10;

578 if–
num
.
sign
 ){

579 if–
iRë
>(
u64
)
LARGEST_INT64
+1 ) 
ovîÊow
;

580  -(
i64
)
iRë
;

582 if–
iRë
>(
u64
)
LARGEST_INT64
 ) 
ovîÊow
;

583  (
i64
)
iRë
;

586 
ovîÊow
:

587 if–
pbLossy
 ) *pbLossy = 1;

588  
num
.
sign
 ? -
LARGEST_INT64
-1 : LARGEST_INT64;

589 
	}
}

599 *
	$ªndîI¡
(
sqlôe4_uöt64
 
v
, *
zBuf
, 
nBuf
){

600 
i
 = 
nBuf
-1;;

601 
zBuf
[
i
--] = 0;

603 
zBuf
[
i
--] = (
v
%10) + '0';

604 
v
 /= 10;

605 } 
v
>0 );

606  
zBuf
+(
i
+1);

607 
	}
}

612 
	$ªmoveTøûögZîos
(*
z
, *
pN
){

613 
i
 = *
pN
;

614  
i
>0 && 
z
[i-1]=='0' ) i--;

615 
z
[
i
] = 0;

616 *
pN
 = 
i
;

617 
	}
}

624 
	$sqlôe4_num_to_ãxt
(
sqlôe4_num
 
x
, *
zOut
, 
bRól
){

625 
zBuf
[24];

626 *
zNum
;

627 
n
;

628 c⁄° 
zîos
[] = "0000000000000000000000000";

630 *
z
 = 
zOut
;

632 if–
x
.
sign
 && x.
m
>0 ){

634 
z
[0] = '-';

635 
z
++;

637 if–
x
.
e
>
SQLITE4_MX_EXP
 ){

639 if–
x
.
m
==0 ){

640 
	`mem˝y
(
z
, "NaN", 4);

642 
	`mem˝y
(
z
, "inf", 4);

644  (
z
 - 
zOut
)+3;

646 if–
x
.
m
==0 ){

647 if–
bRól
 ){

648 
	`mem˝y
(
z
, "0.0", 4);

650 
	`mem˝y
(
z
, "0", 2);

652  1+(
z
-
zOut
);

654 
zNum
 = 
	`ªndîI¡
(
x
.
m
, 
zBuf
, (zBuf));

655 
n
 = &
zBuf
[(zBuf)-1] - 
zNum
;

656 if–
x
.
e
>=0 && x.e+
n
<=25 ){

658 
	`mem˝y
(
z
, 
zNum
, 
n
+1);

659 
z
 +
n
;

660 if–
x
.
e
>0 ){

661 
	`mem˝y
(
z
, 
zîos
, 
x
.
e
);

662 
z
 +
x
.
e
;

663 
z
[0] = 0;

665 if–
bRól
 ){

666 
	`mem˝y
(
z
, ".0", 3);

667 
z
 += 2;

669  (
z
 - 
zOut
);

671 if–
x
.
e
<0 && 
n
+x.e > 0 ){

674 
m
 = 
n
+
x
.
e
;

675 
	`mem˝y
(
z
, 
zNum
, 
m
);

676 
z
 +
m
;

677 
zNum
 +
m
;

678 
n
 -
m
;

679 
	`ªmoveTøûögZîos
(
zNum
, &
n
);

680 if–
n
>0 ){

681 
z
[0] = '.';

682 
z
++;

683 
	`mem˝y
(
z
, 
zNum
, 
n
);

684 
z
 +
n
;

685 
z
[0] = 0;

687 if–
bRól
 ){

688 
	`mem˝y
(
z
, ".0", 3);

689 
z
 += 2;

691 
z
[0] = 0;

694  (
z
 - 
zOut
);

696 if–
x
.
e
<0 && x.ê>-
n
-5 ){

699 
j
 = -(
n
 + 
x
.
e
);

700 
	`mem˝y
(
z
, "0.", 2);

701 
z
 += 2;

702 if–
j
>0 ){

703 
	`mem˝y
(
z
, 
zîos
, 
j
);

704 
z
 +
j
;

706 
	`ªmoveTøûögZîos
(
zNum
, &
n
);

707 
	`mem˝y
(
z
, 
zNum
, 
n
);

708 
z
 +
n
;

709 
z
[0] = 0;

710  (
z
 - 
zOut
);

713 
z
[0] = 
zNum
[0];

714 
z
++;

715 if–
n
>1 ){

716 
nOrig
 = 
n
;

717 
	`ªmoveTøûögZîos
(
zNum
, &
n
);

718 
x
.
e
 +
nOrig
 - 
n
;

720 if–
n
!=1 ){

722 *
z
++ = '.';

723 
	`mem˝y
(
z
, 
zNum
+1, 
n
-1);

724 
z
 +
n
-1;

725 
x
.
e
 +
n
-1;

727 *
z
++ = 'e';

728 if–
x
.
e
<0 ){

729 *
z
++ = '-';

730 
x
.
e
 = -x.e;

732 *
z
++ = '+';

734 
zNum
 = 
	`ªndîI¡
(
x
.
e
&0x7fff, 
zBuf
, (zBuf));

735  (
z
[0] = 
zNum
[0])!=0 ){ z++; zNum++; }

736  (
z
-
zOut
);

737 
	}
}

	@src/mem.c

16 
	~"sqlôeI¡.h
"

55 #i‡!
deföed
(
HAVE_MALLOC_USABLE_SIZE
Ë&& 
SQLITE4_OS_WIN
 \

56 && !
	$deföed
(
SQLITE4_WITHOUT_MSIZE
)

57 
	#HAVE_MALLOC_USABLE_SIZE
 1

	)

58 
	#SQLITE4_MALLOCSIZE
 
_msize


	)

61 #i‡
	`deföed
(
__APPLE__
Ë&& !deföed(
SQLITE4_WITHOUT_ZONEMALLOC
)

67 
	~<sys/sys˘l.h
>

68 
	~<mÆloc/mÆloc.h
>

69 
	~<libkîn/OSAtomic.h
>

70 
mÆloc_z⁄e_t
* 
_sqlôeZ⁄e_
;

71 
	#SQLITE4_MALLOC
(
x
Ë
	`mÆloc_z⁄e_mÆloc
(
_sqlôeZ⁄e_
, (x))

	)

72 
	#SQLITE4_FREE
(
x
Ë
	`mÆloc_z⁄e_‰ì
(
_sqlôeZ⁄e_
, (x));

	)

73 
	#SQLITE4_REALLOC
(
x
,
y
Ë
	`mÆloc_z⁄e_ªÆloc
(
_sqlôeZ⁄e_
, (x), (y))

	)

74 
	#SQLITE4_MALLOCSIZE
(
x
) \

75 (
_sqlôeZ⁄e_
 ? _sqlôeZ⁄e_->
	`size
(_sqlôeZ⁄e_,
x
Ë: 
	`mÆloc_size
(x))

	)

83 
	#SQLITE4_MALLOC
(
x
Ë
	`mÆloc
(x)

	)

84 
	#SQLITE4_FREE
(
x
Ë
	`‰ì
(x)

	)

85 
	#SQLITE4_REALLOC
(
x
,
y
Ë
	`ªÆloc
((x),(y))

	)

87 #ifde‡
HAVE_MALLOC_USABLE_SIZE


88 #i‚de‡
SQLITE4_MALLOCSIZE


89 
	~<mÆloc.h
>

90 
	#SQLITE4_MALLOCSIZE
(
x
Ë
	`mÆloc_ußbÀ_size
(x)

	)

93 #unde‡
SQLITE4_MALLOCSIZE


101 *
	$mmSysMÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
iSize
){

102 #ifde‡
SQLITE4_MALLOCSIZE


103  
	`SQLITE4_MALLOC
(
iSize
);

105 *
pRes
 = 
	`SQLITE4_MALLOC
(
iSize
+8);

106 if–
pRes
 ){

107 *(
sqlôe4_size_t
*)
pRes
 = 
iSize
;

108 
pRes
 += 8;

110  
pRes
;

112 
	}
}

113 *
	$mmSysRóŒoc
(
sqlôe4_mm
 *
pMM
, *
pOld
, 
sqlôe4_size_t
 
iSz
){

114 #ifde‡
SQLITE4_MALLOCSIZE


115  
	`SQLITE4_REALLOC
(
pOld
, 
iSz
);

117 *
pRes
;

118 if–
pOld
==0 )  
	`mmSysMÆloc
(
pMM
, 
iSz
);

119 
pRes
 = (*)
pOld
;

120 
pRes
 -= 8;

121 
pRes
 = 
	`SQLITE4_REALLOC
’Res, 
iSz
+8);

122 if–
pRes
 ){

123 *(
sqlôe4_size_t
*)
pRes
 = 
iSz
;

124 
pRes
 += 8;

126  
pRes
;

128 
	}
}

129 
	$mmSysFªe
(
sqlôe4_mm
 *
pNŸU£d
, *
pOld
){

130 #ifde‡
SQLITE4_MALLOCSIZE


131 
	`SQLITE4_FREE
(
pOld
);

133 *
pRes
;

134 if–
pOld
==0 ) ;

135 
pRes
 = (*)
pOld
;

136 
pRes
 -= 8;

137 
	`SQLITE4_FREE
(
pRes
);

139 
	}
}

140 
sqlôe4_size_t
 
	$mmSysMsize
(
sqlôe4_mm
 *
pNŸU£d
, *
pOld
){

141 #ifde‡
SQLITE4_MALLOCSIZE


142  
	`SQLITE4_MALLOCSIZE
(
pOld
);

144 *
pX
;

145 if–
pOld
==0 )  0;

146 
pX
 = (*)
pOld
;

147 
pX
 -= 8;

148  *(
sqlôe4_size_t
*)
pX
;

150 
	}
}

152 c⁄° 
sqlôe4_mm_mëhods
 
	gmmSysMëhods
 = {

154  
mmSysMÆloc
,

155  
mmSysRóŒoc
,

156  
mmSysFªe
,

157  
mmSysMsize
,

164 
sqlôe4_mm
 
	gsqlôe4MMSy°em
 = {

165  &
mmSysMëhods


169 
sqlôe4_mm
 *
	$sqlôe4_mm_deÁu…
(){  &
sqlôe4MMSy°em
; 
	}
}

178 
	smmOvÊ
 {

179 
sqlôe4_mm
 
	mba£
;

180 (*
	mxMembîOfA
)(
	msqlôe4_mm
*, const *);

181 
sqlôe4_mm
 *
	mpA
;

182 
sqlôe4_mm
 *
	mpB
;

185 *
	$mmOvÊMÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
iSz
){

186 c⁄° 
mmOvÊ
 *
pOvÊ
 = (c⁄° mmOvÊ*)
pMM
;

187 *
pRes
;

188 
pRes
 = 
pOvÊ
->
pA
->
pMëhods
->
	`xMÆloc
’OvÊ->pA, 
iSz
);

189 if–
pRes
==0 ){

190 
pRes
 = 
pOvÊ
->
pB
->
pMëhods
->
	`xMÆloc
’OvÊ->pB, 
iSz
);

192  
pRes
;

193 
	}
}

194 *
	$mmOvÊRóŒoc
(
sqlôe4_mm
 *
pMM
, *
pOld
, 
sqlôe4_size_t
 
iSz
){

195 c⁄° 
mmOvÊ
 *
pOvÊ
;

196 *
pRes
, *
pA…
;

197 if–
pOld
==0 )  
	`mmOvÊMÆloc
(
pMM
, 
iSz
);

198 
pOvÊ
 = (c⁄° 
mmOvÊ
*)
pMM
;

199 if–
pOvÊ
->
	`xMembîOfA
’OvÊ->
pA
, 
pOld
) ){

200 
pRes
 = 
pOvÊ
->
pA
->
pMëhods
->
	`xRóŒoc
’OvÊ->pA, 
pOld
, 
iSz
);

201 if–
pRes
==0 && (
pA…
 = 
pOvÊ
->
pB
->
pMëhods
->
	`xMÆloc
’OvÊ->pB, 
iSz
))!=0 ){

202 
sqlôe4_size_t
 
nOld
 = 
pOvÊ
->
pA
->
pMëhods
->
	`xMsize
’OvÊ->pA, 
pOld
);

203 
	`as£π
–
nOld
<
iSz
 );

204 
	`mem˝y
(
pA…
, 
pOld
, (
size_t
)
nOld
);

205 
pOvÊ
->
pA
->
pMëhods
->
	`xFªe
’OvÊ->pA, 
pOld
);

206 
pRes
 = 
pA…
;

209 
pRes
 = 
pOvÊ
->
pB
->
pMëhods
->
	`xRóŒoc
’OvÊ->pB, 
pOld
, 
iSz
);

211  
pRes
;

212 
	}
}

213 
	$mmOvÊFªe
(
sqlôe4_mm
 *
pMM
, *
pOld
){

214 c⁄° 
mmOvÊ
 *
pOvÊ
;

215 if–
pOld
==0 ) ;

216 
pOvÊ
 = (c⁄° 
mmOvÊ
*)
pMM
;

217 if–
pOvÊ
->
	`xMembîOfA
’OvÊ->
pA
, 
pOld
) ){

218 
pOvÊ
->
pA
->
pMëhods
->
	`xFªe
’OvÊ->pA, 
pOld
);

220 
pOvÊ
->
pB
->
pMëhods
->
	`xFªe
’OvÊ->pB, 
pOld
);

222 
	}
}

223 
sqlôe4_size_t
 
	$mmOvÊMsize
(
sqlôe4_mm
 *
pMM
, *
pOld
){

224 c⁄° 
mmOvÊ
 *
pOvÊ
;

225 
sqlôe4_size_t
 
iSz
;

226 if–
pOld
==0 )  0;

227 
pOvÊ
 = (c⁄° 
mmOvÊ
*)
pMM
;

228 if–
pOvÊ
->
	`xMembîOfA
’OvÊ->
pA
, 
pOld
) ){

229 
iSz
 = 
	`sqlôe4_mm_msize
(
pOvÊ
->
pA
, 
pOld
);

231 
iSz
 = 
	`sqlôe4_mm_msize
(
pOvÊ
->
pB
, 
pOld
);

233  
iSz
;

234 
	}
}

235 
	$mmOvÊMembî
(
sqlôe4_mm
 *
pMM
, c⁄° *
pOld
){

236 c⁄° 
mmOvÊ
 *
pOvÊ
;

237 
iRes
;

238 if–
pOld
==0 )  0;

239 
pOvÊ
 = (c⁄° 
mmOvÊ
*)
pMM
;

240 if–
pOvÊ
->
	`xMembîOfA
’OvÊ->
pA
, 
pOld
) ){

241 
iRes
 = 1;

243 
iRes
 = 
	`sqlôe4_mm_membî
(
pOvÊ
->
pB
, 
pOld
);

245  
iRes
;

246 
	}
}

247 
	$mmOvÊBíign
(
sqlôe4_mm
 *
pMM
, 
bE«bÀ
){

248 
mmOvÊ
 *
pOvÊ
 = (mmOvÊ*)
pMM
;

249 
	`sqlôe4_mm_bíign_Áûuªs
(
pOvÊ
->
pA
, 
bE«bÀ
);

250 
	`sqlôe4_mm_bíign_Áûuªs
(
pOvÊ
->
pB
, 
bE«bÀ
);

251 
	}
}

252 
	$mmOvÊFöÆ
(
sqlôe4_mm
 *
pMM
){

253 
mmOvÊ
 *
pOvÊ
 = (mmOvÊ*)
pMM
;

254 
sqlôe4_mm
 *
pA
 = 
pOvÊ
->pA;

255 
sqlôe4_mm
 *
pB
 = 
pOvÊ
->pB;

256 
	`mmOvÊFªe
(
pMM
,ÖMM);

257 
	`sqlôe4_mm_de°roy
(
pA
);

258 
	`sqlôe4_mm_de°roy
(
pB
);

259 
	}
}

260 c⁄° 
sqlôe4_mm_mëhods
 
	gmmOvÊMëhods
 = {

262  
mmOvÊMÆloc
,

263  
mmOvÊRóŒoc
,

264  
mmOvÊFªe
,

265  
mmOvÊMsize
,

266  
mmOvÊMembî
,

267  
mmOvÊBíign
,

270  
mmOvÊFöÆ


272 
sqlôe4_mm
 *
	$mmOvÊNew
(
sqlôe4_mm
 *
pA
, sqlôe4_mm *
pB
){

273 
mmOvÊ
 *
pOvÊ
;

274 if–
pA
->
pMëhods
->
xMembî
==0 )  0;

275 
pOvÊ
 = 
	`sqlôe4_mm_mÆloc
(
pA
, (*pOvfl));

276 if–
pOvÊ
==0 ){

277 
pOvÊ
 = 
	`sqlôe4_mm_mÆloc
(
pB
, (*pOvfl));

279 if–
pOvÊ
 ){

280 
pOvÊ
->
ba£
.
pMëhods
 = &
mmOvÊMëhods
;

281 
pOvÊ
->
xMembîOfA
 = 
pA
->
pMëhods
->
xMembî
;

282 
pOvÊ
->
pA
 =ÖA;

283 
pOvÊ
->
pB
 =ÖB;

285  &
pOvÊ
->
ba£
;

286 
	}
}

296 
	#MM_STATS_NSTAT
 8

	)

298 
	smmSèts
 {

299 
sqlôe4_mm
 
	mba£
;

300 
sqlôe4_mm
 *
	mp
;

301 
sqlôe4_muãx
 *
	mmuãx
;

303 
i64
 
	mnOut
;

304 
i64
 
	mnOutHw
;

305 
i64
 
	mnUnô
;

306 
i64
 
	mnUnôHw
;

307 
i64
 
	mnMaxReque°
;

308 
i64
 
	mnFau…
;

311 
	$upd©eSètsMÆloc
(

312 
mmSèts
 *
pSèts
,

313 *
pNew
,

314 
sqlôe4_size_t
 
iSz


320 if–
iSz
>
pSèts
->
nMaxReque°
 ){

321 
pSèts
->
nMaxReque°
 = 
iSz
;

327 if–
pNew
 ){

328 
pSèts
->
nOut
 +
	`sqlôe4_mm_msize
’Sèts->
p
, 
pNew
);

329 
pSèts
->
nUnô
 += 1;

330 if–
pSèts
->
nOut
>pSèts->
nOutHw
 )ÖStats->nOutHw =ÖStats->nOut;

331 if–
pSèts
->
nUnô
>pSèts->
nUnôHw
 )ÖStats->nUnitHw =ÖStats->nUnit;

333 
pSèts
->
nFau…
++;

335 
	}
}

337 *
	$mmSètsMÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
iSz
){

338 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

339 *
pRë
;

341 
pRë
 = 
	`sqlôe4_mm_mÆloc
(
pSèts
->
p
, 
iSz
);

342 
	`sqlôe4_muãx_íãr
(
pSèts
->
muãx
);

343 
	`upd©eSètsMÆloc
(
pSèts
, 
pRë
, 
iSz
);

344 
	`sqlôe4_muãx_Àave
(
pSèts
->
muãx
);

345  
pRë
;

346 
	}
}

348 
	$mmSètsFªe
(
sqlôe4_mm
 *
pMM
, *
pOld
){

349 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

350 
	`sqlôe4_muãx_íãr
(
pSèts
->
muãx
);

351 if–
pOld
 ){

352 
sqlôe4_size_t
 
nByã
 = 
	`sqlôe4_mm_msize
(
pMM
, 
pOld
);

353 
pSèts
->
nOut
 -
nByã
;

354 
pSèts
->
nUnô
 -= 1;

356 
	`sqlôe4_muãx_Àave
(
pSèts
->
muãx
);

357 
	`sqlôe4_mm_‰ì
(
pSèts
->
p
, 
pOld
);

358 
	}
}

360 *
	$mmSètsRóŒoc
(
sqlôe4_mm
 *
pMM
, *
pOld
, 
sqlôe4_size_t
 
iSz
){

361 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

362 
sqlôe4_size_t
 
nOrig
 = (
pOld
 ? 
	`sqlôe4_mm_msize
(
pSèts
->
p
,ÖOld) : 0);

363 *
pRë
;

365 
pRë
 = 
	`sqlôe4_mm_ªÆloc
(
pSèts
->
p
, 
pOld
, 
iSz
);

367 
	`sqlôe4_muãx_íãr
(
pSèts
->
muãx
);

368 if–
pRë
 ){

369 
pSèts
->
nOut
 -
nOrig
;

370 if–
pOld
 ) 
pSèts
->
nUnô
--;

372 
	`upd©eSètsMÆloc
(
pSèts
, 
pRë
, 
iSz
);

373 
	`sqlôe4_muãx_Àave
(
pSèts
->
muãx
);

375  
pRë
;

376 
	}
}

378 
sqlôe4_size_t
 
	$mmSètsMsize
(
sqlôe4_mm
 *
pMM
, *
pOld
){

379 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

380  
	`sqlôe4_mm_msize
(
pSèts
->
p
, 
pOld
);

381 
	}
}

383 
	$mmSètsMembî
(
sqlôe4_mm
 *
pMM
, c⁄° *
pOld
){

384 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

385  
	`sqlôe4_mm_membî
(
pSèts
->
p
, 
pOld
);

386 
	}
}

391 
	$mmSètsBíign
(
sqlôe4_mm
 *
pMM
, 
bBíign
){

392 
mmSèts
 *
pSèts
 = (mmSèt†*)
pMM
;

393 
	`sqlôe4_mm_bíign_Áûuªs
(
pSèts
->
p
, 
bBíign
);

394 
	}
}

397 
sqlôe4_öt64
 
	$mmSètsSèt
(

398 
sqlôe4_mm
 *
pMM
,

399 
eTy≥
,

400 
Êags


402 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

403 
i64
 
iRë
 = 0;

404 
	`sqlôe4_muãx_íãr
(
pSèts
->
muãx
);

405  
eTy≥
 ){

406 
SQLITE4_MMSTAT_OUT
: {

407 
iRë
 = 
pSèts
->
nOut
;

410 
SQLITE4_MMSTAT_OUT_HW
: {

411 
iRë
 = 
pSèts
->
nOutHw
;

412 if–
Êags
 & 
SQLITE4_MMSTAT_RESET
 ) 
pSèts
->
nOutHw
 =ÖSèts->
nOut
;

415 
SQLITE4_MMSTAT_UNITS
: {

416 
iRë
 = 
pSèts
->
nUnô
;

419 
SQLITE4_MMSTAT_UNITS_HW
: {

420 
iRë
 = 
pSèts
->
nUnôHw
;

421 if–
Êags
 & 
SQLITE4_MMSTAT_RESET
 ) 
pSèts
->
nUnôHw
 =ÖSèts->
nUnô
;

424 
SQLITE4_MMSTAT_SIZE
: {

425 
iRë
 = 
pSèts
->
nMaxReque°
;

426 if–
Êags
 & 
SQLITE4_MMSTAT_RESET
 ) 
pSèts
->
nMaxReque°
 = 0;

429 
SQLITE4_MMSTAT_MEMFAULT
:

430 
SQLITE4_MMSTAT_FAULT
: {

431 
iRë
 = 
pSèts
->
nFau…
;

432 if–
Êags
 & 
SQLITE4_MMSTAT_RESET
 ) 
pSèts
->
nFau…
 = 0;

436 
	`sqlôe4_muãx_Àave
(
pSèts
->
muãx
);

437  
iRë
;

438 
	}
}

440 
	$mmSètsCål
(
sqlôe4_mm
 *
pMM
, 
eTy≥
, 
va_li°
 
≠
){

441 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

442  
	`sqlôe4_mm_c⁄åﬁ_va
(
pSèts
->
p
, 
eTy≥
, 
≠
);

443 
	}
}

448 
	$mmSètsFöÆ
(
sqlôe4_mm
 *
pMM
){

449 
mmSèts
 *
pSèts
 = (mmSèts*)
pMM
;

450 
sqlôe4_mm
 *
p
 = 
pSèts
->p;

451 
	`sqlôe4_mm_‰ì
(
p
, 
pSèts
);

452 
	`sqlôe4_mm_de°roy
(
p
);

453 
	}
}

455 c⁄° 
sqlôe4_mm_mëhods
 
	gmmSètsMëhods
 = {

457  
mmSètsMÆloc
,

458  
mmSètsRóŒoc
,

459  
mmSètsFªe
,

460  
mmSètsMsize
,

461  
mmSètsMembî
,

462  
mmSètsBíign
,

463  
mmSètsSèt
,

464  
mmSètsCål
,

465  
mmSètsFöÆ


471 
sqlôe4_mm
 *
	$mmSètsNew
(
sqlôe4_mm
 *
p
){

472 
mmSèts
 *
pNew
;

474 
pNew
 = (
mmSèts
 *)
	`sqlôe4_mm_mÆloc
(
p
, (*pNew));

475 if–
pNew
 ){

476 
	`mem£t
(
pNew
, 0, (*pNew));

477 
pNew
->
p
 =Ö;

478 
pNew
->
ba£
.
pMëhods
 = &
mmSètsMëhods
;

481  (
sqlôe4_mm
 *)
pNew
;

482 
	}
}

495 
	smmO√sz
 {

496 
sqlôe4_mm
 
	mba£
;

497 c⁄° *
	mpS∑˚
;

498 c⁄° *
	mpLa°
;

499 
mmO√szBlock
 *
	mpFªe
;

500 
	msz
;

501 
	mnFaûSize
;

502 
	mnFaûMem
;

503 
	mnSlŸ
;

504 
	mnU£d
;

505 
	mnU£dHw
;

506 
sqlôe4_size_t
 
	mmxSize
;

510 
	smmO√szBlock
 {

511 
mmO√szBlock
 *
	mpNext
;

514 *
	$mmO√szMÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
iSz
){

515 
mmO√sz
 *
pO√sz
 = (mmO√sz*)
pMM
;

516 *
pRes
;

517 if–
iSz
>
pO√sz
->
mxSize
 )ÖOnesz->mxSize = iSz;

518 if–
iSz
>
pO√sz
->
sz
 ){ÖO√sz->
nFaûSize
++;  0; }

519 if–
pO√sz
->
pFªe
==0 ){ÖO√sz->
nFaûMem
++;  0; }

520 
pO√sz
->
nU£d
++;

521 if–
pO√sz
->
nU£d
>pO√sz->
nU£dHw
 )ÖOnesz->nUsedHw =ÖOnesz->nUsed;

522 
pRes
 = 
pO√sz
->
pFªe
;

523 
pO√sz
->
pFªe
 =ÖO√sz->pFªe->
pNext
;

524  
pRes
;

525 
	}
}

526 
	$mmO√szFªe
(
sqlôe4_mm
 *
pMM
, *
pOld
){

527 
mmO√sz
 *
pO√sz
 = (mmO√sz*)
pMM
;

528 if–
pOld
 ){

529 
mmO√szBlock
 *
pBlock
 = (mmO√szBlock*)
pOld
;

530 
pBlock
->
pNext
 = 
pO√sz
->
pFªe
;

531 
pO√sz
->
pFªe
 = 
pBlock
;

532 
pO√sz
->
nU£d
--;

534 
	}
}

535 *
	$mmO√szRóŒoc
(
sqlôe4_mm
 *
pMM
, *
pOld
, 
sqlôe4_size_t
 
iSz
){

536 
mmO√sz
 *
pO√sz
 = (mmO√sz*)
pMM
;

537 if–
pOld
==0 )  
	`mmO√szMÆloc
(
pMM
, 
iSz
);

538 if–
iSz
<=0 ){

539 
	`mmO√szFªe
(
pMM
, 
pOld
);

542 if–
iSz
>
pO√sz
->
sz
 )  0;

543  
pOld
;

544 
	}
}

545 
sqlôe4_size_t
 
	$mmO√szMsize
(
sqlôe4_mm
 *
pMM
, *
pOld
){

546 
mmO√sz
 *
pO√sz
 = (mmO√sz*)
pMM
;

547  
pOld
 ? 
pO√sz
->
sz
 : 0;

548 
	}
}

549 
	$mmO√szMembî
(
sqlôe4_mm
 *
pMM
, c⁄° *
pOld
){

550 
mmO√sz
 *
pO√sz
 = (mmO√sz*)
pMM
;

551  
pOld
 &&ÖOld>=
pO√sz
->
pS∑˚
 &&ÖOld<ıO√sz->
pLa°
;

552 
	}
}

553 
sqlôe4_öt64
 
	$mmO√szSèt
(

554 
sqlôe4_mm
 *
pMM
,

555 
eTy≥
,

556 
Êgs


558 
mmO√sz
 *
pO√sz
 = (mmO√sz*)
pMM
;

559 
sqlôe4_öt64
 
x
 = -1;

560  
eTy≥
 ){

561 
SQLITE4_MMSTAT_OUT
: {

562 
x
 = 
pO√sz
->
nU£d
*pO√sz->
sz
;

565 
SQLITE4_MMSTAT_OUT_HW
: {

566 
x
 = 
pO√sz
->
nU£dHw
*pO√sz->
sz
;

567 if–
Êgs
 & 
SQLITE4_MMSTAT_RESET
 ) 
pO√sz
->
nU£dHw
 =ÖO√sz->
nU£d
;

570 
SQLITE4_MMSTAT_UNITS
: {

571 
x
 = 
pO√sz
->
nU£d
;

574 
SQLITE4_MMSTAT_UNITS_HW
: {

575 
x
 = 
pO√sz
->
nU£dHw
;

576 if–
Êgs
 & 
SQLITE4_MMSTAT_RESET
 ) 
pO√sz
->
nU£dHw
 =ÖO√sz->
nU£d
;

579 
SQLITE4_MMSTAT_SIZE
: {

580 
x
 = 
pO√sz
->
mxSize
;

581 if–
Êgs
 & 
SQLITE4_MMSTAT_RESET
 ) 
pO√sz
->
mxSize
 = 0;

584 
SQLITE4_MMSTAT_SZFAULT
: {

585 
x
 = 
pO√sz
->
nFaûSize
;

586 if–
Êgs
 & 
SQLITE4_MMSTAT_RESET
 ) 
pO√sz
->
nFaûSize
 = 0;

589 
SQLITE4_MMSTAT_MEMFAULT
: {

590 
x
 = 
pO√sz
->
nFaûMem
;

591 if–
Êgs
 & 
SQLITE4_MMSTAT_RESET
 ) 
pO√sz
->
nFaûMem
 = 0;

594 
SQLITE4_MMSTAT_FAULT
: {

595 
x
 = 
pO√sz
->
nFaûSize
 +ÖO√sz->
nFaûMem
;

596 if–
Êgs
 & 
SQLITE4_MMSTAT_RESET
 ){

597 
pO√sz
->
nFaûSize
 = 0;

598 
pO√sz
->
nFaûMem
 = 0;

603  
x
;

604 
	}
}

605 c⁄° 
sqlôe4_mm_mëhods
 
	gmmO√szMëhods
 = {

607  
mmO√szMÆloc
,

608  
mmO√szRóŒoc
,

609  
mmO√szFªe
,

610  
mmO√szMsize
,

611  
mmO√szMembî
,

613  
mmO√szSèt
,

617 
sqlôe4_mm
 *
	$mmO√szNew
(*
pS∑˚
, 
sz
, 
˙t
){

618 
mmO√sz
 *
pO√sz
;

619 *
pMem
;

620 
n
;

621 if–
sz
<(
mmO√szBlock
) )  0;

622 
pMem
 = (*)
pS∑˚
;

623 
pO√sz
 = (
mmO√sz
*)
pMem
;

624 
n
 = ((*
pO√sz
Ë+ 
sz
 - 1)/sz;

625 
pMem
 +
sz
*
n
;

626 
˙t
 -
n
;

627 if–
˙t
<2 )  0;

628 
	`mem£t
(
pO√sz
, 0, (*pOnesz));

629 
pO√sz
->
ba£
.
pMëhods
 = &
mmO√szMëhods
;

630 
pO√sz
->
pS∑˚
 = (c⁄° *)
pMem
;

631 
pO√sz
->
sz
 = sz;

632 
pO√sz
->
pLa°
 = (c⁄° *)(
pMem
 + 
sz
*(
˙t
-2));

633 
pO√sz
->
pFªe
 = 0;

634  
˙t
 ){

635 
mmO√szBlock
 *
pBlock
 = (mmO√szBlock*)
pMem
;

636 
pBlock
->
pNext
 = 
pO√sz
->
pFªe
;

637 
pO√sz
->
pFªe
 = 
pBlock
;

638 
˙t
--;

639 
pMem
 +
sz
;

641  &
pO√sz
->
ba£
;

642 
	}
}

647 *
	$sqlôe4_mm_mÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
iSize
){

648 if–
pMM
==0 )ÖMM = &
sqlôe4MMSy°em
;

649  
pMM
->
pMëhods
->
	`xMÆloc
’MM,
iSize
);

650 
	}
}

651 *
	$sqlôe4_mm_ªÆloc
(
sqlôe4_mm
 *
pMM
, *
pOld
, 
sqlôe4_size_t
 
iSize
){

652 if–
pMM
==0 )ÖMM = &
sqlôe4MMSy°em
;

653  
pMM
->
pMëhods
->
	`xRóŒoc
’MM,
pOld
,
iSize
);

654 
	}
}

655 
	$sqlôe4_mm_‰ì
(
sqlôe4_mm
 *
pMM
, *
pOld
){

656 if–
pMM
==0 )ÖMM = &
sqlôe4MMSy°em
;

657 
pMM
->
pMëhods
->
	`xFªe
’MM,
pOld
);

658 
	}
}

659 
sqlôe4_size_t
 
	$sqlôe4_mm_msize
(
sqlôe4_mm
 *
pMM
, *
pOld
){

660 if–
pMM
==0 )ÖMM = &
sqlôe4MMSy°em
;

661  
pMM
->
pMëhods
->
	`xMsize
’MM,
pOld
);

662 
	}
}

663 
	$sqlôe4_mm_membî
(
sqlôe4_mm
 *
pMM
, c⁄° *
pOld
){

664  (
pMM
 &&ÖMM->
pMëhods
->
xMembî
!=0) ?

665 
pMM
->
pMëhods
->
	`xMembî
’MM,
pOld
) : -1;

666 
	}
}

667 
	$sqlôe4_mm_bíign_Áûuªs
(
sqlôe4_mm
 *
pMM
, 
bE«bÀ
){

668 if–
pMM
 &&ÖMM->
pMëhods
->
xBíign
 ){

669 
pMM
->
pMëhods
->
	`xBíign
’MM, 
bE«bÀ
);

671 
	}
}

672 
sqlôe4_öt64
 
	$sqlôe4_mm_°©
(
sqlôe4_mm
 *
pMM
, 
eSètTy≥
, 
Êags
){

673 if–
pMM
==0 )  -1;

674 if–
pMM
->
pMëhods
->
xSèt
==0 )  -1;

675  
pMM
->
pMëhods
->
	`xSèt
’MM, 
eSètTy≥
, 
Êags
);

676 
	}
}

677 
	$sqlôe4_mm_c⁄åﬁ_va
(
sqlôe4_mm
 *
pMM
, 
eCålTy≥
, 
va_li°
 
≠
){

678 if–
pMM
==0 ||ÖMM->
pMëhods
->
xCål
==0 )  
SQLITE4_NOTFOUND
;

679  
pMM
->
pMëhods
->
	`xCål
’MM, 
eCålTy≥
, 
≠
);

680 
	}
}

681 
	$sqlôe4_mm_c⁄åﬁ
(
sqlôe4_mm
 *
pMM
, 
eCålTy≥
, ...){

682 
rc
;

683 
va_li°
 
≠
;

684 
	`va_°¨t
(
≠
, 
eCålTy≥
);

685 
rc
 = 
	`sqlôe4_mm_c⁄åﬁ_va
(
pMM
, 
eCålTy≥
, 
≠
);

686 
	`va_íd
(
≠
);

687  
rc
;

688 
	}
}

689 
	$sqlôe4_mm_de°roy
(
sqlôe4_mm
 *
pMM
){

690 if–
pMM
 &&ÖMM->
pMëhods
->
xFöÆ
 )ÖMM->pMëhods->
	`xFöÆ
(pMM);

691 
	}
}

697 
sqlôe4_mm
 *
	$sqlôe4_mm_√w
(
sqlôe4_mm_ty≥
 
eTy≥
, ...){

698 
va_li°
 
≠
;

699 
sqlôe4_mm
 *
pMM
;

701 
	`va_°¨t
(
≠
, 
eTy≥
);

702  
eTy≥
 ){

703 
SQLITE4_MM_SYSTEM
: {

704 
pMM
 = &
sqlôe4MMSy°em
;

707 
SQLITE4_MM_OVERFLOW
: {

708 
sqlôe4_mm
 *
pA
 = 
	`va_¨g
(
≠
, sqlite4_mm*);

709 
sqlôe4_mm
 *
pB
 = 
	`va_¨g
(
≠
, sqlite4_mm*);

710 
pMM
 = 
	`mmOvÊNew
(
pA
, 
pB
);

713 
SQLITE4_MM_ONESIZE
: {

714 *
pS∑˚
 = 
	`va_¨g
(
≠
, *);

715 
sz
 = 
	`va_¨g
(
≠
, );

716 
˙t
 = 
	`va_¨g
(
≠
, );

717 
pMM
 = 
	`mmO√szNew
(
pS∑˚
, 
sz
, 
˙t
);

720 
SQLITE4_MM_STATS
: {

721 
sqlôe4_mm
 *
p
 = 
	`va_¨g
(
≠
, sqlite4_mm*);

722 
pMM
 = 
	`mmSètsNew
(
p
);

726 
pMM
 = 0;

730 
	`va_íd
(
≠
);

731  
pMM
;

732 
	}
}

738 
	$sqlôe4_buf„r_öô
(
sqlôe4_buf„r
 *
pBuf
, 
sqlôe4_mm
 *
pMM
){

739 
	`mem£t
(
pBuf
, 0, (*pBuf));

740 
pBuf
->
pMM
 =ÖMM;

741 
	}
}

743 
	$sqlôe4_buf„r_ªsize
(
sqlôe4_buf„r
 *
pBuf
, 
sqlôe4_size_t
 
nReq
){

744 
sqlôe4_size_t
 
nCuºít
;

745 
nCuºít
 = 
	`sqlôe4_mm_msize
(
pBuf
->
pMM
,ÖBuf->
p
);

746 if–
nCuºít
<
nReq
 ){

747 *
pNew
 = 
	`sqlôe4_mm_ªÆloc
(
pBuf
->
pMM
,ÖBuf->
p
, 
nReq
);

748 if–
pNew
==0 )  
SQLITE4_NOMEM
;

749 
pBuf
->
p
 = 
pNew
;

751 
pBuf
->
n
 = 
nReq
;

752  
SQLITE4_OK
;

753 
	}
}

755 
	$sqlôe4_buf„r_≠≥nd
(

756 
sqlôe4_buf„r
 *
pBuf
,

757 c⁄° *
p
,

758 
sqlôe4_size_t
 
n


760 
rc
;

761 
sqlôe4_size_t
 
nOrig
 = 
pBuf
->
n
;

763 
rc
 = 
	`sqlôe4_buf„r_ªsize
(
pBuf
, 
nOrig
+
n
);

764 if–
rc
==
SQLITE4_OK
 ){

765 
	`mem˝y
(&((
u8
 *)
pBuf
->
p
)[
nOrig
],Ö, 
n
);

767  
rc
;

768 
	}
}

770 
	$sqlôe4_buf„r_£t
(

771 
sqlôe4_buf„r
 *
pBuf
,

772 c⁄° *
p
,

773 
sqlôe4_size_t
 
n


775 
pBuf
->
n
 = 0;

776  
	`sqlôe4_buf„r_≠≥nd
(
pBuf
, 
p
, 
n
);

777 
	}
}

779 
	$sqlôe4_buf„r_˛ór
(
sqlôe4_buf„r
 *
pBuf
){

780 
	`sqlôe4_mm_‰ì
(
pBuf
->
pMM
,ÖBuf->
p
);

781 
	`sqlôe4_buf„r_öô
(
pBuf
,ÖBuf->
pMM
);

782 
	}
}

	@src/mem.h

21 
sqlôe4_mm
 
	tsqlôe4_mm
;

22 
sqlôe4_mm_mëhods
 
	tsqlôe4_mm_mëhods
;

29 
	ssqlôe4_mm
 {

30 c⁄° 
sqlôe4_mm_mëhods
 *
	mpMëhods
;

37 
	mSQLITE4_MMSTAT_OUT
 = 1,

38 
	mSQLITE4_MMSTAT_UNITS
 = 2,

39 
	mSQLITE4_MMSTAT_SIZE
 = 3,

40 
	mSQLITE4_MMSTAT_SZFAULT
 = 4,

41 
	mSQLITE4_MMSTAT_MEMFAULT
 = 5,

42 
	mSQLITE4_MMSTAT_FAULT
 = 6,

48 
	#SQLITE4_MMSTAT_HIGHWATER
 0x01

	)

49 
	#SQLITE4_MMSTAT_RESET
 0x02

	)

50 
	#SQLITE4_MMSTAT_HWRESET
 0x03

	)

56 
	ssqlôe4_mm_mëhods
 {

57 
	miVîsi⁄
;

58 *(*
	mxMÆloc
)(
	msqlôe4_mm
*, 
	msqlôe4_öt64
);

59 *(*
	mxRóŒoc
)(
	msqlôe4_mm
*, *, 
	msqlôe4_öt64
);

60 (*
	mxFªe
)(
	msqlôe4_mm
*, *);

61 
sqlôe4_öt64
 (*
xMsize
)(
	msqlôe4_mm
*, *);

62 (*
	mxMembî
)(
	msqlôe4_mm
*, const *);

63 (*
	mxBíign
)(
	msqlôe4_mm
*, );

64 
sqlôe4_öt64
 (*
xSèt
)(
	msqlôe4_mm
*, 
	msqlôe4_mm_°©ty≥
, 
	mÊags
);

65 (*
	mxFöÆ
)(
	msqlôe4_mm
*);

72 
	mSQLITE4_MM_SYSTEM
 = 1,

73 
	mSQLITE4_MM_ONESIZE
 = 2,

74 
	mSQLITE4_MM_OVERFLOW
 = 3,

75 
	mSQLITE4_MM_COMPACT
 = 4,

76 
	mSQLITE4_MM_ROBSON
 = 5,

77 
	mSQLITE4_MM_LINEAR
 = 6,

78 
	mSQLITE4_MM_BESPOKE
 = 7,

79 
	mSQLITE4_MM_DEBUG
,

80 
	mSQLITE4_MM_STATS


81 } 
	tsqlôe4_mm_ty≥
;

86 
sqlôe4_mm
 *
sqlôe4_mm_√w
(
sqlôe4_mm_ty≥
, ...);

94 
sqlôe4_mm_de°roy
(
sqlôe4_mm
*);

99 *
sqlôe4_mm_mÆloc
(
sqlôe4_mm
*, 
sqlôe4_öt64
);

100 *
sqlôe4_mm_ªÆloc
(
sqlôe4_mm
*, *, 
sqlôe4_öt64
);

101 
sqlôe4_mm_‰ì
(
sqlôe4_mm
*, *);

112 
sqlôe4_öt64
 
sqlôe4_mm_msize
(
sqlôe4_mm
*, *);

121 
sqlôe4_mm_membî
(
sqlôe4_mm
 *
pMM
, c⁄° *
pOld
);

129 
sqlôe4_mm_bíign_Áûuªs
(
sqlôe4_mm
*, 
bE«bÀ
);

	@src/mem0.c

19 
	~"sqlôeI¡.h
"

26 #ifde‡
SQLITE4_ZERO_MALLOC


31 *
	$sqlôe4MemMÆloc
(*
p
, 
sqlôe4_size_t
 
nByã
){  0; 
	}
}

32 
	$sqlôe4MemFªe
(*
p
, *
pPri‹
){ ; 
	}
}

33 *
	$sqlôe4MemRóŒoc
(*
p
, *
pPri‹
, 
sqlôe4_size_t
 
nByã
){

35 
	}
}

36 
	$sqlôe4MemSize
(*
p
, *
pPri‹
){  0; 
	}
}

37 
	$sqlôe4MemInô
(*
NŸU£d
){  
SQLITE4_OK
; 
	}
}

38 
	$sqlôe4MemShutdown
(*
NŸU£d
){ ; 
	}
}

46 
	$sqlôe4MemSëDeÁu…
(
sqlôe4_ív
 *
pEnv
){

47 c⁄° 
sqlôe4_mem_mëhods
 
deÁu…Mëhods
 = {

48 
sqlôe4MemMÆloc
,

49 
sqlôe4MemFªe
,

50 
sqlôe4MemRóŒoc
,

51 
sqlôe4MemSize
,

52 
sqlôe4MemInô
,

53 
sqlôe4MemShutdown
,

58 
pEnv
->
m
 = 
deÁu…Mëhods
;

59 
pEnv
->
m
.
pMemEnv
 = (*)pEnv;

60 
	}
}

	@src/mem1.c

48 
	~"sqlôeI¡.h
"

55 #ifde‡
SQLITE4_SYSTEM_MALLOC


62 #i‡!
deföed
(
HAVE_MALLOC_USABLE_SIZE
Ë&& 
SQLITE4_OS_WIN
 \

63 && !
	$deföed
(
SQLITE4_WITHOUT_MSIZE
)

64 
	#HAVE_MALLOC_USABLE_SIZE
 1

	)

65 
	#SQLITE4_MALLOCSIZE
 
_msize


	)

68 #i‡
	`deföed
(
__APPLE__
Ë&& !deföed(
SQLITE4_WITHOUT_ZONEMALLOC
)

74 
	~<sys/sys˘l.h
>

75 
	~<mÆloc/mÆloc.h
>

76 
	~<libkîn/OSAtomic.h
>

77 
mÆloc_z⁄e_t
* 
_sqlôeZ⁄e_
;

78 
	#SQLITE4_MALLOC
(
x
Ë
	`mÆloc_z⁄e_mÆloc
(
_sqlôeZ⁄e_
, (x))

	)

79 
	#SQLITE4_FREE
(
x
Ë
	`mÆloc_z⁄e_‰ì
(
_sqlôeZ⁄e_
, (x));

	)

80 
	#SQLITE4_REALLOC
(
x
,
y
Ë
	`mÆloc_z⁄e_ªÆloc
(
_sqlôeZ⁄e_
, (x), (y))

	)

81 
	#SQLITE4_MALLOCSIZE
(
x
) \

82 (
_sqlôeZ⁄e_
 ? _sqlôeZ⁄e_->
	`size
(_sqlôeZ⁄e_,
x
Ë: 
	`mÆloc_size
(x))

	)

90 
	#SQLITE4_MALLOC
(
x
Ë
	`mÆloc
(x)

	)

91 
	#SQLITE4_FREE
(
x
Ë
	`‰ì
(x)

	)

92 
	#SQLITE4_REALLOC
(
x
,
y
Ë
	`ªÆloc
((x),(y))

	)

94 #ifde‡
HAVE_MALLOC_USABLE_SIZE


95 #i‚de‡
SQLITE4_MALLOCSIZE


96 
	~<mÆloc.h
>

97 
	#SQLITE4_MALLOCSIZE
(
x
Ë
	`mÆloc_ußbÀ_size
(x)

	)

100 #unde‡
SQLITE4_MALLOCSIZE


113 *
	$sqlôe4MemMÆloc
(*
NŸU£d
, 
sqlôe4_size_t
 
nByã
){

114 #ifde‡
SQLITE4_MALLOCSIZE


115 *
p
 = 
	`SQLITE4_MALLOC
–
nByã
 );

116 
	`UNUSED_PARAMETER
(
NŸU£d
);

117 if–
p
==0 ){

118 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

119 
	`sqlôe4_log
(0,
SQLITE4_NOMEM
, "ÁûedÅÿÆloˇã %u byã†o‡mem‹y", 
nByã
);

121  
p
;

123 
sqlôe4_öt64
 *
p
;

124 
	`as£π
–
nByã
>0 );

125 
	`UNUSED_PARAMETER
(
NŸU£d
);

126 
nByã
 = 
	`ROUND8
(nByte);

127 
p
 = 
	`SQLITE4_MALLOC
–
nByã
+8 );

128 if–
p
 ){

129 
p
[0] = 
nByã
;

130 
p
++;

132 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

133 
	`sqlôe4_log
(0,
SQLITE4_NOMEM
, "ÁûedÅÿÆloˇã %u byã†o‡mem‹y", 
nByã
);

135  (*)
p
;

137 
	}
}

147 
	$sqlôe4MemFªe
(*
NŸU£d
, *
pPri‹
){

148 #ifde‡
SQLITE4_MALLOCSIZE


149 
	`UNUSED_PARAMETER
(
NŸU£d
);

150 
	`SQLITE4_FREE
(
pPri‹
);

152 
sqlôe4_öt64
 *
p
 = (sqlôe4_öt64*)
pPri‹
;

153 
	`UNUSED_PARAMETER
(
NŸU£d
);

154 
	`as£π
–
pPri‹
!=0 );

155 
p
--;

156 
	`SQLITE4_FREE
(
p
);

158 
	}
}

164 
sqlôe4_size_t
 
	$sqlôe4MemSize
(*
NŸU£d
, *
pPri‹
){

165 #ifde‡
SQLITE4_MALLOCSIZE


166 
	`UNUSED_PARAMETER
(
NŸU£d
);

167  
pPri‹
 ? ()
	`SQLITE4_MALLOCSIZE
(pPrior) : 0;

169 
sqlôe4_öt64
 *
p
;

170 
	`UNUSED_PARAMETER
(
NŸU£d
);

171 if–
pPri‹
==0 )  0;

172 
p
 = (
sqlôe4_öt64
*)
pPri‹
;

173 
p
--;

174  (
sqlôe4_size_t
)
p
[0];

176 
	}
}

188 *
	$sqlôe4MemRóŒoc
(*
NŸU£d
, *
pPri‹
, 
nByã
){

189 #ifde‡
SQLITE4_MALLOCSIZE


190 *
p
 = 
	`SQLITE4_REALLOC
(
pPri‹
, 
nByã
);

191 
	`UNUSED_PARAMETER
(
NŸU£d
);

192 if–
p
==0 ){

193 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

194 
	`sqlôe4_log
(0,
SQLITE4_NOMEM
,

196 
	`SQLITE4_MALLOCSIZE
(
pPri‹
), 
nByã
);

198  
p
;

200 
sqlôe4_öt64
 *
p
 = (sqlôe4_öt64*)
pPri‹
;

201 
	`as£π
–
pPri‹
!=0 && 
nByã
>0 );

202 
	`as£π
–
nByã
==
	`ROUND8
(nByte) );

203 
	`UNUSED_PARAMETER
(
NŸU£d
);

204 
p
--;

205 
p
 = 
	`SQLITE4_REALLOC
’, 
nByã
+8 );

206 if–
p
 ){

207 
p
[0] = 
nByã
;

208 
p
++;

210 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

211 
	`sqlôe4_log
(0,
SQLITE4_NOMEM
,

213 
	`sqlôe4MemSize
(0, 
pPri‹
), 
nByã
);

215  (*)
p
;

217 
	}
}

222 
	$sqlôe4MemInô
(*
NŸU£d
){

223 #i‡
	`deföed
(
__APPLE__
Ë&& !deföed(
SQLITE4_WITHOUT_ZONEMALLOC
)

224 
˝uCou¡
;

225 
size_t
 
Àn
;

226 if–
_sqlôeZ⁄e_
 ){

227  
SQLITE4_OK
;

229 
Àn
 = (
˝uCou¡
);

231 
	`sys˘lby«me
("hw.n˝u", &
˝uCou¡
, &
Àn
, 
NULL
, 0);

232 if–
˝uCou¡
>1 ){

234 
_sqlôeZ⁄e_
 = 
	`mÆloc_deÁu…_z⁄e
();

238 
boﬁ
 
suc˚ss
;

239 
mÆloc_z⁄e_t
* 
√wz⁄e
 = 
	`mÆloc_¸óã_z⁄e
(4096, 0);

240 
	`mÆloc_£t_z⁄e_«me
(
√wz⁄e
, "Sqlite_Heap");

242 
suc˚ss
 = 
	`OSAtomicCom∑ªAndSw≠PåB¨rõr
(
NULL
, 
√wz⁄e
,

243 (* vﬁ©ûê*)&
_sqlôeZ⁄e_
);

244 }!
_sqlôeZ⁄e_
);

245 if–!
suc˚ss
 ){

247 
	`mÆloc_de°roy_z⁄e
(
√wz⁄e
);

251 
	`UNUSED_PARAMETER
(
NŸU£d
);

252  
SQLITE4_OK
;

253 
	}
}

258 
	$sqlôe4MemShutdown
(*
NŸU£d
){

259 
	`UNUSED_PARAMETER
(
NŸU£d
);

261 
	}
}

269 
	$sqlôe4MemSëDeÁu…
(
sqlôe4_ív
 *
pEnv
){

270 c⁄° 
sqlôe4_mem_mëhods
 
deÁu…Mëhods
 = {

271 
sqlôe4MemMÆloc
,

272 
sqlôe4MemFªe
,

273 
sqlôe4MemRóŒoc
,

274 
sqlôe4MemSize
,

275 
sqlôe4MemInô
,

276 
sqlôe4MemShutdown
,

282 
pEnv
->
m
 = 
deÁu…Mëhods
;

283 
pEnv
->
m
.
pMemEnv
 = (*)pEnv;

285 
	}
}

	@src/mem2.c

22 
	~"sqlôeI¡.h
"

28 #ifde‡
SQLITE4_MEMDEBUG


33 #ifde‡
__GLIBC__


34 
backåa˚
(**,);

35 
backåa˚_symbﬁs_fd
(*const*,,);

37 
	#backåa˚
(
A
,
B
Ë1

	)

38 
	#backåa˚_symbﬁs_fd
(
A
,
B
,
C
)

	)

40 
	~<°dio.h
>

55 
	sMemBlockHdr
 {

56 
i64
 
	miSize
;

57 
MemBlockHdr
 *
	mpNext
, *
	mpPªv
;

58 
	mnBackåa˚
;

59 
	mnBackåa˚SlŸs
;

60 
u8
 
	mnTôÀ
;

61 
u8
 
	meTy≥
;

62 
	miF‹eGu¨d
;

68 
	#FOREGUARD
 0x80F5E153

	)

69 
	#REARGUARD
 0xE4676B53

	)

74 
	#NCSIZE
 1000

	)

87 
sqlôe4_muãx
 *
	mmuãx
;

92 
MemBlockHdr
 *
	mpFú°
;

93 
MemBlockHdr
 *
	mpLa°
;

98 
	mnBackåa˚
;

99 (*
	mxBackåa˚
)(, , **);

104 
	mnTôÀ
;

105 
	mzTôÀ
[100];

111 
	mdißŒow
;

119 
	mnAŒoc
[
NCSIZE
];

120 
	mnCuºít
[
NCSIZE
];

121 
	mmxCuºít
[
NCSIZE
];

123 } 
	gmem2
;

129 
	$adju°Sèts
(
iSize
, 
ö¸emít
){

130 
i
 = 
	`ROUND8
(
iSize
)/8;

131 if–
i
>
NCSIZE
-1 ){

132 
i
 = 
NCSIZE
 - 1;

134 if–
ö¸emít
>0 ){

135 
mem2
.
nAŒoc
[
i
]++;

136 
mem2
.
nCuºít
[
i
]++;

137 if–
mem2
.
nCuºít
[
i
]>mem2.
mxCuºít
[i] ){

138 
mem2
.
mxCuºít
[
i
] = mem2.
nCuºít
[i];

141 
mem2
.
nCuºít
[
i
]--;

142 
	`as£π
–
mem2
.
nCuºít
[
i
]>=0 );

144 
	}
}

152 
MemBlockHdr
 *
	$sqlôe4MemsysGëHódî
(*
pAŒoˇti⁄
){

153 
MemBlockHdr
 *
p
;

154 *
pI¡
;

155 
u8
 *
pU8
;

156 
nRe£rve
;

158 
p
 = (
MemBlockHdr
*)
pAŒoˇti⁄
;

159 
p
--;

160 
	`as£π
–
p
->
iF‹eGu¨d
==()
FOREGUARD
 );

161 
nRe£rve
 = 
	`ROUND8
(
p
->
iSize
);

162 
pI¡
 = (*)
pAŒoˇti⁄
;

163 
pU8
 = (
u8
*)
pAŒoˇti⁄
;

164 
	`as£π
–
pI¡
[
nRe£rve
/()]==()
REARGUARD
 );

169  
nRe£rve
-- > 
p
->
iSize
 ) 
	`as£π
–
pU8
[nReserve]==0x65 );

170  
p
;

171 
	}
}

176 
	$sqlôe4MemSize
(*
pMem
, *
p
){

177 
MemBlockHdr
 *
pHdr
;

178 
	`as£π
–
pMem
==(*)&
mem2
 );

179 if–!
p
 ){

182 
pHdr
 = 
	`sqlôe4MemsysGëHódî
(
p
);

183  
pHdr
->
iSize
;

184 
	}
}

189 
	$sqlôe4MemInô
(*
pMÆlocEnv
){

190 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív*)
pMÆlocEnv
;

191 
rc
 = 
SQLITE4_OK
;

192 
	`as£π
–((
MemBlockHdr
)&7) == 0 );

193 if–!
pEnv
->
bMem°©
 ){

194 
mem2
.
muãx
 = 
	`sqlôe4MuãxAŒoc
(
pEnv
, 
SQLITE4_MUTEX_FAST
);

195 if–
mem2
.
muãx
==0 && 
pEnv
->
bC‹eMuãx
 ) 
rc
 = 
SQLITE4_NOMEM
;

197  
rc
;

198 
	}
}

203 
	$sqlôe4MemShutdown
(*
NŸU£d
){

204 
	`UNUSED_PARAMETER
(
NŸU£d
);

205 
	`sqlôe4_muãx_‰ì
(
mem2
.
muãx
);

206 
mem2
.
muãx
 = 0;

207 
	}
}

214 
	$øndomFûl
(*
pBuf
, 
nByã
){

215 
x
, 
y
, 
r
;

216 
x
 = 
	`SQLITE4_PTR_TO_INT
(
pBuf
);

217 
y
 = 
nByã
 | 1;

218  
nByã
 >= 4 ){

219 
x
 = (x>>1) ^ (-(x&1) & 0xd0000001);

220 
y
 = y*1103515245 + 12345;

221 
r
 = 
x
 ^ 
y
;

222 *(*)
pBuf
 = 
r
;

223 
pBuf
 += 4;

224 
nByã
 -= 4;

226  
nByã
-- > 0 ){

227 
x
 = (x>>1) ^ (-(x&1) & 0xd0000001);

228 
y
 = y*1103515245 + 12345;

229 
r
 = 
x
 ^ 
y
;

230 *(
pBuf
++Ë
r
 & 0xff;

232 
	}
}

237 *
	$sqlôe4MemMÆloc
(*
pMem
, 
sqlôe4_size_t
 
nByã
){

238 
MemBlockHdr
 *
pHdr
;

239 **
pBt
;

240 *
z
;

241 *
pI¡
;

242 *
p
 = 0;

243 
tŸÆSize
;

244 
nRe£rve
;

245 
	`sqlôe4_muãx_íãr
(
mem2
.
muãx
);

246 
	`as£π
–
mem2
.
dißŒow
==0 );

247 
nRe£rve
 = 
	`ROUND8
(
nByã
);

248 
tŸÆSize
 = 
nRe£rve
 + (*
pHdr
) + () +

249 
mem2
.
nBackåa˚
*(*Ë+ mem2.
nTôÀ
;

250 
	`as£π
–
pMem
==(*)&
mem2
 );

251 
p
 = 
	`mÆloc
(
tŸÆSize
);

252 if–
p
 ){

253 
z
 = 
p
;

254 
pBt
 = (**)&
z
[
mem2
.
nTôÀ
];

255 
pHdr
 = (
MemBlockHdr
*)&
pBt
[
mem2
.
nBackåa˚
];

256 
pHdr
->
pNext
 = 0;

257 
pHdr
->
pPªv
 = 
mem2
.
pLa°
;

258 if–
mem2
.
pLa°
 ){

259 
mem2
.
pLa°
->
pNext
 = 
pHdr
;

261 
mem2
.
pFú°
 = 
pHdr
;

263 
mem2
.
pLa°
 = 
pHdr
;

264 
pHdr
->
iF‹eGu¨d
 = 
FOREGUARD
;

265 
pHdr
->
eTy≥
 = 
MEMTYPE_HEAP
;

266 
pHdr
->
nBackåa˚SlŸs
 = 
mem2
.
nBackåa˚
;

267 
pHdr
->
nTôÀ
 = 
mem2
.nTitle;

268 if–
mem2
.
nBackåa˚
 ){

269 *
aAddr
[40];

270 
pHdr
->
nBackåa˚
 = 
	`backåa˚
(
aAddr
, 
mem2
.nBacktrace+1)-1;

271 
	`mem˝y
(
pBt
, &
aAddr
[1], 
pHdr
->
nBackåa˚
*(*));

272 
	`as£π
(
pBt
[0]);

273 if–
mem2
.
xBackåa˚
 ){

274 
mem2
.
	`xBackåa˚
(
nByã
, 
pHdr
->
nBackåa˚
-1, &
aAddr
[1]);

277 
pHdr
->
nBackåa˚
 = 0;

279 if–
mem2
.
nTôÀ
 ){

280 
	`mem˝y
(
z
, 
mem2
.
zTôÀ
, mem2.
nTôÀ
);

282 
pHdr
->
iSize
 = 
nByã
;

283 
	`adju°Sèts
(
nByã
, +1);

284 
pI¡
 = (*)&
pHdr
[1];

285 
pI¡
[
nRe£rve
/()] = 
REARGUARD
;

286 
	`øndomFûl
((*)
pI¡
, 
nByã
);

287 
	`mem£t
(((*)
pI¡
)+
nByã
, 0x65, 
nRe£rve
-nByte);

288 
p
 = (*)
pI¡
;

290 
	`sqlôe4_muãx_Àave
(
mem2
.
muãx
);

291  
p
;

292 
	}
}

297 
	$sqlôe4MemFªe
(*
pMem
, *
pPri‹
){

298 
MemBlockHdr
 *
pHdr
;

299 **
pBt
;

300 *
z
;

301 
	`as£π
–
pMem
==(*)&
mem2
 );

302 
	`as£π
–
sqlôe4DeÁu…Env
.
bMem°©
 || sqlôe4DeÁu…Env.
bC‹eMuãx
==0

303 || 
mem2
.
muãx
!=0 );

304 
pHdr
 = 
	`sqlôe4MemsysGëHódî
(
pPri‹
);

305 
pBt
 = (**)
pHdr
;

306 
pBt
 -
pHdr
->
nBackåa˚SlŸs
;

307 
	`sqlôe4_muãx_íãr
(
mem2
.
muãx
);

308 if–
pHdr
->
pPªv
 ){

309 
	`as£π
–
pHdr
->
pPªv
->
pNext
==pHdr );

310 
pHdr
->
pPªv
->
pNext
 =ÖHdr->pNext;

312 
	`as£π
–
mem2
.
pFú°
==
pHdr
 );

313 
mem2
.
pFú°
 = 
pHdr
->
pNext
;

315 if–
pHdr
->
pNext
 ){

316 
	`as£π
–
pHdr
->
pNext
->
pPªv
==pHdr );

317 
pHdr
->
pNext
->
pPªv
 =ÖHdr->pPrev;

319 
	`as£π
–
mem2
.
pLa°
==
pHdr
 );

320 
mem2
.
pLa°
 = 
pHdr
->
pPªv
;

322 
z
 = (*)
pBt
;

323 
z
 -
pHdr
->
nTôÀ
;

324 
	`adju°Sèts
(
pHdr
->
iSize
, -1);

325 
	`øndomFûl
(
z
, (*)*
pHdr
->
nBackåa˚SlŸs
 + (*pHdr) +

326 
pHdr
->
iSize
 + (Ë+ÖHdr->
nTôÀ
);

327 
	`‰ì
(
z
);

328 
	`sqlôe4_muãx_Àave
(
mem2
.
muãx
);

329 
	}
}

340 *
	$sqlôe4MemRóŒoc
(*
p
, *
pPri‹
, 
sqlôe4_size_t
 
nByã
){

341 
MemBlockHdr
 *
pOldHdr
;

342 *
pNew
;

343 
	`as£π
–
p
==(*)&
mem2
 );

344 
	`as£π
–
mem2
.
dißŒow
==0 );

345 
	`as£π
–(
nByã
 & 7)==0 );

346 
pOldHdr
 = 
	`sqlôe4MemsysGëHódî
(
pPri‹
);

347 
pNew
 = 
	`sqlôe4MemMÆloc
(
p
, 
nByã
);

348 if–
pNew
 ){

349 
	`mem˝y
(
pNew
, 
pPri‹
, 
nByã
<
pOldHdr
->
iSize
 ?ÇByte :ÖOldHdr->iSize);

350 if–
nByã
>
pOldHdr
->
iSize
 ){

351 
	`øndomFûl
(&((*)
pNew
)[
pOldHdr
->
iSize
], 
nByã
 -ÖOldHdr->iSize);

353 
	`sqlôe4MemFªe
(
p
, 
pPri‹
);

355  
pNew
;

356 
	}
}

362 
	$sqlôe4MemSëDeÁu…
(
sqlôe4_ív
 *
pEnv
){

363 c⁄° 
sqlôe4_mem_mëhods
 
deÁu…Mëhods
 = {

364 
sqlôe4MemMÆloc
,

365 
sqlôe4MemFªe
,

366 
sqlôe4MemRóŒoc
,

367 
sqlôe4MemSize
,

368 
sqlôe4MemInô
,

369 
sqlôe4MemShutdown
,

372 &
mem2


374 
pEnv
->
m
 = 
deÁu…Mëhods
;

375 
	}
}

380 
	$sqlôe4MemdebugSëTy≥
(*
p
, 
u8
 
eTy≥
){

381 if–
p
 && 
sqlôe4DeÁu…Env
.
m
.
xMÆloc
==
sqlôe4MemMÆloc
 ){

382 
MemBlockHdr
 *
pHdr
;

383 
pHdr
 = 
	`sqlôe4MemsysGëHódî
(
p
);

384 
	`as£π
–
pHdr
->
iF‹eGu¨d
==
FOREGUARD
 );

385 
pHdr
->
eTy≥
 =ÉType;

387 
	}
}

398 
	$sqlôe4MemdebugHasTy≥
(c⁄° *
p
, 
u8
 
eTy≥
){

399 
rc
 = 1;

400 if–
p
 && 
sqlôe4DeÁu…Env
.
m
.
xMÆloc
==
sqlôe4MemMÆloc
 ){

401 
MemBlockHdr
 *
pHdr
;

402 
pHdr
 = 
	`sqlôe4MemsysGëHódî
((*)
p
);

403 
	`as£π
–
pHdr
->
iF‹eGu¨d
==
FOREGUARD
 );

404 if–(
pHdr
->
eTy≥
&eType)==0 ){

405 
rc
 = 0;

408  
rc
;

409 
	}
}

420 
	$sqlôe4MemdebugNoTy≥
(c⁄° *
p
, 
u8
 
eTy≥
){

421 
rc
 = 1;

422 if–
p
 && 
sqlôe4DeÁu…Env
.
m
.
xMÆloc
==
sqlôe4MemMÆloc
 ){

423 
MemBlockHdr
 *
pHdr
;

424 
pHdr
 = 
	`sqlôe4MemsysGëHódî
((*)
p
);

425 
	`as£π
–
pHdr
->
iF‹eGu¨d
==
FOREGUARD
 );

426 if–(
pHdr
->
eTy≥
&eType)!=0 ){

427 
rc
 = 0;

430  
rc
;

431 
	}
}

438 
	$sqlôe4MemdebugBackåa˚
(
dïth
){

439 if–
dïth
<0 ){ depth = 0; }

440 if–
dïth
>20 ){ depth = 20; }

441 
dïth
 = (depth+1)&0xfe;

442 
mem2
.
nBackåa˚
 = 
dïth
;

443 
	}
}

445 
sqlôe4MemdebugBackåa˚CÆlback
((*
xBackåa˚
)(, , **)){

446 
mem2
.
xBackåa˚
 = xBacktrace;

447 
	}
}

452 
	$sqlôe4MemdebugSëtôÀ
(c⁄° *
zTôÀ
){

453 
n
 = 
	`sqlôe4SåÀn30
(
zTôÀ
) + 1;

454 
	`sqlôe4_muãx_íãr
(
mem2
.
muãx
);

455 if–
n
>=(
mem2
.
zTôÀ
) )Ç = (mem2.zTitle)-1;

456 
	`mem˝y
(
mem2
.
zTôÀ
, zTôÀ, 
n
);

457 
mem2
.
zTôÀ
[
n
] = 0;

458 
mem2
.
nTôÀ
 = 
	`ROUND8
(
n
);

459 
	`sqlôe4_muãx_Àave
(
mem2
.
muãx
);

460 
	}
}

462 
	$sqlôe4MemdebugSync
(){

463 
MemBlockHdr
 *
pHdr
;

464 
pHdr
=
mem2
.
pFú°
;ÖHdr;ÖHdrıHdr->
pNext
){

465 **
pBt
 = (**)
pHdr
;

466 
pBt
 -
pHdr
->
nBackåa˚SlŸs
;

467 
mem2
.
	`xBackåa˚
(
pHdr
->
iSize
,ÖHdr->
nBackåa˚
-1, &
pBt
[1]);

469 
	}
}

475 
	$sqlôe4MemdebugDump
(c⁄° *
zFûíame
){

476 
FILE
 *
out
;

477 
MemBlockHdr
 *
pHdr
;

478 **
pBt
;

479 
i
;

480 
out
 = 
	`f›í
(
zFûíame
, "w");

481 if–
out
==0 ){

482 
	`Ârötf
(
°dîr
, "** UnableÅo output memory debug outputÜog: %s **\n",

483 
zFûíame
);

486 
pHdr
=
mem2
.
pFú°
;ÖHdr;ÖHdrıHdr->
pNext
){

487 *
z
 = (*)
pHdr
;

488 
z
 -
pHdr
->
nBackåa˚SlŸs
*(*Ë+ÖHdr->
nTôÀ
;

489 
	`Ârötf
(
out
, "**** %lld bytesát %p from %s ****\n",

490 
pHdr
->
iSize
, &pHdr[1],ÖHdr->
nTôÀ
 ? 
z
 : "???");

491 if–
pHdr
->
nBackåa˚
 ){

492 
	`fÊush
(
out
);

493 
pBt
 = (**)
pHdr
;

494 
pBt
 -
pHdr
->
nBackåa˚SlŸs
;

495 
	`backåa˚_symbﬁs_fd
(
pBt
, 
pHdr
->
nBackåa˚
, 
	`fûío
(
out
));

496 
	`Ârötf
(
out
, "\n");

499 
	`Ârötf
(
out
, "COUNTS:\n");

500 
i
=0; i<
NCSIZE
-1; i++){

501 if–
mem2
.
nAŒoc
[
i
] ){

502 
	`Ârötf
(
out
, " %5d: %10d %10d %10d\n",

503 
i
*8, 
mem2
.
nAŒoc
[i], mem2.
nCuºít
[i], mem2.
mxCuºít
[i]);

506 if–
mem2
.
nAŒoc
[
NCSIZE
-1] ){

507 
	`Ârötf
(
out
, " %5d: %10d %10d %10d\n",

508 
NCSIZE
*8-8, 
mem2
.
nAŒoc
[NCSIZE-1],

509 
mem2
.
nCuºít
[
NCSIZE
-1], mem2.
mxCuºít
[NCSIZE-1]);

511 
	`f˛o£
(
out
);

512 
	}
}

517 
	$sqlôe4MemdebugMÆlocCou¡
(){

518 
i
;

519 
nTŸÆ
 = 0;

520 
i
=0; i<
NCSIZE
; i++){

521 
nTŸÆ
 +
mem2
.
nAŒoc
[
i
];

523  
nTŸÆ
;

524 
	}
}

	@src/mem3.c

26 
	~"sqlôeI¡.h
"

35 #ifde‡
SQLITE4_ENABLE_MEMSYS3


40 
	#MX_SMALL
 10

	)

46 
	#N_HASH
 61

	)

80 
Mem3Block
 
	tMem3Block
;

81 
	sMem3Block
 {

84 
u32
 
	m¥evSize
;

85 
u32
 
	msize4x
;

86 } 
	mhdr
;

88 
u32
 
	m√xt
;

89 
u32
 
	m¥ev
;

90 } 
	mli°
;

91 } 
	mu
;

100 
SQLITE4_WSD
 
	sMem3GlobÆ
 {

105 
u32
 
	mnPoﬁ
;

106 
Mem3Block
 *
	maPoﬁ
;

111 
	mÆ¨mBusy
;

116 
sqlôe4_muãx
 *
	mmuãx
;

121 
u32
 
	mmnMa°î
;

129 
u32
 
	miMa°î
;

130 
u32
 
	mszMa°î
;

137 
u32
 
	maiSmÆl
[
MX_SMALL
-1];

138 
u32
 
	maiHash
[
N_HASH
];

139 } 
	gmem3
 = { 97535575 };

145 
	$memsys3U∆ökFromLi°
(
u32
 
i
, u32 *
pRoŸ
){

146 
u32
 
√xt
 = 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.next;

147 
u32
 
¥ev
 = 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.prev;

148 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

149 if–
¥ev
==0 ){

150 *
pRoŸ
 = 
√xt
;

152 
mem3
.
aPoﬁ
[
¥ev
].
u
.
li°
.
√xt
 =Çext;

154 if–
√xt
 ){

155 
mem3
.
aPoﬁ
[
√xt
].
u
.
li°
.
¥ev
 =Örev;

157 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.
√xt
 = 0;

158 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.
¥ev
 = 0;

159 
	}
}

165 
	$memsys3U∆ök
(
u32
 
i
){

166 
u32
 
size
, 
hash
;

167 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

168 
	`as£π
–(
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
 & 1)==0 );

169 
	`as£π
–
i
>=1 );

170 
size
 = 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
/4;

171 
	`as£π
–
size
==
mem3
.
aPoﬁ
[
i
+size-1].
u
.
hdr
.
¥evSize
 );

172 
	`as£π
–
size
>=2 );

173 if–
size
 <
MX_SMALL
 ){

174 
	`memsys3U∆ökFromLi°
(
i
, &
mem3
.
aiSmÆl
[
size
-2]);

176 
hash
 = 
size
 % 
N_HASH
;

177 
	`memsys3U∆ökFromLi°
(
i
, &
mem3
.
aiHash
[
hash
]);

179 
	}
}

185 
	$memsys3LökI¡oLi°
(
u32
 
i
, u32 *
pRoŸ
){

186 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

187 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.
√xt
 = *
pRoŸ
;

188 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.
¥ev
 = 0;

189 if–*
pRoŸ
 ){

190 
mem3
.
aPoﬁ
[*
pRoŸ
].
u
.
li°
.
¥ev
 = 
i
;

192 *
pRoŸ
 = 
i
;

193 
	}
}

199 
	$memsys3Lök
(
u32
 
i
){

200 
u32
 
size
, 
hash
;

201 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

202 
	`as£π
–
i
>=1 );

203 
	`as£π
–(
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
 & 1)==0 );

204 
size
 = 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
/4;

205 
	`as£π
–
size
==
mem3
.
aPoﬁ
[
i
+size-1].
u
.
hdr
.
¥evSize
 );

206 
	`as£π
–
size
>=2 );

207 if–
size
 <
MX_SMALL
 ){

208 
	`memsys3LökI¡oLi°
(
i
, &
mem3
.
aiSmÆl
[
size
-2]);

210 
hash
 = 
size
 % 
N_HASH
;

211 
	`memsys3LökI¡oLi°
(
i
, &
mem3
.
aiHash
[
hash
]);

213 
	}
}

220 
	$memsys3E¡î
(){

221 if–
sqlôe4DeÁu…Env
.
bMem°©
==0 && 
mem3
.
muãx
==0 ){

222 
mem3
.
muãx
 = 
	`sqlôe4MuãxAŒoc
(
SQLITE4_MUTEX_STATIC_MEM
);

224 
	`sqlôe4_muãx_íãr
(
mem3
.
muãx
);

225 
	}
}

226 
	$memsys3Lóve
(){

227 
	`sqlôe4_muãx_Àave
(
mem3
.
muãx
);

228 
	}
}

233 
	$memsys3OutOfMem‹y
(
nByã
){

234 if–!
mem3
.
Æ¨mBusy
 ){

235 
mem3
.
Æ¨mBusy
 = 1;

236 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

237 
	`sqlôe4_muãx_Àave
(
mem3
.
muãx
);

238 
	`sqlôe4_ªÀa£_mem‹y
(
nByã
);

239 
	`sqlôe4_muãx_íãr
(
mem3
.
muãx
);

240 
mem3
.
Æ¨mBusy
 = 0;

242 
	}
}

250 *
	$memsys3Checkout
(
u32
 
i
, u32 
nBlock
){

251 
u32
 
x
;

252 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

253 
	`as£π
–
i
>=1 );

254 
	`as£π
–
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
/4==
nBlock
 );

255 
	`as£π
–
mem3
.
aPoﬁ
[
i
+
nBlock
-1].
u
.
hdr
.
¥evSize
==nBlock );

256 
x
 = 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
;

257 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
 = 
nBlock
*4 | 1 | (
x
&2);

258 
mem3
.
aPoﬁ
[
i
+
nBlock
-1].
u
.
hdr
.
¥evSize
 =ÇBlock;

259 
mem3
.
aPoﬁ
[
i
+
nBlock
-1].
u
.
hdr
.
size4x
 |= 2;

260  &
mem3
.
aPoﬁ
[
i
];

261 
	}
}

268 *
	$memsys3FromMa°î
(
u32
 
nBlock
){

269 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

270 
	`as£π
–
mem3
.
szMa°î
>=
nBlock
 );

271 if–
nBlock
>=
mem3
.
szMa°î
-1 ){

273 *
p
 = 
	`memsys3Checkout
(
mem3
.
iMa°î
, mem3.
szMa°î
);

274 
mem3
.
iMa°î
 = 0;

275 
mem3
.
szMa°î
 = 0;

276 
mem3
.
mnMa°î
 = 0;

277  
p
;

280 
u32
 
√wi
, 
x
;

281 
√wi
 = 
mem3
.
iMa°î
 + mem3.
szMa°î
 - 
nBlock
;

282 
	`as£π
–
√wi
 > 
mem3
.
iMa°î
+1 );

283 
mem3
.
aPoﬁ
[mem3.
iMa°î
+mem3.
szMa°î
-1].
u
.
hdr
.
¥evSize
 = 
nBlock
;

284 
mem3
.
aPoﬁ
[mem3.
iMa°î
+mem3.
szMa°î
-1].
u
.
hdr
.
size4x
 |= 2;

285 
mem3
.
aPoﬁ
[
√wi
-1].
u
.
hdr
.
size4x
 = 
nBlock
*4 + 1;

286 
mem3
.
szMa°î
 -
nBlock
;

287 
mem3
.
aPoﬁ
[
√wi
-1].
u
.
hdr
.
¥evSize
 = mem3.
szMa°î
;

288 
x
 = 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
 & 2;

289 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
 = mem3.
szMa°î
*4 | 
x
;

290 if–
mem3
.
szMa°î
 < mem3.
mnMa°î
 ){

291 
mem3
.
mnMa°î
 = mem3.
szMa°î
;

293  (*)&
mem3
.
aPoﬁ
[
√wi
];

295 
	}
}

313 
	$memsys3Mîge
(
u32
 *
pRoŸ
){

314 
u32
 
iNext
, 
¥ev
, 
size
, 
i
, 
x
;

316 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

317 
i
=*
pRoŸ
; i>0; i=
iNext
){

318 
iNext
 = 
mem3
.
aPoﬁ
[
i
].
u
.
li°
.
√xt
;

319 
size
 = 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
;

320 
	`as£π
–(
size
&1)==0 );

321 if–(
size
&2)==0 ){

322 
	`memsys3U∆ökFromLi°
(
i
, 
pRoŸ
);

323 
	`as£π
–
i
 > 
mem3
.
aPoﬁ
[i-1].
u
.
hdr
.
¥evSize
 );

324 
¥ev
 = 
i
 - 
mem3
.
aPoﬁ
[i-1].
u
.
hdr
.
¥evSize
;

325 if–
¥ev
==
iNext
 ){

326 
iNext
 = 
mem3
.
aPoﬁ
[
¥ev
].
u
.
li°
.
√xt
;

328 
	`memsys3U∆ök
(
¥ev
);

329 
size
 = 
i
 + size/4 - 
¥ev
;

330 
x
 = 
mem3
.
aPoﬁ
[
¥ev
-1].
u
.
hdr
.
size4x
 & 2;

331 
mem3
.
aPoﬁ
[
¥ev
-1].
u
.
hdr
.
size4x
 = 
size
*4 | 
x
;

332 
mem3
.
aPoﬁ
[
¥ev
+
size
-1].
u
.
hdr
.
¥evSize
 = size;

333 
	`memsys3Lök
(
¥ev
);

334 
i
 = 
¥ev
;

336 
size
 /= 4;

338 if–
size
>
mem3
.
szMa°î
 ){

339 
mem3
.
iMa°î
 = 
i
;

340 
mem3
.
szMa°î
 = 
size
;

343 
	}
}

352 *
	$memsys3MÆlocUnß„
(
nByã
){

353 
u32
 
i
;

354 
u32
 
nBlock
;

355 
u32
 
toFªe
;

357 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

358 
	`as£π
–(
Mem3Block
)==8 );

359 if–
nByã
<=12 ){

360 
nBlock
 = 2;

362 
nBlock
 = (
nByã
 + 11)/8;

364 
	`as£π
–
nBlock
>=2 );

371 if–
nBlock
 <
MX_SMALL
 ){

372 
i
 = 
mem3
.
aiSmÆl
[
nBlock
-2];

373 if–
i
>0 ){

374 
	`memsys3U∆ökFromLi°
(
i
, &
mem3
.
aiSmÆl
[
nBlock
-2]);

375  
	`memsys3Checkout
(
i
, 
nBlock
);

378 
hash
 = 
nBlock
 % 
N_HASH
;

379 
i
=
mem3
.
aiHash
[
hash
]; i>0; i=mem3.
aPoﬁ
[i].
u
.
li°
.
√xt
){

380 if–
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
/4==
nBlock
 ){

381 
	`memsys3U∆ökFromLi°
(
i
, &
mem3
.
aiHash
[
hash
]);

382  
	`memsys3Checkout
(
i
, 
nBlock
);

391 if–
mem3
.
szMa°î
>=
nBlock
 ){

392  
	`memsys3FromMa°î
(
nBlock
);

403 
toFªe
=
nBlock
*16;ÅoFªe<(
mem3
.
nPoﬁ
*16);ÅoFree *= 2){

404 
	`memsys3OutOfMem‹y
(
toFªe
);

405 if–
mem3
.
iMa°î
 ){

406 
	`memsys3Lök
(
mem3
.
iMa°î
);

407 
mem3
.
iMa°î
 = 0;

408 
mem3
.
szMa°î
 = 0;

410 
i
=0; i<
N_HASH
; i++){

411 
	`memsys3Mîge
(&
mem3
.
aiHash
[
i
]);

413 
i
=0; i<
MX_SMALL
-1; i++){

414 
	`memsys3Mîge
(&
mem3
.
aiSmÆl
[
i
]);

416 if–
mem3
.
szMa°î
 ){

417 
	`memsys3U∆ök
(
mem3
.
iMa°î
);

418 if–
mem3
.
szMa°î
>=
nBlock
 ){

419  
	`memsys3FromMa°î
(
nBlock
);

426 
	}
}

434 
	$memsys3FªeUnß„
(*
pOld
){

435 
Mem3Block
 *
p
 = (Mem3Block*)
pOld
;

436 
i
;

437 
u32
 
size
, 
x
;

438 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem3
.
muãx
) );

439 
	`as£π
–
p
>
mem3
.
aPoﬁ
 &&Ö<&mem3.aPoﬁ[mem3.
nPoﬁ
] );

440 
i
 = 
p
 - 
mem3
.
aPoﬁ
;

441 
	`as£π
–(
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
&1)==1 );

442 
size
 = 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
/4;

443 
	`as£π
–
i
+
size
<=
mem3
.
nPoﬁ
+1 );

444 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
 &= ~1;

445 
mem3
.
aPoﬁ
[
i
+
size
-1].
u
.
hdr
.
¥evSize
 = size;

446 
mem3
.
aPoﬁ
[
i
+
size
-1].
u
.
hdr
.
size4x
 &= ~2;

447 
	`memsys3Lök
(
i
);

450 if–
mem3
.
iMa°î
 ){

451  (
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
&2)==0 ){

452 
size
 = 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
¥evSize
;

453 
mem3
.
iMa°î
 -
size
;

454 
mem3
.
szMa°î
 +
size
;

455 
	`memsys3U∆ök
(
mem3
.
iMa°î
);

456 
x
 = 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
 & 2;

457 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
 = mem3.
szMa°î
*4 | 
x
;

458 
mem3
.
aPoﬁ
[mem3.
iMa°î
+mem3.
szMa°î
-1].
u
.
hdr
.
¥evSize
 = mem3.szMaster;

460 
x
 = 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
 & 2;

461  (
mem3
.
aPoﬁ
[mem3.
iMa°î
+mem3.
szMa°î
-1].
u
.
hdr
.
size4x
&1)==0 ){

462 
	`memsys3U∆ök
(
mem3
.
iMa°î
+mem3.
szMa°î
);

463 
mem3
.
szMa°î
 +mem3.
aPoﬁ
[mem3.
iMa°î
+mem3.szMa°î-1].
u
.
hdr
.
size4x
/4;

464 
mem3
.
aPoﬁ
[mem3.
iMa°î
-1].
u
.
hdr
.
size4x
 = mem3.
szMa°î
*4 | 
x
;

465 
mem3
.
aPoﬁ
[mem3.
iMa°î
+mem3.
szMa°î
-1].
u
.
hdr
.
¥evSize
 = mem3.szMaster;

468 
	}
}

475 
	$memsys3Size
(*
p
){

476 
Mem3Block
 *
pBlock
;

477 if–
p
==0 )  0;

478 
pBlock
 = (
Mem3Block
*)
p
;

479 
	`as£π
–(
pBlock
[-1].
u
.
hdr
.
size4x
&1)!=0 );

480  (
pBlock
[-1].
u
.
hdr
.
size4x
&~3)*2 - 4;

481 
	}
}

486 
	$memsys3Roundup
(
n
){

487 if–
n
<=12 ){

490  ((
n
+11)&~7) - 4;

492 
	}
}

497 *
	$memsys3MÆloc
(
nByãs
){

498 
sqlôe4_öt64
 *
p
;

499 
	`as£π
–
nByãs
>0 );

500 
	`memsys3E¡î
();

501 
p
 = 
	`memsys3MÆlocUnß„
(
nByãs
);

502 
	`memsys3Lóve
();

503  (*)
p
;

504 
	}
}

509 
	$memsys3Fªe
(*
pPri‹
){

510 
	`as£π
–
pPri‹
 );

511 
	`memsys3E¡î
();

512 
	`memsys3FªeUnß„
(
pPri‹
);

513 
	`memsys3Lóve
();

514 
	}
}

519 *
	$memsys3RóŒoc
(
sqlôe4_ív
*
pEnv
, *
pPri‹
, 
nByãs
){

520 
nOld
;

521 *
p
;

522 if–
pPri‹
==0 ){

523  
	`sqlôe4_mÆloc
(
pEnv
, 
nByãs
);

525 if–
nByãs
<=0 ){

526 
	`sqlôe4_‰ì
(
pEnv
, 
pPri‹
);

529 
nOld
 = 
	`memsys3Size
(
pPri‹
);

530 if–
nByãs
<=
nOld
 &&ÇBytes>=nOld-128 ){

531  
pPri‹
;

533 
	`memsys3E¡î
();

534 
p
 = 
	`memsys3MÆlocUnß„
(
nByãs
);

535 if–
p
 ){

536 if–
nOld
<
nByãs
 ){

537 
	`mem˝y
(
p
, 
pPri‹
, 
nOld
);

539 
	`mem˝y
(
p
, 
pPri‹
, 
nByãs
);

541 
	`memsys3FªeUnß„
(
pPri‹
);

543 
	`memsys3Lóve
();

544  
p
;

545 
	}
}

550 
	$memsys3Inô
(*
NŸU£d
){

551 
	`UNUSED_PARAMETER
(
NŸU£d
);

552 if–!
sqlôe4DeÁu…Env
.
pHóp
 ){

553  
SQLITE4_ERROR
;

557 
	`as£π
–(
Mem3Block
)==8 );

558 
mem3
.
aPoﬁ
 = (
Mem3Block
 *)
sqlôe4DeÁu…Env
.
pHóp
;

559 
mem3
.
nPoﬁ
 = (
sqlôe4DeÁu…Env
.
nHóp
 / (
Mem3Block
)) - 2;

562 
mem3
.
szMa°î
 = mem3.
nPoﬁ
;

563 
mem3
.
mnMa°î
 = mem3.
szMa°î
;

564 
mem3
.
iMa°î
 = 1;

565 
mem3
.
aPoﬁ
[0].
u
.
hdr
.
size4x
 = (mem3.
szMa°î
<<2) + 2;

566 
mem3
.
aPoﬁ
[mem3.
nPoﬁ
].
u
.
hdr
.
¥evSize
 = mem3.nPool;

567 
mem3
.
aPoﬁ
[mem3.
nPoﬁ
].
u
.
hdr
.
size4x
 = 1;

569  
SQLITE4_OK
;

570 
	}
}

575 
	$memsys3Shutdown
(*
NŸU£d
){

576 
	`UNUSED_PARAMETER
(
NŸU£d
);

577 
mem3
.
muãx
 = 0;

579 
	}
}

587 
	$sqlôe4Memsys3Dump
(c⁄° *
zFûíame
){

588 #ifde‡
SQLITE4_DEBUG


589 
FILE
 *
out
;

590 
u32
 
i
, 
j
;

591 
u32
 
size
;

592 if–
zFûíame
==0 || zFilename[0]==0 ){

593 
out
 = 
°dout
;

595 
out
 = 
	`f›í
(
zFûíame
, "w");

596 if–
out
==0 ){

597 
	`Ârötf
(
°dîr
, "** UnableÅo output memory debug outputÜog: %s **\n",

598 
zFûíame
);

602 
	`memsys3E¡î
();

603 
	`Ârötf
(
out
, "CHUNKS:\n");

604 
i
=1; i<=
mem3
.
nPoﬁ
; i+=
size
/4){

605 
size
 = 
mem3
.
aPoﬁ
[
i
-1].
u
.
hdr
.
size4x
;

606 if–
size
/4<=1 ){

607 
	`Ârötf
(
out
, "%∞sizêîr‹\n", &
mem3
.
aPoﬁ
[
i
]);

608 
	`as£π
( 0 );

611 if–(
size
&1)==0 && 
mem3
.
aPoﬁ
[
i
+size/4-1].
u
.
hdr
.
¥evSize
!=size/4 ){

612 
	`Ârötf
(
out
, "%∞èû sizêd€†nŸ m©ch\n", &
mem3
.
aPoﬁ
[
i
]);

613 
	`as£π
( 0 );

616 if–((
mem3
.
aPoﬁ
[
i
+
size
/4-1].
u
.
hdr
.
size4x
&2)>>1)!=(size&1) ){

617 
	`Ârötf
(
out
, "%∞èû checkouàbô i†öc‹ª˘\n", &
mem3
.
aPoﬁ
[
i
]);

618 
	`as£π
( 0 );

621 if–
size
&1 ){

622 
	`Ârötf
(
out
, "%∞%6d byã†checked out\n", &
mem3
.
aPoﬁ
[
i
], (
size
/4)*8-8);

624 
	`Ârötf
(
out
, "%∞%6d byã†‰ì%s\n", &
mem3
.
aPoﬁ
[
i
], (
size
/4)*8-8,

625 
i
==
mem3
.
iMa°î
 ? " **master**" : "");

628 
i
=0; i<
MX_SMALL
-1; i++){

629 if–
mem3
.
aiSmÆl
[
i
]==0 ) ;

630 
	`Ârötf
(
out
, "smÆl(%2d):", 
i
);

631 
j
 = 
mem3
.
aiSmÆl
[
i
]; j>0; j=mem3.
aPoﬁ
[j].
u
.
li°
.
√xt
){

632 
	`Ârötf
(
out
, " %p(%d)", &
mem3
.
aPoﬁ
[
j
],

633 (
mem3
.
aPoﬁ
[
j
-1].
u
.
hdr
.
size4x
/4)*8-8);

635 
	`Ârötf
(
out
, "\n");

637 
i
=0; i<
N_HASH
; i++){

638 if–
mem3
.
aiHash
[
i
]==0 ) ;

639 
	`Ârötf
(
out
, "hash(%2d):", 
i
);

640 
j
 = 
mem3
.
aiHash
[
i
]; j>0; j=mem3.
aPoﬁ
[j].
u
.
li°
.
√xt
){

641 
	`Ârötf
(
out
, " %p(%d)", &
mem3
.
aPoﬁ
[
j
],

642 (
mem3
.
aPoﬁ
[
j
-1].
u
.
hdr
.
size4x
/4)*8-8);

644 
	`Ârötf
(
out
, "\n");

646 
	`Ârötf
(
out
, "ma°î=%d\n", 
mem3
.
iMa°î
);

647 
	`Ârötf
(
out
, "nowU£d=%d\n", 
mem3
.
nPoﬁ
*8 - mem3.
szMa°î
*8);

648 
	`Ârötf
(
out
, "mxU£d=%d\n", 
mem3
.
nPoﬁ
*8 - mem3.
mnMa°î
*8);

649 
	`sqlôe4_muãx_Àave
(
mem3
.
muãx
);

650 if–
out
==
°dout
 ){

651 
	`fÊush
(
°dout
);

653 
	`f˛o£
(
out
);

656 
	`UNUSED_PARAMETER
(
zFûíame
);

658 
	}
}

671 c⁄° 
sqlôe4_mem_mëhods
 *
	$sqlôe4MemGëMemsys3
(){

672 c⁄° 
sqlôe4_mem_mëhods
 
mempoﬁMëhods
 = {

673 
memsys3MÆloc
,

674 
memsys3Fªe
,

675 
memsys3RóŒoc
,

676 
memsys3Size
,

677 
memsys3Roundup
,

678 
memsys3Inô
,

679 
memsys3Shutdown
,

682  &
mempoﬁMëhods
;

683 
	}
}

	@src/mem5.c

51 
	~"sqlôeI¡.h
"

57 #ifde‡
SQLITE4_ENABLE_MEMSYS5


67 
Mem5Lök
 
	tMem5Lök
;

68 
	sMem5Lök
 {

69 
	m√xt
;

70 
	m¥ev
;

78 
	#LOGMAX
 30

	)

83 
	#CTRL_LOGSIZE
 0x1‡

	)

84 
	#CTRL_FREE
 0x20

	)

92 
SQLITE4_WSD
 
	sMem5GlobÆ
 {

96 
	mszAtom
;

97 
	mnBlock
;

98 
u8
 *
	mzPoﬁ
;

103 
sqlôe4_muãx
 *
	mmuãx
;

108 
u64
 
	mnAŒoc
;

109 
u64
 
	mtŸÆAŒoc
;

110 
u64
 
	mtŸÆEx˚ss
;

111 
u32
 
	mcuºítOut
;

112 
u32
 
	mcuºítCou¡
;

113 
u32
 
	mmaxOut
;

114 
u32
 
	mmaxCou¡
;

115 
u32
 
	mmaxReque°
;

122 
	maiFªñi°
[
LOGMAX
+1];

128 
u8
 *
	maCål
;

130 } 
	gmem5
;

136 
	#MEM5LINK
(
idx
Ë((
Mem5Lök
 *)(&
mem5
.
zPoﬁ
[(idx)*mem5.
szAtom
]))

	)

142 
	$memsys5U∆ök
(
i
, 
iLogsize
){

143 
√xt
, 
¥ev
;

144 
	`as£π
–
i
>=0 && i<
mem5
.
nBlock
 );

145 
	`as£π
–
iLogsize
>=0 && iLogsize<=
LOGMAX
 );

146 
	`as£π
–(
mem5
.
aCål
[
i
] & 
CTRL_LOGSIZE
)==
iLogsize
 );

148 
√xt
 = 
	`MEM5LINK
(
i
)->next;

149 
¥ev
 = 
	`MEM5LINK
(
i
)->prev;

150 if–
¥ev
<0 ){

151 
mem5
.
aiFªñi°
[
iLogsize
] = 
√xt
;

153 
	`MEM5LINK
(
¥ev
)->
√xt
 =Çext;

155 if–
√xt
>=0 ){

156 
	`MEM5LINK
(
√xt
)->
¥ev
 =Örev;

158 
	}
}

164 
	$memsys5Lök
(
i
, 
iLogsize
){

165 
x
;

166 
	`as£π
–
	`sqlôe4_muãx_hñd
(
mem5
.
muãx
) );

167 
	`as£π
–
i
>=0 && i<
mem5
.
nBlock
 );

168 
	`as£π
–
iLogsize
>=0 && iLogsize<=
LOGMAX
 );

169 
	`as£π
–(
mem5
.
aCål
[
i
] & 
CTRL_LOGSIZE
)==
iLogsize
 );

171 
x
 = 
	`MEM5LINK
(
i
)->
√xt
 = 
mem5
.
aiFªñi°
[
iLogsize
];

172 
	`MEM5LINK
(
i
)->
¥ev
 = -1;

173 if–
x
>=0 ){

174 
	`as£π
–
x
<
mem5
.
nBlock
 );

175 
	`MEM5LINK
(
x
)->
¥ev
 = 
i
;

177 
mem5
.
aiFªñi°
[
iLogsize
] = 
i
;

178 
	}
}

185 
	$memsys5E¡î
(){

186 
	`sqlôe4_muãx_íãr
(
mem5
.
muãx
);

187 
	}
}

188 
	$memsys5Lóve
(){

189 
	`sqlôe4_muãx_Àave
(
mem5
.
muãx
);

190 
	}
}

197 
	$memsys5Size
(*
p
){

198 
iSize
 = 0;

199 if–
p
 ){

200 
i
 = ((
u8
 *)
p
-
mem5
.
zPoﬁ
)/mem5.
szAtom
;

201 
	`as£π
–
i
>=0 && i<
mem5
.
nBlock
 );

202 
iSize
 = 
mem5
.
szAtom
 * (1 << (mem5.
aCål
[
i
]&
CTRL_LOGSIZE
));

204  
iSize
;

205 
	}
}

211 
	$memsys5U∆ökFú°
(
iLogsize
){

212 
i
;

213 
iFú°
;

215 
	`as£π
–
iLogsize
>=0 && iLogsize<=
LOGMAX
 );

216 
i
 = 
iFú°
 = 
mem5
.
aiFªñi°
[
iLogsize
];

217 
	`as£π
–
iFú°
>=0 );

218  
i
>0 ){

219 if–
i
<
iFú°
 ) iFirst = i;

220 
i
 = 
	`MEM5LINK
(i)->
√xt
;

222 
	`memsys5U∆ök
(
iFú°
, 
iLogsize
);

223  
iFú°
;

224 
	}
}

236 *
	$memsys5MÆlocUnß„
(
nByã
){

237 
i
;

238 
iBö
;

239 
iFuŒSz
;

240 
iLogsize
;

243 
	`as£π
–
nByã
>0 );

247 if–(
u32
)
nByã
>
mem5
.
maxReque°
 ){

248 
mem5
.
maxReque°
 = 
nByã
;

254 if–
nByã
 > 0x40000000 ){

259 
iFuŒSz
=
mem5
.
szAtom
, 
iLogsize
=0; iFuŒSz<
nByã
; iFullSz *= 2, iLogsize++){}

265 
iBö
=
iLogsize
; 
mem5
.
aiFªñi°
[iBö]<0 && iBö<=
LOGMAX
; iBin++){}

266 if–
iBö
>
LOGMAX
 ){

267 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

268 
	`sqlôe4_log
(0,
SQLITE4_NOMEM
, "ÁûedÅÿÆloˇã %u byãs", 
nByã
);

271 
i
 = 
	`memsys5U∆ökFú°
(
iBö
);

272  
iBö
>
iLogsize
 ){

273 
√wSize
;

275 
iBö
--;

276 
√wSize
 = 1 << 
iBö
;

277 
mem5
.
aCål
[
i
+
√wSize
] = 
CTRL_FREE
 | 
iBö
;

278 
	`memsys5Lök
(
i
+
√wSize
, 
iBö
);

280 
mem5
.
aCål
[
i
] = 
iLogsize
;

283 
mem5
.
nAŒoc
++;

284 
mem5
.
tŸÆAŒoc
 +
iFuŒSz
;

285 
mem5
.
tŸÆEx˚ss
 +
iFuŒSz
 - 
nByã
;

286 
mem5
.
cuºítCou¡
++;

287 
mem5
.
cuºítOut
 +
iFuŒSz
;

288 if–
mem5
.
maxCou¡
<mem5.
cuºítCou¡
 ) mem5.maxCount = mem5.currentCount;

289 if–
mem5
.
maxOut
<mem5.
cuºítOut
 ) mem5.maxOut = mem5.currentOut;

292  (*)&
mem5
.
zPoﬁ
[
i
*mem5.
szAtom
];

293 
	}
}

298 
	$memsys5FªeUnß„
(*
pOld
){

299 
u32
 
size
, 
iLogsize
;

300 
iBlock
;

305 
iBlock
 = ((
u8
 *)
pOld
-
mem5
.
zPoﬁ
)/mem5.
szAtom
;

308 
	`as£π
–
iBlock
>=0 && iBlock<
mem5
.
nBlock
 );

309 
	`as£π
–((
u8
 *)
pOld
-
mem5
.
zPoﬁ
)%mem5.
szAtom
==0 );

310 
	`as£π
–(
mem5
.
aCål
[
iBlock
] & 
CTRL_FREE
)==0 );

312 
iLogsize
 = 
mem5
.
aCål
[
iBlock
] & 
CTRL_LOGSIZE
;

313 
size
 = 1<<
iLogsize
;

314 
	`as£π
–
iBlock
+
size
-1<(
u32
)
mem5
.
nBlock
 );

316 
mem5
.
aCål
[
iBlock
] |
CTRL_FREE
;

317 
mem5
.
aCål
[
iBlock
+
size
-1] |
CTRL_FREE
;

318 
	`as£π
–
mem5
.
cuºítCou¡
>0 );

319 
	`as£π
–
mem5
.
cuºítOut
>=(
size
*mem5.
szAtom
) );

320 
mem5
.
cuºítCou¡
--;

321 
mem5
.
cuºítOut
 -
size
*mem5.
szAtom
;

322 
	`as£π
–
mem5
.
cuºítOut
>0 || mem5.
cuºítCou¡
==0 );

323 
	`as£π
–
mem5
.
cuºítCou¡
>0 || mem5.
cuºítOut
==0 );

325 
mem5
.
aCål
[
iBlock
] = 
CTRL_FREE
 | 
iLogsize
;

326  
	`ALWAYS
(
iLogsize
<
LOGMAX
) ){

327 
iBuddy
;

328 if–(
iBlock
>>
iLogsize
) & 1 ){

329 
iBuddy
 = 
iBlock
 - 
size
;

331 
iBuddy
 = 
iBlock
 + 
size
;

333 
	`as£π
–
iBuddy
>=0 );

334 if–(
iBuddy
+(1<<
iLogsize
))>
mem5
.
nBlock
 ) ;

335 if–
mem5
.
aCål
[
iBuddy
]!=(
CTRL_FREE
 | 
iLogsize
) ) ;

336 
	`memsys5U∆ök
(
iBuddy
, 
iLogsize
);

337 
iLogsize
++;

338 if–
iBuddy
<
iBlock
 ){

339 
mem5
.
aCål
[
iBuddy
] = 
CTRL_FREE
 | 
iLogsize
;

340 
mem5
.
aCål
[
iBlock
] = 0;

341 
iBlock
 = 
iBuddy
;

343 
mem5
.
aCål
[
iBlock
] = 
CTRL_FREE
 | 
iLogsize
;

344 
mem5
.
aCål
[
iBuddy
] = 0;

346 
size
 *= 2;

348 
	`memsys5Lök
(
iBlock
, 
iLogsize
);

349 
	}
}

354 *
	$memsys5MÆloc
(
nByãs
){

355 
sqlôe4_öt64
 *
p
 = 0;

356 if–
nByãs
>0 ){

357 
	`memsys5E¡î
();

358 
p
 = 
	`memsys5MÆlocUnß„
(
nByãs
);

359 
	`memsys5Lóve
();

361  (*)
p
;

362 
	}
}

370 
	$memsys5Fªe
(*
pPri‹
){

371 
	`as£π
–
pPri‹
!=0 );

372 
	`memsys5E¡î
();

373 
	`memsys5FªeUnß„
(
pPri‹
);

374 
	`memsys5Lóve
();

375 
	}
}

389 *
	$memsys5RóŒoc
(*
pPri‹
, 
nByãs
){

390 
nOld
;

391 *
p
;

392 
	`as£π
–
pPri‹
!=0 );

393 
	`as£π
–(
nByãs
&(nBytes-1))==0 );

394 
	`as£π
–
nByãs
>=0 );

395 if–
nByãs
==0 ){

398 
nOld
 = 
	`memsys5Size
(
pPri‹
);

399 if–
nByãs
<=
nOld
 ){

400  
pPri‹
;

402 
	`memsys5E¡î
();

403 
p
 = 
	`memsys5MÆlocUnß„
(
nByãs
);

404 if–
p
 ){

405 
	`mem˝y
(
p
, 
pPri‹
, 
nOld
);

406 
	`memsys5FªeUnß„
(
pPri‹
);

408 
	`memsys5Lóve
();

409  
p
;

410 
	}
}

421 
	$memsys5Roundup
(
n
){

422 
iFuŒSz
;

423 if–
n
 > 0x40000000 )  0;

424 
iFuŒSz
=
mem5
.
szAtom
; iFuŒSz<
n
; iFullSz *= 2);

425  
iFuŒSz
;

426 
	}
}

438 
	$memsys5Log
(
iVÆue
){

439 
iLog
;

440 
iLog
=0; (iLog<()((()*8)-1)Ë&& (1<<iLog)<
iVÆue
; iLog++);

441  
iLog
;

442 
	}
}

450 
	$memsys5Inô
(*
NŸU£d
){

451 
ii
;

452 
nByã
;

453 
u8
 *
zByã
;

454 
nMöLog
;

455 
iOff£t
;

457 
	`UNUSED_PARAMETER
(
NŸU£d
);

460 
mem5
.
muãx
 = 0;

465 
	`as£π
–((
Mem5Lök
)&((Mem5Link)-1))==0 );

467 
nByã
 = 
sqlôe4DeÁu…Env
.
nHóp
;

468 
zByã
 = (
u8
*)
sqlôe4DeÁu…Env
.
pHóp
;

469 
	`as£π
–
zByã
!=0 );

472 
nMöLog
 = 
	`memsys5Log
(
sqlôe4DeÁu…Env
.
mnReq
);

473 
mem5
.
szAtom
 = (1<<
nMöLog
);

474  ()(
Mem5Lök
)>
mem5
.
szAtom
 ){

475 
mem5
.
szAtom
 = mem5.szAtom << 1;

478 
mem5
.
nBlock
 = (
nByã
 / (mem5.
szAtom
+(
u8
)));

479 
mem5
.
zPoﬁ
 = 
zByã
;

480 
mem5
.
aCål
 = (
u8
 *)&mem5.
zPoﬁ
[mem5.
nBlock
*mem5.
szAtom
];

482 
ii
=0; ii<=
LOGMAX
; ii++){

483 
mem5
.
aiFªñi°
[
ii
] = -1;

486 
iOff£t
 = 0;

487 
ii
=
LOGMAX
; ii>=0; ii--){

488 
nAŒoc
 = (1<<
ii
);

489 if–(
iOff£t
+
nAŒoc
)<=
mem5
.
nBlock
 ){

490 
mem5
.
aCål
[
iOff£t
] = 
ii
 | 
CTRL_FREE
;

491 
	`memsys5Lök
(
iOff£t
, 
ii
);

492 
iOff£t
 +
nAŒoc
;

494 
	`as£π
((
iOff£t
+
nAŒoc
)>
mem5
.
nBlock
);

498 if–
sqlôe4DeÁu…Env
.
bMem°©
==0 ){

499 
mem5
.
muãx
 = 
	`sqlôe4MuãxAŒoc
(
SQLITE4_MUTEX_STATIC_MEM
);

502  
SQLITE4_OK
;

503 
	}
}

508 
	$memsys5Shutdown
(*
NŸU£d
){

509 
	`UNUSED_PARAMETER
(
NŸU£d
);

510 
mem5
.
muãx
 = 0;

512 
	}
}

514 #ifde‡
SQLITE4_TEST


519 
	$sqlôe4Memsys5Dump
(c⁄° *
zFûíame
){

520 
FILE
 *
out
;

521 
i
, 
j
, 
n
;

522 
nMöLog
;

524 if–
zFûíame
==0 || zFilename[0]==0 ){

525 
out
 = 
°dout
;

527 
out
 = 
	`f›í
(
zFûíame
, "w");

528 if–
out
==0 ){

529 
	`Ârötf
(
°dîr
, "** UnableÅo output memory debug outputÜog: %s **\n",

530 
zFûíame
);

534 
	`memsys5E¡î
();

535 
nMöLog
 = 
	`memsys5Log
(
mem5
.
szAtom
);

536 
i
=0; i<=
LOGMAX
 && i+
nMöLog
<32; i++){

537 
n
=0, 
j
=
mem5
.
aiFªñi°
[
i
]; j>=0; j = 
	`MEM5LINK
(j)->
√xt
,Ç++){}

538 
	`Ârötf
(
out
, "‰ìli° iãm†o‡sizê%d: %d\n", 
mem5
.
szAtom
 << 
i
, 
n
);

540 
	`Ârötf
(
out
, "mem5.nAŒo¯ = %Œu\n", 
mem5
.
nAŒoc
);

541 
	`Ârötf
(
out
, "mem5.tŸÆAŒo¯ = %Œu\n", 
mem5
.
tŸÆAŒoc
);

542 
	`Ârötf
(
out
, "mem5.tŸÆEx˚s† = %Œu\n", 
mem5
.
tŸÆEx˚ss
);

543 
	`Ârötf
(
out
, "mem5.cuºítOuà = %u\n", 
mem5
.
cuºítOut
);

544 
	`Ârötf
(
out
, "mem5.cuºítCou¡ = %u\n", 
mem5
.
cuºítCou¡
);

545 
	`Ârötf
(
out
, "mem5.maxOuà = %u\n", 
mem5
.
maxOut
);

546 
	`Ârötf
(
out
, "mem5.maxCou¡ = %u\n", 
mem5
.
maxCou¡
);

547 
	`Ârötf
(
out
, "mem5.maxReque° = %u\n", 
mem5
.
maxReque°
);

548 
	`memsys5Lóve
();

549 if–
out
==
°dout
 ){

550 
	`fÊush
(
°dout
);

552 
	`f˛o£
(
out
);

554 
	}
}

562 c⁄° 
sqlôe4_mem_mëhods
 *
	$sqlôe4MemGëMemsys5
(){

563 c⁄° 
sqlôe4_mem_mëhods
 
memsys5Mëhods
 = {

564 
memsys5MÆloc
,

565 
memsys5Fªe
,

566 
memsys5RóŒoc
,

567 
memsys5Size
,

568 
memsys5Roundup
,

569 
memsys5Inô
,

570 
memsys5Shutdown
,

573  &
memsys5Mëhods
;

574 
	}
}

	@src/mutex.c

16 
	~"sqlôeI¡.h
"

18 #i‚de‡
SQLITE4_MUTEX_OMIT


22 
	$sqlôe4MuãxInô
(
sqlôe4_ív
 *
pEnv
){

23 
rc
 = 
SQLITE4_OK
;

24 if–!
pEnv
->
muãx
.
xMuãxAŒoc
 ){

25 if–
pEnv
->
bC‹eMuãx
 ){

26 
pEnv
->
muãx
 = *
	`sqlôe4DeÁu…Muãx
();

28 
pEnv
->
muãx
 = *
	`sqlôe4No›Muãx
();

30 
pEnv
->
muãx
.
pMuãxEnv
 =ÖEnv;

32 
rc
 = 
pEnv
->
muãx
.
	`xMuãxInô
’Env->muãx.
pMuãxEnv
);

33  
rc
;

34 
	}
}

40 
	$sqlôe4MuãxEnd
(
sqlôe4_ív
 *
pEnv
){

41 
rc
 = 
SQLITE4_OK
;

42 if–
pEnv
->
muãx
.
xMuãxEnd
 ){

43 
rc
 = 
pEnv
->
muãx
.
	`xMuãxEnd
’Env->muãx.
pMuãxEnv
);

45  
rc
;

46 
	}
}

51 
sqlôe4_muãx
 *
	$sqlôe4_muãx_Æloc
(
sqlôe4_ív
 *
pEnv
, 
id
){

52 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

53 #i‚de‡
SQLITE4_OMIT_AUTOINIT


54 if–
	`sqlôe4_öôülize
(
pEnv
) )  0;

56  
pEnv
->
muãx
.
	`xMuãxAŒoc
’Env->muãx.
pMuãxEnv
, 
id
);

57 
	}
}

59 
sqlôe4_muãx
 *
	$sqlôe4MuãxAŒoc
(
sqlôe4_ív
 *
pEnv
, 
id
){

60 if–!
pEnv
->
bC‹eMuãx
 ){

63  
pEnv
->
muãx
.
	`xMuãxAŒoc
’Env->muãx.
pMuãxEnv
, 
id
);

64 
	}
}

69 
	$sqlôe4_muãx_‰ì
(
sqlôe4_muãx
 *
p
){

70 if–
p
 ){

71 
p
->
pMuãxMëhods
->
	`xMuãxFªe
(p);

73 
	}
}

79 
	$sqlôe4_muãx_íãr
(
sqlôe4_muãx
 *
p
){

80 if–
p
 ){

81 
p
->
pMuãxMëhods
->
	`xMuãxE¡î
(p);

83 
	}
}

89 
	$sqlôe4_muãx_åy
(
sqlôe4_muãx
 *
p
){

90 
rc
 = 
SQLITE4_OK
;

91 if–
p
 ){

92  
p
->
pMuãxMëhods
->
	`xMuãxTry
(p);

94  
rc
;

95 
	}
}

103 
	$sqlôe4_muãx_Àave
(
sqlôe4_muãx
 *
p
){

104 if–
p
 ){

105 
p
->
pMuãxMëhods
->
	`xMuãxLóve
(p);

107 
	}
}

109 #i‚de‡
NDEBUG


114 
	$sqlôe4_muãx_hñd
(
sqlôe4_muãx
 *
p
){

115  
p
==0 ||Ö->
pMuãxMëhods
->
	`xMuãxHñd
(p);

116 
	}
}

117 
	$sqlôe4_muãx_nŸhñd
(
sqlôe4_muãx
 *
p
){

118  
p
==0 ||Ö->
pMuãxMëhods
->
	`xMuãxNŸhñd
(p);

119 
	}
}

	@src/mutex.h

40 #i‡!
SQLITE4_THREADSAFE


41 
	#SQLITE4_MUTEX_OMIT


	)

43 #i‡
SQLITE4_THREADSAFE
 && !
deföed
(
SQLITE4_MUTEX_NOOP
)

44 #i‡
SQLITE4_OS_UNIX


45 
	#SQLITE4_MUTEX_PTHREADS


	)

46 #ñi‡
SQLITE4_OS_WIN


47 
	#SQLITE4_MUTEX_W32


	)

49 
	#SQLITE4_MUTEX_NOOP


	)

53 #ifde‡
SQLITE4_MUTEX_OMIT


57 
	#sqlôe4_muãx_Æloc
(
X
,
Y
Ë((
sqlôe4_muãx
*)8)

	)

58 
	#sqlôe4_muãx_‰ì
(
X
)

	)

59 
	#sqlôe4_muãx_íãr
(
X
)

	)

60 
	#sqlôe4_muãx_åy
(
X
Ë
SQLITE4_OK


	)

61 
	#sqlôe4_muãx_Àave
(
X
)

	)

62 
	#sqlôe4_muãx_hñd
(
X
Ë(()(X),1)

	)

63 
	#sqlôe4_muãx_nŸhñd
(
X
Ë(()(X),1)

	)

64 
	#sqlôe4MuãxAŒoc
(
X
,
Y
Ë((
sqlôe4_muãx
*)8)

	)

65 
	#sqlôe4MuãxInô
(
E
Ë
SQLITE4_OK


	)

66 
	#sqlôe4MuãxEnd
(
E
)

	)

67 
	#MUTEX_LOGIC
(
X
)

	)

69 
	#MUTEX_LOGIC
(
X
Ë
	)
X

	@src/mutex_noop.c

28 
	~"sqlôeI¡.h
"

30 #i‚de‡
SQLITE4_MUTEX_OMIT


32 #i‚de‡
SQLITE4_DEBUG


38 
	$no›MuãxInô
(*
p
){ 
	`UNUSED_PARAMETER
’);  
SQLITE4_OK
; 
	}
}

39 
	$no›MuãxEnd
(*
p
){ 
	`UNUSED_PARAMETER
’);  
SQLITE4_OK
; 
	}
}

40 
sqlôe4_muãx
 *
	$no›MuãxAŒoc
(*
p
, 
id
){

41 
	`UNUSED_PARAMETER
(
p
);

42 
	`UNUSED_PARAMETER
(
id
);

43  (
sqlôe4_muãx
*)8;

44 
	}
}

45 
	$no›MuãxFªe
(
sqlôe4_muãx
 *
p
){ 
	`UNUSED_PARAMETER
’); ; 
	}
}

46 
	$no›MuãxE¡î
(
sqlôe4_muãx
 *
p
){ 
	`UNUSED_PARAMETER
’); ; 
	}
}

47 
	$no›MuãxTry
(
sqlôe4_muãx
 *
p
){

48 
	`UNUSED_PARAMETER
(
p
);

49  
SQLITE4_OK
;

50 
	}
}

51 
	$no›MuãxLóve
(
sqlôe4_muãx
 *
p
){ 
	`UNUSED_PARAMETER
’); ; 
	}
}

53 
sqlôe4_muãx_mëhods
 c⁄° *
	$sqlôe4No›Muãx
(){

54 c⁄° 
sqlôe4_muãx_mëhods
 
sMuãx
 = {

55 
no›MuãxInô
,

56 
no›MuãxEnd
,

57 
no›MuãxAŒoc
,

58 
no›MuãxFªe
,

59 
no›MuãxE¡î
,

60 
no›MuãxTry
,

61 
no›MuãxLóve
,

66  &
sMuãx
;

67 
	}
}

70 #ifde‡
SQLITE4_DEBUG


80 
	ssqlôe4DebugMuãx
 {

81 
sqlôe4_muãx
 
	mba£
;

82 
sqlôe4_ív
 *
	mpEnv
;

83 
	mid
;

84 
	m˙t
;

85 } 
	tsqlôe4DebugMuãx
;

91 
	$debugMuãxHñd
(
sqlôe4_muãx
 *
pX
){

92 
sqlôe4DebugMuãx
 *
p
 = (sqlôe4DebugMuãx*)
pX
;

93  
p
==0 ||Ö->
˙t
>0;

94 
	}
}

95 
	$debugMuãxNŸhñd
(
sqlôe4_muãx
 *
pX
){

96 
sqlôe4DebugMuãx
 *
p
 = (sqlôe4DebugMuãx*)
pX
;

97  
p
==0 ||Ö->
˙t
==0;

98 
	}
}

103 
	$debugMuãxInô
(*
p
){ 
	`UNUSED_PARAMETER
’);  
SQLITE4_OK
; 
	}
}

104 
	$debugMuãxEnd
(*
p
){ 
	`UNUSED_PARAMETER
’);  
SQLITE4_OK
; 
	}
}

111 
sqlôe4_muãx
 *
	$debugMuãxAŒoc
(*
pX
, 
id
){

112 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív*)
pX
;

113 
sqlôe4DebugMuãx
 *
pNew
 = 0;

115 
sqlôe4DebugMuãx
 
aSèticMuãx
[] = {

119 if–
id
==
SQLITE4_MUTEX_STATIC_KV
 ){

120 
pNew
 = &
aSèticMuãx
[0];

121 
pNew
->
pEnv
 =ÖEnv;

122 
pNew
->
ba£
.
pMuãxMëhods
 = 
	`sqlôe4No›Muãx
();

124 
pNew
 = 
	`sqlôe4MÆloc
(
pEnv
, (*pNew));

125 if–
pNew
 ){

126 
pNew
->
id
 = id;

127 
pNew
->
˙t
 = 0;

128 
pNew
->
pEnv
 =ÖEnv;

129 
pNew
->
ba£
.
pMuãxMëhods
 = 
	`sqlôe4No›Muãx
();

132  (
sqlôe4_muãx
*)
pNew
;

133 
	}
}

138 
	$debugMuãxFªe
(
sqlôe4_muãx
 *
pX
){

139 
sqlôe4DebugMuãx
 *
p
 = (sqlôe4DebugMuãx*)
pX
;

140 
	`as£π
–
p
->
˙t
==0 );

141 
	`sqlôe4_‰ì
(
p
->
pEnv
,Ö);

142 
	}
}

155 
	$debugMuãxE¡î
(
sqlôe4_muãx
 *
pX
){

156 
sqlôe4DebugMuãx
 *
p
 = (sqlôe4DebugMuãx*)
pX
;

157 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`debugMuãxNŸhñd
(
pX
) );

158 
p
->
˙t
++;

159 
	}
}

160 
	$debugMuãxTry
(
sqlôe4_muãx
 *
pX
){

161 
sqlôe4DebugMuãx
 *
p
 = (sqlôe4DebugMuãx*)
pX
;

162 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`debugMuãxNŸhñd
(
pX
) );

163 
p
->
˙t
++;

164  
SQLITE4_OK
;

165 
	}
}

173 
	$debugMuãxLóve
(
sqlôe4_muãx
 *
pX
){

174 
sqlôe4DebugMuãx
 *
p
 = (sqlôe4DebugMuãx*)
pX
;

175 
	`as£π
–
	`debugMuãxHñd
(
pX
) );

176 
p
->
˙t
--;

177 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`debugMuãxNŸhñd
(
pX
) );

178 
	}
}

180 
sqlôe4_muãx_mëhods
 c⁄° *
	$sqlôe4No›Muãx
(){

181 c⁄° 
sqlôe4_muãx_mëhods
 
sMuãx
 = {

182 
debugMuãxInô
,

183 
debugMuãxEnd
,

184 
debugMuãxAŒoc
,

185 
debugMuãxFªe
,

186 
debugMuãxE¡î
,

187 
debugMuãxTry
,

188 
debugMuãxLóve
,

189 
debugMuãxHñd
,

190 
debugMuãxNŸhñd
,

194  &
sMuãx
;

195 
	}
}

202 #ifde‡
SQLITE4_MUTEX_NOOP


203 
sqlôe4_muãx_mëhods
 c⁄° *
	$sqlôe4DeÁu…Muãx
(){

204  
	`sqlôe4No›Muãx
();

205 
	}
}

	@src/mutex_unix.c

14 
	~"sqlôeI¡.h
"

23 #ifde‡
SQLITE4_MUTEX_PTHREADS


25 
	~<±hªad.h
>

32 #i‡
deföed
(
SQLITE4_DEBUG
Ë|| deföed(
SQLITE4_HOMEGROWN_RECURSIVE_MUTEX
)

33 
	#SQLITE4_MUTEX_NREF
 1

	)

35 
	#SQLITE4_MUTEX_NREF
 0

	)

38 
±hªadMuãxInô
(*
p
);

39 
±hªadMuãxEnd
(*
p
);

40 
sqlôe4_muãx
 *
±hªadMuãxAŒoc
(*
pMuãxEnv
, 
iTy≥
);

41 
±hªadMuãxFªe
(
sqlôe4_muãx
 *
pMuãx
);

42 
±hªadMuãxE¡î
(
sqlôe4_muãx
 *
pMuãx
);

43 
±hªadMuãxTry
(
sqlôe4_muãx
 *
pMuãx
);

44 
±hªadMuãxLóve
(
sqlôe4_muãx
 *
pMuãx
);

45 #ifde‡
SQLITE4_DEBUG


46 
±hªadMuãxHñd
(
sqlôe4_muãx
 *
pMuãx
);

47 
±hªadMuãxNŸhñd
(
sqlôe4_muãx
 *
pMuãx
);

50 c⁄° 
sqlôe4_muãx_mëhods
 
	gsMuãxMëhods
 = {

51 
±hªadMuãxInô
,

52 
±hªadMuãxEnd
,

53 
±hªadMuãxAŒoc
,

54 
±hªadMuãxFªe
,

55 
±hªadMuãxE¡î
,

56 
±hªadMuãxTry
,

57 
±hªadMuãxLóve
,

58 #ifde‡
SQLITE4_DEBUG


59 
±hªadMuãxHñd
,

60 
±hªadMuãxNŸhñd
,

71 
	ssqlôe4UnixMuãx
 {

72 
sqlôe4_muãx
 
	mba£
;

73 
±hªad_muãx_t
 
	mmuãx
;

74 #i‡
SQLITE4_MUTEX_NREF


75 
	mid
;

76 vﬁ©ûê
	mnRef
;

77 vﬁ©ûê
±hªad_t
 
	mow√r
;

78 
	måa˚
;

80 } 
	tsqlôe4UnixMuãx
;

81 #i‡
SQLITE4_MUTEX_NREF


82 
	#SQLITE4_MUTEX_INITIALIZER
 \

83 { {&
sMuãxMëhods
}, 
PTHREAD_MUTEX_INITIALIZER
, 0, 0, (
±hªad_t
)0, 0 }

	)

85 
	#SQLITE4_MUTEX_INITIALIZER
 \

86 { {&
sMuãxMëhods
}, 
PTHREAD_MUTEX_INITIALIZER
 }

	)

105 #i‡!
deföed
(
NDEBUG
Ë|| deföed(
SQLITE4_DEBUG
)

106 
	$±hªadMuãxHñd
(
sqlôe4_muãx
 *
pMuãx
){

107 
sqlôe4UnixMuãx
 *
p
 = (sqlôe4UnixMuãx*)
pMuãx
;

108  (
p
->
nRef
!=0 && 
	`±hªad_equÆ
’->
ow√r
, 
	`±hªad_£lf
()));

109 
	}
}

110 
	$±hªadMuãxNŸhñd
(
sqlôe4_muãx
 *
pMuãx
){

111 
sqlôe4UnixMuãx
 *
p
 = (sqlôe4UnixMuãx*)
pMuãx
;

112  
p
->
nRef
==0 || 
	`±hªad_equÆ
’->
ow√r
, 
	`±hªad_£lf
())==0;

113 
	}
}

119 
	$±hªadMuãxInô
(*
p
){ 
	`UNUSED_PARAMETER
’);  
SQLITE4_OK
; 
	}
}

120 
	$±hªadMuãxEnd
(*
p
){ 
	`UNUSED_PARAMETER
’);  
SQLITE4_OK
; 
	}
}

164 
sqlôe4_muãx
 *
	$±hªadMuãxAŒoc
(*
pMuãxEnv
, 
iTy≥
){

165 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív*)
pMuãxEnv
;

166 
sqlôe4UnixMuãx
 *
p
;

168 
sqlôe4UnixMuãx
 
aSèticMuãx
[] = {

169 
SQLITE4_MUTEX_INITIALIZER


172  
iTy≥
 ){

173 
SQLITE4_MUTEX_RECURSIVE
: {

174 
p
 = 
	`sqlôe4MÆlocZîo
(
pEnv
, (*p) );

175 if–
p
 ){

176 #ifde‡
SQLITE4_HOMEGROWN_RECURSIVE_MUTEX


179 
	`±hªad_muãx_öô
(&
p
->
muãx
, 0);

182 
±hªad_muãx©å_t
 
ªcursiveAâr
;

183 
	`±hªad_muãx©å_öô
(&
ªcursiveAâr
);

184 
	`±hªad_muãx©å_£ây≥
(&
ªcursiveAâr
, 
PTHREAD_MUTEX_RECURSIVE
);

185 
	`±hªad_muãx_öô
(&
p
->
muãx
, &
ªcursiveAâr
);

186 
	`±hªad_muãx©å_de°roy
(&
ªcursiveAâr
);

188 #i‡
SQLITE4_MUTEX_NREF


189 
p
->
id
 = 
iTy≥
;

191 
p
->
ba£
.
pMuãxMëhods
 = &
pEnv
->
muãx
;

195 
SQLITE4_MUTEX_FAST
: {

196 
p
 = 
	`sqlôe4MÆlocZîo
(
pEnv
, (*p) );

197 if–
p
 ){

198 #i‡
SQLITE4_MUTEX_NREF


199 
p
->
id
 = 
iTy≥
;

201 
	`±hªad_muãx_öô
(&
p
->
muãx
, 0);

202 
p
->
ba£
.
pMuãxMëhods
 = &
pEnv
->
muãx
;

203 
	`as£π
–
p
->
ba£
.
pMuãxMëhods
->
pMuãxEnv
==(*)
pEnv
 );

208 
	`as£π
–
SQLITE4_MUTEX_RECURSIVE
==1 && 
SQLITE4_MUTEX_FAST
==0 );

209 
	`as£π
–(
iTy≥
-2)<
	`AºaySize
(
aSèticMuãx
) );

210 
p
 = &
aSèticMuãx
[
iTy≥
-2];

214  (
sqlôe4_muãx
*)
p
;

215 
	}
}

223 
	$±hªadMuãxFªe
(
sqlôe4_muãx
 *
pMuãx
){

224 
sqlôe4UnixMuãx
 *
p
 = (sqlôe4UnixMuãx*)
pMuãx
;

225 
sqlôe4_ív
 *
pEnv
;

226 
	`as£π
–
p
->
nRef
==0 );

227 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_FAST
 ||Ö->id==
SQLITE4_MUTEX_RECURSIVE
 );

228 
	`±hªad_muãx_de°roy
(&
p
->
muãx
);

229 
pEnv
 = (
sqlôe4_ív
*)
p
->
ba£
.
pMuãxMëhods
->
pMuãxEnv
;

230 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

231 
	}
}

244 
	$±hªadMuãxE¡î
(
sqlôe4_muãx
 *
pMuãx
){

245 
sqlôe4UnixMuãx
 *
p
 = (sqlôe4UnixMuãx*)
pMuãx
;

246 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`±hªadMuãxNŸhñd
(
pMuãx
) );

248 #ifde‡
SQLITE4_HOMEGROWN_RECURSIVE_MUTEX


260 
±hªad_t
 
£lf
 = 
	`±hªad_£lf
();

261 if–
p
->
nRef
>0 && 
	`±hªad_equÆ
’->
ow√r
, 
£lf
) ){

262 
p
->
nRef
++;

264 
	`±hªad_muãx_lock
(&
p
->
muãx
);

265 
	`as£π
–
p
->
nRef
==0 );

266 
p
->
ow√r
 = 
£lf
;

267 
p
->
nRef
 = 1;

273 
	`±hªad_muãx_lock
(&
p
->
muãx
);

274 #i‡
SQLITE4_MUTEX_NREF


275 
	`as£π
–
p
->
nRef
>0 ||Ö->
ow√r
==0 );

276 
p
->
ow√r
 = 
	`±hªad_£lf
();

277 
p
->
nRef
++;

281 #ifde‡
SQLITE4_DEBUG


282 if–
p
->
åa˚
 ){

283 
	`¥ötf
("íã∏muãx %∞(%dËwôhÇRef=%d\n", 
p
,Ö->
åa˚
,Ö->
nRef
);

286 
	}
}

287 
	$±hªadMuãxTry
(
sqlôe4_muãx
 *
pMuãx
){

288 
rc
;

289 
sqlôe4UnixMuãx
 *
p
 = (sqlôe4UnixMuãx*)
pMuãx
;

290 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`±hªadMuãxNŸhñd
(
pMuãx
) );

292 #ifde‡
SQLITE4_HOMEGROWN_RECURSIVE_MUTEX


304 
±hªad_t
 
£lf
 = 
	`±hªad_£lf
();

305 if–
p
->
nRef
>0 && 
	`±hªad_equÆ
’->
ow√r
, 
£lf
) ){

306 
p
->
nRef
++;

307 
rc
 = 
SQLITE4_OK
;

308 }if–
	`±hªad_muãx_åylock
(&
p
->
muãx
)==0 ){

309 
	`as£π
–
p
->
nRef
==0 );

310 
p
->
ow√r
 = 
£lf
;

311 
p
->
nRef
 = 1;

312 
rc
 = 
SQLITE4_OK
;

314 
rc
 = 
SQLITE4_BUSY
;

320 if–
	`±hªad_muãx_åylock
(&
p
->
muãx
)==0 ){

321 #i‡
SQLITE4_MUTEX_NREF


322 
p
->
ow√r
 = 
	`±hªad_£lf
();

323 
p
->
nRef
++;

325 
rc
 = 
SQLITE4_OK
;

327 
rc
 = 
SQLITE4_BUSY
;

331 #ifde‡
SQLITE4_DEBUG


332 if–
rc
==
SQLITE4_OK
 && 
p
->
åa˚
 ){

333 
	`¥ötf
("íã∏muãx %∞(%dËwôhÇRef=%d\n", 
p
,Ö->
åa˚
,Ö->
nRef
);

336  
rc
;

337 
	}
}

345 
	$±hªadMuãxLóve
(
sqlôe4_muãx
 *
pMuãx
){

346 
sqlôe4UnixMuãx
 *
p
 = (sqlôe4UnixMuãx*)
pMuãx
;

347 
	`as£π
–
	`±hªadMuãxHñd
(
pMuãx
) );

348 #i‡
SQLITE4_MUTEX_NREF


349 
p
->
nRef
--;

350 if–
p
->
nRef
==0 )Ö->
ow√r
 = 0;

352 
	`as£π
–
p
->
nRef
==0 ||Ö->
id
==
SQLITE4_MUTEX_RECURSIVE
 );

354 #ifde‡
SQLITE4_HOMEGROWN_RECURSIVE_MUTEX


355 if–
p
->
nRef
==0 ){

356 
	`±hªad_muãx_u∆ock
(&
p
->
muãx
);

359 
	`±hªad_muãx_u∆ock
(&
p
->
muãx
);

362 #ifde‡
SQLITE4_DEBUG


363 if–
p
->
åa˚
 ){

364 
	`¥ötf
("Àavêmuãx %∞(%dËwôhÇRef=%d\n", 
p
,Ö->
åa˚
,Ö->
nRef
);

367 
	}
}

369 
sqlôe4_muãx_mëhods
 c⁄° *
	$sqlôe4DeÁu…Muãx
(){

370  &
sMuãxMëhods
;

371 
	}
}

	@src/mutex_w32.c

14 
	~"sqlôeI¡.h
"

20 #ifde‡
SQLITE4_MUTEX_W32


25 
	ssqlôe4_muãx
 {

26 
CRITICAL_SECTION
 
	mmuãx
;

27 
	mid
;

28 #ifde‡
SQLITE4_DEBUG


29 vﬁ©ûê
	mnRef
;

30 vﬁ©ûê
DWORD
 
	mow√r
;

31 
	måa˚
;

34 
	#SQLITE4_W32_MUTEX_INITIALIZER
 { 0 }

	)

35 #ifde‡
SQLITE4_DEBUG


36 
	#SQLITE3_MUTEX_INITIALIZER
 { 
SQLITE4_W32_MUTEX_INITIALIZER
, 0, 0L, (
DWORD
)0, 0 }

	)

38 
	#SQLITE3_MUTEX_INITIALIZER
 { 
SQLITE4_W32_MUTEX_INITIALIZER
, 0 }

	)

59 #i‡
SQLITE4_OS_WINCE


60 
	#muãxIsNT
(Ë(1)

	)

62 
	$muãxIsNT
(){

63 
osTy≥
 = 0;

64 if–
osTy≥
==0 ){

65 
OSVERSIONINFO
 
sInfo
;

66 
sInfo
.
dwOSVîsi⁄InfoSize
 = (sInfo);

67 
	`GëVîsi⁄Ex
(&
sInfo
);

68 
osTy≥
 = 
sInfo
.
dwPœtf‹mId
==
VER_PLATFORM_WIN32_NT
 ? 2 : 1;

70  
osTy≥
==2;

71 
	}
}

75 #ifde‡
SQLITE4_DEBUG


80 
	$wöMuãxHñd
(
sqlôe4_muãx
 *
p
){

81  
p
->
nRef
!=0 &&Ö->
ow√r
==
	`GëCuºítThªadId
();

82 
	}
}

83 
	$wöMuãxNŸhñd2
(
sqlôe4_muãx
 *
p
, 
DWORD
 
tid
){

84  
p
->
nRef
==0 ||Ö->
ow√r
!=
tid
;

85 
	}
}

86 
	$wöMuãxNŸhñd
(
sqlôe4_muãx
 *
p
){

87 
DWORD
 
tid
 = 
	`GëCuºítThªadId
();

88  
	`wöMuãxNŸhñd2
(
p
, 
tid
);

89 
	}
}

96 
sqlôe4_muãx
 
	gwöMuãx_°©icMuãxes
[6] = {

97 
SQLITE3_MUTEX_INITIALIZER
,

98 
SQLITE3_MUTEX_INITIALIZER
,

99 
SQLITE3_MUTEX_INITIALIZER
,

100 
SQLITE3_MUTEX_INITIALIZER
,

101 
SQLITE3_MUTEX_INITIALIZER
,

102 
SQLITE3_MUTEX_INITIALIZER


104 
	gwöMuãx_isInô
 = 0;

110 
	gwöMuãx_lock
 = 0;

112 
	$wöMuãxInô
(){

114 if–
	`I¡îlockedCom∑ªExch™ge
(&
wöMuãx_lock
, 1, 0)==0 ){

115 
i
;

116 
i
=0; i<
	`AºaySize
(
wöMuãx_°©icMuãxes
); i++){

117 
	`InôülizeCrôiˇlSe˘i⁄
(&
wöMuãx_°©icMuãxes
[
i
].
muãx
);

119 
wöMuãx_isInô
 = 1;

122  !
wöMuãx_isInô
 ){

123 
	`SÀï
(1);

126  
SQLITE4_OK
;

127 
	}
}

129 
	$wöMuãxEnd
(){

132 if–
	`I¡îlockedCom∑ªExch™ge
(&
wöMuãx_lock
, 0, 1)==1 ){

133 if–
wöMuãx_isInô
==1 ){

134 
i
;

135 
i
=0; i<
	`AºaySize
(
wöMuãx_°©icMuãxes
); i++){

136 
	`DñëeCrôiˇlSe˘i⁄
(&
wöMuãx_°©icMuãxes
[
i
].
muãx
);

138 
wöMuãx_isInô
 = 0;

141  
SQLITE4_OK
;

142 
	}
}

186 
sqlôe4_muãx
 *
	$wöMuãxAŒoc
(
iTy≥
){

187 
sqlôe4_muãx
 *
p
;

189  
iTy≥
 ){

190 
SQLITE4_MUTEX_FAST
:

191 
SQLITE4_MUTEX_RECURSIVE
: {

192 
p
 = 
	`sqlôe4MÆlocZîo
(0, (*p) );

193 if–
p
 ){

194 #ifde‡
SQLITE4_DEBUG


195 
p
->
id
 = 
iTy≥
;

197 
	`InôülizeCrôiˇlSe˘i⁄
(&
p
->
muãx
);

202 
	`as£π
–
wöMuãx_isInô
==1 );

203 
	`as£π
–
iTy≥
-2 >= 0 );

204 
	`as£π
–
iTy≥
-2 < 
	`AºaySize
(
wöMuãx_°©icMuãxes
) );

205 
p
 = &
wöMuãx_°©icMuãxes
[
iTy≥
-2];

206 #ifde‡
SQLITE4_DEBUG


207 
p
->
id
 = 
iTy≥
;

212  
p
;

213 
	}
}

221 
	$wöMuãxFªe
(
sqlôe4_muãx
 *
p
){

222 
	`as£π
–
p
 );

223 
	`as£π
–
p
->
nRef
==0 &&Ö->
ow√r
==0 );

224 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_FAST
 ||Ö->id==
SQLITE4_MUTEX_RECURSIVE
 );

225 
	`DñëeCrôiˇlSe˘i⁄
(&
p
->
muãx
);

226 
	`sqlôe4_‰ì
(0, 
p
);

227 
	}
}

240 
	$wöMuãxE¡î
(
sqlôe4_muãx
 *
p
){

241 #ifde‡
SQLITE4_DEBUG


242 
DWORD
 
tid
 = 
	`GëCuºítThªadId
();

243 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`wöMuãxNŸhñd2
’, 
tid
) );

245 
	`E¡îCrôiˇlSe˘i⁄
(&
p
->
muãx
);

246 #ifde‡
SQLITE4_DEBUG


247 
	`as£π
–
p
->
nRef
>0 ||Ö->
ow√r
==0 );

248 
p
->
ow√r
 = 
tid
;

249 
p
->
nRef
++;

250 if–
p
->
åa˚
 ){

251 
	`¥ötf
("íã∏muãx %∞(%dËwôhÇRef=%d\n", 
p
,Ö->
åa˚
,Ö->
nRef
);

254 
	}
}

255 
	$wöMuãxTry
(
sqlôe4_muãx
 *
p
){

256 #i‚de‡
NDEBUG


257 
DWORD
 
tid
 = 
	`GëCuºítThªadId
();

259 
rc
 = 
SQLITE4_BUSY
;

260 
	`as£π
–
p
->
id
==
SQLITE4_MUTEX_RECURSIVE
 || 
	`wöMuãxNŸhñd2
’, 
tid
) );

273 if–
	`muãxIsNT
(Ë&& 
	`TryE¡îCrôiˇlSe˘i⁄
(&
p
->
muãx
) ){

274 
p
->
ow√r
 = 
tid
;

275 
p
->
nRef
++;

276 
rc
 = 
SQLITE4_OK
;

279 
	`UNUSED_PARAMETER
(
p
);

281 #ifde‡
SQLITE4_DEBUG


282 if–
rc
==
SQLITE4_OK
 && 
p
->
åa˚
 ){

283 
	`¥ötf
("åy muãx %∞(%dËwôhÇRef=%d\n", 
p
,Ö->
åa˚
,Ö->
nRef
);

286  
rc
;

287 
	}
}

295 
	$wöMuãxLóve
(
sqlôe4_muãx
 *
p
){

296 #i‚de‡
NDEBUG


297 
DWORD
 
tid
 = 
	`GëCuºítThªadId
();

298 
	`as£π
–
p
->
nRef
>0 );

299 
	`as£π
–
p
->
ow√r
==
tid
 );

300 
p
->
nRef
--;

301 if–
p
->
nRef
==0 )Ö->
ow√r
 = 0;

302 
	`as£π
–
p
->
nRef
==0 ||Ö->
id
==
SQLITE4_MUTEX_RECURSIVE
 );

304 
	`LóveCrôiˇlSe˘i⁄
(&
p
->
muãx
);

305 #ifde‡
SQLITE4_DEBUG


306 if–
p
->
åa˚
 ){

307 
	`¥ötf
("Àavêmuãx %∞(%dËwôhÇRef=%d\n", 
p
,Ö->
åa˚
,Ö->
nRef
);

310 
	}
}

312 
sqlôe4_muãx_mëhods
 c⁄° *
	$sqlôe4DeÁu…Muãx
(){

313 c⁄° 
sqlôe4_muãx_mëhods
 
sMuãx
 = {

314 
wöMuãxInô
,

315 
wöMuãxEnd
,

316 
wöMuãxAŒoc
,

317 
wöMuãxFªe
,

318 
wöMuãxE¡î
,

319 
wöMuãxTry
,

320 
wöMuãxLóve
,

321 #ifde‡
SQLITE4_DEBUG


322 
wöMuãxHñd
,

323 
wöMuãxNŸhñd


330  &
sMuãx
;

331 
	}
}

	@src/os.c

16 
	#_SQLITE4_OS_C_
 1

	)

17 
	~"sqlôeI¡.h
"

18 #unde‡
_SQLITE4_OS_C_


20 #i‡
SQLITE4_OS_UNIX


21 
	~<sys/time.h
>

29 
	gsqlôe4_cuºít_time
 = 0;

30 
	$sqlôe4OsCuºítTime
(
sqlôe4_ív
 *
pEnv
, 
sqlôe4_uöt64
 *
pTimeOut
){

31 c⁄° 
sqlôe4_uöt64
 
unixEpoch
 = 24405875*(
sqlôe4_öt64
)8640000;

32 
rc
 = 
SQLITE4_OK
;

33 if–
sqlôe4_cuºít_time
 ){

34 *
pTimeOut
 = 
unixEpoch
 + (
sqlôe4_uöt64
)
sqlôe4_cuºít_time
 * 1000;

35  
SQLITE4_OK
;

37 #i‡
SQLITE4_OS_UNIX


38 
timevÆ
 
sNow
;

39 if–
	`gëtimeofday
(&
sNow
, 0)==0 ){

40 *
pTimeOut
 = 
unixEpoch
 + 1000*(
sqlôe4_öt64
)
sNow
.
tv_£c
 + sNow.
tv_u£c
/1000;

42 
rc
 = 
SQLITE4_ERROR
;

44 
	`UNUSED_PARAMETER
(
pEnv
);

46 #i‡
SQLITE4_OS_WIN


47 
FILETIME
 
·
;

48 c⁄° 
sqlôe4_öt64
 
wöFûëimeEpoch
 =

49 23058135*(
sqlôe4_öt64
)8640000;

51 c⁄° 
sqlôe4_öt64
 
max32BôVÆue
 =

52 (
sqlôe4_öt64
)2000000000 + (sqlite4_int64)2000000000

53 + (
sqlôe4_öt64
)294967296;

54 
	`GëSy°emTimeAsFûeTime
–&
·
 );

55 *
pTimeOut
 = 
wöFûëimeEpoch
 +

56 ((((
sqlôe4_öt64
)
·
.
dwHighD©eTime
)*
max32BôVÆue
) +

57 (
sqlôe4_öt64
)
·
.
dwLowD©eTime
)/(sqlite4_int64)10000;

58 
	`UNUSED_PARAMETER
(
pEnv
);

60  
rc
;

61 
	}
}

67 
	$sqlôe4OsR™dom√ss
(
sqlôe4_ív
 *
pEnv
, 
nByã
, *
zBufOut
){

68 
sqlôe4_uöt64
 
˙t
 = 0;

69 *
p
;

70 
i
;

71 
sqlôe4_uöt64
 
now
;

72 
sqlôe4_uöt64
 
x
 = 0;

74 #i‡0 && 
SQLITE4_OS_UNIX


75 
fd
 = 
	`›í
("/dev/uøndom", 
O_RDONLY
, 0);

76 if–
fd
>=0 ){

77 
	`ªad
(
fd
, 
zBufOut
, 
nByã
);

78 
	`˛o£
(
fd
);

80 
x
 = 
	`gëpid
();

82 
	`sqlôe4OsCuºítTime
(
pEnv
, &
now
);

83 
x
 ^
now
;

84 
	`mem£t
(
zBufOut
, 0, 
nByã
);

85 
˙t
++;

86 
x
 ^
˙t
;

87 
p
 = (*)&
x
;

88 
i
=0; i<8; i++Ë
zBufOut
[i%
nByã
] ^
p
[i];

90  
SQLITE4_OK
;

91 
	}
}

99 
	$sqlôe4OsInô
(
sqlôe4_ív
 *
pEnv
){

100 *
p
 = 
	`sqlôe4_mÆloc
(
pEnv
, 10);

101 if–
p
==0 )  
SQLITE4_NOMEM
;

102 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

103 
	`sqlôe4OsR™dom√ss
(
pEnv
, 8, (*)&pEnv->
¥ngX
);

104  
SQLITE4_OK
;

105 
	}
}

	@src/os.h

20 #i‚de‡
_SQLITE4_OS_H_


21 
	#_SQLITE4_OS_H_


	)

30 #i‡
deföed
(
SQLITE4_OS_OTHER
)

31 #i‡
SQLITE4_OS_OTHER
==1

32 #unde‡
SQLITE4_OS_UNIX


33 
	#SQLITE4_OS_UNIX
 0

	)

34 #unde‡
SQLITE4_OS_WIN


35 
	#SQLITE4_OS_WIN
 0

	)

36 #unde‡
SQLITE4_OS_WINRT


37 
	#SQLITE4_OS_WINRT
 0

	)

39 #unde‡
SQLITE4_OS_OTHER


42 #i‡!
deföed
(
SQLITE4_OS_UNIX
Ë&& !deföed(
SQLITE4_OS_OTHER
)

43 
	#SQLITE4_OS_OTHER
 0

	)

44 #i‚de‡
SQLITE4_OS_WIN


45 #i‡
deföed
(
_WIN32
Ë|| deföed(
WIN32
Ë|| deföed(
__CYGWIN__
) \

46 || 
deföed
(
__MINGW32__
Ë|| 
	$deföed
(
__BORLANDC__
)

47 
	#SQLITE4_OS_WIN
 1

	)

48 
	#SQLITE4_OS_UNIX
 0

	)

49 
	#SQLITE4_OS_WINRT
 0

	)

51 
	#SQLITE4_OS_WIN
 0

	)

52 
	#SQLITE4_OS_UNIX
 1

	)

53 
	#SQLITE4_OS_WINRT
 0

	)

56 
	#SQLITE4_OS_UNIX
 0

	)

57 
	#SQLITE4_OS_WINRT
 0

	)

60 #i‚de‡
SQLITE4_OS_WIN


61 
	#SQLITE4_OS_WIN
 0

	)

68 #i‡
SQLITE4_OS_WIN


69 
	~<wödows.h
>

70 
	#SQLITE4_TEMPNAME_SIZE
 (
MAX_PATH
+50)

	)

72 
	#SQLITE4_TEMPNAME_SIZE
 200

	)

78 
	`sqlôe4OsInô
(
sqlôe4_ív
*);

79 
	`sqlôe4OsR™dom√ss
(
sqlôe4_ív
*, , *);

80 
	`sqlôe4OsCuºítTime
(
sqlôe4_ív
*, 
sqlôe4_uöt64
*);

	@src/parse.y

19 %
tokí_¥efix
 
TK_


24 %
tokí_ty≥
 {
Tokí
}

25 %
deÁu…_ty≥
 {
Tokí
}

28 %
exåa_¨gumít
 {
P¨£
 *
pP¨£
}

32 %
sy¡ax_îr‹
 {

33 
UNUSED_PARAMETER
(
yymaj‹
);

34 
as£π
–
TOKEN
.
z
[0] );

35 
sqlôe4Eº‹Msg
(
pP¨£
, "√¨ \"%T\": sy¡axÉº‹", &
TOKEN
);

37 %
°ack_ovîÊow
 {

38 
UNUSED_PARAMETER
(
yypMö‹
);

39 
sqlôe4Eº‹Msg
(
pP¨£
, "parser stack overflow");

44 %
«me
 
sqlôe4P¨£r


49 %
ö˛ude
 {

50 
	~"sqlôeI¡.h
"

56 
	#YYNOERRORRECOVERY
 1

	)

61 
	#yyã°ˇ£
(
X
Ë
	`ã°ˇ£
(X)

	)

67 
	sLimôVÆ
 {

68 
Ex¥
 *
pLimô
;

69 
Ex¥
 *
pOff£t
;

76 
	sLikeOp
 {

77 
Tokí
 
eO≥øt‹
;

78 
nŸ
;

90 
	sTrigEvít
 { 
a
; 
IdLi°
 * 
b
; };

95 
	sAâachKey
 { 
ty≥
; 
Tokí
 
key
; };

100 
	sVÆueLi°
 {

101 
Ex¥Li°
 *
pLi°
;

102 
Sñe˘
 *
pSñe˘
;

108 
	sCovîögO±
 { 
IdLi°
 *
pLi°
; 
Tokí
 
sEnd
; };

113 
öput
 ::
cmdli°
.

114 
cmdli°
 ::cmdli° 
ecmd
.

115 
cmdli°
 ::
ecmd
.

116 
ecmd
 ::
SEMI
.

117 
ecmd
 ::
ex∂aö
 
cmdx
 
SEMI
.

118 
ex∂aö
 ::. { 
sqlôe4BegöP¨£
(
pP¨£
, 0); }

119 %
i‚def
 
SQLITE4_OMIT_EXPLAIN


120 
ex∂aö
 ::
EXPLAIN
. { 
sqlôe4BegöP¨£
(
pP¨£
, 1); }

121 
ex∂aö
 ::
EXPLAIN
 
QUERY
 
PLAN
. { 
sqlôe4BegöP¨£
(
pP¨£
, 2); }

122 %
ídif
 
SQLITE4_OMIT_EXPLAIN


123 
cmdx
 ::
cmd
. { 
sqlôe4FöishCodög
(
pP¨£
); }

128 
cmd
 ::
BEGIN
 
	$å™°y≥
(
Y
Ë
å™s_›t
. {
	`sqlôe4BegöTønß˘i⁄
(
pP¨£
, Y);
	}
}

129 
å™s_›t
 ::= .

130 
å™s_›t
 ::
TRANSACTION
.

131 
å™s_›t
 ::
TRANSACTION
 
nm
.

132 %
ty≥
 
å™°y≥
 {}

133 
	$å™°y≥
(
A
Ë::. {A = 
TK_DEFERRED
;
	}
}

134 
	$å™°y≥
(
A
Ë::
	`DEFERRED
(
X
). {A = @X;
	}
}

135 
	$å™°y≥
(
A
Ë::
	`IMMEDIATE
(
X
). {A = @X;
	}
}

136 
	$å™°y≥
(
A
Ë::
	`EXCLUSIVE
(
X
). {A = @X;
	}
}

137 
cmd
 ::
COMMIT
 
å™s_›t
. {
sqlôe4EndTønß˘i⁄
(
pP¨£
, 
SAVEPOINT_RELEASE
);}

138 
cmd
 ::
END
 
å™s_›t
. {
sqlôe4EndTønß˘i⁄
(
pP¨£
, 
SAVEPOINT_RELEASE
);}

139 
cmd
 ::
ROLLBACK
 
å™s_›t
. {
sqlôe4EndTønß˘i⁄
(
pP¨£
, 
SAVEPOINT_ROLLBACK
);}

141 
ßvïoöt_›t
 ::
SAVEPOINT
.

142 
ßvïoöt_›t
 ::= .

143 
cmd
 ::
SAVEPOINT
 
nm
(
X
). {

144 
sqlôe4Savïoöt
(
pP¨£
, 
SAVEPOINT_BEGIN
, &
X
);

146 
cmd
 ::
RELEASE
 
ßvïoöt_›t
 
nm
(
X
). {

147 
sqlôe4Savïoöt
(
pP¨£
, 
SAVEPOINT_RELEASE
, &
X
);

149 
cmd
 ::
ROLLBACK
 
å™s_›t
 
TO
 
ßvïoöt_›t
 
nm
(
X
). {

150 
sqlôe4Savïoöt
(
pP¨£
, 
SAVEPOINT_ROLLBACK
, &
X
);

155 
cmd
 ::
¸óã_èbÀ
 
¸óã_èbÀ_¨gs
.

156 
¸óã_èbÀ
 ::
¸óãkw
 
	$ãmp
(
T
Ë
TABLE
 
	$i‚Ÿexi°s
(
E
Ë
	$nm
(
Y
Ë
	`dbnm
(
Z
). {

157 
	`sqlôe4SèπTabÀ
(
pP¨£
,&
Y
,&
Z
,
T
,0,0,
E
);

158 
	}
}

159 
	$¸óãkw
(
A
Ë::
	`CREATE
(
X
). {

160 
pP¨£
->
db
->
lookaside
.
bE«bÀd
 = 0;

161 
A
 = 
X
;

162 
	}
}

163 %
ty≥
 
i‚Ÿexi°s
 {}

164 
	$i‚Ÿexi°s
(
A
Ë::. {A = 0;
	}
}

165 
	$i‚Ÿexi°s
(
A
Ë::
IF
 
NOT
 
EXISTS
. {A = 1;
	}
}

166 %
ty≥
 
ãmp
 {}

167 %
i‚def
 
SQLITE4_OMIT_TEMPDB


168 
	$ãmp
(
A
Ë::
TEMP
. {A = 1;
	}
}

169 %
ídif
 
SQLITE4_OMIT_TEMPDB


170 
	$ãmp
(
A
Ë::. {A = 0;
	}
}

171 
¸óã_èbÀ_¨gs
 ::
LP
 
cﬁum∆i°
 
	$c⁄¶i°_›t
(
X
Ë
	`RP
(
Y
). {

172 
	`sqlôe4EndTabÀ
(
pP¨£
,&
X
,&
Y
,0);

173 
	}
}

174 
¸óã_èbÀ_¨gs
 ::
AS
 
£À˘
(
S
). {

175 
sqlôe4EndTabÀ
(
pP¨£
,0,0,
S
);

176 
sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
S
);

178 
cﬁum∆i°
 ::cﬁum∆i° 
COMMA
 
cﬁumn
.

179 
cﬁum∆i°
 ::
cﬁumn
.

186 
	$cﬁumn
(
A
Ë::
	$cﬁumnid
(
X
Ë
ty≥
 
ˇrgli°
. {

187 
A
.
z
 = 
X
.z;

188 
A
.
n
 = ()(
pP¨£
->
sLa°Tokí
.
z
-
X
.z) +ÖParse->sLastToken.n;

189 
	}
}

190 
	$cﬁumnid
(
A
Ë::
	`nm
(
X
). {

191 
	`sqlôe4AddCﬁumn
(
pP¨£
,&
X
);

192 
A
 = 
X
;

193 
	}
}

199 %
ty≥
 
id
 {
Tokí
}

200 
	$id
(
A
Ë::
	`ID
(
X
). {A = X;
	}
}

201 
	$id
(
A
Ë::
	`INDEXED
(
X
). {A = X;
	}
}

207 %
ÁŒback
 
ID


208 
ABORT
 
ACTION
 
AFTER
 
ANALYZE
 
ASC
 
ATTACH
 
BEFORE
 
BEGIN
 
BY
 
CASCADE
 
CAST
 
COLUMNKW


209 
CONFLICT
 
DATABASE
 
DEFERRED
 
DESC
 
DETACH
 
EACH
 
END
 
EXCLUSIVE
 
EXPLAIN
 
FAIL
 
FOR


210 
IGNORE
 
IMMEDIATE
 
INITIALLY
 
INSTEAD
 
LIKE_KW
 
MATCH
 
NO
 
PLAN


211 
QUERY
 
KEY
 
OF
 
OFFSET
 
PRAGMA
 
RAISE
 
RELEASE
 
REPLACE
 
RESTRICT
 
ROW
 
ROLLBACK


212 
SAVEPOINT
 
TEMP
 
TRIGGER
 
VIEW
 
VIRTUAL


213 %
ifdef
 
SQLITE4_OMIT_COMPOUND_SELECT


214 
EXCEPT
 
INTERSECT
 
UNION


215 %
ídif
 
SQLITE4_OMIT_COMPOUND_SELECT


216 
REINDEX
 
RENAME
 
CTIME_KW
 
IF


218 %
wûdˇrd
 
ANY
.

231 %
À·
 
OR
.

232 %
À·
 
AND
.

233 %
right
 
NOT
.

234 %
À·
 
IS
 
MATCH
 
LIKE_KW
 
BETWEEN
 
IN
 
ISNULL
 
NOTNULL
 
NE
 
EQ
.

235 %
À·
 
GT
 
LE
 
LT
 
GE
.

236 %
right
 
ESCAPE
.

237 %
À·
 
BITAND
 
BITOR
 
LSHIFT
 
RSHIFT
.

238 %
À·
 
PLUS
 
MINUS
.

239 %
À·
 
STAR
 
SLASH
 
REM
.

240 %
À·
 
CONCAT
.

241 %
À·
 
COLLATE
.

242 %
right
 
BITNOT
.

246 %
ty≥
 
ids
 {
Tokí
}

247 
	$ids
(
A
Ë::
ID
|
	`STRING
(
X
). {A = X;
	}
}

251 %
ty≥
 
nm
 {
Tokí
}

252 
	$nm
(
A
Ë::
	`id
(
X
). {A = X;
	}
}

253 
	$nm
(
A
Ë::
	`STRING
(
X
). {A = X;
	}
}

254 
	$nm
(
A
Ë::
	`JOIN_KW
(
X
). {A = X;
	}
}

260 %
ty≥
 
ty≥tokí
 {
Tokí
}

261 
ty≥
 ::= .

262 
ty≥
 ::
ty≥tokí
(
X
). {
sqlôe4AddCﬁumnTy≥
(
pP¨£
,&X);}

263 
	$ty≥tokí
(
A
Ë::
	`ty≥«me
(
X
). {A = X;
	}
}

264 
	$ty≥tokí
(
A
Ë::
	$ty≥«me
(
X
Ë
LP
 sig√d 
	`RP
(
Y
). {

265 
A
.
z
 = 
X
.z;

266 
A
.
n
 = ()(&
Y
.
z
[Y.n] - 
X
.z);

267 
	}
}

268 
	$ty≥tokí
(
A
Ë::
	$ty≥«me
(
X
Ë
LP
 sig√d 
COMMA
 sig√d 
	`RP
(
Y
). {

269 
A
.
z
 = 
X
.z;

270 
A
.
n
 = ()(&
Y
.
z
[Y.n] - 
X
.z);

271 
	}
}

272 %
ty≥
 
ty≥«me
 {
Tokí
}

273 
	$ty≥«me
(
A
Ë::
	`ids
(
X
). {A = X;
	}
}

274 
	$ty≥«me
(
A
Ë::
	$ty≥«me
(
X
Ë
	`ids
(
Y
). {
A
.
z
=X.z; A.
n
=Y.n+()(Y.z-X.z);
	}
}

275 sig√d ::
∂us_num
.

276 sig√d ::
möus_num
.

281 
ˇrgli°
 ::ˇrgli° 
ˇrg
.

282 
ˇrgli°
 ::= .

283 
ˇrg
 ::
CONSTRAINT
 
nm
 
cc⁄s
.

284 
ˇrg
 ::
cc⁄s
.

285 
cc⁄s
 ::
DEFAULT
 
ãrm
(
X
). {
sqlôe4AddDeÁu…VÆue
(
pP¨£
,&X);}

286 
cc⁄s
 ::
DEFAULT
 
LP
 
	$ex¥
(
X
Ë
RP
. {
	`sqlôe4AddDeÁu…VÆue
(
pP¨£
,&X);
	}
}

287 
cc⁄s
 ::
DEFAULT
 
PLUS
 
ãrm
(
X
). {
sqlôe4AddDeÁu…VÆue
(
pP¨£
,&X);}

288 
cc⁄s
 ::
DEFAULT
 
	$MINUS
(
A
Ë
	`ãrm
(
X
). {

289 
Ex¥S∑n
 
v
;

290 
v
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_UMINUS
, 
X
.pExpr, 0, 0);

291 
v
.
zSèπ
 = 
A
.
z
;

292 
v
.
zEnd
 = 
X
.zEnd;

293 
	`sqlôe4AddDeÁu…VÆue
(
pP¨£
,&
v
);

294 
	}
}

295 
cc⁄s
 ::
DEFAULT
 
id
(
X
). {

296 
Ex¥S∑n
 
v
;

297 
•™Ex¥
(&
v
, 
pP¨£
, 
TK_STRING
, &
X
);

298 
sqlôe4AddDeÁu…VÆue
(
pP¨£
,&
v
);

304 
cc⁄s
 ::
NULL
 
⁄c⁄f
.

305 
cc⁄s
 ::
NOT
 
NULL
 
⁄c⁄f
(
R
). {
sqlôe4AddNŸNuŒ
(
pP¨£
, R);}

306 
cc⁄s
 ::
PRIMARY
 
KEY
 
	$s‹t‹dî
(
Z
Ë
	$⁄c⁄f
(
R
Ë
	`autoöc
(
I
).

307 {
	`sqlôe4AddPrim¨yKey
(
pP¨£
,0,
R
,
I
,
Z
);
	}
}

308 
cc⁄s
 ::
UNIQUE
 
⁄c⁄f
(
R
). {
sqlôe4Cª©eIndex
(
pP¨£
,0,0,0,R,0,0,0);}

309 
cc⁄s
 ::
CHECK
 
LP
 
	$ex¥
(
X
Ë
RP
. {
	`sqlôe4AddCheckC⁄°øöt
(
pP¨£
,X.
pEx¥
);
	}
}

310 
cc⁄s
 ::
REFERENCES
 
	$nm
(
T
Ë
	$idxli°_›t
(
TA
Ë
	`ªÁrgs
(
R
).

311 {
	`sqlôe4Cª©eF‹eignKey
(
pP¨£
,0,&
T
,
TA
,
R
);
	}
}

312 
cc⁄s
 ::
de„r_sub˛au£
(
D
). {
sqlôe4De„rF‹eignKey
(
pP¨£
,D);}

313 
cc⁄s
 ::
COLLATE
 
ids
(
C
). {
sqlôe4AddCﬁœãTy≥
(
pP¨£
, &C);}

316 %
ty≥
 
autoöc
 {}

317 
	$autoöc
(
X
Ë::. {X = 0;
	}
}

318 
	$autoöc
(
X
Ë::
AUTOINCR
. {X = 1;
	}
}

325 %
ty≥
 
ªÁrgs
 {}

326 
	$ªÁrgs
(
A
Ë::. { A = 
OE_N⁄e
*0x0101; 
	}
}

327 
	$ªÁrgs
(
A
Ë::
	$ªÁrgs
(
X
Ë
	`ªÁrg
(
Y
). { 
A
 = (X & ~Y.
mask
Ë| Y.
vÆue
; 
	}
}

328 %
ty≥
 
ªÁrg
 {°ru˘ {
vÆue
; 
mask
;}}

329 
	$ªÁrg
(
A
Ë::
MATCH
 
nm
. { A.
vÆue
 = 0; A.
mask
 = 0x000000; 
	}
}

330 
	$ªÁrg
(
A
Ë::
ON
 
INSERT
 
ªÁ˘
. { A.
vÆue
 = 0; A.
mask
 = 0x000000; 
	}
}

331 
	$ªÁrg
(
A
Ë::
ON
 
DELETE
 
	`ªÁ˘
(
X
). { A.
vÆue
 = X; A.
mask
 = 0x0000ff; 
	}
}

332 
	$ªÁrg
(
A
Ë::
ON
 
UPDATE
 
	`ªÁ˘
(
X
). { A.
vÆue
 = X<<8; A.
mask
 = 0x00ff00; 
	}
}

333 %
ty≥
 
ªÁ˘
 {}

334 
	$ªÁ˘
(
A
Ë::
SET
 
NULL
. { A = 
OE_SëNuŒ
; 
	}
}

335 
	$ªÁ˘
(
A
Ë::
SET
 
DEFAULT
. { A = 
OE_SëDÊt
; 
	}
}

336 
	$ªÁ˘
(
A
Ë::
CASCADE
. { A = 
OE_Casˇde
; 
	}
}

337 
	$ªÁ˘
(
A
Ë::
RESTRICT
. { A = 
OE_Re°ri˘
; 
	}
}

338 
	$ªÁ˘
(
A
Ë::
NO
 
ACTION
. { A = 
OE_N⁄e
; 
	}
}

339 %
ty≥
 
de„r_sub˛au£
 {}

340 
	$de„r_sub˛au£
(
A
Ë::
NOT
 
DEFERRABLE
 
öô_de„ºed_¥ed_›t
. {A = 0;
	}
}

341 
	$de„r_sub˛au£
(
A
Ë::
DEFERRABLE
 
	`öô_de„ºed_¥ed_›t
(
X
). {A = X;
	}
}

342 %
ty≥
 
öô_de„ºed_¥ed_›t
 {}

343 
	$öô_de„ºed_¥ed_›t
(
A
Ë::. {A = 0;
	}
}

344 
	$öô_de„ºed_¥ed_›t
(
A
Ë::
INITIALLY
 
DEFERRED
. {A = 1;
	}
}

345 
	$öô_de„ºed_¥ed_›t
(
A
Ë::
INITIALLY
 
IMMEDIATE
. {A = 0;
	}
}

350 
	$c⁄¶i°_›t
(
A
Ë::. {A.
n
 = 0; A.
z
 = 0;
	}
}

351 
	$c⁄¶i°_›t
(
A
Ë::
	$COMMA
(
X
Ë
c⁄¶i°
. {
A
 = X;
	}
}

352 
c⁄¶i°
 ::c⁄¶i° 
COMMA
 
tc⁄s
.

353 
c⁄¶i°
 ::c⁄¶i° 
tc⁄s
.

354 
c⁄¶i°
 ::
tc⁄s
.

355 
tc⁄s
 ::
CONSTRAINT
 
nm
.

356 
tc⁄s
 ::
PRIMARY
 
KEY
 
LP
 
	$idxli°
(
X
Ë
	$autoöc
(
I
Ë
RP
 
	`⁄c⁄f
(
R
).

357 {
	`sqlôe4AddPrim¨yKey
(
pP¨£
,
X
,
R
,
I
,0);
	}
}

358 
tc⁄s
 ::
UNIQUE
 
LP
 
	$idxli°
(
X
Ë
RP
 
	`⁄c⁄f
(
R
).

359 {
	`sqlôe4Cª©eIndex
(
pP¨£
,0,
X
,0,
R
,0,0,0);
	}
}

360 
tc⁄s
 ::
CHECK
 
LP
 
	$ex¥
(
E
Ë
RP
 
⁄c⁄f
.

361 {
	`sqlôe4AddCheckC⁄°øöt
(
pP¨£
,
E
.
pEx¥
);
	}
}

362 
tc⁄s
 ::
FOREIGN
 
KEY
 
LP
 
	$idxli°
(
FA
Ë
RP


363 
REFERENCES
 
	$nm
(
T
Ë
	$idxli°_›t
(
TA
Ë
	$ªÁrgs
(
R
Ë
	`de„r_sub˛au£_›t
(
D
). {

364 
	`sqlôe4Cª©eF‹eignKey
(
pP¨£
, 
FA
, &
T
, 
TA
, 
R
);

365 
	`sqlôe4De„rF‹eignKey
(
pP¨£
, 
D
);

366 
	}
}

367 %
ty≥
 
de„r_sub˛au£_›t
 {}

368 
	$de„r_sub˛au£_›t
(
A
Ë::. {A = 0;
	}
}

369 
	$de„r_sub˛au£_›t
(
A
Ë::
	`de„r_sub˛au£
(
X
). {A = X;
	}
}

374 %
ty≥
 
⁄c⁄f
 {}

375 %
ty≥
 
‹c⁄f
 {
u8
}

376 %
ty≥
 
ªsﬁvëy≥
 {}

377 
	$⁄c⁄f
(
A
Ë::. {A = 
OE_DeÁu…
;
	}
}

378 
	$⁄c⁄f
(
A
Ë::
ON
 
CONFLICT
 
	`ªsﬁvëy≥
(
X
). {A = X;
	}
}

379 
	$‹c⁄f
(
A
Ë::. {A = 
OE_DeÁu…
;
	}
}

380 
	$‹c⁄f
(
A
Ë::
OR
 
	`ªsﬁvëy≥
(
X
). {A = (
u8
)X;
	}
}

381 
	$ªsﬁvëy≥
(
A
Ë::
	`øi£ty≥
(
X
). {A = X;
	}
}

382 
	$ªsﬁvëy≥
(
A
Ë::
IGNORE
. {A = 
OE_Ign‹e
;
	}
}

383 
	$ªsﬁvëy≥
(
A
Ë::
REPLACE
. {A = 
OE_Rïœ˚
;
	}
}

387 
cmd
 ::
DROP
 
TABLE
 
	$i„xi°s
(
E
Ë
	`fuŒ«me
(
X
). {

388 
	`sqlôe4Dr›TabÀ
(
pP¨£
, 
X
, 0, 
E
);

389 
	}
}

390 %
ty≥
 
i„xi°s
 {}

391 
	$i„xi°s
(
A
Ë::
IF
 
EXISTS
. {A = 1;
	}
}

392 
	$i„xi°s
(
A
Ë::. {A = 0;
	}
}

396 %
i‚def
 
SQLITE4_OMIT_VIEW


397 
cmd
 ::
	$¸óãkw
(
X
Ë
	$ãmp
(
T
Ë
VIEW
 
	$i‚Ÿexi°s
(
E
Ë
	$nm
(
Y
Ë
	$dbnm
(
Z
Ë
AS
 
	`£À˘
(
S
). {

398 
	`sqlôe4Cª©eVõw
(
pP¨£
, &
X
, &
Y
, &
Z
, 
S
, 
T
, 
E
);

399 
	}
}

400 
cmd
 ::
DROP
 
VIEW
 
	$i„xi°s
(
E
Ë
	`fuŒ«me
(
X
). {

401 
	`sqlôe4Dr›TabÀ
(
pP¨£
, 
X
, 1, 
E
);

402 
	}
}

403 %
ídif
 
SQLITE4_OMIT_VIEW


407 
cmd
 ::
£À˘
(
X
). {

408 
Sñe˘De°
 
de°
 = {
SRT_Ouçut
, 0, 0, 0, 0};

409 
sqlôe4Sñe˘
(
pP¨£
, 
X
, &
de°
);

410 
sqlôe4Ex∂aöBegö
(
pP¨£
->
pVdbe
);

411 
sqlôe4Ex∂aöSñe˘
(
pP¨£
->
pVdbe
, 
X
);

412 
sqlôe4Ex∂aöFöish
(
pP¨£
->
pVdbe
);

413 
sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
X
);

416 %
ty≥
 
£À˘
 {
Sñe˘
*}

417 %
de°ru˘‹
 
£À˘
 {
sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
$$
);}

418 %
ty≥
 
⁄e£À˘
 {
Sñe˘
*}

419 %
de°ru˘‹
 
⁄e£À˘
 {
sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
$$
);}

421 
	$£À˘
(
A
Ë::
	`⁄e£À˘
(
X
). {A = X;
	}
}

422 %
i‚def
 
SQLITE4_OMIT_COMPOUND_SELECT


423 
	$£À˘
(
A
Ë::
	$£À˘
(
X
Ë
	$mu…i£À˘_›
(
Y
Ë
	`⁄e£À˘
(
Z
). {

424 if–
Z
 ){

425 
Z
->
›
 = (
u8
)
Y
;

426 
Z
->
pPri‹
 = 
X
;

428 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
X
);

430 
A
 = 
Z
;

431 
	}
}

432 %
ty≥
 
mu…i£À˘_›
 {}

433 
	$mu…i£À˘_›
(
A
Ë::
	`UNION
(
OP
). {A = @OP;
	}
}

434 
	$mu…i£À˘_›
(
A
Ë::
UNION
 
ALL
. {A = 
TK_ALL
;
	}
}

435 
	$mu…i£À˘_›
(
A
Ë::
EXCEPT
|
	`INTERSECT
(
OP
). {A = @OP;
	}
}

436 %
ídif
 
SQLITE4_OMIT_COMPOUND_SELECT


437 
	$⁄e£À˘
(
A
Ë::
SELECT
 
	$di°ö˘
(
D
Ë
	$£lcﬁli°
(
W
Ë
	$‰om
(
X
Ë
	$whîe_›t
(
Y
)

438 
	$groupby_›t
(
P
Ë
	$havög_›t
(
Q
Ë
	$‹dîby_›t
(
Z
Ë
	`limô_›t
(
L
). {

439 
A
 = 
	`sqlôe4Sñe˘New
(
pP¨£
,
W
,
X
,
Y
,
P
,
Q
,
Z
,
D
,
L
.
pLimô
,L.
pOff£t
);

440 
	}
}

445 %
ty≥
 
di°ö˘
 {}

446 
	$di°ö˘
(
A
Ë::
DISTINCT
. {A = 1;
	}
}

447 
	$di°ö˘
(
A
Ë::
ALL
. {A = 0;
	}
}

448 
	$di°ö˘
(
A
Ë::. {A = 0;
	}
}

455 %
ty≥
 
£lcﬁli°
 {
Ex¥Li°
*}

456 %
de°ru˘‹
 
£lcﬁli°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

457 %
ty≥
 
s˛p
 {
Ex¥Li°
*}

458 %
de°ru˘‹
 
s˛p
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

459 
	$s˛p
(
A
Ë::
	$£lcﬁli°
(
X
Ë
COMMA
. {
A
 = X;
	}
}

460 
	$s˛p
(
A
Ë::. {A = 0;
	}
}

461 
	$£lcﬁli°
(
A
Ë::
	$s˛p
(
P
Ë
	$ex¥
(
X
Ë
	`as
(
Y
). {

462 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 
P
, 
X
.
pEx¥
);

463 if–
Y
.
n
>0 ) 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
A
, &Y, 1);

464 
	`sqlôe4Ex¥Li°SëS∑n
(
pP¨£
,
A
,&
X
);

465 
	}
}

466 
	$£lcﬁli°
(
A
Ë::
	$s˛p
(
P
Ë
STAR
. {

467 
Ex¥
 *
p
 = 
	`sqlôe4Ex¥
(
pP¨£
->
db
, 
TK_ALL
, 0);

468 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 
P
, 
p
);

469 
	}
}

470 
	$£lcﬁli°
(
A
Ë::
	$s˛p
(
P
Ë
	$nm
(
X
Ë
DOT
 
	`STAR
(
Y
). {

471 
Ex¥
 *
pRight
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ALL
, 0, 0, &
Y
);

472 
Ex¥
 *
pLe·
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
X
);

473 
Ex¥
 *
pDŸ
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
, 
pLe·
, 
pRight
, 0);

474 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,
P
, 
pDŸ
);

475 
	}
}

480 %
ty≥
 
as
 {
Tokí
}

481 
	$as
(
X
Ë::
AS
 
	`nm
(
Y
). {X = Y;
	}
}

482 
	$as
(
X
Ë::
	`ids
(
Y
). {X = Y;
	}
}

483 
	$as
(
X
Ë::. {X.
n
 = 0;
	}
}

486 %
ty≥
 
£…abli°
 {
SrcLi°
*}

487 %
de°ru˘‹
 
£…abli°
 {
sqlôe4SrcLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

488 %
ty≥
 
°l_¥efix
 {
SrcLi°
*}

489 %
de°ru˘‹
 
°l_¥efix
 {
sqlôe4SrcLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

490 %
ty≥
 
‰om
 {
SrcLi°
*}

491 %
de°ru˘‹
 
‰om
 {
sqlôe4SrcLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

495 
	$‰om
(
A
Ë::. {A = 
	`sqlôe4DbMÆlocZîo
(
pP¨£
->
db
, (*A));
	}
}

496 
	$‰om
(
A
Ë::
FROM
 
	`£…abli°
(
X
). {

497 
A
 = 
X
;

498 
	`sqlôe4SrcLi°Shi·JoöTy≥
(
A
);

499 
	}
}

504 
	$°l_¥efix
(
A
Ë::
	$£…abli°
(
X
Ë
	`joö›
(
Y
). {

505 
A
 = 
X
;

506 if–
	`ALWAYS
(
A
 && A->
nSrc
>0ËËA->
a
[A->nSrc-1].
joöty≥
 = (
u8
)
Y
;

507 
	}
}

508 
	$°l_¥efix
(
A
Ë::. {A = 0;
	}
}

509 
	$£…abli°
(
A
Ë::
	$°l_¥efix
(
X
Ë
	$nm
(
Y
Ë
	$dbnm
(
D
Ë
	$as
(
Z
Ë
	$ödexed_›t
(
I
Ë
	$⁄_›t
(
N
Ë
	`usög_›t
(
U
). {

510 
A
 = 
	`sqlôe4SrcLi°AµídFromTîm
(
pP¨£
,
X
,&
Y
,&
D
,&
Z
,0,
N
,
U
);

511 
	`sqlôe4SrcLi°IndexedBy
(
pP¨£
, 
A
, &
I
);

512 
	}
}

513 %
i‚def
 
SQLITE4_OMIT_SUBQUERY


514 
	$£…abli°
(
A
Ë::
	$°l_¥efix
(
X
Ë
LP
 
	$£À˘
(
S
Ë
RP


515 
	$as
(
Z
Ë
	$⁄_›t
(
N
Ë
	`usög_›t
(
U
). {

516 
A
 = 
	`sqlôe4SrcLi°AµídFromTîm
(
pP¨£
,
X
,0,0,&
Z
,
S
,
N
,
U
);

517 
	}
}

518 
	$£…abli°
(
A
Ë::
	$°l_¥efix
(
X
Ë
LP
 
	$£…abli°
(
F
Ë
RP


519 
	$as
(
Z
Ë
	$⁄_›t
(
N
Ë
	`usög_›t
(
U
). {

520 if–
X
==0 && 
Z
.
n
==0 && 
N
==0 && 
U
==0 ){

521 
A
 = 
F
;

523 
Sñe˘
 *
pSubquîy
;

524 
	`sqlôe4SrcLi°Shi·JoöTy≥
(
F
);

525 
pSubquîy
 = 
	`sqlôe4Sñe˘New
(
pP¨£
,0,
F
,0,0,0,0,0,0,0);

526 
A
 = 
	`sqlôe4SrcLi°AµídFromTîm
(
pP¨£
,
X
,0,0,&
Z
,
pSubquîy
,
N
,
U
);

528 
	}
}

541 %
ídif
 
SQLITE4_OMIT_SUBQUERY


543 %
ty≥
 
dbnm
 {
Tokí
}

544 
	$dbnm
(
A
Ë::. {A.
z
=0; A.
n
=0;
	}
}

545 
	$dbnm
(
A
Ë::
DOT
 
	`nm
(
X
). {A = X;
	}
}

547 %
ty≥
 
fuŒ«me
 {
SrcLi°
*}

548 %
de°ru˘‹
 
fuŒ«me
 {
sqlôe4SrcLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

549 
	$fuŒ«me
(
A
Ë::
	$nm
(
X
Ë
	`dbnm
(
Y
). {
A
 = 
	`sqlôe4SrcLi°Aµíd
(
pP¨£
->
db
,0,&X,&Y);
	}
}

551 %
ty≥
 
joö›
 {}

552 %
ty≥
 
joö›2
 {}

553 
	$joö›
(
X
Ë::
COMMA
|
JOIN
. { X = 
JT_INNER
; 
	}
}

554 
	$joö›
(
X
Ë::
	$JOIN_KW
(
A
Ë
JOIN
. { 
X
 = 
	`sqlôe4JoöTy≥
(
pP¨£
,&A,0,0); 
	}
}

555 
	$joö›
(
X
Ë::
	$JOIN_KW
(
A
Ë
	$nm
(
B
Ë
JOIN
. { 
X
 = 
	`sqlôe4JoöTy≥
(
pP¨£
,&
A
,&B,0); 
	}
}

556 
	$joö›
(
X
Ë::
	$JOIN_KW
(
A
Ë
	$nm
(
B
Ë
	$nm
(
C
Ë
JOIN
.

557 { 
X
 = 
	`sqlôe4JoöTy≥
(
pP¨£
,&
A
,&
B
,&
C
); 
	}
}

559 %
ty≥
 
⁄_›t
 {
Ex¥
*}

560 %
de°ru˘‹
 
⁄_›t
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

561 
	$⁄_›t
(
N
Ë::
ON
 
	`ex¥
(
E
). {N = E.
pEx¥
;
	}
}

562 
	$⁄_›t
(
N
Ë::. {N = 0;
	}
}

574 %
ty≥
 
ödexed_›t
 {
Tokí
}

575 
	$ödexed_›t
(
A
Ë::. {A.
z
=0; A.
n
=0;
	}
}

576 
	$ödexed_›t
(
A
Ë::
INDEXED
 
BY
 
	`nm
(
X
). {A = X;
	}
}

577 
	$ödexed_›t
(
A
Ë::
NOT
 
INDEXED
. {A.
z
=0; A.
n
=1;
	}
}

579 %
ty≥
 
usög_›t
 {
IdLi°
*}

580 %
de°ru˘‹
 
usög_›t
 {
sqlôe4IdLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

581 
	$usög_›t
(
U
Ë::
USING
 
LP
 
	$öscﬁli°
(
L
Ë
RP
. {
U
 = L;
	}
}

582 
	$usög_›t
(
U
Ë::. {U = 0;
	}
}

585 %
ty≥
 
‹dîby_›t
 {
Ex¥Li°
*}

586 %
de°ru˘‹
 
‹dîby_›t
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

587 %
ty≥
 
s‹éi°
 {
Ex¥Li°
*}

588 %
de°ru˘‹
 
s‹éi°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

589 %
ty≥
 
s‹tôem
 {
Ex¥
*}

590 %
de°ru˘‹
 
s‹tôem
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

592 
	$‹dîby_›t
(
A
Ë::. {A = 0;
	}
}

593 
	$‹dîby_›t
(
A
Ë::
ORDER
 
BY
 
	`s‹éi°
(
X
). {A = X;
	}
}

594 
	$s‹éi°
(
A
Ë::
	$s‹éi°
(
X
Ë
COMMA
 
	$s‹tôem
(
Y
Ë
	`s‹t‹dî
(
Z
). {

595 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,
X
,
Y
);

596 if–
A
 ) A->
a
[A->
nEx¥
-1].
s‹tOrdî
 = (
u8
)
Z
;

597 
	}
}

598 
	$s‹éi°
(
A
Ë::
	$s‹tôem
(
Y
Ë
	`s‹t‹dî
(
Z
). {

599 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0,
Y
);

600 if–
A
 && 
	`ALWAYS
(A->
a
ËËA->a[0].
s‹tOrdî
 = (
u8
)
Z
;

601 
	}
}

602 
	$s‹tôem
(
A
Ë::
	`ex¥
(
X
). {A = X.
pEx¥
;
	}
}

604 %
ty≥
 
s‹t‹dî
 {}

606 
	$s‹t‹dî
(
A
Ë::
ASC
. {A = 
SQLITE4_SO_ASC
;
	}
}

607 
	$s‹t‹dî
(
A
Ë::
DESC
. {A = 
SQLITE4_SO_DESC
;
	}
}

608 
	$s‹t‹dî
(
A
Ë::. {A = 
SQLITE4_SO_ASC
;
	}
}

610 %
ty≥
 
groupby_›t
 {
Ex¥Li°
*}

611 %
de°ru˘‹
 
groupby_›t
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

612 
	$groupby_›t
(
A
Ë::. {A = 0;
	}
}

613 
	$groupby_›t
(
A
Ë::
GROUP
 
BY
 
	`√x¥li°
(
X
). {A = X;
	}
}

615 %
ty≥
 
havög_›t
 {
Ex¥
*}

616 %
de°ru˘‹
 
havög_›t
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

617 
	$havög_›t
(
A
Ë::. {A = 0;
	}
}

618 
	$havög_›t
(
A
Ë::
HAVING
 
	`ex¥
(
X
). {A = X.
pEx¥
;
	}
}

620 %
ty≥
 
limô_›t
 {
LimôVÆ
}

633 
	$limô_›t
(
A
Ë::. {A.
pLimô
 = 0; A.
pOff£t
 = 0;
	}
}

634 
	$limô_›t
(
A
Ë::
LIMIT
 
	`ex¥
(
X
). {A.
pLimô
 = X.
pEx¥
; A.
pOff£t
 = 0;
	}
}

635 
	$limô_›t
(
A
Ë::
LIMIT
 
	$ex¥
(
X
Ë
OFFSET
 
	`ex¥
(
Y
).

636 {
A
.
pLimô
 = 
X
.
pEx¥
; A.
pOff£t
 = 
Y
.pEx¥;
	}
}

637 
	$limô_›t
(
A
Ë::
LIMIT
 
	$ex¥
(
X
Ë
COMMA
 
	`ex¥
(
Y
).

638 {
A
.
pOff£t
 = 
X
.
pEx¥
; A.
pLimô
 = 
Y
.pEx¥;
	}
}

642 %
ifdef
 
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT


643 
cmd
 ::
DELETE
 
FROM
 
	$fuŒ«me
(
X
Ë
	$ödexed_›t
(
I
Ë
	$whîe_›t
(
W
)

644 
	$‹dîby_›t
(
O
Ë
	`limô_›t
(
L
). {

645 
	`sqlôe4SrcLi°IndexedBy
(
pP¨£
, 
X
, &
I
);

646 
W
 = 
	`sqlôe4LimôWhîe
(
pP¨£
, 
X
, W, 
O
, 
L
.
pLimô
, L.
pOff£t
, "DELETE");

647 
	`sqlôe4DñëeFrom
(
pP¨£
,
X
,
W
);

648 
	}
}

649 %
ídif


650 %
i‚def
 
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT


651 
cmd
 ::
DELETE
 
FROM
 
	$fuŒ«me
(
X
Ë
	$ödexed_›t
(
I
Ë
	`whîe_›t
(
W
). {

652 
	`sqlôe4SrcLi°IndexedBy
(
pP¨£
, 
X
, &
I
);

653 
	`sqlôe4DñëeFrom
(
pP¨£
,
X
,
W
);

654 
	}
}

655 %
ídif


657 %
ty≥
 
whîe_›t
 {
Ex¥
*}

658 %
de°ru˘‹
 
whîe_›t
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

660 
	$whîe_›t
(
A
Ë::. {A = 0;
	}
}

661 
	$whîe_›t
(
A
Ë::
WHERE
 
	`ex¥
(
X
). {A = X.
pEx¥
;
	}
}

665 %
ifdef
 
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT


666 
cmd
 ::
UPDATE
 
	$‹c⁄f
(
R
Ë
	$fuŒ«me
(
X
Ë
	$ödexed_›t
(
I
Ë
SET
 
	$£éi°
(
Y
Ë
	$whîe_›t
(
W
Ë
	$‹dîby_›t
(
O
Ë
	`limô_›t
(
L
). {

667 
	`sqlôe4SrcLi°IndexedBy
(
pP¨£
, 
X
, &
I
);

668 
	`sqlôe4Ex¥Li°CheckLígth
(
pP¨£
,
Y
,"setÜist");

669 
W
 = 
	`sqlôe4LimôWhîe
(
pP¨£
, 
X
, W, 
O
, 
L
.
pLimô
, L.
pOff£t
, "UPDATE");

670 
	`sqlôe4Upd©e
(
pP¨£
,
X
,
Y
,
W
,
R
);

671 
	}
}

672 %
ídif


673 %
i‚def
 
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT


674 
cmd
 ::
UPDATE
 
	$‹c⁄f
(
R
Ë
	$fuŒ«me
(
X
Ë
	$ödexed_›t
(
I
Ë
SET
 
	$£éi°
(
Y
Ë
	`whîe_›t
(
W
). {

675 
	`sqlôe4SrcLi°IndexedBy
(
pP¨£
, 
X
, &
I
);

676 
	`sqlôe4Ex¥Li°CheckLígth
(
pP¨£
,
Y
,"setÜist");

677 
	`sqlôe4Upd©e
(
pP¨£
,
X
,
Y
,
W
,
R
);

678 
	}
}

679 %
ídif


681 %
ty≥
 
£éi°
 {
Ex¥Li°
*}

682 %
de°ru˘‹
 
£éi°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

684 
	$£éi°
(
A
Ë::
	$£éi°
(
Z
Ë
COMMA
 
	$nm
(
X
Ë
EQ
 
	`ex¥
(
Y
). {

685 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 
Z
, 
Y
.
pEx¥
);

686 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
A
, &
X
, 1);

687 
	}
}

688 
	$£éi°
(
A
Ë::
	$nm
(
X
Ë
EQ
 
	`ex¥
(
Y
). {

689 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
Y
.
pEx¥
);

690 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
A
, &
X
, 1);

691 
	}
}

695 
cmd
 ::
	$ö£π_cmd
(
R
Ë
INTO
 
	$fuŒ«me
(
X
Ë
	$öscﬁli°_›t
(
F
Ë
	`vÆuñi°
(
Y
).

696 {
	`sqlôe4In£π
(
pP¨£
, 
X
, 
Y
.
pLi°
, Y.
pSñe˘
, 
F
, 
R
);
	}
}

697 
cmd
 ::
	$ö£π_cmd
(
R
Ë
INTO
 
	$fuŒ«me
(
X
Ë
	$öscﬁli°_›t
(
F
Ë
	`£À˘
(
S
).

698 {
	`sqlôe4In£π
(
pP¨£
, 
X
, 0, 
S
, 
F
, 
R
);
	}
}

699 
cmd
 ::
	$ö£π_cmd
(
R
Ë
INTO
 
	$fuŒ«me
(
X
Ë
	$öscﬁli°_›t
(
F
Ë
DEFAULT
 
VALUES
.

700 {
	`sqlôe4In£π
(
pP¨£
, 
X
, 0, 0, 
F
, 
R
);
	}
}

702 %
ty≥
 
ö£π_cmd
 {
u8
}

703 
	$ö£π_cmd
(
A
Ë::
INSERT
 
	`‹c⁄f
(
R
). {A = R;
	}
}

704 
	$ö£π_cmd
(
A
Ë::
REPLACE
. {A = 
OE_Rïœ˚
;
	}
}

713 %
ty≥
 
vÆuñi°
 {
VÆueLi°
}

714 %
de°ru˘‹
 
vÆuñi°
 {

715 
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
.
pLi°
);

716 
sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
$$
.
pSñe˘
);

718 
	$vÆuñi°
(
A
Ë::
VALUES
 
LP
 
	$√x¥li°
(
X
Ë
RP
. {

719 
A
.
pLi°
 = 
X
;

720 
A
.
pSñe˘
 = 0;

721 
	}
}

722 
	$vÆuñi°
(
A
Ë::
	$vÆuñi°
(
X
Ë
COMMA
 
LP
 
	$ex¥li°
(
Y
Ë
RP
. {

723 
Sñe˘
 *
pRight
 = 
	`sqlôe4Sñe˘New
(
pP¨£
, 
Y
, 0, 0, 0, 0, 0, 0, 0, 0);

724 if–
X
.
pLi°
 ){

725 
X
.
pSñe˘
 = 
	`sqlôe4Sñe˘New
(
pP¨£
, X.
pLi°
, 0, 0, 0, 0, 0, 0, 0, 0);

726 
X
.
pLi°
 = 0;

728 
A
.
pLi°
 = 0;

729 if–
X
.
pSñe˘
==0 || 
pRight
==0 ){

730 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
pRight
);

731 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
X
.
pSñe˘
);

732 
A
.
pSñe˘
 = 0;

734 
pRight
->
›
 = 
TK_ALL
;

735 
pRight
->
pPri‹
 = 
X
.
pSñe˘
;

736 
pRight
->
£lFœgs
 |
SF_VÆues
;

737 
pRight
->
pPri‹
->
£lFœgs
 |
SF_VÆues
;

738 
A
.
pSñe˘
 = 
pRight
;

740 
	}
}

742 %
ty≥
 
öscﬁli°_›t
 {
IdLi°
*}

743 %
de°ru˘‹
 
öscﬁli°_›t
 {
sqlôe4IdLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

744 %
ty≥
 
öscﬁli°
 {
IdLi°
*}

745 %
de°ru˘‹
 
öscﬁli°
 {
sqlôe4IdLi°Dñëe
(
pP¨£
->
db
, 
$$
);}

747 
	$öscﬁli°_›t
(
A
Ë::. {A = 0;
	}
}

748 
	$öscﬁli°_›t
(
A
Ë::
LP
 
	$öscﬁli°
(
X
Ë
RP
. {
A
 = X;
	}
}

749 
	$öscﬁli°
(
A
Ë::
	$öscﬁli°
(
X
Ë
COMMA
 
	`nm
(
Y
).

750 {
A
 = 
	`sqlôe4IdLi°Aµíd
(
pP¨£
->
db
,
X
,&
Y
);
	}
}

751 
	$öscﬁli°
(
A
Ë::
	`nm
(
Y
).

752 {
A
 = 
	`sqlôe4IdLi°Aµíd
(
pP¨£
->
db
,0,&
Y
);
	}
}

757 %
ty≥
 
ex¥
 {
Ex¥S∑n
}

758 %
de°ru˘‹
 
ex¥
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
.
pEx¥
);}

759 %
ty≥
 
ãrm
 {
Ex¥S∑n
}

760 %
de°ru˘‹
 
ãrm
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
.
pEx¥
);}

762 %
ö˛ude
 {

767 
•™Së
(
Ex¥S∑n
 *
pOut
, 
Tokí
 *
pSèπ
, Tokí *
pEnd
){

768 
pOut
->
zSèπ
 = 
pSèπ
->
z
;

769 
pOut
->
zEnd
 = &
pEnd
->
z
[pEnd->
n
];

776 
•™Ex¥
(
Ex¥S∑n
 *
pOut
, 
P¨£
 *
pP¨£
, 
›
, 
Tokí
 *
pVÆue
){

777 
pOut
->
pEx¥
 = 
sqlôe4PEx¥
(
pP¨£
, 
›
, 0, 0, 
pVÆue
);

778 
pOut
->
zSèπ
 = 
pVÆue
->
z
;

779 
pOut
->
zEnd
 = &
pVÆue
->
z
[pVÆue->
n
];

783 
	$ex¥
(
A
Ë::
	`ãrm
(
X
). {A = X;
	}
}

784 
	$ex¥
(
A
Ë::
	$LP
(
B
Ë
	$ex¥
(
X
Ë
	`RP
(
E
). {
A
.
pEx¥
 = X.pEx¥; 
	`•™Së
(&A,&
B
,&E);
	}
}

785 
	$ãrm
(
A
Ë::
	`NULL
(
X
). {
	`•™Ex¥
(&A, 
pP¨£
, @X, &X);
	}
}

786 
	$ex¥
(
A
Ë::
	`id
(
X
). {
	`•™Ex¥
(&A, 
pP¨£
, 
TK_ID
, &X);
	}
}

787 
	$ex¥
(
A
Ë::
	`JOIN_KW
(
X
). {
	`•™Ex¥
(&A, 
pP¨£
, 
TK_ID
, &X);
	}
}

788 
	$ex¥
(
A
Ë::
	$nm
(
X
Ë
DOT
 
	`nm
(
Y
). {

789 
Ex¥
 *
ãmp1
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
X
);

790 
Ex¥
 *
ãmp2
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
Y
);

791 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
, 
ãmp1
, 
ãmp2
, 0);

792 
	`•™Së
(&
A
,&
X
,&
Y
);

793 
	}
}

794 
	$ex¥
(
A
Ë::
	$nm
(
X
Ë
DOT
 
	$nm
(
Y
Ë
DOT
 
	`nm
(
Z
). {

795 
Ex¥
 *
ãmp1
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
X
);

796 
Ex¥
 *
ãmp2
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
Y
);

797 
Ex¥
 *
ãmp3
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_ID
, 0, 0, &
Z
);

798 
Ex¥
 *
ãmp4
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
, 
ãmp2
, 
ãmp3
, 0);

799 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
, 
ãmp1
, 
ãmp4
, 0);

800 
	`•™Së
(&
A
,&
X
,&
Z
);

801 
	}
}

802 
	$ãrm
(
A
Ë::
INTEGER
|
FLOAT
|
	`BLOB
(
X
). {
	`•™Ex¥
(&A, 
pP¨£
, @X, &X);
	}
}

803 
	$ãrm
(
A
Ë::
	`STRING
(
X
). {
	`•™Ex¥
(&A, 
pP¨£
, @X, &X);
	}
}

804 
	$ex¥
(
A
Ë::
	`REGISTER
(
X
). {

808 if–
pP¨£
->
√°ed
==0 ){

809 
	`sqlôe4Eº‹Msg
(
pP¨£
, "√¨ \"%T\": sy¡axÉº‹", &
X
);

810 
A
.
pEx¥
 = 0;

812 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_REGISTER
, 0, 0, &
X
);

813 if–
A
.
pEx¥
 ) 
	`sqlôe4GëI¡32
(&
X
.
z
[1], &A.pEx¥->
iTabÀ
);

815 
	`•™Së
(&
A
, &
X
, &X);

816 
	}
}

817 
	$ex¥
(
A
Ë::
	`VARIABLE
(
X
). {

818 
	`•™Ex¥
(&
A
, 
pP¨£
, 
TK_VARIABLE
, &
X
);

819 
	`sqlôe4Ex¥AssignV¨Numbî
(
pP¨£
, 
A
.
pEx¥
);

820 
	`•™Së
(&
A
, &
X
, &X);

821 
	}
}

822 
	$ex¥
(
A
Ë::
	$ex¥
(
E
Ë
COLLATE
 
	`ids
(
C
). {

823 
A
.
pEx¥
 = 
	`sqlôe4Ex¥SëCﬁlByTokí
(
pP¨£
, 
E
.pEx¥, &
C
);

824 
A
.
zSèπ
 = 
E
.zStart;

825 
A
.
zEnd
 = &
C
.
z
[C.
n
];

826 
	}
}

827 %
i‚def
 
SQLITE4_OMIT_CAST


828 
	$ex¥
(
A
Ë::
	$CAST
(
X
Ë
LP
 
	$ex¥
(
E
Ë
AS
 
	$ty≥tokí
(
T
Ë
	`RP
(
Y
). {

829 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_CAST
, 
E
.pEx¥, 0, &
T
);

830 
	`•™Së
(&
A
,&
X
,&
Y
);

831 
	}
}

832 %
ídif
 
SQLITE4_OMIT_CAST


833 
	$ex¥
(
A
Ë::
	$ID
(
X
Ë
LP
 
	$di°ö˘
(
D
Ë
	$ex¥li°
(
Y
Ë
	`RP
(
E
). {

834 if–
Y
 && Y->
nEx¥
>
pP¨£
->
db
->
aLimô
[
SQLITE4_LIMIT_FUNCTION_ARG
] ){

835 
	`sqlôe4Eº‹Msg
(
pP¨£
, "toÿm™yárgumít†⁄ fun˘i⁄ %T", &
X
);

837 
A
.
pEx¥
 = 
	`sqlôe4Ex¥Fun˘i⁄
(
pP¨£
, 
Y
, &
X
);

838 
	`•™Së
(&
A
,&
X
,&
E
);

839 if–
D
 && 
A
.
pEx¥
 ){

840 
A
.
pEx¥
->
Êags
 |
EP_Di°ö˘
;

842 
	}
}

843 
	$ex¥
(
A
Ë::
	$ID
(
X
Ë
LP
 
STAR
 
	`RP
(
E
). {

844 
A
.
pEx¥
 = 
	`sqlôe4Ex¥Fun˘i⁄
(
pP¨£
, 0, &
X
);

845 
	`•™Së
(&
A
,&
X
,&
E
);

846 
	}
}

847 
	$ãrm
(
A
Ë::
	`CTIME_KW
(
OP
). {

850 
A
.
pEx¥
 = 
	`sqlôe4Ex¥Fun˘i⁄
(
pP¨£
, 0,&
OP
);

851 if–
A
.
pEx¥
 ){

852 
A
.
pEx¥
->
›
 = 
TK_CONST_FUNC
;

854 
	`•™Së
(&
A
, &
OP
, &OP);

855 
	}
}

857 %
ö˛ude
 {

861 
•™Bö¨yEx¥
(

862 
Ex¥S∑n
 *
pOut
,

863 
P¨£
 *
pP¨£
,

864 
›
,

865 
Ex¥S∑n
 *
pLe·
,

866 
Ex¥S∑n
 *
pRight


868 
pOut
->
pEx¥
 = 
sqlôe4PEx¥
(
pP¨£
, 
›
, 
pLe·
->pEx¥, 
pRight
->pExpr, 0);

869 
pOut
->
zSèπ
 = 
pLe·
->zStart;

870 
pOut
->
zEnd
 = 
pRight
->zEnd;

874 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$AND
(
OP
Ë
	`ex¥
(
Y
). {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@OP,&
X
,&Y);
	}
}

875 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$OR
(
OP
Ë
	`ex¥
(
Y
). {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@OP,&
X
,&Y);
	}
}

876 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
LT
|
GT
|
GE
|
	$LE
(
OP
Ë
	`ex¥
(
Y
).

877 {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@
OP
,&
X
,&
Y
);
	}
}

878 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
EQ
|
	$NE
(
OP
Ë
	`ex¥
(
Y
). {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@OP,&
X
,&Y);
	}
}

879 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
BITAND
|
BITOR
|
LSHIFT
|
	$RSHIFT
(
OP
Ë
	`ex¥
(
Y
).

880 {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@
OP
,&
X
,&
Y
);
	}
}

881 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
PLUS
|
	$MINUS
(
OP
Ë
	`ex¥
(
Y
).

882 {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@
OP
,&
X
,&
Y
);
	}
}

883 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
STAR
|
SLASH
|
	$REM
(
OP
Ë
	`ex¥
(
Y
).

884 {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@
OP
,&
X
,&
Y
);
	}
}

885 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$CONCAT
(
OP
Ë
	`ex¥
(
Y
). {
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,@OP,&
X
,&Y);
	}
}

886 %
ty≥
 
like›
 {
LikeOp
}

887 
	$like›
(
A
Ë::
	`LIKE_KW
(
X
). {A.
eO≥øt‹
 = X; A.
nŸ
 = 0;
	}
}

888 
	$like›
(
A
Ë::
NOT
 
	`LIKE_KW
(
X
). {A.
eO≥øt‹
 = X; A.
nŸ
 = 1;
	}
}

890 
	$like›
(
A
Ë::
NOT
 
	`MATCH
(
X
). {A.
eO≥øt‹
 = X; A.
nŸ
 = 1;
	}
}

891 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$like›
(
OP
Ë
	`ex¥
(
Y
). [
LIKE_KW
] {

892 
Ex¥Li°
 *
pLi°
;

893 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0, 
Y
.
pEx¥
);

894 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,pLi°, 
X
.
pEx¥
);

895 
A
.
pEx¥
 = 
	`sqlôe4Ex¥Fun˘i⁄
(
pP¨£
, 
pLi°
, &
OP
.
eO≥øt‹
);

896 if–
OP
.
nŸ
 ) 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
, A.pExpr, 0, 0);

897 
A
.
zSèπ
 = 
X
.zStart;

898 
A
.
zEnd
 = 
Y
.zEnd;

899 if–
A
.
pEx¥
 ) A.pEx¥->
Êags
 |
EP_InfixFunc
;

900 
	}
}

901 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$like›
(
OP
Ë
	$ex¥
(
Y
Ë
ESCAPE
 
	`ex¥
(
E
). [
LIKE_KW
] {

902 
Ex¥Li°
 *
pLi°
;

903 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0, 
Y
.
pEx¥
);

904 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,pLi°, 
X
.
pEx¥
);

905 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,pLi°, 
E
.
pEx¥
);

906 
A
.
pEx¥
 = 
	`sqlôe4Ex¥Fun˘i⁄
(
pP¨£
, 
pLi°
, &
OP
.
eO≥øt‹
);

907 if–
OP
.
nŸ
 ) 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
, A.pExpr, 0, 0);

908 
A
.
zSèπ
 = 
X
.zStart;

909 
A
.
zEnd
 = 
E
.zEnd;

910 if–
A
.
pEx¥
 ) A.pEx¥->
Êags
 |
EP_InfixFunc
;

911 
	}
}

913 
	$ex¥
(
A
Ë::
	$ex¥
(
L
Ë
MATCH
 
	`ex¥
(
R
). {

914 
	`•™Bö¨yEx¥
(&
A
, 
pP¨£
, 
TK_MATCH
, &
L
, &
R
);

915 
	}
}

917 %
ö˛ude
 {

920 
•™U«ryPo°fix
(

921 
Ex¥S∑n
 *
pOut
,

922 
P¨£
 *
pP¨£
,

923 
›
,

924 
Ex¥S∑n
 *
pO≥ønd
,

925 
Tokí
 *
pPo°Op


927 
pOut
->
pEx¥
 = 
sqlôe4PEx¥
(
pP¨£
, 
›
, 
pO≥ønd
->pExpr, 0, 0);

928 
pOut
->
zSèπ
 = 
pO≥ønd
->zStart;

929 
pOut
->
zEnd
 = &
pPo°Op
->
z
[pPo°Op->
n
];

933 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
ISNULL
|
	`NOTNULL
(
E
). {
	`•™U«ryPo°fix
(&
A
,
pP¨£
,@E,&X,&E);
	}
}

934 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
NOT
 
	`NULL
(
E
). {
	`•™U«ryPo°fix
(&
A
,
pP¨£
,
TK_NOTNULL
,&X,&E);
	}
}

936 %
ö˛ude
 {

939 
bö¨yToU«ryIfNuŒ
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pY
, Ex¥ *
pA
, 
›
){

940 
sqlôe4
 *
db
 = 
pP¨£
->db;

941 if–
db
->
mÆlocFaûed
==0 && 
pY
->
›
==
TK_NULL
 ){

942 
pA
->
›
 = (
u8
)op;

943 
sqlôe4Ex¥Dñëe
(
db
, 
pA
->
pRight
);

944 
pA
->
pRight
 = 0;

955 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
IS
 
	`ex¥
(
Y
). {

956 
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,
TK_IS
,&
X
,&
Y
);

957 
	`bö¨yToU«ryIfNuŒ
(
pP¨£
, 
Y
.
pEx¥
, 
A
.pEx¥, 
TK_ISNULL
);

958 
	}
}

959 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
IS
 
NOT
 
	`ex¥
(
Y
). {

960 
	`•™Bö¨yEx¥
(&
A
,
pP¨£
,
TK_ISNOT
,&
X
,&
Y
);

961 
	`bö¨yToU«ryIfNuŒ
(
pP¨£
, 
Y
.
pEx¥
, 
A
.pEx¥, 
TK_NOTNULL
);

962 
	}
}

964 %
ö˛ude
 {

967 
•™U«ryPªfix
(

968 
Ex¥S∑n
 *
pOut
,

969 
P¨£
 *
pP¨£
,

970 
›
,

971 
Ex¥S∑n
 *
pO≥ønd
,

972 
Tokí
 *
pPªOp


974 
pOut
->
pEx¥
 = 
sqlôe4PEx¥
(
pP¨£
, 
›
, 
pO≥ønd
->pExpr, 0, 0);

975 
pOut
->
zSèπ
 = 
pPªOp
->
z
;

976 
pOut
->
zEnd
 = 
pO≥ønd
->zEnd;

982 
	$ex¥
(
A
Ë::
	$NOT
(
B
Ë
	`ex¥
(
X
). {
	`•™U«ryPªfix
(&
A
,
pP¨£
,@B,&X,&B);
	}
}

983 
	$ex¥
(
A
Ë::
	$BITNOT
(
B
Ë
	`ex¥
(
X
). {
	`•™U«ryPªfix
(&
A
,
pP¨£
,@B,&X,&B);
	}
}

984 
	$ex¥
(
A
Ë::
	$MINUS
(
B
Ë
	`ex¥
(
X
). [
BITNOT
]

985 {
	`•™U«ryPªfix
(&
A
,
pP¨£
,
TK_UMINUS
,&
X
,&
B
);
	}
}

986 
	$ex¥
(
A
Ë::
	$PLUS
(
B
Ë
	`ex¥
(
X
). [
BITNOT
]

987 {
	`•™U«ryPªfix
(&
A
,
pP¨£
,
TK_UPLUS
,&
X
,&
B
);
	}
}

989 %
ty≥
 
bëwìn_›
 {}

990 
	$bëwìn_›
(
A
Ë::
BETWEEN
. {A = 0;
	}
}

991 
	$bëwìn_›
(
A
Ë::
NOT
 
BETWEEN
. {A = 1;
	}
}

992 
	$ex¥
(
A
Ë::
	$ex¥
(
W
Ë
	$bëwìn_›
(
N
Ë
	$ex¥
(
X
Ë
AND
 
	`ex¥
(
Y
). [
BETWEEN
] {

993 
Ex¥Li°
 *
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0, 
X
.
pEx¥
);

994 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,pLi°, 
Y
.
pEx¥
);

995 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_BETWEEN
, 
W
.pExpr, 0, 0);

996 if–
A
.
pEx¥
 ){

997 
A
.
pEx¥
->
x
.
pLi°
 =ÖList;

999 
	`sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
pLi°
);

1001 if–
N
 ) 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
, A.pExpr, 0, 0);

1002 
A
.
zSèπ
 = 
W
.zStart;

1003 
A
.
zEnd
 = 
Y
.zEnd;

1004 
	}
}

1005 %
i‚def
 
SQLITE4_OMIT_SUBQUERY


1006 %
ty≥
 
ö_›
 {}

1007 
	$ö_›
(
A
Ë::
IN
. {A = 0;
	}
}

1008 
	$ö_›
(
A
Ë::
NOT
 
IN
. {A = 1;
	}
}

1009 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$ö_›
(
N
Ë
LP
 
	$ex¥li°
(
Y
Ë
	`RP
(
E
). [
IN
] {

1010 if–
Y
==0 ){

1019 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_INTEGER
, 0, 0, &
sqlôe4I¡Tokís
[
N
]);

1020 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
X
.
pEx¥
);

1022 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_IN
, 
X
.pExpr, 0, 0);

1023 if–
A
.
pEx¥
 ){

1024 
A
.
pEx¥
->
x
.
pLi°
 = 
Y
;

1025 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
A
.
pEx¥
);

1027 
	`sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
Y
);

1029 if–
N
 ) 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
, A.pExpr, 0, 0);

1031 
A
.
zSèπ
 = 
X
.zStart;

1032 
A
.
zEnd
 = &
E
.
z
[E.
n
];

1033 
	}
}

1034 
	$ex¥
(
A
Ë::
	$LP
(
B
Ë
	$£À˘
(
X
Ë
	`RP
(
E
). {

1035 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_SELECT
, 0, 0, 0);

1036 if–
A
.
pEx¥
 ){

1037 
A
.
pEx¥
->
x
.
pSñe˘
 = 
X
;

1038 
	`Ex¥SëPr›îty
(
A
.
pEx¥
, 
EP_xIsSñe˘
);

1039 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
A
.
pEx¥
);

1041 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
X
);

1043 
A
.
zSèπ
 = 
B
.
z
;

1044 
A
.
zEnd
 = &
E
.
z
[E.
n
];

1045 
	}
}

1046 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$ö_›
(
N
Ë
LP
 
	$£À˘
(
Y
Ë
	`RP
(
E
). [
IN
] {

1047 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_IN
, 
X
.pExpr, 0, 0);

1048 if–
A
.
pEx¥
 ){

1049 
A
.
pEx¥
->
x
.
pSñe˘
 = 
Y
;

1050 
	`Ex¥SëPr›îty
(
A
.
pEx¥
, 
EP_xIsSñe˘
);

1051 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
A
.
pEx¥
);

1053 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
Y
);

1055 if–
N
 ) 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
, A.pExpr, 0, 0);

1056 
A
.
zSèπ
 = 
X
.zStart;

1057 
A
.
zEnd
 = &
E
.
z
[E.
n
];

1058 
	}
}

1059 
	$ex¥
(
A
Ë::
	$ex¥
(
X
Ë
	$ö_›
(
N
Ë
	$nm
(
Y
Ë
	`dbnm
(
Z
). [
IN
] {

1060 
SrcLi°
 *
pSrc
 = 
	`sqlôe4SrcLi°Aµíd
(
pP¨£
->
db
, 0,&
Y
,&
Z
);

1061 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_IN
, 
X
.pExpr, 0, 0);

1062 if–
A
.
pEx¥
 ){

1063 
A
.
pEx¥
->
x
.
pSñe˘
 = 
	`sqlôe4Sñe˘New
(
pP¨£
, 0,
pSrc
,0,0,0,0,0,0,0);

1064 
	`Ex¥SëPr›îty
(
A
.
pEx¥
, 
EP_xIsSñe˘
);

1065 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
A
.
pEx¥
);

1067 
	`sqlôe4SrcLi°Dñëe
(
pP¨£
->
db
, 
pSrc
);

1069 if–
N
 ) 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NOT
, A.pExpr, 0, 0);

1070 
A
.
zSèπ
 = 
X
.zStart;

1071 
A
.
zEnd
 = 
Z
.
z
 ? &Z.z[Z.
n
] : &
Y
.z[Y.n];

1072 
	}
}

1073 
	$ex¥
(
A
Ë::
	$EXISTS
(
B
Ë
LP
 
	$£À˘
(
Y
Ë
	`RP
(
E
). {

1074 
Ex¥
 *
p
 = 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_EXISTS
, 0, 0, 0);

1075 if–
p
 ){

1076 
p
->
x
.
pSñe˘
 = 
Y
;

1077 
	`Ex¥SëPr›îty
(
p
, 
EP_xIsSñe˘
);

1078 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
p
);

1080 
	`sqlôe4Sñe˘Dñëe
(
pP¨£
->
db
, 
Y
);

1082 
A
.
zSèπ
 = 
B
.
z
;

1083 
A
.
zEnd
 = &
E
.
z
[E.
n
];

1084 
	}
}

1085 %
ídif
 
SQLITE4_OMIT_SUBQUERY


1088 
	$ex¥
(
A
Ë::
	$CASE
(
C
Ë
	$ˇ£_›î™d
(
X
Ë
	$ˇ£_ex¥li°
(
Y
Ë
	$ˇ£_ñ£
(
Z
Ë
	`END
(
E
). {

1089 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_CASE
, 
X
, 
Z
, 0);

1090 if–
A
.
pEx¥
 ){

1091 
A
.
pEx¥
->
x
.
pLi°
 = 
Y
;

1092 
	`sqlôe4Ex¥SëHeight
(
pP¨£
, 
A
.
pEx¥
);

1094 
	`sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
Y
);

1096 
A
.
zSèπ
 = 
C
.
z
;

1097 
A
.
zEnd
 = &
E
.
z
[E.
n
];

1098 
	}
}

1099 %
ty≥
 
ˇ£_ex¥li°
 {
Ex¥Li°
*}

1100 %
de°ru˘‹
 
ˇ£_ex¥li°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1101 
	$ˇ£_ex¥li°
(
A
Ë::
	$ˇ£_ex¥li°
(
X
Ë
WHEN
 
	$ex¥
(
Y
Ë
THEN
 
	`ex¥
(
Z
). {

1102 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,
X
, 
Y
.
pEx¥
);

1103 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,A, 
Z
.
pEx¥
);

1104 
	}
}

1105 
	$ˇ£_ex¥li°
(
A
Ë::
WHEN
 
	$ex¥
(
Y
Ë
THEN
 
	`ex¥
(
Z
). {

1106 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0, 
Y
.
pEx¥
);

1107 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,A, 
Z
.
pEx¥
);

1108 
	}
}

1109 %
ty≥
 
ˇ£_ñ£
 {
Ex¥
*}

1110 %
de°ru˘‹
 
ˇ£_ñ£
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

1111 
	$ˇ£_ñ£
(
A
Ë::
ELSE
 
	`ex¥
(
X
). {A = X.
pEx¥
;
	}
}

1112 
	$ˇ£_ñ£
(
A
Ë::. {A = 0;
	}
}

1113 %
ty≥
 
ˇ£_›î™d
 {
Ex¥
*}

1114 %
de°ru˘‹
 
ˇ£_›î™d
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

1115 
	$ˇ£_›î™d
(
A
Ë::
	`ex¥
(
X
). {A = X.
pEx¥
;
	}
}

1116 
	$ˇ£_›î™d
(
A
Ë::. {A = 0;
	}
}

1118 %
ty≥
 
ex¥li°
 {
Ex¥Li°
*}

1119 %
de°ru˘‹
 
ex¥li°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1120 %
ty≥
 
√x¥li°
 {
Ex¥Li°
*}

1121 %
de°ru˘‹
 
√x¥li°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1123 
	$ex¥li°
(
A
Ë::
	`√x¥li°
(
X
). {A = X;
	}
}

1124 
	$ex¥li°
(
A
Ë::. {A = 0;
	}
}

1125 
	$√x¥li°
(
A
Ë::
	$√x¥li°
(
X
Ë
COMMA
 
	`ex¥
(
Y
).

1126 {
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,
X
,
Y
.
pEx¥
);
	}
}

1127 
	$√x¥li°
(
A
Ë::
	`ex¥
(
Y
).

1128 {
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0,
Y
.
pEx¥
);
	}
}

1133 %
ty≥
 
¸óãödex
 {
Cª©eIndex
}

1134 %
de°ru˘‹
 
¸óãödex
 {
sqlôe4SrcLi°Dñëe
(
pP¨£
->
db
, 
$$
.
pTblName
);}

1136 
	$¸óãödex
(
C
Ë::
	$¸óãkw
(
S
Ë
	$uniqueÊag
(
U
Ë
INDEX
 
	$i‚Ÿexi°s
(
NE
)

1137 
	$nm
(
X
Ë
	$dbnm
(
D
Ë
ON
 
	`nm
(
Y
). {

1138 
C
.
bUnique
 = 
U
;

1139 
C
.
bI‚Ÿexi°
 = 
NE
;

1140 
C
.
tCª©e
 = 
S
;

1141 
C
.
tName1
 = 
X
;

1142 
C
.
tName2
 = 
D
;

1143 
C
.
pTblName
 = 
	`sqlôe4SrcLi°Aµíd
(
pP¨£
->
db
, 0, &
Y
, 0);

1144 
	}
}

1146 
cmd
 ::
	$¸óãödex
(
C
Ë
LP
 
	$s‹éi°
(
Z
Ë
	$RP
(
E
Ë
	`covîög_›t
(
F
). {

1147 
Tokí
 *
pEnd
 = (
F
.
pLi°
 ? &F.
sEnd
 : &
E
);

1148 
	`sqlôe4Cª©eIndex
(
pP¨£
, &
C
, 
Z
, 
F
.
pLi°
, C.
bUnique
, 
pEnd
, 
SQLITE4_SO_ASC
,0);

1149 
	}
}

1151 %
ty≥
 
uniqueÊag
 {}

1152 
	$uniqueÊag
(
A
Ë::
UNIQUE
. {A = 
OE_Ab‹t
;
	}
}

1153 
	$uniqueÊag
(
A
Ë::. {A = 
OE_N⁄e
;
	}
}

1155 %
ty≥
 
idxli°
 {
Ex¥Li°
*}

1156 %
de°ru˘‹
 
idxli°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1157 %
ty≥
 
idxli°_›t
 {
Ex¥Li°
*}

1158 %
de°ru˘‹
 
idxli°_›t
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1160 
	$idxli°_›t
(
A
Ë::. {A = 0;
	}
}

1161 
	$idxli°_›t
(
A
Ë::
LP
 
	$idxli°
(
X
Ë
RP
. {
A
 = X;
	}
}

1162 
	$idxli°
(
A
Ë::
	$idxli°
(
X
Ë
COMMA
 
	$nm
(
Y
Ë
	$cﬁœã
(
C
Ë
	`s‹t‹dî
(
Z
). {

1163 
Ex¥
 *
p
 = 0;

1164 if–
C
.
n
>0 ){

1165 
p
 = 
	`sqlôe4Ex¥
(
pP¨£
->
db
, 
TK_COLUMN
, 0);

1166 
	`sqlôe4Ex¥SëCﬁlByTokí
(
pP¨£
, 
p
, &
C
);

1168 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,
X
, 
p
);

1169 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
,
A
,&
Y
,1);

1170 
	`sqlôe4Ex¥Li°CheckLígth
(
pP¨£
, 
A
, "index");

1171 if–
A
 ) A->
a
[A->
nEx¥
-1].
s‹tOrdî
 = (
u8
)
Z
;

1172 
	}
}

1173 
	$idxli°
(
A
Ë::
	$nm
(
Y
Ë
	$cﬁœã
(
C
Ë
	`s‹t‹dî
(
Z
). {

1174 
Ex¥
 *
p
 = 0;

1175 if–
C
.
n
>0 ){

1176 
p
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_COLUMN
, 0, 0, 0);

1177 
	`sqlôe4Ex¥SëCﬁlByTokí
(
pP¨£
, 
p
, &
C
);

1179 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0, 
p
);

1180 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
A
, &
Y
, 1);

1181 
	`sqlôe4Ex¥Li°CheckLígth
(
pP¨£
, 
A
, "index");

1182 if–
A
 ) A->
a
[A->
nEx¥
-1].
s‹tOrdî
 = (
u8
)
Z
;

1183 
	}
}

1185 %
ty≥
 
cﬁœã
 {
Tokí
}

1186 
	$cﬁœã
(
C
Ë::. {C.
z
 = 0; C.
n
 = 0;
	}
}

1187 
	$cﬁœã
(
C
Ë::
COLLATE
 
	`ids
(
X
). {C = X;
	}
}

1189 %
ty≥
 
uidxli°_›t
 {
Ex¥Li°
*}

1190 %
de°ru˘‹
 
uidxli°_›t
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1191 %
ty≥
 
uidxli°
 {
Ex¥Li°
*}

1192 %
de°ru˘‹
 
uidxli°
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1194 
cmd
 ::
	$¸óãödex
(
C
Ë
USING
 
	$nm
(
F
Ë
LP
 
	$uidxli°_›t
(
U
Ë
	`RP
(
E
). {

1195 
	`sqlôe4Cª©eUsögIndex
(
pP¨£
, &
C
, 
U
, &
F
, &
E
);

1196 
	}
}

1198 
	$uidxli°_›t
(
A
Ë::
	`uidxli°
(
B
). { A = B; 
	}
}

1199 
	$uidxli°_›t
(
A
Ë::. { A = 0; 
	}
}

1201 
	$uidxli°
(
A
Ë::
	$uidxli°
(
Z
Ë
COMMA
 
	$ids
(
X
Ë
EQ
 
	`ids
(
Y
). {

1202 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 
Z
, 
	`sqlôe4PEx¥
’P¨£, @
Y
, 0, 0, &Y));

1203 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
A
, &
X
, 1);

1204 
	}
}

1205 
	$uidxli°
(
A
Ë::
	$uidxli°
(
Z
Ë
COMMA
 
	`ids
(
Y
). {

1206 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 
Z
, 
	`sqlôe4PEx¥
’P¨£, @
Y
, 0, 0, &Y));

1207 
	}
}

1208 
	$uidxli°
(
A
Ë::
	$ids
(
X
Ë
EQ
 
	`ids
(
Y
). {

1209 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4PEx¥
’P¨£, @
Y
, 0, 0, &Y));

1210 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
A
, &
X
, 1);

1211 
	}
}

1212 
	$uidxli°
(
A
Ë::
	`ids
(
Y
). {

1213 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4PEx¥
’P¨£, @
Y
, 0, 0, &Y));

1214 
	}
}

1216 %
ty≥
 
covîög_›t
 { 
CovîögO±
 }

1217 %
de°ru˘‹
 
covîög_›t
 {
sqlôe4IdLi°Dñëe
(
pP¨£
->
db
, 
$$
.
pLi°
);}

1218 
	$covîög_›t
(
A
Ë::. { A.
pLi°
 = 0; 
	}
}

1219 
	$covîög_›t
(
A
Ë::
COVERING
 
	`ALL
(
X
). {

1220 
A
.
pLi°
 = 
	`sqlôe4DbMÆlocZîo
(
pP¨£
->
db
, (
IdLi°
));

1221 
A
.
sEnd
 = 
X
;

1222 
	}
}

1223 
	$covîög_›t
(
A
Ë::
COVERING
 
LP
 
	$öscﬁli°
(
X
Ë
	`RP
(
Y
). {

1224 
A
.
pLi°
 = 
X
;

1225 
A
.
sEnd
 = 
Y
;

1226 
	}
}

1231 
cmd
 ::
DROP
 
INDEX
 
	$i„xi°s
(
E
Ë
	`fuŒ«me
(
X
). {
	`sqlôe4Dr›Index
(
pP¨£
, X, E);
	}
}

1235 %
i‚def
 
SQLITE4_OMIT_PRAGMA


1237 
cmd
 ::
PRAGMA
 
	$nm
(
X
Ë
	`dbnm
(
Y
). { 
	`sqlôe4Pøgma
(
pP¨£
, &X, &Y, 0); 
	}
}

1238 
cmd
 ::
PRAGMA
 
	$nm
(
X
Ë
	$dbnm
(
Y
Ë
LP
 
RP
. { 
	`sqlôe4Pøgma
(
pP¨£
, &
X
, &Y, 0); 
	}
}

1239 
cmd
 ::
PRAGMA
 
	$nm
(
X
Ë
	$dbnm
(
Y
Ë
LP
 
	$¥agmØrgs
(
Z
Ë
RP
. {

1240 
	`sqlôe4Pøgma
(
pP¨£
, &
X
, &
Y
, 
Z
);

1241 
	}
}

1242 
cmd
 ::
PRAGMA
 
	$nm
(
X
Ë
	$dbnm
(
Y
Ë
EQ
 
	`¥agmØrg
(
A
). {

1243 
	`sqlôe4Pøgma
(
pP¨£
, &
X
, &
Y
, 
A
);

1244 
	}
}

1246 %
ty≥
 
¥agmØrgs
 {
Ex¥Li°
*}

1247 %
de°ru˘‹
 
¥agmØrgs
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1248 %
ty≥
 
¥agmØrg
 {
Ex¥Li°
*}

1249 %
de°ru˘‹
 
¥agmØrg
 {
sqlôe4Ex¥Li°Dñëe
(
pP¨£
->
db
, 
$$
);}

1251 
	$¥agmØrgs
(
A
Ë::
	`¥agmØrg
(
X
). {A = X;
	}
}

1252 
	$¥agmØrgs
(
A
Ë::
	$¥agmØrgs
(
X
Ë
COMMA
 
	`ex¥
(
Y
). {

1253 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,
X
,
Y
.
pEx¥
);

1254 
	`sqlôe4Ex¥Li°SëS∑n
(
pP¨£
,
A
,&
Y
);

1255 
	}
}

1256 
	$¥agmØrg
(
A
Ë::
	`ex¥
(
Y
). {

1257 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,0,
Y
.
pEx¥
);

1258 
	`sqlôe4Ex¥Li°SëS∑n
(
pP¨£
,
A
,&
Y
);

1259 
	}
}

1260 
	$¥agmØrg
(
A
Ë::
	`ON
(
X
). {

1261 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4PEx¥
’P¨£, 
TK_ID
, 0, 0, &
X
));

1262 
	}
}

1263 
	$¥agmØrg
(
A
Ë::
	`DELETE
(
X
). {

1264 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4PEx¥
’P¨£, 
TK_ID
, 0, 0, &
X
));

1265 
	}
}

1266 
	$¥agmØrg
(
A
Ë::
	`DEFAULT
(
X
). {

1267 
A
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4PEx¥
’P¨£, 
TK_ID
, 0, 0, &
X
));

1268 
	}
}

1283 %
ídif
 
SQLITE4_OMIT_PRAGMA


1284 
	$∂us_num
(
A
Ë::
∂us_›t
 
	`numbî
(
X
). {A = X;
	}
}

1285 
	$möus_num
(
A
Ë::
MINUS
 
	`numbî
(
X
). {A = X;
	}
}

1286 
	$numbî
(
A
Ë::
INTEGER
|
	`FLOAT
(
X
). {A = X;
	}
}

1287 
∂us_›t
 ::
PLUS
.

1288 
∂us_›t
 ::= .

1292 %
i‚def
 
SQLITE4_OMIT_TRIGGER


1294 
cmd
 ::
¸óãkw
 
	$åiggî_de˛
(
A
Ë
BEGIN
 
	$åiggî_cmd_li°
(
S
Ë
	`END
(
Z
). {

1295 
Tokí
 
Æl
;

1296 
Æl
.
z
 = 
A
.z;

1297 
Æl
.
n
 = ()(
Z
.
z
 - 
A
.z) + Z.n;

1298 
	`sqlôe4FöishTriggî
(
pP¨£
, 
S
, &
Æl
);

1299 
	}
}

1301 
	$åiggî_de˛
(
A
Ë::
	$ãmp
(
T
Ë
TRIGGER
 
	$i‚Ÿexi°s
(
NOERR
Ë
	$nm
(
B
Ë
	$dbnm
(
Z
)

1302 
	$åiggî_time
(
C
Ë
	$åiggî_evít
(
D
)

1303 
ON
 
	$fuŒ«me
(
E
Ë
f‹óch_˛au£
 
	`whí_˛au£
(
G
). {

1304 
	`sqlôe4BegöTriggî
(
pP¨£
, &
B
, &
Z
, 
C
, 
D
.
a
, D.
b
, 
E
, 
G
, 
T
, 
NOERR
);

1305 
A
 = (
Z
.
n
==0?
B
:Z);

1306 
	}
}

1308 %
ty≥
 
åiggî_time
 {}

1309 
	$åiggî_time
(
A
Ë::
BEFORE
. { A = 
TK_BEFORE
; 
	}
}

1310 
	$åiggî_time
(
A
Ë::
AFTER
. { A = 
TK_AFTER
; 
	}
}

1311 
	$åiggî_time
(
A
Ë::
INSTEAD
 
OF
. { A = 
TK_INSTEAD
;
	}
}

1312 
	$åiggî_time
(
A
Ë::. { A = 
TK_BEFORE
; 
	}
}

1314 %
ty≥
 
åiggî_evít
 {
TrigEvít
}

1315 %
de°ru˘‹
 
åiggî_evít
 {
sqlôe4IdLi°Dñëe
(
pP¨£
->
db
, 
$$
.
b
);}

1316 
	$åiggî_evít
(
A
Ë::
DELETE
|
	`INSERT
(
OP
). {A.
a
 = @OP; A.
b
 = 0;
	}
}

1317 
	$åiggî_evít
(
A
Ë::
	`UPDATE
(
OP
). {A.
a
 = @OP; A.
b
 = 0;
	}
}

1318 
	$åiggî_evít
(
A
Ë::
UPDATE
 
OF
 
	`öscﬁli°
(
X
). {A.
a
 = 
TK_UPDATE
; A.
b
 = X;
	}
}

1320 
f‹óch_˛au£
 ::= .

1321 
f‹óch_˛au£
 ::
FOR
 
EACH
 
ROW
.

1323 %
ty≥
 
whí_˛au£
 {
Ex¥
*}

1324 %
de°ru˘‹
 
whí_˛au£
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

1325 
	$whí_˛au£
(
A
Ë::. { A = 0; 
	}
}

1326 
	$whí_˛au£
(
A
Ë::
WHEN
 
	`ex¥
(
X
). { A = X.
pEx¥
; 
	}
}

1328 %
ty≥
 
åiggî_cmd_li°
 {
TriggîSãp
*}

1329 %
de°ru˘‹
 
åiggî_cmd_li°
 {
sqlôe4DñëeTriggîSãp
(
pP¨£
->
db
, 
$$
);}

1330 
	$åiggî_cmd_li°
(
A
Ë::
	$åiggî_cmd_li°
(
Y
Ë
	$åiggî_cmd
(
X
Ë
SEMI
. {

1331 
	`as£π
–
Y
!=0 );

1332 
Y
->
pLa°
->
pNext
 = 
X
;

1333 
Y
->
pLa°
 = 
X
;

1334 
A
 = 
Y
;

1335 
	}
}

1336 
	$åiggî_cmd_li°
(
A
Ë::
	$åiggî_cmd
(
X
Ë
SEMI
. {

1337 
	`as£π
–
X
!=0 );

1338 
X
->
pLa°
 = X;

1339 
A
 = 
X
;

1340 
	}
}

1346 %
ty≥
 
ånm
 {
Tokí
}

1347 
	$ånm
(
A
Ë::
	`nm
(
X
). {A = X;
	}
}

1348 
	$ånm
(
A
Ë::
nm
 
DOT
 
	`nm
(
X
). {

1349 
A
 = 
X
;

1350 
	`sqlôe4Eº‹Msg
(
pP¨£
,

1353 
	}
}

1359 
åidxby
 ::= .

1360 
åidxby
 ::
INDEXED
 
BY
 
nm
. {

1361 
sqlôe4Eº‹Msg
(
pP¨£
,

1365 
åidxby
 ::
NOT
 
INDEXED
. {

1366 
sqlôe4Eº‹Msg
(
pP¨£
,

1373 %
ty≥
 
åiggî_cmd
 {
TriggîSãp
*}

1374 %
de°ru˘‹
 
åiggî_cmd
 {
sqlôe4DñëeTriggîSãp
(
pP¨£
->
db
, 
$$
);}

1376 
	$åiggî_cmd
(
A
) ::=

1377 
UPDATE
 
	$‹c⁄f
(
R
Ë
	$ånm
(
X
Ë
åidxby
 
SET
 
	$£éi°
(
Y
Ë
	`whîe_›t
(
Z
).

1378 { 
A
 = 
	`sqlôe4TriggîUpd©eSãp
(
pP¨£
->
db
, &
X
, 
Y
, 
Z
, 
R
); 
	}
}

1381 
	$åiggî_cmd
(
A
) ::=

1382 
	$ö£π_cmd
(
R
Ë
INTO
 
	$ånm
(
X
Ë
	$öscﬁli°_›t
(
F
Ë
	`vÆuñi°
(
Y
).

1383 {
A
 = 
	`sqlôe4TriggîIn£πSãp
(
pP¨£
->
db
, &
X
, 
F
, 
Y
.
pLi°
, Y.
pSñe˘
, 
R
);
	}
}

1385 
	$åiggî_cmd
(
A
Ë::
	$ö£π_cmd
(
R
Ë
INTO
 
	$ånm
(
X
Ë
	$öscﬁli°_›t
(
F
Ë
	`£À˘
(
S
).

1386 {
A
 = 
	`sqlôe4TriggîIn£πSãp
(
pP¨£
->
db
, &
X
, 
F
, 0, 
S
, 
R
);
	}
}

1389 
	$åiggî_cmd
(
A
Ë::
DELETE
 
FROM
 
	$ånm
(
X
Ë
åidxby
 
	`whîe_›t
(
Y
).

1390 {
A
 = 
	`sqlôe4TriggîDñëeSãp
(
pP¨£
->
db
, &
X
, 
Y
);
	}
}

1393 
	$åiggî_cmd
(
A
Ë::
	`£À˘
(
X
). {A = 
	`sqlôe4TriggîSñe˘Sãp
(
pP¨£
->
db
, X); 
	}
}

1396 
	$ex¥
(
A
Ë::
	$RAISE
(
X
Ë
LP
 
IGNORE
 
	`RP
(
Y
). {

1397 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_RAISE
, 0, 0, 0);

1398 if–
A
.
pEx¥
 ){

1399 
A
.
pEx¥
->
afföôy
 = 
OE_Ign‹e
;

1401 
A
.
zSèπ
 = 
X
.
z
;

1402 
A
.
zEnd
 = &
Y
.
z
[Y.
n
];

1403 
	}
}

1404 
	$ex¥
(
A
Ë::
	$RAISE
(
X
Ë
LP
 
	$øi£ty≥
(
T
Ë
COMMA
 
	$nm
(
Z
Ë
	`RP
(
Y
). {

1405 
A
.
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_RAISE
, 0, 0, &
Z
);

1406 if–
A
.
pEx¥
 ) {

1407 
A
.
pEx¥
->
afföôy
 = ()
T
;

1409 
A
.
zSèπ
 = 
X
.
z
;

1410 
A
.
zEnd
 = &
Y
.
z
[Y.
n
];

1411 
	}
}

1412 %
ídif
 !
SQLITE4_OMIT_TRIGGER


1414 %
ty≥
 
øi£ty≥
 {}

1415 
	$øi£ty≥
(
A
Ë::
ROLLBACK
. {A = 
OE_Rﬁlback
;
	}
}

1416 
	$øi£ty≥
(
A
Ë::
ABORT
. {A = 
OE_Ab‹t
;
	}
}

1417 
	$øi£ty≥
(
A
Ë::
FAIL
. {A = 
OE_Faû
;
	}
}

1421 %
i‚def
 
SQLITE4_OMIT_TRIGGER


1422 
cmd
 ::
DROP
 
TRIGGER
 
	$i„xi°s
(
NOERR
Ë
	`fuŒ«me
(
X
). {

1423 
	`sqlôe4Dr›Triggî
(
pP¨£
,
X
,
NOERR
);

1424 
	}
}

1425 %
ídif
 !
SQLITE4_OMIT_TRIGGER


1428 %
i‚def
 
SQLITE4_OMIT_ATTACH


1429 
cmd
 ::
ATTACH
 
d©aba£_kw_›t
 
	$ex¥
(
F
Ë
AS
 
	$ex¥
(
D
Ë
	`key_›t
(
K
). {

1430 
	`sqlôe4Aâach
(
pP¨£
, 
F
.
pEx¥
, 
D
.pEx¥, 
K
);

1431 
	}
}

1432 
cmd
 ::
DETACH
 
d©aba£_kw_›t
 
ex¥
(
D
). {

1433 
sqlôe4Dëach
(
pP¨£
, 
D
.
pEx¥
);

1436 %
ty≥
 
key_›t
 {
Ex¥
*}

1437 %
de°ru˘‹
 
key_›t
 {
sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
$$
);}

1438 
	$key_›t
(
A
Ë::. { A = 0; 
	}
}

1439 
	$key_›t
(
A
Ë::
KEY
 
	`ex¥
(
X
). { A = X.
pEx¥
; 
	}
}

1441 
d©aba£_kw_›t
 ::
DATABASE
.

1442 
d©aba£_kw_›t
 ::= .

1443 %
ídif
 
SQLITE4_OMIT_ATTACH


1446 %
i‚def
 
SQLITE4_OMIT_REINDEX


1447 
cmd
 ::
REINDEX
. {
sqlôe4Reödex
(
pP¨£
, 0, 0);}

1448 
cmd
 ::
REINDEX
 
	$nm
(
X
Ë
	`dbnm
(
Y
). {
	`sqlôe4Reödex
(
pP¨£
, &X, &Y);
	}
}

1449 %
ídif
 
SQLITE4_OMIT_REINDEX


1452 %
i‚def
 
SQLITE4_OMIT_ANALYZE


1453 
cmd
 ::
ANALYZE
. {
sqlôe4A«lyze
(
pP¨£
, 0, 0);}

1454 
cmd
 ::
ANALYZE
 
	$nm
(
X
Ë
	`dbnm
(
Y
). {
	`sqlôe4A«lyze
(
pP¨£
, &X, &Y);
	}
}

1455 %
ídif


1458 %
i‚def
 
SQLITE4_OMIT_ALTERTABLE


1459 
cmd
 ::
ALTER
 
TABLE
 
	$fuŒ«me
(
X
Ë
RENAME
 
TO
 
	`nm
(
Z
). {

1460 
	`sqlôe4A…îRíameTabÀ
(
pP¨£
,
X
,&
Z
);

1461 
	}
}

1462 
cmd
 ::
ALTER
 
TABLE
 
add_cﬁumn_fuŒ«me
 
ADD
 
kwcﬁumn_›t
 
cﬁumn
(
Y
). {

1463 
sqlôe4A…îFöishAddCﬁumn
(
pP¨£
, &
Y
);

1465 
add_cﬁumn_fuŒ«me
 ::
fuŒ«me
(
X
). {

1466 
pP¨£
->
db
->
lookaside
.
bE«bÀd
 = 0;

1467 
sqlôe4A…îBegöAddCﬁumn
(
pP¨£
, 
X
);

1469 
kwcﬁumn_›t
 ::= .

1470 
kwcﬁumn_›t
 ::
COLUMNKW
.

1471 %
ídif
 
SQLITE4_OMIT_ALTERTABLE


1474 %
i‚def
 
SQLITE4_OMIT_VIRTUALTABLE


1475 
cmd
 ::
¸óã_vèb
. {
sqlôe4VèbFöishP¨£
(
pP¨£
,0);}

1476 
cmd
 ::
¸óã_vèb
 
LP
 
vèb¨gli°
 
RP
(
X
). {
sqlôe4VèbFöishP¨£
(
pP¨£
,&X);}

1477 
¸óã_vèb
 ::
¸óãkw
 
VIRTUAL
 
TABLE
 
	$nm
(
X
Ë
	$dbnm
(
Y
Ë
USING
 
	`nm
(
Z
). {

1478 
	`sqlôe4VèbBegöP¨£
(
pP¨£
, &
X
, &
Y
, &
Z
);

1479 
	}
}

1480 
vèb¨gli°
 ::
vèb¨g
.

1481 
vèb¨gli°
 ::vèb¨gli° 
COMMA
 
vèb¨g
.

1482 
vèb¨g
 ::. {
sqlôe4VèbArgInô
(
pP¨£
);}

1483 
vèb¨g
 ::vèb¨g 
vèb¨gtokí
.

1484 
vèb¨gtokí
 ::
ANY
(
X
). {
sqlôe4VèbArgExãnd
(
pP¨£
,&X);}

1485 
vèb¨gtokí
 ::
Õ
 
™yli°
 
RP
(
X
). {
sqlôe4VèbArgExãnd
(
pP¨£
,&X);}

1486 
Õ
 ::
LP
(
X
). {
sqlôe4VèbArgExãnd
(
pP¨£
,&X);}

1487 
™yli°
 ::= .

1488 
™yli°
 ::™yli° 
LP
ányli° 
RP
.

1489 
™yli°
 ::™yli° 
ANY
.

1490 %
ídif
 
SQLITE4_OMIT_VIRTUALTABLE


	@src/pragma.c

14 
	~"sqlôeI¡.h
"

15 
	~"bt.h
"

20 
u8
 
	$sqlôe4GëBoﬁón
(c⁄° *
z
){

22 c⁄° 
zText
[] = "onoffalseyestrue";

23 c⁄° 
u8
 
iOff£t
[] = {0, 1, 2, 4, 9, 12};

24 c⁄° 
u8
 
iLígth
[] = {2, 2, 3, 5, 3, 4};

25 c⁄° 
u8
 
iVÆue
[] = {1, 0, 0, 0, 1, 1};

26 
i
, 
n
;

27 if–
	`sqlôe4Isdigô
(*
z
) ){

28  (
u8
)
	`sqlôe4Atoi
(
z
);

30 
n
 = 
	`sqlôe4SåÀn30
(
z
);

31 
i
=0; i<
	`AºaySize
(
iLígth
); i++){

32 if–
iLígth
[
i
]==
n
 && 
	`sqlôe4_°∫icmp
(&
zText
[
iOff£t
[i]],
z
,n)==0 ){

33  
iVÆue
[
i
];

37 
	}
}

43 #i‡!
deföed
(
SQLITE4_OMIT_PRAGMA
)

48 
	$ªtu∫SögÀI¡
(
P¨£
 *
pP¨£
, c⁄° *
zLabñ
, 
i64
 
vÆue
){

49 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

50 
mem
 = ++
pP¨£
->
nMem
;

51 
sqlôe4_num
 *
pNum
;

53 
pNum
 = 
	`sqlôe4DbMÆlocRaw
(
pP¨£
->
db
, (
vÆue
));

54 if–
pNum
 ){

55 *
pNum
 = 
	`sqlôe4_num_‰om_öt64
(
vÆue
);

57 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Num
, 1, 
mem
, 0, (*)
pNum
, 
P4_NUM
);

58 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

59 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, 
zLabñ
, 
SQLITE4_STATIC
);

60 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
mem
, 1);

61 
	}
}

63 #i‚de‡
SQLITE4_OMIT_FLAG_PRAGMAS


69 
	$ÊagPøgma
(
P¨£
 *
pP¨£
, c⁄° *
zLe·
, c⁄° *
zRight
){

70 c⁄° 
	ssPøgmaTy≥
 {

71 c⁄° *
zName
;

72 
mask
;

73 } 
aPøgma
[] = {

74 { "ªvî£_un‹dîed_£À˘s", 
SQLITE4_Revî£Ordî
 },

75 { "autom©ic_ödex", 
SQLITE4_AutoIndex
 },

76 #ifde‡
SQLITE4_DEBUG


77 { "sql_åa˚", 
SQLITE4_SqlTø˚
 },

78 { "vdbe_li°ög", 
SQLITE4_VdbeLi°ög
 },

79 { "vdbe_åa˚", 
SQLITE4_VdbeTø˚
 },

80 { "kv_åa˚", 
SQLITE4_KvTø˚
 },

81 { "åa˚", 
SQLITE4_SqlTø˚
 | 
SQLITE4_VdbeLi°ög
 |

82 
SQLITE4_VdbeTø˚
 | 
SQLITE4_KvTø˚
 },

83 { "vdbe_add›åa˚", 
SQLITE4_VdbeAdd›Tø˚
 },

85 #i‚de‡
SQLITE4_OMIT_CHECK


86 { "ign‹e_check_c⁄°øöts", 
SQLITE4_Ign‹eChecks
 },

89 { "wrôabÀ_schema", 
SQLITE4_WrôeSchema
|
SQLITE4_RecovîyMode
 },

93 #i‡!
	`deföed
(
SQLITE4_OMIT_FOREIGN_KEY
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

94 { "f‹eign_keys", 
SQLITE4_F‹eignKeys
 },

97 
i
, 
j
;

98 c⁄° 
sPøgmaTy≥
 *
p
;

99 
i
=0, 
p
=
aPøgma
; i<
	`AºaySize
(aPragma); i++,Ö++){

100 if–
	`sqlôe4_°ricmp
(
zLe·
, 
p
->
zName
)==0 ){

101 
sqlôe4
 *
db
 = 
pP¨£
->db;

102 
Vdbe
 *
v
;

103 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

104 
	`as£π
–
v
!=0 );

105 if–
	`ALWAYS
(
v
) ){

106 if–
zRight
==0 ){

107 
	`ªtu∫SögÀI¡
(
pP¨£
, 
p
->
zName
, (
db
->
Êags
 &Ö->
mask
)!=0 );

109 
mask
 = 
p
->mask;

110 if–
db
->
pSavïoöt
 ){

113 
mask
 &~(
SQLITE4_F‹eignKeys
);

116 if–
	`sqlôe4GëBoﬁón
(
zRight
) ){

117 
db
->
Êags
 |
mask
;

119 
db
->
Êags
 &~
mask
;

126 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Expúe
, 0, 0);

128 
j
=0; j<
db
->
nDb
; j++){

129 if–
db
->
aDb
[
j
].
pKV
 ){

130 
db
->
aDb
[
j
].
pKV
->
fTø˚
 = (db->
Êags
 & 
SQLITE4_KvTø˚
)!=0;

139 
	}
}

145 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


146 c⁄° *
	$a˘i⁄Name
(
u8
 
a˘i⁄
){

147 c⁄° *
zName
;

148  
a˘i⁄
 ){

149 
OE_SëNuŒ
: 
zName
 = "SET NULL"; ;

150 
OE_SëDÊt
: 
zName
 = "SET DEFAULT"; ;

151 
OE_Casˇde
: 
zName
 = "CASCADE"; ;

152 
OE_Re°ri˘
: 
zName
 = "RESTRICT"; ;

153 : 
zName
 = "NO ACTION";

154 
	`as£π
–
a˘i⁄
==
OE_N⁄e
 ); ;

156  
zName
;

157 
	}
}

163 
	$sqlôe4Pøgma
(

164 
P¨£
 *
pP¨£
,

165 
Tokí
 *
pId1
,

166 
Tokí
 *
pId2
,

167 
Ex¥Li°
 *
pLi°


169 
sqlôe4
 *
db
 = 
pP¨£
->db;

170 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
 = 
	`sqlôe4VdbeCª©e
(
db
);

171 
Tokí
 *
pPøgma
;

172 *
zPøgma
 = 0;

173 *
zRight
 = 0;

174 
iDb
;

175 c⁄° *
zDb
;

176 
rc
 = 
SQLITE4_OK
;

177 
KVSt‹e
 *
pKV
;

181 
iDb
 = 
	`sqlôe4TwoP¨tName
(
pP¨£
, 
pId1
, 
pId2
, &
pPøgma
);

182 if–
iDb
<0 ) 
¥agma_out
;

183 
zPøgma
 = 
	`sqlôe4NameFromTokí
(
db
, 
pPøgma
);

184 if–!
zPøgma
 ) 
¥agma_out
;

186 
	`as£π
–
pId2
 );

187 
zDb
 = 
pId2
->
n
>0 ? 
db
->
aDb
[
iDb
].
zName
 : 0;

190 if–
iDb
==1 && 
	`sqlôe4O≥nTempD©aba£
(
pP¨£
) ){

191 
¥agma_out
;

196 
pKV
 = 
db
->
aDb
[
iDb
].pKV;

197 if–
pKV
->
pSt‹eVfunc
->
xGëMëhod
 ){

198 (*
xFunc
)(
sqlôe4_c⁄ãxt
 *, , 
sqlôe4_vÆue
 **);

199 (*
xDe°roy
)(*);

200 *
pArg
;

202 
rc
 = 
pKV
->
pSt‹eVfunc
->
	`xGëMëhod
’KV, 
zPøgma
, &
pArg
, &
xFunc
, &
xDe°roy
);

203 if–
rc
==
SQLITE4_OK
 ){

204 
FuncDef
 *
pDef
;

205 
r1
 = 0;

206 
ªgOut
;

208 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_PRAGMA
, 
zPøgma
, 0, 
zDb
) ){

209 
¥agma_out
;

212 
pDef
 = (
FuncDef
 *)
	`sqlôe4DbMÆlocZîo
(
db
, (FuncDef));

213 if–!
pDef
 ) 
¥agma_out
;

214 
pDef
->
Êags
 = 
SQLITE4_FUNC_EPHEM
;

215 
pDef
->
pU£rD©a
 = 
pArg
;

216 
pDef
->
xFunc
 = xFunc;

217 
pDef
->
xDe°roy
 = xDestroy;

219 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

220 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, 
zPøgma
, 
SQLITE4_TRANSIENT
);

222 if–
pLi°
 ){

223 
r1
 = 
pP¨£
->
nMem
+1;

224 
pP¨£
->
nMem
 +
pLi°
->
nEx¥
;

225 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pLi°
, 
r1
, 0);

226 
pDef
->
nArg
 = 
pLi°
->
nEx¥
;

229 
ªgOut
 = ++
pP¨£
->
nMem
;

230 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_KVMëhod
, 
iDb
);

231 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Fun˘i⁄
, 0, 
r1
, 
ªgOut
);

232 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (*)
pDef
, 
P4_FUNCDEF
);

233 if–
pLi°
 ) 
	`sqlôe4VdbeCh™geP5
(
v
,ÖLi°->
nEx¥
);

234 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
ªgOut
, 1);

235 
¥agma_out
;

237 }if–
rc
==
SQLITE4_NOTFOUND
 ){

238 
rc
 = 
SQLITE4_OK
;

240 
¥agma_out
;

244 
pP¨£
->
nMem
 = 2;

245 
	`sqlôe4VdbeRunO∆yOn˚
(
v
);

246 
zRight
 = 0;

247 if–
pLi°
 ){

248 
zRight
 = 
pLi°
->
a
[0].
zS∑n
;

249 if–
zRight
==0 ){

250 
	`as£π
–
pLi°
->
a
[0].
pEx¥
->
›
==
TK_ID
 );

251 
zRight
 = 
pLi°
->
a
[0].
pEx¥
->
u
.
zTokí
;

253 
	`sqlôe4DequŸe
(
zRight
);

256 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_PRAGMA
, 
zPøgma
, 
zRight
, 
zDb
) ){

257 
¥agma_out
;

260 #i‚de‡
SQLITE4_OMIT_FLAG_PRAGMAS


261 if–
	`ÊagPøgma
(
pP¨£
, 
zPøgma
, 
zRight
) ){

270 if–
	`sqlôe4_°ricmp
(
zPøgma
, "·s_check")==0 && 
zRight
 ){

271 
iCksum1
;

272 
iCksum2
;

273 
Index
 *
pIdx
;

274 
TabÀ
 *
pTab
;

275 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

276 if–
v
==0 || 
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

278 
iCksum1
 = ++
pP¨£
->
nMem
;

279 
iCksum2
 = ++
pP¨£
->
nMem
;

280 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
iCksum1
);

281 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
iCksum2
);

283 
pIdx
 = 
	`sqlôe4FödIndex
(
db
, 
zRight
, 
zDb
);

284 if–
pIdx
 &&ÖIdx->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
 ){

285 
iTab
 = 
pP¨£
->
nTab
++;

286 
iAddr
;

287 
iReg
;

288 
i
;

290 
pTab
 = 
pIdx
->
pTabÀ
;

291 
	`sqlôe4O≥nPrim¨yKey
(
pP¨£
, 
iTab
, 
iDb
, 
pTab
, 
OP_O≥nRód
);

292 
iAddr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
iTab
, 0);

294 
iReg
 = 
pP¨£
->
nMem
+1;

295 
pP¨£
->
nMem
 +(1 + 
pTab
->
nCﬁ
);

297 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iTab
, 
iReg
);

298 
i
=0; i<
pTab
->
nCﬁ
; i++){

299 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iTab
, 
i
, 
iReg
+1+i);

301 
	`sqlôe4Fts5CodeCksum
(
pP¨£
, 
pIdx
, 
iCksum1
, 
iReg
, 0);

303 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iTab
, 
iAddr
+1);

304 
	`sqlôe4VdbeJumpHîe
(
v
, 
iAddr
);

305 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iTab
);

307 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_O≥nRód
, 
iTab
, 
pIdx
->
äum
, 
iDb
);

308 
iAddr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
iTab
, 0);

310 
iReg
 = 
pP¨£
->
nMem
+1;

311 
pP¨£
->
nMem
 += 2;

312 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iTab
, 
iReg
);

313 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowD©a
, 
iTab
, 
iReg
+1);

314 
	`sqlôe4Fts5CodeCksum
(
pP¨£
, 
pIdx
, 
iCksum2
, 
iReg
, 1);

316 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iTab
, 
iAddr
+1);

317 
	`sqlôe4VdbeJumpHîe
(
v
, 
iAddr
);

318 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iTab
);

320 
iReg
 = ++
pP¨£
->
nMem
;

321 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
iReg
, 0, "ok", 0);

322 
iAddr
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Eq
, 
iCksum1
, 0, 
iCksum2
);

323 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
iReg
, 0, "error - cksum mismatch", 0);

324 
	`sqlôe4VdbeJumpHîe
(
v
, 
iAddr
);

325 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
iReg
, 1);

327 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

331 #i‚de‡
SQLITE4_OMIT_SCHEMA_PRAGMAS


344 if–
	`sqlôe4_°ricmp
(
zPøgma
, "èbÀ_öfo")==0 && 
zRight
 ){

345 
TabÀ
 *
pTab
;

346 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

347 
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
zRight
, 
zDb
);

348 if–
pTab
 ){

349 
i
;

350 
nHiddí
 = 0;

351 
Cﬁumn
 *
pCﬁ
;

352 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 6);

353 
pP¨£
->
nMem
 = 6;

354 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "cid", 
SQLITE4_STATIC
);

355 
	`sqlôe4VdbeSëCﬁName
(
v
, 1, 
COLNAME_NAME
, "«me", 
SQLITE4_STATIC
);

356 
	`sqlôe4VdbeSëCﬁName
(
v
, 2, 
COLNAME_NAME
, "ty≥", 
SQLITE4_STATIC
);

357 
	`sqlôe4VdbeSëCﬁName
(
v
, 3, 
COLNAME_NAME
, "nŸnuŒ", 
SQLITE4_STATIC
);

358 
	`sqlôe4VdbeSëCﬁName
(
v
, 4, 
COLNAME_NAME
, "dÊt_vÆue", 
SQLITE4_STATIC
);

359 
	`sqlôe4VdbeSëCﬁName
(
v
, 5, 
COLNAME_NAME
, "pk", 
SQLITE4_STATIC
);

360 
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
, 
pTab
);

361 
i
=0, 
pCﬁ
=
pTab
->
aCﬁ
; i<pTab->
nCﬁ
; i++,ÖCol++){

362 if–
	`IsHiddíCﬁumn
(
pCﬁ
) ){

363 
nHiddí
++;

366 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
-
nHiddí
, 1);

367 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 2, 0, 
pCﬁ
->
zName
, 0);

368 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 3, 0,

369 
pCﬁ
->
zTy≥
 ?ÖCol->zType : "", 0);

370 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, (
pCﬁ
->
nŸNuŒ
 ? 1 : 0), 4);

371 if–
pCﬁ
->
zDÊt
 ){

372 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 5, 0, (*)
pCﬁ
->
zDÊt
, 0);

374 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 5);

376 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
pCﬁ
->
iPrimKey
, 6);

377 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 6);

382 if–
	`sqlôe4_°ricmp
(
zPøgma
, "ödex_öfo")==0 && 
zRight
 ){

383 
Index
 *
pIdx
;

384 
TabÀ
 *
pTab
;

385 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

386 
pIdx
 = 
	`sqlôe4FödIndex
(
db
, 
zRight
, 
zDb
);

387 if–
pIdx
 ){

388 
i
;

389 
pTab
 = 
pIdx
->
pTabÀ
;

390 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 3);

391 
pP¨£
->
nMem
 = 3;

392 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "£qno", 
SQLITE4_STATIC
);

393 
	`sqlôe4VdbeSëCﬁName
(
v
, 1, 
COLNAME_NAME
, "cid", 
SQLITE4_STATIC
);

394 
	`sqlôe4VdbeSëCﬁName
(
v
, 2, 
COLNAME_NAME
, "«me", 
SQLITE4_STATIC
);

395 
i
=0; i<
pIdx
->
nCﬁumn
; i++){

396 
˙um
 = 
pIdx
->
aiCﬁumn
[
i
];

397 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
, 1);

398 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
˙um
, 2);

399 
	`as£π
–
pTab
->
nCﬁ
>
˙um
 );

400 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 3, 0, 
pTab
->
aCﬁ
[
˙um
].
zName
, 0);

401 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 3);

406 if–
	`sqlôe4_°ricmp
(
zPøgma
, "ödex_li°")==0 && 
zRight
 ){

407 
Index
 *
pIdx
;

408 
TabÀ
 *
pTab
;

409 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

410 
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
zRight
, 
zDb
);

411 if–
pTab
 ){

412 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

413 
pIdx
 = 
pTab
->
pIndex
;

414 if–
pIdx
 ){

415 
i
 = 0;

416 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 3);

417 
pP¨£
->
nMem
 = 3;

418 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "£q", 
SQLITE4_STATIC
);

419 
	`sqlôe4VdbeSëCﬁName
(
v
, 1, 
COLNAME_NAME
, "«me", 
SQLITE4_STATIC
);

420 
	`sqlôe4VdbeSëCﬁName
(
v
, 2, 
COLNAME_NAME
, "unique", 
SQLITE4_STATIC
);

421 
pIdx
){

422 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
, 1);

423 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 2, 0, 
pIdx
->
zName
, 0);

424 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
pIdx
->
⁄Eº‹
!=
OE_N⁄e
, 3);

425 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 3);

426 ++
i
;

427 
pIdx
 =ÖIdx->
pNext
;

433 if–
	`sqlôe4_°ricmp
(
zPøgma
, "database_list")==0 ){

434 
i
;

435 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

436 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 2);

437 
pP¨£
->
nMem
 = 3;

438 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "£q", 
SQLITE4_STATIC
);

439 
	`sqlôe4VdbeSëCﬁName
(
v
, 1, 
COLNAME_NAME
, "«me", 
SQLITE4_STATIC
);

440 
i
=0; i<
db
->
nDb
; i++){

441 if–
db
->
aDb
[
i
].
pKV
==0 ) ;

442 
	`as£π
–
db
->
aDb
[
i
].
zName
!=0 );

443 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
, 1);

444 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 2, 0, 
db
->
aDb
[
i
].
zName
, 0);

445 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 2);

449 if–
	`sqlôe4_°ricmp
(
zPøgma
, "collation_list")==0 ){

450 
i
 = 0;

451 
HashEÀm
 *
p
;

452 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 2);

453 
pP¨£
->
nMem
 = 2;

454 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "£q", 
SQLITE4_STATIC
);

455 
	`sqlôe4VdbeSëCﬁName
(
v
, 1, 
COLNAME_NAME
, "«me", 
SQLITE4_STATIC
);

456 
p
=
	`sqlôeHashFú°
(&
db
->
aCﬁlSeq
);Ö;Ö=
	`sqlôeHashNext
(p)){

457 
CﬁlSeq
 *
pCﬁl
 = (CﬁlSeq *)
	`sqlôeHashD©a
(
p
);

458 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
++, 1);

459 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 2, 0, 
pCﬁl
->
zName
, 0);

460 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 2);

465 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


466 if–
	`sqlôe4_°ricmp
(
zPøgma
, "f‹eign_key_li°")==0 && 
zRight
 ){

467 
FKey
 *
pFK
;

468 
TabÀ
 *
pTab
;

469 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

470 
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
zRight
, 
zDb
);

471 if–
pTab
 ){

472 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

473 
pFK
 = 
pTab
->
pFKey
;

474 if–
pFK
 ){

475 
i
 = 0;

476 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 8);

477 
pP¨£
->
nMem
 = 8;

478 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "id", 
SQLITE4_STATIC
);

479 
	`sqlôe4VdbeSëCﬁName
(
v
, 1, 
COLNAME_NAME
, "£q", 
SQLITE4_STATIC
);

480 
	`sqlôe4VdbeSëCﬁName
(
v
, 2, 
COLNAME_NAME
, "èbÀ", 
SQLITE4_STATIC
);

481 
	`sqlôe4VdbeSëCﬁName
(
v
, 3, 
COLNAME_NAME
, "‰om", 
SQLITE4_STATIC
);

482 
	`sqlôe4VdbeSëCﬁName
(
v
, 4, 
COLNAME_NAME
, "to", 
SQLITE4_STATIC
);

483 
	`sqlôe4VdbeSëCﬁName
(
v
, 5, 
COLNAME_NAME
, "⁄_upd©e", 
SQLITE4_STATIC
);

484 
	`sqlôe4VdbeSëCﬁName
(
v
, 6, 
COLNAME_NAME
, "⁄_dñëe", 
SQLITE4_STATIC
);

485 
	`sqlôe4VdbeSëCﬁName
(
v
, 7, 
COLNAME_NAME
, "m©ch", 
SQLITE4_STATIC
);

486 
pFK
){

487 
j
;

488 
j
=0; j<
pFK
->
nCﬁ
; j++){

489 *
zCﬁ
 = 
pFK
->
aCﬁ
[
j
].zCol;

490 *
zOnDñëe
 = (*)
	`a˘i⁄Name
(
pFK
->
aA˘i⁄
[0]);

491 *
zOnUpd©e
 = (*)
	`a˘i⁄Name
(
pFK
->
aA˘i⁄
[1]);

492 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
i
, 1);

493 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
j
, 2);

494 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 3, 0, 
pFK
->
zTo
, 0);

495 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 4, 0,

496 
pTab
->
aCﬁ
[
pFK
->aCﬁ[
j
].
iFrom
].
zName
, 0);

497 
	`sqlôe4VdbeAddOp4
(
v
, 
zCﬁ
 ? 
OP_Såög8
 : 
OP_NuŒ
, 0, 5, 0, zCol, 0);

498 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 6, 0, 
zOnUpd©e
, 0);

499 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 7, 0, 
zOnDñëe
, 0);

500 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 8, 0, "NONE", 0);

501 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 8);

503 ++
i
;

504 
pFK
 =ÖFK->
pNextFrom
;

511 #i‚de‡
NDEBUG


512 if–
	`sqlôe4_°ricmp
(
zPøgma
, "parser_trace")==0 ){

513 if–
zRight
 ){

514 if–
	`sqlôe4GëBoﬁón
(
zRight
) ){

515 
	`sqlôe4P¨£rTø˚
(
°dîr
, "parser: ");

517 
	`sqlôe4P¨£rTø˚
(0, 0);

526 if–
	`sqlôe4_°ricmp
(
zPøgma
, "case_sensitive_like")==0 ){

527 if–
zRight
 ){

528 
	`sqlôe4Regi°îLikeFun˘i⁄s
(
db
, 
	`sqlôe4GëBoﬁón
(
zRight
));

532 #i‚de‡
SQLITE4_INTEGRITY_CHECK_ERROR_MAX


533 
	#SQLITE4_INTEGRITY_CHECK_ERROR_MAX
 100

	)

537 #i‚de‡
SQLITE4_OMIT_UTF16


560 if–
	`sqlôe4_°ricmp
(
zPøgma
, "encoding")==0 ){

561 c⁄° 
	sEncName
 {

562 *
zName
;

563 
u8
 
íc
;

564 } 
í˙ames
[] = {

565 { "UTF8", 
SQLITE4_UTF8
 },

566 { "UTF-8", 
SQLITE4_UTF8
 },

567 { "UTF-16À", 
SQLITE4_UTF16LE
 },

568 { "UTF-16be", 
SQLITE4_UTF16BE
 },

569 { "UTF16À", 
SQLITE4_UTF16LE
 },

570 { "UTF16be", 
SQLITE4_UTF16BE
 },

575 c⁄° 
EncName
 *
pEnc
;

576 if–!
zRight
 ){

577 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

578 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

579 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "ícodög", 
SQLITE4_STATIC
);

580 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Såög8
, 0, 1);

581 
	`as£π
–
í˙ames
[
SQLITE4_UTF8
].
íc
==SQLITE4_UTF8 );

582 
	`as£π
–
í˙ames
[
SQLITE4_UTF16LE
].
íc
==SQLITE4_UTF16LE );

583 
	`as£π
–
í˙ames
[
SQLITE4_UTF16BE
].
íc
==SQLITE4_UTF16BE );

584 
	`sqlôe4VdbeCh™geP4
(
v
, -1, 
í˙ames
[
	`ENC
(
pP¨£
->
db
)].
zName
, 
P4_STATIC
);

585 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 1);

593 !(
	`DbHasPr›îty
(
db
, 0, 
DB_SchemaLﬂded
)) ||

594 
	`DbHasPr›îty
(
db
, 0, 
DB_Em±y
)

596 
pEnc
=&
í˙ames
[0];ÖEnc->
zName
;ÖEnc++){

597 if–0==
	`sqlôe4_°ricmp
(
zRight
, 
pEnc
->
zName
) ){

598 
	`ENC
(
pP¨£
->
db
Ë
pEnc
->
íc
 ?ÖEnc->í¯: 
SQLITE4_UTF16NATIVE
;

602 if–!
pEnc
->
zName
 ){

603 
	`sqlôe4Eº‹Msg
(
pP¨£
, "unsuµ‹ãdÉncodög: %s", 
zRight
);

611 #i‚de‡
SQLITE4_OMIT_COMPILEOPTION_DIAGS


618 if–
	`sqlôe4_°ricmp
(
zPøgma
, "compile_options")==0 ){

619 
i
 = 0;

620 c⁄° *
zO±
;

621 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

622 
pP¨£
->
nMem
 = 1;

623 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "compûe_›ti⁄", 
SQLITE4_STATIC
);

624  (
zO±
 = 
	`sqlôe4_compûe›ti⁄_gë
(
i
++))!=0 ){

625 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 1, 0, 
zO±
, 0);

626 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 1);

631 #ifde‡
SQLITE4_DEBUG


637 if–
	`sqlôe4_°ricmp
(
zPøgma
, "kvdump")==0 ){

638 
	`sqlôe4KVSt‹eDump
(
db
->
aDb
[0].
pKV
);

649 if–
	`sqlôe4_°ricmp
(
zPøgma
, "kvreplace")==0

650 && 
pLi°
->
nEx¥
==2

652 
r1
, 
r2
;

653 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

654 
pP¨£
->
nTab
 = 1;

655 
pP¨£
->
nMem
 = 3;

656 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

657 
r1
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pLi°
->
a
[0].
pEx¥
, 1);

658 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_HÆtIfNuŒ
, 
SQLITE4_CONSTRAINT
, 
OE_Ab‹t
,

659 
r1
, "key mayÇŸ bênuŒ", 
P4_STATIC
);

660 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_ToBlob
, 
r1
);

661 
r2
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pLi°
->
a
[1].
pEx¥
, 2);

662 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_HÆtIfNuŒ
, 
SQLITE4_CONSTRAINT
, 
OE_Ab‹t
,

663 
r2
, "vÆuêmayÇŸ bênuŒ", 
P4_STATIC
);

664 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_ToBlob
, 
r2
);

665 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_O≥nWrôe
);

666 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 0, 
r2
, 
r1
);

667 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_HÆt
);

677 if–
	`sqlôe4_°ricmp
(
zPøgma
, "integrity_check")==0 ){

678 c⁄° 
ba£C§
 = 1;

680 c⁄° 
ªgEº˙t
 = 1;

681 c⁄° 
ªgEº°r
 = 2;

682 c⁄° 
ªgTmp
 = 3;

683 c⁄° 
ªgRow˙t1
 = 4;

684 c⁄° 
ªgRow˙t2
 = 5;

685 c⁄° 
ªgResu…
 = 6;

686 c⁄° 
ªgKey
 = 7;

687 c⁄° 
ªgAºay
 = 8;

689 
i
;

690 
nMaxAºay
 = 1;

691 
addrNŸ
 = 0;

692 
Vdbe
 *
v
;

694 if–
	`sqlôe4RódSchema
(
pP¨£
ËË
¥agma_out
;

696 
i
=0; i<
db
->
nDb
; i++){

697 if–
OMIT_TEMPDB
 && 
i
==1 ) ;

698 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
i
);

701 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

702 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgEº˙t
);

703 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgEº°r
, 0, "", 0);

705 
i
=0; i<
db
->
nDb
; i++){

706 
Hash
 *
pTbls
;

707 
HashEÀm
 *
x
;

709 if–
OMIT_TEMPDB
 && 
i
==1 ) ;

711 
pTbls
 = &
db
->
aDb
[
i
].
pSchema
->
tblHash
;

712 
x
=
	`sqlôeHashFú°
(
pTbls
); x; x=
	`sqlôeHashNext
(x)){

713 
Index
 *
pIdx
;

714 
TabÀ
 *
pTab
 = (TabÀ *)
	`sqlôeHashD©a
(
x
);

715 
addrRewöd
;

716 
nIdx
 = 0;

717 
iPkC§
;

718 
Index
 *
pPk
;

719 
iC§
;

722 if–
	`IsVõw
(
pTab
Ë|| 
	`IsKv°‹e
(pTab) ) ;

725 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

726 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

727 
pPk
 = 
pIdx
;

728 
iPkC§
 = 
nIdx
+
ba£C§
;

730 
nIdx
++;

732 
	`sqlôe4O≥nAŒIndexes
(
pP¨£
, 
pTab
, 
ba£C§
, 
OP_O≥nRód
);

734 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgRow˙t1
);

735 
addrRewöd
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rewöd
, 
iPkC§
);

738 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgRow˙t1
, 1);

740 
iC§
=
ba£C§
, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, iCsr++){

741 
	`as£π
–(
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
)==(
iC§
==
iPkC§
) );

742 if–
iC§
!=
iPkC§
 ){

743 *
zEº
;

744 
iCﬁ
;

745 
jmp
;

746 
iCﬁ
=0; iCﬁ<
pIdx
->
nCﬁumn
; iCol++){

747 
r
 = 
ªgAºay
 + 
iCﬁ
;

748 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iPkC§
, 
pIdx
->
aiCﬁumn
[
iCﬁ
], 
r
);

749 
	`as£π
–
pIdx
->
aiCﬁumn
[
iCﬁ
]>=0 );

751 
iCﬁ
=0; iCﬁ<
pPk
->
nCﬁumn
; iCol++){

752 
ªg
 = 
ªgAºay
 + 
pIdx
->
nCﬁumn
 + 
iCﬁ
;

753 
iTblCﬁ
 = 
pPk
->
aiCﬁumn
[
iCﬁ
];

754 if–
iTblCﬁ
<0 ){

755 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iPkC§
, 
ªg
);

757 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iPkC§
, 
iTblCﬁ
, 
ªg
);

761 if–(
pPk
->
nCﬁumn
+
pIdx
->nCﬁumn)>
nMaxAºay
 ){

762 
nMaxAºay
 = 
pPk
->
nCﬁumn
 + 
pIdx
->nColumn;

765 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgAºay
,

766 
pIdx
->
nCﬁumn
+
pPk
->nCﬁumn, 
ªgKey
, 
iC§
);

767 
jmp
 = 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Found
, 
iC§
, 0, 
ªgKey
, 0, 
P4_INT32
);

768 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgEº˙t
, 1);

769 
zEº
 = 
	`sqlôe4MPrötf
(

770 
db
, "íåy missög from index %s: ", 
pIdx
->
zName


772 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgTmp
, 0, 
zEº
, 0);

773 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgTmp
, 
ªgEº°r
,ÑegErrstr);

774 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Fun˘i⁄
, 0, 
ªgKey
, 
ªgTmp
);

775 
	`sqlôe4VdbeCh™geP4
(
v
, -1,

776 (*)
	`sqlôe4FödFun˘i⁄
(
db
, "hex", 3, 1, 0),

777 
P4_FUNCDEF


779 
	`sqlôe4VdbeCh™geP5
(
v
, 1);

780 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgTmp
, 
ªgEº°r
,ÑegErrstr);

781 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgTmp
, 0, "\n", 0);

782 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgTmp
, 
ªgEº°r
,ÑegErrstr);

783 
	`sqlôe4VdbeJumpHîe
(
v
, 
jmp
);

784 
	`sqlôe4DbFªe
(
db
, 
zEº
);

787 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iPkC§
, 
addrRewöd
+1);

788 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrRewöd
);

790 
iC§
=
ba£C§
, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, iCsr++){

791 if–
iC§
!=
iPkC§
 ){

792 *
zEº
;

793 
addrEq
;

794 
addrRewöd2
;

795 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgRow˙t2
);

796 
addrRewöd2
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rewöd
, 
iC§
);

797 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgRow˙t2
, 1);

798 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iC§
, 
addrRewöd2
+1);

799 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrRewöd2
);

800 
zEº
 = 
	`sqlôe4MPrötf
(

801 
db
, "wr⁄g #Çumbî o‡íåõ†ö index %s\n", 
pIdx
->
zName


803 
addrEq
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Eq
, 
ªgRow˙t1
, 0, 
ªgRow˙t2
);

804 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
ªgEº˙t
, 1);

805 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgTmp
, 0, 
zEº
, 0);

806 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgTmp
, 
ªgEº°r
,ÑegErrstr);

808 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrEq
);

809 
	`sqlôe4DbFªe
(
db
, 
zEº
);

813 
iC§
=
ba£C§
; iC§<(ba£C§+
nIdx
); iCsr++){

814 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
iC§
);

819 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgResu…
, 0, "ok", 0);

820 
addrNŸ
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfNŸ
, 
ªgEº˙t
);

821 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Såög8
, 0, 
ªgAºay
, 0, "Érrors:\n", 0);

822 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgAºay
, 
ªgEº˙t
, 
ªgResu…
);

823 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_C⁄ˇt
, 
ªgEº°r
, 
ªgResu…
,ÑegResult);

824 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrNŸ
);

826 
pP¨£
->
nMem
 = (
ªgAºay
 + 
nMaxAºay
);

827 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

828 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "öãgrôy_check", 
SQLITE4_STATIC
);

829 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
ªgResu…
, 1);

840 if–
	`sqlôe4_°ricmp
(
zPøgma
, "shrink_memory")==0 ){

841 
	`sqlôe4_db_ªÀa£_mem‹y
(
db
);

847 if–
	`sqlôe4_°ricmp
(
zPøgma
, "schema_version")==0 ){

848 if–
zRight
 ){

850 c⁄° 
VdbeOpLi°
 
£tCookõ
[] = {

851 { 
OP_Tønß˘i⁄
, 0, 1, 0},

852 { 
OP_I¡egî
, 0, 1, 0},

853 { 
OP_SëCookõ
, 0, 0, 1},

855 
addr
 = 
	`sqlôe4VdbeAddOpLi°
(
v
, 
	`AºaySize
(
£tCookõ
), setCookie);

856 
	`sqlôe4VdbeCh™geP1
(
v
, 
addr
, 
iDb
);

857 
	`sqlôe4VdbeCh™geP1
(
v
, 
addr
+1, 
	`sqlôe4Atoi
(
zRight
));

858 
	`sqlôe4VdbeCh™geP1
(
v
, 
addr
+2, 
iDb
);

861 c⁄° 
VdbeOpLi°
 
ªadCookõ
[] = {

862 { 
OP_Tønß˘i⁄
, 0, 0, 0},

863 { 
OP_RódCookõ
, 0, 1, 0},

864 { 
OP_Resu…Row
, 1, 1, 0}

866 
addr
 = 
	`sqlôe4VdbeAddOpLi°
(
v
, 
	`AºaySize
(
ªadCookõ
),ÑeadCookie);

867 
	`sqlôe4VdbeCh™geP1
(
v
, 
addr
, 
iDb
);

868 
	`sqlôe4VdbeCh™geP1
(
v
, 
addr
+1, 
iDb
);

869 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

870 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, 
zPøgma
, 
SQLITE4_TRANSIENT
);

878 if–
	`sqlôe4_°ricmp
(
zPøgma
, "bt_∑ge_dump")==0 && 
zRight
 ){

879 
bt_öfo
 
öfo
;

880 
	`mem£t
(&
öfo
, 0, (info));

881 
öfo
.
pgno
 = 
	`sqlôe4Atoi
(
zRight
);

882 
	`sqlôe4_buf„r_öô
(&
öfo
.
ouçut
, 
	`sqlôe4_db_ív
(
db
)->
pMM
);

884 
rc
 = 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, 
zDb
, 
BT_CONTROL_INFO
, (*)&
öfo
);

885 if–
rc
==
SQLITE4_OK
 ){

886 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 1);

887 
	`sqlôe4VdbeSëCﬁName
(
v
, 0, 
COLNAME_NAME
, "öfo", 
SQLITE4_STATIC
);

888 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Såög8
, 0, 1);

889 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (*)
öfo
.
ouçut
.
p
, 
P4_TRANSIENT
);

890 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 1, 1);

892 
	`sqlôe4_buf„r_˛ór
(&
öfo
.
ouçut
);

900 
¥agma_out
:

901 
	`sqlôe4DbFªe
(
db
, 
zPøgma
);

903 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

904 
	}
}

	@src/prepare.c

16 
	~"sqlôeI¡.h
"

22 
	$c‹ru±Schema
(

23 
InôD©a
 *
pD©a
,

24 c⁄° *
zObj
,

25 c⁄° *
zExåa


27 
sqlôe4
 *
db
 = 
pD©a
->db;

28 if–!
db
->
mÆlocFaûed
 && (db->
Êags
 & 
SQLITE4_RecovîyMode
)==0 ){

29 if–
zObj
==0 ) zObj = "?";

30 
	`sqlôe4SëSåög
(
pD©a
->
pzEºMsg
, 
db
,

31 "mÆf‹med d©aba£ schem®(%s)", 
zObj
);

32 if–
zExåa
 ){

33 *
pD©a
->
pzEºMsg
 = 
	`sqlôe4MAµídf
(
db
, *pData->pzErrMsg,

34 "%†- %s", *
pD©a
->
pzEºMsg
, 
zExåa
);

37 
pD©a
->
rc
 = 
db
->
mÆlocFaûed
 ? 
SQLITE4_NOMEM
 : 
SQLITE4_CORRUPT_BKPT
;

38 
	}
}

43 
	$öôCÆlback
(

44 
InôD©a
 *
pD©a
,

45 c⁄° *
zObj
,

46 
iRoŸ
,

47 c⁄° *
zSql


49 
sqlôe4
 *
db
 = 
pD©a
->db;

50 
iDb
 = 
pD©a
->iDb;

52 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

53 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

55 
	`DbCÀ¨Pr›îty
(
db
, 
iDb
, 
DB_Em±y
);

56 if–
db
->
mÆlocFaûed
 ){

57 
	`c‹ru±Schema
(
pD©a
, 
zObj
, 0);

61 if–
zSql
 && zSql[0] ){

66 
rc
;

67 
sqlôe4_°mt
 *
pStmt
;

68 
	`TESTONLY
(
r˝
);

70 
	`as£π
–
db
->
öô
.
busy
 );

71 
db
->
öô
.
iDb
 = iDb;

72 
db
->
öô
.
√wTnum
 = 
iRoŸ
;

73 
db
->
öô
.
‹ph™Triggî
 = 0;

74 
	`TESTONLY
(
r˝
 = ) 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

75 
rc
 = 
db
->
îrCode
;

76 
	`as£π
–(
rc
&0xFF)==(
r˝
&0xFF) );

77 
db
->
öô
.
iDb
 = 0;

78 if–
SQLITE4_OK
!=
rc
 ){

79 if–
db
->
öô
.
‹ph™Triggî
 ){

80 
	`as£π
–
iDb
==1 );

82 
pD©a
->
rc
 =Ñc;

83 if–
rc
==
SQLITE4_NOMEM
 ){

84 
db
->
mÆlocFaûed
 = 1;

85 }if–
rc
!=
SQLITE4_INTERRUPT
 && (rc&0xFF)!=
SQLITE4_LOCKED
 ){

86 
	`c‹ru±Schema
(
pD©a
, 
zObj
, 
	`sqlôe4_îrmsg
(
db
));

91 
TabÀ
 *
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
zObj
, db->
aDb
[
iDb
].
zName
);

92 i‡(
pTab
 && 
iRoŸ
>0 &&ÖTab->
äum
==0) {

93 
pTab
->
äum
 = 
iRoŸ
;

96 
	`sqlôe4_föÆize
(
pStmt
);

97 }if–
zObj
==0 ){

98 
	`c‹ru±Schema
(
pD©a
, 0, 0);

106 
Index
 *
pIndex
;

107 
pIndex
 = 
	`sqlôe4FödIndex
(
db
, 
zObj
, db->
aDb
[
iDb
].
zName
);

108 if–
pIndex
==0 ){

115 }if–
iRoŸ
==0 ){

116 
	`c‹ru±Schema
(
pD©a
, 
zObj
, "invalidÑootpage");

118 
pIndex
->
äum
 = 
iRoŸ
;

122 
	}
}

136 
	$sqlôe4InôCÆlback
(

137 *
pInô
,

138 
nVÆ
,

139 
sqlôe4_vÆue
 **
≠VÆ
,

140 c⁄° **
azCﬁ


142 
InôD©a
 *
pD©a
 = (InôD©a*)
pInô
;

143 
sqlôe4
 *
db
 = 
pD©a
->db;

144 
iDb
 = 
pD©a
->iDb;

146 
	`UNUSED_PARAMETER2
(
azCﬁ
, 
nVÆ
);

147 
	`as£π
–
nVÆ
==3 );

148 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

149 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

151 
	`DbCÀ¨Pr›îty
(
db
, 
iDb
, 
DB_Em±y
);

152 if–
db
->
mÆlocFaûed
 ){

153 
	`c‹ru±Schema
(
pD©a
, 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[0], 0), 0);

154 }if–
≠VÆ
 ){

155 if–
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[1])==
SQLITE4_NULL
 ){

156 
	`c‹ru±Schema
(
pD©a
, 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[0], 0), 0);

158 
	`öôCÆlback
(
pD©a
,

159 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[0], 0),

160 
	`sqlôe4_vÆue_öt
(
≠VÆ
[1]),

161 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[2], 0)

167 
	}
}

169 
	$¸óãSchemaTabÀ
(

170 
InôD©a
 *
pInô
,

171 c⁄° *
zName
,

172 
i64
 
iRoŸ
,

173 c⁄° *
zSchema


175 
TabÀ
 *
pTab
;

176 
	`öôCÆlback
(
pInô
, 
zName
, 
iRoŸ
, 
zSchema
);

177 if–
pInô
->
rc
 )  1;

178 
pTab
 = 
	`sqlôe4FödTabÀ
(
pInô
->
db
, 
zName
,ÖInô->db->
aDb
[pInô->
iDb
].zName);

179 if–
	`ALWAYS
(
pTab
ËËpTab->
èbFœgs
 |
TF_Ród⁄ly
;

181 
	}
}

192 
	$sqlôe4InôO√
(
sqlôe4
 *
db
, 
iDb
, **
pzEºMsg
){

193 
rc
;

194 
TabÀ
 *
pTab
;

195 
Db
 *
pDb
;

196 
InôD©a
 
öôD©a
;

197 c⁄° *
zMa°îSchema
;

198 c⁄° *
zMa°îName
;

199 c⁄° *
zKv°‹eName
;

200 
›íedTønß˘i⁄
 = 0;

202 c⁄° *
aMa°î
[] = {

210 #i‚de‡
SQLITE4_OMIT_TEMPDB


220 c⁄° *
aKv°‹e
[] = {

222 #i‚de‡
SQLITE4_OMIT_TEMPDB


226 c⁄° *
aKv°‹eName
[] = {

228 #i‚de‡
SQLITE4_OMIT_TEMPDB


234 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

235 
	`as£π
–
db
->
aDb
[
iDb
].
pSchema
 );

236 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

239 
zMa°îName
 = 
	`SCHEMA_TABLE
(
iDb
);

240 
zKv°‹eName
 = 
aKv°‹eName
[
iDb
==1];

243 
öôD©a
.
db
 = db;

244 
öôD©a
.
iDb
 = iDb;

245 
öôD©a
.
rc
 = 
SQLITE4_OK
;

246 
öôD©a
.
pzEºMsg
 =ÖzErrMsg;

247 if–
	`¸óãSchemaTabÀ
(&
öôD©a
, 
zMa°îName
, 1, 
aMa°î
[
iDb
==1])

248 || 
	`¸óãSchemaTabÀ
(&
öôD©a
, 
zKv°‹eName
, 
KVSTORE_ROOT
, 
aKv°‹e
[
iDb
==1])

250 
rc
 = 
öôD©a
.rc;

251 
îr‹_out
;

256 
pDb
 = &
db
->
aDb
[
iDb
];

257 if–
pDb
->
pKV
==0 ){

258 if–!
OMIT_TEMPDB
 && 
	`ALWAYS
(
iDb
==1) ){

259 
	`DbSëPr›îty
(
db
, 1, 
DB_SchemaLﬂded
);

261  
SQLITE4_OK
;

267 if–
pDb
->
pKV
->
iTønsLevñ
==0 ){

268 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
pDb
->
pKV
, 1);

269 if–
rc
!=
SQLITE4_OK
 ){

270 
	`sqlôe4SëSåög
(
pzEºMsg
, 
db
, "%s", 
	`sqlôe4EºSå
(
rc
));

271 
öô⁄e_îr‹_out
;

273 
›íedTønß˘i⁄
 = 1;

278 
	`sqlôe4KVSt‹eGëSchema
(
pDb
->
pKV
, (
u32
 *)&pDb->
pSchema
->
schema_cookõ
);

282 
	`as£π
–
db
->
öô
.
busy
 );

284 *
zSql
;

285 
zSql
 = 
	`sqlôe4MPrötf
(
db
,

287 
db
->
aDb
[
iDb
].
zName
, 
zMa°îName
);

288 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


290 
Auth‹izî
 *
pAuth
;

291 
pAuth
 = 
db
->pAuth;

292 
db
->
pAuth
 = 0;

294 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
sqlôe4InôCÆlback
, &
öôD©a
);

295 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


296 
db
->
pAuth
 =ÖAuth;

299 if–
rc
==
SQLITE4_OK
 )Ñ¯
öôD©a
.rc;

300 
	`sqlôe4DbFªe
(
db
, 
zSql
);

301 #i‚de‡
SQLITE4_OMIT_ANALYZE


302 if–
rc
==
SQLITE4_OK
 ){

303 
	`sqlôe4A«lysisLﬂd
(
db
, 
iDb
);

307 if–
db
->
mÆlocFaûed
 ){

308 
rc
 = 
SQLITE4_NOMEM
;

309 
	`sqlôe4Re£tI¡î«lSchema
(
db
, -1);

311 if–
rc
==
SQLITE4_OK
 || (
db
->
Êags
&
SQLITE4_RecovîyMode
)){

320 
	`DbSëPr›îty
(
db
, 
iDb
, 
DB_SchemaLﬂded
);

321 
rc
 = 
SQLITE4_OK
;

327 
öô⁄e_îr‹_out
:

328 if–
›íedTønß˘i⁄
 ){

329 
	`sqlôe4KVSt‹eCommô
(
pDb
->
pKV
, 0);

332 
îr‹_out
:

333 if–
rc
==
SQLITE4_NOMEM
 ||Ñc==
SQLITE4_IOERR_NOMEM
 ){

334 
db
->
mÆlocFaûed
 = 1;

336  
rc
;

337 
	}
}

349 
	$sqlôe4Inô
(
sqlôe4
 *
db
, **
pzEºMsg
){

350 
i
, 
rc
;

351 
commô_öã∫Æ
 = !(
db
->
Êags
&
SQLITE4_I¡înCh™ges
);

353 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

354 
rc
 = 
SQLITE4_OK
;

355 
db
->
öô
.
busy
 = 1;

356 
i
=0; 
rc
==
SQLITE4_OK
 && i<
db
->
nDb
; i++){

357 if–
	`DbHasPr›îty
(
db
, 
i
, 
DB_SchemaLﬂded
) || i==1 ) ;

358 
rc
 = 
	`sqlôe4InôO√
(
db
, 
i
, 
pzEºMsg
);

359 if–
rc
 ){

360 
	`sqlôe4Re£tI¡î«lSchema
(
db
, 
i
);

368 #i‚de‡
SQLITE4_OMIT_TEMPDB


369 if–
rc
==
SQLITE4_OK
 && 
	`ALWAYS
(
db
->
nDb
>1)

370 && !
	`DbHasPr›îty
(
db
, 1, 
DB_SchemaLﬂded
) ){

371 
rc
 = 
	`sqlôe4InôO√
(
db
, 1, 
pzEºMsg
);

372 if–
rc
 ){

373 
	`sqlôe4Re£tI¡î«lSchema
(
db
, 1);

378 
db
->
öô
.
busy
 = 0;

379 if–
rc
==
SQLITE4_OK
 && 
commô_öã∫Æ
 ){

380 
	`sqlôe4CommôI¡î«lCh™ges
(
db
);

383  
rc
;

384 
	}
}

390 
	$sqlôe4RódSchema
(
P¨£
 *
pP¨£
){

391 
rc
 = 
SQLITE4_OK
;

392 
sqlôe4
 *
db
 = 
pP¨£
->db;

393 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

394 if–!
db
->
öô
.
busy
 ){

395 
rc
 = 
	`sqlôe4Inô
(
db
, &
pP¨£
->
zEºMsg
);

397 if–
rc
!=
SQLITE4_OK
 ){

398 
pP¨£
->
rc
 =Ñc;

399 
pP¨£
->
nEº
++;

401  
rc
;

402 
	}
}

410 
	$schemaIsVÆid
(
P¨£
 *
pP¨£
){

411 
sqlôe4
 *
db
 = 
pP¨£
->db;

412 
iDb
;

413 
rc
;

414 
cookõ
;

416 
	`as£π
–
pP¨£
->
checkSchema
 );

417 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

418 
iDb
=0; iDb<
db
->
nDb
; iDb++){

419 
›íedTønß˘i⁄
 = 0;

420 
KVSt‹e
 *
pKV
 = 
db
->
aDb
[
iDb
].pKV;

421 if–
pKV
==0 ) ;

426 if–
pKV
->
iTønsLevñ
==0 ){

427 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
pKV
, 1);

428 if–
rc
==
SQLITE4_NOMEM
 ||Ñc==
SQLITE4_IOERR_NOMEM
 ){

429 
db
->
mÆlocFaûed
 = 1;

431 if–
rc
!=
SQLITE4_OK
 ) ;

432 
›íedTønß˘i⁄
 = 1;

438 
	`sqlôe4KVSt‹eGëSchema
(
pKV
, (
u32
 *)&
cookõ
);

439 if–
cookõ
!=
db
->
aDb
[
iDb
].
pSchema
->
schema_cookõ
 ){

440 
	`sqlôe4Re£tI¡î«lSchema
(
db
, 
iDb
);

441 
pP¨£
->
rc
 = 
SQLITE4_SCHEMA
;

445 if–
›íedTønß˘i⁄
 ){

446 
	`sqlôe4KVSt‹eCommô
(
pKV
, 0);

449 
	}
}

458 
	$sqlôe4SchemaToIndex
(
sqlôe4
 *
db
, 
Schema
 *
pSchema
){

459 
i
 = -1000000;

471 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

472 if–
pSchema
 ){

473 
i
=0; 
	`ALWAYS
(i<
db
->
nDb
); i++){

474 if–
db
->
aDb
[
i
].
pSchema
==pSchema ){

478 
	`as£π
–
i
>=0 && i<
db
->
nDb
 );

480  
i
;

481 
	}
}

486 
	$sqlôe4Pª∑ª
(

487 
sqlôe4
 *
db
,

488 c⁄° *
zSql
,

489 
nByãs
,

490 
Vdbe
 *
pRïª∑ª
,

491 
sqlôe4_°mt
 **
µStmt
,

492 *
≤U£d


494 
P¨£
 *
pP¨£
;

495 *
zEºMsg
 = 0;

496 
rc
 = 
SQLITE4_OK
;

497 
i
;

500 
pP¨£
 = 
	`sqlôe4SèckAŒocZîo
(
db
, (*pParse));

501 if–
pP¨£
==0 ){

502 
rc
 = 
SQLITE4_NOMEM
;

503 
íd_¥ï¨e
;

505 
pP¨£
->
pRïª∑ª
 =ÖReprepare;

506 
	`as£π
–
µStmt
 && *ppStmt==0 );

507 
	`as£π
–!
db
->
mÆlocFaûed
 );

508 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

510 
	`sqlôe4VèbU∆ockLi°
(
db
);

512 
pP¨£
->
db
 = db;

513 
pP¨£
->
nQuîyLo›
 = ()1;

514 if–
nByãs
>=0 && (nByãs==0 || 
zSql
[nBytes-1]!=0) ){

515 *
zSqlC›y
;

516 
mxLí
 = 
db
->
aLimô
[
SQLITE4_LIMIT_SQL_LENGTH
];

517 
	`ã°ˇ£
–
nByãs
==
mxLí
 );

518 
	`ã°ˇ£
–
nByãs
==
mxLí
+1 );

519 if–
nByãs
>
mxLí
 ){

520 
	`sqlôe4Eº‹
(
db
, 
SQLITE4_TOOBIG
, "statementÅooÜong");

521 
rc
 = 
	`sqlôe4ApiExô
(
db
, 
SQLITE4_TOOBIG
);

522 
íd_¥ï¨e
;

524 
zSqlC›y
 = 
	`sqlôe4DbSåNDup
(
db
, 
zSql
, 
nByãs
);

525 if–
zSqlC›y
 ){

526 
	`sqlôe4RunP¨£r
(
pP¨£
, 
zSqlC›y
, &
zEºMsg
);

527 
	`sqlôe4DbFªe
(
db
, 
zSqlC›y
);

528 
pP¨£
->
zTaû
 = &
zSql
[pP¨£->zTaû-
zSqlC›y
];

530 
pP¨£
->
zTaû
 = &
zSql
[
nByãs
];

533 
	`sqlôe4RunP¨£r
(
pP¨£
, 
zSql
, &
zEºMsg
);

535 
	`as£π
–1==()
pP¨£
->
nQuîyLo›
 );

537 if–
db
->
mÆlocFaûed
 ){

538 
pP¨£
->
rc
 = 
SQLITE4_NOMEM
;

540 if–
pP¨£
->
rc
==
SQLITE4_DONE
 )ÖP¨£->r¯
SQLITE4_OK
;

541 if–
pP¨£
->
checkSchema
 ){

542 
	`schemaIsVÆid
(
pP¨£
);

544 if–
db
->
mÆlocFaûed
 ){

545 
pP¨£
->
rc
 = 
SQLITE4_NOMEM
;

547 if–
≤U£d
 ){

548 *
≤U£d
 = (
pP¨£
->
zTaû
-
zSql
);

550 
rc
 = 
pP¨£
->rc;

552 #i‚de‡
SQLITE4_OMIT_EXPLAIN


553 if–
rc
==
SQLITE4_OK
 && 
pP¨£
->
pVdbe
 &&ÖP¨£->
ex∂aö
 ){

554 c⁄° * c⁄° 
azCﬁName
[] = {

558 
iFú°
, 
mx
;

559 if–
pP¨£
->
ex∂aö
==2 ){

560 
	`sqlôe4VdbeSëNumCﬁs
(
pP¨£
->
pVdbe
, 4);

561 
iFú°
 = 8;

562 
mx
 = 12;

564 
	`sqlôe4VdbeSëNumCﬁs
(
pP¨£
->
pVdbe
, 8);

565 
iFú°
 = 0;

566 
mx
 = 8;

568 
i
=
iFú°
; i<
mx
; i++){

569 
	`sqlôe4VdbeSëCﬁName
(
pP¨£
->
pVdbe
, 
i
-
iFú°
, 
COLNAME_NAME
,

570 
azCﬁName
[
i
], 
SQLITE4_STATIC
);

576 
Vdbe
 *
pVdbe
 = 
pP¨£
->pVdbe;

577 
	`sqlôe4VdbeSëSql
(
pVdbe
, 
zSql
, ()(
pP¨£
->
zTaû
-zSql));

579 if–
pP¨£
->
pVdbe
 && (
rc
!=
SQLITE4_OK
 || 
db
->
mÆlocFaûed
) ){

580 
	`sqlôe4VdbeFöÆize
(
pP¨£
->
pVdbe
);

581 
	`as£π
(!(*
µStmt
));

583 *
µStmt
 = (
sqlôe4_°mt
*)
pP¨£
->
pVdbe
;

586 if–
zEºMsg
 ){

587 
	`sqlôe4Eº‹
(
db
, 
rc
, "%s", 
zEºMsg
);

588 
	`sqlôe4DbFªe
(
db
, 
zEºMsg
);

590 
	`sqlôe4Eº‹
(
db
, 
rc
, 0);

594  
pP¨£
->
pTriggîPrg
 ){

595 
TriggîPrg
 *
pT
 = 
pP¨£
->
pTriggîPrg
;

596 
pP¨£
->
pTriggîPrg
 = 
pT
->
pNext
;

597 
	`sqlôe4DbFªe
(
db
, 
pT
);

600 
íd_¥ï¨e
:

602 
	`sqlôe4SèckFªe
(
db
, 
pP¨£
);

603 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

604  
rc
;

605 
	}
}

606 
	$sqlôe4LockAndPª∑ª
(

607 
sqlôe4
 *
db
,

608 c⁄° *
zSql
,

609 
nByãs
,

610 
Vdbe
 *
pOld
,

611 
sqlôe4_°mt
 **
µStmt
,

612 *
≤U£d


614 
rc
;

615 
	`as£π
–
µStmt
!=0 );

616 *
µStmt
 = 0;

617 if–
≤U£d
 ){

618 *
≤U£d
 = 0;

620 if–!
	`sqlôe4Sa„tyCheckOk
(
db
) ){

621  
SQLITE4_MISUSE_BKPT
;

623 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

624 
rc
 = 
	`sqlôe4Pª∑ª
(
db
, 
zSql
, 
nByãs
, 
pOld
, 
µStmt
, 
≤U£d
);

625 if–
rc
==
SQLITE4_SCHEMA
 ){

626 
	`sqlôe4_föÆize
(*
µStmt
);

627 
rc
 = 
	`sqlôe4Pª∑ª
(
db
, 
zSql
, 
nByãs
, 
pOld
, 
µStmt
, 
≤U£d
);

629 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

630  
rc
;

631 
	}
}

641 
	$sqlôe4Rïª∑ª
(
Vdbe
 *
p
){

642 
rc
;

643 
sqlôe4_°mt
 *
pNew
;

644 c⁄° *
zSql
;

645 
sqlôe4
 *
db
;

647 
	`as£π
–
	`sqlôe4_muãx_hñd
(
	`sqlôe4VdbeDb
(
p
)->
muãx
) );

648 
zSql
 = 
	`sqlôe4_°mt_sql
((
sqlôe4_°mt
 *)
p
);

649 
db
 = 
	`sqlôe4VdbeDb
(
p
);

650 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

651 
rc
 = 
	`sqlôe4LockAndPª∑ª
(
db
, 
zSql
, -1, 
p
, &
pNew
, 0);

652 if–
rc
 ){

653 if–
rc
==
SQLITE4_NOMEM
 ){

654 
db
->
mÆlocFaûed
 = 1;

656 
	`as£π
–
pNew
==0 );

657  
rc
;

659 
	`as£π
–
pNew
!=0 );

661 
	`sqlôe4VdbeSw≠
((
Vdbe
*)
pNew
, 
p
);

662 
	`sqlôe4Tøns„rBödögs
(
pNew
, (
sqlôe4_°mt
*)
p
);

663 
	`sqlôe4VdbeRe£tSãpResu…
((
Vdbe
*)
pNew
);

664 
	`sqlôe4VdbeFöÆize
((
Vdbe
*)
pNew
);

665  
SQLITE4_OK
;

666 
	}
}

677 
	$sqlôe4_¥ï¨e
(

678 
sqlôe4
 *
db
,

679 c⁄° *
zSql
,

680 
nByãs
,

681 
sqlôe4_°mt
 **
µStmt
,

682 *
≤U£d


684 
rc
;

685 
rc
 = 
	`sqlôe4LockAndPª∑ª
(
db
, 
zSql
, 
nByãs
, 0, 
µStmt
, 
≤U£d
);

686 
	`as£π
–
rc
==
SQLITE4_OK
 || 
µStmt
==0 || *ppStmt==0 );

687  
rc
;

688 
	}
}

	@src/printf.c

15 
	~"sqlôeI¡.h
"

21 
	#ëRADIX
 1

	)

22 
	#ëFLOAT
 2

	)

23 
	#ëEXP
 3

	)

24 
	#ëGENERIC
 4

	)

25 
	#ëSIZE
 5

	)

26 
	#ëSTRING
 6

	)

27 
	#ëDYNSTRING
 7

	)

28 
	#ëPERCENT
 8

	)

29 
	#ëCHARX
 9

	)

31 
	#ëSQLESCAPE
 10

	)

32 
	#ëSQLESCAPE2
 11

	)

34 
	#ëTOKEN
 12

	)

35 
	#ëSRCLIST
 13

	)

36 
	#ëPOINTER
 14

	)

37 
	#ëSQLESCAPE3
 15

	)

38 
	#ëORDINAL
 16

	)

40 
	#ëINVALID
 0

	)

46 
	tëByã
;

52 
	së_öfo
 {

53 
	mfmây≥
;

54 
ëByã
 
	mba£
;

55 
ëByã
 
	mÊags
;

56 
ëByã
 
	mty≥
;

57 
ëByã
 
	mch¨£t
;

58 
ëByã
 
	m¥efix
;

59 } 
	të_öfo
;

64 
	#FLAG_SIGNED
 1

	)

65 
	#FLAG_INTERN
 2

	)

66 
	#FLAG_STRING
 4

	)

73 c⁄° 
	gaDigôs
[] = "0123456789abcdef0123456789ABCDEF";

74 c⁄° 
	gaPªfix
[] = "-x0\000X0";

75 c⁄° 
ë_öfo
 
	gfmtöfo
[] = {

76 { 'd', 10, 1, 
ëRADIX
, 0, 0 },

77 { 's', 0, 4, 
ëSTRING
, 0, 0 },

78 { 'g', 0, 1, 
ëGENERIC
, 14, 0 },

79 { 'z', 0, 4, 
ëDYNSTRING
, 0, 0 },

80 { 'q', 0, 4, 
ëSQLESCAPE
, 0, 0 },

81 { 'Q', 0, 4, 
ëSQLESCAPE2
, 0, 0 },

82 { 'w', 0, 4, 
ëSQLESCAPE3
, 0, 0 },

83 { 'c', 0, 0, 
ëCHARX
, 0, 0 },

84 { 'o', 8, 0, 
ëRADIX
, 0, 2 },

85 { 'u', 10, 0, 
ëRADIX
, 0, 0 },

86 { 'x', 16, 0, 
ëRADIX
, 0, 1 },

87 { 'X', 16, 0, 
ëRADIX
, 16, 4 },

88 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


89 { 'f', 0, 1, 
ëFLOAT
, 0, 0 },

90 { 'e', 0, 1, 
ëEXP
, 14, 0 },

91 { 'E', 0, 1, 
ëEXP
, 30, 0 },

92 { 'G', 0, 1, 
ëGENERIC
, 30, 0 },

94 { 'i', 10, 1, 
ëRADIX
, 0, 0 },

95 { 'n', 0, 0, 
ëSIZE
, 0, 0 },

96 { '%', 0, 0, 
ëPERCENT
, 0, 0 },

97 { 'p', 16, 0, 
ëPOINTER
, 0, 1 },

101 { 'T', 0, 2, 
ëTOKEN
, 0, 0 },

102 { 'S', 0, 2, 
ëSRCLIST
, 0, 0 },

103 { 'r', 10, 3, 
ëORDINAL
, 0, 0 },

110 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


124 
	$ë_gëdigô
(
LONGDOUBLE_TYPE
 *
vÆ
, *
˙t
){

125 
digô
;

126 
LONGDOUBLE_TYPE
 
d
;

127 if–(*
˙t
)++ >= 16 )  '0';

128 
digô
 = ()*
vÆ
;

129 
d
 = 
digô
;

130 
digô
 += '0';

131 *
vÆ
 = (*vÆ - 
d
)*10.0;

132  ()
digô
;

133 
	}
}

139 
	$sqlôe4AµídS∑˚
(
SåAccum
 *
pAccum
, 
N
){

140 c⁄° 
zS∑˚s
[] = " ";

141  
N
>=()(
zS∑˚s
)-1 ){

142 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
zS∑˚s
, (zSpaces)-1);

143 
N
 -(
zS∑˚s
)-1;

145 if–
N
>0 ){

146 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
zS∑˚s
, 
N
);

148 
	}
}

154 #i‚de‡
SQLITE4_PRINT_BUF_SIZE


155 
	#SQLITE4_PRINT_BUF_SIZE
 70

	)

157 
	#ëBUFSIZE
 
SQLITE4_PRINT_BUF_SIZE


	)

162 
	$sqlôe4VXPrötf
(

163 
SåAccum
 *
pAccum
,

164 
u£Exãnded
,

165 c⁄° *
fmt
,

166 
va_li°
 
≠


168 
c
;

169 *
buÂt
;

170 
¥ecisi⁄
;

171 
Àngth
;

172 
idx
;

173 
width
;

174 
ëByã
 
Êag_À·ju°ify
;

175 
ëByã
 
Êag_∂ussign
;

176 
ëByã
 
Êag_bœnksign
;

177 
ëByã
 
Êag_Æã∫©ef‹m
;

178 
ëByã
 
Êag_Ætf‹m2
;

179 
ëByã
 
Êag_zî›ad
;

180 
ëByã
 
Êag_l⁄g
;

181 
ëByã
 
Êag_l⁄gl⁄g
;

182 
ëByã
 
d⁄e
;

183 
ëByã
 
xty≥
 = 0;

184 
¥efix
;

185 
sqlôe4_uöt64
 
l⁄gvÆue
;

186 
LONGDOUBLE_TYPE
 
ªÆvÆue
;

187 c⁄° 
ë_öfo
 *
öf›
;

188 *
zOut
;

189 
nOut
;

190 *
zExåa
;

191 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


192 
exp
, 
e2
;

193 
nsd
;

194 
roundî
;

195 
ëByã
 
Êag_dp
;

196 
ëByã
 
Êag_πz
;

198 
buf
[
ëBUFSIZE
];

200 
buÂt
 = 0;

201 ; (
c
=(*
fmt
))!=0; ++fmt){

202 if–
c
!='%' ){

203 
amt
;

204 
buÂt
 = (*)
fmt
;

205 
amt
 = 1;

206  (
c
=(*++
fmt
))!='%' && c!=0 ) 
amt
++;

207 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
buÂt
, 
amt
);

208 if–
c
==0 ) ;

210 if–(
c
=(*++
fmt
))==0 ){

211 
	`sqlôe4SåAccumAµíd
(
pAccum
, "%", 1);

215 
Êag_À·ju°ify
 = 
Êag_∂ussign
 = 
Êag_bœnksign
 =

216 
Êag_Æã∫©ef‹m
 = 
Êag_Ætf‹m2
 = 
Êag_zî›ad
 = 0;

217 
d⁄e
 = 0;

219  
c
 ){

220 '-': 
Êag_À·ju°ify
 = 1; ;

221 '+': 
Êag_∂ussign
 = 1; ;

222 ' ': 
Êag_bœnksign
 = 1; ;

223 '#': 
Êag_Æã∫©ef‹m
 = 1; ;

224 '!': 
Êag_Ætf‹m2
 = 1; ;

225 '0': 
Êag_zî›ad
 = 1; ;

226 : 
d⁄e
 = 1; ;

228 } !
d⁄e
 && (
c
=(*++
fmt
))!=0 );

230 
width
 = 0;

231 if–
c
=='*' ){

232 
width
 = 
	`va_¨g
(
≠
,);

233 if–
width
<0 ){

234 
Êag_À·ju°ify
 = 1;

235 
width
 = -width;

237 
c
 = *++
fmt
;

239  
c
>='0' && c<='9' ){

240 
width
 = width*10 + 
c
 - '0';

241 
c
 = *++
fmt
;

245 if–
c
=='.' ){

246 
¥ecisi⁄
 = 0;

247 
c
 = *++
fmt
;

248 if–
c
=='*' ){

249 
¥ecisi⁄
 = 
	`va_¨g
(
≠
,);

250 if–
¥ecisi⁄
<0 )Örecision = -precision;

251 
c
 = *++
fmt
;

253  
c
>='0' && c<='9' ){

254 
¥ecisi⁄
 =Öªcisi⁄*10 + 
c
 - '0';

255 
c
 = *++
fmt
;

259 
¥ecisi⁄
 = -1;

262 if–
c
=='l' ){

263 
Êag_l⁄g
 = 1;

264 
c
 = *++
fmt
;

265 if–
c
=='l' ){

266 
Êag_l⁄gl⁄g
 = 1;

267 
c
 = *++
fmt
;

269 
Êag_l⁄gl⁄g
 = 0;

272 
Êag_l⁄g
 = 
Êag_l⁄gl⁄g
 = 0;

275 
öf›
 = &
fmtöfo
[0];

276 
xty≥
 = 
ëINVALID
;

277 
idx
=0; idx<
	`AºaySize
(
fmtöfo
); idx++){

278 if–
c
==
fmtöfo
[
idx
].
fmây≥
 ){

279 
öf›
 = &
fmtöfo
[
idx
];

280 if–
u£Exãnded
 || (
öf›
->
Êags
 & 
FLAG_INTERN
)==0 ){

281 
xty≥
 = 
öf›
->
ty≥
;

288 
zExåa
 = 0;

311  
xty≥
 ){

312 
ëPOINTER
:

313 
Êag_l⁄gl⁄g
 = (*)==(
i64
);

314 
Êag_l⁄g
 = (*)==();

316 
ëORDINAL
:

317 
ëRADIX
:

318 if–
öf›
->
Êags
 & 
FLAG_SIGNED
 ){

319 
i64
 
v
;

320 if–
Êag_l⁄gl⁄g
 ){

321 
v
 = 
	`va_¨g
(
≠
,
i64
);

322 }if–
Êag_l⁄g
 ){

323 
v
 = 
	`va_¨g
(
≠
,);

325 
v
 = 
	`va_¨g
(
≠
,);

327 if–
v
<0 ){

328 if–
v
==
SMALLEST_INT64
 ){

329 
l⁄gvÆue
 = ((
u64
)1)<<63;

331 
l⁄gvÆue
 = -
v
;

333 
¥efix
 = '-';

335 
l⁄gvÆue
 = 
v
;

336 if–
Êag_∂ussign
 ) 
¥efix
 = '+';

337 if–
Êag_bœnksign
 ) 
¥efix
 = ' ';

338 
¥efix
 = 0;

341 if–
Êag_l⁄gl⁄g
 ){

342 
l⁄gvÆue
 = 
	`va_¨g
(
≠
,
u64
);

343 }if–
Êag_l⁄g
 ){

344 
l⁄gvÆue
 = 
	`va_¨g
(
≠
,);

346 
l⁄gvÆue
 = 
	`va_¨g
(
≠
,);

348 
¥efix
 = 0;

350 if–
l⁄gvÆue
==0 ) 
Êag_Æã∫©ef‹m
 = 0;

351 if–
Êag_zî›ad
 && 
¥ecisi⁄
<
width
-(
¥efix
!=0) ){

352 
¥ecisi⁄
 = 
width
-(
¥efix
!=0);

354 if–
¥ecisi⁄
<
ëBUFSIZE
-10 ){

355 
nOut
 = 
ëBUFSIZE
;

356 
zOut
 = 
buf
;

358 
nOut
 = 
¥ecisi⁄
 + 10;

359 
zOut
 = 
zExåa
 = 
	`sqlôe4MÆloc
(
pAccum
->
pEnv
, 
nOut
);

360 if–
zOut
==0 ){

361 
pAccum
->
mÆlocFaûed
 = 1;

365 
buÂt
 = &
zOut
[
nOut
-1];

366 if–
xty≥
==
ëORDINAL
 ){

367 c⁄° 
zOrd
[] = "thstndrd";

368 
x
 = ()(
l⁄gvÆue
 % 10);

369 if–
x
>=4 || (
l⁄gvÆue
/10)%10==1 ){

370 
x
 = 0;

372 *(--
buÂt
Ë
zOrd
[
x
*2+1];

373 *(--
buÂt
Ë
zOrd
[
x
*2];

376 c⁄° *
c£t
;

377 
ba£
;

378 
c£t
 = &
aDigôs
[
öf›
->
ch¨£t
];

379 
ba£
 = 
öf›
->base;

381 *(--
buÂt
Ë
c£t
[
l⁄gvÆue
%
ba£
];

382 
l⁄gvÆue
 =Ü⁄gvÆue/
ba£
;

383 } 
l⁄gvÆue
>0 );

385 
Àngth
 = ()(&
zOut
[
nOut
-1]-
buÂt
);

386 
idx
=
¥ecisi⁄
-
Àngth
; idx>0; idx--){

387 *(--
buÂt
) = '0';

389 if–
¥efix
 ) *(--
buÂt
) =Örefix;

390 if–
Êag_Æã∫©ef‹m
 && 
öf›
->
¥efix
 ){

391 c⁄° *
¥e
;

392 
x
;

393 
¥e
 = &
aPªfix
[
öf›
->
¥efix
];

394 ; (
x
=(*
¥e
))!=0;Öª++Ë*(--
buÂt
) = x;

396 
Àngth
 = ()(&
zOut
[
nOut
-1]-
buÂt
);

398 
ëFLOAT
:

399 
ëEXP
:

400 
ëGENERIC
:

401 
ªÆvÆue
 = 
	`va_¨g
(
≠
,);

402 #ifde‡
SQLITE4_OMIT_FLOATING_POINT


403 
Àngth
 = 0;

405 if–
¥ecisi⁄
<0 )Örecision = 6;

406 if–
ªÆvÆue
<0.0 ){

407 
ªÆvÆue
 = -realvalue;

408 
¥efix
 = '-';

410 if–
Êag_∂ussign
 ) 
¥efix
 = '+';

411 if–
Êag_bœnksign
 ) 
¥efix
 = ' ';

412 
¥efix
 = 0;

414 if–
xty≥
==
ëGENERIC
 && 
¥ecisi⁄
>0 )Örecision--;

417 
idx
=
¥ecisi⁄
, 
roundî
=0.4999; idx>0; idx--,Ñounder*=0.1);

420 
idx
=
¥ecisi⁄
, 
roundî
=0.5; idx>0; idx--,Ñounder*=0.1){}

422 if–
xty≥
==
ëFLOAT
 ) 
ªÆvÆue
 +
roundî
;

424 
exp
 = 0;

425 if–
	`sqlôe4IsNaN
(()
ªÆvÆue
) ){

426 
buÂt
 = "NaN";

427 
Àngth
 = 3;

430 if–
ªÆvÆue
>0.0 ){

431  
ªÆvÆue
>=1e32 && 
exp
<=350 ){Ñealvalue *= 1e-32;Éxp+=32; }

432  
ªÆvÆue
>=1e8 && 
exp
<=350 ){Ñealvalue *= 1e-8;Éxp+=8; }

433  
ªÆvÆue
>=10.0 && 
exp
<=350 ){Ñealvalue *= 0.1;Éxp++; }

434  
ªÆvÆue
<1e-8 ){ÑólvÆuê*1e8; 
exp
-=8; }

435  
ªÆvÆue
<1.0 ){ÑólvÆuê*10.0; 
exp
--; }

436 if–
exp
>350 ){

437 if–
¥efix
=='-' ){

438 
buÂt
 = "-Inf";

439 }if–
¥efix
=='+' ){

440 
buÂt
 = "+Inf";

442 
buÂt
 = "Inf";

444 
Àngth
 = 
	`sqlôe4SåÀn30
(
buÂt
);

448 
buÂt
 = 
buf
;

453 if–
xty≥
!=
ëFLOAT
 ){

454 
ªÆvÆue
 +
roundî
;

455 if–
ªÆvÆue
>=10.0 ){ÑólvÆuê*0.1; 
exp
++; }

457 if–
xty≥
==
ëGENERIC
 ){

458 
Êag_πz
 = !
Êag_Æã∫©ef‹m
;

459 if–
exp
<-4 ||Éxp>
¥ecisi⁄
 ){

460 
xty≥
 = 
ëEXP
;

462 
¥ecisi⁄
 =Öªcisi⁄ - 
exp
;

463 
xty≥
 = 
ëFLOAT
;

466 
Êag_πz
 = 0;

468 if–
xty≥
==
ëEXP
 ){

469 
e2
 = 0;

471 
e2
 = 
exp
;

473 if–
e2
+
¥ecisi⁄
+
width
 > 
ëBUFSIZE
 - 15 ){

474 
buÂt
 = 
zExåa
 = 
	`sqlôe4MÆloc
(
pAccum
->
pEnv
, 
e2
+
¥ecisi⁄
+
width
+15 );

475 if–
buÂt
==0 ){

476 
pAccum
->
mÆlocFaûed
 = 1;

480 
zOut
 = 
buÂt
;

481 
nsd
 = 0;

482 
Êag_dp
 = (
¥ecisi⁄
>0 ?1:0Ë| 
Êag_Æã∫©ef‹m
 | 
Êag_Ætf‹m2
;

484 if–
¥efix
 ){

485 *(
buÂt
++Ë
¥efix
;

488 if–
e2
<0 ){

489 *(
buÂt
++) = '0';

491 ; 
e2
>=0;É2--){

492 *(
buÂt
++Ë
	`ë_gëdigô
(&
ªÆvÆue
,&
nsd
);

496 if–
Êag_dp
 ){

497 *(
buÂt
++) = '.';

501 
e2
++;É2<0; 
¥ecisi⁄
--,É2++){

502 
	`as£π
–
¥ecisi⁄
>0 );

503 *(
buÂt
++) = '0';

506  (
¥ecisi⁄
--)>0 ){

507 *(
buÂt
++Ë
	`ë_gëdigô
(&
ªÆvÆue
,&
nsd
);

510 if–
Êag_πz
 && 
Êag_dp
 ){

511  
buÂt
[-1]=='0' ) *(--bufpt) = 0;

512 
	`as£π
–
buÂt
>
zOut
 );

513 if–
buÂt
[-1]=='.' ){

514 if–
Êag_Ætf‹m2
 ){

515 *(
buÂt
++) = '0';

517 *(--
buÂt
) = 0;

522 if–
xty≥
==
ëEXP
 ){

523 *(
buÂt
++Ë
aDigôs
[
öf›
->
ch¨£t
];

524 if–
exp
<0 ){

525 *(
buÂt
++Ë'-'; 
exp
 = -exp;

527 *(
buÂt
++) = '+';

529 if–
exp
>=100 ){

530 *(
buÂt
++Ë()((
exp
/100)+'0');

531 
exp
 %= 100;

533 *(
buÂt
++Ë()(
exp
/10+'0');

534 *(
buÂt
++Ë()(
exp
%10+'0');

536 *
buÂt
 = 0;

541 
Àngth
 = ()(
buÂt
-
zOut
);

542 
buÂt
 = 
zOut
;

546 if–
Êag_zî›ad
 && !
Êag_À·ju°ify
 && 
Àngth
 < 
width
){

547 
i
;

548 
nPad
 = 
width
 - 
Àngth
;

549 
i
=
width
; i>=
nPad
; i--){

550 
buÂt
[
i
] = buÂt[i-
nPad
];

552 
i
 = 
¥efix
!=0;

553  
nPad
-- ) 
buÂt
[
i
++] = '0';

554 
Àngth
 = 
width
;

558 
ëSIZE
:

559 *(
	`va_¨g
(
≠
,*)Ë
pAccum
->
nCh¨
;

560 
Àngth
 = 
width
 = 0;

562 
ëPERCENT
:

563 
buf
[0] = '%';

564 
buÂt
 = 
buf
;

565 
Àngth
 = 1;

567 
ëCHARX
:

568 
c
 = 
	`va_¨g
(
≠
,);

569 
buf
[0] = ()
c
;

570 if–
¥ecisi⁄
>=0 ){

571 
idx
=1; idx<
¥ecisi⁄
; idx++Ë
buf
[idx] = ()
c
;

572 
Àngth
 = 
¥ecisi⁄
;

574 
Àngth
 =1;

576 
buÂt
 = 
buf
;

578 
ëSTRING
:

579 
ëDYNSTRING
:

580 
buÂt
 = 
	`va_¨g
(
≠
,*);

581 if–
buÂt
==0 ){

582 
buÂt
 = "";

583 }if–
xty≥
==
ëDYNSTRING
 ){

584 
zExåa
 = 
buÂt
;

586 if–
¥ecisi⁄
>=0 ){

587 
Àngth
=0;Üígth<
¥ecisi⁄
 && 
buÂt
[length];Üength++){}

589 
Àngth
 = 
	`sqlôe4SåÀn30
(
buÂt
);

592 
ëSQLESCAPE
:

593 
ëSQLESCAPE2
:

594 
ëSQLESCAPE3
: {

595 
i
, 
j
, 
k
, 
n
, 
i¢uŒ
;

596 
√edQuŸe
;

597 
ch
;

598 
q
 = ((
xty≥
==
ëSQLESCAPE3
)?'"':'\'');

599 *
esˇrg
 = 
	`va_¨g
(
≠
,*);

600 
i¢uŒ
 = 
esˇrg
==0;

601 if–
i¢uŒ
 ) 
esˇrg
 = (
xty≥
==
ëSQLESCAPE2
 ? "NULL" : "(NULL)");

602 
k
 = 
¥ecisi⁄
;

603 
i
=
n
=0; 
k
!=0 && (
ch
=
esˇrg
[i])!=0; i++, k--){

604 if–
ch
==
q
 ) 
n
++;

606 
√edQuŸe
 = !
i¢uŒ
 && 
xty≥
==
ëSQLESCAPE2
;

607 
n
 +
i
 + 1 + 
√edQuŸe
*2;

608 if–
n
>
ëBUFSIZE
 ){

609 
buÂt
 = 
zExåa
 = 
	`sqlôe4MÆloc
(
pAccum
->
pEnv
, 
n
);

610 if–
buÂt
==0 ){

611 
pAccum
->
mÆlocFaûed
 = 1;

615 
buÂt
 = 
buf
;

617 
j
 = 0;

618 if–
√edQuŸe
 ) 
buÂt
[
j
++] = 
q
;

619 
k
 = 
i
;

620 
i
=0; i<
k
; i++){

621 
buÂt
[
j
++] = 
ch
 = 
esˇrg
[
i
];

622 if–
ch
==
q
 ) 
buÂt
[
j
++] = ch;

624 if–
√edQuŸe
 ) 
buÂt
[
j
++] = 
q
;

625 
buÂt
[
j
] = 0;

626 
Àngth
 = 
j
;

632 
ëTOKEN
: {

633 
Tokí
 *
pTokí
 = 
	`va_¨g
(
≠
, Token*);

634 if–
pTokí
 ){

635 
	`sqlôe4SåAccumAµíd
(
pAccum
, (c⁄° *)
pTokí
->
z
,ÖTokí->
n
);

637 
Àngth
 = 
width
 = 0;

640 
ëSRCLIST
: {

641 
SrcLi°
 *
pSrc
 = 
	`va_¨g
(
≠
, SrcList*);

642 
k
 = 
	`va_¨g
(
≠
, );

643 
SrcLi°Iãm
 *
pIãm
 = &
pSrc
->
a
[
k
];

644 
	`as£π
–
k
>=0 && k<
pSrc
->
nSrc
 );

645 if–
pIãm
->
zD©aba£
 ){

646 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
pIãm
->
zD©aba£
, -1);

647 
	`sqlôe4SåAccumAµíd
(
pAccum
, ".", 1);

649 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
pIãm
->
zName
, -1);

650 
Àngth
 = 
width
 = 0;

654 
	`as£π
–
xty≥
==
ëINVALID
 );

663 if–!
Êag_À·ju°ify
 ){

664 
n•a˚
;

665 
n•a˚
 = 
width
-
Àngth
;

666 if–
n•a˚
>0 ){

667 
	`sqlôe4AµídS∑˚
(
pAccum
, 
n•a˚
);

670 if–
Àngth
>0 ){

671 
	`sqlôe4SåAccumAµíd
(
pAccum
, 
buÂt
, 
Àngth
);

673 if–
Êag_À·ju°ify
 ){

674 
n•a˚
;

675 
n•a˚
 = 
width
-
Àngth
;

676 if–
n•a˚
>0 ){

677 
	`sqlôe4AµídS∑˚
(
pAccum
, 
n•a˚
);

680 
	`sqlôe4_‰ì
(
pAccum
->
pEnv
, 
zExåa
);

682 
	}
}

687 
	$sqlôe4SåAccumAµíd
(
SåAccum
 *
p
, c⁄° *
z
, 
N
){

688 
	`as£π
–
z
!=0 || 
N
==0 );

689 if–
p
->
tooBig
 |Ö->
mÆlocFaûed
 ){

690 
	`ã°ˇ£
(
p
->
tooBig
);

691 
	`ã°ˇ£
(
p
->
mÆlocFaûed
);

694 
	`as£π
–
p
->
zText
!=0 ||Ö->
nCh¨
==0 );

695 if–
N
<0 ){

696 
N
 = 
	`sqlôe4SåÀn30
(
z
);

698 if–
N
==0 || 
	`NEVER
(
z
==0) ){

701 if–
p
->
nCh¨
+
N
 >p->
nAŒoc
 ){

702 *
zNew
;

703 if–!
p
->
u£MÆloc
 ){

704 
p
->
tooBig
 = 1;

705 
N
 = 
p
->
nAŒoc
 -Ö->
nCh¨
 - 1;

706 if–
N
<=0 ){

710 *
zOld
 = (
p
->
zText
=ı->
zBa£
 ? 0 :Ö->zText);

711 
i64
 
szNew
 = 
p
->
nCh¨
;

712 
szNew
 +
N
 + 1;

713 if–
szNew
 > 
p
->
mxAŒoc
 ){

714 
	`sqlôe4SåAccumRe£t
(
p
);

715 
p
->
tooBig
 = 1;

718 
p
->
nAŒoc
 = ()
szNew
;

720 if–
p
->
u£MÆloc
==1 ){

721 
zNew
 = 
	`sqlôe4DbRóŒoc
(
p
->
db
, 
zOld
,Ö->
nAŒoc
);

723 
zNew
 = 
	`sqlôe4_ªÆloc
(
p
->
pEnv
, 
zOld
,Ö->
nAŒoc
);

725 if–
zNew
 ){

726 if–
zOld
==0 && 
p
->
nCh¨
>0 ) 
	`mem˝y
(
zNew
,Ö->
zText
,Ö->nChar);

727 
p
->
zText
 = 
zNew
;

729 
p
->
mÆlocFaûed
 = 1;

730 
	`sqlôe4SåAccumRe£t
(
p
);

735 
	`as£π
–
p
->
zText
 );

736 
	`mem˝y
(&
p
->
zText
[p->
nCh¨
], 
z
, 
N
);

737 
p
->
nCh¨
 +
N
;

738 
	}
}

745 *
	$sqlôe4SåAccumFöish
(
SåAccum
 *
p
){

746 if–
p
->
zText
 ){

747 
p
->
zText
[p->
nCh¨
] = 0;

748 if–
p
->
u£MÆloc
 &&Ö->
zText
=ı->
zBa£
 ){

749 if–
p
->
u£MÆloc
==1 ){

750 
p
->
zText
 = 
	`sqlôe4DbMÆlocRaw
’->
db
,Ö->
nCh¨
+1 );

752 
p
->
zText
 = 
	`sqlôe4_mÆloc
’->
pEnv
,Ö->
nCh¨
+1);

754 if–
p
->
zText
 ){

755 
	`mem˝y
(
p
->
zText
,Ö->
zBa£
,Ö->
nCh¨
+1);

757 
p
->
mÆlocFaûed
 = 1;

761  
p
->
zText
;

762 
	}
}

767 
	$sqlôe4SåAccumRe£t
(
SåAccum
 *
p
){

768 if–
p
->
zText
!ı->
zBa£
 ){

769 if–
p
->
u£MÆloc
==1 ){

770 
	`sqlôe4DbFªe
(
p
->
db
,Ö->
zText
);

772 
	`sqlôe4_‰ì
(
p
->
pEnv
,Ö->
zText
);

775 
p
->
zText
 = 0;

776 
	}
}

781 
	$sqlôe4SåAccumInô
(
SåAccum
 *
p
, *
zBa£
, 
n
, 
mx
){

782 
p
->
zText
 =Ö->
zBa£
 = zBase;

783 
p
->
db
 = 0;

784 
p
->
pEnv
 = 0;

785 
p
->
nCh¨
 = 0;

786 
p
->
nAŒoc
 = 
n
;

787 
p
->
mxAŒoc
 = 
mx
;

788 
p
->
u£MÆloc
 = 1;

789 
p
->
tooBig
 = 0;

790 
p
->
mÆlocFaûed
 = 0;

791 
	}
}

797 *
	$sqlôe4VMPrötf
(
sqlôe4
 *
db
, c⁄° *
zF‹m©
, 
va_li°
 
≠
){

798 *
z
;

799 
zBa£
[
SQLITE4_PRINT_BUF_SIZE
];

800 
SåAccum
 
acc
;

801 
	`as£π
–
db
!=0 );

802 
	`sqlôe4SåAccumInô
(&
acc
, 
zBa£
, (zBase),

803 
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
]);

804 
acc
.
db
 = db;

805 
	`sqlôe4VXPrötf
(&
acc
, 1, 
zF‹m©
, 
≠
);

806 
z
 = 
	`sqlôe4SåAccumFöish
(&
acc
);

807 if–
acc
.
mÆlocFaûed
 ){

808 
db
->
mÆlocFaûed
 = 1;

810  
z
;

811 
	}
}

817 *
	$sqlôe4MPrötf
(
sqlôe4
 *
db
, c⁄° *
zF‹m©
, ...){

818 
va_li°
 
≠
;

819 *
z
;

820 
	`va_°¨t
(
≠
, 
zF‹m©
);

821 
z
 = 
	`sqlôe4VMPrötf
(
db
, 
zF‹m©
, 
≠
);

822 
	`va_íd
(
≠
);

823  
z
;

824 
	}
}

834 *
	$sqlôe4MAµídf
(
sqlôe4
 *
db
, *
zSå
, c⁄° *
zF‹m©
, ...){

835 
va_li°
 
≠
;

836 *
z
;

837 
	`va_°¨t
(
≠
, 
zF‹m©
);

838 
z
 = 
	`sqlôe4VMPrötf
(
db
, 
zF‹m©
, 
≠
);

839 
	`va_íd
(
≠
);

840 
	`sqlôe4DbFªe
(
db
, 
zSå
);

841  
z
;

842 
	}
}

848 *
	$sqlôe4_vm¥ötf
(
sqlôe4_ív
 *
pEnv
, c⁄° *
zF‹m©
, 
va_li°
 
≠
){

849 *
z
;

850 
zBa£
[
SQLITE4_PRINT_BUF_SIZE
];

851 
SåAccum
 
acc
;

852 #i‚de‡
SQLITE4_OMIT_AUTOINIT


853 if–
	`sqlôe4_öôülize
(
pEnv
) )  0;

855 
	`sqlôe4SåAccumInô
(&
acc
, 
zBa£
, (zBa£), 
SQLITE4_MAX_LENGTH
);

856 
acc
.
u£MÆloc
 = 2;

857 
acc
.
pEnv
 =ÖEnv;

858 
	`sqlôe4VXPrötf
(&
acc
, 0, 
zF‹m©
, 
≠
);

859 
z
 = 
	`sqlôe4SåAccumFöish
(&
acc
);

860  
z
;

861 
	}
}

867 *
	$sqlôe4_m¥ötf
(
sqlôe4_ív
 *
pEnv
, c⁄° *
zF‹m©
, ...){

868 
va_li°
 
≠
;

869 *
z
;

870 #i‚de‡
SQLITE4_OMIT_AUTOINIT


871 if–
	`sqlôe4_öôülize
(
pEnv
) )  0;

873 
	`va_°¨t
(
≠
, 
zF‹m©
);

874 
z
 = 
	`sqlôe4_vm¥ötf
(
pEnv
, 
zF‹m©
, 
≠
);

875 
	`va_íd
(
≠
);

876  
z
;

877 
	}
}

892 
sqlôe4_size_t
 
	$sqlôe4_v¢¥ötf
(

893 *
zBuf
,

894 
sqlôe4_size_t
 
n
,

895 c⁄° *
zF‹m©
,

896 
va_li°
 
≠


898 
SåAccum
 
acc
;

899 if–
n
<=0 )  0;

900 
	`sqlôe4SåAccumInô
(&
acc
, 
zBuf
, 
n
, 0);

901 
acc
.
u£MÆloc
 = 0;

902 
	`sqlôe4VXPrötf
(&
acc
, 0, 
zF‹m©
, 
≠
);

903 
	`sqlôe4SåAccumFöish
(&
acc
);

904  
acc
.
nCh¨
;

905 
	}
}

906 
sqlôe4_size_t
 
	$sqlôe4_¢¥ötf
(

907 *
zBuf
,

908 
sqlôe4_size_t
 
n
,

909 c⁄° *
zF‹m©
,

912 
va_li°
 
≠
;

913 
	`va_°¨t
(
≠
,
zF‹m©
);

914 
n
 = 
	`sqlôe4_v¢¥ötf
(
zBuf
,Ç, 
zF‹m©
, 
≠
);

915 
	`va_íd
(
≠
);

916  
n
;

917 
	}
}

928 
	$ªndîLogMsg
(

929 
sqlôe4_ív
 *
pEnv
,

930 
iEºCode
,

931 c⁄° *
zF‹m©
,

932 
va_li°
 
≠


934 
SåAccum
 
acc
;

935 
zMsg
[
SQLITE4_PRINT_BUF_SIZE
*3];

937 
	`sqlôe4SåAccumInô
(&
acc
, 
zMsg
, (zMsg), 0);

938 
acc
.
u£MÆloc
 = 0;

939 
	`sqlôe4VXPrötf
(&
acc
, 0, 
zF‹m©
, 
≠
);

940 
pEnv
->
	`xLog
’Env->
pLogArg
, 
iEºCode
, 
	`sqlôe4SåAccumFöish
(&
acc
));

941 
	}
}

946 
	$sqlôe4_log
(
sqlôe4_ív
 *
pEnv
, 
iEºCode
, c⁄° *
zF‹m©
, ...){

947 
va_li°
 
≠
;

948 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

949 if–
pEnv
->
xLog
 ){

950 
	`va_°¨t
(
≠
, 
zF‹m©
);

951 
	`ªndîLogMsg
(
pEnv
, 
iEºCode
, 
zF‹m©
, 
≠
);

952 
	`va_íd
(
≠
);

954 
	}
}

956 #i‡
deföed
(
SQLITE4_DEBUG
)

962 
	$sqlôe4DebugPrötf
(c⁄° *
zF‹m©
, ...){

963 
va_li°
 
≠
;

964 
SåAccum
 
acc
;

965 
zBuf
[500];

966 
	`sqlôe4SåAccumInô
(&
acc
, 
zBuf
, (zBuf), 0);

967 
acc
.
u£MÆloc
 = 0;

968 
	`va_°¨t
(
≠
,
zF‹m©
);

969 
	`sqlôe4VXPrötf
(&
acc
, 0, 
zF‹m©
, 
≠
);

970 
	`va_íd
(
≠
);

971 
	`sqlôe4SåAccumFöish
(&
acc
);

972 
	`Ârötf
(
°dout
,"%s", 
zBuf
);

973 
	`fÊush
(
°dout
);

974 
	}
}

977 #i‚de‡
SQLITE4_OMIT_TRACE


981 
	$sqlôe4XPrötf
(
SåAccum
 *
p
, c⁄° *
zF‹m©
, ...){

982 
va_li°
 
≠
;

983 
	`va_°¨t
(
≠
,
zF‹m©
);

984 
	`sqlôe4VXPrötf
(
p
, 1, 
zF‹m©
, 
≠
);

985 
	`va_íd
(
≠
);

986 
	}
}

993 
	$sqlôe4BlobToHex
(
N
, c⁄° 
u8
 *
zIn
, *
zOut
){

994  (
N
--)>0 ){

995 
u8
 
c
 = *(
zIn
++);

996 *(
zOut
++Ë
aDigôs
[
c
>>4];

997 *(
zOut
++Ë
aDigôs
[
c
&0x0f];

999 *
zOut
 = 0;

1000 
	}
}

	@src/random.c

18 
	~"sqlôeI¡.h
"

25 
u8
 
	$øndomByã
(
sqlôe4_ív
 *
pEnv
){

26 
pEnv
->
¥ngX
 = (pEnv->prngX>>1) ^ ((-(pEnv->prngX&1)) & 0xd0000001);

27 
pEnv
->
¥ngY
 =ÖEnv->prngY*1103515245 + 12345;

28  (
u8
)((
pEnv
->
¥ngX
 ^ÖEnv->
¥ngY
)&0xff);

29 
	}
}

34 
	$sqlôe4_øndom√ss
(
sqlôe4_ív
 *
pEnv
, 
N
, *
pBuf
){

35 *
zBuf
 = 
pBuf
;

36 if–
pEnv
==0 )ÖEnv = &
sqlôe4DeÁu…Env
;

37 
	`sqlôe4_muãx_íãr
(
pEnv
->
pP∫gMuãx
);

38  
N
-- ){

39 *(
zBuf
++Ë
	`øndomByã
(
pEnv
);

41 
	`sqlôe4_muãx_Àave
(
pEnv
->
pP∫gMuãx
);

42 
	}
}

	@src/resolve.c

17 
	~"sqlôeI¡.h
"

18 
	~<°dlib.h
>

19 
	~<°rög.h
>

48 
	$ªsﬁveAlüs
(

49 
P¨£
 *
pP¨£
,

50 
Ex¥Li°
 *
pELi°
,

51 
iCﬁ
,

52 
Ex¥
 *
pEx¥
,

53 c⁄° *
zTy≥


55 
Ex¥
 *
pOrig
;

56 
Ex¥
 *
pDup
;

57 
sqlôe4
 *
db
;

59 
	`as£π
–
iCﬁ
>=0 && iCﬁ<
pELi°
->
nEx¥
 );

60 
pOrig
 = 
pELi°
->
a
[
iCﬁ
].
pEx¥
;

61 
	`as£π
–
pOrig
!=0 );

62 
	`as£π
–
pOrig
->
Êags
 & 
EP_Resﬁved
 );

63 
db
 = 
pP¨£
->db;

64 if–
pOrig
->
›
!=
TK_COLUMN
 && 
zTy≥
[0]!='G' ){

65 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pOrig
, 0);

66 
pDup
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_AS
,ÖDup, 0, 0);

67 if–
pDup
==0 ) ;

68 if–
pELi°
->
a
[
iCﬁ
].
iAlüs
==0 ){

69 
pELi°
->
a
[
iCﬁ
].
iAlüs
 = (
u16
)(++
pP¨£
->
nAlüs
);

71 
pDup
->
iTabÀ
 = 
pELi°
->
a
[
iCﬁ
].
iAlüs
;

72 }if–
	`Ex¥HasPr›îty
(
pOrig
, 
EP_I¡VÆue
Ë||ÖOrig->
u
.
zTokí
==0 ){

73 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pOrig
, 0);

74 if–
pDup
==0 ) ;

76 *
zTokí
 = 
pOrig
->
u
.zToken;

77 
	`as£π
–
zTokí
!=0 );

78 
pOrig
->
u
.
zTokí
 = 0;

79 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pOrig
, 0);

80 
pOrig
->
u
.
zTokí
 = zToken;

81 if–
pDup
==0 ) ;

82 
	`as£π
–(
pDup
->
Êags
 & (
EP_Redu˚d
|
EP_TokíO∆y
))==0 );

83 
pDup
->
Êags2
 |
EP2_MÆlo˚dTokí
;

84 
pDup
->
u
.
zTokí
 = 
	`sqlôe4DbSåDup
(
db
, zToken);

86 if–
pEx¥
->
Êags
 & 
EP_ExpCﬁœã
 ){

87 
pDup
->
pCﬁl
 = 
pEx¥
->pColl;

88 
pDup
->
Êags
 |
EP_ExpCﬁœã
;

95 
	`Ex¥SëPr›îty
(
pEx¥
, 
EP_Sètic
);

96 
	`sqlôe4Ex¥Dñëe
(
db
, 
pEx¥
);

97 
	`mem˝y
(
pEx¥
, 
pDup
, (*pExpr));

98 
	`sqlôe4DbFªe
(
db
, 
pDup
);

99 
	}
}

108 
	$«meInUsögCœu£
(
IdLi°
 *
pUsög
, c⁄° *
zCﬁ
){

109 if–
pUsög
 ){

110 
k
;

111 
k
=0; k<
pUsög
->
nId
; k++){

112 if–
	`sqlôe4_°ricmp
(
pUsög
->
a
[
k
].
zName
, 
zCﬁ
)==0 )  1;

116 
	}
}

122 
	$isRowidRe„ªn˚
(
TabÀ
 *
pTab
, c⁄° *
zCﬁ
){

123 
ªt
 = 0;

124 if–0==
	`sqlôe4_°ricmp
(
zCﬁ
, "ROWID") ){

127 
Index
 *
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

128 if–
pPk
 &&ÖPk->
aiCﬁumn
[0]==-1 ) 
ªt
 = 1;

130  
ªt
;

131 
	}
}

160 
	$lookupName
(

161 
P¨£
 *
pP¨£
,

162 c⁄° *
zDb
,

163 c⁄° *
zTab
,

164 c⁄° *
zCﬁ
,

165 
NameC⁄ãxt
 *
pNC
,

166 
Ex¥
 *
pEx¥


168 
i
, 
j
;

169 
˙t
 = 0;

170 
˙tTab
 = 0;

171 
sqlôe4
 *
db
 = 
pP¨£
->db;

172 
SrcLi°Iãm
 *
pIãm
;

173 
SrcLi°Iãm
 *
pM©ch
 = 0;

174 
NameC⁄ãxt
 *
pT›NC
 = 
pNC
;

175 
Schema
 *
pSchema
 = 0;

176 
isTriggî
 = 0;

178 
	`as£π
–
pNC
 );

179 
	`as£π
–
zCﬁ
 );

180 
	`as£π
–~
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

183 
pEx¥
->
iTabÀ
 = -1;

184 
pEx¥
->
pTab
 = 0;

185 
	`Ex¥SëIºeducibÀ
(
pEx¥
);

188  
pNC
 && 
˙t
==0 ){

189 
Ex¥Li°
 *
pELi°
;

190 
SrcLi°
 *
pSrcLi°
 = 
pNC
->pSrcList;

192 if–
pSrcLi°
 ){

193 
i
=0, 
pIãm
=
pSrcLi°
->
a
; i<pSrcLi°->
nSrc
; i++,ÖItem++){

194 
TabÀ
 *
pTab
;

195 
iDb
;

196 
Cﬁumn
 *
pCﬁ
;

198 
pTab
 = 
pIãm
->pTab;

199 
	`as£π
–
pTab
!=0 &&ÖTab->
zName
!=0 );

200 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

201 
	`as£π
–
pTab
->
nCﬁ
>0 );

202 if–
zTab
 ){

203 if–
pIãm
->
zAlüs
 ){

204 *
zTabName
 = 
pIãm
->
zAlüs
;

205 if–
	`sqlôe4_°ricmp
(
zTabName
, 
zTab
)!=0 ) ;

207 *
zTabName
 = 
pTab
->
zName
;

208 if–
	`NEVER
(
zTabName
==0Ë|| 
	`sqlôe4_°ricmp
(zTabName, 
zTab
)!=0 ){

211 if–
zDb
!=0 && 
	`sqlôe4_°ricmp
(
db
->
aDb
[
iDb
].
zName
, zDb)!=0 ){

216 if–0==(
˙tTab
++) ){

217 
pEx¥
->
iTabÀ
 = 
pIãm
->
iCurs‹
;

218 
pEx¥
->
pTab
 =ÖTab;

219 
pSchema
 = 
pTab
->pSchema;

220 
pM©ch
 = 
pIãm
;

222 
j
=0, 
pCﬁ
=
pTab
->
aCﬁ
; j<pTab->
nCﬁ
; j++,ÖCol++){

223 if–
	`sqlôe4_°ricmp
(
pCﬁ
->
zName
, 
zCﬁ
)==0 ){

228 if–
˙t
==1 ){

229 if–
pIãm
->
joöty≥
 & 
JT_NATURAL
 ) ;

230 if–
	`«meInUsögCœu£
(
pIãm
->
pUsög
, 
zCﬁ
) ) ;

232 
˙t
++;

233 
pEx¥
->
iTabÀ
 = 
pIãm
->
iCurs‹
;

234 
pEx¥
->
pTab
 =ÖTab;

235 
pM©ch
 = 
pIãm
;

236 
pSchema
 = 
pTab
->pSchema;

237 
pEx¥
->
iCﬁumn
 = (
i16
)
j
;

244 #i‚de‡
SQLITE4_OMIT_TRIGGER


248 if–
zDb
==0 && 
zTab
!=0 && 
˙t
==0 && 
pP¨£
->
pTriggîTab
!=0 ){

249 
›
 = 
pP¨£
->
eTriggîOp
;

250 
TabÀ
 *
pTab
 = 0;

251 
	`as£π
–
›
==
TK_DELETE
 || op==
TK_UPDATE
 || op==
TK_INSERT
 );

252 if–
›
!=
TK_DELETE
 && 
	`sqlôe4_°ricmp
("√w",
zTab
) == 0 ){

253 
pEx¥
->
iTabÀ
 = 1;

254 
pTab
 = 
pP¨£
->
pTriggîTab
;

255 }if–
›
!=
TK_INSERT
 && 
	`sqlôe4_°ricmp
("ﬁd",
zTab
)==0 ){

256 
pEx¥
->
iTabÀ
 = 0;

257 
pTab
 = 
pP¨£
->
pTriggîTab
;

260 if–
pTab
 ){

261 
iCﬁ
;

262 
pSchema
 = 
pTab
->pSchema;

263 
˙tTab
++;

264 
iCﬁ
=0; iCﬁ<
pTab
->
nCﬁ
; iCol++){

265 
Cﬁumn
 *
pCﬁ
 = &
pTab
->
aCﬁ
[
iCﬁ
];

266 if–
	`sqlôe4_°ricmp
(
pCﬁ
->
zName
, 
zCﬁ
)==0 ){

270 if–
iCﬁ
>=
pTab
->
nCﬁ
 && 
	`isRowidRe„ªn˚
’Tab, 
zCﬁ
) ){

271 
iCﬁ
 = -1;

273 if–
iCﬁ
<
pTab
->
nCﬁ
 ){

274 
˙t
++;

275 if–
iCﬁ
<0 ){

276 
pEx¥
->
afföôy
 = 
SQLITE4_AFF_INTEGER
;

277 }if–
pEx¥
->
iTabÀ
==0 ){

278 
	`ã°ˇ£
–
iCﬁ
==31 );

279 
	`ã°ˇ£
–
iCﬁ
==32 );

280 
pP¨£
->
ﬁdmask
 |(
iCﬁ
>=32 ? 0xfffffff‡: (((
u32
)1)<<iCol));

282 
	`ã°ˇ£
–
iCﬁ
==31 );

283 
	`ã°ˇ£
–
iCﬁ
==32 );

284 
pP¨£
->
√wmask
 |(
iCﬁ
>=32 ? 0xfffffff‡: (((
u32
)1)<<iCol));

286 
pEx¥
->
iCﬁumn
 = (
i16
)
iCﬁ
;

287 
isTriggî
 = 1;

289 
pEx¥
->
pTab
 =ÖTab;

297 if–
˙t
==0 && 
˙tTab
==1 && 
	`isRowidRe„ªn˚
(
pEx¥
->
pTab
, 
zCﬁ
) ){

298 
˙t
 = 1;

299 
pEx¥
->
iCﬁumn
 = -1;

300 
pEx¥
->
afföôy
 = 
SQLITE4_AFF_INTEGER
;

315 if–
˙t
==0 && (
pELi°
 = 
pNC
->pELi°)!=0 && 
zTab
==0 ){

316 
j
=0; j<
pELi°
->
nEx¥
; j++){

317 *
zAs
 = 
pELi°
->
a
[
j
].
zName
;

318 if–
zAs
!=0 && 
	`sqlôe4_°ricmp
(zAs, 
zCﬁ
)==0 ){

319 
Ex¥
 *
pOrig
;

320 
	`as£π
–
pEx¥
->
pLe·
==0 &&ÖEx¥->
pRight
==0 );

321 
	`as£π
–
pEx¥
->
x
.
pLi°
==0 );

322 
	`as£π
–
pEx¥
->
x
.
pSñe˘
==0 );

323 
pOrig
 = 
pELi°
->
a
[
j
].
pEx¥
;

324 if–!
pNC
->
ÆlowAgg
 && 
	`Ex¥HasPr›îty
(
pOrig
, 
EP_Agg
) ){

325 
	`sqlôe4Eº‹Msg
(
pP¨£
, "misu£ o‡Æü£dággªg©ê%s", 
zAs
);

326  
WRC_Ab‹t
;

328 
	`ªsﬁveAlüs
(
pP¨£
, 
pELi°
, 
j
, 
pEx¥
, "");

329 
˙t
 = 1;

330 
pM©ch
 = 0;

331 
	`as£π
–
zTab
==0 && 
zDb
==0 );

332 
looku≤ame_íd
;

340 if–
˙t
==0 ){

341 
pNC
 =ÖNC->
pNext
;

349 if–
˙t
!=1 ){

350 c⁄° *
zEº
;

351 
zEº
 = 
˙t
==0 ? "no such column" : "ambiguous columnÇame";

352 if–
zDb
 ){

353 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s: %s.%s.%s", 
zEº
, 
zDb
, 
zTab
, 
zCﬁ
);

354 }if–
zTab
 ){

355 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s: %s.%s", 
zEº
, 
zTab
, 
zCﬁ
);

357 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s: %s", 
zEº
, 
zCﬁ
);

359 
pP¨£
->
checkSchema
 = 1;

360 
pT›NC
->
nEº
++;

369 if–
pM©ch
!=0 ){

370 
n
 = 
pEx¥
->
iCﬁumn
;

371 
	`ã°ˇ£
–
n
==
BMS
-1 );

372 if–
n
>=
BMS
 ||Ç<0 ){

373 
n
 = 
BMS
-1;

375 
	`as£π
–
pM©ch
->
iCurs‹
==
pEx¥
->
iTabÀ
 );

376 
pM©ch
->
cﬁU£d
 |((
Bômask
)1)<<
n
;

381 
	`sqlôe4Ex¥Dñëe
(
db
, 
pEx¥
->
pLe·
);

382 
pEx¥
->
pLe·
 = 0;

383 
	`sqlôe4Ex¥Dñëe
(
db
, 
pEx¥
->
pRight
);

384 
pEx¥
->
pRight
 = 0;

385 
pEx¥
->
›
 = (
isTriggî
 ? 
TK_TRIGGER
 : 
TK_COLUMN
);

386 
looku≤ame_íd
:

387 if–
˙t
==1 ){

388 
	`as£π
–
pNC
!=0 );

389 
	`sqlôe4AuthRód
(
pP¨£
, 
pEx¥
, 
pSchema
, 
pNC
->
pSrcLi°
);

393 
	`as£π
–
pT›NC
!=0 );

394 
pT›NC
->
nRef
++;

395 if–
pT›NC
==
pNC
 ) ;

396 
pT›NC
 =ÖT›NC->
pNext
;

398  
WRC_Pru√
;

400  
WRC_Ab‹t
;

402 
	}
}

408 
Ex¥
 *
	$sqlôe4Cª©eCﬁumnEx¥
(
sqlôe4
 *
db
, 
SrcLi°
 *
pSrc
, 
iSrc
, 
iCﬁ
){

409 
Ex¥
 *
p
 = 
	`sqlôe4Ex¥AŒoc
(
db
, 
TK_COLUMN
, 0, 0);

410 if–
p
 ){

411 
SrcLi°Iãm
 *
pIãm
 = &
pSrc
->
a
[
iSrc
];

412 
p
->
pTab
 = 
pIãm
->pTab;

413 
p
->
iTabÀ
 = 
pIãm
->
iCurs‹
;

414 
p
->
iCﬁumn
 = (
ynV¨
)
iCﬁ
;

415 
	`ã°ˇ£
–
iCﬁ
==
BMS
 );

416 
	`ã°ˇ£
–
iCﬁ
==
BMS
-1 );

417 
pIãm
->
cﬁU£d
 |((
Bômask
)1)<<((
iCﬁ
>=
BMS
 || iCol<0) ? BMS-1 : iCol);

418 
	`Ex¥SëPr›îty
(
p
, 
EP_Resﬁved
);

420  
p
;

421 
	}
}

423 
	$ªsﬁveM©chArg
(
P¨£
 *
pP¨£
, 
NameC⁄ãxt
 *
pNC
, 
Ex¥
 *
pEx¥
){

424 
SrcLi°
 *
pSrc
 = 
pNC
->
pSrcLi°
;

425 
SrcLi°Iãm
 *
pIãm
;

426 *
zLhs
;

427 
i
;

429 if–
pEx¥
->
›
!=
TK_ID
 || 
pSrc
==0 ||ÖExpr==0 ){

430 
	`sqlôe4Eº‹Msg
(
pP¨£
, "firstárgument xxx must beáÅableÇame");

433 
zLhs
 = 
pEx¥
->
u
.
zTokí
;

435 
i
=0; i<
pSrc
->
nSrc
; i++){

436 
pIãm
 = &
pSrc
->
a
[
i
];

437 if–
pIãm
->
zAlüs
 && 
	`sqlôe4_°ricmp
(
zLhs
,ÖItem->zAlias)==0 ) ;

438 if–
pIãm
->
zAlüs
==0 && 
	`sqlôe4_°ricmp
(
zLhs
,ÖIãm->
zName
)==0 ) ;

440 if–
i
==
pSrc
->
nSrc
 ){

441 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuchÅabÀ: %s", 
zLhs
);

445 
pEx¥
->
›
 = 
TK_NULL
;

446 
pEx¥
->
iTabÀ
 = 
pIãm
->
iCurs‹
;

447 
	`Ex¥SëPr›îty
(
pEx¥
, 
EP_Resﬁved
);

448 
	}
}

450 
	$ªsﬁveM©ch
(
P¨£
 *
pP¨£
, 
NameC⁄ãxt
 *
pNC
, 
Ex¥
 *
pEx¥
){

451 
Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

452 
SrcLi°
 *
pSrc
 = 
pNC
->
pSrcLi°
;

453 
SrcLi°Iãm
 *
pIãm
;

454 *
zLhs
;

455 
i
;

456 
Index
 *
pIdx
;

458 if–
pLe·
->
›
!=
TK_ID
 || 
pSrc
==0 ){

459 
	`sqlôe4Eº‹Msg
(
pP¨£
, "lhs of MATCH operator must beáÅableÇame");

462 
zLhs
 = 
pLe·
->
u
.
zTokí
;

464 
i
=0; i<
pSrc
->
nSrc
; i++){

465 
pIãm
 = &
pSrc
->
a
[
i
];

466 if–
pIãm
->
zAlüs
 && 
	`sqlôe4_°ricmp
(
zLhs
,ÖItem->zAlias)==0 ) ;

467 if–
pIãm
->
zAlüs
==0 && 
	`sqlôe4_°ricmp
(
zLhs
,ÖIãm->
zName
)==0 ) ;

470 if–
i
==
pSrc
->
nSrc
 ){

471 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuchÅabÀ: %s", 
zLhs
);

475 
pIdx
=
pIãm
->
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

476 if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
 ) ;

478 if–!
pIdx
 ){

479 
	`sqlôe4Eº‹Msg
(
pP¨£
, "no indexÅoÖrocess MATCH operator");

483 
pEx¥
->
pLe·
 = 0;

484 
pEx¥
->
pIdx
 =ÖIdx;

485 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
pLe·
);

486 
	}
}

499 
	$ªsﬁveEx¥Sãp
(
WÆkî
 *
pWÆkî
, 
Ex¥
 *
pEx¥
){

500 
NameC⁄ãxt
 *
pNC
;

501 
P¨£
 *
pP¨£
;

503 
pNC
 = 
pWÆkî
->
u
.pNC;

504 
	`as£π
–
pNC
!=0 );

505 
pP¨£
 = 
pNC
->pParse;

506 
	`as£π
–
pP¨£
==
pWÆkî
->pParse );

508 if–
	`Ex¥HasAnyPr›îty
(
pEx¥
, 
EP_Resﬁved
ËË 
WRC_Pru√
;

509 
	`Ex¥SëPr›îty
(
pEx¥
, 
EP_Resﬁved
);

510 #i‚de‡
NDEBUG


511 if–
pNC
->
pSrcLi°
 &&ÖNC->pSrcLi°->
nAŒoc
>0 ){

512 
SrcLi°
 *
pSrcLi°
 = 
pNC
->pSrcList;

513 
i
;

514 
i
=0; i<
pNC
->
pSrcLi°
->
nSrc
; i++){

515 
	`as£π
–
pSrcLi°
->
a
[
i
].
iCurs‹
>=0 &&ÖSrcLi°->a[i].iCurs‹<
pP¨£
->
nTab
);

519  
pEx¥
->
›
 ){

521 #i‡
	`deföed
(
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT
Ë&& !deföed(
SQLITE4_OMIT_SUBQUERY
)

526 
TK_ROW
: {

527 
SrcLi°
 *
pSrcLi°
 = 
pNC
->pSrcList;

528 
SrcLi°Iãm
 *
pIãm
;

529 
	`as£π
–
pSrcLi°
 &&ÖSrcLi°->
nSrc
==1 );

530 
pIãm
 = 
pSrcLi°
->
a
;

531 
pEx¥
->
›
 = 
TK_COLUMN
;

532 
pEx¥
->
pTab
 = 
pIãm
->pTab;

533 
pEx¥
->
iTabÀ
 = 
pIãm
->
iCurs‹
;

534 
pEx¥
->
iCﬁumn
 = -1;

535 
pEx¥
->
afföôy
 = 
SQLITE4_AFF_INTEGER
;

542 
TK_ID
: {

543  
	`lookupName
(
pP¨£
, 0, 0, 
pEx¥
->
u
.
zTokí
, 
pNC
,ÖExpr);

549 
TK_DOT
: {

550 c⁄° *
zCﬁumn
;

551 c⁄° *
zTabÀ
;

552 c⁄° *
zDb
;

553 
Ex¥
 *
pRight
;

556 
pRight
 = 
pEx¥
->pRight;

557 if–
pRight
->
›
==
TK_ID
 ){

558 
zDb
 = 0;

559 
zTabÀ
 = 
pEx¥
->
pLe·
->
u
.
zTokí
;

560 
zCﬁumn
 = 
pRight
->
u
.
zTokí
;

562 
	`as£π
–
pRight
->
›
==
TK_DOT
 );

563 
zDb
 = 
pEx¥
->
pLe·
->
u
.
zTokí
;

564 
zTabÀ
 = 
pRight
->
pLe·
->
u
.
zTokí
;

565 
zCﬁumn
 = 
pRight
->pRight->
u
.
zTokí
;

567  
	`lookupName
(
pP¨£
, 
zDb
, 
zTabÀ
, 
zCﬁumn
, 
pNC
, 
pEx¥
);

572 
TK_CONST_FUNC
:

573 
TK_FUNCTION
: {

574 
Ex¥Li°
 *
pLi°
 = 
pEx¥
->
x
.pList;

575 
n
 = 
pLi°
 ?ÖLi°->
nEx¥
 : 0;

576 
no_such_func
 = 0;

577 
wr⁄g_num_¨gs
 = 0;

578 
is_agg
 = 0;

579 
auth
;

580 
nId
;

581 c⁄° *
zId
;

582 
FuncDef
 *
pDef
;

584 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_CONST_FUNC
 );

585 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

586 
zId
 = 
pEx¥
->
u
.
zTokí
;

587 
nId
 = 
	`sqlôe4SåÀn30
(
zId
);

588 
pDef
 = 
	`sqlôe4FödFun˘i⁄
(
pP¨£
->
db
, 
zId
, 
nId
, 
n
, 0);

589 if–
pDef
==0 ){

590 
pDef
 = 
	`sqlôe4FödFun˘i⁄
(
pP¨£
->
db
, 
zId
, 
nId
, -1, 0);

591 if–
pDef
==0 ){

592 
no_such_func
 = 1;

594 
wr⁄g_num_¨gs
 = 1;

597 
is_agg
 = 
pDef
->
xFunc
==0;

599 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


600 if–
pDef
 ){

601 
auth
 = 
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_FUNCTION
, 0, 
pDef
->
zName
, 0);

602 if–
auth
!=
SQLITE4_OK
 ){

603 if–
auth
==
SQLITE4_DENY
 ){

604 
	`sqlôe4Eº‹Msg
(
pP¨£
, "notáuthorizedÅo use function: %s",

605 
pDef
->
zName
);

606 
pNC
->
nEº
++;

608 
pEx¥
->
›
 = 
TK_NULL
;

609  
WRC_Pru√
;

613 if–
is_agg
 && !
pNC
->
ÆlowAgg
 ){

614 
	`sqlôe4Eº‹Msg
(
pP¨£
, "misu£ o‡aggªg©êfun˘i⁄ %.*s()", 
nId
,
zId
);

615 
pNC
->
nEº
++;

616 
is_agg
 = 0;

617 }if–
no_such_func
 ){

618 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuch fun˘i⁄: %.*s", 
nId
, 
zId
);

619 
pNC
->
nEº
++;

620 }if–
wr⁄g_num_¨gs
 ){

621 
	`sqlôe4Eº‹Msg
(
pP¨£
,"wrongÇumber ofárgumentsÅo function %.*s()",

622 
nId
, 
zId
);

623 
pNC
->
nEº
++;

625 if–
is_agg
 ){

626 
pEx¥
->
›
 = 
TK_AGG_FUNCTION
;

627 
pNC
->
hasAgg
 = 1;

630 if–
pP¨£
->
nEº
==0 ){

631 if–
pDef
->
bM©chöfo
 ){

632 
	`ªsﬁveM©chArg
(
pP¨£
, 
pNC
, 
n
>0 ? 
pLi°
->
a
[0].
pEx¥
 : 0);

634 if–
is_agg
 ) 
pNC
->
ÆlowAgg
 = 0;

635 
	`sqlôe4WÆkEx¥Li°
(
pWÆkî
, 
pLi°
);

636 if–
is_agg
 ) 
pNC
->
ÆlowAgg
 = 1;

642  
WRC_Pru√
;

644 #i‚de‡
SQLITE4_OMIT_SUBQUERY


645 
TK_SELECT
:

646 
TK_EXISTS
: 
	`ã°ˇ£
–
pEx¥
->
›
==TK_EXISTS );

648 
TK_IN
: {

649 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_IN
 );

650 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

651 
nRef
 = 
pNC
->nRef;

652 #i‚de‡
SQLITE4_OMIT_CHECK


653 if–
pNC
->
isCheck
 ){

654 
	`sqlôe4Eº‹Msg
(
pP¨£
,"subqueriesÖrohibited in CHECK constraints");

657 
	`sqlôe4WÆkSñe˘
(
pWÆkî
, 
pEx¥
->
x
.
pSñe˘
);

658 
	`as£π
–
pNC
->
nRef
>=nRef );

659 if–
nRef
!=
pNC
->nRef ){

660 
	`Ex¥SëPr›îty
(
pEx¥
, 
EP_V¨Sñe˘
);

665 #i‚de‡
SQLITE4_OMIT_CHECK


666 
TK_VARIABLE
: {

667 if–
pNC
->
isCheck
 ){

668 
	`sqlôe4Eº‹Msg
(
pP¨£
,"parametersÖrohibited in CHECK constraints");

673 
TK_MATCH
: {

674 
	`ªsﬁveM©ch
(
pP¨£
, 
pNC
, 
pEx¥
);

678  (
pP¨£
->
nEº
 ||ÖP¨£->
db
->
mÆlocFaûed
Ë? 
WRC_Ab‹t
 : 
WRC_C⁄töue
;

679 
	}
}

693 
	$ªsﬁveAsName
(

694 
P¨£
 *
pP¨£
,

695 
Ex¥Li°
 *
pELi°
,

696 
Ex¥
 *
pE


698 
i
;

700 
	`UNUSED_PARAMETER
(
pP¨£
);

702 if–
pE
->
›
==
TK_ID
 ){

703 *
zCﬁ
 = 
pE
->
u
.
zTokí
;

704 
i
=0; i<
pELi°
->
nEx¥
; i++){

705 *
zAs
 = 
pELi°
->
a
[
i
].
zName
;

706 if–
zAs
!=0 && 
	`sqlôe4_°ricmp
(zAs, 
zCﬁ
)==0 ){

707  
i
+1;

712 
	}
}

732 
	$ªsﬁveOrdîByTîmToEx¥Li°
(

733 
P¨£
 *
pP¨£
,

734 
Sñe˘
 *
pSñe˘
,

735 
Ex¥
 *
pE


737 
i
;

738 
Ex¥Li°
 *
pELi°
;

739 
NameC⁄ãxt
 
nc
;

740 
sqlôe4
 *
db
;

741 
rc
;

742 
u8
 
ßvedSuµEº
;

744 
	`as£π
–
	`sqlôe4Ex¥IsI¡egî
(
pE
, &
i
)==0 );

745 
pELi°
 = 
pSñe˘
->pEList;

749 
	`mem£t
(&
nc
, 0, (nc));

750 
nc
.
pP¨£
 =ÖParse;

751 
nc
.
pSrcLi°
 = 
pSñe˘
->
pSrc
;

752 
nc
.
pELi°
 =ÖEList;

753 
nc
.
ÆlowAgg
 = 1;

754 
nc
.
nEº
 = 0;

755 
db
 = 
pP¨£
->db;

756 
ßvedSuµEº
 = 
db
->
suµªssEº
;

757 
db
->
suµªssEº
 = 1;

758 
rc
 = 
	`sqlôe4ResﬁveEx¥Names
(&
nc
, 
pE
);

759 
db
->
suµªssEº
 = 
ßvedSuµEº
;

760 if–
rc
 )  0;

766 
i
=0; i<
pELi°
->
nEx¥
; i++){

767 if–
	`sqlôe4Ex¥Com∑ª
(
pELi°
->
a
[
i
].
pEx¥
, 
pE
)<2 ){

768  
i
+1;

774 
	}
}

779 
	$ªsﬁveOutOfR™geEº‹
(

780 
P¨£
 *
pP¨£
,

781 c⁄° *
zTy≥
,

782 
i
,

783 
mx


785 
	`sqlôe4Eº‹Msg
(
pP¨£
,

787 "bëwì¿1ánd %d", 
i
, 
zTy≥
, 
mx
);

788 
	}
}

805 
	$ªsﬁveCompoundOrdîBy
(

806 
P¨£
 *
pP¨£
,

807 
Sñe˘
 *
pSñe˘


809 
i
;

810 
Ex¥Li°
 *
pOrdîBy
;

811 
Ex¥Li°
 *
pELi°
;

812 
sqlôe4
 *
db
;

813 
m‹eToDo
 = 1;

815 
pOrdîBy
 = 
pSñe˘
->pOrderBy;

816 if–
pOrdîBy
==0 )  0;

817 
db
 = 
pP¨£
->db;

818 #i‡
SQLITE4_MAX_COLUMN


819 if–
pOrdîBy
->
nEx¥
>
db
->
aLimô
[
SQLITE4_LIMIT_COLUMN
] ){

820 
	`sqlôe4Eº‹Msg
(
pP¨£
, "too manyÅerms in ORDER BY clause");

824 
i
=0; i<
pOrdîBy
->
nEx¥
; i++){

825 
pOrdîBy
->
a
[
i
].
d⁄e
 = 0;

827 
pSñe˘
->
pNext
 = 0;

828  
pSñe˘
->
pPri‹
 ){

829 
pSñe˘
->
pPri‹
->
pNext
 =ÖSelect;

830 
pSñe˘
 =ÖSñe˘->
pPri‹
;

832  
pSñe˘
 && 
m‹eToDo
 ){

833 
Ex¥Li°Iãm
 *
pIãm
;

834 
m‹eToDo
 = 0;

835 
pELi°
 = 
pSñe˘
->pEList;

836 
	`as£π
–
pELi°
!=0 );

837 
i
=0, 
pIãm
=
pOrdîBy
->
a
; i<pOrdîBy->
nEx¥
; i++,ÖItem++){

838 
iCﬁ
 = -1;

839 
Ex¥
 *
pE
, *
pDup
;

840 if–
pIãm
->
d⁄e
 ) ;

841 
pE
 = 
pIãm
->
pEx¥
;

842 if–
	`sqlôe4Ex¥IsI¡egî
(
pE
, &
iCﬁ
) ){

843 if–
iCﬁ
<=0 || iCﬁ>
pELi°
->
nEx¥
 ){

844 
	`ªsﬁveOutOfR™geEº‹
(
pP¨£
, "ORDER", 
i
+1, 
pELi°
->
nEx¥
);

848 
iCﬁ
 = 
	`ªsﬁveAsName
(
pP¨£
, 
pELi°
, 
pE
);

849 if–
iCﬁ
==0 ){

850 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pE
, 0);

851 if–!
db
->
mÆlocFaûed
 ){

852 
	`as£π
(
pDup
);

853 
iCﬁ
 = 
	`ªsﬁveOrdîByTîmToEx¥Li°
(
pP¨£
, 
pSñe˘
, 
pDup
);

855 
	`sqlôe4Ex¥Dñëe
(
db
, 
pDup
);

858 if–
iCﬁ
>0 ){

859 
CﬁlSeq
 *
pCﬁl
 = 
pE
->pColl;

860 
Êags
 = 
pE
->Êag†& 
EP_ExpCﬁœã
;

861 
	`sqlôe4Ex¥Dñëe
(
db
, 
pE
);

862 
pIãm
->
pEx¥
 = 
pE
 = 
	`sqlôe4Ex¥
(
db
, 
TK_INTEGER
, 0);

863 if–
pE
==0 )  1;

864 
pE
->
pCﬁl
 =ÖColl;

865 
pE
->
Êags
 |
EP_I¡VÆue
 | flags;

866 
pE
->
u
.
iVÆue
 = 
iCﬁ
;

867 
pIãm
->
iOrdîByCﬁ
 = (
u16
)
iCﬁ
;

868 
pIãm
->
d⁄e
 = 1;

870 
m‹eToDo
 = 1;

873 
pSñe˘
 =ÖSñe˘->
pNext
;

875 
i
=0; i<
pOrdîBy
->
nEx¥
; i++){

876 if–
pOrdîBy
->
a
[
i
].
d⁄e
==0 ){

877 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%r ORDER BYÅerm doesÇot matchány "

878 "cﬁum¿öÅhêªsu… së", 
i
+1);

883 
	}
}

895 
	$sqlôe4ResﬁveOrdîGroupBy
(

896 
P¨£
 *
pP¨£
,

897 
Sñe˘
 *
pSñe˘
,

898 
Ex¥Li°
 *
pOrdîBy
,

899 c⁄° *
zTy≥


901 
i
;

902 
sqlôe4
 *
db
 = 
pP¨£
->db;

903 
Ex¥Li°
 *
pELi°
;

904 
Ex¥Li°Iãm
 *
pIãm
;

906 if–
pOrdîBy
==0 || 
pP¨£
->
db
->
mÆlocFaûed
 )  0;

907 #i‡
SQLITE4_MAX_COLUMN


908 if–
pOrdîBy
->
nEx¥
>
db
->
aLimô
[
SQLITE4_LIMIT_COLUMN
] ){

909 
	`sqlôe4Eº‹Msg
(
pP¨£
, "toÿm™yÅîm†ö %†BY cœu£", 
zTy≥
);

913 
pELi°
 = 
pSñe˘
->pEList;

914 
	`as£π
–
pELi°
!=0 );

915 
i
=0, 
pIãm
=
pOrdîBy
->
a
; i<pOrdîBy->
nEx¥
; i++,ÖItem++){

916 if–
pIãm
->
iOrdîByCﬁ
 ){

917 if–
pIãm
->
iOrdîByCﬁ
>
pELi°
->
nEx¥
 ){

918 
	`ªsﬁveOutOfR™geEº‹
(
pP¨£
, 
zTy≥
, 
i
+1, 
pELi°
->
nEx¥
);

921 
	`ªsﬁveAlüs
(
pP¨£
, 
pELi°
, 
pIãm
->
iOrdîByCﬁ
-1,ÖIãm->
pEx¥
, 
zTy≥
);

925 
	}
}

945 
	$ªsﬁveOrdîGroupBy
(

946 
NameC⁄ãxt
 *
pNC
,

947 
Sñe˘
 *
pSñe˘
,

948 
Ex¥Li°
 *
pOrdîBy
,

949 c⁄° *
zTy≥


951 
i
;

952 
iCﬁ
;

953 
Ex¥Li°Iãm
 *
pIãm
;

954 
P¨£
 *
pP¨£
;

955 
nResu…
;

957 if–
pOrdîBy
==0 )  0;

958 
nResu…
 = 
pSñe˘
->
pELi°
->
nEx¥
;

959 
pP¨£
 = 
pNC
->pParse;

960 
i
=0, 
pIãm
=
pOrdîBy
->
a
; i<pOrdîBy->
nEx¥
; i++,ÖItem++){

961 
Ex¥
 *
pE
 = 
pIãm
->
pEx¥
;

962 
iCﬁ
 = 
	`ªsﬁveAsName
(
pP¨£
, 
pSñe˘
->
pELi°
, 
pE
);

963 if–
iCﬁ
>0 ){

968 
pIãm
->
iOrdîByCﬁ
 = (
u16
)
iCﬁ
;

971 if–
	`sqlôe4Ex¥IsI¡egî
(
pE
, &
iCﬁ
) ){

975 if–
iCﬁ
<1 ){

976 
	`ªsﬁveOutOfR™geEº‹
(
pP¨£
, 
zTy≥
, 
i
+1, 
nResu…
);

979 
pIãm
->
iOrdîByCﬁ
 = (
u16
)
iCﬁ
;

984 
pIãm
->
iOrdîByCﬁ
 = 0;

985 if–
	`sqlôe4ResﬁveEx¥Names
(
pNC
, 
pE
) ){

989  
	`sqlôe4ResﬁveOrdîGroupBy
(
pP¨£
, 
pSñe˘
, 
pOrdîBy
, 
zTy≥
);

990 
	}
}

995 
	$ªsﬁveSñe˘Sãp
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
p
){

996 
NameC⁄ãxt
 *
pOuãrNC
;

997 
NameC⁄ãxt
 
sNC
;

998 
isCompound
;

999 
nCompound
;

1000 
P¨£
 *
pP¨£
;

1001 
Ex¥Li°
 *
pELi°
;

1002 
i
;

1003 
Ex¥Li°
 *
pGroupBy
;

1004 
Sñe˘
 *
pLe·mo°
;

1005 
sqlôe4
 *
db
;

1008 
	`as£π
–
p
!=0 );

1009 if–
p
->
£lFœgs
 & 
SF_Resﬁved
 ){

1010  
WRC_Pru√
;

1012 
pOuãrNC
 = 
pWÆkî
->
u
.
pNC
;

1013 
pP¨£
 = 
pWÆkî
->pParse;

1014 
db
 = 
pP¨£
->db;

1024 if–(
p
->
£lFœgs
 & 
SF_Ex∑nded
)==0 ){

1025 
	`sqlôe4Sñe˘Pªp
(
pP¨£
, 
p
, 
pOuãrNC
);

1026  (
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
Ë? 
WRC_Ab‹t
 : 
WRC_Pru√
;

1029 
isCompound
 = 
p
->
pPri‹
!=0;

1030 
nCompound
 = 0;

1031 
pLe·mo°
 = 
p
;

1032  
p
 ){

1033 
	`as£π
–(
p
->
£lFœgs
 & 
SF_Ex∑nded
)!=0 );

1034 
	`as£π
–(
p
->
£lFœgs
 & 
SF_Resﬁved
)==0 );

1035 
p
->
£lFœgs
 |
SF_Resﬁved
;

1040 
	`mem£t
(&
sNC
, 0, (sNC));

1041 
sNC
.
pP¨£
 =ÖParse;

1042 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
p
->
pLimô
) ||

1043 
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
p
->
pOff£t
) ){

1044  
WRC_Ab‹t
;

1050 
sNC
.
ÆlowAgg
 = 1;

1051 
sNC
.
pSrcLi°
 = 
p
->
pSrc
;

1052 
sNC
.
pNext
 = 
pOuãrNC
;

1055 
pELi°
 = 
p
->pEList;

1056 
	`as£π
–
pELi°
!=0 );

1057 
i
=0; i<
pELi°
->
nEx¥
; i++){

1058 
Ex¥
 *
pX
 = 
pELi°
->
a
[
i
].
pEx¥
;

1059 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pX
) ){

1060  
WRC_Ab‹t
;

1066 
i
=0; i<
p
->
pSrc
->
nSrc
; i++){

1067 
SrcLi°Iãm
 *
pIãm
 = &
p
->
pSrc
->
a
[
i
];

1068 if–
pIãm
->
pSñe˘
 ){

1069 
NameC⁄ãxt
 *
pNC
;

1070 
nRef
 = 0;

1071 c⁄° *
zSavedC⁄ãxt
 = 
pP¨£
->
zAuthC⁄ãxt
;

1078 
pNC
=
pOuãrNC
;ÖNC;ÖNCıNC->
pNext
Ë
nRef
 +=ÖNC->nRef;

1080 if–
pIãm
->
zName
 ) 
pP¨£
->
zAuthC⁄ãxt
 =ÖItem->zName;

1081 
	`sqlôe4ResﬁveSñe˘Names
(
pP¨£
, 
pIãm
->
pSñe˘
, 
pOuãrNC
);

1082 
pP¨£
->
zAuthC⁄ãxt
 = 
zSavedC⁄ãxt
;

1083 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 )  
WRC_Ab‹t
;

1085 
pNC
=
pOuãrNC
;ÖNC;ÖNCıNC->
pNext
Ë
nRef
 -=ÖNC->nRef;

1086 
	`as£π
–
pIãm
->
isC‹ªœãd
==0 && 
nRef
<=0 );

1087 
pIãm
->
isC‹ªœãd
 = (
nRef
!=0);

1094 
	`as£π
–(
p
->
£lFœgs
 & 
SF_Aggªg©e
)==0 );

1095 
pGroupBy
 = 
p
->pGroupBy;

1096 if–
pGroupBy
 || 
sNC
.
hasAgg
 ){

1097 
p
->
£lFœgs
 |
SF_Aggªg©e
;

1099 
sNC
.
ÆlowAgg
 = 0;

1104 if–
p
->
pHavög
 && !
pGroupBy
 ){

1105 
	`sqlôe4Eº‹Msg
(
pP¨£
, "a GROUP BY clause isÑequired before HAVING");

1106  
WRC_Ab‹t
;

1117 
sNC
.
pELi°
 = 
p
->pEList;

1118 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
p
->
pWhîe
) ||

1119 
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
p
->
pHavög
)

1121  
WRC_Ab‹t
;

1127 
sNC
.
pNext
 = 0;

1128 
sNC
.
ÆlowAgg
 = 1;

1135 if–!
isCompound
 && 
	`ªsﬁveOrdîGroupBy
(&
sNC
, 
p
,Ö->
pOrdîBy
, "ORDER") ){

1136  
WRC_Ab‹t
;

1138 if–
db
->
mÆlocFaûed
 ){

1139  
WRC_Ab‹t
;

1145 if–
pGroupBy
 ){

1146 
Ex¥Li°Iãm
 *
pIãm
;

1148 if–
	`ªsﬁveOrdîGroupBy
(&
sNC
, 
p
, 
pGroupBy
, "GROUP"Ë|| 
db
->
mÆlocFaûed
 ){

1149  
WRC_Ab‹t
;

1151 
i
=0, 
pIãm
=
pGroupBy
->
a
; i<pGroupBy->
nEx¥
; i++,ÖItem++){

1152 if–
	`Ex¥HasPr›îty
(
pIãm
->
pEx¥
, 
EP_Agg
) ){

1153 
	`sqlôe4Eº‹Msg
(
pP¨£
, "aggregate functionsáreÇotállowed in "

1155  
WRC_Ab‹t
;

1162 
p
 =Ö->
pPri‹
;

1163 
nCompound
++;

1169 if–
isCompound
 && 
	`ªsﬁveCompoundOrdîBy
(
pP¨£
, 
pLe·mo°
) ){

1170  
WRC_Ab‹t
;

1173  
WRC_Pru√
;

1174 
	}
}

1224 
	$sqlôe4ResﬁveEx¥Names
(

1225 
NameC⁄ãxt
 *
pNC
,

1226 
Ex¥
 *
pEx¥


1228 
ßvedHasAgg
;

1229 
WÆkî
 
w
;

1231 if–
pEx¥
==0 )  0;

1232 #i‡
SQLITE4_MAX_EXPR_DEPTH
>0

1234 
P¨£
 *
pP¨£
 = 
pNC
->pParse;

1235 if–
	`sqlôe4Ex¥CheckHeight
(
pP¨£
, 
pEx¥
->
nHeight
+
pNC
->pParse->nHeight) ){

1238 
pP¨£
->
nHeight
 +
pEx¥
->nHeight;

1241 
ßvedHasAgg
 = 
pNC
->
hasAgg
;

1242 
pNC
->
hasAgg
 = 0;

1243 
w
.
xEx¥CÆlback
 = 
ªsﬁveEx¥Sãp
;

1244 
w
.
xSñe˘CÆlback
 = 
ªsﬁveSñe˘Sãp
;

1245 
w
.
pP¨£
 = 
pNC
->pParse;

1246 
w
.
u
.
pNC
 =ÖNC;

1247 
	`sqlôe4WÆkEx¥
(&
w
, 
pEx¥
);

1248 #i‡
SQLITE4_MAX_EXPR_DEPTH
>0

1249 
pNC
->
pP¨£
->
nHeight
 -
pEx¥
->nHeight;

1251 if–
pNC
->
nEº
>0 || 
w
.
pP¨£
->nErr>0 ){

1252 
	`Ex¥SëPr›îty
(
pEx¥
, 
EP_Eº‹
);

1254 if–
pNC
->
hasAgg
 ){

1255 
	`Ex¥SëPr›îty
(
pEx¥
, 
EP_Agg
);

1256 }if–
ßvedHasAgg
 ){

1257 
pNC
->
hasAgg
 = 1;

1259  
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_Eº‹
);

1260 
	}
}

1275 
	$sqlôe4ResﬁveSñe˘Names
(

1276 
P¨£
 *
pP¨£
,

1277 
Sñe˘
 *
p
,

1278 
NameC⁄ãxt
 *
pOuãrNC


1280 
WÆkî
 
w
;

1282 
	`as£π
–
p
!=0 );

1283 
w
.
xEx¥CÆlback
 = 
ªsﬁveEx¥Sãp
;

1284 
w
.
xSñe˘CÆlback
 = 
ªsﬁveSñe˘Sãp
;

1285 
w
.
pP¨£
 =ÖParse;

1286 
w
.
u
.
pNC
 = 
pOuãrNC
;

1287 
	`sqlôe4WÆkSñe˘
(&
w
, 
p
);

1288 
	}
}

	@src/rowset.c

62 
	~"sqlôeI¡.h
"

64 
RowSëE¡ry
 
	tRowSëE¡ry
;

65 
RowSëChunk
 
	tRowSëChunk
;

75 
	#ROWSET_ALLOCATION_SIZE
 1024

	)

76 
	#ROWSET_BYTES_PER_CHUNK
 (
ROWSET_ALLOCATION_SIZE
 - (
RowSëChunk
))

	)

81 
	sRowSëE¡ry
 {

82 
RowSëE¡ry
 *
	mpRight
;

83 
RowSëE¡ry
 *
	mpLe·
;

84 
	mnKey
;

85 
u8
 
	maKey
[0];

94 
	sRowSëChunk
 {

95 
RowSëChunk
 *
	mpNextChunk
;

103 
	sRowSë
 {

104 
RowSëChunk
 *
	mpChunk
;

105 
sqlôe4
 *
	mdb
;

106 
RowSëE¡ry
 *
	mpE¡ry
;

107 
RowSëE¡ry
 *
	mpLa°
;

108 
RowSëE¡ry
 *
	mpTªe
;

109 
u8
 *
	maS∑˚
;

110 
u16
 
	mnS∑˚
;

111 
u8
 
	misS‹ãd
;

112 
u8
 
	miB©ch
;

127 
RowSë
 *
	$sqlôe4RowSëInô
(
sqlôe4
 *
db
, *
pS∑˚
, 
N
){

128 
RowSë
 *
p
;

129 
	`as£π
–
N
 >
	`ROUND8
((*
p
)) );

130 
p
 = 
pS∑˚
;

131 
p
->
pChunk
 = 0;

132 
p
->
db
 = db;

133 
p
->
pE¡ry
 = 0;

134 
p
->
pLa°
 = 0;

135 
p
->
pTªe
 = 0;

136 
p
->
aS∑˚
 = 0;

137 
p
->
nS∑˚
 = 0;

138 
p
->
isS‹ãd
 = 1;

139 
p
->
iB©ch
 = 0;

140  
p
;

141 
	}
}

148 
	$sqlôe4RowSëCÀ¨
(
RowSë
 *
p
){

149 
RowSëChunk
 *
pChunk
, *
pNextChunk
;

150 
pChunk
=
p
->pChunk;ÖChunk;ÖChunk = 
pNextChunk
){

151 
pNextChunk
 = 
pChunk
->pNextChunk;

152 
	`sqlôe4DbFªe
(
p
->
db
, 
pChunk
);

154 
	`mem£t
(
p
, 0, (
RowSë
));

155 
p
->
isS‹ãd
 = 1;

156 
	}
}

159 
u8
 *
	$row£tAŒoˇãChunk
(
RowSë
 *
p
, 
nByã
){

160 
rowChunkSize
 = 
	`ROUND8
((
RowSëChunk
));

161 
RowSëChunk
 *
pNew
;

162 
nAŒoc
;

163 
nAŒoc
 = 
rowChunkSize
 + 
nByã
;

164 
pNew
 = (
RowSëChunk
 *)
	`sqlôe4DbMÆlocRaw
(
p
->
db
, 
nAŒoc
);

165 if–!
pNew
 )  0;

166 
pNew
->
pNextChunk
 = 
p
->
pChunk
;

167 
p
->
pChunk
 = 
pNew
;

168  (
u8
 *)(&
pNew
[1]);

169 
	}
}

171 
	$row£tE¡ryKeyCmp
(
RowSëE¡ry
 *
pLe·
, c⁄° 
u8
 *
aKey
, 
nKey
){

172 
nCmp
 = 
	`SQLITE4_MIN
(
pLe·
->
nKey
,ÇKey);

173 
ªs
;

174 
ªs
 = 
	`memcmp
(
pLe·
->
aKey
,áKey, 
nCmp
);

175  (
ªs
 ?Ñe†: (
pLe·
->
nKey
 -ÇKey));

176 
	}
}

178 
	$row£tE¡ryCmp
(
RowSëE¡ry
 *
pLe·
, RowSëE¡ry *
pRight
){

179  
	`row£tE¡ryKeyCmp
(
pLe·
, 
pRight
->
aKey
,ÖRight->
nKey
);

180 
	}
}

189 
	$sqlôe4RowSëIn£π
(
RowSë
 *
p
, 
u8
 *
aKey
, 
nKey
){

190 
nByã
;

191 
RowSëE¡ry
 *
pE¡ry
;

192 
RowSëE¡ry
 *
pLa°
;

193 
	`as£π
–
p
!=0 );

195 
nByã
 = 
	`ROUND8
((
RowSëE¡ry
Ë+ 
nKey
);

197 if–
nByã
>(
ROWSET_BYTES_PER_CHUNK
/4) ){

199 
pE¡ry
 = (
RowSëE¡ry
 *)
	`row£tAŒoˇãChunk
(
p
, 
nByã
);

201 if–
nByã
>
p
->
nS∑˚
 ){

202 
p
->
aS∑˚
 = 
	`row£tAŒoˇãChunk
’, 
ROWSET_BYTES_PER_CHUNK
);

203 
p
->
nS∑˚
 = 
ROWSET_BYTES_PER_CHUNK
;

205 
pE¡ry
 = (
RowSëE¡ry
 *)
p
->
aS∑˚
;

206 
p
->
aS∑˚
 +
nByã
;

207 
p
->
nS∑˚
 -
nByã
;

209 if–
pE¡ry
==0 ) ;

211 
pE¡ry
->
pRight
 = 0;

212 
pE¡ry
->
pLe·
 = 0;

213 
pE¡ry
->
nKey
 =ÇKey;

214 
	`mem˝y
(
pE¡ry
->
aKey
,áKey, 
nKey
);

216 
pLa°
 = 
p
->pLast;

217 if–
pLa°
 ){

218 if–
p
->
isS‹ãd
 && 
	`row£tE¡ryCmp
(
pE¡ry
, 
pLa°
)<0 ){

219 
p
->
isS‹ãd
 = 0;

221 
pLa°
->
pRight
 = 
pE¡ry
;

223 
	`as£π
–
p
->
pE¡ry
==0 );

224 
p
->
pE¡ry
 =ÖEntry;

226 
p
->
pLa°
 = 
pE¡ry
;

227 
	}
}

235 
RowSëE¡ry
 *
	$rowSëMîge
(

236 
RowSëE¡ry
 *
pA
,

237 
RowSëE¡ry
 *
pB


239 
RowSëE¡ry
 
hód
;

240 
RowSëE¡ry
 *
pTaû
;

242 
pTaû
 = &
hód
;

243  
pA
 && 
pB
 ){

244 
ªs
;

245 
	`as£π
–
pA
->
pRight
==0 || 
	`row£tE¡ryCmp
(pA,ÖA->pRight)<=0 );

246 
	`as£π
–
pB
->
pRight
==0 || 
	`row£tE¡ryCmp
(pB,ÖB->pRight)<=0 );

247 
ªs
 = 
	`row£tE¡ryCmp
(
pA
, 
pB
);

248 if–
ªs
<0 ){

249 
pTaû
->
pRight
 = 
pA
;

250 
pA
 =ÖA->
pRight
;

251 
pTaû
 =ÖTaû->
pRight
;

252 }if–
ªs
>0 ){

253 
pTaû
->
pRight
 = 
pB
;

254 
pB
 =ÖB->
pRight
;

255 
pTaû
 =ÖTaû->
pRight
;

257 
pA
 =ÖA->
pRight
;

260 if–
pA
 ){

261 
	`as£π
–
pA
->
pRight
==0 || 
	`row£tE¡ryCmp
(pA,ÖA->pRight)<=0 );

262 
pTaû
->
pRight
 = 
pA
;

264 
	`as£π
–
pB
==0 ||ÖB->
pRight
==0 || 
	`row£tE¡ryCmp
(pB,ÖB->pRight)<=0 );

265 
pTaû
->
pRight
 = 
pB
;

267  
hód
.
pRight
;

268 
	}
}

273 
	$rowSëS‹t
(
RowSë
 *
p
){

274 
i
;

275 
RowSëE¡ry
 *
pE¡ry
;

276 
RowSëE¡ry
 *
aBuckë
[40];

278 
	`as£π
–
p
->
isS‹ãd
==0 );

279 
	`mem£t
(
aBuckë
, 0, (aBucket));

280  
p
->
pE¡ry
 ){

281 
pE¡ry
 = 
p
->pEntry;

282 
p
->
pE¡ry
 =ÖE¡ry->
pRight
;

283 
pE¡ry
->
pRight
 = 0;

284 
i
=0; 
aBuckë
[i]; i++){

285 
pE¡ry
 = 
	`rowSëMîge
(
aBuckë
[
i
],ÖEntry);

286 
aBuckë
[
i
] = 0;

288 
aBuckë
[
i
] = 
pE¡ry
;

290 
pE¡ry
 = 0;

291 
i
=0; i<(
aBuckë
)/(aBucket[0]); i++){

292 
pE¡ry
 = 
	`rowSëMîge
’E¡ry, 
aBuckë
[
i
]);

294 
p
->
pE¡ry
 =ÖEntry;

295 
p
->
pLa°
 = 0;

296 
p
->
isS‹ãd
 = 1;

297 
	}
}

305 
	$rowSëTªeToLi°
(

306 
RowSëE¡ry
 *
pIn
,

307 
RowSëE¡ry
 **
µFú°
,

308 
RowSëE¡ry
 **
µLa°


310 
	`as£π
–
pIn
!=0 );

311 if–
pIn
->
pLe·
 ){

312 
RowSëE¡ry
 *
p
;

313 
	`rowSëTªeToLi°
(
pIn
->
pLe·
, 
µFú°
, &
p
);

314 
p
->
pRight
 = 
pIn
;

316 *
µFú°
 = 
pIn
;

318 if–
pIn
->
pRight
 ){

319 
	`rowSëTªeToLi°
(
pIn
->
pRight
, &pIn->pRight, 
µLa°
);

321 *
µLa°
 = 
pIn
;

323 
	`as£π
–(*
µLa°
)->
pRight
==0 );

324 
	}
}

340 
RowSëE¡ry
 *
	$rowSëNDìpTªe
(

341 
RowSëE¡ry
 **
µLi°
,

342 
iDïth


344 
RowSëE¡ry
 *
p
;

345 
RowSëE¡ry
 *
pLe·
;

346 if–*
µLi°
==0 ){

349 if–
iDïth
==1 ){

350 
p
 = *
µLi°
;

351 *
µLi°
 = 
p
->
pRight
;

352 
p
->
pLe·
 =Ö->
pRight
 = 0;

353  
p
;

355 
pLe·
 = 
	`rowSëNDìpTªe
(
µLi°
, 
iDïth
-1);

356 
p
 = *
µLi°
;

357 if–
p
==0 ){

358  
pLe·
;

360 
p
->
pLe·
 =ÖLeft;

361 *
µLi°
 = 
p
->
pRight
;

362 
p
->
pRight
 = 
	`rowSëNDìpTªe
(
µLi°
, 
iDïth
-1);

363  
p
;

364 
	}
}

370 
RowSëE¡ry
 *
	$rowSëLi°ToTªe
(
RowSëE¡ry
 *
pLi°
){

371 
iDïth
;

372 
RowSëE¡ry
 *
p
;

373 
RowSëE¡ry
 *
pLe·
;

375 
	`as£π
–
pLi°
!=0 );

376 
p
 = 
pLi°
;

377 
pLi°
 = 
p
->
pRight
;

378 
p
->
pLe·
 =Ö->
pRight
 = 0;

379 
iDïth
=1; 
pLi°
; iDepth++){

380 
pLe·
 = 
p
;

381 
p
 = 
pLi°
;

382 
pLi°
 = 
p
->
pRight
;

383 
p
->
pLe·
 =ÖLeft;

384 
p
->
pRight
 = 
	`rowSëNDìpTªe
(&
pLi°
, 
iDïth
);

386  
p
;

387 
	}
}

394 
	$rowSëToLi°
(
RowSë
 *
p
){

395 if–!
p
->
isS‹ãd
 ){

396 
	`rowSëS‹t
(
p
);

398 if–
p
->
pTªe
 ){

399 
RowSëE¡ry
 *
pHód
, *
pTaû
;

400 
	`rowSëTªeToLi°
(
p
->
pTªe
, &
pHód
, &
pTaû
);

401 
p
->
pTªe
 = 0;

402 
p
->
pE¡ry
 = 
	`rowSëMîge
’->pE¡ry, 
pHód
);

404 
	}
}

414 
	$sqlôe4RowSëNext
(
RowSë
 *
p
){

415 
	`rowSëToLi°
(
p
);

416 
	`as£π
–
p
->
pE¡ry
 );

417 
p
->
pE¡ry
 =Ö->pE¡ry->
pRight
;

418  (
p
->
pE¡ry
!=0);

419 
	}
}

421 c⁄° 
u8
 *
	$sqlôe4RowSëRód
(
RowSë
 *
p
, *
≤Key
){

422 c⁄° 
u8
 *
aRë
 = 0;

423 
	`rowSëToLi°
(
p
);

424 if–
p
->
pE¡ry
 ){

425 *
≤Key
 = 
p
->
pE¡ry
->
nKey
;

426 
aRë
 = 
p
->
pE¡ry
->
aKey
;

428  
aRë
;

429 
	}
}

435 
	$sqlôe4RowSëTe°
(
RowSë
 *
pRowSë
, 
u8
 
iB©ch
, u8 *
aKey
, 
nKey
){

436 
RowSëE¡ry
 *
p
;

437 if–
iB©ch
!=
pRowSë
->iBatch ){

438 if–
pRowSë
->
pE¡ry
 ){

439 
	`rowSëToLi°
(
pRowSë
);

440 
pRowSë
->
pTªe
 = 
	`rowSëLi°ToTªe
’RowSë->
pE¡ry
);

441 
pRowSë
->
pE¡ry
 = 0;

442 
pRowSë
->
pLa°
 = 0;

444 
pRowSë
->
iB©ch
 = iBatch;

446 
p
 = 
pRowSë
->
pTªe
;

447  
p
 ){

448 
ªs
 = 
	`row£tE¡ryKeyCmp
(
p
, 
aKey
, 
nKey
);

449 if–
ªs
<0 ){

450 
p
 =Ö->
pRight
;

451 }if–
ªs
>0 ){

452 
p
 =Ö->
pLe·
;

458 
	}
}

	@src/select.c

15 
	~"sqlôeI¡.h
"

22 
	$˛órSñe˘
(
sqlôe4
 *
db
, 
Sñe˘
 *
p
){

23 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
p
->
pELi°
);

24 
	`sqlôe4SrcLi°Dñëe
(
db
, 
p
->
pSrc
);

25 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pWhîe
);

26 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
p
->
pGroupBy
);

27 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pHavög
);

28 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
p
->
pOrdîBy
);

29 
	`sqlôe4Sñe˘Dñëe
(
db
, 
p
->
pPri‹
);

30 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pLimô
);

31 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pOff£t
);

32 
	}
}

37 
	$sqlôe4Sñe˘De°Inô
(
Sñe˘De°
 *
pDe°
, 
eDe°
, 
iP¨m
){

38 
pDe°
->
eDe°
 = (
u8
)eDest;

39 
pDe°
->
iP¨m
 = iParm;

40 
pDe°
->
afföôy
 = 0;

41 
pDe°
->
iMem
 = 0;

42 
pDe°
->
nMem
 = 0;

43 
	}
}

50 
Sñe˘
 *
	$sqlôe4Sñe˘New
(

51 
P¨£
 *
pP¨£
,

52 
Ex¥Li°
 *
pELi°
,

53 
SrcLi°
 *
pSrc
,

54 
Ex¥
 *
pWhîe
,

55 
Ex¥Li°
 *
pGroupBy
,

56 
Ex¥
 *
pHavög
,

57 
Ex¥Li°
 *
pOrdîBy
,

58 
isDi°ö˘
,

59 
Ex¥
 *
pLimô
,

60 
Ex¥
 *
pOff£t


62 
Sñe˘
 *
pNew
;

63 
Sñe˘
 
°™dö
;

64 
sqlôe4
 *
db
 = 
pP¨£
->db;

65 
pNew
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (*pNew) );

66 
	`as£π
–
db
->
mÆlocFaûed
 || !
pOff£t
 || 
pLimô
 );

67 if–
pNew
==0 ){

68 
	`as£π
–
db
->
mÆlocFaûed
 );

69 
pNew
 = &
°™dö
;

70 
	`mem£t
(
pNew
, 0, (*pNew));

72 if–
pELi°
==0 ){

73 
pELi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4Ex¥
(
db
,
TK_ALL
,0));

75 
pNew
->
pELi°
 =ÖEList;

76 if–
pSrc
==0 )ÖSr¯
	`sqlôe4DbMÆlocZîo
(
db
, (*pSrc));

77 
pNew
->
pSrc
 =ÖSrc;

78 
pNew
->
pWhîe
 =ÖWhere;

79 
pNew
->
pGroupBy
 =ÖGroupBy;

80 
pNew
->
pHavög
 =ÖHaving;

81 
pNew
->
pOrdîBy
 =ÖOrderBy;

82 
pNew
->
£lFœgs
 = 
isDi°ö˘
 ? 
SF_Di°ö˘
 : 0;

83 
pNew
->
›
 = 
TK_SELECT
;

84 
pNew
->
pLimô
 =ÖLimit;

85 
pNew
->
pOff£t
 =ÖOffset;

86 
	`as£π
–
pOff£t
==0 || 
pLimô
!=0 );

87 
pNew
->
addrO≥nEphm
[0] = -1;

88 
pNew
->
addrO≥nEphm
[1] = -1;

89 
pNew
->
addrO≥nEphm
[2] = -1;

90 if–
db
->
mÆlocFaûed
 ) {

91 
	`˛órSñe˘
(
db
, 
pNew
);

92 if–
pNew
!=&
°™dö
 ) 
	`sqlôe4DbFªe
(
db
,ÖNew);

93 
pNew
 = 0;

95 
	`as£π
–
pNew
->
pSrc
!=0 || 
pP¨£
->
nEº
>0 );

97 
	`as£π
–
pNew
!=&
°™dö
 );

98  
pNew
;

99 
	}
}

104 
	$sqlôe4Sñe˘Dñëe
(
sqlôe4
 *
db
, 
Sñe˘
 *
p
){

105 if–
p
 ){

106 
	`˛órSñe˘
(
db
, 
p
);

107 
	`sqlôe4DbFªe
(
db
, 
p
);

109 
	}
}

128 
	$sqlôe4JoöTy≥
(
P¨£
 *
pP¨£
, 
Tokí
 *
pA
, Tokí *
pB
, Tokí *
pC
){

129 
joöty≥
 = 0;

130 
Tokí
 *
≠AŒ
[3];

131 
Tokí
 *
p
;

133 c⁄° 
zKeyText
[] = "naturaleftouterightfullinnercross";

135 
u8
 
i
;

136 
u8
 
nCh¨
;

137 
u8
 
code
;

138 } 
aKeyw‹d
[] = {

139  { 0, 7, 
JT_NATURAL
 },

140  { 6, 4, 
JT_LEFT
|
JT_OUTER
 },

141  { 10, 5, 
JT_OUTER
 },

142  { 14, 5, 
JT_RIGHT
|
JT_OUTER
 },

143  { 19, 4, 
JT_LEFT
|
JT_RIGHT
|
JT_OUTER
 },

144  { 23, 5, 
JT_INNER
 },

145  { 28, 5, 
JT_INNER
|
JT_CROSS
 },

147 
i
, 
j
;

148 
≠AŒ
[0] = 
pA
;

149 
≠AŒ
[1] = 
pB
;

150 
≠AŒ
[2] = 
pC
;

151 
i
=0; i<3 && 
≠AŒ
[i]; i++){

152 
p
 = 
≠AŒ
[
i
];

153 
j
=0; j<
	`AºaySize
(
aKeyw‹d
); j++){

154 if–
p
->
n
==
aKeyw‹d
[
j
].
nCh¨


155 && 
	`sqlôe4_°∫icmp
((*)
p
->
z
, &
zKeyText
[
aKeyw‹d
[
j
].
i
],Ö->
n
)==0 ){

156 
joöty≥
 |
aKeyw‹d
[
j
].
code
;

160 
	`ã°ˇ£
–
j
==0 || j==1 || j==2 || j==3 || j==4 || j==5 || j==6 );

161 if–
j
>=
	`AºaySize
(
aKeyw‹d
) ){

162 
joöty≥
 |
JT_ERROR
;

167 (
joöty≥
 & (
JT_INNER
|
JT_OUTER
))==(JT_INNER|JT_OUTER) ||

168 (
joöty≥
 & 
JT_ERROR
)!=0

170 c⁄° *
zSp
 = " ";

171 
	`as£π
–
pB
!=0 );

172 if–
pC
==0 ){ 
zSp
++; }

173 
	`sqlôe4Eº‹Msg
(
pP¨£
, "unknown or unsupported joinÅype: "

174 "%T %T%s%T", 
pA
, 
pB
, 
zSp
, 
pC
);

175 
joöty≥
 = 
JT_INNER
;

176 }if–(
joöty≥
 & 
JT_OUTER
)!=0

177 && (
joöty≥
 & (
JT_LEFT
|
JT_RIGHT
))!=JT_LEFT ){

178 
	`sqlôe4Eº‹Msg
(
pP¨£
,

180 
joöty≥
 = 
JT_INNER
;

182  
joöty≥
;

183 
	}
}

189 
	$cﬁumnIndex
(
TabÀ
 *
pTab
, c⁄° *
zCﬁ
){

190 
i
;

191 
i
=0; i<
pTab
->
nCﬁ
; i++){

192 if–
	`sqlôe4_°ricmp
(
pTab
->
aCﬁ
[
i
].
zName
, 
zCﬁ
)==0 )  i;

195 
	}
}

206 
	$èbÀAndCﬁumnIndex
(

207 
SrcLi°
 *
pSrc
,

208 
N
,

209 c⁄° *
zCﬁ
,

210 *
piTab
,

211 *
piCﬁ


213 
i
;

214 
iCﬁ
;

216 
	`as£π
–(
piTab
==0)==(
piCﬁ
==0) );

217 
i
=0; i<
N
; i++){

218 
iCﬁ
 = 
	`cﬁumnIndex
(
pSrc
->
a
[
i
].
pTab
, 
zCﬁ
);

219 if–
iCﬁ
>=0 ){

220 if–
piTab
 ){

221 *
piTab
 = 
i
;

222 *
piCﬁ
 = 
iCﬁ
;

228 
	}
}

241 
	$addWhîeTîm
(

242 
P¨£
 *
pP¨£
,

243 
SrcLi°
 *
pSrc
,

244 
iLe·
,

245 
iCﬁLe·
,

246 
iRight
,

247 
iCﬁRight
,

248 
isOuãrJoö
,

249 
Ex¥
 **
µWhîe


251 
sqlôe4
 *
db
 = 
pP¨£
->db;

252 
Ex¥
 *
pE1
;

253 
Ex¥
 *
pE2
;

254 
Ex¥
 *
pEq
;

256 
	`as£π
–
iLe·
<
iRight
 );

257 
	`as£π
–
pSrc
->
nSrc
>
iRight
 );

258 
	`as£π
–
pSrc
->
a
[
iLe·
].
pTab
 );

259 
	`as£π
–
pSrc
->
a
[
iRight
].
pTab
 );

261 
pE1
 = 
	`sqlôe4Cª©eCﬁumnEx¥
(
db
, 
pSrc
, 
iLe·
, 
iCﬁLe·
);

262 
pE2
 = 
	`sqlôe4Cª©eCﬁumnEx¥
(
db
, 
pSrc
, 
iRight
, 
iCﬁRight
);

264 
pEq
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_EQ
, 
pE1
, 
pE2
, 0);

265 if–
pEq
 && 
isOuãrJoö
 ){

266 
	`Ex¥SëPr›îty
(
pEq
, 
EP_FromJoö
);

267 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
pEq
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

268 
	`Ex¥SëIºeducibÀ
(
pEq
);

269 
pEq
->
iRightJoöTabÀ
 = (
i16
)
pE2
->
iTabÀ
;

271 *
µWhîe
 = 
	`sqlôe4Ex¥And
(
db
, *µWhîe, 
pEq
);

272 
	}
}

300 
	$£tJoöEx¥
(
Ex¥
 *
p
, 
iTabÀ
){

301  
p
 ){

302 
	`Ex¥SëPr›îty
(
p
, 
EP_FromJoö
);

303 
	`as£π
–!
	`Ex¥HasAnyPr›îty
(
p
, 
EP_TokíO∆y
|
EP_Redu˚d
) );

304 
	`Ex¥SëIºeducibÀ
(
p
);

305 
p
->
iRightJoöTabÀ
 = (
i16
)
iTabÀ
;

306 
	`£tJoöEx¥
(
p
->
pLe·
, 
iTabÀ
);

307 
p
 =Ö->
pRight
;

309 
	}
}

325 
	$sqlôePro˚ssJoö
(
P¨£
 *
pP¨£
, 
Sñe˘
 *
p
){

326 
SrcLi°
 *
pSrc
;

327 
i
, 
j
;

328 
SrcLi°Iãm
 *
pLe·
;

329 
SrcLi°Iãm
 *
pRight
;

331 
pSrc
 = 
p
->pSrc;

332 
pLe·
 = &
pSrc
->
a
[0];

333 
pRight
 = &
pLe·
[1];

334 
i
=0; i<
pSrc
->
nSrc
-1; i++, 
pRight
++, 
pLe·
++){

335 
TabÀ
 *
pLe·Tab
 = 
pLe·
->
pTab
;

336 
TabÀ
 *
pRightTab
 = 
pRight
->
pTab
;

337 
isOuãr
;

339 if–
	`NEVER
(
pLe·Tab
==0 || 
pRightTab
==0) ) ;

340 
isOuãr
 = (
pRight
->
joöty≥
 & 
JT_OUTER
)!=0;

345 if–
pRight
->
joöty≥
 & 
JT_NATURAL
 ){

346 if–
pRight
->
pOn
 ||ÖRight->
pUsög
 ){

347 
	`sqlôe4Eº‹Msg
(
pP¨£
, "a NATURAL join mayÇot have "

351 
j
=0; j<
pRightTab
->
nCﬁ
; j++){

352 *
zName
;

353 
iLe·
;

354 
iLe·Cﬁ
;

356 
zName
 = 
pRightTab
->
aCﬁ
[
j
].zName;

357 if–
	`èbÀAndCﬁumnIndex
(
pSrc
, 
i
+1, 
zName
, &
iLe·
, &
iLe·Cﬁ
) ){

358 
	`addWhîeTîm
(
pP¨£
, 
pSrc
, 
iLe·
, 
iLe·Cﬁ
, 
i
+1, 
j
,

359 
isOuãr
, &
p
->
pWhîe
);

366 if–
pRight
->
pOn
 &&ÖRight->
pUsög
 ){

367 
	`sqlôe4Eº‹Msg
(
pP¨£
, "cannot have both ONánd USING "

375 if–
pRight
->
pOn
 ){

376 if–
isOuãr
 ) 
	`£tJoöEx¥
(
pRight
->
pOn
,ÖRight->
iCurs‹
);

377 
p
->
pWhîe
 = 
	`sqlôe4Ex¥And
(
pP¨£
->
db
,Ö->pWhîe, 
pRight
->
pOn
);

378 
pRight
->
pOn
 = 0;

388 if–
pRight
->
pUsög
 ){

389 
IdLi°
 *
pLi°
 = 
pRight
->
pUsög
;

390 
j
=0; j<
pLi°
->
nId
; j++){

391 *
zName
;

392 
iLe·
;

393 
iLe·Cﬁ
;

394 
iRightCﬁ
;

396 
zName
 = 
pLi°
->
a
[
j
].zName;

397 
iRightCﬁ
 = 
	`cﬁumnIndex
(
pRightTab
, 
zName
);

398 if–
iRightCﬁ
<0

399 || !
	`èbÀAndCﬁumnIndex
(
pSrc
, 
i
+1, 
zName
, &
iLe·
, &
iLe·Cﬁ
)

401 
	`sqlôe4Eº‹Msg
(
pP¨£
, "cannot join using column %s - column "

402 "nŸÖª£¡ i¿bŸhÅabÀs", 
zName
);

405 
	`addWhîeTîm
(
pP¨£
, 
pSrc
, 
iLe·
, 
iLe·Cﬁ
, 
i
+1, 
iRightCﬁ
,

406 
isOuãr
, &
p
->
pWhîe
);

411 
	}
}

417 
	$pushO¡oS‹ãr
(

418 
P¨£
 *
pP¨£
,

419 
Ex¥Li°
 *
pOrdîBy
,

420 
Sñe˘
 *
pSñe˘
,

421 
ªgD©a


423 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

424 
nEx¥
 = 
pOrdîBy
->nExpr;

425 
ªgBa£
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nEx¥
+1);

426 
ªgKey
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

433 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

434 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pOrdîBy
, 
ªgBa£
, 0);

435 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Sequí˚
, 
pOrdîBy
->
iECurs‹
, 
ªgBa£
+
nEx¥
);

438 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgBa£
, 
nEx¥
+1, 
ªgKey
,

439 
pOrdîBy
->
iECurs‹
);

444 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
pOrdîBy
->
iECurs‹
, 
ªgD©a
, 
ªgKey
);

447 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgKey
);

448 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgBa£
, 
nEx¥
+1);

450 if–
pSñe˘
->
iLimô
 ){

451 
addr1
, 
addr2
;

452 
iLimô
;

453 if–
pSñe˘
->
iOff£t
 ){

454 
iLimô
 = 
pSñe˘
->
iOff£t
+1;

456 
iLimô
 = 
pSñe˘
->iLimit;

458 
addr1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfZîo
, 
iLimô
);

459 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
iLimô
, -1);

460 
addr2
 = 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_GŸo
);

461 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr1
);

462 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_La°
, 
pOrdîBy
->
iECurs‹
);

463 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Dñëe
, 
pOrdîBy
->
iECurs‹
);

464 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr2
);

466 
	}
}

471 
	$codeOff£t
(

472 
Vdbe
 *
v
,

473 
Sñe˘
 *
p
,

474 
iC⁄töue


476 if–
p
->
iOff£t
 && 
iC⁄töue
!=0 ){

477 
addr
;

478 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_AddImm
, 
p
->
iOff£t
, -1);

479 
addr
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfNeg
, 
p
->
iOff£t
);

480 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
iC⁄töue
);

481 
	`VdbeCommít
((
v
, "skip OFFSETÑecords"));

482 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr
);

484 
	}
}

495 
	$codeDi°ö˘
(

496 
P¨£
 *
pP¨£
,

497 
iTab
,

498 
addrRïót
,

499 
N
,

500 
iMem


502 
Vdbe
 *
v
;

503 
r1
, 
r2
;

505 
v
 = 
pP¨£
->
pVdbe
;

506 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

507 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

508 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_Found
, 
iTab
, 
addrRïót
, 
iMem
, 
N
);

509 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
iMem
, 
N
, 
r2
, 
iTab
);

510 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
iMem
, 
N
, 
r1
);

511 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_USEKEY
);

512 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iTab
, 
r1
, 
r2
);

513 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

514 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

515 
	}
}

517 #i‚de‡
SQLITE4_OMIT_SUBQUERY


525 
	$checkF‹Mu…iCﬁumnSñe˘Eº‹
(

526 
P¨£
 *
pP¨£
,

527 
Sñe˘De°
 *
pDe°
,

528 
nEx¥


530 
eDe°
 = 
pDe°
->eDest;

531 if–
nEx¥
>1 && (
eDe°
==
SRT_Mem
 ||ÉDe°==
SRT_Së
) ){

532 
	`sqlôe4Eº‹Msg
(
pP¨£
, "onlyá singleÑesultállowed for "

538 
	}
}

550 
	$£À˘I¬îLo›
(

551 
P¨£
 *
pP¨£
,

552 
Sñe˘
 *
p
,

553 
Ex¥Li°
 *
pELi°
,

554 
§cTab
,

555 
nCﬁumn
,

556 
Ex¥Li°
 *
pOrdîBy
,

557 
di°ö˘
,

558 
Sñe˘De°
 *
pDe°
,

559 
iC⁄töue
,

560 
iBªak


562 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

563 
i
;

564 
hasDi°ö˘
;

565 
ªgResu…
;

566 
eDe°
 = 
pDe°
->eDest;

567 
iP¨m
 = 
pDe°
->iParm;

568 
nResu…Cﬁ
;

570 
	`as£π
–
v
 );

571 if–
	`NEVER
(
v
==0) ) ;

572 
	`as£π
–
pELi°
!=0 );

573 
hasDi°ö˘
 = 
di°ö˘
>=0;

574 if–
pOrdîBy
==0 && !
hasDi°ö˘
 ){

575 
	`codeOff£t
(
v
, 
p
, 
iC⁄töue
);

580 if–
nCﬁumn
>0 ){

581 
nResu…Cﬁ
 = 
nCﬁumn
;

583 
nResu…Cﬁ
 = 
pELi°
->
nEx¥
;

585 if–
pDe°
->
iMem
==0 ){

586 
pDe°
->
iMem
 = 
pP¨£
->
nMem
+1;

587 
pDe°
->
nMem
 = 
nResu…Cﬁ
;

588 
pP¨£
->
nMem
 +
nResu…Cﬁ
;

590 
	`as£π
–
pDe°
->
nMem
==
nResu…Cﬁ
 );

592 
ªgResu…
 = 
pDe°
->
iMem
;

593 if–
nCﬁumn
>0 ){

594 
i
=0; i<
nCﬁumn
; i++){

595 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
§cTab
, 
i
, 
ªgResu…
+i);

597 }if–
eDe°
!=
SRT_Exi°s
 ){

601 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

602 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pELi°
, 
ªgResu…
, 
eDe°
==
SRT_Ouçut
);

604 
nCﬁumn
 = 
nResu…Cﬁ
;

610 if–
hasDi°ö˘
 ){

611 
	`as£π
–
pELi°
!=0 );

612 
	`as£π
–
pELi°
->
nEx¥
==
nCﬁumn
 );

613 
	`codeDi°ö˘
(
pP¨£
, 
di°ö˘
, 
iC⁄töue
, 
nCﬁumn
, 
ªgResu…
);

614 if–
pOrdîBy
==0 ){

615 
	`codeOff£t
(
v
, 
p
, 
iC⁄töue
);

619  
eDe°
 ){

623 #i‚de‡
SQLITE4_OMIT_COMPOUND_SELECT


624 
SRT_Uni⁄
: {

625 
r1
, 
r2
;

626 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

627 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

628 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgResu…
, 
nCﬁumn
, 
r2
, 
iP¨m
);

629 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgResu…
, 
nCﬁumn
, 
r1
);

630 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_USEKEY
);

631 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iP¨m
, 
r1
, 
r2
);

632 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

633 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

644 
SRT_Ex˚±
: {

645 
ªgKey
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

646 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgResu…
, 
nCﬁumn
, 
ªgKey
, 
iP¨m
);

647 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_IdxDñëe
, 
iP¨m
, 0, 
ªgKey
);

648 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgKey
);

655 
SRT_TabÀ
:

656 
SRT_EphemTab
: {

657 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

658 
	`ã°ˇ£
–
eDe°
==
SRT_TabÀ
 );

659 
	`ã°ˇ£
–
eDe°
==
SRT_EphemTab
 );

660 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgResu…
, 
nCﬁumn
, 
r1
);

661 if–
pOrdîBy
 ){

662 
	`pushO¡oS‹ãr
(
pP¨£
, 
pOrdîBy
, 
p
, 
r1
);

664 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

665 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
iP¨m
, 
r2
);

666 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iP¨m
, 
r1
, 
r2
);

667 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

669 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

673 #i‚de‡
SQLITE4_OMIT_SUBQUERY


678 
SRT_Së
: {

679 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

680 
	`as£π
–
nCﬁumn
==1 );

681 
p
->
afföôy
 = 
	`sqlôe4Com∑ªAfföôy
(
pELi°
->
a
[0].
pEx¥
, 
pDe°
->affinity);

682 if–
pOrdîBy
 ){

687 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_MakeRec‹d
, 
ªgResu…
, 1, 
r1
, &
p
->
afföôy
, 1);

688 
	`pushO¡oS‹ãr
(
pP¨£
, 
pOrdîBy
, 
p
, 
r1
);

690 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

691 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Afföôy
, 
ªgResu…
, 1, 0, &
p
->
afföôy
, 1);

692 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgResu…
, 1, 
r2
, 
iP¨m
);

693 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
ªgResu…
, 1);

694 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgResu…
, 1, 
r1
);

695 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_USEKEY
);

696 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iP¨m
, 
r1
, 
r2
);

697 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

699 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

705 
SRT_Exi°s
: {

706 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
iP¨m
);

715 
SRT_Mem
: {

716 
	`as£π
–
nCﬁumn
==1 );

717 if–
pOrdîBy
 ){

718 
ªgRec‹d
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

719 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgResu…
, 1, 
ªgRec‹d
);

720 
	`pushO¡oS‹ãr
(
pP¨£
, 
pOrdîBy
, 
p
, 
ªgRec‹d
);

721 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgRec‹d
);

723 
	`sqlôe4Ex¥CodeMove
(
pP¨£
, 
ªgResu…
, 
iP¨m
, 1);

734 
SRT_C‹outöe
:

735 
SRT_Ouçut
: {

736 
	`ã°ˇ£
–
eDe°
==
SRT_C‹outöe
 );

737 
	`ã°ˇ£
–
eDe°
==
SRT_Ouçut
 );

738 if–
pOrdîBy
 ){

739 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

740 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgResu…
, 
nCﬁumn
, 
r1
);

741 
	`pushO¡oS‹ãr
(
pP¨£
, 
pOrdîBy
, 
p
, 
r1
);

742 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

743 }if–
eDe°
==
SRT_C‹outöe
 ){

744 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
pDe°
->
iP¨m
);

746 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
ªgResu…
, 
nCﬁumn
);

747 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
ªgResu…
, 
nCﬁumn
);

752 #i‡!
	`deföed
(
SQLITE4_OMIT_TRIGGER
)

759 
	`as£π
–
eDe°
==
SRT_Disˇrd
 );

769 if–
pOrdîBy
==0 && 
p
->
iLimô
 ){

770 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_IfZîo
, 
p
->
iLimô
, 
iBªak
, -1);

772 
	}
}

789 
KeyInfo
 *
	$keyInfoFromEx¥Li°
(

790 
P¨£
 *
pP¨£
,

791 
Ex¥Li°
 *
pLi°
,

792 
bOrdîBy


794 
sqlôe4
 *
db
 = 
pP¨£
->db;

795 
nFõld
;

796 
KeyInfo
 *
pInfo
;

797 
nByã
;

799 
	`as£π
–
bOrdîBy
==0 || bOrderBy==1 );

801 
nFõld
 = 
pLi°
->
nEx¥
 + 
bOrdîBy
;

802 
nByã
 = (
KeyInfo
Ë+ 
nFõld
 * (
CﬁlSeq
 *) +ÇField;

803 
pInfo
 = (
KeyInfo
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

805 if–
pInfo
 ){

806 
i
;

808 
pInfo
->
aS‹tOrdî
 = (
u8
*)&pInfo->
aCﬁl
[
nFõld
];

809 
pInfo
->
nFõld
 = (
u16
)nField;

811 
i
=0; i<
pLi°
->
nEx¥
; i++){

812 
CﬁlSeq
 *
pCﬁl
;

813 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pLi°
->
a
[
i
].
pEx¥
);

814 if–!
pCﬁl
 )ÖCﬁ»
db
->
pDÊtCﬁl
;

815 
pInfo
->
aCﬁl
[
i
] = 
pCﬁl
;

816 
pInfo
->
aS‹tOrdî
[
i
] = 
pLi°
->
a
[i].
s‹tOrdî
;

819  
pInfo
;

820 
	}
}

822 #i‚de‡
SQLITE4_OMIT_COMPOUND_SELECT


826 c⁄° *
	$£À˘OpName
(
id
){

827 *
z
;

828  
id
 ){

829 
TK_ALL
: 
z
 = "UNION ALL"; ;

830 
TK_INTERSECT
: 
z
 = "INTERSECT"; ;

831 
TK_EXCEPT
: 
z
 = "EXCEPT"; ;

832 : 
z
 = "UNION"; ;

834  
z
;

835 
	}
}

838 #i‚de‡
SQLITE4_OMIT_EXPLAIN


849 
	$ex∂aöTempTabÀ
(
P¨£
 *
pP¨£
, c⁄° *
zUßge
){

850 if–
pP¨£
->
ex∂aö
==2 ){

851 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

852 *
zMsg
 = 
	`sqlôe4MPrötf
(
pP¨£
->
db
, "USE TEMP B-TREE FOR %s", 
zUßge
);

853 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Ex∂aö
, 
pP¨£
->
iSñe˘Id
, 0, 0, 
zMsg
, 
P4_DYNAMIC
);

855 
	}
}

864 
	#ex∂aöSëI¡egî
(
a
, 
b
Ë®
	)
b

868 
	#ex∂aöTempTabÀ
(
y
,
z
)

	)

869 
	#ex∂aöSëI¡egî
(
y
,
z
)

	)

872 #i‡!
deföed
(
SQLITE4_OMIT_EXPLAIN
Ë&& !deföed(
SQLITE4_OMIT_COMPOUND_SELECT
)

887 
	$ex∂aöComposôe
(

888 
P¨£
 *
pP¨£
,

889 
›
,

890 
iSub1
,

891 
iSub2
,

892 
bU£Tmp


894 
	`as£π
–
›
==
TK_UNION
 || op==
TK_EXCEPT
 || op==
TK_INTERSECT
 || op==
TK_ALL
 );

895 if–
pP¨£
->
ex∂aö
==2 ){

896 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

897 *
zMsg
 = 
	`sqlôe4MPrötf
(

898 
pP¨£
->
db
, "COMPOUND SUBQUERIES %d AND %d %s(%s)", 
iSub1
, 
iSub2
,

899 
bU£Tmp
?"USING TEMP B-TREE ":"", 
	`£À˘OpName
(
›
)

901 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Ex∂aö
, 
pP¨£
->
iSñe˘Id
, 0, 0, 
zMsg
, 
P4_DYNAMIC
);

903 
	}
}

906 
	#ex∂aöComposôe
(
v
,
w
,
x
,
y
,
z
)

	)

915 
	$gíî©eS‹tTaû
(

916 
P¨£
 *
pP¨£
,

917 
Sñe˘
 *
p
,

918 
Vdbe
 *
v
,

919 
nCﬁumn
,

920 
Sñe˘De°
 *
pDe°


922 
addrBªak
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

923 
addrC⁄töue
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

924 
addr
;

925 
iTab
;

926 
Ex¥Li°
 *
pOrdîBy
 = 
p
->pOrderBy;

927 
eDe°
 = 
pDe°
->eDest;

928 
iP¨m
 = 
pDe°
->iParm;

929 
›
;

931 
iTab
 = 
pOrdîBy
->
iECurs‹
;

932 
›
 = (
p
->
£lFœgs
 & 
SF_U£S‹ãr
Ë? 
OP_S‹ãrS‹t
 : 
OP_S‹t
;

933 
addr
 = 1 + 
	`sqlôe4VdbeAddOp2
(
v
, 
›
, 
iTab
, 
addrBªak
);

934 
	`codeOff£t
(
v
, 
p
, 
addrC⁄töue
);

935  
eDe°
 ){

936 
SRT_TabÀ
:

937 
SRT_EphemTab
: {

938 
ªgRowid
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

939 
ªgRow
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

940 
	`ã°ˇ£
–
eDe°
==
SRT_TabÀ
 );

941 
	`ã°ˇ£
–
eDe°
==
SRT_EphemTab
 );

942 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
iP¨m
, 
ªgRowid
);

943 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowD©a
, 
iTab
, 
ªgRow
);

944 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iP¨m
, 
ªgRow
, 
ªgRowid
);

945 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgRow
);

946 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgRowid
);

949 #i‚de‡
SQLITE4_OMIT_SUBQUERY


950 
SRT_Së
: {

951 
ªgRes
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

952 
ªgKey
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

953 
ªgVÆue
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

954 
	`as£π
–
nCﬁumn
==1 );

955 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iTab
, 0, 
ªgRes
);

956 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Afföôy
, 
ªgRes
, 1, 0, &
p
->
afföôy
, 1);

957 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgRes
, 1, 
ªgKey
, 
iP¨m
);

958 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
ªgRes
, 1);

959 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgRes
, 1, 
ªgVÆue
);

960 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_USEKEY
);

961 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
iP¨m
, 
ªgVÆue
, 
ªgKey
);

962 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgKey
);

963 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgRes
);

964 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgVÆue
);

967 
SRT_Mem
: {

968 
	`as£π
–
nCﬁumn
==1 );

969 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iTab
, 0, 
iP¨m
);

975 
i
;

976 
	`as£π
–
eDe°
==
SRT_Ouçut
 ||ÉDe°==
SRT_C‹outöe
 );

977 
	`ã°ˇ£
–
eDe°
==
SRT_Ouçut
 );

978 
	`ã°ˇ£
–
eDe°
==
SRT_C‹outöe
 );

982 
i
=0; i<
nCﬁumn
; i++){

983 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iTab
, 
i
, 
pDe°
->
iMem
+i);

986 if–
eDe°
==
SRT_Ouçut
 ){

987 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
pDe°
->
iMem
, 
nCﬁumn
);

988 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
pDe°
->
iMem
, 
nCﬁumn
);

990 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
pDe°
->
iP¨m
);

998 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
addrC⁄töue
);

999 if–
p
->
£lFœgs
 & 
SF_U£S‹ãr
 ){

1000 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_S‹ãrNext
, 
iTab
, 
addr
);

1002 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
iTab
, 
addr
);

1004 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
addrBªak
);

1005 
	}
}

1025 c⁄° *
	$cﬁumnTy≥
(

1026 
NameC⁄ãxt
 *
pNC
,

1027 
Ex¥
 *
pEx¥
,

1028 c⁄° **
pzOrigöDb
,

1029 c⁄° **
pzOrigöTab
,

1030 c⁄° **
pzOrigöCﬁ


1032 c⁄° *
zTy≥
 = 0;

1033 c⁄° *
zOrigöDb
 = 0;

1034 c⁄° *
zOrigöTab
 = 0;

1035 c⁄° *
zOrigöCﬁ
 = 0;

1036 
j
;

1037 if–
	`NEVER
(
pEx¥
==0Ë|| 
pNC
->
pSrcLi°
==0 )  0;

1039  
pEx¥
->
›
 ){

1040 
TK_AGG_COLUMN
:

1041 
TK_COLUMN
: {

1046 
TabÀ
 *
pTab
 = 0;

1047 
Sñe˘
 *
pS
 = 0;

1048 
iCﬁ
 = 
pEx¥
->
iCﬁumn
;

1049 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_AGG_COLUMN
 );

1050 
	`ã°ˇ£
–
pEx¥
->
›
==
TK_COLUMN
 );

1051  
pNC
 && !
pTab
 ){

1052 
SrcLi°
 *
pTabLi°
 = 
pNC
->
pSrcLi°
;

1053 
j
=0;j<
pTabLi°
->
nSrc
 &&ÖTabLi°->
a
[j].
iCurs‹
!=
pEx¥
->
iTabÀ
;j++);

1054 if–
j
<
pTabLi°
->
nSrc
 ){

1055 
pTab
 = 
pTabLi°
->
a
[
j
].pTab;

1056 
pS
 = 
pTabLi°
->
a
[
j
].
pSñe˘
;

1058 
pNC
 =ÖNC->
pNext
;

1062 if–
pTab
==0 ){

1083 
	`as£π
–
pTab
 && 
pEx¥
->pTab==pTab );

1084 if–
pS
 ){

1089 if–
iCﬁ
>=0 && 
	`ALWAYS
(iCﬁ<
pS
->
pELi°
->
nEx¥
) ){

1094 
NameC⁄ãxt
 
sNC
;

1095 
Ex¥
 *
p
 = 
pS
->
pELi°
->
a
[
iCﬁ
].
pEx¥
;

1096 
sNC
.
pSrcLi°
 = 
pS
->
pSrc
;

1097 
sNC
.
pNext
 = 
pNC
;

1098 
sNC
.
pP¨£
 = 
pNC
->pParse;

1099 
zTy≥
 = 
	`cﬁumnTy≥
(&
sNC
, 
p
, &
zOrigöDb
, &
zOrigöTab
, &
zOrigöCﬁ
);

1101 }if–
	`ALWAYS
(
pTab
->
pSchema
) ){

1103 
	`as£π
–!
pS
 );

1104 
	`as£π
–
iCﬁ
==-1 || (iCﬁ>=0 && iCﬁ<
pTab
->
nCﬁ
) );

1105 if–
iCﬁ
<0 ){

1106 
zTy≥
 = "INTEGER";

1107 
zOrigöCﬁ
 = "rowid";

1109 
zTy≥
 = 
pTab
->
aCﬁ
[
iCﬁ
].zType;

1110 
zOrigöCﬁ
 = 
pTab
->
aCﬁ
[
iCﬁ
].
zName
;

1112 
zOrigöTab
 = 
pTab
->
zName
;

1113 if–
pNC
->
pP¨£
 ){

1114 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pNC
->
pP¨£
->
db
, 
pTab
->
pSchema
);

1115 
zOrigöDb
 = 
pNC
->
pP¨£
->
db
->
aDb
[
iDb
].
zName
;

1120 #i‚de‡
SQLITE4_OMIT_SUBQUERY


1121 
TK_SELECT
: {

1126 
NameC⁄ãxt
 
sNC
;

1127 
Sñe˘
 *
pS
 = 
pEx¥
->
x
.
pSñe˘
;

1128 
Ex¥
 *
p
 = 
pS
->
pELi°
->
a
[0].
pEx¥
;

1129 
	`as£π
–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) );

1130 
sNC
.
pSrcLi°
 = 
pS
->
pSrc
;

1131 
sNC
.
pNext
 = 
pNC
;

1132 
sNC
.
pP¨£
 = 
pNC
->pParse;

1133 
zTy≥
 = 
	`cﬁumnTy≥
(&
sNC
, 
p
, &
zOrigöDb
, &
zOrigöTab
, &
zOrigöCﬁ
);

1139 if–
pzOrigöDb
 ){

1140 
	`as£π
–
pzOrigöTab
 && 
pzOrigöCﬁ
 );

1141 *
pzOrigöDb
 = 
zOrigöDb
;

1142 *
pzOrigöTab
 = 
zOrigöTab
;

1143 *
pzOrigöCﬁ
 = 
zOrigöCﬁ
;

1145  
zTy≥
;

1146 
	}
}

1152 
	$gíî©eCﬁumnTy≥s
(

1153 
P¨£
 *
pP¨£
,

1154 
SrcLi°
 *
pTabLi°
,

1155 
Ex¥Li°
 *
pELi°


1157 #i‚de‡
SQLITE4_OMIT_DECLTYPE


1158 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1159 
i
;

1160 
NameC⁄ãxt
 
sNC
;

1161 
sNC
.
pSrcLi°
 = 
pTabLi°
;

1162 
sNC
.
pP¨£
 =ÖParse;

1163 
i
=0; i<
pELi°
->
nEx¥
; i++){

1164 
Ex¥
 *
p
 = 
pELi°
->
a
[
i
].
pEx¥
;

1165 c⁄° *
zTy≥
;

1166 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


1167 c⁄° *
zOrigDb
 = 0;

1168 c⁄° *
zOrigTab
 = 0;

1169 c⁄° *
zOrigCﬁ
 = 0;

1170 
zTy≥
 = 
	`cﬁumnTy≥
(&
sNC
, 
p
, &
zOrigDb
, &
zOrigTab
, &
zOrigCﬁ
);

1176 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_DATABASE
, 
zOrigDb
, 
SQLITE4_TRANSIENT
);

1177 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_TABLE
, 
zOrigTab
, 
SQLITE4_TRANSIENT
);

1178 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_COLUMN
, 
zOrigCﬁ
, 
SQLITE4_TRANSIENT
);

1180 
zTy≥
 = 
	`cﬁumnTy≥
(&
sNC
, 
p
, 0, 0, 0);

1182 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_DECLTYPE
, 
zTy≥
, 
SQLITE4_TRANSIENT
);

1185 
	}
}

1192 
	$gíî©eCﬁumnNames
(

1193 
P¨£
 *
pP¨£
,

1194 
SrcLi°
 *
pTabLi°
,

1195 
Ex¥Li°
 *
pELi°


1197 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1198 
i
, 
j
;

1199 
sqlôe4
 *
db
 = 
pP¨£
->db;

1201 #i‚de‡
SQLITE4_OMIT_EXPLAIN


1203 if–
pP¨£
->
ex∂aö
 ){

1208 if–
pP¨£
->
cﬁNamesSë
 || 
	`NEVER
(
v
==0Ë|| 
db
->
mÆlocFaûed
 ) ;

1209 
pP¨£
->
cﬁNamesSë
 = 1;

1210 
	`sqlôe4VdbeSëNumCﬁs
(
v
, 
pELi°
->
nEx¥
);

1211 
i
=0; i<
pELi°
->
nEx¥
; i++){

1212 
Ex¥
 *
p
;

1213 
p
 = 
pELi°
->
a
[
i
].
pEx¥
;

1214 if–
	`NEVER
(
p
==0) ) ;

1215 if–
pELi°
->
a
[
i
].
zName
 ){

1216 *
zName
 = 
pELi°
->
a
[
i
].zName;

1217 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_NAME
, 
zName
, 
SQLITE4_TRANSIENT
);

1218 }if–(
p
->
›
==
TK_COLUMN
 ||Ö->›==
TK_AGG_COLUMN
Ë&& 
pTabLi°
 ){

1219 
TabÀ
 *
pTab
;

1220 *
zCﬁ
;

1221 
iCﬁ
 = 
p
->
iCﬁumn
;

1222 
j
=0; 
	`ALWAYS
(j<
pTabLi°
->
nSrc
); j++){

1223 if–
pTabLi°
->
a
[
j
].
iCurs‹
==
p
->
iTabÀ
 ) ;

1225 
	`as£π
–
j
<
pTabLi°
->
nSrc
 );

1226 
pTab
 = 
pTabLi°
->
a
[
j
].pTab;

1227 
	`as£π
–
iCﬁ
==-1 || (iCﬁ>=0 && iCﬁ<
pTab
->
nCﬁ
) );

1228 if–
iCﬁ
<0 ){

1229 
zCﬁ
 = "rowid";

1231 
zCﬁ
 = 
pTab
->
aCﬁ
[
iCﬁ
].
zName
;

1233 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_NAME
, 
zCﬁ
, 
SQLITE4_TRANSIENT
);

1235 
	`sqlôe4VdbeSëCﬁName
(
v
, 
i
, 
COLNAME_NAME
,

1236 
	`sqlôe4DbSåDup
(
db
, 
pELi°
->
a
[
i
].
zS∑n
), 
SQLITE4_DYNAMIC
);

1239 
	`gíî©eCﬁumnTy≥s
(
pP¨£
, 
pTabLi°
, 
pELi°
);

1240 
	}
}

1255 
	$£À˘CﬁumnsFromEx¥Li°
(

1256 
P¨£
 *
pP¨£
,

1257 
Ex¥Li°
 *
pELi°
,

1258 *
≤Cﬁ
,

1259 
Cﬁumn
 **
∑Cﬁ


1261 
sqlôe4
 *
db
 = 
pP¨£
->db;

1262 
i
, 
j
;

1263 
˙t
;

1264 
Cﬁumn
 *
aCﬁ
, *
pCﬁ
;

1265 
nCﬁ
;

1266 
Ex¥
 *
p
;

1267 *
zName
;

1268 
nName
;

1270 *
≤Cﬁ
 = 
nCﬁ
 = 
pELi°
 ?ÖELi°->
nEx¥
 : 0;

1271 
aCﬁ
 = *
∑Cﬁ
 = 
	`sqlôe4DbMÆlocZîo
(
db
, ◊Cﬁ[0])*
nCﬁ
);

1272 if–
aCﬁ
==0 )  
SQLITE4_NOMEM
;

1273 
i
=0, 
pCﬁ
=
aCﬁ
; i<
nCﬁ
; i++,ÖCol++){

1276 
p
 = 
pELi°
->
a
[
i
].
pEx¥
;

1277 
	`as£π
–
p
->
pRight
==0 || 
	`Ex¥HasPr›îty
’->pRight, 
EP_I¡VÆue
)

1278 || 
p
->
pRight
->
u
.
zTokí
==0 ||Ö->pRight->u.zToken[0]!=0 );

1279 if–(
zName
 = 
pELi°
->
a
[
i
].zName)!=0 ){

1281 
zName
 = 
	`sqlôe4DbSåDup
(
db
, zName);

1283 
Ex¥
 *
pCﬁEx¥
 = 
p
;

1284 
TabÀ
 *
pTab
;

1285  
pCﬁEx¥
->
›
==
TK_DOT
 ){

1286 
pCﬁEx¥
 =ÖCﬁEx¥->
pRight
;

1287 
	`as£π
–
pCﬁEx¥
!=0 );

1289 if–
pCﬁEx¥
->
›
==
TK_COLUMN
 && 
	`ALWAYS
’CﬁEx¥->
pTab
!=0) ){

1291 
iCﬁ
 = 
pCﬁEx¥
->
iCﬁumn
;

1292 
pTab
 = 
pCﬁEx¥
->pTab;

1293 
zName
 = 
	`sqlôe4MPrötf
(
db
, "%s",

1294 
iCﬁ
>=0 ? 
pTab
->
aCﬁ
[iCﬁ].
zName
 : "rowid");

1295 }if–
pCﬁEx¥
->
›
==
TK_ID
 ){

1296 
	`as£π
–!
	`Ex¥HasPr›îty
(
pCﬁEx¥
, 
EP_I¡VÆue
) );

1297 
zName
 = 
	`sqlôe4MPrötf
(
db
, "%s", 
pCﬁEx¥
->
u
.
zTokí
);

1300 
zName
 = 
	`sqlôe4MPrötf
(
db
, "%s", 
pELi°
->
a
[
i
].
zS∑n
);

1303 if–
db
->
mÆlocFaûed
 ){

1304 
	`sqlôe4DbFªe
(
db
, 
zName
);

1311 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

1312 
j
=
˙t
=0; j<
i
; j++){

1313 if–
	`sqlôe4_°ricmp
(
aCﬁ
[
j
].
zName
, zName)==0 ){

1314 *
zNewName
;

1315 
zName
[
nName
] = 0;

1316 
zNewName
 = 
	`sqlôe4MPrötf
(
db
, "%s:%d", 
zName
, ++
˙t
);

1317 
	`sqlôe4DbFªe
(
db
, 
zName
);

1318 
zName
 = 
zNewName
;

1319 
j
 = -1;

1320 if–
zName
==0 ) ;

1323 
pCﬁ
->
zName
 = zName;

1325 if–
db
->
mÆlocFaûed
 ){

1326 
j
=0; j<
i
; j++){

1327 
	`sqlôe4DbFªe
(
db
, 
aCﬁ
[
j
].
zName
);

1329 
	`sqlôe4DbFªe
(
db
, 
aCﬁ
);

1330 *
∑Cﬁ
 = 0;

1331 *
≤Cﬁ
 = 0;

1332  
SQLITE4_NOMEM
;

1334  
SQLITE4_OK
;

1335 
	}
}

1348 
	$£À˘AddCﬁumnTy≥AndCﬁœti⁄
(

1349 
P¨£
 *
pP¨£
,

1350 
nCﬁ
,

1351 
Cﬁumn
 *
aCﬁ
,

1352 
Sñe˘
 *
pSñe˘


1354 
sqlôe4
 *
db
 = 
pP¨£
->db;

1355 
NameC⁄ãxt
 
sNC
;

1356 
Cﬁumn
 *
pCﬁ
;

1357 
CﬁlSeq
 *
pCﬁl
;

1358 
i
;

1359 
Ex¥
 *
p
;

1360 
Ex¥Li°Iãm
 *
a
;

1362 
	`as£π
–
pSñe˘
!=0 );

1363 
	`as£π
–(
pSñe˘
->
£lFœgs
 & 
SF_Resﬁved
)!=0 );

1364 
	`as£π
–
nCﬁ
==
pSñe˘
->
pELi°
->
nEx¥
 || 
db
->
mÆlocFaûed
 );

1365 if–
db
->
mÆlocFaûed
 ) ;

1366 
	`mem£t
(&
sNC
, 0, (sNC));

1367 
sNC
.
pSrcLi°
 = 
pSñe˘
->
pSrc
;

1368 
a
 = 
pSñe˘
->
pELi°
->a;

1369 
i
=0, 
pCﬁ
=
aCﬁ
; i<
nCﬁ
; i++,ÖCol++){

1370 
p
 = 
a
[
i
].
pEx¥
;

1371 
pCﬁ
->
zTy≥
 = 
	`sqlôe4DbSåDup
(
db
, 
	`cﬁumnTy≥
(&
sNC
, 
p
, 0, 0, 0));

1372 
pCﬁ
->
afföôy
 = 
	`sqlôe4Ex¥Afföôy
(
p
);

1373 if–
pCﬁ
->
afföôy
==0 )ÖCﬁ->afföôy = 
SQLITE4_AFF_NONE
;

1374 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
p
);

1375 if–
pCﬁl
 ){

1376 
pCﬁ
->
zCﬁl
 = 
	`sqlôe4DbSåDup
(
db
, 
pCﬁl
->
zName
);

1379 
	}
}

1385 
TabÀ
 *
	$sqlôe4Resu…SëOfSñe˘
(
P¨£
 *
pP¨£
, 
Sñe˘
 *
pSñe˘
){

1386 
TabÀ
 *
pTab
;

1387 
sqlôe4
 *
db
 = 
pP¨£
->db;

1389 
	`sqlôe4Sñe˘Pªp
(
pP¨£
, 
pSñe˘
, 0);

1390 if–
pP¨£
->
nEº
 )  0;

1391  
pSñe˘
->
pPri‹
 )ÖSelect =ÖSelect->pPrior;

1392 
pTab
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
TabÀ
) );

1393 if–
pTab
==0 ){

1398 
	`as£π
–
db
->
lookaside
.
bE«bÀd
==0 );

1399 
pTab
->
nRef
 = 1;

1400 
pTab
->
zName
 = 0;

1401 
pTab
->
nRowE°
 = 1000000;

1402 
	`£À˘CﬁumnsFromEx¥Li°
(
pP¨£
, 
pSñe˘
->
pELi°
, &
pTab
->
nCﬁ
, &pTab->
aCﬁ
);

1403 
	`£À˘AddCﬁumnTy≥AndCﬁœti⁄
(
pP¨£
, 
pTab
->
nCﬁ
,ÖTab->
aCﬁ
, 
pSñe˘
);

1404 if–
db
->
mÆlocFaûed
 ){

1405 
	`sqlôe4DñëeTabÀ
(
db
, 
pTab
);

1408  
pTab
;

1409 
	}
}

1415 
Vdbe
 *
	$sqlôe4GëVdbe
(
P¨£
 *
pP¨£
){

1416 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1417 if–
v
==0 ){

1418 
v
 = 
pP¨£
->
pVdbe
 = 
	`sqlôe4VdbeCª©e
’P¨£->
db
);

1419 #i‚de‡
SQLITE4_OMIT_TRACE


1420 if–
v
 ){

1421 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_Tø˚
);

1425  
v
;

1426 
	}
}

1447 
	$compuãLimôRegi°îs
(
P¨£
 *
pP¨£
, 
Sñe˘
 *
p
, 
iBªak
){

1448 
Vdbe
 *
v
 = 0;

1449 
iLimô
 = 0;

1450 
iOff£t
;

1451 
addr1
, 
n
;

1452 if–
p
->
iLimô
 ) ;

1460 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

1461 
	`as£π
–
p
->
pOff£t
==0 ||Ö->
pLimô
!=0 );

1462 if–
p
->
pLimô
 ){

1463 
p
->
iLimô
 = iLimô = ++
pP¨£
->
nMem
;

1464 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1465 if–
	`NEVER
(
v
==0) ) ;

1466 if–
	`sqlôe4Ex¥IsI¡egî
(
p
->
pLimô
, &
n
) ){

1467 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
n
, 
iLimô
);

1468 
	`VdbeCommít
((
v
, "LIMIT counter"));

1469 if–
n
==0 ){

1470 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
iBªak
);

1472 if–
p
->
nSñe˘Row
 > ()
n
 )Ö->nSelectRow = ()n;

1475 
	`sqlôe4Ex¥Code
(
pP¨£
, 
p
->
pLimô
, 
iLimô
);

1476 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Mu°BeI¡
, 
iLimô
);

1477 
	`VdbeCommít
((
v
, "LIMIT counter"));

1478 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IfZîo
, 
iLimô
, 
iBªak
);

1480 if–
p
->
pOff£t
 ){

1481 
p
->
iOff£t
 = iOff£à++
pP¨£
->
nMem
;

1482 
pP¨£
->
nMem
++;

1483 
	`sqlôe4Ex¥Code
(
pP¨£
, 
p
->
pOff£t
, 
iOff£t
);

1484 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Mu°BeI¡
, 
iOff£t
);

1485 
	`VdbeCommít
((
v
, "OFFSET counter"));

1486 
addr1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfPos
, 
iOff£t
);

1487 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
iOff£t
);

1488 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr1
);

1489 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Add
, 
iLimô
, 
iOff£t
, iOffset+1);

1490 
	`VdbeCommít
((
v
, "LIMIT+OFFSET"));

1491 
addr1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfPos
, 
iLimô
);

1492 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, -1, 
iOff£t
+1);

1493 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr1
);

1496 
	}
}

1498 #i‚de‡
SQLITE4_OMIT_COMPOUND_SELECT


1507 
CﬁlSeq
 *
	$mu…iSñe˘CﬁlSeq
(
P¨£
 *
pP¨£
, 
Sñe˘
 *
p
, 
iCﬁ
){

1508 
CﬁlSeq
 *
pRë
;

1509 if–
p
->
pPri‹
 ){

1510 
pRë
 = 
	`mu…iSñe˘CﬁlSeq
(
pP¨£
, 
p
->
pPri‹
, 
iCﬁ
);

1512 
pRë
 = 0;

1514 
	`as£π
–
iCﬁ
>=0 );

1515 if–
pRë
==0 && 
iCﬁ
<
p
->
pELi°
->
nEx¥
 ){

1516 
pRë
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
p
->
pELi°
->
a
[
iCﬁ
].
pEx¥
);

1518  
pRë
;

1519 
	}
}

1523 
mu…iSñe˘OrdîBy
(

1524 
P¨£
 *
pP¨£
,

1525 
Sñe˘
 *
p
,

1526 
Sñe˘De°
 *
pDe°


1530 #i‚de‡
SQLITE4_OMIT_COMPOUND_SELECT


1562 
	$mu…iSñe˘
(

1563 
P¨£
 *
pP¨£
,

1564 
Sñe˘
 *
p
,

1565 
Sñe˘De°
 *
pDe°


1567 
rc
 = 
SQLITE4_OK
;

1568 
Sñe˘
 *
pPri‹
;

1569 
Vdbe
 *
v
;

1570 
Sñe˘De°
 
de°
;

1571 
Sñe˘
 *
pDñëe
 = 0;

1572 
sqlôe4
 *
db
;

1573 #i‚de‡
SQLITE4_OMIT_EXPLAIN


1574 
iSub1
;

1575 
iSub2
;

1581 
	`as£π
–
p
 &&Ö->
pPri‹
 );

1582 
db
 = 
pP¨£
->db;

1583 
pPri‹
 = 
p
->pPrior;

1584 
	`as£π
–
pPri‹
->
pRightmo°
!=pPrior );

1585 
	`as£π
–
pPri‹
->
pRightmo°
==
p
->pRightmost );

1586 
de°
 = *
pDe°
;

1587 if–
pPri‹
->
pOrdîBy
 ){

1588 
	`sqlôe4Eº‹Msg
(
pP¨£
,"ORDER BY clause should comeáfter %sÇot before",

1589 
	`£À˘OpName
(
p
->
›
));

1590 
rc
 = 1;

1591 
mu…i_£À˘_íd
;

1593 if–
pPri‹
->
pLimô
 ){

1594 
	`sqlôe4Eº‹Msg
(
pP¨£
,"LIMIT clause should comeáfter %sÇot before",

1595 
	`£À˘OpName
(
p
->
›
));

1596 
rc
 = 1;

1597 
mu…i_£À˘_íd
;

1600 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

1601 
	`as£π
–
v
!=0 );

1605 if–
de°
.
eDe°
==
SRT_EphemTab
 ){

1606 
	`as£π
–
p
->
pELi°
 );

1607 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
de°
.
iP¨m
, 
p
->
pELi°
->
nEx¥
);

1608 
de°
.
eDe°
 = 
SRT_TabÀ
;

1614 
	`as£π
–
p
->
pELi°
 && 
pPri‹
->pEList );

1615 if–
p
->
pELi°
->
nEx¥
!=
pPri‹
->pEList->nExpr ){

1616 if–
p
->
£lFœgs
 & 
SF_VÆues
 ){

1617 
	`sqlôe4Eº‹Msg
(
pP¨£
, "all VALUES must haveÅhe sameÇumber ofÅerms");

1619 
	`sqlôe4Eº‹Msg
(
pP¨£
, "SELECTsÅoÅheÜeftándÑight of %s"

1620 " dÿnŸ havêthêßmênumbî o‡ªsu… cﬁumns", 
	`£À˘OpName
(
p
->
›
));

1622 
rc
 = 1;

1623 
mu…i_£À˘_íd
;

1628 if–
p
->
pOrdîBy
 ){

1629  
	`mu…iSñe˘OrdîBy
(
pP¨£
, 
p
, 
pDe°
);

1634  
p
->
›
 ){

1635 
TK_ALL
: {

1636 
addr
 = 0;

1637 
nLimô
;

1638 
	`as£π
–!
pPri‹
->
pLimô
 );

1639 
pPri‹
->
pLimô
 = 
p
->pLimit;

1640 
pPri‹
->
pOff£t
 = 
p
->pOffset;

1641 
	`ex∂aöSëI¡egî
(
iSub1
, 
pP¨£
->
iNextSñe˘Id
);

1642 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
pPri‹
, &
de°
);

1643 
p
->
pLimô
 = 0;

1644 
p
->
pOff£t
 = 0;

1645 if–
rc
 ){

1646 
mu…i_£À˘_íd
;

1648 
p
->
pPri‹
 = 0;

1649 
p
->
iLimô
 = 
pPri‹
->iLimit;

1650 
p
->
iOff£t
 = 
pPri‹
->iOffset;

1651 if–
p
->
iLimô
 ){

1652 
addr
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfZîo
, 
p
->
iLimô
);

1653 
	`VdbeCommít
((
v
, "Jumpáhead if LIMITÑeached"));

1655 
	`ex∂aöSëI¡egî
(
iSub2
, 
pP¨£
->
iNextSñe˘Id
);

1656 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
p
, &
de°
);

1657 
	`ã°ˇ£
–
rc
!=
SQLITE4_OK
 );

1658 
pDñëe
 = 
p
->
pPri‹
;

1659 
p
->
pPri‹
 =ÖPrior;

1660 
p
->
nSñe˘Row
 +
pPri‹
->nSelectRow;

1661 if–
pPri‹
->
pLimô


1662 && 
	`sqlôe4Ex¥IsI¡egî
(
pPri‹
->
pLimô
, &
nLimô
)

1663 && 
p
->
nSñe˘Row
 > ()
nLimô


1665 
p
->
nSñe˘Row
 = ()
nLimô
;

1667 if–
addr
 ){

1668 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr
);

1672 
TK_EXCEPT
:

1673 
TK_UNION
: {

1674 
uni⁄Tab
;

1675 
u8
 
›
 = 0;

1676 
¥i‹Op
;

1677 
Ex¥
 *
pLimô
, *
pOff£t
;

1678 
addr
;

1679 
Sñe˘De°
 
uni⁄de°
;

1681 
	`ã°ˇ£
–
p
->
›
==
TK_EXCEPT
 );

1682 
	`ã°ˇ£
–
p
->
›
==
TK_UNION
 );

1683 
¥i‹Op
 = 
SRT_Uni⁄
;

1684 if–
de°
.
eDe°
==
¥i‹Op
 && 
	`ALWAYS
(!
p
->
pLimô
 &&!p->
pOff£t
) ){

1688 
	`as£π
–
p
->
pRightmo°
!=p );

1690 
	`as£π
–
p
->
pLimô
==0 );

1691 
	`as£π
–
p
->
pOff£t
==0 );

1692 
uni⁄Tab
 = 
de°
.
iP¨m
;

1697 
uni⁄Tab
 = 
pP¨£
->
nTab
++;

1698 
	`as£π
–
p
->
pOrdîBy
==0 );

1699 
addr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
uni⁄Tab
, 0);

1700 
	`as£π
–
p
->
addrO≥nEphm
[0] == -1 );

1701 
p
->
addrO≥nEphm
[0] = 
addr
;

1702 
p
->
pRightmo°
->
£lFœgs
 |
SF_U£sEphemîÆ
;

1703 
	`as£π
–
p
->
pELi°
 );

1708 
	`as£π
–!
pPri‹
->
pOrdîBy
 );

1709 
	`sqlôe4Sñe˘De°Inô
(&
uni⁄de°
, 
¥i‹Op
, 
uni⁄Tab
);

1710 
	`ex∂aöSëI¡egî
(
iSub1
, 
pP¨£
->
iNextSñe˘Id
);

1711 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
pPri‹
, &
uni⁄de°
);

1712 if–
rc
 ){

1713 
mu…i_£À˘_íd
;

1718 if–
p
->
›
==
TK_EXCEPT
 ){

1719 
›
 = 
SRT_Ex˚±
;

1721 
	`as£π
–
p
->
›
==
TK_UNION
 );

1722 
›
 = 
SRT_Uni⁄
;

1724 
p
->
pPri‹
 = 0;

1725 
pLimô
 = 
p
->pLimit;

1726 
p
->
pLimô
 = 0;

1727 
pOff£t
 = 
p
->pOffset;

1728 
p
->
pOff£t
 = 0;

1729 
uni⁄de°
.
eDe°
 = 
›
;

1730 
	`ex∂aöSëI¡egî
(
iSub2
, 
pP¨£
->
iNextSñe˘Id
);

1731 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
p
, &
uni⁄de°
);

1732 
	`ã°ˇ£
–
rc
!=
SQLITE4_OK
 );

1735 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
p
->
pOrdîBy
);

1736 
pDñëe
 = 
p
->
pPri‹
;

1737 
p
->
pPri‹
 =ÖPrior;

1738 
p
->
pOrdîBy
 = 0;

1739 if–
p
->
›
==
TK_UNION
 )Ö->
nSñe˘Row
 +
pPri‹
->nSelectRow;

1740 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pLimô
);

1741 
p
->
pLimô
 =ÖLimit;

1742 
p
->
pOff£t
 =ÖOffset;

1743 
p
->
iLimô
 = 0;

1744 
p
->
iOff£t
 = 0;

1749 
	`as£π
–
uni⁄Tab
==
de°
.
iP¨m
 || de°.
eDe°
!=
¥i‹Op
 );

1750 if–
de°
.
eDe°
!=
¥i‹Op
 ){

1751 
iC⁄t
, 
iBªak
, 
iSèπ
;

1752 
	`as£π
–
p
->
pELi°
 );

1753 if–
de°
.
eDe°
==
SRT_Ouçut
 ){

1754 
Sñe˘
 *
pFú°
 = 
p
;

1755  
pFú°
->
pPri‹
 )ÖFirst =ÖFirst->pPrior;

1756 
	`gíî©eCﬁumnNames
(
pP¨£
, 0, 
pFú°
->
pELi°
);

1758 
iBªak
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1759 
iC⁄t
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1760 
	`compuãLimôRegi°îs
(
pP¨£
, 
p
, 
iBªak
);

1761 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
uni⁄Tab
, 
iBªak
);

1762 
iSèπ
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

1763 
	`£À˘I¬îLo›
(
pP¨£
, 
p
,Ö->
pELi°
, 
uni⁄Tab
,Ö->pELi°->
nEx¥
,

1764 0, -1, &
de°
, 
iC⁄t
, 
iBªak
);

1765 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iC⁄t
);

1766 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
uni⁄Tab
, 
iSèπ
);

1767 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iBªak
);

1768 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Clo£
, 
uni⁄Tab
, 0);

1772 : 
	`as£π
–
p
->
›
==
TK_INTERSECT
 ); {

1773 
èb1
, 
èb2
;

1774 
iC⁄t
, 
iBªak
, 
iSèπ
;

1775 
Ex¥
 *
pLimô
, *
pOff£t
;

1776 
addr
;

1777 
Sñe˘De°
 
öãr£˘de°
;

1778 
r1
;

1784 
èb1
 = 
pP¨£
->
nTab
++;

1785 
èb2
 = 
pP¨£
->
nTab
++;

1786 
	`as£π
–
p
->
pOrdîBy
==0 );

1788 
addr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
èb1
, 0);

1789 
	`as£π
–
p
->
addrO≥nEphm
[0] == -1 );

1790 
p
->
addrO≥nEphm
[0] = 
addr
;

1791 
p
->
pRightmo°
->
£lFœgs
 |
SF_U£sEphemîÆ
;

1792 
	`as£π
–
p
->
pELi°
 );

1796 
	`sqlôe4Sñe˘De°Inô
(&
öãr£˘de°
, 
SRT_Uni⁄
, 
èb1
);

1797 
	`ex∂aöSëI¡egî
(
iSub1
, 
pP¨£
->
iNextSñe˘Id
);

1798 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
pPri‹
, &
öãr£˘de°
);

1799 if–
rc
 ){

1800 
mu…i_£À˘_íd
;

1805 
addr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
èb2
, 0);

1806 
	`as£π
–
p
->
addrO≥nEphm
[1] == -1 );

1807 
p
->
addrO≥nEphm
[1] = 
addr
;

1808 
p
->
pPri‹
 = 0;

1809 
pLimô
 = 
p
->pLimit;

1810 
p
->
pLimô
 = 0;

1811 
pOff£t
 = 
p
->pOffset;

1812 
p
->
pOff£t
 = 0;

1813 
öãr£˘de°
.
iP¨m
 = 
èb2
;

1814 
	`ex∂aöSëI¡egî
(
iSub2
, 
pP¨£
->
iNextSñe˘Id
);

1815 
rc
 = 
	`sqlôe4Sñe˘
(
pP¨£
, 
p
, &
öãr£˘de°
);

1816 
	`ã°ˇ£
–
rc
!=
SQLITE4_OK
 );

1817 
pDñëe
 = 
p
->
pPri‹
;

1818 
p
->
pPri‹
 =ÖPrior;

1819 if–
p
->
nSñe˘Row
>
pPri‹
->nSelectRow )Ö->nSelectRow =ÖPrior->nSelectRow;

1820 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pLimô
);

1821 
p
->
pLimô
 =ÖLimit;

1822 
p
->
pOff£t
 =ÖOffset;

1827 
	`as£π
–
p
->
pELi°
 );

1828 if–
de°
.
eDe°
==
SRT_Ouçut
 ){

1829 
Sñe˘
 *
pFú°
 = 
p
;

1830  
pFú°
->
pPri‹
 )ÖFirst =ÖFirst->pPrior;

1831 
	`gíî©eCﬁumnNames
(
pP¨£
, 0, 
pFú°
->
pELi°
);

1833 
iBªak
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1834 
iC⁄t
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1835 
	`compuãLimôRegi°îs
(
pP¨£
, 
p
, 
iBªak
);

1836 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
èb1
, 
iBªak
);

1837 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1838 
iSèπ
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
èb1
, 
r1
);

1839 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_NŸFound
, 
èb2
, 
iC⁄t
, 
r1
, 0);

1840 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

1841 
	`£À˘I¬îLo›
(
pP¨£
, 
p
,Ö->
pELi°
, 
èb1
,Ö->pELi°->
nEx¥
,

1842 0, -1, &
de°
, 
iC⁄t
, 
iBªak
);

1843 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iC⁄t
);

1844 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
èb1
, 
iSèπ
);

1845 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iBªak
);

1846 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Clo£
, 
èb2
, 0);

1847 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Clo£
, 
èb1
, 0);

1852 
	`ex∂aöComposôe
(
pP¨£
, 
p
->
›
, 
iSub1
, 
iSub2
,Ö->›!=
TK_ALL
);

1863 if–
p
->
£lFœgs
 & 
SF_U£sEphemîÆ
 ){

1864 
i
;

1865 
KeyInfo
 *
pKeyInfo
;

1866 
Sñe˘
 *
pLo›
;

1867 
CﬁlSeq
 **
≠Cﬁl
;

1868 
nCﬁ
;

1870 
	`as£π
–
p
->
pRightmo°
==p );

1871 
nCﬁ
 = 
p
->
pELi°
->
nEx¥
;

1872 
pKeyInfo
 = 
	`sqlôe4DbMÆlocZîo
(
db
,

1873 (*
pKeyInfo
)+
nCﬁ
*((
CﬁlSeq
*) + 1));

1874 if–!
pKeyInfo
 ){

1875 
rc
 = 
SQLITE4_NOMEM
;

1876 
mu…i_£À˘_íd
;

1879 
pKeyInfo
->
nFõld
 = (
u16
)
nCﬁ
;

1881 
i
=0, 
≠Cﬁl
=
pKeyInfo
->
aCﬁl
; i<
nCﬁ
; i++,ápColl++){

1882 *
≠Cﬁl
 = 
	`mu…iSñe˘CﬁlSeq
(
pP¨£
, 
p
, 
i
);

1883 if–0==*
≠Cﬁl
 ){

1884 *
≠Cﬁl
 = 
db
->
pDÊtCﬁl
;

1888 
pLo›
=
p
;ÖLo›;ÖLo›ıLo›->
pPri‹
){

1889 
i
=0; i<2; i++){

1890 
addr
 = 
pLo›
->
addrO≥nEphm
[
i
];

1891 if–
addr
<0 ){

1894 
	`as£π
–
pLo›
->
addrO≥nEphm
[1]<0 );

1897 
	`sqlôe4VdbeCh™geP2
(
v
, 
addr
, 
nCﬁ
);

1898 
	`sqlôe4VdbeCh™geP4
(
v
, 
addr
, (*)
pKeyInfo
, 
P4_KEYINFO
);

1899 
pLo›
->
addrO≥nEphm
[
i
] = -1;

1902 
	`sqlôe4DbFªe
(
db
, 
pKeyInfo
);

1905 
mu…i_£À˘_íd
:

1906 
pDe°
->
iMem
 = 
de°
.iMem;

1907 
pDe°
->
nMem
 = 
de°
.nMem;

1908 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pDñëe
);

1909  
rc
;

1910 
	}
}

1933 
	$gíî©eOuçutSubroutöe
(

1934 
P¨£
 *
pP¨£
,

1935 
Sñe˘
 *
p
,

1936 
Sñe˘De°
 *
pIn
,

1937 
Sñe˘De°
 *
pDe°
,

1938 
ªgRëu∫
,

1939 
ªgPªv
,

1940 
KeyInfo
 *
pKeyInfo
,

1941 
p4ty≥
,

1942 
iBªak


1944 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1945 
iC⁄töue
;

1946 
addr
;

1948 
addr
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

1949 
iC⁄töue
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

1953 if–
ªgPªv
 ){

1954 
j1
, 
j2
;

1955 
j1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfNŸ
, 
ªgPªv
);

1956 
j2
 = 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Com∑ª
, 
pIn
->
iMem
, 
ªgPªv
+1,ÖIn->
nMem
,

1957 (*)
pKeyInfo
, 
p4ty≥
);

1958 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Jump
, 
j2
+2, 
iC⁄töue
, j2+2);

1959 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

1960 
	`sqlôe4Ex¥CodeC›y
(
pP¨£
, 
pIn
->
iMem
, 
ªgPªv
+1,ÖIn->
nMem
);

1961 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
ªgPªv
);

1963 if–
pP¨£
->
db
->
mÆlocFaûed
 )  0;

1967 
	`codeOff£t
(
v
, 
p
, 
iC⁄töue
);

1969  
pDe°
->
eDe°
 ){

1972 
SRT_TabÀ
:

1973 
SRT_EphemTab
: {

1974 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1975 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1976 
	`ã°ˇ£
–
pDe°
->
eDe°
==
SRT_TabÀ
 );

1977 
	`ã°ˇ£
–
pDe°
->
eDe°
==
SRT_EphemTab
 );

1978 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
pIn
->
iMem
,ÖIn->
nMem
, 
r1
);

1979 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NewRowid
, 
pDe°
->
iP¨m
, 
r2
);

1980 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
pDe°
->
iP¨m
, 
r1
, 
r2
);

1981 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

1982 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

1986 #i‚de‡
SQLITE4_OMIT_SUBQUERY


1991 
SRT_Së
: {

1992 
r1
, 
r2
;

1993 
	`as£π
–
pIn
->
nMem
==1 );

1994 
p
->
afföôy
 =

1995 
	`sqlôe4Com∑ªAfföôy
(
p
->
pELi°
->
a
[0].
pEx¥
, 
pDe°
->
afföôy
);

1996 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1997 
r2
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1998 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Afföôy
, 
pIn
->
iMem
, 1, 0, &
p
->
afföôy
, 1);

1999 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
pIn
->
iMem
, 1);

2000 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
pIn
->
iMem
, 1, 
r2
, 
pDe°
->
iP¨m
);

2001 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
pIn
->
iMem
, 1, 
r1
);

2002 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_USEKEY
);

2003 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
pDe°
->
iP¨m
, 
r1
, 
r2
);

2004 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

2005 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r2
);

2012 
SRT_Exi°s
: {

2013 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
pDe°
->
iP¨m
);

2023 
SRT_Mem
: {

2024 
	`as£π
–
pIn
->
nMem
==1 );

2025 
	`sqlôe4Ex¥CodeMove
(
pP¨£
, 
pIn
->
iMem
, 
pDe°
->
iP¨m
, 1);

2034 
SRT_C‹outöe
: {

2035 if–
pDe°
->
iMem
==0 ){

2036 
pDe°
->
iMem
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
pIn
->
nMem
);

2037 
pDe°
->
nMem
 = 
pIn
->nMem;

2039 
	`sqlôe4Ex¥CodeMove
(
pP¨£
, 
pIn
->
iMem
, 
pDe°
->iMem,ÖDe°->
nMem
);

2040 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
pDe°
->
iP¨m
);

2053 
	`as£π
–
pDe°
->
eDe°
==
SRT_Ouçut
 );

2054 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Resu…Row
, 
pIn
->
iMem
,ÖIn->
nMem
);

2055 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
pIn
->
iMem
,ÖIn->
nMem
);

2062 if–
p
->
iLimô
 ){

2063 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_IfZîo
, 
p
->
iLimô
, 
iBªak
, -1);

2068 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iC⁄töue
);

2069 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rëu∫
, 
ªgRëu∫
);

2071  
addr
;

2072 
	}
}

2159 #i‚de‡
SQLITE4_OMIT_COMPOUND_SELECT


2160 
	$mu…iSñe˘OrdîBy
(

2161 
P¨£
 *
pP¨£
,

2162 
Sñe˘
 *
p
,

2163 
Sñe˘De°
 *
pDe°


2165 
i
, 
j
;

2166 
Sñe˘
 *
pPri‹
;

2167 
Vdbe
 *
v
;

2168 
Sñe˘De°
 
de°A
;

2169 
Sñe˘De°
 
de°B
;

2170 
ªgAddrA
;

2171 
ªgEofA
;

2172 
ªgAddrB
;

2173 
ªgEofB
;

2174 
addrSñe˘A
;

2175 
addrSñe˘B
;

2176 
ªgOutA
;

2177 
ªgOutB
;

2178 
addrOutA
;

2179 
addrOutB
 = 0;

2180 
addrEofA
;

2181 
addrEofB
;

2182 
addrA…B
;

2183 
addrAeqB
;

2184 
addrAgtB
;

2185 
ªgLimôA
;

2186 
ªgLimôB
;

2187 
ªgPªv
;

2188 
ßvedLimô
;

2189 
ßvedOff£t
;

2190 
œbñCm¥
;

2191 
œbñEnd
;

2192 
j1
;

2193 
›
;

2194 
KeyInfo
 *
pKeyDup
 = 0;

2195 
KeyInfo
 *
pKeyMîge
;

2196 
sqlôe4
 *
db
;

2197 
Ex¥Li°
 *
pOrdîBy
;

2198 
nOrdîBy
;

2199 *
aPîmuã
;

2200 #i‚de‡
SQLITE4_OMIT_EXPLAIN


2201 
iSub1
;

2202 
iSub2
;

2205 
	`as£π
–
p
->
pOrdîBy
!=0 );

2206 
	`as£π
–
pKeyDup
==0 );

2207 
db
 = 
pP¨£
->db;

2208 
v
 = 
pP¨£
->
pVdbe
;

2209 
	`as£π
–
v
!=0 );

2210 
œbñEnd
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2211 
œbñCm¥
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

2216 
›
 = 
p
->op;

2217 
pPri‹
 = 
p
->pPrior;

2218 
	`as£π
–
pPri‹
->
pOrdîBy
==0 );

2219 
pOrdîBy
 = 
p
->pOrderBy;

2220 
	`as£π
–
pOrdîBy
 );

2221 
nOrdîBy
 = 
pOrdîBy
->
nEx¥
;

2227 if–
›
!=
TK_ALL
 ){

2228 
i
=1; 
db
->
mÆlocFaûed
==0 && i<=
p
->
pELi°
->
nEx¥
; i++){

2229 
Ex¥Li°Iãm
 *
pIãm
;

2230 
j
=0, 
pIãm
=
pOrdîBy
->
a
; j<
nOrdîBy
; j++,ÖItem++){

2231 
	`as£π
–
pIãm
->
iOrdîByCﬁ
>0 );

2232 if–
pIãm
->
iOrdîByCﬁ
==
i
 ) ;

2234 if–
j
==
nOrdîBy
 ){

2235 
Ex¥
 *
pNew
 = 
	`sqlôe4Ex¥
(
db
, 
TK_INTEGER
, 0);

2236 if–
pNew
==0 )  
SQLITE4_NOMEM
;

2237 
pNew
->
Êags
 |
EP_I¡VÆue
;

2238 
pNew
->
u
.
iVÆue
 = 
i
;

2239 
pOrdîBy
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,ÖOrdîBy, 
pNew
);

2240 
pOrdîBy
->
a
[
nOrdîBy
++].
iOrdîByCﬁ
 = (
u16
)
i
;

2252 
aPîmuã
 = 
	`sqlôe4DbMÆlocRaw
(
db
, ()*
nOrdîBy
);

2253 if–
aPîmuã
 ){

2254 
Ex¥Li°Iãm
 *
pIãm
;

2255 
i
=0, 
pIãm
=
pOrdîBy
->
a
; i<
nOrdîBy
; i++,ÖItem++){

2256 
	`as£π
–
pIãm
->
iOrdîByCﬁ
>0 &&ÖIãm->iOrdîByCﬁ<=
p
->
pELi°
->
nEx¥
 );

2257 
aPîmuã
[
i
] = 
pIãm
->
iOrdîByCﬁ
 - 1;

2259 
pKeyMîge
 =

2260 
	`sqlôe4DbMÆlocRaw
(
db
, (*
pKeyMîge
)+
nOrdîBy
*((
CﬁlSeq
*)+1));

2261 if–
pKeyMîge
 ){

2262 
pKeyMîge
->
aS‹tOrdî
 = (
u8
*)&pKeyMîge->
aCﬁl
[
nOrdîBy
];

2263 
pKeyMîge
->
nFõld
 = (
u16
)
nOrdîBy
;

2264 
i
=0; i<
nOrdîBy
; i++){

2265 
CﬁlSeq
 *
pCﬁl
;

2266 
Ex¥
 *
pTîm
 = 
pOrdîBy
->
a
[
i
].
pEx¥
;

2267 if–
pTîm
->
Êags
 & 
EP_ExpCﬁœã
 ){

2268 
pCﬁl
 = 
pTîm
->pColl;

2270 
pCﬁl
 = 
	`mu…iSñe˘CﬁlSeq
(
pP¨£
, 
p
, 
aPîmuã
[
i
]);

2271 
pTîm
->
Êags
 |
EP_ExpCﬁœã
;

2272 
pTîm
->
pCﬁl
 =ÖColl;

2274 
pKeyMîge
->
aCﬁl
[
i
] = 
pCﬁl
;

2275 
pKeyMîge
->
aS‹tOrdî
[
i
] = 
pOrdîBy
->
a
[i].
s‹tOrdî
;

2279 
pKeyMîge
 = 0;

2284 
p
->
pOrdîBy
 =ÖOrderBy;

2285 
pPri‹
->
pOrdîBy
 = 
	`sqlôe4Ex¥Li°Dup
(
pP¨£
->
db
,ÖOrderBy, 0);

2291 if–
›
==
TK_ALL
 ){

2292 
ªgPªv
 = 0;

2294 
nEx¥
 = 
p
->
pELi°
->nExpr;

2295 
	`as£π
–
nOrdîBy
>=
nEx¥
 || 
db
->
mÆlocFaûed
 );

2296 
ªgPªv
 = 
pP¨£
->
nMem
 + 1;

2297 
pP¨£
->
nMem
 +
nEx¥
 + 1;

2298 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgPªv
);

2299 
pKeyDup
 = 
	`sqlôe4DbMÆlocZîo
(
db
,

2300 (*
pKeyDup
Ë+ 
nEx¥
*((
CﬁlSeq
*)+1) );

2301 if–
pKeyDup
 ){

2302 
pKeyDup
->
aS‹tOrdî
 = (
u8
*)&pKeyDup->
aCﬁl
[
nEx¥
];

2303 
pKeyDup
->
nFõld
 = (
u16
)
nEx¥
;

2304 
i
=0; i<
nEx¥
; i++){

2305 
pKeyDup
->
aCﬁl
[
i
] = 
	`mu…iSñe˘CﬁlSeq
(
pP¨£
, 
p
, i);

2306 
pKeyDup
->
aS‹tOrdî
[
i
] = 0;

2313 
p
->
pPri‹
 = 0;

2314 
	`sqlôe4ResﬁveOrdîGroupBy
(
pP¨£
, 
p
,Ö->
pOrdîBy
, "ORDER");

2315 if–
pPri‹
->pPrior==0 ){

2316 
	`sqlôe4ResﬁveOrdîGroupBy
(
pP¨£
, 
pPri‹
,ÖPri‹->
pOrdîBy
, "ORDER");

2320 
	`compuãLimôRegi°îs
(
pP¨£
, 
p
, 
œbñEnd
);

2321 if–
p
->
iLimô
 && 
›
==
TK_ALL
 ){

2322 
ªgLimôA
 = ++
pP¨£
->
nMem
;

2323 
ªgLimôB
 = ++
pP¨£
->
nMem
;

2324 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
p
->
iOff£t
 ?Ö->iOff£t+1 :Ö->
iLimô
,

2325 
ªgLimôA
);

2326 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
ªgLimôA
, 
ªgLimôB
);

2328 
ªgLimôA
 = 
ªgLimôB
 = 0;

2330 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pLimô
);

2331 
p
->
pLimô
 = 0;

2332 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
->
pOff£t
);

2333 
p
->
pOff£t
 = 0;

2335 
ªgAddrA
 = ++
pP¨£
->
nMem
;

2336 
ªgEofA
 = ++
pP¨£
->
nMem
;

2337 
ªgAddrB
 = ++
pP¨£
->
nMem
;

2338 
ªgEofB
 = ++
pP¨£
->
nMem
;

2339 
ªgOutA
 = ++
pP¨£
->
nMem
;

2340 
ªgOutB
 = ++
pP¨£
->
nMem
;

2341 
	`sqlôe4Sñe˘De°Inô
(&
de°A
, 
SRT_C‹outöe
, 
ªgAddrA
);

2342 
	`sqlôe4Sñe˘De°Inô
(&
de°B
, 
SRT_C‹outöe
, 
ªgAddrB
);

2347 
j1
 = 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_GŸo
);

2348 
addrSñe˘A
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

2354 
	`VdbeNo›Commít
((
v
, "Begin coroutine forÜeft SELECT"));

2355 
pPri‹
->
iLimô
 = 
ªgLimôA
;

2356 
	`ex∂aöSëI¡egî
(
iSub1
, 
pP¨£
->
iNextSñe˘Id
);

2357 
	`sqlôe4Sñe˘
(
pP¨£
, 
pPri‹
, &
de°A
);

2358 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
ªgEofA
);

2359 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrA
);

2360 
	`VdbeNo›Commít
((
v
, "End coroutine forÜeft SELECT"));

2365 
addrSñe˘B
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

2366 
	`VdbeNo›Commít
((
v
, "Begin coroutine forÑight SELECT"));

2367 
ßvedLimô
 = 
p
->
iLimô
;

2368 
ßvedOff£t
 = 
p
->
iOff£t
;

2369 
p
->
iLimô
 = 
ªgLimôB
;

2370 
p
->
iOff£t
 = 0;

2371 
	`ex∂aöSëI¡egî
(
iSub2
, 
pP¨£
->
iNextSñe˘Id
);

2372 
	`sqlôe4Sñe˘
(
pP¨£
, 
p
, &
de°B
);

2373 
p
->
iLimô
 = 
ßvedLimô
;

2374 
p
->
iOff£t
 = 
ßvedOff£t
;

2375 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
ªgEofB
);

2376 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrB
);

2377 
	`VdbeNo›Commít
((
v
, "End coroutine forÑight SELECT"));

2382 
	`VdbeNo›Commít
((
v
, "OutputÑoutine for A"));

2383 
addrOutA
 = 
	`gíî©eOuçutSubroutöe
(
pP¨£
,

2384 
p
, &
de°A
, 
pDe°
, 
ªgOutA
,

2385 
ªgPªv
, 
pKeyDup
, 
P4_KEYINFO_HANDOFF
, 
œbñEnd
);

2390 if–
›
==
TK_ALL
 || op==
TK_UNION
 ){

2391 
	`VdbeNo›Commít
((
v
, "OutputÑoutine for B"));

2392 
addrOutB
 = 
	`gíî©eOuçutSubroutöe
(
pP¨£
,

2393 
p
, &
de°B
, 
pDe°
, 
ªgOutB
,

2394 
ªgPªv
, 
pKeyDup
, 
P4_KEYINFO_STATIC
, 
œbñEnd
);

2400 
	`VdbeNo›Commít
((
v
, "eof-A subroutine"));

2401 if–
›
==
TK_EXCEPT
 || op==
TK_INTERSECT
 ){

2402 
addrEofA
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
œbñEnd
);

2404 
addrEofA
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofB
, 
œbñEnd
);

2405 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgOutB
, 
addrOutB
);

2406 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrB
);

2407 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrEofA
);

2408 
p
->
nSñe˘Row
 +
pPri‹
->nSelectRow;

2414 if–
›
==
TK_INTERSECT
 ){

2415 
addrEofB
 = 
addrEofA
;

2416 if–
p
->
nSñe˘Row
 > 
pPri‹
->nSelectRow )Ö->nSelectRow =ÖPrior->nSelectRow;

2418 
	`VdbeNo›Commít
((
v
, "eof-B subroutine"));

2419 
addrEofB
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofA
, 
œbñEnd
);

2420 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgOutA
, 
addrOutA
);

2421 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrA
);

2422 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrEofB
);

2427 
	`VdbeNo›Commít
((
v
, "A-lt-B subroutine"));

2428 
addrA…B
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgOutA
, 
addrOutA
);

2429 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrA
);

2430 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofA
, 
addrEofA
);

2431 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
œbñCm¥
);

2435 if–
›
==
TK_ALL
 ){

2436 
addrAeqB
 = 
addrA…B
;

2437 }if–
›
==
TK_INTERSECT
 ){

2438 
addrAeqB
 = 
addrA…B
;

2439 
addrA…B
++;

2441 
	`VdbeNo›Commít
((
v
, "A-eq-B subroutine"));

2442 
addrAeqB
 =

2443 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrA
);

2444 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofA
, 
addrEofA
);

2445 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
œbñCm¥
);

2450 
	`VdbeNo›Commít
((
v
, "A-gt-B subroutine"));

2451 
addrAgtB
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

2452 if–
›
==
TK_ALL
 || op==
TK_UNION
 ){

2453 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgOutB
, 
addrOutB
);

2455 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgAddrB
);

2456 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofB
, 
addrEofB
);

2457 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
œbñCm¥
);

2461 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

2462 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgEofA
);

2463 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgEofB
);

2464 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgAddrA
, 
addrSñe˘A
);

2465 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgAddrB
, 
addrSñe˘B
);

2466 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofA
, 
addrEofA
);

2467 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgEofB
, 
addrEofB
);

2471 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
œbñCm¥
);

2472 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Pîmuèti⁄
, 
nOrdîBy
, 0, 0,

2473 (*)
aPîmuã
, 
P4_INTARRAY
);

2474 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Com∑ª
, 
de°A
.
iMem
, 
de°B
.iMem, 
nOrdîBy
,

2475 (*)
pKeyMîge
, 
P4_KEYINFO_HANDOFF
);

2476 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Jump
, 
addrA…B
, 
addrAeqB
, 
addrAgtB
);

2480 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
œbñEnd
);

2484 if–
pDe°
->
eDe°
==
SRT_Ouçut
 ){

2485 
Sñe˘
 *
pFú°
 = 
pPri‹
;

2486  
pFú°
->
pPri‹
 )ÖFirst =ÖFirst->pPrior;

2487 
	`gíî©eCﬁumnNames
(
pP¨£
, 0, 
pFú°
->
pELi°
);

2492 if–
p
->
pPri‹
 ){

2493 
	`sqlôe4Sñe˘Dñëe
(
db
, 
p
->
pPri‹
);

2495 
p
->
pPri‹
 =ÖPrior;

2499 
	`ex∂aöComposôe
(
pP¨£
, 
p
->
›
, 
iSub1
, 
iSub2
, 0);

2500  
SQLITE4_OK
;

2501 
	}
}

2504 #i‡!
deföed
(
SQLITE4_OMIT_SUBQUERY
Ë|| !deföed(
SQLITE4_OMIT_VIEW
)

2506 
sub°Ex¥Li°
(
sqlôe4
*, 
Ex¥Li°
*, , ExprList*);

2507 
sub°Sñe˘
(
sqlôe4
*, 
Sñe˘
 *, , 
Ex¥Li°
 *);

2522 
Ex¥
 *
	$sub°Ex¥
(

2523 
sqlôe4
 *
db
,

2524 
Ex¥
 *
pEx¥
,

2525 
iTabÀ
,

2526 
Ex¥Li°
 *
pELi°


2528 if–
pEx¥
==0 )  0;

2529 if–
pEx¥
->
›
==
TK_COLUMN
 &&ÖEx¥->
iTabÀ
==iTable ){

2530 if–
pEx¥
->
iCﬁumn
<0 ){

2531 
pEx¥
->
›
 = 
TK_NULL
;

2533 
Ex¥
 *
pNew
;

2534 
	`as£π
–
pELi°
!=0 && 
pEx¥
->
iCﬁumn
<pELi°->
nEx¥
 );

2535 
	`as£π
–
pEx¥
->
pLe·
==0 &&ÖEx¥->
pRight
==0 );

2536 
pNew
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pELi°
->
a
[
pEx¥
->
iCﬁumn
].pExpr, 0);

2537 if–
pNew
 && 
pEx¥
->
pCﬁl
 ){

2538 
pNew
->
pCﬁl
 = 
pEx¥
->pColl;

2540 
	`sqlôe4Ex¥Dñëe
(
db
, 
pEx¥
);

2541 
pEx¥
 = 
pNew
;

2544 
pEx¥
->
pLe·
 = 
	`sub°Ex¥
(
db
,ÖEx¥->pLe·, 
iTabÀ
, 
pELi°
);

2545 
pEx¥
->
pRight
 = 
	`sub°Ex¥
(
db
,ÖEx¥->pRight, 
iTabÀ
, 
pELi°
);

2546 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

2547 
	`sub°Sñe˘
(
db
, 
pEx¥
->
x
.
pSñe˘
, 
iTabÀ
, 
pELi°
);

2549 
	`sub°Ex¥Li°
(
db
, 
pEx¥
->
x
.
pLi°
, 
iTabÀ
, 
pELi°
);

2552  
pEx¥
;

2553 
	}
}

2554 
	$sub°Ex¥Li°
(

2555 
sqlôe4
 *
db
,

2556 
Ex¥Li°
 *
pLi°
,

2557 
iTabÀ
,

2558 
Ex¥Li°
 *
pELi°


2560 
i
;

2561 if–
pLi°
==0 ) ;

2562 
i
=0; i<
pLi°
->
nEx¥
; i++){

2563 
pLi°
->
a
[
i
].
pEx¥
 = 
	`sub°Ex¥
(
db
,ÖLi°->a[i].pEx¥, 
iTabÀ
, 
pELi°
);

2565 
	}
}

2566 
	$sub°Sñe˘
(

2567 
sqlôe4
 *
db
,

2568 
Sñe˘
 *
p
,

2569 
iTabÀ
,

2570 
Ex¥Li°
 *
pELi°


2572 
SrcLi°
 *
pSrc
;

2573 
SrcLi°Iãm
 *
pIãm
;

2574 
i
;

2575 if–!
p
 ) ;

2576 
	`sub°Ex¥Li°
(
db
, 
p
->
pELi°
, 
iTabÀ
,ÖEList);

2577 
	`sub°Ex¥Li°
(
db
, 
p
->
pGroupBy
, 
iTabÀ
, 
pELi°
);

2578 
	`sub°Ex¥Li°
(
db
, 
p
->
pOrdîBy
, 
iTabÀ
, 
pELi°
);

2579 
p
->
pHavög
 = 
	`sub°Ex¥
(
db
,Ö->pHavög, 
iTabÀ
, 
pELi°
);

2580 
p
->
pWhîe
 = 
	`sub°Ex¥
(
db
,Ö->pWhîe, 
iTabÀ
, 
pELi°
);

2581 
	`sub°Sñe˘
(
db
, 
p
->
pPri‹
, 
iTabÀ
, 
pELi°
);

2582 
pSrc
 = 
p
->pSrc;

2583 
	`as£π
–
pSrc
 );

2584 if–
	`ALWAYS
(
pSrc
) ){

2585 
i
=
pSrc
->
nSrc
, 
pIãm
ıSrc->
a
; i>0; i--,ÖItem++){

2586 
	`sub°Sñe˘
(
db
, 
pIãm
->
pSñe˘
, 
iTabÀ
, 
pELi°
);

2589 
	}
}

2592 #i‡!
deföed
(
SQLITE4_OMIT_SUBQUERY
Ë|| !deföed(
SQLITE4_OMIT_VIEW
)

2714 
	$Ê©ãnSubquîy
(

2715 
P¨£
 *
pP¨£
,

2716 
Sñe˘
 *
p
,

2717 
iFrom
,

2718 
isAgg
,

2719 
subquîyIsAgg


2721 c⁄° *
zSavedAuthC⁄ãxt
 = 
pP¨£
->
zAuthC⁄ãxt
;

2722 
Sñe˘
 *
pP¨ít
;

2723 
Sñe˘
 *
pSub
;

2724 
Sñe˘
 *
pSub1
;

2725 
SrcLi°
 *
pSrc
;

2726 
SrcLi°
 *
pSubSrc
;

2727 
Ex¥Li°
 *
pLi°
;

2728 
iP¨ít
;

2729 
i
;

2730 
Ex¥
 *
pWhîe
;

2731 
SrcLi°Iãm
 *
pSubôem
;

2732 
sqlôe4
 *
db
 = 
pP¨£
->db;

2736 
	`as£π
–
p
!=0 );

2737 
	`as£π
–
p
->
pPri‹
==0 );

2738 if–
db
->
Êags
 & 
SQLITE4_QuîyFœâíî
 )  0;

2739 
pSrc
 = 
p
->pSrc;

2740 
	`as£π
–
pSrc
 && 
iFrom
>=0 && iFrom<pSrc->
nSrc
 );

2741 
pSubôem
 = &
pSrc
->
a
[
iFrom
];

2742 
iP¨ít
 = 
pSubôem
->
iCurs‹
;

2743 
pSub
 = 
pSubôem
->
pSñe˘
;

2744 
	`as£π
–
pSub
!=0 );

2745 if–
isAgg
 && 
subquîyIsAgg
 )  0;

2746 if–
subquîyIsAgg
 && 
pSrc
->
nSrc
>1 )  0;

2747 
pSubSrc
 = 
pSub
->
pSrc
;

2748 
	`as£π
–
pSubSrc
 );

2754 if–
pSub
->
pLimô
 && 
p
->pLimit )  0;

2755 if–
pSub
->
pOff£t
 )  0;

2756 if–
p
->
pRightmo°
 && 
pSub
->
pLimô
 ){

2759 if–
pSubSrc
->
nSrc
==0 )  0;

2760 if–
pSub
->
£lFœgs
 & 
SF_Di°ö˘
 )  0;

2761 if–
pSub
->
pLimô
 && (
pSrc
->
nSrc
>1 || 
isAgg
) ){

2764 if–(
p
->
£lFœgs
 & 
SF_Di°ö˘
)!=0 && 
subquîyIsAgg
 ){

2767 if–
p
->
pOrdîBy
 && 
pSub
->pOrderBy ){

2770 if–
isAgg
 && 
pSub
->
pOrdîBy
 )  0;

2771 if–
pSub
->
pLimô
 && 
p
->
pWhîe
 )  0;

2772 if–
pSub
->
pLimô
 && (
p
->
£lFœgs
 & 
SF_Di°ö˘
)!=0 ){

2808 if–(
pSubôem
->
joöty≥
 & 
JT_OUTER
)!=0 ){

2817 if–
pSub
->
pPri‹
 ){

2818 if–
pSub
->
pOrdîBy
 ){

2821 if–
isAgg
 || (
p
->
£lFœgs
 & 
SF_Di°ö˘
)!=0 || 
pSrc
->
nSrc
!=1 ){

2824 
pSub1
=
pSub
;ÖSub1;ÖSub1ıSub1->
pPri‹
){

2825 
	`ã°ˇ£
–(
pSub1
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
))==SF_Distinct );

2826 
	`ã°ˇ£
–(
pSub1
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
))==SF_Aggregate );

2827 
	`as£π
–
pSub
->
pSrc
!=0 );

2828 if–(
pSub1
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
))!=0

2829 || (
pSub1
->
pPri‹
 &&ÖSub1->
›
!=
TK_ALL
)

2830 || 
pSub1
->
pSrc
->
nSrc
<1

2831 || 
pSub
->
pELi°
->
nEx¥
!=
pSub1
->pEList->nExpr

2835 
	`ã°ˇ£
–
pSub1
->
pSrc
->
nSrc
>1 );

2839 if–
p
->
pOrdîBy
 ){

2840 
ii
;

2841 
ii
=0; ii<
p
->
pOrdîBy
->
nEx¥
; ii++){

2842 if–
p
->
pOrdîBy
->
a
[
ii
].
iOrdîByCﬁ
==0 )  0;

2850 
pP¨£
->
zAuthC⁄ãxt
 = 
pSubôem
->
zName
;

2851 
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_SELECT
, 0, 0, 0);

2852 
pP¨£
->
zAuthC⁄ãxt
 = 
zSavedAuthC⁄ãxt
;

2887 
pSub
ıSub->
pPri‹
;ÖSub;ÖSub=pSub->pPrior){

2888 
Sñe˘
 *
pNew
;

2889 
Ex¥Li°
 *
pOrdîBy
 = 
p
->pOrderBy;

2890 
Ex¥
 *
pLimô
 = 
p
->pLimit;

2891 
Sñe˘
 *
pPri‹
 = 
p
->pPrior;

2892 
p
->
pOrdîBy
 = 0;

2893 
p
->
pSrc
 = 0;

2894 
p
->
pPri‹
 = 0;

2895 
p
->
pLimô
 = 0;

2896 
pNew
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
p
, 0);

2897 
p
->
pLimô
 =ÖLimit;

2898 
p
->
pOrdîBy
 =ÖOrderBy;

2899 
p
->
pSrc
 =ÖSrc;

2900 
p
->
›
 = 
TK_ALL
;

2901 
p
->
pRightmo°
 = 0;

2902 if–
pNew
==0 ){

2903 
pNew
 = 
pPri‹
;

2905 
pNew
->
pPri‹
 =ÖPrior;

2906 
pNew
->
pRightmo°
 = 0;

2908 
p
->
pPri‹
 = 
pNew
;

2909 if–
db
->
mÆlocFaûed
 )  1;

2915 
pSub
 = 
pSub1
 = 
pSubôem
->
pSñe˘
;

2920 
	`sqlôe4DbFªe
(
db
, 
pSubôem
->
zD©aba£
);

2921 
	`sqlôe4DbFªe
(
db
, 
pSubôem
->
zName
);

2922 
	`sqlôe4DbFªe
(
db
, 
pSubôem
->
zAlüs
);

2923 
pSubôem
->
zD©aba£
 = 0;

2924 
pSubôem
->
zName
 = 0;

2925 
pSubôem
->
zAlüs
 = 0;

2926 
pSubôem
->
pSñe˘
 = 0;

2935 if–
	`ALWAYS
(
pSubôem
->
pTab
!=0) ){

2936 
TabÀ
 *
pTabToDñ
 = 
pSubôem
->
pTab
;

2937 if–
pTabToDñ
->
nRef
==1 ){

2938 
P¨£
 *
pT›Àvñ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

2939 
pTabToDñ
->
pNextZombõ
 = 
pT›Àvñ
->
pZombõTab
;

2940 
pT›Àvñ
->
pZombõTab
 = 
pTabToDñ
;

2942 
pTabToDñ
->
nRef
--;

2944 
pSubôem
->
pTab
 = 0;

2960 
pP¨ít
=
p
;ÖP¨ít;ÖP¨ítıP¨ít->
pPri‹
, 
pSub
=pSub->pPrior){

2961 
nSubSrc
;

2962 
u8
 
joöty≥
 = 0;

2963 
pSubSrc
 = 
pSub
->
pSrc
;

2964 
nSubSrc
 = 
pSubSrc
->
nSrc
;

2965 
pSrc
 = 
pP¨ít
->pSrc;

2967 if–
pSrc
 ){

2968 
	`as£π
–
pP¨ít
==
p
 );

2969 
joöty≥
 = 
pSubôem
->jointype;

2971 
	`as£π
–
pP¨ít
!=
p
 );

2972 
pSrc
 = 
pP¨ít
->pSr¯
	`sqlôe4SrcLi°Aµíd
(
db
, 0, 0, 0);

2973 if–
pSrc
==0 ){

2974 
	`as£π
–
db
->
mÆlocFaûed
 );

2994 if–
nSubSrc
>1 ){

2995 
pP¨ít
->
pSrc
 =ÖSr¯
	`sqlôe4SrcLi°E∆¨ge
(
db
,ÖSrc, 
nSubSrc
-1,
iFrom
+1);

2996 if–
db
->
mÆlocFaûed
 ){

3004 
i
=0; i<
nSubSrc
; i++){

3005 
	`sqlôe4IdLi°Dñëe
(
db
, 
pSrc
->
a
[
i
+
iFrom
].
pUsög
);

3006 
pSrc
->
a
[
i
+
iFrom
] = 
pSubSrc
->a[i];

3007 
	`mem£t
(&
pSubSrc
->
a
[
i
], 0, (pSubSrc->a[i]));

3009 
pSrc
->
a
[
iFrom
].
joöty≥
 = jointype;

3023 
pLi°
 = 
pP¨ít
->
pELi°
;

3024 
i
=0; i<
pLi°
->
nEx¥
; i++){

3025 if–
pLi°
->
a
[
i
].
zName
==0 ){

3026 c⁄° *
zS∑n
 = 
pLi°
->
a
[
i
].zSpan;

3027 if–
	`ALWAYS
(
zS∑n
) ){

3028 
pLi°
->
a
[
i
].
zName
 = 
	`sqlôe4DbSåDup
(
db
, 
zS∑n
);

3032 
	`sub°Ex¥Li°
(
db
, 
pP¨ít
->
pELi°
, 
iP¨ít
, 
pSub
->pEList);

3033 if–
isAgg
 ){

3034 
	`sub°Ex¥Li°
(
db
, 
pP¨ít
->
pGroupBy
, 
iP¨ít
, 
pSub
->
pELi°
);

3035 
pP¨ít
->
pHavög
 = 
	`sub°Ex¥
(
db
,ÖP¨ít->pHavög, 
iP¨ít
, 
pSub
->
pELi°
);

3037 if–
pSub
->
pOrdîBy
 ){

3038 
	`as£π
–
pP¨ít
->
pOrdîBy
==0 );

3039 
pP¨ít
->
pOrdîBy
 = 
pSub
->pOrderBy;

3040 
pSub
->
pOrdîBy
 = 0;

3041 }if–
pP¨ít
->
pOrdîBy
 ){

3042 
	`sub°Ex¥Li°
(
db
, 
pP¨ít
->
pOrdîBy
, 
iP¨ít
, 
pSub
->
pELi°
);

3044 if–
pSub
->
pWhîe
 ){

3045 
pWhîe
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pSub
->pWhere, 0);

3047 
pWhîe
 = 0;

3049 if–
subquîyIsAgg
 ){

3050 
	`as£π
–
pP¨ít
->
pHavög
==0 );

3051 
pP¨ít
->
pHavög
 =ÖP¨ít->
pWhîe
;

3052 
pP¨ít
->
pWhîe
 =ÖWhere;

3053 
pP¨ít
->
pHavög
 = 
	`sub°Ex¥
(
db
,ÖP¨ít->pHavög, 
iP¨ít
, 
pSub
->
pELi°
);

3054 
pP¨ít
->
pHavög
 = 
	`sqlôe4Ex¥And
(
db
,ÖParent->pHaving,

3055 
	`sqlôe4Ex¥Dup
(
db
, 
pSub
->
pHavög
, 0));

3056 
	`as£π
–
pP¨ít
->
pGroupBy
==0 );

3057 
pP¨ít
->
pGroupBy
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
pSub
->pGroupBy, 0);

3059 
pP¨ít
->
pWhîe
 = 
	`sub°Ex¥
(
db
,ÖP¨ít->pWhîe, 
iP¨ít
, 
pSub
->
pELi°
);

3060 
pP¨ít
->
pWhîe
 = 
	`sqlôe4Ex¥And
(
db
,ÖParent->pWhere,ÖWhere);

3066 
pP¨ít
->
£lFœgs
 |
pSub
->£lFœg†& 
SF_Di°ö˘
;

3074 if–
pSub
->
pLimô
 ){

3075 
pP¨ít
->
pLimô
 = 
pSub
->pLimit;

3076 
pSub
->
pLimô
 = 0;

3083 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSub1
);

3086 
	}
}

3100 
u8
 
	$möMaxQuîy
(
Sñe˘
 *
p
){

3101 
Ex¥
 *
pEx¥
;

3102 
Ex¥Li°
 *
pELi°
 = 
p
->pEList;

3104 if–
pELi°
->
nEx¥
!=1 )  
WHERE_ORDERBY_NORMAL
;

3105 
pEx¥
 = 
pELi°
->
a
[0].pExpr;

3106 if–
pEx¥
->
›
!=
TK_AGG_FUNCTION
 )  0;

3107 if–
	`NEVER
(
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
)) )  0;

3108 
pELi°
 = 
pEx¥
->
x
.
pLi°
;

3109 if–
pELi°
==0 ||ÖELi°->
nEx¥
!=1 )  0;

3110 if–
pELi°
->
a
[0].
pEx¥
->
›
!=
TK_AGG_COLUMN
 )  
WHERE_ORDERBY_NORMAL
;

3111 
	`as£π
–!
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) );

3112 if–
	`sqlôe4_°ricmp
(
pEx¥
->
u
.
zTokí
,"min")==0 ){

3113  
WHERE_ORDERBY_MIN
;

3114 }if–
	`sqlôe4_°ricmp
(
pEx¥
->
u
.
zTokí
,"max")==0 ){

3115  
WHERE_ORDERBY_MAX
;

3117  
WHERE_ORDERBY_NORMAL
;

3118 
	}
}

3127 
	$sqlôe4IndexedByLookup
(
P¨£
 *
pP¨£
, 
SrcLi°Iãm
 *
pFrom
){

3128 if–
pFrom
->
pTab
 &&ÖFrom->
zIndex
 ){

3129 
TabÀ
 *
pTab
 = 
pFrom
->pTab;

3130 *
zIndex
 = 
pFrom
->zIndex;

3131 
Index
 *
pIdx
;

3132 
pIdx
=
pTab
->
pIndex
;

3133 
pIdx
 && 
	`sqlôe4_°ricmp
’Idx->
zName
, 
zIndex
);

3134 
pIdx
ıIdx->
pNext


3136 if–!
pIdx
 ){

3137 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuch index: %s", 
zIndex
, 0);

3138 
pP¨£
->
checkSchema
 = 1;

3139  
SQLITE4_ERROR
;

3141 
pFrom
->
pIndex
 = 
pIdx
;

3143  
SQLITE4_OK
;

3144 
	}
}

3170 
	$£À˘Ex∑ndî
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
p
){

3171 
P¨£
 *
pP¨£
 = 
pWÆkî
->pParse;

3172 
i
, 
j
, 
k
;

3173 
SrcLi°
 *
pTabLi°
;

3174 
Ex¥Li°
 *
pELi°
;

3175 
SrcLi°Iãm
 *
pFrom
;

3176 
sqlôe4
 *
db
 = 
pP¨£
->db;

3178 if–
db
->
mÆlocFaûed
 ){

3179  
WRC_Ab‹t
;

3181 if–
	`NEVER
(
p
->
pSrc
==0Ë|| (p->
£lFœgs
 & 
SF_Ex∑nded
)!=0 ){

3182  
WRC_Pru√
;

3184 
p
->
£lFœgs
 |
SF_Ex∑nded
;

3185 
pTabLi°
 = 
p
->
pSrc
;

3186 
pELi°
 = 
p
->pEList;

3191 
	`sqlôe4SrcLi°AssignCurs‹s
(
pP¨£
, 
pTabLi°
);

3197 
i
=0, 
pFrom
=
pTabLi°
->
a
; i<pTabLi°->
nSrc
; i++,ÖFrom++){

3198 
TabÀ
 *
pTab
;

3199 if–
pFrom
->
pTab
!=0 ){

3202 
	`as£π
–
i
==0 );

3203  
WRC_Pru√
;

3205 if–
pFrom
->
zName
==0 ){

3206 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3207 
Sñe˘
 *
pSñ
 = 
pFrom
->
pSñe˘
;

3209 
	`as£π
–
pSñ
!=0 );

3210 
	`as£π
–
pFrom
->
pTab
==0 );

3211 
	`sqlôe4WÆkSñe˘
(
pWÆkî
, 
pSñ
);

3212 
pFrom
->
pTab
 =ÖTab = 
	`sqlôe4DbMÆlocZîo
(
db
, (
TabÀ
));

3213 if–
pTab
==0 )  
WRC_Ab‹t
;

3214 
pTab
->
nRef
 = 1;

3215 
pTab
->
zName
 = 
	`sqlôe4MPrötf
(
db
, "sqlite_subquery_%p_", (*)pTab);

3216  
pSñ
->
pPri‹
 ){ÖSel =ÖSel->pPrior; }

3217 
	`£À˘CﬁumnsFromEx¥Li°
(
pP¨£
, 
pSñ
->
pELi°
, &
pTab
->
nCﬁ
, &pTab->
aCﬁ
);

3218 
pTab
->
nRowE°
 = 1000000;

3219 
pTab
->
èbFœgs
 |
TF_EphemîÆ
;

3223 
	`as£π
–
pFrom
->
pTab
==0 );

3224 
pFrom
->
pTab
 =ÖTab =

3225 
	`sqlôe4LoˇãTabÀ
(
pP¨£
,0,
pFrom
->
zName
,pFrom->
zD©aba£
);

3226 if–
pTab
==0 )  
WRC_Ab‹t
;

3227 
pTab
->
nRef
++;

3228 #i‡!
	`deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed (
SQLITE4_OMIT_VIRTUALTABLE
)

3229 if–
pTab
->
pSñe˘
 || 
	`IsVútuÆ
(pTab) ){

3231 if–
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
, 
pTab
ËË 
WRC_Ab‹t
;

3232 
	`as£π
–
pFrom
->
pSñe˘
==0 );

3233 
pFrom
->
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
pTab
->pSelect, 0);

3234 
	`sqlôe4WÆkSñe˘
(
pWÆkî
, 
pFrom
->
pSñe˘
);

3240 if–
	`sqlôe4IndexedByLookup
(
pP¨£
, 
pFrom
) ){

3241  
WRC_Ab‹t
;

3247 if–
db
->
mÆlocFaûed
 || 
	`sqlôePro˚ssJoö
(
pP¨£
, 
p
) ){

3248  
WRC_Ab‹t
;

3261 
k
=0; k<
pELi°
->
nEx¥
; k++){

3262 
Ex¥
 *
pE
 = 
pELi°
->
a
[
k
].
pEx¥
;

3263 if–
pE
->
›
==
TK_ALL
 ) ;

3264 
	`as£π
–
pE
->
›
!=
TK_DOT
 ||ÖE->
pRight
!=0 );

3265 
	`as£π
–
pE
->
›
!=
TK_DOT
 || (pE->
pLe·
!=0 &&ÖE->pLe·->›==
TK_ID
) );

3266 if–
pE
->
›
==
TK_DOT
 &&ÖE->
pRight
->›==
TK_ALL
 ) ;

3268 if–
k
<
pELi°
->
nEx¥
 ){

3274 
Ex¥Li°Iãm
 *
a
 = 
pELi°
->a;

3275 
Ex¥Li°
 *
pNew
 = 0;

3277 
k
=0; k<
pELi°
->
nEx¥
; k++){

3278 
Ex¥
 *
pE
 = 
a
[
k
].
pEx¥
;

3279 
	`as£π
–
pE
->
›
!=
TK_DOT
 ||ÖE->
pRight
!=0 );

3280 if–
pE
->
›
!=
TK_ALL
 && (pE->›!=
TK_DOT
 ||ÖE->
pRight
->op!=TK_ALL) ){

3283 
pNew
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,ÖNew, 
a
[
k
].
pEx¥
);

3284 if–
pNew
 ){

3285 
pNew
->
a
[pNew->
nEx¥
-1].
zName
 =á[
k
].zName;

3286 
pNew
->
a
[pNew->
nEx¥
-1].
zS∑n
 =á[
k
].zSpan;

3287 
a
[
k
].
zName
 = 0;

3288 
a
[
k
].
zS∑n
 = 0;

3290 
a
[
k
].
pEx¥
 = 0;

3294 
èbÀSìn
 = 0;

3295 *
zTName
;

3296 if–
pE
->
›
==
TK_DOT
 ){

3297 
	`as£π
–
pE
->
pLe·
!=0 );

3298 
	`as£π
–!
	`Ex¥HasPr›îty
(
pE
->
pLe·
, 
EP_I¡VÆue
) );

3299 
zTName
 = 
pE
->
pLe·
->
u
.
zTokí
;

3301 
zTName
 = 0;

3303 
i
=0, 
pFrom
=
pTabLi°
->
a
; i<pTabLi°->
nSrc
; i++,ÖFrom++){

3304 
TabÀ
 *
pTab
 = 
pFrom
->pTab;

3305 *
zTabName
 = 
pFrom
->
zAlüs
;

3306 if–
zTabName
==0 ){

3307 
zTabName
 = 
pTab
->
zName
;

3309 if–
db
->
mÆlocFaûed
 ) ;

3310 if–
zTName
 && 
	`sqlôe4_°ricmp
(zTName, 
zTabName
)!=0 ){

3313 
èbÀSìn
 = 1;

3314 
j
=0; j<
pTab
->
nCﬁ
; j++){

3315 
Ex¥
 *
pEx¥
, *
pRight
;

3316 *
zName
 = 
pTab
->
aCﬁ
[
j
].zName;

3317 *
zCﬁ«me
;

3318 *
zToFªe
;

3319 
Tokí
 
sCﬁ«me
;

3325 if–
	`IsHiddíCﬁumn
(&
pTab
->
aCﬁ
[
j
]) ){

3326 
	`as£π
(
	`IsVútuÆ
(
pTab
));

3330 if–
i
>0 && 
zTName
==0 ){

3331 if–(
pFrom
->
joöty≥
 & 
JT_NATURAL
)!=0

3332 && 
	`èbÀAndCﬁumnIndex
(
pTabLi°
, 
i
, 
zName
, 0, 0)

3338 if–
	`sqlôe4IdLi°Index
(
pFrom
->
pUsög
, 
zName
)>=0 ){

3344 
pRight
 = 
	`sqlôe4Ex¥
(
db
, 
TK_ID
, 
zName
);

3345 
zCﬁ«me
 = 
zName
;

3346 
zToFªe
 = 0;

3347 if–
pTabLi°
->
nSrc
>1 ){

3348 
Ex¥
 *
pLe·
;

3349 
pLe·
 = 
	`sqlôe4Ex¥
(
db
, 
TK_ID
, 
zTabName
);

3350 
pEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_DOT
, 
pLe·
, 
pRight
, 0);

3352 
pEx¥
 = 
pRight
;

3354 
pNew
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,ÖNew, 
pEx¥
);

3355 
sCﬁ«me
.
z
 = 
zCﬁ«me
;

3356 
sCﬁ«me
.
n
 = 
	`sqlôe4SåÀn30
(
zCﬁ«me
);

3357 
	`sqlôe4Ex¥Li°SëName
(
pP¨£
, 
pNew
, &
sCﬁ«me
, 0);

3358 
	`sqlôe4DbFªe
(
db
, 
zToFªe
);

3361 if–!
èbÀSìn
 ){

3362 if–
zTName
 ){

3363 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuchÅabÀ: %s", 
zTName
);

3365 
	`sqlôe4Eº‹Msg
(
pP¨£
, "noÅables specified");

3370 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pELi°
);

3371 
p
->
pELi°
 = 
pNew
;

3373 #i‡
SQLITE4_MAX_COLUMN


3374 if–
p
->
pELi°
 &&Ö->pELi°->
nEx¥
>
db
->
aLimô
[
SQLITE4_LIMIT_COLUMN
] ){

3375 
	`sqlôe4Eº‹Msg
(
pP¨£
, "too many columns inÑesult set");

3378  
WRC_C⁄töue
;

3379 
	}
}

3390 
	$ex¥WÆkNo›
(
WÆkî
 *
NŸU£d
, 
Ex¥
 *
NŸU£d2
){

3391 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

3392  
WRC_C⁄töue
;

3393 
	}
}

3408 
	$sqlôe4Sñe˘Ex∑nd
(
P¨£
 *
pP¨£
, 
Sñe˘
 *
pSñe˘
){

3409 
WÆkî
 
w
;

3410 
w
.
xSñe˘CÆlback
 = 
£À˘Ex∑ndî
;

3411 
w
.
xEx¥CÆlback
 = 
ex¥WÆkNo›
;

3412 
w
.
pP¨£
 =ÖParse;

3413 
	`sqlôe4WÆkSñe˘
(&
w
, 
pSñe˘
);

3414 
	}
}

3417 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3431 
	$£À˘AddSubquîyTy≥Info
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
p
){

3432 
P¨£
 *
pP¨£
;

3433 
i
;

3434 
SrcLi°
 *
pTabLi°
;

3435 
SrcLi°Iãm
 *
pFrom
;

3437 
	`as£π
–
p
->
£lFœgs
 & 
SF_Resﬁved
 );

3438 if–(
p
->
£lFœgs
 & 
SF_HasTy≥Info
)==0 ){

3439 
p
->
£lFœgs
 |
SF_HasTy≥Info
;

3440 
pP¨£
 = 
pWÆkî
->pParse;

3441 
pTabLi°
 = 
p
->
pSrc
;

3442 
i
=0, 
pFrom
=
pTabLi°
->
a
; i<pTabLi°->
nSrc
; i++,ÖFrom++){

3443 
TabÀ
 *
pTab
 = 
pFrom
->pTab;

3444 if–
	`ALWAYS
(
pTab
!=0Ë&& (pTab->
èbFœgs
 & 
TF_EphemîÆ
)!=0 ){

3446 
Sñe˘
 *
pSñ
 = 
pFrom
->
pSñe˘
;

3447 
	`as£π
–
pSñ
 );

3448  
pSñ
->
pPri‹
 )ÖSel =ÖSel->pPrior;

3449 
	`£À˘AddCﬁumnTy≥AndCﬁœti⁄
(
pP¨£
, 
pTab
->
nCﬁ
,ÖTab->
aCﬁ
, 
pSñ
);

3453  
WRC_C⁄töue
;

3454 
	}
}

3465 
	$sqlôe4Sñe˘AddTy≥Info
(
P¨£
 *
pP¨£
, 
Sñe˘
 *
pSñe˘
){

3466 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3467 
WÆkî
 
w
;

3468 
w
.
xSñe˘CÆlback
 = 
£À˘AddSubquîyTy≥Info
;

3469 
w
.
xEx¥CÆlback
 = 
ex¥WÆkNo›
;

3470 
w
.
pP¨£
 =ÖParse;

3471 
	`sqlôe4WÆkSñe˘
(&
w
, 
pSñe˘
);

3473 
	}
}

3488 
	$sqlôe4Sñe˘Pªp
(

3489 
P¨£
 *
pP¨£
,

3490 
Sñe˘
 *
p
,

3491 
NameC⁄ãxt
 *
pOuãrNC


3493 
sqlôe4
 *
db
;

3494 if–
	`NEVER
(
p
==0) ) ;

3495 
db
 = 
pP¨£
->db;

3496 if–
p
->
£lFœgs
 & 
SF_HasTy≥Info
 ) ;

3497 
	`sqlôe4Sñe˘Ex∑nd
(
pP¨£
, 
p
);

3498 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ) ;

3499 
	`sqlôe4ResﬁveSñe˘Names
(
pP¨£
, 
p
, 
pOuãrNC
);

3500 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ) ;

3501 
	`sqlôe4Sñe˘AddTy≥Info
(
pP¨£
, 
p
);

3502 
	}
}

3511 
	$ª£tAccumuœt‹
(
P¨£
 *
pP¨£
, 
AggInfo
 *
pAggInfo
){

3512 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3513 
i
;

3514 
AggInfoFunc
 *
pFunc
;

3515 if–
pAggInfo
->
nFunc
+pAggInfo->
nCﬁumn
==0 ){

3518 
i
=0; i<
pAggInfo
->
nCﬁumn
; i++){

3519 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
pAggInfo
->
aCﬁ
[
i
].
iMem
);

3521 
pFunc
=
pAggInfo
->
aFunc
, 
i
=0; i<pAggInfo->
nFunc
; i++,ÖFunc++){

3522 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
pFunc
->
iMem
);

3523 if–
pFunc
->
iDi°ö˘
>=0 ){

3524 
Ex¥
 *
pE
 = 
pFunc
->
pEx¥
;

3525 
	`as£π
–!
	`Ex¥HasPr›îty
(
pE
, 
EP_xIsSñe˘
) );

3526 if–
pE
->
x
.
pLi°
==0 ||ÖE->x.pLi°->
nEx¥
!=1 ){

3527 
	`sqlôe4Eº‹Msg
(
pP¨£
, "DISTINCTággregates must haveÉxactly one "

3529 
pFunc
->
iDi°ö˘
 = -1;

3531 
KeyInfo
 *
pKeyInfo
 = 
	`keyInfoFromEx¥Li°
(
pP¨£
, 
pE
->
x
.
pLi°
, 0);

3532 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_O≥nEphemîÆ
, 
pFunc
->
iDi°ö˘
, 0, 0,

3533 (*)
pKeyInfo
, 
P4_KEYINFO_HANDOFF
);

3537 
	}
}

3543 
	$föÆizeAggFun˘i⁄s
(
P¨£
 *
pP¨£
, 
AggInfo
 *
pAggInfo
){

3544 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3545 
i
;

3546 
AggInfoFunc
 *
pF
;

3547 
i
=0, 
pF
=
pAggInfo
->
aFunc
; i<pAggInfo->
nFunc
; i++,ÖF++){

3548 
Ex¥Li°
 *
pLi°
 = 
pF
->
pEx¥
->
x
.pList;

3549 
	`as£π
–!
	`Ex¥HasPr›îty
(
pF
->
pEx¥
, 
EP_xIsSñe˘
) );

3550 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_AggFöÆ
, 
pF
->
iMem
, 
pLi°
 ?ÖLi°->
nEx¥
 : 0, 0,

3551 (*)
pF
->
pFunc
, 
P4_FUNCDEF
);

3553 
	}
}

3559 
	$upd©eAccumuœt‹
(
P¨£
 *
pP¨£
, 
AggInfo
 *
pAggInfo
){

3560 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3561 
i
;

3562 
AggInfoFunc
 *
pF
;

3563 
AggInfoCﬁ
 *
pC
;

3565 
pAggInfo
->
dúe˘Mode
 = 1;

3566 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

3567 
i
=0, 
pF
=
pAggInfo
->
aFunc
; i<pAggInfo->
nFunc
; i++,ÖF++){

3568 
nArg
;

3569 
addrNext
 = 0;

3570 
ªgAgg
;

3571 
Ex¥Li°
 *
pLi°
 = 
pF
->
pEx¥
->
x
.pList;

3572 
	`as£π
–!
	`Ex¥HasPr›îty
(
pF
->
pEx¥
, 
EP_xIsSñe˘
) );

3573 if–
pLi°
 ){

3574 
nArg
 = 
pLi°
->
nEx¥
;

3575 
ªgAgg
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nArg
);

3576 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pLi°
, 
ªgAgg
, 1);

3578 
nArg
 = 0;

3579 
ªgAgg
 = 0;

3581 if–
pF
->
iDi°ö˘
>=0 ){

3582 
addrNext
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3583 
	`as£π
–
nArg
==1 );

3584 
	`codeDi°ö˘
(
pP¨£
, 
pF
->
iDi°ö˘
, 
addrNext
, 1, 
ªgAgg
);

3586 if–
pF
->
pFunc
->
Êags
 & 
SQLITE4_FUNC_NEEDCOLL
 ){

3587 
CﬁlSeq
 *
pCﬁl
 = 0;

3588 
Ex¥Li°Iãm
 *
pIãm
;

3589 
j
;

3590 
	`as£π
–
pLi°
!=0 );

3591 
j
=0, 
pIãm
=
pLi°
->
a
; !
pCﬁl
 && j<
nArg
; j++,ÖItem++){

3592 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pIãm
->
pEx¥
);

3594 if–!
pCﬁl
 ){

3595 
pCﬁl
 = 
pP¨£
->
db
->
pDÊtCﬁl
;

3597 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_CﬁlSeq
, 0, 0, 0, (*)
pCﬁl
, 
P4_COLLSEQ
);

3599 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_AggSãp
, 0, 
ªgAgg
, 
pF
->
iMem
,

3600 (*)
pF
->
pFunc
, 
P4_FUNCDEF
);

3601 
	`sqlôe4VdbeCh™geP5
(
v
, (
u8
)
nArg
);

3602 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
ªgAgg
, 
nArg
);

3603 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgAgg
, 
nArg
);

3604 if–
addrNext
 ){

3605 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
addrNext
);

3606 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

3620 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

3621 
i
=0, 
pC
=
pAggInfo
->
aCﬁ
; i<pAggInfo->
nAccumuœt‹
; i++,ÖC++){

3622 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pC
->
pEx¥
,ÖC->
iMem
);

3624 
pAggInfo
->
dúe˘Mode
 = 0;

3625 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

3626 
	}
}

3682 
	$sqlôe4Sñe˘
(

3683 
P¨£
 *
pP¨£
,

3684 
Sñe˘
 *
p
,

3685 
Sñe˘De°
 *
pDe°


3687 
i
, 
j
;

3688 
WhîeInfo
 *
pWInfo
;

3689 
Vdbe
 *
v
;

3690 
isAgg
;

3691 
Ex¥Li°
 *
pELi°
;

3692 
SrcLi°
 *
pTabLi°
;

3693 
Ex¥
 *
pWhîe
;

3694 
Ex¥Li°
 *
pOrdîBy
;

3695 
Ex¥Li°
 *
pGroupBy
;

3696 
Ex¥
 *
pHavög
;

3697 
isDi°ö˘
;

3698 
di°ö˘
;

3699 
rc
 = 1;

3700 
addrS‹tIndex
;

3701 
addrDi°ö˘Index
;

3702 
AggInfo
 
sAggInfo
;

3703 
iEnd
;

3704 
sqlôe4
 *
db
;

3706 #i‚de‡
SQLITE4_OMIT_EXPLAIN


3707 
iRe°‹eSñe˘Id
 = 
pP¨£
->
iSñe˘Id
;

3708 
pP¨£
->
iSñe˘Id
 =ÖP¨£->
iNextSñe˘Id
++;

3711 
	`mem£t
(&
sAggInfo
, 0, (sAggInfo));

3713 
db
 = 
pP¨£
->db;

3714 if–
p
==0 || 
db
->
mÆlocFaûed
 || 
pP¨£
->
nEº
 ){

3717 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_SELECT
, 0, 0, 0) )  1;

3719 if–
	`Ign‹abÀOrdîby
(
pDe°
) ){

3720 
	`as£π
(
pDe°
->
eDe°
==
SRT_Exi°s
 ||ÖDe°->eDe°==
SRT_Uni⁄
 ||

3721 
pDe°
->
eDe°
==
SRT_Ex˚±
 ||ÖDe°->eDe°==
SRT_Disˇrd
);

3724 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
p
->
pOrdîBy
);

3725 
p
->
pOrdîBy
 = 0;

3726 
p
->
£lFœgs
 &~
SF_Di°ö˘
;

3728 
	`sqlôe4Sñe˘Pªp
(
pP¨£
, 
p
, 0);

3729 
pOrdîBy
 = 
p
->pOrderBy;

3730 
pTabLi°
 = 
p
->
pSrc
;

3731 
pELi°
 = 
p
->pEList;

3732 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ){

3733 
£À˘_íd
;

3735 
isAgg
 = (
p
->
£lFœgs
 & 
SF_Aggªg©e
)!=0;

3736 
	`as£π
–
pELi°
!=0 );

3740 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

3741 if–
v
==0 ) 
£À˘_íd
;

3746 #i‚de‡
SQLITE4_OMIT_SUBQUERY


3747 if–
	`checkF‹Mu…iCﬁumnSñe˘Eº‹
(
pP¨£
, 
pDe°
, 
pELi°
->
nEx¥
) ){

3748 
£À˘_íd
;

3754 #i‡!
	`deföed
(
SQLITE4_OMIT_SUBQUERY
Ë|| !deföed(
SQLITE4_OMIT_VIEW
)

3755 
i
=0; !
p
->
pPri‹
 && i<
pTabLi°
->
nSrc
; i++){

3756 
SrcLi°Iãm
 *
pIãm
 = &
pTabLi°
->
a
[
i
];

3757 
Sñe˘De°
 
de°
;

3758 
Sñe˘
 *
pSub
 = 
pIãm
->
pSñe˘
;

3759 
isAggSub
;

3761 if–
pSub
==0 ) ;

3762 if–
pIãm
->
addrFûlSub
 ){

3763 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
pIãm
->
ªgRëu∫
,ÖIãm->
addrFûlSub
);

3774 
pP¨£
->
nHeight
 +
	`sqlôe4Sñe˘Ex¥Height
(
p
);

3776 
isAggSub
 = (
pSub
->
£lFœgs
 & 
SF_Aggªg©e
)!=0;

3777 if–
	`Ê©ãnSubquîy
(
pP¨£
, 
p
, 
i
, 
isAgg
, 
isAggSub
) ){

3779 if–
isAggSub
 ){

3780 
isAgg
 = 1;

3781 
p
->
£lFœgs
 |
SF_Aggªg©e
;

3783 
i
 = -1;

3790 
t›Addr
;

3791 
⁄˚Addr
 = 0;

3792 
ªtAddr
;

3793 
	`as£π
–
pIãm
->
addrFûlSub
==0 );

3794 
pIãm
->
ªgRëu∫
 = ++
pP¨£
->
nMem
;

3795 
t›Addr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
pIãm
->
ªgRëu∫
);

3796 
pIãm
->
addrFûlSub
 = 
t›Addr
+1;

3797 
	`VdbeNo›Commít
((
v
, "m©îülizê%s", 
pIãm
->
pTab
->
zName
));

3798 if–
pIãm
->
isC‹ªœãd
==0 ){

3802 
⁄˚Addr
 = 
	`sqlôe4CodeOn˚
(
pP¨£
);

3804 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 
SRT_EphemTab
, 
pIãm
->
iCurs‹
);

3805 
	`ex∂aöSëI¡egî
(
pIãm
->
iSñe˘Id
, (
u8
)
pP¨£
->
iNextSñe˘Id
);

3806 
	`sqlôe4Sñe˘
(
pP¨£
, 
pSub
, &
de°
);

3807 
pIãm
->
pTab
->
nRowE°
 = ()
pSub
->
nSñe˘Row
;

3808 if–
⁄˚Addr
 ) 
	`sqlôe4VdbeJumpHîe
(
v
, onceAddr);

3809 
ªtAddr
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rëu∫
, 
pIãm
->
ªgRëu∫
);

3810 
	`VdbeCommít
((
v
, "íd %s", 
pIãm
->
pTab
->
zName
));

3811 
	`sqlôe4VdbeCh™geP1
(
v
, 
t›Addr
, 
ªtAddr
);

3812 
	`sqlôe4CÀ¨TempRegCache
(
pP¨£
);

3814 if– 
db
->
mÆlocFaûed
 ){

3815 
£À˘_íd
;

3817 
pP¨£
->
nHeight
 -
	`sqlôe4Sñe˘Ex¥Height
(
p
);

3818 
pTabLi°
 = 
p
->
pSrc
;

3819 if–!
	`Ign‹abÀOrdîby
(
pDe°
) ){

3820 
pOrdîBy
 = 
p
->pOrderBy;

3823 
pELi°
 = 
p
->pEList;

3825 
pWhîe
 = 
p
->pWhere;

3826 
pGroupBy
 = 
p
->pGroupBy;

3827 
pHavög
 = 
p
->pHaving;

3828 
isDi°ö˘
 = (
p
->
£lFœgs
 & 
SF_Di°ö˘
)!=0;

3830 #i‚de‡
SQLITE4_OMIT_COMPOUND_SELECT


3833 if–
p
->
pPri‹
 ){

3834 if–
p
->
pRightmo°
==0 ){

3835 
Sñe˘
 *
pLo›
, *
pRight
 = 0;

3836 
˙t
 = 0;

3837 
mxSñe˘
;

3838 
pLo›
=
p
;ÖLo›;ÖLo›ıLo›->
pPri‹
, 
˙t
++){

3839 
pLo›
->
pRightmo°
 = 
p
;

3840 
pLo›
->
pNext
 = 
pRight
;

3841 
pRight
 = 
pLo›
;

3843 
mxSñe˘
 = 
db
->
aLimô
[
SQLITE4_LIMIT_COMPOUND_SELECT
];

3844 if–
mxSñe˘
 && 
˙t
>mxSelect ){

3845 
	`sqlôe4Eº‹Msg
(
pP¨£
, "too manyÅerms in compound SELECT");

3846 
£À˘_íd
;

3849 
rc
 = 
	`mu…iSñe˘
(
pP¨£
, 
p
, 
pDe°
);

3850 
	`ex∂aöSëI¡egî
(
pP¨£
->
iSñe˘Id
, 
iRe°‹eSñe˘Id
);

3851  
rc
;

3862 if–
	`sqlôe4Ex¥Li°Com∑ª
(
p
->
pGroupBy
, 
pOrdîBy
)==0

3863 && (
db
->
Êags
 & 
SQLITE4_GroupByOrdî
)==0 ){

3864 
pOrdîBy
 = 0;

3882 if–(
p
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
))==SF_Distinct

3883 && 
	`sqlôe4Ex¥Li°Com∑ª
(
pOrdîBy
, 
p
->
pELi°
)==0

3885 
p
->
£lFœgs
 &~
SF_Di°ö˘
;

3886 
p
->
pGroupBy
 = 
	`sqlôe4Ex¥Li°Dup
(
db
,Ö->
pELi°
, 0);

3887 
pGroupBy
 = 
p
->pGroupBy;

3888 
pOrdîBy
 = 0;

3898 if–
pOrdîBy
 ){

3899 
KeyInfo
 *
pKeyInfo
;

3900 
pKeyInfo
 = 
	`keyInfoFromEx¥Li°
(
pP¨£
, 
pOrdîBy
, 1);

3901 if–
pKeyInfo
 )ÖKeyInfo->
nD©a
 = 
pELi°
->
nEx¥
;

3903 
pOrdîBy
->
iECurs‹
 = 
pP¨£
->
nTab
++;

3904 
p
->
addrO≥nEphm
[2] = 
addrS‹tIndex
 =

3905 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_O≥nEphemîÆ
,

3906 
pOrdîBy
->
iECurs‹
,ÖOrdîBy->
nEx¥
+2, 0,

3907 (*)
pKeyInfo
, 
P4_KEYINFO_HANDOFF
);

3909 
addrS‹tIndex
 = -1;

3914 if–
pDe°
->
eDe°
==
SRT_EphemTab
 ){

3915 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
pDe°
->
iP¨m
, 
pELi°
->
nEx¥
);

3920 
iEnd
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3921 
p
->
nSñe˘Row
 = ()
LARGEST_INT64
;

3922 
	`compuãLimôRegi°îs
(
pP¨£
, 
p
, 
iEnd
);

3923 if–
p
->
iLimô
==0 && 
addrS‹tIndex
>=0 ){

3924 
	`sqlôe4VdbeGëOp
(
v
, 
addrS‹tIndex
)->
›code
 = 
OP_S‹ãrO≥n
;

3925 
p
->
£lFœgs
 |
SF_U£S‹ãr
;

3930 if–
p
->
£lFœgs
 & 
SF_Di°ö˘
 ){

3931 
KeyInfo
 *
pKeyInfo
;

3932 
di°ö˘
 = 
pP¨£
->
nTab
++;

3933 
pKeyInfo
 = 
	`keyInfoFromEx¥Li°
(
pP¨£
, 
p
->
pELi°
, 0);

3934 
addrDi°ö˘Index
 = 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_O≥nEphemîÆ
, 
di°ö˘
, 0, 0,

3935 (*)
pKeyInfo
, 
P4_KEYINFO_HANDOFF
);

3937 
di°ö˘
 = 
addrDi°ö˘Index
 = -1;

3941 if–!
isAgg
 && 
pGroupBy
==0 ){

3942 
Ex¥Li°
 *
pDi°
 = (
isDi°ö˘
 ? 
p
->
pELi°
 : 0);

3945 
pWInfo
 = 
	`sqlôe4WhîeBegö
(
pP¨£
, 
pTabLi°
, 
pWhîe
, 
pOrdîBy
, 
pDi°
, 0, 0);

3946 if–
pWInfo
==0 ) 
£À˘_íd
;

3947 if–
	`sqlôe4WhîeOuçutRowCou¡
(
pWInfo
)<
p
->
nSñe˘Row
 ){

3948 
p
->
nSñe˘Row
 = 
	`sqlôe4WhîeOuçutRowCou¡
(
pWInfo
);

3950 if–
pOrdîBy
 && 
	`sqlôe4WhîeIsOrdîed
(
pWInfo
) )ÖOrderBy = 0;

3956 if–
addrS‹tIndex
>=0 && 
pOrdîBy
==0 ){

3957 
	`sqlôe4VdbeCh™geToNo›
(
v
, 
addrS‹tIndex
);

3958 
p
->
addrO≥nEphm
[2] = -1;

3961 if–
	`sqlôe4WhîeIsDi°ö˘
(
pWInfo
) ){

3962 
VdbeOp
 *
pOp
;

3964 
	`as£π
–
addrDi°ö˘Index
>=0 );

3965 
pOp
 = 
	`sqlôe4VdbeGëOp
(
v
, 
addrDi°ö˘Index
);

3967 
	`as£π
–
isDi°ö˘
 );

3968 
	`as£π
–
	`sqlôe4WhîeIsDi°ö˘
(
pWInfo
)==
WHERE_DISTINCT_ORDERED


3969 || 
	`sqlôe4WhîeIsDi°ö˘
(
pWInfo
)==
WHERE_DISTINCT_UNIQUE


3971 
di°ö˘
 = -1;

3972 if–
	`sqlôe4WhîeIsDi°ö˘
(
pWInfo
)==
WHERE_DISTINCT_ORDERED
 ){

3973 
iJump
;

3974 
iEx¥
;

3975 
iFœg
 = ++
pP¨£
->
nMem
;

3976 
iBa£
 = 
pP¨£
->
nMem
+1;

3977 
iBa£2
 = 
iBa£
 + 
pELi°
->
nEx¥
;

3978 
pP¨£
->
nMem
 +(
pELi°
->
nEx¥
*2);

3982 
pOp
->
›code
 = 
OP_I¡egî
;

3983 
pOp
->
p1
 = 1;

3984 
pOp
->
p2
 = 
iFœg
;

3986 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pELi°
, 
iBa£
, 1);

3987 
iJump
 = 
	`sqlôe4VdbeCuºítAddr
(
v
Ë+ 1 + 
pELi°
->
nEx¥
 + 1 + 1;

3988 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
iFœg
, 
iJump
-1);

3989 
iEx¥
=0; iEx¥<
pELi°
->
nEx¥
; iExpr++){

3990 
CﬁlSeq
 *
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pELi°
->
a
[
iEx¥
].
pEx¥
);

3991 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Ne
, 
iBa£
+
iEx¥
, 
iJump
, 
iBa£2
+iExpr);

3992 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pCﬁl
, 
P4_COLLSEQ
);

3993 
	`sqlôe4VdbeCh™geP5
(
v
, 
SQLITE4_NULLEQ
);

3995 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
	`sqlôe4WhîeC⁄töueLabñ
(
pWInfo
));

3997 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
iFœg
);

3998 
	`as£π
–
	`sqlôe4VdbeCuºítAddr
(
v
)==
iJump
 );

3999 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Move
, 
iBa£
, 
iBa£2
, 
pELi°
->
nEx¥
);

4001 
pOp
->
›code
 = 
OP_No›
;

4006 
	`£À˘I¬îLo›
(
pP¨£
, 
p
, 
pELi°
, 0, 0, 
pOrdîBy
, 
di°ö˘
, 
pDe°
,

4007 
	`sqlôe4WhîeC⁄töueLabñ
(
pWInfo
), 
	`sqlôe4WhîeBªakLabñ
(pWInfo)

4012 
	`sqlôe4WhîeEnd
(
pWInfo
);

4015 
NameC⁄ãxt
 
sNC
;

4016 
iAMem
;

4017 
iBMem
;

4018 
iU£Fœg
;

4021 
iAb‹tFœg
;

4022 
groupByS‹t
;

4023 
addrEnd
;

4028 if–
pGroupBy
 ){

4029 
k
;

4030 
Ex¥Li°Iãm
 *
pIãm
;

4032 
k
=
p
->
pELi°
->
nEx¥
, 
pIãm
ı->pELi°->
a
; k>0; k--,ÖItem++){

4033 
pIãm
->
iAlüs
 = 0;

4035 
k
=
pGroupBy
->
nEx¥
, 
pIãm
ıGroupBy->
a
; k>0; k--,ÖItem++){

4036 
pIãm
->
iAlüs
 = 0;

4038 if–
p
->
nSñe˘Row
>()100 )Ö->nSelectRow = ()100;

4040 
p
->
nSñe˘Row
 = ()1;

4045 
addrEnd
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

4051 
	`mem£t
(&
sNC
, 0, (sNC));

4052 
sNC
.
pP¨£
 =ÖParse;

4053 
sNC
.
pSrcLi°
 = 
pTabLi°
;

4054 
sNC
.
pAggInfo
 = &
sAggInfo
;

4055 
sAggInfo
.
nS‹tögCﬁumn
 = 
pGroupBy
 ?ÖGroupBy->
nEx¥
+1 : 0;

4056 
sAggInfo
.
pGroupBy
 =ÖGroupBy;

4057 
	`sqlôe4Ex¥A«lyzeAggLi°
(&
sNC
, 
pELi°
);

4058 
	`sqlôe4Ex¥A«lyzeAggLi°
(&
sNC
, 
pOrdîBy
);

4059 if–
pHavög
 ){

4060 
	`sqlôe4Ex¥A«lyzeAggªg©es
(&
sNC
, 
pHavög
);

4062 
sAggInfo
.
nAccumuœt‹
 = sAggInfo.
nCﬁumn
;

4063 
i
=0; i<
sAggInfo
.
nFunc
; i++){

4064 
	`as£π
–!
	`Ex¥HasPr›îty
(
sAggInfo
.
aFunc
[
i
].
pEx¥
, 
EP_xIsSñe˘
) );

4065 
	`sqlôe4Ex¥A«lyzeAggLi°
(&
sNC
, 
sAggInfo
.
aFunc
[
i
].
pEx¥
->
x
.
pLi°
);

4067 if–
db
->
mÆlocFaûed
 ) 
£À˘_íd
;

4072 if–
pGroupBy
 ){

4073 
KeyInfo
 *
pKeyInfo
;

4074 
j1
;

4075 
addrOuçutRow
;

4076 
ªgOuçutRow
;

4077 
addrSëAb‹t
;

4078 
addrT›OfLo›
;

4079 
addrS‹tögIdx
;

4080 
addrRe£t
;

4081 
ªgRe£t
;

4088 
sAggInfo
.
s‹tögIdx
 = 
pP¨£
->
nTab
++;

4089 
pKeyInfo
 = 
	`keyInfoFromEx¥Li°
(
pP¨£
, 
pGroupBy
, 0);

4090 
addrS‹tögIdx
 = 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_S‹ãrO≥n
,

4091 
sAggInfo
.
s‹tögIdx
, sAggInfo.
nS‹tögCﬁumn
,

4092 0, (*)
pKeyInfo
, 
P4_KEYINFO_HANDOFF
);

4096 
iU£Fœg
 = ++
pP¨£
->
nMem
;

4097 
iAb‹tFœg
 = ++
pP¨£
->
nMem
;

4098 
ªgOuçutRow
 = ++
pP¨£
->
nMem
;

4099 
addrOuçutRow
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

4100 
ªgRe£t
 = ++
pP¨£
->
nMem
;

4101 
addrRe£t
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

4102 
iAMem
 = 
pP¨£
->
nMem
 + 1;

4103 
pP¨£
->
nMem
 +
pGroupBy
->
nEx¥
;

4104 
iBMem
 = 
pP¨£
->
nMem
 + 1;

4105 
pP¨£
->
nMem
 +
pGroupBy
->
nEx¥
;

4106 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
iAb‹tFœg
);

4107 
	`VdbeCommít
((
v
, "clearábort flag"));

4108 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
iU£Fœg
);

4109 
	`VdbeCommít
((
v
, "indicateáccumulatorÉmpty"));

4110 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NuŒ
, 0, 
iAMem
, iAMem+
pGroupBy
->
nEx¥
-1);

4117 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgRe£t
, 
addrRe£t
);

4118 
pWInfo
 = 
	`sqlôe4WhîeBegö
(
pP¨£
, 
pTabLi°
, 
pWhîe
, 
pGroupBy
, 0, 0, 0);

4119 if–
pWInfo
==0 ) 
£À˘_íd
;

4120 if–
	`sqlôe4WhîeIsOrdîed
(
pWInfo
) ){

4125 
groupByS‹t
 = 0;

4132 
sAggInfo
.
dúe˘Mode
 = 1;

4133 
addrT›OfLo›
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

4134 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

4135 
j
=0; j<
pGroupBy
->
nEx¥
; j++){

4136 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pGroupBy
->
a
[
j
].
pEx¥
, 
iBMem
+j);

4138 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Com∑ª
, 
iAMem
, 
iBMem
, 
pGroupBy
->
nEx¥
,

4139 (*)
pKeyInfo
, 
P4_KEYINFO
);

4140 
j1
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

4141 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Jump
, 
j1
+1, 0, j1+1);

4147 
ªgBa£
;

4148 
nCﬁ
 = 
sAggInfo
.
nCﬁumn
;

4149 
nGroup
 = 
pGroupBy
->
nEx¥
;

4150 
ªgKey
 = ++
pP¨£
->
nMem
;

4151 
ªgRec‹d
 = 0;

4153 
groupByS‹t
 = 1;

4155 
	`ex∂aöTempTabÀ
(
pP¨£
,

4156 
isDi°ö˘
 && !(
p
->
£lFœgs
&
SF_Di°ö˘
)?"DISTINCT":"GROUP BY");

4162 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

4163 
ªgBa£
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nGroup
);

4164 
	`sqlôe4Ex¥CodeEx¥Li°
(
pP¨£
, 
pGroupBy
, 
ªgBa£
, 0);

4165 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgBa£
, 
nGroup
, 
ªgKey
,

4166 
sAggInfo
.
s‹tögIdx
);

4167 
	`sqlôe4VdbeCh™geP5
(
v
, 
OPFLAG_SEQCOUNT
);

4168 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgBa£
, 
nGroup
);

4175 if–
nCﬁ
>0 ){

4176 
ªgRec‹d
 = ++
pP¨£
->
nMem
;

4177 
ªgBa£
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nCﬁ
);

4178 
i
=0; i<
nCﬁ
; i++){

4179 
AggInfoCﬁ
 *
pCﬁ
 = &
sAggInfo
.
aCﬁ
[
i
];

4180 
ªgDe°
 = 
i
 + 
ªgBa£
;

4181 
ªgVÆue
 = 
	`sqlôe4Ex¥CodeGëCﬁumn
(

4182 
pP¨£
, 
pCﬁ
->
pTab
,ÖCﬁ->
iCﬁumn
,ÖCﬁ->
iTabÀ
, 
ªgDe°


4184 if–
ªgDe°
!=
ªgVÆue
 ){

4185 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
ªgVÆue
, 
ªgDe°
);

4188 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_MakeRec‹d
, 
ªgBa£
, 
nCﬁ
, 
ªgRec‹d
);

4189 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgBa£
, 
nCﬁ
);

4194 
	`sqlôe4VdbeAddOp3
(

4195 
v
, 
OP_In£π
, 
sAggInfo
.
s‹tögIdx
, 
ªgRec‹d
, 
ªgKey


4197 
	`sqlôe4WhîeEnd
(
pWInfo
);

4199 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgKey
);

4200 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_S‹ãrS‹t
, 
sAggInfo
.
s‹tögIdx
, 
addrEnd
);

4201 
	`VdbeCommít
((
v
, "GROUP BY sort"));

4202 
sAggInfo
.
u£S‹tögIdx
 = 1;

4203 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

4205 
j1
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_GΩCom∑ª
, 
sAggInfo
.
s‹tögIdx
, 0,
ªgKey
);

4206 
addrT›OfLo›
 = 
j1
;

4218 if–
groupByS‹t
==0 ){

4219 
	`sqlôe4Ex¥CodeMove
(
pP¨£
, 
iBMem
, 
iAMem
, 
pGroupBy
->
nEx¥
);

4221 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgOuçutRow
, 
addrOuçutRow
);

4222 
	`VdbeCommít
((
v
, "output oneÑow"));

4223 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IfPos
, 
iAb‹tFœg
, 
addrEnd
);

4224 
	`VdbeCommít
((
v
, "checkábort flag"));

4225 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgRe£t
, 
addrRe£t
);

4226 
	`VdbeCommít
((
v
, "resetáccumulator"));

4231 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

4232 
	`upd©eAccumuœt‹
(
pP¨£
, &
sAggInfo
);

4233 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
iU£Fœg
);

4234 
	`VdbeCommít
((
v
, "indicate data ináccumulator"));

4238 if–
groupByS‹t
 ){

4239 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_S‹ãrNext
, 
sAggInfo
.
s‹tögIdx
, 
addrT›OfLo›
);

4241 
	`sqlôe4WhîeEnd
(
pWInfo
);

4242 
	`sqlôe4VdbeCh™geToNo›
(
v
, 
addrS‹tögIdx
);

4247 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgOuçutRow
, 
addrOuçutRow
);

4248 
	`VdbeCommít
((
v
, "output finalÑow"));

4252 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addrEnd
);

4261 
addrSëAb‹t
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

4262 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
iAb‹tFœg
);

4263 
	`VdbeCommít
((
v
, "setábort flag"));

4264 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rëu∫
, 
ªgOuçutRow
);

4265 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
addrOuçutRow
);

4266 
addrOuçutRow
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

4267 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IfPos
, 
iU£Fœg
, 
addrOuçutRow
+2);

4268 
	`VdbeCommít
((
v
, "GroupbyÑesult generatorÉntryÖoint"));

4269 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rëu∫
, 
ªgOuçutRow
);

4270 
	`föÆizeAggFun˘i⁄s
(
pP¨£
, &
sAggInfo
);

4271 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pHavög
, 
addrOuçutRow
+1, 
SQLITE4_JUMPIFNULL
);

4272 
	`£À˘I¬îLo›
(
pP¨£
, 
p
,Ö->
pELi°
, 0, 0, 
pOrdîBy
,

4273 
di°ö˘
, 
pDe°
,

4274 
addrOuçutRow
+1, 
addrSëAb‹t
);

4275 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rëu∫
, 
ªgOuçutRow
);

4276 
	`VdbeCommít
((
v
, "end groupbyÑesult generator"));

4280 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
addrRe£t
);

4281 
	`ª£tAccumuœt‹
(
pP¨£
, &
sAggInfo
);

4282 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rëu∫
, 
ªgRe£t
);

4286 
Ex¥Li°
 *
pDñ
 = 0;

4313 
Ex¥Li°
 *
pMöMax
 = 0;

4314 
u8
 
Êag
 = 
	`möMaxQuîy
(
p
);

4315 if–
Êag
 ){

4316 
	`as£π
–!
	`Ex¥HasPr›îty
(
p
->
pELi°
->
a
[0].
pEx¥
, 
EP_xIsSñe˘
) );

4317 
pMöMax
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
p
->
pELi°
->
a
[0].
pEx¥
->
x
.
pLi°
,0);

4318 
pDñ
 = 
pMöMax
;

4319 if–
pMöMax
 && !
db
->
mÆlocFaûed
 ){

4320 
pMöMax
->
a
[0].
s‹tOrdî
 = 
Êag
!=
WHERE_ORDERBY_MIN
 ?1:0;

4321 
pMöMax
->
a
[0].
pEx¥
->
›
 = 
TK_COLUMN
;

4329 
	`ª£tAccumuœt‹
(
pP¨£
, &
sAggInfo
);

4330 
pWInfo
 = 
	`sqlôe4WhîeBegö
(
pP¨£
, 
pTabLi°
, 
pWhîe
, 
pMöMax
, 0,
Êag
,0);

4331 if–
pWInfo
==0 ){

4332 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pDñ
);

4333 
£À˘_íd
;

4335 
	`upd©eAccumuœt‹
(
pP¨£
, &
sAggInfo
);

4336 if–
	`sqlôe4WhîeIsOrdîed
(
pWInfo
Ë&& 
Êag
 ){

4337 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
	`sqlôe4WhîeBªakLabñ
(
pWInfo
));

4338 
	`VdbeCommít
((
v
, "%s() by index",

4339 (
Êag
==
WHERE_ORDERBY_MIN
?"min":"max")));

4341 
	`sqlôe4WhîeEnd
(
pWInfo
);

4342 
	`föÆizeAggFun˘i⁄s
(
pP¨£
, &
sAggInfo
);

4345 
pOrdîBy
 = 0;

4346 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pHavög
, 
addrEnd
, 
SQLITE4_JUMPIFNULL
);

4347 
	`£À˘I¬îLo›
(
pP¨£
, 
p
,Ö->
pELi°
, 0, 0, 0, -1,

4348 
pDe°
, 
addrEnd
,áddrEnd);

4349 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pDñ
);

4351 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
addrEnd
);

4355 if–
di°ö˘
>=0 ){

4356 
	`ex∂aöTempTabÀ
(
pP¨£
, "DISTINCT");

4362 if–
pOrdîBy
 ){

4363 
	`ex∂aöTempTabÀ
(
pP¨£
, "ORDER BY");

4364 
	`gíî©eS‹tTaû
(
pP¨£
, 
p
, 
v
, 
pELi°
->
nEx¥
, 
pDe°
);

4369 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iEnd
);

4374 
rc
 = 0;

4379 
£À˘_íd
:

4380 
	`ex∂aöSëI¡egî
(
pP¨£
->
iSñe˘Id
, 
iRe°‹eSñe˘Id
);

4384 if–
rc
==
SQLITE4_OK
 && 
pDe°
->
eDe°
==
SRT_Ouçut
 ){

4385 
	`gíî©eCﬁumnNames
(
pP¨£
, 
pTabLi°
, 
pELi°
);

4388 
	`sqlôe4DbFªe
(
db
, 
sAggInfo
.
aCﬁ
);

4389 
	`sqlôe4DbFªe
(
db
, 
sAggInfo
.
aFunc
);

4390  
rc
;

4391 
	}
}

4393 #i‡
deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

4397 
	$ex∂aöO√Sñe˘
(
Vdbe
 *
pVdbe
, 
Sñe˘
 *
p
){

4398 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "SELECT ");

4399 if–
p
->
£lFœgs
 & (
SF_Di°ö˘
|
SF_Aggªg©e
) ){

4400 if–
p
->
£lFœgs
 & 
SF_Di°ö˘
 ){

4401 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "DISTINCT ");

4403 if–
p
->
£lFœgs
 & 
SF_Aggªg©e
 ){

4404 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "agg_flag ");

4406 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4407 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, " ");

4409 
	`sqlôe4Ex∂aöEx¥Li°
(
pVdbe
, 
p
->
pELi°
);

4410 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4411 if–
p
->
pSrc
 &&Ö->pSrc->
nSrc
 ){

4412 
i
;

4413 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "FROM ");

4414 
	`sqlôe4Ex∂aöPush
(
pVdbe
);

4415 
i
=0; i<
p
->
pSrc
->
nSrc
; i++){

4416 
SrcLi°Iãm
 *
pIãm
 = &
p
->
pSrc
->
a
[
i
];

4417 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "{%d,*} = ", 
pIãm
->
iCurs‹
);

4418 if–
pIãm
->
pSñe˘
 ){

4419 
	`sqlôe4Ex∂aöSñe˘
(
pVdbe
, 
pIãm
->
pSñe˘
);

4420 if–
pIãm
->
pTab
 ){

4421 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, " (èb«me=%s)", 
pIãm
->
pTab
->
zName
);

4423 }if–
pIãm
->
zName
 ){

4424 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "%s", 
pIãm
->
zName
);

4426 if–
pIãm
->
zAlüs
 ){

4427 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, " (AS %s)", 
pIãm
->
zAlüs
);

4429 if–
pIãm
->
joöty≥
 & 
JT_LEFT
 ){

4430 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, " LEFT-JOIN");

4432 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4434 
	`sqlôe4Ex∂aöP›
(
pVdbe
);

4436 if–
p
->
pWhîe
 ){

4437 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "WHERE ");

4438 
	`sqlôe4Ex∂aöEx¥
(
pVdbe
, 
p
->
pWhîe
);

4439 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4441 if–
p
->
pGroupBy
 ){

4442 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "GROUPBY ");

4443 
	`sqlôe4Ex∂aöEx¥Li°
(
pVdbe
, 
p
->
pGroupBy
);

4444 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4446 if–
p
->
pHavög
 ){

4447 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "HAVING ");

4448 
	`sqlôe4Ex∂aöEx¥
(
pVdbe
, 
p
->
pHavög
);

4449 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4451 if–
p
->
pOrdîBy
 ){

4452 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "ORDERBY ");

4453 
	`sqlôe4Ex∂aöEx¥Li°
(
pVdbe
, 
p
->
pOrdîBy
);

4454 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4456 if–
p
->
pLimô
 ){

4457 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "LIMIT ");

4458 
	`sqlôe4Ex∂aöEx¥
(
pVdbe
, 
p
->
pLimô
);

4459 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4461 if–
p
->
pOff£t
 ){

4462 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "OFFSET ");

4463 
	`sqlôe4Ex∂aöEx¥
(
pVdbe
, 
p
->
pOff£t
);

4464 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4466 
	}
}

4467 
	$sqlôe4Ex∂aöSñe˘
(
Vdbe
 *
pVdbe
, 
Sñe˘
 *
p
){

4468 if–
p
==0 ){

4469 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "(null-select)");

4472  
p
->
pPri‹
 )Ö =Ö->pPrior;

4473 
	`sqlôe4Ex∂aöPush
(
pVdbe
);

4474  
p
 ){

4475 
	`ex∂aöO√Sñe˘
(
pVdbe
, 
p
);

4476 
p
 =Ö->
pNext
;

4477 if–
p
==0 ) ;

4478 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

4479 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "%s\n", 
	`£À˘OpName
(
p
->
›
));

4481 
	`sqlôe4Ex∂aöPrötf
(
pVdbe
, "END");

4482 
	`sqlôe4Ex∂aöP›
(
pVdbe
);

4483 
	}
}

	@src/sqliteInt.h

15 #i‚de‡
_SQLITEINT_H_


16 
	#_SQLITEINT_H_


	)

18 
	#SQLITE4_OMIT_PROGRESS_CALLBACK
 1

	)

19 
	#SQLITE4_OMIT_VIRTUALTABLE
 1

	)

20 
	#SQLITE4_OMIT_LOCALTIME
 1

	)

41 #i‚de‡
SQLITE4_DISABLE_LFS


42 
	#_LARGE_FILE
 1

	)

43 #i‚de‡
_FILE_OFFSET_BITS


44 
	#_FILE_OFFSET_BITS
 64

	)

46 
	#_LARGEFILE_SOURCE
 1

	)

53 #ifde‡
_HAVE_SQLITE4_CONFIG_H


54 
	~"c⁄fig.h
"

57 
	~"sqlôeLimô.h
"

60 #i‡
deföed
(
__BORLANDC__
)

61 #¥agm®
w¨n
 -
rch


62 #¥agm®
w¨n
 -
ccc


63 #¥agm®
w¨n
 -
aus


64 #¥agm®
w¨n
 -
csu


65 #¥agm®
w¨n
 -
•a


69 #i‚de‡
_GNU_SOURCE


70 
	#_GNU_SOURCE


	)

76 #ifde‡
HAVE_STDINT_H


77 
	~<°döt.h
>

79 #ifde‡
HAVE_INTTYPES_H


80 
	~<öây≥s.h
>

99 #i‡
deföed
(
__PTRDIFF_TYPE__
)

100 
	#SQLITE4_INT_TO_PTR
(
X
Ë((*)(
__PTRDIFF_TYPE__
)(X))

	)

101 
	#SQLITE4_PTR_TO_INT
(
X
Ë(()(
__PTRDIFF_TYPE__
)(X))

	)

102 #ñi‡!
deföed
(
__GNUC__
)

103 
	#SQLITE4_INT_TO_PTR
(
X
Ë((*)&((*)0)[X])

	)

104 
	#SQLITE4_PTR_TO_INT
(
X
Ë(()(((*)X)-(*)0))

	)

105 #ñi‡
deföed
(
HAVE_STDINT_H
)

106 
	#SQLITE4_INT_TO_PTR
(
X
Ë((*)(
öçå_t
)(X))

	)

107 
	#SQLITE4_PTR_TO_INT
(
X
Ë(()(
öçå_t
)(X))

	)

109 
	#SQLITE4_INT_TO_PTR
(
X
Ë((*)(X))

	)

110 
	#SQLITE4_PTR_TO_INT
(
X
Ë(()(X))

	)

124 #i‡!
deföed
(
SQLITE4_THREADSAFE
)

125 #i‡
deföed
(
THREADSAFE
)

126 
	#SQLITE4_THREADSAFE
 
THREADSAFE


	)

128 
	#SQLITE4_THREADSAFE
 1

	)

136 #i‚de‡
SQLITE4_POWERSAFE_OVERWRITE


137 
	#SQLITE4_POWERSAFE_OVERWRITE
 1

	)

146 #i‡!
deföed
(
SQLITE4_DEFAULT_MEMSTATUS
)

147 
	#SQLITE4_DEFAULT_MEMSTATUS
 1

	)

169 #i‡
deföed
(
SQLITE4_SYSTEM_MALLOC
)+deföed(
SQLITE4_WIN32_MALLOC
)\

170 +
deföed
(
SQLITE4_MEMDEBUG
)>1

174 #i‡
deföed
(
SQLITE4_SYSTEM_MALLOC
)+deföed(
SQLITE4_WIN32_MALLOC
)\

175 +
deföed
(
SQLITE4_MEMDEBUG
)==0

176 
	#SQLITE4_SYSTEM_MALLOC
 1

	)

183 #i‡!
deföed
(
SQLITE4_MALLOC_SOFT_LIMIT
)

184 
	#SQLITE4_MALLOC_SOFT_LIMIT
 1024

	)

200 #i‡!
deföed
(
_XOPEN_SOURCE
Ë&& !deföed(
__DARWIN__
Ë&& !deföed(
__APPLE__
)\

201 && 
SQLITE4_THREADSAFE


202 
	#_XOPEN_SOURCE
 500

	)

208 #i‡
deföed
(
SQLITE4_TCL
Ë|| deföed(
TCLSH
)

209 
	~<t˛.h
>

219 #i‡!
deföed
(
NDEBUG
Ë&& !deföed(
SQLITE4_DEBUG
)

220 
	#NDEBUG
 1

	)

237 #ifde‡
SQLITE4_COVERAGE_TEST


238 
sqlôe4Covîage
();

239 
	#ã°ˇ£
(
X
Ëif–X ){ 
	`sqlôe4Covîage
(
__LINE__
); }

	)

241 
	#ã°ˇ£
(
X
)

	)

249 #i‡!
deföed
(
NDEBUG
Ë|| deföed(
SQLITE4_COVERAGE_TEST
)

250 
	#TESTONLY
(
X
Ë
	)
X

252 
	#TESTONLY
(
X
)

	)

263 #i‚de‡
NDEBUG


264 
	#VVA_ONLY
(
X
Ë
	)
X

266 
	#VVA_ONLY
(
X
)

	)

284 #i‡
deföed
(
SQLITE4_COVERAGE_TEST
)

285 
	#ALWAYS
(
X
Ë(1)

	)

286 
	#NEVER
(
X
Ë(0)

	)

287 #ñi‡!
deföed
(
NDEBUG
)

288 
	#ALWAYS
(
X
Ë((X)?1:(
	`as£π
(0),0))

	)

289 
	#NEVER
(
X
Ë((X)?(
	`as£π
(0),1):0)

	)

291 
	#ALWAYS
(
X
Ë(X)

	)

292 
	#NEVER
(
X
Ë(X)

	)

295 
	~"sqlôe4.h
"

296 
	~"hash.h
"

297 
	~"∑r£.h
"

298 
	~<°dio.h
>

299 
	~<°dlib.h
>

300 
	~<°rög.h
>

301 
	~<as£π.h
>

302 
	~<°ddef.h
>

303 
	~<˘y≥.h
>

309 #ifde‡
SQLITE4_OMIT_FLOATING_POINT


310 
sqlôe4_öt64


	)

311 
sqlôe4_öt64


	)

312 
	#LONGDOUBLE_TYPE
 
sqlôe4_öt64


	)

313 #i‚de‡
SQLITE4_BIG_DBL


314 
	#SQLITE4_BIG_DBL
 (((
sqlôe4_öt64
)1)<<50)

	)

316 
	#SQLITE4_OMIT_DATETIME_FUNCS
 1

	)

317 
	#SQLITE4_OMIT_TRACE
 1

	)

318 #unde‡
SQLITE4_MIXED_ENDIAN_64BIT_FLOAT


319 #unde‡
SQLITE4_HAVE_ISNAN


321 #i‚de‡
SQLITE4_BIG_DBL


322 
	#SQLITE4_BIG_DBL
 (1e99)

	)

330 #ifde‡
SQLITE4_OMIT_TEMPDB


331 
	#OMIT_TEMPDB
 1

	)

333 
	#OMIT_TEMPDB
 0

	)

340 #i‚de‡
SQLITE4_TEMP_STORE


341 
	#SQLITE4_TEMP_STORE
 1

	)

348 #i‚de‡
off£tof


349 
	#off£tof
(
STRUCTURE
,
FIELD
Ë(()((*)&((STRUCTURE*)0)->FIELD))

	)

355 
	#MIN
(
A
,
B
Ë((A)<(B)?(A):(B))

	)

356 
	#MAX
(
A
,
B
Ë((A)>(B)?(A):(B))

	)

363 
	#SQLITE4_EBCDIC
 1

	)

365 
	#SQLITE4_ASCII
 1

	)

375 #i‚de‡
UINT32_TYPE


376 #ifde‡
HAVE_UINT32_T


377 
	#UINT32_TYPE
 
uöt32_t


	)

379 
	#UINT32_TYPE
 

	)

382 #i‚de‡
UINT16_TYPE


383 #ifde‡
HAVE_UINT16_T


384 
	#UINT16_TYPE
 
uöt16_t


	)

386 
	#UINT16_TYPE
 

	)

389 #i‚de‡
INT16_TYPE


390 #ifde‡
HAVE_INT16_T


391 
	#INT16_TYPE
 
öt16_t


	)

393 
	#INT16_TYPE
 

	)

396 #i‚de‡
UINT8_TYPE


397 #ifde‡
HAVE_UINT8_T


398 
	#UINT8_TYPE
 
uöt8_t


	)

400 
	#UINT8_TYPE
 

	)

403 #i‚de‡
INT8_TYPE


404 #ifde‡
HAVE_INT8_T


405 
	#INT8_TYPE
 
öt8_t


	)

407 
	#INT8_TYPE
 sig√d 

	)

410 #i‚de‡
LONGDOUBLE_TYPE


411 
	#LONGDOUBLE_TYPE
 

	)

413 
sqlôe4_öt64
 
	ti64
;

414 
sqlôe4_uöt64
 
	tu64
;

415 
UINT32_TYPE
 
	tu32
;

416 
UINT16_TYPE
 
	tu16
;

417 
INT16_TYPE
 
	ti16
;

418 
UINT8_TYPE
 
	tu8
;

419 
INT8_TYPE
 
	ti8
;

427 
	#SQLITE4_MAX_U32
 ((((
u64
)1)<<32)-1)

	)

433 
	#SQLITE4_MX_EXP
 999

	)

434 
	#SQLITE4_NAN_EXP
 2000

	)

442 #ifde‡
SQLITE4_64BIT_STATS


443 
u64
 
	ttRow˙t
;

445 
u32
 
	ttRow˙t
;

452 #ifde‡
SQLITE4_AMALGAMATION


453 c⁄° 
	gsqlôe4⁄e
 = 1;

455 c⁄° 
sqlôe4⁄e
;

457 #i‡
deföed
(
i386
Ë|| deföed(
__i386__
Ë|| deföed(
_M_IX86
)\

458 || 
deföed
(
__x86_64
Ë|| 
	$deföed
(
__x86_64__
)

459 
	#SQLITE4_BIGENDIAN
 0

	)

460 
	#SQLITE4_LITTLEENDIAN
 1

	)

461 
	#SQLITE4_UTF16NATIVE
 
SQLITE4_UTF16LE


	)

463 
	#SQLITE4_BIGENDIAN
 (*(*)(&
sqlôe4⁄e
)==0)

	)

464 
	#SQLITE4_LITTLEENDIAN
 (*(*)(&
sqlôe4⁄e
)==1)

	)

465 
	#SQLITE4_UTF16NATIVE
 (
SQLITE4_BIGENDIAN
?
SQLITE4_UTF16BE
:
SQLITE4_UTF16LE
)

	)

473 
	#LARGEST_INT64
 (0xffffffff|(((
i64
)0x7fffffff)<<32))

	)

474 
	#SMALLEST_INT64
 (((
i64
)-1Ë- 
LARGEST_INT64
)

	)

475 
	#LARGEST_UINT64
 (0xffffffff|(((
u64
)0xffffffff)<<32))

	)

480 
	#LARGEST_INT32
 0x7fffffff

	)

481 
	#SMALLEST_INT32
 (-
LARGEST_INT32
 - 1)

	)

487 
	#ROUND8
(
x
Ë(((x)+7)&~7)

	)

492 
	#ROUNDDOWN8
(
x
Ë((x)&~7)

	)

497 
	#SQLITE4_MIN
(
a
,
b
Ë((◊)<(b)Ë? (aË: (b))

	)

498 
	#SQLITE4_MAX
(
a
,
b
Ë((◊)>(b)Ë? (aË: (b))

	)

509 #ifde‡
SQLITE4_4_BYTE_ALIGNED_MALLOC


510 
	#EIGHT_BYTE_ALIGNMENT
(
X
Ë((((*)(XË- (*)0)&3)==0)

	)

512 
	#EIGHT_BYTE_ALIGNMENT
(
X
Ë((((*)(XË- (*)0)&7)==0)

	)

521 
	#MASTER_NAME
 "sqlôe_ma°î"

	)

522 
	#TEMP_MASTER_NAME
 "sqlôe_ãmp_ma°î"

	)

527 
	#MASTER_ROOT
 1

	)

528 
	#KVSTORE_ROOT
 0x7fffffff

	)

530 
	#IsKv°‹e
(
pTab
Ë(’Tab)->
pIndex
 && (pTab)->pIndex->
äum
==
KVSTORE_ROOT
)

	)

535 
	#SCHEMA_TABLE
(
x
Ë((!
OMIT_TEMPDB
)&&(x==1)?
TEMP_MASTER_NAME
:
MASTER_NAME
)

	)

541 
	#AºaySize
(
X
Ë(()((X)/(X[0])))

	)

546 
	#IsPowîOfTwo
(
X
Ë(((X)&((X)-1))==0)

	)

564 
	#UNUSED_PARAMETER
(
x
Ë()(x)

	)

565 
	#UNUSED_PARAMETER2
(
x
,
y
Ë
	`UNUSED_PARAMETER
(x),UNUSED_PARAMETER(y)

	)

570 
AggInfo
 
	tAggInfo
;

571 
AggInfoCﬁ
 
	tAggInfoCﬁ
;

572 
AggInfoFunc
 
	tAggInfoFunc
;

573 
Auth‹izî
 
	tAuth‹izî
;

574 
AuthC⁄ãxt
 
	tAuthC⁄ãxt
;

575 
AutoöcInfo
 
	tAutoöcInfo
;

576 
CﬁlSeq
 
	tCﬁlSeq
;

577 
Cﬁumn
 
	tCﬁumn
;

578 
Cª©eIndex
 
	tCª©eIndex
;

579 
Db
 
	tDb
;

580 
Schema
 
	tSchema
;

581 
Ex¥
 
	tEx¥
;

582 
Ex¥Li°
 
	tEx¥Li°
;

583 
Ex¥Li°Iãm
 
	tEx¥Li°Iãm
;

584 
Ex¥S∑n
 
	tEx¥S∑n
;

585 
FKey
 
	tFKey
;

586 
FuncDef
 
	tFuncDef
;

587 
FuncDefTabÀ
 
	tFuncDefTabÀ
;

588 
Fts5Tokíizî
 
	tFts5Tokíizî
;

589 
Fts5Index
 
	tFts5Index
;

590 
Fts5Info
 
	tFts5Info
;

591 
Fts5Curs‹
 
	tFts5Curs‹
;

592 
IdLi°
 
	tIdLi°
;

593 
IdLi°Iãm
 
	tIdLi°Iãm
;

594 
Index
 
	tIndex
;

595 
IndexSam∂e
 
	tIndexSam∂e
;

596 
KeyCœss
 
	tKeyCœss
;

597 
KeyInfo
 
	tKeyInfo
;

598 
Lookaside
 
	tLookaside
;

599 
LookasideSlŸ
 
	tLookasideSlŸ
;

600 
ModuÀ
 
	tModuÀ
;

601 
NameC⁄ãxt
 
	tNameC⁄ãxt
;

602 
P¨£
 
	tP¨£
;

603 
P¨£YCﬁCache
 
	tP¨£YCﬁCache
;

604 
RowSë
 
	tRowSë
;

605 
Savïoöt
 
	tSavïoöt
;

606 
Sñe˘
 
	tSñe˘
;

607 
Sqlôe4InôInfo
 
	tSqlôe4InôInfo
;

608 
SrcLi°
 
	tSrcLi°
;

609 
SrcLi°Iãm
 
	tSrcLi°Iãm
;

610 
SåAccum
 
	tSåAccum
;

611 
TabÀ
 
	tTabÀ
;

612 
Tokí
 
	tTokí
;

613 
Triggî
 
	tTriggî
;

614 
TriggîPrg
 
	tTriggîPrg
;

615 
TriggîSãp
 
	tTriggîSãp
;

616 
VTabÀ
 
	tVTabÀ
;

617 
VèbCtx
 
	tVèbCtx
;

618 
WÆkî
 
	tWÆkî
;

619 
WhîePœn
 
	tWhîePœn
;

620 
WhîeInfo
 
	tWhîeInfo
;

621 
WhîeLevñ
 
	tWhîeLevñ
;

624 
U≈ackedRec‹d
 
	tU≈ackedRec‹d
;

627 
	~"vdbe.h
"

628 
	~"kv.h
"

630 
	~"os.h
"

631 
	~"muãx.h
"

641 
	sDb
 {

642 *
zName
;

643 
KVSt‹e
 *
pKV
;

644 
u8
 
öTøns
;

645 
u8
 
chngFœg
;

646 
Schema
 *
pSchema
;

655 
	sFuncDef
 {

656 
i16
 
nArg
;

657 
u8
 
Êags
;

658 *
pU£rD©a
;

659 
FuncDef
 *
pSameName
;

660 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**);

661 (*
xSãp
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**);

662 (*
xFöÆize
)(
sqlôe4_c⁄ãxt
*);

663 *
zName
;

664 
FuncDef
 *
pNextName
;

665 
u8
 
bM©chöfo
;

666 (*
xDe°roy
)(*);

677 
	sFuncDefTabÀ
 {

678 
FuncDef
 *
pFú°
;

679 
FuncDef
 *
pLa°
;

680 
FuncDef
 *
pSame
;

698 
	sSchema
 {

699 
schema_cookõ
;

700 
iGíî©i⁄
;

701 
Hash
 
tblHash
;

702 
Hash
 
idxHash
;

703 
Hash
 
åigHash
;

704 
Hash
 
fkeyHash
;

705 
TabÀ
 *
pSeqTab
;

706 
u8
 
fûe_f‹m©
;

707 
u8
 
íc
;

708 
u16
 
Êags
;

709 
ˇche_size
;

716 
	#DbHasPr›îty
(
D
,
I
,
P
Ë(((D)->
aDb
[I].
pSchema
->
Êags
&(P))==(P))

	)

717 
	#DbHasAnyPr›îty
(
D
,
I
,
P
Ë(((D)->
aDb
[I].
pSchema
->
Êags
&(P))!=0)

	)

718 
	#DbSëPr›îty
(
D
,
I
,
P
Ë(D)->
aDb
[I].
pSchema
->
Êags
|=(P)

	)

719 
	#DbCÀ¨Pr›îty
(
D
,
I
,
P
Ë(D)->
aDb
[I].
pSchema
->
Êags
&=~(P)

	)

731 
	#DB_SchemaLﬂded
 0x0001

	)

732 
	#DB_Uƒe£tVõws
 0x0002

	)

733 
	#DB_Em±y
 0x0004

	)

739 
	#SQLITE4_N_LIMIT
 (
SQLITE4_LIMIT_TRIGGER_DEPTH
+1)

	)

761 
	sLookaside
 {

762 
u16
 
sz
;

763 
u8
 
bE«bÀd
;

764 
u8
 
bMÆlo˚d
;

765 
nOut
;

766 
mxOut
;

767 
™Sèt
[3];

768 
LookasideSlŸ
 *
pFªe
;

769 *
pSèπ
;

770 *
pEnd
;

772 
	sLookasideSlŸ
 {

773 
LookasideSlŸ
 *
pNext
;

779 
	sSqlôe4InôInfo
 {

780 
iDb
;

781 
√wTnum
;

782 
u8
 
busy
;

783 
u8
 
‹ph™Triggî
;

806 
	ssqlôe4
 {

807 
sqlôe4_ív
 *
pEnv
;

808 
nDb
;

809 
Db
 *
aDb
;

810 
Êags
;

811 
›íFœgs
;

812 
îrCode
;

813 
u8
 
ãmp_°‹e
;

814 
u8
 
mÆlocFaûed
;

815 
u8
 
dÊtLockMode
;

816 sig√d 
√xtAutovac
;

817 
u8
 
suµªssEº
;

818 
u8
 
vèbOnC⁄Êi˘
;

819 
√xtPagesize
;

820 
nTabÀ
;

821 
CﬁlSeq
 *
pDÊtCﬁl
;

822 
u32
 
magic
;

823 
nCh™ge
;

824 
nTŸÆCh™ge
;

825 
sqlôe4_muãx
 *
muãx
;

826 
aLimô
[
SQLITE4_N_LIMIT
];

827 
Sqlôe4InôInfo
 
öô
;

828 
nExãnsi⁄
;

829 **
aExãnsi⁄
;

830 
Vdbe
 *
pVdbe
;

831 
a˘iveVdbeC¡
;

832 
wrôeVdbeC¡
;

833 
vdbeExecC¡
;

834 (*
xTø˚
)(*,const *);

835 (*
xTø˚De°roy
)(*);

836 *
pTø˚Arg
;

837 (*
xProfûe
)(*,c⁄° *,
u64
);

838 (*
xProfûeDe°roy
)(*);

839 *
pProfûeArg
;

840 #i‚de‡
SQLITE4_OMIT_WAL


841 (*
xWÆCÆlback
)(*, 
sqlôe4
 *, const *, );

842 *
pWÆArg
;

844 (*
xCﬁlNìded
)(*,
sqlôe4
*,const *);

845 (*
xCﬁlNìdedDe°roy
)(*);

846 *
pCﬁlNìdedArg
;

847 
sqlôe4_vÆue
 *
pEº
;

848 *
zEºMsg
;

849 *
zEºMsg16
;

851 vﬁ©ûê
isI¡îru±ed
;

852 
nŸU£d1
;

853 } 
u1
;

854 
Lookaside
 
lookaside
;

855 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


856 
Auth‹izî
 *
pAuth
;

858 #i‚de‡
SQLITE4_OMIT_PROGRESS_CALLBACK


859 (*
xProgªss
)(*);

860 *
pProgªssArg
;

861 
nProgªssOps
;

863 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


864 
Hash
 
aModuÀ
;

865 
VèbCtx
 *
pVèbCtx
;

866 
VTabÀ
 **
aVTøns
;

867 
nVTøns
;

868 
VTabÀ
 *
pDisc⁄√˘
;

870 
FuncDefTabÀ
 
aFunc
;

871 
Hash
 
aCﬁlSeq
;

872 
Db
 
aDbSètic
[2];

873 
Savïoöt
 *
pSavïoöt
;

874 
nSavïoöt
;

875 
nSèãmít
;

876 
i64
 
nDe„ºedC⁄s
;

877 *
≤ByãsFªed
;

879 #ifde‡
SQLITE4_ENABLE_UNLOCK_NOTIFY


890 
sqlôe4
 *
pBlockögC⁄√˘i⁄
;

891 
sqlôe4
 *
pU∆ockC⁄√˘i⁄
;

892 *
pU∆ockArg
;

893 (*
xU∆ockNŸify
)(**, );

894 
sqlôe4
 *
pNextBlocked
;

897 #i‚de‡
SQLITE_OMIT_FTS5


898 
Fts5Tokíizî
 *
pTokíizî
;

905 
	#ENC
(
db
Ë((db)->
aDb
[0].
pSchema
->
íc
)

	)

910 
	#SQLITE4_VdbeTø˚
 0x00000100

	)

911 
	#SQLITE4_SqlTø˚
 0x00000200

	)

912 
	#SQLITE4_VdbeLi°ög
 0x00000400

	)

913 
	#SQLITE4_KvTø˚
 0x00000800

	)

914 
	#SQLITE4_VdbeAdd›Tø˚
 0x00001000

	)

915 
	#SQLITE4_I¡înCh™ges
 0x00010000

	)

916 
	#SQLITE4_WrôeSchema
 0x00020000

	)

917 
	#SQLITE4_Ign‹eChecks
 0x00040000

	)

918 
	#SQLITE4_RecovîyMode
 0x00080000

	)

919 
	#SQLITE4_Revî£Ordî
 0x01000000

	)

920 
	#SQLITE4_RecTriggîs
 0x02000000

	)

921 
	#SQLITE4_F‹eignKeys
 0x04000000

	)

922 
	#SQLITE4_AutoIndex
 0x08000000

	)

923 
	#SQLITE4_Pª„rBuûtö
 0x10000000

	)

924 
	#SQLITE4_E«bÀTriggî
 0x40000000

	)

931 
	#SQLITE4_QuîyFœâíî
 0x01

	)

932 
	#SQLITE4_CﬁumnCache
 0x02

	)

933 
	#SQLITE4_IndexS‹t
 0x04

	)

934 
	#SQLITE4_IndexSórch
 0x08

	)

935 
	#SQLITE4_IndexCovî
 0x10

	)

936 
	#SQLITE4_GroupByOrdî
 0x20

	)

937 
	#SQLITE4_Fa˘‹OutC⁄°
 0x40

	)

938 
	#SQLITE4_IdxRólAsI¡
 0x80

	)

939 
	#SQLITE4_Di°ö˘O±
 0x80

	)

940 
	#SQLITE4_O±Mask
 0xf‡

	)

946 
	#O±imiz©i⁄DißbÀd
(
db
, 
mask
Ë0

	)

947 
	#O±imiz©i⁄E«bÀd
(
db
, 
mask
Ë1

	)

954 
	#SQLITE4_MAGIC_OPEN
 0x4d06c919

	)

955 
	#SQLITE4_MAGIC_CLOSED
 0x5f2246b4

	)

956 
	#SQLITE4_MAGIC_SICK
 0xˇad9e61

	)

957 
	#SQLITE4_MAGIC_BUSY
 0xb07f8c8¯

	)

958 
	#SQLITE4_MAGIC_ERROR
 0x912e4c46

	)

963 
	#SQLITE4_FUNC_LIKE
 0x01

	)

964 
	#SQLITE4_FUNC_CASE
 0x02

	)

965 
	#SQLITE4_FUNC_EPHEM
 0x04

	)

966 
	#SQLITE4_FUNC_NEEDCOLL
 0x08

	)

967 
	#SQLITE4_FUNC_PRIVATE
 0x10

	)

968 
	#SQLITE4_FUNC_COUNT
 0x20

	)

969 
	#SQLITE4_FUNC_COALESCE
 0x40

	)

996 
	#FUNCTION
(
zName
, 
nArg
, 
iArg
, 
bNC
, 
xFunc
) \

997 {
nArg
, 
bNC
*
SQLITE4_FUNC_NEEDCOLL
, \

998 
	`SQLITE4_INT_TO_PTR
(
iArg
), 0, 
xFunc
, 0, 0, #zName, 0, 0
	}

	)
}

999 
	#STR_FUNCTION
(
zName
, 
nArg
, 
pArg
, 
bNC
, 
xFunc
) \

1000 {
nArg
, 
bNC
*
SQLITE4_FUNC_NEEDCOLL
, \

1001 
pArg
, 0, 
xFunc
, 0, 0, #zName, 0, 0}

	)

1002 
	#LIKEFUNC
(
zName
, 
nArg
, 
¨g
, 
Êags
) \

1003 {
nArg
, 
Êags
, (*)
¨g
, 0, 
likeFunc
, 0, 0, #zName, 0, 0}

	)

1004 
	#AGGREGATE
(
zName
, 
nArg
, 
¨g
, 
nc
, 
xSãp
, 
xFöÆ
) \

1005 {
nArg
, 
nc
*
SQLITE4_FUNC_NEEDCOLL
, \

1006 
	`SQLITE4_INT_TO_PTR
(
¨g
), 0, 0, 
xSãp
,
xFöÆ
,#zName,0,0}

	)

1014 
	sSavïoöt
 {

1015 *
	mzName
;

1016 
i64
 
	mnDe„ºedC⁄s
;

1017 
Savïoöt
 *
	mpNext
;

1024 
	#SAVEPOINT_BEGIN
 0

	)

1025 
	#SAVEPOINT_RELEASE
 1

	)

1026 
	#SAVEPOINT_ROLLBACK
 2

	)

1034 
	sModuÀ
 {

1035 c⁄° 
sqlôe4_moduÀ
 *
	mpModuÀ
;

1036 c⁄° *
	mzName
;

1037 *
	mpAux
;

1038 (*
	mxDe°roy
)(*);

1045 
	sCﬁumn
 {

1046 *
	mzName
;

1047 
Ex¥
 *
	mpDÊt
;

1048 *
	mzDÊt
;

1049 *
	mzTy≥
;

1050 *
	mzCﬁl
;

1051 
u16
 
	miPrimKey
;

1052 
u8
 
	mnŸNuŒ
;

1053 
	mafföôy
;

1054 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1055 
u8
 
	misHiddí
;

1080 
	sCﬁlSeq
 {

1081 *
	mzName
;

1082 *
	mpU£r
;

1083 (*
	mxCmp
)(*, 
	msqlôe4_vÆue
*, sqlite4_value*, *);

1084 (*
	mxMkKey
)(*, 
	msqlôe4_vÆue
*, , *, *);

1085 (*
	mxDñ
)(*);

1091 
	#SQLITE4_SO_ASC
 0

	)

1092 
	#SQLITE4_SO_DESC
 1

	)

1108 
	#SQLITE4_AFF_TEXT
 'a'

	)

1109 
	#SQLITE4_AFF_NONE
 'b'

	)

1110 
	#SQLITE4_AFF_NUMERIC
 'c'

	)

1111 
	#SQLITE4_AFF_INTEGER
 'd'

	)

1112 
	#SQLITE4_AFF_REAL
 'e'

	)

1114 
	#sqlôe4IsNumîicAfföôy
(
X
Ë((X)>=
SQLITE4_AFF_NUMERIC
)

	)

1118 
	#SQLITE_AFF_NONE
 0x40

	)

1119 
	#SQLITE_AFF_BLOB
 0x41

	)

1120 
	#SQLITE_AFF_TEXT
 0x42

	)

1121 
	#SQLITE_AFF_NUMERIC
 0x43

	)

1122 
	#SQLITE_AFF_INTEGER
 0x44

	)

1123 
	#SQLITE_AFF_REAL
 0x45

	)

1124 
	#SQLITE_AFF_FLEXNUM
 0x46

	)

1130 
	#SQLITE4_AFF_MASK
 0x67

	)

1136 
	#SQLITE4_JUMPIFNULL
 0x08

	)

1137 
	#SQLITE4_STOREP2
 0x10

	)

1138 
	#SQLITE4_NULLEQ
 0x80

	)

1182 
	sVTabÀ
 {

1183 
sqlôe4
 *
	mdb
;

1184 
ModuÀ
 *
	mpMod
;

1185 
sqlôe4_vèb
 *
	mpVèb
;

1186 
	mnRef
;

1187 
u8
 
	mbC⁄°øöt
;

1188 
	miSavïoöt
;

1189 
VTabÀ
 *
	mpNext
;

1196 
	sTabÀ
 {

1197 *
	mzName
;

1198 
	mnCﬁ
;

1199 
Cﬁumn
 *
	maCﬁ
;

1200 
Index
 *
	mpIndex
;

1201 
tRow˙t
 
	mnRowE°
;

1202 
Sñe˘
 *
	mpSñe˘
;

1203 
u16
 
	mnRef
;

1204 
u8
 
	mèbFœgs
;

1205 
FKey
 *
	mpFKey
;

1206 *
	mzCﬁAff
;

1207 
	mäum
;

1208 #i‚de‡
SQLITE4_OMIT_CHECK


1209 
Ex¥
 *
	mpCheck
;

1211 #i‚de‡
SQLITE4_OMIT_ALTERTABLE


1212 
	maddCﬁOff£t
;

1214 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1215 
VTabÀ
 *
	mpVTabÀ
;

1216 
	mnModuÀArg
;

1217 **
	mazModuÀArg
;

1219 
Triggî
 *
	mpTriggî
;

1220 
Schema
 *
	mpSchema
;

1221 
TabÀ
 *
	mpNextZombõ
;

1227 
	#TF_Ród⁄ly
 0x01

	)

1228 
	#TF_EphemîÆ
 0x02

	)

1229 
	#TF_HasPrim¨yKey
 0x04

	)

1230 
	#TF_Autoö¸emít
 0x08

	)

1231 
	#TF_VútuÆ
 0x10

	)

1232 
	#TF_NìdMëad©a
 0x20

	)

1241 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1242 
	#IsVútuÆ
(
X
Ë(((X)->
èbFœgs
 & 
TF_VútuÆ
)!=0)

	)

1243 
	#IsHiddíCﬁumn
(
X
Ë((X)->
isHiddí
)

	)

1245 
	#IsVútuÆ
(
X
Ë0

	)

1246 
	#IsHiddíCﬁumn
(
X
Ë0

	)

1250 #i‚de‡
SQLITE4_OMIT_VIEW


1251 
	#IsVõw
(
X
Ë((X)->
pSñe˘
!=0)

	)

1253 
	#IsVõw
(
X
Ë0

	)

1275 
	sFKey
 {

1276 
TabÀ
 *
	mpFrom
;

1277 
FKey
 *
	mpNextFrom
;

1278 *
	mzTo
;

1279 
FKey
 *
	mpNextTo
;

1280 
FKey
 *
	mpPªvTo
;

1281 
	mnCﬁ
;

1283 
u8
 
	misDe„ºed
;

1284 
u8
 
	maA˘i⁄
[2];

1285 
Triggî
 *
	m≠Triggî
[2];

1286 
	ssCﬁM≠
 {

1287 
	miFrom
;

1288 *
	mzCﬁ
;

1289 } 
	maCﬁ
[1];

1317 
	#OE_N⁄e
 0

	)

1318 
	#OE_Rﬁlback
 1

	)

1319 
	#OE_Ab‹t
 2

	)

1320 
	#OE_Faû
 3

	)

1321 
	#OE_Ign‹e
 4

	)

1322 
	#OE_Rïœ˚
 5

	)

1324 
	#OE_Re°ri˘
 6

	)

1325 
	#OE_SëNuŒ
 7

	)

1326 
	#OE_SëDÊt
 8

	)

1327 
	#OE_Casˇde
 9

	)

1329 
	#OE_DeÁu…
 99

	)

1337 
	sKeyInfo
 {

1338 
u16
 
	mnFõld
;

1339 
u16
 
	mnPK
;

1340 
u16
 
	mnD©a
;

1341 
u8
 *
	maS‹tOrdî
;

1342 
CﬁlSeq
 *
	maCﬁl
[1];

1382 
	sU≈ackedRec‹d
 {

1383 
KeyInfo
 *
	mpKeyInfo
;

1384 
Mem
 *
	maMem
;

1386 *
	mz
;

1387 
i64
 
	mi
;

1388 } 
	mu
;

1389 
	mn
;

1390 
u16
 
	mnFõld
;

1391 
i8
 
	mdeÁu…_rc
;

1392 
u8
 
	mîrCode
;

1393 
i8
 
	mr1
;

1394 
i8
 
	mr2
;

1395 
u8
 
	meqSìn
;

1424 
	sIndex
 {

1425 *
	mzName
;

1426 
	mnCﬁumn
;

1427 *
	maiCﬁumn
;

1428 
	mnCovî
;

1429 *
	maiCovî
;

1430 
tRow˙t
 *
	maiRowE°
;

1431 
TabÀ
 *
	mpTabÀ
;

1432 
	mäum
;

1433 
u8
 
	m⁄Eº‹
;

1434 
u8
 
	meIndexTy≥
;

1435 
u8
 
	mfIndex
;

1436 *
	mzCﬁAff
;

1437 
Index
 *
	mpNext
;

1438 
Schema
 *
	mpSchema
;

1439 
u8
 *
	maS‹tOrdî
;

1440 **
	mazCﬁl
;

1441 #ifde‡
SQLITE4_ENABLE_STAT3


1442 
	mnSam∂e
;

1443 
tRow˙t
 
	mavgEq
;

1444 
IndexSam∂e
 *
	maSam∂e
;

1447 #i‚de‡
SQLITE4_OMIT_VECTOR


1448 
Ex¥Li°
 *
	maCﬁEx¥
;

1449 
	midxIsVe˘‹
:1;

1452 
Fts5Index
 *
	mpFts
;

1454 
	mbUn‹dîed
:1;

1458 
	#SQLITE4_INDEX_USER
 0

	)

1459 
	#SQLITE4_INDEX_UNIQUE
 1

	)

1460 
	#SQLITE4_INDEX_PRIMARYKEY
 2

	)

1461 
	#SQLITE4_INDEX_FTS5
 3

	)

1462 
	#SQLITE4_INDEX_TEMP
 4

	)

1465 
	#IDX_I¡PK
 0x01

	)

1466 
	#IDX_Un‹dîed
 0x02

	)

1473 
	sIndexSam∂e
 {

1474 
u8
 *
	maVÆ
;

1475 
	mnVÆ
;

1476 
tRow˙t
 
	mnEq
;

1477 
tRow˙t
 
	mnLt
;

1478 
tRow˙t
 
	mnDLt
;

1489 
	sTokí
 {

1490 c⁄° *
	mz
;

1491 
	mn
;

1499 
	sCª©eIndex
 {

1500 
	mbUnique
;

1501 
	mbI‚Ÿexi°
;

1502 
Tokí
 
	mtCª©e
;

1503 
Tokí
 
	mtName1
;

1504 
Tokí
 
	mtName2
;

1505 
SrcLi°
 *
	mpTblName
;

1511 
	sAggInfoCﬁ
 {

1512 
TabÀ
 *
	mpTab
;

1513 
	miTabÀ
;

1514 
	miCﬁumn
;

1515 
	miS‹ãrCﬁumn
;

1516 
	miMem
;

1517 
Ex¥
 *
	mpEx¥
;

1523 
	sAggInfoFunc
 {

1524 
Ex¥
 *
	mpEx¥
;

1525 
FuncDef
 *
	mpFunc
;

1526 
	miMem
;

1527 
	miDi°ö˘
;

1543 
	sAggInfo
 {

1544 
u8
 
	mdúe˘Mode
;

1546 
u8
 
	mu£S‹tögIdx
;

1548 
	ms‹tögIdx
;

1549 
Ex¥Li°
 *
	mpGroupBy
;

1550 
	mnS‹tögCﬁumn
;

1551 
AggInfoCﬁ
 *
	maCﬁ
;

1552 
	mnCﬁumn
;

1553 
	mnCﬁumnAŒoc
;

1554 
	mnAccumuœt‹
;

1557 
AggInfoFunc
 *
	maFunc
;

1558 
	mnFunc
;

1559 
	mnFuncAŒoc
;

1572 #i‡
SQLITE4_MAX_VARIABLE_NUMBER
<=32767

1573 
i16
 
	tynV¨
;

1575 
	tynV¨
;

1641 
	sEx¥
 {

1642 
u8
 
	m›
;

1643 
	mafföôy
;

1644 
u16
 
	mÊags
;

1646 *
	mzTokí
;

1647 
	miVÆue
;

1648 } 
	mu
;

1655 
Ex¥
 *
	mpLe·
;

1656 
Ex¥
 *
	mpRight
;

1658 
Ex¥Li°
 *
	mpLi°
;

1659 
Sñe˘
 *
	mpSñe˘
;

1660 } 
	mx
;

1661 
CﬁlSeq
 *
	mpCﬁl
;

1668 
	miTabÀ
;

1671 
ynV¨
 
	miCﬁumn
;

1673 
i16
 
	miAgg
;

1674 
i16
 
	miRightJoöTabÀ
;

1675 
u8
 
	mÊags2
;

1676 
u8
 
	m›2
;

1677 
AggInfo
 *
	mpAggInfo
;

1678 
TabÀ
 *
	mpTab
;

1679 
Index
 *
	mpIdx
;

1680 #i‡
SQLITE4_MAX_EXPR_DEPTH
>0

1681 
	mnHeight
;

1688 
	#EP_FromJoö
 0x0001

	)

1689 
	#EP_Agg
 0x0002

	)

1690 
	#EP_Resﬁved
 0x0004

	)

1691 
	#EP_Eº‹
 0x0008

	)

1692 
	#EP_Di°ö˘
 0x0010

	)

1693 
	#EP_V¨Sñe˘
 0x0020

	)

1694 
	#EP_InfixFunc
 0x0080

	)

1695 
	#EP_ExpCﬁœã
 0x0100

	)

1696 
	#EP_FixedDe°
 0x0200

	)

1697 
	#EP_I¡VÆue
 0x0400

	)

1698 
	#EP_xIsSñe˘
 0x0800

	)

1699 
	#EP_Höt
 0x1000

	)

1700 
	#EP_Redu˚d
 0x2000

	)

1701 
	#EP_TokíO∆y
 0x4000

	)

1702 
	#EP_Sètic
 0x8000

	)

1707 
	#EP2_MÆlo˚dTokí
 0x0001

	)

1708 
	#EP2_IºeducibÀ
 0x0002

	)

1716 #ifde‡
SQLITE4_DEBUG


1717 
	#Ex¥SëIºeducibÀ
(
X
Ë(X)->
Êags2
 |
EP2_IºeducibÀ


	)

1719 
	#Ex¥SëIºeducibÀ
(
X
)

	)

1726 
	#Ex¥HasPr›îty
(
E
,
P
Ë(((E)->
Êags
&(P))==(P))

	)

1727 
	#Ex¥HasAnyPr›îty
(
E
,
P
Ë(((E)->
Êags
&(P))!=0)

	)

1728 
	#Ex¥SëPr›îty
(
E
,
P
Ë(E)->
Êags
|=(P)

	)

1729 
	#Ex¥CÀ¨Pr›îty
(
E
,
P
Ë(E)->
Êags
&=~(P)

	)

1736 
	#EXPR_FULLSIZE
 (
Ex¥
Ë

	)

1737 
	#EXPR_REDUCEDSIZE
 
	`off£tof
(
Ex¥
,
iTabÀ
Ë

	)

1738 
	#EXPR_TOKENONLYSIZE
 
	`off£tof
(
Ex¥
,
pLe·
Ë

	)

1744 
	#EXPRDUP_REDUCE
 0x0001

	)

1749 
	sEx¥Li°Iãm
 {

1750 
Ex¥
 *
	mpEx¥
;

1751 *
	mzName
;

1752 *
	mzS∑n
;

1753 
u8
 
	ms‹tOrdî
;

1754 
u8
 
	md⁄e
;

1755 
u16
 
	miOrdîByCﬁ
;

1756 
u16
 
	miAlüs
;

1767 
	sEx¥Li°
 {

1768 
	mnEx¥
;

1769 
	mnAŒoc
;

1770 
	miECurs‹
;

1771 
Ex¥Li°Iãm
 *
	ma
;

1779 
	sEx¥S∑n
 {

1780 
Ex¥
 *
	mpEx¥
;

1781 c⁄° *
	mzSèπ
;

1782 c⁄° *
	mzEnd
;

1785 
	sIdLi°Iãm
 {

1786 *
	mzName
;

1787 
	midx
;

1806 
	sIdLi°
 {

1807 
IdLi°Iãm
 *
	ma
;

1808 
	mnId
;

1809 
	mnAŒoc
;

1819 
u64
 
	tBômask
;

1824 
	#BMS
 (()((
Bômask
)*8))

	)

1829 
	sSrcLi°Iãm
 {

1830 *
	mzD©aba£
;

1831 *
	mzName
;

1832 *
	mzAlüs
;

1833 
TabÀ
 *
	mpTab
;

1834 
Sñe˘
 *
	mpSñe˘
;

1835 
	maddrFûlSub
;

1836 
	mªgRëu∫
;

1837 
u8
 
	mjoöty≥
;

1838 
u8
 
	mnŸIndexed
;

1839 
u8
 
	misC‹ªœãd
;

1840 #i‚de‡
SQLITE4_OMIT_EXPLAIN


1841 
u8
 
	miSñe˘Id
;

1843 
	miCurs‹
;

1844 
Ex¥
 *
	mpOn
;

1845 
IdLi°
 *
	mpUsög
;

1846 
Bômask
 
	mcﬁU£d
;

1847 *
	mzIndex
;

1848 
Index
 *
	mpIndex
;

1871 
	sSrcLi°
 {

1872 
i16
 
	mnSrc
;

1873 
i16
 
	mnAŒoc
;

1874 
SrcLi°Iãm
 
	ma
[1];

1880 
	#JT_INNER
 0x0001

	)

1881 
	#JT_CROSS
 0x0002

	)

1882 
	#JT_NATURAL
 0x0004

	)

1883 
	#JT_LEFT
 0x0008

	)

1884 
	#JT_RIGHT
 0x0010

	)

1885 
	#JT_OUTER
 0x0020

	)

1886 
	#JT_ERROR
 0x0040

	)

1903 
	sWhîePœn
 {

1904 
u32
 
	mwsFœgs
;

1905 
u32
 
	mnEq
;

1906 
	mnRow
;

1908 
Index
 *
	mpIdx
;

1909 
WhîeTîm
 *
	mpTîm
;

1910 
sqlôe4_ödex_öfo
 *
	mpVèbIdx
;

1911 } 
	mu
;

1928 
	sWhîeLevñ
 {

1929 
WhîePœn
 
	m∂™
;

1930 
	miLe·Joö
;

1931 
	miTabCur
;

1932 
	miIdxCur
;

1933 
	maddrBrk
;

1934 
	maddrNxt
;

1935 
	maddrC⁄t
;

1936 
	maddrFú°
;

1937 
u8
 
	miFrom
;

1938 
u8
 
	m›
, 
	mp5
;

1939 
	mp1
, 
	mp2
;

1942 
	mnIn
;

1943 
	sInLo›
 {

1944 
	miCur
;

1945 
	maddrInT›
;

1946 } *
	maInLo›
;

1947 } 
	mö
;

1948 } 
	mu
;

1956 
sqlôe4_ödex_öfo
 *
	mpIdxInfo
;

1965 
	#WHERE_ORDERBY_NORMAL
 0x0000

	)

1966 
	#WHERE_ORDERBY_MIN
 0x0001

	)

1967 
	#WHERE_ORDERBY_MAX
 0x0002

	)

1968 
	#WHERE_ONEPASS_DESIRED
 0x0004

	)

1969 
	#WHERE_DUPLICATES_OK
 0x0008

	)

1970 
	#WHERE_OMIT_OPEN_CLOSE
 0x0010

	)

1971 
	#WHERE_NO_AUTOINDEX
 0x0020

	)

1972 
	#WHERE_ONETABLE_ONLY
 0x0040

	)

1973 
	#WHERE_AND_ONLY
 0x0080

	)

1981 
	#WHERE_ORDERBY_NORMAL
 0x0000

	)

1982 
	#WHERE_ORDERBY_MIN
 0x0001

	)

1983 
	#WHERE_ORDERBY_MAX
 0x0002

	)

1984 
	#WHERE_ONEPASS_DESIRED
 0x0004

	)

1985 
	#WHERE_DUPLICATES_OK
 0x0008

	)

1986 
	#WHERE_OMIT_OPEN_CLOSE
 0x0010

	)

1987 
	#WHERE_FORCE_TABLE
 0x0020

	)

1988 
	#WHERE_ONETABLE_ONLY
 0x0040

	)

1989 
	#WHERE_AND_ONLY
 0x0080

	)

1990 
	#WHERE_GROUPBY
 0x0100

	)

1991 
	#WHERE_DISTINCTBY
 0x0200

	)

1992 
	#WHERE_WANT_DISTINCT
 0x0400

	)

2004 
	sWhîeInfo
 {

2005 
P¨£
 *
	mpP¨£
;

2006 
u16
 
	mw˘æFœgs
;

2007 
u8
 
	mokO√Pass
;

2008 
u8
 
	mu¡e°edTîms
;

2009 
u8
 
	meDi°ö˘
;

2010 
SrcLi°
 *
	mpTabLi°
;

2011 
	miT›
;

2012 
	miC⁄töue
;

2013 
	miBªak
;

2014 
	mnLevñ
;

2015 
WhîeCœu£
 *
	mpWC
;

2016 
	mßvedNQuîyLo›
;

2017 
	mnRowOut
;

2018 
WhîeLevñ
 
	ma
[1];

2022 
	#WHERE_DISTINCT_NOOP
 0

	)

2023 
	#WHERE_DISTINCT_UNIQUE
 1

	)

2024 
	#WHERE_DISTINCT_ORDERED
 2

	)

2025 
	#WHERE_DISTINCT_UNORDERED
 3

	)

2048 
	sNameC⁄ãxt
 {

2049 
P¨£
 *
	mpP¨£
;

2050 
SrcLi°
 *
	mpSrcLi°
;

2051 
Ex¥Li°
 *
	mpELi°
;

2052 
	mnRef
;

2053 
	mnEº
;

2054 
u8
 
	mÆlowAgg
;

2055 
u8
 
	mhasAgg
;

2056 
u8
 
	misCheck
;

2057 
	mnDïth
;

2058 
AggInfo
 *
	mpAggInfo
;

2059 
NameC⁄ãxt
 *
	mpNext
;

2082 
	sSñe˘
 {

2083 
Ex¥Li°
 *
	mpELi°
;

2084 
u8
 
	m›
;

2085 
	mafföôy
;

2086 
u16
 
	m£lFœgs
;

2087 
SrcLi°
 *
	mpSrc
;

2088 
Ex¥
 *
	mpWhîe
;

2089 
Ex¥Li°
 *
	mpGroupBy
;

2090 
Ex¥
 *
	mpHavög
;

2091 
Ex¥Li°
 *
	mpOrdîBy
;

2092 
Sñe˘
 *
	mpPri‹
;

2093 
Sñe˘
 *
	mpNext
;

2094 
Sñe˘
 *
	mpRightmo°
;

2095 
Ex¥
 *
	mpLimô
;

2096 
Ex¥
 *
	mpOff£t
;

2097 
	miLimô
, 
	miOff£t
;

2098 
	maddrO≥nEphm
[3];

2099 
	mnSñe˘Row
;

2106 
	#SF_Di°ö˘
 0x01

	)

2107 
	#SF_Resﬁved
 0x02

	)

2108 
	#SF_Aggªg©e
 0x04

	)

2109 
	#SF_U£sEphemîÆ
 0x08

	)

2110 
	#SF_Ex∑nded
 0x10

	)

2111 
	#SF_HasTy≥Info
 0x20

	)

2112 
	#SF_U£S‹ãr
 0x40

	)

2113 
	#SF_VÆues
 0x80

	)

2120 
	#SRT_Uni⁄
 1

	)

2121 
	#SRT_Ex˚±
 2

	)

2122 
	#SRT_Exi°s
 3

	)

2123 
	#SRT_Disˇrd
 4

	)

2126 
	#Ign‹abÀOrdîby
(
X
Ë((X->
eDe°
)<=
SRT_Disˇrd
)

	)

2128 
	#SRT_Ouçut
 5

	)

2129 
	#SRT_Mem
 6

	)

2130 
	#SRT_Së
 7

	)

2131 
	#SRT_TabÀ
 8

	)

2132 
	#SRT_EphemTab
 9

	)

2133 
	#SRT_C‹outöe
 10

	)

2139 
Sñe˘De°
 
	tSñe˘De°
;

2140 
	sSñe˘De°
 {

2141 
u8
 
	meDe°
;

2142 
u8
 
	mafföôy
;

2143 
	miP¨m
;

2144 
	miMem
;

2145 
	mnMem
;

2157 
	sAutoöcInfo
 {

2158 
AutoöcInfo
 *
	mpNext
;

2159 
TabÀ
 *
	mpTab
;

2160 
	miDb
;

2161 
	mªgCå
;

2167 #i‚de‡
SQLITE4_N_COLCACHE


2168 
	#SQLITE4_N_COLCACHE
 10

	)

2189 
	sTriggîPrg
 {

2190 
Triggî
 *
	mpTriggî
;

2191 
	m‹c⁄f
;

2192 
SubProgøm
 *
	mpProgøm
;

2193 
u32
 
	maCﬁmask
[2];

2194 
TriggîPrg
 *
	mpNext
;

2200 #i‡
SQLITE4_MAX_ATTACHED
>30

2201 
sqlôe4_uöt64
 
	tyDbMask
;

2203 
	tyDbMask
;

2210 
	sP¨£YCﬁCache
 {

2211 
	miTabÀ
;

2212 
	miCﬁumn
;

2213 
u8
 
	mãmpReg
;

2214 
	miLevñ
;

2215 
	miReg
;

2216 
	mÃu
;

2230 
	sP¨£
 {

2231 
sqlôe4
 *
	mdb
;

2232 
	mrc
;

2233 *
	mzEºMsg
;

2234 
Vdbe
 *
	mpVdbe
;

2235 
u8
 
	mcﬁNamesSë
;

2236 
u8
 
	mcheckSchema
;

2237 
u8
 
	m√°ed
;

2238 
u8
 
	mnTempReg
;

2239 
u8
 
	mnTempInU£
;

2240 
	maTempReg
[8];

2241 
	mnR™geReg
;

2242 
	miR™geReg
;

2243 
	mnEº
;

2244 
	mnTab
;

2245 
	mnMem
;

2246 
	mnSë
;

2247 
	mnOn˚
;

2248 
	mckBa£
;

2249 
	miCacheLevñ
;

2250 
	miCacheC¡
;

2251 
	miNewidxReg
;

2252 
u8
 
	mnCﬁCache
;

2253 
u8
 
	miCﬁCache
;

2254 
P¨£YCﬁCache
 
	maCﬁCache
[
SQLITE4_N_COLCACHE
];

2255 
yDbMask
 
	mwrôeMask
;

2256 
yDbMask
 
	mcookõMask
;

2257 
u8
 
	misMu…iWrôe
;

2258 
u8
 
	mmayAb‹t
;

2259 
	mcookõGŸo
;

2260 
	mcookõVÆue
[
SQLITE4_MAX_ATTACHED
+2];

2261 
	mªgRowid
;

2262 *
	mpPKRoŸ
;

2263 
AutoöcInfo
 *
	mpAöc
;

2264 
	mnMaxArg
;

2267 
P¨£
 *
	mpT›Àvñ
;

2268 
TabÀ
 *
	mpTriggîTab
;

2269 
u32
 
	mﬁdmask
;

2270 
u32
 
	m√wmask
;

2271 
u8
 
	meTriggîOp
;

2272 
u8
 
	meOrc⁄f
;

2273 
u8
 
	mdißbÀTriggîs
;

2274 
	mnQuîyLo›
;

2279 
	mnV¨
;

2280 
	mnzV¨
;

2281 **
	mazV¨
;

2282 
Vdbe
 *
	mpRïª∑ª
;

2283 
	mnAlüs
;

2284 *
	maAlüs
;

2285 
u8
 
	mex∂aö
;

2286 
Tokí
 
	msNameTokí
;

2287 
Tokí
 
	msLa°Tokí
;

2288 c⁄° *
	mzTaû
;

2289 
TabÀ
 *
	mpNewTabÀ
;

2290 
Triggî
 *
	mpNewTriggî
;

2291 c⁄° *
	mzAuthC⁄ãxt
;

2292 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


2293 
Tokí
 
	msArg
;

2294 
u8
 
	mde˛¨eVèb
;

2295 
	mnVèbLock
;

2296 
TabÀ
 **
	m≠VèbLock
;

2298 
	mnHeight
;

2299 
TabÀ
 *
	mpZombõTab
;

2300 
TriggîPrg
 *
	mpTriggîPrg
;

2302 #i‚de‡
SQLITE4_OMIT_EXPLAIN


2303 
	miSñe˘Id
;

2304 
	miNextSñe˘Id
;

2308 #ifde‡
SQLITE4_OMIT_VIRTUALTABLE


2309 
	#IN_DECLARE_VTAB
 0

	)

2311 
	#IN_DECLARE_VTAB
 (
pP¨£
->
de˛¨eVèb
)

	)

2318 
	sAuthC⁄ãxt
 {

2319 c⁄° *
	mzAuthC⁄ãxt
;

2320 
P¨£
 *
	mpP¨£
;

2326 
	#OPFLAG_NCHANGE
 0x01

	)

2327 
	#OPFLAG_ISUPDATE
 0x02

	)

2328 
	#OPFLAG_USEKEY
 0x04

	)

2329 
	#OPFLAG_SEQCOUNT
 0x08

	)

2330 
	#OPFLAG_CLEARCACHE
 0x10

	)

2347 
	sTriggî
 {

2348 *
	mzName
;

2349 *
	mèbÀ
;

2350 
u8
 
	m›
;

2351 
u8
 
	må_tm
;

2352 
Ex¥
 *
	mpWhí
;

2353 
IdLi°
 *
	mpCﬁumns
;

2355 
Schema
 *
	mpSchema
;

2356 
Schema
 *
	mpTabSchema
;

2357 
TriggîSãp
 *
	m°ï_li°
;

2358 
Triggî
 *
	mpNext
;

2368 
	#TRIGGER_BEFORE
 1

	)

2369 
	#TRIGGER_AFTER
 2

	)

2409 
	sTriggîSãp
 {

2410 
u8
 
	m›
;

2411 
u8
 
	m‹c⁄f
;

2412 
Triggî
 *
	mpTrig
;

2413 
Sñe˘
 *
	mpSñe˘
;

2414 
Tokí
 
	mèrgë
;

2415 
Ex¥
 *
	mpWhîe
;

2416 
Ex¥Li°
 *
	mpEx¥Li°
;

2417 
IdLi°
 *
	mpIdLi°
;

2418 
TriggîSãp
 *
	mpNext
;

2419 
TriggîSãp
 *
	mpLa°
;

2427 
DbFixî
 
	tDbFixî
;

2428 
	sDbFixî
 {

2429 
P¨£
 *
	mpP¨£
;

2430 c⁄° *
	mzDb
;

2431 c⁄° *
	mzTy≥
;

2432 c⁄° 
Tokí
 *
	mpName
;

2439 
	sSåAccum
 {

2440 
sqlôe4
 *
	mdb
;

2441 
sqlôe4_ív
 *
	mpEnv
;

2442 *
	mzBa£
;

2443 *
	mzText
;

2444 
	mnCh¨
;

2445 
	mnAŒoc
;

2446 
	mmxAŒoc
;

2447 
u8
 
	mmÆlocFaûed
;

2448 
u8
 
	mu£MÆloc
;

2449 
u8
 
	mtooBig
;

2457 
sqlôe4
 *
	mdb
;

2458 
	miDb
;

2459 **
	mpzEºMsg
;

2460 
	mrc
;

2461 } 
	tInôD©a
;

2466 
	sKVFa˘‹y
 {

2467 
KVFa˘‹y
 *
	mpNext
;

2468 c⁄° *
	mzName
;

2469 
sqlôe4_kvÁ˘‹y
 
	mxFa˘‹y
;

2470 
	misPîm
;

2471 } 
	tKVFa˘‹y
;

2476 
	ssqlôe4_ív
 {

2477 
	mnByã
;

2478 
	miVîsi⁄
;

2479 
	mbMem°©
;

2480 
	mbC‹eMuãx
;

2481 
	mbFuŒMuãx
;

2482 
	mmxSåÀn
;

2483 
	mszLookaside
;

2484 
	mnLookaside
;

2485 
sqlôe4_mm
 *
	mpMM
;

2486 
sqlôe4_muãx_mëhods
 
	mmuãx
;

2487 *
	mpHóp
;

2488 
	mnHóp
;

2489 
	mmnReq
, 
	mmxReq
;

2490 
	mmxP¨£rSèck
;

2491 
KVFa˘‹y
 *
	mpFa˘‹y
;

2492 (*
	mxR™dom√ss
)(
	msqlôe4_ív
*, , *);

2493 (*
	mxCuºítTime
)(
	msqlôe4_ív
*, 
	msqlôe4_uöt64
*);

2496 
	misInô
;

2497 
sqlôe4_muãx
 *
	mpFa˘‹yMuãx
;

2498 
sqlôe4_muãx
 *
	mpP∫gMuãx
;

2499 
u32
 
	m¥ngX
, 
	m¥ngY
;

2500 (*
	mxLog
)(*,,const *);

2501 *
	mpLogArg
;

2502 
	mbLoˇ…imeFau…
;

2503 
sqlôe4_muãx
 *
	mpMemMuãx
;

2504 
sqlôe4_uöt64
 
	mnowVÆue
[4];

2505 
sqlôe4_uöt64
 
	mmxVÆue
[4];

2506 
FuncDefTabÀ
 
	maGlobÆFuncs
;

2512 
	sWÆkî
 {

2513 (*
	mxEx¥CÆlback
)(
	mWÆkî
*, 
	mEx¥
*);

2514 (*
	mxSñe˘CÆlback
)(
	mWÆkî
*,
	mSñe˘
*);

2515 
P¨£
 *
	mpP¨£
;

2517 
NameC⁄ãxt
 *
	mpNC
;

2518 
	mi
;

2519 } 
	mu
;

2526 
	sFts5Info
 {

2527 
	miDb
;

2528 
	miRoŸ
;

2529 
	miTbl
;

2530 
	mnCﬁ
;

2531 **
	mazCﬁ
;

2532 
Fts5Tokíizî
 *
	mpTokíizî
;

2533 
sqlôe4_tokíizî
 *
	mp
;

2536 
sqlôe4WÆkEx¥
(
WÆkî
*, 
Ex¥
*);

2537 
sqlôe4WÆkEx¥Li°
(
WÆkî
*, 
Ex¥Li°
*);

2538 
sqlôe4WÆkSñe˘
(
WÆkî
*, 
Sñe˘
*);

2539 
sqlôe4WÆkSñe˘Ex¥
(
WÆkî
*, 
Sñe˘
*);

2540 
sqlôe4WÆkSñe˘From
(
WÆkî
*, 
Sñe˘
*);

2546 
	#WRC_C⁄töue
 0

	)

2547 
	#WRC_Pru√
 1

	)

2548 
	#WRC_Ab‹t
 2

	)

2554 
	#SQLITE4_SKIP_UTF8
(
zIn
) { \

2555 if–(*(*)(
zIn
++))>=0xc0 ){ \

2556  (*
zIn
 & 0xc0)==0x80 ){ zIn++; } \

2558 }

	)

2563 
sqlôe4_mm
 
sqlôe4MMSy°em
;

2572 
sqlôe4C‹ru±Eº‹
();

2573 
sqlôe4Misu£Eº‹
();

2574 
sqlôe4C™t›íEº‹
();

2575 
	#SQLITE4_CORRUPT_BKPT
 
	`sqlôe4C‹ru±Eº‹
(
__LINE__
)

	)

2576 
	#SQLITE4_MISUSE_BKPT
 
	`sqlôe4Misu£Eº‹
(
__LINE__
)

	)

2577 
	#SQLITE4_CANTOPEN_BKPT
 
	`sqlôe4C™t›íEº‹
(
__LINE__
)

	)

2585 #i‡
deföed
(
SQLITE4_ENABLE_FTS4
Ë&& !deföed(
SQLITE4_ENABLE_FTS3
)

2586 
	#SQLITE4_ENABLE_FTS3


	)

2595 #ifde‡
SQLITE4_ASCII


2596 
	#sqlôe4Touµî
(
x
Ë((x)&~(
sqlôe4Cty≥M≠
[()(x)]&0x20))

	)

2597 
	#sqlôe4Is•a˚
(
x
Ë(
sqlôe4Cty≥M≠
[()(x)]&0x01)

	)

2598 
	#sqlôe4Iß um
(
x
Ë(
sqlôe4Cty≥M≠
[()(x)]&0x06)

	)

2599 
	#sqlôe4IßÕha
(
x
Ë(
sqlôe4Cty≥M≠
[()(x)]&0x02)

	)

2600 
	#sqlôe4Isdigô
(
x
Ë(
sqlôe4Cty≥M≠
[()(x)]&0x04)

	)

2601 
	#sqlôe4Isxdigô
(
x
Ë(
sqlôe4Cty≥M≠
[()(x)]&0x08)

	)

2602 
	#sqlôe4Tﬁowî
(
x
Ë(
sqlôe4UµîToLowî
[()(x)])

	)

2604 
	#sqlôe4Touµî
(
x
Ë
	`touµî
(()(x))

	)

2605 
	#sqlôe4Is•a˚
(
x
Ë
	`is•a˚
(()(x))

	)

2606 
	#sqlôe4Iß um
(
x
Ë
	`iß um
(()(x))

	)

2607 
	#sqlôe4IßÕha
(
x
Ë
	`ißÕha
(()(x))

	)

2608 
	#sqlôe4Isdigô
(
x
Ë
	`isdigô
(()(x))

	)

2609 
	#sqlôe4Isxdigô
(
x
Ë
	`isxdigô
(()(x))

	)

2610 
	#sqlôe4Tﬁowî
(
x
Ë
	`tﬁowî
(()(x))

	)

2616 
sqlôe4SåÀn30
(const *);

2618 
sqlôe4MÆlocInô
(
sqlôe4_ív
*);

2619 
sqlôe4MÆlocEnd
(
sqlôe4_ív
*);

2620 *
sqlôe4MÆloc
(
sqlôe4_ív
*, );

2621 *
sqlôe4MÆlocZîo
(
sqlôe4_ív
*, );

2622 *
sqlôe4DbMÆlocZîo
(
sqlôe4
*, );

2623 *
sqlôe4DbMÆlocRaw
(
sqlôe4
*, );

2624 *
sqlôe4DbSåDup
(
sqlôe4
*,const *);

2625 *
sqlôe4DbSåNDup
(
sqlôe4
*,const *, );

2626 *
sqlôe4RóŒoc
(
sqlôe4_ív
*, *, );

2627 *
sqlôe4DbRóŒocOrFªe
(
sqlôe4
 *, *, );

2628 *
sqlôe4DbRóŒoc
(
sqlôe4
 *, *, );

2629 
sqlôe4DbFªe
(
sqlôe4
*, *);

2630 
sqlôe4MÆlocSize
(
sqlôe4_ív
*, *);

2631 
sqlôe4DbMÆlocSize
(
sqlôe4
*, *);

2632 
sqlôe4MemSëDeÁu…
(
sqlôe4_ív
*);

2633 
sqlôe4BíignMÆlocHooks
(
sqlôe4_ív
*,(*)(), (*)());

2643 #ifde‡
SQLITE4_USE_ALLOCA


2644 
	#sqlôe4SèckAŒocRaw
(
D
,
N
Ë
	`Æloˇ
(N)

	)

2645 
	#sqlôe4SèckAŒocZîo
(
D
,
N
Ë
	`mem£t
(
	`Æloˇ
(N), 0, N)

	)

2646 
	#sqlôe4SèckFªe
(
D
,
P
)

	)

2648 
	#sqlôe4SèckAŒocRaw
(
D
,
N
Ë
	`sqlôe4DbMÆlocRaw
(D,N)

	)

2649 
	#sqlôe4SèckAŒocZîo
(
D
,
N
Ë
	`sqlôe4DbMÆlocZîo
(D,N)

	)

2650 
	#sqlôe4SèckFªe
(
D
,
P
Ë
	`sqlôe4DbFªe
(D,P)

	)

2653 #ifde‡
SQLITE4_ENABLE_MEMSYS3


2654 c⁄° 
sqlôe4_mem_mëhods
 *
	`sqlôe4MemGëMemsys3
();

2656 #ifde‡
SQLITE4_ENABLE_MEMSYS5


2657 c⁄° 
sqlôe4_mem_mëhods
 *
	`sqlôe4MemGëMemsys5
();

2661 #i‚de‡
SQLITE4_MUTEX_OMIT


2662 
sqlôe4_muãx_mëhods
 c⁄° *
	`sqlôe4DeÁu…Muãx
();

2663 
sqlôe4_muãx_mëhods
 c⁄° *
	`sqlôe4No›Muãx
();

2664 
sqlôe4_muãx
 *
	`sqlôe4MuãxAŒoc
(
sqlôe4_ív
*,);

2665 
	`sqlôe4MuãxInô
(
sqlôe4_ív
*);

2666 
	`sqlôe4MuãxEnd
(
sqlôe4_ív
*);

2669 
	`sqlôe4SètusAdd
(
sqlôe4_ív
*, , 
sqlôe4_öt64
);

2670 
	`sqlôe4SètusSë
(
sqlôe4_ív
*, , 
sqlôe4_uöt64
);

2672 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


2673 
	`sqlôe4IsNaN
();

2674 
	`sqlôe4IsInf
();

2676 
	#sqlôe4IsNaN
(
X
Ë0

	)

2677 
	#sqlôe4IsInf
(
X
Ë0

	)

2680 
	`sqlôe4BlobToHex
(, c⁄° 
u8
*, *);

2681 
	`sqlôe4VXPrötf
(
SåAccum
*, , c⁄° *, 
va_li°
);

2682 #i‚de‡
SQLITE4_OMIT_TRACE


2683 
	`sqlôe4XPrötf
(
SåAccum
*, const *, ...);

2685 *
	`sqlôe4MPrötf
(
sqlôe4
*,const *, ...);

2686 *
	`sqlôe4VMPrötf
(
sqlôe4
*,c⁄° *, 
va_li°
);

2687 *
	`sqlôe4MAµídf
(
sqlôe4
*,*,const *,...);

2688 #i‡
	`deföed
(
SQLITE4_TEST
Ë|| deföed(
SQLITE4_DEBUG
)

2689 
	`sqlôe4DebugPrötf
(const *, ...);

2691 #i‡
	`deföed
(
SQLITE4_TEST
)

2692 *
	`sqlôe4Te°TextToPå
(const *);

2696 #i‡
	`deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

2697 
	`sqlôe4Ex∂aöBegö
(
Vdbe
*);

2698 
	`sqlôe4Ex∂aöPrötf
(
Vdbe
*, const *, ...);

2699 
	`sqlôe4Ex∂aöNL
(
Vdbe
*);

2700 
	`sqlôe4Ex∂aöPush
(
Vdbe
*);

2701 
	`sqlôe4Ex∂aöP›
(
Vdbe
*);

2702 
	`sqlôe4Ex∂aöFöish
(
Vdbe
*);

2703 
	`sqlôe4Ex∂aöSñe˘
(
Vdbe
*, 
Sñe˘
*);

2704 
	`sqlôe4Ex∂aöEx¥
(
Vdbe
*, 
Ex¥
*);

2705 
	`sqlôe4Ex∂aöEx¥Li°
(
Vdbe
*, 
Ex¥Li°
*);

2706 c⁄° *
	`sqlôe4VdbeEx∂™©i⁄
(
Vdbe
*);

2708 
	#sqlôe4Ex∂aöBegö
(
X
)

	)

2709 
	#sqlôe4Ex∂aöSñe˘
(
A
,
B
)

	)

2710 
	#sqlôe4Ex∂aöEx¥
(
A
,
B
)

	)

2711 
	#sqlôe4Ex∂aöEx¥Li°
(
A
,
B
)

	)

2712 
	#sqlôe4Ex∂aöFöish
(
X
)

	)

2713 
	#sqlôe4VdbeEx∂™©i⁄
(
X
Ë0

	)

2717 
	`sqlôe4SëSåög
(**, 
sqlôe4
*, const *, ...);

2718 
	`sqlôe4Eº‹Msg
(
P¨£
*, const *, ...);

2719 
	`sqlôe4DequŸe
(*);

2720 
	`sqlôe4Keyw‹dCode
(const *, );

2721 
	`sqlôe4RunP¨£r
(
P¨£
*, const *, **);

2722 
	`sqlôe4FöishCodög
(
P¨£
*);

2723 
	`sqlôe4GëTempReg
(
P¨£
*);

2724 
	`sqlôe4Rñó£TempReg
(
P¨£
*,);

2725 
	`sqlôe4GëTempR™ge
(
P¨£
*,);

2726 
	`sqlôe4Rñó£TempR™ge
(
P¨£
*,,);

2727 
	`sqlôe4CÀ¨TempRegCache
(
P¨£
*);

2728 
Ex¥
 *
	`sqlôe4Ex¥AŒoc
(
sqlôe4
*,,c⁄° 
Tokí
*,);

2729 
Ex¥
 *
	`sqlôe4Ex¥
(
sqlôe4
*,,const *);

2730 
	`sqlôe4Ex¥AâachSubåìs
(
sqlôe4
*,
Ex¥
*,Expr*,Expr*);

2731 
Ex¥
 *
	`sqlôe4PEx¥
(
P¨£
*, , Ex¥*, Ex¥*, c⁄° 
Tokí
*);

2732 
Ex¥
 *
	`sqlôe4Ex¥And
(
sqlôe4
*,Expr*, Expr*);

2733 
Ex¥
 *
	`sqlôe4Ex¥Fun˘i⁄
(
P¨£
*,
Ex¥Li°
*, 
Tokí
*);

2734 
	`sqlôe4Ex¥AssignV¨Numbî
(
P¨£
*, 
Ex¥
*);

2735 
	`sqlôe4Ex¥Dñëe
(
sqlôe4
*, 
Ex¥
*);

2736 
Ex¥Li°
 *
	`sqlôe4Ex¥Li°Aµíd
(
P¨£
*,Ex¥Li°*,
Ex¥
*);

2737 
	`sqlôe4Ex¥Li°SëName
(
P¨£
*,
Ex¥Li°
*,
Tokí
*,);

2738 
	`sqlôe4Ex¥Li°SëS∑n
(
P¨£
*,
Ex¥Li°
*,
Ex¥S∑n
*);

2739 
	`sqlôe4Ex¥Li°Dñëe
(
sqlôe4
*, 
Ex¥Li°
*);

2740 
	`sqlôe4Inô
(
sqlôe4
*, **);

2741 
	`sqlôe4InôCÆlback
(*, , 
sqlôe4_vÆue
**, const **);

2742 
	`sqlôe4Pøgma
(
P¨£
*,
Tokí
*,Tokí*,
Ex¥Li°
*);

2743 
	`sqlôe4Re£tI¡î«lSchema
(
sqlôe4
*, );

2744 
	`sqlôe4BegöP¨£
(
P¨£
*,);

2745 
	`sqlôe4CommôI¡î«lCh™ges
(
sqlôe4
*);

2746 
TabÀ
 *
	`sqlôe4Resu…SëOfSñe˘
(
P¨£
*,
Sñe˘
*);

2747 
	`sqlôe4O≥nMa°îTabÀ
(
P¨£
 *, );

2748 
	`sqlôe4SèπTabÀ
(
P¨£
*,
Tokí
*,Token*,,,,);

2749 
	`sqlôe4AddCﬁumn
(
P¨£
*,
Tokí
*);

2750 
	`sqlôe4AddNŸNuŒ
(
P¨£
*, );

2751 
	`sqlôe4AddPrim¨yKey
(
P¨£
*, 
Ex¥Li°
*, , , );

2752 
	`sqlôe4AddCheckC⁄°øöt
(
P¨£
*, 
Ex¥
*);

2753 
	`sqlôe4AddCﬁumnTy≥
(
P¨£
*,
Tokí
*);

2754 
	`sqlôe4AddDeÁu…VÆue
(
P¨£
*,
Ex¥S∑n
*);

2755 
	`sqlôe4AddCﬁœãTy≥
(
P¨£
*, 
Tokí
*);

2756 
	`sqlôe4EndTabÀ
(
P¨£
*,
Tokí
*,Tokí*,
Sñe˘
*);

2757 
	`sqlôe4P¨£Uri
(
sqlôe4_ív
*,const *,*,**,**);

2758 
	`sqlôe4CodeOn˚
(
P¨£
 *);

2760 
RowSë
 *
	`sqlôe4RowSëInô
(
sqlôe4
 *, *, );

2761 
	`sqlôe4RowSëCÀ¨
(
RowSë
 *);

2762 
	`sqlôe4RowSëIn£π
(
RowSë
 *, 
u8
 *, );

2763 
	`sqlôe4RowSëNext
(
RowSë
 *);

2764 c⁄° 
u8
 *
	`sqlôe4RowSëRód
(
RowSë
 *, *);

2765 
	`sqlôe4RowSëTe°
(
RowSë
 *, 
u8
, u8 *, );

2767 
	`sqlôe4Cª©eVõw
(
P¨£
*,
Tokí
*,Tokí*,Tokí*,
Sñe˘
*,,);

2769 #i‡!
	`deföed
(
SQLITE4_OMIT_VIEW
Ë|| !deföed(
SQLITE4_OMIT_VIRTUALTABLE
)

2770 
	`sqlôe4VõwGëCﬁumnNames
(
P¨£
*,
TabÀ
*);

2772 
	#sqlôe4VõwGëCﬁumnNames
(
A
,
B
Ë0

	)

2775 
	`sqlôe4Dr›TabÀ
(
P¨£
*, 
SrcLi°
*, , );

2776 
	`sqlôe4CodeDr›TabÀ
(
P¨£
*, 
TabÀ
*, , );

2777 
	`sqlôe4DñëeTabÀ
(
sqlôe4
*, 
TabÀ
*);

2778 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


2779 
	`sqlôe4Autoö¸emítBegö
(
P¨£
 *
pP¨£
);

2780 
	`sqlôe4Autoö¸emítEnd
(
P¨£
 *
pP¨£
);

2782 
	#sqlôe4Autoö¸emítBegö
(
X
)

	)

2783 
	#sqlôe4Autoö¸emítEnd
(
X
)

	)

2785 
	`sqlôe4In£π
(
P¨£
*, 
SrcLi°
*, 
Ex¥Li°
*, 
Sñe˘
*, 
IdLi°
*, );

2786 *
	`sqlôe4AºayAŒoˇã
(
sqlôe4
*,*,,,*,*,*);

2787 
IdLi°
 *
	`sqlôe4IdLi°Aµíd
(
sqlôe4
*, IdLi°*, 
Tokí
*);

2788 
	`sqlôe4IdLi°Index
(
IdLi°
*,const *);

2789 
SrcLi°
 *
	`sqlôe4SrcLi°E∆¨ge
(
sqlôe4
*, SrcList*, , );

2790 
SrcLi°
 *
	`sqlôe4SrcLi°Aµíd
(
sqlôe4
*, SrcLi°*, 
Tokí
*, Token*);

2791 
SrcLi°
 *
	`sqlôe4SrcLi°AµídFromTîm
(
P¨£
*, SrcLi°*, 
Tokí
*, Token*,

2792 
Tokí
*, 
Sñe˘
*, 
Ex¥
*, 
IdLi°
*);

2793 
	`sqlôe4SrcLi°IndexedBy
(
P¨£
 *, 
SrcLi°
 *, 
Tokí
 *);

2794 
	`sqlôe4IndexedByLookup
(
P¨£
 *, 
SrcLi°Iãm
 *);

2795 
	`sqlôe4SrcLi°Shi·JoöTy≥
(
SrcLi°
*);

2796 
	`sqlôe4SrcLi°AssignCurs‹s
(
P¨£
*, 
SrcLi°
*);

2797 
	`sqlôe4IdLi°Dñëe
(
sqlôe4
*, 
IdLi°
*);

2798 
	`sqlôe4SrcLi°Dñëe
(
sqlôe4
*, 
SrcLi°
*);

2799 
Index
 *
	`sqlôe4Cª©eIndex
(
P¨£
*,
Cª©eIndex
*,
Ex¥Li°
*,
IdLi°
*,,
Tokí
*,,);

2800 
	`sqlôe4Dr›Index
(
P¨£
*, 
SrcLi°
*, );

2801 
	`sqlôe4Sñe˘
(
P¨£
*, 
Sñe˘
*, 
Sñe˘De°
*);

2802 
Sñe˘
 *
	`sqlôe4Sñe˘New
(
P¨£
*,
Ex¥Li°
*,
SrcLi°
*,
Ex¥
*,ExprList*,

2803 
Ex¥
*,
Ex¥Li°
*,,Expr*,Expr*);

2804 
	`sqlôe4Sñe˘Dñëe
(
sqlôe4
*, 
Sñe˘
*);

2805 
TabÀ
 *
	`sqlôe4SrcLi°Lookup
(
P¨£
*, 
SrcLi°
*);

2806 
	`sqlôe4IsRódO∆y
(
P¨£
*, 
TabÀ
*, );

2807 
	`sqlôe4O≥nTabÀ
(
P¨£
*, 
iCur
, 
iDb
, 
TabÀ
*, );

2808 #i‡
	`deföed
(
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT
) \

2809 && !
	$deföed
(
SQLITE4_OMIT_SUBQUERY
)

2810 
Ex¥
 *
	`sqlôe4LimôWhîe
(
P¨£
*,
SrcLi°
*,Ex¥*,
Ex¥Li°
*,Expr*,Expr*,*);

2812 
	`sqlôe4DñëeFrom
(
P¨£
*, 
SrcLi°
*, 
Ex¥
*);

2813 
	`sqlôe4Upd©e
(
P¨£
*, 
SrcLi°
*, 
Ex¥Li°
*, 
Ex¥
*, );

2814 
WhîeInfo
 *
	`sqlôe4WhîeBegö
(
P¨£
*,
SrcLi°
*,
Ex¥
*,
Ex¥Li°
*,Ex¥Li°*,
u16
,);

2816 
	`sqlôe4WhîeEnd
(
WhîeInfo
*);

2817 
u64
 
	`sqlôe4WhîeOuçutRowCou¡
(
WhîeInfo
*);

2818 
	`sqlôe4WhîeIsDi°ö˘
(
WhîeInfo
*);

2819 
	`sqlôe4WhîeIsOrdîed
(
WhîeInfo
*);

2820 
	`sqlôe4WhîeC⁄töueLabñ
(
WhîeInfo
*);

2821 
	`sqlôe4WhîeBªakLabñ
(
WhîeInfo
*);

2822 
	`sqlôe4WhîeOkO√Pass
(
WhîeInfo
*);

2823 
	`sqlôe4Ex¥CodeGëCﬁumn
(
P¨£
*, 
TabÀ
*, , , );

2824 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
Vdbe
*, 
TabÀ
*, , , );

2825 
	`sqlôe4Ex¥CodeMove
(
P¨£
*, , , );

2826 
	`sqlôe4Ex¥CodeC›y
(
P¨£
*, , , );

2827 
	`sqlôe4Ex¥CacheSt‹e
(
P¨£
*, , , );

2828 
	`sqlôe4Ex¥CachePush
(
P¨£
*);

2829 
	`sqlôe4Ex¥CacheP›
(
P¨£
*, );

2830 
	`sqlôe4Ex¥CacheRemove
(
P¨£
*, , );

2831 
	`sqlôe4Ex¥CacheCÀ¨
(
P¨£
*);

2832 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
P¨£
*, , );

2833 
	`sqlôe4Ex¥Code
(
P¨£
*, 
Ex¥
*, );

2834 
	`sqlôe4Ex¥CodeTemp
(
P¨£
*, 
Ex¥
*, *);

2835 
	`sqlôe4Ex¥CodeT¨gë
(
P¨£
*, 
Ex¥
*, );

2836 
	`sqlôe4Ex¥CodeAndCache
(
P¨£
*, 
Ex¥
*, );

2837 
	`sqlôe4Ex¥CodeC⁄°™ts
(
P¨£
*, 
Ex¥
*);

2838 
	`sqlôe4Ex¥CodeEx¥Li°
(
P¨£
*, 
Ex¥Li°
*, , );

2839 
	`sqlôe4Ex¥IfTrue
(
P¨£
*, 
Ex¥
*, , );

2840 
	`sqlôe4Ex¥IfFÆ£
(
P¨£
*, 
Ex¥
*, , );

2841 
TabÀ
 *
	`sqlôe4FödTabÀ
(
sqlôe4
*,const *, const *);

2842 
TabÀ
 *
	`sqlôe4LoˇãTabÀ
(
P¨£
*,
isVõw
,const *, const *);

2843 
Index
 *
	`sqlôe4FödIndex
(
sqlôe4
*,const *, const *);

2844 
	`sqlôe4U∆ökAndDñëeTabÀ
(
sqlôe4
*,,const *);

2845 
	`sqlôe4U∆ökAndDñëeIndex
(
sqlôe4
*,,const *);

2846 
	`sqlôe4Vacuum
(
P¨£
*);

2847 
	`sqlôe4RunVacuum
(**, 
sqlôe4
*);

2848 *
	`sqlôe4NameFromTokí
(
sqlôe4
*, 
Tokí
*);

2849 
	`sqlôe4Ex¥Com∑ª
(
Ex¥
*, Expr*);

2850 
	`sqlôe4Ex¥Li°Com∑ª
(
Ex¥Li°
*, ExprList*);

2851 
	`sqlôe4Ex¥A«lyzeAggªg©es
(
NameC⁄ãxt
*, 
Ex¥
*);

2852 
	`sqlôe4Ex¥A«lyzeAggLi°
(
NameC⁄ãxt
*,
Ex¥Li°
*);

2853 
Vdbe
 *
	`sqlôe4GëVdbe
(
P¨£
*);

2854 
	`sqlôe4CodeVîifySchema
(
P¨£
*, );

2855 
	`sqlôe4CodeVîifyNamedSchema
(
P¨£
*, c⁄° *
zDb
);

2856 
	`sqlôe4BegöTønß˘i⁄
(
P¨£
*, );

2857 
	`sqlôe4EndTønß˘i⁄
(
P¨£
 *, );

2858 
	`sqlôe4Savïoöt
(
P¨£
*, , 
Tokí
*);

2859 
	`sqlôe4Clo£Savïoöts
(
sqlôe4
 *);

2860 
	`sqlôe4Ex¥IsC⁄°™t
(
Ex¥
*);

2861 
	`sqlôe4Ex¥IsC⁄°™tNŸJoö
(
Ex¥
*);

2862 
	`sqlôe4Ex¥IsC⁄°™tOrFun˘i⁄
(
Ex¥
*);

2863 
	`sqlôe4Ex¥IsI¡egî
(
Ex¥
*, *);

2864 
	`sqlôe4Ex¥C™BeNuŒ
(c⁄° 
Ex¥
*);

2865 
	`sqlôe4Ex¥CodeIsNuŒJump
(
Vdbe
*, c⁄° 
Ex¥
*, , );

2866 
	`sqlôe4Ex¥NìdsNoAfföôyCh™ge
(c⁄° 
Ex¥
*, );

2867 
	`sqlôe4Gíî©eRowDñëe
(
P¨£
*, 
TabÀ
*, , , , 
Triggî
 *, );

2868 
	`sqlôe4Gíî©eRowIndexDñëe
(
P¨£
*, 
TabÀ
*, , , *);

2869 
	`sqlôe4EncodeIndexKey
(
P¨£
 *, 
Index
 *, , Index *, , , );

2870 
	`sqlôe4EncodeIndexVÆue
(
P¨£
*, , 
Index
*, );

2871 
	`sqlôe4Gíî©eC⁄°øötChecks
(
P¨£
*,
TabÀ
*,,,

2873 
	`sqlôe4Com∂ëeIn£πi⁄
(
P¨£
*, 
TabÀ
*, , , *, , , );

2874 
	`sqlôe4O≥nTabÀAndIndi˚s
(
P¨£
*, 
TabÀ
*, , );

2875 
	`sqlôe4BegöWrôeO≥øti⁄
(
P¨£
*, , );

2876 
	`sqlôe4Mu…iWrôe
(
P¨£
*);

2877 
	`sqlôe4MayAb‹t
(
P¨£
*);

2878 
	`sqlôe4HÆtC⁄°øöt
(
P¨£
*, , *, );

2879 
Ex¥
 *
	`sqlôe4Ex¥Dup
(
sqlôe4
*,Expr*,);

2880 
Ex¥Li°
 *
	`sqlôe4Ex¥Li°Dup
(
sqlôe4
*,ExprList*,);

2881 
SrcLi°
 *
	`sqlôe4SrcLi°Dup
(
sqlôe4
*,SrcList*,);

2882 
IdLi°
 *
	`sqlôe4IdLi°Dup
(
sqlôe4
*,IdList*);

2883 
Sñe˘
 *
	`sqlôe4Sñe˘Dup
(
sqlôe4
*,Select*,);

2884 
	`sqlôe4FuncDefIn£π
(
FuncDefTabÀ
*, 
FuncDef
*, );

2885 
FuncDef
 *
	`sqlôe4FödFun˘i⁄
(
sqlôe4
*,const *,,,);

2886 
	`sqlôe4Regi°îBuûtöFun˘i⁄s
(
sqlôe4
*);

2887 
	`sqlôe4Regi°îD©eTimeFun˘i⁄s
(
sqlôe4_ív
*);

2888 
	`sqlôe4Regi°îGlobÆFun˘i⁄s
(
sqlôe4_ív
*);

2889 
	`sqlôe4Sa„tyCheckOk
(
sqlôe4
*);

2890 
	`sqlôe4Sa„tyCheckSickOrOk
(
sqlôe4
*);

2891 
	`sqlôe4Ch™geCookõ
(
P¨£
*, );

2893 #i‡!
	`deföed
(
SQLITE4_OMIT_VIEW
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

2894 
	`sqlôe4M©îülizeVõw
(
P¨£
*, 
TabÀ
*, 
Ex¥
*, );

2896 
	#sqlôe4M©îülizeVõw
(
w
,
x
,
y
,
z
)

	)

2899 #i‚de‡
SQLITE4_OMIT_TRIGGER


2900 
	`sqlôe4BegöTriggî
(
P¨£
*, 
Tokí
*,Tokí*,,,
IdLi°
*,
SrcLi°
*,

2901 
Ex¥
*,, );

2902 
	`sqlôe4FöishTriggî
(
P¨£
*, 
TriggîSãp
*, 
Tokí
*);

2903 
	`sqlôe4Dr›Triggî
(
P¨£
*, 
SrcLi°
*, );

2904 
	`sqlôe4Dr›TriggîPå
(
P¨£
*, 
Triggî
*);

2905 
Triggî
 *
	`sqlôe4TriggîsExi°
(
P¨£
 *, 
TabÀ
*, , 
Ex¥Li°
*, *
pMask
);

2906 
Triggî
 *
	`sqlôe4TriggîLi°
(
P¨£
 *, 
TabÀ
 *);

2907 
	`sqlôe4CodeRowTriggî
(
P¨£
*, 
Triggî
 *, , 
Ex¥Li°
*, , 
TabÀ
 *,

2909 
	`sqlôe4CodeRowTriggîDúe˘
(
P¨£
 *, 
Triggî
 *, 
TabÀ
 *, , , );

2910 
	`sqlôeVõwTriggîs
(
P¨£
*, 
TabÀ
*, 
Ex¥
*, , 
Ex¥Li°
*);

2911 
	`sqlôe4DñëeTriggîSãp
(
sqlôe4
*, 
TriggîSãp
*);

2912 
TriggîSãp
 *
	`sqlôe4TriggîSñe˘Sãp
(
sqlôe4
*,
Sñe˘
*);

2913 
TriggîSãp
 *
	`sqlôe4TriggîIn£πSãp
(
sqlôe4
*,
Tokí
*, 
IdLi°
*,

2914 
Ex¥Li°
*,
Sñe˘
*,
u8
);

2915 
TriggîSãp
 *
	`sqlôe4TriggîUpd©eSãp
(
sqlôe4
*,
Tokí
*,
Ex¥Li°
*, 
Ex¥
*, 
u8
);

2916 
TriggîSãp
 *
	`sqlôe4TriggîDñëeSãp
(
sqlôe4
*,
Tokí
*, 
Ex¥
*);

2917 
	`sqlôe4DñëeTriggî
(
sqlôe4
*, 
Triggî
*);

2918 
	`sqlôe4U∆ökAndDñëeTriggî
(
sqlôe4
*,,const *);

2919 
u32
 
	`sqlôe4TriggîCﬁmask
(
P¨£
*,
Triggî
*,
Ex¥Li°
*,,,
TabÀ
*,);

2920 
	#sqlôe4P¨£T›Àvñ
(
p
Ë(’)->
pT›Àvñ
 ? (p)->pT›Àvñ : (p))

	)

2922 
	#sqlôe4TriggîsExi°
(
B
,
C
,
D
,
E
,
F
Ë0

	)

2923 
	#sqlôe4DñëeTriggî
(
A
,
B
)

	)

2924 
	#sqlôe4Dr›TriggîPå
(
A
,
B
)

	)

2925 
	#sqlôe4U∆ökAndDñëeTriggî
(
A
,
B
,
C
)

	)

2926 
	#sqlôe4CodeRowTriggî
(
A
,
B
,
C
,
D
,
E
,
F
,
G
,
H
,
I
)

	)

2927 
	#sqlôe4CodeRowTriggîDúe˘
(
A
,
B
,
C
,
D
,
E
,
F
)

	)

2928 
	#sqlôe4TriggîLi°
(
X
, 
Y
Ë0

	)

2929 
	#sqlôe4P¨£T›Àvñ
(
p
Ë
	)
p

2930 
	#sqlôe4TriggîCﬁmask
(
A
,
B
,
C
,
D
,
E
,
F
,
G
Ë0

	)

2933 
	`sqlôe4JoöTy≥
(
P¨£
*, 
Tokí
*, Token*, Token*);

2934 
	`sqlôe4Cª©eF‹eignKey
(
P¨£
*, 
Ex¥Li°
*, 
Tokí
*, ExprList*, );

2935 
	`sqlôe4De„rF‹eignKey
(
P¨£
*, );

2936 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


2937 
	`sqlôe4AuthRód
(
P¨£
*,
Ex¥
*,
Schema
*,
SrcLi°
*);

2938 
	`sqlôe4AuthCheck
(
P¨£
*,, const *, const *, const *);

2939 
	`sqlôe4AuthC⁄ãxtPush
(
P¨£
*, 
AuthC⁄ãxt
*, const *);

2940 
	`sqlôe4AuthC⁄ãxtP›
(
AuthC⁄ãxt
*);

2941 
	`sqlôe4AuthRódCﬁ
(
P¨£
*, const *, const *, );

2942 
	`sqlôe4AuthFªeAŒ
(
sqlôe4
 *
db
);

2944 
	#sqlôe4AuthRód
(
a
,
b
,
c
,
d
)

	)

2945 
	#sqlôe4AuthCheck
(
a
,
b
,
c
,
d
,
e
Ë
SQLITE4_OK


	)

2946 
	#sqlôe4AuthC⁄ãxtPush
(
a
,
b
,
c
)

	)

2947 
	#sqlôe4AuthC⁄ãxtP›
(
a
Ë(()◊))

	)

2948 
	#sqlôe4AuthFªeAŒ
(
a
)

	)

2950 
	`sqlôe4Aâach
(
P¨£
*, 
Ex¥
*, Expr*, Expr*);

2951 
	`sqlôe4Dëach
(
P¨£
*, 
Ex¥
*);

2952 
	`sqlôe4FixInô
(
DbFixî
*, 
P¨£
*, , c⁄° *, c⁄° 
Tokí
*);

2953 
	`sqlôe4FixSrcLi°
(
DbFixî
*, 
SrcLi°
*);

2954 
	`sqlôe4FixSñe˘
(
DbFixî
*, 
Sñe˘
*);

2955 
	`sqlôe4FixEx¥
(
DbFixî
*, 
Ex¥
*);

2956 
	`sqlôe4FixEx¥Li°
(
DbFixî
*, 
Ex¥Li°
*);

2957 
	`sqlôe4FixTriggîSãp
(
DbFixî
*, 
TriggîSãp
*);

2958 
	`sqlôe4GëI¡32
(const *, *);

2959 
	`sqlôe4Atoi
(const *);

2960 
	`sqlôe4Utf16ByãLí
(c⁄° *
pD©a
, 
nCh¨
);

2961 
	`sqlôe4Utf8Ch¨Lí
(c⁄° *
pD©a
, 
nByã
);

2962 
u32
 
	`sqlôe4Utf8Ród
(const *, const **);

2971 
	`sqlôe4PutV¨öt
(*, 
u64
);

2972 
	`sqlôe4PutV¨öt32
(*, 
u32
);

2973 
u8
 
	`sqlôe4GëV¨öt
(c⁄° *, 
u64
 *);

2974 
	`sqlôe4GëV¨öt32
(c⁄° *, 
u32
 *);

2975 
	`sqlôe4V¨ötLí
(
u64
 
v
);

2976 
	`sqlôe4GëV¨öt64
(c⁄° *, , 
sqlôe4_uöt64
 *
pResu…
);

2977 
	`sqlôe4PutV¨öt64
(*, 
sqlôe4_uöt64
);

2996 
	#gëV¨öt32
(
A
,
B
) \

2997 (
u8
)((*(
A
)<(u8)0x80)?((
B
)=(
u32
)*(A)),1:
	`sqlôe4GëV¨öt32
((A),(u32 *)&(B)))

	)

2998 
	#putV¨öt32
(
A
,
B
) \

2999 (
u8
)(((
u32
)(
B
)<(u32)0x80)?(*(
A
)=()(B)),1\

3000 :
	`sqlôe4PutV¨öt32
((
A
),(
B
)))

	)

3001 
	#gëV¨öt
 
sqlôe4GëV¨öt


	)

3002 
	#putV¨öt
 
sqlôe4PutV¨öt


	)

3005 c⁄° *
	`sqlôe4IndexAfföôySå
(
Vdbe
 *, 
Index
 *);

3006 
	`sqlôe4TabÀAfföôySå
(
Vdbe
 *, 
TabÀ
 *);

3007 
	`sqlôe4Com∑ªAfföôy
(
Ex¥
 *
pEx¥
, 
aff2
);

3008 
	`sqlôe4IndexAfföôyOk
(
Ex¥
 *
pEx¥
, 
idx_afföôy
);

3009 
	`sqlôe4Ex¥Afföôy
(
Ex¥
 *
pEx¥
);

3010 
	`sqlôe4Atoi64
(c⁄° *, 
i64
*, , 
u8
);

3011 
	`sqlôe4Eº‹
(
sqlôe4
*, , const *,...);

3012 *
	`sqlôe4HexToBlob
(
sqlôe4
*, c⁄° *
z
, 
n
);

3013 
u8
 
	`sqlôe4HexToI¡
(
h
);

3014 
	`sqlôe4TwoP¨tName
(
P¨£
 *, 
Tokí
 *, Token *, Token **);

3015 c⁄° *
	`sqlôe4EºSå
();

3016 
	`sqlôe4RódSchema
(
P¨£
 *
pP¨£
);

3017 
CﬁlSeq
 *
	`sqlôe4FödCﬁlSeq
(
sqlôe4
*,const *,);

3018 
CﬁlSeq
 *
	`sqlôe4LoˇãCﬁlSeq
(
P¨£
 *
pP¨£
, c⁄° *
zName
);

3019 
CﬁlSeq
 *
	`sqlôe4Ex¥CﬁlSeq
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
);

3020 
Ex¥
 *
	`sqlôe4Ex¥SëCﬁl
(Ex¥*, 
CﬁlSeq
*);

3021 
Ex¥
 *
	`sqlôe4Ex¥SëCﬁlByTokí
(
P¨£
 *
pP¨£
, Ex¥*, 
Tokí
*);

3022 
	`sqlôe4CheckCﬁlSeq
(
P¨£
 *, 
CﬁlSeq
 *);

3023 
	`sqlôe4CheckObje˘Name
(
P¨£
 *, const *);

3024 
	`sqlôe4VdbeSëCh™ges
(
sqlôe4
 *, );

3025 
	`sqlôe4AddI¡64
(
i64
*,i64);

3026 
	`sqlôe4SubI¡64
(
i64
*,i64);

3027 
	`sqlôe4MulI¡64
(
i64
*,i64);

3028 
	`sqlôe4AbsI¡32
();

3029 #ifde‡
SQLITE4_ENABLE_8_3_NAMES


3030 
	`sqlôe4FûeSuffix3
(const *, *);

3032 
	#sqlôe4FûeSuffix3
(
X
,
Y
)

	)

3034 
u8
 
	`sqlôe4GëBoﬁón
(c⁄° *
z
);

3036 c⁄° *
	`sqlôe4VÆueText
(
sqlôe4_vÆue
*, 
u8
);

3037 
	`sqlôe4VÆueByãs
(
sqlôe4_vÆue
*, 
u8
);

3038 
	`sqlôe4VÆueSëSå
(
sqlôe4_vÆue
*, , c⁄° *,
u8
,

3040 
	`sqlôe4VÆueFªe
(
sqlôe4_vÆue
*);

3041 
sqlôe4_vÆue
 *
	`sqlôe4VÆueNew
(
sqlôe4
 *);

3042 *
	`sqlôe4Utf16to8
(
sqlôe4
 *, c⁄° *, , 
u8
);

3043 #ifde‡
SQLITE4_ENABLE_STAT3


3044 *
	`sqlôe4Utf8to16
(
sqlôe4
 *, 
u8
, *, , *);

3046 
	`sqlôe4VÆueFromEx¥
(
sqlôe4
 *, 
Ex¥
 *, 
u8
, u8, 
sqlôe4_vÆue
 **);

3047 
	`sqlôe4VÆueAµlyAfföôy
(
sqlôe4_vÆue
 *, 
u8
, u8);

3048 #i‚de‡
SQLITE4_AMALGAMATION


3049 c⁄° 
sqlôe4OpcodePr›îty
[];

3050 c⁄° 
sqlôe4UµîToLowî
[];

3051 c⁄° 
sqlôe4Cty≥M≠
[];

3052 c⁄° 
Tokí
 
sqlôe4I¡Tokís
[];

3053 
sqlôe4_ív
 
sqlôe4DeÁu…Env
;

3054 
KVFa˘‹y
 
sqlôe4BuûtöFa˘‹y
;

3056 
	`sqlôe4Reödex
(
P¨£
*, 
Tokí
*, Token*);

3057 
	`sqlôe4A…îFun˘i⁄s
(
sqlôe4_ív
*);

3058 
	`sqlôe4A…îRíameTabÀ
(
P¨£
*, 
SrcLi°
*, 
Tokí
*);

3059 
	`sqlôe4GëTokí
(const *, *);

3060 
	`sqlôe4Ne°edP¨£
(
P¨£
*, const *, ...);

3061 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
sqlôe4
*);

3062 
	`sqlôe4CodeSub£À˘
(
P¨£
 *, 
Ex¥
 *, );

3063 
	`sqlôe4Sñe˘Pªp
(
P¨£
*, 
Sñe˘
*, 
NameC⁄ãxt
*);

3064 
	`sqlôe4ResﬁveEx¥Names
(
NameC⁄ãxt
*, 
Ex¥
*);

3065 
	`sqlôe4ResﬁveSñe˘Names
(
P¨£
*, 
Sñe˘
*, 
NameC⁄ãxt
*);

3066 
	`sqlôe4ResﬁveOrdîGroupBy
(
P¨£
*, 
Sñe˘
*, 
Ex¥Li°
*, const *);

3067 
	`sqlôe4CﬁumnDeÁu…
(
Vdbe
 *, 
TabÀ
 *, , );

3068 
	`sqlôe4A…îFöishAddCﬁumn
(
P¨£
 *, 
Tokí
 *);

3069 
	`sqlôe4A…îBegöAddCﬁumn
(
P¨£
 *, 
SrcLi°
 *);

3070 
CﬁlSeq
 *
	`sqlôe4GëCﬁlSeq
(
sqlôe4
*, CollSeq *, const *);

3071 
	`sqlôe4AfföôyTy≥
(const *);

3072 
	`sqlôe4A«lyze
(
P¨£
*, 
Tokí
*, Token*);

3073 
	`sqlôe4FödDb
(
sqlôe4
*, 
Tokí
*);

3074 
	`sqlôe4FödDbName
(
sqlôe4
 *, const *);

3075 
	`sqlôe4A«lysisLﬂd
(
sqlôe4
*,
iDB
);

3076 
	`sqlôe4DñëeIndexSam∂es
(
sqlôe4
*,
Index
*);

3077 
	`sqlôe4DeÁu…RowE°
(
Index
*);

3078 
	`sqlôe4Regi°îLikeFun˘i⁄s
(
sqlôe4
*, );

3079 
	`sqlôe4IsLikeFun˘i⁄
(
sqlôe4
*,
Ex¥
*,*,*);

3080 
	`sqlôe4SchemaCÀ¨
(
sqlôe4_ív
*,
Schema
*);

3081 
Schema
 *
	`sqlôe4SchemaGë
(
sqlôe4
*);

3082 
	`sqlôe4SchemaToIndex
(
sqlôe4
 *
db
, 
Schema
 *);

3083 
KeyInfo
 *
	`sqlôe4IndexKeyöfo
(
P¨£
 *, 
Index
 *);

3084 
	`sqlôe4Cª©eFunc
(
sqlôe4
 *, const *, , *,

3085 (*)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **),

3086 (*)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **), (*)(sqlite4_context*),

3089 
	`sqlôe4ApiExô
(
sqlôe4
 *
db
, );

3090 
	`sqlôe4O≥nTempD©aba£
(
P¨£
 *);

3092 
	`sqlôe4SåAccumInô
(
SåAccum
*, *, , );

3093 
	`sqlôe4SåAccumAµíd
(
SåAccum
*,const *,);

3094 
	`sqlôe4AµídS∑˚
(
SåAccum
*,);

3095 *
	`sqlôe4SåAccumFöish
(
SåAccum
*);

3096 
	`sqlôe4SåAccumRe£t
(
SåAccum
*);

3097 
	`sqlôe4Sñe˘De°Inô
(
Sñe˘De°
*,,);

3098 
Ex¥
 *
	`sqlôe4Cª©eCﬁumnEx¥
(
sqlôe4
 *, 
SrcLi°
 *, , );

3100 
	`sqlôe4O≥nPrim¨yKey
(
P¨£
*, 
iCur
, 
iDb
, 
TabÀ
*, );

3101 
	`sqlôe4O≥nIndex
(
P¨£
*, 
iCur
, 
iDb
, 
Index
*, );

3102 
	`sqlôe4O≥nAŒIndexes
(
P¨£
 *, 
TabÀ
 *, , );

3103 
	`sqlôe4Clo£AŒIndexes
(
P¨£
 *, 
TabÀ
 *, );

3104 
Index
 *
	`sqlôe4FödPrim¨yKey
(
TabÀ
 *, *);

3109 *
	`sqlôe4P¨£rAŒoc
(*(*)(*,
size_t
), *);

3110 
	`sqlôe4P¨£rFªe
(*, (*)(*,*));

3111 
	`sqlôe4P¨£r
(*, , 
Tokí
, 
P¨£
*);

3112 #ifde‡
YYTRACKMAXSTACKDEPTH


3113 
	`sqlôe4P¨£rSèckPók
(*);

3116 #ifde‡
SQLITE4_TEST


3117 
	`sqlôe4Utf8To8
(*);

3120 #ifde‡
SQLITE4_OMIT_VIRTUALTABLE


3121 
	#sqlôe4VèbCÀ¨
(
Y
)

	)

3122 
	#sqlôe4VèbSync
(
X
,
Y
Ë
SQLITE4_OK


	)

3123 
	#sqlôe4VèbRﬁlback
(
X
)

	)

3124 
	#sqlôe4VèbCommô
(
X
)

	)

3125 
	#sqlôe4VèbInSync
(
db
Ë0

	)

3126 
	#sqlôe4VèbLock
(
X
)

	)

3127 
	#sqlôe4VèbU∆ock
(
X
)

	)

3128 
	#sqlôe4VèbU∆ockLi°
(
X
)

	)

3129 
	#sqlôe4VèbSavïoöt
(
X
, 
Y
, 
Z
Ë
SQLITE4_OK


	)

3130 
	#sqlôe4GëVTabÀ
(
X
,
Y
Ë((
VTabÀ
*)0)

	)

3132 
	`sqlôe4VèbCÀ¨
(
sqlôe4
 *
db
, 
TabÀ
*);

3133 
	`sqlôe4VèbSync
(
sqlôe4
 *
db
, **);

3134 
	`sqlôe4VèbRﬁlback
(
sqlôe4
 *
db
);

3135 
	`sqlôe4VèbCommô
(
sqlôe4
 *
db
);

3136 
	`sqlôe4VèbLock
(
VTabÀ
 *);

3137 
	`sqlôe4VèbU∆ock
(
VTabÀ
 *);

3138 
	`sqlôe4VèbU∆ockLi°
(
sqlôe4
*);

3139 
	`sqlôe4VèbSavïoöt
(
sqlôe4
 *, , );

3140 
VTabÀ
 *
	`sqlôe4GëVTabÀ
(
sqlôe4
*, 
TabÀ
*);

3141 
	#sqlôe4VèbInSync
(
db
Ë((db)->
nVTøns
>0 && (db)->
aVTøns
==0)

	)

3143 
	`sqlôe4VèbMakeWrôabÀ
(
P¨£
*,
TabÀ
*);

3144 
	`sqlôe4VèbBegöP¨£
(
P¨£
*, 
Tokí
*, Token*, Token*);

3145 
	`sqlôe4VèbFöishP¨£
(
P¨£
*, 
Tokí
*);

3146 
	`sqlôe4VèbArgInô
(
P¨£
*);

3147 
	`sqlôe4VèbArgExãnd
(
P¨£
*, 
Tokí
*);

3148 
	`sqlôe4VèbCÆlCª©e
(
sqlôe4
*, , const *, **);

3149 
	`sqlôe4VèbCÆlC⁄√˘
(
P¨£
*, 
TabÀ
*);

3150 
	`sqlôe4VèbCÆlDe°roy
(
sqlôe4
*, , const *);

3151 
	`sqlôe4VèbBegö
(
sqlôe4
 *, 
VTabÀ
 *);

3152 
FuncDef
 *
	`sqlôe4VèbOvîlﬂdFun˘i⁄
(
sqlôe4
 *,FuncDef*, 
nArg
, 
Ex¥
*);

3153 
	`sqlôe4InvÆidFun˘i⁄
(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
**);

3154 
	`sqlôe4VdbeP¨amëîIndex
(
Vdbe
*, const *, );

3155 
	`sqlôe4Tøns„rBödögs
(
sqlôe4_°mt
 *, sqlite4_stmt *);

3156 
	`sqlôe4Rïª∑ª
(
Vdbe
*);

3157 
	`sqlôe4Ex¥Li°CheckLígth
(
P¨£
*, 
Ex¥Li°
*, const *);

3158 
CﬁlSeq
 *
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
P¨£
 *, 
Ex¥
 *, Expr *);

3167 #i‡!
	`deföed
(
SQLITE4_OMIT_FOREIGN_KEY
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

3168 
	`sqlôe4FkCheck
(
P¨£
*, 
TabÀ
*, , );

3169 
	`sqlôe4FkDr›TabÀ
(
P¨£
*, 
SrcLi°
 *, 
TabÀ
*);

3170 
	`sqlôe4FkA˘i⁄s
(
P¨£
*, 
TabÀ
*, 
Ex¥Li°
*, );

3171 
	`sqlôe4FkRequúed
(
P¨£
*, 
TabÀ
*, *);

3172 
u32
 
	`sqlôe4FkOldmask
(
P¨£
*, 
TabÀ
*);

3173 
FKey
 *
	`sqlôe4FkRe„ªn˚s
(
TabÀ
 *);

3175 
	#sqlôe4FkA˘i⁄s
(
a
,
b
,
c
,
d
)

	)

3176 
	#sqlôe4FkCheck
(
a
,
b
,
c
,
d
)

	)

3177 
	#sqlôe4FkDr›TabÀ
(
a
,
b
,
c
)

	)

3178 
	#sqlôe4FkOldmask
(
a
,
b
Ë0

	)

3179 
	#sqlôe4FkRequúed
(
a
,
b
,
c
Ë0

	)

3181 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


3182 
	`sqlôe4FkDñëe
(
sqlôe4
 *, 
TabÀ
*);

3184 
	#sqlôe4FkDñëe
(
a
,
b
)

	)

3191 
	#SQLITE4_FAULTINJECTOR_MALLOC
 0

	)

3192 
	#SQLITE4_FAULTINJECTOR_COUNT
 1

	)

3199 #i‚de‡
SQLITE4_OMIT_BUILTIN_TEST


3200 
	`sqlôe4BegöBíignMÆloc
(
sqlôe4_ív
*);

3201 
	`sqlôe4EndBíignMÆloc
(
sqlôe4_ív
*);

3203 
	#sqlôe4BegöBíignMÆloc
(
X
)

	)

3204 
	#sqlôe4EndBíignMÆloc
(
X
)

	)

3207 
	#IN_INDEX_ROWID
 1

	)

3208 
	#IN_INDEX_EPH
 2

	)

3209 
	#IN_INDEX_INDEX_ASC
 3

	)

3210 
	#IN_INDEX_INDEX_DESC
 4

	)

3211 
	`sqlôe4FödInIndex
(
P¨£
 *, 
Ex¥
 *, *, *);

3212 
Index
 *
	`sqlôe4FödExi°ögInIndex
(
P¨£
 *, 
Ex¥
 *, );

3215 #i‡
SQLITE4_MAX_EXPR_DEPTH
>0

3216 
	`sqlôe4Ex¥SëHeight
(
P¨£
 *
pP¨£
, 
Ex¥
 *
p
);

3217 
	`sqlôe4Sñe˘Ex¥Height
(
Sñe˘
 *);

3218 
	`sqlôe4Ex¥CheckHeight
(
P¨£
*, );

3220 
	#sqlôe4Ex¥SëHeight
(
x
,
y
)

	)

3221 
	#sqlôe4Sñe˘Ex¥Height
(
x
Ë0

	)

3222 
	#sqlôe4Ex¥CheckHeight
(
x
,
y
)

	)

3225 
u32
 
	`sqlôe4Gë4byã
(c⁄° 
u8
*);

3226 
	`sqlôe4Put4byã
(
u8
*, 
u32
);

3228 #ifde‡
SQLITE4_ENABLE_UNLOCK_NOTIFY


3229 
	`sqlôe4C⁄√˘i⁄Blocked
(
sqlôe4
 *, sqlite4 *);

3230 
	`sqlôe4C⁄√˘i⁄U∆ocked
(
sqlôe4
 *
db
);

3231 
	`sqlôe4C⁄√˘i⁄Clo£d
(
sqlôe4
 *
db
);

3233 
	#sqlôe4C⁄√˘i⁄Blocked
(
x
,
y
)

	)

3234 
	#sqlôe4C⁄√˘i⁄U∆ocked
(
x
)

	)

3235 
	#sqlôe4C⁄√˘i⁄Clo£d
(
x
)

	)

3238 #ifde‡
SQLITE4_DEBUG


3239 
	`sqlôe4P¨£rTø˚
(
FILE
*, *);

3247 #ifde‡
SQLITE4_ENABLE_IOTRACE


3248 
	#IOTRACE
(
A
Ëif–
sqlôe4IoTø˚
 ){ sqlôe4IoTø˚ A; 
	}

	)
}

3249 
sqlôe4VdbeIOTø˚Sql
(
Vdbe
*);

3250 
SQLITE4_EXTERN
 (*
sqlôe4IoTø˚
)(const *,...);

3252 
	#IOTRACE
(
A
)

	)

3253 
	#sqlôe4VdbeIOTø˚Sql
(
X
)

	)

3284 #ifde‡
SQLITE4_MEMDEBUG


3285 
	`sqlôe4MemdebugSëTy≥
(*,
u8
);

3286 
	`sqlôe4MemdebugHasTy≥
(c⁄° *,
u8
);

3287 
	`sqlôe4MemdebugNoTy≥
(c⁄° *,
u8
);

3289 
	#sqlôe4MemdebugSëTy≥
(
X
,
Y
Ë

	)

3290 
	#sqlôe4MemdebugHasTy≥
(
X
,
Y
Ë1

	)

3291 
	#sqlôe4MemdebugNoTy≥
(
X
,
Y
Ë1

	)

3293 
	#MEMTYPE_HEAP
 0x01

	)

3294 
	#MEMTYPE_LOOKASIDE
 0x02

	)

3295 
	#MEMTYPE_SCRATCH
 0x04

	)

3296 
	#MEMTYPE_DB
 0x10

	)

3298 
	`sqlôe4InôFts5
(
sqlôe4
 *
db
);

3299 
	`sqlôe4InôFts5Func
(
sqlôe4
 *
db
);

3300 
	`sqlôe4ShutdownFts5
(
sqlôe4
 *
db
);

3301 
	`sqlôe4Cª©eUsögIndex
(
P¨£
*, 
Cª©eIndex
*, 
Ex¥Li°
*, 
Tokí
*, Token*);

3303 
	`sqlôe4Fts5IndexSz
();

3304 
	`sqlôe4Fts5IndexInô
(
P¨£
 *, 
Index
 *, 
Ex¥Li°
 *);

3305 
	`sqlôe4Fts5IndexFªe
(
sqlôe4
 *, 
Index
 *);

3307 
	`sqlôe4Fts5Upd©e
(
sqlôe4
 *, 
Fts5Info
 *, , 
Mem
 *, Mem *, , **);

3308 
	`sqlôe4Fts5FªeInfo
(
sqlôe4
 *
db
, 
Fts5Info
 *);

3309 
	`sqlôe4Fts5CodeUpd©e
(
P¨£
 *, 
Index
 *
pIdx
, , , , );

3310 
	`sqlôe4Fts5CodeCksum
(
P¨£
 *, 
Index
 *, , , );

3311 
	`sqlôe4Fts5CodeQuîy
(
P¨£
 *, 
Index
 *, , , );

3313 
	`sqlôe4Fts5Pk
(
Fts5Curs‹
 *, , 
KVByãAºay
 **, 
KVSize
 *);

3314 
	`sqlôe4Fts5Next
(
Fts5Curs‹
 *
pC§
);

3316 
	`sqlôe4Fts5E¡ryCksum
(
sqlôe4
 *, 
Fts5Info
 *, 
Mem
 *, Mem *, 
i64
 *);

3317 
	`sqlôe4Fts5RowCksum
(
sqlôe4
 *, 
Fts5Info
 *, 
Mem
 *, Mem *, 
i64
 *);

3318 
	`sqlôe4Fts5O≥n
(
sqlôe4
*, 
Fts5Info
*, c⁄° *, , 
Fts5Curs‹
**,**);

3319 
	`sqlôe4Fts5VÆid
(
Fts5Curs‹
 *);

3320 
	`sqlôe4Fts5Clo£
(
Fts5Curs‹
 *);

3324 
	`sqlôe4AtoF
(c⁄° *
z
, *
pResu…
, 
Àngth
, 
u8
 
íc
);

3325 
sqlôe4_vÆue
 *
	`sqlôe4_vÆue_dup
(
sqlôe4_ív
 *
pEnv
, c⁄° sqlôe4_vÆuê*
pOrig
);

3326 
	`sqlôe4_vÆue_byãs
(
sqlôe4_vÆue
 *
pVÆ
);

3327 
	`sqlôe4_vÆue_‰ì
(
sqlôe4_vÆue
 *
pOld
);

3328 c⁄° *
	`sqlôe4CﬁumnTy≥
(c⁄° 
Cﬁumn
 *
pCﬁ
, c⁄° *
zDÊt
);

3329 
	`sqlôe4Regi°îVe˘‹Fun˘i⁄s
(
sqlôe4_ív
 *
pEnv
);

3330 
	`sqlôe4_ªsu…_zîoblob64
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
u64
 
n
);

3331 
	`sqlôe4_ªsu…_zîoblob
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
n
);

3332 
	`sqlôe4_ªsu…_vÆue
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
sqlôe4_vÆue
 *
pVÆue
);

3335 
	#IsVe˘‹Index
(
X
Ë((X)->
idxIsVe˘‹
==1)

	)

3340 
	#XN_ROWID
 (-1Ë

	)

3341 
	#XN_EXPR
 (-2Ë

	)

3360 
	#TF_HasHiddí
 0x00000002

	)

3361 
	#TF_HasVútuÆ
 0x00000020

	)

3362 
	#TF_HasSt‹ed
 0x00000040

	)

3363 
	#TF_HasGíî©ed
 0x00000060

	)

3364 
	#TF_WôhoutRowid
 0x00000080

	)

3365 
	#TF_SètsU£d
 0x00000100

	)

3367 
	#TF_NoVisibÀRowid
 0x00000200

	)

3368 
	#TF_OOOHiddí
 0x00000400

	)

3369 
	#TF_HasNŸNuŒ
 0x00000800

	)

3370 
	#TF_Shadow
 0x00001000

	)

3371 
	#TF_HasSèt4
 0x00002000

	)

3372 
	#TF_Ep⁄ymous
 0x00008000

	)

3373 
	#TF_Såi˘
 0x00010000

	)

3376 
	#HasRowid
(
X
Ë(((X)->
èbFœgs
 & 
TF_WôhoutRowid
)==0)

	)

3377 
	#VisibÀRowid
(
X
Ë(((X)->
èbFœgs
 & 
TF_NoVisibÀRowid
)==0)

	)

3393 
	#SQLITE4_CHECKPOINT_PASSIVE
 0

	)

3394 
	#SQLITE4_CHECKPOINT_FULL
 1

	)

3395 
	#SQLITE4_CHECKPOINT_RESTART
 2

	)

3396 
	#SQLITE4_CHECKPOINT_TRUNCATE
 3

	@src/sqliteLimit.h

23 #i‚de‡
SQLITE4_MAX_LENGTH


24 
	#SQLITE4_MAX_LENGTH
 1000000000

	)

44 #i‚de‡
SQLITE4_MAX_COLUMN


45 
	#SQLITE4_MAX_COLUMN
 2000

	)

55 #i‚de‡
SQLITE4_MAX_SQL_LENGTH


56 
	#SQLITE4_MAX_SQL_LENGTH
 1000000000

	)

69 #i‚de‡
SQLITE4_MAX_EXPR_DEPTH


70 
	#SQLITE4_MAX_EXPR_DEPTH
 1000

	)

81 #i‚de‡
SQLITE4_MAX_COMPOUND_SELECT


82 
	#SQLITE4_MAX_COMPOUND_SELECT
 500

	)

89 #i‚de‡
SQLITE4_MAX_VDBE_OP


90 
	#SQLITE4_MAX_VDBE_OP
 25000

	)

96 #i‚de‡
SQLITE4_MAX_FUNCTION_ARG


97 
	#SQLITE4_MAX_FUNCTION_ARG
 127

	)

104 #i‚de‡
SQLITE4_DEFAULT_CACHE_SIZE


105 
	#SQLITE4_DEFAULT_CACHE_SIZE
 2000

	)

107 #i‚de‡
SQLITE4_DEFAULT_TEMP_CACHE_SIZE


108 
	#SQLITE4_DEFAULT_TEMP_CACHE_SIZE
 500

	)

115 #i‚de‡
SQLITE4_DEFAULT_WAL_AUTOCHECKPOINT


116 
	#SQLITE4_DEFAULT_WAL_AUTOCHECKPOINT
 1000

	)

124 #i‚de‡
SQLITE4_MAX_ATTACHED


125 
	#SQLITE4_MAX_ATTACHED
 10

	)

132 #i‚de‡
SQLITE4_MAX_VARIABLE_NUMBER


133 
	#SQLITE4_MAX_VARIABLE_NUMBER
 999

	)

147 #ifde‡
SQLITE4_MAX_PAGE_SIZE


148 #unde‡
SQLITE4_MAX_PAGE_SIZE


150 
	#SQLITE4_MAX_PAGE_SIZE
 65536

	)

156 #i‚de‡
SQLITE4_DEFAULT_PAGE_SIZE


157 
	#SQLITE4_DEFAULT_PAGE_SIZE
 1024

	)

159 #i‡
SQLITE4_DEFAULT_PAGE_SIZE
>
SQLITE4_MAX_PAGE_SIZE


160 #unde‡
SQLITE4_DEFAULT_PAGE_SIZE


161 
	#SQLITE4_DEFAULT_PAGE_SIZE
 
SQLITE4_MAX_PAGE_SIZE


	)

171 #i‚de‡
SQLITE4_MAX_DEFAULT_PAGE_SIZE


172 
	#SQLITE4_MAX_DEFAULT_PAGE_SIZE
 8192

	)

174 #i‡
SQLITE4_MAX_DEFAULT_PAGE_SIZE
>
SQLITE4_MAX_PAGE_SIZE


175 #unde‡
SQLITE4_MAX_DEFAULT_PAGE_SIZE


176 
	#SQLITE4_MAX_DEFAULT_PAGE_SIZE
 
SQLITE4_MAX_PAGE_SIZE


	)

187 #i‚de‡
SQLITE4_MAX_PAGE_COUNT


188 
	#SQLITE4_MAX_PAGE_COUNT
 1073741823

	)

195 #i‚de‡
SQLITE4_MAX_LIKE_PATTERN_LENGTH


196 
	#SQLITE4_MAX_LIKE_PATTERN_LENGTH
 50000

	)

206 #i‚de‡
SQLITE4_MAX_TRIGGER_DEPTH


207 
	#SQLITE4_MAX_TRIGGER_DEPTH
 1000

	)

	@src/status.c

16 
	~"sqlôeI¡.h
"

17 
	~"vdbeI¡.h
"

23 
	$sqlôe4SètusAdd
(
sqlôe4_ív
 *
pEnv
, 
›
, 
sqlôe4_öt64
 
N
){

24 
	`as£π
–
›
>=0 && op<
	`AºaySize
(
pEnv
->
nowVÆue
) );

25 
pEnv
->
nowVÆue
[
›
] +
N
;

26 if–
pEnv
->
nowVÆue
[
›
]>pEnv->
mxVÆue
[op] ){

27 
pEnv
->
mxVÆue
[
›
] =ÖEnv->
nowVÆue
[op];

29 
	}
}

34 
	$sqlôe4SètusSë
(
sqlôe4_ív
 *
pEnv
, 
›
, 
sqlôe4_uöt64
 
X
){

35 
	`as£π
–
›
>=0 && op<
	`AºaySize
(
pEnv
->
nowVÆue
) );

36 
pEnv
->
nowVÆue
[
›
] = 
X
;

37 if–
pEnv
->
nowVÆue
[
›
]>pEnv->
mxVÆue
[op] ){

38 
pEnv
->
mxVÆue
[
›
] =ÖEnv->
nowVÆue
[op];

40 
	}
}

49 
	$sqlôe4_ív_°©us
(

50 
sqlôe4_ív
 *
pEnv
,

51 
›
,

52 
sqlôe4_uöt64
 *
pCuºít
,

53 
sqlôe4_uöt64
 *
pHighw©î
,

54 
ª£tFœg


56 if–
pEnv
==0 )ÖEnv = 
	`sqlôe4_ív_deÁu…
();

57 if–
›
<0 || op>=
	`AºaySize
(
pEnv
->
nowVÆue
) ){

58  
SQLITE4_MISUSE_BKPT
;

60 *
pCuºít
 = 
pEnv
->
nowVÆue
[
›
];

61 *
pHighw©î
 = 
pEnv
->
mxVÆue
[
›
];

62 if–
ª£tFœg
 ){

63 
pEnv
->
mxVÆue
[
›
] =ÖEnv->
nowVÆue
[op];

65  
SQLITE4_OK
;

66 
	}
}

71 
	$sqlôe4_db_°©us
(

72 
sqlôe4
 *
db
,

73 
›
,

74 *
pCuºít
,

75 *
pHighw©î
,

76 
ª£tFœg


78 
rc
 = 
SQLITE4_OK
;

79 
sqlôe4_ív
 *
pEnv
;

80 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

81 
pEnv
 = 
db
->pEnv;

82  
›
 ){

83 
SQLITE4_DBSTATUS_LOOKASIDE_USED
: {

84 *
pCuºít
 = 
db
->
lookaside
.
nOut
;

85 *
pHighw©î
 = 
db
->
lookaside
.
mxOut
;

86 if–
ª£tFœg
 ){

87 
db
->
lookaside
.
mxOut
 = db->lookaside.
nOut
;

92 
SQLITE4_DBSTATUS_LOOKASIDE_HIT
:

93 
SQLITE4_DBSTATUS_LOOKASIDE_MISS_SIZE
:

94 
SQLITE4_DBSTATUS_LOOKASIDE_MISS_FULL
: {

95 
	`ã°ˇ£
–
›
==
SQLITE4_DBSTATUS_LOOKASIDE_HIT
 );

96 
	`ã°ˇ£
–
›
==
SQLITE4_DBSTATUS_LOOKASIDE_MISS_SIZE
 );

97 
	`ã°ˇ£
–
›
==
SQLITE4_DBSTATUS_LOOKASIDE_MISS_FULL
 );

98 
	`as£π
–(
›
-
SQLITE4_DBSTATUS_LOOKASIDE_HIT
)>=0 );

99 
	`as£π
–(
›
-
SQLITE4_DBSTATUS_LOOKASIDE_HIT
)<3 );

100 *
pCuºít
 = 0;

101 *
pHighw©î
 = 
db
->
lookaside
.
™Sèt
[
›
 - 
SQLITE4_DBSTATUS_LOOKASIDE_HIT
];

102 if–
ª£tFœg
 ){

103 
db
->
lookaside
.
™Sèt
[
›
 - 
SQLITE4_DBSTATUS_LOOKASIDE_HIT
] = 0;

113 
SQLITE4_DBSTATUS_CACHE_USED
: {

114 
tŸÆU£d
 = 0;

115 *
pCuºít
 = 
tŸÆU£d
;

116 *
pHighw©î
 = 0;

125 
SQLITE4_DBSTATUS_SCHEMA_USED
: {

126 
i
;

127 
nByã
 = 0;

129 
db
->
≤ByãsFªed
 = &
nByã
;

130 
i
=0; i<
db
->
nDb
; i++){

131 
Schema
 *
pSchema
 = 
db
->
aDb
[
i
].pSchema;

132 if–
	`ALWAYS
(
pSchema
!=0) ){

133 
HashEÀm
 *
p
;

135 
nByã
 +(
HashEÀm
) * (

136 
pSchema
->
tblHash
.
cou¡


137 + 
pSchema
->
åigHash
.
cou¡


138 + 
pSchema
->
idxHash
.
cou¡


139 + 
pSchema
->
fkeyHash
.
cou¡


141 
nByã
 +
	`sqlôe4MÆlocSize
(
pEnv
, 
pSchema
->
tblHash
.
ht
);

142 
nByã
 +
	`sqlôe4MÆlocSize
(
pEnv
, 
pSchema
->
åigHash
.
ht
);

143 
nByã
 +
	`sqlôe4MÆlocSize
(
pEnv
, 
pSchema
->
idxHash
.
ht
);

144 
nByã
 +
	`sqlôe4MÆlocSize
(
pEnv
, 
pSchema
->
fkeyHash
.
ht
);

146 
p
=
	`sqlôeHashFú°
(&
pSchema
->
åigHash
);Ö;Ö=
	`sqlôeHashNext
(p)){

147 
	`sqlôe4DñëeTriggî
(
db
, (
Triggî
*)
	`sqlôeHashD©a
(
p
));

149 
p
=
	`sqlôeHashFú°
(&
pSchema
->
tblHash
);Ö;Ö=
	`sqlôeHashNext
(p)){

150 
	`sqlôe4DñëeTabÀ
(
db
, (
TabÀ
 *)
	`sqlôeHashD©a
(
p
));

154 
db
->
≤ByãsFªed
 = 0;

156 *
pHighw©î
 = 0;

157 *
pCuºít
 = 
nByã
;

166 
SQLITE4_DBSTATUS_STMT_USED
: {

167 
Vdbe
 *
pVdbe
;

168 
nByã
 = 0;

170 
db
->
≤ByãsFªed
 = &
nByã
;

171 
pVdbe
=
db
->pVdbe;ÖVdbe;ÖVdbeıVdbe->
pNext
){

172 
	`sqlôe4VdbeDñëeObje˘
(
db
, 
pVdbe
);

174 
db
->
≤ByãsFªed
 = 0;

176 *
pHighw©î
 = 0;

177 *
pCuºít
 = 
nByã
;

187 
SQLITE4_DBSTATUS_CACHE_HIT
:

188 
SQLITE4_DBSTATUS_CACHE_MISS
: {

189 
nRë
 = 0;

190 *
pHighw©î
 = 0;

191 *
pCuºít
 = 
nRë
;

196 
rc
 = 
SQLITE4_ERROR
;

199 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

200  
rc
;

201 
	}
}

	@src/tclsqlite.c

28 
	~"t˛.h
"

29 
	~<î∫o.h
>

35 #i‚de‡
SQLITE4_AMALGAMATION


36 
	~"sqlôe4.h
"

37 
	~<°dlib.h
>

38 
	~<°rög.h
>

39 
	~<as£π.h
>

40 
	tu8
;

42 
	~<˘y≥.h
>

43 
	~<°dlib.h
>

48 #ifde‡
BUILD_sqlôe


49 #unde‡
TCL_STORAGE_CLASS


50 
	#TCL_STORAGE_CLASS
 
DLLEXPORT


	)

53 
	#NUM_PREPARED_STMTS
 10

	)

54 
	#MAX_PREPARED_STMTS
 100

	)

62 #i‡
deföed
(
TCL_UTF_MAX
Ë&& !deföed(
SQLITE4_UTF8
)

63 
	#UTF_TRANSLATION_NEEDED
 1

	)

70 
SqlFunc
 
	tSqlFunc
;

71 
	sSqlFunc
 {

72 
T˛_I¡îp
 *
	möãΩ
;

73 
T˛_Obj
 *
	mpS¸ùt
;

74 
	mu£EvÆObjv
;

75 *
	mzName
;

76 
SqlFunc
 *
	mpNext
;

83 
SqlCﬁœã
 
	tSqlCﬁœã
;

84 
	sSqlCﬁœã
 {

85 
T˛_I¡îp
 *
	möãΩ
;

86 *
	mzCmp
;

87 *
	mzMkkey
;

88 
SqlCﬁœã
 *
	mpNext
;

95 
SqlPª∑ªdStmt
 
	tSqlPª∑ªdStmt
;

96 
	sSqlPª∑ªdStmt
 {

97 
SqlPª∑ªdStmt
 *
	mpNext
;

98 
SqlPª∑ªdStmt
 *
	mpPªv
;

99 
sqlôe4_°mt
 *
	mpStmt
;

100 
	mnSql
;

101 c⁄° *
	mzSql
;

102 
	mnP¨m
;

103 
T˛_Obj
 **
	m≠P¨m
;

110 
SqlôeDb
 
	tSqlôeDb
;

111 
	sSqlôeDb
 {

112 
sqlôe4
 *
	mdb
;

113 
T˛_I¡îp
 *
	möãΩ
;

114 *
	mzTø˚
;

115 *
	mzProfûe
;

116 *
	mzAuth
;

117 
	mdißbÀAuth
;

118 *
	mzNuŒ
;

119 
SqlFunc
 *
	mpFunc
;

120 
SqlCﬁœã
 *
	mpCﬁœã
;

121 
	mrc
;

122 
T˛_Obj
 *
	mpCﬁœãNìded
;

123 
SqlPª∑ªdStmt
 *
	m°mtLi°
;

124 
SqlPª∑ªdStmt
 *
	m°mtLa°
;

125 
	mmaxStmt
;

126 
	mnStmt
;

127 
	mnSãp
, 
	mnS‹t
, 
	mnIndex
;

128 
	mnTønß˘i⁄
;

135 
	$°æí30
(c⁄° *
z
){

136 c⁄° *
z2
 = 
z
;

137  *
z2
 ){ z2++; }

138  0x3ffffff‡& ()(
z2
 - 
z
);

139 
	}
}

155 
	$ß„ToU£EvÆObjv
(
T˛_I¡îp
 *
öãΩ
, 
T˛_Obj
 *
pCmd
){

160 c⁄° *
z
;

161 
n
;

162 
z
 = 
	`T˛_GëSåögFromObj
(
pCmd
, &
n
);

163  
n
-- > 0 ){

164 
c
 = *(
z
++);

165 if–
c
=='$' || c=='[' || c==';' )  0;

168 
	}
}

175 
SqlFunc
 *
	$födSqlFunc
(
SqlôeDb
 *
pDb
, c⁄° *
zName
){

176 
SqlFunc
 *
p
, *
pNew
;

177 
i
;

178 
pNew
 = (
SqlFunc
*)
	`T˛_AŒoc
–(*pNewË+ 
	`°æí30
(
zName
) + 1 );

179 
pNew
->
zName
 = (*)&pNew[1];

180 
i
=0; 
zName
[i]; i++){ 
pNew
->zName[i] = 
	`tﬁowî
(zName[i]); }

181 
pNew
->
zName
[
i
] = 0;

182 
p
=
pDb
->
pFunc
;Ö;Öı->
pNext
){

183 if–
	`°rcmp
(
p
->
zName
, 
pNew
->zName)==0 ){

184 
	`T˛_Fªe
((*)
pNew
);

185  
p
;

188 
pNew
->
öãΩ
 = 
pDb
->interp;

189 
pNew
->
pS¸ùt
 = 0;

190 
pNew
->
pNext
 = 
pDb
->
pFunc
;

191 
pDb
->
pFunc
 = 
pNew
;

192  
pNew
;

193 
	}
}

198 
	$dbFªeStmt
(
SqlPª∑ªdStmt
 *
pStmt
){

199 #ifde‡
SQLITE4_TEST


200 if–
	`sqlôe4_°mt_sql
(
pStmt
->pStmt)==0 ){

201 
	`T˛_Fªe
((*)
pStmt
->
zSql
);

204 
	`sqlôe4_föÆize
(
pStmt
->pStmt);

205 
	`T˛_Fªe
((*)
pStmt
);

206 
	}
}

211 
	$ÊushStmtCache
(
SqlôeDb
 *
pDb
){

212 
SqlPª∑ªdStmt
 *
pPªStmt
;

213 
SqlPª∑ªdStmt
 *
pNext
;

215 
pPªStmt
 = 
pDb
->
°mtLi°
;ÖPªStmt;ÖPªStmt=
pNext
){

216 
pNext
 = 
pPªStmt
->pNext;

217 
	`dbFªeStmt
(
pPªStmt
);

219 
pDb
->
nStmt
 = 0;

220 
pDb
->
°mtLa°
 = 0;

221 
pDb
->
°mtLi°
 = 0;

222 
	}
}

228 
	$DbDñëeCmd
(*
db
){

229 
SqlôeDb
 *
pDb
 = (SqlôeDb*)
db
;

230 
	`ÊushStmtCache
(
pDb
);

231 
	`sqlôe4_˛o£
(
pDb
->
db
, 0);

232  
pDb
->
pFunc
 ){

233 
SqlFunc
 *
pFunc
 = 
pDb
->pFunc;

234 
pDb
->
pFunc
 =ÖFunc->
pNext
;

235 
	`T˛_De¸RefCou¡
(
pFunc
->
pS¸ùt
);

236 
	`T˛_Fªe
((*)
pFunc
);

238  
pDb
->
pCﬁœã
 ){

239 
SqlCﬁœã
 *
pCﬁœã
 = 
pDb
->pCollate;

240 
pDb
->
pCﬁœã
 =ÖCﬁœã->
pNext
;

241 
	`T˛_Fªe
((*)
pCﬁœã
);

243 if–
pDb
->
zTø˚
 ){

244 
	`T˛_Fªe
(
pDb
->
zTø˚
);

246 if–
pDb
->
zProfûe
 ){

247 
	`T˛_Fªe
(
pDb
->
zProfûe
);

249 if–
pDb
->
zAuth
 ){

250 
	`T˛_Fªe
(
pDb
->
zAuth
);

252 if–
pDb
->
zNuŒ
 ){

253 
	`T˛_Fªe
(
pDb
->
zNuŒ
);

255 if–
pDb
->
pCﬁœãNìded
 ){

256 
	`T˛_De¸RefCou¡
(
pDb
->
pCﬁœãNìded
);

258 
	`T˛_Fªe
((*)
pDb
);

259 
	}
}

261 #i‚de‡
SQLITE4_OMIT_TRACE


266 
	$DbTø˚H™dÀr
(*
cd
, c⁄° *
zSql
){

267 
SqlôeDb
 *
pDb
 = (SqlôeDb*)
cd
;

268 
T˛_DSåög
 
°r
;

270 
	`T˛_DSåögInô
(&
°r
);

271 
	`T˛_DSåögAµíd
(&
°r
, 
pDb
->
zTø˚
, -1);

272 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zSql
);

273 
	`T˛_EvÆ
(
pDb
->
öãΩ
, 
	`T˛_DSåögVÆue
(&
°r
));

274 
	`T˛_DSåögFªe
(&
°r
);

275 
	`T˛_Re£tResu…
(
pDb
->
öãΩ
);

276 
	}
}

279 #i‚de‡
SQLITE4_OMIT_TRACE


284 
	$DbProfûeH™dÀr
(*
cd
, c⁄° *
zSql
, 
sqlôe4_uöt64
 
tm
){

285 
SqlôeDb
 *
pDb
 = (SqlôeDb*)
cd
;

286 
T˛_DSåög
 
°r
;

287 
zTm
[100];

289 
	`sqlôe4_¢¥ötf
(
zTm
, (zTm)-1, "%Œd", 
tm
);

290 
	`T˛_DSåögInô
(&
°r
);

291 
	`T˛_DSåögAµíd
(&
°r
, 
pDb
->
zProfûe
, -1);

292 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zSql
);

293 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zTm
);

294 
	`T˛_EvÆ
(
pDb
->
öãΩ
, 
	`T˛_DSåögVÆue
(&
°r
));

295 
	`T˛_DSåögFªe
(&
°r
);

296 
	`T˛_Re£tResu…
(
pDb
->
öãΩ
);

297 
	}
}

300 
	$t˛CﬁœãNìded
(

301 *
pCtx
,

302 
sqlôe4
 *
db
,

303 c⁄° *
zName


305 
SqlôeDb
 *
pDb
 = (SqlôeDb *)
pCtx
;

306 
T˛_Obj
 *
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
pDb
->
pCﬁœãNìded
);

307 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

308 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
zName
, -1));

309 
	`T˛_EvÆObjEx
(
pDb
->
öãΩ
, 
pS¸ùt
, 0);

310 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

311 
	}
}

317 
	$t˛SqlCﬁœã
(

318 *
pCtx
,

319 
sqlôe4_vÆue
 *
p1
,

320 
sqlôe4_vÆue
 *
p2
,

321 *
pRes


323 
n1
;

324 
n2
;

325 c⁄° *
z1
;

326 c⁄° *
z2
;

327 
SqlCﬁœã
 *
p
 = (SqlCﬁœã *)
pCtx
;

328 
T˛_Obj
 *
pCmd
;

329 
rc
;

331 
z1
 = 
	`sqlôe4_vÆue_ãxt
(
p1
, &
n1
);

332 
z2
 = 
	`sqlôe4_vÆue_ãxt
(
p2
, &
n2
);

334 
pCmd
 = 
	`T˛_NewSåögObj
(
p
->
zCmp
, -1);

335 
	`T˛_In¸RefCou¡
(
pCmd
);

336 
	`T˛_Li°ObjAµídEÀmít
(
p
->
öãΩ
, 
pCmd
, 
	`T˛_NewSåögObj
(
z1
, 
n1
));

337 
	`T˛_Li°ObjAµídEÀmít
(
p
->
öãΩ
, 
pCmd
, 
	`T˛_NewSåögObj
(
z2
, 
n2
));

338 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pCmd
, 
TCL_EVAL_DIRECT
);

339 
	`T˛_De¸RefCou¡
(
pCmd
);

340 *
pRes
 = (
	`©oi
(
	`T˛_GëSåögResu…
(
p
->
öãΩ
)));

341  (
rc
==
TCL_OK
 ? 
SQLITE4_OK
 : 
SQLITE4_ERROR
);

342 
	}
}

344 
	$t˛SqlMkkey
(

345 *
pCtx
,

346 
sqlôe4_vÆue
 *
pVÆ
,

347 
nOut
,

348 *
pOut
,

349 *
≤Out


351 
nIn
;

352 
rc
;

353 c⁄° *
zIn
;

354 
SqlCﬁœã
 *
p
 = (SqlCﬁœã *)
pCtx
;

355 
T˛_Obj
 *
pCmd
;

356 
nRes
;

357 *
zRes
;

359 
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
pVÆ
, &
nIn
);

361 
pCmd
 = 
	`T˛_NewSåögObj
(
p
->
zMkkey
, -1);

362 
	`T˛_In¸RefCou¡
(
pCmd
);

363 
	`T˛_Li°ObjAµídEÀmít
(
p
->
öãΩ
, 
pCmd
, 
	`T˛_NewSåögObj
(
zIn
, 
nIn
));

364 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pCmd
, 
TCL_EVAL_DIRECT
);

365 
	`T˛_De¸RefCou¡
(
pCmd
);

367 
zRes
 = 
	`T˛_GëSåögFromObj
(
	`T˛_GëObjResu…
(
p
->
öãΩ
), &
nRes
);

368 if–
nRes
<=
nOut
 ){

369 
	`mem˝y
(
pOut
, 
zRes
, 
nRes
);

371 *
≤Out
 = 
nRes
;

373  
rc
;

374 
	}
}

380 
	$t˛SqlFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
**
¨gv
){

381 
SqlFunc
 *
p
 = 
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
);

382 
T˛_Obj
 *
pCmd
;

383 
i
;

384 
rc
;

386 if–
¨gc
==0 ){

391 
pCmd
 = 
p
->
pS¸ùt
;

392 
	`T˛_In¸RefCou¡
(
pCmd
);

393 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pCmd
, 0);

394 
	`T˛_De¸RefCou¡
(
pCmd
);

405 
T˛_Obj
 **
aArg
;

406 
nArg
;

407 if–
	`T˛_Li°ObjGëEÀmíts
(
p
->
öãΩ
,Ö->
pS¸ùt
, &
nArg
, &
aArg
) ){

408 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
	`T˛_GëSåögResu…
(
p
->
öãΩ
), -1);

411 
pCmd
 = 
	`T˛_NewLi°Obj
(
nArg
, 
aArg
);

412 
	`T˛_In¸RefCou¡
(
pCmd
);

413 
i
=0; i<
¨gc
; i++){

414 
sqlôe4_vÆue
 *
pIn
 = 
¨gv
[
i
];

415 
T˛_Obj
 *
pVÆ
;

418  
	`sqlôe4_vÆue_ty≥
(
pIn
) ){

419 
SQLITE4_BLOB
: {

420 
nBlob
;

421 c⁄° *
pBlob
 = 
	`sqlôe4_vÆue_blob
(
pIn
, &
nBlob
);

422 
pVÆ
 = 
	`T˛_NewByãAºayObj
(
pBlob
, 
nBlob
);

425 
SQLITE4_INTEGER
: {

426 
sqlôe4_öt64
 
v
 = 
	`sqlôe4_vÆue_öt64
(
pIn
);

427 if–
v
>=-2147483647 && v<=2147483647 ){

428 
pVÆ
 = 
	`T˛_NewI¡Obj
(()
v
);

430 
pVÆ
 = 
	`T˛_NewWideI¡Obj
(
v
);

434 
SQLITE4_FLOAT
: {

435 
r
 = 
	`sqlôe4_vÆue_doubÀ
(
pIn
);

436 
pVÆ
 = 
	`T˛_NewDoubÀObj
(
r
);

439 
SQLITE4_NULL
: {

440 
pVÆ
 = 
	`T˛_NewSåögObj
("", 0);

444 
nText
;

445 c⁄° *
zText
 = 
	`sqlôe4_vÆue_ãxt
(
pIn
, &
nText
);

446 
pVÆ
 = 
	`T˛_NewSåögObj
(
zText
, 
nText
);

450 
rc
 = 
	`T˛_Li°ObjAµídEÀmít
(
p
->
öãΩ
, 
pCmd
, 
pVÆ
);

451 if–
rc
 ){

452 
	`T˛_De¸RefCou¡
(
pCmd
);

453 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
	`T˛_GëSåögResu…
(
p
->
öãΩ
), -1);

457 if–!
p
->
u£EvÆObjv
 ){

461 
	`T˛_GëSåög
(
pCmd
);

463 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pCmd
, 
TCL_EVAL_DIRECT
);

464 
	`T˛_De¸RefCou¡
(
pCmd
);

467 if–
rc
 &&Ñc!=
TCL_RETURN
 ){

468 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
	`T˛_GëSåögResu…
(
p
->
öãΩ
), -1);

470 
T˛_Obj
 *
pV¨
 = 
	`T˛_GëObjResu…
(
p
->
öãΩ
);

471 
n
;

472 
u8
 *
d©a
;

473 c⁄° *
zTy≥
 = (
pV¨
->
ty≥På
 ?ÖV¨->ty≥På->
«me
 : "");

474 
c
 = 
zTy≥
[0];

475 if–
c
=='b' && 
	`°rcmp
(
zTy≥
,"byã¨øy")==0 && 
pV¨
->
byãs
==0 ){

478 
d©a
 = 
	`T˛_GëByãAºayFromObj
(
pV¨
, &
n
);

479 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, 
d©a
, 
n
, 
SQLITE4_TRANSIENT
, 0);

480 }if–
c
=='b' && 
	`°rcmp
(
zTy≥
,"boolean")==0 ){

481 
	`T˛_GëI¡FromObj
(0, 
pV¨
, &
n
);

482 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
n
);

483 }if–
c
=='d' && 
	`°rcmp
(
zTy≥
,"double")==0 ){

484 
r
;

485 
	`T˛_GëDoubÀFromObj
(0, 
pV¨
, &
r
);

486 
	`sqlôe4_ªsu…_doubÀ
(
c⁄ãxt
, 
r
);

487 }if–(
c
=='w' && 
	`°rcmp
(
zTy≥
,"wideInt")==0) ||

488 (
c
=='i' && 
	`°rcmp
(
zTy≥
,"int")==0) ){

489 
T˛_WideI¡
 
v
;

490 
	`T˛_GëWideI¡FromObj
(0, 
pV¨
, &
v
);

491 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
v
);

493 
d©a
 = (*)
	`T˛_GëSåögFromObj
(
pV¨
, &
n
);

494 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, (*)
d©a
, 
n
, 
SQLITE4_TRANSIENT
, 0);

497 
	}
}

499 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


506 
	$auth_ˇŒback
(

507 *
pArg
,

508 
code
,

509 c⁄° *
zArg1
,

510 c⁄° *
zArg2
,

511 c⁄° *
zArg3
,

512 c⁄° *
zArg4


514 *
zCode
;

515 
T˛_DSåög
 
°r
;

516 
rc
;

517 c⁄° *
zRïly
;

518 
SqlôeDb
 *
pDb
 = (SqlôeDb*)
pArg
;

519 if–
pDb
->
dißbÀAuth
 )  
SQLITE4_OK
;

521  
code
 ){

522 
SQLITE4_COPY
 : 
zCode
="SQLITE4_COPY"; ;

523 
SQLITE4_CREATE_INDEX
 : 
zCode
="SQLITE4_CREATE_INDEX"; ;

524 
SQLITE4_CREATE_TABLE
 : 
zCode
="SQLITE4_CREATE_TABLE"; ;

525 
SQLITE4_CREATE_TEMP_INDEX
 : 
zCode
="SQLITE4_CREATE_TEMP_INDEX"; ;

526 
SQLITE4_CREATE_TEMP_TABLE
 : 
zCode
="SQLITE4_CREATE_TEMP_TABLE"; ;

527 
SQLITE4_CREATE_TEMP_TRIGGER
: 
zCode
="SQLITE4_CREATE_TEMP_TRIGGER"; ;

528 
SQLITE4_CREATE_TEMP_VIEW
 : 
zCode
="SQLITE4_CREATE_TEMP_VIEW"; ;

529 
SQLITE4_CREATE_TRIGGER
 : 
zCode
="SQLITE4_CREATE_TRIGGER"; ;

530 
SQLITE4_CREATE_VIEW
 : 
zCode
="SQLITE4_CREATE_VIEW"; ;

531 
SQLITE4_DELETE
 : 
zCode
="SQLITE4_DELETE"; ;

532 
SQLITE4_DROP_INDEX
 : 
zCode
="SQLITE4_DROP_INDEX"; ;

533 
SQLITE4_DROP_TABLE
 : 
zCode
="SQLITE4_DROP_TABLE"; ;

534 
SQLITE4_DROP_TEMP_INDEX
 : 
zCode
="SQLITE4_DROP_TEMP_INDEX"; ;

535 
SQLITE4_DROP_TEMP_TABLE
 : 
zCode
="SQLITE4_DROP_TEMP_TABLE"; ;

536 
SQLITE4_DROP_TEMP_TRIGGER
 : 
zCode
="SQLITE4_DROP_TEMP_TRIGGER"; ;

537 
SQLITE4_DROP_TEMP_VIEW
 : 
zCode
="SQLITE4_DROP_TEMP_VIEW"; ;

538 
SQLITE4_DROP_TRIGGER
 : 
zCode
="SQLITE4_DROP_TRIGGER"; ;

539 
SQLITE4_DROP_VIEW
 : 
zCode
="SQLITE4_DROP_VIEW"; ;

540 
SQLITE4_INSERT
 : 
zCode
="SQLITE4_INSERT"; ;

541 
SQLITE4_PRAGMA
 : 
zCode
="SQLITE4_PRAGMA"; ;

542 
SQLITE4_READ
 : 
zCode
="SQLITE4_READ"; ;

543 
SQLITE4_SELECT
 : 
zCode
="SQLITE4_SELECT"; ;

544 
SQLITE4_TRANSACTION
 : 
zCode
="SQLITE4_TRANSACTION"; ;

545 
SQLITE4_UPDATE
 : 
zCode
="SQLITE4_UPDATE"; ;

546 
SQLITE4_ATTACH
 : 
zCode
="SQLITE4_ATTACH"; ;

547 
SQLITE4_DETACH
 : 
zCode
="SQLITE4_DETACH"; ;

548 
SQLITE4_ALTER_TABLE
 : 
zCode
="SQLITE4_ALTER_TABLE"; ;

549 
SQLITE4_REINDEX
 : 
zCode
="SQLITE4_REINDEX"; ;

550 
SQLITE4_ANALYZE
 : 
zCode
="SQLITE4_ANALYZE"; ;

551 
SQLITE4_CREATE_VTABLE
 : 
zCode
="SQLITE4_CREATE_VTABLE"; ;

552 
SQLITE4_DROP_VTABLE
 : 
zCode
="SQLITE4_DROP_VTABLE"; ;

553 
SQLITE4_FUNCTION
 : 
zCode
="SQLITE4_FUNCTION"; ;

554 
SQLITE4_SAVEPOINT
 : 
zCode
="SQLITE4_SAVEPOINT"; ;

555  : 
zCode
="????"; ;

557 
	`T˛_DSåögInô
(&
°r
);

558 
	`T˛_DSåögAµíd
(&
°r
, 
pDb
->
zAuth
, -1);

559 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zCode
);

560 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zArg1
 ? zArg1 : "");

561 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zArg2
 ? zArg2 : "");

562 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zArg3
 ? zArg3 : "");

563 
	`T˛_DSåögAµídEÀmít
(&
°r
, 
zArg4
 ? zArg4 : "");

564 
rc
 = 
	`T˛_GlobÆEvÆ
(
pDb
->
öãΩ
, 
	`T˛_DSåögVÆue
(&
°r
));

565 
	`T˛_DSåögFªe
(&
°r
);

566 
zRïly
 = 
rc
==
TCL_OK
 ? 
	`T˛_GëSåögResu…
(
pDb
->
öãΩ
) : "SQLITE4_DENY";

567 if–
	`°rcmp
(
zRïly
,"SQLITE4_OK")==0 ){

568 
rc
 = 
SQLITE4_OK
;

569 }if–
	`°rcmp
(
zRïly
,"SQLITE4_DENY")==0 ){

570 
rc
 = 
SQLITE4_DENY
;

571 }if–
	`°rcmp
(
zRïly
,"SQLITE4_IGNORE")==0 ){

572 
rc
 = 
SQLITE4_IGNORE
;

574 
rc
 = 999;

576  
rc
;

577 
	}
}

586 
T˛_Obj
 *
	$dbTextToObj
(c⁄° *
zText
){

587 
T˛_Obj
 *
pVÆ
;

588 #ifde‡
UTF_TRANSLATION_NEEDED


589 
T˛_DSåög
 
dCﬁ
;

590 
	`T˛_DSåögInô
(&
dCﬁ
);

591 
	`T˛_Exã∫ÆToUtfDSåög
(
NULL
, 
zText
, -1, &
dCﬁ
);

592 
pVÆ
 = 
	`T˛_NewSåögObj
(
	`T˛_DSåögVÆue
(&
dCﬁ
), -1);

593 
	`T˛_DSåögFªe
(&
dCﬁ
);

595 
pVÆ
 = 
	`T˛_NewSåögObj
(
zText
, -1);

597  
pVÆ
;

598 
	}
}

611 *
	$loˇl_gëlöe
(*
zProm±
, 
FILE
 *
ö
){

612 *
zLöe
;

613 
nLöe
;

614 
n
;

616 
nLöe
 = 100;

617 
zLöe
 = 
	`mÆloc
–
nLöe
 );

618 if–
zLöe
==0 )  0;

619 
n
 = 0;

621 if–
n
+100>
nLöe
 ){

622 
nLöe
 =ÇLine*2 + 100;

623 
zLöe
 = 
	`ªÆloc
(zLöe, 
nLöe
);

624 if–
zLöe
==0 )  0;

626 if–
	`fgës
(&
zLöe
[
n
], 
nLöe
 -Ç, 
ö
)==0 ){

627 if–
n
==0 ){

628 
	`‰ì
(
zLöe
);

631 
zLöe
[
n
] = 0;

634  
zLöe
[
n
] ){Ç++; }

635 if–
n
>0 && 
zLöe
[n-1]=='\n' ){

636 
n
--;

637 
zLöe
[
n
] = 0;

641 
zLöe
 = 
	`ªÆloc
–zLöe, 
n
+1 );

642  
zLöe
;

643 
	}
}

654 
	$DbTønsPo°Cmd
(

655 
Clõ¡D©a
 
d©a
[],

656 
T˛_I¡îp
 *
öãΩ
,

657 
ªsu…


659 c⁄° *
azEnd
[] = {

665 
SqlôeDb
 *
pDb
 = (SqlôeDb*)
d©a
[0];

666 
rc
 = 
ªsu…
;

667 c⁄° *
zEnd
;

669 
pDb
->
nTønß˘i⁄
--;

670 
zEnd
 = 
azEnd
[(
rc
==
TCL_ERROR
)*2 + (
pDb
->
nTønß˘i⁄
==0)];

672 
pDb
->
dißbÀAuth
++;

673 if–
	`sqlôe4_exec
(
pDb
->
db
, 
zEnd
, 0, 0) ){

684 if–
rc
!=
TCL_ERROR
 ){

685 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4_îrmsg
(
pDb
->
db
), 0);

686 
rc
 = 
TCL_ERROR
;

688 
	`sqlôe4_exec
(
pDb
->
db
, "ROLLBACK", 0, 0);

690 
pDb
->
dißbÀAuth
--;

692  
rc
;

693 
	}
}

710 
	$dbPª∑ªAndBöd
(

711 
SqlôeDb
 *
pDb
,

712 c⁄° *
zIn
,

713 c⁄° **
pzOut
,

714 
SqlPª∑ªdStmt
 **
µPªStmt


716 c⁄° *
zSql
 = 
zIn
;

717 
sqlôe4_°mt
 *
pStmt
;

718 
SqlPª∑ªdStmt
 *
pPªStmt
;

719 
nSql
;

720 
nV¨
;

721 
iP¨m
 = 0;

722 
i
;

723 
T˛_I¡îp
 *
öãΩ
 = 
pDb
->interp;

725 *
µPªStmt
 = 0;

728  
	`is•a˚
(
zSql
[0]) ){ zSql++; }

729 
nSql
 = 
	`°æí30
(
zSql
);

731 
pPªStmt
 = 
pDb
->
°mtLi°
;ÖPªStmt;ÖPªStmtıPªStmt->
pNext
){

732 
n
 = 
pPªStmt
->
nSql
;

733 if–
nSql
>=
n


734 && 
	`memcmp
(
pPªStmt
->
zSql
, zSql, 
n
)==0

735 && (
zSql
[
n
]==0 || zSql[n-1]==';')

737 
pStmt
 = 
pPªStmt
->pStmt;

738 *
pzOut
 = &
zSql
[
pPªStmt
->
nSql
];

744 if–
pPªStmt
->
pPªv
 ){

745 
pPªStmt
->
pPªv
->
pNext
 =ÖPreStmt->pNext;

747 
pDb
->
°mtLi°
 = 
pPªStmt
->
pNext
;

749 if–
pPªStmt
->
pNext
 ){

750 
pPªStmt
->
pNext
->
pPªv
 =ÖPreStmt->pPrev;

752 
pDb
->
°mtLa°
 = 
pPªStmt
->
pPªv
;

754 
pDb
->
nStmt
--;

755 
nV¨
 = 
	`sqlôe4_böd_∑ømëî_cou¡
(
pStmt
);

762 if–
pPªStmt
==0 ){

763 
nByã
;

764 
nU£d
;

766 if–
SQLITE4_OK
!=
	`sqlôe4_¥ï¨e
(
pDb
->
db
, 
zSql
, -1, &
pStmt
, &
nU£d
) ){

767 
	`T˛_SëObjResu…
(
öãΩ
, 
	`dbTextToObj
(
	`sqlôe4_îrmsg
(
pDb
->
db
)));

768  
TCL_ERROR
;

770 *
pzOut
 = &
zSql
[
nU£d
];

771 if–
pStmt
==0 ){

772 if–
SQLITE4_OK
!=
	`sqlôe4_îrcode
(
pDb
->
db
) ){

774 
	`T˛_SëObjResu…
(
öãΩ
, 
	`dbTextToObj
(
	`sqlôe4_îrmsg
(
pDb
->
db
)));

775  
TCL_ERROR
;

780  
TCL_OK
;

784 
	`as£π
–
pPªStmt
==0 );

785 
nV¨
 = 
	`sqlôe4_böd_∑ømëî_cou¡
(
pStmt
);

786 
nByã
 = (
SqlPª∑ªdStmt
Ë+ 
nV¨
*(
T˛_Obj
 *);

787 
pPªStmt
 = (
SqlPª∑ªdStmt
*)
	`T˛_AŒoc
(
nByã
);

788 
	`mem£t
(
pPªStmt
, 0, 
nByã
);

790 
pPªStmt
->
pStmt
 =ÖStmt;

791 
pPªStmt
->
nSql
 = 
nU£d
;

792 
pPªStmt
->
zSql
 = 
	`sqlôe4_°mt_sql
(
pStmt
);

793 
pPªStmt
->
≠P¨m
 = (
T˛_Obj
 **)&pPreStmt[1];

794 #ifde‡
SQLITE4_TEST


795 if–
pPªStmt
->
zSql
==0 ){

796 *
zC›y
 = 
	`T˛_AŒoc
(
pPªStmt
->
nSql
 + 1);

797 
	`mem˝y
(
zC›y
, 
zSql
, 
pPªStmt
->
nSql
);

798 
zC›y
[
pPªStmt
->
nSql
] = '\0';

799 
pPªStmt
->
zSql
 = 
zC›y
;

803 
	`as£π
–
pPªStmt
 );

804 
	`as£π
–
	`°æí30
(
pPªStmt
->
zSql
)=ıPªStmt->
nSql
 );

805 
	`as£π
–0==
	`memcmp
(
pPªStmt
->
zSql
, zSql,ÖPªStmt->
nSql
) );

808 
i
=1; i<=
nV¨
; i++){

809 c⁄° *
zV¨
 = 
	`sqlôe4_böd_∑ømëî_«me
(
pStmt
, 
i
);

810 if–
zV¨
!=0 && (zVar[0]=='$' || zVar[0]==':' || zVar[0]=='@') ){

811 
T˛_Obj
 *
pV¨
 = 
	`T˛_GëV¨2Ex
(
öãΩ
, &
zV¨
[1], 0, 0);

812 if–
pV¨
 ){

813 
n
;

814 
u8
 *
d©a
;

815 c⁄° *
zTy≥
 = (
pV¨
->
ty≥På
 ?ÖV¨->ty≥På->
«me
 : "");

816 
c
 = 
zTy≥
[0];

817 if–
zV¨
[0]=='@' ||

818 (
c
=='b' && 
	`°rcmp
(
zTy≥
,"byã¨øy")==0 && 
pV¨
->
byãs
==0) ){

822 
d©a
 = 
	`T˛_GëByãAºayFromObj
(
pV¨
, &
n
);

823 
	`sqlôe4_böd_blob
(
pStmt
, 
i
, 
d©a
, 
n
, 
SQLITE4_STATIC
, 0);

824 
	`T˛_In¸RefCou¡
(
pV¨
);

825 
pPªStmt
->
≠P¨m
[
iP¨m
++] = 
pV¨
;

826 }if–
c
=='b' && 
	`°rcmp
(
zTy≥
,"boolean")==0 ){

827 
	`T˛_GëI¡FromObj
(
öãΩ
, 
pV¨
, &
n
);

828 
	`sqlôe4_böd_öt
(
pStmt
, 
i
, 
n
);

829 }if–
c
=='d' && 
	`°rcmp
(
zTy≥
,"double")==0 ){

830 
r
;

831 
	`T˛_GëDoubÀFromObj
(
öãΩ
, 
pV¨
, &
r
);

832 
	`sqlôe4_böd_doubÀ
(
pStmt
, 
i
, 
r
);

833 }if–(
c
=='w' && 
	`°rcmp
(
zTy≥
,"wideInt")==0) ||

834 (
c
=='i' && 
	`°rcmp
(
zTy≥
,"int")==0) ){

835 
T˛_WideI¡
 
v
;

836 
	`T˛_GëWideI¡FromObj
(
öãΩ
, 
pV¨
, &
v
);

837 
	`sqlôe4_böd_öt64
(
pStmt
, 
i
, 
v
);

839 
d©a
 = (*)
	`T˛_GëSåögFromObj
(
pV¨
, &
n
);

840 
	`sqlôe4_böd_ãxt
(
pStmt
, 
i
, (*)
d©a
, 
n
, 
SQLITE4_STATIC
, 0);

841 
	`T˛_In¸RefCou¡
(
pV¨
);

842 
pPªStmt
->
≠P¨m
[
iP¨m
++] = 
pV¨
;

845 
	`sqlôe4_böd_nuŒ
(
pStmt
, 
i
);

849 
pPªStmt
->
nP¨m
 = 
iP¨m
;

850 *
µPªStmt
 = 
pPªStmt
;

852  
TCL_OK
;

853 
	}
}

864 
	$dbRñó£Stmt
(

865 
SqlôeDb
 *
pDb
,

866 
SqlPª∑ªdStmt
 *
pPªStmt
,

867 
disˇrd


869 
i
;

872 
i
=0; i<
pPªStmt
->
nP¨m
; i++){

873 
	`T˛_De¸RefCou¡
(
pPªStmt
->
≠P¨m
[
i
]);

875 
pPªStmt
->
nP¨m
 = 0;

877 if–
pDb
->
maxStmt
<=0 || 
disˇrd
 ){

879 
	`dbFªeStmt
(
pPªStmt
);

882 
pPªStmt
->
pNext
 = 
pDb
->
°mtLi°
;

883 
pPªStmt
->
pPªv
 = 0;

884 if–
pDb
->
°mtLi°
 ){

885 
pDb
->
°mtLi°
->
pPªv
 = 
pPªStmt
;

887 
pDb
->
°mtLi°
 = 
pPªStmt
;

888 if–
pDb
->
°mtLa°
==0 ){

889 
	`as£π
–
pDb
->
nStmt
==0 );

890 
pDb
->
°mtLa°
 = 
pPªStmt
;

892 
	`as£π
–
pDb
->
nStmt
>0 );

894 
pDb
->
nStmt
++;

898  
pDb
->
nStmt
>pDb->
maxStmt
 ){

899 
SqlPª∑ªdStmt
 *
pLa°
 = 
pDb
->
°mtLa°
;

900 
pDb
->
°mtLa°
 = 
pLa°
->
pPªv
;

901 
pDb
->
°mtLa°
->
pNext
 = 0;

902 
pDb
->
nStmt
--;

903 
	`dbFªeStmt
(
pLa°
);

906 
	}
}

917 
DbEvÆC⁄ãxt
 
	tDbEvÆC⁄ãxt
;

918 
	sDbEvÆC⁄ãxt
 {

919 
SqlôeDb
 *
	mpDb
;

920 
T˛_Obj
 *
	mpSql
;

921 c⁄° *
	mzSql
;

922 
SqlPª∑ªdStmt
 *
	mpPªStmt
;

923 
	mnCﬁ
;

924 
T˛_Obj
 *
	mpAºay
;

925 
T˛_Obj
 **
	m≠CﬁName
;

932 
	$dbRñó£CﬁumnNames
(
DbEvÆC⁄ãxt
 *
p
){

933 if–
p
->
≠CﬁName
 ){

934 
i
;

935 
i
=0; i<
p
->
nCﬁ
; i++){

936 
	`T˛_De¸RefCou¡
(
p
->
≠CﬁName
[
i
]);

938 
	`T˛_Fªe
((*)
p
->
≠CﬁName
);

939 
p
->
≠CﬁName
 = 0;

941 
p
->
nCﬁ
 = 0;

942 
	}
}

956 
	$dbEvÆInô
(

957 
DbEvÆC⁄ãxt
 *
p
,

958 
SqlôeDb
 *
pDb
,

959 
T˛_Obj
 *
pSql
,

960 
T˛_Obj
 *
pAºay


962 
	`mem£t
(
p
, 0, (
DbEvÆC⁄ãxt
));

963 
p
->
pDb
 =ÖDb;

964 
p
->
zSql
 = 
	`T˛_GëSåög
(
pSql
);

965 
p
->
pSql
 =ÖSql;

966 
	`T˛_In¸RefCou¡
(
pSql
);

967 if–
pAºay
 ){

968 
p
->
pAºay
 =ÖArray;

969 
	`T˛_In¸RefCou¡
(
pAºay
);

971 
	}
}

977 
	$dbEvÆRowInfo
(

978 
DbEvÆC⁄ãxt
 *
p
,

979 *
≤Cﬁ
,

980 
T˛_Obj
 ***
∑pCﬁName


983 if–0==
p
->
≠CﬁName
 ){

984 
sqlôe4_°mt
 *
pStmt
 = 
p
->
pPªStmt
->pStmt;

985 
i
;

986 
nCﬁ
;

987 
T˛_Obj
 **
≠CﬁName
 = 0;

989 
p
->
nCﬁ
 =ÇCﬁ = 
	`sqlôe4_cﬁumn_cou¡
(
pStmt
);

990 if–
nCﬁ
>0 && (
∑pCﬁName
 || 
p
->
pAºay
) ){

991 
≠CﬁName
 = (
T˛_Obj
**)
	`T˛_AŒoc
–(T˛_Obj*)*
nCﬁ
 );

992 
i
=0; i<
nCﬁ
; i++){

993 
≠CﬁName
[
i
] = 
	`dbTextToObj
(
	`sqlôe4_cﬁumn_«me
(
pStmt
,i));

994 
	`T˛_In¸RefCou¡
(
≠CﬁName
[
i
]);

996 
p
->
≠CﬁName
 =ápColName;

1002 if–
p
->
pAºay
 ){

1003 
T˛_I¡îp
 *
öãΩ
 = 
p
->
pDb
->interp;

1004 
T˛_Obj
 *
pCﬁLi°
 = 
	`T˛_NewObj
();

1005 
T˛_Obj
 *
pSèr
 = 
	`T˛_NewSåögObj
("*", -1);

1007 
i
=0; i<
nCﬁ
; i++){

1008 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pCﬁLi°
, 
≠CﬁName
[
i
]);

1010 
	`T˛_In¸RefCou¡
(
pSèr
);

1011 
	`T˛_ObjSëV¨2
(
öãΩ
, 
p
->
pAºay
, 
pSèr
, 
pCﬁLi°
, 0);

1012 
	`T˛_De¸RefCou¡
(
pSèr
);

1016 if–
∑pCﬁName
 ){

1017 *
∑pCﬁName
 = 
p
->
≠CﬁName
;

1019 if–
≤Cﬁ
 ){

1020 *
≤Cﬁ
 = 
p
->
nCﬁ
;

1022 
	}
}

1035 
	$dbEvÆSãp
(
DbEvÆC⁄ãxt
 *
p
){

1036 c⁄° *
zPªvSql
 = 0;

1038  
p
->
zSql
[0] ||Ö->
pPªStmt
 ){

1039 
rc
;

1040 if–
p
->
pPªStmt
==0 ){

1041 
zPªvSql
 = (
p
->
zSql
==zPrevSql ? 0 :Ö->zSql);

1042 
rc
 = 
	`dbPª∑ªAndBöd
(
p
->
pDb
,Ö->
zSql
, &p->zSql, &p->
pPªStmt
);

1043 if–
rc
!=
TCL_OK
 ) Ñc;

1045 
rcs
;

1046 
SqlôeDb
 *
pDb
 = 
p
->pDb;

1047 
SqlPª∑ªdStmt
 *
pPªStmt
 = 
p
->pPreStmt;

1048 
sqlôe4_°mt
 *
pStmt
 = 
pPªStmt
->pStmt;

1050 
rcs
 = 
	`sqlôe4_°ï
(
pStmt
);

1051 if–
rcs
==
SQLITE4_ROW
 ){

1052  
TCL_OK
;

1054 if–
p
->
pAºay
 ){

1055 
	`dbEvÆRowInfo
(
p
, 0, 0);

1057 
rcs
 = 
	`sqlôe4_ª£t
(
pStmt
);

1059 
pDb
->
nSãp
 = 
	`sqlôe4_°mt_°©us
(
pStmt
,
SQLITE4_STMTSTATUS_FULLSCAN_STEP
,1);

1060 
pDb
->
nS‹t
 = 
	`sqlôe4_°mt_°©us
(
pStmt
,
SQLITE4_STMTSTATUS_SORT
,1);

1061 
pDb
->
nIndex
 = 
	`sqlôe4_°mt_°©us
(
pStmt
,
SQLITE4_STMTSTATUS_AUTOINDEX
,1);

1062 
	`dbRñó£CﬁumnNames
(
p
);

1063 
p
->
pPªStmt
 = 0;

1065 if–
rcs
!=
SQLITE4_OK
 ){

1068 
	`dbRñó£Stmt
(
pDb
, 
pPªStmt
, 1);

1069 
	`T˛_SëObjResu…
(
pDb
->
öãΩ
, 
	`dbTextToObj
(
	`sqlôe4_îrmsg
’Db->
db
)));

1070  
TCL_ERROR
;

1072 
	`dbRñó£Stmt
(
pDb
, 
pPªStmt
, 0);

1078  
TCL_BREAK
;

1079 
	}
}

1086 
	$dbEvÆFöÆize
(
DbEvÆC⁄ãxt
 *
p
){

1087 if–
p
->
pPªStmt
 ){

1088 
	`sqlôe4_ª£t
(
p
->
pPªStmt
->
pStmt
);

1089 
	`dbRñó£Stmt
(
p
->
pDb
,Ö->
pPªStmt
, 0);

1090 
p
->
pPªStmt
 = 0;

1092 if–
p
->
pAºay
 ){

1093 
	`T˛_De¸RefCou¡
(
p
->
pAºay
);

1094 
p
->
pAºay
 = 0;

1096 
	`T˛_De¸RefCou¡
(
p
->
pSql
);

1097 
	`dbRñó£CﬁumnNames
(
p
);

1098 
	}
}

1105 
T˛_Obj
 *
	$dbEvÆCﬁumnVÆue
(
DbEvÆC⁄ãxt
 *
p
, 
iCﬁ
){

1106 
sqlôe4_°mt
 *
pStmt
 = 
p
->
pPªStmt
->pStmt;

1107  
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 
iCﬁ
) ){

1108 
SQLITE4_BLOB
: {

1109 
byãs
;

1110 c⁄° *
zBlob
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 
iCﬁ
, &
byãs
);

1111 if–!
zBlob
 ) 
byãs
 = 0;

1112  
	`T˛_NewByãAºayObj
((
u8
*)
zBlob
, 
byãs
);

1114 
SQLITE4_INTEGER
: {

1115 
sqlôe4_öt64
 
v
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 
iCﬁ
);

1116 if–
v
>=-2147483647 && v<=2147483647 ){

1117  
	`T˛_NewI¡Obj
(()
v
);

1119  
	`T˛_NewWideI¡Obj
(
v
);

1122 
SQLITE4_FLOAT
: {

1123  
	`T˛_NewDoubÀObj
(
	`sqlôe4_cﬁumn_doubÀ
(
pStmt
, 
iCﬁ
));

1125 
SQLITE4_NULL
: {

1126  
	`dbTextToObj
(
p
->
pDb
->
zNuŒ
);

1130  
	`dbTextToObj
(
	`sqlôe4_cﬁumn_ãxt
(
pStmt
, 
iCﬁ
, 0));

1131 
	}
}

1140 #i‡
TCL_MAJOR_VERSION
>8 || (TCL_MAJOR_VERSION==8 && 
TCL_MINOR_VERSION
>=6)

1141 
	#SQLITE4_TCL_NRE
 1

	)

1142 
	$DbU£Nª
(){

1143 
maj‹
, 
mö‹
;

1144 
	`T˛_GëVîsi⁄
(&
maj‹
, &
mö‹
, 0, 0);

1145 –(
maj‹
==8 && 
mö‹
>=6) || major>8 );

1146 
	}
}

1157 
	#SQLITE4_TCL_NRE
 0

	)

1158 
	#DbU£Nª
(Ë0

	)

1159 
	#T˛_NRAddCÆlback
(
a
,
b
,
c
,
d
,
e
,
f
Ë0

	)

1160 
	#T˛_NREvÆObj
(
a
,
b
,
c
Ë0

	)

1161 
	#T˛_NRCª©eComm™d
(
a
,
b
,
c
,
d
,
e
,
f
Ë0

	)

1169 
	$DbEvÆNextCmd
(

1170 
Clõ¡D©a
 
d©a
[],

1171 
T˛_I¡îp
 *
öãΩ
,

1172 
ªsu…


1174 
rc
 = 
ªsu…
;

1180 
DbEvÆC⁄ãxt
 *
p
 = (DbEvÆC⁄ãxà*)
d©a
[0];

1181 
T˛_Obj
 *
pS¸ùt
 = (T˛_Obj *)
d©a
[1];

1182 
T˛_Obj
 *
pAºay
 = 
p
->pArray;

1184  (
rc
==
TCL_OK
 ||Ñc==
TCL_CONTINUE
Ë&& TCL_OK==‘¯
	`dbEvÆSãp
(
p
)) ){

1185 
i
;

1186 
nCﬁ
;

1187 
T˛_Obj
 **
≠CﬁName
;

1188 
	`dbEvÆRowInfo
(
p
, &
nCﬁ
, &
≠CﬁName
);

1189 
i
=0; i<
nCﬁ
; i++){

1190 
T˛_Obj
 *
pVÆ
 = 
	`dbEvÆCﬁumnVÆue
(
p
, 
i
);

1191 if–
pAºay
==0 ){

1192 
	`T˛_ObjSëV¨2
(
öãΩ
, 
≠CﬁName
[
i
], 0, 
pVÆ
, 0);

1194 
	`T˛_ObjSëV¨2
(
öãΩ
, 
pAºay
, 
≠CﬁName
[
i
], 
pVÆ
, 0);

1207 if–
	`DbU£Nª
() ){

1208 
	`T˛_NRAddCÆlback
(
öãΩ
, 
DbEvÆNextCmd
, (*)
p
, (*)
pS¸ùt
, 0, 0);

1209  
	`T˛_NREvÆObj
(
öãΩ
, 
pS¸ùt
, 0);

1211 
rc
 = 
	`T˛_EvÆObjEx
(
öãΩ
, 
pS¸ùt
, 0);

1215 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

1216 
	`dbEvÆFöÆize
(
p
);

1217 
	`T˛_Fªe
((*)
p
);

1219 if–
rc
==
TCL_OK
 ||Ñc==
TCL_BREAK
 ){

1220 
	`T˛_Re£tResu…
(
öãΩ
);

1221 
rc
 = 
TCL_OK
;

1223  
rc
;

1224 
	}
}

1239 
	$DbObjCmd
(*
cd
, 
T˛_I¡îp
 *
öãΩ
, 
objc
,
T˛_Obj
 *c⁄°*
objv
){

1240 
SqlôeDb
 *
pDb
 = (SqlôeDb*)
cd
;

1241 
choi˚
;

1242 
rc
 = 
TCL_OK
;

1243 c⁄° *
DB_°rs
[] = {

1254 
	eDB_íum
 {

1255 
DB_AUTHORIZER
, 
DB_CACHE
, 
DB_CHANGES
,

1256 
DB_CLOSE
, 
DB_COLLATE
, 
DB_COLLATION_NEEDED
,

1257 
DB_COMPLETE
, 
DB_COPY
, 
DB_ENABLE_LOAD_EXTENSION
,

1258 
DB_ERRORCODE
, 
DB_EVAL
, 
DB_EXISTS
,

1259 
DB_FUNCTION
, 
DB_INTERRUPT
,

1260 
DB_NULLVALUE
, 
DB_ONECOLUMN
, 
DB_PROFILE
,

1261 
DB_REKEY
, 
DB_STATUS
, 
DB_TOTAL_CHANGES
,

1262 
DB_TRACE
, 
DB_TRANSACTION
,

1263 
DB_VERSION


1267 if–
objc
<2 ){

1268 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SUBCOMMAND ...");

1269  
TCL_ERROR
;

1271 if–
	`T˛_GëIndexFromObj
(
öãΩ
, 
objv
[1], 
DB_°rs
, "›ti⁄", 0, &
choi˚
) ){

1272  
TCL_ERROR
;

1275  (
DB_íum
)
choi˚
 ){

1295 
DB_AUTHORIZER
: {

1296 #ifde‡
SQLITE4_OMIT_AUTHORIZATION


1297 
	`T˛_AµídResu…
(
öãΩ
, "authorizationÇotávailable inÅhis build", 0);

1298  
TCL_ERROR
;

1300 if–
objc
>3 ){

1301 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "?CALLBACK?");

1302  
TCL_ERROR
;

1303 }if–
objc
==2 ){

1304 if–
pDb
->
zAuth
 ){

1305 
	`T˛_AµídResu…
(
öãΩ
, 
pDb
->
zAuth
, 0);

1308 *
zAuth
;

1309 
Àn
;

1310 if–
pDb
->
zAuth
 ){

1311 
	`T˛_Fªe
(
pDb
->
zAuth
);

1312 
	`sqlôe4_auth‹izî_p›
(
pDb
->
db
);

1314 
zAuth
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
Àn
);

1315 if–
zAuth
 && 
Àn
>0 ){

1316 
pDb
->
zAuth
 = 
	`T˛_AŒoc
–
Àn
 + 1 );

1317 
	`mem˝y
(
pDb
->
zAuth
, zAuth, 
Àn
+1);

1319 
pDb
->
zAuth
 = 0;

1321 if–
pDb
->
zAuth
 ){

1322 
pDb
->
öãΩ
 = interp;

1323 
rc
 = 
	`sqlôe4_auth‹izî_push
(
pDb
->
db
,ÖDb, 
auth_ˇŒback
, 0);

1324 if–
rc
!=
SQLITE4_OK
 ){

1325 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4_îrmsg
(
pDb
->
db
), 
TCL_VOLATILE
);

1326  
TCL_ERROR
;

1340 
DB_CACHE
: {

1341 *
subCmd
;

1342 
n
;

1344 if–
objc
<=2 ){

1345 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "cache option ?arg?");

1346  
TCL_ERROR
;

1348 
subCmd
 = 
	`T˛_GëSåögFromObj
–
objv
[2], 0 );

1349 if–*
subCmd
=='f' && 
	`°rcmp
(subCmd,"flush")==0 ){

1350 if–
objc
!=3 ){

1351 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "flush");

1352  
TCL_ERROR
;

1354 
	`ÊushStmtCache
–
pDb
 );

1356 }if–*
subCmd
=='s' && 
	`°rcmp
(subCmd,"size")==0 ){

1357 if–
objc
!=4 ){

1358 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "sizeÇ");

1359  
TCL_ERROR
;

1361 if–
TCL_ERROR
==
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
n
) ){

1362 
	`T˛_AµídResu…
–
öãΩ
, "cannot convert \"",

1363 
	`T˛_GëSåögFromObj
(
objv
[3],0), "\"Åo integer", 0);

1364  
TCL_ERROR
;

1366 if–
n
<0 ){

1367 
	`ÊushStmtCache
–
pDb
 );

1368 
n
 = 0;

1369 }if–
n
>
MAX_PREPARED_STMTS
 ){

1370 
n
 = 
MAX_PREPARED_STMTS
;

1372 
pDb
->
maxStmt
 = 
n
;

1376 
	`T˛_AµídResu…
–
öãΩ
, "bad option \"",

1377 
	`T˛_GëSåögFromObj
(
objv
[2],0), "\": must be flush or size", 0);

1378  
TCL_ERROR
;

1389 
DB_CHANGES
: {

1390 
T˛_Obj
 *
pResu…
;

1391 if–
objc
!=2 ){

1392 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "");

1393  
TCL_ERROR
;

1395 
pResu…
 = 
	`T˛_GëObjResu…
(
öãΩ
);

1396 
	`T˛_SëI¡Obj
(
pResu…
, 
	`sqlôe4_ch™ges
(
pDb
->
db
));

1404 
DB_CLOSE
: {

1405 
	`T˛_DñëeComm™d
(
öãΩ
, 
	`T˛_GëSåögFromObj
(
objv
[0], 0));

1415 
DB_COLLATE
: {

1416 
SqlCﬁœã
 *
pCﬁœã
;

1417 *
zName
;

1418 *
zCmp
; 
nCmp
;

1419 *
zMkkey
; 
nMkkey
;

1420 
nByã
;

1422 if–
objc
!=5 ){

1423 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "NAME CMP-SCRIPT MKKEY-SCRIPT");

1424  
TCL_ERROR
;

1426 
zName
 = 
	`T˛_GëSåögFromObj
(
objv
[2], 0);

1427 
zCmp
 = 
	`T˛_GëSåögFromObj
(
objv
[3], &
nCmp
);

1428 
zMkkey
 = 
	`T˛_GëSåögFromObj
(
objv
[4], &
nMkkey
);

1430 
nByã
 = (
SqlCﬁœã
Ë+ 
nCmp
 + 1 + 
nMkkey
 + 1;

1431 
pCﬁœã
 = (
SqlCﬁœã
*)
	`T˛_AŒoc
(
nByã
);

1432 
pCﬁœã
->
öãΩ
 = interp;

1433 
pCﬁœã
->
pNext
 = 
pDb
->pCollate;

1434 
pCﬁœã
->
zCmp
 = (*)&pCollate[1];

1435 
pCﬁœã
->
zMkkey
 = &pCﬁœã->
zCmp
[
nCmp
 + 1];

1436 
pDb
->
pCﬁœã
 =ÖCollate;

1438 
	`mem˝y
(
pCﬁœã
->
zCmp
, zCmp, 
nCmp
+1);

1439 
	`mem˝y
(
pCﬁœã
->
zMkkey
, zMkkey, 
nMkkey
+1);

1440 
rc
 = 
	`sqlôe4_¸óã_cﬁœti⁄
(

1441 
pDb
->
db
, 
zName
, 
pCﬁœã
, 
t˛SqlCﬁœã
, 
t˛SqlMkkey
, 0

1443 if–
rc
!=
SQLITE4_OK
 ){

1444 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4_îrmsg
(
pDb
->
db
), 
TCL_VOLATILE
);

1445  
TCL_ERROR
;

1456 
DB_COLLATION_NEEDED
: {

1457 if–
objc
!=3 ){

1458 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "SCRIPT");

1459  
TCL_ERROR
;

1461 if–
pDb
->
pCﬁœãNìded
 ){

1462 
	`T˛_De¸RefCou¡
(
pDb
->
pCﬁœãNìded
);

1464 
pDb
->
pCﬁœãNìded
 = 
	`T˛_Du∂iˇãObj
(
objv
[2]);

1465 
	`T˛_In¸RefCou¡
(
pDb
->
pCﬁœãNìded
);

1466 
	`sqlôe4_cﬁœti⁄_√eded
(
pDb
->
db
, (*ÌDb, 
t˛CﬁœãNìded
, 0);

1476 
DB_COMPLETE
: {

1477 #i‚de‡
SQLITE4_OMIT_COMPLETE


1478 
T˛_Obj
 *
pResu…
;

1479 
isCom∂ëe
;

1480 if–
objc
!=3 ){

1481 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "SQL");

1482  
TCL_ERROR
;

1484 
isCom∂ëe
 = 
	`sqlôe4_com∂ëe
–
	`T˛_GëSåögFromObj
(
objv
[2], 0) );

1485 
pResu…
 = 
	`T˛_GëObjResu…
(
öãΩ
);

1486 
	`T˛_SëBoﬁónObj
(
pResu…
, 
isCom∂ëe
);

1508 
DB_COPY
: {

1509 *
zTabÀ
;

1510 *
zFûe
;

1511 *
zC⁄Êi˘
;

1512 
sqlôe4_°mt
 *
pStmt
;

1513 
nCﬁ
;

1514 
nByã
;

1515 
i
, 
j
;

1516 
nSï
;

1517 
nNuŒ
;

1518 *
zSql
;

1519 *
zLöe
;

1520 **
azCﬁ
;

1521 *
zCommô
;

1522 
FILE
 *
ö
;

1523 
löío
 = 0;

1524 
zLöeNum
[80];

1525 
T˛_Obj
 *
pResu…
;

1527 *
zSï
;

1528 *
zNuŒ
;

1529 if–
objc
<5 || objc>7 ){

1530 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
,

1532  
TCL_ERROR
;

1534 if–
objc
>=6 ){

1535 
zSï
 = 
	`T˛_GëSåögFromObj
(
objv
[5], 0);

1537 
zSï
 = "\t";

1539 if–
objc
>=7 ){

1540 
zNuŒ
 = 
	`T˛_GëSåögFromObj
(
objv
[6], 0);

1542 
zNuŒ
 = "";

1544 
zC⁄Êi˘
 = 
	`T˛_GëSåögFromObj
(
objv
[2], 0);

1545 
zTabÀ
 = 
	`T˛_GëSåögFromObj
(
objv
[3], 0);

1546 
zFûe
 = 
	`T˛_GëSåögFromObj
(
objv
[4], 0);

1547 
nSï
 = 
	`°æí30
(
zSï
);

1548 
nNuŒ
 = 
	`°æí30
(
zNuŒ
);

1549 if–
nSï
==0 ){

1550 
	`T˛_AµídResu…
(
öãΩ
,"Error:Çon-null separatorÑequired for copy",0);

1551  
TCL_ERROR
;

1553 if(
	`°rcmp
(
zC⁄Êi˘
, "rollback") != 0 &&

1554 
	`°rcmp
(
zC⁄Êi˘
, "abort" ) != 0 &&

1555 
	`°rcmp
(
zC⁄Êi˘
, "fail" ) != 0 &&

1556 
	`°rcmp
(
zC⁄Êi˘
, "ignore" ) != 0 &&

1557 
	`°rcmp
(
zC⁄Êi˘
, "replace" ) != 0 ) {

1558 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹: \"", 
zC⁄Êi˘
,

1561  
TCL_ERROR
;

1563 
zSql
 = 
	`sqlôe4_m¥ötf
(0, "SELECT * FROM '%q'", 
zTabÀ
);

1564 if–
zSql
==0 ){

1565 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹:ÇÿsuchÅabÀ: ", 
zTabÀ
, 0);

1566  
TCL_ERROR
;

1568 
nByã
 = 
	`°æí30
(
zSql
);

1569 
rc
 = 
	`sqlôe4_¥ï¨e
(
pDb
->
db
, 
zSql
, -1, &
pStmt
, 0);

1570 
	`sqlôe4_‰ì
(0, 
zSql
);

1571 if–
rc
 ){

1572 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹: ", 
	`sqlôe4_îrmsg
(
pDb
->
db
), 0);

1573 
nCﬁ
 = 0;

1575 
nCﬁ
 = 
	`sqlôe4_cﬁumn_cou¡
(
pStmt
);

1577 
	`sqlôe4_föÆize
(
pStmt
);

1578 if–
nCﬁ
==0 ) {

1579  
TCL_ERROR
;

1581 
zSql
 = 
	`mÆloc
–
nByã
 + 50 + 
nCﬁ
*2 );

1582 if–
zSql
==0 ) {

1583 
	`T˛_AµídResu…
(
öãΩ
, "Error: can't malloc()", 0);

1584  
TCL_ERROR
;

1586 
j
 = 
	`sqlôe4_¢¥ötf
(
zSql
, 
nByã
+50, "INSERT OR %q INTO '%q' VALUES(?",

1587 
zC⁄Êi˘
, 
zTabÀ
);

1588 
i
=1; i<
nCﬁ
; i++){

1589 
zSql
[
j
++] = ',';

1590 
zSql
[
j
++] = '?';

1592 
zSql
[
j
++] = ')';

1593 
zSql
[
j
] = 0;

1594 
rc
 = 
	`sqlôe4_¥ï¨e
(
pDb
->
db
, 
zSql
, -1, &
pStmt
, 0);

1595 
	`‰ì
(
zSql
);

1596 if–
rc
 ){

1597 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹: ", 
	`sqlôe4_îrmsg
(
pDb
->
db
), 0);

1598 
	`sqlôe4_föÆize
(
pStmt
);

1599  
TCL_ERROR
;

1601 
ö
 = 
	`f›í
(
zFûe
, "rb");

1602 if–
ö
==0 ){

1603 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹: c™nŸ o≥¿fûe: ", 
zFûe
, 
NULL
);

1604 
	`sqlôe4_föÆize
(
pStmt
);

1605  
TCL_ERROR
;

1607 
azCﬁ
 = 
	`mÆloc
–◊zCﬁ[0])*(
nCﬁ
+1) );

1608 if–
azCﬁ
==0 ) {

1609 
	`T˛_AµídResu…
(
öãΩ
, "Error: can't malloc()", 0);

1610 
	`f˛o£
(
ö
);

1611  
TCL_ERROR
;

1613 ()
	`sqlôe4_exec
(
pDb
->
db
, "BEGIN", 0, 0);

1614 
zCommô
 = "COMMIT";

1615  (
zLöe
 = 
	`loˇl_gëlöe
(0, 
ö
))!=0 ){

1616 *
z
;

1617 
löío
++;

1618 
azCﬁ
[0] = 
zLöe
;

1619 
i
=0, 
z
=
zLöe
; *z; z++){

1620 if–*
z
==
zSï
[0] && 
	`°∫cmp
(z, zSï, 
nSï
)==0 ){

1621 *
z
 = 0;

1622 
i
++;

1623 if–
i
<
nCﬁ
 ){

1624 
azCﬁ
[
i
] = &
z
[
nSï
];

1625 
z
 +
nSï
-1;

1629 if–
i
+1!=
nCﬁ
 ){

1630 *
zEº
;

1631 
nEº
 = 
	`°æí30
(
zFûe
) + 200;

1632 
zEº
 = 
	`mÆloc
(
nEº
);

1633 if–
zEº
 ){

1634 
	`sqlôe4_¢¥ötf
(
zEº
, 
nEº
,

1636 
zFûe
, 
löío
, 
nCﬁ
, 
i
+1);

1637 
	`T˛_AµídResu…
(
öãΩ
, 
zEº
, 0);

1638 
	`‰ì
(
zEº
);

1640 
zCommô
 = "ROLLBACK";

1643 
i
=0; i<
nCﬁ
; i++){

1645 if–(
nNuŒ
>0 && 
	`°rcmp
(
azCﬁ
[
i
], 
zNuŒ
)==0)

1646 || 
	`°æí30
(
azCﬁ
[
i
])==0

1648 
	`sqlôe4_böd_nuŒ
(
pStmt
, 
i
+1);

1650 
	`sqlôe4_böd_ãxt
(
pStmt
, 
i
+1, 
azCﬁ
[i], -1, 
SQLITE4_STATIC
, 0);

1653 
	`sqlôe4_°ï
(
pStmt
);

1654 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

1655 
	`‰ì
(
zLöe
);

1656 if–
rc
!=
SQLITE4_OK
 ){

1657 
	`T˛_AµídResu…
(
öãΩ
,"Eº‹: ", 
	`sqlôe4_îrmsg
(
pDb
->
db
), 0);

1658 
zCommô
 = "ROLLBACK";

1662 
	`‰ì
(
azCﬁ
);

1663 
	`f˛o£
(
ö
);

1664 
	`sqlôe4_föÆize
(
pStmt
);

1665 ()
	`sqlôe4_exec
(
pDb
->
db
, 
zCommô
, 0, 0);

1667 if–
zCommô
[0] == 'C' ){

1669 
pResu…
 = 
	`T˛_GëObjResu…
(
öãΩ
);

1670 
	`T˛_SëI¡Obj
(
pResu…
, 
löío
);

1671 
rc
 = 
TCL_OK
;

1674 
	`sqlôe4_¢¥ötf
(
zLöeNum
, (zLöeNum),"%d",
löío
);

1675 
	`T˛_AµídResu…
(
öãΩ
,", faûed whûê¥o˚ssögÜöe: ",
zLöeNum
,0);

1676 
rc
 = 
TCL_ERROR
;

1687 
DB_ENABLE_LOAD_EXTENSION
: {

1688 
	`T˛_AµídResu…
(
öãΩ
, "extensionÜoading isÅurned offát compile-time",

1690  
TCL_ERROR
;

1699 
DB_ERRORCODE
: {

1700 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_îrcode
(
pDb
->
db
)));

1711 
DB_EXISTS
:

1712 
DB_ONECOLUMN
: {

1713 
DbEvÆC⁄ãxt
 
sEvÆ
;

1714 if–
objc
!=3 ){

1715 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "SQL");

1716  
TCL_ERROR
;

1719 
	`dbEvÆInô
(&
sEvÆ
, 
pDb
, 
objv
[2], 0);

1720 
rc
 = 
	`dbEvÆSãp
(&
sEvÆ
);

1721 if–
choi˚
==
DB_ONECOLUMN
 ){

1722 if–
rc
==
TCL_OK
 ){

1723 
	`T˛_SëObjResu…
(
öãΩ
, 
	`dbEvÆCﬁumnVÆue
(&
sEvÆ
, 0));

1724 }if–
rc
==
TCL_BREAK
 ){

1725 
	`T˛_Re£tResu…
(
öãΩ
);

1727 }if–
rc
==
TCL_BREAK
 ||Ñc==
TCL_OK
 ){

1728 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
rc
==
TCL_OK
));

1730 
	`dbEvÆFöÆize
(&
sEvÆ
);

1732 if–
rc
==
TCL_BREAK
 ){

1733 
rc
 = 
TCL_OK
;

1747 
DB_EVAL
: {

1748 if–
objc
<3 || objc>5 ){

1749 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "SQL ?ARRAY-NAME? ?SCRIPT?");

1750  
TCL_ERROR
;

1753 if–
objc
==3 ){

1754 
DbEvÆC⁄ãxt
 
sEvÆ
;

1755 
T˛_Obj
 *
pRë
 = 
	`T˛_NewObj
();

1756 
	`T˛_In¸RefCou¡
(
pRë
);

1757 
	`dbEvÆInô
(&
sEvÆ
, 
pDb
, 
objv
[2], 0);

1758  
TCL_OK
==(
rc
 = 
	`dbEvÆSãp
(&
sEvÆ
)) ){

1759 
i
;

1760 
nCﬁ
;

1761 
	`dbEvÆRowInfo
(&
sEvÆ
, &
nCﬁ
, 0);

1762 
i
=0; i<
nCﬁ
; i++){

1763 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
, 
	`dbEvÆCﬁumnVÆue
(&
sEvÆ
, 
i
));

1766 
	`dbEvÆFöÆize
(&
sEvÆ
);

1767 if–
rc
==
TCL_BREAK
 ){

1768 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

1769 
rc
 = 
TCL_OK
;

1771 
	`T˛_De¸RefCou¡
(
pRë
);

1773 
Clõ¡D©a
 
cd
[2];

1774 
DbEvÆC⁄ãxt
 *
p
;

1775 
T˛_Obj
 *
pAºay
 = 0;

1776 
T˛_Obj
 *
pS¸ùt
;

1778 if–
objc
==5 && *(*)
	`T˛_GëSåög
(
objv
[3]) ){

1779 
pAºay
 = 
objv
[3];

1781 
pS¸ùt
 = 
objv
[
objc
-1];

1782 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1784 
p
 = (
DbEvÆC⁄ãxt
 *)
	`T˛_AŒoc
((DbEvalContext));

1785 
	`dbEvÆInô
(
p
, 
pDb
, 
objv
[2], 
pAºay
);

1787 
cd
[0] = (*)
p
;

1788 
cd
[1] = (*)
pS¸ùt
;

1789 
rc
 = 
	`DbEvÆNextCmd
(
cd
, 
öãΩ
, 
TCL_OK
);

1800 
DB_FUNCTION
: {

1801 
SqlFunc
 *
pFunc
;

1802 
T˛_Obj
 *
pS¸ùt
;

1803 *
zName
;

1804 
nArg
 = -1;

1805 if–
objc
==6 ){

1806 c⁄° *
z
 = 
	`T˛_GëSåög
(
objv
[3]);

1807 
n
 = 
	`°æí30
(
z
);

1808 if–
n
>2 && 
	`°∫cmp
(
z
, "-argcount",n)==0 ){

1809 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[4], &
nArg
ËË 
TCL_ERROR
;

1810 if–
nArg
<0 ){

1811 
	`T˛_AµídResu…
(
öãΩ
, "number ofárguments must beÇon-negative",

1813  
TCL_ERROR
;

1816 
pS¸ùt
 = 
objv
[5];

1817 }if–
objc
!=4 ){

1818 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "NAME [-argcount N] SCRIPT");

1819  
TCL_ERROR
;

1821 
pS¸ùt
 = 
objv
[3];

1823 
zName
 = 
	`T˛_GëSåögFromObj
(
objv
[2], 0);

1824 
pFunc
 = 
	`födSqlFunc
(
pDb
, 
zName
);

1825 if–
pFunc
==0 )  
TCL_ERROR
;

1826 if–
pFunc
->
pS¸ùt
 ){

1827 
	`T˛_De¸RefCou¡
(
pFunc
->
pS¸ùt
);

1829 
pFunc
->
pS¸ùt
 =ÖScript;

1830 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1831 
pFunc
->
u£EvÆObjv
 = 
	`ß„ToU£EvÆObjv
(
öãΩ
, 
pS¸ùt
);

1832 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
pDb
->
db
, 
zName
, 
nArg
,

1833 
pFunc
, 
t˛SqlFunc
, 0, 0, 0);

1834 if–
rc
!=
SQLITE4_OK
 ){

1835 
rc
 = 
TCL_ERROR
;

1836 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4_îrmsg
(
pDb
->
db
), 
TCL_VOLATILE
);

1847 
DB_INTERRUPT
: {

1848 
	`sqlôe4_öãºu±
(
pDb
->
db
);

1860 
DB_NULLVALUE
: {

1861 if–
objc
!=2 && objc!=3 ){

1862 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "NULLVALUE");

1863  
TCL_ERROR
;

1865 if–
objc
==3 ){

1866 
Àn
;

1867 *
zNuŒ
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
Àn
);

1868 if–
pDb
->
zNuŒ
 ){

1869 
	`T˛_Fªe
(
pDb
->
zNuŒ
);

1871 if–
zNuŒ
 && 
Àn
>0 ){

1872 
pDb
->
zNuŒ
 = 
	`T˛_AŒoc
–
Àn
 + 1 );

1873 
	`mem˝y
(
pDb
->
zNuŒ
, zNuŒ, 
Àn
);

1874 
pDb
->
zNuŒ
[
Àn
] = '\0';

1876 
pDb
->
zNuŒ
 = 0;

1879 
	`T˛_SëObjResu…
(
öãΩ
, 
	`dbTextToObj
(
pDb
->
zNuŒ
));

1894 
DB_PROFILE
: {

1895 if–
objc
>3 ){

1896 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "?CALLBACK?");

1897  
TCL_ERROR
;

1898 }if–
objc
==2 ){

1899 if–
pDb
->
zProfûe
 ){

1900 
	`T˛_AµídResu…
(
öãΩ
, 
pDb
->
zProfûe
, 0);

1903 *
zProfûe
;

1904 
Àn
;

1905 if–
pDb
->
zProfûe
 ){

1906 
	`T˛_Fªe
(
pDb
->
zProfûe
);

1908 
zProfûe
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
Àn
);

1909 if–
zProfûe
 && 
Àn
>0 ){

1910 
pDb
->
zProfûe
 = 
	`T˛_AŒoc
–
Àn
 + 1 );

1911 
	`mem˝y
(
pDb
->
zProfûe
, zProfûe, 
Àn
+1);

1913 
pDb
->
zProfûe
 = 0;

1915 #i‡!
	`deföed
(
SQLITE4_OMIT_TRACE
Ë&& !deföed(
SQLITE4_OMIT_FLOATING_POINT
)

1916 if–
pDb
->
zProfûe
 ){

1917 
pDb
->
öãΩ
 = interp;

1918 
	`sqlôe4_¥ofûe
(
pDb
->
db
, (*ÌDb, 
DbProfûeH™dÀr
, 0);

1920 
	`sqlôe4_¥ofûe
(
pDb
->
db
, 0, 0, 0);

1932 
DB_REKEY
: {

1933 #ifde‡
SQLITE4_HAS_CODEC


1934 
nKey
;

1935 *
pKey
;

1937 if–
objc
!=3 ){

1938 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "KEY");

1939  
TCL_ERROR
;

1941 #ifde‡
SQLITE4_HAS_CODEC


1942 
pKey
 = 
	`T˛_GëByãAºayFromObj
(
objv
[2], &
nKey
);

1943 
rc
 = 
	`sqlôe4_ªkey
(
pDb
->
db
, 
pKey
, 
nKey
);

1944 if–
rc
 ){

1945 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4EºSå
(
rc
), 0);

1946 
rc
 = 
TCL_ERROR
;

1958 
DB_STATUS
: {

1959 
v
;

1960 c⁄° *
zOp
;

1961 if–
objc
!=3 ){

1962 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "(step|sort|autoindex)");

1963  
TCL_ERROR
;

1965 
zOp
 = 
	`T˛_GëSåög
(
objv
[2]);

1966 if–
	`°rcmp
(
zOp
, "step")==0 ){

1967 
v
 = 
pDb
->
nSãp
;

1968 }if–
	`°rcmp
(
zOp
, "sort")==0 ){

1969 
v
 = 
pDb
->
nS‹t
;

1970 }if–
	`°rcmp
(
zOp
, "autoindex")==0 ){

1971 
v
 = 
pDb
->
nIndex
;

1973 
	`T˛_AµídResu…
(
öãΩ
,

1976  
TCL_ERROR
;

1978 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
v
));

1988 
DB_TOTAL_CHANGES
: {

1989 
T˛_Obj
 *
pResu…
;

1990 if–
objc
!=2 ){

1991 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "");

1992  
TCL_ERROR
;

1994 
pResu…
 = 
	`T˛_GëObjResu…
(
öãΩ
);

1995 
	`T˛_SëI¡Obj
(
pResu…
, 
	`sqlôe4_tŸÆ_ch™ges
(
pDb
->
db
));

2005 
DB_TRACE
: {

2006 if–
objc
>3 ){

2007 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "?CALLBACK?");

2008  
TCL_ERROR
;

2009 }if–
objc
==2 ){

2010 if–
pDb
->
zTø˚
 ){

2011 
	`T˛_AµídResu…
(
öãΩ
, 
pDb
->
zTø˚
, 0);

2014 *
zTø˚
;

2015 
Àn
;

2016 if–
pDb
->
zTø˚
 ){

2017 
	`T˛_Fªe
(
pDb
->
zTø˚
);

2019 
zTø˚
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
Àn
);

2020 if–
zTø˚
 && 
Àn
>0 ){

2021 
pDb
->
zTø˚
 = 
	`T˛_AŒoc
–
Àn
 + 1 );

2022 
	`mem˝y
(
pDb
->
zTø˚
, zTø˚, 
Àn
+1);

2024 
pDb
->
zTø˚
 = 0;

2026 #i‡!
	`deföed
(
SQLITE4_OMIT_TRACE
Ë&& !deföed(
SQLITE4_OMIT_FLOATING_POINT
)

2027 if–
pDb
->
zTø˚
 ){

2028 
pDb
->
öãΩ
 = interp;

2029 
	`sqlôe4_åa˚
(
pDb
->
db
, (*ÌDb, 
DbTø˚H™dÀr
, 0);

2031 
	`sqlôe4_åa˚
(
pDb
->
db
, 0, 0, 0);

2049 
DB_TRANSACTION
: {

2050 
T˛_Obj
 *
pS¸ùt
;

2051 c⁄° *
zBegö
 = "SAVEPOINT _tcl_transaction";

2052 if–
objc
!=3 && objc!=4 ){

2053 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "[TYPE] SCRIPT");

2054  
TCL_ERROR
;

2057 if–
pDb
->
nTønß˘i⁄
==0 && 
objc
==4 ){

2058 c⁄° *
TTYPE_°rs
[] = {

2061 
	eTTYPE_íum
 {

2062 
TTYPE_DEFERRED
, 
TTYPE_EXCLUSIVE
, 
TTYPE_IMMEDIATE


2064 
ây≥
;

2065 if–
	`T˛_GëIndexFromObj
(
öãΩ
, 
objv
[2], 
TTYPE_°rs
, "transactionÅype",

2066 0, &
ây≥
) ){

2067  
TCL_ERROR
;

2069  (
TTYPE_íum
)
ây≥
 ){

2070 
TTYPE_DEFERRED
: ; ;

2071 
TTYPE_EXCLUSIVE
: 
zBegö
 = "BEGIN EXCLUSIVE"; ;

2072 
TTYPE_IMMEDIATE
: 
zBegö
 = "BEGIN IMMEDIATE"; ;

2075 
pS¸ùt
 = 
objv
[
objc
-1];

2078 
pDb
->
dißbÀAuth
++;

2079 
rc
 = 
	`sqlôe4_exec
(
pDb
->
db
, 
zBegö
, 0, 0);

2080 
pDb
->
dißbÀAuth
--;

2081 if–
rc
!=
SQLITE4_OK
 ){

2082 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4_îrmsg
(
pDb
->
db
), 0);

2083  
TCL_ERROR
;

2085 
pDb
->
nTønß˘i⁄
++;

2092 if–
	`DbU£Nª
() ){

2093 
	`T˛_NRAddCÆlback
(
öãΩ
, 
DbTønsPo°Cmd
, 
cd
, 0, 0, 0);

2094 
	`T˛_NREvÆObj
(
öãΩ
, 
pS¸ùt
, 0);

2096 
rc
 = 
	`DbTønsPo°Cmd
(&
cd
, 
öãΩ
, 
	`T˛_EvÆObjEx
(öãΩ, 
pS¸ùt
, 0));

2105 
DB_VERSION
: {

2106 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4_libvîsi⁄
(), 
TCL_STATIC
);

2112  
rc
;

2113 
	}
}

2115 #i‡
SQLITE4_TCL_NRE


2120 
	$DbObjCmdAd≠t‹
(

2121 *
cd
,

2122 
T˛_I¡îp
 *
öãΩ
,

2123 
objc
,

2124 
T˛_Obj
 *c⁄°*
objv


2126  
	`T˛_NRCÆlObjProc
(
öãΩ
, 
DbObjCmd
, 
cd
, 
objc
, 
objv
);

2127 
	}
}

2145 
	$DbMaö
(*
cd
, 
T˛_I¡îp
 *
öãΩ
, 
objc
,
T˛_Obj
 *c⁄°*
objv
){

2146 
SqlôeDb
 *
p
;

2147 c⁄° *
zArg
;

2148 *
zEºMsg
;

2149 
i
;

2150 c⁄° *
zFûe
;

2151 c⁄° *
zVfs
 = 0;

2152 
Êags
;

2153 
T˛_DSåög
 
å™¶©edFûíame
;

2154 #ifde‡
SQLITE4_HAS_CODEC


2155 *
pKey
 = 0;

2156 
nKey
 = 0;

2159 
Êags
 = 
SQLITE4_OPEN_READWRITE
 | 
SQLITE4_OPEN_CREATE
;

2160 if–
objc
==2 ){

2161 
zArg
 = 
	`T˛_GëSåögFromObj
(
objv
[1], 0);

2162 if–
	`°rcmp
(
zArg
,"-version")==0 ){

2163 
	`T˛_AµídResu…
(
öãΩ
,
	`sqlôe4_libvîsi⁄
(),0);

2164  
TCL_OK
;

2166 if–
	`°rcmp
(
zArg
,"-has-codec")==0 ){

2167 #ifde‡
SQLITE4_HAS_CODEC


2168 
	`T˛_AµídResu…
(
öãΩ
,"1",0);

2170 
	`T˛_AµídResu…
(
öãΩ
,"0",0);

2172  
TCL_OK
;

2175 
i
=3; i+1<
objc
; i+=2){

2176 
zArg
 = 
	`T˛_GëSåög
(
objv
[
i
]);

2177 if–
	`°rcmp
(
zArg
,"-key")==0 ){

2178 #ifde‡
SQLITE4_HAS_CODEC


2179 
pKey
 = 
	`T˛_GëByãAºayFromObj
(
objv
[
i
+1], &
nKey
);

2181 }if–
	`°rcmp
(
zArg
, "-vfs")==0 ){

2182 
zVfs
 = 
	`T˛_GëSåög
(
objv
[
i
+1]);

2183 }if–
	`°rcmp
(
zArg
, "-readonly")==0 ){

2184 
b
;

2185 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[
i
+1], &
b
ËË 
TCL_ERROR
;

2186 if–
b
 ){

2187 
Êags
 &~(
SQLITE4_OPEN_READWRITE
|
SQLITE4_OPEN_CREATE
);

2188 
Êags
 |
SQLITE4_OPEN_READONLY
;

2190 
Êags
 &~
SQLITE4_OPEN_READONLY
;

2191 
Êags
 |
SQLITE4_OPEN_READWRITE
;

2193 }if–
	`°rcmp
(
zArg
, "-create")==0 ){

2194 
b
;

2195 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[
i
+1], &
b
ËË 
TCL_ERROR
;

2196 if–
b
 && (
Êags
 & 
SQLITE4_OPEN_READONLY
)==0 ){

2197 
Êags
 |
SQLITE4_OPEN_CREATE
;

2199 
Êags
 &~
SQLITE4_OPEN_CREATE
;

2202 
	`T˛_AµídResu…
(
öãΩ
, "unknow¿›ti⁄: ", 
zArg
, (*)0);

2203  
TCL_ERROR
;

2206 if–
objc
<3 || (objc&1)!=1 ){

2207 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
,

2210 #ifde‡
SQLITE4_HAS_CODEC


2214  
TCL_ERROR
;

2216 
zEºMsg
 = 0;

2217 
p
 = (
SqlôeDb
*)
	`T˛_AŒoc
( (*p) );

2218 if–
p
==0 ){

2219 
	`T˛_SëResu…
(
öãΩ
, "mÆlo¯Áûed", 
TCL_STATIC
);

2220  
TCL_ERROR
;

2222 
	`mem£t
(
p
, 0, (*p));

2223 
zFûe
 = 
	`T˛_GëSåögFromObj
(
objv
[2], 0);

2224 
zFûe
 = 
	`T˛_Tøn¶©eFûeName
(
öãΩ
, zFûe, &
å™¶©edFûíame
);

2225 
	`sqlôe4_›í
(0, 
zFûe
, &
p
->
db
, 0);

2226 
	`T˛_DSåögFªe
(&
å™¶©edFûíame
);

2227 if–
SQLITE4_OK
!=
	`sqlôe4_îrcode
(
p
->
db
) ){

2228 
zEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "%s", 
	`sqlôe4_îrmsg
(
p
->
db
));

2229 
	`sqlôe4_˛o£
(
p
->
db
, 0);

2230 
p
->
db
 = 0;

2232 #ifde‡
SQLITE4_TEST


2234 
	`sqlôe4ã°_ö°Æl_ã°_fun˘i⁄s
(
sqlôe4
*);

2235 
	`sqlôe4ã°_ö°Æl_ã°_fun˘i⁄s
(
p
->
db
);

2238 #ifde‡
SQLITE4_HAS_CODEC


2239 if–
p
->
db
 ){

2240 
	`sqlôe4_key
(
p
->
db
, 
pKey
, 
nKey
);

2243 if–
p
->
db
==0 ){

2244 
	`T˛_SëResu…
(
öãΩ
, 
zEºMsg
, 
TCL_VOLATILE
);

2245 
	`T˛_Fªe
((*)
p
);

2246 
	`sqlôe4_‰ì
(0, 
zEºMsg
);

2247  
TCL_ERROR
;

2249 
p
->
maxStmt
 = 
NUM_PREPARED_STMTS
;

2250 
p
->
öãΩ
 = interp;

2251 
zArg
 = 
	`T˛_GëSåögFromObj
(
objv
[1], 0);

2252 if–
	`DbU£Nª
() ){

2253 
	`T˛_NRCª©eComm™d
(
öãΩ
, 
zArg
, 
DbObjCmdAd≠t‹
, 
DbObjCmd
,

2254 (*)
p
, 
DbDñëeCmd
);

2256 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
zArg
, 
DbObjCmd
, (*)
p
, 
DbDñëeCmd
);

2258  
TCL_OK
;

2259 
	}
}

2265 #i‚de‡
USE_TCL_STUBS


2266 #unde‡
T˛_InôStubs


2267 
	#T˛_InôStubs
(
a
,
b
,
c
)

	)

2275 #i‚de‡
PACKAGE_VERSION


2276 
	#PACKAGE_VERSION
 
SQLITE4_VERSION


	)

2290 
EXTERN
 
	$Sqlôe3_Inô
(
T˛_I¡îp
 *
öãΩ
){

2291 
	`T˛_InôStubs
(
öãΩ
, "8.4", 0);

2292 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sqlôe4", (
T˛_ObjCmdProc
*)
DbMaö
, 0, 0);

2293 
	`T˛_PkgProvide
(
öãΩ
, "sqlôe4", 
PACKAGE_VERSION
);

2295 #i‚de‡
SQLITE4_3_SUFFIX_ONLY


2300 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sqlôe", (
T˛_ObjCmdProc
*)
DbMaö
, 0, 0);

2303  
TCL_OK
;

2304 
	}
}

2305 
EXTERN
 
	$T˛sqlôe4_Inô
(
T˛_I¡îp
 *
öãΩ
){  
	`Sqlôe3_Inô
(öãΩ); 
	}
}

2306 
EXTERN
 
	$Sqlôe3_Sa„Inô
(
T˛_I¡îp
 *
öãΩ
){  
TCL_OK
; 
	}
}

2307 
EXTERN
 
	$T˛sqlôe4_Sa„Inô
(
T˛_I¡îp
 *
öãΩ
){  
TCL_OK
; 
	}
}

2308 
EXTERN
 
	$Sqlôe3_U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
; 
	}
}

2309 
EXTERN
 
	$T˛sqlôe4_U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
; 
	}
}

2310 
EXTERN
 
	$Sqlôe3_Sa„U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
; 
	}
}

2311 
EXTERN
 
	$T˛sqlôe4_Sa„U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
;
	}
}

2314 #i‚de‡
SQLITE4_3_SUFFIX_ONLY


2315 
	$Sqlôe_Inô
(
T˛_I¡îp
 *
öãΩ
){  
	`Sqlôe3_Inô
(öãΩ); 
	}
}

2316 
	$T˛sqlôe_Inô
(
T˛_I¡îp
 *
öãΩ
){  
	`Sqlôe3_Inô
(öãΩ); 
	}
}

2317 
	$Sqlôe_Sa„Inô
(
T˛_I¡îp
 *
öãΩ
){  
TCL_OK
; 
	}
}

2318 
	$T˛sqlôe_Sa„Inô
(
T˛_I¡îp
 *
öãΩ
){  
TCL_OK
; 
	}
}

2319 
	$Sqlôe_U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
; 
	}
}

2320 
	$T˛sqlôe_U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
; 
	}
}

2321 
	$Sqlôe_Sa„U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
; 
	}
}

2322 
	$T˛sqlôe_Sa„U∆ﬂd
(
T˛_I¡îp
 *
öãΩ
, 
Êags
){  
TCL_OK
;
	}
}

2325 #ifde‡
TCLSH


2334 #i‡
deföed
(
SQLITE4_TEST
Ë|| deföed(
SQLITE4_TCLMD5
)

2360 #i‚de‡
uöt32


2361 
	#uöt32
 

	)

2364 
	sMD5C⁄ãxt
 {

2365 
	misInô
;

2366 
uöt32
 
	mbuf
[4];

2367 
uöt32
 
	mbôs
[2];

2368 
	mö
[64];

2370 
MD5C⁄ãxt
 
	tMD5C⁄ãxt
;

2375 
	$byãRevî£
 (*
buf
, 
l⁄gs
){

2376 
uöt32
 
t
;

2378 
t
 = (
uöt32
)(()
buf
[3]<<8 | buf[2]) << 16 |

2379 (()
buf
[1]<<8 | buf[0]);

2380 *(
uöt32
 *)
buf
 = 
t
;

2381 
buf
 += 4;

2382 } --
l⁄gs
);

2383 
	}
}

2387 
	#F1
(
x
, 
y
, 
z
Ë(z ^ (x & (y ^ z)))

	)

2388 
	#F2
(
x
, 
y
, 
z
Ë
	`F1
(z, x, y)

	)

2389 
	#F3
(
x
, 
y
, 
z
Ë(x ^ y ^ z)

	)

2390 
	#F4
(
x
, 
y
, 
z
Ë(y ^ (x | ~z))

	)

2393 
	#MD5STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
d©a
, 
s
) \

2394 –
w
 +
	`f
(
x
, 
y
, 
z
Ë+ 
d©a
, w = w<<
s
 | w>>(32-s), w +x )

	)

2401 
	$MD5Tønsf‹m
(
uöt32
 
buf
[4], c⁄° uöt32 
ö
[16]){

2402 
uöt32
 
a
, 
b
, 
c
, 
d
;

2404 
a
 = 
buf
[0];

2405 
b
 = 
buf
[1];

2406 
c
 = 
buf
[2];

2407 
d
 = 
buf
[3];

2409 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 0]+0xd76aa478, 7);

2410 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 1]+0xe8c7b756, 12);

2411 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 2]+0x242070db, 17);

2412 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 3]+0xc1bdceee, 22);

2413 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 4]+0xf57c0faf, 7);

2414 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 5]+0x4787c62a, 12);

2415 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 6]+0xa8304613, 17);

2416 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 7]+0xfd469501, 22);

2417 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 8]+0x698098d8, 7);

2418 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 9]+0x8b44f7af, 12);

2419 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[10]+0xffff5bb1, 17);

2420 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[11]+0x895cd7be, 22);

2421 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
ö
[12]+0x6b901122, 7);

2422 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
ö
[13]+0xfd987193, 12);

2423 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
ö
[14]+0xa679438e, 17);

2424 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
ö
[15]+0x49b40821, 22);

2426 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 1]+0xf61e2562, 5);

2427 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 6]+0xc040b340, 9);

2428 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[11]+0x265e5a51, 14);

2429 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 0]+0xe9b6c7aa, 20);

2430 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 5]+0xd62f105d, 5);

2431 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[10]+0x02441453, 9);

2432 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[15]+0xd8a1e681, 14);

2433 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 4]+0xe7d3fbc8, 20);

2434 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 9]+0x21e1cde6, 5);

2435 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[14]+0xc33707d6, 9);

2436 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 3]+0xf4d50d87, 14);

2437 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 8]+0x455a14ed, 20);

2438 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
ö
[13]+0xa9e3e905, 5);

2439 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 2]+0xfcefa3f8, 9);

2440 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 7]+0x676f02d9, 14);

2441 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
ö
[12]+0x8d2a4c8a, 20);

2443 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 5]+0xfffa3942, 4);

2444 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 8]+0x8771f681, 11);

2445 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[11]+0x6d9d6122, 16);

2446 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[14]+0xfde5380c, 23);

2447 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 1]+0xa4beea44, 4);

2448 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 4]+0x4bdecfa9, 11);

2449 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 7]+0xf6bb4b60, 16);

2450 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[10]+0xbebfbc70, 23);

2451 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[13]+0x289b7ec6, 4);

2452 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 0]+0xeaa127fa, 11);

2453 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 3]+0xd4ef3085, 16);

2454 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 6]+0x04881d05, 23);

2455 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 9]+0xd9d4d039, 4);

2456 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
ö
[12]+0xe6db99e5, 11);

2457 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
ö
[15]+0x1fa27cf8, 16);

2458 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 2]+0xc4ac5665, 23);

2460 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 0]+0xf4292244, 6);

2461 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 7]+0x432aff97, 10);

2462 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[14]+0xab9423a7, 15);

2463 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 5]+0xfc93a039, 21);

2464 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[12]+0x655b59c3, 6);

2465 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[ 3]+0x8f0ccc92, 10);

2466 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[10]+0xffeff47d, 15);

2467 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 1]+0x85845dd1, 21);

2468 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 8]+0x6fa87e4f, 6);

2469 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[15]+0xfe2ce6e0, 10);

2470 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 6]+0xa3014314, 15);

2471 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[13]+0x4e0811a1, 21);

2472 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
ö
[ 4]+0xf7537e82, 6);

2473 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
ö
[11]+0xbd3af235, 10);

2474 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
ö
[ 2]+0x2ad7d2bb, 15);

2475 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
ö
[ 9]+0xeb86d391, 21);

2477 
buf
[0] +
a
;

2478 
buf
[1] +
b
;

2479 
buf
[2] +
c
;

2480 
buf
[3] +
d
;

2481 
	}
}

2487 
	$MD5Inô
(
MD5C⁄ãxt
 *
˘x
){

2488 
˘x
->
isInô
 = 1;

2489 
˘x
->
buf
[0] = 0x67452301;

2490 
˘x
->
buf
[1] = 0xefcdab89;

2491 
˘x
->
buf
[2] = 0x98badcfe;

2492 
˘x
->
buf
[3] = 0x10325476;

2493 
˘x
->
bôs
[0] = 0;

2494 
˘x
->
bôs
[1] = 0;

2495 
	}
}

2502 
	$MD5Upd©e
(
MD5C⁄ãxt
 *
˘x
, c⁄° *
buf
, 
Àn
){

2503 
uöt32
 
t
;

2507 
t
 = 
˘x
->
bôs
[0];

2508 i‡((
˘x
->
bôs
[0] = 
t
 + ((
uöt32
)
Àn
 << 3)) <Å)

2509 
˘x
->
bôs
[1]++;

2510 
˘x
->
bôs
[1] +
Àn
 >> 29;

2512 
t
 = (t >> 3) & 0x3f;

2516 i‡–
t
 ) {

2517 *
p
 = (*)
˘x
->
ö
 + 
t
;

2519 
t
 = 64-t;

2520 i‡(
Àn
 < 
t
) {

2521 
	`mem˝y
(
p
, 
buf
, 
Àn
);

2524 
	`mem˝y
(
p
, 
buf
, 
t
);

2525 
	`byãRevî£
(
˘x
->
ö
, 16);

2526 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
uöt32
 *)˘x->
ö
);

2527 
buf
 +
t
;

2528 
Àn
 -
t
;

2533 
Àn
 >= 64) {

2534 
	`mem˝y
(
˘x
->
ö
, 
buf
, 64);

2535 
	`byãRevî£
(
˘x
->
ö
, 16);

2536 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
uöt32
 *)˘x->
ö
);

2537 
buf
 += 64;

2538 
Àn
 -= 64;

2543 
	`mem˝y
(
˘x
->
ö
, 
buf
, 
Àn
);

2544 
	}
}

2550 
	$MD5FöÆ
(
dige°
[16], 
MD5C⁄ãxt
 *
˘x
){

2551 
cou¡
;

2552 *
p
;

2555 
cou¡
 = (
˘x
->
bôs
[0] >> 3) & 0x3F;

2559 
p
 = 
˘x
->
ö
 + 
cou¡
;

2560 *
p
++ = 0x80;

2563 
cou¡
 = 64 - 1 - count;

2566 i‡(
cou¡
 < 8) {

2568 
	`mem£t
(
p
, 0, 
cou¡
);

2569 
	`byãRevî£
(
˘x
->
ö
, 16);

2570 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
uöt32
 *)˘x->
ö
);

2573 
	`mem£t
(
˘x
->
ö
, 0, 56);

2576 
	`mem£t
(
p
, 0, 
cou¡
-8);

2578 
	`byãRevî£
(
˘x
->
ö
, 14);

2581 ((
uöt32
 *)
˘x
->
ö
)[ 14 ] = ctx->
bôs
[0];

2582 ((
uöt32
 *)
˘x
->
ö
)[ 15 ] = ctx->
bôs
[1];

2584 
	`MD5Tønsf‹m
(
˘x
->
buf
, (
uöt32
 *)˘x->
ö
);

2585 
	`byãRevî£
((*)
˘x
->
buf
, 4);

2586 
	`mem˝y
(
dige°
, 
˘x
->
buf
, 16);

2587 
	`mem£t
(
˘x
, 0, (ctx));

2588 
	}
}

2593 
	$MD5Dige°ToBa£16
(*
dige°
, *
zBuf
){

2594 c⁄° 
zEncode
[] = "0123456789abcdef";

2595 
i
, 
j
;

2597 
j
=
i
=0; i<16; i++){

2598 
a
 = 
dige°
[
i
];

2599 
zBuf
[
j
++] = 
zEncode
[(
a
>>4)&0xf];

2600 
zBuf
[
j
++] = 
zEncode
[
a
 & 0xf];

2602 
zBuf
[
j
] = 0;

2603 
	}
}

2611 
	$MD5Dige°ToBa£10x8
(
dige°
[16], 
zDige°
[50]){

2612 
i
, 
j
;

2613 
x
;

2614 
i
=
j
=0; i<16; i+=2){

2615 
x
 = 
dige°
[
i
]*256 + digest[i+1];

2616 if–
i
>0 ) 
zDige°
[
j
++] = '-';

2617 
	`•rötf
(&
zDige°
[
j
], "%05u", 
x
);

2618 
j
 += 5;

2620 
zDige°
[
j
] = 0;

2621 
	}
}

2627 
	$md5_cmd
(*
cd
, 
T˛_I¡îp
 *
öãΩ
, 
¨gc
, c⁄° **
¨gv
){

2628 
MD5C⁄ãxt
 
˘x
;

2629 
dige°
[16];

2630 
zBuf
[50];

2631 (*
c⁄vîãr
)(*, *);

2633 if–
¨gc
!=2 ){

2634 
	`T˛_AµídResu…
(
öãΩ
,"wr⁄g #árgs: should bê\"", 
¨gv
[0],

2636  
TCL_ERROR
;

2638 
	`MD5Inô
(&
˘x
);

2639 
	`MD5Upd©e
(&
˘x
, (*)
¨gv
[1], ()
	`°æí
(argv[1]));

2640 
	`MD5FöÆ
(
dige°
, &
˘x
);

2641 
c⁄vîãr
 = ((*)(*,*))
cd
;

2642 
	`c⁄vîãr
(
dige°
, 
zBuf
);

2643 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, (*)0);

2644  
TCL_OK
;

2645 
	}
}

2651 
	$md5fûe_cmd
(*
cd
, 
T˛_I¡îp
*
öãΩ
, 
¨gc
, c⁄° **
¨gv
){

2652 
FILE
 *
ö
;

2653 
MD5C⁄ãxt
 
˘x
;

2654 (*
c⁄vîãr
)(*, *);

2655 
dige°
[16];

2656 
zBuf
[10240];

2658 if–
¨gc
!=2 ){

2659 
	`T˛_AµídResu…
(
öãΩ
,"wr⁄g #árgs: should bê\"", 
¨gv
[0],

2661  
TCL_ERROR
;

2663 
ö
 = 
	`f›í
(
¨gv
[1],"rb");

2664 if–
ö
==0 ){

2665 
	`T˛_AµídResu…
(
öãΩ
,"u«bÀÅÿ›í fûê\"", 
¨gv
[1],

2667  
TCL_ERROR
;

2669 
	`MD5Inô
(&
˘x
);

2671 
n
;

2672 
n
 = 
	`‰ód
(
zBuf
, 1, (zBuf), 
ö
);

2673 if–
n
<=0 ) ;

2674 
	`MD5Upd©e
(&
˘x
, (*)
zBuf
, ()
n
);

2676 
	`f˛o£
(
ö
);

2677 
	`MD5FöÆ
(
dige°
, &
˘x
);

2678 
c⁄vîãr
 = ((*)(*,*))
cd
;

2679 
	`c⁄vîãr
(
dige°
, 
zBuf
);

2680 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, (*)0);

2681  
TCL_OK
;

2682 
	}
}

2688 
	$Md5_Inô
(
T˛_I¡îp
 *
öãΩ
){

2689 
	`T˛_Cª©eComm™d
(
öãΩ
, "md5", (
T˛_CmdProc
*)
md5_cmd
,

2690 
MD5Dige°ToBa£16
, 0);

2691 
	`T˛_Cª©eComm™d
(
öãΩ
, "md5-10x8", (
T˛_CmdProc
*)
md5_cmd
,

2692 
MD5Dige°ToBa£10x8
, 0);

2693 
	`T˛_Cª©eComm™d
(
öãΩ
, "md5fûe", (
T˛_CmdProc
*)
md5fûe_cmd
,

2694 
MD5Dige°ToBa£16
, 0);

2695 
	`T˛_Cª©eComm™d
(
öãΩ
, "md5fûe-10x8", (
T˛_CmdProc
*)
md5fûe_cmd
,

2696 
MD5Dige°ToBa£10x8
, 0);

2697  
TCL_OK
;

2698 
	}
}

2701 #i‡
deföed
(
SQLITE4_TEST
)

2706 
	$md5°ï
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

2707 
MD5C⁄ãxt
 *
p
;

2708 
i
;

2709 if–
¨gc
<1 ) ;

2710 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*p));

2711 if–
p
==0 ) ;

2712 if–!
p
->
isInô
 ){

2713 
	`MD5Inô
(
p
);

2715 
i
=0; i<
¨gc
; i++){

2716 c⁄° *
zD©a
 = (*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], 0);

2717 if–
zD©a
 ){

2718 
	`MD5Upd©e
(
p
, (*)
zD©a
, 
	`°æí
(zData));

2721 
	}
}

2722 
	$md5föÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

2723 
MD5C⁄ãxt
 *
p
;

2724 
dige°
[16];

2725 
zBuf
[33];

2726 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*p));

2727 
	`MD5FöÆ
(
dige°
,
p
);

2728 
	`MD5Dige°ToBa£16
(
dige°
, 
zBuf
);

2729 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

2730 
	}
}

2731 
	$Md5_Regi°î
(
sqlôe4
 *
db
){

2732 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "md5sum", -1, 0, 0,

2733 
md5°ï
, 
md5föÆize
, 0);

2734 
	`sqlôe4_ovîlﬂd_fun˘i⁄
(
db
, "md5sum", -1);

2735  
rc
;

2736 
	}
}

2746 #i‡
TCLSH
==1

2747 c⁄° *
	$t˛sh_maö_lo›
(){

2748 c⁄° 
zMaölo›
[] =

2770  
zMaölo›
;

2771 
	}
}

2773 #i‡
TCLSH
==2

2774 c⁄° *
t˛sh_maö_lo›
();

2777 #ifde‡
SQLITE4_TEST


2778 
öô_Æl
(
T˛_I¡îp
 *);

2779 
	$öô_Æl_cmd
(

2780 
Clõ¡D©a
 
cd
,

2781 
T˛_I¡îp
 *
öãΩ
,

2782 
objc
,

2783 
T˛_Obj
 *
CONST
 
objv
[]

2786 
T˛_I¡îp
 *
¶ave
;

2787 if–
objc
!=2 ){

2788 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SLAVE");

2789  
TCL_ERROR
;

2792 
¶ave
 = 
	`T˛_GëSœve
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]));

2793 if–!
¶ave
 ){

2794  
TCL_ERROR
;

2797 
	`öô_Æl
(
¶ave
);

2798  
TCL_OK
;

2799 
	}
}

2810 
	$db_u£_Àgacy_¥ï¨e_cmd
(

2811 
Clõ¡D©a
 
cd
,

2812 
T˛_I¡îp
 *
öãΩ
,

2813 
objc
,

2814 
T˛_Obj
 *
CONST
 
objv
[]

2816 
T˛_CmdInfo
 
cmdInfo
;

2817 
SqlôeDb
 *
pDb
;

2818 
bPª∑ª
;

2820 if–
objc
!=3 ){

2821 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB BOOLEAN");

2822  
TCL_ERROR
;

2825 if–!
	`T˛_GëComm™dInfo
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
cmdInfo
) ){

2826 
	`T˛_AµídResu…
(
öãΩ
, "nÿsuch db: ", 
	`T˛_GëSåög
(
objv
[1]), (*)0);

2827  
TCL_ERROR
;

2829 
pDb
 = (
SqlôeDb
*)
cmdInfo
.
objClõ¡D©a
;

2830 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[2], &
bPª∑ª
) ){

2831  
TCL_ERROR
;

2834 
	`T˛_Re£tResu…
(
öãΩ
);

2835  
TCL_OK
;

2836 
	}
}

2850 
	$öô_Æl
(
T˛_I¡îp
 *
öãΩ
){

2851 
	`Sqlôe3_Inô
(
öãΩ
);

2853 #i‡
	`deföed
(
SQLITE4_TEST
Ë|| deföed(
SQLITE4_TCLMD5
)

2854 
	`Md5_Inô
(
öãΩ
);

2857 #ifde‡
SQLITE4_TEST


2859 
	`Sqlôec⁄fig_Inô
(
T˛_I¡îp
*);

2860 
	`Sqlôëe°1_Inô
(
T˛_I¡îp
*);

2861 
	`Sqlôëe°4_Inô
(
T˛_I¡îp
*);

2862 
	`Sqlôëe°5_Inô
(
T˛_I¡îp
*);

2863 
	`Sqlôëe°9_Inô
(
T˛_I¡îp
*);

2864 
	`Sqlôëe°_func_Inô
(
T˛_I¡îp
*);

2865 
	`Sqlôëe°_hexio_Inô
(
T˛_I¡îp
*);

2866 
	`Sqlôëe°_mÆloc_Inô
(
T˛_I¡îp
*);

2867 
	`Sqlôëe°_muãx_Inô
(
T˛_I¡îp
*);

2868 
	`Sqlôëe°schema_Inô
(
T˛_I¡îp
*);

2869 
	`Sqlôëe°s£_Inô
(
T˛_I¡îp
*);

2870 
	`Sqlôëe°t˛v¨_Inô
(
T˛_I¡îp
*);

2871 
	`Sqlôëe°Thªad_Inô
(
T˛_I¡îp
*);

2872 
	`Sqlôëe°öèºay_Inô
(
T˛_I¡îp
*);

2873 
	`Sqlôëe°πªe_Inô
(
T˛_I¡îp
*);

2874 
	`SqlôequŸa_Inô
(
T˛_I¡îp
*);

2875 
	`SqlôeSu≥æock_Inô
(
T˛_I¡îp
*);

2876 
	`Sqlôëe°SysˇŒ_Inô
(
T˛_I¡îp
*);

2877 
	`Sqlôëe°°‹age_Inô
(
T˛_I¡îp
*);

2878 
	`Sqlôëe°°‹age2_Inô
(
T˛_I¡îp
*);

2879 
	`Sqlôëe°Lsm_Inô
(
T˛_I¡îp
*);

2881 
	`sqlôe4Te°Inô
(
T˛_I¡îp
*);

2883 
	`Sqlôec⁄fig_Inô
(
öãΩ
);

2884 
	`Sqlôëe°1_Inô
(
öãΩ
);

2885 
	`Sqlôëe°4_Inô
(
öãΩ
);

2886 
	`Sqlôëe°5_Inô
(
öãΩ
);

2887 
	`Sqlôëe°9_Inô
(
öãΩ
);

2888 
	`Sqlôëe°_hexio_Inô
(
öãΩ
);

2889 
	`Sqlôëe°_mÆloc_Inô
(
öãΩ
);

2890 
	`Sqlôëe°_muãx_Inô
(
öãΩ
);

2891 
	`Sqlôëe°Thªad_Inô
(
öãΩ
);

2892 
	`Sqlôëe°°‹age_Inô
(
öãΩ
);

2893 
	`Sqlôëe°°‹age2_Inô
(
öãΩ
);

2894 
	`Sqlôëe°Lsm_Inô
(
öãΩ
);

2895 
	`sqlôe4Te°Inô
(
öãΩ
);

2897 
	`T˛_Cª©eObjComm™d
(

2898 
öãΩ
, "lﬂd_ã°fixtuª_exãnsi⁄s", 
öô_Æl_cmd
, 0, 0

2900 
	`T˛_Cª©eObjComm™d
(

2901 
öãΩ
, "db_u£_Àgacy_¥ï¨e", 
db_u£_Àgacy_¥ï¨e_cmd
, 0, 0

2904 #ifde‡
SQLITE4_SSE


2905 
	`Sqlôëe°s£_Inô
(
öãΩ
);

2909 
	}
}

2911 
	#TCLSH_MAIN
 
maö


	)

2912 
	$TCLSH_MAIN
(
¨gc
, **
¨gv
){

2913 
T˛_I¡îp
 *
öãΩ
;

2918 
	`sqlôe4_shutdown
(0);

2921 
öãΩ
 = 
	`T˛_Cª©eI¡îp
();

2923 #i‡
TCLSH
==2

2924 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_SINGLETHREAD
);

2927 
	`öô_Æl
(
öãΩ
);

2928 if–
¨gc
>=2 ){

2929 
i
;

2930 
zArgc
[32];

2931 
	`sqlôe4_¢¥ötf
(
zArgc
, (zArgc), "%d", 
¨gc
-(3-
TCLSH
));

2932 
	`T˛_SëV¨
(
öãΩ
,"¨gc", 
zArgc
, 
TCL_GLOBAL_ONLY
);

2933 
	`T˛_SëV¨
(
öãΩ
,"¨gv0",
¨gv
[1],
TCL_GLOBAL_ONLY
);

2934 
	`T˛_SëV¨
(
öãΩ
,"¨gv", "", 
TCL_GLOBAL_ONLY
);

2935 
i
=3-
TCLSH
; i<
¨gc
; i++){

2936 
	`T˛_SëV¨
(
öãΩ
, "¨gv", 
¨gv
[
i
],

2937 
TCL_GLOBAL_ONLY
 | 
TCL_LIST_ELEMENT
 | 
TCL_APPEND_VALUE
);

2939 if–
TCLSH
==1 && 
	`T˛_EvÆFûe
(
öãΩ
, 
¨gv
[1])!=
TCL_OK
 ){

2940 c⁄° *
zInfo
 = 
	`T˛_GëV¨
(
öãΩ
, "îr‹Info", 
TCL_GLOBAL_ONLY
);

2941 if–
zInfo
==0 ) zInfÿ
	`T˛_GëSåögResu…
(
öãΩ
);

2942 
	`Ârötf
(
°dîr
,"%s: %s\n", *
¨gv
, 
zInfo
);

2943 
	`T˛_DñëeI¡îp
–
öãΩ
 );

2947 if–
TCLSH
==2 || 
¨gc
<=1 ){

2948 
	`T˛_GlobÆEvÆ
(
öãΩ
, 
	`t˛sh_maö_lo›
());

2950 
	`T˛_DñëeI¡îp
–
öãΩ
 );

2952 
	}
}

	@src/tokenize.c

18 
	~"sqlôeI¡.h
"

19 
	~<°dlib.h
>

28 #ifde‡
SQLITE4_ASCII


29 
	#ch¨M≠
(
X
Ë
sqlôe4UµîToLowî
[()X]

	)

31 #ifde‡
SQLITE4_EBCDIC


32 
	#ch¨M≠
(
X
Ë
ebcdicToAscii
[()X]

	)

33 c⁄° 
	gebcdicToAscii
[] = {

65 
	~"keyw‹dhash.h
"

84 #ifde‡
SQLITE4_ASCII


85 
	#IdCh¨
(
C
Ë((
sqlôe4Cty≥M≠
[()C]&0x46)!=0)

	)

87 #ifde‡
SQLITE4_EBCDIC


88 c⁄° 
	gsqlôe4IsEbcdicIdCh¨
[] = {

103 
	#IdCh¨
(
C
Ë(((
c
=C)>=0x42 && 
sqlôe4IsEbcdicIdCh¨
[c-0x40]))

	)

111 
	$sqlôe4GëTokí
(c⁄° *
z
, *
tokíTy≥
){

112 
i
, 
c
;

113  *
z
 ){

115 
	`ã°ˇ£
–
z
[0]==' ' );

116 
	`ã°ˇ£
–
z
[0]=='\t' );

117 
	`ã°ˇ£
–
z
[0]=='\n' );

118 
	`ã°ˇ£
–
z
[0]=='\f' );

119 
	`ã°ˇ£
–
z
[0]=='\r' );

120 
i
=1; 
	`sqlôe4Is•a˚
(
z
[i]); i++){}

121 *
tokíTy≥
 = 
TK_SPACE
;

122  
i
;

125 if–
z
[1]=='-' ){

127 
i
=2; (
c
=
z
[i])!=0 && c!='\n'; i++){}

128 *
tokíTy≥
 = 
TK_SPACE
;

129  
i
;

131 *
tokíTy≥
 = 
TK_MINUS
;

135 *
tokíTy≥
 = 
TK_LP
;

139 *
tokíTy≥
 = 
TK_RP
;

143 *
tokíTy≥
 = 
TK_SEMI
;

147 *
tokíTy≥
 = 
TK_PLUS
;

151 *
tokíTy≥
 = 
TK_STAR
;

155 if–
z
[1]!='*' || z[2]==0 ){

156 *
tokíTy≥
 = 
TK_SLASH
;

160 
i
=3, 
c
=
z
[2]; (c!='*' || z[i]!='/') && (c=z[i])!=0; i++){}

161 if–
c
 ) 
i
++;

162 *
tokíTy≥
 = 
TK_SPACE
;

163  
i
;

166 *
tokíTy≥
 = 
TK_REM
;

170 *
tokíTy≥
 = 
TK_EQ
;

171  1 + (
z
[1]=='=');

174 if–(
c
=
z
[1])=='=' ){

175 *
tokíTy≥
 = 
TK_LE
;

177 }if–
c
=='>' ){

178 *
tokíTy≥
 = 
TK_NE
;

180 }if–
c
=='<' ){

181 *
tokíTy≥
 = 
TK_LSHIFT
;

184 *
tokíTy≥
 = 
TK_LT
;

189 if–(
c
=
z
[1])=='=' ){

190 *
tokíTy≥
 = 
TK_GE
;

192 }if–
c
=='>' ){

193 *
tokíTy≥
 = 
TK_RSHIFT
;

196 *
tokíTy≥
 = 
TK_GT
;

201 if–
z
[1]!='=' ){

202 *
tokíTy≥
 = 
TK_ILLEGAL
;

205 *
tokíTy≥
 = 
TK_NE
;

210 if–
z
[1]!='|' ){

211 *
tokíTy≥
 = 
TK_BITOR
;

214 *
tokíTy≥
 = 
TK_CONCAT
;

219 *
tokíTy≥
 = 
TK_COMMA
;

223 *
tokíTy≥
 = 
TK_BITAND
;

227 *
tokíTy≥
 = 
TK_BITNOT
;

232 
dñim
 = 
z
[0];

233 
	`ã°ˇ£
–
dñim
=='`' );

234 
	`ã°ˇ£
–
dñim
=='\'' );

235 
	`ã°ˇ£
–
dñim
=='"' );

236 
i
=1; (
c
=
z
[i])!=0; i++){

237 if–
c
==
dñim
 ){

238 if–
z
[
i
+1]==
dñim
 ){

239 
i
++;

245 if–
c
=='\'' ){

246 *
tokíTy≥
 = 
TK_STRING
;

247  
i
+1;

248 }if–
c
!=0 ){

249 *
tokíTy≥
 = 
TK_ID
;

250  
i
+1;

252 *
tokíTy≥
 = 
TK_ILLEGAL
;

253  
i
;

257 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


258 if–!
	`sqlôe4Isdigô
(
z
[1]) )

261 *
tokíTy≥
 = 
TK_DOT
;

269 
	`ã°ˇ£
–
z
[0]=='0' );Åestcase( z[0]=='1' );Åestcase( z[0]=='2' );

270 
	`ã°ˇ£
–
z
[0]=='3' );Åestcase( z[0]=='4' );Åestcase( z[0]=='5' );

271 
	`ã°ˇ£
–
z
[0]=='6' );Åestcase( z[0]=='7' );Åestcase( z[0]=='8' );

272 
	`ã°ˇ£
–
z
[0]=='9' );

273 *
tokíTy≥
 = 
TK_INTEGER
;

274 
i
=0; 
	`sqlôe4Isdigô
(
z
[i]); i++){}

275 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


276 if–
z
[
i
]=='.' ){

277 
i
++;

278  
	`sqlôe4Isdigô
(
z
[
i
]) ){ i++; }

279 *
tokíTy≥
 = 
TK_FLOAT
;

281 if–(
z
[
i
]=='e' || z[i]=='E') &&

282 –
	`sqlôe4Isdigô
(
z
[
i
+1])

283 || ((
z
[
i
+1]=='+' || z[i+1]=='-'Ë&& 
	`sqlôe4Isdigô
(z[i+2]))

286 
i
 += 2;

287  
	`sqlôe4Isdigô
(
z
[
i
]) ){ i++; }

288 *
tokíTy≥
 = 
TK_FLOAT
;

291  
	`IdCh¨
(
z
[
i
]) ){

292 *
tokíTy≥
 = 
TK_ILLEGAL
;

293 
i
++;

295  
i
;

298 
i
=1, 
c
=
z
[0]; c!=']' && (c=z[i])!=0; i++){}

299 *
tokíTy≥
 = 
c
==']' ? 
TK_ID
 : 
TK_ILLEGAL
;

300  
i
;

303 *
tokíTy≥
 = 
TK_VARIABLE
;

304 
i
=1; 
	`sqlôe4Isdigô
(
z
[i]); i++){}

305  
i
;

308 
i
=1; 
	`sqlôe4Isdigô
(
z
[i]); i++){}

309 if–
i
>1 ){

312 *
tokíTy≥
 = 
TK_REGISTER
;

313  
i
;

318 #i‚de‡
SQLITE4_OMIT_TCL_VARIABLE


323 
n
 = 0;

324 
	`ã°ˇ£
–
z
[0]=='$' );Åestcase( z[0]=='@' );Åestcase( z[0]==':' );

325 *
tokíTy≥
 = 
TK_VARIABLE
;

326 
i
=1; (
c
=
z
[i])!=0; i++){

327 if–
	`IdCh¨
(
c
) ){

328 
n
++;

329 #i‚de‡
SQLITE4_OMIT_TCL_VARIABLE


330 }if–
c
=='(' && 
n
>0 ){

332 
i
++;

333 } (
c
=
z
[
i
])!=0 && !
	`sqlôe4Is•a˚
(c) && c!=')' );

334 if–
c
==')' ){

335 
i
++;

337 *
tokíTy≥
 = 
TK_ILLEGAL
;

340 }if–
c
==':' && 
z
[
i
+1]==':' ){

341 
i
++;

347 if–
n
==0 ) *
tokíTy≥
 = 
TK_ILLEGAL
;

348  
i
;

350 #i‚de‡
SQLITE4_OMIT_BLOB_LITERAL


352 
	`ã°ˇ£
–
z
[0]=='x' );Åestcase( z[0]=='X' );

353 if–
z
[1]=='\'' ){

354 *
tokíTy≥
 = 
TK_BLOB
;

355 
i
=2; 
	`sqlôe4Isxdigô
(
z
[i]); i++){}

356 if–
z
[
i
]!='\'' || i%2 ){

357 *
tokíTy≥
 = 
TK_ILLEGAL
;

358  
z
[
i
] && z[i]!='\'' ){ i++; }

360 if–
z
[
i
] ) i++;

361  
i
;

367 if–!
	`IdCh¨
(*
z
) ){

370 
i
=1; 
	`IdCh¨
(
z
[i]); i++){}

371 *
tokíTy≥
 = 
	`keyw‹dCode
((*)
z
, 
i
);

372  
i
;

375 *
tokíTy≥
 = 
TK_ILLEGAL
;

377 
	}
}

386 
	$sqlôe4RunP¨£r
(
P¨£
 *
pP¨£
, c⁄° *
zSql
, **
pzEºMsg
){

387 
nEº
 = 0;

388 
i
;

389 *
pEngöe
;

390 
tokíTy≥
;

391 
œ°TokíP¨£d
 = -1;

392 
u8
 
íabÀLookaside
;

393 
sqlôe4
 *
db
 = 
pP¨£
->db;

394 
mxSqlLí
;

397 
mxSqlLí
 = 
db
->
aLimô
[
SQLITE4_LIMIT_SQL_LENGTH
];

398 if–
db
->
a˘iveVdbeC¡
==0 ){

399 
db
->
u1
.
isI¡îru±ed
 = 0;

401 
pP¨£
->
rc
 = 
SQLITE4_OK
;

402 
pP¨£
->
zTaû
 = 
zSql
;

403 
i
 = 0;

404 
	`as£π
–
pzEºMsg
!=0 );

405 
pEngöe
 = 
	`sqlôe4P¨£rAŒoc
((*(*)(*,
size_t
))
sqlôe4_mÆloc
,
db
->
pEnv
);

406 if–
pEngöe
==0 ){

407 
db
->
mÆlocFaûed
 = 1;

408  
SQLITE4_NOMEM
;

410 
	`as£π
–
pP¨£
->
pNewTabÀ
==0 );

411 
	`as£π
–
pP¨£
->
pNewTriggî
==0 );

412 
	`as£π
–
pP¨£
->
nV¨
==0 );

413 
	`as£π
–
pP¨£
->
nzV¨
==0 );

414 
	`as£π
–
pP¨£
->
azV¨
==0 );

415 
íabÀLookaside
 = 
db
->
lookaside
.
bE«bÀd
;

416 if–
db
->
lookaside
.
pSèπ
 ) db->lookaside.
bE«bÀd
 = 1;

417  !
db
->
mÆlocFaûed
 && 
zSql
[
i
]!=0 ){

418 
	`as£π
–
i
>=0 );

419 
pP¨£
->
sLa°Tokí
.
z
 = &
zSql
[
i
];

420 
pP¨£
->
sLa°Tokí
.
n
 = 
	`sqlôe4GëTokí
((*)&
zSql
[
i
],&
tokíTy≥
);

421 
i
 +
pP¨£
->
sLa°Tokí
.
n
;

422 if–
i
>
mxSqlLí
 ){

423 
pP¨£
->
rc
 = 
SQLITE4_TOOBIG
;

426  
tokíTy≥
 ){

427 
TK_SPACE
: {

428 if–
db
->
u1
.
isI¡îru±ed
 ){

429 
	`sqlôe4Eº‹Msg
(
pP¨£
, "interrupt");

430 
pP¨£
->
rc
 = 
SQLITE4_INTERRUPT
;

431 
ab‹t_∑r£
;

435 
TK_ILLEGAL
: {

436 
	`sqlôe4DbFªe
(
db
, *
pzEºMsg
);

437 *
pzEºMsg
 = 
	`sqlôe4MPrötf
(
db
, "unrecognizedÅoken: \"%T\"",

438 &
pP¨£
->
sLa°Tokí
);

439 
nEº
++;

440 
ab‹t_∑r£
;

442 
TK_SEMI
: {

443 
pP¨£
->
zTaû
 = &
zSql
[
i
];

447 
	`sqlôe4P¨£r
(
pEngöe
, 
tokíTy≥
, 
pP¨£
->
sLa°Tokí
,ÖParse);

448 
œ°TokíP¨£d
 = 
tokíTy≥
;

449 if–
pP¨£
->
rc
!=
SQLITE4_OK
 ){

450 
ab‹t_∑r£
;

456 
ab‹t_∑r£
:

457 if–
zSql
[
i
]==0 && 
nEº
==0 && 
pP¨£
->
rc
==
SQLITE4_OK
 ){

458 if–
œ°TokíP¨£d
!=
TK_SEMI
 ){

459 
	`sqlôe4P¨£r
(
pEngöe
, 
TK_SEMI
, 
pP¨£
->
sLa°Tokí
,ÖParse);

460 
pP¨£
->
zTaû
 = &
zSql
[
i
];

462 
	`sqlôe4P¨£r
(
pEngöe
, 0, 
pP¨£
->
sLa°Tokí
,ÖParse);

464 #i‡
YYTRACKMAXSTACKDEPTH


465 
	`sqlôe4SètusSë
(
SQLITE4_STATUS_PARSER_STACK
,

466 
	`sqlôe4P¨£rSèckPók
(
pEngöe
)

469 
	`sqlôe4P¨£rFªe
(
pEngöe
, ((*)(*,*))
sqlôe4_‰ì
);

470 
db
->
lookaside
.
bE«bÀd
 = 
íabÀLookaside
;

471 if–
db
->
mÆlocFaûed
 ){

472 
pP¨£
->
rc
 = 
SQLITE4_NOMEM
;

474 if–
pP¨£
->
rc
!=
SQLITE4_OK
 &&ÖP¨£->rc!=
SQLITE4_DONE
 &&ÖP¨£->
zEºMsg
==0 ){

475 
	`sqlôe4SëSåög
(&
pP¨£
->
zEºMsg
, 
db
, "%s", 
	`sqlôe4EºSå
’P¨£->
rc
));

477 
	`as£π
–
pzEºMsg
!=0 );

478 if–
pP¨£
->
zEºMsg
 ){

479 *
pzEºMsg
 = 
pP¨£
->
zEºMsg
;

480 
	`sqlôe4_log
(
db
->
pEnv
, 
pP¨£
->
rc
, "%s", *
pzEºMsg
);

481 
pP¨£
->
zEºMsg
 = 0;

482 
nEº
++;

484 if–
pP¨£
->
pVdbe
 &&ÖP¨£->
nEº
>0 &&ÖP¨£->
√°ed
==0 ){

485 
	`sqlôe4VdbeDñëe
(
pP¨£
->
pVdbe
);

486 
pP¨£
->
pVdbe
 = 0;

488 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


489 
	`sqlôe4_‰ì
(0, 
pP¨£
->
≠VèbLock
);

492 if–!
IN_DECLARE_VTAB
 ){

497 
	`sqlôe4DñëeTabÀ
(
db
, 
pP¨£
->
pNewTabÀ
);

500 
	`sqlôe4DñëeTriggî
(
db
, 
pP¨£
->
pNewTriggî
);

501 
i
=
pP¨£
->
nzV¨
-1; i>=0; i--Ë
	`sqlôe4DbFªe
(
db
,ÖP¨£->
azV¨
[i]);

502 
	`sqlôe4DbFªe
(
db
, 
pP¨£
->
azV¨
);

503 
	`sqlôe4DbFªe
(
db
, 
pP¨£
->
aAlüs
);

504  
pP¨£
->
pAöc
 ){

505 
AutoöcInfo
 *
p
 = 
pP¨£
->
pAöc
;

506 
pP¨£
->
pAöc
 = 
p
->
pNext
;

507 
	`sqlôe4DbFªe
(
db
, 
p
);

509  
pP¨£
->
pZombõTab
 ){

510 
TabÀ
 *
p
 = 
pP¨£
->
pZombõTab
;

511 
pP¨£
->
pZombõTab
 = 
p
->
pNextZombõ
;

512 
	`sqlôe4DñëeTabÀ
(
db
, 
p
);

514 if–
nEº
>0 && 
pP¨£
->
rc
==
SQLITE4_OK
 ){

515 
pP¨£
->
rc
 = 
SQLITE4_ERROR
;

517  
nEº
;

518 
	}
}

	@src/trigger.c

13 
	~"sqlôeI¡.h
"

15 #i‚de‡
SQLITE4_OMIT_TRIGGER


19 
	$sqlôe4DñëeTriggîSãp
(
sqlôe4
 *
db
, 
TriggîSãp
 *
pTriggîSãp
){

20  
pTriggîSãp
 ){

21 
TriggîSãp
 * 
pTmp
 = 
pTriggîSãp
;

22 
pTriggîSãp
 =ÖTriggîSãp->
pNext
;

24 
	`sqlôe4Ex¥Dñëe
(
db
, 
pTmp
->
pWhîe
);

25 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pTmp
->
pEx¥Li°
);

26 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pTmp
->
pSñe˘
);

27 
	`sqlôe4IdLi°Dñëe
(
db
, 
pTmp
->
pIdLi°
);

29 
	`sqlôe4DbFªe
(
db
, 
pTmp
);

31 
	}
}

47 
Triggî
 *
	$sqlôe4TriggîLi°
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
){

48 
Schema
 * c⁄° 
pTmpSchema
 = 
pP¨£
->
db
->
aDb
[1].
pSchema
;

49 
Triggî
 *
pLi°
 = 0;

51 if–
pP¨£
->
dißbÀTriggîs
 ){

55 if–
pTmpSchema
!=
pTab
->
pSchema
 ){

56 
HashEÀm
 *
p
;

57 
p
=
	`sqlôeHashFú°
(&
pTmpSchema
->
åigHash
);Ö;Ö=
	`sqlôeHashNext
(p)){

58 
Triggî
 *
pTrig
 = (Triggî *)
	`sqlôeHashD©a
(
p
);

59 if–
pTrig
->
pTabSchema
==
pTab
->
pSchema


60 && 0==
	`sqlôe4_°ricmp
(
pTrig
->
èbÀ
, 
pTab
->
zName
)

62 
pTrig
->
pNext
 = (
pLi°
 ?ÖLi° : 
pTab
->
pTriggî
);

63 
pLi°
 = 
pTrig
;

68  (
pLi°
 ?ÖLi° : 
pTab
->
pTriggî
);

69 
	}
}

79 
	$sqlôe4BegöTriggî
(

80 
P¨£
 *
pP¨£
,

81 
Tokí
 *
pName1
,

82 
Tokí
 *
pName2
,

83 
å_tm
,

84 
›
,

85 
IdLi°
 *
pCﬁumns
,

86 
SrcLi°
 *
pTabÀName
,

87 
Ex¥
 *
pWhí
,

88 
isTemp
,

89 
noEº


91 
Triggî
 *
pTriggî
 = 0;

92 
TabÀ
 *
pTab
;

93 *
zName
 = 0;

94 
sqlôe4
 *
db
 = 
pP¨£
->db;

95 
iDb
;

96 
Tokí
 *
pName
;

97 
DbFixî
 
sFix
;

98 
iTabDb
;

100 
	`as£π
–
pName1
!=0 );

101 
	`as£π
–
pName2
!=0 );

102 
	`as£π
–
›
==
TK_INSERT
 || op==
TK_UPDATE
 || op==
TK_DELETE
 );

103 
	`as£π
–
›
>0 && op<0xff );

104 if–
isTemp
 ){

106 if–
pName2
->
n
>0 ){

107 
	`sqlôe4Eº‹Msg
(
pP¨£
, "temporaryÅrigger mayÇot have qualifiedÇame");

108 
åiggî_˛ónup
;

110 
iDb
 = 1;

111 
pName
 = 
pName1
;

114 
iDb
 = 
	`sqlôe4TwoP¨tName
(
pP¨£
, 
pName1
, 
pName2
, &
pName
);

115 if–
iDb
<0 ){

116 
åiggî_˛ónup
;

119 if–!
pTabÀName
 || 
db
->
mÆlocFaûed
 ){

120 
åiggî_˛ónup
;

131 if–
db
->
öô
.
busy
 && 
iDb
!=1 ){

132 
	`sqlôe4DbFªe
(
db
, 
pTabÀName
->
a
[0].
zD©aba£
);

133 
pTabÀName
->
a
[0].
zD©aba£
 = 0;

141 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
pTabÀName
);

142 if–
db
->
öô
.
busy
==0 && 
pName2
->
n
==0 && 
pTab


143 && 
pTab
->
pSchema
==
db
->
aDb
[1].pSchema ){

144 
iDb
 = 1;

148 if–
db
->
mÆlocFaûed
 ) 
åiggî_˛ónup
;

149 
	`as£π
–
pTabÀName
->
nSrc
==1 );

150 if–
	`sqlôe4FixInô
(&
sFix
, 
pP¨£
, 
iDb
, "åiggî", 
pName
) &&

151 
	`sqlôe4FixSrcLi°
(&
sFix
, 
pTabÀName
) ){

152 
åiggî_˛ónup
;

154 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
pTabÀName
);

155 if–!
pTab
 ){

157 if–
db
->
öô
.
iDb
==1 ){

166 
db
->
öô
.
‹ph™Triggî
 = 1;

168 
åiggî_˛ónup
;

170 if–
	`IsVútuÆ
(
pTab
) ){

171 
	`sqlôe4Eº‹Msg
(
pP¨£
, "cannot createÅriggers on virtualÅables");

172 
åiggî_˛ónup
;

177 
zName
 = 
	`sqlôe4NameFromTokí
(
db
, 
pName
);

178 if–!
zName
 || 
SQLITE4_OK
!=
	`sqlôe4CheckObje˘Name
(
pP¨£
, zName) ){

179 
åiggî_˛ónup
;

181 if–
	`sqlôe4HashFöd
(&(
db
->
aDb
[
iDb
].
pSchema
->
åigHash
),

182 
zName
, 
	`sqlôe4SåÀn30
(zName)) ){

183 if–!
noEº
 ){

184 
	`sqlôe4Eº‹Msg
(
pP¨£
, "åiggî %TáÃódyÉxi°s", 
pName
);

186 
	`as£π
–!
db
->
öô
.
busy
 );

187 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

189 
åiggî_˛ónup
;

193 if–
	`sqlôe4_°∫icmp
(
pTab
->
zName
, "sqlite_", 7)==0 ){

194 
	`sqlôe4Eº‹Msg
(
pP¨£
, "cannot createÅrigger on systemÅable");

195 
pP¨£
->
nEº
++;

196 
åiggî_˛ónup
;

202 if–
pTab
->
pSñe˘
 && 
å_tm
!=
TK_INSTEAD
 ){

203 
	`sqlôe4Eº‹Msg
(
pP¨£
, "cannot create %sÅrigger on view: %S",

204 (
å_tm
 =
TK_BEFORE
)?"BEFORE":"AFTER", 
pTabÀName
, 0);

205 
åiggî_˛ónup
;

207 if–!
pTab
->
pSñe˘
 && 
å_tm
==
TK_INSTEAD
 ){

208 
	`sqlôe4Eº‹Msg
(
pP¨£
, "cannot create INSTEAD OF"

209 "Åriggî o¿èbÀ: %S", 
pTabÀName
, 0);

210 
åiggî_˛ónup
;

212 
iTabDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

214 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


216 
code
 = 
SQLITE4_CREATE_TRIGGER
;

217 c⁄° *
zDb
 = 
db
->
aDb
[
iTabDb
].
zName
;

218 c⁄° *
zDbTrig
 = 
isTemp
 ? 
db
->
aDb
[1].
zName
 : 
zDb
;

219 if–
iTabDb
==1 || 
isTemp
 ) 
code
 = 
SQLITE4_CREATE_TEMP_TRIGGER
;

220 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
code
, 
zName
, 
pTab
->zName, 
zDbTrig
) ){

221 
åiggî_˛ónup
;

223 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_INSERT
, 
	`SCHEMA_TABLE
(
iTabDb
),0,
zDb
)){

224 
åiggî_˛ónup
;

234 i‡(
å_tm
 =
TK_INSTEAD
){

235 
å_tm
 = 
TK_BEFORE
;

239 
pTriggî
 = (
Triggî
*)
	`sqlôe4DbMÆlocZîo
(
db
, (Trigger));

240 if–
pTriggî
==0 ) 
åiggî_˛ónup
;

241 
pTriggî
->
zName
 = zName;

242 
zName
 = 0;

243 
pTriggî
->
èbÀ
 = 
	`sqlôe4DbSåDup
(
db
, 
pTabÀName
->
a
[0].
zName
);

244 
pTriggî
->
pSchema
 = 
db
->
aDb
[
iDb
].pSchema;

245 
pTriggî
->
pTabSchema
 = 
pTab
->
pSchema
;

246 
pTriggî
->
›
 = (
u8
)op;

247 
pTriggî
->
å_tm
 =År_tm==
TK_BEFORE
 ? 
TRIGGER_BEFORE
 : 
TRIGGER_AFTER
;

248 
pTriggî
->
pWhí
 = 
	`sqlôe4Ex¥Dup
(
db
,ÖWhí, 
EXPRDUP_REDUCE
);

249 
pTriggî
->
pCﬁumns
 = 
	`sqlôe4IdLi°Dup
(
db
,ÖColumns);

250 
	`as£π
–
pP¨£
->
pNewTriggî
==0 );

251 
pP¨£
->
pNewTriggî
 = 
pTriggî
;

253 
åiggî_˛ónup
:

254 
	`sqlôe4DbFªe
(
db
, 
zName
);

255 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pTabÀName
);

256 
	`sqlôe4IdLi°Dñëe
(
db
, 
pCﬁumns
);

257 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhí
);

258 if–!
pP¨£
->
pNewTriggî
 ){

259 
	`sqlôe4DñëeTriggî
(
db
, 
pTriggî
);

261 
	`as£π
–
pP¨£
->
pNewTriggî
==
pTriggî
 );

263 
	}
}

269 
	$sqlôe4FöishTriggî
(

270 
P¨£
 *
pP¨£
,

271 
TriggîSãp
 *
pSãpLi°
,

272 
Tokí
 *
pAŒ


274 
Triggî
 *
pTrig
 = 
pP¨£
->
pNewTriggî
;

275 *
zName
;

276 
sqlôe4
 *
db
 = 
pP¨£
->db;

277 
DbFixî
 
sFix
;

278 
iDb
;

279 
Tokí
 
«meTokí
;

281 
pP¨£
->
pNewTriggî
 = 0;

282 if–
	`NEVER
(
pP¨£
->
nEº
Ë|| !
pTrig
 ) 
åiggîföish_˛ónup
;

283 
zName
 = 
pTrig
->zName;

284 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTrig
->
pSchema
);

285 
pTrig
->
°ï_li°
 = 
pSãpLi°
;

286  
pSãpLi°
 ){

287 
pSãpLi°
->
pTrig
 =ÖTrig;

288 
pSãpLi°
 =ÖSãpLi°->
pNext
;

290 
«meTokí
.
z
 = 
pTrig
->
zName
;

291 
«meTokí
.
n
 = 
	`sqlôe4SåÀn30
“ameTokí.
z
);

292 if–
	`sqlôe4FixInô
(&
sFix
, 
pP¨£
, 
iDb
, "åiggî", &
«meTokí
)

293 && 
	`sqlôe4FixTriggîSãp
(&
sFix
, 
pTrig
->
°ï_li°
) ){

294 
åiggîföish_˛ónup
;

300 if–!
db
->
öô
.
busy
 ){

301 
Vdbe
 *
v
;

302 *
z
;

305 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

306 if–
v
==0 ) 
åiggîföish_˛ónup
;

307 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

308 
z
 = 
	`sqlôe4DbSåNDup
(
db
, (*)
pAŒ
->z,ÖAŒ->
n
);

309 
	`sqlôe4Ne°edP¨£
(
pP¨£
,

311 
db
->
aDb
[
iDb
].
zName
, 
	`SCHEMA_TABLE
(iDb), zName,

312 
pTrig
->
èbÀ
, 
z
);

313 
	`sqlôe4DbFªe
(
db
, 
z
);

314 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

315 
	`sqlôe4VdbeAddP¨£SchemaOp
(
v
, 
iDb
,

316 
	`sqlôe4MPrötf
(
db
, "ty≥='åiggî' ANDÇame='%q'", 
zName
));

319 if–
db
->
öô
.
busy
 ){

320 
Triggî
 *
pLök
 = 
pTrig
;

321 
Hash
 *
pHash
 = &
db
->
aDb
[
iDb
].
pSchema
->
åigHash
;

322 
pTrig
 = 
	`sqlôe4HashIn£π
(
pHash
, 
zName
, 
	`sqlôe4SåÀn30
(zName),ÖTrig);

323 if–
pTrig
 ){

324 
db
->
mÆlocFaûed
 = 1;

325 }if–
pLök
->
pSchema
=ıLök->
pTabSchema
 ){

326 
TabÀ
 *
pTab
;

327 
n
 = 
	`sqlôe4SåÀn30
(
pLök
->
èbÀ
);

328 
pTab
 = 
	`sqlôe4HashFöd
(&
pLök
->
pTabSchema
->
tblHash
,ÖLök->
èbÀ
, 
n
);

329 
	`as£π
–
pTab
!=0 );

330 
pLök
->
pNext
 = 
pTab
->
pTriggî
;

331 
pTab
->
pTriggî
 = 
pLök
;

335 
åiggîföish_˛ónup
:

336 
	`sqlôe4DñëeTriggî
(
db
, 
pTrig
);

337 
	`as£π
–!
pP¨£
->
pNewTriggî
 );

338 
	`sqlôe4DñëeTriggîSãp
(
db
, 
pSãpLi°
);

339 
	}
}

348 
TriggîSãp
 *
	$sqlôe4TriggîSñe˘Sãp
(
sqlôe4
 *
db
, 
Sñe˘
 *
pSñe˘
){

349 
TriggîSãp
 *
pTriggîSãp
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (TriggerStep));

350 if–
pTriggîSãp
==0 ) {

351 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

354 
pTriggîSãp
->
›
 = 
TK_SELECT
;

355 
pTriggîSãp
->
pSñe˘
 =ÖSelect;

356 
pTriggîSãp
->
‹c⁄f
 = 
OE_DeÁu…
;

357  
pTriggîSãp
;

358 
	}
}

366 
TriggîSãp
 *
	$åiggîSãpAŒoˇã
(

367 
sqlôe4
 *
db
,

368 
u8
 
›
,

369 
Tokí
 *
pName


371 
TriggîSãp
 *
pTriggîSãp
;

373 
pTriggîSãp
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
TriggîSãp
Ë+ 
pName
->
n
);

374 if–
pTriggîSãp
 ){

375 *
z
 = (*)&
pTriggîSãp
[1];

376 
	`mem˝y
(
z
, 
pName
->z,ÖName->
n
);

377 
pTriggîSãp
->
èrgë
.
z
 = z;

378 
pTriggîSãp
->
èrgë
.
n
 = 
pName
->n;

379 
pTriggîSãp
->
›
 = op;

381  
pTriggîSãp
;

382 
	}
}

391 
TriggîSãp
 *
	$sqlôe4TriggîIn£πSãp
(

392 
sqlôe4
 *
db
,

393 
Tokí
 *
pTabÀName
,

394 
IdLi°
 *
pCﬁumn
,

395 
Ex¥Li°
 *
pELi°
,

396 
Sñe˘
 *
pSñe˘
,

397 
u8
 
‹c⁄f


399 
TriggîSãp
 *
pTriggîSãp
;

401 
	`as£π
(
pELi°
 =0 || 
pSñe˘
 == 0);

402 
	`as£π
(
pELi°
 !0 || 
pSñe˘
 !0 || 
db
->
mÆlocFaûed
);

404 
pTriggîSãp
 = 
	`åiggîSãpAŒoˇã
(
db
, 
TK_INSERT
, 
pTabÀName
);

405 if–
pTriggîSãp
 ){

406 
pTriggîSãp
->
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
,ÖSñe˘, 
EXPRDUP_REDUCE
);

407 
pTriggîSãp
->
pIdLi°
 = 
pCﬁumn
;

408 
pTriggîSãp
->
pEx¥Li°
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
pELi°
, 
EXPRDUP_REDUCE
);

409 
pTriggîSãp
->
‹c⁄f
 = orconf;

411 
	`sqlôe4IdLi°Dñëe
(
db
, 
pCﬁumn
);

413 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pELi°
);

414 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

416  
pTriggîSãp
;

417 
	}
}

424 
TriggîSãp
 *
	$sqlôe4TriggîUpd©eSãp
(

425 
sqlôe4
 *
db
,

426 
Tokí
 *
pTabÀName
,

427 
Ex¥Li°
 *
pELi°
,

428 
Ex¥
 *
pWhîe
,

429 
u8
 
‹c⁄f


431 
TriggîSãp
 *
pTriggîSãp
;

433 
pTriggîSãp
 = 
	`åiggîSãpAŒoˇã
(
db
, 
TK_UPDATE
, 
pTabÀName
);

434 if–
pTriggîSãp
 ){

435 
pTriggîSãp
->
pEx¥Li°
 = 
	`sqlôe4Ex¥Li°Dup
(
db
, 
pELi°
, 
EXPRDUP_REDUCE
);

436 
pTriggîSãp
->
pWhîe
 = 
	`sqlôe4Ex¥Dup
(
db
,ÖWhîe, 
EXPRDUP_REDUCE
);

437 
pTriggîSãp
->
‹c⁄f
 = orconf;

439 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pELi°
);

440 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhîe
);

441  
pTriggîSãp
;

442 
	}
}

449 
TriggîSãp
 *
	$sqlôe4TriggîDñëeSãp
(

450 
sqlôe4
 *
db
,

451 
Tokí
 *
pTabÀName
,

452 
Ex¥
 *
pWhîe


454 
TriggîSãp
 *
pTriggîSãp
;

456 
pTriggîSãp
 = 
	`åiggîSãpAŒoˇã
(
db
, 
TK_DELETE
, 
pTabÀName
);

457 if–
pTriggîSãp
 ){

458 
pTriggîSãp
->
pWhîe
 = 
	`sqlôe4Ex¥Dup
(
db
,ÖWhîe, 
EXPRDUP_REDUCE
);

459 
pTriggîSãp
->
‹c⁄f
 = 
OE_DeÁu…
;

461 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhîe
);

462  
pTriggîSãp
;

463 
	}
}

468 
	$sqlôe4DñëeTriggî
(
sqlôe4
 *
db
, 
Triggî
 *
pTriggî
){

469 if–
pTriggî
==0 ) ;

470 
	`sqlôe4DñëeTriggîSãp
(
db
, 
pTriggî
->
°ï_li°
);

471 
	`sqlôe4DbFªe
(
db
, 
pTriggî
->
zName
);

472 
	`sqlôe4DbFªe
(
db
, 
pTriggî
->
èbÀ
);

473 
	`sqlôe4Ex¥Dñëe
(
db
, 
pTriggî
->
pWhí
);

474 
	`sqlôe4IdLi°Dñëe
(
db
, 
pTriggî
->
pCﬁumns
);

475 
	`sqlôe4DbFªe
(
db
, 
pTriggî
);

476 
	}
}

486 
	$sqlôe4Dr›Triggî
(
P¨£
 *
pP¨£
, 
SrcLi°
 *
pName
, 
noEº
){

487 
Triggî
 *
pTriggî
 = 0;

488 
i
;

489 c⁄° *
zDb
;

490 c⁄° *
zName
;

491 
nName
;

492 
sqlôe4
 *
db
 = 
pP¨£
->db;

494 if–
db
->
mÆlocFaûed
 ) 
dr›_åiggî_˛ónup
;

495 if–
SQLITE4_OK
!=
	`sqlôe4RódSchema
(
pP¨£
) ){

496 
dr›_åiggî_˛ónup
;

499 
	`as£π
–
pName
->
nSrc
==1 );

500 
zDb
 = 
pName
->
a
[0].
zD©aba£
;

501 
zName
 = 
pName
->
a
[0].zName;

502 
nName
 = 
	`sqlôe4SåÀn30
(
zName
);

503 
i
=
OMIT_TEMPDB
; i<
db
->
nDb
; i++){

504 
j
 = (
i
<2) ? i^1 : i;

505 if–
zDb
 && 
	`sqlôe4_°ricmp
(
db
->
aDb
[
j
].
zName
, zDb) ) ;

506 
pTriggî
 = 
	`sqlôe4HashFöd
(&(
db
->
aDb
[
j
].
pSchema
->
åigHash
), 
zName
, 
nName
);

507 if–
pTriggî
 ) ;

509 if–!
pTriggî
 ){

510 if–!
noEº
 ){

511 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuchÅriggî: %S", 
pName
, 0);

513 
	`sqlôe4CodeVîifyNamedSchema
(
pP¨£
, 
zDb
);

515 
pP¨£
->
checkSchema
 = 1;

516 
dr›_åiggî_˛ónup
;

518 
	`sqlôe4Dr›TriggîPå
(
pP¨£
, 
pTriggî
);

520 
dr›_åiggî_˛ónup
:

521 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pName
);

522 
	}
}

528 
TabÀ
 *
	$èbÀOfTriggî
(
Triggî
 *
pTriggî
){

529 
n
 = 
	`sqlôe4SåÀn30
(
pTriggî
->
èbÀ
);

530  
	`sqlôe4HashFöd
(&
pTriggî
->
pTabSchema
->
tblHash
,ÖTriggî->
èbÀ
, 
n
);

531 
	}
}

537 
	$sqlôe4Dr›TriggîPå
(
P¨£
 *
pP¨£
, 
Triggî
 *
pTriggî
){

538 
TabÀ
 *
pTabÀ
;

539 
Vdbe
 *
v
;

540 
sqlôe4
 *
db
 = 
pP¨£
->db;

541 
iDb
;

543 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTriggî
->
pSchema
);

544 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

545 
pTabÀ
 = 
	`èbÀOfTriggî
(
pTriggî
);

546 
	`as£π
–
pTabÀ
 );

547 
	`as£π
–
pTabÀ
->
pSchema
==
pTriggî
->pSchem®|| 
iDb
==1 );

548 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


550 
code
 = 
SQLITE4_DROP_TRIGGER
;

551 c⁄° *
zDb
 = 
db
->
aDb
[
iDb
].
zName
;

552 c⁄° *
zTab
 = 
	`SCHEMA_TABLE
(
iDb
);

553 if–
iDb
==1 ) 
code
 = 
SQLITE4_DROP_TEMP_TRIGGER
;

554 if–
	`sqlôe4AuthCheck
(
pP¨£
, 
code
, 
pTriggî
->
zName
, 
pTabÀ
->zName, 
zDb
) ||

555 
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_DELETE
, 
zTab
, 0, 
zDb
) ){

563 
	`as£π
–
pTabÀ
!=0 );

564 if–(
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
))!=0 ){

565 
ba£
;

566 c⁄° 
VdbeOpLi°
 
dr›Triggî
[] = {

567 { 
OP_Rewöd
, 0, 
	`ADDR
(9), 0},

568 { 
OP_Såög8
, 0, 1, 0},

569 { 
OP_Cﬁumn
, 0, 1, 2},

570 { 
OP_Ne
, 2, 
	`ADDR
(8), 1},

571 { 
OP_Såög8
, 0, 1, 0},

572 { 
OP_Cﬁumn
, 0, 0, 2},

573 { 
OP_Ne
, 2, 
	`ADDR
(8), 1},

574 { 
OP_Dñëe
, 0, 0, 0},

575 { 
OP_Next
, 0, 
	`ADDR
(1), 0},

578 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 0, 
iDb
);

579 
	`sqlôe4O≥nMa°îTabÀ
(
pP¨£
, 
iDb
);

580 
ba£
 = 
	`sqlôe4VdbeAddOpLi°
(
v
, 
	`AºaySize
(
dr›Triggî
), dropTrigger);

581 
	`sqlôe4VdbeCh™geP4
(
v
, 
ba£
+1, 
pTriggî
->
zName
, 
P4_TRANSIENT
);

582 
	`sqlôe4VdbeCh™geP4
(
v
, 
ba£
+4, "åiggî", 
P4_STATIC
);

583 
	`sqlôe4Ch™geCookõ
(
pP¨£
, 
iDb
);

584 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Clo£
, 0, 0);

585 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Dr›Triggî
, 
iDb
, 0, 0, 
pTriggî
->
zName
, 0);

586 if–
pP¨£
->
nMem
<3 ){

587 
pP¨£
->
nMem
 = 3;

590 
	}
}

595 
	$sqlôe4U∆ökAndDñëeTriggî
(
sqlôe4
 *
db
, 
iDb
, c⁄° *
zName
){

596 
Triggî
 *
pTriggî
;

597 
Hash
 *
pHash
;

599 
pHash
 = &(
db
->
aDb
[
iDb
].
pSchema
->
åigHash
);

600 
pTriggî
 = 
	`sqlôe4HashIn£π
(
pHash
, 
zName
, 
	`sqlôe4SåÀn30
(zName), 0);

601 if–
	`ALWAYS
(
pTriggî
) ){

602 if–
pTriggî
->
pSchema
=ıTriggî->
pTabSchema
 ){

603 
TabÀ
 *
pTab
 = 
	`èbÀOfTriggî
(
pTriggî
);

604 
Triggî
 **
µ
;

605 
µ
=&
pTab
->
pTriggî
; *µ!ıTriggî;Öp=&((*µ)->
pNext
));

606 *
µ
 = (*µ)->
pNext
;

608 
	`sqlôe4DñëeTriggî
(
db
, 
pTriggî
);

609 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

611 
	}
}

622 
	$checkCﬁumnOvîœp
(
IdLi°
 *
pIdLi°
, 
Ex¥Li°
 *
pELi°
){

623 
e
;

624 if–
pIdLi°
==0 || 
	`NEVER
(
pELi°
==0) )  1;

625 
e
=0;É<
pELi°
->
nEx¥
;É++){

626 if–
	`sqlôe4IdLi°Index
(
pIdLi°
, 
pELi°
->
a
[
e
].
zName
)>=0 )  1;

629 
	}
}

637 
Triggî
 *
	$sqlôe4TriggîsExi°
(

638 
P¨£
 *
pP¨£
,

639 
TabÀ
 *
pTab
,

640 
›
,

641 
Ex¥Li°
 *
pCh™ges
,

642 *
pMask


644 
mask
 = 0;

645 
Triggî
 *
pLi°
 = 0;

646 
Triggî
 *
p
;

648 if–(
pP¨£
->
db
->
Êags
 & 
SQLITE4_E«bÀTriggî
)!=0 ){

649 
pLi°
 = 
	`sqlôe4TriggîLi°
(
pP¨£
, 
pTab
);

651 
	`as£π
–
pLi°
==0 || 
	`IsVútuÆ
(
pTab
)==0 );

652 
p
=
pLi°
;Ö;Öı->
pNext
){

653 if–
p
->
›
==› && 
	`checkCﬁumnOvîœp
’->
pCﬁumns
, 
pCh™ges
) ){

654 
mask
 |
p
->
å_tm
;

657 if–
pMask
 ){

658 *
pMask
 = 
mask
;

660  (
mask
 ? 
pLi°
 : 0);

661 
	}
}

673 
SrcLi°
 *
	$èrgëSrcLi°
(

674 
P¨£
 *
pP¨£
,

675 
TriggîSãp
 *
pSãp


677 
iDb
;

678 
SrcLi°
 *
pSrc
;

680 
pSrc
 = 
	`sqlôe4SrcLi°Aµíd
(
pP¨£
->
db
, 0, &
pSãp
->
èrgë
, 0);

681 if–
pSrc
 ){

682 
	`as£π
–
pSrc
->
nSrc
>0 );

683 
	`as£π
–
pSrc
->
a
!=0 );

684 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pSãp
->
pTrig
->
pSchema
);

685 if–
iDb
==0 || iDb>=2 ){

686 
sqlôe4
 *
db
 = 
pP¨£
->db;

687 
	`as£π
–
iDb
<
pP¨£
->
db
->
nDb
 );

688 
pSrc
->
a
[pSrc->
nSrc
-1].
zD©aba£
 = 
	`sqlôe4DbSåDup
(
db
, db->
aDb
[
iDb
].
zName
);

691  
pSrc
;

692 
	}
}

698 
	$codeTriggîProgøm
(

699 
P¨£
 *
pP¨£
,

700 
TriggîSãp
 *
pSãpLi°
,

701 
‹c⁄f


703 
TriggîSãp
 *
pSãp
;

704 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

705 
sqlôe4
 *
db
 = 
pP¨£
->db;

707 
	`as£π
–
pP¨£
->
pTriggîTab
 &&ÖP¨£->
pT›Àvñ
 );

708 
	`as£π
–
pSãpLi°
 );

709 
	`as£π
–
v
!=0 );

710 
pSãp
=
pSãpLi°
;ÖSãp;ÖSãpıSãp->
pNext
){

724 
pP¨£
->
eOrc⁄f
 = (
‹c⁄f
==
OE_DeÁu…
)?
pSãp
->‹c⁄f:(
u8
)orconf;

726  
pSãp
->
›
 ){

727 
TK_UPDATE
: {

728 
	`sqlôe4Upd©e
(
pP¨£
,

729 
	`èrgëSrcLi°
(
pP¨£
, 
pSãp
),

730 
	`sqlôe4Ex¥Li°Dup
(
db
, 
pSãp
->
pEx¥Li°
, 0),

731 
	`sqlôe4Ex¥Dup
(
db
, 
pSãp
->
pWhîe
, 0),

732 
pP¨£
->
eOrc⁄f


736 
TK_INSERT
: {

737 
	`sqlôe4In£π
(
pP¨£
,

738 
	`èrgëSrcLi°
(
pP¨£
, 
pSãp
),

739 
	`sqlôe4Ex¥Li°Dup
(
db
, 
pSãp
->
pEx¥Li°
, 0),

740 
	`sqlôe4Sñe˘Dup
(
db
, 
pSãp
->
pSñe˘
, 0),

741 
	`sqlôe4IdLi°Dup
(
db
, 
pSãp
->
pIdLi°
),

742 
pP¨£
->
eOrc⁄f


746 
TK_DELETE
: {

747 
	`sqlôe4DñëeFrom
(
pP¨£
,

748 
	`èrgëSrcLi°
(
pP¨£
, 
pSãp
),

749 
	`sqlôe4Ex¥Dup
(
db
, 
pSãp
->
pWhîe
, 0)

753 : 
	`as£π
–
pSãp
->
›
==
TK_SELECT
 ); {

754 
Sñe˘De°
 
sDe°
;

755 
Sñe˘
 *
pSñe˘
 = 
	`sqlôe4Sñe˘Dup
(
db
, 
pSãp
->pSelect, 0);

756 
	`sqlôe4Sñe˘De°Inô
(&
sDe°
, 
SRT_Disˇrd
, 0);

757 
	`sqlôe4Sñe˘
(
pP¨£
, 
pSñe˘
, &
sDe°
);

758 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

762 if–
pSãp
->
›
!=
TK_SELECT
 ){

763 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_Re£tCou¡
);

768 
	}
}

770 #ifde‡
SQLITE4_DEBUG


775 c⁄° *
	$⁄Eº‹Text
(
⁄Eº‹
){

776  
⁄Eº‹
 ){

777 
OE_Ab‹t
:  "abort";

778 
OE_Rﬁlback
:  "rollback";

779 
OE_Faû
:  "fail";

780 
OE_Rïœ˚
:  "replace";

781 
OE_Ign‹e
:  "ignore";

782 
OE_DeÁu…
:  "default";

785 
	}
}

793 
	$å™s„rP¨£Eº‹
(
P¨£
 *
pTo
, P¨£ *
pFrom
){

794 
	`as£π
–
pFrom
->
zEºMsg
==0 ||ÖFrom->
nEº
 );

795 
	`as£π
–
pTo
->
zEºMsg
==0 ||ÖTo->
nEº
 );

796 if–
pTo
->
nEº
==0 ){

797 
pTo
->
zEºMsg
 = 
pFrom
->zErrMsg;

798 
pTo
->
nEº
 = 
pFrom
->nErr;

800 
	`sqlôe4DbFªe
(
pFrom
->
db
,ÖFrom->
zEºMsg
);

802 
	}
}

808 
TriggîPrg
 *
	$codeRowTriggî
(

809 
P¨£
 *
pP¨£
,

810 
Triggî
 *
pTriggî
,

811 
TabÀ
 *
pTab
,

812 
‹c⁄f


814 
P¨£
 *
pT›
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

815 
sqlôe4
 *
db
 = 
pP¨£
->db;

816 
TriggîPrg
 *
pPrg
;

817 
Ex¥
 *
pWhí
 = 0;

818 
Vdbe
 *
v
;

819 
NameC⁄ãxt
 
sNC
;

820 
SubProgøm
 *
pProgøm
 = 0;

821 
P¨£
 *
pSubP¨£
;

822 
iEndTriggî
 = 0;

824 
	`as£π
–
pTriggî
->
zName
==0 || 
pTab
==
	`èbÀOfTriggî
(pTrigger) );

825 
	`as£π
–
pT›
->
pVdbe
 );

830 
pPrg
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
TriggîPrg
));

831 if–!
pPrg
 )  0;

832 
pPrg
->
pNext
 = 
pT›
->
pTriggîPrg
;

833 
pT›
->
pTriggîPrg
 = 
pPrg
;

834 
pPrg
->
pProgøm
 =ÖProgøm = 
	`sqlôe4DbMÆlocZîo
(
db
, (
SubProgøm
));

835 if–!
pProgøm
 )  0;

836 
	`sqlôe4VdbeLökSubProgøm
(
pT›
->
pVdbe
, 
pProgøm
);

837 
pPrg
->
pTriggî
 =ÖTrigger;

838 
pPrg
->
‹c⁄f
 = orconf;

839 
pPrg
->
aCﬁmask
[0] = 0xffffffff;

840 
pPrg
->
aCﬁmask
[1] = 0xffffffff;

844 
pSubP¨£
 = 
	`sqlôe4SèckAŒocZîo
(
db
, (
P¨£
));

845 if–!
pSubP¨£
 )  0;

846 
	`mem£t
(&
sNC
, 0, (sNC));

847 
sNC
.
pP¨£
 = 
pSubP¨£
;

848 
pSubP¨£
->
db
 = db;

849 
pSubP¨£
->
pTriggîTab
 = 
pTab
;

850 
pSubP¨£
->
pT›Àvñ
 = 
pT›
;

851 
pSubP¨£
->
zAuthC⁄ãxt
 = 
pTriggî
->
zName
;

852 
pSubP¨£
->
eTriggîOp
 = 
pTriggî
->
›
;

853 
pSubP¨£
->
nQuîyLo›
 = 
pP¨£
->nQueryLoop;

855 
v
 = 
	`sqlôe4GëVdbe
(
pSubP¨£
);

856 if–
v
 ){

857 
	`VdbeCommít
((
v
, "Start: %s.%s (%s %s%s%s ON %s)",

858 
pTriggî
->
zName
, 
	`⁄Eº‹Text
(
‹c⁄f
),

859 (
pTriggî
->
å_tm
==
TRIGGER_BEFORE
 ? "BEFORE" : "AFTER"),

860 (
pTriggî
->
›
==
TK_UPDATE
 ? "UPDATE" : ""),

861 (
pTriggî
->
›
==
TK_INSERT
 ? "INSERT" : ""),

862 (
pTriggî
->
›
==
TK_DELETE
 ? "DELETE" : ""),

863 
pTab
->
zName


865 #i‚de‡
SQLITE4_OMIT_TRACE


866 
	`sqlôe4VdbeCh™geP4
(
v
, -1,

867 
	`sqlôe4MPrötf
(
db
, "-- TRIGGER %s", 
pTriggî
->
zName
), 
P4_DYNAMIC


874 if–
pTriggî
->
pWhí
 ){

875 
pWhí
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pTriggî
->pWhen, 0);

876 if–
SQLITE4_OK
==
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pWhí
)

877 && 
db
->
mÆlocFaûed
==0

879 
iEndTriggî
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

880 
	`sqlôe4Ex¥IfFÆ£
(
pSubP¨£
, 
pWhí
, 
iEndTriggî
, 
SQLITE4_JUMPIFNULL
);

882 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhí
);

886 
	`codeTriggîProgøm
(
pSubP¨£
, 
pTriggî
->
°ï_li°
, 
‹c⁄f
);

889 if–
iEndTriggî
 ){

890 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iEndTriggî
);

892 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_HÆt
);

893 
	`VdbeCommít
((
v
, "End: %s.%s", 
pTriggî
->
zName
, 
	`⁄Eº‹Text
(
‹c⁄f
)));

895 
	`å™s„rP¨£Eº‹
(
pP¨£
, 
pSubP¨£
);

896 if–
db
->
mÆlocFaûed
==0 ){

897 
pProgøm
->
aOp
 = 
	`sqlôe4VdbeTakeOpAºay
(
v
, &pProgøm->
nOp
, &
pT›
->
nMaxArg
);

899 
pProgøm
->
nMem
 = 
pSubP¨£
->nMem;

900 
pProgøm
->
nC§
 = 
pSubP¨£
->
nTab
;

901 
pProgøm
->
nOn˚
 = 
pSubP¨£
->nOnce;

902 
pProgøm
->
tokí
 = (*)
pTriggî
;

903 
pPrg
->
aCﬁmask
[0] = 
pSubP¨£
->
ﬁdmask
;

904 
pPrg
->
aCﬁmask
[1] = 
pSubP¨£
->
√wmask
;

905 
	`sqlôe4VdbeDñëe
(
v
);

908 
	`as£π
–!
pSubP¨£
->
pAöc
 && !pSubP¨£->
pZombõTab
 );

909 
	`as£π
–!
pSubP¨£
->
pTriggîPrg
 && !pSubP¨£->
nMaxArg
 );

910 
	`sqlôe4SèckFªe
(
db
, 
pSubP¨£
);

912  
pPrg
;

913 
	}
}

921 
TriggîPrg
 *
	$gëRowTriggî
(

922 
P¨£
 *
pP¨£
,

923 
Triggî
 *
pTriggî
,

924 
TabÀ
 *
pTab
,

925 
‹c⁄f


927 
P¨£
 *
pRoŸ
 = 
	`sqlôe4P¨£T›Àvñ
(
pP¨£
);

928 
TriggîPrg
 *
pPrg
;

930 
	`as£π
–
pTriggî
->
zName
==0 || 
pTab
==
	`èbÀOfTriggî
(pTrigger) );

936 
pPrg
=
pRoŸ
->
pTriggîPrg
;

937 
pPrg
 && (pPrg->
pTriggî
!ıTriggî ||ÖPrg->
‹c⁄f
!=orconf);

938 
pPrg
ıPrg->
pNext


942 if–!
pPrg
 ){

943 
pPrg
 = 
	`codeRowTriggî
(
pP¨£
, 
pTriggî
, 
pTab
, 
‹c⁄f
);

946  
pPrg
;

947 
	}
}

955 
	$sqlôe4CodeRowTriggîDúe˘
(

956 
P¨£
 *
pP¨£
,

957 
Triggî
 *
p
,

958 
TabÀ
 *
pTab
,

959 
ªg
,

960 
‹c⁄f
,

961 
ign‹eJump


963 
Vdbe
 *
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

964 
TriggîPrg
 *
pPrg
;

965 
pPrg
 = 
	`gëRowTriggî
(
pP¨£
, 
p
, 
pTab
, 
‹c⁄f
);

966 
	`as£π
–
pPrg
 || 
pP¨£
->
nEº
 ||ÖP¨£->
db
->
mÆlocFaûed
 );

970 if–
pPrg
 ){

971 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Progøm
, 
ªg
, 
ign‹eJump
, ++
pP¨£
->
nMem
);

972 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pPrg
->
pProgøm
, 
P4_SUBPROGRAM
);

973 
	`VdbeCommít
(

974 (
v
, "CÆl: %s.%s", (
p
->
zName
?p->zName:"fkey"), 
	`⁄Eº‹Text
(
‹c⁄f
)));

976 
	}
}

1018 
	$sqlôe4CodeRowTriggî
(

1019 
P¨£
 *
pP¨£
,

1020 
Triggî
 *
pTriggî
,

1021 
›
,

1022 
Ex¥Li°
 *
pCh™ges
,

1023 
å_tm
,

1024 
TabÀ
 *
pTab
,

1025 
ªg
,

1026 
‹c⁄f
,

1027 
ign‹eJump


1029 
Triggî
 *
p
;

1031 
	`as£π
–
›
==
TK_UPDATE
 || op==
TK_INSERT
 || op==
TK_DELETE
 );

1032 
	`as£π
–
å_tm
==
TRIGGER_BEFORE
 ||År_tm==
TRIGGER_AFTER
 );

1033 
	`as£π
–(
›
==
TK_UPDATE
)==(
pCh™ges
!=0) );

1035 
p
=
pTriggî
;Ö;Öı->
pNext
){

1040 
	`as£π
–
p
->
pSchema
!=0 );

1041 
	`as£π
–
p
->
pTabSchema
!=0 );

1042 
	`as£π
–
p
->
pSchema
=ı->
pTabSchema


1043 || 
p
->
pSchema
==
pP¨£
->
db
->
aDb
[1].pSchema );

1046 if–
p
->
›
==op

1047 && 
p
->
å_tm
==tr_tm

1048 && 
	`checkCﬁumnOvîœp
(
p
->
pCﬁumns
, 
pCh™ges
)

1050 
	`sqlôe4CodeRowTriggîDúe˘
(
pP¨£
, 
p
, 
pTab
, 
ªg
, 
‹c⁄f
, 
ign‹eJump
);

1053 
	}
}

1080 
u32
 
	$sqlôe4TriggîCﬁmask
(

1081 
P¨£
 *
pP¨£
,

1082 
Triggî
 *
pTriggî
,

1083 
Ex¥Li°
 *
pCh™ges
,

1084 
isNew
,

1085 
å_tm
,

1086 
TabÀ
 *
pTab
,

1087 
‹c⁄f


1089 c⁄° 
›
 = 
pCh™ges
 ? 
TK_UPDATE
 : 
TK_DELETE
;

1090 
u32
 
mask
 = 0;

1091 
Triggî
 *
p
;

1093 
	`as£π
–
isNew
==1 || isNew==0 );

1094 
p
=
pTriggî
;Ö;Öı->
pNext
){

1095 if–
p
->
›
==› && (
å_tm
&p->tr_tm)

1096 && 
	`checkCﬁumnOvîœp
(
p
->
pCﬁumns
,
pCh™ges
)

1098 
TriggîPrg
 *
pPrg
;

1099 
pPrg
 = 
	`gëRowTriggî
(
pP¨£
, 
p
, 
pTab
, 
‹c⁄f
);

1100 if–
pPrg
 ){

1101 
mask
 |
pPrg
->
aCﬁmask
[
isNew
];

1106  
mask
;

1107 
	}
}

	@src/update.c

15 
	~"sqlôeI¡.h
"

17 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


19 
upd©eVútuÆTabÀ
(

20 
P¨£
 *
pP¨£
,

21 
SrcLi°
 *
pSrc
,

22 
TabÀ
 *
pTab
,

23 
Ex¥Li°
 *
pCh™ges
,

24 
Ex¥
 *
pRowidEx¥
,

25 *
aXRef
,

26 
Ex¥
 *
pWhîe
,

27 
⁄Eº‹


61 
	$sqlôe4CﬁumnDeÁu…
(
Vdbe
 *
v
, 
TabÀ
 *
pTab
, 
i
, 
iReg
){

62 
	`as£π
–
pTab
!=0 );

63 if–!
pTab
->
pSñe˘
 ){

64 
sqlôe4_vÆue
 *
pVÆue
;

65 
u8
 
íc
 = 
	`ENC
(
	`sqlôe4VdbeDb
(
v
));

66 
Cﬁumn
 *
pCﬁ
 = &
pTab
->
aCﬁ
[
i
];

67 
	`VdbeCommít
((
v
, "%s.%s", 
pTab
->
zName
, 
pCﬁ
->zName));

68 
	`as£π
–
i
<
pTab
->
nCﬁ
 );

69 
	`sqlôe4VÆueFromEx¥
(
	`sqlôe4VdbeDb
(
v
), 
pCﬁ
->
pDÊt
, 
íc
,

70 
pCﬁ
->
afföôy
, &
pVÆue
);

71 if–
pVÆue
 ){

72 
	`sqlôe4VdbeCh™geP4
(
v
, -1, (c⁄° *)
pVÆue
, 
P4_MEM
);

74 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


75 if–
iReg
>=0 && 
pTab
->
aCﬁ
[
i
].
afföôy
==
SQLITE4_AFF_REAL
 ){

76 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_RólAfföôy
, 
iReg
);

80 
	}
}

89 
	$sqlôe4Upd©e
(

90 
P¨£
 *
pP¨£
,

91 
SrcLi°
 *
pSrc
,

92 
Ex¥Li°
 *
pCh™ges
,

93 
Ex¥
 *
pWhîe
,

94 
⁄Eº‹


96 
i
, 
j
;

97 
TabÀ
 *
pTab
;

98 
addr
 = 0;

99 
WhîeInfo
 *
pWInfo
;

100 
Vdbe
 *
v
;

101 
Index
 *
pIdx
;

102 
nIdx
;

103 
iCur
;

104 
sqlôe4
 *
db
;

105 *
aRegIdx
 = 0;

106 *
aXRef
 = 0;

109 
AuthC⁄ãxt
 
sC⁄ãxt
;

110 
NameC⁄ãxt
 
sNC
;

111 
iDb
;

112 
okO√Pass
;

113 
hasFK
;

115 #i‚de‡
SQLITE4_OMIT_TRIGGER


116 
isVõw
;

117 
Triggî
 *
pTriggî
;

118 
tmask
;

120 
√wmask
;

122 
ªgOldKey
;

123 
ªgNew
;

124 
ªgOld
 = 0;

125 
ªgRowSë
 = 0;

126 
Index
 *
pPk
 = 0;

127 
iPk
 = 0;

128 
bChngPk
 = 0;

129 
bO≥nAŒ
 = 0;

130 
bIm∂icôPk
 = 0;

131 
ªgOldTr
 = 0;

132 
ªgNewTr
 = 0;

134 
	`mem£t
(&
sC⁄ãxt
, 0, (sContext));

135 
db
 = 
pP¨£
->db;

136 if–
pP¨£
->
nEº
 || 
db
->
mÆlocFaûed
 ){

137 
upd©e_˛ónup
;

139 
	`as£π
–
pSrc
->
nSrc
==1 );

148 
pTab
 = 
	`sqlôe4SrcLi°Lookup
(
pP¨£
, 
pSrc
);

149 if–
pTab
==0 ) 
upd©e_˛ónup
;

150 
iDb
 = 
	`sqlôe4SchemaToIndex
(
pP¨£
->
db
, 
pTab
->
pSchema
);

151 if–
	`IsVõw
(
pTab
)==0 ){

152 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, &
iPk
);

153 
bIm∂icôPk
 = (
pPk
->
aiCﬁumn
[0]<0);

159 #i‚de‡
SQLITE4_OMIT_TRIGGER


160 
pTriggî
 = 
	`sqlôe4TriggîsExi°
(
pP¨£
, 
pTab
, 
TK_UPDATE
, 
pCh™ges
, &
tmask
);

161 
isVõw
 = 
pTab
->
pSñe˘
!=0;

162 
	`as£π
–
pTriggî
 || 
tmask
==0 );

164 
	#pTriggî
 0

	)

165 
	#isVõw
 0

	)

166 
	#tmask
 0

	)

168 #ifde‡
SQLITE4_OMIT_VIEW


169 #unde‡
isVõw


170 
	#isVõw
 0

	)

173 if–
	`sqlôe4VõwGëCﬁumnNames
(
pP¨£
, 
pTab
ËË
upd©e_˛ónup
;

174 if–
	`sqlôe4IsRódO∆y
(
pP¨£
, 
pTab
, 
tmask
ËË
upd©e_˛ónup
;

176 
aXRef
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (Ë* 
pTab
->
nCﬁ
 );

177 if–
aXRef
==0 ) 
upd©e_˛ónup
;

178 
i
=0; i<
pTab
->
nCﬁ
; i++Ë
aXRef
[i] = -1;

184 
iCur
 = 
pP¨£
->
nTab
;

185 
pSrc
->
a
[0].
iCurs‹
 = 
iCur
+
iPk
;

186 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

187 
pP¨£
->
nTab
++;

189 if–
	`IsVõw
(
pTab
ËË
pP¨£
->
nTab
++;

192 
	`mem£t
(&
sNC
, 0, (sNC));

193 
sNC
.
pP¨£
 =ÖParse;

194 
sNC
.
pSrcLi°
 = 
pSrc
;

205 
i
=0; i<
pCh™ges
->
nEx¥
; i++){

206 
iPkCﬁ
;

209 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pCh™ges
->
a
[
i
].
pEx¥
) ){

210 
upd©e_˛ónup
;

214 
j
=0; j<
pTab
->
nCﬁ
; j++){

215 if–
	`sqlôe4_°ricmp
(
pTab
->
aCﬁ
[
j
].
zName
, 
pCh™ges
->
a
[
i
].zName)==0 ) ;

217 if–
j
==
pTab
->
nCﬁ
 ){

218 
	`sqlôe4Eº‹Msg
(
pP¨£
, "nÿsuch cﬁumn: %s", 
pCh™ges
->
a
[
i
].
zName
);

219 
pP¨£
->
checkSchema
 = 1;

220 
upd©e_˛ónup
;

222 
aXRef
[
j
] = 
i
;

225 if–!
	`IsVõw
(
pTab
) ){

226 
iPkCﬁ
=0; iPkCﬁ<
pPk
->
nCﬁumn
; iPkCol++){

227 if–
pPk
->
aiCﬁumn
[
iPkCﬁ
]==
j
 ) 
bChngPk
 = 1;

231 #i‚de‡
SQLITE4_OMIT_AUTHORIZATION


233 
rc
;

234 
rc
 = 
	`sqlôe4AuthCheck
(
pP¨£
, 
SQLITE4_UPDATE
, 
pTab
->
zName
,

235 
pTab
->
aCﬁ
[
j
].
zName
, 
db
->
aDb
[
iDb
].zName);

236 if–
rc
==
SQLITE4_DENY
 ){

237 
upd©e_˛ónup
;

238 }if–
rc
==
SQLITE4_IGNORE
 ){

239 
aXRef
[
j
] = -1;

246 
v
 = 
	`sqlôe4GëVdbe
(
pP¨£
);

247 if–
v
==0 ) 
upd©e_˛ónup
;

248 if–
pP¨£
->
√°ed
==0 ) 
	`sqlôe4VdbeCou¡Ch™ges
(
v
);

249 
	`sqlôe4BegöWrôeO≥øti⁄
(
pP¨£
, 1, 
iDb
);

251 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


254 if–
	`IsVútuÆ
(
pTab
) ){

255 
	`upd©eVútuÆTabÀ
(
pP¨£
, 
pSrc
, 
pTab
, 
pCh™ges
, 0, 
aXRef
, 
pWhîe
, 
⁄Eº‹
);

256 
pWhîe
 = 0;

257 
pSrc
 = 0;

258 
upd©e_˛ónup
;

262 
hasFK
 = 
	`sqlôe4FkRequúed
(
pP¨£
, 
pTab
, 
aXRef
);

268 
nIdx
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
,ÇIdx++){}

269 
	`as£π
–
nIdx
>0 || 
isVõw
 );

270 if–
nIdx
 ){

271 
aRegIdx
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Index
*Ë* 
nIdx
 );

272 if–
aRegIdx
==0 ) 
upd©e_˛ónup
;

276 
j
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, j++){

277 if–
pIdx
==
pPk
 || 
hasFK
 || 
bChngPk
 ){

278 
aRegIdx
[
j
] = ++
pP¨£
->
nMem
;

280 
i
=0; i<
pIdx
->
nCﬁumn
; i++){

281 if–
aXRef
[
pIdx
->
aiCﬁumn
[
i
]]>=0 ){

282 
aRegIdx
[
j
] = ++
pP¨£
->
nMem
;

303 
ªgRowSë
 = ++
pP¨£
->
nMem
;

304 
ªgOldKey
 = ++
pP¨£
->
nMem
;

305 if–
pTriggî
 || 
hasFK
 ){

306 
ªgOldTr
 = 
pP¨£
->
nMem
 + 1;

307 
ªgOld
 = 
ªgOldTr
+1;

308 
pP¨£
->
nMem
 +(
pTab
->
nCﬁ
 + 1);

310 
ªgNewTr
 = 
pP¨£
->
nMem
 + 1;

311 
ªgNew
 = 
ªgNewTr
+1;

312 
pP¨£
->
nMem
 +(
pTab
->
nCﬁ
+1);

315 if–
isVõw
 ){

316 
	`sqlôe4AuthC⁄ãxtPush
(
pP¨£
, &
sC⁄ãxt
, 
pTab
->
zName
);

322 #i‡!
	`deföed
(
SQLITE4_OMIT_VIEW
Ë&& !deföed(
SQLITE4_OMIT_TRIGGER
)

323 if–
isVõw
 ){

324 
	`sqlôe4M©îülizeVõw
(
pP¨£
, 
pTab
, 
pWhîe
, 
iCur
);

331 if–
	`sqlôe4ResﬁveEx¥Names
(&
sNC
, 
pWhîe
) ){

332 
upd©e_˛ónup
;

345 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NuŒ
, 0, 
ªgRowSë
, 
ªgOldKey
);

346 
pWInfo
 = 
	`sqlôe4WhîeBegö
(
pP¨£
, 
pSrc
, 
pWhîe
, 0,0,
WHERE_ONEPASS_DESIRED
,0);

347 if–
pWInfo
==0 ) 
upd©e_˛ónup
;

348 
okO√Pass
 = 
	`sqlôe4WhîeOkO√Pass
(
pWInfo
);

349 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iCur
+
iPk
, 
ªgOldKey
);

350 if–!
okO√Pass
 ){

351 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_RowSëAdd
, 
ªgRowSë
, 0, 
ªgOldKey
);

353 
	`sqlôe4WhîeEnd
(
pWInfo
);

358 if–!
isVõw
 ){

360 
bO≥nAŒ
 = (
⁄Eº‹
==
OE_Rïœ˚
);

361 
i
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, i++){

362 if–
aRegIdx
[
i
] && 
pIdx
->
⁄Eº‹
==
OE_Rïœ˚
 ) 
bO≥nAŒ
 = 1;

370 
i
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, i++){

371 if–(
bO≥nAŒ
 || 
aRegIdx
[
i
]Ë&& (
okO√Pass
==0 || 
pIdx
!=
pPk
) ){

372 
	`sqlôe4O≥nIndex
(
pP¨£
, 
iCur
+
i
, 
iDb
, 
pIdx
, 
OP_O≥nWrôe
);

391 if–
okO√Pass
 ){

392 
a1
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NŸNuŒ
, 
ªgOldKey
);

393 
addr
 = 
	`sqlôe4VdbeAddOp0
(
v
, 
OP_GŸo
);

394 
	`sqlôe4VdbeJumpHîe
(
v
, 
a1
);

396 
addr
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_RowSëRód
, 
ªgRowSë
, 0, 
ªgOldKey
);

403 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_NŸFound
, 
iCur
+
iPk
, 
addr
, 
ªgOldKey
, 0, 
P4_INT32
);

407 if–
hasFK
 || 
pTriggî
 ){

408 
u32
 
ﬁdmask
 = (
hasFK
 ? 
	`sqlôe4FkOldmask
(
pP¨£
, 
pTab
) : 0);

409 
ﬁdmask
 |
	`sqlôe4TriggîCﬁmask
(
pP¨£
,

410 
pTriggî
, 
pCh™ges
, 0, 
TRIGGER_BEFORE
|
TRIGGER_AFTER
, 
pTab
, 
⁄Eº‹


413 if–
bIm∂icôPk
 ){

414 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iCur
+
iPk
, 
ªgOldTr
);

416 
i
=0; i<
pTab
->
nCﬁ
; i++){

417 if–
aXRef
[
i
]<0 || 
ﬁdmask
==0xffffffff || (i<32 && (oldmask & (1<<i))) ){

418 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pTab
, 
iCur
+
iPk
, 
i
, 
ªgOld
+i);

420 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgOld
+
i
);

438 
√wmask
 = 
	`sqlôe4TriggîCﬁmask
(

439 
pP¨£
, 
pTriggî
, 
pCh™ges
, 1, 
TRIGGER_BEFORE
, 
pTab
, 
⁄Eº‹


441 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_NuŒ
, 0, 
ªgNew
,ÑegNew+
pTab
->
nCﬁ
-1);

442 
i
=0; i<
pTab
->
nCﬁ
; i++){

443 
j
 = 
aXRef
[
i
];

444 if–
j
>=0 ){

445 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pCh™ges
->
a
[
j
].
pEx¥
, 
ªgNew
+
i
);

446 }if–0==(
tmask
&
TRIGGER_BEFORE
Ë|| 
i
>31 || (
√wmask
&(1<<i)) ){

452 
	`ã°ˇ£
–
i
==31 );

453 
	`ã°ˇ£
–
i
==32 );

454 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pTab
, 
iCur
+
iPk
, 
i
, 
ªgNew
+i);

457 if–
bIm∂icôPk
 ){

458 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iCur
+
iPk
, 
ªgNew
-1);

464 if–
tmask
&
TRIGGER_BEFORE
 ){

465 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Afföôy
, 
ªgNew
, 
pTab
->
nCﬁ
);

466 
	`sqlôe4TabÀAfföôySå
(
v
, 
pTab
);

467 
	`sqlôe4CodeRowTriggî
(
pP¨£
, 
pTriggî
, 
TK_UPDATE
, 
pCh™ges
,

468 
TRIGGER_BEFORE
, 
pTab
, 
ªgOldTr
, 
⁄Eº‹
, 
addr
);

476 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_NŸFound
, 
iCur
+
iPk
, 
addr
, 
ªgOldKey
, 0);

483 
i
=0; i<
pTab
->
nCﬁ
; i++){

484 if–
aXRef
[
i
]<0 ){

485 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pTab
, 
iCur
+
iPk
, 
i
, 
ªgNew
+i);

490 if–!
isVõw
 ){

491 
j1
;

494 
	`as£π
–
bChngPk
==0 || 
bIm∂icôPk
==0 );

495 if–
bChngPk
==0 ) 
aRegIdx
[
iPk
] = 0;

496 
	`sqlôe4Gíî©eC⁄°øötChecks
(

497 
pP¨£
, 
pTab
, 
iCur
, 
ªgNew
, 
aRegIdx
, 
ªgOldKey
, 1, 
⁄Eº‹
, 
addr
, 0

499 if–
bChngPk
==0 ) 
aRegIdx
[
iPk
] = 
ªgOldKey
;

502 if–
hasFK
 ){

503 
	`sqlôe4FkCheck
(
pP¨£
, 
pTab
, 
ªgOld
, 0);

507 
j1
 = 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_NŸFound
, 
iCur
+
iPk
, 0, 
ªgOldKey
, 0, 
P4_INT32
);

508 
	`sqlôe4Gíî©eRowIndexDñëe
(
pP¨£
, 
pTab
, 0, 
iCur
, 
aRegIdx
);

509 
	`sqlôe4VdbeJumpHîe
(
v
, 
j1
);

511 if–
hasFK
 ){

512 
	`sqlôe4FkCheck
(
pP¨£
, 
pTab
, 0, 
ªgNew
);

516 
	`sqlôe4Com∂ëeIn£πi⁄
(
pP¨£
, 
pTab
, 
iCur
, 
ªgNew
, 
aRegIdx
, 1, 0, 0);

521 if–
hasFK
 ){

522 
	`sqlôe4FkA˘i⁄s
(
pP¨£
, 
pTab
, 
pCh™ges
, 
ªgOldTr
);

526 
	`sqlôe4CodeRowTriggî
(
pP¨£
, 
pTriggî
, 
TK_UPDATE
, 
pCh™ges
,

527 
TRIGGER_AFTER
, 
pTab
, 
ªgOldTr
, 
⁄Eº‹
, 
addr
);

532 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
addr
);

533 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr
);

536 
i
=0, 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
, i++){

537 
	`as£π
–
aRegIdx
 );

538 if–
bO≥nAŒ
 || 
aRegIdx
[
i
] ){

539 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Clo£
, 
iCur
+
i
, 0);

547 if–
pP¨£
->
√°ed
==0 &&ÖP¨£->
pTriggîTab
==0 ){

548 
	`sqlôe4Autoö¸emítEnd
(
pP¨£
);

551 
upd©e_˛ónup
:

552 
	`sqlôe4AuthC⁄ãxtP›
(&
sC⁄ãxt
);

553 
	`sqlôe4DbFªe
(
db
, 
aRegIdx
);

554 
	`sqlôe4DbFªe
(
db
, 
aXRef
);

555 
	`sqlôe4SrcLi°Dñëe
(
db
, 
pSrc
);

556 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pCh™ges
);

557 
	`sqlôe4Ex¥Dñëe
(
db
, 
pWhîe
);

559 
	}
}

563 #ifde‡
isVõw


564 #unde‡
isVõw


566 #ifde‡
pTriggî


567 #unde‡
pTriggî


570 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


590 
	$upd©eVútuÆTabÀ
(

591 
P¨£
 *
pP¨£
,

592 
SrcLi°
 *
pSrc
,

593 
TabÀ
 *
pTab
,

594 
Ex¥Li°
 *
pCh™ges
,

595 
Ex¥
 *
pRowid
,

596 *
aXRef
,

597 
Ex¥
 *
pWhîe
,

598 
⁄Eº‹


600 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

601 
Ex¥Li°
 *
pELi°
 = 0;

602 
Sñe˘
 *
pSñe˘
 = 0;

603 
Ex¥
 *
pEx¥
;

604 
ïhemTab
;

605 
i
;

606 
addr
;

607 
iReg
;

608 
sqlôe4
 *
db
 = 
pP¨£
->db;

609 c⁄° *
pVTab
 = (c⁄° *)
	`sqlôe4GëVTabÀ
(
db
, 
pTab
);

610 
Sñe˘De°
 
de°
;

615 
pELi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
, 0, 
	`sqlôe4Ex¥
(
db
, 
TK_ID
, "_rowid_"));

616 if–
pRowid
 ){

617 
pELi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,ÖEList,

618 
	`sqlôe4Ex¥Dup
(
db
, 
pRowid
, 0));

620 
	`as£π
–
pTab
->
iPKey
<0 );

621 
i
=0; i<
pTab
->
nCﬁ
; i++){

622 if–
aXRef
[
i
]>=0 ){

623 
pEx¥
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pCh™ges
->
a
[
aXRef
[
i
]].pExpr, 0);

625 
pEx¥
 = 
	`sqlôe4Ex¥
(
db
, 
TK_ID
, 
pTab
->
aCﬁ
[
i
].
zName
);

627 
pELi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pP¨£
,ÖELi°, 
pEx¥
);

629 
pSñe˘
 = 
	`sqlôe4Sñe˘New
(
pP¨£
, 
pELi°
, 
pSrc
, 
pWhîe
, 0, 0, 0, 0, 0, 0);

634 
	`as£π
–
v
 );

635 
ïhemTab
 = 
pP¨£
->
nTab
++;

636 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_O≥nEphemîÆ
, 
ïhemTab
, 
pTab
->
nCﬁ
+1+(
pRowid
!=0));

640 
	`sqlôe4Sñe˘De°Inô
(&
de°
, 
SRT_TabÀ
, 
ïhemTab
);

641 
	`sqlôe4Sñe˘
(
pP¨£
, 
pSñe˘
, &
de°
);

644 
iReg
 = ++
pP¨£
->
nMem
;

645 
pP¨£
->
nMem
 +
pTab
->
nCﬁ
+1;

646 
addr
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rewöd
, 
ïhemTab
, 0);

647 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
ïhemTab
, 0, 
iReg
);

648 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
ïhemTab
, (
pRowid
?1:0), 
iReg
+1);

649 
i
=0; i<
pTab
->
nCﬁ
; i++){

650 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
ïhemTab
, 
i
+1+(
pRowid
!=0), 
iReg
+2+i);

652 
	`sqlôe4VèbMakeWrôabÀ
(
pP¨£
, 
pTab
);

653 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VUpd©e
, 0, 
pTab
->
nCﬁ
+2, 
iReg
, 
pVTab
, 
P4_VTAB
);

654 
	`sqlôe4VdbeCh™geP5
(
v
, 
⁄Eº‹
==
OE_DeÁu…
 ? 
OE_Ab‹t
 : onError);

655 
	`sqlôe4MayAb‹t
(
pP¨£
);

656 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
ïhemTab
, 
addr
+1);

657 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr
);

658 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Clo£
, 
ïhemTab
, 0);

661 
	`sqlôe4Sñe˘Dñëe
(
db
, 
pSñe˘
);

662 
	}
}

	@src/utf.c

36 
	~"sqlôeI¡.h
"

37 
	~<as£π.h
>

38 
	~"vdbeI¡.h
"

40 #i‚de‡
SQLITE4_AMALGAMATION


45 c⁄° 
	gsqlôe4⁄e
 = 1;

52 c⁄° 
	gsqlôe4Utf8Tøns1
[] = {

64 
	#WRITE_UTF8
(
zOut
, 
c
) { \

65 if–
c
<0x00080 ){ \

66 *
zOut
++ = (
u8
)(
c
&0xFF); \

68 if–
c
<0x00800 ){ \

69 *
zOut
++ = 0xC0 + (
u8
)((
c
>>6)&0x1F); \

70 *
zOut
++ = 0x80 + (
u8
)(
c
 & 0x3F); \

72 if–
c
<0x10000 ){ \

73 *
zOut
++ = 0xE0 + (
u8
)((
c
>>12)&0x0F); \

74 *
zOut
++ = 0x80 + (
u8
)((
c
>>6) & 0x3F); \

75 *
zOut
++ = 0x80 + (
u8
)(
c
 & 0x3F); \

77 *
zOut
++ = 0xF0 + (
u8
)((
c
>>18) & 0x07); \

78 *
zOut
++ = 0x80 + (
u8
)((
c
>>12) & 0x3F); \

79 *
zOut
++ = 0x80 + (
u8
)((
c
>>6) & 0x3F); \

80 *
zOut
++ = 0x80 + (
u8
)(
c
 & 0x3F); \

82 }

	)

84 
	#WRITE_UTF16LE
(
zOut
, 
c
) { \

85 if–
c
<=0xFFFF ){ \

86 *
zOut
++ = (
u8
)(
c
&0x00FF); \

87 *
zOut
++ = (
u8
)((
c
>>8)&0x00FF); \

89 *
zOut
++ = (
u8
)(((
c
>>10)&0x003F) + (((c-0x10000)>>10)&0x00C0)); \

90 *
zOut
++ = (
u8
)(0x00D8 + (((
c
-0x10000)>>18)&0x03)); \

91 *
zOut
++ = (
u8
)(
c
&0x00FF); \

92 *
zOut
++ = (
u8
)(0x00DC + ((
c
>>8)&0x03)); \

94 }

	)

96 
	#WRITE_UTF16BE
(
zOut
, 
c
) { \

97 if–
c
<=0xFFFF ){ \

98 *
zOut
++ = (
u8
)((
c
>>8)&0x00FF); \

99 *
zOut
++ = (
u8
)(
c
&0x00FF); \

101 *
zOut
++ = (
u8
)(0x00D8 + (((
c
-0x10000)>>18)&0x03)); \

102 *
zOut
++ = (
u8
)(((
c
>>10)&0x003F) + (((c-0x10000)>>10)&0x00C0)); \

103 *
zOut
++ = (
u8
)(0x00DC + ((
c
>>8)&0x03)); \

104 *
zOut
++ = (
u8
)(
c
&0x00FF); \

106 }

	)

108 
	#READ_UTF16LE
(
zIn
, 
TERM
, 
c
){ \

109 
c
 = (*
zIn
++); \

110 
c
 +((*
zIn
++)<<8); \

111 if–
c
>=0xD800 && c<0xE000 && 
TERM
 ){ \

112 
c2
 = (*
zIn
++); \

113 
c2
 +((*
zIn
++)<<8); \

114 
c
 = (
c2
&0x03FF) + ((c&0x003F)<<10) + (((c&0x03C0)+0x0040)<<10); \

116 }

	)

118 
	#READ_UTF16BE
(
zIn
, 
TERM
, 
c
){ \

119 
c
 = ((*
zIn
++)<<8); \

120 
c
 +(*
zIn
++); \

121 if–
c
>=0xD800 && c<0xE000 && 
TERM
 ){ \

122 
c2
 = ((*
zIn
++)<<8); \

123 
c2
 +(*
zIn
++); \

124 
c
 = (
c2
&0x03FF) + ((c&0x003F)<<10) + (((c&0x03C0)+0x0040)<<10); \

126 }

	)

155 
	#READ_UTF8
(
zIn
, 
zTîm
, 
c
) \

156 
c
 = *(
zIn
++); \

157 if–
c
>=0xc0 ){ \

158 
c
 = 
sqlôe4Utf8Tøns1
[c-0xc0]; \

159  
zIn
!=
zTîm
 && (*zIn & 0xc0)==0x80 ){ \

160 
c
 = (c<<6Ë+ (0x3‡& *(
zIn
++)); \

162 if–
c
<0x80 \

163 || (
c
&0xFFFFF800)==0xD800 \

164 || (
c
&0xFFFFFFFE)==0xFFFE ){ c = 0xFFFD; } \

165 }

	)

166 
u32
 
	$sqlôe4Utf8Ród
(

167 c⁄° *
zIn
,

168 c⁄° **
pzNext


170 
c
;

175 
c
 = *(*)(
zIn
++);

176 if–
c
>=0xc0 ){

177 
c
 = 
sqlôe4Utf8Tøns1
[c-0xc0];

178  (*
zIn
 & 0xc0)==0x80 ){

179 
c
 = (c<<6Ë+ (0x3‡& *(
zIn
++));

181 if–
c
<0x80

182 || (
c
&0xFFFFF800)==0xD800

183 || (
c
&0xFFFFFFFE)==0xFFFE ){ c = 0xFFFD; }

185 *
pzNext
 = 
zIn
;

186  
c
;

187 
	}
}

194 
	$sqlôe4_°ricmp
(c⁄° *
zLe·
, c⁄° *
zRight
){

195 *
a
, *
b
;

196 
ac
, 
bc
;

197 
a
 = (*)
zLe·
;

198 
b
 = (*)
zRight
;

200 
	`READ_UTF8
(
a
, 0, 
ac
);

201 
ac
 = 
	`sqlôe4_tﬁowî
(ac);

202 
	`READ_UTF8
(
b
, 0, 
bc
);

203 
bc
 = 
	`sqlôe4_tﬁowî
(bc);

204 } 
ac
==
bc
 &&ác!=0 );

205  
ac
 - 
bc
;

206 
	}
}

207 
	$sqlôe4_°∫icmp
(c⁄° *
zLe·
, c⁄° *
zRight
, 
N
){

208 *
a
, *
b
, *
aTîm
, *
bTîm
;

209 
ac
, 
bc
;

210 
a
 = (*)
zLe·
;

211 
b
 = (*)
zRight
;

212 
aTîm
 = 
a
 + 
N
;

213 
bTîm
 = 
b
 + 
N
;

215 
	`READ_UTF8
(
a
, 
aTîm
, 
ac
);

216 
ac
 = 
	`sqlôe4_tﬁowî
(ac);

217 
	`READ_UTF8
(
b
, 
bTîm
, 
bc
);

218 
bc
 = 
	`sqlôe4_tﬁowî
(bc);

219 } 
ac
==
bc
 &&ác!=0 && 
a
<
aTîm
 );

220  
ac
 - 
bc
;

221 
	}
}

230 #i‚de‡
SQLITE4_OMIT_UTF16


238 
	$sqlôe4VdbeMemTøn¶©e
(
Mem
 *
pMem
, 
u8
 
desúedEnc
){

239 *
zIn
;

240 *
zTîm
;

242 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

243 
	`as£π
–
pMem
->
Êags
&
MEM_Så
 );

244 
	`as£π
–
pMem
->
íc
!=
desúedEnc
 );

245 
	`as£π
–
pMem
->
íc
!=0 );

246 
	`as£π
–
pMem
->
n
>=0 );

248 #i‡
	`deföed
(
TRANSLATE_TRACE
Ë&& deföed(
SQLITE4_DEBUG
)

250 
zBuf
[100];

251 
	`sqlôe4VdbeMemPªâyPröt
(
pMem
, 
zBuf
);

252 
	`Ârötf
(
°dîr
, "INPUT: %s\n", 
zBuf
);

256 if–
pMem
->
íc
!=
SQLITE4_UTF8
 && 
desúedEnc
!=SQLITE4_UTF8 ){

259 
u8
 
ãmp
;

260 
rc
;

261 
rc
 = 
	`sqlôe4VdbeMemMakeWrôóbÀ
(
pMem
);

262 if–
rc
!=
SQLITE4_OK
 ){

263 
	`as£π
–
rc
==
SQLITE4_NOMEM
 );

264  
SQLITE4_NOMEM
;

266 
zIn
 = (
u8
*)
pMem
->
z
;

267 
zTîm
 = &
zIn
[
pMem
->
n
&~1];

268  
zIn
<
zTîm
 ){

269 
ãmp
 = *
zIn
;

270 *
zIn
 = *(zIn+1);

271 
zIn
++;

272 *
zIn
++ = 
ãmp
;

274 
pMem
->
íc
 = 
desúedEnc
;

276 
eTøns
;

277 
sqlôe4_buf„r
 
buf
;

278 
sqlôe4_mm
 *
pMM
 = 
	`sqlôe4_db_ív
(
pMem
->
db
)->pMM;

280  
pMem
->
íc
 ){

281 
SQLITE4_UTF8
:

282 if–
desúedEnc
==
SQLITE4_UTF16BE
 ){

283 
eTøns
 = 
SQLITE4_TRANSLATE_UTF8_UTF16BE
;

285 
eTøns
 = 
SQLITE4_TRANSLATE_UTF8_UTF16LE
;

288 
SQLITE4_UTF16BE
:

289 
eTøns
 = 
SQLITE4_TRANSLATE_UTF16BE_UTF8
;

292 
	`as£π
–
pMem
->
íc
==
SQLITE4_UTF16LE
 );

293 
eTøns
 = 
SQLITE4_TRANSLATE_UTF16LE_UTF8
;

297 
	`sqlôe4_buf„r_öô
(&
buf
, 
pMM
);

298 if–0==
	`sqlôe4_å™¶©e
(&
buf
, 
pMem
->
z
,ÖMem->
n
, 
eTøns
) ){

299  
SQLITE4_NOMEM
;

302 
	`sqlôe4VdbeMemRñó£
(
pMem
);

303 
pMem
->
Êags
 &~(
MEM_Sètic
|
MEM_Dyn
|
MEM_Ephem
);

304 
pMem
->
íc
 = 
desúedEnc
;

305 
pMem
->
Êags
 |(
MEM_Tîm
|
MEM_Dyn
);

306 
pMem
->
z
 = (*)
buf
.
p
;

307 
pMem
->
n
 = ()
buf
.n;

308 
pMem
->
zMÆloc
 =ÖMem->
z
;

311 #i‡
	`deföed
(
TRANSLATE_TRACE
Ë&& deföed(
SQLITE4_DEBUG
)

313 
zBuf
[100];

314 
	`sqlôe4VdbeMemPªâyPröt
(
pMem
, 
zBuf
);

315 
	`Ârötf
(
°dîr
, "OUTPUT: %s\n", 
zBuf
);

318  
SQLITE4_OK
;

319 
	}
}

330 
	$sqlôe4VdbeMemH™dÀBom
(
Mem
 *
pMem
){

331 
rc
 = 
SQLITE4_OK
;

332 
u8
 
bom
 = 0;

334 
	`as£π
–
pMem
->
n
>=0 );

335 if–
pMem
->
n
>1 ){

336 
u8
 
b1
 = *(u8*)
pMem
->
z
;

337 
u8
 
b2
 = *(((u8*)
pMem
->
z
) + 1);

338 if–
b1
==0xFE && 
b2
==0xFF ){

339 
bom
 = 
SQLITE4_UTF16BE
;

341 if–
b1
==0xFF && 
b2
==0xFE ){

342 
bom
 = 
SQLITE4_UTF16LE
;

346 if–
bom
 ){

347 
rc
 = 
	`sqlôe4VdbeMemMakeWrôóbÀ
(
pMem
);

348 if–
rc
==
SQLITE4_OK
 ){

349 
pMem
->
n
 -= 2;

350 
	`memmove
(
pMem
->
z
, &pMem->z[2],ÖMem->
n
);

351 
pMem
->
z
[pMem->
n
] = '\0';

352 
pMem
->
z
[pMem->
n
+1] = '\0';

353 
pMem
->
Êags
 |
MEM_Tîm
;

354 
pMem
->
íc
 = 
bom
;

357  
rc
;

358 
	}
}

368 
	$sqlôe4Utf8Ch¨Lí
(c⁄° *
zIn
, 
nByã
){

369 
r
 = 0;

370 c⁄° 
u8
 *
z
 = (c⁄° u8*)
zIn
;

371 c⁄° 
u8
 *
zTîm
;

372 if–
nByã
>=0 ){

373 
zTîm
 = &
z
[
nByã
];

375 
zTîm
 = (c⁄° 
u8
*)(-1);

377 
	`as£π
–
z
<=
zTîm
 );

378  *
z
!=0 && z<
zTîm
 ){

379 
	`SQLITE4_SKIP_UTF8
(
z
);

380 
r
++;

382  
r
;

383 
	}
}

388 #i‡
deföed
(
SQLITE4_TEST
Ë&& deföed(
SQLITE4_DEBUG
)

398 
	$sqlôe4Utf8To8
(*
zIn
){

399 *
zOut
 = 
zIn
;

400 *
zSèπ
 = 
zIn
;

401 
u32
 
c
;

403  
zIn
[0] && 
zOut
<=zIn ){

404 
c
 = 
	`sqlôe4Utf8Ród
(
zIn
, (const **)&zIn);

405 if–
c
!=0xfffd ){

406 
	`WRITE_UTF8
(
zOut
, 
c
);

409 *
zOut
 = 0;

410  ()(
zOut
 - 
zSèπ
);

411 
	}
}

414 #i‚de‡
SQLITE4_OMIT_UTF16


422 *
	$sqlôe4Utf16to8
(
sqlôe4
 *
db
, c⁄° *
z
, 
nByã
, 
u8
 
íc
){

423 
Mem
 
m
;

424 
	`mem£t
(&
m
, 0, (m));

425 
m
.
db
 = db;

426 
	`sqlôe4VdbeMemSëSå
(&
m
, 
z
, 
nByã
, 
íc
, 
SQLITE4_STATIC
, 0);

427 
	`sqlôe4VdbeCh™geEncodög
(&
m
, 
SQLITE4_UTF8
);

428 if–
db
->
mÆlocFaûed
 ){

429 
	`sqlôe4VdbeMemRñó£
(&
m
);

430 
m
.
z
 = 0;

432 
	`as£π
–(
m
.
Êags
 & 
MEM_Tîm
)!=0 || 
db
->
mÆlocFaûed
 );

433 
	`as£π
–(
m
.
Êags
 & 
MEM_Så
)!=0 || 
db
->
mÆlocFaûed
 );

434 
	`as£π
–(
m
.
Êags
 & 
MEM_Dyn
)!=0 || 
db
->
mÆlocFaûed
 );

435 
	`as£π
–
m
.
z
 || 
db
->
mÆlocFaûed
 );

436  
m
.
z
;

437 
	}
}

449 #ifde‡
SQLITE4_ENABLE_STAT3


450 *
	$sqlôe4Utf8to16
(
sqlôe4
 *
db
, 
u8
 
íc
, *
z
, 
n
, *
≤Out
){

451 
Mem
 
m
;

452 
	`mem£t
(&
m
, 0, (m));

453 
m
.
db
 = db;

454 
	`sqlôe4VdbeMemSëSå
(&
m
, 
z
, 
n
, 
SQLITE4_UTF8
, 
SQLITE4_STATIC
, 0);

455 if–
	`sqlôe4VdbeMemTøn¶©e
(&
m
, 
íc
) ){

456 
	`as£π
–
db
->
mÆlocFaûed
 );

459 
	`as£π
–
m
.
z
==m.
zMÆloc
 );

460 *
≤Out
 = 
m
.
n
;

461  
m
.
z
;

462 
	}
}

470 
	$sqlôe4Utf16ByãLí
(c⁄° *
zIn
, 
nCh¨
){

471 
c
;

472 c⁄° *
z
 = 
zIn
;

473 
n
 = 0;

475 if–
SQLITE4_UTF16NATIVE
==
SQLITE4_UTF16BE
 ){

476  
n
<
nCh¨
 ){

477 
	`READ_UTF16BE
(
z
, 1, 
c
);

478 
n
++;

481  
n
<
nCh¨
 ){

482 
	`READ_UTF16LE
(
z
, 1, 
c
);

483 
n
++;

486  ()(
z
-(c⁄° *)
zIn
);

487 
	}
}

492 
	$å™¶©eEncodög
(

493 
eTøns
,

494 c⁄° *
pIn
, 
nIn
,

495 *
pOut
,

496 
sqlôe4_size_t
 *
≤Out


498 
u8
 *
zIn
 = (u8*)
pIn
;

499 
u8
 *
zTîm
 = &
zIn
[
nIn
];

500 
u8
 *
z
 = (u8*)
pOut
;

501 
e16
;

502 
c
;

504 if–
eTøns
==
SQLITE4_TRANSLATE_UTF8_UTF16


505 || 
eTøns
==
SQLITE4_TRANSLATE_UTF16_UTF8


507 
e16
 = 
SQLITE4_UTF16NATIVE
;

508 }if–
eTøns
==
SQLITE4_TRANSLATE_UTF8_UTF16BE


509 || 
eTøns
==
SQLITE4_TRANSLATE_UTF16BE_UTF8


511 
e16
 = 
SQLITE4_UTF16BE
;

513 
e16
 = 
SQLITE4_UTF16LE
;

516 
	`as£π
–(
SQLITE4_TRANSLATE_UTF8_UTF16
 & 0x01)

517 && (
SQLITE4_TRANSLATE_UTF8_UTF16LE
 & 0x01)

518 && (
SQLITE4_TRANSLATE_UTF8_UTF16BE
 & 0x01)

520 if–
eTøns
 & 0x01 ){

521 if–
e16
==
SQLITE4_UTF16LE
 ){

523  
zIn
<
zTîm
 ){

525 
	`READ_UTF8
(
zIn
, 
zTîm
, 
c
);

526 
	`WRITE_UTF16LE
(
z
, 
c
);

529 
	`as£π
–
e16
==
SQLITE4_UTF16BE
 );

531  
zIn
<
zTîm
 ){

533 
	`READ_UTF8
(
zIn
, 
zTîm
, 
c
);

534 
	`WRITE_UTF16BE
(
z
, 
c
);

538 if–
e16
==
SQLITE4_UTF16LE
 ){

540  
zIn
<
zTîm
 ){

541 
	`READ_UTF16LE
(
zIn
, zIn<
zTîm
, 
c
);

542 
	`WRITE_UTF8
(
z
, 
c
);

546  
zIn
<
zTîm
 ){

547 
	`READ_UTF16BE
(
zIn
, zIn<
zTîm
, 
c
);

548 
	`WRITE_UTF8
(
z
, 
c
);

553 *
≤Out
 = (
sqlôe4_size_t
)(
z
 - (
u8
*)
pOut
);

554 if–
eTøns
 & 0x01 ) *
z
++ = 0;

555 *
z
 = 0;

556 
	}
}

563 *
	$sqlôe4_å™¶©e
(

564 
sqlôe4_buf„r
 *
pBuf
,

565 c⁄° *
p
, 
n
,

566 
eTøns


568 
nReq
;

570 
	`as£π
–(
SQLITE4_TRANSLATE_UTF8_UTF16
 & 0x01)

571 && (
SQLITE4_TRANSLATE_UTF8_UTF16LE
 & 0x01)

572 && (
SQLITE4_TRANSLATE_UTF8_UTF16BE
 & 0x01)

574 if–
eTøns
 & 0x01 ){

579 if–
n
<0 ){

580 
u8
 *
z
 = (u8*)
p
;

581  
z
[0] || z[1] ) z += 2;

582 
n
 = 
z
 - (
u8
*)
p
;

584 
nReq
 = 
n
 * 2 + 2;

590 if–
n
<0 )Ç = 
	`sqlôe4SåÀn30
(
p
);

591 
nReq
 = 
n
 * 2 + 1;

594 if–
SQLITE4_OK
!=
	`sqlôe4_buf„r_ªsize
(
pBuf
, 
nReq
) ){

595 
	`sqlôe4_buf„r_˛ór
(
pBuf
);

597 
	`å™¶©eEncodög
(
eTøns
, 
p
, 
n
, 
pBuf
->p, &pBuf->n);

600  
pBuf
->
p
;

601 
	}
}

603 #i‡
deföed
(
SQLITE4_TEST
)

609 
	$sqlôe4UtfSñfTe°
(){

610 
i
, 
t
;

611 
u8
 
zBuf
[20];

612 
u8
 *
z
;

613 
n
;

614 
c
;

616 
i
=0; i<0x00110000; i++){

617 
z
 = 
zBuf
;

618 
	`WRITE_UTF8
(
z
, 
i
);

619 
n
 = ()(
z
-
zBuf
);

620 
	`as£π
–
n
>0 &&Ç<=4 );

621 
z
[0] = 0;

622 
z
 = 
zBuf
;

623 
c
 = 
	`sqlôe4Utf8Ród
((*)
z
, (const **)&z);

624 
t
 = 
i
;

625 if–
i
>=0xD800 && i<=0xDFFF ) 
t
 = 0xFFFD;

626 if–(
i
&0xFFFFFFFE)==0xFFFE ) 
t
 = 0xFFFD;

627 
	`as£π
–
c
==
t
 );

628 
	`as£π
–(
z
-
zBuf
)==
n
 );

630 
i
=0; i<0x00110000; i++){

631 if–
i
>=0xD800 && i<0xE000 ) ;

632 
z
 = 
zBuf
;

633 
	`WRITE_UTF16LE
(
z
, 
i
);

634 
n
 = ()(
z
-
zBuf
);

635 
	`as£π
–
n
>0 &&Ç<=4 );

636 
z
[0] = 0;

637 
z
 = 
zBuf
;

638 
	`READ_UTF16LE
(
z
, 1, 
c
);

639 
	`as£π
–
c
==
i
 );

640 
	`as£π
–(
z
-
zBuf
)==
n
 );

642 
i
=0; i<0x00110000; i++){

643 if–
i
>=0xD800 && i<0xE000 ) ;

644 
z
 = 
zBuf
;

645 
	`WRITE_UTF16BE
(
z
, 
i
);

646 
n
 = ()(
z
-
zBuf
);

647 
	`as£π
–
n
>0 &&Ç<=4 );

648 
z
[0] = 0;

649 
z
 = 
zBuf
;

650 
	`READ_UTF16BE
(
z
, 1, 
c
);

651 
	`as£π
–
c
==
i
 );

652 
	`as£π
–(
z
-
zBuf
)==
n
 );

654 
	}
}

666 
	$sqlôe4_iß um
(
c
){

678 c⁄° 
aE¡ry
[] = {

763 c⁄° 
aAscii
[4] = {

767 if–
c
<128 ){

768  ( (
aAscii
[
c
 >> 5] & (1 << (c & 0x001F)))==0 );

769 }if–
c
<(1<<22) ){

770 
key
 = ((()
c
)<<10) | 0x000003FF;

771 
iRes
;

772 
iHi
 = (
aE¡ry
)/(aEntry[0]) - 1;

773 
iLo
 = 0;

774  
iHi
>=
iLo
 ){

775 
iTe°
 = (
iHi
 + 
iLo
) / 2;

776 if–
key
 >
aE¡ry
[
iTe°
] ){

777 
iRes
 = 
iTe°
;

778 
iLo
 = 
iTe°
+1;

780 
iHi
 = 
iTe°
-1;

783 
	`as£π
–
aE¡ry
[0]<
key
 );

784 
	`as£π
–
key
>=
aE¡ry
[
iRes
] );

785  ((()
c
Ë>((
aE¡ry
[
iRes
]>>10) + (aEntry[iRes]&0x3FF)));

788 
	}
}

799 
	$sqlôe4_tﬁowî
(
c
){

817 c⁄° 
	sTabÀE¡ry
 {

818 
iCode
;

819 
Êags
;

820 
nR™ge
;

821 } 
aE¡ry
[] = {

878 c⁄° 
aiOff
[] = {

891 
ªt
 = 
c
;

893 
	`as£π
–
c
>=0 );

894 
	`as£π
( ()==2 && ()==1 );

896 if–
c
<128 ){

897 if–
c
>='A' && c<='Z' ) 
ªt
 = c + ('a' - 'A');

898 }if–
c
<65536 ){

899 
iHi
 = (
aE¡ry
)/(aEntry[0]) - 1;

900 
iLo
 = 0;

901 
iRes
 = -1;

903  
iHi
>=
iLo
 ){

904 
iTe°
 = (
iHi
 + 
iLo
) / 2;

905 
cmp
 = (
c
 - 
aE¡ry
[
iTe°
].
iCode
);

906 if–
cmp
>=0 ){

907 
iRes
 = 
iTe°
;

908 
iLo
 = 
iTe°
+1;

910 
iHi
 = 
iTe°
-1;

913 
	`as£π
–
iRes
<0 || 
c
>=
aE¡ry
[iRes].
iCode
 );

915 if–
iRes
>=0 ){

916 c⁄° 
TabÀE¡ry
 *
p
 = &
aE¡ry
[
iRes
];

917 if–
c
<(
p
->
iCode
 +Ö->
nR™ge
Ë&& 0==(0x01 &Ö->
Êags
 & (p->iCode ^ c)) ){

918 
ªt
 = (
c
 + (
aiOff
[
p
->
Êags
>>1])) & 0x0000FFFF;

919 
	`as£π
–
ªt
>0 );

924 if–
c
>=66560 && c<66600 ){

925 
ªt
 = 
c
 + 40;

928  
ªt
;

929 
	}
}

	@src/util.c

18 
	~"sqlôeI¡.h
"

19 
	~<°d¨g.h
>

20 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


21 
	~<m©h.h
>

27 #ifde‡
SQLITE4_COVERAGE_TEST


28 
	$sqlôe4Covîage
(
x
){

29 
dummy
 = 0;

30 
dummy
 +()
x
;

31 
	}
}

34 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


41 
	$sqlôe4IsNaN
(
x
){

42 
rc
;

43 #i‡!
	`deföed
(
SQLITE4_HAVE_ISNAN
)

67 #ifde‡
__FAST_MATH__


68 #îr‹ 
SQLôe
 
wûl
 
nŸ
 
w‹k
 
c‹ª˘ly
 
wôh
 
the
 -
fÁ°
-
m©h
 
›ti⁄
 
of
 
GCC
.

70 vﬁ©ûê
y
 = 
x
;

71 vﬁ©ûê
z
 = 
y
;

72 
rc
 = (
y
!=
z
);

74 
rc
 = 
	`i¢™
(
x
);

76 
	`ã°ˇ£
–
rc
 );

77  
rc
;

78 
	}
}

90 c⁄° *
	$sqlôe4CﬁumnTy≥
(c⁄° 
Cﬁumn
 *
pCﬁ
, c⁄° *
zDÊt
){

91 if–
pCﬁ
==0 )  
zDÊt
;

92 if–
pCﬁ
->
zTy≥
 &&ÖCol->zType[0] ) ÖCol->zType;

93  
zDÊt
;

94 
	}
}

100 
	$sqlôe4IsInf
(
r
){

101  
	`isöf
(
r
);

102 
	}
}

114 
	$sqlôe4SåÀn30
(c⁄° *
z
){

115 c⁄° *
z2
 = 
z
;

116 if–
z
==0 )  0;

117  *
z2
 ){ z2++; }

118  0x3ffffff‡& ()(
z2
 - 
z
);

119 
	}
}

142 
	$sqlôe4Eº‹
(
sqlôe4
 *
db
, 
îr_code
, c⁄° *
zF‹m©
, ...){

143 if–
db
 && (db->
pEº
 || (db->pEº = 
	`sqlôe4VÆueNew
(db))!=0) ){

144 
db
->
îrCode
 = 
îr_code
;

145 if–
zF‹m©
 ){

146 *
z
;

147 
va_li°
 
≠
;

148 
	`va_°¨t
(
≠
, 
zF‹m©
);

149 
z
 = 
	`sqlôe4VMPrötf
(
db
, 
zF‹m©
, 
≠
);

150 
	`va_íd
(
≠
);

151 
	`sqlôe4VÆueSëSå
(
db
->
pEº
, -1, 
z
, 
SQLITE4_UTF8
, 
SQLITE4_DYNAMIC
, 0);

153 
	`sqlôe4VÆueSëSå
(
db
->
pEº
, 0, 0, 
SQLITE4_UTF8
, 
SQLITE4_STATIC
, 0);

156 
	}
}

175 
	$sqlôe4Eº‹Msg
(
P¨£
 *
pP¨£
, c⁄° *
zF‹m©
, ...){

176 *
zMsg
;

177 
va_li°
 
≠
;

178 
sqlôe4
 *
db
 = 
pP¨£
->db;

179 
	`va_°¨t
(
≠
, 
zF‹m©
);

180 
zMsg
 = 
	`sqlôe4VMPrötf
(
db
, 
zF‹m©
, 
≠
);

181 
	`va_íd
(
≠
);

182 if–
db
->
suµªssEº
 ){

183 
	`sqlôe4DbFªe
(
db
, 
zMsg
);

185 
pP¨£
->
nEº
++;

186 
	`sqlôe4DbFªe
(
db
, 
pP¨£
->
zEºMsg
);

187 
pP¨£
->
zEºMsg
 = 
zMsg
;

188 
pP¨£
->
rc
 = 
SQLITE4_ERROR
;

190 
	}
}

209 
	$sqlôe4DequŸe
(*
z
){

210 
quŸe
;

211 
i
, 
j
;

212 if–
z
==0 )  -1;

213 
quŸe
 = 
z
[0];

214  
quŸe
 ){

218 '[': 
quŸe
 = ']'; ;

221 
i
=1, 
j
=0; 
	`ALWAYS
(
z
[i]); i++){

222 if–
z
[
i
]==
quŸe
 ){

223 if–
z
[
i
+1]==
quŸe
 ){

224 
z
[
j
++] = 
quŸe
;

225 
i
++;

230 
z
[
j
++] = z[
i
];

233 
z
[
j
] = 0;

234  
j
;

235 
	}
}

251 
	$com∑ª2pow63
(c⁄° *
zNum
, 
ö¸
){

252 
c
 = 0;

253 
i
;

255 c⁄° *
pow63
 = "922337203685477580";

256 
i
=0; 
c
==0 && i<18; i++){

257 
c
 = (
zNum
[
i
*
ö¸
]-
pow63
[i])*10;

259 if–
c
==0 ){

260 
c
 = 
zNum
[18*
ö¸
] - '8';

261 
	`ã°ˇ£
–
c
==(-1) );

262 
	`ã°ˇ£
–
c
==0 );

263 
	`ã°ˇ£
–
c
==(+1) );

265  
c
;

266 
	}
}

277 
	$dekkîMul2
(vﬁ©ûê*
x
, 
y
, 
yy
){

286 vﬁ©ûê
tx
, 
ty
, 
p
, 
q
, 
c
, 
cc
;

287 
hx
, 
hy
;

288 
u64
 
m
;

289 
	`mem˝y
(&
m
, (*)&
x
[0], 8);

290 
m
 &= 0xfffffffffc000000LL;

291 
	`mem˝y
(&
hx
, &
m
, 8);

292 
tx
 = 
x
[0] - 
hx
;

293 
	`mem˝y
(&
m
, &
y
, 8);

294 
m
 &= 0xfffffffffc000000LL;

295 
	`mem˝y
(&
hy
, &
m
, 8);

296 
ty
 = 
y
 - 
hy
;

297 
p
 = 
hx
*
hy
;

298 
q
 = 
hx
*
ty
 + 
tx
*
hy
;

299 
c
 = 
p
+
q
;

300 
cc
 = 
p
 - 
c
 + 
q
 + 
tx
*
ty
;

301 
cc
 = 
x
[0]*
yy
 + x[1]*
y
 + cc;

302 
x
[0] = 
c
 + 
cc
;

303 
x
[1] = 
c
 - x[0];

304 
x
[1] +
cc
;

305 
	}
}

308 #i‡
deföed
(
_MSC_VER
)

309 #¥agm®
w¨nög
(
dißbÀ
 : 4756)

311 
	$sqlôe4AtoF
(c⁄° *
z
, *
pResu…
, 
Àngth
, 
u8
 
íc
){

312 #i‚de‡
SQLITE_OMIT_FLOATING_POINT


313 
ö¸
;

314 c⁄° *
zEnd
;

316 
sign
 = 1;

317 
u64
 
s
 = 0;

318 
d
 = 0;

319 
esign
 = 1;

320 
e
 = 0;

321 
eVÆid
 = 1;

322 
nDigô
 = 0;

323 
eTy≥
 = 1;

325 
	`as£π
–
íc
==
SQLITE4_UTF8
 ||Énc==
SQLITE4_UTF16LE
 ||Énc==
SQLITE4_UTF16BE
 );

326 *
pResu…
 = 0.0;

327 if–
Àngth
==0 )  0;

329 if–
íc
==
SQLITE4_UTF8
 ){

330 
ö¸
 = 1;

331 
zEnd
 = 
z
 + 
Àngth
;

333 
i
;

334 
ö¸
 = 2;

335 
Àngth
 &= ~1;

336 
	`as£π
–
SQLITE4_UTF16LE
==2 && 
SQLITE4_UTF16BE
==3 );

337 
	`ã°ˇ£
–
íc
==
SQLITE4_UTF16LE
 );

338 
	`ã°ˇ£
–
íc
==
SQLITE4_UTF16BE
 );

339 
i
=3-
íc
; i<
Àngth
 && 
z
[i]==0; i+=2){}

340 if–
i
<
Àngth
 ) 
eTy≥
 = -100;

341 
zEnd
 = &
z
[
i
^1];

342 
z
 +(
íc
&1);

346  
z
<
zEnd
 && 
	`sqlôe4Is•a˚
(*zËËz+=
ö¸
;

347 if–
z
>=
zEnd
 )  0;

350 if–*
z
=='-' ){

351 
sign
 = -1;

352 
z
+=
ö¸
;

353 }if–*
z
=='+' ){

354 
z
+=
ö¸
;

358  
z
<
zEnd
 && 
	`sqlôe4Isdigô
(*z) ){

359 
s
 = s*10 + (*
z
 - '0');

360 
z
+=
ö¸
; 
nDigô
++;

361 if–
s
>=((
LARGEST_UINT64
-9)/10) ){

364  
z
<
zEnd
 && 
	`sqlôe4Isdigô
(*zË){ z+=
ö¸
; 
d
++; }

367 if–
z
>=
zEnd
 ) 
do_©of_ˇlc
;

370 if–*
z
=='.' ){

371 
z
+=
ö¸
;

372 
eTy≥
++;

375  
z
<
zEnd
 && 
	`sqlôe4Isdigô
(*z) ){

376 if–
s
<((
LARGEST_UINT64
-9)/10) ){

377 
s
 = s*10 + (*
z
 - '0');

378 
d
--;

379 
nDigô
++;

381 
z
+=
ö¸
;

384 if–
z
>=
zEnd
 ) 
do_©of_ˇlc
;

387 if–*
z
=='e' || *z=='E' ){

388 
z
+=
ö¸
;

389 
eVÆid
 = 0;

390 
eTy≥
++;

395 if–
z
>=
zEnd
 ) 
do_©of_ˇlc
;

398 if–*
z
=='-' ){

399 
esign
 = -1;

400 
z
+=
ö¸
;

401 }if–*
z
=='+' ){

402 
z
+=
ö¸
;

405  
z
<
zEnd
 && 
	`sqlôe4Isdigô
(*z) ){

406 
e
 =É<10000 ? (e*10 + (*
z
 - '0')) : 10000;

407 
z
+=
ö¸
;

408 
eVÆid
 = 1;

413  
z
<
zEnd
 && 
	`sqlôe4Is•a˚
(*zËËz+=
ö¸
;

415 
do_©of_ˇlc
:

417 if–
s
==0 ){

418 *
pResu…
 = 
sign
<0 ? -0.0 : +0.0;

419 
©of_ªtu∫
;

423 
e
 = (e*
esign
Ë+ 
d
;

426  
e
>0 && 
s
<(
LARGEST_UINT64
/10) ){

427 
s
 *= 10;

428 
e
--;

430  
e
<0 && (
s
%10)==0 ){

431 
s
 /= 10;

432 
e
++;

435 if–
e
==0 ){

436 *
pResu…
 = 
s
;

438 
º
[2];

439 
u64
 
s2
;

440 
º
[0] = ()
s
;

441 
s2
 = (
u64
)
º
[0];

442 
º
[1] = 
s
>=
s2
 ? ()(s - s2) : -()(s2 - s);

443 if–
e
>0 ){

444  
e
>=100 ){

445 
e
 -= 100;

446 
	`dekkîMul2
(
º
, 1.0e+100, -1.5902891109759918046e+83);

448  
e
>=10 ){

449 
e
 -= 10;

450 
	`dekkîMul2
(
º
, 1.0e+10, 0.0);

452  
e
>=1 ){

453 
e
 -= 1;

454 
	`dekkîMul2
(
º
, 1.0e+01, 0.0);

457  
e
<=-100 ){

458 
e
 += 100;

459 
	`dekkîMul2
(
º
, 1.0e-100, -1.99918998026028836196e-117);

461  
e
<=-10 ){

462 
e
 += 10;

463 
	`dekkîMul2
(
º
, 1.0e-10, -3.6432197315497741579e-27);

465  
e
<=-1 ){

466 
e
 += 1;

467 
	`dekkîMul2
(
º
, 1.0e-01, -5.5511151231257827021e-18);

470 *
pResu…
 = 
º
[0]+rr[1];

471 if–
	`sqlôe4IsNaN
(*
pResu…
) ) *pResult = 1e300*1e300;

473 if–
sign
<0 ) *
pResu…
 = -*pResult;

474 
	`as£π
–!
	`sqlôe4IsNaN
(*
pResu…
) );

476 
©of_ªtu∫
:

478 if–
z
==
zEnd
 && 
nDigô
>0 && 
eVÆid
 && 
eTy≥
>0 ){

479  
eTy≥
;

480 }if–
eTy≥
>=2 && (eTy≥==3 || 
eVÆid
Ë&& 
nDigô
>0 ){

486  !
	`sqlôe4Atoi64
(
z
, 
pResu…
, 
Àngth
, 
íc
);

488 
	}
}

489 #i‡
deföed
(
_MSC_VER
)

490 #¥agm®
w¨nög
( : 4756)

512 
	$sqlôe4Atoi64
(c⁄° *
zNum
, 
i64
 *
pNum
, 
Àngth
, 
u8
 
íc
){

513 
ö¸
 = (
íc
==
SQLITE4_UTF8
?1:2);

514 
u64
 
u
 = 0;

515 
√g
 = 0;

516 
i
;

517 
c
 = 0;

518 c⁄° *
zSèπ
;

519 c⁄° *
zEnd
 = 
zNum
 + 
Àngth
;

520 if–
íc
==
SQLITE4_UTF16BE
 ) 
zNum
++;

521  
zNum
<
zEnd
 && 
	`sqlôe4Is•a˚
(*zNumËËzNum+=
ö¸
;

522 if–
zNum
<
zEnd
 ){

523 if–*
zNum
=='-' ){

524 
√g
 = 1;

525 
zNum
+=
ö¸
;

526 }if–*
zNum
=='+' ){

527 
zNum
+=
ö¸
;

530 
zSèπ
 = 
zNum
;

531  
zNum
<
zEnd
 && zNum[0]=='0' ){ zNum+=
ö¸
; }

532 
i
=0; &
zNum
[i]<
zEnd
 && (
c
=zNum[i])>='0' && c<='9'; i+=
ö¸
){

533 
u
 = u*10 + 
c
 - '0';

535 if–
u
>
LARGEST_INT64
 ){

536 *
pNum
 = 
SMALLEST_INT64
;

537 }if–
√g
 ){

538 *
pNum
 = -(
i64
)
u
;

540 *
pNum
 = (
i64
)
u
;

542 
	`ã°ˇ£
–
i
==18 );

543 
	`ã°ˇ£
–
i
==19 );

544 
	`ã°ˇ£
–
i
==20 );

545 if–(
c
!=0 && &
zNum
[
i
]<
zEnd
Ë|| (i==0 && 
zSèπ
==zNumË|| i>19*
ö¸
 ){

549 }if–
i
<19*
ö¸
 ){

551 
	`as£π
–
u
<=
LARGEST_INT64
 );

555 
c
 = 
	`com∑ª2pow63
(
zNum
, 
ö¸
);

556 if–
c
<0 ){

558 
	`as£π
–
u
<=
LARGEST_INT64
 );

560 }if–
c
>0 ){

566 
	`as£π
–
u
-1==
LARGEST_INT64
 );

567 
	`as£π
–(*
pNum
)==
SMALLEST_INT64
 );

568  
√g
 ? 0 : 2;

571 
	}
}

581 
	$sqlôe4GëI¡32
(c⁄° *
zNum
, *
pVÆue
){

582 
sqlôe4_öt64
 
v
 = 0;

583 
i
, 
c
;

584 
√g
 = 0;

585 if–
zNum
[0]=='-' ){

586 
√g
 = 1;

587 
zNum
++;

588 }if–
zNum
[0]=='+' ){

589 
zNum
++;

591  
zNum
[0]=='0' ) zNum++;

592 
i
=0; i<11 && (
c
 = 
zNum
[i] - '0')>=0 && c<=9; i++){

593 
v
 = v*10 + 
c
;

601 
	`ã°ˇ£
–
i
==10 );

602 if–
i
>10 ){

605 
	`ã°ˇ£
–
v
-
√g
==2147483647 );

606 if–
v
-
√g
>2147483647 ){

609 if–
√g
 ){

610 
v
 = -v;

612 *
pVÆue
 = ()
v
;

614 
	}
}

620 
	$sqlôe4Atoi
(c⁄° *
z
){

621 
x
 = 0;

622 if–
z
 ) 
	`sqlôe4GëI¡32
(z, &
x
);

623  
x
;

624 
	}
}

629 
u32
 
	$sqlôe4Gë4byã
(c⁄° 
u8
 *
p
){

630  (
p
[0]<<24) | (p[1]<<16) | (p[2]<<8) |Ö[3];

631 
	}
}

632 
	$sqlôe4Put4byã
(*
p
, 
u32
 
v
){

633 
p
[0] = (
u8
)(
v
>>24);

634 
p
[1] = (
u8
)(
v
>>16);

635 
p
[2] = (
u8
)(
v
>>8);

636 
p
[3] = (
u8
)
v
;

637 
	}
}

646 
u8
 
	$sqlôe4HexToI¡
(
h
){

647 
	`as£π
–(
h
>='0' && h<='9') || (h>='a' && h<='f') || (h>='A' && h<='F') );

648 #ifde‡
SQLITE4_ASCII


649 
h
 += 9*(1&(h>>6));

651 #ifde‡
SQLITE4_EBCDIC


652 
h
 += 9*(1&~(h>>4));

654  (
u8
)(
h
 & 0xf);

655 
	}
}

657 #i‡!
deföed
(
SQLITE4_OMIT_BLOB_LITERAL
Ë|| deföed(
SQLITE4_HAS_CODEC
)

664 *
	$sqlôe4HexToBlob
(
sqlôe4
 *
db
, c⁄° *
z
, 
n
){

665 *
zBlob
;

666 
i
;

668 
zBlob
 = (*)
	`sqlôe4DbMÆlocRaw
(
db
, 
n
/2 + 1);

669 
n
--;

670 if–
zBlob
 ){

671 
i
=0; i<
n
; i+=2){

672 
zBlob
[
i
/2] = (
	`sqlôe4HexToI¡
(
z
[i])<<4) | sqlite4HexToInt(z[i+1]);

674 
zBlob
[
i
/2] = 0;

676  
zBlob
;

677 
	}
}

685 
	$logBadC⁄√˘i⁄
(c⁄° *
zTy≥
){

686 
	`sqlôe4_log
(0, 
SQLITE4_MISUSE
,

688 
zTy≥


690 
	}
}

706 
	$sqlôe4Sa„tyCheckOk
(
sqlôe4
 *
db
){

707 
u32
 
magic
;

708 if–
db
==0 ){

709 
	`logBadC⁄√˘i⁄
("NULL");

712 
magic
 = 
db
->magic;

713 if–
magic
!=
SQLITE4_MAGIC_OPEN
 ){

714 if–
	`sqlôe4Sa„tyCheckSickOrOk
(
db
) ){

715 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

716 
	`logBadC⁄√˘i⁄
("unopened");

722 
	}
}

723 
	$sqlôe4Sa„tyCheckSickOrOk
(
sqlôe4
 *
db
){

724 
u32
 
magic
;

725 
magic
 = 
db
->magic;

726 if–
magic
!=
SQLITE4_MAGIC_SICK
 &&

727 
magic
!=
SQLITE4_MAGIC_OPEN
 &&

728 
magic
!=
SQLITE4_MAGIC_BUSY
 ){

729 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

730 
	`logBadC⁄√˘i⁄
("invalid");

735 
	}
}

743 
	$sqlôe4AddI¡64
(
i64
 *
pA
, i64 
iB
){

744 
i64
 
iA
 = *
pA
;

745 
	`ã°ˇ£
–
iA
==0 );Åestcase( iA==1 );

746 
	`ã°ˇ£
–
iB
==-1 );Åestcase( iB==0 );

747 if–
iB
>=0 ){

748 
	`ã°ˇ£
–
iA
>0 && 
LARGEST_INT64
 - iA =
iB
 );

749 
	`ã°ˇ£
–
iA
>0 && 
LARGEST_INT64
 - iA =
iB
 - 1 );

750 if–
iA
>0 && 
LARGEST_INT64
 - iA < 
iB
 )  1;

751 *
pA
 +
iB
;

753 
	`ã°ˇ£
–
iA
<0 && -(iA + 
LARGEST_INT64
Ë=
iB
 + 1 );

754 
	`ã°ˇ£
–
iA
<0 && -(iA + 
LARGEST_INT64
Ë=
iB
 + 2 );

755 if–
iA
<0 && -(iA + 
LARGEST_INT64
Ë> 
iB
 + 1 )  1;

756 *
pA
 +
iB
;

759 
	}
}

760 
	$sqlôe4SubI¡64
(
i64
 *
pA
, i64 
iB
){

761 
	`ã°ˇ£
–
iB
==
SMALLEST_INT64
+1 );

762 if–
iB
==
SMALLEST_INT64
 ){

763 
	`ã°ˇ£
–(*
pA
)==(-1) );Åestcase( (*pA)==0 );

764 if–(*
pA
)>=0 )  1;

765 *
pA
 -
iB
;

768  
	`sqlôe4AddI¡64
(
pA
, -
iB
);

770 
	}
}

771 
	#TWOPOWER32
 (((
i64
)1)<<32)

	)

772 
	#TWOPOWER31
 (((
i64
)1)<<31)

	)

773 
	$sqlôe4MulI¡64
(
i64
 *
pA
, i64 
iB
){

774 
i64
 
iA
 = *
pA
;

775 
i64
 
iA1
, 
iA0
, 
iB1
, 
iB0
, 
r
;

777 
iA1
 = 
iA
/
TWOPOWER32
;

778 
iA0
 = 
iA
 % 
TWOPOWER32
;

779 
iB1
 = 
iB
/
TWOPOWER32
;

780 
iB0
 = 
iB
 % 
TWOPOWER32
;

781 if–
iA1
*
iB1
 != 0 )  1;

782 
	`as£π
–
iA1
*
iB0
==0 || 
iA0
*
iB1
==0 );

783 
r
 = 
iA1
*
iB0
 + 
iA0
*
iB1
;

784 
	`ã°ˇ£
–
r
==(-
TWOPOWER31
)-1 );

785 
	`ã°ˇ£
–
r
==(-
TWOPOWER31
) );

786 
	`ã°ˇ£
–
r
==
TWOPOWER31
 );

787 
	`ã°ˇ£
–
r
==
TWOPOWER31
-1 );

788 if–
r
<(-
TWOPOWER31
) ||Ñ>=TWOPOWER31 )  1;

789 
r
 *
TWOPOWER32
;

790 if–
	`sqlôe4AddI¡64
(&
r
, 
iA0
*
iB0
) )  1;

791 *
pA
 = 
r
;

793 
	}
}

799 
	$sqlôe4AbsI¡32
(
x
){

800 if–
x
>=0 )  x;

801 if–
x
==()0x80000000 )  0x7fffffff;

802  -
x
;

803 
	}
}

805 #ifde‡
SQLITE4_ENABLE_8_3_NAMES


823 
	$sqlôe4FûeSuffix3
(c⁄° *
zBa£Fûíame
, *
z
){

824 #i‡
SQLITE4_ENABLE_8_3_NAMES
<2

825 if–
	`sqlôe4_uri_boﬁón
(
zBa£Fûíame
, "8_3_names", 0) )

828 
i
, 
sz
;

829 
sz
 = 
	`sqlôe4SåÀn30
(
z
);

830 
i
=
sz
-1; i>0 && 
z
[i]!='/' && z[i]!='.'; i--){}

831 if–
z
[
i
]=='.' && 
	`ALWAYS
(
sz
>i+4ËË
	`memmove
(&z[i+1], &z[sz-3], 4);

833 
	}
}

	@src/varint.c

96 
	~"sqlôeI¡.h
"

105 
	$sqlôe4GëV¨öt64
(

106 c⁄° *
z
,

107 
n
,

108 
sqlôe4_uöt64
 *
pResu…


110 
x
;

111 if–
n
<1 )  0;

112 if–
z
[0]<=240 ){

113 *
pResu…
 = 
z
[0];

116 if–
z
[0]<=248 ){

117 if–
n
<2 )  0;

118 *
pResu…
 = (
z
[0]-241)*256 + z[1] + 240;

121 if–
n
<
z
[0]-246 )  0;

122 if–
z
[0]==249 ){

123 *
pResu…
 = 2288 + 256*
z
[1] + z[2];

126 if–
z
[0]==250 ){

127 *
pResu…
 = (
z
[1]<<16) + (z[2]<<8) + z[3];

130 
x
 = (
z
[1]<<24) + (z[2]<<16) + (z[3]<<8) + z[4];

131 if–
z
[0]==251 ){

132 *
pResu…
 = 
x
;

135 if–
z
[0]==252 ){

136 *
pResu…
 = (((
sqlôe4_uöt64
)
x
)<<8Ë+ 
z
[5];

139 if–
z
[0]==253 ){

140 *
pResu…
 = (((
sqlôe4_uöt64
)
x
)<<16Ë+ (
z
[5]<<8) + z[6];

143 if–
z
[0]==254 ){

144 *
pResu…
 = (((
sqlôe4_uöt64
)
x
)<<24Ë+ (
z
[5]<<16) + (z[6]<<8) + z[7];

147 *
pResu…
 = (((
sqlôe4_uöt64
)
x
)<<32) +

148 (0xfffffff‡& ((
z
[5]<<24) + (z[6]<<16) + (z[7]<<8) + z[8]));

150 
	}
}

155 
	$v¨ötWrôe32
(*
z
, 
y
){

156 
z
[0] = ()(
y
>>24);

157 
z
[1] = ()(
y
>>16);

158 
z
[2] = ()(
y
>>8);

159 
z
[3] = ()(
y
);

160 
	}
}

167 
	$sqlôe4PutV¨öt64
(*
z
, 
sqlôe4_uöt64
 
x
){

168 
w
, 
y
;

169 if–
x
<=240 ){

170 
z
[0] = ()
x
;

173 if–
x
<=2287 ){

174 
y
 = ()(
x
 - 240);

175 
z
[0] = ()(
y
/256 + 241);

176 
z
[1] = ()(
y
%256);

179 if–
x
<=67823 ){

180 
y
 = ()(
x
 - 2288);

181 
z
[0] = 249;

182 
z
[1] = ()(
y
/256);

183 
z
[2] = ()(
y
%256);

186 
y
 = ()
x
;

187 
w
 = ()(
x
>>32);

188 if–
w
==0 ){

189 if–
y
<=16777215 ){

190 
z
[0] = 250;

191 
z
[1] = ()(
y
>>16);

192 
z
[2] = ()(
y
>>8);

193 
z
[3] = ()(
y
);

196 
z
[0] = 251;

197 
	`v¨ötWrôe32
(
z
+1, 
y
);

200 if–
w
<=255 ){

201 
z
[0] = 252;

202 
z
[1] = ()
w
;

203 
	`v¨ötWrôe32
(
z
+2, 
y
);

206 if–
w
<=65535 ){

207 
z
[0] = 253;

208 
z
[1] = ()(
w
>>8);

209 
z
[2] = ()
w
;

210 
	`v¨ötWrôe32
(
z
+3, 
y
);

213 if–
w
<=16777215 ){

214 
z
[0] = 254;

215 
z
[1] = ()(
w
>>16);

216 
z
[2] = ()(
w
>>8);

217 
z
[3] = ()
w
;

218 
	`v¨ötWrôe32
(
z
+4, 
y
);

221 
z
[0] = 255;

222 
	`v¨ötWrôe32
(
z
+1, 
w
);

223 
	`v¨ötWrôe32
(
z
+5, 
y
);

225 
	}
}

230 
	$sqlôe4V¨ötLí
(
sqlôe4_uöt64
 
v
){

231 
aDummy
[9];

232  
	`sqlôe4PutV¨öt64
(
aDummy
, 
v
);

233 
	}
}

239 
	$sqlôe4GëV¨öt32
(c⁄° *
z
, 
u32
 *
pResu…
){

240 
sqlôe4_uöt64
 
iRes
;

241 
ªt
;

242 
ªt
 = 
	`sqlôe4GëV¨öt64
(
z
, 9, &
iRes
);

243 *
pResu…
 = (
u32
)
iRes
;

244  
ªt
;

245 
	}
}

251 
	$sqlôe4PutV¨öt32
(*
p
, 
u32
 
v
){

252  
	`sqlôe4PutV¨öt64
(
p
, 
v
);

253 
	}
}

262 #ifde‡
TEST_VARINT


263 
	$øndI¡
(){

264 
rx
 = 1;

265 
ry
 = 0;

266 
rx
 = (rx>>1) ^ (-(rx&1) & 0xd0000001);

267 
ry
 =Ñy*1103515245 + 12345;

268  
rx
 ^ 
ry
;

269 
	}
}

270 
	$maö
(
¨gc
,**
¨gv
){

271 
sqlôe4_uöt64
 
x
, 
y
, 
px
;

272 
i
, 
n1
, 
n2
, 
≤
;

273 
nbô
;

274 
z
[20], 
zp
[20];

276 
i
=0; i<10000000; i++){

277 
x
 = 
	`øndI¡
();

278 
x
 = (x<<32Ë+ 
	`øndI¡
();

279 
nbô
 = 
	`øndI¡
()%65;

280 if–
nbô
<64 ){

281 
x
 &(((
sqlôe4_uöt64
)1)<<
nbô
)-1;

283 
n1
 = 
	`sqlôe4PutV¨öt64
(
z
, 
x
);

284 
	`as£π
–
n1
>=1 &&Ç1<=9 );

285 
n2
 = 
	`sqlôe4GëV¨öt64
(
z
, 
n1
, &
y
);

286 
	`as£π
–
n1
==
n2
 );

287 
	`as£π
–
x
==
y
 );

288 
n2
 = 
	`sqlôe4GëV¨öt64
(
z
, 
n1
-1, &
y
);

289 
	`as£π
–
n2
==0 );

290 if–
i
>0 ){

291 
c
 = 
	`memcmp
(
z
,
zp
,
≤
<
n1
?pn:n1);

292 if–
x
<
px
 ){

293 
	`as£π
–
c
<0 );

294 }if–
x
>
px
 ){

295 
	`as£π
–
c
>0 );

297 
	`as£π
–
c
==0 );

300 
	`mem˝y
(
zp
, 
z
, 
n1
);

301 
≤
 = 
n1
;

302 
px
 = 
x
;

306 
	`¥ötf
("%dÅe°†wôh 0Éº‹s\n", 
i
);

308 
	}
}

317 #ifde‡
VARINT_TOOL


318 
	$hexToI¡
(
c
){

319 if–
c
>='0' && c<='9' )  c - '0';

320 if–
c
>='a' && c<='f' )  c - 'a' + 10;

321 if–
c
>='A' && c<='F' )  c - 'A' + 10;

323 
	}
}

324 
	$maö
(
¨gc
, **
¨gv
){

325 
i
, 
j
, 
n
;

326 
sqlôe4_uöt64
 
x
;

327 
out
[20];

328 if–
¨gc
<=1 ){

329 
	`¥ötf
("Usage: %s N =X ...\n"

332 
¨gv
[0]);

335 
i
=1; i<
¨gc
; i++){

336 c⁄° *
z
 = 
¨gv
[
i
];

337 
x
 = 0;

338 if–
z
[0]=='=' ){

339 
j
=1; j/2<(
out
Ë&& 
z
[j] && z[j+1]; j+=2 ){

340 
out
[
j
/2] = 
	`hexToI¡
(
z
[j])*16 + hexToInt(z[j+1]);

342 
	`sqlôe4GëV¨öt64
(
out
, 
j
/2, &
x
);

344  
z
[0]>='0' && z[0]<='9' ){

345 
x
 = x*10 + 
z
[0] - '0';

346 
z
++;

349 
n
 = 
	`sqlôe4PutV¨öt64
(
out
, 
x
);

350 
	`¥ötf
("%Œu = ", ()
x
);

351 
j
=0; j<
n
; j++Ë
	`¥ötf
("%02x", 
out
[j]&0xff);

352 
	`¥ötf
("\n");

355 
	}
}

	@src/vdbe.c

46 
	~"sqlôeI¡.h
"

47 
	~"vdbeI¡.h
"

54 #ifde‡
SQLITE4_DEBUG


55 
	#memAboutToCh™ge
(
P
,
M
Ë
	`sqlôe4VdbeMemAboutToCh™ge
(P,M)

	)

57 
	#memAboutToCh™ge
(
P
,
M
)

	)

67 #ifde‡
SQLITE4_TEST


68 
	gsqlôe4_£¨ch_cou¡
 = 0;

79 #ifde‡
SQLITE4_TEST


80 
	gsqlôe4_öãºu±_cou¡
 = 0;

90 #ifde‡
SQLITE4_TEST


91 
	gsqlôe4_s‹t_cou¡
 = 0;

101 #ifde‡
SQLITE4_TEST


102 
	gsqlôe4_max_blobsize
 = 0;

103 
	$upd©eMaxBlobsize
(
Mem
 *
p
){

104 if–(
p
->
Êags
 & (
MEM_Så
|
MEM_Blob
))!=0 &&Ö->
n
>
sqlôe4_max_blobsize
 ){

105 
sqlôe4_max_blobsize
 = 
p
->
n
;

107 
	}
}

117 #ifde‡
SQLITE4_TEST


118 
	gsqlôe4_found_cou¡
 = 0;

125 #i‡
deföed
(
SQLITE4_TEST
Ë&& !deföed(
SQLITE4_OMIT_BUILTIN_TEST
)

126 
	#UPDATE_MAX_BLOBSIZE
(
P
Ë
	`upd©eMaxBlobsize
(P)

	)

128 
	#UPDATE_MAX_BLOBSIZE
(
P
)

	)

135 
	#Såögify
(
P
, 
íc
) \

136 if(((
P
)->
Êags
&(
MEM_Så
|
MEM_Blob
))==0 && 
	`sqlôe4VdbeMemSåögify
(P,
íc
)) \

137 { 
no_mem
; }

	)

150 
	#DìphemîÆize
(
P
) \

151 if–((
P
)->
Êags
&
MEM_Ephem
)!=0 \

152 && 
	`sqlôe4VdbeMemMakeWrôóbÀ
(
P
Ë){ 
no_mem
;}

	)

160 
	$sqlôe4VdbeMemSt‹eTy≥
(
Mem
 *
pMem
){

161 
Êags
 = 
pMem
->flags;

162 if–
Êags
 & 
MEM_NuŒ
 ){

163 
pMem
->
ty≥
 = 
SQLITE4_NULL
;

165 if–
Êags
 & 
MEM_I¡
 ){

166 
pMem
->
ty≥
 = 
SQLITE4_INTEGER
;

168 if–
Êags
 & 
MEM_Ról
 ){

169 
pMem
->
ty≥
 = 
SQLITE4_FLOAT
;

171 if–
Êags
 & 
MEM_Så
 ){

172 
pMem
->
ty≥
 = 
SQLITE4_TEXT
;

174 
pMem
->
ty≥
 = 
SQLITE4_BLOB
;

176 
	}
}

182 
VdbeCurs‹
 *
	$ÆloˇãCurs‹
(

183 
Vdbe
 *
p
,

184 
iCur
,

185 
nFõld
,

186 
iDb
,

187 
isTrueCurs‹


203 
Mem
 *
pMem
 = &
p
->
aMem
[p->
nMem
-
iCur
];

205 
nByã
;

206 
VdbeCurs‹
 *
pCx
 = 0;

207 
nByã
 =

208 
	`ROUND8
((
VdbeCurs‹
)) +

209 2*
nFõld
*(
u32
);

211 
	`as£π
–
iCur
<
p
->
nCurs‹
 );

212 if–
p
->
≠C§
[
iCur
] ){

213 
	`sqlôe4VdbeFªeCurs‹
(
p
->
≠C§
[
iCur
]);

214 
p
->
≠C§
[
iCur
] = 0;

216 if–
SQLITE4_OK
==
	`sqlôe4VdbeMemGrow
(
pMem
, 
nByã
, 0) ){

217 
p
->
≠C§
[
iCur
] = 
pCx
 = (
VdbeCurs‹
*)
pMem
->
z
;

218 
	`mem£t
(
pCx
, 0, (
VdbeCurs‹
));

219 
pCx
->
db
 = 
p
->db;

220 
pCx
->
iDb
 = iDb;

221 
pCx
->
nFõld
 =ÇField;

222 
pCx
->
rowChnged
 = 1;

223 
	`sqlôe4_buf„r_öô
(&
pCx
->
sSìkKey
, 
p
->
db
->
pEnv
->
pMM
);

225  
pCx
;

226 
	}
}

234 
	$≠∂yNumîicAfföôy
(
Mem
 *
pRec
){

235 if–(
pRec
->
Êags
 & (
MEM_Ról
|
MEM_I¡
))==0 && (pRec->Êag†& 
MEM_Så
) ){

236 
Êags
 = 
pRec
->
íc
 | 
SQLITE4_IGNORE_WHITESPACE
;

237 
bRól
 = 0;

238 
sqlôe4_num
 
num
;

240 
num
 = 
	`sqlôe4_num_‰om_ãxt
(
pRec
->
z
,ÖRec->
n
, 
Êags
, &
bRól
);

241 if–
	`sqlôe4_num_i¢™
(
num
)==0 ){

242 
pRec
->
u
.
num
 =Çum;

243 
	`MemSëTy≥Fœg
(
pRec
, (
bRól
 ? 
MEM_Ról
 : 
MEM_I¡
));

246 
	}
}

266 
	$≠∂yAfföôy
(

267 
Mem
 *
pRec
,

268 
afföôy
,

269 
u8
 
íc


271 if–
afföôy
==
SQLITE4_AFF_TEXT
 ){

276 if–0==(
pRec
->
Êags
&
MEM_Så
Ë&& (pRec->Êags&(
MEM_Ról
|
MEM_I¡
)) ){

277 
	`sqlôe4VdbeMemSåögify
(
pRec
, 
íc
);

279 
pRec
->
Êags
 &~(
MEM_Ról
|
MEM_I¡
);

280 }if–
afföôy
!=
SQLITE4_AFF_NONE
 ){

281 
	`as£π
–
afföôy
==
SQLITE4_AFF_INTEGER
 ||áfföôy==
SQLITE4_AFF_REAL


282 || 
afföôy
==
SQLITE4_AFF_NUMERIC
 );

283 
	`≠∂yNumîicAfföôy
(
pRec
);

284 if–
pRec
->
Êags
 & 
MEM_Ról
 ){

285 
	`sqlôe4VdbeI¡egîAfföôy
(
pRec
);

288 
	}
}

296 
	$sqlôe4_vÆue_numîic_ty≥
(
sqlôe4_vÆue
 *
pVÆ
){

297 
Mem
 *
pMem
 = (Mem*)
pVÆ
;

298 if–
pMem
->
ty≥
==
SQLITE4_TEXT
 ){

299 
	`≠∂yNumîicAfföôy
(
pMem
);

300 
	`sqlôe4VdbeMemSt‹eTy≥
(
pMem
);

302  
pMem
->
ty≥
;

303 
	}
}

305 
sqlôe4_num
 
	$sqlôe4_vÆue_num
(
sqlôe4_vÆue
 *
pVÆ
){

306  
	`sqlôe4VdbeNumVÆue
((
Mem
*)
pVÆ
);

307 
	}
}

313 
	$sqlôe4VÆueAµlyAfföôy
(

314 
sqlôe4_vÆue
 *
pVÆ
,

315 
u8
 
afföôy
,

316 
u8
 
íc


318 
	`≠∂yAfföôy
((
Mem
 *)
pVÆ
, 
afföôy
, 
íc
);

319 
	}
}

321 #ifde‡
SQLITE4_DEBUG


326 
	$sqlôe4VdbeMemPªâyPröt
(
Mem
 *
pMem
, *
zBuf
){

327 *
zC§
 = 
zBuf
;

328 
f
 = 
pMem
->
Êags
;

330 c⁄° *c⁄° 
í˙ames
[] = {"(X)", "(8)", "(16LE)", "(16BE)"};

332 if–
f
&
MEM_Blob
 ){

333 
i
;

334 
c
;

335 if–
f
 & 
MEM_Dyn
 ){

336 
c
 = 'z';

337 
	`as£π
–(
f
 & (
MEM_Sètic
|
MEM_Ephem
))==0 );

338 }if–
f
 & 
MEM_Sètic
 ){

339 
c
 = 't';

340 
	`as£π
–(
f
 & (
MEM_Dyn
|
MEM_Ephem
))==0 );

341 }if–
f
 & 
MEM_Ephem
 ){

342 
c
 = 'e';

343 
	`as£π
–(
f
 & (
MEM_Sètic
|
MEM_Dyn
))==0 );

345 
c
 = 's';

348 
zC§
 +
	`sqlôe4_¢¥ötf
(zC§, 100, "%c", 
c
);

349 
zC§
 +
	`sqlôe4_¢¥ötf
(zC§, 100, "%d[", 
pMem
->
n
);

350 
i
=0; i<16 && i<
pMem
->
n
; i++){

351 
zC§
 +
	`sqlôe4_¢¥ötf
(zC§, 100, "%02X", (()
pMem
->
z
[
i
] & 0xFF));

353 
i
=0; i<16 && i<
pMem
->
n
; i++){

354 
z
 = 
pMem
->z[
i
];

355 if–
z
<32 || z>126 ) *
zC§
++ = '.';

356 *
zC§
++ = 
z
;

359 
zC§
 +
	`sqlôe4_¢¥ötf
(zC§, 100, "]%s", 
í˙ames
[
pMem
->
íc
]);

360 *
zC§
 = '\0';

361 }if–
f
 & 
MEM_Så
 ){

362 
j
, 
k
;

363 
zBuf
[0] = ' ';

364 if–
f
 & 
MEM_Dyn
 ){

365 
zBuf
[1] = 'z';

366 
	`as£π
–(
f
 & (
MEM_Sètic
|
MEM_Ephem
))==0 );

367 }if–
f
 & 
MEM_Sètic
 ){

368 
zBuf
[1] = 't';

369 
	`as£π
–(
f
 & (
MEM_Dyn
|
MEM_Ephem
))==0 );

370 }if–
f
 & 
MEM_Ephem
 ){

371 
zBuf
[1] = 'e';

372 
	`as£π
–(
f
 & (
MEM_Sètic
|
MEM_Dyn
))==0 );

374 
zBuf
[1] = 's';

376 
k
 = 2;

377 
k
 +
	`sqlôe4_¢¥ötf
(&
zBuf
[k], 100, "%d", 
pMem
->
n
);

378 
zBuf
[
k
++] = '[';

379 
j
=0; j<15 && j<
pMem
->
n
; j++){

380 
u8
 
c
 = 
pMem
->
z
[
j
];

381 if–
c
>=0x20 && c<0x7f ){

382 
zBuf
[
k
++] = 
c
;

384 
zBuf
[
k
++] = '.';

387 
zBuf
[
k
++] = ']';

388 
k
 +
	`sqlôe4_¢¥ötf
(&
zBuf
[k], 100, 
í˙ames
[
pMem
->
íc
]);

389 
zBuf
[
k
++] = 0;

391 
	}
}

394 #ifde‡
SQLITE4_DEBUG


398 
	$memTø˚Pröt
(
FILE
 *
out
, 
Mem
 *
p
){

399 if–
p
->
Êags
 & 
MEM_NuŒ
 ){

400 
	`Ârötf
(
out
, " NULL");

401 }if–
p
->
Êags
 & (
MEM_I¡
|
MEM_Ról
) ){

402 
aNum
[31];

403 *
zFœgs
 = "r";

404 
	`sqlôe4_num_to_ãxt
(
p
->
u
.
num
, 
aNum
, (p->
Êags
 & 
MEM_Ról
));

405 if–(
p
->
Êags
 & (
MEM_I¡
|
MEM_Så
))==(MEM_Int|MEM_Str) ){

406 
zFœgs
 = "si";

407 }if–
p
->
Êags
 & 
MEM_I¡
 ){

408 
zFœgs
 = "i";

410 
	`Ârötf
(
out
, " %s:%s", 
zFœgs
, 
aNum
);

411 }if–
p
->
Êags
 & 
MEM_RowSë
 ){

412 
	`Ârötf
(
out
, " (keyset)");

414 
zBuf
[200];

415 
	`sqlôe4VdbeMemPªâyPröt
(
p
, 
zBuf
);

416 
	`Ârötf
(
out
, " ");

417 
	`Ârötf
(
out
, "%s", 
zBuf
);

419 
	}
}

420 
	$ªgi°îTø˚
(
FILE
 *
out
, 
iReg
, 
Mem
 *
p
){

421 
	`Ârötf
(
out
, "REG[%d] = ", 
iReg
);

422 
	`memTø˚Pröt
(
out
, 
p
);

423 
	`Ârötf
(
out
, "\n");

424 
	}
}

427 #ifde‡
SQLITE4_DEBUG


428 
	$as£πFœgsOk
(
Mem
 *
p
){

429 
u16
 
Êags
 = 
p
->flags;

430 
	`as£π
–(
Êags
&
MEM_I¡
)==0 || (Êags&
MEM_Ról
)==0 );

432 
	}
}

435 #ifde‡
SQLITE4_DEBUG


436 
	#REGISTER_TRACE
(
R
,
M
) \

437 if(
	`as£πFœgsOk
(
M
Ë&& 
p
->
åa˚
)
	`ªgi°îTø˚
’->åa˚,
R
,M)

	)

439 
	#REGISTER_TRACE
(
R
,
M
)

	)

443 #ifde‡
VDBE_PROFILE


449 
	~"hwtime.h
"

463 
	#CHECK_FOR_INTERRUPT
 \

464 if–
db
->
u1
.
isI¡îru±ed
 ) 
ab‹t_due_to_öãºu±
;

	)

471  
	$imp‹tVèbEºMsg
(
Vdbe
 *
p
, 
sqlôe4_vèb
 *
pVèb
){

472 
sqlôe4
 *
db
 = 
p
->db;

473 
	`sqlôe4DbFªe
(
db
, 
p
->
zEºMsg
);

474 
p
->
zEºMsg
 = 
	`sqlôe4DbSåDup
(
db
, 
pVèb
->zErrMsg);

475 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
pVèb
->
zEºMsg
);

476 
pVèb
->
zEºMsg
 = 0;

477 
	}
}

482 
Mem
 *
	$sqlôe4Regi°îInRoŸFøme
(
Vdbe
 *
p
, 
i
){

483 if–
p
->
pFøme
 ){

484 
VdbeFøme
 *
pFøme
;

485 
pFøme
=
p
->pFøme;ÖFøme->
pP¨ít
;ÖFrame=pFrame->pParent);

486  &
pFøme
->
aMem
[
i
];

488  &
p
->
aMem
[
i
];

490 
	}
}

523 
	$sqlôe4VdbeExec
(

524 
Vdbe
 *
p


526 
pc
=0;

527 
Op
 *
aOp
 = 
p
->aOp;

528 
Op
 *
pOp
;

529 
rc
 = 
SQLITE4_OK
;

530 
sqlôe4
 *
db
 = 
p
->db;

531 
u8
 
ª£tSchemaOnFau…
 = 0;

532 
u8
 
ícodög
 = 
	`ENC
(
db
);

533 #i‚de‡
SQLITE4_OMIT_PROGRESS_CALLBACK


534 
checkProgªss
;

535 
nProgªssOps
 = 0;

537 
Mem
 *
aMem
 = 
p
->aMem;

538 
Mem
 *
pIn1
 = 0;

539 
Mem
 *
pIn2
 = 0;

540 
Mem
 *
pIn3
 = 0;

541 
Mem
 *
pOut
 = 0;

542 
iCom∑ª
 = 0;

543 *
aPîmuã
 = 0;

544 #ifde‡
VDBE_PROFILE


545 
u64
 
°¨t
;

546 
‹igPc
;

550 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_RUN
 );

551 if–
p
->
rc
==
SQLITE4_NOMEM
 ){

554 
no_mem
;

556 
	`as£π
–
p
->
rc
==
SQLITE4_OK
 ||Ö->rc==
SQLITE4_BUSY
 );

557 
p
->
rc
 = 
SQLITE4_OK
;

558 
	`as£π
–
p
->
ex∂aö
==0 );

559 
p
->
pResu…Së
 = 0;

560 
CHECK_FOR_INTERRUPT
;

561 
	`sqlôe4VdbeIOTø˚Sql
(
p
);

562 #i‚de‡
SQLITE4_OMIT_PROGRESS_CALLBACK


563 
checkProgªss
 = 
db
->
xProgªss
!=0;

565 #ifde‡
SQLITE4_DEBUG


566 
	`sqlôe4BegöBíignMÆloc
(
db
->
pEnv
);

567 if–
p
->
pc
==0 && (
db
->
Êags
 & 
SQLITE4_VdbeLi°ög
)!=0 ){

568 
i
;

569 
	`¥ötf
("VDBE Program Listing:\n");

570 
	`sqlôe4VdbePrötSql
(
p
);

571 
i
=0; i<
p
->
nOp
; i++){

572 
	`sqlôe4VdbePrötOp
(
°dout
, 
i
, &
aOp
[i]);

575 
	`sqlôe4EndBíignMÆloc
(
db
->
pEnv
);

577 
pc
=
p
->pc; 
rc
==
SQLITE4_OK
;Öc++){

578 
	`as£π
–
pc
>=0 &&Öc<
p
->
nOp
 );

579 if–
db
->
mÆlocFaûed
 ) 
no_mem
;

580 #ifde‡
VDBE_PROFILE


581 
‹igPc
 = 
pc
;

582 
°¨t
 = 
	`sqlôe4Hwtime
();

584 
pOp
 = &
aOp
[
pc
];

588 #ifde‡
SQLITE4_DEBUG


589 if–
p
->
åa˚
 ){

590 if–
pc
==0 ){

591 
	`¥ötf
("VDBE Execution Trace:\n");

592 
	`sqlôe4VdbePrötSql
(
p
);

594 
	`sqlôe4VdbePrötOp
(
p
->
åa˚
, 
pc
, 
pOp
);

602 #ifde‡
SQLITE4_TEST


603 if–
sqlôe4_öãºu±_cou¡
>0 ){

604 
sqlôe4_öãºu±_cou¡
--;

605 if–
sqlôe4_öãºu±_cou¡
==0 ){

606 
	`sqlôe4_öãºu±
(
db
);

611 #i‚de‡
SQLITE4_OMIT_PROGRESS_CALLBACK


618 if–
checkProgªss
 ){

619 if–
db
->
nProgªssOps
==nProgressOps ){

620 
¥c
;

621 
¥c
 = 
db
->
	`xProgªss
(db->
pProgªssArg
);

622 if–
¥c
!=0 ){

623 
rc
 = 
SQLITE4_INTERRUPT
;

624 
vdbe_îr‹_hÆt
;

626 
nProgªssOps
 = 0;

628 
nProgªssOps
++;

637 
	`as£π
–
pOp
->
›Êags
==
sqlôe4OpcodePr›îty
[pOp->
›code
] );

638 if–
pOp
->
›Êags
 & 
OPFLG_OUT2_PRERELEASE
 ){

639 
	`as£π
–
pOp
->
p2
>0 );

640 
	`as£π
–
pOp
->
p2
<=
p
->
nMem
 );

641 
pOut
 = &
aMem
[
pOp
->
p2
];

642 
	`memAboutToCh™ge
(
p
, 
pOut
);

643 
	`VdbeMemRñó£
(
pOut
);

644 
pOut
->
Êags
 = 
MEM_I¡
;

648 #ifde‡
SQLITE4_DEBUG


649 if–(
pOp
->
›Êags
 & 
OPFLG_IN1
)!=0 ){

650 
	`as£π
–
pOp
->
p1
>0 );

651 
	`as£π
–
pOp
->
p1
<=
p
->
nMem
 );

652 
	`as£π
–
	`memIsVÆid
(&
aMem
[
pOp
->
p1
]) );

653 
	`REGISTER_TRACE
(
pOp
->
p1
, &
aMem
[pOp->p1]);

655 if–(
pOp
->
›Êags
 & 
OPFLG_IN2
)!=0 ){

656 
	`as£π
–
pOp
->
p2
>0 );

657 
	`as£π
–
pOp
->
p2
<=
p
->
nMem
 );

658 
	`as£π
–
	`memIsVÆid
(&
aMem
[
pOp
->
p2
]) );

659 
	`REGISTER_TRACE
(
pOp
->
p2
, &
aMem
[pOp->p2]);

661 if–(
pOp
->
›Êags
 & 
OPFLG_IN3
)!=0 ){

662 
	`as£π
–
pOp
->
p3
>0 );

663 
	`as£π
–
pOp
->
p3
<=
p
->
nMem
 );

664 
	`as£π
–
	`memIsVÆid
(&
aMem
[
pOp
->
p3
]) );

665 
	`REGISTER_TRACE
(
pOp
->
p3
, &
aMem
[pOp->p3]);

667 if–(
pOp
->
›Êags
 & 
OPFLG_OUT2
)!=0 ){

668 
	`as£π
–
pOp
->
p2
>0 );

669 
	`as£π
–
pOp
->
p2
<=
p
->
nMem
 );

670 
	`memAboutToCh™ge
(
p
, &
aMem
[
pOp
->
p2
]);

672 if–(
pOp
->
›Êags
 & 
OPFLG_OUT3
)!=0 ){

673 
	`as£π
–
pOp
->
p3
>0 );

674 
	`as£π
–
pOp
->
p3
<=
p
->
nMem
 );

675 
	`memAboutToCh™ge
(
p
, &
aMem
[
pOp
->
p3
]);

679  
pOp
->
›code
 ){

723 
OP_GŸo
: {

724 
CHECK_FOR_INTERRUPT
;

725 
pc
 = 
pOp
->
p2
 - 1;

734 
OP_Gosub
: {

735 
	`as£π
–
pOp
->
p1
>0 &&ÖOp->p1<=
p
->
nMem
 );

736 
pIn1
 = &
aMem
[
pOp
->
p1
];

737 
	`as£π
–(
pIn1
->
Êags
 & 
MEM_Dyn
)==0 );

738 
	`memAboutToCh™ge
(
p
, 
pIn1
);

739 
pIn1
->
Êags
 = 
MEM_I¡
;

740 
pIn1
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
((
i64
)
pc
);

741 
	`REGISTER_TRACE
(
pOp
->
p1
, 
pIn1
);

742 
pc
 = 
pOp
->
p2
 - 1;

750 
OP_Rëu∫
: {

751 
pIn1
 = &
aMem
[
pOp
->
p1
];

752 
	`as£π
–
pIn1
->
Êags
 & 
MEM_I¡
 );

753 
pc
 = 
	`sqlôe4_num_to_öt32
(
pIn1
->
u
.
num
, 0);

761 
OP_Yõld
: {

762 
pcDe°
;

763 
pIn1
 = &
aMem
[
pOp
->
p1
];

764 
	`as£π
–(
pIn1
->
Êags
 & 
MEM_Dyn
)==0 );

765 
pIn1
->
Êags
 = 
MEM_I¡
;

766 
pcDe°
 = 
	`sqlôe4_num_to_öt32
(
pIn1
->
u
.
num
, 0);

767 
pIn1
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
pc
);

768 
	`REGISTER_TRACE
(
pOp
->
p1
, 
pIn1
);

769 
pc
 = 
pcDe°
;

779 
OP_HÆtIfNuŒ
: {

780 
pIn3
 = &
aMem
[
pOp
->
p3
];

781 if–(
pIn3
->
Êags
 & 
MEM_NuŒ
)==0 ) ;

804 
OP_HÆt
: {

805 if–
pOp
->
p1
==
SQLITE4_OK
 && 
p
->
pFøme
 ){

807 
VdbeFøme
 *
pFøme
 = 
p
->pFrame;

808 
p
->
pFøme
 =ÖFøme->
pP¨ít
;

809 
p
->
nFøme
--;

810 
	`sqlôe4VdbeSëCh™ges
(
db
, 
p
->
nCh™ge
);

811 
pc
 = 
	`sqlôe4VdbeFømeRe°‹e
(
pFøme
);

812 if–
pOp
->
p2
==
OE_Ign‹e
 ){

818 
pc
 = 
p
->
aOp
[pc].
p2
-1;

820 
aOp
 = 
p
->aOp;

821 
aMem
 = 
p
->aMem;

825 
p
->
rc
 = 
pOp
->
p1
;

826 
p
->
îr‹A˘i⁄
 = (
u8
)
pOp
->
p2
;

827 
p
->
pc
 =Öc;

828 if–
pOp
->
p4
.
z
 ){

829 
	`as£π
–
p
->
rc
!=
SQLITE4_OK
 );

830 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s", 
pOp
->
p4
.
z
);

831 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

832 
	`sqlôe4_log
(
db
->
pEnv
, 
pOp
->
p1
,

833 "ab‹à© %d i¿[%s]: %s", 
pc
, 
p
->
zSql
, 
pOp
->
p4
.
z
);

834 }if–
p
->
rc
 ){

835 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

836 
	`sqlôe4_log
(
db
->
pEnv
, 
pOp
->
p1
,

837 "c⁄°øöàÁûedáà%d i¿[%s]", 
pc
, 
p
->
zSql
);

839 
rc
 = 
	`sqlôe4VdbeHÆt
(
p
);

840 
	`as£π
–
rc
==
SQLITE4_BUSY
 ||Ñc==
SQLITE4_OK
 ||Ñc==
SQLITE4_ERROR
 );

841 if–
rc
==
SQLITE4_BUSY
 ){

842 
p
->
rc
 =Ñ¯
SQLITE4_BUSY
;

844 
	`as£π
–
rc
==
SQLITE4_OK
 || 
p
->rc==
SQLITE4_CONSTRAINT
 );

845 
	`as£π
–
rc
==
SQLITE4_OK
 || 
db
->
nDe„ºedC⁄s
>0 );

846 
rc
 = 
p
->r¯? 
SQLITE4_ERROR
 : 
SQLITE4_DONE
;

848 
vdbe_ªtu∫
;

855 
OP_I¡egî
: {

856 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
((
i64
)
pOp
->
p1
);

857 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_I¡
);

867 
OP_Num
: {

868 
pOut
->
Êags
 = (
pOp
->
p1
 ? 
MEM_I¡
 : 
MEM_Ról
);

869 
pOut
->
u
.
num
 = *(
pOp
->
p4
.
pNum
);

878 
OP_Såög8
: {

879 
	`as£π
–
pOp
->
p4
.
z
!=0 );

880 
pOp
->
›code
 = 
OP_Såög
;

881 
pOp
->
p1
 = 
	`sqlôe4SåÀn30
’Op->
p4
.
z
);

883 #i‚de‡
SQLITE4_OMIT_UTF16


884 if–
ícodög
!=
SQLITE4_UTF8
 ){

885 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, 
pOp
->
p4
.
z
, -1, 
SQLITE4_UTF8
,

886 
SQLITE4_STATIC
, 0);

887 if–
rc
==
SQLITE4_TOOBIG
 ) 
too_big
;

888 if–
SQLITE4_OK
!=
	`sqlôe4VdbeCh™geEncodög
(
pOut
, 
ícodög
ËË
no_mem
;

889 
	`as£π
–
pOut
->
zMÆloc
=ıOut->
z
 );

890 
	`as£π
–
pOut
->
Êags
 & 
MEM_Dyn
 );

891 
pOut
->
zMÆloc
 = 0;

892 
pOut
->
Êags
 |
MEM_Sètic
;

893 
pOut
->
Êags
 &~
MEM_Dyn
;

894 if–
pOp
->
p4ty≥
==
P4_DYNAMIC
 ){

895 
	`sqlôe4DbFªe
(
db
, 
pOp
->
p4
.
z
);

897 
pOp
->
p4ty≥
 = 
P4_DYNAMIC
;

898 
pOp
->
p4
.
z
 = 
pOut
->z;

899 
pOp
->
p1
 = 
pOut
->
n
;

902 if–
pOp
->
p1
>
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

903 
too_big
;

912 
OP_Såög
: {

913 
	`as£π
–
pOp
->
p4
.
z
!=0 );

914 
pOut
->
Êags
 = 
MEM_Så
|
MEM_Sètic
|
MEM_Tîm
;

915 
pOut
->
z
 = 
pOp
->
p4
.z;

916 
pOut
->
n
 = 
pOp
->
p1
;

917 
pOut
->
íc
 = 
ícodög
;

918 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

929 
OP_NuŒ
: {

930 
˙t
;

931 
˙t
 = 
pOp
->
p3
-pOp->
p2
;

932 
	`as£π
–
pOp
->
p3
<=
p
->
nMem
 );

933 
pOut
->
Êags
 = 
MEM_NuŒ
;

934  
˙t
>0 ){

935 
pOut
++;

936 
	`memAboutToCh™ge
(
p
, 
pOut
);

937 
	`VdbeMemRñó£
(
pOut
);

938 
pOut
->
Êags
 = 
MEM_NuŒ
;

939 
˙t
--;

950 
OP_Blob
: {

951 
	`as£π
–
pOp
->
p1
 <
SQLITE4_MAX_LENGTH
 );

952 
	`sqlôe4VdbeMemSëSå
(
pOut
, 
pOp
->
p4
.
z
,ÖOp->
p1
, 0, 0, 0);

953 
pOut
->
íc
 = 
ícodög
;

954 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

965 
OP_V¨übÀ
: {

966 
Mem
 *
pV¨
;

968 
	`as£π
–
pOp
->
p1
>0 &&ÖOp->p1<=
p
->
nV¨
 );

969 
	`as£π
–
pOp
->
p4
.
z
==0 ||ÖOp->p4.z==
p
->
azV¨
[pOp->
p1
-1] );

970 
pV¨
 = &
p
->
aV¨
[
pOp
->
p1
 - 1];

971 if–
	`sqlôe4VdbeMemTooBig
(
pV¨
) ){

972 
too_big
;

974 
	`sqlôe4VdbeMemShÆlowC›y
(
pOut
, 
pV¨
, 
MEM_Sètic
);

975 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

986 
OP_Move
: {

987 *
zMÆloc
;

988 
n
;

989 
p1
;

990 
p2
;

992 
n
 = 
pOp
->
p3
;

993 
p1
 = 
pOp
->p1;

994 
p2
 = 
pOp
->p2;

995 
	`as£π
–
n
>0 && 
p1
>0 && 
p2
>0 );

996 
	`as£π
–
p1
+
n
<=
p2
 ||Ö2+n<=p1 );

998 
pIn1
 = &
aMem
[
p1
];

999 
pOut
 = &
aMem
[
p2
];

1000  
n
-- ){

1001 
	`as£π
–
pOut
<=&
aMem
[
p
->
nMem
] );

1002 
	`as£π
–
pIn1
<=&
aMem
[
p
->
nMem
] );

1003 
	`as£π
–
	`memIsVÆid
(
pIn1
) );

1004 
	`memAboutToCh™ge
(
p
, 
pOut
);

1005 
zMÆloc
 = 
pOut
->zMalloc;

1006 
pOut
->
zMÆloc
 = 0;

1007 
	`sqlôe4VdbeMemMove
(
pOut
, 
pIn1
);

1008 #ifde‡
SQLITE4_DEBUG


1009 if–
pOut
->
pSc›yFrom
>=&
aMem
[
p1
] &&ÖOut->pSc›yFrom<&aMem[p1+
pOp
->
p3
] ){

1010 
pOut
->
pSc›yFrom
 +
p1
 - 
pOp
->
p2
;

1013 
pIn1
->
zMÆloc
 = zMalloc;

1014 
	`REGISTER_TRACE
(
p2
++, 
pOut
);

1015 
pIn1
++;

1016 
pOut
++;

1028 
OP_C›y
: {

1029 
pIn1
 = &
aMem
[
pOp
->
p1
];

1030 
pOut
 = &
aMem
[
pOp
->
p2
];

1031 
	`as£π
–
pOut
!=
pIn1
 );

1032 
	`sqlôe4VdbeMemShÆlowC›y
(
pOut
, 
pIn1
, 
MEM_Ephem
);

1033 
	`DìphemîÆize
(
pOut
);

1034 
	`REGISTER_TRACE
(
pOp
->
p2
, 
pOut
);

1050 
OP_SC›y
: {

1051 
pIn1
 = &
aMem
[
pOp
->
p1
];

1052 
pOut
 = &
aMem
[
pOp
->
p2
];

1053 
	`as£π
–
pOut
!=
pIn1
 );

1054 
	`sqlôe4VdbeMemShÆlowC›y
(
pOut
, 
pIn1
, 
MEM_Ephem
);

1055 #ifde‡
SQLITE4_DEBUG


1056 if–
pOut
->
pSc›yFrom
==0 )ÖOut->pSc›yFrom = 
pIn1
;

1058 
	`REGISTER_TRACE
(
pOp
->
p2
, 
pOut
);

1070 
OP_Resu…Row
: {

1071 
Mem
 *
pMem
;

1072 
i
;

1073 
	`as£π
–
p
->
nResCﬁumn
==
pOp
->
p2
 );

1074 
	`as£π
–
pOp
->
p1
>0 );

1075 
	`as£π
–
pOp
->
p1
+pOp->
p2
<=
p
->
nMem
+1 );

1076 
	`as£π
–
p
->
nFkC⁄°øöt
==0 );

1093 
rc
 = 
	`sqlôe4VdbeClo£Sèãmít
(
p
, 
SAVEPOINT_RELEASE
);

1094 if–
	`NEVER
(
rc
!=
SQLITE4_OK
) ){

1099 
p
->
ˇcheCå
 = (p->cacheCtr + 2)|1;

1105 
pMem
 = 
p
->
pResu…Së
 = &
aMem
[
pOp
->
p1
];

1106 
i
=0; i<
pOp
->
p2
; i++){

1107 
	`as£π
–
	`memIsVÆid
(&
pMem
[
i
]) );

1108 
	`DìphemîÆize
(&
pMem
[
i
]);

1109 
	`as£π
–(
pMem
[
i
].
Êags
 & 
MEM_Ephem
)==0

1110 || (
pMem
[
i
].
Êags
 & (
MEM_Så
|
MEM_Blob
))==0 );

1111 
	`sqlôe4VdbeMemNulTîmö©e
(&
pMem
[
i
]);

1112 
	`sqlôe4VdbeMemSt‹eTy≥
(&
pMem
[
i
]);

1113 
	`REGISTER_TRACE
(
pOp
->
p1
+
i
, &
pMem
[i]);

1115 if–
db
->
mÆlocFaûed
 ) 
no_mem
;

1119 
p
->
pc
 =Öc + 1;

1120 
rc
 = 
SQLITE4_ROW
;

1121 
vdbe_ªtu∫
;

1136 
OP_C⁄ˇt
: {

1137 
i64
 
nByã
;

1139 
pIn1
 = &
aMem
[
pOp
->
p1
];

1140 
pIn2
 = &
aMem
[
pOp
->
p2
];

1141 
pOut
 = &
aMem
[
pOp
->
p3
];

1142 
	`as£π
–
pIn1
!=
pOut
 );

1143 if–(
pIn1
->
Êags
 | 
pIn2
->ÊagsË& 
MEM_NuŒ
 ){

1144 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

1147 
	`Såögify
(
pIn1
, 
ícodög
);

1148 
	`Såögify
(
pIn2
, 
ícodög
);

1149 
nByã
 = 
pIn1
->
n
 + 
pIn2
->n;

1150 if–
nByã
>
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

1151 
too_big
;

1153 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_Så
);

1154 if–
	`sqlôe4VdbeMemGrow
(
pOut
, ()
nByã
+2,ÖOut==
pIn2
) ){

1155 
no_mem
;

1157 if–
pOut
!=
pIn2
 ){

1158 
	`mem˝y
(
pOut
->
z
, 
pIn2
->z,ÖIn2->
n
);

1160 
	`mem˝y
(&
pOut
->
z
[
pIn2
->
n
], 
pIn1
->z,ÖIn1->n);

1161 
pOut
->
z
[
nByã
] = 0;

1162 
pOut
->
z
[
nByã
+1] = 0;

1163 
pOut
->
Êags
 |
MEM_Tîm
;

1164 
pOut
->
n
 = ()
nByã
;

1165 
pOut
->
íc
 = 
ícodög
;

1166 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

1203 
OP_Add
:

1204 
OP_Subåa˘
:

1205 
OP_Mu…ùly
:

1206 
OP_Divide
:

1207 
OP_Remaödî
: {

1208 
Êags
;

1209 
i64
 
iA
;

1210 
i64
 
iB
;

1211 
sqlôe4_num
 
num1
;

1212 
sqlôe4_num
 
num2
;

1214 
pIn1
 = &
aMem
[
pOp
->
p1
];

1215 
	`≠∂yNumîicAfföôy
(
pIn1
);

1216 
pIn2
 = &
aMem
[
pOp
->
p2
];

1217 
	`≠∂yNumîicAfföôy
(
pIn2
);

1218 
pOut
 = &
aMem
[
pOp
->
p3
];

1219 
Êags
 = 
pIn1
->Êag†| 
pIn2
->flags;

1220 if–(
Êags
 & 
MEM_NuŒ
)!=0 ) 
¨ôhmëic_ªsu…_is_nuŒ
;

1222 if–(
pIn1
->
Êags
&
MEM_I¡
Ë&& (
pIn2
->flags&MEM_Int) ){

1223 
iA
 = 
	`sqlôe4_num_to_öt64
(
pIn1
->
u
.
num
, 0);

1224 
iB
 = 
	`sqlôe4_num_to_öt64
(
pIn2
->
u
.
num
, 0);

1226  
pOp
->
›code
 ){

1227 
OP_Add
: if–
	`sqlôe4AddI¡64
(&
iB
,
iA
ËË
Â_m©h
; ;

1228 
OP_Subåa˘
: if–
	`sqlôe4SubI¡64
(&
iB
,
iA
ËË
Â_m©h
; ;

1229 
OP_Mu…ùly
: if–
	`sqlôe4MulI¡64
(&
iB
,
iA
ËË
Â_m©h
; ;

1230 
OP_Divide
: {

1231 if–
iA
==0 ) 
¨ôhmëic_ªsu…_is_nuŒ
;

1232 if–
iA
==-1 && 
iB
==
SMALLEST_INT64
 ) 
Â_m©h
;

1233 
iB
 /
iA
;

1237 if–
iA
==0 ) 
¨ôhmëic_ªsu…_is_nuŒ
;

1238 if–
iA
==-1 ) iA = 1;

1239 
iB
 %
iA
;

1243 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
iB
);

1244 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_I¡
);

1249 
Â_m©h
:

1250 
num1
 = 
	`sqlôe4VdbeNumVÆue
(
pIn1
);

1251 
num2
 = 
	`sqlôe4VdbeNumVÆue
(
pIn2
);

1252  
pOp
->
›code
 ){

1253 
OP_Add
:

1254 
pOut
->
u
.
num
 = 
	`sqlôe4_num_add
(
num1
, 
num2
); ;

1255 
OP_Subåa˘
:

1256 
pOut
->
u
.
num
 = 
	`sqlôe4_num_sub
(
num2
, 
num1
); ;

1257 
OP_Mu…ùly
:

1258 
pOut
->
u
.
num
 = 
	`sqlôe4_num_mul
(
num1
, 
num2
); ;

1259 
OP_Divide
:

1260 
pOut
->
u
.
num
 = 
	`sqlôe4_num_div
(
num2
, 
num1
); ;

1262 
iA
 = 
	`sqlôe4_num_to_öt64
(
num1
, 0);

1263 
iB
 = 
	`sqlôe4_num_to_öt64
(
num2
, 0);

1264 if–
iA
==0 ) 
¨ôhmëic_ªsu…_is_nuŒ
;

1265 if–
iA
==-1 ) iA = 1;

1266 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
iB
 % 
iA
);

1271 if–
	`sqlôe4_num_i¢™
(
pOut
->
u
.
num
) ){

1272 
¨ôhmëic_ªsu…_is_nuŒ
;

1274 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_Ról
);

1275 if–(
Êags
 & 
MEM_Ról
)==0 ){

1276 
	`sqlôe4VdbeI¡egîAfföôy
(
pOut
);

1283 
¨ôhmëic_ªsu…_is_nuŒ
:

1284 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

1299 
OP_CﬁlSeq
: {

1300 
	`as£π
–
pOp
->
p4ty≥
==
P4_COLLSEQ
 );

1306 
OP_KVMëhod
: {

1307 
	`as£π
–
pOp
[1].
›code
==
OP_Fun˘i⁄
 );

1313 
OP_Mifun˘i⁄
: {

1314 
pc
++;

1315 
pOp
++;

1335 
OP_Fun˘i⁄
: {

1336 
i
;

1337 
Mem
 *
pArg
;

1338 
sqlôe4_c⁄ãxt
 
˘x
;

1339 
sqlôe4_vÆue
 **
≠VÆ
;

1340 
n
;

1342 
n
 = 
pOp
->
p5
;

1343 
≠VÆ
 = 
p
->
≠Arg
;

1344 
	`as£π
–
≠VÆ
 || 
n
==0 );

1345 
	`as£π
–
pOp
->
p3
>0 &&ÖOp->p3<=
p
->
nMem
 );

1346 
pOut
 = &
aMem
[
pOp
->
p3
];

1347 
	`memAboutToCh™ge
(
p
, 
pOut
);

1349 
	`as£π
–
n
==0 || (
pOp
->
p2
>0 &&ÖOp->p2+n<=
p
->
nMem
+1) );

1350 
	`as£π
–
pOp
->
p3
<pOp->
p2
 ||ÖOp->p3>ıOp->p2+
n
 );

1351 
pArg
 = &
aMem
[
pOp
->
p2
];

1352 
i
=0; i<
n
; i++, 
pArg
++){

1353 
	`as£π
–
	`memIsVÆid
(
pArg
) );

1354 
≠VÆ
[
i
] = 
pArg
;

1355 
	`DìphemîÆize
(
pArg
);

1356 
	`sqlôe4VdbeMemSt‹eTy≥
(
pArg
);

1357 
	`REGISTER_TRACE
(
pOp
->
p2
+
i
, 
pArg
);

1360 
	`as£π
–
pOp
->
p4ty≥
==
P4_FUNCDEF
 ||ÖOp->p4ty≥==
P4_VDBEFUNC
 );

1361 if–
pOp
->
p4ty≥
==
P4_FUNCDEF
 ){

1362 
˘x
.
pFunc
 = 
pOp
->
p4
.pFunc;

1363 
˘x
.
pVdbeFunc
 = 0;

1365 
˘x
.
pVdbeFunc
 = (
VdbeFunc
*)
pOp
->
p4
.pVdbeFunc;

1366 
˘x
.
pFunc
 = ctx.
pVdbeFunc
->pFunc;

1369 
˘x
.
s
.
Êags
 = 
MEM_NuŒ
;

1370 
˘x
.
s
.
db
 = db;

1371 
˘x
.
s
.
xDñ
 = 0;

1372 
˘x
.
s
.
zMÆloc
 = 0;

1373 
˘x
.
pFts
 = 0;

1374 if–
pOp
[-1].
›code
==
OP_Mifun˘i⁄
 ){

1375 
˘x
.
pFts
 = 
p
->
≠C§
[
pOp
[-1].
p1
]->pFts;

1376 
≠VÆ
++;

1377 
n
--;

1384 
	`sqlôe4VdbeMemMove
(&
˘x
.
s
, 
pOut
);

1385 
	`MemSëTy≥Fœg
(&
˘x
.
s
, 
MEM_NuŒ
);

1387 
˘x
.
isEº‹
 = 0;

1388 if–
˘x
.
pFunc
->
Êags
 & 
SQLITE4_FUNC_NEEDCOLL
 ){

1389 
	`as£π
–
pOp
>
aOp
 );

1390 
	`as£π
–
pOp
[-1].
p4ty≥
==
P4_COLLSEQ
 );

1391 
	`as£π
–
pOp
[-1].
›code
==
OP_CﬁlSeq
 );

1392 
˘x
.
pCﬁl
 = 
pOp
[-1].
p4
.pColl;

1394 (*
˘x
.
pFunc
->
xFunc
)(&˘x, 
n
, 
≠VÆ
);

1399 if–
˘x
.
pVdbeFunc
 ){

1400 
	`sqlôe4VdbeDñëeAuxD©a
(
˘x
.
pVdbeFunc
, 
pOp
->
p1
);

1401 
pOp
->
p4
.
pVdbeFunc
 = 
˘x
.pVdbeFunc;

1402 
pOp
->
p4ty≥
 = 
P4_VDBEFUNC
;

1405 if–
db
->
mÆlocFaûed
 ){

1411 
	`sqlôe4VdbeMemRñó£
(&
˘x
.
s
);

1412 
no_mem
;

1416 if–
˘x
.
isEº‹
 ){

1417 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s",

1418 (c⁄° *)
	`sqlôe4VÆueText
(&
˘x
.
s
, 
SQLITE4_UTF8
)

1420 
rc
 = 
˘x
.
isEº‹
;

1424 
	`sqlôe4VdbeCh™geEncodög
(&
˘x
.
s
, 
ícodög
);

1425 
	`sqlôe4VdbeMemMove
(
pOut
, &
˘x
.
s
);

1426 if–
	`sqlôe4VdbeMemTooBig
(
pOut
) ){

1427 
too_big
;

1435 if–
p
->
expúed
 ) 
rc
 = 
SQLITE4_ABORT
;

1438 
	`REGISTER_TRACE
(
pOp
->
p3
, 
pOut
);

1439 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

1469 
OP_BôAnd
:

1470 
OP_BôOr
:

1471 
OP_Shi·Le·
:

1472 
OP_Shi·Right
: {

1473 
i64
 
iA
;

1474 
u64
 
uA
;

1475 
i64
 
iB
;

1476 
u8
 
›
;

1478 
pIn1
 = &
aMem
[
pOp
->
p1
];

1479 
pIn2
 = &
aMem
[
pOp
->
p2
];

1480 
pOut
 = &
aMem
[
pOp
->
p3
];

1481 if–(
pIn1
->
Êags
 | 
pIn2
->ÊagsË& 
MEM_NuŒ
 ){

1482 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

1485 
iA
 = 
	`sqlôe4VdbeI¡VÆue
(
pIn2
);

1486 
iB
 = 
	`sqlôe4VdbeI¡VÆue
(
pIn1
);

1487 
›
 = 
pOp
->
›code
;

1488 if–
›
==
OP_BôAnd
 ){

1489 
iA
 &
iB
;

1490 }if–
›
==
OP_BôOr
 ){

1491 
iA
 |
iB
;

1492 }if–
iB
!=0 ){

1493 
	`as£π
–
›
==
OP_Shi·Right
 || op==
OP_Shi·Le·
 );

1496 if–
iB
<0 ){

1497 
	`as£π
–
OP_Shi·Right
==
OP_Shi·Le·
+1 );

1498 
›
 = 2*
OP_Shi·Le·
 + 1 - op;

1499 
iB
 = iB>(-64) ? -iB : 64;

1502 if–
iB
>=64 ){

1503 
iA
 = (iA>=0 || 
›
==
OP_Shi·Le·
) ? 0 : -1;

1505 
	`mem˝y
(&
uA
, &
iA
, (uA));

1506 if–
›
==
OP_Shi·Le·
 ){

1507 
uA
 <<
iB
;

1509 
uA
 >>
iB
;

1511 if–
iA
<0 ) 
uA
 |((((
u64
)0xffffffff)<<32)|0xffffffffË<< (64-
iB
);

1513 
	`mem˝y
(&
iA
, &
uA
, (iA));

1517 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
iA
);

1518 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_I¡
);

1529 
OP_AddImm
: {

1530 
pIn1
 = &
aMem
[
pOp
->
p1
];

1531 
	`memAboutToCh™ge
(
p
, 
pIn1
);

1532 
	`sqlôe4VdbeMemI¡egîify
(
pIn1
);

1533 
pIn1
->
u
.
num
 = 
	`sqlôe4_num_add
’In1->u.num, 
	`sqlôe4_num_‰om_öt64
(
pOp
->
p2
));

1544 
OP_Mu°BeI¡
: {

1545 
pIn1
 = &
aMem
[
pOp
->
p1
];

1546 
	`≠∂yAfföôy
(
pIn1
, 
SQLITE4_AFF_NUMERIC
, 
ícodög
);

1547 if–(
pIn1
->
Êags
 & 
MEM_I¡
)==0 ){

1548 if–
pOp
->
p2
==0 ){

1549 
rc
 = 
SQLITE4_MISMATCH
;

1550 
ab‹t_due_to_îr‹
;

1552 
pc
 = 
pOp
->
p2
 - 1;

1555 
	`MemSëTy≥Fœg
(
pIn1
, 
MEM_I¡
);

1560 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


1570 
OP_RólAfföôy
: {

1571 
pIn1
 = &
aMem
[
pOp
->
p1
];

1572 if–
pIn1
->
Êags
 & 
MEM_I¡
 ){

1573 
	`MemSëTy≥Fœg
(
pIn1
, 
MEM_Ról
);

1579 #i‚de‡
SQLITE4_OMIT_CAST


1589 
OP_ToText
: {

1590 
pIn1
 = &
aMem
[
pOp
->
p1
];

1591 
	`memAboutToCh™ge
(
p
, 
pIn1
);

1592 if–
pIn1
->
Êags
 & 
MEM_NuŒ
 ) ;

1593 
	`as£π
–
MEM_Så
==(
MEM_Blob
>>3) );

1594 
pIn1
->
Êags
 |’In1->Êags&
MEM_Blob
)>>3;

1595 
	`≠∂yAfföôy
(
pIn1
, 
SQLITE4_AFF_TEXT
, 
ícodög
);

1596 
	`as£π
–
pIn1
->
Êags
 & 
MEM_Så
 || 
db
->
mÆlocFaûed
 );

1597 
pIn1
->
Êags
 &~(
MEM_I¡
|
MEM_Ról
|
MEM_Blob
);

1598 
	`UPDATE_MAX_BLOBSIZE
(
pIn1
);

1611 
OP_ToBlob
: {

1612 
pIn1
 = &
aMem
[
pOp
->
p1
];

1613 if–
pIn1
->
Êags
 & 
MEM_NuŒ
 ) ;

1614 if–(
pIn1
->
Êags
 & 
MEM_Blob
)==0 ){

1615 
	`≠∂yAfföôy
(
pIn1
, 
SQLITE4_AFF_TEXT
, 
ícodög
);

1616 
	`as£π
–
pIn1
->
Êags
 & 
MEM_Så
 || 
db
->
mÆlocFaûed
 );

1617 
	`MemSëTy≥Fœg
(
pIn1
, 
MEM_Blob
);

1619 
pIn1
->
Êags
 &~(
MEM_Ty≥Mask
&~
MEM_Blob
);

1621 
	`UPDATE_MAX_BLOBSIZE
(
pIn1
);

1635 
OP_ToNumîic
: {

1636 
pIn1
 = &
aMem
[
pOp
->
p1
];

1637 
	`sqlôe4VdbeMemNumîify
(
pIn1
);

1651 
OP_ToI¡
: {

1652 
pIn1
 = &
aMem
[
pOp
->
p1
];

1653 if–(
pIn1
->
Êags
 & 
MEM_NuŒ
)==0 ){

1654 
	`sqlôe4VdbeMemI¡egîify
(
pIn1
);

1659 #i‡!
	`deföed
(
SQLITE4_OMIT_CAST
Ë&& !deföed(
SQLITE4_OMIT_FLOATING_POINT
)

1669 
OP_ToRól
: {

1670 
pIn1
 = &
aMem
[
pOp
->
p1
];

1671 
	`memAboutToCh™ge
(
p
, 
pIn1
);

1672 
	`sqlôe4VdbeMemNumîify
(
pIn1
);

1673 
pIn1
->
Êags
 |
MEM_Ról
;

1674 
pIn1
->
Êags
 &~
MEM_I¡
;

1751 
OP_Eq
:

1752 
OP_Ne
:

1753 
OP_Lt
:

1754 
OP_Le
:

1755 
OP_Gt
:

1756 
OP_Ge
: {

1757 
ªs
;

1758 
afföôy
;

1759 
u16
 
Êags1
;

1760 
u16
 
Êags3
;

1762 
pIn1
 = &
aMem
[
pOp
->
p1
];

1763 
pIn3
 = &
aMem
[
pOp
->
p3
];

1764 
Êags1
 = 
pIn1
->
Êags
;

1765 
Êags3
 = 
pIn3
->
Êags
;

1766 if–(
Êags1
 | 
Êags3
)&
MEM_NuŒ
 ){

1768 if–
pOp
->
p5
 & 
SQLITE4_NULLEQ
 ){

1773 
	`as£π
–
pOp
->
›code
==
OP_Eq
 ||ÖOp->›code==
OP_Ne
 );

1774 
ªs
 = (
Êags1
 & 
Êags3
 & 
MEM_NuŒ
)==0;

1780 if–
pOp
->
p5
 & 
SQLITE4_STOREP2
 ){

1781 
pOut
 = &
aMem
[
pOp
->
p2
];

1782 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_NuŒ
);

1783 
	`REGISTER_TRACE
(
pOp
->
p2
, 
pOut
);

1784 }if–
pOp
->
p5
 & 
SQLITE4_JUMPIFNULL
 ){

1785 
pc
 = 
pOp
->
p2
-1;

1791 
afföôy
 = 
pOp
->
p5
 & 
SQLITE4_AFF_MASK
;

1792 if–
afföôy
 ){

1793 
	`≠∂yAfföôy
(
pIn1
, 
afföôy
, 
ícodög
);

1794 
	`≠∂yAfföôy
(
pIn3
, 
afföôy
, 
ícodög
);

1795 if–
db
->
mÆlocFaûed
 ) 
no_mem
;

1798 
	`as£π
–
pOp
->
p4ty≥
==
P4_COLLSEQ
 ||ÖOp->
p4
.
pCﬁl
==0 );

1799 
rc
 = 
	`sqlôe4MemCom∑ª
(
pIn3
, 
pIn1
, 
pOp
->
p4
.
pCﬁl
, &
ªs
);

1801  
pOp
->
›code
 ){

1802 
OP_Eq
: 
ªs
 =Ñes==0; ;

1803 
OP_Ne
: 
ªs
 =Ñes!=0; ;

1804 
OP_Lt
: 
ªs
 =Ñes<0; ;

1805 
OP_Le
: 
ªs
 =Ñes<=0; ;

1806 
OP_Gt
: 
ªs
 =Ñes>0; ;

1807 : 
ªs
 =Ñes>=0; ;

1810 if–
pOp
->
p5
 & 
SQLITE4_STOREP2
 ){

1811 
pOut
 = &
aMem
[
pOp
->
p2
];

1812 
	`memAboutToCh™ge
(
p
, 
pOut
);

1813 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_I¡
);

1814 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
ªs
);

1815 
	`REGISTER_TRACE
(
pOp
->
p2
, 
pOut
);

1816 }if–
ªs
 ){

1817 
pc
 = 
pOp
->
p2
-1;

1821 
pIn1
->
Êags
 = (pIn1->Êags&~
MEM_Ty≥Mask
Ë| (
Êags1
&MEM_TypeMask);

1822 
pIn3
->
Êags
 = (pIn3->Êags&~
MEM_Ty≥Mask
Ë| (
Êags3
&MEM_TypeMask);

1836 
OP_Pîmuèti⁄
: {

1837 
	`as£π
–
pOp
->
p4ty≥
==
P4_INTARRAY
 );

1838 
	`as£π
–
pOp
->
p4
.
ai
 );

1839 
aPîmuã
 = 
pOp
->
p4
.
ai
;

1857 
OP_Com∑ª
: {

1858 
n
;

1859 
i
;

1860 
p1
;

1861 
p2
;

1862 c⁄° 
KeyInfo
 *
pKeyInfo
;

1863 
idx
;

1864 
CﬁlSeq
 *
pCﬁl
;

1865 
bRev
;

1867 
n
 = 
pOp
->
p3
;

1868 
pKeyInfo
 = 
pOp
->
p4
.pKeyInfo;

1869 
	`as£π
–
n
>0 );

1870 
	`as£π
–
pKeyInfo
!=0 );

1871 
p1
 = 
pOp
->p1;

1872 
p2
 = 
pOp
->p2;

1873 #i‡
SQLITE4_DEBUG


1874 if–
aPîmuã
 ){

1875 
k
, 
mx
 = 0;

1876 
k
=0; k<
n
; k++Ëif–
aPîmuã
[k]>
mx
 ) mx =áPermute[k];

1877 
	`as£π
–
p1
>0 &&Ö1+
mx
<=
p
->
nMem
+1 );

1878 
	`as£π
–
p2
>0 &&Ö2+
mx
<=
p
->
nMem
+1 );

1880 
	`as£π
–
p1
>0 &&Ö1+
n
<=
p
->
nMem
+1 );

1881 
	`as£π
–
p2
>0 &&Ö2+
n
<=
p
->
nMem
+1 );

1884 
i
=0; i<
n
; i++){

1885 
idx
 = 
aPîmuã
 ?áPîmuã[
i
] : i;

1886 
	`as£π
–
	`memIsVÆid
(&
aMem
[
p1
+
idx
]) );

1887 
	`as£π
–
	`memIsVÆid
(&
aMem
[
p2
+
idx
]) );

1888 
	`REGISTER_TRACE
(
p1
+
idx
, &
aMem
[p1+idx]);

1889 
	`REGISTER_TRACE
(
p2
+
idx
, &
aMem
[p2+idx]);

1890 
	`as£π
–
i
<
pKeyInfo
->
nFõld
 );

1891 
pCﬁl
 = 
pKeyInfo
->
aCﬁl
[
i
];

1892 
bRev
 = 
pKeyInfo
->
aS‹tOrdî
[
i
];

1893 
rc
 = 
	`sqlôe4MemCom∑ª
(&
aMem
[
p1
+
idx
], &aMem[
p2
+idx], 
pCﬁl
, &
iCom∑ª
);

1894 if–
iCom∑ª
 ){

1895 if–
bRev
 ) 
iCom∑ª
 = -iCompare;

1899 
aPîmuã
 = 0;

1909 
OP_Jump
: {

1910 if–
iCom∑ª
<0 ){

1911 
pc
 = 
pOp
->
p1
 - 1;

1912 }if–
iCom∑ª
==0 ){

1913 
pc
 = 
pOp
->
p2
 - 1;

1915 
pc
 = 
pOp
->
p3
 - 1;

1938 
OP_And
:

1939 
OP_Or
: {

1940 
v1
;

1941 
v2
;

1943 
pIn1
 = &
aMem
[
pOp
->
p1
];

1944 if–
pIn1
->
Êags
 & 
MEM_NuŒ
 ){

1945 
v1
 = 2;

1947 
v1
 = 
	`sqlôe4VdbeI¡VÆue
(
pIn1
)!=0;

1949 
pIn2
 = &
aMem
[
pOp
->
p2
];

1950 if–
pIn2
->
Êags
 & 
MEM_NuŒ
 ){

1951 
v2
 = 2;

1953 
v2
 = 
	`sqlôe4VdbeI¡VÆue
(
pIn2
)!=0;

1955 if–
pOp
->
›code
==
OP_And
 ){

1956 c⁄° 
™d_logic
[] = { 0, 0, 0, 0, 1, 2, 0, 2, 2 };

1957 
v1
 = 
™d_logic
[v1*3+
v2
];

1959 c⁄° 
‹_logic
[] = { 0, 1, 2, 1, 1, 1, 2, 1, 2 };

1960 
v1
 = 
‹_logic
[v1*3+
v2
];

1962 
pOut
 = &
aMem
[
pOp
->
p3
];

1963 if–
v1
==2 ){

1964 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_NuŒ
);

1966 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
v1
);

1967 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_I¡
);

1978 
OP_NŸ
: {

1979 
pIn1
 = &
aMem
[
pOp
->
p1
];

1980 
pOut
 = &
aMem
[
pOp
->
p2
];

1981 if–
pIn1
->
Êags
 & 
MEM_NuŒ
 ){

1982 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

1984 
	`sqlôe4VdbeMemSëI¡64
(
pOut
, !
	`sqlôe4VdbeI¡VÆue
(
pIn1
));

1995 
OP_BôNŸ
: {

1996 
pIn1
 = &
aMem
[
pOp
->
p1
];

1997 
pOut
 = &
aMem
[
pOp
->
p2
];

1998 if–
pIn1
->
Êags
 & 
MEM_NuŒ
 ){

1999 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

2001 
	`sqlôe4VdbeMemSëI¡64
(
pOut
, ~
	`sqlôe4VdbeI¡VÆue
(
pIn1
));

2013 
OP_On˚
: {

2014 
	`as£π
–
pOp
->
p1
<
p
->
nOn˚Fœg
 );

2015 if–
p
->
aOn˚Fœg
[
pOp
->
p1
] ){

2016 
pc
 = 
pOp
->
p2
-1;

2018 
p
->
aOn˚Fœg
[
pOp
->
p1
] = 1;

2035 
OP_If
:

2036 
OP_IfNŸ
: {

2037 
c
;

2038 
pIn1
 = &
aMem
[
pOp
->
p1
];

2039 if–
pIn1
->
Êags
 & 
MEM_NuŒ
 ){

2040 
c
 = 
pOp
->
p3
;

2042 
c
 = 
	`sqlôe4VdbeNumVÆue
(
pIn1
).
m
!=0;

2043 if–
pOp
->
›code
==
OP_IfNŸ
 ) 
c
 = !c;

2045 if–
c
 ){

2046 
pc
 = 
pOp
->
p2
-1;

2057 
OP_IsNuŒ
: {

2058 
Mem
 *
pEnd
;

2059 
pIn1
 = &
aMem
[
pOp
->
p1
];

2060 
pEnd
 = &
aMem
[
pOp
->
p1
+pOp->
p3
];

2063 if–(
pIn1
->
Êags
 & 
MEM_NuŒ
)!=0 ){

2064 
pc
 = 
pOp
->
p2
 - 1;

2067 } (++
pIn1
)<
pEnd
 );

2076 
OP_NŸNuŒ
: {

2077 
pIn1
 = &
aMem
[
pOp
->
p1
];

2078 if–(
pIn1
->
Êags
 & 
MEM_NuŒ
)==0 ){

2079 
pc
 = 
pOp
->
p2
 - 1;

2103 
OP_Cﬁumn
: {

2104 
p1
;

2105 
mxFõld
;

2106 
VdbeCurs‹
 *
pC
;

2107 
Mem
 *
pDe°
;

2108 
Mem
 *
pDeÁu…
;

2110 
p1
 = 
pOp
->p1;

2111 
	`as£π
–
p1
<
p
->
nCurs‹
 );

2112 
	`as£π
–
pOp
->
p3
>0 &&ÖOp->p3<=
p
->
nMem
 );

2113 
pDe°
 = &
aMem
[
pOp
->
p3
];

2114 
	`memAboutToCh™ge
(
p
, 
pDe°
);

2115 
pC
 = 
p
->
≠C§
[
p1
];

2116 
	`as£π
–
pC
!=0 );

2117 
	`as£π
–
pC
->
iRoŸ
!=
KVSTORE_ROOT
 );

2118 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


2119 
	`as£π
–
pC
->
pVèbCurs‹
==0 );

2121 if–
pC
->
pDecodî
==0 ){

2122 
mxFõld
 = 
pC
->
nFõld
;

2123 if–
pC
->
pKeyInfo
 &&ÖC->pKeyInfo->
nD©a
 ) 
mxFõld
 =ÖC->pKeyInfo->nData;

2124 
rc
 = 
	`sqlôe4VdbeDecodîCª©e
(
db
, 
pC
, 0, 
mxFõld
, &pC->
pDecodî
);

2125 
pC
->
rowChnged
 = 1;

2127 if–
rc
==
SQLITE4_OK
 ){

2128 
pDeÁu…
 = (
pOp
->
p4ty≥
==
P4_MEM
Ë?ÖOp->
p4
.
pMem
 : 0;

2129 
rc
 = 
	`sqlôe4VdbeDecodîGëCﬁumn
(
pC
->
pDecodî
, 
pOp
->
p2
, 
pDeÁu…
, 
pDe°
);

2131 
	`sqlôe4VdbeMemSëNuŒ
(
pDe°
);

2133 
	`UPDATE_MAX_BLOBSIZE
(
pDe°
);

2134 
	`REGISTER_TRACE
(
pOp
->
p3
, 
pDe°
);

2159 
OP_MakeKey
:

2160 
OP_MakeRec‹d
: {

2161 
VdbeCurs‹
 *
pC
;

2162 
Mem
 *
pD©a0
;

2163 
Mem
 *
pLa°
;

2164 
Mem
 *
pMem
;

2165 
Mem
 *
pOut
;

2166 
nIn
;

2167 *
zAfföôy
;

2168 
u8
 *
aRec
;

2169 
nRec
;

2170 
bRïót
;

2171 
u8
 
aSeq
[10];

2172 
nSeq
;

2173 
u64
 
iSeq
;

2176 
bRïót
 = 0;

2177 
zAfföôy
 = 
pOp
->
p4ty≥
==
P4_INT32
 ? 0 :ÖOp->
p4
.
z
;

2178 
	`as£π
–
pOp
->
p1
>0 &&ÖOp->
p2
>0 &&ÖOp->p2+pOp->p1<=
p
->
nMem
+1 );

2179 
pD©a0
 = &
aMem
[
pOp
->
p1
];

2180 
nIn
 = 
pOp
->
p2
;

2181 
pLa°
 = &
pD©a0
[
nIn
-1];

2182 
	`as£π
–
pOp
->
p3
>0 &&ÖOp->p3<=
p
->
nMem
 );

2183 
pOut
 = &
aMem
[
pOp
->
p3
];

2184 
	`memAboutToCh™ge
(
p
, 
pOut
);

2185 
aRec
 = 0;

2186 
nSeq
 = 0;

2189 if–
zAfföôy
 ){

2190 
pMem
=
pD©a0
;ÖMem<=
pLa°
;ÖMem++){

2191 
	`as£π
–
	`memIsVÆid
(
pMem
) );

2192 
	`≠∂yAfföôy
(
pMem
, *(
zAfföôy
++), 
ícodög
);

2196 if–
pOp
->
›code
==
OP_MakeKey
 ){

2197 
	`as£π
–
pOp
->
p4ty≥
==
P4_INT32
 );

2198 
	`as£π
–
pOp
->
p4
.
i
>=0 &&ÖOp->p4.i<
p
->
nCurs‹
 );

2199 
pC
 = 
p
->
≠C§
[
pOp
->
p4
.
i
];

2207 if–
pOp
->
p5
 & 
OPFLAG_SEQCOUNT
 ){

2208 
iSeq
 = 
pC
->
£qCou¡
++;

2210 
nSeq
++;

2211 
aSeq
[◊Seq)-
nSeq
] = (
u8
)(
iSeq
 & 0x007F);

2212 
iSeq
 = iSeq >> 7;

2213 } 
iSeq
 );

2214 
aSeq
[◊Seq)-
nSeq
] |= 0x80;

2218 
rc
 = 
	`sqlôe4VdbeEncodeKey
(

2219 
db
, 
pD©a0
, 
nIn
, 
pC
->
iRoŸ
,ÖC->
pKeyInfo
, &
aRec
, &
nRec
, 
nSeq


2222 if–
pOp
[1].
›code
==
OP_MakeRec‹d
 ){

2223 
pc
++;

2224 
pOp
++;

2225 
bRïót
 = 1;

2228 
	`as£π
–
pOp
->
›code
==
OP_MakeRec‹d
 );

2229 
rc
 = 
	`sqlôe4VdbeEncodeD©a
(
db
, 
pD©a0
, 
aPîmuã
, 
nIn
, &
aRec
, &
nRec
);

2230 
aPîmuã
 = 0;

2234 if–
rc
!=
SQLITE4_OK
 ){

2235 
	`sqlôe4DbFªe
(
db
, 
aRec
);

2237 if–
nSeq
 ) 
	`mem˝y
(&
aRec
[
nRec
], &
aSeq
[(aSeq)-nSeq],ÇSeq);

2238 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, (*)
aRec
, 
nRec
+
nSeq
, 0,

2239 
SQLITE4_DYNAMIC
, 0);

2240 
	`REGISTER_TRACE
(
pOp
->
p3
, 
pOut
);

2241 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

2243 } 
rc
==
SQLITE4_OK
 && 
bRïót
 );

2255 
OP_Afföôy
: {

2256 c⁄° *
zAfföôy
;

2257 
Mem
 *
pEnd
;

2259 
zAfföôy
 = 
pOp
->
p4
.
z
;

2260 
	`as£π
–
zAfföôy
!=0 );

2261 
	`as£π
–
	`sqlôe4SåÀn30
(
zAfföôy
)>=
pOp
->
p2
 );

2263 
pEnd
 = &
aMem
[
pOp
->
p2
+pOp->
p1
];

2264 
pIn1
=&
aMem
[
pOp
->
p1
];ÖIn1<
pEnd
;ÖIn1++){

2265 
	`as£π
–
	`memIsVÆid
(
pIn1
) );

2266 
	`memAboutToCh™ge
(
p
, 
pIn1
);

2267 
	`≠∂yAfföôy
(
pIn1
, *(
zAfföôy
++), 
ícodög
);

2268 
	`REGISTER_TRACE
(
pIn1
-
aMem
,ÖIn1);

2279 
OP_Cou¡
: {

2280 
i64
 
nE¡ry
;

2281 
VdbeCurs‹
 *
pC
;

2283 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

2284 
rc
 = 
	`sqlôe4VdbeSìkEnd
(
pC
, +1);

2285 
nE¡ry
 = 0;

2286  
rc
!=
SQLITE4_NOTFOUND
 ){

2287 
nE¡ry
++;

2288 
rc
 = 
	`sqlôe4VdbeNext
(
pC
);

2290 
	`sqlôe4VdbeMemSëI¡64
(
pOut
, 
nE¡ry
);

2291 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_OK
;

2309 
OP_Savïoöt
: {

2310 
iSave
;

2311 
Savïoöt
 *
pSave
;

2312 c⁄° *
zSave
;

2313 
nSave
;

2314 
iOp
;

2315 c⁄° *
zEº
;

2317 
zEº
 = 0;

2318 
zSave
 = 
pOp
->
p4
.
z
;

2319 
nSave
 = 
zSave
 ? 
	`sqlôe4SåÀn30
(zSave) : 0;

2320 
iOp
 = 
pOp
->
p1
;

2321 
	`as£π
–
pOp
->
p1
==
SAVEPOINT_BEGIN


2322 || 
pOp
->
p1
==
SAVEPOINT_RELEASE


2323 || 
pOp
->
p1
==
SAVEPOINT_ROLLBACK


2326 if–
iOp
==
SAVEPOINT_BEGIN
 ){

2327 if–
zSave
==0 && 
db
->
pSavïoöt
 ){

2330 
zEº
 = "cannot startáÅransaction withináÅransaction";

2332 
pSave
 = (
Savïoöt
 *)
	`sqlôe4DbMÆlocZîo
(
db
, 
nSave
+1+(Savepoint));

2333 if–
pSave
==0 ) ;

2334 if–
zSave
 ){

2335 
pSave
->
zName
 = (*)&pSave[1];

2336 
	`mem˝y
(
pSave
->
zName
, 
zSave
, 
nSave
);

2338 
pSave
->
pNext
 = 
db
->
pSavïoöt
;

2339 
pSave
->
nDe„ºedC⁄s
 = 
db
->nDeferredCons;

2340 
db
->
pSavïoöt
 = 
pSave
;

2341 
db
->
nSavïoöt
++;

2351 
iSave
 = 
db
->
nSavïoöt
+1;

2352 
pSave
=
db
->
pSavïoöt
;ÖSave;ÖSaveıSave->
pNext
){

2353 if–
zSave
 ){

2354 if–
pSave
->
zName
 && 0==
	`sqlôe4_°ricmp
(
zSave
,ÖSave->zName) ) ;

2356 if–
pSave
->
pNext
==0 ) ;

2358 
iSave
--;

2361 if–
pSave
==0 ){

2362 if–
zSave
 ){

2363 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "nÿsuch savïoöt: %s", 
zSave
);

2364 
rc
 = 
SQLITE4_ERROR
;

2365 }if–
iOp
==
SAVEPOINT_RELEASE
 ){

2366 
zEº
 = "cannot commit -ÇoÅransaction isáctive";

2368 
zEº
 = "cannotÑollback -ÇoÅransaction isáctive";

2376 if–
iOp
==
SAVEPOINT_RELEASE
 && 
iSave
==2 ){

2377 
rc
 = 
	`sqlôe4VdbeCheckFk
(
p
, 1);

2378 if–
rc
!=
SQLITE4_OK
 ) ;

2381 if–
iOp
==
SAVEPOINT_RELEASE
 ){

2382 
rc
 = 
	`sqlôe4VdbeCommô
(
db
, 
iSave
-1);

2384 
rc
 = 
	`sqlôe4VdbeRﬁlback
(
db
, 
iSave
-(
zSave
==0));

2389 if–
zEº
 ){

2390 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s", 
zEº
);

2391 
rc
 = 
SQLITE4_ERROR
;

2418 
OP_Tønß˘i⁄
: {

2419 
Db
 *
pDb
;

2420 
KVSt‹e
 *
pKV
;

2421 
bStmt
;

2422 
iLevñ
;

2424 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
db
->
nDb
 );

2425 
pDb
 = &
db
->
aDb
[
pOp
->
p1
];

2426 
pKV
 = 
pDb
->pKV;

2427 if–
pKV
 ){

2428 if–
pOp
->
p2
==0 ){

2430 if–
pKV
->
iTønsLevñ
==0 ){

2431 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
pKV
, 1);

2435 
iLevñ
 = 
db
->
nSavïoöt
 + 1;

2436 if–
iLevñ
<2 ) iLevel = 2;

2437 
bStmt
 = 
db
->
pSavïoöt
 && (
p
->
√edSavïoöt
 || db->
a˘iveVdbeC¡
>1);

2438 if–
pKV
->
iTønsLevñ
<
iLevñ
 ){

2439 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
pKV
, 
iLevñ
);

2441 if–
rc
==
SQLITE4_OK
 && 
bStmt
 ){

2442 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
pKV
,ÖKV->
iTønsLevñ
+1);

2443 if–
rc
==
SQLITE4_OK
 ){

2444 
p
->
°mtTønsMask
 |((
yDbMask
)1)<<
pOp
->
p1
;

2446 
p
->
nStmtDefC⁄s
 = 
db
->
nDe„ºedC⁄s
;

2461 
OP_RódCookõ
: {

2462 
iMëa
;

2463 
KVSt‹e
 *
pKV
;

2465 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
db
->
nDb
 );

2466 
pKV
 = 
db
->
aDb
[
pOp
->
p1
].pKV;

2467 
rc
 = 
	`sqlôe4KVSt‹eGëSchema
(
pKV
, &
iMëa
);

2468 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
iMëa
);

2469 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_I¡
);

2483 
OP_SëCookõ
: {

2484 
Db
 *
pDb
;

2485 
i64
 
v
;

2487 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
db
->
nDb
 );

2488 
pDb
 = &
db
->
aDb
[
pOp
->
p1
];

2489 
pIn3
 = &
aMem
[
pOp
->
p3
];

2490 
	`sqlôe4VdbeMemI¡egîify
(
pIn3
);

2491 
v
 = 
	`sqlôe4_num_to_öt64
(
pIn3
->
u
.
num
, 0);

2492 
rc
 = 
	`sqlôe4KVSt‹ePutSchema
(
pDb
->
pKV
, (
u32
)
v
);

2493 
pDb
->
pSchema
->
schema_cookõ
 = ()
v
;

2494 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

2495 if–
pOp
->
p1
==1 ){

2498 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

2499 
p
->
expúed
 = 0;

2522 
OP_VîifyCookõ
: {

2523 
iMëa
;

2524 
iGí
;

2525 
KVSt‹e
 *
pKV
;

2527 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
db
->
nDb
 );

2528 
pKV
 = 
db
->
aDb
[
pOp
->
p1
].pKV;

2529 if–
pKV
 ){

2530 
rc
 = 
	`sqlôe4KVSt‹eGëSchema
(
pKV
, &
iMëa
);

2531 if–
rc
 ) ;

2532 
iGí
 = 
db
->
aDb
[
pOp
->
p1
].
pSchema
->
iGíî©i⁄
;

2534 
iGí
 = 
iMëa
 = 0;

2536 if–
iMëa
!=
pOp
->
p2
 || 
iGí
!ıOp->
p3
 ){

2537 
	`sqlôe4DbFªe
(
db
, 
p
->
zEºMsg
);

2538 
p
->
zEºMsg
 = 
	`sqlôe4DbSåDup
(
db
, "database schema has changed");

2552 if–
db
->
aDb
[
pOp
->
p1
].
pSchema
->
schema_cookõ
!=
iMëa
 ){

2553 
	`sqlôe4Re£tI¡î«lSchema
(
db
, 
pOp
->
p1
);

2556 
p
->
expúed
 = 1;

2557 
rc
 = 
SQLITE4_SCHEMA
;

2611 
OP_O≥nRód
:

2612 
OP_O≥nWrôe
: {

2613 
nFõld
;

2614 
KeyInfo
 *
pKeyInfo
;

2615 
p2
;

2616 
iDb
;

2617 
KVSt‹e
 *
pX
;

2618 
VdbeCurs‹
 *
pCur
;

2619 
Db
 *
pDb
;

2621 if–
p
->
expúed
 ){

2622 
rc
 = 
SQLITE4_ABORT
;

2626 
nFõld
 = 0;

2627 
pKeyInfo
 = 0;

2628 
p2
 = 
pOp
->p2;

2629 
iDb
 = 
pOp
->
p3
;

2630 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

2631 
pDb
 = &
db
->
aDb
[
iDb
];

2632 
pX
 = 
pDb
->
pKV
;

2633 
	`as£π
–
pX
!=0 );

2634 if–
pOp
->
p5
 ){

2635 
	`as£π
–
p2
>0 );

2636 
	`as£π
–
p2
<=
p
->
nMem
 );

2637 
pIn2
 = &
aMem
[
p2
];

2638 
	`as£π
–
	`memIsVÆid
(
pIn2
) );

2639 
	`as£π
–(
pIn2
->
Êags
 & 
MEM_I¡
)!=0 );

2640 
	`sqlôe4VdbeMemI¡egîify
(
pIn2
);

2641 
p2
 = 
	`sqlôe4_num_to_öt32
(
pIn2
->
u
.
num
, 0);

2646 if–
	`NEVER
(
p2
<2) ) {

2647 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

2648 
ab‹t_due_to_îr‹
;

2651 if–
pOp
->
p4ty≥
==
P4_KEYINFO
 ){

2652 
pKeyInfo
 = 
pOp
->
p4
.pKeyInfo;

2653 
nFõld
 = 
pKeyInfo
->nField+1;

2654 }if–
pOp
->
p4ty≥
==
P4_INT32
 ){

2655 
nFõld
 = 
pOp
->
p4
.
i
;

2657 
	`as£π
–
pOp
->
p1
>=0 );

2658 
pCur
 = 
	`ÆloˇãCurs‹
(
p
, 
pOp
->
p1
, 
nFõld
, 
iDb
, 1);

2659 if–
pCur
==0 ) 
no_mem
;

2660 
pCur
->
nuŒRow
 = 1;

2661 
pCur
->
iRoŸ
 = 
p2
;

2662 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pX
, &
pCur
->
pKVCur
);

2663 
pCur
->
pKeyInfo
 =ÖKeyInfo;

2704 
OP_O≥nAutoödex
:

2705 
OP_O≥nEphemîÆ
: {

2706 
VdbeCurs‹
 *
pCx
;

2708 
	`as£π
–
pOp
->
p1
>=0 );

2709 
pCx
 = 
	`ÆloˇãCurs‹
(
p
, 
pOp
->
p1
,ÖOp->
p2
, -1, 1);

2710 if–
pCx
==0 ) 
no_mem
;

2711 
pCx
->
nuŒRow
 = 1;

2713 
rc
 = 
	`sqlôe4KVSt‹eO≥n
(
db
, "ïhm", 0, &
pCx
->
pTmpKV
,

2714 
SQLITE4_KVOPEN_TEMPORARY
 | 
SQLITE4_KVOPEN_NO_TRANSACTIONS


2716 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4KVSt‹eO≥nCurs‹
(
pCx
->
pTmpKV
, &pCx->
pKVCur
);

2717 if–
rc
==
SQLITE4_OK
 )Ñ¯
	`sqlôe4KVSt‹eBegö
(
pCx
->
pTmpKV
, 2);

2719 
pCx
->
pKeyInfo
 = 
pOp
->
p4
.pKeyInfo;

2730 
OP_S‹ãrO≥n
: {

2732 
pOp
->
›code
 = 
OP_O≥nEphemîÆ
;

2733 
pc
--;

2742 
OP_Clo£
: {

2743 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

2744 
	`sqlôe4VdbeFªeCurs‹
(
p
->
≠C§
[
pOp
->
p1
]);

2745 
p
->
≠C§
[
pOp
->
p1
] = 0;

2765 
OP_SìkPk
: {

2766 
KVByãAºay
 *
aKey
;

2767 
KVSize
 
nKey
;

2768 
VdbeCurs‹
 *
pPk
;

2769 
VdbeCurs‹
 *
pIdx
;

2770 
nSh‹t
;

2771 
nV¨öt
;

2773 
pPk
 = 
p
->
≠C§
[
pOp
->
p1
];

2774 
pIdx
 = 
p
->
≠C§
[
pOp
->
p3
];

2776 if–
pIdx
->
pFts
 ){

2777 
rc
 = 
	`sqlôe4Fts5Pk
(
pIdx
->
pFts
, 
pPk
->
iRoŸ
, &
aKey
, &
nKey
);

2778 if–
rc
==
SQLITE4_OK
 ){

2779 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pPk
->
pKVCur
, 
aKey
, 
nKey
, 0);

2780 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_CORRUPT_BKPT
;

2781 
pPk
->
nuŒRow
 = 0;

2784 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pIdx
->
pKVCur
, (c⁄° 
KVByãAºay
 **)&
aKey
, &
nKey
);

2785 if–
rc
!=
SQLITE4_OK
 ) ;

2786 
nSh‹t
 = 
	`sqlôe4VdbeSh‹tKey
(
aKey
, 
nKey
,

2787 
pIdx
->
pKeyInfo
->
nFõld
 -ÖIdx->pKeyInfo->
nPK
, 0

2789 
nV¨öt
 = 
	`sqlôe4V¨ötLí
(
pPk
->
iRoŸ
);

2790 
rc
 = 
	`sqlôe4_buf„r_ªsize
(&
pPk
->
sSìkKey
, 
nV¨öt
 + 
nKey
 - 
nSh‹t
);

2791 if–
rc
!=
SQLITE4_OK
 ) ;

2792 
	`putV¨öt32
((
u8
 *)(
pPk
->
sSìkKey
.
p
),ÖPk->
iRoŸ
);

2793 
	`mem˝y
(((
u8
*)
pPk
->
sSìkKey
.
p
Ë+ 
nV¨öt
, &
aKey
[
nSh‹t
], 
nKey
-nShort);

2794 
	`as£π
–
pPk
->
sSìkKey
.
n
>0 );

2796 
pPk
->
rowChnged
 = 1;

2849 
OP_SìkLt
:

2850 
OP_SìkLe
:

2851 
OP_SìkGe
:

2852 
OP_SìkGt
: {

2853 
›
;

2854 
VdbeCurs‹
 *
pC
;

2855 
nFõld
;

2856 
KVByãAºay
 *
aProbe
;

2857 
KVSize
 
nProbe
;

2858 
dú
;

2859 c⁄° 
KVByãAºay
 *
aKey
;

2860 
KVSize
 
nKey
;

2862 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

2863 
pC
->
nuŒRow
 = 0;

2864 
pC
->
sSìkKey
.
n
 = 0;

2865 
pC
->
rowChnged
 = 1;

2867 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

2868 
	`as£π
–
pOp
->
p2
!=0 );

2869 
	`as£π
–
pC
!=0 );

2870 
	`as£π
–
OP_SìkLe
 =
OP_SìkLt
+1 );

2871 
	`as£π
–
OP_SìkGe
 =
OP_SìkLt
+2 );

2872 
	`as£π
–
OP_SìkGt
 =
OP_SìkLt
+3 );

2874 
dú
 = +1;

2875 
›
 = 
pOp
->
›code
;

2876 if–
›
==
OP_SìkLe
 || op==
OP_SìkLt
 ) 
dú
 = -1;

2881 
nFõld
 = 
pOp
->
p4
.
i
;

2882 
pIn3
 = &
aMem
[
pOp
->
p3
];

2883 if–
pC
->
iRoŸ
!=
KVSTORE_ROOT
 ){

2884 
rc
 = 
	`sqlôe4VdbeEncodeKey
(

2885 
db
, 
pIn3
, 
nFõld
, 
pC
->
iRoŸ
,ÖC->
pKeyInfo
, &
aProbe
, &
nProbe
, 1

2895 if–
›
==
OP_SìkLe
 || op==
OP_SìkGt
 ) 
aProbe
[
nProbe
++] = 0xFF;

2896 if–
rc
==
SQLITE4_OK
 ){

2897 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC
->
pKVCur
, 
aProbe
, 
nProbe
, 
dú
);

2900 
	`Såögify
(
pIn3
, 
ícodög
);

2901 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(

2902 
pC
->
pKVCur
, (c⁄° 
KVByãAºay
 *)
pIn3
->
z
,ÖIn3->
n
, 
dú


2906 if–
rc
==
SQLITE4_OK
 ){

2907 if–
›
==
OP_SìkLt
 ){

2908 
rc
 = 
	`sqlôe4KVCurs‹Pªv
(
pC
->
pKVCur
);

2909 }if–
›
==
OP_SìkGt
 ){

2910 
rc
 = 
	`sqlôe4KVCurs‹Next
(
pC
->
pKVCur
);

2914 if–
pC
->
iRoŸ
!=
KVSTORE_ROOT
 ){

2918 if–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_INEXACT
 ){

2919 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

2920 if–
rc
==
SQLITE4_OK
 && 
	`memcmp
(
aKey
, 
aProbe
, 
	`sqlôe4V¨ötLí
(
pC
->
iRoŸ
)) ){

2921 
rc
 = 
SQLITE4_NOTFOUND
;

2927 
	`sqlôe4DbFªe
(
db
, 
aProbe
);

2928 }if–
rc
==
SQLITE4_INEXACT
 ){

2929 
rc
 = 
SQLITE4_OK
;

2932 #ifde‡
SQLITE4_TEST


2933 if–
rc
==
SQLITE4_OK
 ){ 
sqlôe4_£¨ch_cou¡
++; }

2935 if–
rc
==
SQLITE4_NOTFOUND
 ){

2936 
rc
 = 
SQLITE4_OK
;

2937 
pc
 = 
pOp
->
p2
 - 1;

2981 
OP_NŸExi°s
: {

2982 
pOp
->
p4
.
i
 = 1;

2983 
pOp
->
p4ty≥
 = 
P4_INT32
;

2986 
OP_NŸFound
:

2987 
OP_Found
: {

2988 
ÆªadyExi°s
;

2989 
VdbeCurs‹
 *
pC
;

2990 
KVByãAºay
 *
pFªe
;

2991 
KVByãAºay
 *
pProbe
;

2992 
KVSize
 
nProbe
;

2993 c⁄° 
KVByãAºay
 *
pKey
;

2994 
KVSize
 
nKey
;

2996 #ifde‡
SQLITE4_TEST


2997 
sqlôe4_found_cou¡
++;

3000 
ÆªadyExi°s
 = 0;

3001 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3002 
	`as£π
–
pOp
->
p4ty≥
==
P4_INT32
 );

3003 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3004 
pC
->
sSìkKey
.
n
 = 0;

3005 
pC
->
rowChnged
 = 1;

3006 
	`as£π
–
pC
!=0 );

3007 
pIn3
 = &
aMem
[
pOp
->
p3
];

3008 
	`as£π
–
pC
->
pKVCur
!=0 );

3009 if–
pOp
->
p4
.
i
>0 ){

3010 
rc
 = 
	`sqlôe4VdbeEncodeKey
(

3011 
db
, 
pIn3
, 
pOp
->
p4
.
i
, 
pC
->
iRoŸ
,ÖC->
pKeyInfo
, &
pProbe
, &
nProbe
, 0

3013 
pFªe
 = 
pProbe
;

3015 
pProbe
 = (
KVByãAºay
*)
pIn3
->
z
;

3016 
nProbe
 = 
pIn3
->
n
;

3017 
pFªe
 = 0;

3019 if–
rc
==
SQLITE4_OK
 ){

3020 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC
->
pKVCur
, 
pProbe
, 
nProbe
, +1);

3021 if–
rc
==
SQLITE4_INEXACT
 ||Ñc==
SQLITE4_OK
 ){

3022 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
pKey
, &
nKey
);

3023 if–
rc
==
SQLITE4_OK
 && 
nKey
>=
nProbe
 && 
	`memcmp
(
pKey
, 
pProbe
,ÇProbe)==0 ){

3024 
ÆªadyExi°s
 = 1;

3025 
pC
->
nuŒRow
 = 0;

3027 }if–
rc
==
SQLITE4_NOTFOUND
 ){

3028 
rc
 = 
SQLITE4_OK
;

3031 
	`sqlôe4DbFªe
(
db
, 
pFªe
);

3032 if–
pOp
->
›code
==
OP_Found
 ){

3033 if–
ÆªadyExi°s
 ) 
pc
 = 
pOp
->
p2
 - 1;

3035 if–!
ÆªadyExi°s
 ) 
pc
 = 
pOp
->
p2
 - 1;

3056 
OP_IsUnique
: {

3057 
VdbeCurs‹
 *
pC
;

3058 
Mem
 *
pProbe
;

3059 
Mem
 *
pOut
;

3060 
iOut
;

3061 
nSh‹t
;

3062 
dú
;

3063 
bPk
;

3064 
u64
 
dummy
;

3066 
KVByãAºay
 c⁄° *
aKey
;

3067 
KVSize
 
nKey
;

3069 
	`as£π
–
pOp
->
p4ty≥
==
P4_INT32
 );

3071 
pProbe
 = &
aMem
[
pOp
->
p3
];

3072 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3073 
pC
->
rowChnged
 = 1;

3074 
pOut
 = (
pOp
->
p4
.
i
==0 ? 0 : &
aMem
[pOp->p4.i]);

3075 
bPk
 = (
pC
->
pKeyInfo
->
nPK
==0);

3076 
	`as£π
–
pOut
==0 || (pOut->
Êags
 & 
MEM_Blob
Ë|| 
bPk
 );

3078 if–
bPk
==0 ){

3079 
nSh‹t
 = 
	`sqlôe4VdbeSh‹tKey
((
u8
 *)
pProbe
->
z
,ÖProbe->
n
,

3080 
pC
->
pKeyInfo
->
nFõld
 -ÖC->pKeyInfo->
nPK
, 0

3082 
	`as£π
–
nSh‹t
<=
pProbe
->
n
 );

3083 
	`as£π
–(
nSh‹t
==
pProbe
->
n
)==(
pC
->
pKeyInfo
->
nPK
==0) );

3085 
nSh‹t
 = 
pProbe
->
n
;

3088 
dú
 = !
bPk
;

3089 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC
->
pKVCur
, (
u8
 *)
pProbe
->
z
, 
nSh‹t
, 
dú
);

3091 if–
rc
==
SQLITE4_OK
 && 
pOut
 ){

3092 
	`sqlôe4VdbeMemC›y
(
pOut
, 
pProbe
);

3093 }if–
rc
==
SQLITE4_NOTFOUND
 ){

3094 
rc
 = 
SQLITE4_OK
;

3095 
pc
 = 
pOp
->
p2
-1;

3096 }if–
rc
==
SQLITE4_INEXACT
 ){

3097 
	`as£π
–
nSh‹t
<
pProbe
->
n
 );

3098 
	`as£π
–
bPk
==0 );

3099 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

3100 if–
rc
==
SQLITE4_OK
 ){

3101 if–
nKey
<
nSh‹t
 || 
	`memcmp
(
pProbe
->
z
, 
aKey
,ÇShort) ){

3102 
pc
 = 
pOp
->
p2
-1;

3103 }if–
pOut
 ){

3104 
iOut
 = 
	`sqlôe4GëV¨öt64
((
u8
 *)
pOut
->
z
,ÖOut->
n
, &
dummy
);

3105 
rc
 = 
	`sqlôe4VdbeMemGrow
(
pOut
, 
iOut
+(
nKey
 - 
nSh‹t
), 1);

3106 if–
rc
==
SQLITE4_OK
 ){

3107 
	`mem˝y
(&
pOut
->
z
[
iOut
], &
aKey
[
nSh‹t
], (
nKey
 -ÇShort));

3108 
pOut
->
n
 = 
iOut
 + (
nKey
 - 
nSh‹t
);

3124 
OP_Sequí˚
: {

3125 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3126 
	`as£π
–
p
->
≠C§
[
pOp
->
p1
]!=0 );

3127 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
p
->
≠C§
[
pOp
->
p1
]->
£qCou¡
++);

3141 
OP_NewRowid
: {

3142 
i64
 
v
;

3143 
VdbeCurs‹
 *
pC
;

3144 c⁄° 
KVByãAºay
 *
aKey
;

3145 
KVSize
 
nKey
;

3146 
n
;

3147 
i64
 
i3
;

3148 
sqlôe4_num
 
vNum
;

3150 
v
 = 0;

3151 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3152 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3153 
	`as£π
–
pC
!=0 );

3159 
	#MAX_ROWID
 (
i64
)–(((
u64
)0x7fffffff)<<32Ë| (u64)0xfffffff‡)

	)

3175 
rc
 = 
	`sqlôe4VdbeSìkEnd
(
pC
, -2);

3176 if–
rc
==
SQLITE4_NOTFOUND
 ){

3177 
v
 = 0;

3178 
rc
 = 
SQLITE4_OK
;

3179 }if–
rc
==
SQLITE4_OK
 ){

3180 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

3181 if–
rc
==
SQLITE4_OK
 ){

3182 
n
 = 
	`sqlôe4GëV¨öt64
((
u8
 *)
aKey
, 
nKey
, (
u64
 *)&
v
);

3183 if–
n
==0 ) 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

3184 if–
v
!=
pC
->
iRoŸ
 ) 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

3186 if–
rc
==
SQLITE4_OK
 ){

3187 
n
 = 
	`sqlôe4VdbeDecodeNumîicKey
(&
aKey
[n], 
nKey
-n, &
vNum
);

3188 if–
n
==0 || (
v
 = 
	`sqlôe4_num_to_öt64
(
vNum
,0))==
LARGEST_INT64
 ){

3189 
	`as£π
( 0 );

3190 
rc
 = 
SQLITE4_FULL
;

3196 #i‚de‡
SQLITE_OMIT_AUTOINCREMENT


3197 if–
pOp
->
p3
 && 
rc
==
SQLITE4_OK
 ){

3198 
pIn3
 = 
	`sqlôe4Regi°îInRoŸFøme
(
p
, 
pOp
->
p3
);

3199 
	`as£π
–
	`memIsVÆid
(
pIn3
) );

3200 
	`REGISTER_TRACE
(
pOp
->
p3
, 
pIn3
);

3201 
	`sqlôe4VdbeMemI¡egîify
(
pIn3
);

3202 
	`as£π
–(
pIn3
->
Êags
 & 
MEM_I¡
)!=0 );

3203 
i3
 = 
	`sqlôe4_num_to_öt64
(
pIn3
->
u
.
num
, 0);

3204 if–
i3
==
MAX_ROWID
 ){

3205 
rc
 = 
SQLITE4_FULL
;

3206 
	`as£π
( 0 );

3208 if–
v
<
i3
 ) v = i3;

3211 
pOut
->
Êags
 = 
MEM_I¡
;

3212 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
v
+1);

3226 
OP_NewIdxid
: {

3227 
u64
 
iMax
;

3228 
i64
 
i1
;

3229 
KVSt‹e
 *
pKV
;

3230 
KVCurs‹
 *
pC§
;

3232 
pKV
 = 
db
->
aDb
[
pOp
->
p2
].pKV;

3233 
pIn1
 = &
aMem
[
pOp
->
p1
];

3234 
iMax
 = 0;

3235 
	`as£π
–
pIn1
->
Êags
 & 
MEM_I¡
 );

3237 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pKV
, &
pC§
);

3238 if–
rc
==
SQLITE4_OK
 ){

3239 c⁄° 
u8
 
aKey
[] = { 0xFF, 0xFF };

3240 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC§
, 
aKey
, (aKey), -2);

3241 if–
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_INEXACT
 ){

3242 c⁄° 
KVByãAºay
 *
pKey
;

3243 
KVSize
 
nKey
;

3244 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC§
, &
pKey
, &
nKey
);

3245 if–
rc
==
SQLITE4_OK
 ){

3246 
	`sqlôe4GëV¨öt64
((c⁄° *)
pKey
, 
nKey
, &
iMax
);

3248 }if–
rc
==
SQLITE4_NOTFOUND
 ){

3249 
rc
 = 
SQLITE4_OK
;

3251 
	`sqlôe4KVCurs‹Clo£
(
pC§
);

3254 
i1
 = 
	`sqlôe4_num_to_öt64
(
pIn1
->
u
.
num
, 0);

3255 if–
i1
>=(
i64
)
iMax
 ){

3256 
i1
++;

3258 
i1
 = 
iMax
+1;

3260 
pIn1
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
i1
);

3279 
OP_Dñëe
: {

3280 
VdbeCurs‹
 *
pC
;

3281 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3282 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3283 
	`as£π
–
pC
!=0 );

3284 
	`as£π
–
pC
->
sSìkKey
.
n
==0 );

3285 
pC
->
rowChnged
 = 1;

3286 
rc
 = 
	`sqlôe4KVCurs‹Dñëe
(
pC
->
pKVCur
);

3287 if–
pOp
->
p2
 & 
OPFLAG_NCHANGE
 ) 
p
->
nCh™ge
++;

3298 
OP_Re£tCou¡
: {

3299 
	`sqlôe4VdbeSëCh™ges
(
db
, 
p
->
nCh™ge
);

3300 
p
->
nCh™ge
 = 0;

3318 
OP_GΩCom∑ª
: {

3319 
VdbeCurs‹
 *
pC
;

3320 
KVByãAºay
 c⁄° *
aKey
;

3321 
KVSize
 
nKey
;

3323 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3324 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

3325 if–
rc
==
SQLITE4_OK
 ){

3326 
nKey
--; (
aKey
[nKey] & 0x80)==0;ÇKey--);

3329 
pIn3
 = &
aMem
[
pOp
->
p3
];

3330 if–(
pIn3
->
Êags
 & 
MEM_Blob
)

3331 && 
pIn3
->
n
==
nKey
 && 0==
	`memcmp
’In3->
z
, 
aKey
,ÇKey)

3333 
pc
 = 
pOp
->
p2
-1;

3335 
	`sqlôe4VdbeMemSëSå
(
pIn3
, (c⁄° *)
aKey
, 
nKey
, 0, 
SQLITE4_TRANSIENT
,0);

3371 
OP_S‹ãrD©a
:

3372 
OP_RowKey
:

3373 
OP_RowD©a
: {

3374 
VdbeCurs‹
 *
pC
;

3375 
KVCurs‹
 *
pCr§
;

3376 c⁄° 
KVByãAºay
 *
pD©a
;

3377 
KVSize
 
nD©a
;

3378 
nV¨öt
;

3379 
u64
 
dummy
;

3381 
pOut
 = &
aMem
[
pOp
->
p2
];

3382 
	`memAboutToCh™ge
(
p
, 
pOut
);

3385 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3386 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3387 
rc
 = 
	`sqlôe4VdbeCurs‹Movëo
(
pC
);

3388 if–
rc
!=
SQLITE4_OK
 ) ;

3389 
	`as£π
–
pC
->
nuŒRow
==0 );

3390 
	`as£π
–
pC
->
pKVCur
!=0 );

3391 
pCr§
 = 
pC
->
pKVCur
;

3393 if–
pOp
->
›code
==
OP_RowKey
 ){

3394 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pCr§
, &
pD©a
, &
nD©a
);

3395 if–
pOp
->
p5
 ){

3396 
nD©a
 = 
	`sqlôe4VdbeSh‹tKey
(
pD©a
,ÇData, 1, 0);

3397 
nV¨öt
 = 
	`sqlôe4GëV¨öt64
(
pD©a
, 
nD©a
, &
dummy
);

3398 
pD©a
 +
nV¨öt
;

3399 
nD©a
 -
nV¨öt
;

3402 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pCr§
, 0, -1, &
pD©a
, &
nD©a
);

3404 if–
rc
==
SQLITE4_OK
 && 
nD©a
>
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

3405 
too_big
;

3407 
	`sqlôe4VdbeMemSëSå
(
pOut
, (c⁄° *)
pD©a
, 
nD©a
, 0, 
SQLITE4_TRANSIENT
,0);

3408 
pOut
->
íc
 = 
SQLITE4_UTF8
;

3409 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

3429 
OP_A«lyzeKey
: {

3430 
VdbeCurs‹
 *
pC
;

3431 c⁄° 
KVByãAºay
 *
pNew
;

3432 
KVSize
 
nNew
;

3433 
Mem
 *
pKey
;

3434 
Mem
 *
aIn¸
;

3435 
nEq
;

3436 
nTŸÆ
;

3437 
i
;

3439 
pKey
 = &
aMem
[
pOp
->
p2
];

3440 
aIn¸
 = &
aMem
[
pOp
->
p3
];

3441 
nTŸÆ
 = 
pOp
->
p4
.
i
;

3442 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3443 
	`as£π
–
pC
!=0 );

3444 
	`as£π
–
pC
->
nuŒRow
==0 );

3445 
	`as£π
–
pC
->
pKVCur
!=0 );

3446 
	`as£π
–
pOp
->
p4ty≥
==
P4_INT32
 );

3448 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
pNew
, &
nNew
);

3449 if–
rc
==
SQLITE4_OK
 ){

3450 
	`as£π
–
pKey
->
Êags
 & (
MEM_Blob
|
MEM_NuŒ
) );

3451 if–
pKey
->
Êags
 & 
MEM_Blob
 ){

3452 
i
=0; i<
nNew
 && i<
pKey
->
n
 && 
pNew
[i]==(
KVByãAºay
ÌKey->
z
[i]; i++);

3456 
	`sqlôe4VdbeSh‹tKey
(
pNew
, 
i
, 
LARGEST_INT32
, &
nEq
);

3458 
nEq
 = 
nTŸÆ
;

3462 
i
=
nEq
; i<
nTŸÆ
; i++){

3463 
	`memAboutToCh™ge
(
p
, &
aIn¸
[
i
]);

3464 
	`sqlôe4VdbeMemI¡egîify
(&
aIn¸
[
i
]);

3465 
aIn¸
[
i
].
u
.
num
 = 
	`sqlôe4_num_add
(

3466 
aIn¸
[
i
].
u
.
num
, 
	`sqlôe4_num_‰om_öt64
(1)

3468 
	`REGISTER_TRACE
(
pOp
->
p1
, &
aIn¸
[
i
]);

3472 
	`memAboutToCh™ge
(
p
, 
pKey
);

3473 
	`sqlôe4VdbeMemSëSå
(
pKey
, (c⁄° *)
pNew
, 
nNew
, 0, 
SQLITE4_TRANSIENT
,0);

3474 
pKey
->
íc
 = 
SQLITE4_UTF8
;

3475 
	`UPDATE_MAX_BLOBSIZE
(
pKey
);

3490 
OP_Rowid
: {

3491 
VdbeCurs‹
 *
pC
;

3492 
i64
 
v
;

3493 c⁄° 
KVByãAºay
 *
aKey
;

3494 
KVSize
 
nKey
;

3495 
n
;

3496 
sqlôe4_num
 
vNum
;

3498 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3499 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3500 
rc
 = 
	`sqlôe4VdbeCurs‹Movëo
(
pC
);

3501 if–
rc
!=
SQLITE4_OK
 ) ;

3502 
	`as£π
–
pC
->
sSìkKey
.
n
==0 );

3503 if–
pC
->
nuŒRow
 ){

3504 
pOut
->
Êags
 = 
MEM_NuŒ
;

3506 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


3507 }if–
pC
->
pVèbCurs‹
 ){

3508 
pVèb
 = 
pC
->
pVèbCurs‹
->pVtab;

3509 
pModuÀ
 = 
pVèb
->pModule;

3510 
	`as£π
–
pModuÀ
->
xRowid
 );

3511 
rc
 = 
pModuÀ
->
	`xRowid
(
pC
->
pVèbCurs‹
, &
v
);

3512 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

3515 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

3516 if–
rc
==
SQLITE4_OK
 ){

3517 
n
 = 
	`sqlôe4GëV¨öt64
(
aKey
, 
nKey
, (
sqlôe4_uöt64
*)&
v
);

3518 
n
 = 
	`sqlôe4VdbeDecodeNumîicKey
(&
aKey
[n], 
nKey
-n, &
vNum
);

3519 if–
n
==0 ) 
rc
 = 
SQLITE4_CORRUPT
;

3520 
v
 = 
	`sqlôe4_num_to_öt64
(
vNum
,0);

3523 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
v
);

3533 
OP_NuŒRow
: {

3534 
VdbeCurs‹
 *
pC
;

3536 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3537 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3538 
	`as£π
–
pC
!=0 );

3539 
pC
->
nuŒRow
 = 1;

3540 
pC
->
rowChnged
 = 1;

3552 
OP_La°
: {

3553 
VdbeCurs‹
 *
pC
;

3555 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3556 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3557 
	`as£π
–
pC
!=0 );

3558 
rc
 = 
	`sqlôe4VdbeSìkEnd
(
pC
, -1);

3559 if–
rc
==
SQLITE4_NOTFOUND
 ){

3560 
rc
 = 
SQLITE4_OK
;

3561 if–
pOp
->
p2
 ) 
pc
 =ÖOp->p2 - 1;

3563 
pC
->
nuŒRow
 = 0;

3581 
OP_S‹ãrS‹t
:

3582 
pOp
->
›code
 = 
OP_S‹t
;

3583 
OP_S‹t
: {

3584 #ifde‡
SQLITE4_TEST


3585 
sqlôe4_s‹t_cou¡
++;

3586 
sqlôe4_£¨ch_cou¡
--;

3588 
p
->
aCou¡î
[
SQLITE4_STMTSTATUS_SORT
-1]++;

3599 
OP_Rewöd
: {

3600 
VdbeCurs‹
 *
pC
;

3601 
doJump
;

3603 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3604 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3605 
	`as£π
–
pC
!=0 );

3606 
doJump
 = 1;

3607 
rc
 = 
	`sqlôe4VdbeSìkEnd
(
pC
, +1);

3608 if–
rc
==
SQLITE4_NOTFOUND
 ){

3609 
rc
 = 
SQLITE4_OK
;

3610 
doJump
 = 1;

3612 
doJump
 = 0;

3614 
pC
->
nuŒRow
 = (
u8
)
doJump
;

3615 
	`as£π
–
pOp
->
p2
>0 &&ÖOp->p2<
p
->
nOp
 );

3616 if–
doJump
 ){

3617 
pc
 = 
pOp
->
p2
 - 1;

3654 
OP_S‹ãrNext
:

3655 
pOp
->
›code
 = 
OP_Next
;

3656 
OP_Pªv
:

3657 
OP_Next
: {

3658 
VdbeCurs‹
 *
pC
;

3660 
CHECK_FOR_INTERRUPT
;

3661 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3662 
	`as£π
–
pOp
->
p5
<=
	`AºaySize
(
p
->
aCou¡î
) );

3663 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3664 if–
pC
==0 ){

3667 
	`as£π
–
pOp
->
›code
!=
OP_Next
 ||ÖOp->
p4
.
xAdv™˚
==
sqlôe4VdbeNext
 );

3668 
	`as£π
–
pOp
->
›code
!=
OP_Pªv
 ||ÖOp->
p4
.
xAdv™˚
==
sqlôe4VdbePªvious
 );

3669 
rc
 = 
pOp
->
p4
.
	`xAdv™˚
(
pC
);

3670 if–
rc
==
SQLITE4_OK
 ){

3671 
pc
 = 
pOp
->
p2
 - 1;

3672 if–
pOp
->
p5
 ) 
p
->
aCou¡î
[pOp->p5-1]++;

3673 
pC
->
nuŒRow
 = 0;

3674 #ifde‡
SQLITE4_TEST


3675 
sqlôe4_£¨ch_cou¡
++;

3677 }if–
rc
==
SQLITE4_NOTFOUND
 ){

3678 
pC
->
nuŒRow
 = 1;

3679 
rc
 = 
SQLITE4_OK
;

3698 
OP_In£π
: {

3699 
VdbeCurs‹
 *
pC
;

3700 
Mem
 *
pKey
;

3701 
Mem
 *
pD©a
;

3702 
nKVKey
;

3703 
KVByãAºay
 *
pKVKey
;

3704 
KVByãAºay
 
aKey
[24];

3707 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3708 
pKey
 = &
aMem
[
pOp
->
p3
];

3709 
pD©a
 = 
pOp
->
p2
 ? &
aMem
[pOp->p2] : 0;

3711 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3712 
	`as£π
–
pC
 &&ÖC->
pKVCur
 &&ÖC->pKVCur->
pSt‹e
 );

3713 
	`as£π
–
pD©a
==0 || (pD©a->
Êags
 & 
MEM_Blob
) );

3715 if–
pOp
->
p5
 & 
OPFLAG_NCHANGE
 ) 
p
->
nCh™ge
++;

3717 if–
pKey
->
Êags
 & 
MEM_I¡
 ){

3718 
nKVKey
 = 
	`sqlôe4PutV¨öt64
(
aKey
, 
pC
->
iRoŸ
);

3719 
nKVKey
 +
	`sqlôe4VdbeEncodeI¡Key
(
aKey
+nKVKey, 
	`sqlôe4VdbeI¡VÆue
(
pKey
));

3720 
pKVKey
 = 
aKey
;

3722 
nKVKey
 = 
pKey
->
n
;

3723 
pKVKey
 = 
pKey
->
z
;

3727 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(

3728 
pC
->
pKVCur
->
pSt‹e
,

3729 (
u8
 *)
pKVKey
, 
nKVKey
,

3730 (
u8
 *)(
pD©a
 ?ÖD©a->
z
 : 0), (pD©®?ÖD©a->
n
 : 0)

3732 
pC
->
rowChnged
 = 1;

3744 
OP_IdxDñëe
: {

3745 
VdbeCurs‹
 *
pC
;

3746 
Mem
 *
pKey
;

3748 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3749 
pKey
 = &
aMem
[
pOp
->
p3
];

3751 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
p
->
nCurs‹
 );

3752 
	`as£π
–
pC
 &&ÖC->
pKVCur
 &&ÖC->pKVCur->
pSt‹e
 );

3753 
	`as£π
–
pKey
->
Êags
 & 
MEM_Blob
 );

3755 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pC
->
pKVCur
, (
u8
 *)
pKey
->
z
,ÖKey->
n
, 0);

3756 if–
rc
==
SQLITE4_OK
 ){

3757 
rc
 = 
	`sqlôe4KVCurs‹Dñëe
(
pC
->
pKVCur
);

3758 }if–
rc
==
SQLITE4_NOTFOUND
 ){

3759 
rc
 = 
SQLITE4_OK
;

3761 
pC
->
rowChnged
 = 1;

3775 
OP_IdxRowkey
: {

3776 
KVByãAºay
 c⁄° *
aKey
;

3777 
KVSize
 
nKey
;

3778 
nSh‹t
;

3779 
KVByãAºay
 *
aPkKey
;

3780 
KVSize
 
nPkKey
;

3781 
iRoŸ
;

3782 
VdbeCurs‹
 *
pC
;

3784 
iRoŸ
 = 
pOp
->
p3
;

3785 
pOut
 = &
aMem
[
pOp
->
p2
];

3786 
	`memAboutToCh™ge
(
p
, 
pOut
);

3788 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3790 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

3791 if–
rc
!=
SQLITE4_OK
 ) ;

3793 
nSh‹t
 = 
	`sqlôe4VdbeSh‹tKey
(
aKey
, 
nKey
,

3794 
pC
->
pKeyInfo
->
nFõld
 -ÖC->pKeyInfo->
nPK
, 0

3797 
nPkKey
 = 
	`sqlôe4V¨ötLí
(
iRoŸ
Ë+ 
nKey
 - 
nSh‹t
;

3798 if–
nPkKey
>
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

3799 
too_big
;

3802 
rc
 = 
	`sqlôe4VdbeMemGrow
(
pOut
, 
nPkKey
, 0);

3803 if–
rc
!=
SQLITE4_OK
 ) ;

3804 
aPkKey
 = 
pOut
->
z
;

3805 
	`putV¨öt32
(
aPkKey
, 
iRoŸ
);

3806 
	`mem˝y
(&
aPkKey
[
nPkKey
 - (
nKey
-
nSh‹t
)], &
aKey
[nShort],ÇKey-nShort);

3807 
pOut
->
ty≥
 = 
SQLITE4_BLOB
;

3808 
pOut
->
n
 = 
nPkKey
;

3809 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_Blob
);

3811 
pOut
->
íc
 = 
SQLITE4_UTF8
;

3812 
	`UPDATE_MAX_BLOBSIZE
(
pOut
);

3827 
OP_IdxLT
:

3828 
OP_IdxLE
:

3829 
OP_IdxGE
:

3830 
OP_IdxGT
: {

3831 
VdbeCurs‹
 *
pC
;

3832 
KVByãAºay
 c⁄° *
aKey
;

3833 
KVSize
 
nKey
;

3834 
Mem
 *
pCmp
;

3835 
nCmp
;

3836 
ªs
;

3837 
bJump
;

3839 
pCmp
 = &
aMem
[
pOp
->
p3
];

3840 
	`as£π
–
pCmp
->
Êags
 & 
MEM_Blob
 );

3841 
pC
 = 
p
->
≠C§
[
pOp
->
p1
];

3842 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pC
->
pKVCur
, &
aKey
, &
nKey
);

3844 if–
rc
==
SQLITE4_OK
 ){

3845 
nCmp
 = 
pCmp
->
n
;

3846 if–
nCmp
>
nKey
 )ÇCmp =ÇKey;

3848 
ªs
 = 
	`memcmp
(
aKey
, 
pCmp
->
z
, 
nCmp
);

3849  
pOp
->
›code
 ){

3850 
OP_IdxLT
: 
bJump
 = (
ªs
 < 0); ;

3851 
OP_IdxLE
: 
bJump
 = (
ªs
 <= 0); ;

3852 
OP_IdxGE
: 
bJump
 = (
ªs
 >= 0); ;

3853 
OP_IdxGT
: 
bJump
 = (
ªs
 > 0); ;

3856 if–
bJump
 ) 
pc
 = 
pOp
->
p2
 - 1;

3875 
OP_CÀ¨
: {

3876 
KVCurs‹
 *
pCur
;

3877 
KVByãAºay
 c⁄° *
aKey
;

3878 
KVSize
 
nKey
;

3879 
KVSize
 
nProbe
;

3880 
KVByãAºay
 
aProbe
[12];

3882 
nProbe
 = 
	`sqlôe4PutV¨öt64
(
aProbe
, 
pOp
->
p1
);

3883 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
db
->
aDb
[
pOp
->
p2
].
pKV
, &
pCur
);

3884 if–
rc
 ) ;

3885 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
aProbe
, 
nProbe
, +1);

3886  
rc
!=
SQLITE4_NOTFOUND
 ){

3887 if–
pOp
->
p5
 & 
OPFLAG_NCHANGE
 ) 
p
->
nCh™ge
++;

3888 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pCur
, &
aKey
, &
nKey
);

3889 if–
rc
!=
SQLITE4_OK
 ) ;

3890 if–
nKey
<
nProbe
 ){ 
rc
 = 
SQLITE4_CORRUPT
; ; }

3891 if–
	`memcmp
(
aKey
, 
aProbe
, 
nProbe
)!=0 ) ;

3892 
rc
 = 
	`sqlôe4KVCurs‹Dñëe
(
pCur
);

3893 if–
rc
 ) ;

3894 
rc
 = 
	`sqlôe4KVCurs‹Next
(
pCur
);

3896 
	`sqlôe4KVCurs‹Clo£
(
pCur
);

3897 if–
rc
==
SQLITE4_NOTFOUND
Ër¯
SQLITE4_OK
;

3910 
OP_P¨£Schema
: {

3911 
iDb
;

3912 c⁄° *
zMa°î
;

3913 *
zSql
;

3914 
InôD©a
 
öôD©a
;

3916 
iDb
 = 
pOp
->
p1
;

3917 
	`as£π
–
iDb
>=0 && iDb<
db
->
nDb
 );

3918 
	`as£π
–
	`DbHasPr›îty
(
db
, 
iDb
, 
DB_SchemaLﬂded
) );

3920 
zMa°î
 = 
	`SCHEMA_TABLE
(
iDb
);

3921 
öôD©a
.
db
 = db;

3922 
öôD©a
.
iDb
 = 
pOp
->
p1
;

3923 
öôD©a
.
pzEºMsg
 = &
p
->
zEºMsg
;

3924 
zSql
 = 
	`sqlôe4MPrötf
(
db
,

3926 
db
->
aDb
[
iDb
].
zName
, 
zMa°î
, 
pOp
->
p4
.
z
);

3927 if–
zSql
==0 ){

3928 
rc
 = 
SQLITE4_NOMEM
;

3930 
	`as£π
–
db
->
öô
.
busy
==0 );

3931 
db
->
öô
.
busy
 = 1;

3932 
öôD©a
.
rc
 = 
SQLITE4_OK
;

3933 
	`as£π
–!
db
->
mÆlocFaûed
 );

3934 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
sqlôe4InôCÆlback
, &
öôD©a
);

3935 if–
rc
==
SQLITE4_OK
 )Ñ¯
öôD©a
.rc;

3936 
	`sqlôe4DbFªe
(
db
, 
zSql
);

3937 
db
->
öô
.
busy
 = 0;

3940 if–
rc
==
SQLITE4_NOMEM
 ){

3941 
no_mem
;

3946 #i‡!
	`deföed
(
SQLITE4_OMIT_ANALYZE
)

3953 
OP_LﬂdA«lysis
: {

3954 
	`as£π
–
pOp
->
p1
>=0 &&ÖOp->p1<
db
->
nDb
 );

3955 
rc
 = 
	`sqlôe4A«lysisLﬂd
(
db
, 
pOp
->
p1
);

3967 
OP_Dr›TabÀ
: {

3968 
	`sqlôe4U∆ökAndDñëeTabÀ
(
db
, 
pOp
->
p1
,ÖOp->
p4
.
z
);

3979 
OP_Dr›Index
: {

3980 
	`sqlôe4U∆ökAndDñëeIndex
(
db
, 
pOp
->
p1
,ÖOp->
p4
.
z
);

3991 
OP_Dr›Triggî
: {

3992 
	`sqlôe4U∆ökAndDñëeTriggî
(
db
, 
pOp
->
p1
,ÖOp->
p4
.
z
);

4005 
OP_RowSëTe°
: {

4006 
iSë
;

4007 
pIn1
 = &
aMem
[
pOp
->
p1
];

4008 
pIn3
 = &
aMem
[
pOp
->
p3
];

4009 
iSë
 = 
pOp
->
p4
.
i
;

4011 if–0!=(
pIn1
->
Êags
 & 
MEM_RowSë
)

4012 && 0!=
	`sqlôe4RowSëTe°
(
pIn1
->
u
.
pRowSë
, 
iSë
, (
u8
 *)
pIn3
->
z
,ÖIn3->
n
)

4014 
pc
 = 
pOp
->
p2
-1;

4025 
OP_RowSëAdd
: {

4026 
pIn1
 = &
aMem
[
pOp
->
p1
];

4027 if–(
pIn1
->
Êags
 & 
MEM_RowSë
)==0 ){

4028 
	`sqlôe4VdbeMemSëRowSë
(
pIn1
);

4029 if–(
pIn1
->
Êags
 & 
MEM_RowSë
)==0 ) 
no_mem
;

4031 
pIn3
 = &
aMem
[
pOp
->
p3
];

4032 
	`as£π
–
pIn3
->
Êags
 & 
MEM_Blob
 );

4033 
	`sqlôe4RowSëIn£π
(
pIn1
->
u
.
pRowSë
, (
u8
 *)
pIn3
->
z
,ÖIn3->
n
);

4043 
OP_RowSëRód
: {

4044 c⁄° 
u8
 *
aKey
;

4045 
nKey
;

4047 
CHECK_FOR_INTERRUPT
;

4048 
pIn1
 = &
aMem
[
pOp
->
p1
];

4049 
pOut
 = &
aMem
[
pOp
->
p3
];

4050 if–(
pIn1
->
Êags
 & 
MEM_RowSë
)

4051 && (
aKey
 = 
	`sqlôe4RowSëRód
(
pIn1
->
u
.
pRowSë
, &
nKey
))

4053 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, (c⁄° *)
aKey
, 
nKey
, 0,

4054 
SQLITE4_TRANSIENT
, 0);

4055 
	`sqlôe4RowSëNext
(
pIn1
->
u
.
pRowSë
);

4058 
	`sqlôe4VdbeMemSëNuŒ
(
pIn1
);

4059 
pc
 = 
pOp
->
p2
 - 1;

4065 #i‚de‡
SQLITE4_OMIT_TRIGGER


4080 
OP_Progøm
: {

4081 
nMem
;

4082 
nByã
;

4083 
Mem
 *
pRt
;

4084 
Mem
 *
pMem
;

4085 
Mem
 *
pEnd
;

4086 
VdbeFøme
 *
pFøme
;

4087 
SubProgøm
 *
pProgøm
;

4089 
pProgøm
 = 
pOp
->
p4
.pProgram;

4090 
pRt
 = &
aMem
[
pOp
->
p3
];

4091 
	`as£π
–
pProgøm
->
nOp
>0 );

4093 if–
p
->
nFøme
>=
db
->
aLimô
[
SQLITE4_LIMIT_TRIGGER_DEPTH
] ){

4094 
rc
 = 
SQLITE4_ERROR
;

4095 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "too manyÜevels ofÅriggerÑecursion");

4103 if–(
pRt
->
Êags
&
MEM_Føme
)==0 ){

4109 
nMem
 = 
pProgøm
->nMem +ÖProgøm->
nC§
;

4110 
nByã
 = 
	`ROUND8
((
VdbeFøme
))

4111 + 
nMem
 * (
Mem
)

4112 + 
pProgøm
->
nC§
 * (
VdbeCurs‹
 *)

4113 + 
pProgøm
->
nOn˚
 * (
u8
);

4114 
pFøme
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

4115 if–!
pFøme
 ){

4116 
no_mem
;

4118 
	`sqlôe4VdbeMemRñó£
(
pRt
);

4119 
pRt
->
Êags
 = 
MEM_Føme
;

4120 
pRt
->
u
.
pFøme
 =ÖFrame;

4122 
pFøme
->
v
 = 
p
;

4123 
pFøme
->
nChûdMem
 = 
nMem
;

4124 
pFøme
->
nChûdC§
 = 
pProgøm
->
nC§
;

4125 
pFøme
->
pc
 =Öc;

4126 
pFøme
->
aMem
 = 
p
->aMem;

4127 
pFøme
->
nMem
 = 
p
->nMem;

4128 
pFøme
->
≠C§
 = 
p
->apCsr;

4129 
pFøme
->
nCurs‹
 = 
p
->nCursor;

4130 
pFøme
->
aOp
 = 
p
->aOp;

4131 
pFøme
->
nOp
 = 
p
->nOp;

4132 
pFøme
->
tokí
 = 
pProgøm
->token;

4133 
pFøme
->
aOn˚Fœg
 = 
p
->aOnceFlag;

4134 
pFøme
->
nOn˚Fœg
 = 
p
->nOnceFlag;

4136 
pEnd
 = &
	`VdbeFømeMem
(
pFøme
)[pFøme->
nChûdMem
];

4137 
pMem
=
	`VdbeFømeMem
(
pFøme
);ÖMem!=
pEnd
;ÖMem++){

4138 
pMem
->
Êags
 = 
MEM_InvÆid
;

4139 
pMem
->
db
 = db;

4142 
pFøme
 = 
pRt
->
u
.pFrame;

4143 
	`as£π
–
pProgøm
->
nMem
+pProgøm->
nC§
==
pFøme
->
nChûdMem
 );

4144 
	`as£π
–
pProgøm
->
nC§
==
pFøme
->
nChûdC§
 );

4145 
	`as£π
–
pc
==
pFøme
->pc );

4148 
p
->
nFøme
++;

4149 
pFøme
->
pP¨ít
 = 
p
->pFrame;

4150 
pFøme
->
nCh™ge
 = 
p
->nChange;

4151 
p
->
nCh™ge
 = 0;

4152 
p
->
pFøme
 =ÖFrame;

4153 
p
->
aMem
 =áMem = &
	`VdbeFømeMem
(
pFøme
)[-1];

4154 
p
->
nMem
 = 
pFøme
->
nChûdMem
;

4155 
p
->
nCurs‹
 = (
u16
)
pFøme
->
nChûdC§
;

4156 
p
->
≠C§
 = (
VdbeCurs‹
 **)&
aMem
[p->
nMem
+1];

4157 
p
->
aOp
 =áO∞
pProgøm
->aOp;

4158 
p
->
nOp
 = 
pProgøm
->nOp;

4159 
p
->
aOn˚Fœg
 = (
u8
 *)&p->
≠C§
[p->
nCurs‹
];

4160 
p
->
nOn˚Fœg
 = 
pProgøm
->
nOn˚
;

4161 
pc
 = -1;

4162 
	`mem£t
(
p
->
aOn˚Fœg
, 0,Ö->
nOn˚Fœg
);

4179 
OP_P¨am
: {

4180 
VdbeFøme
 *
pFøme
;

4181 
Mem
 *
pIn
;

4182 
pFøme
 = 
p
->pFrame;

4183 
pIn
 = &
pFøme
->
aMem
[
pOp
->
p1
 +ÖFøme->
aOp
[pFøme->
pc
].p1];

4184 
	`as£π
–
	`memIsVÆid
(
pIn
) );

4185 
	`sqlôe4VdbeMemShÆlowC›y
(
pOut
, 
pIn
, 
MEM_Ephem
);

4191 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


4199 
OP_FkCou¡î
: {

4200 if–
pOp
->
p1
 ){

4201 
db
->
nDe„ºedC⁄s
 +
pOp
->
p2
;

4203 
p
->
nFkC⁄°øöt
 +
pOp
->
p2
;

4219 
OP_FkIfZîo
: {

4220 if–
pOp
->
p1
 ){

4221 if–
db
->
nDe„ºedC⁄s
==0 ) 
pc
 = 
pOp
->
p2
-1;

4223 if–
p
->
nFkC⁄°øöt
==0 ) 
pc
 = 
pOp
->
p2
-1;

4229 #i‚de‡
SQLITE4_OMIT_AUTOINCREMENT


4240 
OP_MemMax
: {

4241 
i64
 
i1
;

4242 
i64
 
i2
;

4243 
Mem
 *
pIn1
;

4244 
pIn1
 = 
	`sqlôe4Regi°îInRoŸFøme
(
p
, 
pOp
->
p1
);

4245 
	`as£π
–
	`memIsVÆid
(
pIn1
) );

4246 
	`sqlôe4VdbeMemI¡egîify
(
pIn1
);

4247 
pIn2
 = &
aMem
[
pOp
->
p2
];

4248 
	`REGISTER_TRACE
(
pOp
->
p1
, 
pIn1
);

4249 
	`sqlôe4VdbeMemI¡egîify
(
pIn2
);

4250 
i1
 = 
	`sqlôe4_num_to_öt64
(
pIn1
->
u
.
num
, 0);

4251 
i2
 = 
	`sqlôe4_num_to_öt64
(
pIn2
->
u
.
num
, 0);

4252 if–
i1
<
i2
 ){

4253 
pIn1
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
i2
);

4255 
	`REGISTER_TRACE
(
pOp
->
p1
, 
pIn1
);

4267 
OP_IfPos
: {

4268 
i64
 
i1
;

4269 
pIn1
 = &
aMem
[
pOp
->
p1
];

4270 
	`as£π
–
pIn1
->
Êags
&
MEM_I¡
 );

4271 
i1
 = 
	`sqlôe4_num_to_öt64
(
pIn1
->
u
.
num
, 0);

4272 if–
i1
>0 ){

4273 
pc
 = 
pOp
->
p2
 - 1;

4285 
OP_IfNeg
: {

4286 
i64
 
i1
;

4287 
pIn1
 = &
aMem
[
pOp
->
p1
];

4288 
	`as£π
–
pIn1
->
Êags
&
MEM_I¡
 );

4289 
i1
 = 
	`sqlôe4_num_to_öt64
(
pIn1
->
u
.
num
, 0);

4290 if–
i1
<0 ){

4291 
pc
 = 
pOp
->
p2
 - 1;

4304 
OP_IfZîo
: {

4305 
i64
 
i1
;

4306 
pIn1
 = &
aMem
[
pOp
->
p1
];

4307 
	`as£π
–
pIn1
->
Êags
&
MEM_I¡
 );

4308 
i1
 = 
	`sqlôe4_num_to_öt64
(
pIn1
->
u
.
num
, 0);

4309 
i1
 +
pOp
->
p3
;

4310 
pIn1
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
i1
);

4311 if–
i1
==0 ){

4312 
pc
 = 
pOp
->
p2
 - 1;

4327 
OP_AggSãp
: {

4328 
n
;

4329 
i
;

4330 
Mem
 *
pMem
;

4331 
Mem
 *
pRec
;

4332 
sqlôe4_c⁄ãxt
 
˘x
;

4333 
sqlôe4_vÆue
 **
≠VÆ
;

4335 
n
 = 
pOp
->
p5
;

4336 
	`as£π
–
n
>=0 );

4337 
pRec
 = &
aMem
[
pOp
->
p2
];

4338 
≠VÆ
 = 
p
->
≠Arg
;

4339 
	`as£π
–
≠VÆ
 || 
n
==0 );

4340 
i
=0; i<
n
; i++, 
pRec
++){

4341 
	`as£π
–
	`memIsVÆid
(
pRec
) );

4342 
≠VÆ
[
i
] = 
pRec
;

4343 
	`memAboutToCh™ge
(
p
, 
pRec
);

4344 
	`sqlôe4VdbeMemSt‹eTy≥
(
pRec
);

4346 
˘x
.
pFunc
 = 
pOp
->
p4
.pFunc;

4347 
	`as£π
–
pOp
->
p3
>0 &&ÖOp->p3<=
p
->
nMem
 );

4348 
˘x
.
pMem
 =ÖMem = &
aMem
[
pOp
->
p3
];

4349 
pMem
->
n
++;

4350 
˘x
.
s
.
Êags
 = 
MEM_NuŒ
;

4351 
˘x
.
s
.
z
 = 0;

4352 
˘x
.
s
.
zMÆloc
 = 0;

4353 
˘x
.
s
.
xDñ
 = 0;

4354 
˘x
.
s
.
db
 = db;

4355 
˘x
.
isEº‹
 = 0;

4356 
˘x
.
pCﬁl
 = 0;

4357 if–
˘x
.
pFunc
->
Êags
 & 
SQLITE4_FUNC_NEEDCOLL
 ){

4358 
	`as£π
–
pOp
>
p
->
aOp
 );

4359 
	`as£π
–
pOp
[-1].
p4ty≥
==
P4_COLLSEQ
 );

4360 
	`as£π
–
pOp
[-1].
›code
==
OP_CﬁlSeq
 );

4361 
˘x
.
pCﬁl
 = 
pOp
[-1].
p4
.pColl;

4363 (
˘x
.
pFunc
->
xSãp
)(&˘x, 
n
, 
≠VÆ
);

4364 if–
˘x
.
isEº‹
 ){

4365 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s",

4366 (c⁄° *)
	`sqlôe4VÆueText
(&
˘x
.
s
, 
SQLITE4_UTF8
)

4368 
rc
 = 
˘x
.
isEº‹
;

4371 
	`sqlôe4VdbeMemRñó£
(&
˘x
.
s
);

4388 
OP_AggFöÆ
: {

4389 
Mem
 *
pMem
;

4390 
	`as£π
–
pOp
->
p1
>0 &&ÖOp->p1<=
p
->
nMem
 );

4391 
pMem
 = &
aMem
[
pOp
->
p1
];

4392 
	`as£π
–(
pMem
->
Êags
 & ~(
MEM_NuŒ
|
MEM_Agg
))==0 );

4393 
rc
 = 
	`sqlôe4VdbeMemFöÆize
(
pMem
, 
pOp
->
p4
.
pFunc
);

4394 if–
rc
 ){

4395 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s",

4396 (c⁄° *)
	`sqlôe4VÆueText
(
pMem
, 
SQLITE4_UTF8
)

4399 
	`sqlôe4VdbeCh™geEncodög
(
pMem
, 
ícodög
);

4400 
	`UPDATE_MAX_BLOBSIZE
(
pMem
);

4401 if–
	`sqlôe4VdbeMemTooBig
(
pMem
) ){

4402 
too_big
;

4407 #i‚de‡
SQLITE4_OMIT_PRAGMA


4419 
OP_Jou∫ÆMode
: {

4434 
OP_Expúe
: {

4435 if–!
pOp
->
p1
 ){

4436 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

4438 
p
->
expúed
 = 1;

4444 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4454 
OP_VBegö
: {

4455 
VTabÀ
 *
pVTab
;

4456 
pVTab
 = 
pOp
->
p4
.
pVèb
;

4457 
rc
 = 
	`sqlôe4VèbBegö
(
db
, 
pVTab
);

4458 if–
pVTab
 ) 
	`imp‹tVèbEºMsg
(
p
,ÖVTab->
pVèb
);

4463 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4469 
OP_VCª©e
: {

4470 
rc
 = 
	`sqlôe4VèbCÆlCª©e
(
db
, 
pOp
->
p1
,ÖOp->
p4
.
z
, &
p
->
zEºMsg
);

4475 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4481 
OP_VDe°roy
: {

4482 
p
->
öVèbMëhod
 = 2;

4483 
rc
 = 
	`sqlôe4VèbCÆlDe°roy
(
db
, 
pOp
->
p1
,ÖOp->
p4
.
z
);

4484 
p
->
öVèbMëhod
 = 0;

4489 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4496 
OP_VO≥n
: {

4497 
VdbeCurs‹
 *
pCur
;

4498 
sqlôe4_vèb_curs‹
 *
pVèbCurs‹
;

4499 
sqlôe4_vèb
 *
pVèb
;

4500 
sqlôe4_moduÀ
 *
pModuÀ
;

4502 
pCur
 = 0;

4503 
pVèbCurs‹
 = 0;

4504 
pVèb
 = 
pOp
->
p4
.pVtab->pVtab;

4505 
pModuÀ
 = (
sqlôe4_moduÀ
 *)
pVèb
->pModule;

4506 
	`as£π
(
pVèb
 && 
pModuÀ
);

4507 
rc
 = 
pModuÀ
->
	`xO≥n
(
pVèb
, &
pVèbCurs‹
);

4508 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

4509 if–
SQLITE4_OK
==
rc
 ){

4511 
pVèbCurs‹
->
pVèb
 =ÖVtab;

4514 
pCur
 = 
	`ÆloˇãCurs‹
(
p
, 
pOp
->
p1
, 0, -1, 0);

4515 if–
pCur
 ){

4516 
pCur
->
pVèbCurs‹
 =ÖVtabCursor;

4517 
pCur
->
pModuÀ
 = 
pVèbCurs‹
->
pVèb
->pModule;

4519 
db
->
mÆlocFaûed
 = 1;

4520 
pModuÀ
->
	`xClo£
(
pVèbCurs‹
);

4527 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4546 
OP_VFûãr
: {

4547 
nArg
;

4548 
iQuîy
;

4549 c⁄° 
sqlôe4_moduÀ
 *
pModuÀ
;

4550 
Mem
 *
pQuîy
;

4551 
Mem
 *
pArgc
;

4552 
sqlôe4_vèb_curs‹
 *
pVèbCurs‹
;

4553 
sqlôe4_vèb
 *
pVèb
;

4554 
VdbeCurs‹
 *
pCur
;

4555 
ªs
;

4556 
i
;

4557 
Mem
 **
≠Arg
;

4559 
pQuîy
 = &
aMem
[
pOp
->
p3
];

4560 
pArgc
 = &
pQuîy
[1];

4561 
pCur
 = 
p
->
≠C§
[
pOp
->
p1
];

4562 
	`as£π
–
	`memIsVÆid
(
pQuîy
) );

4563 
	`REGISTER_TRACE
(
pOp
->
p3
, 
pQuîy
);

4564 
	`as£π
–
pCur
->
pVèbCurs‹
 );

4565 
pVèbCurs‹
 = 
pCur
->pVtabCursor;

4566 
pVèb
 = 
pVèbCurs‹
->pVtab;

4567 
pModuÀ
 = 
pVèb
->pModule;

4570 
	`as£π
–(
pQuîy
->
Êags
&
MEM_I¡
)!=0 && 
pArgc
->flags==MEM_Int );

4571 
nArg
 = ()
pArgc
->
u
.
i
;

4572 
iQuîy
 = ()
pQuîy
->
u
.
i
;

4576 
ªs
 = 0;

4577 
≠Arg
 = 
p
->apArg;

4578 
i
 = 0; i<
nArg
; i++){

4579 
≠Arg
[
i
] = &
pArgc
[i+1];

4580 
	`sqlôe4VdbeMemSt‹eTy≥
(
≠Arg
[
i
]);

4583 
p
->
öVèbMëhod
 = 1;

4584 
rc
 = 
pModuÀ
->
	`xFûãr
(
pVèbCurs‹
, 
iQuîy
, 
pOp
->
p4
.
z
, 
nArg
, 
≠Arg
);

4585 
p
->
öVèbMëhod
 = 0;

4586 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

4587 if–
rc
==
SQLITE4_OK
 ){

4588 
ªs
 = 
pModuÀ
->
	`xEof
(
pVèbCurs‹
);

4591 if–
ªs
 ){

4592 
pc
 = 
pOp
->
p2
 - 1;

4595 
pCur
->
nuŒRow
 = 0;

4601 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4608 
OP_VCﬁumn
: {

4609 
sqlôe4_vèb
 *
pVèb
;

4610 c⁄° 
sqlôe4_moduÀ
 *
pModuÀ
;

4611 
Mem
 *
pDe°
;

4612 
sqlôe4_c⁄ãxt
 
sC⁄ãxt
;

4614 
VdbeCurs‹
 *
pCur
 = 
p
->
≠C§
[
pOp
->
p1
];

4615 
	`as£π
–
pCur
->
pVèbCurs‹
 );

4616 
	`as£π
–
pOp
->
p3
>0 &&ÖOp->p3<=
p
->
nMem
 );

4617 
pDe°
 = &
aMem
[
pOp
->
p3
];

4618 
	`memAboutToCh™ge
(
p
, 
pDe°
);

4619 if–
pCur
->
nuŒRow
 ){

4620 
	`sqlôe4VdbeMemSëNuŒ
(
pDe°
);

4623 
pVèb
 = 
pCur
->
pVèbCurs‹
->pVtab;

4624 
pModuÀ
 = 
pVèb
->pModule;

4625 
	`as£π
–
pModuÀ
->
xCﬁumn
 );

4626 
	`mem£t
(&
sC⁄ãxt
, 0, (sContext));

4633 
	`sqlôe4VdbeMemMove
(&
sC⁄ãxt
.
s
, 
pDe°
);

4634 
	`MemSëTy≥Fœg
(&
sC⁄ãxt
.
s
, 
MEM_NuŒ
);

4636 
rc
 = 
pModuÀ
->
	`xCﬁumn
(
pCur
->
pVèbCurs‹
, &
sC⁄ãxt
, 
pOp
->
p2
);

4637 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

4638 if–
sC⁄ãxt
.
isEº‹
 ){

4639 
rc
 = 
sC⁄ãxt
.
isEº‹
;

4646 
	`sqlôe4VdbeCh™geEncodög
(&
sC⁄ãxt
.
s
, 
ícodög
);

4647 
	`sqlôe4VdbeMemMove
(
pDe°
, &
sC⁄ãxt
.
s
);

4648 
	`REGISTER_TRACE
(
pOp
->
p3
, 
pDe°
);

4649 
	`UPDATE_MAX_BLOBSIZE
(
pDe°
);

4651 if–
	`sqlôe4VdbeMemTooBig
(
pDe°
) ){

4652 
too_big
;

4658 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4665 
OP_VNext
: {

4666 
sqlôe4_vèb
 *
pVèb
;

4667 c⁄° 
sqlôe4_moduÀ
 *
pModuÀ
;

4668 
ªs
;

4669 
VdbeCurs‹
 *
pCur
;

4671 
ªs
 = 0;

4672 
pCur
 = 
p
->
≠C§
[
pOp
->
p1
];

4673 
	`as£π
–
pCur
->
pVèbCurs‹
 );

4674 if–
pCur
->
nuŒRow
 ){

4677 
pVèb
 = 
pCur
->
pVèbCurs‹
->pVtab;

4678 
pModuÀ
 = 
pVèb
->pModule;

4679 
	`as£π
–
pModuÀ
->
xNext
 );

4687 
p
->
öVèbMëhod
 = 1;

4688 
rc
 = 
pModuÀ
->
	`xNext
(
pCur
->
pVèbCurs‹
);

4689 
p
->
öVèbMëhod
 = 0;

4690 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

4691 if–
rc
==
SQLITE4_OK
 ){

4692 
ªs
 = 
pModuÀ
->
	`xEof
(
pCur
->
pVèbCurs‹
);

4695 if–!
ªs
 ){

4697 
pc
 = 
pOp
->
p2
 - 1;

4703 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4710 
OP_VRíame
: {

4711 
sqlôe4_vèb
 *
pVèb
;

4712 
Mem
 *
pName
;

4714 
pVèb
 = 
pOp
->
p4
.pVtab->pVtab;

4715 
pName
 = &
aMem
[
pOp
->
p1
];

4716 
	`as£π
–
pVèb
->
pModuÀ
->
xRíame
 );

4717 
	`as£π
–
	`memIsVÆid
(
pName
) );

4718 
	`REGISTER_TRACE
(
pOp
->
p1
, 
pName
);

4719 
	`as£π
–
pName
->
Êags
 & 
MEM_Så
 );

4720 
	`ã°ˇ£
–
pName
->
íc
==
SQLITE4_UTF8
 );

4721 
	`ã°ˇ£
–
pName
->
íc
==
SQLITE4_UTF16BE
 );

4722 
	`ã°ˇ£
–
pName
->
íc
==
SQLITE4_UTF16LE
 );

4723 
rc
 = 
	`sqlôe4VdbeCh™geEncodög
(
pName
, 
SQLITE4_UTF8
);

4724 if–
rc
==
SQLITE4_OK
 ){

4725 
rc
 = 
pVèb
->
pModuÀ
->
	`xRíame
’Vèb, 
pName
->
z
);

4726 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

4727 
p
->
expúed
 = 0;

4733 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4757 
OP_VUpd©e
: {

4758 
sqlôe4_vèb
 *
pVèb
;

4759 
sqlôe4_moduÀ
 *
pModuÀ
;

4760 
nArg
;

4761 
i
;

4762 
sqlôe4_öt64
 
rowid
;

4763 
Mem
 **
≠Arg
;

4764 
Mem
 *
pX
;

4766 
	`as£π
–
pOp
->
p2
==1 ||ÖOp->
p5
==
OE_Faû
 ||ÖOp->p5==
OE_Rﬁlback


4767 || 
pOp
->
p5
==
OE_Ab‹t
 ||ÖOp->p5==
OE_Ign‹e
 ||ÖOp->p5==
OE_Rïœ˚


4769 
pVèb
 = 
pOp
->
p4
.pVtab->pVtab;

4770 
pModuÀ
 = (
sqlôe4_moduÀ
 *)
pVèb
->pModule;

4771 
nArg
 = 
pOp
->
p2
;

4772 
	`as£π
–
pOp
->
p4ty≥
==
P4_VTAB
 );

4773 if–
	`ALWAYS
(
pModuÀ
->
xUpd©e
) ){

4774 
u8
 
vèbOnC⁄Êi˘
 = 
db
->vtabOnConflict;

4775 
≠Arg
 = 
p
->apArg;

4776 
pX
 = &
aMem
[
pOp
->
p3
];

4777 
i
=0; i<
nArg
; i++){

4778 
	`as£π
–
	`memIsVÆid
(
pX
) );

4779 
	`memAboutToCh™ge
(
p
, 
pX
);

4780 
	`sqlôe4VdbeMemSt‹eTy≥
(
pX
);

4781 
≠Arg
[
i
] = 
pX
;

4782 
pX
++;

4784 
db
->
vèbOnC⁄Êi˘
 = 
pOp
->
p5
;

4785 
rc
 = 
pModuÀ
->
	`xUpd©e
(
pVèb
, 
nArg
, 
≠Arg
, &
rowid
);

4786 
db
->
vèbOnC⁄Êi˘
 = vtabOnConflict;

4787 
	`imp‹tVèbEºMsg
(
p
, 
pVèb
);

4788 if–
rc
==
SQLITE4_CONSTRAINT
 && 
pOp
->
p4
.
pVèb
->
bC⁄°øöt
 ){

4789 if–
pOp
->
p5
==
OE_Ign‹e
 ){

4790 
rc
 = 
SQLITE4_OK
;

4792 
p
->
îr‹A˘i⁄
 = ((
pOp
->
p5
==
OE_Rïœ˚
Ë? 
OE_Ab‹t
 :ÖOp->p5);

4795 
p
->
nCh™ge
++;

4802 #i‚de‡
SQLITE4_OMIT_TRACE


4808 
OP_Tø˚
: {

4809 *
zTø˚
;

4810 *
z
;

4812 if–
db
->
xTø˚
 && (
zTø˚
 = (
pOp
->
p4
.
z
 ?ÖOp->p4.z : 
p
->
zSql
))!=0 ){

4813 
z
 = 
	`sqlôe4VdbeEx∑ndSql
(
p
, 
zTø˚
);

4814 
db
->
	`xTø˚
(db->
pTø˚Arg
, 
z
);

4815 
	`sqlôe4DbFªe
(
db
, 
z
);

4817 #ifde‡
SQLITE4_DEBUG


4818 if–(
db
->
Êags
 & 
SQLITE4_SqlTø˚
)!=0

4819 && (
zTø˚
 = (
pOp
->
p4
.
z
 ?ÖOp->p4.z : 
p
->
zSql
))!=0

4821 
	`sqlôe4DebugPrötf
("SQL-åa˚: %s\n", 
zTø˚
);

4849 
OP_FtsUpd©e
: {

4850 
Fts5Info
 *
pInfo
;

4851 
Mem
 *
pKey
;

4852 
Mem
 *
aArg
;

4853 
iRoŸ
;

4855 
	`as£π
–
pOp
->
p4ty≥
==
P4_FTS5INFO
 );

4856 
pInfo
 = 
pOp
->
p4
.
pFtsInfo
;

4857 
aArg
 = &
aMem
[
pOp
->
p3
];

4858 
pKey
 = &
aMem
[
pOp
->
p1
];

4860 if–
pOp
->
p2
 ){

4861 
iRoŸ
 = 
	`sqlôe4_num_to_öt32
(
aMem
[
pOp
->
p2
].
u
.
num
, 0);

4863 
iRoŸ
 = 0;

4866 
rc
 = 
	`sqlôe4Fts5Upd©e
(
db
, 
pInfo
, 
iRoŸ
, 
pKey
, 
aArg
, 
pOp
->
p5
, &
p
->
zEºMsg
);

4876 
OP_FtsCksum
: {

4877 
Fts5Info
 *
pInfo
;

4878 
Mem
 *
pKey
;

4879 
Mem
 *
aArg
;

4880 
i64
 
cksum
;

4881 
i64
 
i1
;

4883 
	`as£π
–
pOp
->
p4ty≥
==
P4_FTS5INFO
 );

4884 
pInfo
 = 
pOp
->
p4
.
pFtsInfo
;

4886 
pOut
 = &
aMem
[
pOp
->
p1
];

4887 
pKey
 = &
aMem
[
pOp
->
p3
];

4888 
aArg
 = &
aMem
[
pOp
->
p3
+1];

4889 
cksum
 = 0;

4891 if–
pOp
->
p5
 ){

4892 
	`sqlôe4Fts5E¡ryCksum
(
db
, 
pInfo
, 
pKey
, 
aArg
, &
cksum
);

4894 
	`sqlôe4Fts5RowCksum
(
db
, 
pInfo
, 
pKey
, 
aArg
, &
cksum
);

4896 
i1
 = 
	`sqlôe4_num_to_öt64
(
pOut
->
u
.
num
, 0);

4897 
pOut
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
i1
 ^ 
cksum
);

4914 
OP_FtsO≥n
: {

4915 
Fts5Info
 *
pInfo
;

4916 
VdbeCurs‹
 *
pCur
;

4917 *
zM©ch
;

4918 
Mem
 *
pM©ch
;

4920 
pM©ch
 = &
aMem
[
pOp
->
p3
];

4921 
	`Såögify
(
pM©ch
, 
ícodög
);

4922 
zM©ch
 = 
pM©ch
->
z
;

4924 
	`as£π
–
pOp
->
p4ty≥
==
P4_FTS5INFO
 );

4925 
pInfo
 = 
pOp
->
p4
.
pFtsInfo
;

4926 
pCur
 = 
	`ÆloˇãCurs‹
(
p
, 
pOp
->
p1
, 0, 
pInfo
->
iDb
, 0);

4927 if–
pCur
 ){

4928 
rc
 = 
	`sqlôe4Fts5O≥n
(
db
, 
pInfo
, 
zM©ch
, 
pOp
->
p5
, &
pCur
->
pFts
, &
p
->
zEºMsg
);

4930 if–
rc
==
SQLITE4_OK
 && 0==
	`sqlôe4Fts5VÆid
(
pCur
->
pFts
) ){

4931 
pc
 = 
pOp
->
p2
-1;

4942 
OP_FtsNext
: {

4943 
VdbeCurs‹
 *
pC§
;

4945 
pC§
 = 
p
->
≠C§
[
pOp
->
p1
];

4946 
rc
 = 
	`sqlôe4Fts5Next
(
pC§
->
pFts
);

4947 if–
rc
==
SQLITE4_OK
 && 
	`sqlôe4Fts5VÆid
(
pC§
->
pFts
ËË
pc
 = 
pOp
->
p2
-1;

4957 
OP_FtsPk
: {

4958 
	`as£π
( 0 );

4974 
	`as£π
–
pOp
->
›code
==
OP_No›
 ||ÖOp->›code==
OP_Ex∂aö
 );

4986 #ifde‡
VDBE_PROFILE


4988 
u64
 
ñ≠£d
 = 
	`sqlôe4Hwtime
(Ë- 
°¨t
;

4989 
pOp
->
cy˛es
 +
ñ≠£d
;

4990 
pOp
->
˙t
++;

4992 
	`Ârötf
(
°dout
, "%10Œu ", 
ñ≠£d
);

4993 
	`sqlôe4VdbePrötOp
(
°dout
, 
‹igPc
, &
aOp
[origPc]);

5003 #i‚de‡
NDEBUG


5004 
	`as£π
–
pc
>=-1 &&Öc<
p
->
nOp
 );

5006 #ifde‡
SQLITE4_DEBUG


5007 if–
p
->
åa˚
 ){

5008 if–
rc
!=0 ) 
	`Ârötf
(
p
->
åa˚
,"rc=%d\n",rc);

5009 if–
pOp
->
›Êags
 & (
OPFLG_OUT2_PRERELEASE
|
OPFLG_OUT2
) ){

5010 
	`ªgi°îTø˚
(
p
->
åa˚
, 
pOp
->
p2
, &
aMem
[pOp->p2]);

5012 if–
pOp
->
›Êags
 & 
OPFLG_OUT3
 ){

5013 
	`ªgi°îTø˚
(
p
->
åa˚
, 
pOp
->
p3
, &
aMem
[pOp->p3]);

5023 
vdbe_îr‹_hÆt
:

5024 
	`as£π
–
rc
 );

5025 
p
->
rc
 =Ñc;

5026 
	`ã°ˇ£
–
sqlôe4DeÁu…Env
.
xLog
!=0 );

5027 
	`sqlôe4_log
(
db
->
pEnv
, 
rc
, "statementábortsát %d: [%s] %s",

5028 
pc
, 
p
->
zSql
,Ö->
zEºMsg
);

5029 
	`sqlôe4VdbeHÆt
(
p
);

5030 if–
rc
==
SQLITE4_IOERR_NOMEM
 ) 
db
->
mÆlocFaûed
 = 1;

5031 
rc
 = 
SQLITE4_ERROR
;

5032 if–
ª£tSchemaOnFau…
>0 ){

5033 
	`sqlôe4Re£tI¡î«lSchema
(
db
, 
ª£tSchemaOnFau…
-1);

5039 
vdbe_ªtu∫
:

5040  
rc
;

5045 
too_big
:

5046 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "string or blobÅoo big");

5047 
rc
 = 
SQLITE4_TOOBIG
;

5048 
vdbe_îr‹_hÆt
;

5052 
no_mem
:

5053 
db
->
mÆlocFaûed
 = 1;

5054 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "out of memory");

5055 
rc
 = 
SQLITE4_NOMEM
;

5056 
vdbe_îr‹_hÆt
;

5061 
ab‹t_due_to_îr‹
:

5062 
	`as£π
–
p
->
zEºMsg
==0 );

5063 if–
db
->
mÆlocFaûed
 ) 
rc
 = 
SQLITE4_NOMEM
;

5064 if–
rc
!=
SQLITE4_IOERR_NOMEM
 ){

5065 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s", 
	`sqlôe4EºSå
(
rc
));

5067 
vdbe_îr‹_hÆt
;

5072 
ab‹t_due_to_öãºu±
:

5073 
	`as£π
–
db
->
u1
.
isI¡îru±ed
 );

5074 
rc
 = 
SQLITE4_INTERRUPT
;

5075 
p
->
rc
 =Ñc;

5076 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s", 
	`sqlôe4EºSå
(
rc
));

5077 
vdbe_îr‹_hÆt
;

5078 
	}
}

	@src/vdbe.h

18 #i‚de‡
_SQLITE4_VDBE_H_


19 
	#_SQLITE4_VDBE_H_


	)

20 
	~<°dio.h
>

27 
Vdbe
 
	tVdbe
;

33 
VdbeFunc
 
	tVdbeFunc
;

34 
Mem
 
	tMem
;

35 
SubProgøm
 
	tSubProgøm
;

36 
VdbeCurs‹
 
	tVdbeCurs‹
;

43 
	sVdbeOp
 {

44 
u8
 
	m›code
;

45 sig√d 
	mp4ty≥
;

46 
u8
 
	m›Êags
;

47 
u8
 
	mp5
;

48 
	mp1
;

49 
	mp2
;

50 
	mp3
;

52 
	mi
;

53 *
	mp
;

54 *
	mz
;

55 
sqlôe4_num
 *
	mpNum
;

56 
FuncDef
 *
	mpFunc
;

57 
VdbeFunc
 *
	mpVdbeFunc
;

58 
CﬁlSeq
 *
	mpCﬁl
;

59 
Mem
 *
	mpMem
;

60 
VTabÀ
 *
	mpVèb
;

61 
KeyInfo
 *
	mpKeyInfo
;

62 *
	mai
;

63 
SubProgøm
 *
	mpProgøm
;

64 
Fts5Info
 *
	mpFtsInfo
;

65 (*
	mxAdv™˚
)(
	mVdbeCurs‹
*);

66 } 
	mp4
;

67 #ifde‡
SQLITE4_DEBUG


68 *
	mzCommít
;

70 #ifde‡
VDBE_PROFILE


71 
	m˙t
;

72 
u64
 
	mcy˛es
;

75 
VdbeOp
 
	tVdbeOp
;

81 
	sSubProgøm
 {

82 
VdbeOp
 *
	maOp
;

83 
	mnOp
;

84 
	mnMem
;

85 
	mnC§
;

86 
	mnOn˚
;

87 *
	mtokí
;

88 
SubProgøm
 *
	mpNext
;

95 
	sVdbeOpLi°
 {

96 
u8
 
	m›code
;

97 sig√d 
	mp1
;

98 sig√d 
	mp2
;

99 sig√d 
	mp3
;

101 
VdbeOpLi°
 
	tVdbeOpLi°
;

108 
	#P4_NOTUSED
 0

	)

109 
	#P4_TRANSIENT
 0

	)

110 
	#P4_DYNAMIC
 (-1Ë

	)

111 
	#P4_STATIC
 (-2Ë

	)

112 
	#P4_COLLSEQ
 (-3Ë

	)

113 
	#P4_FUNCDEF
 (-4Ë

	)

114 
	#P4_KEYINFO
 (-5Ë

	)

115 
	#P4_VDBEFUNC
 (-6Ë

	)

116 
	#P4_MEM
 (-7Ë

	)

117 
	#P4_VTAB
 (-8Ë

	)

118 
	#P4_NUM
 (-9Ë

	)

119 
	#P4_INT32
 (-10Ë

	)

120 
	#P4_INTARRAY
 (-11Ë

	)

121 
	#P4_SUBPROGRAM
 (-12Ë

	)

122 
	#P4_ADVANCE
 (-13Ë

	)

123 
	#P4_FTS5INFO
 (-14Ë

	)

132 
	#P4_KEYINFO_HANDOFF
 (-124)

	)

133 
	#P4_KEYINFO_STATIC
 (-125)

	)

139 
	#COLNAME_NAME
 0

	)

140 
	#COLNAME_DECLTYPE
 1

	)

141 
	#COLNAME_DATABASE
 2

	)

142 
	#COLNAME_TABLE
 3

	)

143 
	#COLNAME_COLUMN
 4

	)

144 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


145 
	#COLNAME_N
 5

	)

147 #ifde‡
SQLITE4_OMIT_DECLTYPE


148 
	#COLNAME_N
 1

	)

150 
	#COLNAME_N
 2

	)

160 
	#ADDR
(
X
Ë(-1-(X))

	)

166 
	~"›codes.h
"

172 
Vdbe
 *
sqlôe4VdbeCª©e
(
sqlôe4
*);

173 
sqlôe4VdbeAddOp0
(
Vdbe
*,);

174 
sqlôe4VdbeAddOp1
(
Vdbe
*,,);

175 
sqlôe4VdbeAddOp2
(
Vdbe
*,,,);

176 
sqlôe4VdbeAddOp3
(
Vdbe
*,,,,);

177 
sqlôe4VdbeAddOp4
(
Vdbe
*,,,,,c⁄° *
zP4
,);

178 
sqlôe4VdbeAddOp4I¡
(
Vdbe
*,,,,,);

179 
sqlôe4VdbeAddOpLi°
(
Vdbe
*, 
nOp
, 
VdbeOpLi°
 c⁄° *
aOp
);

180 
sqlôe4VdbeAddP¨£SchemaOp
(
Vdbe
*,,*);

181 
sqlôe4VdbeCh™geP1
(
Vdbe
*, 
u32
 
addr
, 
P1
);

182 
sqlôe4VdbeCh™geP2
(
Vdbe
*, 
u32
 
addr
, 
P2
);

183 
sqlôe4VdbeCh™geP3
(
Vdbe
*, 
u32
 
addr
, 
P3
);

184 
sqlôe4VdbeCh™geP5
(
Vdbe
*, 
u8
 
P5
);

185 
sqlôe4VdbeJumpHîe
(
Vdbe
*, 
addr
);

186 
sqlôe4VdbeCh™geToNo›
(
Vdbe
*, 
addr
);

187 
sqlôe4VdbeCh™geP4
(
Vdbe
*, 
addr
, c⁄° *
zP4
, 
N
);

188 
sqlôe4VdbeU£sSt‹age
(
Vdbe
*, );

189 
VdbeOp
 *
sqlôe4VdbeGëOp
(
Vdbe
*, );

190 
sqlôe4VdbeMakeLabñ
(
Vdbe
*);

191 
sqlôe4VdbeRunO∆yOn˚
(
Vdbe
*);

192 
sqlôe4VdbeDñëe
(
Vdbe
*);

193 
sqlôe4VdbeDñëeObje˘
(
sqlôe4
*,
Vdbe
*);

194 
sqlôe4VdbeMakeRódy
(
Vdbe
*,
P¨£
*);

195 
sqlôe4VdbeFöÆize
(
Vdbe
*);

196 
sqlôe4VdbeResﬁveLabñ
(
Vdbe
*, );

197 
sqlôe4VdbeCuºítAddr
(
Vdbe
*);

198 #ifde‡
SQLITE4_DEBUG


199 
sqlôe4VdbeAs£πMayAb‹t
(
Vdbe
 *, );

200 
sqlôe4VdbeTø˚
(
Vdbe
*,
FILE
*);

202 
sqlôe4VdbeRe£tSãpResu…
(
Vdbe
*);

203 
sqlôe4VdbeRewöd
(
Vdbe
*);

204 
sqlôe4VdbeRe£t
(
Vdbe
*);

205 
sqlôe4VdbeSëNumCﬁs
(
Vdbe
*,);

206 
sqlôe4VdbeSëCﬁName
(
Vdbe
*, , , const *, (*)(*,*));

207 
	`sqlôe4VdbeCou¡Ch™ges
(
Vdbe
*);

208 
sqlôe4
 *
	`sqlôe4VdbeDb
(
Vdbe
*);

209 
	`sqlôe4VdbeSëSql
(
Vdbe
*, c⁄° *
z
, 
n
);

210 
	`sqlôe4VdbeSw≠
(
Vdbe
*,Vdbe*);

211 
VdbeOp
 *
	`sqlôe4VdbeTakeOpAºay
(
Vdbe
*, *, *);

212 
sqlôe4_vÆue
 *
	`sqlôe4VdbeGëVÆue
(
Vdbe
*, , 
u8
);

213 
	`sqlôe4VdbeSëV¨mask
(
Vdbe
*, );

214 #i‚de‡
SQLITE4_OMIT_TRACE


215 *
	`sqlôe4VdbeEx∑ndSql
(
Vdbe
*, const *);

217 
sqlôe4_vÆue
 *
	`sqlôe4CﬁumnVÆue
(
sqlôe4_°mt
 *
pStmt
, 
iCﬁ
);

219 #i‚de‡
SQLITE4_OMIT_TRIGGER


220 
	`sqlôe4VdbeLökSubProgøm
(
Vdbe
 *, 
SubProgøm
 *);

223 
	`sqlôe4VdbeEncodeKey
(

224 
sqlôe4
 *
db
,

225 
Mem
 *
aIn
,

226 
nIn
,

227 
iTabno
,

228 
KeyInfo
 *
pKeyInfo
,

229 
u8
 **
pzOut
,

230 *
≤Out
,

231 
nExåa


234 #i‚de‡
NDEBUG


235 
	`sqlôe4VdbeCommít
(
Vdbe
*, const *, ...);

236 
	#VdbeCommít
(
X
Ë
sqlôe4VdbeCommít
 
	)
X

237 
	`sqlôe4VdbeNo›Commít
(
Vdbe
*, const *, ...);

238 
	#VdbeNo›Commít
(
X
Ë
sqlôe4VdbeNo›Commít
 
	)
X

240 
	#VdbeCommít
(
X
)

	)

241 
	#VdbeNo›Commít
(
X
)

	)

	@src/vdbeInt.h

18 #i‚de‡
_VDBEINT_H_


19 
	#_VDBEINT_H_


	)

26 
VdbeOp
 
	tOp
;

31 
	tBoﬁ
;

34 
VdbeS‹ãr
 
	tVdbeS‹ãr
;

37 
Ex∂aö
 
	tEx∂aö
;

40 
RowDecodî
 
	tRowDecodî
;

44 
	#CURTYPE_BTREE
 0

	)

45 
	#CURTYPE_SORTER
 1

	)

46 
	#CURTYPE_VTAB
 2

	)

47 
	#CURTYPE_PSEUDO
 3

	)

49 #i‚de‡
SQLITE_OMIT_VECTOR


50 
	#CURTYPE_VECTOR_IDX
 64

	)

63 
	sVdbeCurs‹
 {

64 
sqlôe4
 *
	mdb
;

65 
KVCurs‹
 *
	mpKVCur
;

66 
KVSt‹e
 *
	mpTmpKV
;

67 
KeyInfo
 *
	mpKeyInfo
;

68 
	miDb
;

69 
	miRoŸ
;

70 
	mnFõld
;

71 
Boﬁ
 
	mnuŒRow
;

72 
Boﬁ
 
	mrowChnged
;

73 
i64
 
	m£qCou¡
;

74 
VdbeS‹ãr
 *
	mpS‹ãr
;

75 
Fts5Curs‹
 *
	mpFts
;

76 
RowDecodî
 *
	mpDecodî
;

77 
sqlôe4_vèb_curs‹
 *
	mpVèbCurs‹
;

78 c⁄° 
sqlôe4_moduÀ
 *
	mpModuÀ
;

79 
sqlôe4_buf„r
 
	msSìkKey
;

84 
u8
 
	meCuπy≥
;

85 
u32
 
	miHdrOff£t
;

86 
i64
 
	mpgnoRoŸ
;

87 
u16
 
	mnHdrP¨£d
;

88 
i64
 
	mmovëoT¨gë
;

89 
u32
 *
	maOff£t
;

90 c⁄° 
u8
 *
	maRow
;

91 
u32
 
	m∑ylﬂdSize
;

92 
u32
 
	mszRow
;

96 
u32
 
	maTy≥
[1];

100 
sqlôe4VdbeFªeCurs‹
(
VdbeCurs‹
*);

101 
sqlôe4VdbeSìkEnd
(
VdbeCurs‹
*, );

102 
sqlôe4VdbeNext
(
VdbeCurs‹
*);

103 
sqlôe4VdbePªvious
(
VdbeCurs‹
*);

104 
sqlôe4VdbeCurs‹Movëo
(
VdbeCurs‹
 *);

128 
VdbeFøme
 
	tVdbeFøme
;

129 
	sVdbeFøme
 {

130 
Vdbe
 *
	mv
;

131 
	mpc
;

132 
Op
 *
	maOp
;

133 
	mnOp
;

134 
Mem
 *
	maMem
;

135 
	mnMem
;

136 
u8
 *
	maOn˚Fœg
;

137 
	mnOn˚Fœg
;

138 
VdbeCurs‹
 **
	m≠C§
;

139 
u16
 
	mnCurs‹
;

140 *
	mtokí
;

141 
	mnChûdMem
;

142 
	mnChûdC§
;

143 
	mnCh™ge
;

144 
VdbeFøme
 *
	mpP¨ít
;

147 
	#VdbeFømeMem
(
p
Ë((
Mem
 *)&((
u8
 *Ì)[
	`ROUND8
((
VdbeFøme
))])

	)

152 
	#CACHE_STALE
 0

	)

159 
	sMem
 {

160 
sqlôe4
 *
	mdb
;

161 *
	mz
;

163 
sqlôe4_num
 
	mnum
;

164 
FuncDef
 *
	mpDef
;

165 
RowSë
 *
	mpRowSë
;

166 
VdbeFøme
 *
	mpFøme
;

167 } 
	mu
;

168 
	mn
;

169 
u16
 
	mÊags
;

170 
u8
 
	mty≥
;

171 
u8
 
	míc
;

172 #ifde‡
SQLITE4_DEBUG


173 
Mem
 *
	mpSc›yFrom
;

174 *
	mpFûÀr
;

176 (*
	mxDñ
)(*,*);

177 *
	mpDñArg
;

178 *
	mzMÆloc
;

185 
	#MEMCELLSIZE
 (
size_t
)(&(((
Mem
 *)0)->
zMÆloc
))

	)

200 
	#MEM_NuŒ
 0x0001

	)

201 
	#MEM_Så
 0x0002

	)

202 
	#MEM_I¡
 0x0004

	)

203 
	#MEM_Ról
 0x0008

	)

204 
	#MEM_Blob
 0x0010

	)

205 
	#MEM_RowSë
 0x0020

	)

206 
	#MEM_Føme
 0x0040

	)

207 
	#MEM_InvÆid
 0x0080

	)

208 
	#MEM_Ty≥Mask
 0x00f‡

	)

215 
	#MEM_Tîm
 0x0200

	)

216 
	#MEM_Dyn
 0x0400

	)

217 
	#MEM_Sètic
 0x0800

	)

218 
	#MEM_Ephem
 0x1000

	)

219 
	#MEM_Agg
 0x2000

	)

224 
	#MemSëTy≥Fœg
(
p
, 
f
) \

225 ((
p
)->
Êags
 = (’)->Êags&~(
MEM_Ty≥Mask
))|
f
)

	)

231 #ifde‡
SQLITE4_DEBUG


232 
	#memIsVÆid
(
M
Ë((M)->
Êags
 & 
MEM_InvÆid
)==0

	)

245 
	sVdbeFunc
 {

246 
FuncDef
 *
	mpFunc
;

247 
	mnAux
;

248 
	sAuxD©a
 {

249 *
	mpAux
;

250 (*
	mxDñëe
)(*,*);

251 *
	mpDñëeArg
;

252 } 
	m≠Aux
[1];

268 
	ssqlôe4_c⁄ãxt
 {

269 
FuncDef
 *
	mpFunc
;

270 
VdbeFunc
 *
	mpVdbeFunc
;

271 
Mem
 
	ms
;

272 
Mem
 *
	mpMem
;

273 
	misEº‹
;

274 
CﬁlSeq
 *
	mpCﬁl
;

275 
Fts5Curs‹
 *
	mpFts
;

282 
	sEx∂aö
 {

283 
Vdbe
 *
	mpVdbe
;

284 
SåAccum
 
	m°r
;

285 
	mnIndít
;

286 
u16
 
	maIndít
[100];

287 
	mzBa£
[100];

305 
	sVdbe
 {

306 
sqlôe4
 *
	mdb
;

307 
Op
 *
	maOp
;

308 
Mem
 *
	maMem
;

309 
Mem
 **
	m≠Arg
;

310 
Mem
 *
	maCﬁName
;

311 
Mem
 *
	mpResu…Së
;

312 
	mnMem
;

313 
	mnOp
;

314 
	mnOpAŒoc
;

315 
	mnLabñ
;

316 
	mnLabñAŒoc
;

317 *
	maLabñ
;

318 
u16
 
	mnResCﬁumn
;

319 
u16
 
	mnCurs‹
;

320 
u32
 
	mmagic
;

321 *
	mzEºMsg
;

322 
Vdbe
 *
	mpPªv
,*
	mpNext
;

323 
VdbeCurs‹
 **
	m≠C§
;

324 
Mem
 *
	maV¨
;

325 **
	mazV¨
;

326 
ynV¨
 
	mnV¨
;

327 
ynV¨
 
	mnzV¨
;

328 
u32
 
	mˇcheCå
;

329 
	mpc
;

330 
	mrc
;

331 
u8
 
	mîr‹A˘i⁄
;

332 
u8
 
	mex∂aö
;

333 
u8
 
	mch™geC¡On
;

334 
u8
 
	mexpúed
;

335 
u8
 
	mrunO∆yOn˚
;

336 
u8
 
	mmöWrôeFûeF‹m©
;

337 
u8
 
	möVèbMëhod
;

338 
u8
 
	m√edSavïoöt
;

339 
u8
 
	mªadO∆y
;

340 
	mnCh™ge
;

341 
yDbMask
 
	m°mtTønsMask
;

342 
	maCou¡î
[3];

343 #i‚de‡
SQLITE4_OMIT_TRACE


344 
u64
 
	m°¨tTime
;

346 
i64
 
	mnFkC⁄°øöt
;

347 
i64
 
	mnStmtDefC⁄s
;

348 *
	mzSql
;

349 *
	mpFªe
;

350 #ifde‡
SQLITE4_DEBUG


351 
FILE
 *
	måa˚
;

353 #ifde‡
SQLITE4_ENABLE_TREE_EXPLAIN


354 
Ex∂aö
 *
	mpEx∂aö
;

355 *
	mzEx∂aö
;

357 
VdbeFøme
 *
	mpFøme
;

358 
VdbeFøme
 *
	mpDñFøme
;

359 
	mnFøme
;

360 
u32
 
	mexpmask
;

361 
SubProgøm
 *
	mpProgøm
;

362 
	mnOn˚Fœg
;

363 
u8
 *
	maOn˚Fœg
;

369 
	#VDBE_MAGIC_INIT
 0x26b˚Ø5

	)

370 
	#VDBE_MAGIC_RUN
 0xbdf20da3

	)

371 
	#VDBE_MAGIC_HALT
 0x519c2973

	)

372 
	#VDBE_MAGIC_DEAD
 0xb606c3c8

	)

377 
sqlôeVdbeP›Sèck
(
Vdbe
*,);

378 #i‡
deföed
(
SQLITE4_DEBUG
Ë|| deföed(
VDBE_PROFILE
)

379 
sqlôe4VdbePrötOp
(
FILE
*, , 
Op
*);

381 
sqlôe4VdbeDñëeAuxD©a
(
VdbeFunc
*, );

383 
sqlôe4VdbeDecodîCª©e
(

384 
sqlôe4
 *
db
,

385 
VdbeCurs‹
 *
pCur
,

386 
KVCurs‹
 *
pKVCur
,

387 
mxCﬁ
,

388 
RowDecodî
 **
µOut


390 
sqlôe4VdbeDecodîDe°roy
(
RowDecodî
 *
pDecodî
);

391 
sqlôe4VdbeDecodîGëCﬁumn
(

392 
RowDecodî
 *
pDecodî
,

393 
iVÆ
,

394 
Mem
 *
pDeÁu…
,

395 
Mem
 *
pOut


397 
sqlôe4VdbeEncodeD©a
(

398 
sqlôe4
 *
db
,

399 
Mem
 *
aIn
,

400 *
aPîmuã
,

401 
nIn
,

402 
u8
 **
pzOut
,

403 *
≤Out


405 
sqlôe4VdbeEncodeI¡Key
(
u8
 *
aBuf
,
sqlôe4_öt64
 
v
);

406 
sqlôe4VdbeDecodeNumîicKey
(c⁄° 
KVByãAºay
*, 
KVSize
, 
sqlôe4_num
*);

407 
sqlôe4VdbeSh‹tKey
(c⁄° 
u8
 *, , , *);

408 
sqlôe4MemCom∑ª
(
Mem
*, Mem*, c⁄° 
CﬁlSeq
*,*);

409 
sqlôe4VdbeExec
(
Vdbe
*);

410 
sqlôe4VdbeLi°
(
Vdbe
*);

411 
sqlôe4VdbeHÆt
(
Vdbe
*);

412 
sqlôe4VdbeCh™geEncodög
(
Mem
 *, );

413 
sqlôe4VdbeMemTooBig
(
Mem
*);

414 
sqlôe4VdbeMemC›y
(
Mem
*, const Mem*);

415 
sqlôe4VdbeMemShÆlowC›y
(
Mem
*, const Mem*, );

416 
sqlôe4VdbeMemMove
(
Mem
*, Mem*);

417 
sqlôe4VdbeMemNulTîmö©e
(
Mem
*);

418 
sqlôe4VdbeMemSëSå
(
Mem
*, c⁄° *, , 
u8
,

420 
	`sqlôe4VdbeMemSëI¡64
(
Mem
*, 
i64
);

421 #ifde‡
SQLITE4_OMIT_FLOATING_POINT


422 
	#sqlôe4VdbeMemSëDoubÀ
 
sqlôe4VdbeMemSëI¡64


	)

424 
	`sqlôe4VdbeMemSëDoubÀ
(
Mem
*, );

426 
	`sqlôe4VdbeMemSëNuŒ
(
Mem
*);

427 
	`sqlôe4VdbeMemSëNum
(
Mem
 *, 
sqlôe4_num
, );

428 
	`sqlôe4VdbeMemMakeWrôóbÀ
(
Mem
*);

429 
	`sqlôe4VdbeMemSåögify
(
Mem
*, );

430 
i64
 
	`sqlôe4VdbeI¡VÆue
(
Mem
*);

431 
	`sqlôe4VdbeMemI¡egîify
(
Mem
*);

432 
	`sqlôe4VdbeRólVÆue
(
Mem
*);

433 
sqlôe4_num
 
	`sqlôe4VdbeNumVÆue
(
Mem
 *);

434 
	`sqlôe4VdbeI¡egîAfföôy
(
Mem
*);

435 
	`sqlôe4VdbeMemNumîify
(
Mem
*);

436 
	`sqlôe4VdbeMemSëRowSë
(
Mem
 *
pMem
);

438 
	`sqlôe4VdbeMemRñó£
(
Mem
 *
p
);

439 
	`sqlôe4VdbeMemRñó£Exã∫Æ
(
Mem
 *
p
);

440 
	#VdbeMemRñó£
(
X
) \

441 if((
X
)->
Êags
&(
MEM_Agg
|
MEM_Dyn
|
MEM_RowSë
|
MEM_Føme
)) \

442 
	`sqlôe4VdbeMemRñó£Exã∫Æ
(
X
);

	)

443 
	`sqlôe4VdbeMemFöÆize
(
Mem
*, 
FuncDef
*);

444 c⁄° *
	`sqlôe4OpcodeName
();

445 
	`sqlôe4VdbeMemGrow
(
Mem
 *
pMem
, 
n
, 
¥e£rve
);

446 
	`sqlôe4VdbeClo£Sèãmít
(
Vdbe
 *, );

447 
	`sqlôe4VdbeFømeDñëe
(
VdbeFøme
*);

448 
	`sqlôe4VdbeFømeRe°‹e
(
VdbeFøme
 *);

449 
	`sqlôe4VdbeMemSt‹eTy≥
(
Mem
 *
pMem
);

450 
	`sqlôe4VdbeTøns„rEº‹
(
Vdbe
 *
p
);

451 
	`sqlôe4VdbeRﬁlback
(
sqlôe4
 *
db
, 
iLevñ
);

452 
	`sqlôe4VdbeCommô
(
sqlôe4
 *
db
, 
iLevñ
);

454 #ifde‡
SQLITE4_DEBUG


455 
	`sqlôe4VdbeMemAboutToCh™ge
(
Vdbe
*,
Mem
*);

458 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


459 
	`sqlôe4VdbeCheckFk
(
Vdbe
 *, );

461 
	#sqlôe4VdbeCheckFk
(
p
,
i
Ë0

	)

464 
	`sqlôe4VdbeMemTøn¶©e
(
Mem
*, 
u8
);

465 #ifde‡
SQLITE4_DEBUG


466 
	`sqlôe4VdbePrötSql
(
Vdbe
*);

467 
	`sqlôe4VdbeMemPªâyPröt
(
Mem
 *
pMem
, *
zBuf
);

469 
	`sqlôe4VdbeMemH™dÀBom
(
Mem
 *
pMem
);

473 
	`sqlôe4VdbeMemSëZîoBlob
(
Mem
 *
pMem
, 
n
);

474 
	`sqlôe4_böd_zîoblob
(
sqlôe4_°mt
 *
pStmt
, 
i
, 
n
);

475 
u32
 
	`sqlôe4VdbeSîülTy≥Lí
(u32 
£rül_ty≥
);

481 #i‚de‡
SQLITE4_MAX_SCHEMA_RETRY


482 
	#SQLITE4_MAX_SCHEMA_RETRY
 50

	)

	@src/vdbeapi.c

16 
	~"sqlôeI¡.h
"

17 
	~"vdbeI¡.h
"

24 
	$vdbeSa„ty
(
Vdbe
 *
p
){

25 if–
p
->
db
==0 ){

26 
	`sqlôe4_log
(0,
SQLITE4_MISUSE
,"API called with finalizedÖrepared statement");

31 
	}
}

32 
	$vdbeSa„tyNŸNuŒ
(
Vdbe
 *
p
){

33 if–
p
==0 ){

34 
	`sqlôe4_log
(0,
SQLITE4_MISUSE
, "API called with NULLÖrepared statement");

37  
	`vdbeSa„ty
(
p
);

39 
	}
}

50 
	$sqlôe4_föÆize
(
sqlôe4_°mt
 *
pStmt
){

51 
rc
;

52 if–
pStmt
==0 ){

55 
rc
 = 
SQLITE4_OK
;

57 
Vdbe
 *
v
 = (Vdbe*)
pStmt
;

58 
sqlôe4
 *
db
 = 
v
->db;

59 #i‡
SQLITE4_THREADSAFE


60 
sqlôe4_muãx
 *
muãx
;

62 if–
	`vdbeSa„ty
(
v
ËË 
SQLITE4_MISUSE_BKPT
;

63 #i‡
SQLITE4_THREADSAFE


64 
muãx
 = 
v
->
db
->mutex;

66 
	`sqlôe4_muãx_íãr
(
muãx
);

67 
rc
 = 
	`sqlôe4VdbeFöÆize
(
v
);

68 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

69 
	`sqlôe4_muãx_Àave
(
muãx
);

71  
rc
;

72 
	}
}

82 
	$sqlôe4_ª£t
(
sqlôe4_°mt
 *
pStmt
){

83 
rc
;

84 if–
pStmt
==0 ){

85 
rc
 = 
SQLITE4_OK
;

87 
Vdbe
 *
v
 = (Vdbe*)
pStmt
;

88 
	`sqlôe4_muãx_íãr
(
v
->
db
->
muãx
);

89 
rc
 = 
	`sqlôe4VdbeRe£t
(
v
);

90 
	`sqlôe4VdbeRewöd
(
v
);

91 
rc
 = 
	`sqlôe4ApiExô
(
v
->
db
,Ñc);

92 
	`sqlôe4_muãx_Àave
(
v
->
db
->
muãx
);

94  
rc
;

95 
	}
}

100 
	$sqlôe4_˛ór_bödögs
(
sqlôe4_°mt
 *
pStmt
){

101 
i
;

102 
rc
 = 
SQLITE4_OK
;

103 
Vdbe
 *
p
 = (Vdbe*)
pStmt
;

104 #i‡
SQLITE4_THREADSAFE


105 
sqlôe4_muãx
 *
muãx
 = ((
Vdbe
*)
pStmt
)->
db
->mutex;

107 
	`sqlôe4_muãx_íãr
(
muãx
);

108 
i
=0; i<
p
->
nV¨
; i++){

109 
	`sqlôe4VdbeMemRñó£
(&
p
->
aV¨
[
i
]);

110 
p
->
aV¨
[
i
].
Êags
 = 
MEM_NuŒ
;

112 if–
p
->
expmask
 ){

113 
p
->
expúed
 = 1;

115 
	`sqlôe4_muãx_Àave
(
muãx
);

116  
rc
;

117 
	}
}

124 c⁄° *
	$sqlôe4_vÆue_blob
(
sqlôe4_vÆue
 *
pVÆ
, *
≤Byã
){

125 
Mem
 *
p
 = (Mem*)
pVÆ
;

126 if–
p
->
Êags
 & (
MEM_Blob
|
MEM_Så
) ){

127 
p
->
Êags
 &~
MEM_Så
;

128 
p
->
Êags
 |
MEM_Blob
;

129 if–
≤Byã
 ) *≤Byã = 
p
->
n
;

130  
p
->
n
 ?Ö->
z
 : 0;

132  
	`sqlôe4_vÆue_ãxt
(
pVÆ
, 
≤Byã
);

134 
	}
}

135 
	$sqlôe4_vÆue_byãs
(
sqlôe4_vÆue
 *
pVÆ
){

136  
	`sqlôe4VÆueByãs
(
pVÆ
, 
SQLITE4_UTF8
);

137 
	}
}

138 
	$sqlôe4_vÆue_byãs16
(
sqlôe4_vÆue
 *
pVÆ
){

139  
	`sqlôe4VÆueByãs
(
pVÆ
, 
SQLITE4_UTF16NATIVE
);

140 
	}
}

141 
	$sqlôe4_vÆue_doubÀ
(
sqlôe4_vÆue
 *
pVÆ
){

142  
	`sqlôe4VdbeRólVÆue
((
Mem
*)
pVÆ
);

143 
	}
}

144 
	$sqlôe4_vÆue_öt
(
sqlôe4_vÆue
 *
pVÆ
){

145  ()
	`sqlôe4VdbeI¡VÆue
((
Mem
*)
pVÆ
);

146 
	}
}

147 
sqlôe4_öt64
 
	$sqlôe4_vÆue_öt64
(
sqlôe4_vÆue
 *
pVÆ
){

148  
	`sqlôe4VdbeI¡VÆue
((
Mem
*)
pVÆ
);

149 
	}
}

150 c⁄° *
	$sqlôe4_vÆue_ãxt
(
sqlôe4_vÆue
 *
pVÆ
, *
≤Byã
){

151 c⁄° *
zRë
 = (c⁄° *)
	`sqlôe4VÆueText
(
pVÆ
, 
SQLITE4_UTF8
);

152 if–
≤Byã
 ) *≤Byã = (
zRë
 ? ((
Mem
 *)
pVÆ
)->
n
 : 0);

153  
zRë
;

154 
	}
}

155 #i‚de‡
SQLITE4_OMIT_UTF16


156 c⁄° *
	$sqlôe4_vÆue_ãxt16
(
sqlôe4_vÆue
* 
pVÆ
, *
≤Byã
){

157 c⁄° *
pRë
 = 
	`sqlôe4VÆueText
(
pVÆ
, 
SQLITE4_UTF16NATIVE
);

158 if–
≤Byã
 ) *≤Byã = (
pRë
 ? ((
Mem
 *)
pVÆ
)->
n
 : 0);

159  
pRë
;

160 
	}
}

161 c⁄° *
	$sqlôe4_vÆue_ãxt16be
(
sqlôe4_vÆue
 *
pVÆ
, *
≤Byã
){

162 c⁄° *
pRë
 = 
	`sqlôe4VÆueText
(
pVÆ
, 
SQLITE4_UTF16BE
);

163 if–
≤Byã
 ) *≤Byã = (
pRë
 ? ((
Mem
 *)
pVÆ
)->
n
 : 0);

164  
pRë
;

165 
	}
}

166 c⁄° *
	$sqlôe4_vÆue_ãxt16À
(
sqlôe4_vÆue
 *
pVÆ
, *
≤Byã
){

167 c⁄° *
pRë
 = 
	`sqlôe4VÆueText
(
pVÆ
, 
SQLITE4_UTF16LE
);

168 if–
≤Byã
 ) *≤Byã = (
pRë
 ? ((
Mem
 *)
pVÆ
)->
n
 : 0);

169  
pRë
;

170 
	}
}

172 
	$sqlôe4_vÆue_ty≥
(
sqlôe4_vÆue
* 
pVÆ
){

173  
pVÆ
->
ty≥
;

174 
	}
}

178 
sqlôe4_vÆue
 *
	$sqlôe4_vÆue_dup
(
sqlôe4_ív
 *
pEnv
, c⁄° 
sqlôe4_vÆue
 *
pOrig
){

179 
sqlôe4_vÆue
 *
pNew
;

180 if–
pOrig
==0 )  0;

181 
pNew
 = 
	`sqlôe4_mÆloc
(
pEnv
, (*pNew) );

182 if–
pNew
==0 )  0;

183 
	`mem£t
(
pNew
, 0, (*pNew));

184 
	`mem˝y
(
pNew
, 
pOrig
, 
MEMCELLSIZE
);

185 
pNew
->
Êags
 &~
MEM_Dyn
;

186 
pNew
->
db
 = 0;

187 if–
pNew
->
Êags
&(
MEM_Så
|
MEM_Blob
) ){

188 
pNew
->
Êags
 &~(
MEM_Sètic
|
MEM_Dyn
);

189 
pNew
->
Êags
 |
MEM_Ephem
;

190 if–
	`sqlôe4VdbeMemMakeWrôóbÀ
(
pNew
)!=
SQLITE4_OK
 ){

191 
	`sqlôe4VÆueFªe
(
pNew
);

192 
pNew
 = 0;

194 }if–
pNew
->
Êags
 & 
MEM_NuŒ
 ){

196 
pNew
->
Êags
 &~(
MEM_Tîm
);

198  
pNew
;

199 
	}
}

204 
	$sqlôe4_vÆue_‰ì
(
sqlôe4_vÆue
 *
pOld
){

205 
	`sqlôe4VÆueFªe
(
pOld
);

206 
	}
}

216 
£tResu…SåOrEº‹
(

217 
sqlôe4_c⁄ãxt
 *
pCtx
,

218 c⁄° *
z
,

219 
n
,

220 
u8
 
íc
,

221 (*
xDñ
)(*,*),

222 *
pDñArg


224 if–
xDñ
==
SQLITE4_DYNAMIC
 ){

225 
	`as£π
–
	`sqlôe4MemdebugHasTy≥
(
z
, 
MEMTYPE_HEAP
) );

226 
	`as£π
–
	`sqlôe4MemdebugNoTy≥
(
z
, ~
MEMTYPE_HEAP
) );

227 
	`sqlôe4MemdebugSëTy≥
((*)
z
, 
MEMTYPE_DB
 | 
MEMTYPE_HEAP
);

229 if–
	`sqlôe4VdbeMemSëSå
(&
pCtx
->
s
, 
z
, 
n
, 
íc
, 
xDñ
,
pDñArg
)==
SQLITE4_TOOBIG
 ){

230 
	`sqlôe4_ªsu…_îr‹_toobig
(
pCtx
);

232 
	}
}

233 
sqlôe4_ªsu…_blob
(

234 
sqlôe4_c⁄ãxt
 *
pCtx
,

235 c⁄° *
z
,

236 
n
,

237 (*
xDñ
)(*,*),

238 *
pDñArg


240 
	`as£π
–
n
>=0 );

241 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

242 
	`£tResu…SåOrEº‹
(
pCtx
, 
z
, 
n
, 0, 
xDñ
, 
pDñArg
);

243 
	}
}

244 
	$sqlôe4_ªsu…_doubÀ
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
rVÆ
){

245 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

246 
	`sqlôe4VdbeMemSëDoubÀ
(&
pCtx
->
s
, 
rVÆ
);

247 
	}
}

248 
	$sqlôe4_ªsu…_îr‹
(
sqlôe4_c⁄ãxt
 *
pCtx
, c⁄° *
z
, 
n
){

249 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

250 
pCtx
->
isEº‹
 = 
SQLITE4_ERROR
;

251 
	`sqlôe4VdbeMemSëSå
(&
pCtx
->
s
, 
z
, 
n
, 
SQLITE4_UTF8
, 
SQLITE4_TRANSIENT
, 0);

252 
	}
}

253 #i‚de‡
SQLITE4_OMIT_UTF16


254 
	$sqlôe4_ªsu…_îr‹16
(
sqlôe4_c⁄ãxt
 *
pCtx
, c⁄° *
z
, 
n
){

255 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

256 
pCtx
->
isEº‹
 = 
SQLITE4_ERROR
;

257 
	`sqlôe4VdbeMemSëSå
(&
pCtx
->
s
, 
z
, 
n
, 
SQLITE4_UTF16NATIVE
,
SQLITE4_TRANSIENT
,0);

258 
	}
}

260 
	$sqlôe4_ªsu…_öt
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
iVÆ
){

261 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

262 
	`sqlôe4VdbeMemSëI¡64
(&
pCtx
->
s
, (
i64
)
iVÆ
);

263 
	}
}

264 
	$sqlôe4_ªsu…_öt64
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
i64
 
iVÆ
){

265 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

266 
	`sqlôe4VdbeMemSëI¡64
(&
pCtx
->
s
, 
iVÆ
);

267 
	}
}

268 
	$sqlôe4_ªsu…_num
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
sqlôe4_num
 
vÆ
){

269 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

270 
	`sqlôe4VdbeMemSëNum
(&
pCtx
->
s
, 
vÆ
, 
MEM_Ról
);

271 
	}
}

272 
	$sqlôe4_ªsu…_nuŒ
(
sqlôe4_c⁄ãxt
 *
pCtx
){

273 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

274 
	`sqlôe4VdbeMemSëNuŒ
(&
pCtx
->
s
);

275 
	}
}

276 
sqlôe4_ªsu…_ãxt
(

277 
sqlôe4_c⁄ãxt
 *
pCtx
,

278 c⁄° *
z
,

279 
n
,

280 (*
xDñ
)(*,*),

281 *
pDñArg


283 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

284 
	`£tResu…SåOrEº‹
(
pCtx
, 
z
, 
n
, 
SQLITE4_UTF8
, 
xDñ
, 
pDñArg
);

285 
	}
}

288 
	$sqlôe4_ªsu…_zîoblob64
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
u64
 
n
){

289 
Mem
 *
pOut
;

291 #ifde‡
SQLITE4_ENABLE_API_ARMOR


292 if–
pCtx
==0 )  
SQLITE4_MISUSE_BKPT
;

294 
pOut
 = &
pCtx
->
s
;

295 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pOut
->
db
->
muãx
) );

296 if–
n
>(
u64
)
pOut
->
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
] ){

297 
	`sqlôe4_ªsu…_îr‹_toobig
(
pCtx
);

298  
SQLITE4_TOOBIG
;

300 #i‚de‡
SQLITE4_OMIT_INCRBLOB


301 
	`sqlôe4VdbeMemSëZîoBlob
(
pOut
, ()
n
);

302  
SQLITE4_OK
;

304  
	`sqlôe4VdbeMemSëZîoBlob
(&
pCtx
->
s
, ()
n
);

306 
	}
}

308 
	$sqlôe4_ªsu…_vÆue
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
sqlôe4_vÆue
 *
pVÆue
){

309 
Mem
 *
pOut
;

311 #ifde‡
SQLITE4_ENABLE_API_ARMOR


312 if–
pCtx
==0 ) ;

313 if–
pVÆue
==0 ){

314 
	`sqlôe4_ªsu…_nuŒ
(
pCtx
);

318 
pOut
 = &
pCtx
->
s
;

319 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

320 
	`sqlôe4VdbeMemC›y
(
pOut
, 
pVÆue
);

321 
	`sqlôe4VdbeCh™geEncodög
(
pOut
, 
pCtx
->
s
.
íc
);

322 if–
	`sqlôe4VdbeMemTooBig
(
pOut
) ){

323 
	`sqlôe4_ªsu…_îr‹_toobig
(
pCtx
);

325 
	}
}

327 
	$sqlôe4_ªsu…_zîoblob
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
n
){

328 
	`sqlôe4_ªsu…_zîoblob64
(
pCtx
, 
n
>0 ?Ç : 0);

329 
	}
}

331 
	$sqlôe4_ªsu…_îr‹_code
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
îrCode
){

332 #ifde‡
SQLITE4_ENABLE_API_ARMOR


333 if–
pCtx
==0 ) ;

335 
pCtx
->
isEº‹
 = 
îrCode
 ?ÉrrCode : -1;

336 #ifde‡
SQLITE4_DEBUG


337 if–
pCtx
->
pVdbe
 )ÖCtx->pVdbe->
rcAµ
 = 
îrCode
;

339 if–
pCtx
->
s
.
Êags
 & 
MEM_NuŒ
 ){

340 
	`£tResu…SåOrEº‹
(
pCtx
, 
	`sqlôe4EºSå
(
îrCode
), -1, 
SQLITE4_UTF8
,

341 
SQLITE4_STATIC
, 0);

343 
	}
}

345 #i‚de‡
SQLITE4_OMIT_UTF16


346 
sqlôe4_ªsu…_ãxt16
(

347 
sqlôe4_c⁄ãxt
 *
pCtx
,

348 c⁄° *
z
,

349 
n
,

350 (*
xDñ
)(*,*),

351 *
pDñArg


353 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

354 
	`£tResu…SåOrEº‹
(
pCtx
, 
z
, 
n
, 
SQLITE4_UTF16NATIVE
, 
xDñ
, 
pDñArg
);

355 
	}
}

356 
sqlôe4_ªsu…_ãxt16be
(

357 
sqlôe4_c⁄ãxt
 *
pCtx
,

358 c⁄° *
z
,

359 
n
,

360 (*
xDñ
)(*,*),

361 *
pDñArg


363 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

364 
	`£tResu…SåOrEº‹
(
pCtx
, 
z
, 
n
, 
SQLITE4_UTF16BE
, 
xDñ
, 
pDñArg
);

365 
	}
}

366 
sqlôe4_ªsu…_ãxt16À
(

367 
sqlôe4_c⁄ãxt
 *
pCtx
,

368 c⁄° *
z
,

369 
n
,

370 (*
xDñ
)(*,*),

371 *
pDñArg


373 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

374 
	`£tResu…SåOrEº‹
(
pCtx
, 
z
, 
n
, 
SQLITE4_UTF16LE
, 
xDñ
, 
pDñArg
);

375 
	}
}

379 
	$sqlôe4_ªsu…_îr‹_toobig
(
sqlôe4_c⁄ãxt
 *
pCtx
){

380 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

381 
pCtx
->
isEº‹
 = 
SQLITE4_TOOBIG
;

382 
	`sqlôe4VdbeMemSëSå
(&
pCtx
->
s
, "string or blobÅoo big", -1,

383 
SQLITE4_UTF8
, 
SQLITE4_STATIC
, 0);

384 
	}
}

387 
	$sqlôe4_ªsu…_îr‹_nomem
(
sqlôe4_c⁄ãxt
 *
pCtx
){

388 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

389 
	`sqlôe4VdbeMemSëNuŒ
(&
pCtx
->
s
);

390 
pCtx
->
isEº‹
 = 
SQLITE4_NOMEM
;

391 
pCtx
->
s
.
db
->
mÆlocFaûed
 = 1;

392 
	}
}

403 
	$sqlôe4Sãp
(
Vdbe
 *
p
){

404 
sqlôe4
 *
db
;

405 
rc
;

407 
	`as£π
(
p
);

408 if–
p
->
magic
!=
VDBE_MAGIC_RUN
 ){

425 #ifde‡
SQLITE4_OMIT_AUTORESET


426 if–
p
->
rc
==
SQLITE4_BUSY
 ||Ö->rc==
SQLITE4_LOCKED
 ){

427 
	`sqlôe4_ª£t
((
sqlôe4_°mt
*)
p
);

429  
SQLITE4_MISUSE_BKPT
;

432 
	`sqlôe4_ª£t
((
sqlôe4_°mt
*)
p
);

437 
db
 = 
p
->db;

438 if–
db
->
mÆlocFaûed
 ){

439 
p
->
rc
 = 
SQLITE4_NOMEM
;

440  
SQLITE4_NOMEM
;

443 if–
p
->
pc
<=0 &&Ö->
expúed
 ){

444 
p
->
rc
 = 
SQLITE4_SCHEMA
;

445 
rc
 = 
SQLITE4_ERROR
;

446 
íd_of_°ï
;

448 if–
p
->
pc
<0 ){

453 if–
db
->
a˘iveVdbeC¡
==0 ){

454 
db
->
u1
.
isI¡îru±ed
 = 0;

457 
	`as£π
–
db
->
wrôeVdbeC¡
>0 || db->
pSavïoöt
 || db->
nDe„ºedC⁄s
==0 );

459 #i‚de‡
SQLITE4_OMIT_TRACE


460 if–
db
->
xProfûe
 && !db->
öô
.
busy
 ){

461 
	`sqlôe4OsCuºítTime
(0, &
p
->
°¨tTime
);

465 
db
->
a˘iveVdbeC¡
++;

466 if–
p
->
ªadO∆y
==0 ) 
db
->
wrôeVdbeC¡
++;

467 
p
->
pc
 = 0;

469 #i‚de‡
SQLITE4_OMIT_EXPLAIN


470 if–
p
->
ex∂aö
 ){

471 
rc
 = 
	`sqlôe4VdbeLi°
(
p
);

475 
db
->
vdbeExecC¡
++;

476 
rc
 = 
	`sqlôe4VdbeExec
(
p
);

477 
db
->
vdbeExecC¡
--;

480 #i‚de‡
SQLITE4_OMIT_TRACE


483 if–
rc
!=
SQLITE4_ROW
 && 
db
->
xProfûe
 && !db->
öô
.
busy
 && 
p
->
zSql
 ){

484 
sqlôe4_uöt64
 
iNow
 = 0;

485 
	`sqlôe4OsCuºítTime
(0, &
iNow
);

486 
db
->
	`xProfûe
(db->
pProfûeArg
, 
p
->
zSql
, (
iNow
 -Ö->
°¨tTime
)*1000000);

490 
db
->
îrCode
 = 
rc
;

491 if–
SQLITE4_NOMEM
==
	`sqlôe4ApiExô
(
p
->
db
,Ö->
rc
) ){

492 
p
->
rc
 = 
SQLITE4_NOMEM
;

494 
íd_of_°ï
:

502 
	`as£π
–
rc
==
SQLITE4_ROW
 ||Ñc==
SQLITE4_DONE
 ||Ñc==
SQLITE4_ERROR


503 || 
rc
==
SQLITE4_BUSY
 ||Ñc==
SQLITE4_MISUSE


505 
	`as£π
–
p
->
rc
!=
SQLITE4_ROW
 &&Ö->rc!=
SQLITE4_DONE
 );

506 if–
rc
!=
SQLITE4_ROW
 &&Ñc!=
SQLITE4_DONE
 ){

507 
rc
 = 
	`sqlôe4VdbeTøns„rEº‹
(
p
);

509  
rc
;

510 
	}
}

516 #i‚de‡
SQLITE4_MAX_SCHEMA_RETRY


517 
	#SQLITE4_MAX_SCHEMA_RETRY
 5

	)

525 
	$sqlôe4_°ï
(
sqlôe4_°mt
 *
pStmt
){

526 
rc
 = 
SQLITE4_OK
;

527 
rc2
 = 
SQLITE4_OK
;

528 
Vdbe
 *
v
 = (Vdbe*)
pStmt
;

529 
˙t
 = 0;

530 
sqlôe4
 *
db
;

532 if–
	`vdbeSa„tyNŸNuŒ
(
v
) ){

533  
SQLITE4_MISUSE_BKPT
;

535 
db
 = 
v
->db;

536 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

537  (
rc
 = 
	`sqlôe4Sãp
(
v
))==
SQLITE4_SCHEMA


538 && 
˙t
++ < 
SQLITE4_MAX_SCHEMA_RETRY


539 && (
rc2
 = 
rc
 = 
	`sqlôe4Rïª∑ª
(
v
))==
SQLITE4_OK
 ){

540 
	`sqlôe4_ª£t
(
pStmt
);

541 
	`as£π
–
v
->
expúed
==0 );

543 if–
rc2
!=
SQLITE4_OK
 && 
	`ALWAYS
(
db
->
pEº
) ){

552 c⁄° *
zEº
 = 
	`sqlôe4_vÆue_ãxt
(
db
->
pEº
, 0);

553 
	`sqlôe4DbFªe
(
db
, 
v
->
zEºMsg
);

554 if–!
db
->
mÆlocFaûed
 ){

555 
v
->
zEºMsg
 = 
	`sqlôe4DbSåDup
(
db
, 
zEº
);

556 
v
->
rc
 = 
rc2
;

558 
v
->
zEºMsg
 = 0;

559 
v
->
rc
 =Ñ¯
SQLITE4_NOMEM
;

562 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

563 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

564  
rc
;

565 
	}
}

571 *
	$sqlôe4_c⁄ãxt_≠pd©a
(
sqlôe4_c⁄ãxt
 *
p
){

572 
	`as£π
–
p
 &&Ö->
pFunc
 );

573  
p
->
pFunc
->
pU£rD©a
;

574 
	}
}

585 
sqlôe4
 *
	$sqlôe4_c⁄ãxt_db_h™dÀ
(
sqlôe4_c⁄ãxt
 *
p
){

586 
	`as£π
–
p
 &&Ö->
pFunc
 );

587  
p
->
s
.
db
;

588 
	}
}

593 
sqlôe4_ív
 *
	$sqlôe4_c⁄ãxt_ív
(
sqlôe4_c⁄ãxt
 *
p
){

594 
	`as£π
–
p
 &&Ö->
pFunc
 );

595  
p
->
s
.
db
->
pEnv
;

596 
	}
}

606 
	$sqlôe4InvÆidFun˘i⁄
(

607 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

608 
NŸU£d
,

609 
sqlôe4_vÆue
 **
NŸU£d2


611 c⁄° *
zName
 = 
c⁄ãxt
->
pFunc
->zName;

612 *
zEº
;

613 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
);

614 
	`UNUSED_PARAMETER2
(
NŸU£d
, 
NŸU£d2
);

615 
zEº
 = 
	`sqlôe4_m¥ötf
(
pEnv
,

616 "u«bÀÅÿu£ fun˘i⁄ %†öÅhêªque°ed c⁄ãxt", 
zName
);

617 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
zEº
, -1);

618 
	`sqlôe4_‰ì
(
pEnv
, 
zEº
);

619 
	}
}

626 *
	$sqlôe4_aggªg©e_c⁄ãxt
(
sqlôe4_c⁄ãxt
 *
p
, 
nByã
){

627 
Mem
 *
pMem
;

628 
	`as£π
–
p
 &&Ö->
pFunc
 &&Ö->pFunc->
xSãp
 );

629 
	`as£π
–
	`sqlôe4_muãx_hñd
(
p
->
s
.
db
->
muãx
) );

630 
pMem
 = 
p
->pMem;

631 
	`ã°ˇ£
–
nByã
<0 );

632 if–(
pMem
->
Êags
 & 
MEM_Agg
)==0 ){

633 if–
nByã
<=0 ){

634 
	`sqlôe4VdbeMemRñó£Exã∫Æ
(
pMem
);

635 
pMem
->
Êags
 = 
MEM_NuŒ
;

636 
pMem
->
z
 = 0;

638 
	`sqlôe4VdbeMemGrow
(
pMem
, 
nByã
, 0);

639 
pMem
->
Êags
 = 
MEM_Agg
;

640 
pMem
->
u
.
pDef
 = 
p
->
pFunc
;

641 if–
pMem
->
z
 ){

642 
	`mem£t
(
pMem
->
z
, 0, 
nByã
);

646  (*)
pMem
->
z
;

647 
	}
}

653 *
	$sqlôe4_auxd©a_„tch
(
sqlôe4_c⁄ãxt
 *
pCtx
, 
iArg
){

654 
VdbeFunc
 *
pVdbeFunc
;

656 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

657 
pVdbeFunc
 = 
pCtx
->pVdbeFunc;

658 if–!
pVdbeFunc
 || 
iArg
>ıVdbeFunc->
nAux
 || iArg<0 ){

661  
pVdbeFunc
->
≠Aux
[
iArg
].
pAux
;

662 
	}
}

669 
sqlôe4_auxd©a_°‹e
(

670 
sqlôe4_c⁄ãxt
 *
pCtx
,

671 
iArg
,

672 *
pAux
,

673 (*
xDñëe
)(*,*),

674 *
pDñëeArg


676 
AuxD©a
 *
pAuxD©a
;

677 
VdbeFunc
 *
pVdbeFunc
;

678 if–
iArg
<0 ) 
Áûed
;

680 
	`as£π
–
	`sqlôe4_muãx_hñd
(
pCtx
->
s
.
db
->
muãx
) );

681 
pVdbeFunc
 = 
pCtx
->pVdbeFunc;

682 if–!
pVdbeFunc
 ||ÖVdbeFunc->
nAux
<=
iArg
 ){

683 
nAux
 = (
pVdbeFunc
 ?ÖVdbeFunc->nAux : 0);

684 
nMÆloc
 = (
VdbeFunc
Ë+ (
AuxD©a
)*
iArg
;

685 
pVdbeFunc
 = 
	`sqlôe4DbRóŒoc
(
pCtx
->
s
.
db
,ÖVdbeFunc, 
nMÆloc
);

686 if–!
pVdbeFunc
 ){

687 
Áûed
;

689 
pCtx
->
pVdbeFunc
 =ÖVdbeFunc;

690 
	`mem£t
(&
pVdbeFunc
->
≠Aux
[
nAux
], 0, (
AuxD©a
)*(
iArg
+1-nAux));

691 
pVdbeFunc
->
nAux
 = 
iArg
+1;

692 
pVdbeFunc
->
pFunc
 = 
pCtx
->pFunc;

695 
pAuxD©a
 = &
pVdbeFunc
->
≠Aux
[
iArg
];

696 if–
pAuxD©a
->
pAux
 &&ÖAuxD©a->
xDñëe
 ){

697 
pAuxD©a
->
	`xDñëe
’AuxD©a->
pDñëeArg
,ÖAuxD©a->
pAux
);

699 
pAuxD©a
->
pAux
 =ÖAux;

700 
pAuxD©a
->
xDñëe
 = xDelete;

701 
pAuxD©a
->
pDñëeArg
 =ÖDeleteArg;

704 
Áûed
:

705 if–
xDñëe
 ){

706 
	`xDñëe
(
pDñëeArg
, 
pAux
);

708 
	}
}

713 
	$sqlôe4_cﬁumn_cou¡
(
sqlôe4_°mt
 *
pStmt
){

714 
Vdbe
 *
pVm
 = (Vdbê*)
pStmt
;

715  
pVm
 ?ÖVm->
nResCﬁumn
 : 0;

716 
	}
}

722 
	$sqlôe4_d©a_cou¡
(
sqlôe4_°mt
 *
pStmt
){

723 
Vdbe
 *
pVm
 = (Vdbê*)
pStmt
;

724 if–
pVm
==0 ||ÖVm->
pResu…Së
==0 )  0;

725  
pVm
->
nResCﬁumn
;

726 
	}
}

735 
Mem
 *
	$cﬁumnMem
(
sqlôe4_°mt
 *
pStmt
, 
i
){

736 
Vdbe
 *
pVm
;

737 
Mem
 *
pOut
;

739 
pVm
 = (
Vdbe
 *)
pStmt
;

740 if–
pVm
 &&ÖVm->
pResu…Së
!=0 && 
i
<pVm->
nResCﬁumn
 && i>=0 ){

741 
	`sqlôe4_muãx_íãr
(
pVm
->
db
->
muãx
);

742 
pOut
 = &
pVm
->
pResu…Së
[
i
];

755 c⁄° 
Mem
 
nuŒMem


756 #i‡
	`deföed
(
SQLITE4_DEBUG
Ë&& deföed(
__GNUC__
)

757 
	`__©åibuã__
((
	`Æig√d
(8)))

759 {0, "", {{0,0,0,0}}, 0, 
MEM_NuŒ
, 
SQLITE4_NULL
, 0,

760 #ifde‡
SQLITE4_DEBUG


765 if–
pVm
 && 
	`ALWAYS
’Vm->
db
) ){

766 
	`sqlôe4_muãx_íãr
(
pVm
->
db
->
muãx
);

767 
	`sqlôe4Eº‹
(
pVm
->
db
, 
SQLITE4_RANGE
, 0);

769 
pOut
 = (
Mem
*)&
nuŒMem
;

771  
pOut
;

772 
	}
}

782 
sqlôe4_vÆue
 *
	$sqlôe4CﬁumnVÆue
(
sqlôe4_°mt
 *
pStmt
, 
iCﬁ
){

783 
Vdbe
 *
p
 = (Vdbe*)
pStmt
;

784 
	`as£π
–
	`sqlôe4_muãx_hñd
(
p
->
db
->
muãx
) );

785 
	`as£π
–
iCﬁ
<
p
->
nResCﬁumn
 && iCol>=0 );

786  (
sqlôe4_vÆue
 *)&
p
->
pResu…Së
[
iCﬁ
];

787 
	}
}

807 
	$cﬁumnMÆlocFaûuª
(
sqlôe4_°mt
 *
pStmt
)

814 
Vdbe
 *
p
 = (Vdbê*)
pStmt
;

815 if–
p
 ){

816 
p
->
rc
 = 
	`sqlôe4ApiExô
’->
db
,Ö->rc);

817 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

819 
	}
}

825 c⁄° *
	$sqlôe4_cﬁumn_blob
(
sqlôe4_°mt
 *
pStmt
, 
i
, *
≤Byã
){

826 c⁄° *
vÆ
;

827 
vÆ
 = 
	`sqlôe4_vÆue_blob
–
	`cﬁumnMem
(
pStmt
,
i
), 
≤Byã
 );

828 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

829  
vÆ
;

830 
	}
}

831 
	$sqlôe4_cﬁumn_doubÀ
(
sqlôe4_°mt
 *
pStmt
, 
i
){

832 
vÆ
 = 
	`sqlôe4_vÆue_doubÀ
–
	`cﬁumnMem
(
pStmt
,
i
) );

833 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

834  
vÆ
;

835 
	}
}

836 
	$sqlôe4_cﬁumn_öt
(
sqlôe4_°mt
 *
pStmt
, 
i
){

837 
vÆ
 = 
	`sqlôe4_vÆue_öt
–
	`cﬁumnMem
(
pStmt
,
i
) );

838 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

839  
vÆ
;

840 
	}
}

841 
sqlôe4_öt64
 
	$sqlôe4_cﬁumn_öt64
(
sqlôe4_°mt
 *
pStmt
, 
i
){

842 
sqlôe4_öt64
 
vÆ
 = 
	`sqlôe4_vÆue_öt64
–
	`cﬁumnMem
(
pStmt
,
i
) );

843 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

844  
vÆ
;

845 
	}
}

846 c⁄° *
	$sqlôe4_cﬁumn_ãxt
(
sqlôe4_°mt
 *
pStmt
, 
i
, *
≤Byã
){

847 c⁄° *
vÆ
 = 
	`sqlôe4_vÆue_ãxt
–
	`cﬁumnMem
(
pStmt
,
i
), 
≤Byã
 );

848 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

849  
vÆ
;

850 
	}
}

851 
sqlôe4_vÆue
 *
	$sqlôe4_cﬁumn_vÆue
(
sqlôe4_°mt
 *
pStmt
, 
i
){

852 
Mem
 *
pOut
 = 
	`cﬁumnMem
(
pStmt
, 
i
);

853 if–
pOut
->
Êags
&
MEM_Sètic
 ){

854 
pOut
->
Êags
 &~
MEM_Sètic
;

855 
pOut
->
Êags
 |
MEM_Ephem
;

857 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

858  (
sqlôe4_vÆue
 *)
pOut
;

859 
	}
}

860 #i‚de‡
SQLITE4_OMIT_UTF16


861 c⁄° *
	$sqlôe4_cﬁumn_ãxt16
(
sqlôe4_°mt
 *
pStmt
, 
i
, *
≤Byã
){

862 c⁄° *
vÆ
 = 
	`sqlôe4_vÆue_ãxt16
–
	`cﬁumnMem
(
pStmt
,
i
), 
≤Byã
 );

863 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

864  
vÆ
;

865 
	}
}

867 
	$sqlôe4_cﬁumn_ty≥
(
sqlôe4_°mt
 *
pStmt
, 
i
){

868 
iTy≥
 = 
	`sqlôe4_vÆue_ty≥
–
	`cﬁumnMem
(
pStmt
,
i
) );

869 
	`cﬁumnMÆlocFaûuª
(
pStmt
);

870  
iTy≥
;

871 
	}
}

896 c⁄° *
cﬁumnName
(

897 
sqlôe4_°mt
 *
pStmt
,

898 
N
,

899 c⁄° *(*
xFunc
)(
Mem
*, *),

900 
u£Ty≥


902 c⁄° *
	gªt
 = 0;

903 
Vdbe
 *
	gp
 = (Vdbê*)
pStmt
;

904 
	gn
;

905 
sqlôe4
 *
	gdb
 = 
p
->
db
;

907 
as£π
–
db
!=0 );

908 
	gn
 = 
sqlôe4_cﬁumn_cou¡
(
pStmt
);

909 if–
	gN
<
	gn
 && N>=0 ){

910 
N
 +
u£Ty≥
*
n
;

911 
sqlôe4_muãx_íãr
(
db
->
muãx
);

912 
as£π
–
db
->
mÆlocFaûed
==0 );

913 
	gªt
 = 
xFunc
(&
p
->
aCﬁName
[
N
], 0);

917 if–
	gdb
->
	gmÆlocFaûed
 ){

918 
	gdb
->
	gmÆlocFaûed
 = 0;

919 
	gªt
 = 0;

921 
sqlôe4_muãx_Àave
(
db
->
muãx
);

923  
	gªt
;

930 c⁄° *
	$sqlôe4_cﬁumn_«me
(
sqlôe4_°mt
 *
pStmt
, 
N
){

931  
	`cﬁumnName
(

932 
pStmt
, 
N
, (c⁄° *(*)(
Mem
*, *))
sqlôe4_vÆue_ãxt
, 
COLNAME_NAME
);

933 
	}
}

939 #i‡
deföed
(
SQLITE4_OMIT_DECLTYPE
Ë&& deföed(
SQLITE4_ENABLE_COLUMN_METADATA
)

944 #i‚de‡
SQLITE4_OMIT_DECLTYPE


949 c⁄° *
	$sqlôe4_cﬁumn_de˛ty≥
(
sqlôe4_°mt
 *
pStmt
, 
N
){

950  
	`cﬁumnName
(
pStmt
,

951 
N
, (c⁄° *(*)(
Mem
*, *))
sqlôe4_vÆue_ãxt
, 
COLNAME_DECLTYPE
);

952 
	}
}

955 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


961 c⁄° *
	$sqlôe4_cﬁumn_d©aba£_«me
(
sqlôe4_°mt
 *
pStmt
, 
N
){

962  
	`cﬁumnName
(
pStmt
,

963 
N
, (c⁄° *(*)(
Mem
*, *))
sqlôe4_vÆue_ãxt
, 
COLNAME_DATABASE
);

964 
	}
}

971 c⁄° *
	$sqlôe4_cﬁumn_èbÀ_«me
(
sqlôe4_°mt
 *
pStmt
, 
N
){

972  
	`cﬁumnName
(
pStmt
,

973 
N
, (c⁄° *(*)(
Mem
*, *))
sqlôe4_vÆue_ãxt
, 
COLNAME_TABLE
);

974 
	}
}

981 c⁄° *
	$sqlôe4_cﬁumn_‹igö_«me
(
sqlôe4_°mt
 *
pStmt
, 
N
){

982  
	`cﬁumnName
(
pStmt
,

983 
N
, (c⁄° *(*)(
Mem
*, *))
sqlôe4_vÆue_ãxt
, 
COLNAME_COLUMN
);

984 
	}
}

1003 
	$vdbeUnböd
(
Vdbe
 *
p
, 
i
){

1004 
Mem
 *
pV¨
;

1005 if–
	`vdbeSa„tyNŸNuŒ
(
p
) ){

1006  
SQLITE4_MISUSE_BKPT
;

1008 
	`sqlôe4_muãx_íãr
(
p
->
db
->
muãx
);

1009 if–
p
->
magic
!=
VDBE_MAGIC_RUN
 ||Ö->
pc
>=0 ){

1010 
	`sqlôe4Eº‹
(
p
->
db
, 
SQLITE4_MISUSE
, 0);

1011 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1012 
	`sqlôe4_log
(
p
->
db
->
pEnv
,
SQLITE4_MISUSE
,

1013 "böd o¿®busyÖª∑ªd sèãmít: [%s]", 
p
->
zSql
);

1014  
SQLITE4_MISUSE_BKPT
;

1016 if–
i
<1 || i>
p
->
nV¨
 ){

1017 
	`sqlôe4Eº‹
(
p
->
db
, 
SQLITE4_RANGE
, 0);

1018 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1019  
SQLITE4_RANGE
;

1021 
i
--;

1022 
pV¨
 = &
p
->
aV¨
[
i
];

1023 
	`sqlôe4VdbeMemRñó£
(
pV¨
);

1024 
pV¨
->
Êags
 = 
MEM_NuŒ
;

1025 
	`sqlôe4Eº‹
(
p
->
db
, 
SQLITE4_OK
, 0);

1036 if–((
i
<32 && 
p
->
expmask
 & ((
u32
)1 << i)) ||Ö->expmask==0xffffffff)

1038 
p
->
expúed
 = 1;

1040  
SQLITE4_OK
;

1041 
	}
}

1046 
bödText
(

1047 
sqlôe4_°mt
 *
pStmt
,

1048 
i
,

1049 c⁄° *
zD©a
,

1050 
nD©a
,

1051 (*
xDñ
)(*,*),

1052 *
pDñArg
,

1053 
u8
 
ícodög


1055 
Vdbe
 *
p
 = (Vdbê*)
pStmt
;

1056 
Mem
 *
pV¨
;

1057 
rc
;

1059 
rc
 = 
	`vdbeUnböd
(
p
, 
i
);

1060 if–
rc
==
SQLITE4_OK
 ){

1061 if–
zD©a
!=0 ){

1062 
pV¨
 = &
p
->
aV¨
[
i
-1];

1063 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pV¨
, 
zD©a
, 
nD©a
, 
ícodög
, 
xDñ
, 
pDñArg
);

1064 if–
rc
==
SQLITE4_OK
 && 
ícodög
!=0 ){

1065 
rc
 = 
	`sqlôe4VdbeCh™geEncodög
(
pV¨
, 
	`ENC
(
p
->
db
));

1067 
	`sqlôe4Eº‹
(
p
->
db
, 
rc
, 0);

1068 
rc
 = 
	`sqlôe4ApiExô
(
p
->
db
,Ñc);

1070 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1071 }if–
xDñ
!=
SQLITE4_STATIC
 && xDñ!=
SQLITE4_TRANSIENT
 ){

1072 
	`xDñ
(
pDñArg
, (*)
zD©a
);

1074  
rc
;

1075 
	}
}

1081 
sqlôe4_böd_blob
(

1082 
sqlôe4_°mt
 *
pStmt
,

1083 
i
,

1084 c⁄° *
zD©a
,

1085 
nD©a
,

1086 (*
xDñ
)(*,*),

1087 *
pDñArg


1089  
	`bödText
(
pStmt
, 
i
, 
zD©a
, 
nD©a
, 
xDñ
, 
pDñArg
, 0);

1090 
	}
}

1091 
	$sqlôe4_böd_doubÀ
(
sqlôe4_°mt
 *
pStmt
, 
i
, 
rVÆue
){

1092 
rc
;

1093 
Vdbe
 *
p
 = (Vdbê*)
pStmt
;

1094 
rc
 = 
	`vdbeUnböd
(
p
, 
i
);

1095 if–
rc
==
SQLITE4_OK
 ){

1096 
	`sqlôe4VdbeMemSëDoubÀ
(&
p
->
aV¨
[
i
-1], 
rVÆue
);

1097 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1099  
rc
;

1100 
	}
}

1101 
	$sqlôe4_böd_öt
(
sqlôe4_°mt
 *
p
, 
i
, 
iVÆue
){

1102  
	`sqlôe4_böd_öt64
(
p
, 
i
, (
i64
)
iVÆue
);

1103 
	}
}

1104 
	$sqlôe4_böd_öt64
(
sqlôe4_°mt
 *
pStmt
, 
i
, 
sqlôe4_öt64
 
iVÆue
){

1105 
rc
;

1106 
Vdbe
 *
p
 = (Vdbê*)
pStmt
;

1107 
rc
 = 
	`vdbeUnböd
(
p
, 
i
);

1108 if–
rc
==
SQLITE4_OK
 ){

1109 
	`sqlôe4VdbeMemSëI¡64
(&
p
->
aV¨
[
i
-1], 
iVÆue
);

1110 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1112  
rc
;

1113 
	}
}

1114 
	$sqlôe4_böd_nuŒ
(
sqlôe4_°mt
 *
pStmt
, 
i
){

1115 
rc
;

1116 
Vdbe
 *
p
 = (Vdbe*)
pStmt
;

1117 
rc
 = 
	`vdbeUnböd
(
p
, 
i
);

1118 if–
rc
==
SQLITE4_OK
 ){

1119 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1121  
rc
;

1122 
	}
}

1123 
sqlôe4_böd_ãxt
(

1124 
sqlôe4_°mt
 *
pStmt
,

1125 
i
,

1126 c⁄° *
zD©a
,

1127 
nD©a
,

1128 (*
xDñ
)(*,*),

1129 *
pDñArg


1131  
	`bödText
(
pStmt
, 
i
, 
zD©a
, 
nD©a
, 
xDñ
, 
pDñArg
, 
SQLITE4_UTF8
);

1132 
	}
}

1133 #i‚de‡
SQLITE4_OMIT_UTF16


1134 
sqlôe4_böd_ãxt16
(

1135 
sqlôe4_°mt
 *
pStmt
,

1136 
i
,

1137 c⁄° *
zD©a
,

1138 
nD©a
,

1139 (*
xDñ
)(*,*),

1140 *
pDñArg


1142  
	`bödText
(
pStmt
, 
i
, 
zD©a
, 
nD©a
, 
xDñ
, 
pDñArg
, 
SQLITE4_UTF16NATIVE
);

1143 
	}
}

1145 
	$sqlôe4_böd_vÆue
(
sqlôe4_°mt
 *
pStmt
, 
i
, c⁄° 
sqlôe4_vÆue
 *
pVÆue
){

1146 
rc
;

1147  
pVÆue
->
ty≥
 ){

1148 
SQLITE4_INTEGER
:

1149 
SQLITE4_FLOAT
: {

1150 
Mem
 *
p
 = (Mem *)
pVÆue
;

1151 
Vdbe
 *
v
 = (Vdbê*)
pStmt
;

1152 
	`vdbeUnböd
(
v
, 
i
);

1153 
v
->
aV¨
[
i
-1].
u
.
num
 = 
p
->u.num;

1154 
	`MemSëTy≥Fœg
(&
v
->
aV¨
[
i
-1],

1155 (
pVÆue
->
ty≥
==
SQLITE4_FLOAT
 ? 
MEM_Ról
 : 
MEM_I¡
)

1159 
SQLITE4_BLOB
: {

1160 
rc
 = 
	`sqlôe4_böd_blob
(
pStmt
, 
i
, 
pVÆue
->
z
,ÖVÆue->
n
,

1161 
SQLITE4_TRANSIENT
, 0);

1164 
SQLITE4_TEXT
: {

1165 
rc
 = 
	`bödText
(
pStmt
,
i
, 
pVÆue
->
z
,ÖVÆue->
n
, 
SQLITE4_TRANSIENT
, 0,

1166 
pVÆue
->
íc
);

1170 
rc
 = 
	`sqlôe4_böd_nuŒ
(
pStmt
, 
i
);

1174  
rc
;

1175 
	}
}

1178 
	$sqlôe4_böd_zîoblob
(
sqlôe4_°mt
 *
pStmt
, 
i
, 
n
){

1179 
rc
;

1180 
Vdbe
 *
p
 = (Vdbê*)
pStmt
;

1181 
rc
 = 
	`vdbeUnböd
(
p
, (
u32
)(
i
-1));

1182 if–
rc
==
SQLITE4_OK
 ){

1183 #i‚de‡
SQLITE4_OMIT_INCRBLOB


1184 
	`sqlôe4VdbeMemSëZîoBlob
(&
p
->
aV¨
[
i
-1], 
n
);

1186 
rc
 = 
	`sqlôe4VdbeMemSëZîoBlob
(&
p
->
aV¨
[
i
-1], 
n
);

1188 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

1190  
rc
;

1191 
	}
}

1197 
	$sqlôe4_böd_∑ømëî_cou¡
(
sqlôe4_°mt
 *
pStmt
){

1198 
Vdbe
 *
p
 = (Vdbe*)
pStmt
;

1199  
p
 ?Ö->
nV¨
 : 0;

1200 
	}
}

1208 c⁄° *
	$sqlôe4_böd_∑ømëî_«me
(
sqlôe4_°mt
 *
pStmt
, 
i
){

1209 
Vdbe
 *
p
 = (Vdbe*)
pStmt
;

1210 if–
p
==0 || 
i
<1 || i>p->
nzV¨
 ){

1213  
p
->
azV¨
[
i
-1];

1214 
	}
}

1221 
	$sqlôe4VdbeP¨amëîIndex
(
Vdbe
 *
p
, c⁄° *
zName
, 
nName
){

1222 
i
;

1223 if–
p
==0 ){

1226 if–
zName
 ){

1227 
i
=0; i<
p
->
nzV¨
; i++){

1228 c⁄° *
z
 = 
p
->
azV¨
[
i
];

1229 if–
z
 && 
	`memcmp
(z,
zName
,
nName
)==0 && z[nName]==0 ){

1230  
i
+1;

1235 
	}
}

1236 
	$sqlôe4_böd_∑ømëî_ödex
(
sqlôe4_°mt
 *
pStmt
, c⁄° *
zName
){

1237  
	`sqlôe4VdbeP¨amëîIndex
((
Vdbe
*)
pStmt
, 
zName
, 
	`sqlôe4SåÀn30
(zName));

1238 
	}
}

1243 
	$sqlôe4Tøns„rBödögs
(
sqlôe4_°mt
 *
pFromStmt
, sqlôe4_°mà*
pToStmt
){

1244 
Vdbe
 *
pFrom
 = (Vdbe*)
pFromStmt
;

1245 
Vdbe
 *
pTo
 = (Vdbe*)
pToStmt
;

1246 
i
;

1247 
	`as£π
–
pTo
->
db
==
pFrom
->db );

1248 
	`as£π
–
pTo
->
nV¨
==
pFrom
->nVar );

1249 
	`sqlôe4_muãx_íãr
(
pTo
->
db
->
muãx
);

1250 
i
=0; i<
pFrom
->
nV¨
; i++){

1251 
	`sqlôe4VdbeMemMove
(&
pTo
->
aV¨
[
i
], &
pFrom
->aVar[i]);

1253 
	`sqlôe4_muãx_Àave
(
pTo
->
db
->
muãx
);

1254  
SQLITE4_OK
;

1255 
	}
}

1263 
sqlôe4
 *
	$sqlôe4_db_h™dÀ
(
sqlôe4_°mt
 *
pStmt
){

1264  
pStmt
 ? ((
Vdbe
*ÌStmt)->
db
 : 0;

1265 
	}
}

1271 
	$sqlôe4_°mt_ªad⁄ly
(
sqlôe4_°mt
 *
pStmt
){

1272  
pStmt
 ? ((
Vdbe
*ÌStmt)->
ªadO∆y
 : 1;

1273 
	}
}

1278 
	$sqlôe4_°mt_busy
(
sqlôe4_°mt
 *
pStmt
){

1279 
Vdbe
 *
v
 = (Vdbe*)
pStmt
;

1280  
v
!=0 && v->
pc
>0 && v->
magic
==
VDBE_MAGIC_RUN
;

1281 
	}
}

1289 
sqlôe4_°mt
 *
	$sqlôe4_√xt_°mt
(
sqlôe4
 *
pDb
, 
sqlôe4_°mt
 *
pStmt
){

1290 
sqlôe4_°mt
 *
pNext
;

1291 
	`sqlôe4_muãx_íãr
(
pDb
->
muãx
);

1292 if–
pStmt
==0 ){

1293 
pNext
 = (
sqlôe4_°mt
*)
pDb
->
pVdbe
;

1295 
pNext
 = (
sqlôe4_°mt
*)((
Vdbe
*)
pStmt
)->pNext;

1297 
	`sqlôe4_muãx_Àave
(
pDb
->
muãx
);

1298  
pNext
;

1299 
	}
}

1304 
	$sqlôe4_°mt_°©us
(
sqlôe4_°mt
 *
pStmt
, 
›
, 
ª£tFœg
){

1305 
Vdbe
 *
pVdbe
 = (Vdbe*)
pStmt
;

1306 
v
 = 
pVdbe
->
aCou¡î
[
›
-1];

1307 if–
ª£tFœg
 ) 
pVdbe
->
aCou¡î
[
›
-1] = 0;

1308  
v
;

1309 
	}
}

	@src/vdbeaux.c

17 
	~"sqlôeI¡.h
"

18 
	~"vdbeI¡.h
"

24 
Vdbe
 *
	$sqlôe4VdbeCª©e
(
sqlôe4
 *
db
){

25 
Vdbe
 *
p
;

26 
p
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
Vdbe
) );

27 if–
p
==0 )  0;

28 
p
->
db
 = db;

29 if–
db
->
pVdbe
 ){

30 
db
->
pVdbe
->
pPªv
 = 
p
;

32 
p
->
pNext
 = 
db
->
pVdbe
;

33 
p
->
pPªv
 = 0;

34 
db
->
pVdbe
 = 
p
;

35 
p
->
magic
 = 
VDBE_MAGIC_INIT
;

36  
p
;

37 
	}
}

42 
	$sqlôe4VdbeSëSql
(
Vdbe
 *
p
, c⁄° *
z
, 
n
){

43 if–
p
==0 ) ;

44 
	`as£π
–
p
->
zSql
==0 );

45 
p
->
zSql
 = 
	`sqlôe4DbSåNDup
’->
db
, 
z
, 
n
);

46 
	}
}

51 c⁄° *
	$sqlôe4_°mt_sql
(
sqlôe4_°mt
 *
pStmt
){

52 
Vdbe
 *
p
 = (Vdbê*)
pStmt
;

53  
p
 ?Ö->
zSql
 : 0;

54 
	}
}

59 
	$sqlôe4VdbeSw≠
(
Vdbe
 *
pA
, Vdbê*
pB
){

60 
Vdbe
 
tmp
, *
pTmp
;

61 *
zTmp
;

62 
tmp
 = *
pA
;

63 *
pA
 = *
pB
;

64 *
pB
 = 
tmp
;

65 
pTmp
 = 
pA
->
pNext
;

66 
pA
->
pNext
 = 
pB
->pNext;

67 
pB
->
pNext
 = 
pTmp
;

68 
pTmp
 = 
pA
->
pPªv
;

69 
pA
->
pPªv
 = 
pB
->pPrev;

70 
pB
->
pPªv
 = 
pTmp
;

71 
zTmp
 = 
pA
->
zSql
;

72 
pA
->
zSql
 = 
pB
->zSql;

73 
pB
->
zSql
 = 
zTmp
;

74 
	}
}

76 #ifde‡
SQLITE4_DEBUG


80 
	$sqlôe4VdbeTø˚
(
Vdbe
 *
p
, 
FILE
 *
åa˚
){

81 
p
->
åa˚
 =Årace;

82 
	}
}

94 
	$growOpAºay
(
Vdbe
 *
p
){

95 
VdbeOp
 *
pNew
;

96 
nNew
 = (
p
->
nOpAŒoc
 ?Ö->nOpAŒoc*2 : ()(1024/(
Op
)));

97 
pNew
 = 
	`sqlôe4DbRóŒoc
(
p
->
db
,Ö->
aOp
, 
nNew
*(
Op
));

98 if–
pNew
 ){

99 
p
->
nOpAŒoc
 = 
	`sqlôe4DbMÆlocSize
’->
db
, 
pNew
)/(
Op
);

100 
p
->
aOp
 = 
pNew
;

102  (
pNew
 ? 
SQLITE4_OK
 : 
SQLITE4_NOMEM
);

103 
	}
}

121 
	$sqlôe4VdbeAddOp3
(
Vdbe
 *
p
, 
›
, 
p1
, 
p2
, 
p3
){

122 
i
;

123 
VdbeOp
 *
pOp
;

125 
i
 = 
p
->
nOp
;

126 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

127 
	`as£π
–
›
>0 && op<0xff );

128 if–
p
->
nOpAŒoc
<=
i
 ){

129 if–
	`growOpAºay
(
p
) ){

133 
p
->
nOp
++;

134 
pOp
 = &
p
->
aOp
[
i
];

135 
pOp
->
›code
 = (
u8
)
›
;

136 
pOp
->
p5
 = 0;

137 
pOp
->
p1
 =Ö1;

138 
pOp
->
p2
 =Ö2;

139 
pOp
->
p3
 =Ö3;

140 
pOp
->
p4
.
p
 = 0;

141 
pOp
->
p4ty≥
 = 
P4_NOTUSED
;

142 #ifde‡
SQLITE4_DEBUG


143 
pOp
->
zCommít
 = 0;

144 if–
p
->
db
->
Êags
 & 
SQLITE4_VdbeAdd›Tø˚
 ){

145 
	`sqlôe4VdbePrötOp
(0, 
i
, &
p
->
aOp
[i]);

148 #ifde‡
VDBE_PROFILE


149 
pOp
->
cy˛es
 = 0;

150 
pOp
->
˙t
 = 0;

152  
i
;

153 
	}
}

154 
	$sqlôe4VdbeAddOp0
(
Vdbe
 *
p
, 
›
){

155  
	`sqlôe4VdbeAddOp3
(
p
, 
›
, 0, 0, 0);

156 
	}
}

157 
	$sqlôe4VdbeAddOp1
(
Vdbe
 *
p
, 
›
, 
p1
){

158  
	`sqlôe4VdbeAddOp3
(
p
, 
›
, 
p1
, 0, 0);

159 
	}
}

160 
	$sqlôe4VdbeAddOp2
(
Vdbe
 *
p
, 
›
, 
p1
, 
p2
){

161  
	`sqlôe4VdbeAddOp3
(
p
, 
›
, 
p1
, 
p2
, 0);

162 
	}
}

168 
	$sqlôe4VdbeAddOp4
(

169 
Vdbe
 *
p
,

170 
›
,

171 
p1
,

172 
p2
,

173 
p3
,

174 c⁄° *
zP4
,

175 
p4ty≥


177 
addr
 = 
	`sqlôe4VdbeAddOp3
(
p
, 
›
, 
p1
, 
p2
, 
p3
);

178 
	`sqlôe4VdbeCh™geP4
(
p
, 
addr
, 
zP4
, 
p4ty≥
);

179  
addr
;

180 
	}
}

190 
	$sqlôe4VdbeAddP¨£SchemaOp
(
Vdbe
 *
p
, 
iDb
, *
zWhîe
){

191 
j
;

192 
addr
 = 
	`sqlôe4VdbeAddOp3
(
p
, 
OP_P¨£Schema
, 
iDb
, 0, 0);

193 
	`sqlôe4VdbeCh™geP4
(
p
, 
addr
, 
zWhîe
, 
P4_DYNAMIC
);

194 
j
=0; j<
p
->
db
->
nDb
; j++Ë
	`sqlôe4VdbeU£sSt‹age
(p, j);

195 
	}
}

200 
	$sqlôe4VdbeAddOp4I¡
(

201 
Vdbe
 *
p
,

202 
›
,

203 
p1
,

204 
p2
,

205 
p3
,

206 
p4


208 
addr
 = 
	`sqlôe4VdbeAddOp3
(
p
, 
›
, 
p1
, 
p2
, 
p3
);

209 
	`sqlôe4VdbeCh™geP4
(
p
, 
addr
, 
	`SQLITE4_INT_TO_PTR
(
p4
), 
P4_INT32
);

210  
addr
;

211 
	}
}

227 
	$sqlôe4VdbeMakeLabñ
(
Vdbe
 *
p
){

228 
i
;

229 
i
 = 
p
->
nLabñ
++;

230 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

231 if–
i
>=
p
->
nLabñAŒoc
 ){

232 
n
 = 
p
->
nLabñAŒoc
*2 + 5;

233 
p
->
aLabñ
 = 
	`sqlôe4DbRóŒocOrFªe
’->
db
,Ö->aLabel,

234 
n
*(
p
->
aLabñ
[0]));

235 
p
->
nLabñAŒoc
 = 
	`sqlôe4DbMÆlocSize
’->
db
,Ö->
aLabñ
)/(p->aLabel[0]);

237 if–
p
->
aLabñ
 ){

238 
p
->
aLabñ
[
i
] = -1;

240  -1-
i
;

241 
	}
}

248 
	$sqlôe4VdbeResﬁveLabñ
(
Vdbe
 *
p
, 
x
){

249 
j
 = -1-
x
;

250 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

251 
	`as£π
–
j
>=0 && j<
p
->
nLabñ
 );

252 if–
p
->
aLabñ
 ){

253 
p
->
aLabñ
[
j
] =Ö->
nOp
;

255 
	}
}

260 
	$sqlôe4VdbeRunO∆yOn˚
(
Vdbe
 *
p
){

261 
p
->
runO∆yOn˚
 = 1;

262 
	}
}

264 #ifde‡
SQLITE4_DEBUG


282 
VdbeOpIãr
 
	tVdbeOpIãr
;

283 
	sVdbeOpIãr
 {

284 
Vdbe
 *
	mv
;

285 
SubProgøm
 **
	m≠Sub
;

286 
	mnSub
;

287 
	miAddr
;

288 
	miSub
;

290 
Op
 *
	$›IãrNext
(
VdbeOpIãr
 *
p
){

291 
Vdbe
 *
v
 = 
p
->v;

292 
Op
 *
pRë
 = 0;

293 
Op
 *
aOp
;

294 
nOp
;

296 if–
p
->
iSub
<ı->
nSub
 ){

298 if–
p
->
iSub
==0 ){

299 
aOp
 = 
v
->aOp;

300 
nOp
 = 
v
->nOp;

302 
aOp
 = 
p
->
≠Sub
[p->
iSub
-1]->aOp;

303 
nOp
 = 
p
->
≠Sub
[p->
iSub
-1]->nOp;

305 
	`as£π
–
p
->
iAddr
<
nOp
 );

307 
pRë
 = &
aOp
[
p
->
iAddr
];

308 
p
->
iAddr
++;

309 if–
p
->
iAddr
==
nOp
 ){

310 
p
->
iSub
++;

311 
p
->
iAddr
 = 0;

314 if–
pRë
->
p4ty≥
==
P4_SUBPROGRAM
 ){

315 
nByã
 = (
p
->
nSub
+1)*(
SubProgøm
*);

316 
j
;

317 
j
=0; j<
p
->
nSub
; j++){

318 if–
p
->
≠Sub
[
j
]==
pRë
->
p4
.
pProgøm
 ) ;

320 if–
j
==
p
->
nSub
 ){

321 
p
->
≠Sub
 = 
	`sqlôe4DbRóŒocOrFªe
(
v
->
db
,Ö->≠Sub, 
nByã
);

322 if–!
p
->
≠Sub
 ){

323 
pRë
 = 0;

325 
p
->
≠Sub
[p->
nSub
++] = 
pRë
->
p4
.
pProgøm
;

331  
pRë
;

332 
	}
}

353 
	$sqlôe4VdbeAs£πMayAb‹t
(
Vdbe
 *
v
, 
mayAb‹t
){

354 
hasAb‹t
 = 0;

355 
Op
 *
pOp
;

356 
VdbeOpIãr
 
sIãr
;

357 
	`mem£t
(&
sIãr
, 0, (sIter));

358 
sIãr
.
v
 = v;

360  (
pOp
 = 
	`›IãrNext
(&
sIãr
))!=0 ){

361 
›code
 = 
pOp
->opcode;

362 if–
›code
==
OP_VUpd©e
 || opcode==
OP_VRíame


363 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


364 || (
›code
==
OP_FkCou¡î
 && 
pOp
->
p1
==0 &&ÖOp->
p2
==1)

366 || ((
›code
==
OP_HÆt
 || opcode==
OP_HÆtIfNuŒ
)

367 && (
pOp
->
p1
==
SQLITE4_CONSTRAINT
 &&ÖOp->
p2
==
OE_Ab‹t
))

369 
hasAb‹t
 = 1;

373 
	`sqlôe4DbFªe
(
v
->
db
, 
sIãr
.
≠Sub
);

380  ( 
v
->
db
->
mÆlocFaûed
 || 
hasAb‹t
==
mayAb‹t
 );

381 
	}
}

397 
	$ªsﬁveP2VÆues
(
Vdbe
 *
p
, *
pMaxFuncArgs
){

398 
i
;

399 
nMaxArgs
 = *
pMaxFuncArgs
;

400 
Op
 *
pOp
;

401 *
aLabñ
 = 
p
->aLabel;

402 
p
->
ªadO∆y
 = 1;

403 
pOp
=
p
->
aOp
, 
i
ı->
nOp
-1; i>=0; i--,ÖOp++){

404 
u8
 
›code
 = 
pOp
->opcode;

406 
pOp
->
›Êags
 = 
sqlôe4OpcodePr›îty
[
›code
];

407 if–
›code
==
OP_Fun˘i⁄
 || opcode==
OP_AggSãp
 ){

408 if–
pOp
->
p5
>
nMaxArgs
 )ÇMaxArgs =ÖOp->p5;

409 }if–(
›code
==
OP_Tønß˘i⁄
 && 
pOp
->
p2
!=0) ){

410 
p
->
ªadO∆y
 = 0;

411 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


412 }if–
›code
==
OP_VUpd©e
 ){

413 if–
pOp
->
p2
>
nMaxArgs
 )ÇMaxArgs =ÖOp->p2;

414 }if–
›code
==
OP_VFûãr
 ){

415 
n
;

416 
	`as£π
–
p
->
nOp
 - 
i
 >= 3 );

417 
	`as£π
–
pOp
[-1].
›code
==
OP_I¡egî
 );

418 
n
 = 
pOp
[-1].
p1
;

419 if–
n
>
nMaxArgs
 )ÇMaxArgs =Ç;

421 }if–
›code
==
OP_Next
 || opcode==
OP_S‹ãrNext
 ){

422 
pOp
->
p4
.
xAdv™˚
 = 
sqlôe4VdbeNext
;

423 
pOp
->
p4ty≥
 = 
P4_ADVANCE
;

424 }if–
›code
==
OP_Pªv
 ){

425 
pOp
->
p4
.
xAdv™˚
 = 
sqlôe4VdbePªvious
;

426 
pOp
->
p4ty≥
 = 
P4_ADVANCE
;

429 if–(
pOp
->
›Êags
 & 
OPFLG_JUMP
)!=0 &&ÖOp->
p2
<0 ){

430 
	`as£π
–-1-
pOp
->
p2
<
p
->
nLabñ
 );

431 
pOp
->
p2
 = 
aLabñ
[-1-pOp->p2];

434 
	`sqlôe4DbFªe
(
p
->
db
,Ö->
aLabñ
);

435 
p
->
aLabñ
 = 0;

437 *
pMaxFuncArgs
 = 
nMaxArgs
;

438 
	}
}

443 
	$sqlôe4VdbeCuºítAddr
(
Vdbe
 *
p
){

444 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

445  
p
->
nOp
;

446 
	}
}

459 
VdbeOp
 *
	$sqlôe4VdbeTakeOpAºay
(
Vdbe
 *
p
, *
≤Op
, *
≤MaxArg
){

460 
VdbeOp
 *
aOp
 = 
p
->aOp;

461 
	`as£π
–
aOp
 && !
p
->
db
->
mÆlocFaûed
 );

463 
	`ªsﬁveP2VÆues
(
p
, 
≤MaxArg
);

464 *
≤Op
 = 
p
->
nOp
;

465 
p
->
aOp
 = 0;

466  
aOp
;

467 
	}
}

473 
	$sqlôe4VdbeAddOpLi°
(
Vdbe
 *
p
, 
nOp
, 
VdbeOpLi°
 c⁄° *
aOp
){

474 
addr
;

475 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

476 if–
p
->
nOp
 +ÇO∞>Ö->
nOpAŒoc
 && 
	`growOpAºay
(p) ){

479 
addr
 = 
p
->
nOp
;

480 if–
	`ALWAYS
(
nOp
>0) ){

481 
i
;

482 
VdbeOpLi°
 c⁄° *
pIn
 = 
aOp
;

483 
i
=0; i<
nOp
; i++, 
pIn
++){

484 
p2
 = 
pIn
->p2;

485 
VdbeOp
 *
pOut
 = &
p
->
aOp
[
i
+
addr
];

486 
pOut
->
›code
 = 
pIn
->opcode;

487 
pOut
->
p1
 = 
pIn
->p1;

488 if–
p2
<0 && (
sqlôe4OpcodePr›îty
[
pOut
->
›code
] & 
OPFLG_JUMP
)!=0 ){

489 
pOut
->
p2
 = 
addr
 + 
	`ADDR
(p2);

491 
pOut
->
p2
 =Ö2;

493 
pOut
->
p3
 = 
pIn
->p3;

494 
pOut
->
p4ty≥
 = 
P4_NOTUSED
;

495 
pOut
->
p4
.
p
 = 0;

496 
pOut
->
p5
 = 0;

497 #ifde‡
SQLITE4_DEBUG


498 
pOut
->
zCommít
 = 0;

499 if–
p
->
db
->
Êags
 & 
SQLITE4_VdbeAdd›Tø˚
 ){

500 
	`sqlôe4VdbePrötOp
(0, 
i
+
addr
, &
p
->
aOp
[i+addr]);

504 
p
->
nOp
 +=ÇOp;

506  
addr
;

507 
	}
}

515 
	$sqlôe4VdbeCh™geP1
(
Vdbe
 *
p
, 
u32
 
addr
, 
vÆ
){

516 
	`as£π
–
p
!=0 );

517 if–((
u32
)
p
->
nOp
)>
addr
 ){

518 
p
->
aOp
[
addr
].
p1
 = 
vÆ
;

520 
	}
}

526 
	$sqlôe4VdbeCh™geP2
(
Vdbe
 *
p
, 
u32
 
addr
, 
vÆ
){

527 
	`as£π
–
p
!=0 );

528 if–((
u32
)
p
->
nOp
)>
addr
 ){

529 
p
->
aOp
[
addr
].
p2
 = 
vÆ
;

531 
	}
}

536 
	$sqlôe4VdbeCh™geP3
(
Vdbe
 *
p
, 
u32
 
addr
, 
vÆ
){

537 
	`as£π
–
p
!=0 );

538 if–((
u32
)
p
->
nOp
)>
addr
 ){

539 
p
->
aOp
[
addr
].
p3
 = 
vÆ
;

541 
	}
}

547 
	$sqlôe4VdbeCh™geP5
(
Vdbe
 *
p
, 
u8
 
vÆ
){

548 
	`as£π
–
p
!=0 );

549 if–
p
->
aOp
 ){

550 
	`as£π
–
p
->
nOp
>0 );

551 
p
->
aOp
[p->
nOp
-1].
p5
 = 
vÆ
;

553 
	}
}

559 
	$sqlôe4VdbeJumpHîe
(
Vdbe
 *
p
, 
addr
){

560 
	`as£π
–
addr
>=0 || 
p
->
db
->
mÆlocFaûed
 );

561 if–
addr
>=0 ) 
	`sqlôe4VdbeCh™geP2
(
p
,áddr,Ö->
nOp
);

562 
	}
}

569 
	$‰ìEphemîÆFun˘i⁄
(
sqlôe4
 *
db
, 
FuncDef
 *
pDef
){

570 if–
	`ALWAYS
(
pDef
Ë&& (pDef->
Êags
 & 
SQLITE4_FUNC_EPHEM
)!=0 ){

571 if–
pDef
->
xDe°roy
 ){

572 
pDef
->
	`xDe°roy
’Def->
pU£rD©a
);

574 
	`sqlôe4DbFªe
(
db
, 
pDef
);

576 
	}
}

578 
vdbeFªeOpAºay
(
sqlôe4
 *, 
Op
 *, );

583 
	$‰ìP4
(
sqlôe4
 *
db
, 
p4ty≥
, *
p4
){

584 if–
p4
 ){

585 
	`as£π
–
db
 );

586  
p4ty≥
 ){

587 
P4_NUM
:

588 
P4_DYNAMIC
:

589 
P4_KEYINFO
:

590 
P4_INTARRAY
:

591 
P4_KEYINFO_HANDOFF
: {

592 
	`sqlôe4DbFªe
(
db
, 
p4
);

595 
P4_VDBEFUNC
: {

596 
VdbeFunc
 *
pVdbeFunc
 = (VdbeFun¯*)
p4
;

597 
	`‰ìEphemîÆFun˘i⁄
(
db
, 
pVdbeFunc
->
pFunc
);

598 if–
db
->
≤ByãsFªed
==0 ) 
	`sqlôe4VdbeDñëeAuxD©a
(
pVdbeFunc
, 0);

599 
	`sqlôe4DbFªe
(
db
, 
pVdbeFunc
);

602 
P4_FUNCDEF
: {

603 
	`‰ìEphemîÆFun˘i⁄
(
db
, (
FuncDef
*)
p4
);

606 
P4_MEM
: {

607 if–
db
->
≤ByãsFªed
==0 ){

608 
	`sqlôe4VÆueFªe
((
sqlôe4_vÆue
*)
p4
);

610 
Mem
 *
p
 = (Mem*)
p4
;

611 
	`sqlôe4DbFªe
(
db
, 
p
->
zMÆloc
);

612 
	`sqlôe4DbFªe
(
db
, 
p
);

616 
P4_VTAB
 : {

617 if–
db
->
≤ByãsFªed
==0 ) 
	`sqlôe4VèbU∆ock
((
VTabÀ
 *)
p4
);

620 
P4_FTS5INFO
 : {

621 
	`sqlôe4Fts5FªeInfo
(
db
, (
Fts5Info
 *)
p4
);

626 
	}
}

633 
	$vdbeFªeOpAºay
(
sqlôe4
 *
db
, 
Op
 *
aOp
, 
nOp
){

634 if–
aOp
 ){

635 
Op
 *
pOp
;

636 
pOp
=
aOp
;ÖOp<&aOp[
nOp
];ÖOp++){

637 
	`‰ìP4
(
db
, 
pOp
->
p4ty≥
,ÖOp->
p4
.
p
);

638 #ifde‡
SQLITE4_DEBUG


639 
	`sqlôe4DbFªe
(
db
, 
pOp
->
zCommít
);

643 
	`sqlôe4DbFªe
(
db
, 
aOp
);

644 
	}
}

651 
	$sqlôe4VdbeLökSubProgøm
(
Vdbe
 *
pVdbe
, 
SubProgøm
 *
p
){

652 
p
->
pNext
 = 
pVdbe
->
pProgøm
;

653 
pVdbe
->
pProgøm
 = 
p
;

654 
	}
}

659 
	$sqlôe4VdbeCh™geToNo›
(
Vdbe
 *
p
, 
addr
){

660 if–
p
->
aOp
 ){

661 
VdbeOp
 *
pOp
 = &
p
->
aOp
[
addr
];

662 
sqlôe4
 *
db
 = 
p
->db;

663 
	`‰ìP4
(
db
, 
pOp
->
p4ty≥
,ÖOp->
p4
.
p
);

664 
	`mem£t
(
pOp
, 0, (pOp[0]));

665 
pOp
->
›code
 = 
OP_No›
;

667 
	}
}

694 
	$sqlôe4VdbeCh™geP4
(
Vdbe
 *
p
, 
addr
, c⁄° *
zP4
, 
n
){

695 
Op
 *
pOp
;

696 
sqlôe4
 *
db
;

697 
	`as£π
–
p
!=0 );

698 
db
 = 
p
->db;

699 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

700 if–
p
->
aOp
==0 || 
db
->
mÆlocFaûed
 ){

701 i‡–
n
!=
P4_KEYINFO
 &&Ç!=
P4_VTAB
 ) {

702 
	`‰ìP4
(
db
, 
n
, (*)*(**)&
zP4
);

706 
	`as£π
–
p
->
nOp
>0 );

707 
	`as£π
–
addr
<
p
->
nOp
 );

708 if–
addr
<0 ){

709 
addr
 = 
p
->
nOp
 - 1;

711 
pOp
 = &
p
->
aOp
[
addr
];

712 
	`‰ìP4
(
db
, 
pOp
->
p4ty≥
,ÖOp->
p4
.
p
);

713 
pOp
->
p4
.
p
 = 0;

714 if–
n
==
P4_INT32
 ){

717 
pOp
->
p4
.
i
 = 
	`SQLITE4_PTR_TO_INT
(
zP4
);

718 
pOp
->
p4ty≥
 = 
P4_INT32
;

719 }if–
zP4
==0 ){

720 
pOp
->
p4
.
p
 = 0;

721 
pOp
->
p4ty≥
 = 
P4_NOTUSED
;

722 }if–
n
==
P4_KEYINFO
 ){

723 
KeyInfo
 *
pKeyInfo
;

724 
nFõld
, 
nByã
;

726 
nFõld
 = ((
KeyInfo
*)
zP4
)->nField;

727 
nByã
 = (*
pKeyInfo
Ë+ (
nFõld
-1)*’KeyInfo->
aCﬁl
[0]) +ÇField;

728 
pKeyInfo
 = 
	`sqlôe4DbMÆlocRaw
(0, 
nByã
);

729 
pOp
->
p4
.
pKeyInfo
 =ÖKeyInfo;

730 if–
pKeyInfo
 ){

731 
u8
 *
aS‹tOrdî
;

732 
	`mem˝y
((*)
pKeyInfo
, 
zP4
, 
nByã
 - 
nFõld
);

733 
aS‹tOrdî
 = 
pKeyInfo
->aSortOrder;

734 if–
aS‹tOrdî
 ){

735 
pKeyInfo
->
aS‹tOrdî
 = (*)&pKeyInfo->
aCﬁl
[
nFõld
];

736 
	`mem˝y
(
pKeyInfo
->
aS‹tOrdî
,áS‹tOrdî, 
nFõld
);

738 
pOp
->
p4ty≥
 = 
P4_KEYINFO
;

740 
p
->
db
->
mÆlocFaûed
 = 1;

741 
pOp
->
p4ty≥
 = 
P4_NOTUSED
;

743 }if–
n
==
P4_KEYINFO_HANDOFF
 ){

744 
pOp
->
p4
.
p
 = (*)
zP4
;

745 
pOp
->
p4ty≥
 = 
P4_KEYINFO
;

746 }if–
n
==
P4_VTAB
 ){

747 
pOp
->
p4
.
p
 = (*)
zP4
;

748 
pOp
->
p4ty≥
 = 
P4_VTAB
;

749 
	`sqlôe4VèbLock
((
VTabÀ
 *)
zP4
);

750 
	`as£π
–((
VTabÀ
 *)
zP4
)->
db
==
p
->db );

751 }if–
n
<0 ){

752 
pOp
->
p4
.
p
 = (*)
zP4
;

753 
pOp
->
p4ty≥
 = (sig√d )
n
;

755 if–
n
==0 )Ç = 
	`sqlôe4SåÀn30
(
zP4
);

756 
pOp
->
p4
.
z
 = 
	`sqlôe4DbSåNDup
(
p
->
db
, 
zP4
, 
n
);

757 
pOp
->
p4ty≥
 = 
P4_DYNAMIC
;

759 
	}
}

761 #i‚de‡
NDEBUG


768 
	$vdbeVCommít
(
Vdbe
 *
p
, c⁄° *
zF‹m©
, 
va_li°
 
≠
){

769 
	`as£π
–
p
->
nOp
>0 ||Ö->
aOp
==0 );

770 
	`as£π
–
p
->
aOp
==0 ||Ö->aOp[p->
nOp
-1].
zCommít
==0 ||Ö->
db
->
mÆlocFaûed
 );

771 if–
p
->
nOp
 ){

772 
	`as£π
–
p
->
aOp
 );

773 
	`sqlôe4DbFªe
(
p
->
db
,Ö->
aOp
[p->
nOp
-1].
zCommít
);

774 
p
->
aOp
[p->
nOp
-1].
zCommít
 = 
	`sqlôe4VMPrötf
’->
db
, 
zF‹m©
, 
≠
);

776 
	}
}

777 
	$sqlôe4VdbeCommít
(
Vdbe
 *
p
, c⁄° *
zF‹m©
, ...){

778 
va_li°
 
≠
;

779 if–
p
 ){

780 
	`va_°¨t
(
≠
, 
zF‹m©
);

781 
	`vdbeVCommít
(
p
, 
zF‹m©
, 
≠
);

782 
	`va_íd
(
≠
);

784 
	}
}

785 
	$sqlôe4VdbeNo›Commít
(
Vdbe
 *
p
, c⁄° *
zF‹m©
, ...){

786 
va_li°
 
≠
;

787 if–
p
 ){

788 
	`sqlôe4VdbeAddOp0
(
p
, 
OP_No›
);

789 
	`va_°¨t
(
≠
, 
zF‹m©
);

790 
	`vdbeVCommít
(
p
, 
zF‹m©
, 
≠
);

791 
	`va_íd
(
≠
);

793 
	}
}

817 
VdbeOp
 *
	$sqlôe4VdbeGëOp
(
Vdbe
 *
p
, 
addr
){

820 
VdbeOp
 
dummy
;

821 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

822 if–
addr
<0 ){

823 #ifde‡
SQLITE4_OMIT_TRACE


824 if–
p
->
nOp
==0 )  (
VdbeOp
*)&
dummy
;

826 
addr
 = 
p
->
nOp
 - 1;

828 
	`as£π
–(
addr
>=0 &&áddr<
p
->
nOp
Ë||Ö->
db
->
mÆlocFaûed
 );

829 if–
p
->
db
->
mÆlocFaûed
 ){

830  (
VdbeOp
*)&
dummy
;

832  &
p
->
aOp
[
addr
];

834 
	}
}

836 #i‡!
deföed
(
SQLITE4_OMIT_EXPLAIN
Ë|| !deföed(
NDEBUG
) \

837 || 
deföed
(
VDBE_PROFILE
Ë|| 
	$deföed
(
SQLITE4_DEBUG
)

842 *
	$di•œyP4
(
Op
 *
pOp
, *
zTemp
, 
nTemp
){

843 *
zP4
 = 
zTemp
;

844 
	`as£π
–
nTemp
>=30 );

845  
pOp
->
p4ty≥
 ){

846 
P4_KEYINFO_STATIC
:

847 
P4_KEYINFO
: {

848 
i
, 
j
;

849 
KeyInfo
 *
pKeyInfo
 = 
pOp
->
p4
.pKeyInfo;

850 
i
 = 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
,

851 "keyöfo(%d,%d,%d", 
pKeyInfo
->
nFõld
,ÖKeyInfo->
nPK
,

852 
pKeyInfo
->
nD©a
);

853 
j
=0; j<
pKeyInfo
->
nFõld
; j++){

854 
CﬁlSeq
 *
pCﬁl
 = 
pKeyInfo
->
aCﬁl
[
j
];

855 if–
pCﬁl
 ){

856 
n
 = 
	`sqlôe4SåÀn30
(
pCﬁl
->
zName
);

857 if–
i
+
n
>
nTemp
-6 ){

858 
	`mem˝y
(&
zTemp
[
i
],",...",4);

861 
zTemp
[
i
++] = ',';

862 if–
pKeyInfo
->
aS‹tOrdî
 &&ÖKeyInfo->aS‹tOrdî[
j
] ){

863 
zTemp
[
i
++] = '-';

865 
	`mem˝y
(&
zTemp
[
i
], 
pCﬁl
->
zName
,
n
+1);

866 
i
 +
n
;

867 }if–
i
+4<
nTemp
-6 ){

868 
	`mem˝y
(&
zTemp
[
i
],",nil",4);

869 
i
 += 4;

872 
zTemp
[
i
++] = ')';

873 
zTemp
[
i
] = 0;

874 
	`as£π
–
i
<
nTemp
 );

877 
P4_COLLSEQ
: {

878 
CﬁlSeq
 *
pCﬁl
 = 
pOp
->
p4
.pColl;

879 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "cﬁl£q(%.20s)", 
pCﬁl
->
zName
);

882 
P4_FUNCDEF
: {

883 
FuncDef
 *
pDef
 = 
pOp
->
p4
.
pFunc
;

884 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "%s(%d)", 
pDef
->
zName
,ÖDef->
nArg
);

887 
P4_INT32
: {

888 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "%d", 
pOp
->
p4
.
i
);

891 
P4_NUM
: {

892 
	`sqlôe4_num_to_ãxt
(*
pOp
->
p4
.
pNum
, 
zTemp
, 0);

895 
P4_MEM
: {

896 
Mem
 *
pMem
 = 
pOp
->
p4
.pMem;

897 if–
pMem
->
Êags
 & 
MEM_Så
 ){

898 
zP4
 = 
pMem
->
z
;

899 }if–
pMem
->
Êags
 & (
MEM_I¡
|
MEM_Ról
) ){

900 
aOut
[30];

901 
	`sqlôe4_num_to_ãxt
(
pMem
->
u
.
num
, 
aOut
, (pMem->
Êags
 & 
MEM_Ról
));

902 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "%s", 
aOut
);

903 }if–
pMem
->
Êags
 & 
MEM_NuŒ
 ){

904 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "NULL");

906 
	`as£π
–
pMem
->
Êags
 & 
MEM_Blob
 );

907 
zP4
 = "(blob)";

911 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


912 
P4_VTAB
: {

913 
sqlôe4_vèb
 *
pVèb
 = 
pOp
->
p4
.pVtab->pVtab;

914 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "vèb:%p:%p", 
pVèb
,ÖVèb->
pModuÀ
);

918 
P4_INTARRAY
: {

919 
i
, 
j
, 
n
, 
cSï
 = '(';

920 
i
 = 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "intarray");

921 
n
 = 
pOp
->
›code
==
OP_Pîmuèti⁄
 ?ÖOp->
p1
 : 0;

922 
j
=0; j<
n
; j++){

923 
i
 +
	`sqlôe4_¢¥ötf
(
zTemp
+i, 
nTemp
-i,"%c%d",
cSï
, 
pOp
->
p4
.
ai
[
j
]);

924 
cSï
 = ',';

926 
	`sqlôe4_¢¥ötf
(
zTemp
+
i
, 
nTemp
-i, ")");

929 
P4_SUBPROGRAM
: {

930 
	`sqlôe4_¢¥ötf
(
zTemp
, 
nTemp
, "program");

933 
P4_ADVANCE
: {

934 
zTemp
[0] = 0;

938 if–
pOp
->
›code
==
OP_Blob
 ){

939 
n
 = 
pOp
->
p1
*2+2;

940 if–
n
>
nTemp
-2 )Ç =ÇTemp-2;

941 
zTemp
[0] = 'x';

942 
zTemp
[1] = '\'';

943 
	`sqlôe4BlobToHex
((
n
-2)/2,
pOp
->
p4
.
z
,
zTemp
+2);

944 
zTemp
[
n
] = '\'';

945 
zTemp
[
n
+1] = 0;

947 
zP4
 = 
pOp
->
p4
.
z
;

948 if–
zP4
==0 ){

949 
zP4
 = 
zTemp
;

950 
zTemp
[0] = 0;

955 
	`as£π
–
zP4
!=0 );

956  
zP4
;

957 
	}
}

963 
	$sqlôe4VdbeU£sSt‹age
(
Vdbe
 *
p
, 
i
){

964 
	`as£π
–
i
>=0 && i<
p
->
db
->
nDb
 && i<()(
yDbMask
)*8 );

965 
	}
}

968 #i‡
deföed
(
VDBE_PROFILE
Ë|| deföed(
SQLITE4_DEBUG
)

972 
	$sqlôe4VdbePrötOp
(
FILE
 *
pOut
, 
pc
, 
Op
 *
pOp
){

973 *
zP4
;

974 
zPå
[150];

975 c⁄° *
zF‹m©1
 = "%4d %-13s %4d %4d %4d %-4s %.2X %s\n";

976 if–
pOut
==0 )ÖOuà
°dout
;

977 
zP4
 = 
	`di•œyP4
(
pOp
, 
zPå
, (zPtr));

978 
	`Ârötf
(
pOut
, 
zF‹m©1
, 
pc
,

979 
	`sqlôe4OpcodeName
(
pOp
->
›code
),ÖOp->
p1
,ÖOp->
p2
,ÖOp->
p3
, 
zP4
,ÖOp->
p5
,

980 #ifde‡
SQLITE4_DEBUG


981 
pOp
->
zCommít
 ?ÖOp->zComment : ""

986 
	`fÊush
(
pOut
);

987 
	}
}

993 
	$ªÀa£MemAºay
(
Mem
 *
p
, 
N
){

994 if–
p
 && 
N
 ){

995 
Mem
 *
pEnd
;

996 
sqlôe4
 *
db
 = 
p
->db;

997 
u8
 
mÆloc_Áûed
 = 
db
->
mÆlocFaûed
;

998 if–
db
->
≤ByãsFªed
 ){

999 
pEnd
=&
p
[
N
];Ö<pEnd;Ö++){

1000 
	`sqlôe4DbFªe
(
db
, 
p
->
zMÆloc
);

1004 
pEnd
=&
p
[
N
];Ö<pEnd;Ö++){

1005 
	`as£π
–(&
p
[1])==
pEnd
 ||Ö[0].
db
==p[1].db );

1019 if–
p
->
Êags
&(
MEM_Agg
|
MEM_Dyn
|
MEM_Føme
|
MEM_RowSë
) ){

1020 
	`sqlôe4VdbeMemRñó£
(
p
);

1021 }if–
p
->
zMÆloc
 ){

1022 
	`sqlôe4DbFªe
(
db
, 
p
->
zMÆloc
);

1023 
p
->
zMÆloc
 = 0;

1026 
p
->
Êags
 = 
MEM_InvÆid
;

1028 
db
->
mÆlocFaûed
 = 
mÆloc_Áûed
;

1030 
	}
}

1036 
	$sqlôe4VdbeFømeDñëe
(
VdbeFøme
 *
p
){

1037 
i
;

1038 
Mem
 *
aMem
 = 
	`VdbeFømeMem
(
p
);

1039 
VdbeCurs‹
 **
≠C§
 = (VdbeCurs‹ **)&
aMem
[
p
->
nChûdMem
];

1040 
i
=0; i<
p
->
nChûdC§
; i++){

1041 
	`sqlôe4VdbeFªeCurs‹
(
≠C§
[
i
]);

1043 
	`ªÀa£MemAºay
(
aMem
, 
p
->
nChûdMem
);

1044 
	`sqlôe4DbFªe
(
p
->
v
->
db
,Ö);

1045 
	}
}

1047 #i‚de‡
SQLITE4_OMIT_EXPLAIN


1063 
	$sqlôe4VdbeLi°
(

1064 
Vdbe
 *
p


1066 
nRow
;

1067 
nSub
 = 0;

1068 
SubProgøm
 **
≠Sub
 = 0;

1069 
Mem
 *
pSub
 = 0;

1070 
sqlôe4
 *
db
 = 
p
->db;

1071 
i
;

1072 
rc
 = 
SQLITE4_OK
;

1073 
Mem
 *
pMem
 = &
p
->
aMem
[1];

1075 
	`as£π
–
p
->
ex∂aö
 );

1076 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_RUN
 );

1077 
	`as£π
–
p
->
rc
==
SQLITE4_OK
 ||Ö->rc==
SQLITE4_BUSY
 ||Ö->rc==
SQLITE4_NOMEM
 );

1083 
	`ªÀa£MemAºay
(
pMem
, 8);

1084 
p
->
pResu…Së
 = 0;

1086 if–
p
->
rc
==
SQLITE4_NOMEM
 ){

1089 
db
->
mÆlocFaûed
 = 1;

1090  
SQLITE4_ERROR
;

1100 
nRow
 = 
p
->
nOp
;

1101 if–
p
->
ex∂aö
==1 ){

1106 
	`as£π
–
p
->
nMem
>9 );

1107 
pSub
 = &
p
->
aMem
[9];

1108 if–
pSub
->
Êags
&
MEM_Blob
 ){

1111 
nSub
 = 
pSub
->
n
/(
Vdbe
*);

1112 
≠Sub
 = (
SubProgøm
 **)
pSub
->
z
;

1114 
i
=0; i<
nSub
; i++){

1115 
nRow
 +
≠Sub
[
i
]->
nOp
;

1120 
i
 = 
p
->
pc
++;

1121 } 
i
<
nRow
 && 
p
->
ex∂aö
==2 &&Ö->
aOp
[i].
›code
!=
OP_Ex∂aö
 );

1122 if–
i
>=
nRow
 ){

1123 
p
->
rc
 = 
SQLITE4_OK
;

1124 
rc
 = 
SQLITE4_DONE
;

1125 }if–
db
->
u1
.
isI¡îru±ed
 ){

1126 
p
->
rc
 = 
SQLITE4_INTERRUPT
;

1127 
rc
 = 
SQLITE4_ERROR
;

1128 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "%s", 
	`sqlôe4EºSå
’->
rc
));

1130 *
z
;

1131 
Op
 *
pOp
;

1132 if–
i
<
p
->
nOp
 ){

1135 
pOp
 = &
p
->
aOp
[
i
];

1139 
j
;

1140 
i
 -
p
->
nOp
;

1141 
j
=0; 
i
>=
≠Sub
[j]->
nOp
; j++){

1142 
i
 -
≠Sub
[
j
]->
nOp
;

1144 
pOp
 = &
≠Sub
[
j
]->
aOp
[
i
];

1146 if–
p
->
ex∂aö
==1 ){

1147 
pMem
->
Êags
 = 
MEM_I¡
;

1148 
pMem
->
ty≥
 = 
SQLITE4_INTEGER
;

1149 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
i
);

1150 
pMem
++;

1152 
pMem
->
Êags
 = 
MEM_Sètic
|
MEM_Så
|
MEM_Tîm
;

1153 
pMem
->
z
 = (*)
	`sqlôe4OpcodeName
(
pOp
->
›code
);

1154 
	`as£π
–
pMem
->
z
!=0 );

1155 
pMem
->
n
 = 
	`sqlôe4SåÀn30
’Mem->
z
);

1156 
pMem
->
ty≥
 = 
SQLITE4_TEXT
;

1157 
pMem
->
íc
 = 
SQLITE4_UTF8
;

1158 
pMem
++;

1165 if–
pOp
->
p4ty≥
==
P4_SUBPROGRAM
 ){

1166 
nByã
 = (
nSub
+1)*(
SubProgøm
*);

1167 
j
;

1168 
j
=0; j<
nSub
; j++){

1169 if–
≠Sub
[
j
]==
pOp
->
p4
.
pProgøm
 ) ;

1171 if–
j
==
nSub
 && 
SQLITE4_OK
==
	`sqlôe4VdbeMemGrow
(
pSub
, 
nByã
, 1) ){

1172 
≠Sub
 = (
SubProgøm
 **)
pSub
->
z
;

1173 
≠Sub
[
nSub
++] = 
pOp
->
p4
.
pProgøm
;

1174 
pSub
->
Êags
 |
MEM_Blob
;

1175 
pSub
->
n
 = 
nSub
*(
SubProgøm
*);

1180 
pMem
->
Êags
 = 
MEM_I¡
;

1181 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
pOp
->
p1
);

1182 
pMem
->
ty≥
 = 
SQLITE4_INTEGER
;

1183 
pMem
++;

1185 
pMem
->
Êags
 = 
MEM_I¡
;

1186 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
pOp
->
p2
);

1187 
pMem
->
ty≥
 = 
SQLITE4_INTEGER
;

1188 
pMem
++;

1190 
pMem
->
Êags
 = 
MEM_I¡
;

1191 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
pOp
->
p3
);

1192 
pMem
->
ty≥
 = 
SQLITE4_INTEGER
;

1193 
pMem
++;

1195 if–
	`sqlôe4VdbeMemGrow
(
pMem
, 150, 0) ){

1196 
	`as£π
–
p
->
db
->
mÆlocFaûed
 );

1197  
SQLITE4_ERROR
;

1199 
pMem
->
Êags
 = 
MEM_Dyn
|
MEM_Så
|
MEM_Tîm
;

1200 
z
 = 
	`di•œyP4
(
pOp
, 
pMem
->z, 150);

1201 if–
z
!=
pMem
->z ){

1202 
	`sqlôe4VdbeMemSëSå
(
pMem
, 
z
, -1, 
SQLITE4_UTF8
, 0, 0);

1204 
	`as£π
–
pMem
->
z
!=0 );

1205 
pMem
->
n
 = 
	`sqlôe4SåÀn30
’Mem->
z
);

1206 
pMem
->
íc
 = 
SQLITE4_UTF8
;

1208 
pMem
->
ty≥
 = 
SQLITE4_TEXT
;

1209 
pMem
++;

1211 if–
p
->
ex∂aö
==1 ){

1212 if–
	`sqlôe4VdbeMemGrow
(
pMem
, 4, 0) ){

1213 
	`as£π
–
p
->
db
->
mÆlocFaûed
 );

1214  
SQLITE4_ERROR
;

1216 
pMem
->
Êags
 = 
MEM_Dyn
|
MEM_Så
|
MEM_Tîm
;

1217 
pMem
->
n
 = 2;

1218 
	`sqlôe4_¢¥ötf
(
pMem
->
z
, 3, "%.2x", 
pOp
->
p5
);

1219 
pMem
->
ty≥
 = 
SQLITE4_TEXT
;

1220 
pMem
->
íc
 = 
SQLITE4_UTF8
;

1221 
pMem
++;

1223 #ifde‡
SQLITE4_DEBUG


1224 if–
pOp
->
zCommít
 ){

1225 
pMem
->
Êags
 = 
MEM_Så
|
MEM_Tîm
;

1226 
pMem
->
z
 = 
pOp
->
zCommít
;

1227 
pMem
->
n
 = 
	`sqlôe4SåÀn30
’Mem->
z
);

1228 
pMem
->
íc
 = 
SQLITE4_UTF8
;

1229 
pMem
->
ty≥
 = 
SQLITE4_TEXT
;

1233 
pMem
->
Êags
 = 
MEM_NuŒ
;

1234 
pMem
->
ty≥
 = 
SQLITE4_NULL
;

1238 
p
->
nResCﬁumn
 = 8 - 4*’->
ex∂aö
-1);

1239 
p
->
pResu…Së
 = &p->
aMem
[1];

1240 
p
->
rc
 = 
SQLITE4_OK
;

1241 
rc
 = 
SQLITE4_ROW
;

1243  
rc
;

1244 
	}
}

1247 #ifde‡
SQLITE4_DEBUG


1251 
	$sqlôe4VdbePrötSql
(
Vdbe
 *
p
){

1252 
nOp
 = 
p
->nOp;

1253 
VdbeOp
 *
pOp
;

1254 if–
nOp
<1 ) ;

1255 
pOp
 = &
p
->
aOp
[0];

1256 if–
pOp
->
›code
==
OP_Tø˚
 &&ÖOp->
p4
.
z
!=0 ){

1257 c⁄° *
z
 = 
pOp
->
p4
.z;

1258  
	`sqlôe4Is•a˚
(*
z
) ) z++;

1259 
	`¥ötf
("SQL: [%s]\n", 
z
);

1261 
	}
}

1264 #i‡!
deföed
(
SQLITE4_OMIT_TRACE
Ë&& deföed(
SQLITE4_ENABLE_IOTRACE
)

1268 
	$sqlôe4VdbeIOTø˚Sql
(
Vdbe
 *
p
){

1269 
nOp
 = 
p
->nOp;

1270 
VdbeOp
 *
pOp
;

1271 if–
sqlôe4IoTø˚
==0 ) ;

1272 if–
nOp
<1 ) ;

1273 
pOp
 = &
p
->
aOp
[0];

1274 if–
pOp
->
›code
==
OP_Tø˚
 &&ÖOp->
p4
.
z
!=0 ){

1275 
i
, 
j
;

1276 
z
[1000];

1277 
	`sqlôe4_¢¥ötf
(
z
, (z), "%s", 
pOp
->
p4
.z);

1278 
i
=0; 
	`sqlôe4Is•a˚
(
z
[i]); i++){}

1279 
j
=0; 
z
[
i
]; i++){

1280 if–
	`sqlôe4Is•a˚
(
z
[
i
]) ){

1281 if–
z
[
i
-1]!=' ' ){

1282 
z
[
j
++] = ' ';

1285 
z
[
j
++] = z[
i
];

1288 
z
[
j
] = 0;

1289 
	`sqlôe4IoTø˚
("SQL %s\n", 
z
);

1291 
	}
}

1315 *
	$ÆlocS∑˚
(

1316 *
pBuf
,

1317 
nByã
,

1318 
u8
 **
µFrom
,

1319 
u8
 *
pEnd
,

1320 *
≤Byã


1322 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(*
µFrom
) );

1323 if–
pBuf
 ) ÖBuf;

1324 
nByã
 = 
	`ROUND8
(nByte);

1325 if–&(*
µFrom
)[
nByã
] <
pEnd
 ){

1326 
pBuf
 = (*)*
µFrom
;

1327 *
µFrom
 +
nByã
;

1329 *
≤Byã
 +
nByã
;

1331  
pBuf
;

1332 
	}
}

1338 
	$sqlôe4VdbeRewöd
(
Vdbe
 *
p
){

1339 #i‡
	`deföed
(
SQLITE4_DEBUG
Ë|| deföed(
VDBE_PROFILE
)

1340 
i
;

1342 
	`as£π
–
p
!=0 );

1343 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

1347 
	`as£π
–
p
->
nOp
>0 );

1350 
p
->
magic
 = 
VDBE_MAGIC_RUN
;

1352 #ifde‡
SQLITE4_DEBUG


1353 
i
=1; i<
p
->
nMem
; i++){

1354 
	`as£π
–
p
->
aMem
[
i
].
db
==p->db );

1357 
p
->
pc
 = -1;

1358 
p
->
rc
 = 
SQLITE4_OK
;

1359 
p
->
îr‹A˘i⁄
 = 
OE_Ab‹t
;

1360 
p
->
magic
 = 
VDBE_MAGIC_RUN
;

1361 
p
->
nCh™ge
 = 0;

1362 
p
->
ˇcheCå
 = 1;

1363 
p
->
möWrôeFûeF‹m©
 = 255;

1364 
p
->
°mtTønsMask
 = 0;

1365 
p
->
nFkC⁄°øöt
 = 0;

1366 #ifde‡
VDBE_PROFILE


1367 
i
=0; i<
p
->
nOp
; i++){

1368 
p
->
aOp
[
i
].
˙t
 = 0;

1369 
p
->
aOp
[
i
].
cy˛es
 = 0;

1372 
	}
}

1392 
	$sqlôe4VdbeMakeRódy
(

1393 
Vdbe
 *
p
,

1394 
P¨£
 *
pP¨£


1396 
sqlôe4
 *
db
;

1397 
nV¨
;

1398 
nMem
;

1399 
nCurs‹
;

1400 
nArg
;

1401 
nOn˚
;

1402 
n
;

1403 
u8
 *
zC§
;

1404 
u8
 *
zEnd
;

1405 
nByã
;

1407 
	`as£π
–
p
!=0 );

1408 
	`as£π
–
p
->
nOp
>0 );

1409 
	`as£π
–
pP¨£
!=0 );

1410 
	`as£π
–
p
->
magic
==
VDBE_MAGIC_INIT
 );

1411 
db
 = 
p
->db;

1412 
	`as£π
–
db
->
mÆlocFaûed
==0 );

1413 
nV¨
 = 
pP¨£
->nVar;

1414 
nMem
 = 
pP¨£
->nMem;

1415 
nCurs‹
 = 
pP¨£
->
nTab
;

1416 
nArg
 = 
pP¨£
->
nMaxArg
;

1417 
nOn˚
 = 
pP¨£
->nOnce;

1418 if–
nOn˚
==0 )ÇOnce = 1;

1429 
nMem
 +
nCurs‹
;

1434 
zC§
 = (
u8
*)&
p
->
aOp
[p->
nOp
];

1435 
zEnd
 = (
u8
*)&
p
->
aOp
[p->
nOpAŒoc
];

1437 
	`ªsﬁveP2VÆues
(
p
, &
nArg
);

1438 
p
->
√edSavïoöt
 = (
u8
)(
pP¨£
->
isMu…iWrôe
 &&ÖP¨£->
mayAb‹t
);

1439 if–
pP¨£
->
ex∂aö
 && 
nMem
<10 ){

1440 
nMem
 = 10;

1442 
	`mem£t
(
zC§
, 0, 
zEnd
-zCsr);

1443 
zC§
 +(zC§ - (
u8
*)0)&7;

1444 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
zC§
) );

1445 
p
->
expúed
 = 0;

1458 
nByã
 = 0;

1459 
p
->
aMem
 = 
	`ÆlocS∑˚
’->aMem, 
nMem
*(
Mem
), &
zC§
, 
zEnd
, &
nByã
);

1460 
p
->
aV¨
 = 
	`ÆlocS∑˚
’->aV¨, 
nV¨
*(
Mem
), &
zC§
, 
zEnd
, &
nByã
);

1461 
p
->
≠Arg
 = 
	`ÆlocS∑˚
’->≠Arg, 
nArg
*(
Mem
*), &
zC§
, 
zEnd
, &
nByã
);

1462 
p
->
azV¨
 = 
	`ÆlocS∑˚
’->azV¨, 
nV¨
*(*), &
zC§
, 
zEnd
, &
nByã
);

1463 
p
->
≠C§
 = 
	`ÆlocS∑˚
’->≠C§, 
nCurs‹
*(
VdbeCurs‹
*),

1464 &
zC§
, 
zEnd
, &
nByã
);

1465 
p
->
aOn˚Fœg
 = 
	`ÆlocS∑˚
’->aOn˚Fœg, 
nOn˚
, &
zC§
, 
zEnd
, &
nByã
);

1466 if–
nByã
 ){

1467 
p
->
pFªe
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nByã
);

1469 
zC§
 = 
p
->
pFªe
;

1470 
zEnd
 = &
zC§
[
nByã
];

1471 } 
nByã
 && !
db
->
mÆlocFaûed
 );

1473 
p
->
nCurs‹
 = (
u16
)nCursor;

1474 
p
->
nOn˚Fœg
 = 
nOn˚
;

1475 if–
p
->
aV¨
 ){

1476 
p
->
nV¨
 = (
ynV¨
)nVar;

1477 
n
=0;Ç<
nV¨
;Ç++){

1478 
p
->
aV¨
[
n
].
Êags
 = 
MEM_NuŒ
;

1479 
p
->
aV¨
[
n
].
db
 = db;

1482 if–
p
->
azV¨
 ){

1483 
p
->
nzV¨
 = 
pP¨£
->nzVar;

1484 
	`mem˝y
(
p
->
azV¨
, 
pP¨£
->azV¨,Ö->
nzV¨
*(p->azVar[0]));

1485 
	`mem£t
(
pP¨£
->
azV¨
, 0,ÖP¨£->
nzV¨
*(pParse->azVar[0]));

1487 if–
p
->
aMem
 ){

1488 
p
->
aMem
--;

1489 
p
->
nMem
 =ÇMem;

1490 
n
=1;Ç<=
nMem
;Ç++){

1491 
p
->
aMem
[
n
].
Êags
 = 
MEM_InvÆid
;

1492 
p
->
aMem
[
n
].
db
 = db;

1495 
p
->
ex∂aö
 = 
pP¨£
->explain;

1496 
	`sqlôe4VdbeRewöd
(
p
);

1497 
	}
}

1504 
	$sqlôe4VdbeFømeRe°‹e
(
VdbeFøme
 *
pFøme
){

1505 
Vdbe
 *
v
 = 
pFøme
->v;

1506 
v
->
aOn˚Fœg
 = 
pFøme
->aOnceFlag;

1507 
v
->
nOn˚Fœg
 = 
pFøme
->nOnceFlag;

1508 
v
->
aOp
 = 
pFøme
->aOp;

1509 
v
->
nOp
 = 
pFøme
->nOp;

1510 
v
->
aMem
 = 
pFøme
->aMem;

1511 
v
->
nMem
 = 
pFøme
->nMem;

1512 
v
->
≠C§
 = 
pFøme
->apCsr;

1513 
v
->
nCurs‹
 = 
pFøme
->nCursor;

1514 
v
->
nCh™ge
 = 
pFøme
->nChange;

1515  
pFøme
->
pc
;

1516 
	}
}

1526 
	$˛o£AŒCurs‹s
(
Vdbe
 *
p
){

1527 if–
p
->
pFøme
 ){

1528 
VdbeFøme
 *
pFøme
;

1529 
pFøme
=
p
->pFøme;ÖFøme->
pP¨ít
;ÖFrame=pFrame->pParent);

1530 
	`sqlôe4VdbeFømeRe°‹e
(
pFøme
);

1532 
p
->
pFøme
 = 0;

1533 
p
->
nFøme
 = 0;

1535 if–
p
->
≠C§
 ){

1536 
i
;

1537 
i
=0; i<
p
->
nCurs‹
; i++){

1538 
VdbeCurs‹
 *
pC
 = 
p
->
≠C§
[
i
];

1539 if–
pC
 ){

1540 
	`sqlôe4VdbeFªeCurs‹
(
pC
);

1541 
p
->
≠C§
[
i
] = 0;

1545 if–
p
->
aMem
 ){

1546 
	`ªÀa£MemAºay
(&
p
->
aMem
[1],Ö->
nMem
);

1548  
p
->
pDñFøme
 ){

1549 
VdbeFøme
 *
pDñ
 = 
p
->
pDñFøme
;

1550 
p
->
pDñFøme
 = 
pDñ
->
pP¨ít
;

1551 
	`sqlôe4VdbeFømeDñëe
(
pDñ
);

1553 
	}
}

1561 
	$CÀ™up
(
Vdbe
 *
p
){

1562 
sqlôe4
 *
db
 = 
p
->db;

1564 #ifde‡
SQLITE4_DEBUG


1567 
i
;

1568 if–
p
->
≠C§
 ) 
i
=0; i<p->
nCurs‹
; i++Ë
	`as£π
(Ö->apCsr[i]==0 );

1569 if–
p
->
aMem
 ){

1570 
i
=1; i<=
p
->
nMem
; i++Ë
	`as£π
–p->
aMem
[i].
Êags
==
MEM_InvÆid
 );

1574 
	`sqlôe4DbFªe
(
db
, 
p
->
zEºMsg
);

1575 
p
->
zEºMsg
 = 0;

1576 
p
->
pResu…Së
 = 0;

1577 
	}
}

1585 
	$sqlôe4VdbeSëNumCﬁs
(
Vdbe
 *
p
, 
nResCﬁumn
){

1586 
Mem
 *
pCﬁName
;

1587 
n
;

1588 
sqlôe4
 *
db
 = 
p
->db;

1590 
	`ªÀa£MemAºay
(
p
->
aCﬁName
,Ö->
nResCﬁumn
*
COLNAME_N
);

1591 
	`sqlôe4DbFªe
(
db
, 
p
->
aCﬁName
);

1592 
n
 = 
nResCﬁumn
*
COLNAME_N
;

1593 
p
->
nResCﬁumn
 = (
u16
)nResColumn;

1594 
p
->
aCﬁName
 = 
pCﬁName
 = (
Mem
*)
	`sqlôe4DbMÆlocZîo
(
db
, (Mem)*
n
 );

1595 if–
p
->
aCﬁName
==0 ) ;

1596  
n
-- > 0 ){

1597 
pCﬁName
->
Êags
 = 
MEM_NuŒ
;

1598 
pCﬁName
->
db
 = 
p
->db;

1599 
pCﬁName
++;

1601 
	}
}

1613 
sqlôe4VdbeSëCﬁName
(

1614 
Vdbe
 *
p
,

1615 
idx
,

1616 
v¨
,

1617 c⁄° *
zName
,

1618 (*
xDñ
)(*,*)

1620 
rc
;

1621 
Mem
 *
pCﬁName
;

1622 
	`as£π
–
idx
<
p
->
nResCﬁumn
 );

1623 
	`as£π
–
v¨
<
COLNAME_N
 );

1624 
	`as£π
–
xDñ
==
SQLITE4_STATIC
 || xDñ==
SQLITE4_TRANSIENT


1625 || 
xDñ
==
SQLITE4_DYNAMIC
 );

1626 if–
p
->
db
->
mÆlocFaûed
 ){

1627 
	`as£π
–!
zName
 || 
xDñ
!=
SQLITE4_DYNAMIC
 );

1628  
SQLITE4_NOMEM
;

1630 
	`as£π
–
p
->
aCﬁName
!=0 );

1631 
pCﬁName
 = &(
p
->
aCﬁName
[
idx
+
v¨
*p->
nResCﬁumn
]);

1632 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pCﬁName
, 
zName
, -1, 
SQLITE4_UTF8
, 
xDñ
, 0);

1633 
	`as£π
–
rc
!=0 || !
zName
 || (
pCﬁName
->
Êags
&
MEM_Tîm
)!=0 );

1634  
rc
;

1635 
	}
}

1642 
	$‰ìSavïoöts
(
sqlôe4
 *
db
, 
iLevñ
){

1643 if–
iLevñ
<1 ) iLevel = 1;

1644  (
iLevñ
-1)<
db
->
nSavïoöt
 ){

1645 
Savïoöt
 *
pDñ
 = 
db
->
pSavïoöt
;

1646 
db
->
pSavïoöt
 = 
pDñ
->
pNext
;

1647 
db
->
nSavïoöt
--;

1648 
	`sqlôe4DbFªe
(
db
, 
pDñ
);

1650 
	}
}

1652 #ifde‡
SQLITE4_DEBUG


1653 
	$cou¡Savïoöts
(
sqlôe4
 *
db
){

1654 
nRë
 = 0;

1655 
Savïoöt
 *
p
;

1656 
p
=
db
->
pSavïoöt
;Ö;Öı->
pNext
Ë
nRë
++;

1657  
nRë
;

1658 
	}
}

1681 
	$sqlôe4VdbeRﬁlback
(
sqlôe4
 *
db
, 
iLevñ
){

1682 
i
;

1683 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

1684 
	`as£π
–
db
->
nSavïoöt
==
	`cou¡Savïoöts
(db) );

1687 
	`sqlôe4BegöBíignMÆloc
(
db
->
pEnv
);

1688 
i
=0; i<
db
->
nDb
; i++){

1689 
KVSt‹e
 *
pKV
 = 
db
->
aDb
[
i
].pKV;

1690 if–
pKV
 &&ÖKV->
iTønsLevñ
>=
iLevñ
 ){

1691 
	`sqlôe4KVSt‹eRﬁlback
(
pKV
, 
iLevñ
);

1694 
	`sqlôe4EndBíignMÆloc
(
db
->
pEnv
);

1699 if–
db
->
Êags
&
SQLITE4_I¡înCh™ges
 ){

1700 
	`sqlôe4ExpúePª∑ªdSèãmíts
(
db
);

1701 
	`sqlôe4Re£tI¡î«lSchema
(
db
, -1);

1702 if–
iLevñ
>2 ) 
db
->
Êags
 |
SQLITE4_I¡înCh™ges
;

1708 
	`‰ìSavïoöts
(
db
, 
iLevñ
);

1709 
db
->
nDe„ºedC⁄s
 = (db->
pSavïoöt
 ? db->pSavepoint->nDeferredCons : 0);

1710 
	`as£π
–
db
->
nSavïoöt
==
	`cou¡Savïoöts
(db) );

1712  
SQLITE4_OK
;

1713 
	}
}

1718 
	$sqlôe4VdbeCommô
(
sqlôe4
 *
db
, 
iLevñ
){

1719 
rc
 = 
SQLITE4_OK
;

1720 
i
;

1721 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

1722 
	`as£π
–
db
->
nSavïoöt
==
	`cou¡Savïoöts
(db) );

1723 
	`as£π
–
iLevñ
>1 || 
db
->
nDe„ºedC⁄s
==0 );

1726 
i
=0; 
rc
==
SQLITE4_OK
 && i<
db
->
nDb
; i++){

1727 
KVSt‹e
 *
pKV
 = 
db
->
aDb
[
i
].pKV;

1728 if–
pKV
 &&ÖKV->
iTønsLevñ
>
iLevñ
 ){

1729 
rc
 = 
	`sqlôe4KVSt‹eCommô
(
pKV
, 
iLevñ
);

1733 if–
rc
!=
SQLITE4_OK
 ){

1734 
	`sqlôe4VdbeRﬁlback
(
db
, 1);

1736 
	`‰ìSavïoöts
(
db
, 
iLevñ
);

1738 
	`as£π
–
db
->
nSavïoöt
==
	`cou¡Savïoöts
(db) );

1739  
rc
;

1740 
	}
}

1742 
	$vdbeClo£Sèãmít
(
Vdbe
 *
p
, 
bRﬁlback
){

1743 
i
;

1744 
rc
 = 
SQLITE4_OK
;

1745 
sqlôe4
 *
db
 = 
p
->db;

1747 
i
=0; 
rc
==
SQLITE4_OK
 && i<
db
->
nDb
; i++){

1748 if–
p
->
°mtTønsMask
 & ((
yDbMask
)1)<<
i
 ){

1749 
KVSt‹e
 *
pKV
 = 
db
->
aDb
[
i
].pKV;

1750 
	`as£π
–
pKV
->
iTønsLevñ
>2 );

1751 if–
bRﬁlback
 ){

1752 
rc
 = 
	`sqlôe4KVSt‹eRﬁlback
(
pKV
,ÖKV->
iTønsLevñ
);

1754 if–
rc
==
SQLITE4_OK
 ){

1755 
rc
 = 
	`sqlôe4KVSt‹eCommô
(
pKV
,ÖKV->
iTønsLevñ
-1);

1760 if–
bRﬁlback
 ){

1761 
p
->
db
->
nDe„ºedC⁄s
 =Ö->
nStmtDefC⁄s
;

1764 if–
rc
 ){

1765 
	`sqlôe4VdbeRﬁlback
(
db
, 1);

1767  
rc
;

1768 
	}
}

1779 #i‚de‡
NDEBUG


1780 
	$checkA˘iveVdbeC¡
(
sqlôe4
 *
db
){

1781 
Vdbe
 *
p
;

1782 
˙t
 = 0;

1783 
nWrôe
 = 0;

1784 
p
 = 
db
->
pVdbe
;

1785  
p
 ){

1786 if–
p
->
magic
==
VDBE_MAGIC_RUN
 &&Ö->
pc
>=0 ){

1787 
˙t
++;

1788 if–
p
->
ªadO∆y
==0 ) 
nWrôe
++;

1790 
p
 =Ö->
pNext
;

1792 
	`as£π
–
˙t
==
db
->
a˘iveVdbeC¡
 );

1793 
	`as£π
–
nWrôe
==
db
->
wrôeVdbeC¡
 );

1794 
	}
}

1796 
	#checkA˘iveVdbeC¡
(
x
)

	)

1809 
	$sqlôe4VdbeClo£Sèãmít
(
Vdbe
 *
p
, 
eOp
){

1810  
SQLITE4_OK
;

1811 
	}
}

1825 #i‚de‡
SQLITE4_OMIT_FOREIGN_KEY


1826 
	$sqlôe4VdbeCheckFk
(
Vdbe
 *
p
, 
de„ºed
){

1827 
sqlôe4
 *
db
 = 
p
->db;

1828 if–(
de„ºed
 && 
db
->
nDe„ºedC⁄s
>0Ë|| (!de„ºed && 
p
->
nFkC⁄°øöt
>0) ){

1829 
p
->
rc
 = 
SQLITE4_CONSTRAINT
;

1830 
p
->
îr‹A˘i⁄
 = 
OE_Ab‹t
;

1831 
	`sqlôe4SëSåög
(&
p
->
zEºMsg
, 
db
, "foreign key constraint failed");

1832  
SQLITE4_ERROR
;

1834  
SQLITE4_OK
;

1835 
	}
}

1851 
	$sqlôe4VdbeHÆt
(
Vdbe
 *
p
){

1852 
sqlôe4
 *
db
 = 
p
->db;

1854 if–
db
->
mÆlocFaûed
 ) 
p
->
rc
 = 
SQLITE4_NOMEM
;

1855 if–
p
->
aOn˚Fœg
 ) 
	`mem£t
’->aOn˚Fœg, 0,Ö->
nOn˚Fœg
);

1856 
	`˛o£AŒCurs‹s
(
p
);

1857 if–
p
->
magic
!=
VDBE_MAGIC_RUN
 ){

1858  
SQLITE4_OK
;

1860 
	`checkA˘iveVdbeC¡
(
db
);

1862 if–
p
->
pc
>=0 ){

1870 
eA˘i⁄
 = (
p
->
rc
!=
SQLITE4_OK
);

1872 if–
p
->
rc
==
SQLITE4_CONSTRAINT
 ){

1873 if–
p
->
îr‹A˘i⁄
==
OE_Rﬁlback
 ){

1874 
eA˘i⁄
 = 2;

1875 }if–
p
->
îr‹A˘i⁄
==
OE_Faû
 ){

1876 
eA˘i⁄
 = 0;

1879 if–
eA˘i⁄
==0 && 
	`sqlôe4VdbeCheckFk
(
p
, 0) )ÉAction = 1;

1881 if–
eA˘i⁄
==2 || (

1882 
db
->
wrôeVdbeC¡
==(
p
->
ªadO∆y
==0Ë&& db->
pSavïoöt
==0

1885 if–
eA˘i⁄
==0 && 
	`sqlôe4VdbeCheckFk
(
p
, 1) )ÉAction = 1;

1886 if–
eA˘i⁄
==0 ){

1887 
rc
 = 
	`sqlôe4VdbeCommô
(
db
, 1);

1888 if–
rc
!=
SQLITE4_OK
 ){

1889 
p
->
rc
 =Ñc;

1890 
eA˘i⁄
 = 1;

1892 
	`as£π
–
db
->
nDe„ºedC⁄s
<=0 );

1893 
	`sqlôe4CommôI¡î«lCh™ges
(
db
);

1897 if–
eA˘i⁄
 ){

1898 
	`sqlôe4VdbeRﬁlback
(
db
, 1);

1901 
db
->
nDe„ºedC⁄s
 = 0;

1902 }if–
p
->
°mtTønsMask
 ){

1906 
	`as£π
–
eA˘i⁄
==0 ||ÉAction==1 );

1907 
	`vdbeClo£Sèãmít
(
p
, 
eA˘i⁄
);

1910 if–
p
->
ch™geC¡On
 ){

1911 
	`sqlôe4VdbeSëCh™ges
(
db
, (
eA˘i⁄
 ? 0 : 
p
->
nCh™ge
));

1913 
p
->
nCh™ge
 = 0;

1916 
db
->
a˘iveVdbeC¡
--;

1917 if–!
p
->
ªadO∆y
 ){

1918 
db
->
wrôeVdbeC¡
--;

1920 
	`as£π
–
db
->
a˘iveVdbeC¡
>=db->
wrôeVdbeC¡
 );

1922 if–
db
->
pSavïoöt
==0 && db->
a˘iveVdbeC¡
==0 ){

1923 
	`sqlôe4VdbeRﬁlback
(
db
, 0);

1927 
p
->
magic
 = 
VDBE_MAGIC_HALT
;

1928 
	`checkA˘iveVdbeC¡
(
db
);

1929 if–
p
->
db
->
mÆlocFaûed
 ){

1930 
p
->
rc
 = 
SQLITE4_NOMEM
;

1932  (
p
->
rc
==
SQLITE4_BUSY
 ? SQLITE4_BUSY : 
SQLITE4_OK
);

1933 
	}
}

1940 
	$sqlôe4VdbeRe£tSãpResu…
(
Vdbe
 *
p
){

1941 
p
->
rc
 = 
SQLITE4_OK
;

1942 
	}
}

1952 
	$sqlôe4VdbeTøns„rEº‹
(
Vdbe
 *
p
){

1953 
sqlôe4
 *
db
 = 
p
->db;

1954 
rc
 = 
p
->rc;

1955 if–
p
->
zEºMsg
 ){

1956 
u8
 
mÆlocFaûed
 = 
db
->mallocFailed;

1957 
	`sqlôe4BegöBíignMÆloc
(
db
->
pEnv
);

1958 
	`sqlôe4VÆueSëSå
(
db
->
pEº
, -1, 
p
->
zEºMsg
, 
SQLITE4_UTF8
,

1959 
SQLITE4_TRANSIENT
, 0);

1960 
	`sqlôe4EndBíignMÆloc
(
db
->
pEnv
);

1961 
db
->
mÆlocFaûed
 = mallocFailed;

1962 
db
->
îrCode
 = 
rc
;

1964 
	`sqlôe4Eº‹
(
db
, 
rc
, 0);

1966  
rc
;

1967 
	}
}

1980 
	$sqlôe4VdbeRe£t
(
Vdbe
 *
p
){

1981 
sqlôe4
 *
db
;

1982 
db
 = 
p
->db;

1988 
	`sqlôe4VdbeHÆt
(
p
);

1995 if–
p
->
pc
>=0 ){

1996 
	`sqlôe4VdbeTøns„rEº‹
(
p
);

1997 
	`sqlôe4DbFªe
(
db
, 
p
->
zEºMsg
);

1998 
p
->
zEºMsg
 = 0;

1999 if–
p
->
runO∆yOn˚
 )Ö->
expúed
 = 1;

2000 }if–
p
->
rc
 &&Ö->
expúed
 ){

2005 
	`sqlôe4Eº‹
(
db
, 
p
->
rc
, 0);

2006 
	`sqlôe4VÆueSëSå
(
db
->
pEº
, -1, 
p
->
zEºMsg
, 
SQLITE4_UTF8
,

2007 
SQLITE4_TRANSIENT
, 0);

2008 
	`sqlôe4DbFªe
(
db
, 
p
->
zEºMsg
);

2009 
p
->
zEºMsg
 = 0;

2014 
	`CÀ™up
(
p
);

2018 #ifde‡
VDBE_PROFILE


2020 
FILE
 *
out
 = 
	`f›í
("vdbe_profile.out", "a");

2021 if–
out
 ){

2022 
i
;

2023 
	`Ârötf
(
out
, "---- ");

2024 
i
=0; i<
p
->
nOp
; i++){

2025 
	`Ârötf
(
out
, "%02x", 
p
->
aOp
[
i
].
›code
);

2027 
	`Ârötf
(
out
, "\n");

2028 
i
=0; i<
p
->
nOp
; i++){

2029 
	`Ârötf
(
out
, "%6d %10lld %8lld ",

2030 
p
->
aOp
[
i
].
˙t
,

2031 
p
->
aOp
[
i
].
cy˛es
,

2032 
p
->
aOp
[
i
].
˙t
>0 ?Ö->aOp[i].
cy˛es
/p->aOp[i].cnt : 0

2034 
	`sqlôe4VdbePrötOp
(
out
, 
i
, &
p
->
aOp
[i]);

2036 
	`f˛o£
(
out
);

2040 
p
->
magic
 = 
VDBE_MAGIC_INIT
;

2041  
p
->
rc
;

2042 
	}
}

2048 
	$sqlôe4VdbeFöÆize
(
Vdbe
 *
p
){

2049 
rc
 = 
SQLITE4_OK
;

2050 if–
p
->
magic
==
VDBE_MAGIC_RUN
 ||Ö->magic==
VDBE_MAGIC_HALT
 ){

2051 
rc
 = 
	`sqlôe4VdbeRe£t
(
p
);

2053 
	`sqlôe4VdbeDñëe
(
p
);

2054  
rc
;

2055 
	}
}

2063 
	$sqlôe4VdbeDñëeAuxD©a
(
VdbeFunc
 *
pVdbeFunc
, 
mask
){

2064 
i
;

2065 
i
=0; i<
pVdbeFunc
->
nAux
; i++){

2066 
AuxD©a
 *
pAux
 = &
pVdbeFunc
->
≠Aux
[
i
];

2067 if–(
i
>31 || !(
mask
&(((
u32
)1)<<i))Ë&& 
pAux
->pAux ){

2068 if–
pAux
->
xDñëe
 ){

2069 
pAux
->
	`xDñëe
’Aux->
pDñëeArg
,ÖAux->pAux);

2071 
pAux
->pAux = 0;

2074 
	}
}

2082 
	$sqlôe4VdbeDñëeObje˘
(
sqlôe4
 *
db
, 
Vdbe
 *
p
){

2083 
SubProgøm
 *
pSub
, *
pNext
;

2084 
i
;

2085 
	`as£π
–
p
->
db
==0 ||Ö->db==db );

2086 
	`ªÀa£MemAºay
(
p
->
aV¨
,Ö->
nV¨
);

2087 
	`ªÀa£MemAºay
(
p
->
aCﬁName
,Ö->
nResCﬁumn
*
COLNAME_N
);

2088 
pSub
=
p
->
pProgøm
;ÖSub;ÖSub=
pNext
){

2089 
pNext
 = 
pSub
->pNext;

2090 
	`vdbeFªeOpAºay
(
db
, 
pSub
->
aOp
,ÖSub->
nOp
);

2091 
	`sqlôe4DbFªe
(
db
, 
pSub
);

2093 
i
=
p
->
nzV¨
-1; i>=0; i--Ë
	`sqlôe4DbFªe
(
db
,Ö->
azV¨
[i]);

2094 
	`vdbeFªeOpAºay
(
db
, 
p
->
aOp
,Ö->
nOp
);

2095 
	`sqlôe4DbFªe
(
db
, 
p
->
aLabñ
);

2096 
	`sqlôe4DbFªe
(
db
, 
p
->
aCﬁName
);

2097 
	`sqlôe4DbFªe
(
db
, 
p
->
zSql
);

2098 
	`sqlôe4DbFªe
(
db
, 
p
->
pFªe
);

2099 #i‡
	`deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

2100 
	`sqlôe4DbFªe
(
db
, 
p
->
zEx∂aö
);

2101 
	`sqlôe4DbFªe
(
db
, 
p
->
pEx∂aö
);

2103 
	`sqlôe4DbFªe
(
db
, 
p
);

2104 
	}
}

2109 
	$sqlôe4VdbeDñëe
(
Vdbe
 *
p
){

2110 
sqlôe4
 *
db
;

2112 if–
	`NEVER
(
p
==0) ) ;

2113 
db
 = 
p
->db;

2114 if–
p
->
pPªv
 ){

2115 
p
->
pPªv
->
pNext
 =Ö->pNext;

2117 
	`as£π
–
db
->
pVdbe
==
p
 );

2118 
db
->
pVdbe
 = 
p
->
pNext
;

2120 if–
p
->
pNext
 ){

2121 
p
->
pNext
->
pPªv
 =Ö->pPrev;

2123 
p
->
magic
 = 
VDBE_MAGIC_DEAD
;

2124 
p
->
db
 = 0;

2125 
	`sqlôe4VdbeDñëeObje˘
(
db
, 
p
);

2126 
	}
}

2162 #ifde‡
SQLITE4_MIXED_ENDIAN_64BIT_FLOAT


2163 
u64
 
	$ÊﬂtSw≠
(
u64
 
ö
){

2165 
u64
 
r
;

2166 
u32
 
i
[2];

2167 } 
u
;

2168 
u32
 
t
;

2170 
u
.
r
 = 
ö
;

2171 
t
 = 
u
.
i
[0];

2172 
u
.
i
[0] = u.i[1];

2173 
u
.
i
[1] = 
t
;

2174  
u
.
r
;

2175 
	}
}

2176 
	#sw≠MixedEndünFlﬂt
(
X
ËX = 
	`ÊﬂtSw≠
(X)

	)

2178 
	#sw≠MixedEndünFlﬂt
(
X
)

	)

2186 
	$sqlôe4VdbeSëCh™ges
(
sqlôe4
 *
db
, 
nCh™ge
){

2187 
	`as£π
–
	`sqlôe4_muãx_hñd
(
db
->
muãx
) );

2188 
db
->
nCh™ge
 =ÇChange;

2189 
db
->
nTŸÆCh™ge
 +
nCh™ge
;

2190 
	}
}

2196 
	$sqlôe4VdbeCou¡Ch™ges
(
Vdbe
 *
v
){

2197 
v
->
ch™geC¡On
 = 1;

2198 
	}
}

2210 
	$sqlôe4ExpúePª∑ªdSèãmíts
(
sqlôe4
 *
db
){

2211 
Vdbe
 *
p
;

2212 
p
 = 
db
->
pVdbe
;Ö;Öı->
pNext
){

2213 
p
->
expúed
 = 1;

2215 
	}
}

2220 
sqlôe4
 *
	$sqlôe4VdbeDb
(
Vdbe
 *
v
){

2221  
v
->
db
;

2222 
	}
}

2232 
sqlôe4_vÆue
 *
	$sqlôe4VdbeGëVÆue
(
Vdbe
 *
v
, 
iV¨
, 
u8
 
aff
){

2233 
	`as£π
–
iV¨
>0 );

2234 if–
v
 ){

2235 
Mem
 *
pMem
 = &
v
->
aV¨
[
iV¨
-1];

2236 if–0==(
pMem
->
Êags
 & 
MEM_NuŒ
) ){

2237 
sqlôe4_vÆue
 *
pRë
 = 
	`sqlôe4VÆueNew
(
v
->
db
);

2238 if–
pRë
 ){

2239 
	`sqlôe4VdbeMemC›y
((
Mem
 *)
pRë
, 
pMem
);

2240 
	`sqlôe4VÆueAµlyAfföôy
(
pRë
, 
aff
, 
SQLITE4_UTF8
);

2241 
	`sqlôe4VdbeMemSt‹eTy≥
((
Mem
 *)
pRë
);

2243  
pRë
;

2247 
	}
}

2254 
	$sqlôe4VdbeSëV¨mask
(
Vdbe
 *
v
, 
iV¨
){

2255 
	`as£π
–
iV¨
>0 );

2256 if–
iV¨
>32 ){

2257 
v
->
expmask
 = 0xffffffff;

2259 
v
->
expmask
 |((
u32
)1 << (
iV¨
-1));

2261 
	}
}

2268 c⁄° 
u8
 
	gsqlôe4SmÆlTy≥Sizes
[128] = {

2288 
u32
 
	$sqlôe4VdbeSîülTy≥Lí
(
u32
 
£rül_ty≥
){

2289 if–
£rül_ty≥
>=128 ){

2290  (
£rül_ty≥
-12)/2;

2292 
	`as£π
–
£rül_ty≥
<12

2293 || 
sqlôe4SmÆlTy≥Sizes
[
£rül_ty≥
]==(serial_type - 12)/2 );

2294  
sqlôe4SmÆlTy≥Sizes
[
£rül_ty≥
];

2296 
	}
}

	@src/vdbeblob.c

13 
	~"sqlôeI¡.h
"

15 #i‚de‡
SQLITE4_OMIT_INCRBLOB


18 
sqlôe4PutV¨öt64
(*, 
sqlôe4_uöt64
);

23 
In¸blob
 
	tIn¸blob
;

24 
	sIn¸blob
 {

25 
sqlôe4
 *
	mdb
;

26 
KVSt‹e
 *
	mpSt‹e
;

29 *
	mzDb
;

30 *
	mzTabÀ
;

31 *
	mzCﬁumn
;

34 
KVByãAºay
 *
	mpKey
;

35 
KVSize
 
	mnKey
;

37 
sqlôe4_öt64
 
	mnByã
;

38 
	mwrFœg
;

42 
	$födDbIndex
(
sqlôe4
 *
db
, c⁄° *
zDb
){

43 
i
;

44 if–
zDb
==0 || zDb[0]==0 ) zDb = "main";

45 
i
=0; i<
db
->
nDb
; i++){

46 if–
db
->
aDb
[
i
].
zName
 && 
	`sqlôe4_°ricmp
(db->aDb[i].zName, 
zDb
)==0 ){

47  
i
;

51 
	}
}

61 
	$buûdBlobKey
(

62 
sqlôe4
 *
db
,

63 c⁄° *
zTabÀ
,

64 c⁄° *
zCﬁumn
,

65 
sqlôe4_öt64
 
iRow
,

66 
KVByãAºay
 **
µKey
,

67 
KVSize
 *
≤Key


69 
nTabÀ
, 
nCﬁ
;

70 
nV¨
;

71 
KVSize
 
nKey
;

72 
KVByãAºay
 *
pKey
;

73 
aV¨
[16];

75 if–
zTabÀ
==0 || zTabÀ[0]==0 || 
zCﬁumn
==0 || zColumn[0]==0 ){

76  
SQLITE4_MISUSE_BKPT
;

79 
nTabÀ
 = ()
	`sqlôe4SåÀn30
(
zTabÀ
);

80 
nCﬁ
 = ()
	`sqlôe4SåÀn30
(
zCﬁumn
);

81 
nV¨
 = 
	`sqlôe4PutV¨öt64
(
aV¨
, (
sqlôe4_uöt64
)
iRow
);

84 
nKey
 = 5 + (
KVSize
)
nTabÀ
 + 1 + (KVSize)
nCﬁ
 + 1 + (KVSize)
nV¨
;

86 
pKey
 = (
KVByãAºay
*)
	`sqlôe4DbMÆlocRaw
(
db
, 
nKey
);

87 if–
pKey
==0 )  
SQLITE4_NOMEM
;

90 
	`mem˝y
(
pKey
, "blob", 4);

91 
pKey
[4] = 0x00;

93 
	`mem˝y
(
pKey
+5, 
zTabÀ
, 
nTabÀ
);

94 
pKey
[5+
nTabÀ
] = 0x00;

96 
	`mem˝y
(
pKey
+5+
nTabÀ
+1, 
zCﬁumn
, 
nCﬁ
);

97 
pKey
[5+
nTabÀ
+1+
nCﬁ
] = 0x00;

99 
	`mem˝y
(
pKey
+5+
nTabÀ
+1+
nCﬁ
+1, 
aV¨
, 
nV¨
);

101 *
µKey
 = 
pKey
;

102 *
≤Key
 = 
nKey
;

103  
SQLITE4_OK
;

104 
	}
}

112 
	$kvBlobSize
(
KVSt‹e
 *
pSt‹e
, c⁄° 
KVByãAºay
 *
pKey
, 
KVSize
 
nKey
, 
sqlôe4_öt64
 *
≤Byã
){

113 
KVCurs‹
 *
pCur
 = 0;

114 
rc
;

115 c⁄° 
KVByãAºay
 *
pD©a
 = 0;

116 
KVSize
 
nD©a
 = 0;

118 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pSt‹e
, &
pCur
);

119 if–
rc
!=
SQLITE4_OK
 ) Ñc;

121 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
pKey
, 
nKey
, 0);

122 if–
rc
==
SQLITE4_OK
 ){

123 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pCur
, 0, -1, &
pD©a
, &
nD©a
);

124 if–
rc
==
SQLITE4_OK
 ){

125 *
≤Byã
 = (
sqlôe4_öt64
)
nD©a
;

127 }if–
rc
==
SQLITE4_NOTFOUND
 ){

129 }if–
rc
==
SQLITE4_INEXACT
 ){

131 
rc
 = 
SQLITE4_NOTFOUND
;

134 
	`sqlôe4KVCurs‹Clo£
(
pCur
);

135  
rc
;

136 
	}
}

147 
	$sqlôe4_blob_›í
(

148 
sqlôe4
* 
db
,

149 c⁄° *
zDb
,

150 c⁄° *
zTabÀ
,

151 c⁄° *
zCﬁumn
,

152 
sqlôe4_öt64
 
iRow
,

153 
wrFœg
,

154 
sqlôe4_blob
 **
µBlob


156 
rc
 = 
SQLITE4_OK
;

157 
In¸blob
 *
pBlob
 = 0;

158 
iDb
;

159 
KVSt‹e
 *
pSt‹e
 = 0;

160 
KVByãAºay
 *
pKey
 = 0;

161 
KVSize
 
nKey
 = 0;

162 
sqlôe4_öt64
 
nByã
 = 0;

164 #ifde‡
SQLITE_ENABLE_API_ARMOR


165 if–
µBlob
==0 )  
SQLITE4_MISUSE_BKPT
;

167 *
µBlob
 = 0;

169 #ifde‡
SQLITE_ENABLE_API_ARMOR


170 if–!
	`sqlôe4Sa„tyCheckOk
(
db
Ë|| 
zTabÀ
==0 || 
zCﬁumn
==0 ){

171  
SQLITE4_MISUSE_BKPT
;

175 
wrFœg
 = !!wrFlag;

176 if–
zDb
==0 || zDb[0]==0 ) zDb = "main";

178 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

180 
iDb
 = 
	`födDbIndex
(
db
, 
zDb
);

181 if–
iDb
<0 ){

182 
rc
 = 
SQLITE4_ERROR
;

183 
	`sqlôe4Eº‹
(
db
, 
rc
, "unknow¿d©aba£: %s", 
zDb
);

184 
out
;

186 
pSt‹e
 = 
db
->
aDb
[
iDb
].
pKV
;

187 if–
pSt‹e
==0 ){

188 
rc
 = 
SQLITE4_ERROR
;

189 
	`sqlôe4Eº‹
(
db
, 
rc
, "nÿKV st‹êf‹ db: %s", db->
aDb
[
iDb
].
zName
);

190 
out
;

193 
rc
 = 
	`buûdBlobKey
(
db
, 
zTabÀ
, 
zCﬁumn
, 
iRow
, &
pKey
, &
nKey
);

194 if–
rc
!=
SQLITE4_OK
 ) 
out
;

196 
rc
 = 
	`kvBlobSize
(
pSt‹e
, 
pKey
, 
nKey
, &
nByã
);

197 if–
rc
==
SQLITE4_OK
 ){

199 }if–
rc
==
SQLITE4_NOTFOUND
 ){

200 if–
wrFœg
 ){

201 
nByã
 = -1;

202 
rc
 = 
SQLITE4_OK
;

204 
rc
 = 
SQLITE4_ERROR
;

205 
	`sqlôe4Eº‹
(
db
, 
rc
, "no such blob (%s.%s.%sÑow=%lld)",

206 
zDb
, 
zTabÀ
, 
zCﬁumn
, ()
iRow
);

207 
out
;

210 
	`sqlôe4Eº‹
(
db
, 
rc
, 
NULL
);

211 
out
;

214 
pBlob
 = (
In¸blob
*)
	`sqlôe4DbMÆlocZîo
(
db
, (Incrblob));

215 if–
pBlob
==0 ){

216 
rc
 = 
SQLITE4_NOMEM
;

217 
out
;

220 
pBlob
->
db
 = db;

221 
pBlob
->
pSt‹e
 =ÖStore;

222 
pBlob
->
pKey
 =ÖKey;

223 
pBlob
->
nKey
 =ÇKey;

224 
pBlob
->
nByã
 =ÇByte;

225 
pBlob
->
wrFœg
 = wrFlag;

228 
pBlob
->
zDb
 = 
	`sqlôe4DbSåDup
(
db
, zDb);

229 
pBlob
->
zTabÀ
 = 
	`sqlôe4DbSåDup
(
db
, zTable);

230 
pBlob
->
zCﬁumn
 = 
	`sqlôe4DbSåDup
(
db
, zColumn);

231 if–
pBlob
->
zDb
==0 ||ÖBlob->
zTabÀ
==0 ||ÖBlob->
zCﬁumn
==0 ){

232 
rc
 = 
SQLITE4_NOMEM
;

233 
out
;

236 *
µBlob
 = (
sqlôe4_blob
*)
pBlob
;

237 
pKey
 = 0;

239 
out
:

240 if–
rc
!=
SQLITE4_OK
 ){

241 if–
pKey
 ) 
	`sqlôe4DbFªe
(
db
,ÖKey);

242 if–
pBlob
 ){

243 if–
pBlob
->
pKey
 ) 
	`sqlôe4DbFªe
(
db
,ÖBlob->pKey);

244 if–
pBlob
->
zDb
 ) 
	`sqlôe4DbFªe
(
db
,ÖBlob->zDb);

245 if–
pBlob
->
zTabÀ
 ) 
	`sqlôe4DbFªe
(
db
,ÖBlob->zTable);

246 if–
pBlob
->
zCﬁumn
 ) 
	`sqlôe4DbFªe
(
db
,ÖBlob->zColumn);

247 
	`sqlôe4DbFªe
(
db
, 
pBlob
);

251 
rc
 = 
	`sqlôe4ApiExô
(
db
,Ñc);

252 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

253  
rc
;

254 
	}
}

256 
	$sqlôe4_blob_˛o£
(
sqlôe4_blob
 *
pBlob
){

257 
In¸blob
 *
p
 = (In¸blob*)
pBlob
;

258 
sqlôe4
 *
db
;

259 if–
p
==0 )  
SQLITE4_OK
;

261 
db
 = 
p
->db;

262 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

264 if–
p
->
pKey
 ) 
	`sqlôe4DbFªe
(
db
,Ö->pKey);

265 if–
p
->
zDb
 ) 
	`sqlôe4DbFªe
(
db
,Ö->zDb);

266 if–
p
->
zTabÀ
 ) 
	`sqlôe4DbFªe
(
db
,Ö->zTable);

267 if–
p
->
zCﬁumn
 ) 
	`sqlôe4DbFªe
(
db
,Ö->zColumn);

269 
	`sqlôe4DbFªe
(
db
, 
p
);

271 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

272  
SQLITE4_OK
;

273 
	}
}

281 
	$sqlôe4_blob_byãs
(
sqlôe4_blob
 *
pBlob
){

282 
In¸blob
 *
p
 = (In¸blob*)
pBlob
;

283 
sqlôe4_öt64
 
nByã
 = 0;

284 
rc
;

286 if–
p
==0 )  0;

287 if–
p
->
nByã
>=0 )  ()p->nByte;

290 
	`sqlôe4_muãx_íãr
(
p
->
db
->
muãx
);

291 
rc
 = 
	`kvBlobSize
(
p
->
pSt‹e
,Ö->
pKey
,Ö->
nKey
, &
nByã
);

292 if–
rc
==
SQLITE4_OK
 ){

293 
p
->
nByã
 =ÇByte;

295 
nByã
 = 0;

297 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

299  ()
nByã
;

300 
	}
}

305 
	$sqlôe4_blob_ªad
(
sqlôe4_blob
 *
pBlob
, *
z
, 
n
, 
iOff£t
){

306 
In¸blob
 *
p
 = (In¸blob*)
pBlob
;

307 
rc
;

308 c⁄° 
KVByãAºay
 *
pD©a
 = 0;

309 
KVSize
 
nD©a
 = 0;

310 
KVCurs‹
 *
pCur
 = 0;

312 if–
p
==0 )  
SQLITE4_MISUSE_BKPT
;

313 if–
n
<0 || 
iOff£t
<0 )  
SQLITE4_ERROR
;

315 
	`sqlôe4_muãx_íãr
(
p
->
db
->
muãx
);

318 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
p
->
pSt‹e
, &
pCur
);

319 if–
rc
!=
SQLITE4_OK
 ) 
out
;

321 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
p
->
pKey
,Ö->
nKey
, 0);

322 if–
rc
!=
SQLITE4_OK
 ){

323 if–
rc
==
SQLITE4_NOTFOUND
 )Ñ¯
SQLITE4_ERROR
;

324 
out
;

327 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
pCur
, 0, -1, &
pD©a
, &
nD©a
);

328 if–
rc
!=
SQLITE4_OK
 ) 
out
;

331 if–(
sqlôe4_öt64
)
iOff£t
 + (sqlôe4_öt64)
n
 > (sqlôe4_öt64)
nD©a
 ){

332 
rc
 = 
SQLITE4_ERROR
;

333 
out
;

336 
	`mem˝y
(
z
, 
pD©a
 + 
iOff£t
, (
size_t
)
n
);

339 if–
p
->
nByã
<0 )Ö->nByã = (
sqlôe4_öt64
)
nD©a
;

341 
rc
 = 
SQLITE4_OK
;

343 
out
:

344 if–
pCur
 ) 
	`sqlôe4KVCurs‹Clo£
(pCur);

345 
	`sqlôe4Eº‹
(
p
->
db
, 
rc
, 
NULL
);

346 
rc
 = 
	`sqlôe4ApiExô
(
p
->
db
,Ñc);

347 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

348  
rc
;

349 
	}
}

363 
	$sqlôe4_blob_wrôe
(
sqlôe4_blob
 *
pBlob
, c⁄° *
z
, 
n
, 
iOff£t
){

364 
In¸blob
 *
p
 = (In¸blob*)
pBlob
;

365 
rc
;

367 if–
p
==0 )  
SQLITE4_MISUSE_BKPT
;

368 if–
p
->
wrFœg
==0 )  
SQLITE4_READONLY
;

369 if–
n
<0 || 
iOff£t
<0 )  
SQLITE4_ERROR
;

371 
	`sqlôe4_muãx_íãr
(
p
->
db
->
muãx
);

373 if–
p
->
nByã
>=0 ){

375 if–
iOff£t
!=0 || (
sqlôe4_öt64
)
n
 !
p
->
nByã
 ){

376 
rc
 = 
SQLITE4_ERROR
;

377 
out
;

381 if–
iOff£t
!=0 ){

382 
rc
 = 
SQLITE4_ERROR
;

383 
out
;

385 
p
->
nByã
 = (
sqlôe4_öt64
)
n
;

388 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(

389 
p
->
pSt‹e
,

390 
p
->
pKey
,Ö->
nKey
,

391 (c⁄° 
KVByãAºay
*)
z
, (
KVSize
)
n


394 
out
:

395 
	`sqlôe4Eº‹
(
p
->
db
, 
rc
, 
NULL
);

396 
rc
 = 
	`sqlôe4ApiExô
(
p
->
db
,Ñc);

397 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

398  
rc
;

399 
	}
}

405 
	$sqlôe4_blob_ª›í
(
sqlôe4_blob
 *
pBlob
, 
sqlôe4_öt64
 
iRow
){

406 
In¸blob
 *
p
 = (In¸blob*)
pBlob
;

407 
rc
;

408 
KVByãAºay
 *
pKeyNew
 = 0;

409 
KVSize
 
nKeyNew
 = 0;

410 
sqlôe4_öt64
 
nByã
 = 0;

412 if–
p
==0 )  
SQLITE4_MISUSE_BKPT
;

414 
	`sqlôe4_muãx_íãr
(
p
->
db
->
muãx
);

416 if–
p
->
zTabÀ
==0 ||Ö->
zCﬁumn
==0 ){

417 
rc
 = 
SQLITE4_MISUSE_BKPT
;

418 
out
;

421 
rc
 = 
	`buûdBlobKey
(
p
->
db
,Ö->
zTabÀ
,Ö->
zCﬁumn
, 
iRow
, &
pKeyNew
, &
nKeyNew
);

422 if–
rc
!=
SQLITE4_OK
 ) 
out
;

424 
rc
 = 
	`kvBlobSize
(
p
->
pSt‹e
, 
pKeyNew
, 
nKeyNew
, &
nByã
);

425 if–
rc
==
SQLITE4_OK
 ){

426 
p
->
nByã
 =ÇByte;

427 }if–
rc
==
SQLITE4_NOTFOUND
 ){

428 if–
p
->
wrFœg
 ){

429 
p
->
nByã
 = -1;

430 
rc
 = 
SQLITE4_OK
;

432 
rc
 = 
SQLITE4_ERROR
;

433 
	`sqlôe4Eº‹
(
p
->
db
, 
rc
, "no such blob forÑeopen (%s.%s.%sÑow=%lld)",

434 (
p
->
zDb
?p->zDb:"maö"),Ö->
zTabÀ
,Ö->
zCﬁumn
, ()
iRow
);

435 
out
;

438 
	`sqlôe4Eº‹
(
p
->
db
, 
rc
, 
NULL
);

439 
out
;

443 if–
p
->
pKey
 ) 
	`sqlôe4DbFªe
’->
db
,Ö->pKey);

444 
p
->
pKey
 = 
pKeyNew
;

445 
p
->
nKey
 = 
nKeyNew
;

446 
pKeyNew
 = 0;

448 
out
:

449 if–
pKeyNew
 ) 
	`sqlôe4DbFªe
(
p
->
db
,ÖKeyNew);

451 
	`sqlôe4Eº‹
(
p
->
db
, 
rc
, 
NULL
);

452 
rc
 = 
	`sqlôe4ApiExô
(
p
->
db
,Ñc);

453 
	`sqlôe4_muãx_Àave
(
p
->
db
->
muãx
);

454  
rc
;

455 
	}
}

	@src/vdbecodec.c

16 
	~"sqlôeI¡.h
"

17 
	~"vdbeI¡.h
"

31 
	sRowDecodî
 {

32 
sqlôe4
 *
	mdb
;

33 
VdbeCurs‹
 *
	mpCur
;

34 
KVCurs‹
 *
	mpKVCur
;

35 c⁄° 
KVByãAºay
 *
	ma
;

36 c⁄° 
KVByãAºay
 *
	maKey
;

37 
KVSize
 
	mn
;

38 
KVSize
 
	mnKey
;

39 
	mmxCﬁ
;

47 
	$sqlôe4VdbeDecodîCª©e
(

48 
sqlôe4
 *
db
,

49 
VdbeCurs‹
 *
pCur
,

50 
KVCurs‹
 *
pKVCur
,

51 
mxCﬁ
,

52 
RowDecodî
 **
µOut


54 
RowDecodî
 *
p
;

56 
	`as£π
–
pCur
==0 || 
pKVCur
==0 );

57 
	`as£π
–
pCur
!=0 || 
pKVCur
!=0 );

58 
p
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (*p));

59 *
µOut
 = 
p
;

60 if–
p
==0 )  
SQLITE4_NOMEM
;

61 
p
->
db
 = db;

62 
p
->
pCur
 =ÖCur;

63 
p
->
pKVCur
 =ÖKVCur;

64 
p
->
mxCﬁ
 = mxCol;

65  
SQLITE4_OK
;

66 
	}
}

72 
	$sqlôe4VdbeDecodîDe°roy
(
RowDecodî
 *
p
){

73 if–
p
 ){

74 
	`sqlôe4DbFªe
(
p
->
db
,Ö);

76  
SQLITE4_OK
;

77 
	}
}

82 
	$decodîFëchD©a
(
RowDecodî
 *
p
){

83 
VdbeCurs‹
 *
pCur
 = 
p
->pCur;

84 
rc
;

85 if–
pCur
==0 ){

86 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
p
->
pKVCur
, 0, -1, &p->
a
, &p->
n
);

87  
rc
;

89 if–
pCur
->
rowChnged
 ){

90 
p
->
a
 = 0;

91 
p
->
aKey
 = 0;

92 
pCur
->
rowChnged
 = 0;

94 if–
p
->
a
 )  
SQLITE4_OK
;

95 
rc
 = 
	`sqlôe4VdbeCurs‹Movëo
(
pCur
);

96 if–
rc
 ) Ñc;

97 if–
pCur
->
nuŒRow
 ){

98 
p
->
a
 = 0;

99 
p
->
n
 = 0;

100  
SQLITE4_OK
;

102 
	`as£π
–
pCur
->
pKVCur
!=0 );

103  
	`sqlôe4KVCurs‹D©a
(
pCur
->
pKVCur
, 0, -1, &
p
->
a
, &p->
n
);

104 
	}
}

109 
	$decodîFëchKey
(
RowDecodî
 *
p
){

110 
VdbeCurs‹
 *
pCur
 = 
p
->pCur;

111 
rc
;

112 if–
pCur
==0 ){

113 
rc
 = 
	`sqlôe4KVCurs‹Key
(
p
->
pKVCur
, &p->
aKey
, &p->
nKey
);

114  
rc
;

116 
	`as£π
–
p
->
a
!=0 );

117 if–
p
->
aKey
 )  
SQLITE4_OK
;

118 
	`as£π
–
pCur
->
pKVCur
!=0 );

119  
	`sqlôe4KVCurs‹Key
(
pCur
->
pKVCur
, &
p
->
aKey
, &p->
nKey
);

120 
	}
}

127 
	$decodîMemSëFromBlob
(

128 c⁄° 
KVByãAºay
 *
a
, 
KVSize
 
n
,

129 
x‹Mask
,

130 
Mem
 *
pOut


132 
rc
;

133 
m
 = 0;

134 
i
, 
j
, 
k
;

136 
	`sqlôe4VdbeMemSëSå
(
pOut
, "", 0, 0, 0, 0);

137 
rc
 = 
	`sqlôe4VdbeMemGrow
(
pOut
, 
n
, 0);

138 if–
rc
==
SQLITE4_OK
 ){

139 
i
 = 0;

140 
j
 = 0;

141 
k
 = 0;

142  
i
<
n
 ){

143 
m
 = (m<<7Ë| ((
a
[
i
++] ^ 
x‹Mask
)&0x7f);

144 
j
 += 7;

145 if–
j
>=8 ){

146 
pOut
->
z
[
k
++] = (
m
>>(
j
-8))&0xff;

147 
j
 -= 8;

150 if–
j
>0 ){

151 
pOut
->
z
[
k
] = 
m
<<(7-
j
);

153 
pOut
->
n
 = 
k
;

155  
rc
;

156 
	}
}

162 
	$sqlôe4VdbeDecodeNumîicKey
(

163 c⁄° 
KVByãAºay
 *
aKey
,

164 
KVSize
 
nKey
,

165 
sqlôe4_num
 *
pVÆ


167 
i
, 
y
;

168 
x‹Mask
 = 0;

169 
e
;

170 
sqlôe4_uöt64
 
m
;

171 
sqlôe4_öt64
 
eBig
;

172 
KVByãAºay
 
aInvîãdKey
[4];

174 
pVÆ
->
≠¥ox
 = 0;

175 
pVÆ
->
sign
 = 0;

176 if–
nKey
<1 )  0;

177  
aKey
[0] ){

180 
pVÆ
->
m
 = 0;

181 
pVÆ
->
e
 = 1000;

186 
pVÆ
->
m
 = 1;

187 
pVÆ
->
sign
 = 1;

188 
pVÆ
->
e
 = 1000;

193 
pVÆ
->
m
 = 0;

194 
pVÆ
->
e
 = 0;

199 
pVÆ
->
m
 = 1;

200 
pVÆ
->
e
 = 1000;

214 
pVÆ
->
sign
 = 1;

215 
x‹Mask
 = 0xff;

216 
e
 = 0x13 - 
aKey
[0];

217 
i
 = 1;

231 
pVÆ
->
sign
 = 1;

232 
e
 = 
aKey
[0] - 0xec;

233 
i
 = 1;

247 
e
 = 
aKey
[0] - 0x17;

248 
i
 = 1;

262 
e
 = 0xe8 - 
aKey
[0];

263 
x‹Mask
 = 0xff;

264 
i
 = 1;

269 
i
 = 1 + 
	`sqlôe4GëV¨öt64
(
aKey
+1, 2, &
eBig
);

270 
e
 = ()-
eBig
;

271 
x‹Mask
 = 0xff;

276 
aInvîãdKey
[0] = 
aKey
[1] ^ 0xff;

277 
aInvîãdKey
[1] = 
aKey
[2] ^ 0xff;

278 
i
 = 1 + 
	`sqlôe4GëV¨öt64
(
aInvîãdKey
, 2, &
eBig
);

279 
e
 = ()-
eBig
;

284 
aInvîãdKey
[0] = 
aKey
[1] ^ 0xff;

285 
aInvîãdKey
[1] = 
aKey
[2] ^ 0xff;

286 
i
 = 1 + 
	`sqlôe4GëV¨öt64
(
aInvîãdKey
, 2, &
eBig
);

287 
e
 = ()
eBig
;

288 
x‹Mask
 = 0xff;

293 
i
 = 1 + 
	`sqlôe4GëV¨öt64
(
aKey
+1, 2, &
eBig
);

294 
e
 = ()
eBig
;

300 
m
 = 0;

302 
y
 = 
aKey
[
i
++] ^ 
x‹Mask
;

303 
m
 = m*100 + 
y
/2;

304 
e
--;

305 } 
y
 & 1 );

306 if–
m
==0 )  0;

308 
pVÆ
->
m
 = m;

309 
pVÆ
->
e
 = 2*e;

310  
i
;

311 
	}
}

322 
	$decodîFromKey
(

323 
RowDecodî
 *
p
,

324 
affRól
,

325 
sqlôe4_öt64
 
iOf°
,

326 
Mem
 *
pOut


328 
rc
;

329 
KVSize
 
i
;

330 
KVSize
 
n
;

331 c⁄° 
KVByãAºay
 *
a
;

332 *
z
;

334 if–
iOf°
<0 ){

335  
SQLITE4_CORRUPT_BKPT
;

337 
rc
 = 
	`decodîFëchKey
(
p
);

338 if–
rc
 ) Ñc;

339 if–
iOf°
>=
p
->
nKey
 ){

340  
SQLITE4_CORRUPT_BKPT
;

342 
a
 = 
p
->
aKey
;

343 
n
 = 
p
->
nKey
;

344  
a
[
iOf°
++] ){

347 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

352 
i
=
iOf°
; i<
n
 && 
a
[i]!=0; i++){}

353 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, &
a
[
iOf°
], 
i
-iOfst,

354 
SQLITE4_UTF8
, 
SQLITE4_TRANSIENT
, 0);

358 
i
=
iOf°
; i<
n
 && 
a
[i]!=0xFF; i++){}

359 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, &
a
[
iOf°
+1], 
n
 = 
i
 - iOfst,

360 
SQLITE4_UTF8
, 
SQLITE4_TRANSIENT
, 0);

361 if–
rc
==
SQLITE4_OK
 ){

362 
z
 = 
pOut
->z;

363 
i
=
n
-1; i>=0; i--Ë*(
z
++) ^= 0xFF;

369 
i
=
iOf°
; i<
n
 && 
a
[i]!=0; i++){}

370 
rc
 = 
	`decodîMemSëFromBlob
(&
a
[
iOf°
], 
i
-iOf°, 0x00, 
pOut
);

374 
i
=
iOf°
; i<
n
 && 
a
[i]!=0xFF; i++){}

375 
rc
 = 
	`decodîMemSëFromBlob
(&
a
[
iOf°
], 
i
-iOf°, 0xFF, 
pOut
);

380 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, &
a
[
iOf°
], 
n
-iOfst, 0,

381 
SQLITE4_TRANSIENT
, 0);

385 
rc
 = 
	`sqlôe4VdbeMemSëSå
(
pOut
, &
a
[
iOf°
], 
n
-iOfst,

386 
SQLITE4_UTF8
, 
SQLITE4_TRANSIENT
, 0);

387 if–
rc
==
SQLITE4_OK
 ){

388 
z
 = 
pOut
->z;

389 
i
=
n
-
iOf°
; i>0; i--Ë*(
z
++) ^= 0xFF;

394 
sqlôe4_num
 
v
;

395 
i
 = 
	`sqlôe4VdbeDecodeNumîicKey
(
a
+
iOf°
-1, 
n
-iOf°+1, &
v
);

396 if–
i
==0 ){

397 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

399 
	`sqlôe4VdbeMemSëNum
(
pOut
, 
v
, 
affRól
 ? 
MEM_Ról
 : 
MEM_I¡
);

400 
rc
 = 
SQLITE4_OK
;

405  
rc
;

406 
	}
}

422 
	$sqlôe4VdbeDecodîGëCﬁumn
(

423 
RowDecodî
 *
p
,

424 
iVÆ
,

425 
Mem
 *
pDeÁu…
,

426 
Mem
 *
pOut


428 
u32
 
size
;

429 
sqlôe4_uöt64
 
of°
;

430 
sqlôe4_uöt64
 
ty≥
;

431 
sqlôe4_uöt64
 
subty≥
;

432 
c˛ass
;

433 
n
;

434 
i
;

435 
sz
;

436 
ídHdr
;

437 
rc
;

439 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

440 
	`as£π
–
iVÆ
<=
p
->
mxCﬁ
 );

441 
rc
 = 
	`decodîFëchD©a
(
p
);

442 if–
rc
 ) Ñc;

443 if–
p
->
a
==0 )  
SQLITE4_OK
;

444 
n
 = 
	`sqlôe4GëV¨öt64
(
p
->
a
,Ö->n, &
of°
);

445 if–
n
==0 )  
SQLITE4_CORRUPT
;

446 
of°
 +
n
;

447 
ídHdr
 = 
of°
;

448 if–
ídHdr
>
p
->
n
 )  
SQLITE4_CORRUPT
;

449 
i
=0; i<=
iVÆ
 && 
n
<
ídHdr
; i++){

450 
sz
 = 
	`sqlôe4GëV¨öt64
(
p
->
a
+
n
,Ö->n-n, &
ty≥
);

451 if–
sz
==0 )  
SQLITE4_CORRUPT
;

452 
n
 +
sz
;

453 if–
ty≥
>=22 ){

454 
c˛ass
 = (
ty≥
-22)%4;

455 if–
c˛ass
==2 ){

456 
size
 = 0;

458 
size
 = (
ty≥
-22)/4;

459 if–
c˛ass
==3 ){

460 
sz
 = 
	`sqlôe4GëV¨öt64
(
p
->
a
+
n
,Ö->n-n, &
subty≥
);

461 if–
sz
==0 )  
SQLITE4_CORRUPT
;

462 
n
 +
sz
;

465 }if–
ty≥
<=2 ){

466 
size
 = 0;

467 }if–
ty≥
<=10 ){

468 
size
 = 
ty≥
 - 2;

470 
	`as£π
–
ty≥
>=11 &&Åype<=21 );

471 
size
 = 
ty≥
 - 9;

473 if–
i
<
iVÆ
 ){

474 
of°
 +
size
;

475 }if–
ty≥
==0 ){

477 }if–
ty≥
<=2 ){

478 
	`sqlôe4VdbeMemSëI¡64
(
pOut
, 
ty≥
-1);

479 }if–
ty≥
<=10 ){

480 
iByã
;

481 
sqlôe4_öt64
 
v
 = ((*)
p
->
a
)[
of°
];

482 
iByã
=1; iByã<
size
; iByte++){

483 
v
 = v*256 + 
p
->
a
[
of°
+
iByã
];

485 
	`sqlôe4VdbeMemSëI¡64
(
pOut
, 
v
);

486 }if–
ty≥
<=21 ){

487 
sqlôe4_num
 
num
 = {0, 0, 0, 0};

488 
sqlôe4_uöt64
 
x
;

489 
e
;

491 
n
 = 
	`sqlôe4GëV¨öt64
(
p
->
a
+
of°
,Ö->n-of°, &
x
);

492 
e
 = ()
x
;

493 
n
 +
	`sqlôe4GëV¨öt64
(
p
->
a
+
of°
+n,Ö->n-(of°+n), &
x
);

494 if–
n
!=
size
 )  
SQLITE4_CORRUPT
;

496 
num
.
m
 = 
x
;

497 
num
.
e
 = (e >> 2);

498 if–
e
 & 0x02 ) 
num
.e = -1 *Çum.e;

499 if–
e
 & 0x01 ) 
num
.
sign
 = 1;

500 
pOut
->
u
.
num
 =Çum;

501 
	`MemSëTy≥Fœg
(
pOut
, 
MEM_Ról
);

502 }if–
c˛ass
==0 ){

503 if–
size
==0 ){

504 
	`sqlôe4VdbeMemSëSå
(
pOut
, "", 0, 
SQLITE4_UTF8
, 
SQLITE4_TRANSIENT
, 0);

505 }if–
p
->
a
[
of°
]>0x02 ){

506 
	`sqlôe4VdbeMemSëSå
(
pOut
, (*)(
p
->
a
+
of°
), 
size
,

507 
SQLITE4_UTF8
, 
SQLITE4_TRANSIENT
, 0);

509 c⁄° 
u8
 
íc
[] = {
SQLITE4_UTF8
,
SQLITE4_UTF16LE
,
SQLITE4_UTF16BE
 };

510 
	`sqlôe4VdbeMemSëSå
(
pOut
, (*)(
p
->
a
+
of°
+1), 
size
-1,

511 
íc
[
p
->
a
[
of°
]], 
SQLITE4_TRANSIENT
, 0);

513 }if–
c˛ass
==2 ){

514 
k
 = (
ty≥
 - 24)/4;

515  
	`decodîFromKey
(
p
, (
k
&1)!=0, k/2, 
pOut
);

517 
	`sqlôe4VdbeMemSëSå
(
pOut
, (*)(
p
->
a
+
of°
), 
size
, 0,

518 
SQLITE4_TRANSIENT
, 0);

519 
pOut
->
íc
 = 
	`ENC
(
p
->
db
);

522 
	`ã°ˇ£
–
i
==
iVÆ
 );

523 
	`ã°ˇ£
–
i
==
iVÆ
+1 );

524 if–
i
<=
iVÆ
 ){

525 if–
pDeÁu…
 ){

526 
	`sqlôe4VdbeMemShÆlowC›y
(
pOut
, 
pDeÁu…
, 
MEM_Sètic
);

528 
	`sqlôe4VdbeMemSëNuŒ
(
pOut
);

531  
SQLITE4_OK
;

532 
	}
}

537 
	$signifiˇ¡Byãs
(
sqlôe4_öt64
 
v
){

538 
sqlôe4_öt64
 
x
;

539 
n
 = 1;

540 if–
v
<0 ){

541 
x
 = -128;

542  
v
<
x
 && 
n
<8 ){Ç++; x *= 256; }

544 
x
 = 127;

545  
v
>
x
 && 
n
<8 ){Ç++; x *= 256; }

547  
n
;

548 
	}
}

561 
	$sqlôe4VdbeEncodeD©a
(

562 
sqlôe4
 *
db
,

563 
Mem
 *
aIn
,

564 *
aPîmuã
,

565 
nIn
,

566 
u8
 **
pzOut
,

567 *
≤Out


569 
i
, 
j
;

570 
rc
 = 
SQLITE4_OK
;

571 
nHdr
;

572 
n
;

573 
u8
 *
aOut
 = 0;

574 
nOut
;

575 
nPaylﬂd
 = 0;

576 
ícodög
 = 
	`ENC
(
db
);

577 
	sdícAux
 {

578 
n
;

579 
u8
 
z
[12];

580 } *
aAux
;

582 
aAux
 = 
	`sqlôe4SèckAŒocZîo
(
db
, (*aAux)*
nIn
);

583 if–
aAux
==0 )  
SQLITE4_NOMEM
;

584 
aOut
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (
nIn
+1)*9);

585 if–
aOut
==0 ){

586 
rc
 = 
SQLITE4_NOMEM
;

587 
vdbeEncodeD©a_îr‹
;

589 
nOut
 = 9;

590 
i
=0; i<
nIn
; i++){

591 
Mem
 *
pIn
 = &
aIn
[ 
aPîmuã
 ?áPîmuã[
i
] : i ];

592 
Êags
 = 
pIn
->flags;

593 if–
Êags
 & 
MEM_NuŒ
 ){

594 
aOut
[
nOut
++] = 0;

595 }if–
Êags
 & 
MEM_I¡
 ){

596 
i64
 
i1
;

597 
i1
 = 
	`sqlôe4_num_to_öt64
(
pIn
->
u
.
num
, 0);

598 
n
 = 
	`signifiˇ¡Byãs
(
i1
);

599 
aOut
[
nOut
++] = 
n
+2;

600 
nPaylﬂd
 +
n
;

601 
aAux
[
i
].
n
 =Ç;

602 }if–
Êags
 & 
MEM_Ról
 ){

603 
sqlôe4_num
 *
p
 = &
pIn
->
u
.
num
;

604 
e
;

605 
	`as£π
–
p
->
sign
==0 ||Ö->sign==1 );

606 if–
p
->
e
<0 ){

607 
e
 = (
p
->e*-4Ë+ 2 +Ö->
sign
;

609 
e
 = (
p
->e*4Ë+Ö->
sign
;

611 
n
 = 
	`sqlôe4PutV¨öt64
(
aAux
[
i
].
z
, (
sqlôe4_uöt64
)
e
);

612 
n
 +
	`sqlôe4PutV¨öt64
(
aAux
[
i
].
z
+n, 
p
->
m
);

613 
aAux
[
i
].
n
 =Ç;

614 
aOut
[
nOut
++] = 
n
+9;

615 
nPaylﬂd
 +
n
;

616 }if–
Êags
 & 
MEM_Så
 ){

617 
n
 = 
pIn
->n;

618 if–
n
 && (
ícodög
!=
SQLITE4_UTF8
 || 
pIn
->
z
[0]<3) )Ç++;

619 
nPaylﬂd
 +
n
;

620 
nOut
 +
	`sqlôe4PutV¨öt64
(
aOut
+nOut, 22+4*(
sqlôe4_öt64
)
n
);

622 
n
 = 
pIn
->n;

623 
	`as£π
–
Êags
 & 
MEM_Blob
 );

624 
nPaylﬂd
 +
n
;

625 
nOut
 +
	`sqlôe4PutV¨öt64
(
aOut
+nOut, 23+4*(
sqlôe4_öt64
)
n
);

628 
nHdr
 = 
nOut
 - 9;

629 
n
 = 
	`sqlôe4PutV¨öt64
(
aOut
, 
nHdr
);

630 
i
=
n
, 
j
=9; j<
nOut
; j++Ë
aOut
[i++] =áOut[j];

631 
nOut
 = 
i
;

632 
aOut
 = 
	`sqlôe4DbRóŒocOrFªe
(
db
,áOut, 
nOut
 + 
nPaylﬂd
);

633 if–
aOut
==0 ){ 
rc
 = 
SQLITE4_NOMEM
; 
vdbeEncodeD©a_îr‹
; }

634 
i
=0; i<
nIn
; i++){

635 
Mem
 *
pIn
 = &
aIn
[ 
aPîmuã
 ?áPîmuã[
i
] : i ];

636 
Êags
 = 
pIn
->flags;

637 if–
Êags
 & 
MEM_NuŒ
 ){

639 }if–
Êags
 & 
MEM_I¡
 ){

640 
sqlôe4_öt64
 
v
;

641 
v
 = 
	`sqlôe4_num_to_öt64
(
pIn
->
u
.
num
, 0);

642 
n
 = 
aAux
[
i
].n;

643 
aOut
[
nOut
+(--
n
)] = 
v
 & 0xff;

644  
n
 ){

645 
v
 >>= 8;

646 
aOut
[
nOut
+(--
n
)] = 
v
 & 0xff;

648 
nOut
 +
aAux
[
i
].
n
;

649 }if–
Êags
 & 
MEM_Ról
 ){

650 
	`mem˝y
(
aOut
+
nOut
, 
aAux
[
i
].
z
,áAux[i].
n
);

651 
nOut
 +
aAux
[
i
].
n
;

652 }if–
Êags
 & 
MEM_Så
 ){

653 
n
 = 
pIn
->n;

654 if–
n
 ){

655 if–
ícodög
==
SQLITE4_UTF16LE
 ) 
aOut
[
nOut
++] = 1;

656 if–
ícodög
==
SQLITE4_UTF16BE
 ) 
aOut
[
nOut
++] = 2;

657 if–
pIn
->
z
[0]<3 ) 
aOut
[
nOut
++] = 0;

658 
	`mem˝y
(
aOut
+
nOut
, 
pIn
->
z
, 
n
);

659 
nOut
 +
n
;

662 
	`as£π
–
Êags
 & 
MEM_Blob
 );

663 
	`mem˝y
(
aOut
+
nOut
, 
pIn
->
z
,ÖIn->
n
);

664 
nOut
 +
pIn
->
n
;

668 *
pzOut
 = 
aOut
;

669 *
≤Out
 = 
nOut
;

670 
	`sqlôe4SèckFªe
(
db
, 
aAux
);

671  
SQLITE4_OK
;

673 
vdbeEncodeD©a_îr‹
:

674 
	`sqlôe4SèckFªe
(
db
, 
aAux
);

675 
	`sqlôe4DbFªe
(
db
, 
aOut
);

676  
rc
;

677 
	}
}

682 
KeyEncodî
 
	tKeyEncodî
;

683 
	sKeyEncodî
 {

684 
sqlôe4
 *
	mdb
;

685 
u8
 *
	maOut
;

686 
	mnOut
;

687 
	mnAŒoc
;

693 
	$íœrgeEncodîAŒoˇti⁄
(
KeyEncodî
 *
p
, 
√eded
){

694 
	`as£π
–
p
->
nOut
<ı->
nAŒoc
 );

695 if–
p
->
nOut
+
√eded
>p->
nAŒoc
 ){

696 
u8
 *
aNew
;

697 
p
->
nAŒoc
 =Ö->nAŒo¯+ 
√eded
 + 10;

698 
aNew
 = 
	`sqlôe4DbRóŒoc
(
p
->
db
,Ö->
aOut
,Ö->
nAŒoc
);

699 if–
aNew
==0 ){

700 
	`sqlôe4DbFªe
(
p
->
db
,Ö->
aOut
);

701 
	`mem£t
(
p
, 0, (*p));

702  
SQLITE4_NOMEM
;

704 
p
->
aOut
 = 
aNew
;

705 
p
->
nAŒoc
 = 
	`sqlôe4DbMÆlocSize
’->
db
,Ö->
aOut
);

707  
SQLITE4_OK
;

708 
	}
}

715 
	$putV¨öt64
(
KeyEncodî
 *
p
, 
sqlôe4_uöt64
 
v
, 
bInvît
){

716 *
z
 = &
p
->
aOut
[p->
nOut
];

717 
n
 = 
	`sqlôe4PutV¨öt64
(
z
, 
v
);

718 if–
bInvît
 ){

719 
i
;

720 
i
=0; i<
n
; i++Ë
z
[i] = ~z[i];

722 
p
->
nOut
 +
n
;

723 
	}
}

728 
	$ícodeNumîicKey
(
KeyEncodî
 *
p
, 
sqlôe4_num
 
num
){

729 if–
num
.
m
==0 ){

730 if–
	`sqlôe4_num_i¢™
(
num
) ){

731 
p
->
aOut
[p->
nOut
++] = 0x06;

733 
p
->
aOut
[p->
nOut
++] = 0x15;

735 }if–
	`sqlôe4_num_isöf
(
num
) ){

736 
p
->
aOut
[p->
nOut
++] = 
num
.
sign
 ? 0x07 : 0x23;

738 
e
;

739 
u64
 
m
;

740 
iDigô
 = 0;

741 
u8
 
aDigô
[12];

743  (
num
.
m
 % 10)==0 ){

744 
num
.
e
++;

745 
num
.
m
 =Çum.m / 10;

747 
m
 = 
num
.m;

748 
e
 = 
num
.e;

750 if–
num
.
e
 % 2 ){

751 
aDigô
[0] = 10 * (
m
 % 10);

752 
m
 = m / 10;

753 
e
--;

754 
iDigô
 = 1;

756 
iDigô
 = 0;

759  
m
 ){

760 
aDigô
[
iDigô
++] = (
m
 % 100);

761 
m
 = m / 100;

763 
e
 = (
iDigô
 + (e/2));

765 if–
e
>=11 ){

766 if–
num
.
sign
==0 ){

767 
p
->
aOut
[p->
nOut
++] = 0x22;

768 
	`putV¨öt64
(
p
, 
e
, 0);

770 
p
->
aOut
[p->
nOut
++] = 0x08;

771 
	`putV¨öt64
(
p
, 
e
, 1);

774 if–
e
>=0 ){

775 if–
num
.
sign
==0 ){

776 
p
->
aOut
[p->
nOut
++] = 0x17+
e
;

778 
p
->
aOut
[p->
nOut
++] = 0x13-
e
;

782 if–
num
.
sign
==0 ){

783 
p
->
aOut
[p->
nOut
++] = 0x16;

784 
	`putV¨öt64
(
p
, -1*
e
, 1);

786 
p
->
aOut
[p->
nOut
++] = 0x14;

787 
	`putV¨öt64
(
p
, -1*
e
, 0);

792  (
iDigô
--)>0 ){

793 
u8
 
d
 = 
aDigô
[
iDigô
]*2;

794 if–
iDigô
!=0 ) 
d
 |= 0x01;

795 if–
num
.
sign
 ) 
d
 = ~d;

796 
p
->
aOut
[p->
nOut
++] = 
d
;

799 
	}
}

806 
	$sqlôe4VdbeEncodeI¡Key
(
u8
 *
a
, 
sqlôe4_öt64
 
v
){

807 
KeyEncodî
 
s
;

808 
sqlôe4_num
 
num
;

810 
num
 = 
	`sqlôe4_num_‰om_öt64
(
v
);

811 
	`mem£t
(&
s
, 0, (s));

812 
s
.
aOut
 = 
a
;

813 
	`ícodeNumîicKey
(&
s
, 
num
);

814  
s
.
nOut
;

815 
	}
}

820 
	$ícodeO√KeyVÆue
(

821 
KeyEncodî
 *
p
,

822 
Mem
 *
pMem
,

823 
u8
 
s‹tOrdî
,

824 
u8
 
isLa°VÆue
,

825 
CﬁlSeq
 *
pCﬁl


827 
Êags
 = 
pMem
->flags;

828 
i
;

829 
n
;

830 
iSèπ
 = 
p
->
nOut
;

831 if–
Êags
 & 
MEM_NuŒ
 ){

832 if–
	`íœrgeEncodîAŒoˇti⁄
(
p
, 1ËË 
SQLITE4_NOMEM
;

833 
p
->
aOut
[p->
nOut
++] = 0x05;

835 if–
Êags
 & (
MEM_Ról
|
MEM_I¡
) ){

836 if–
	`íœrgeEncodîAŒoˇti⁄
(
p
, 16ËË 
SQLITE4_NOMEM
;

837 
	`ícodeNumîicKey
(
p
, 
pMem
->
u
.
num
);

838 }if–
Êags
 & 
MEM_Så
 ){

839 
íc
;

841 
	`as£π
–
pMem
->
íc
==
SQLITE4_UTF8


842 || 
pMem
->
íc
==
SQLITE4_UTF16LE


843 || 
pMem
->
íc
==
SQLITE4_UTF16BE


845 
	`as£π
–
pMem
->
db
 );

846 
íc
 = 
pMem
->enc;

849 if–
	`íœrgeEncodîAŒoˇti⁄
(
p
, 
pMem
->
n
*4 + 2ËË 
SQLITE4_NOMEM
;

850 
p
->
aOut
[p->
nOut
++] = 0x24;

851 if–
pCﬁl
==0 ||ÖCﬁl->
xMkKey
==0 ){

852 c⁄° *
z
 = (c⁄° *)
	`sqlôe4VÆueText
(
pMem
, 
SQLITE4_UTF8
);

853 if–
z
 ){

854 c⁄° *
zC§
 = 
z
;

855 c⁄° *
zEnd
 = &
z
[
pMem
->
n
];

856  *
zC§
 && zC§<
zEnd
 ) zCsr++;

857 
	`mem˝y
(
p
->
aOut
+p->
nOut
, 
z
, (
zC§
-z));

858 
p
->
nOut
 +(
zC§
-
z
);

861 
rc
;

862 
nReq
;

863 
nSpc
;

865 
nSpc
 = 
p
->
nAŒoc
-p->
nOut
;

866 
rc
 = 
pCﬁl
->
	`xMkKey
’Cﬁl->
pU£r
, 
pMem
, 
nSpc
, 
p
->
aOut
+p->
nOut
, &
nReq
);

867 if–
rc
!=
SQLITE4_OK
 ) Ñc;

868 if–
nReq
+1>
nSpc
 ){

869 if–
	`íœrgeEncodîAŒoˇti⁄
(
p
, 
nReq
+1ËË 
SQLITE4_NOMEM
;

870 
rc
 = 
pCﬁl
->
	`xMkKey
’Cﬁl->
pU£r
, 
pMem
, 
nReq
, 
p
->
aOut
+p->
nOut
, &nReq);

872 
p
->
nOut
 +
nReq
;

874 
p
->
aOut
[p->
nOut
++] = 0x00;

878 
	`sqlôe4VdbeCh™geEncodög
(
pMem
, 
íc
);

880 }if–
isLa°VÆue
 ){

882 
	`as£π
–
Êags
 & 
MEM_Blob
 );

883 if–
	`íœrgeEncodîAŒoˇti⁄
(
p
, 
pMem
->
n
+1ËË 
SQLITE4_NOMEM
;

884 
p
->
aOut
[p->
nOut
++] = 0x26;

885 
	`mem˝y
(
p
->
aOut
+p->
nOut
, 
pMem
->
z
,ÖMem->
n
);

886 
p
->
nOut
 +
pMem
->
n
;

889 c⁄° *
a
;

890 
s
, 
t
;

891 
	`as£π
–
Êags
 & 
MEM_Blob
 );

892 
n
 = 
pMem
->n;

893 
a
 = (
u8
*)
pMem
->
z
;

894 
s
 = 1;

895 
t
 = 0;

896 if–
	`íœrgeEncodîAŒoˇti⁄
(
p
, (
n
*8+6)/7 + 2ËË 
SQLITE4_NOMEM
;

897 
p
->
aOut
[p->
nOut
++] = 0x25;

898 
i
=0; i<
n
; i++){

899 
x
 = 
a
[
i
];

900 
p
->
aOut
[p->
nOut
++] = 0x80 | 
t
 | (
x
>>
s
);

901 if–
s
<7 ){

902 
t
 = 
x
<<(7-
s
);

903 
s
++;

905 
p
->
aOut
[p->
nOut
++] = 0x80 | 
x
;

906 
s
 = 1;

907 
t
 = 0;

910 if–
s
>1 ) 
p
->
aOut
[p->
nOut
++] = 0x80 | 
t
;

911 
p
->
aOut
[p->
nOut
++] = 0x00;

913 if–
s‹tOrdî
==
SQLITE4_SO_DESC
 ){

914 
i
=
iSèπ
; i<
p
->
nOut
; i++Ëp->
aOut
[i] ^= 0xff;

916 
	`as£π
–
p
->
nOut
<ı->
nAŒoc
 );

917  
SQLITE4_OK
;

918 
	}
}

925 
	$sqlôe4VdbeSh‹tKey
(

926 c⁄° 
u8
 *
aKey
,

927 
nKey
,

928 
nFõld
,

929 *
≤Out


931 
u8
 *
p
 = (u8*)
aKey
;

932 
u8
 *
pEnd
 = (u8*)&
aKey
[
nKey
];

933 
u64
 
dummy
;

934 
i
;

937 
p
 +
	`sqlôe4GëV¨öt64
’, 
pEnd
-p, &
dummy
);

939 
i
=0; i<
nFõld
 && 
p
<
pEnd
; i++){

940 
u8
 
c
 = *(
p
++);

941  
c
 ){

952  *(
p
++) );

957  (0xFF!=*(
p
++)) );

962 
p
 = 
pEnd
;

969 
u8
 
d
;

974 if–
c
==0x16 || c==0x08 || c==0xDD || c==0xEB ){

975 
d
 = ~(*(
p
++));

977 
d
 = *(
p
++);

979 if–
d
>240 ){

980 
p
++;

981 if–
d
>248 ) 
p
 += (d - 248);

988 if–
c
<0x15 || (c>0xDC && c<0xEA) ){

989  !((*
p
++) & 0x01) );

991  ((*
p
++) & 0x01) );

996 if–
p
>
pEnd
 ) ;

998 if–
≤Out
 ) *≤Ouà
i
;

1000  (
p
 - 
aKey
);

1001 
	}
}

1009 
	$sqlôe4VdbeEncodeKey
(

1010 
sqlôe4
 *
db
,

1011 
Mem
 *
aIn
,

1012 
nIn
,

1013 
iTabno
,

1014 
KeyInfo
 *
pKeyInfo
,

1015 
u8
 **
∑Out
,

1016 *
≤Out
,

1017 
nExåa


1019 
i
;

1020 
rc
 = 
SQLITE4_OK
;

1021 
KeyEncodî
 
x
;

1022 
u8
 *
so
;

1023 
CﬁlSeq
 **
aCﬁl
;

1025 
	`as£π
–
pKeyInfo
 );

1026 
	`as£π
–
nIn
<=
pKeyInfo
->
nFõld
 );

1028 
x
.
db
 = db;

1029 
x
.
aOut
 = 0;

1030 
x
.
nOut
 = 0;

1031 
x
.
nAŒoc
 = 0;

1032 *
∑Out
 = 0;

1033 *
≤Out
 = 0;

1035 if–
	`íœrgeEncodîAŒoˇti⁄
(&
x
, (
nIn
+1)*10ËË 
SQLITE4_NOMEM
;

1036 if–
iTabno
>=0 ){

1037 
x
.
nOut
 = 
	`sqlôe4PutV¨öt64
(x.
aOut
, 
iTabno
);

1039 
aCﬁl
 = 
pKeyInfo
->aColl;

1040 
so
 = 
pKeyInfo
->
aS‹tOrdî
;

1041 
i
=0; i<
nIn
 && 
rc
==
SQLITE4_OK
; i++){

1042 
rc
 = 
	`ícodeO√KeyVÆue
(&
x
, 
aIn
+
i
, 
so
 ? so[i] : 
SQLITE4_SO_ASC
,

1043 
i
==
pKeyInfo
->
nFõld
-1, 
aCﬁl
[i]);

1046 if–
rc
==
SQLITE4_OK
 && 
nExåa
 ){Ñ¯
	`íœrgeEncodîAŒoˇti⁄
(&
x
,ÇExtra); }

1047 if–
rc
 ){

1048 
	`sqlôe4DbFªe
(
db
, 
x
.
aOut
);

1050 *
∑Out
 = 
x
.
aOut
;

1051 *
≤Out
 = 
x
.
nOut
;

1053  
rc
;

1054 
	}
}

	@src/vdbecursor.c

23 
	~"sqlôeI¡.h
"

24 
	~"vdbeI¡.h
"

34 
	$sqlôe4VdbeSìkEnd
(
VdbeCurs‹
 *
pC
, 
iEnd
){

35 
KVCurs‹
 *
pCur
 = 
pC
->
pKVCur
;

36 
rc
;

37 
KVSize
 
nProbe
;

38 
KVByãAºay
 
aProbe
[16];

40 
	`as£π
–
iEnd
==(+1) || iEnd==(-1) || iEnd==(-2) );

41 if–
pC
->
iRoŸ
==
KVSTORE_ROOT
 ){

42 if–
iEnd
>0 ){

43 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, (c⁄° 
KVByãAºay
 *)"\00", 1, 
iEnd
);

45 
nProbe
 = 
	`sqlôe4PutV¨öt64
(
aProbe
, 
LARGEST_INT64
);

46 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
aProbe
, 
nProbe
, 
iEnd
);

48 if–
rc
==
SQLITE4_INEXACT
 )Ñ¯
SQLITE4_OK
;

50 c⁄° 
KVByãAºay
 *
aKey
;

51 
KVSize
 
nKey
;

53 
nProbe
 = 
	`sqlôe4PutV¨öt64
(
aProbe
, 
pC
->
iRoŸ
);

54 
aProbe
[
nProbe
] = 0xFF;

56 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pCur
, 
aProbe
, 
nProbe
+(
iEnd
<0), iEnd);

57 if–
rc
==
SQLITE4_OK
 ){

58 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

59 }if–
rc
==
SQLITE4_INEXACT
 ){

60 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pCur
, &
aKey
, &
nKey
);

61 if–
rc
==
SQLITE4_OK
 && (
nKey
<
nProbe
 || 
	`memcmp
(
aKey
, 
aProbe
,ÇProbe)!=0) ){

62 
rc
 = 
SQLITE4_NOTFOUND
;

65 
pC
->
rowChnged
 = 1;

68  
rc
;

69 
	}
}

75 
	$sqlôe4VdbeNext
(
VdbeCurs‹
 *
pC
){

76 
KVCurs‹
 *
pCur
 = 
pC
->
pKVCur
;

77 c⁄° 
KVByãAºay
 *
aKey
;

78 
KVSize
 
nKey
;

79 
rc
;

80 
sqlôe4_uöt64
 
iTabno
;

82 
rc
 = 
	`sqlôe4KVCurs‹Next
(
pCur
);

83 if–
rc
==
SQLITE4_OK
 && 
pC
->
iRoŸ
!=
KVSTORE_ROOT
 ){

84 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pCur
, &
aKey
, &
nKey
);

85 if–
rc
==
SQLITE4_OK
 ){

86 
iTabno
 = 0;

87 
	`sqlôe4GëV¨öt64
(
aKey
, 
nKey
, &
iTabno
);

88 if–
iTabno
!=
pC
->
iRoŸ
 ) 
rc
 = 
SQLITE4_NOTFOUND
;

91 
pC
->
rowChnged
 = 1;

92  
rc
;

93 
	}
}

99 
	$sqlôe4VdbePªvious
(
VdbeCurs‹
 *
pC
){

100 
KVCurs‹
 *
pCur
 = 
pC
->
pKVCur
;

101 c⁄° 
KVByãAºay
 *
aKey
;

102 
KVSize
 
nKey
;

103 
rc
;

104 
sqlôe4_uöt64
 
iTabno
;

106 
rc
 = 
	`sqlôe4KVCurs‹Pªv
(
pCur
);

107 if–
rc
==
SQLITE4_OK
 && 
pC
->
iRoŸ
!=
KVSTORE_ROOT
 ){

108 
rc
 = 
	`sqlôe4KVCurs‹Key
(
pCur
, &
aKey
, &
nKey
);

109 if–
rc
==
SQLITE4_OK
 ){

110 
iTabno
 = 0;

111 
	`sqlôe4GëV¨öt64
(
aKey
, 
nKey
, &
iTabno
);

112 if–
iTabno
!=
pC
->
iRoŸ
 ) 
rc
 = 
SQLITE4_NOTFOUND
;

115 
pC
->
rowChnged
 = 1;

116  
rc
;

117 
	}
}

124 
	$sqlôe4VdbeFªeCurs‹
(
VdbeCurs‹
 *
pCx
){

125 if–
pCx
==0 ){

128 
	`sqlôe4Fts5Clo£
(
pCx
->
pFts
);

129 if–
pCx
->
pKVCur
 ){

130 
	`sqlôe4KVCurs‹Clo£
(
pCx
->
pKVCur
);

132 if–
pCx
->
pTmpKV
 ){

133 
	`sqlôe4KVSt‹eClo£
(
pCx
->
pTmpKV
);

135 if–
pCx
->
pDecodî
 ){

136 
	`sqlôe4VdbeDecodîDe°roy
(
pCx
->
pDecodî
);

137 
pCx
->
pDecodî
 = 0;

139 
	`sqlôe4_buf„r_˛ór
(&
pCx
->
sSìkKey
);

140 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


141 if–
pCx
->
pVèbCurs‹
 ){

142 
sqlôe4_vèb_curs‹
 *
pVèbCurs‹
 = 
pCx
->pVtabCursor;

143 c⁄° 
sqlôe4_moduÀ
 *
pModuÀ
 = 
pCx
->pModule;

144 
p
->
öVèbMëhod
 = 1;

145 
pModuÀ
->
	`xClo£
(
pVèbCurs‹
);

146 
p
->
öVèbMëhod
 = 0;

149 
	}
}

160 
	$sqlôe4VdbeCurs‹Movëo
(
VdbeCurs‹
 *
pPk
){

161 
rc
 = 
SQLITE4_OK
;

162 if–
pPk
->
sSìkKey
.
n
!=0 ){

163 
	`as£π
–
pPk
->
pKeyInfo
->
nPK
==0 );

164 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
pPk
->
pKVCur
,ÖPk->
sSìkKey
.
p
,ÖPk->sSìkKey.
n
, 0);

165 if–
rc
==
SQLITE4_NOTFOUND
 ){

166 
rc
 = 
SQLITE4_CORRUPT_BKPT
;

168 
pPk
->
nuŒRow
 = 0;

169 
pPk
->
sSìkKey
.
n
 = 0;

170 
pPk
->
rowChnged
 = 1;

172  
rc
;

173 
	}
}

	@src/vdbemem.c

18 
	~"sqlôeI¡.h
"

19 
	~"vdbeI¡.h
"

34 
	$sqlôe4VdbeCh™geEncodög
(
Mem
 *
pMem
, 
desúedEnc
){

35 
rc
;

36 
	`as£π
–(
pMem
->
Êags
&
MEM_RowSë
)==0 );

37 
	`as£π
–
desúedEnc
==
SQLITE4_UTF8
 || desúedEnc==
SQLITE4_UTF16LE


38 || 
desúedEnc
==
SQLITE4_UTF16BE
 );

39 if–!(
pMem
->
Êags
&
MEM_Så
Ë||ÖMem->
íc
==
desúedEnc
 ){

40  
SQLITE4_OK
;

42 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

43 #ifde‡
SQLITE4_OMIT_UTF16


44  
SQLITE4_ERROR
;

50 
rc
 = 
	`sqlôe4VdbeMemTøn¶©e
(
pMem
, (
u8
)
desúedEnc
);

51 
	`as£π
(
rc
==
SQLITE4_OK
 ||Ñc==
SQLITE4_NOMEM
);

52 
	`as£π
(
rc
==
SQLITE4_OK
 || 
pMem
->
íc
!=
desúedEnc
);

53 
	`as£π
(
rc
==
SQLITE4_NOMEM
 || 
pMem
->
íc
==
desúedEnc
);

54  
rc
;

56 
	}
}

71 
	$sqlôe4VdbeMemGrow
(
Mem
 *
pMem
, 
n
, 
¥e£rve
){

72 
	`as£π
( 1 >=

73 ((
pMem
->
zMÆloc
 &&ÖMem->zMÆloc=ıMem->
z
) ? 1 : 0) +

74 (((
pMem
->
Êags
&
MEM_Dyn
)&&pMem->
xDñ
) ? 1 : 0) +

75 ((
pMem
->
Êags
&
MEM_Ephem
) ? 1 : 0) +

76 ((
pMem
->
Êags
&
MEM_Sètic
) ? 1 : 0)

78 
	`as£π
–(
pMem
->
Êags
&
MEM_RowSë
)==0 );

80 if–
n
<32 )Ç = 32;

81 if–
	`sqlôe4DbMÆlocSize
(
pMem
->
db
,ÖMem->
zMÆloc
)<
n
 ){

82 if–
¥e£rve
 && 
pMem
->
z
=ıMem->
zMÆloc
 ){

83 
pMem
->
z
 =ÖMem->
zMÆloc
 = 
	`sqlôe4DbRóŒocOrFªe
’Mem->
db
,ÖMem->z, 
n
);

84 
¥e£rve
 = 0;

86 
	`sqlôe4DbFªe
(
pMem
->
db
,ÖMem->
zMÆloc
);

87 
pMem
->
zMÆloc
 = 
	`sqlôe4DbMÆlocRaw
’Mem->
db
, 
n
);

91 if–
pMem
->
z
 && 
¥e£rve
 &&ÖMem->
zMÆloc
 &&ÖMem->z!=pMem->zMalloc ){

92 
	`mem˝y
(
pMem
->
zMÆloc
,ÖMem->
z
,ÖMem->
n
);

94 if–
pMem
->
Êags
&
MEM_Dyn
 &&ÖMem->
xDñ
 ){

95 
	`as£π
–
pMem
->
xDñ
!=
SQLITE4_DYNAMIC
 );

96 
pMem
->
	`xDñ
’Mem->
pDñArg
, (*)’Mem->
z
));

99 
pMem
->
z
 =ÖMem->
zMÆloc
;

100 if–
pMem
->
z
==0 ){

101 
pMem
->
Êags
 = 
MEM_NuŒ
;

103 
pMem
->
Êags
 &~(
MEM_Ephem
|
MEM_Sètic
);

105 
pMem
->
xDñ
 = 0;

106  (
pMem
->
z
 ? 
SQLITE4_OK
 : 
SQLITE4_NOMEM
);

107 
	}
}

117 
	$sqlôe4VdbeMemMakeWrôóbÀ
(
Mem
 *
pMem
){

118 
f
;

119 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

120 
	`as£π
–(
pMem
->
Êags
&
MEM_RowSë
)==0 );

121 
f
 = 
pMem
->
Êags
;

122 if–(
f
&(
MEM_Så
|
MEM_Blob
)Ë&& 
pMem
->
z
!ıMem->
zMÆloc
 ){

123 if–
	`sqlôe4VdbeMemGrow
(
pMem
,ÖMem->
n
 + 2, 1) ){

124  
SQLITE4_NOMEM
;

126 
pMem
->
z
[pMem->
n
] = 0;

127 
pMem
->
z
[pMem->
n
+1] = 0;

128 
pMem
->
Êags
 |
MEM_Tîm
;

129 #ifde‡
SQLITE4_DEBUG


130 
pMem
->
pSc›yFrom
 = 0;

134  
SQLITE4_OK
;

135 
	}
}

141 
	$sqlôe4VdbeMemNulTîmö©e
(
Mem
 *
pMem
){

142 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

143 if–(
pMem
->
Êags
 & 
MEM_Tîm
)!=0 || (pMem->Êag†& 
MEM_Så
)==0 ){

144  
SQLITE4_OK
;

146 if–
	`sqlôe4VdbeMemGrow
(
pMem
,ÖMem->
n
+2, 1) ){

147  
SQLITE4_NOMEM
;

149 
pMem
->
z
[pMem->
n
] = 0;

150 
pMem
->
z
[pMem->
n
+1] = 0;

151 
pMem
->
Êags
 |
MEM_Tîm
;

152  
SQLITE4_OK
;

153 
	}
}

168 
	$sqlôe4VdbeMemSåögify
(
Mem
 *
pMem
, 
íc
){

169 
rc
 = 
SQLITE4_OK
;

170 
fg
 = 
pMem
->
Êags
;

171 c⁄° 
nByã
 = 32;

173 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

174 
	`as£π
–!(
fg
&(
MEM_Så
|
MEM_Blob
)) );

175 
	`as£π
–
fg
&(
MEM_I¡
|
MEM_Ról
) );

176 
	`as£π
–(
pMem
->
Êags
&
MEM_RowSë
)==0 );

177 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pMem
) );

179 if–
	`sqlôe4VdbeMemGrow
(
pMem
, 
nByã
, 0) ){

180  
SQLITE4_NOMEM
;

189 
	`sqlôe4_num_to_ãxt
(
pMem
->
u
.
num
,ÖMem->
z
, (pMem->
Êags
 & 
MEM_I¡
)==0);

191 
pMem
->
n
 = 
	`sqlôe4SåÀn30
’Mem->
z
);

192 
pMem
->
íc
 = 
SQLITE4_UTF8
;

193 
pMem
->
Êags
 |
MEM_Så
|
MEM_Tîm
;

194 
	`sqlôe4VdbeCh™geEncodög
(
pMem
, 
íc
);

195  
rc
;

196 
	}
}

206 
	$sqlôe4VdbeMemFöÆize
(
Mem
 *
pMem
, 
FuncDef
 *
pFunc
){

207 
rc
 = 
SQLITE4_OK
;

208 if–
	`ALWAYS
(
pFunc
 &&ÖFunc->
xFöÆize
) ){

209 
sqlôe4_c⁄ãxt
 
˘x
;

210 
	`as£π
–(
pMem
->
Êags
 & 
MEM_NuŒ
)!=0 || 
pFunc
=ıMem->
u
.
pDef
 );

211 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

212 
	`mem£t
(&
˘x
, 0, (ctx));

213 
˘x
.
s
.
Êags
 = 
MEM_NuŒ
;

214 
˘x
.
s
.
db
 = 
pMem
->db;

215 
˘x
.
pMem
 =ÖMem;

216 
˘x
.
pFunc
 =ÖFunc;

217 
pFunc
->
	`xFöÆize
(&
˘x
);

218 
	`as£π
–0==(
pMem
->
Êags
&
MEM_Dyn
Ë&& !pMem->
xDñ
 );

219 
	`sqlôe4DbFªe
(
pMem
->
db
,ÖMem->
zMÆloc
);

220 
	`mem˝y
(
pMem
, &
˘x
.
s
, (ctx.s));

221 
rc
 = 
˘x
.
isEº‹
;

223  
rc
;

224 
	}
}

231 
	$sqlôe4VdbeMemRñó£Exã∫Æ
(
Mem
 *
p
){

232 
	`as£π
–
p
->
db
==0 || 
	`sqlôe4_muãx_hñd
’->db->
muãx
) );

233 if–
p
->
Êags
&
MEM_Agg
 ){

234 
	`sqlôe4VdbeMemFöÆize
(
p
,Ö->
u
.
pDef
);

235 
	`as£π
–(
p
->
Êags
 & 
MEM_Agg
)==0 );

236 
	`sqlôe4VdbeMemRñó£
(
p
);

237 }if–
p
->
Êags
&
MEM_Dyn
 &&Ö->
xDñ
 ){

238 
	`as£π
–(
p
->
Êags
&
MEM_RowSë
)==0 );

239 
	`as£π
–
p
->
xDñ
!=
SQLITE4_DYNAMIC
 );

240 
p
->
	`xDñ
’->
pDñArg
, (*Ì->
z
);

241 
p
->
xDñ
 = 0;

242 }if–
p
->
Êags
&
MEM_RowSë
 ){

243 
	`sqlôe4RowSëCÀ¨
(
p
->
u
.
pRowSë
);

244 }if–
p
->
Êags
&
MEM_Føme
 ){

245 
	`sqlôe4VdbeMemSëNuŒ
(
p
);

247 
	}
}

254 
	$sqlôe4VdbeMemRñó£
(
Mem
 *
p
){

255 
	`VdbeMemRñó£
(
p
);

256 
	`sqlôe4DbFªe
(
p
->
db
,Ö->
zMÆloc
);

257 
p
->
z
 = 0;

258 
p
->
zMÆloc
 = 0;

259 
p
->
xDñ
 = 0;

260 
	}
}

273 
i64
 
	$sqlôe4VdbeI¡VÆue
(
Mem
 *
pMem
){

274 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

275 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pMem
) );

276  
	`sqlôe4_num_to_öt64
(
	`sqlôe4VdbeNumVÆue
(
pMem
), 0);

277 
	}
}

285 
	$sqlôe4VdbeRólVÆue
(
Mem
 *
pMem
){

286 
rVÆ
 = 0.0;

287 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

288 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pMem
) );

289 
	`sqlôe4_num_to_doubÀ
(
	`sqlôe4VdbeNumVÆue
(
pMem
), &
rVÆ
);

290  
rVÆ
;

291 
	}
}

297 
sqlôe4_num
 
	$sqlôe4VdbeNumVÆue
(
Mem
 *
pMem
){

298 if–
pMem
->
Êags
 & (
MEM_Ról
|
MEM_I¡
) ){

299  
pMem
->
u
.
num
;

300 }if–
pMem
->
Êags
 & (
MEM_Så
|
MEM_Blob
) ){

301 
Êags
 = 
SQLITE4_PREFIX_ONLY
 | 
SQLITE4_IGNORE_WHITESPACE
 | 
pMem
->
íc
;

302  
	`sqlôe4_num_‰om_ãxt
(
pMem
->
z
,ÖMem->
n
, 
Êags
, 0);

304 
sqlôe4_num
 
zîo
 = {0,0,0,0};

305  
zîo
;

307 
	}
}

313 
	$sqlôe4VdbeI¡egîAfföôy
(
Mem
 *
pMem
){

314 
i64
 
i
;

315 
bLossy
;

317 
	`as£π
–
pMem
->
Êags
 & 
MEM_Ról
 );

318 
	`as£π
–(
pMem
->
Êags
 & 
MEM_RowSë
)==0 );

319 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

320 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pMem
) );

322 
i
 = 
	`sqlôe4_num_to_öt64
(
pMem
->
u
.
num
, &
bLossy
);

323 if–
bLossy
==0 ){

324 
	`MemSëTy≥Fœg
(
pMem
, 
MEM_I¡
);

325 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
i
);

327 
	}
}

332 
	$sqlôe4VdbeMemI¡egîify
(
Mem
 *
pMem
){

333 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

334 
	`as£π
–(
pMem
->
Êags
 & 
MEM_RowSë
)==0 );

335 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
pMem
) );

337 if–(
pMem
->
Êags
 & 
MEM_I¡
)==0 ){

338 if–
pMem
->
Êags
 & (
MEM_Ról
|
MEM_NuŒ
) ){

339 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
	`sqlôe4VdbeI¡VÆue
(pMem));

341 
Êags
 = 
pMem
->
íc
 |

342 
SQLITE4_INTEGER_ONLY
|
SQLITE4_PREFIX_ONLY
|
SQLITE4_IGNORE_WHITESPACE
;

343 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_ãxt
’Mem->
z
,ÖMem->
n
, 
Êags
, 0);

345 
	`MemSëTy≥Fœg
(
pMem
, 
MEM_I¡
);

347  
SQLITE4_OK
;

348 
	}
}

358 
	$sqlôe4VdbeMemNumîify
(
Mem
 *
pMem
){

359 if–(
pMem
->
Êags
 & (
MEM_I¡
|
MEM_Ról
|
MEM_NuŒ
))==0 ){

360 
bRól
 = 0;

361 
Êags
 = (
pMem
->
íc
 | 
SQLITE4_PREFIX_ONLY
 | 
SQLITE4_IGNORE_WHITESPACE
);

363 
	`as£π
–(
pMem
->
Êags
 & (
MEM_Blob
|
MEM_Så
))!=0 );

364 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

365 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_ãxt
’Mem->
z
,ÖMem->
n
, 
Êags
, 0);

366 
	`sqlôe4_num_to_öt64
(
pMem
->
u
.
num
, &
bRól
);

367 
	`MemSëTy≥Fœg
(
pMem
, (
bRól
 ? 
MEM_Ról
 : 
MEM_I¡
));

369 
	`as£π
–(
pMem
->
Êags
 & (
MEM_I¡
|
MEM_Ról
|
MEM_NuŒ
))!=0 );

370 
pMem
->
Êags
 &~(
MEM_Så
|
MEM_Blob
);

371  
SQLITE4_OK
;

372 
	}
}

377 
	$sqlôe4VdbeMemSëNuŒ
(
Mem
 *
pMem
){

378 if–
pMem
->
Êags
 & 
MEM_Føme
 ){

379 
VdbeFøme
 *
pFøme
 = 
pMem
->
u
.pFrame;

380 
pFøme
->
pP¨ít
 =ÖFøme->
v
->
pDñFøme
;

381 
pFøme
->
v
->
pDñFøme
 =ÖFrame;

382 }if–
pMem
->
Êags
 & 
MEM_RowSë
 ){

383 
	`sqlôe4RowSëCÀ¨
(
pMem
->
u
.
pRowSë
);

385 
	`MemSëTy≥Fœg
(
pMem
, 
MEM_NuŒ
);

386 
pMem
->
ty≥
 = 
SQLITE4_NULL
;

387 
	}
}

393 
	$sqlôe4VdbeMemSëI¡64
(
Mem
 *
pMem
, 
i64
 
vÆ
){

394 
	`sqlôe4VdbeMemRñó£
(
pMem
);

395 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_öt64
(
vÆ
);

396 
pMem
->
Êags
 = 
MEM_I¡
;

397 
pMem
->
ty≥
 = 
SQLITE4_INTEGER
;

398 
	}
}

400 
	$sqlôe4VdbeMemSëNum
(
Mem
 *
pMem
, 
sqlôe4_num
 
vÆ
, 
Êag
){

401 
	`as£π
–
Êag
==
MEM_I¡
 || fœg==
MEM_Ról
 );

402 
	`sqlôe4VdbeMemRñó£
(
pMem
);

403 
pMem
->
u
.
num
 = 
vÆ
;

404 
pMem
->
Êags
 = 
Êag
;

405 
	`sqlôe4VdbeMemSt‹eTy≥
(
pMem
);

406 
	}
}

408 #i‚de‡
SQLITE4_OMIT_FLOATING_POINT


413 
	$sqlôe4VdbeMemSëDoubÀ
(
Mem
 *
pMem
, 
vÆ
){

414 if–
	`sqlôe4IsNaN
(
vÆ
) ){

415 
	`sqlôe4VdbeMemSëNuŒ
(
pMem
);

417 
	`sqlôe4VdbeMemRñó£
(
pMem
);

418 
pMem
->
u
.
num
 = 
	`sqlôe4_num_‰om_doubÀ
(
vÆ
);

419 
pMem
->
Êags
 = 
MEM_Ról
;

420 
pMem
->
ty≥
 = 
SQLITE4_FLOAT
;

422 
	}
}

425 #i‚de‡
SQLITE4_OMIT_INCRBLOB


426 
	$sqlôe4VdbeMemSëZîoBlob
(
Mem
 *
pMem
, 
n
){

427 
	`sqlôe4VdbeMemRñó£
(
pMem
);

428 
pMem
->
Êags
 = 
MEM_Blob
;

429 
pMem
->
n
 = 0;

430 if–
n
<0 )Ç = 0;

432 
pMem
->
íc
 = 
SQLITE4_UTF8
;

433 
pMem
->
z
 = 0;

434 
	}
}

436 
	$sqlôe4VdbeMemSëZîoBlob
(
Mem
 *
pMem
, 
n
){

437 
nByã
 = 
n
>0?n:1;

438 if–
	`sqlôe4VdbeMemGrow
(
pMem
, 
nByã
, 0) ){

439  
SQLITE4_NOMEM_BKPT
;

441 
	`as£π
–
pMem
->
z
!=0 );

442 
	`as£π
–
	`sqlôe4DbMÆlocSize
(
pMem
->
db
,ÖMem->
z
)>=
nByã
 );

443 
	`mem£t
(
pMem
->
z
, 0, 
nByã
);

444 
pMem
->
n
 =Ç>0?n:0;

445 
pMem
->
Êags
 = 
MEM_Blob
;

446 
pMem
->
íc
 = 
SQLITE4_UTF8
;

447  
SQLITE4_OK
;

448 
	}
}

456 
	$sqlôe4VdbeMemSëRowSë
(
Mem
 *
pMem
){

457 
sqlôe4
 *
db
 = 
pMem
->db;

458 
	`as£π
–
db
!=0 );

459 
	`as£π
–(
pMem
->
Êags
 & 
MEM_RowSë
)==0 );

460 
	`sqlôe4VdbeMemRñó£
(
pMem
);

461 
	`sqlôe4VdbeMemGrow
(
pMem
, 64, 0);

462 if–
db
->
mÆlocFaûed
 ){

463 
pMem
->
Êags
 = 
MEM_NuŒ
;

465 
nAŒoc
 = 
	`sqlôe4DbMÆlocSize
(
db
, 
pMem
->
zMÆloc
);

466 
pMem
->
u
.
pRowSë
 = 
	`sqlôe4RowSëInô
(
db
,ÖMem->
zMÆloc
, 
nAŒoc
);

467 
pMem
->
Êags
 = 
MEM_RowSë
;

469 
	}
}

475 
	$sqlôe4VdbeMemTooBig
(
Mem
 *
p
){

476 
	`as£π
–
p
->
db
!=0 );

477 if–
p
->
Êags
 & (
MEM_Så
|
MEM_Blob
) ){

478 
n
 = 
p
->n;

479  
n
>
p
->
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
];

482 
	}
}

484 #ifde‡
SQLITE4_DEBUG


493 
	$sqlôe4VdbeMemAboutToCh™ge
(
Vdbe
 *
pVdbe
, 
Mem
 *
pMem
){

494 
i
;

495 
Mem
 *
pX
;

496 
i
=1, 
pX
=&
pVdbe
->
aMem
[1]; i<ıVdbe->
nMem
; i++,ÖX++){

497 if–
pX
->
pSc›yFrom
==
pMem
 ){

498 
pX
->
Êags
 |
MEM_InvÆid
;

499 
pX
->
pSc›yFrom
 = 0;

502 
pMem
->
pSc›yFrom
 = 0;

503 
	}
}

514 
	$sqlôe4VdbeMemShÆlowC›y
(
Mem
 *
pTo
, c⁄° Mem *
pFrom
, 
§cTy≥
){

515 
	`as£π
–(
pFrom
->
Êags
 & 
MEM_RowSë
)==0 );

516 
	`VdbeMemRñó£
(
pTo
);

517 
	`mem˝y
(
pTo
, 
pFrom
, 
MEMCELLSIZE
);

518 
pTo
->
xDñ
 = 0;

519 if–(
pFrom
->
Êags
&
MEM_Sètic
)==0 ){

520 
pTo
->
Êags
 &~(
MEM_Dyn
|
MEM_Sètic
|
MEM_Ephem
);

521 
	`as£π
–
§cTy≥
==
MEM_Ephem
 || srcTy≥==
MEM_Sètic
 );

522 
pTo
->
Êags
 |
§cTy≥
;

524 
	}
}

530 
	$sqlôe4VdbeMemC›y
(
Mem
 *
pTo
, c⁄° Mem *
pFrom
){

531 
rc
 = 
SQLITE4_OK
;

533 
	`as£π
–(
pFrom
->
Êags
 & 
MEM_RowSë
)==0 );

534 
	`VdbeMemRñó£
(
pTo
);

535 
	`mem˝y
(
pTo
, 
pFrom
, 
MEMCELLSIZE
);

536 
pTo
->
Êags
 &~
MEM_Dyn
;

538 if–
pTo
->
Êags
&(
MEM_Så
|
MEM_Blob
) ){

539 if–0==(
pFrom
->
Êags
&
MEM_Sètic
) ){

540 
pTo
->
Êags
 |
MEM_Ephem
;

541 
rc
 = 
	`sqlôe4VdbeMemMakeWrôóbÀ
(
pTo
);

545  
rc
;

546 
	}
}

554 
	$sqlôe4VdbeMemMove
(
Mem
 *
pTo
, Mem *
pFrom
){

555 
	`as£π
–
pFrom
->
db
==0 || 
	`sqlôe4_muãx_hñd
’From->db->
muãx
) );

556 
	`as£π
–
pTo
->
db
==0 || 
	`sqlôe4_muãx_hñd
’To->db->
muãx
) );

557 
	`as£π
–
pFrom
->
db
==0 || 
pTo
->db==0 ||ÖFrom->db==pTo->db );

559 
	`sqlôe4VdbeMemRñó£
(
pTo
);

560 
	`mem˝y
(
pTo
, 
pFrom
, (
Mem
));

561 
pFrom
->
Êags
 = 
MEM_NuŒ
;

562 
pFrom
->
xDñ
 = 0;

563 
pFrom
->
zMÆloc
 = 0;

564 
	}
}

581 
sqlôe4VdbeMemSëSå
(

582 
Mem
 *
pMem
,

583 c⁄° *
z
,

584 
n
,

585 
u8
 
íc
,

586 (*
xDñ
)(*,*),

587 *
pDñArg


589 
nByã
 = 
n
;

590 
iLimô
;

591 
u16
 
Êags
 = 0;

593 
	`as£π
–
pMem
->
db
==0 || 
	`sqlôe4_muãx_hñd
’Mem->db->
muãx
) );

594 
	`as£π
–(
pMem
->
Êags
 & 
MEM_RowSë
)==0 );

597 if–!
z
 ){

598 
	`sqlôe4VdbeMemSëNuŒ
(
pMem
);

599  
SQLITE4_OK
;

602 if–
pMem
->
db
 ){

603 
iLimô
 = 
pMem
->
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
];

605 
iLimô
 = 
SQLITE4_MAX_LENGTH
;

607 
Êags
 = (
íc
==0?
MEM_Blob
:
MEM_Så
);

608 if–
nByã
<0 ){

609 
	`as£π
–
íc
!=0 );

610 if–
íc
==
SQLITE4_UTF8
 ){

611 
nByã
=0;ÇByã<=
iLimô
 && 
z
[nByte];ÇByte++){}

613 
nByã
=0;ÇByã<=
iLimô
 && (
z
[nByte] | z[nByte+1]);ÇByte+=2){}

615 
Êags
 |
MEM_Tîm
;

622 if–
xDñ
==
SQLITE4_TRANSIENT
 ){

623 
nAŒoc
 = 
nByã
;

624 if–
Êags
&
MEM_Tîm
 ){

625 
nAŒoc
 +(
íc
==
SQLITE4_UTF8
?1:2);

627 if–
nByã
>
iLimô
 ){

628  
SQLITE4_TOOBIG
;

630 if–
	`sqlôe4VdbeMemGrow
(
pMem
, 
nAŒoc
, 0) ){

631  
SQLITE4_NOMEM
;

633 
	`mem˝y
(
pMem
->
z
, z, 
nAŒoc
);

634 }if–
xDñ
==
SQLITE4_DYNAMIC
 ){

635 
	`sqlôe4VdbeMemRñó£
(
pMem
);

636 
pMem
->
zMÆloc
 =ÖMem->
z
 = (*)z;

637 
pMem
->
xDñ
 = 0;

639 
	`sqlôe4VdbeMemRñó£
(
pMem
);

640 
pMem
->
z
 = (*)z;

641 
pMem
->
xDñ
 = xDel;

642 
pMem
->
pDñArg
 =ÖDelArg;

643 
Êags
 |((
xDñ
==
SQLITE4_STATIC
)?
MEM_Sètic
:
MEM_Dyn
);

646 
pMem
->
n
 = 
nByã
;

647 
pMem
->
Êags
 = flags;

648 
pMem
->
íc
 = (íc==0 ? 
SQLITE4_UTF8
 :Énc);

649 
pMem
->
ty≥
 = (
íc
==0 ? 
SQLITE4_BLOB
 : 
SQLITE4_TEXT
);

651 #i‚de‡
SQLITE4_OMIT_UTF16


652 if–
pMem
->
íc
!=
SQLITE4_UTF8
 && 
	`sqlôe4VdbeMemH™dÀBom
(pMem) ){

653  
SQLITE4_NOMEM
;

657 if–
nByã
>
iLimô
 ){

658  
SQLITE4_TOOBIG
;

661  
SQLITE4_OK
;

662 
	}
}

673 
	$sqlôe4MemCom∑ª
(

674 
Mem
 *
pMem1
,

675 
Mem
 *
pMem2
,

676 c⁄° 
CﬁlSeq
 *
pCﬁl
,

677 *
pRes


679 
rc
 = 
SQLITE4_OK
;

680 
f1
, 
f2
;

681 
comböed_Êags
;

683 
f1
 = 
pMem1
->
Êags
;

684 
f2
 = 
pMem2
->
Êags
;

685 
comböed_Êags
 = 
f1
|
f2
;

686 
	`as£π
–(
comböed_Êags
 & 
MEM_RowSë
)==0 );

691 if–
comböed_Êags
&
MEM_NuŒ
 ){

692 *
pRes
 = (
f2
&
MEM_NuŒ
Ë- (
f1
&MEM_Null);

693  
SQLITE4_OK
;

700 if–
comböed_Êags
&(
MEM_I¡
|
MEM_Ról
) ){

701 if–!(
f1
&(
MEM_I¡
|
MEM_Ról
)) ){

702 *
pRes
 = 1;

703 }if–!(
f2
&(
MEM_I¡
|
MEM_Ról
)) ){

704 *
pRes
 = -1;

706 *
pRes
 = (
	`sqlôe4_num_com∑ª
(
pMem1
->
u
.
num
, 
pMem2
->u.num) - 2);

708  
SQLITE4_OK
;

714 if–
comböed_Êags
&
MEM_Så
 ){

716 if–(
f1
 & 
f2
 & 
MEM_Så
)==0 ){

720 *
pRes
 = (
f1
 & 
MEM_Så
) ? -1 : +1;

721  
SQLITE4_OK
;

724 
	`as£π
–
pMem1
->
íc
==
pMem2
->enc );

725 
	`as£π
–
pMem1
->
íc
==
SQLITE4_UTF8
 ||

726 
pMem1
->
íc
==
SQLITE4_UTF16LE
 ||ÖMem1->íc==
SQLITE4_UTF16BE
 );

732 
	`as£π
–!
pCﬁl
 ||ÖCﬁl->
xCmp
 );

734 if–
pCﬁl
 ){

735 
íc
 = 
pMem1
->enc;

736 *
pU£r
 = 
pCﬁl
->pUser;

737 
rc
 = 
pCﬁl
->
	`xCmp
(
pU£r
, 
pMem1
, 
pMem2
, 
pRes
);

738 
	`sqlôe4VdbeCh™geEncodög
(
pMem1
, 
íc
);

739 
	`sqlôe4VdbeCh™geEncodög
(
pMem2
, 
íc
);

740  
rc
;

748 *
pRes
 = 
	`memcmp
(
pMem1
->
z
, 
pMem2
->z, (pMem1->
n
>pMem2->n)?pMem2->n:pMem1->n);

749 if–*
pRes
==0 ){

750 *
pRes
 = 
pMem1
->
n
 - 
pMem2
->n;

752  
rc
;

753 
	}
}

761 c⁄° *
	$sqlôe4VÆueText
(
sqlôe4_vÆue
* 
pVÆ
, 
u8
 
íc
){

762 if–!
pVÆ
 )  0;

764 
	`as£π
–
pVÆ
->
db
==0 || 
	`sqlôe4_muãx_hñd
’VÆ->db->
muãx
) );

765 
	`as£π
–(
pVÆ
->
Êags
 & 
MEM_RowSë
)==0 );

767 if–
pVÆ
->
Êags
&
MEM_NuŒ
 ){

770 
	`as£π
–(
MEM_Blob
>>3Ë=
MEM_Så
 );

771 
pVÆ
->
Êags
 |’VÆ->Êag†& 
MEM_Blob
)>>3;

772 if–
pVÆ
->
Êags
&
MEM_Så
 ){

773 
	`sqlôe4VdbeCh™geEncodög
(
pVÆ
, 
íc
);

774 
	`sqlôe4VdbeMemNulTîmö©e
(
pVÆ
);

776 
	`as£π
–(
pVÆ
->
Êags
&
MEM_Blob
)==0 );

777 
	`sqlôe4VdbeMemSåögify
(
pVÆ
, 
íc
);

778 
	`as£π
–0==(1&
	`SQLITE4_PTR_TO_INT
(
pVÆ
->
z
)) );

780 
	`as£π
(
pVÆ
->
íc
=Ûn¯||ÖVÆ->
db
==0 ||ÖVÆ->db->
mÆlocFaûed
 );

781 if–
pVÆ
->
íc
==enc ){

782  
pVÆ
->
z
;

786 
	}
}

791 
sqlôe4_vÆue
 *
	$sqlôe4VÆueNew
(
sqlôe4
 *
db
){

792 
Mem
 *
p
 = 
	`sqlôe4DbMÆlocZîo
(
db
, (*p));

793 if–
p
 ){

794 
p
->
Êags
 = 
MEM_NuŒ
;

795 
p
->
ty≥
 = 
SQLITE4_NULL
;

796 
p
->
db
 = db;

798  
p
;

799 
	}
}

811 
	$sqlôe4VÆueFromEx¥
(

812 
sqlôe4
 *
db
,

813 
Ex¥
 *
pEx¥
,

814 
u8
 
íc
,

815 
u8
 
afföôy
,

816 
sqlôe4_vÆue
 **
µVÆ


818 
›
;

819 *
zVÆ
 = 0;

820 
sqlôe4_vÆue
 *
pVÆ
 = 0;

821 
√gI¡
 = 1;

822 c⁄° *
zNeg
 = "";

824 if–!
pEx¥
 ){

825 *
µVÆ
 = 0;

826  
SQLITE4_OK
;

828 
›
 = 
pEx¥
->op;

834 #ifde‡
SQLITE4_ENABLE_STAT3


835 if–
›
==
TK_REGISTER
 ) o∞
pEx¥
->
›2
;

837 if–
	`NEVER
(
›
==
TK_REGISTER
ËË› = 
pEx¥
->
›2
;

843 if–
›
==
TK_UMINUS


844 && (
pEx¥
->
pLe·
->
›
==
TK_INTEGER
 ||ÖEx¥->pLe·->›==
TK_FLOAT
) ){

845 
pEx¥
 =ÖEx¥->
pLe·
;

846 
›
 = 
pEx¥
->op;

847 
√gI¡
 = -1;

848 
zNeg
 = "-";

851 if–
›
==
TK_STRING
 || op==
TK_FLOAT
 || op==
TK_INTEGER
 ){

852 
pVÆ
 = 
	`sqlôe4VÆueNew
(
db
);

853 if–
pVÆ
==0 ) 
no_mem
;

854 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_I¡VÆue
) ){

855 
	`sqlôe4VdbeMemSëI¡64
(
pVÆ
, (
i64
)
pEx¥
->
u
.
iVÆue
*
√gI¡
);

857 
zVÆ
 = 
	`sqlôe4MPrötf
(
db
, "%s%s", 
zNeg
, 
pEx¥
->
u
.
zTokí
);

858 if–
zVÆ
==0 ) 
no_mem
;

859 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
zVÆ
, 
SQLITE4_UTF8
, 
SQLITE4_DYNAMIC
, 0);

860 if–
›
==
TK_FLOAT
 ) 
pVÆ
->
ty≥
 = 
SQLITE4_FLOAT
;

862 if–(
›
==
TK_INTEGER
 || op==
TK_FLOAT
 ) && 
afföôy
==
SQLITE4_AFF_NONE
 ){

863 
	`sqlôe4VÆueAµlyAfföôy
(
pVÆ
, 
SQLITE4_AFF_NUMERIC
, 
SQLITE4_UTF8
);

865 
	`sqlôe4VÆueAµlyAfföôy
(
pVÆ
, 
afföôy
, 
SQLITE4_UTF8
);

867 if–
pVÆ
->
Êags
 & (
MEM_I¡
|
MEM_Ról
ËËpVÆ->Êag†&~
MEM_Så
;

868 if–
íc
!=
SQLITE4_UTF8
 ){

869 
	`sqlôe4VdbeCh™geEncodög
(
pVÆ
, 
íc
);

871 }if–
›
==
TK_UMINUS
 ) {

873 if–
SQLITE4_OK
==
	`sqlôe4VÆueFromEx¥
(
db
,
pEx¥
->
pLe·
,
íc
,
afföôy
,&
pVÆ
) ){

874 
	`sqlôe4VdbeMemNumîify
(
pVÆ
);

875 
pVÆ
->
u
.
num
 = 
	`sqlôe4_num_mul
’VÆ->u.num, 
	`sqlôe4_num_‰om_öt64
(-1));

876 
	`sqlôe4VÆueAµlyAfföôy
(
pVÆ
, 
afföôy
, 
íc
);

878 }if–
›
==
TK_NULL
 ){

879 
pVÆ
 = 
	`sqlôe4VÆueNew
(
db
);

880 if–
pVÆ
==0 ) 
no_mem
;

882 #i‚de‡
SQLITE4_OMIT_BLOB_LITERAL


883 if–
›
==
TK_BLOB
 ){

884 
nVÆ
;

885 
	`as£π
–
pEx¥
->
u
.
zTokí
[0]=='x' ||ÖExpr->u.zToken[0]=='X' );

886 
	`as£π
–
pEx¥
->
u
.
zTokí
[1]=='\'' );

887 
pVÆ
 = 
	`sqlôe4VÆueNew
(
db
);

888 if–!
pVÆ
 ) 
no_mem
;

889 
zVÆ
 = &
pEx¥
->
u
.
zTokí
[2];

890 
nVÆ
 = 
	`sqlôe4SåÀn30
(
zVÆ
)-1;

891 
	`as£π
–
zVÆ
[
nVÆ
]=='\'' );

892 
	`sqlôe4VdbeMemSëSå
(
pVÆ
, 
	`sqlôe4HexToBlob
(
db
, 
zVÆ
, 
nVÆ
),ÇVal/2,

893 0, 
SQLITE4_DYNAMIC
, 0);

897 if–
pVÆ
 ){

898 
	`sqlôe4VdbeMemSt‹eTy≥
(
pVÆ
);

900 *
µVÆ
 = 
pVÆ
;

901  
SQLITE4_OK
;

903 
no_mem
:

904 
db
->
mÆlocFaûed
 = 1;

905 
	`sqlôe4DbFªe
(
db
, 
zVÆ
);

906 
	`sqlôe4VÆueFªe
(
pVÆ
);

907 *
µVÆ
 = 0;

908  
SQLITE4_NOMEM
;

909 
	}
}

914 
sqlôe4VÆueSëSå
(

915 
sqlôe4_vÆue
 *
v
,

916 
n
,

917 c⁄° *
z
,

918 
u8
 
íc
,

919 (*
xDñ
)(*,*),

920 *
pDñArg


922 if–
v
 ) 
	`sqlôe4VdbeMemSëSå
((
Mem
 *)v, 
z
, 
n
, 
íc
, 
xDñ
, 
pDñArg
);

923 
	}
}

928 
	$sqlôe4VÆueFªe
(
sqlôe4_vÆue
 *
v
){

929 if–!
v
 ) ;

930 
	`sqlôe4VdbeMemRñó£
((
Mem
 *)
v
);

931 
	`sqlôe4DbFªe
(((
Mem
*)
v
)->
db
, v);

932 
	}
}

938 
	$sqlôe4VÆueByãs
(
sqlôe4_vÆue
 *
pVÆ
, 
u8
 
íc
){

939 
Mem
 *
p
 = (Mem*)
pVÆ
;

940 if–(
p
->
Êags
 & 
MEM_Blob
)!=0 || 
	`sqlôe4VÆueText
(
pVÆ
, 
íc
) ){

941  
p
->
n
;

944 
	}
}

	@src/vdbetrace.c

18 
	~"sqlôeI¡.h
"

19 
	~"vdbeI¡.h
"

21 #i‚de‡
SQLITE4_OMIT_TRACE


29 
	$födNextHo°P¨amëî
(c⁄° *
zSql
, *
≤Tokí
){

30 
tokíTy≥
;

31 
nTŸÆ
 = 0;

32 
n
;

34 *
≤Tokí
 = 0;

35  
zSql
[0] ){

36 
n
 = 
	`sqlôe4GëTokí
((
u8
*)
zSql
, &
tokíTy≥
);

37 
	`as£π
–
n
>0 && 
tokíTy≥
!=
TK_ILLEGAL
 );

38 if–
tokíTy≥
==
TK_VARIABLE
 ){

39 *
≤Tokí
 = 
n
;

42 
nTŸÆ
 +
n
;

43 
zSql
 +
n
;

45  
nTŸÆ
;

46 
	}
}

67 *
	$sqlôe4VdbeEx∑ndSql
(

68 
Vdbe
 *
p
,

69 c⁄° *
zRawSql


71 
sqlôe4
 *
db
;

72 
idx
 = 0;

73 
√xtIndex
 = 1;

74 
n
;

75 
nTokí
;

76 
i
;

77 
Mem
 *
pV¨
;

78 
SåAccum
 
out
;

79 
zBa£
[100];

81 
db
 = 
p
->db;

82 
	`sqlôe4SåAccumInô
(&
out
, 
zBa£
, (zBase),

83 
db
->
aLimô
[
SQLITE4_LIMIT_LENGTH
]);

84 
out
.
db
 = db;

85 
out
.
pEnv
 = 
db
->pEnv;

86 if–
db
->
vdbeExecC¡
>1 ){

87  *
zRawSql
 ){

88 c⁄° *
zSèπ
 = 
zRawSql
;

89  *(
zRawSql
++)!='\n' && *zRawSql );

90 
	`sqlôe4SåAccumAµíd
(&
out
, "-- ", 3);

91 
	`sqlôe4SåAccumAµíd
(&
out
, 
zSèπ
, ()(
zRawSql
-zStart));

94  
zRawSql
[0] ){

95 
n
 = 
	`födNextHo°P¨amëî
(
zRawSql
, &
nTokí
);

96 
	`as£π
–
n
>0 );

97 
	`sqlôe4SåAccumAµíd
(&
out
, 
zRawSql
, 
n
);

98 
zRawSql
 +
n
;

99 
	`as£π
–
zRawSql
[0] || 
nTokí
==0 );

100 if–
nTokí
==0 ) ;

101 if–
zRawSql
[0]=='?' ){

102 if–
nTokí
>1 ){

103 
	`as£π
–
	`sqlôe4Isdigô
(
zRawSql
[1]) );

104 
	`sqlôe4GëI¡32
(&
zRawSql
[1], &
idx
);

106 
idx
 = 
√xtIndex
;

109 
	`as£π
–
zRawSql
[0]==':' || zRawSql[0]=='$' || zRawSql[0]=='@' );

110 
	`ã°ˇ£
–
zRawSql
[0]==':' );

111 
	`ã°ˇ£
–
zRawSql
[0]=='$' );

112 
	`ã°ˇ£
–
zRawSql
[0]=='@' );

113 
idx
 = 
	`sqlôe4VdbeP¨amëîIndex
(
p
, 
zRawSql
, 
nTokí
);

114 
	`as£π
–
idx
>0 );

116 
zRawSql
 +
nTokí
;

117 
√xtIndex
 = 
idx
 + 1;

118 
	`as£π
–
idx
>0 && idx<=
p
->
nV¨
 );

119 
pV¨
 = &
p
->
aV¨
[
idx
-1];

120 if–
pV¨
->
Êags
 & 
MEM_NuŒ
 ){

121 
	`sqlôe4SåAccumAµíd
(&
out
, "NULL", 4);

122 }if–
pV¨
->
Êags
 & (
MEM_I¡
|
MEM_Ról
) ){

123 
aOut
[30];

124 
	`sqlôe4_num_to_ãxt
(
pV¨
->
u
.
num
, 
aOut
, (pV¨->
Êags
 & 
MEM_Ról
));

125 
	`sqlôe4XPrötf
(&
out
, "%s", 
aOut
);

126 }if–
pV¨
->
Êags
 & 
MEM_Så
 ){

127 #i‚de‡
SQLITE4_OMIT_UTF16


128 
u8
 
íc
 = 
	`ENC
(
db
);

129 if–
íc
!=
SQLITE4_UTF8
 ){

130 
Mem
 
utf8
;

131 
	`mem£t
(&
utf8
, 0, (utf8));

132 
utf8
.
db
 = db;

133 
	`sqlôe4VdbeMemSëSå
(&
utf8
, 
pV¨
->
z
,ÖV¨->
n
, 
íc
, 
SQLITE4_STATIC
, 0);

134 
	`sqlôe4VdbeCh™geEncodög
(&
utf8
, 
SQLITE4_UTF8
);

135 
	`sqlôe4XPrötf
(&
out
, "'%.*q'", 
utf8
.
n
, utf8.
z
);

136 
	`sqlôe4VdbeMemRñó£
(&
utf8
);

140 
	`sqlôe4XPrötf
(&
out
, "'%.*q'", 
pV¨
->
n
,ÖV¨->
z
);

143 
	`as£π
–
pV¨
->
Êags
 & 
MEM_Blob
 );

144 
	`sqlôe4SåAccumAµíd
(&
out
, "x'", 2);

145 
i
=0; i<
pV¨
->
n
; i++){

146 
	`sqlôe4XPrötf
(&
out
, "%02x", 
pV¨
->
z
[
i
]&0xff);

148 
	`sqlôe4SåAccumAµíd
(&
out
, "'", 1);

152  
	`sqlôe4SåAccumFöish
(&
out
);

153 
	}
}

162 #i‡
deföed
(
SQLITE4_ENABLE_TREE_EXPLAIN
)

167 
	$sqlôe4Ex∂aöBegö
(
Vdbe
 *
pVdbe
){

168 if–
pVdbe
 ){

169 
Ex∂aö
 *
p
;

170 
sqlôe4
 *
db
 = 
pVdbe
->db;

171 
sqlôe4_ív
 *
pEnv
 = 
db
->pEnv;

172 
	`sqlôe4BegöBíignMÆloc
(
pEnv
);

173 
p
 = 
	`sqlôe4_mÆloc
(
pEnv
, (
Ex∂aö
) );

174 if–
p
 ){

175 
	`mem£t
(
p
, 0, (*p));

176 
p
->
pVdbe
 =ÖVdbe;

177 
	`sqlôe4_‰ì
(
pEnv
, 
pVdbe
->
pEx∂aö
);

178 
pVdbe
->
pEx∂aö
 = 
p
;

179 
	`sqlôe4SåAccumInô
(&
p
->
°r
,Ö->
zBa£
, (p->zBase),

180 
SQLITE4_MAX_LENGTH
);

181 
p
->
°r
.
u£MÆloc
 = 2;

182 
p
->
°r
.
pEnv
 =ÖEnv;

184 
	`sqlôe4EndBíignMÆloc
(
pEnv
);

187 
	}
}

192 
	$ídsWôhNL
(
Ex∂aö
 *
p
){

193  
p
 &&Ö->
°r
.
zText
 &&Ö->°r.
nCh¨


194 && 
p
->
°r
.
zText
[p->°r.
nCh¨
-1]=='\n';

195 
	}
}

200 
	$sqlôe4Ex∂aöPrötf
(
Vdbe
 *
pVdbe
, c⁄° *
zF‹m©
, ...){

201 
Ex∂aö
 *
p
;

202 if–
pVdbe
 && (
p
 =ÖVdbe->
pEx∂aö
)!=0 ){

203 
va_li°
 
≠
;

204 if–
p
->
nIndít
 && 
	`ídsWôhNL
(p) ){

205 
n
 = 
p
->
nIndít
;

206 if–
n
>
	`AºaySize
(
p
->
aIndít
) )Ç = ArraySize(p->aIndent);

207 
	`sqlôe4AµídS∑˚
(&
p
->
°r
,Ö->
aIndít
[
n
-1]);

209 
	`va_°¨t
(
≠
, 
zF‹m©
);

210 
	`sqlôe4VXPrötf
(&
p
->
°r
, 1, 
zF‹m©
, 
≠
);

211 
	`va_íd
(
≠
);

213 
	}
}

218 
	$sqlôe4Ex∂aöNL
(
Vdbe
 *
pVdbe
){

219 
Ex∂aö
 *
p
;

220 if–
pVdbe
 && (
p
 =ÖVdbe->
pEx∂aö
)!=0 && !
	`ídsWôhNL
(p) ){

221 
	`sqlôe4SåAccumAµíd
(&
p
->
°r
, "\n", 1);

223 
	}
}

229 
	$sqlôe4Ex∂aöPush
(
Vdbe
 *
pVdbe
){

230 
Ex∂aö
 *
p
;

231 if–
pVdbe
 && (
p
 =ÖVdbe->
pEx∂aö
)!=0 ){

232 if–
p
->
°r
.
zText
 &&Ö->
nIndít
<
	`AºaySize
’->
aIndít
) ){

233 c⁄° *
z
 = 
p
->
°r
.
zText
;

234 
i
 = 
p
->
°r
.
nCh¨
-1;

235 
x
;

236  
i
>=0 && 
z
[i]!='\n' ){ i--; }

237 
x
 = (
p
->
°r
.
nCh¨
 - 1Ë- 
i
;

238 if–
p
->
nIndít
 && 
x
<p->
aIndít
[p->nIndent-1] ){

239 
x
 = 
p
->
aIndít
[p->
nIndít
-1];

241 
p
->
aIndít
[p->
nIndít
] = 
x
;

243 
p
->
nIndít
++;

245 
	}
}

250 
	$sqlôe4Ex∂aöP›
(
Vdbe
 *
p
){

251 if–
p
 &&Ö->
pEx∂aö
 )Ö->pEx∂aö->
nIndít
--;

252 
	}
}

257 
	$sqlôe4Ex∂aöFöish
(
Vdbe
 *
pVdbe
){

258 if–
pVdbe
 &&ÖVdbe->
pEx∂aö
 ){

259 
sqlôe4_ív
 *
pEnv
 = 
pVdbe
->
db
->pEnv;

260 
	`sqlôe4_‰ì
(
pEnv
, 
pVdbe
->
zEx∂aö
);

261 
	`sqlôe4Ex∂aöNL
(
pVdbe
);

262 
pVdbe
->
zEx∂aö
 = 
	`sqlôe4SåAccumFöish
(&pVdbe->
pEx∂aö
->
°r
);

263 
	`sqlôe4_‰ì
(
pEnv
, 
pVdbe
->
pEx∂aö
);

264 
pVdbe
->
pEx∂aö
 = 0;

265 
	`sqlôe4EndBíignMÆloc
(
pEnv
);

267 
	}
}

272 c⁄° *
	$sqlôe4VdbeEx∂™©i⁄
(
Vdbe
 *
pVdbe
){

273  (
pVdbe
 &&ÖVdbe->
zEx∂aö
) ?ÖVdbe->zExplain : 0;

274 
	}
}

	@src/vector.c

30 #i‚de‡
SQLITE4_OMIT_VECTOR


32 
	~"sqlôeI¡.h
"

33 
	~"ve˘‹I¡.h
"

35 
	#MAX_FLOAT_CHAR_SZ
 1024

	)

41 
size_t
 
	$ve˘‹D©aSize
(
Ve˘‹Ty≥
 
ty≥
, 
Ve˘‹Dims
 
dims
){

42  
ty≥
 ){

43 
VECTOR_TYPE_FLOAT32
:

44  
dims
 * ();

45 
VECTOR_TYPE_FLOAT64
:

46  
dims
 * ();

47 
VECTOR_TYPE_FLOAT1BIT
:

48  (
dims
 + 7) / 8;

49 
VECTOR_TYPE_FLOAT8
:

50  
	`ALIGN
(
dims
, ()) + () + () ;

51 
VECTOR_TYPE_FLOAT16
:

52  
dims
 * (
u16
);

53 
VECTOR_TYPE_FLOATB16
:

54  
dims
 * (
u16
);

56 
	`as£π
(0);

59 
	}
}

61 
	$ve˘‹Inô
(
Ve˘‹
 *
pVe˘‹
, 
Ve˘‹Ty≥
 
ty≥
, 
Ve˘‹Dims
 
dims
, *
d©a
){

62 
pVe˘‹
->
ty≥
 =Åype;

63 
pVe˘‹
->
dims
 = dims;

64 
pVe˘‹
->
d©a
 = data;

65 
pVe˘‹
->
Êags
 = 0;

66 
	}
}

71 
Ve˘‹
 *
	$ve˘‹AŒoc
(
Ve˘‹Ty≥
 
ty≥
, 
Ve˘‹Dims
 
dims
){

72 *
pVe˘‹
 = 
	`sqlôe4_mÆloc
(0, (
Ve˘‹
Ë+ 
	`ve˘‹D©aSize
(
ty≥
, 
dims
));

73 if–
pVe˘‹
==
NULL
 ){

74  
NULL
;

76 
	`ve˘‹Inô
(
pVe˘‹
, 
ty≥
, 
dims
, ((*ËpVe˘‹Ë+ (
Ve˘‹
));

77  
pVe˘‹
;

78 
	}
}

86 
	$ve˘‹InôSètic
(
Ve˘‹
 *
pVe˘‹
, 
Ve˘‹Ty≥
 
ty≥
, 
Ve˘‹Dims
 
dims
, *
pBlob
){

87 
pVe˘‹
->
Êags
 = 
VECTOR_FLAGS_STATIC
;

88 
pVe˘‹
->
ty≥
 =Åype;

89 
pVe˘‹
->
dims
 = dims;

90 
pVe˘‹
->
d©a
 = 
pBlob
;

91 
	}
}

96 
Ve˘‹
* 
	$ve˘‹C⁄ãxtAŒoc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
ty≥
, 
dims
){

97 *
pVe˘‹
 = 
	`sqlôe4_mÆloc
(0, (
Ve˘‹
Ë+ 
	`ve˘‹D©aSize
(
ty≥
, 
dims
));

98 if–
pVe˘‹
==
NULL
 ){

99 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

100  
NULL
;

102 
	`ve˘‹Inô
(
pVe˘‹
, 
ty≥
, 
dims
, ((*ËpVe˘‹Ë+ (
Ve˘‹
));

103  
pVe˘‹
;

104 
	}
}

109 
	$ve˘‹Fªe
(
Ve˘‹
 *
pVe˘‹
){

110 if–
pVe˘‹
 =
NULL
 ){

113 if–
pVe˘‹
->
Êags
 & 
VECTOR_FLAGS_STATIC
 ){

116 
	`sqlôe4_‰ì
(0, 
pVe˘‹
);

117 
	}
}

119 
	$ve˘‹Di°™˚Cos
(c⁄° 
Ve˘‹
 *
pVe˘‹1
, c⁄° Ve˘‹ *
pVe˘‹2
){

120 
	`as£π
–
pVe˘‹1
->
ty≥
 =
pVe˘‹2
->type );

121 
pVe˘‹1
->
ty≥
) {

122 
VECTOR_TYPE_FLOAT32
:

123  
	`ve˘‹F32Di°™˚Cos
(
pVe˘‹1
, 
pVe˘‹2
);

124 
VECTOR_TYPE_FLOAT64
:

125  
	`ve˘‹F64Di°™˚Cos
(
pVe˘‹1
, 
pVe˘‹2
);

126 
VECTOR_TYPE_FLOAT1BIT
:

127  
	`ve˘‹1BôDi°™˚Hammög
(
pVe˘‹1
, 
pVe˘‹2
);

128 
VECTOR_TYPE_FLOAT8
:

129  
	`ve˘‹F8Di°™˚Cos
(
pVe˘‹1
, 
pVe˘‹2
);

130 
VECTOR_TYPE_FLOAT16
:

131  
	`ve˘‹F16Di°™˚Cos
(
pVe˘‹1
, 
pVe˘‹2
);

132 
VECTOR_TYPE_FLOATB16
:

133  
	`ve˘‹FB16Di°™˚Cos
(
pVe˘‹1
, 
pVe˘‹2
);

135 
	`as£π
(0);

138 
	}
}

140 
	$ve˘‹Di°™˚L2
(c⁄° 
Ve˘‹
 *
pVe˘‹1
, c⁄° Ve˘‹ *
pVe˘‹2
){

141 
	`as£π
–
pVe˘‹1
->
ty≥
 =
pVe˘‹2
->type );

142 
pVe˘‹1
->
ty≥
) {

143 
VECTOR_TYPE_FLOAT32
:

144  
	`ve˘‹F32Di°™˚L2
(
pVe˘‹1
, 
pVe˘‹2
);

145 
VECTOR_TYPE_FLOAT64
:

146  
	`ve˘‹F64Di°™˚L2
(
pVe˘‹1
, 
pVe˘‹2
);

147 
VECTOR_TYPE_FLOAT8
:

148  
	`ve˘‹F8Di°™˚L2
(
pVe˘‹1
, 
pVe˘‹2
);

149 
VECTOR_TYPE_FLOAT16
:

150  
	`ve˘‹F16Di°™˚L2
(
pVe˘‹1
, 
pVe˘‹2
);

151 
VECTOR_TYPE_FLOATB16
:

152  
	`ve˘‹FB16Di°™˚L2
(
pVe˘‹1
, 
pVe˘‹2
);

154 
	`as£π
(0);

157 
	}
}

159 c⁄° *
	$sqlôe4_ty≥_ª¥
(
ty≥
){

160  
ty≥
 ){

161 
SQLITE4_NULL
:

163 
SQLITE4_INTEGER
:

165 
SQLITE4_FLOAT
:

167 
SQLITE4_BLOB
:

169 
SQLITE4_TEXT
:

174 
	}
}

178 
	$ve˘‹P¨£SqlôeText
(

179 
sqlôe4_vÆue
 *
¨g
,

180 
Ve˘‹
 *
pVe˘‹
,

181 **
pzEºMsg


183 c⁄° *
pzText
;

184 
ñem
;

185 *
ñemsFlﬂt
;

186 *
ñemsDoubÀ
;

187 
iEÀm
 = 0;

190 
vÆueBuf
[
MAX_FLOAT_CHAR_SZ
 + 1];

191 
iBuf
 = 0;

193 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ||ÖVe˘‹->ty≥ =
VECTOR_TYPE_FLOAT64
 );

194 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨g
Ë=
SQLITE4_TEXT
 );

196 if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

197 
ñemsFlﬂt
 = 
pVe˘‹
->
d©a
;

198 } if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

199 
ñemsDoubÀ
 = 
pVe˘‹
->
d©a
;

202 
pzText
 = 
	`sqlôe4_vÆue_ãxt
(
¨g
, 0);

203 i‡–
pzText
 =
NULL
 )  0;

205  
	`sqlôe4Is•a˚
(*
pzText
) )

206 
pzText
++;

208 if–*
pzText
 != '[' ){

209 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "vector: must start with '['");

210 
îr‹
;

212 
pzText
++;

215 
	`mem£t
(
vÆueBuf
, 0, (valueBuf));

217 ; *
pzText
 != '\0';ÖzText++){

218 
this
 = *
pzText
;

219 if–
	`sqlôe4Is•a˚
(
this
) ){

222 if–
this
 != ',' &&Åhis != ']' ){

223 if–
iBuf
 > 
MAX_FLOAT_CHAR_SZ
 ){

224 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂà°rögÜígthÉx˚eded %d ch¨a˘îs: '%s'", 
MAX_FLOAT_CHAR_SZ
, 
vÆueBuf
);

225 
îr‹
;

227 
vÆueBuf
[
iBuf
++] = 
this
;

231 if–
this
 =']' && 
iEÀm
 =0 && 
iBuf
 == 0 ){

234 if–
	`sqlôe4AtoF
(
vÆueBuf
, &
ñem
, 
iBuf
, 
SQLITE4_UTF8
) <= 0 ){

235 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: invÆid flﬂà©Öosôi⁄ %d: '%s'", 
iEÀm
, 
vÆueBuf
);

236 
îr‹
;

238 if–
iEÀm
 >
MAX_VECTOR_SZ
 ){

239 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: max sizêex˚eded %d", 
MAX_VECTOR_SZ
);

240 
îr‹
;

243 
	`mem£t
(
vÆueBuf
, 0, 
iBuf
);

244 
iBuf
 = 0;

245 if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

246 
ñemsFlﬂt
[
iEÀm
++] = 
ñem
;

247 } if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

248 
ñemsDoubÀ
[
iEÀm
++] = 
ñem
;

250 if–
this
 == ']' ){

254  
	`sqlôe4Is•a˚
(*
pzText
) )

255 
pzText
++;

257 if–*
pzText
 != ']' ){

258 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "vector: mustÉnd with ']'");

259 
îr‹
;

261 
pzText
++;

263  
	`sqlôe4Is•a˚
(*
pzText
) )

264 
pzText
++;

266 if–*
pzText
 != '\0' ){

267 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "vector:Çon-space symbolsáfter closing ']'áre forbidden");

268 
îr‹
;

270 
pVe˘‹
->
dims
 = 
iEÀm
;

272 
îr‹
:

274 
	}
}

276 
	$ve˘‹P¨£Mëa
(c⁄° *
pBlob
, 
size_t
 
nBlobSize
, *
pTy≥
, *
pDims
, size_à*
pD©aSize
, **
pzEºMsg
){

277 
nTøûögBôs
;

278 
nTøûögByãs
;

280 if–
nBlobSize
 % 2 == 0 ){

281 *
pTy≥
 = 
VECTOR_TYPE_FLOAT32
;

282 *
pDims
 = 
nBlobSize
 / ();

283 *
pD©aSize
 = 
nBlobSize
;

284  
SQLITE4_OK
;

286 *
pTy≥
 = 
pBlob
[
nBlobSize
 - 1];

287 
nBlobSize
--;

289 if–*
pTy≥
 =
VECTOR_TYPE_FLOAT32
 ){

290 if–
nBlobSize
 % 4 != 0 ){

291 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂt32 ve˘‹ blobÜígth mu° bêdivisibÀ by 4 (ex˛udög o±i⁄Æ 'ty≥'-byã):Üígth=%d", 
nBlobSize
);

292  
SQLITE4_ERROR
;

294 *
pDims
 = 
nBlobSize
 / ();

295 *
pD©aSize
 = 
nBlobSize
;

296 }if–*
pTy≥
 =
VECTOR_TYPE_FLOAT64
 ){

297 if–
nBlobSize
 % 8 != 0 ){

298 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂt64 ve˘‹ blobÜígth mu° bêdivisibÀ by 8 (ex˛udög 'ty≥'-byã):Üígth=%d", 
nBlobSize
);

299  
SQLITE4_ERROR
;

301 *
pDims
 = 
nBlobSize
 / ();

302 *
pD©aSize
 = 
nBlobSize
;

303 }if–*
pTy≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

304 if–
nBlobSize
 == 0 ||ÇBlobSize % 2 != 0 ){

305 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂt1bô ve˘‹ blobÜígth mu° bêdivisibÀ by 2ándÇŸ bêem±y (ex˛udög 'ty≥'-byã):Üígth=%d", 
nBlobSize
);

306  
SQLITE4_ERROR
;

308 
nTøûögBôs
 = 
pBlob
[
nBlobSize
 - 1];

309 *
pDims
 = 
nBlobSize
 * 8 - 
nTøûögBôs
;

310 *
pD©aSize
 = (*
pDims
 + 7) / 8;

311 }if–*
pTy≥
 =
VECTOR_TYPE_FLOAT8
 ){

312 if–
nBlobSize
 < 2 ||ÇBlobSize % 2 != 0 ){

313 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂt8 ve˘‹ blobÜígth mu° bêdivisibÀ by 2ánd ha†©Üó° 2 byã†”x˛udög 'ty≥'-byã):Üígth=%d", 
nBlobSize
);

314  
SQLITE4_ERROR
;

316 
nTøûögByãs
 = 
pBlob
[
nBlobSize
 - 1];

317 *
pDims
 = (
nBlobSize
 - 2Ë- (Ë- (Ë- 
nTøûögByãs
;

318 *
pD©aSize
 = 
nBlobSize
 - 2;

319 }if–*
pTy≥
 =
VECTOR_TYPE_FLOAT16
 ){

320 if–
nBlobSize
 % 2 != 0 ){

321 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂt16 ve˘‹ blobÜígth mu° bêdivisibÀ by 2 (ex˛udög 'ty≥'-byã):Üígth=%d", 
nBlobSize
);

322  
SQLITE4_ERROR
;

324 *
pDims
 = 
nBlobSize
 / (
u16
);

325 *
pD©aSize
 = 
nBlobSize
;

326 }if–*
pTy≥
 =
VECTOR_TYPE_FLOATB16
 ){

327 if–
nBlobSize
 % 2 != 0 ){

328 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: flﬂtb16 ve˘‹ blobÜígth mu° bêdivisibÀ by 2 (ex˛udög 'ty≥'-byã):Üígth=%d", 
nBlobSize
);

329  
SQLITE4_ERROR
;

331 *
pDims
 = 
nBlobSize
 / (
u16
);

332 *
pD©aSize
 = 
nBlobSize
;

334 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: u√x≥˘ed bö¨yÅy≥: %d", *
pTy≥
);

335  
SQLITE4_ERROR
;

337  
SQLITE4_OK
;

338 
	}
}

340 
	$ve˘‹P¨£SqlôeBlobWôhTy≥
(

341 
sqlôe4_vÆue
 *
¨g
,

342 
Ve˘‹
 *
pVe˘‹
,

343 **
pzEºMsg


345 c⁄° *
pBlob
;

346 
size_t
 
nBlobSize
, 
nD©aSize
;

347 
ty≥
, 
dims
;

349 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨g
Ë=
SQLITE4_BLOB
 );

351 
pBlob
 = 
	`sqlôe4_vÆue_blob
(
¨g
, 0);

352 
nBlobSize
 = 
	`sqlôe4_vÆue_byãs
(
¨g
);

353 if–
	`ve˘‹P¨£Mëa
(
pBlob
, 
nBlobSize
, &
ty≥
, &
dims
, &
nD©aSize
, 
pzEºMsg
Ë!
SQLITE4_OK
 ){

354  
SQLITE4_ERROR
;

357 if–
nD©aSize
 !
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) ){

358 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(

360 
pVe˘‹
->
ty≥
,

361 
pVe˘‹
->
dims
,

362 
nD©aSize
,

363 
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
)

365  
SQLITE4_ERROR
;

368 
pVe˘‹
->
ty≥
) {

369 
VECTOR_TYPE_FLOAT32
:

370 
	`ve˘‹F32De£rülizeFromBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

372 
VECTOR_TYPE_FLOAT64
:

373 
	`ve˘‹F64De£rülizeFromBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

375 
VECTOR_TYPE_FLOAT1BIT
:

376 
	`ve˘‹1BôDe£rülizeFromBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

378 
VECTOR_TYPE_FLOAT8
:

379 
	`ve˘‹F8De£rülizeFromBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

381 
VECTOR_TYPE_FLOAT16
:

382 
	`ve˘‹F16De£rülizeFromBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

384 
VECTOR_TYPE_FLOATB16
:

385 
	`ve˘‹FB16De£rülizeFromBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

388 
	`as£π
(0);

391 
	}
}

393 
	$dëe˘BlobVe˘‹P¨amëîs
(
sqlôe4_vÆue
 *
¨g
, *
pTy≥
, *
pDims
, **
pzEºMsg
) {

394 c⁄° 
u8
 *
pBlob
;

395 
size_t
 
nBlobSize
, 
nD©aSize
;

397 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨g
Ë=
SQLITE4_BLOB
 );

399 
pBlob
 = 
	`sqlôe4_vÆue_blob
(
¨g
, 0);

400 
nBlobSize
 = 
	`sqlôe4_vÆue_byãs
(
¨g
);

402 if–
	`ve˘‹P¨£Mëa
(
pBlob
, 
nBlobSize
, 
pTy≥
, 
pDims
, &
nD©aSize
, 
pzEºMsg
Ë!
SQLITE4_OK
 ){

403  
SQLITE4_ERROR
;

405 if–*
pDims
 > 
MAX_VECTOR_SZ
 ){

406 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: max sizêex˚eded: %d > %d", *
pDims
, 
MAX_VECTOR_SZ
);

407  
SQLITE4_ERROR
;

409  
SQLITE4_OK
;

410 
	}
}

412 
	$dëe˘TextVe˘‹P¨amëîs
(
sqlôe4_vÆue
 *
¨g
, 
ty≥Höt
, *
pTy≥
, *
pDims
, **
pzEºMsg
) {

413 c⁄° 
u8
 *
ãxt
;

414 
ãxtByãs
;

415 
iText
;

416 
ãxtHasDigô
 = 0;

418 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
¨g
Ë=
SQLITE4_TEXT
 );

419 
ãxt
 = 
	`sqlôe4_vÆue_ãxt
(
¨g
, 0);

420 
ãxtByãs
 = 
	`sqlôe4_vÆue_byãs
(
¨g
);

421 if–
ty≥Höt
 == 0 ){

422 *
pTy≥
 = 
VECTOR_TYPE_FLOAT32
;

423 }if–
ty≥Höt
 =
VECTOR_TYPE_FLOAT32
 ){

424 *
pTy≥
 = 
VECTOR_TYPE_FLOAT32
;

425 }if–
ty≥Höt
 =
VECTOR_TYPE_FLOAT64
 ){

426 *
pTy≥
 = 
VECTOR_TYPE_FLOAT64
;

428 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "unexpected vectorÅype");

431 *
pDims
 = 0;

432 
iText
 = 0; iTexà< 
ãxtByãs
; iText++){

433 if–
ãxt
[
iText
] == ',' ){

434 *
pDims
 += 1;

436 if–
	`sqlôe4Isdigô
(
ãxt
[
iText
]) ){

437 
ãxtHasDigô
 = 1;

440 if–
ãxtHasDigô
 ){

441 *
pDims
 += 1;

444 
	}
}

446 
	$dëe˘Ve˘‹P¨amëîs
(
sqlôe4_vÆue
 *
¨g
, 
ty≥Höt
, *
pTy≥
, *
pDims
, **
pzEºMsg
) {

447  
	`sqlôe4_vÆue_ty≥
(
¨g
) ){

448 
SQLITE4_BLOB
:

449  
	`dëe˘BlobVe˘‹P¨amëîs
(
¨g
, 
pTy≥
, 
pDims
, 
pzEºMsg
);

450 
SQLITE4_TEXT
:

451  
	`dëe˘TextVe˘‹P¨amëîs
(
¨g
, 
ty≥Höt
, 
pTy≥
, 
pDims
, 
pzEºMsg
);

453 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: u√x≥˘ed vÆuêty≥: gŸ %s,Éx≥˘ed TEXT o∏BLOB", 
	`sqlôe4_ty≥_ª¥
(
	`sqlôe4_vÆue_ty≥
(
¨g
)));

456 
	}
}

458 
	$ve˘‹P¨£WôhTy≥
(

459 
sqlôe4_vÆue
 *
¨g
,

460 
Ve˘‹
 *
pVe˘‹
,

461 **
pzEºMsg


463  
	`sqlôe4_vÆue_ty≥
(
¨g
) ){

464 
SQLITE4_BLOB
:

465  
	`ve˘‹P¨£SqlôeBlobWôhTy≥
(
¨g
, 
pVe˘‹
, 
pzEºMsg
);

466 
SQLITE4_TEXT
:

467  
	`ve˘‹P¨£SqlôeText
(
¨g
, 
pVe˘‹
, 
pzEºMsg
);

469 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹: u√x≥˘ed vÆuêty≥: gŸ %s,Éx≥˘ed TEXT o∏BLOB", 
	`sqlôe4_ty≥_ª¥
(
	`sqlôe4_vÆue_ty≥
(
¨g
)));

472 
	}
}

474 
	$ve˘‹Dump
(c⁄° 
Ve˘‹
 *
pVe˘‹
){

475 
pVe˘‹
->
ty≥
) {

476 
VECTOR_TYPE_FLOAT32
:

477 
	`ve˘‹F32Dump
(
pVe˘‹
);

479 
VECTOR_TYPE_FLOAT64
:

480 
	`ve˘‹F64Dump
(
pVe˘‹
);

482 
VECTOR_TYPE_FLOAT1BIT
:

483 
	`ve˘‹1BôDump
(
pVe˘‹
);

485 
VECTOR_TYPE_FLOAT8
:

486 
	`ve˘‹F8Dump
(
pVe˘‹
);

488 
VECTOR_TYPE_FLOAT16
:

489 
	`ve˘‹F16Dump
(
pVe˘‹
);

491 
VECTOR_TYPE_FLOATB16
:

492 
	`ve˘‹FB16Dump
(
pVe˘‹
);

495 
	`as£π
(0);

497 
	}
}

499 
	$ve˘‹M¨shÆToText
(

500 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

501 c⁄° 
Ve˘‹
 *
pVe˘‹


503 
pVe˘‹
->
ty≥
) {

504 
VECTOR_TYPE_FLOAT32
:

505 
	`ve˘‹F32M¨shÆToText
(
c⁄ãxt
, 
pVe˘‹
);

507 
VECTOR_TYPE_FLOAT64
:

508 
	`ve˘‹F64M¨shÆToText
(
c⁄ãxt
, 
pVe˘‹
);

511 
	`as£π
(0);

513 
	}
}

515 
	$ve˘‹MëaSize
(
Ve˘‹Ty≥
 
ty≥
, 
Ve˘‹Dims
 
dims
){

516 
nD©aSize
;

517 if–
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

519 }if–
ty≥
 =
VECTOR_TYPE_FLOAT64
 ||Åy≥ =
VECTOR_TYPE_FLOAT16
 ||Åy≥ =
VECTOR_TYPE_FLOATB16
 ){

521 }if–
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

522 
nD©aSize
 = 
	`ve˘‹D©aSize
(
ty≥
, 
dims
);

524  (
nD©aSize
 % 2 == 0 ? 1 : 0) + 1 + 1;

525 }if–
ty≥
 =
VECTOR_TYPE_FLOAT8
 ){

526 
nD©aSize
 = 
	`ve˘‹D©aSize
(
ty≥
, 
dims
);

527 
	`as£π
–
nD©aSize
 % 2 == 0 );

531 
	`as£π
( 0 );

533 
	}
}

535 
	$ve˘‹SîülizeMëa
(c⁄° 
Ve˘‹
 *
pVe˘‹
, 
size_t
 
nD©aSize
, *
pBlob
, size_à
nBlobSize
){

536 if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

538 }if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ||ÖVe˘‹->ty≥ =
VECTOR_TYPE_FLOAT16
 ||ÖVe˘‹->ty≥ =
VECTOR_TYPE_FLOATB16
 ){

539 
	`as£π
–
nD©aSize
 % 2 == 0 );

540 
	`as£π
–
nBlobSize
 =
nD©aSize
 + 1 );

541 
pBlob
[
nBlobSize
 - 1] = 
pVe˘‹
->
ty≥
;

542 }if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

543 
	`as£π
–
nBlobSize
 % 2 == 1 );

544 
	`as£π
–
nBlobSize
 >= 3 );

545 
pBlob
[
nBlobSize
 - 1] = 
pVe˘‹
->
ty≥
;

546 
pBlob
[
nBlobSize
 - 2] = 8 * (nBlobSizê- 1Ë- 
pVe˘‹
->
dims
;

547 if–
	`ve˘‹MëaSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) == 3 ){

548 
pBlob
[
nBlobSize
 - 3] = 0;

550 }if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 ){

551 
	`as£π
–
nBlobSize
 % 2 == 1 );

552 
	`as£π
–
nD©aSize
 % 2 == 0 );

553 
	`as£π
–
nBlobSize
 =
nD©aSize
 + 3 );

554 
pBlob
[
nBlobSize
 - 1] = 
pVe˘‹
->
ty≥
;

555 
pBlob
[
nBlobSize
 - 2] = 
	`ALIGN
(
pVe˘‹
->
dims
, ()) -ÖVector->dims;

556 
pBlob
[
nBlobSize
 - 3] = 0;

558 
	`as£π
( 0 );

560 
	}
}

562 
	$ve˘‹BlobFªe
(*
p
, *
pArg
){

563 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív*)
pArg
;

564 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

565 
	}
}

567 
	$ve˘‹SîülizeWôhMëa
(

568 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

569 c⁄° 
Ve˘‹
 *
pVe˘‹


571 *
pBlob
;

572 
size_t
 
nBlobSize
, 
nD©aSize
, 
nMëaSize
;

574 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

576 
nD©aSize
 = 
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
);

577 
nMëaSize
 = 
	`ve˘‹MëaSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
);

578 
nBlobSize
 = 
nD©aSize
 + 
nMëaSize
;

579 if–
nBlobSize
 == 0 ){

580 
	`sqlôe4_ªsu…_zîoblob
(
c⁄ãxt
, 0);

584 
pBlob
 = 
	`sqlôe4_mÆloc
(0, 
nBlobSize
);

585 if–
pBlob
 =
NULL
 ){

586 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

590 
	`ve˘‹SîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nD©aSize
);

591 
	`ve˘‹SîülizeMëa
(
pVe˘‹
, 
nD©aSize
, 
pBlob
, 
nBlobSize
);

592 
	`sqlôe4_ªsu…_blob
(
c⁄ãxt
, (*)
pBlob
, 
nBlobSize
, 
ve˘‹BlobFªe
, 0);

593 
	}
}

595 
	$ve˘‹SîülizeToBlob
(c⁄° 
Ve˘‹
 *
pVe˘‹
, *
pBlob
, 
size_t
 
nBlobSize
){

596 
pVe˘‹
->
ty≥
) {

597 
VECTOR_TYPE_FLOAT32
:

598 
	`ve˘‹F32SîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nBlobSize
);

600 
VECTOR_TYPE_FLOAT64
:

601 
	`ve˘‹F64SîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nBlobSize
);

603 
VECTOR_TYPE_FLOAT1BIT
:

604 
	`ve˘‹1BôSîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nBlobSize
);

606 
VECTOR_TYPE_FLOAT8
:

607 
	`ve˘‹F8SîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nBlobSize
);

609 
VECTOR_TYPE_FLOAT16
:

610 
	`ve˘‹F16SîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nBlobSize
);

612 
VECTOR_TYPE_FLOATB16
:

613 
	`ve˘‹FB16SîülizeToBlob
(
pVe˘‹
, 
pBlob
, 
nBlobSize
);

616 
	`as£π
(0);

618 
	}
}

620 
	$ve˘‹InôFromBlob
(
Ve˘‹
 *
pVe˘‹
, c⁄° *
pBlob
, 
size_t
 
nBlobSize
){

621 
pVe˘‹
->
d©a
 = (*)
pBlob
;

622 
	}
}

624 
	$ve˘‹C⁄vîtFromF32
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

625 
i
;

626 *
§c
;

628 
u8
 *
d°1Bô
;

629 *
d°F64
;

630 
u16
 *
d°F16
;

632 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

633 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

634 
	`as£π
–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

636 
§c
 = 
pFrom
->
d©a
;

637 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

638 
d°F64
 = 
pTo
->
d©a
;

639 
i
 = 0; i < 
pFrom
->
dims
; i++){

640 
d°F64
[
i
] = 
§c
[i];

642 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

643 
d°1Bô
 = 
pTo
->
d©a
;

644 
i
 = 0; i < 
pFrom
->
dims
; i += 8){

645 
d°1Bô
[
i
 / 8] = 0;

647 
i
 = 0; i < 
pFrom
->
dims
; i++){

648 if–
§c
[
i
] > 0 ){

649 
d°1Bô
[
i
 / 8] |= (1 << (i & 7));

652 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

653 
d°F16
 = 
pTo
->
d©a
;

654 
i
 = 0; i < 
pFrom
->
dims
; i++){

655 
d°F16
[
i
] = 
	`ve˘‹F16FromFlﬂt
(
§c
[i]);

657 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

658 
d°F16
 = 
pTo
->
d©a
;

659 
i
 = 0; i < 
pFrom
->
dims
; i++){

660 
d°F16
[
i
] = 
	`ve˘‹FB16FromFlﬂt
(
§c
[i]);

663 
	`as£π
( 0 );

665 
	}
}

667 
	$ve˘‹C⁄vîtFromF64
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

668 
i
;

669 *
§c
;

671 
u8
 *
d°1Bô
;

672 *
d°F32
;

673 
u16
 *
d°F16
;

675 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

676 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

677 
	`as£π
–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

679 
§c
 = 
pFrom
->
d©a
;

680 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

681 
d°F32
 = 
pTo
->
d©a
;

682 
i
 = 0; i < 
pFrom
->
dims
; i++){

683 
d°F32
[
i
] = 
§c
[i];

685 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

686 
d°1Bô
 = 
pTo
->
d©a
;

687 
i
 = 0; i < 
pFrom
->
dims
; i += 8){

688 
d°1Bô
[
i
 / 8] = 0;

690 
i
 = 0; i < 
pFrom
->
dims
; i++){

691 if–
§c
[
i
] > 0 ){

692 
d°1Bô
[
i
 / 8] |= (1 << (i & 7));

695 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

696 
d°F16
 = 
pTo
->
d©a
;

697 
i
 = 0; i < 
pFrom
->
dims
; i++){

698 
d°F16
[
i
] = 
	`ve˘‹F16FromFlﬂt
(
§c
[i]);

700 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

701 
d°F16
 = 
pTo
->
d©a
;

702 
i
 = 0; i < 
pFrom
->
dims
; i++){

703 
d°F16
[
i
] = 
	`ve˘‹FB16FromFlﬂt
(
§c
[i]);

706 
	`as£π
( 0 );

708 
	}
}

710 
	$ve˘‹C⁄vîtFrom1Bô
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

711 
i
;

712 
u8
 *
§c
;

714 *
d°F32
;

715 *
d°F64
;

716 
u16
 *
d°U16
;

718 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

719 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

720 
	`as£π
–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 );

722 
§c
 = 
pFrom
->
d©a
;

723 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

724 
d°F32
 = 
pTo
->
d©a
;

725 
i
 = 0; i < 
pFrom
->
dims
; i++){

726 if–((
§c
[
i
 / 8] >> (i & 7)) & 1) == 1 ){

727 
d°F32
[
i
] = +1;

729 
d°F32
[
i
] = -1;

732 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

733 
d°F64
 = 
pTo
->
d©a
;

734 
i
 = 0; i < 
pFrom
->
dims
; i++){

735 if–((
§c
[
i
 / 8] >> (i & 7)) & 1) == 1 ){

736 
d°F64
[
i
] = +1;

738 
d°F64
[
i
] = -1;

741 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

742 
u16
 
posôive
 = 
	`ve˘‹F16FromFlﬂt
(+1);

743 
u16
 
√g©ive
 = 
	`ve˘‹F16FromFlﬂt
(-1);

744 
d°U16
 = 
pTo
->
d©a
;

745 
i
 = 0; i < 
pFrom
->
dims
; i++){

746 if–((
§c
[
i
 / 8] >> (i & 7)) & 1) == 1 ){

747 
d°U16
[
i
] = 
posôive
;

749 
d°U16
[
i
] = 
√g©ive
;

752 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

753 
u16
 
posôive
 = 
	`ve˘‹FB16FromFlﬂt
(+1);

754 
u16
 
√g©ive
 = 
	`ve˘‹FB16FromFlﬂt
(-1);

755 
d°U16
 = 
pTo
->
d©a
;

756 
i
 = 0; i < 
pFrom
->
dims
; i++){

757 if–((
§c
[
i
 / 8] >> (i & 7)) & 1) == 1 ){

758 
d°U16
[
i
] = 
posôive
;

760 
d°U16
[
i
] = 
√g©ive
;

764 
	`as£π
( 0 );

766 
	}
}

768 
	$ve˘‹C⁄vîtFromF8
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

769 
i
;

770 
u8
 *
§c
;

771 
Æpha
, 
shi·
;

773 *
d°F32
;

774 *
d°F64
;

775 
u8
 *
d°1Bô
;

776 
u16
 *
d°F16
;

778 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

779 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

780 
	`as£π
–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

782 
	`ve˘‹F8GëP¨amëîs
(
pFrom
->
d©a
,ÖFrom->
dims
, &
Æpha
, &
shi·
);

784 
§c
 = 
pFrom
->
d©a
;

785 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

786 
d°F32
 = 
pTo
->
d©a
;

787 
i
 = 0; i < 
pFrom
->
dims
; i++){

788 
d°F32
[
i
] = 
Æpha
 * 
§c
[i] + 
shi·
;

790 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

791 
d°F64
 = 
pTo
->
d©a
;

792 
i
 = 0; i < 
pFrom
->
dims
; i++){

793 
d°F64
[
i
] = 
Æpha
 * 
§c
[i] + 
shi·
;

795 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

796 
d°1Bô
 = 
pTo
->
d©a
;

797 
i
 = 0; i < 
pFrom
->
dims
; i += 8){

798 
d°1Bô
[
i
 / 8] = 0;

800 
i
 = 0; i < 
pFrom
->
dims
; i++){

801 if–(
Æpha
 * 
§c
[
i
] + 
shi·
) > 0 ){

802 
d°1Bô
[
i
 / 8] |= (1 << (i & 7));

805 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

806 
d°F16
 = 
pTo
->
d©a
;

807 
i
 = 0; i < 
pFrom
->
dims
; i++){

808 
d°F16
[
i
] = 
	`ve˘‹F16FromFlﬂt
(
Æpha
 * 
§c
[i] + 
shi·
);

810 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

811 
d°F16
 = 
pTo
->
d©a
;

812 
i
 = 0; i < 
pFrom
->
dims
; i++){

813 
d°F16
[
i
] = 
	`ve˘‹FB16FromFlﬂt
(
Æpha
 * 
§c
[i] + 
shi·
);

816 
	`as£π
( 0 );

818 
	}
}

820 
	$ve˘‹C⁄vîtFromF16
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

821 
i
;

822 
u16
 *
§c
;

824 *
d°F32
;

825 *
d°F64
;

826 
u8
 *
d°1Bô
;

827 
u16
 *
d°U16
;

829 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

830 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

831 
	`as£π
–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

833 
§c
 = 
pFrom
->
d©a
;

834 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

835 
d°F32
 = 
pTo
->
d©a
;

836 
i
 = 0; i < 
pFrom
->
dims
; i++){

837 
d°F32
[
i
] = 
	`ve˘‹F16ToFlﬂt
(
§c
[i]);

839 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

840 
d°F64
 = 
pTo
->
d©a
;

841 
i
 = 0; i < 
pFrom
->
dims
; i++){

842 
d°F64
[
i
] = 
	`ve˘‹F16ToFlﬂt
(
§c
[i]);

844 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

845 
d°U16
 = 
pTo
->
d©a
;

846 
i
 = 0; i < 
pFrom
->
dims
; i++){

847 
d°U16
[
i
] = 
	`ve˘‹FB16FromFlﬂt
(
	`ve˘‹F16ToFlﬂt
(
§c
[i]));

849 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

850 
d°1Bô
 = 
pTo
->
d©a
;

851 
i
 = 0; i < 
pFrom
->
dims
; i += 8){

852 
d°1Bô
[
i
 / 8] = 0;

854 
i
 = 0; i < 
pFrom
->
dims
; i++){

855 if–
	`ve˘‹F16ToFlﬂt
(
§c
[
i
]) > 0 ){

856 
d°1Bô
[
i
 / 8] |= (1 << (i & 7));

860 
	`as£π
( 0 );

862 
	}
}

864 
	$ve˘‹C⁄vîtFromFB16
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

865 
i
;

866 
u16
 *
§c
;

868 *
d°F32
;

869 *
d°F64
;

870 
u8
 *
d°1Bô
;

871 
u16
 *
d°U16
;

873 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

874 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

875 
	`as£π
–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

877 
§c
 = 
pFrom
->
d©a
;

878 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

879 
d°F32
 = 
pTo
->
d©a
;

880 
i
 = 0; i < 
pFrom
->
dims
; i++){

881 
d°F32
[
i
] = 
	`ve˘‹FB16ToFlﬂt
(
§c
[i]);

883 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

884 
d°F64
 = 
pTo
->
d©a
;

885 
i
 = 0; i < 
pFrom
->
dims
; i++){

886 
d°F64
[
i
] = 
	`ve˘‹FB16ToFlﬂt
(
§c
[i]);

888 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

889 
d°U16
 = 
pTo
->
d©a
;

890 
i
 = 0; i < 
pFrom
->
dims
; i++){

891 
d°U16
[
i
] = 
	`ve˘‹F16FromFlﬂt
(
	`ve˘‹FB16ToFlﬂt
(
§c
[i]));

893 }if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

894 
d°1Bô
 = 
pTo
->
d©a
;

895 
i
 = 0; i < 
pFrom
->
dims
; i += 8){

896 
d°1Bô
[
i
 / 8] = 0;

898 
i
 = 0; i < 
pFrom
->
dims
; i++){

899 if–
	`ve˘‹FB16ToFlﬂt
(
§c
[
i
]) > 0 ){

900 
d°1Bô
[
i
 / 8] |= (1 << (i & 7));

904 
	`as£π
( 0 );

906 
	}
}

908 
ölöe
 
	$˛ù
(
f
, 
möF
, 
maxF
){

909 if–
f
 < 
möF
 ){

910  
möF
;

911 }if–
f
 > 
maxF
 ){

912  
maxF
;

914  ()(
f
 + 0.5);

915 
	}
}

917 
	#MINMAX
(
i
, 
vÆue
, 
möVÆue
, 
maxVÆue
Ë{if(ò=0){ möVÆuê(vÆue); maxVÆuê(vÆue);} { möVÆuê
	`MIN
(möVÆue, (vÆue)); maxVÆuê
	`MAX
(maxVÆue, (vÆue)); }}

	)

919 
	$ve˘‹C⁄vîtToF8
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

920 
i
;

921 
u8
 *
d°
;

922 
Æpha
, 
shi·
;

923 
möF
 = 0, 
maxF
 = 0;

925 *
§cF32
;

926 *
§cF64
;

927 
u8
 *
§c1Bô
;

928 
u16
 *
§cU16
;

930 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

931 
	`as£π
–
pFrom
->
ty≥
 !
pTo
->type );

932 
	`as£π
–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

934 
d°
 = 
pTo
->
d©a
;

935 if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

936 
§cF32
 = 
pFrom
->
d©a
;

937 
i
 = 0; i < 
pFrom
->
dims
; i++){

938 
	`MINMAX
(
i
, 
§cF32
[i], 
möF
, 
maxF
);

940 
shi·
 = 
möF
;

941 
Æpha
 = (
maxF
 - 
möF
) / 255;

942 
i
 = 0; i < 
pFrom
->
dims
; i++){

943 
d°
[
i
] = 
	`˛ù
((
§cF32
[i] - 
shi·
Ë/ 
Æpha
, 0, 255);

945 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

946 
§cF64
 = 
pFrom
->
d©a
;

947 
i
 = 0; i < 
pFrom
->
dims
; i++){

948 
	`MINMAX
(
i
, 
§cF64
[i], 
möF
, 
maxF
);

950 
shi·
 = 
möF
;

951 
Æpha
 = (
maxF
 - 
möF
) / 255;

952 
i
 = 0; i < 
pFrom
->
dims
; i++){

953 
d°
[
i
] = 
	`˛ù
((
§cF64
[i] - 
shi·
Ë/ 
Æpha
, 0, 255);

955 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

956 
§c1Bô
 = 
pFrom
->
d©a
;

957 
i
 = 0; i < 
pFrom
->
dims
; i++){

958 
	`MINMAX
(
i
, ((
§c1Bô
[ò/ 8] >> (ò& 7)Ë& 1Ë? +1 : -1, 
möF
, 
maxF
);

960 
shi·
 = 
möF
;

961 
Æpha
 = (
maxF
 - 
möF
) / 255;

962 
i
 = 0; i < 
pFrom
->
dims
; i++){

963 
d°
[
i
] = 
	`˛ù
(((((
§c1Bô
[ò/ 8] >> (ò& 7)Ë& 1Ë? +1 : -1Ë- 
shi·
Ë/ 
Æpha
, 0, 255);

965 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

966 
§cU16
 = 
pFrom
->
d©a
;

967 
i
 = 0; i < 
pFrom
->
dims
; i++){

968 
	`MINMAX
(
i
, 
	`ve˘‹F16ToFlﬂt
(
§cU16
[i]), 
möF
, 
maxF
);

970 
shi·
 = 
möF
;

971 
Æpha
 = (
maxF
 - 
möF
) / 255;

972 
i
 = 0; i < 
pFrom
->
dims
; i++){

973 
d°
[
i
] = 
	`˛ù
((
	`ve˘‹F16ToFlﬂt
(
§cU16
[i]Ë- 
shi·
Ë/ 
Æpha
, 0, 255);

975 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

976 
§cU16
 = 
pFrom
->
d©a
;

977 
i
 = 0; i < 
pFrom
->
dims
; i++){

978 
	`MINMAX
(
i
, 
	`ve˘‹FB16ToFlﬂt
(
§cU16
[i]), 
möF
, 
maxF
);

980 
shi·
 = 
möF
;

981 
Æpha
 = (
maxF
 - 
möF
) / 255;

982 
i
 = 0; i < 
pFrom
->
dims
; i++){

983 
d°
[
i
] = 
	`˛ù
((
	`ve˘‹FB16ToFlﬂt
(
§cU16
[i]Ë- 
shi·
Ë/ 
Æpha
, 0, 255);

986 
	`as£π
( 0 );

988 
	`ve˘‹F8SëP¨amëîs
(
pTo
->
d©a
,ÖTo->
dims
, 
Æpha
, 
shi·
);

989 
	}
}

992 
	$ve˘‹C⁄vît
(c⁄° 
Ve˘‹
 *
pFrom
, Ve˘‹ *
pTo
){

993 
	`as£π
–
pFrom
->
dims
 =
pTo
->dims );

995 if–
pFrom
->
ty≥
 =
pTo
->type ){

996 
	`mem˝y
(
pTo
->
d©a
, 
pFrom
->d©a, 
	`ve˘‹D©aSize
’From->
ty≥
,ÖFrom->
dims
));

1000 if–
pTo
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 ){

1001 
	`ve˘‹C⁄vîtToF8
(
pFrom
, 
pTo
);

1002 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ){

1003 
	`ve˘‹C⁄vîtFromF32
(
pFrom
, 
pTo
);

1004 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 ){

1005 
	`ve˘‹C⁄vîtFromF64
(
pFrom
, 
pTo
);

1006 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 ){

1007 
	`ve˘‹C⁄vîtFrom1Bô
(
pFrom
, 
pTo
);

1008 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 ){

1009 
	`ve˘‹C⁄vîtFromF8
(
pFrom
, 
pTo
);

1010 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 ){

1011 
	`ve˘‹C⁄vîtFromF16
(
pFrom
, 
pTo
);

1012 }if–
pFrom
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 ){

1013 
	`ve˘‹C⁄vîtFromFB16
(
pFrom
, 
pTo
);

1015 
	`as£π
( 0 );

1017 
	}
}

1026 
	$ve˘‹FuncHöãdTy≥
(

1027 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1028 
¨gc
,

1029 
sqlôe4_vÆue
 **
¨gv
,

1030 
èrgëTy≥


1032 *
pzEºMsg
 = 
NULL
;

1033 
Ve˘‹
 *
pVe˘‹
 = 
NULL
, *
pT¨gë
 = NULL;

1034 
ty≥
, 
dims
, 
ty≥Höt
 = 
VECTOR_TYPE_FLOAT32
;

1035 if–
¨gc
 < 1 ){

1036 
out
;

1039 if–
èrgëTy≥
 =
VECTOR_TYPE_FLOAT64
 ){

1040 
ty≥Höt
 = 
èrgëTy≥
;

1042 if–
	`dëe˘Ve˘‹P¨amëîs
(
¨gv
[0], 
ty≥Höt
, &
ty≥
, &
dims
, &
pzEºMsg
) != 0 ){

1043 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1044 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1045 
out
;

1047 
pVe˘‹
 = 
	`ve˘‹C⁄ãxtAŒoc
(
c⁄ãxt
, 
ty≥
, 
dims
);

1048 if–
pVe˘‹
 =
NULL
 ){

1049 
out
;

1051 if–
	`ve˘‹P¨£WôhTy≥
(
¨gv
[0], 
pVe˘‹
, &
pzEºMsg
) != 0 ){

1052 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1053 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1054 
out
;

1056 if–
ty≥
 =
èrgëTy≥
 ){

1057 
	`ve˘‹SîülizeWôhMëa
(
c⁄ãxt
, 
pVe˘‹
);

1059 
pT¨gë
 = 
	`ve˘‹C⁄ãxtAŒoc
(
c⁄ãxt
, 
èrgëTy≥
, 
dims
);

1060 if–
pT¨gë
 =
NULL
 ){

1061 
out
;

1063 
	`ve˘‹C⁄vît
(
pVe˘‹
, 
pT¨gë
);

1064 
	`ve˘‹SîülizeWôhMëa
(
c⁄ãxt
, 
pT¨gë
);

1066 
out
:

1067 if–
pVe˘‹
 !
NULL
 ){

1068 
	`ve˘‹Fªe
(
pVe˘‹
);

1070 if–
pT¨gë
 !
NULL
 ){

1071 
	`ve˘‹Fªe
(
pT¨gë
);

1073 
	}
}

1075 
	$ve˘‹32Func
(

1076 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1077 
¨gc
,

1078 
sqlôe4_vÆue
 **
¨gv


1080 
	`ve˘‹FuncHöãdTy≥
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
VECTOR_TYPE_FLOAT32
);

1081 
	}
}

1082 
	$ve˘‹64Func
(

1083 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1084 
¨gc
,

1085 
sqlôe4_vÆue
 **
¨gv


1087 
	`ve˘‹FuncHöãdTy≥
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
VECTOR_TYPE_FLOAT64
);

1088 
	}
}

1090 
	$ve˘‹8Func
(

1091 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1092 
¨gc
,

1093 
sqlôe4_vÆue
 **
¨gv


1095 
	`ve˘‹FuncHöãdTy≥
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
VECTOR_TYPE_FLOAT8
);

1096 
	}
}

1098 
	$ve˘‹16Func
(

1099 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1100 
¨gc
,

1101 
sqlôe4_vÆue
 **
¨gv


1103 
	`ve˘‹FuncHöãdTy≥
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
VECTOR_TYPE_FLOAT16
);

1104 
	}
}

1106 
	$ve˘‹b16Func
(

1107 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1108 
¨gc
,

1109 
sqlôe4_vÆue
 **
¨gv


1111 
	`ve˘‹FuncHöãdTy≥
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
VECTOR_TYPE_FLOATB16
);

1112 
	}
}

1114 
	$ve˘‹1BôFunc
(

1115 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1116 
¨gc
,

1117 
sqlôe4_vÆue
 **
¨gv


1119 
	`ve˘‹FuncHöãdTy≥
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
VECTOR_TYPE_FLOAT1BIT
);

1120 
	}
}

1125 
	$ve˘‹Exåa˘Func
(

1126 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1127 
¨gc
,

1128 
sqlôe4_vÆue
 **
¨gv


1130 *
pzEºMsg
 = 
NULL
;

1131 
Ve˘‹
 *
pVe˘‹
 = 
NULL
, *
pT¨gë
 = NULL;

1132 
i
;

1133 
ty≥
, 
dims
;

1135 if–
¨gc
 < 1 ){

1136 
out
;

1138 if–
	`dëe˘Ve˘‹P¨amëîs
(
¨gv
[0], 0, &
ty≥
, &
dims
, &
pzEºMsg
) != 0 ){

1139 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1140 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1141 
out
;

1143 
pVe˘‹
 = 
	`ve˘‹C⁄ãxtAŒoc
(
c⁄ãxt
, 
ty≥
, 
dims
);

1144 if–
pVe˘‹
 =
NULL
 ){

1145 
out
;

1147 if–
	`ve˘‹P¨£WôhTy≥
(
¨gv
[0], 
pVe˘‹
, &
pzEºMsg
)<0 ){

1148 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1149 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1150 
out
;

1152 if–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 ||ÖVe˘‹->ty≥ =
VECTOR_TYPE_FLOAT64
 ){

1153 
	`ve˘‹M¨shÆToText
(
c⁄ãxt
, 
pVe˘‹
);

1155 
pT¨gë
 = 
	`ve˘‹C⁄ãxtAŒoc
(
c⁄ãxt
, 
VECTOR_TYPE_FLOAT32
, 
dims
);

1156 if–
pT¨gë
 =
NULL
 ){

1157 
out
;

1159 
	`ve˘‹C⁄vît
(
pVe˘‹
, 
pT¨gë
);

1160 
	`ve˘‹M¨shÆToText
(
c⁄ãxt
, 
pT¨gë
);

1162 
out
:

1163 if–
pVe˘‹
 !
NULL
 ){

1164 
	`ve˘‹Fªe
(
pVe˘‹
);

1166 if–
pT¨gë
 !
NULL
 ){

1167 
	`ve˘‹Fªe
(
pT¨gë
);

1169 
	}
}

1171 
ve˘‹Di°™˚Func
(

1172 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

1173 
¨gc
,

1174 
sqlôe4_vÆue
 **
¨gv
,

1175 (*
ve˘‹Di°™˚
)(c⁄° 
Ve˘‹
 *
pVe˘‹1
, c⁄° Ve˘‹ *
pVe˘‹2
)

1177 *
pzEºMsg
 = 
NULL
;

1178 
Ve˘‹
 *
pVe˘‹1
 = 
NULL
, *
pVe˘‹2
 = NULL;

1179 
ty≥1
, 
ty≥2
;

1180 
dims1
, 
dims2
;

1181 if–
¨gc
 < 2 ) {

1184 if–
	`dëe˘Ve˘‹P¨amëîs
(
¨gv
[0], 0, &
ty≥1
, &
dims1
, &
pzEºMsg
) != 0 ){

1185 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1186 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1187 
out_‰ì
;

1189 if–
	`dëe˘Ve˘‹P¨amëîs
(
¨gv
[1], 0, &
ty≥2
, &
dims2
, &
pzEºMsg
) != 0 ){

1190 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1191 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1192 
out_‰ì
;

1194 if–
ty≥1
 !
ty≥2
 ){

1195 
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹_di°™˚: ve˘‹†mu° havêthêßmêty≥: %d !%d", 
ty≥1
, 
ty≥2
);

1196 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1197 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1198 
out_‰ì
;

1200 if–
dims1
 !
dims2
 ){

1201 
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹_di°™˚: ve˘‹†mu° havêthêßmêÀngth: %d !%d", 
dims1
, 
dims2
);

1202 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1203 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1204 
out_‰ì
;

1206 if–
ve˘‹Di°™˚
 =
ve˘‹Di°™˚L2
 && 
ty≥1
 =
VECTOR_TYPE_FLOAT1BIT
 ){

1207 
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(0, "ve˘‹_di°™˚:Ü2 di°™˚ i†nŸ suµ‹ãd f‹ flﬂt1bô ve˘‹s", 
dims1
, 
dims2
);

1208 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1209 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1210 
out_‰ì
;

1212 
pVe˘‹1
 = 
	`ve˘‹C⁄ãxtAŒoc
(
c⁄ãxt
, 
ty≥1
, 
dims1
);

1213 if–
pVe˘‹1
==
NULL
 ){

1214 
out_‰ì
;

1216 
pVe˘‹2
 = 
	`ve˘‹C⁄ãxtAŒoc
(
c⁄ãxt
, 
ty≥2
, 
dims2
);

1217 if–
pVe˘‹2
==
NULL
 ){

1218 
out_‰ì
;

1220 if–
	`ve˘‹P¨£WôhTy≥
(
¨gv
[0], 
pVe˘‹1
, &
pzEºMsg
)<0 ){

1221 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1222 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1223 
out_‰ì
;

1225 if–
	`ve˘‹P¨£WôhTy≥
(
¨gv
[1], 
pVe˘‹2
, &
pzEºMsg
)<0 ){

1226 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, 
pzEºMsg
, -1);

1227 
	`sqlôe4_‰ì
(0, 
pzEºMsg
);

1228 
out_‰ì
;

1230 
	`sqlôe4_ªsu…_doubÀ
(
c⁄ãxt
, 
	`ve˘‹Di°™˚
(
pVe˘‹1
, 
pVe˘‹2
));

1231 
out_‰ì
:

1232 if–
pVe˘‹2
 ){

1233 
	`ve˘‹Fªe
(
pVe˘‹2
);

1235 if–
pVe˘‹1
 ){

1236 
	`ve˘‹Fªe
(
pVe˘‹1
);

1238 
	}
}

1243 
	$ve˘‹Di°™˚CosFunc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1244 
	`ve˘‹Di°™˚Func
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
ve˘‹Di°™˚Cos
);

1245 
	}
}

1250 
	$ve˘‹Di°™˚L2Func
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1251 
	`ve˘‹Di°™˚Func
(
c⁄ãxt
, 
¨gc
, 
¨gv
, 
ve˘‹Di°™˚L2
);

1252 
	}
}

1257 
	$libsqlVe˘‹Idx
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1259 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[0]);

1260 
	}
}

1265 
	$sqlôe4Regi°îVe˘‹Fun˘i⁄s
(
sqlôe4_ív
 *
pEnv
){

1266 
FuncDef
 
aVe˘‹Funcs
[] = {

1267 
	`FUNCTION
(
ve˘‹
, 1, 0, 0, 
ve˘‹32Func
),

1268 
	`FUNCTION
(
ve˘‹32
, 1, 0, 0, 
ve˘‹32Func
),

1269 
	`FUNCTION
(
ve˘‹64
, 1, 0, 0, 
ve˘‹64Func
),

1270 
	`FUNCTION
(
ve˘‹1bô
, 1, 0, 0, 
ve˘‹1BôFunc
),

1271 
	`FUNCTION
(
ve˘‹8
, 1, 0, 0, 
ve˘‹8Func
),

1272 
	`FUNCTION
(
ve˘‹16
, 1, 0, 0, 
ve˘‹16Func
),

1273 
	`FUNCTION
(
ve˘‹b16
, 1, 0, 0, 
ve˘‹b16Func
),

1274 
	`FUNCTION
(
ve˘‹_exåa˘
, 1, 0, 0, 
ve˘‹Exåa˘Func
),

1275 
	`FUNCTION
(
ve˘‹_di°™˚_cos
, 2, 0, 0, 
ve˘‹Di°™˚CosFunc
),

1276 
	`FUNCTION
(
ve˘‹_di°™˚_l2
, 2, 0, 0, 
ve˘‹Di°™˚L2Func
),

1277 
	`FUNCTION
(
libsql_ve˘‹_idx
, -1, 0, 0, 
libsqlVe˘‹Idx
),

1280 
i
;

1281 
FuncDefTabÀ
 *
pFuncTab
 = &
pEnv
->
aGlobÆFuncs
;

1282 
FuncDef
 *
aFunc
 = (FuncDef*)
aVe˘‹Funcs
;

1284 
i
=0; i<
	`AºaySize
(
aVe˘‹Funcs
); i++){

1285 
	`sqlôe4FuncDefIn£π
(
pFuncTab
, &
aFunc
[
i
], 1);

1287 
	}
}

	@src/vectorIndex.c

34 #i‚de‡
SQLITE_OMIT_VECTOR


35 
	~"sqlôe4.h
"

36 
	~"sqlôeI¡.h
"

37 
	~"vdbeI¡.h
"

38 
	~"lsmI¡.h
"

39 
	~"ve˘‹IndexI¡.h
"

62 
	$ve˘‹IdxP¨amsInô
(
Ve˘‹IdxP¨ams
 *
pP¨ams
, 
u8
 *
pBöBuf
, 
nBöSize
) {

63 
	`as£π
–
nBöSize
 <
VECTOR_INDEX_PARAMS_BUF_SIZE
 );

65 
pP¨ams
->
nBöSize
 =ÇBinSize;

66 if–
pBöBuf
 !
NULL
 ){

67 
	`mem˝y
(
pP¨ams
->
pBöBuf
,ÖBöBuf, 
nBöSize
);

69 
	}
}

71 
u64
 
	$ve˘‹IdxP¨amsGëU64
(c⁄° 
Ve˘‹IdxP¨ams
 *
pP¨ams
, 
èg
) {

72 
i
, 
off£t
;

73 
u64
 
vÆue
 = 0;

74 
i
 = 0; i + 9 <
pP¨ams
->
nBöSize
; i += 9){

75 if–
pP¨ams
->
pBöBuf
[
i
] !
èg
 ){

79 
vÆue
 = 0;

80 
off£t
 = 0; offset < 8; offset++){

81 
vÆue
 |((
u64
)(
pP¨ams
->
pBöBuf
[
i
 + 1 + 
off£t
]) << (u64)(8 * offset));

84  
vÆue
;

85 
	}
}

87 
	$ve˘‹IdxP¨amsPutU64
(
Ve˘‹IdxP¨ams
 *
pP¨ams
, 
èg
, 
u64
 
vÆue
) {

88 
i
;

89 if–
pP¨ams
->
nBöSize
 + 9 > 
VECTOR_INDEX_PARAMS_BUF_SIZE
 ){

92 
pP¨ams
->
pBöBuf
[pP¨ams->
nBöSize
++] = 
èg
;

93 
i
 = 0; i < 8; i++){

94 
pP¨ams
->
pBöBuf
[pP¨ams->
nBöSize
++] = 
vÆue
 & 0xff;

95 
vÆue
 >>= 8;

98 
	}
}

100 
	$ve˘‹IdxP¨amsGëF64
(c⁄° 
Ve˘‹IdxP¨ams
 *
pP¨ams
, 
èg
) {

101 
u64
 
vÆue
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
èg
);

102  *((*)&
vÆue
);

103 
	}
}

105 
	$ve˘‹IdxP¨amsPutF64
(
Ve˘‹IdxP¨ams
 *
pP¨ams
, 
èg
, 
vÆue
) {

106  
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
èg
, *((
u64
*)&
vÆue
));

107 
	}
}

114 
	$ve˘‹IdxKeyGë
(c⁄° 
Index
 *
pIndex
, 
Ve˘‹IdxKey
 *
pKey
, c⁄° **
pzEºMsg
) {

115 
TabÀ
 *
pTabÀ
;

116 
Index
 *
pPkIndex
;

117 
i
, 
nKeyCﬁumns
;

119 
pTabÀ
 = 
pIndex
->pTable;

122 
pPkIndex
 = 
	`sqlôe4FödPrim¨yKey
(
pTabÀ
, 0);

125 if–
pPkIndex
 == 0 ){

126 
pKey
->
nKeyCﬁumns
 = 1;

127 
pKey
->
aKeyAfföôy
[0] = 
SQLITE4_AFF_INTEGER
;

128 
pKey
->
azKeyCﬁœti⁄
[0] = "binary";

132 
nKeyCﬁumns
 = 
pPkIndex
->
nCﬁumn
;

134 if–
nKeyCﬁumns
 > 
VECTOR_INDEX_MAX_KEY_COLUMNS
 ){

135 *
pzEºMsg
 = "exceededÜimit for composite columns inÖrimary key index";

139 
pKey
->
nKeyCﬁumns
 =ÇKeyColumns;

140 
i
 = 0; i < 
nKeyCﬁumns
; i++){

141 
iCﬁ
 = 
pPkIndex
->
aiCﬁumn
[
i
];

142 
pKey
->
aKeyAfföôy
[
i
] = 
pTabÀ
->
aCﬁ
[
iCﬁ
].
afföôy
;

143 
pKey
->
azKeyCﬁœti⁄
[
i
] = 
pPkIndex
->
azCﬁl
[i];

146 
	}
}

148 
	$ve˘‹IdxKeyRowidLike
(c⁄° 
Ve˘‹IdxKey
 *
pKey
){

149  
pKey
->
nKeyCﬁumns
 == 1

150 && (
pKey
->
aKeyAfföôy
[0] =
SQLITE4_AFF_INTEGER
 ||ÖKey->aKeyAffinity[0] == 0)

151 && (
pKey
->
azKeyCﬁœti⁄
[0] =0 || 
	`sqlôe4_°ricmp
(pKey->azKeyCollation[0], "binary") == 0);

152 
	}
}

154 c⁄° *
	$ve˘‹IdxSqlTy≥FromSqlôe4Aff
(
aff
){

155  
aff
 ){

156 
SQLITE4_AFF_TEXT
:  " TEXT";

157 
SQLITE4_AFF_NONE
:  " BLOB";

158 
SQLITE4_AFF_NUMERIC
:  " NUMERIC";

159 
SQLITE4_AFF_INTEGER
:  " INTEGER";

160 
SQLITE4_AFF_REAL
:  " REAL";

163 
	}
}

165 
	$ve˘‹IdxKeyDefsRídî
(

166 c⁄° 
Ve˘‹IdxKey
 *
pKey
,

167 c⁄° *
¥efix
,

168 *
pBuf
,

169 
nBufSize


171 
i
, 
size
;

173 
i
 = 0; i < 
pKey
->
nKeyCﬁumns
 && 
nBufSize
 > 0; i++){

174 c⁄° *
cﬁœti⁄
 = 
pKey
->
azKeyCﬁœti⁄
[
i
];

175 if–
cﬁœti⁄
==0 ) collation = "";

178 if–
cﬁœti⁄
[0] && 
	`sqlôe4_°∫icmp
(collation, "binary", 6) == 0 ){

179 
cﬁœti⁄
 = "";

182 c⁄° *
zTy≥
 = 
	`ve˘‹IdxSqlTy≥FromSqlôe4Aff
(()
pKey
->
aKeyAfföôy
[
i
]);

184 if–
i
 == 0 ){

185 
size
 = 
	`¢¥ötf
(
pBuf
, 
nBufSize
, "%s%†%s", 
¥efix
, 
zTy≥
, 
cﬁœti⁄
);

187 
size
 = 
	`¢¥ötf
(
pBuf
, 
nBufSize
, ",%s%d%†%s", 
¥efix
, 
i
, 
zTy≥
, 
cﬁœti⁄
);

190 if–
size
 < 0 || sizê>
nBufSize
 ){

193 
pBuf
 +
size
;

194 
nBufSize
 -
size
;

197  (
nBufSize
 > 0) ? 0 : -1;

198 
	}
}

201 
	$ve˘‹IdxKeyNamesRídî
(
nKeyCﬁumns
, c⁄° *
¥efix
, *
pBuf
, 
nBufSize
) {

202 
i
, 
size
;

203 
i
 = 0; i < 
nKeyCﬁumns
 && 
nBufSize
 > 0; i++){

204 if–
i
 == 0 ){

205 
size
 = 
	`¢¥ötf
(
pBuf
, 
nBufSize
, "%s", 
¥efix
);

207 
size
 = 
	`¢¥ötf
(
pBuf
, 
nBufSize
, ",%s%d", 
¥efix
, 
i
);

209 if–
size
 < 0 ){

212 
pBuf
 +
size
;

213 
nBufSize
 -
size
;

215 if–
nBufSize
 <= 0 ){

219 
	}
}

225 
sqlôe4_vÆue
* 
	$ve˘‹InRowKey
(c⁄° 
Ve˘‹InRow
 *
pVe˘‹InRow
, 
iKey
) {

226 
	`as£π
–0 <
iKey
 && iKey < 
pVe˘‹InRow
->
nKeys
 );

227  
pVe˘‹InRow
->
pKeyVÆues
 + 
iKey
;

228 
	}
}

230 
i64
 
	$ve˘‹InRowLegacyId
(c⁄° 
Ve˘‹InRow
 *
pVe˘‹InRow
) {

231 if–
pVe˘‹InRow
->
nKeys
 =1 && 
	`sqlôe4_vÆue_ty≥
(&pVe˘‹InRow->
pKeyVÆues
[0]Ë=
SQLITE4_INTEGER
 ){

232  
	`sqlôe4_vÆue_öt64
(
pVe˘‹InRow
->
pKeyVÆues
);

235 
	}
}

237 
	$ve˘‹InRowTryGëRowid
(c⁄° 
Ve˘‹InRow
 *
pVe˘‹InRow
, 
u64
 *
nRowid
) {

238 if–
pVe˘‹InRow
->
nKeys
 != 1 ){

241 if–
	`sqlôe4_vÆue_ty≥
(
	`ve˘‹InRowKey
(
pVe˘‹InRow
, 0)Ë!
SQLITE4_INTEGER
 ){

244 *
nRowid
 = 
	`sqlôe4_vÆue_öt64
(
	`ve˘‹InRowKey
(
pVe˘‹InRow
, 0));

246 
	}
}

248 
	$ve˘‹InRowPœ˚hﬁdîRídî
(c⁄° 
Ve˘‹InRow
 *
pVe˘‹InRow
, *
pBuf
, 
nBufSize
) {

249 
i
;

250 
	`as£π
–
pVe˘‹InRow
->
nKeys
 > 0 );

251 if–
nBufSize
 < 2 * 
pVe˘‹InRow
->
nKeys
 ){

254 
i
 = 0; i < 
pVe˘‹InRow
->
nKeys
; i++){

255 *(
pBuf
++) = '?';

256 *(
pBuf
++) = ',';

258 *(
pBuf
 - 1) = '\0';

260 
	}
}

264 
	$ve˘‹InRowAŒoc
(
sqlôe4
 *
db
, c⁄° 
U≈ackedRec‹d
 *
pRec‹d
, 
Ve˘‹InRow
 *
pVe˘‹InRow
, **
pzEºMsg
) {

265 
rc
 = 
SQLITE4_OK
;

266 
ty≥
, 
dims
;

267 
sqlôe4_vÆue
 *
pVe˘‹VÆue
 = &
pRec‹d
->
aMem
[0];

268 
pVe˘‹InRow
->
pKeyVÆues
 = 
pRec‹d
->
aMem
 + 1;

269 
pVe˘‹InRow
->
nKeys
 = 
pRec‹d
->
nFõld
 - 1;

270 
pVe˘‹InRow
->
pVe˘‹
 = 
NULL
;

272 if–
pVe˘‹InRow
->
nKeys
 <= 0 ){

273 
rc
 = 
SQLITE4_ERROR
;

274 
out
;

277 if–
	`sqlôe4_vÆue_ty≥
(
pVe˘‹VÆue
)==
SQLITE4_NULL
 ){

278 
rc
 = 
SQLITE4_OK
;

279 
out
;

282 if–
	`dëe˘Ve˘‹P¨amëîs
(
pVe˘‹VÆue
, 
VECTOR_TYPE_FLOAT32
, &
ty≥
, &
dims
, 
pzEºMsg
) != 0 ){

283 
rc
 = 
SQLITE4_ERROR
;

284 
out
;

287 
pVe˘‹InRow
->
pVe˘‹
 = 
	`ve˘‹AŒoc
(
ty≥
, 
dims
);

288 if–
pVe˘‹InRow
->
pVe˘‹
 =
NULL
 ){

289 
rc
 = 
SQLITE4_NOMEM
;

290 
out
;

293 if–
	`sqlôe4_vÆue_ty≥
(
pVe˘‹VÆue
Ë=
SQLITE4_BLOB
 ){

294 
nBlob
 = 0;

295 
	`ve˘‹InôFromBlob
(
pVe˘‹InRow
->
pVe˘‹
, 
	`sqlôe4_vÆue_blob
(
pVe˘‹VÆue
, &
nBlob
),ÇBlob);

296 } if–
	`sqlôe4_vÆue_ty≥
(
pVe˘‹VÆue
Ë=
SQLITE4_TEXT
 ){

298 if–
	`ve˘‹P¨£WôhTy≥
(
pVe˘‹VÆue
, 
pVe˘‹InRow
->
pVe˘‹
, 
pzEºMsg
) != 0 ){

299 
rc
 = 
SQLITE4_ERROR
;

300 
out
;

303 
rc
 = 
SQLITE4_OK
;

304 
out
:

305 if–
rc
 !
SQLITE4_OK
 && 
pVe˘‹InRow
->
pVe˘‹
 !
NULL
 ){

306 
	`ve˘‹Fªe
(
pVe˘‹InRow
->
pVe˘‹
);

308  
rc
;

309 
	}
}

311 
	$ve˘‹InRowFªe
(
sqlôe4
 *
db
, 
Ve˘‹InRow
 *
pVe˘‹InRow
) {

312 
	`ve˘‹Fªe
(
pVe˘‹InRow
->
pVe˘‹
);

313 
	}
}

319 
	$ve˘‹OutRowsAŒoc
(
sqlôe4
 *
db
, 
Ve˘‹OutRows
 *
pRows
, 
nRows
, 
nCﬁs
, 
rowidLike
){

320 
	`as£π
–
nCﬁs
 > 0 && 
nRows
 >= 0 );

321 
pRows
->
nRows
 =ÇRows;

322 
pRows
->
nCﬁs
 =ÇCols;

323 
pRows
->
aI¡VÆues
 = 
NULL
;

324 
pRows
->
µVÆues
 = 
NULL
;

326 if–(
u64
)
nRows
 * (u64)
nCﬁs
 > 
VECTOR_OUT_ROWS_MAX_CELLS
 ){

327  
SQLITE4_NOMEM
;

330 if–
rowidLike
 ){

331 
	`as£π
–
nCﬁs
 == 1 );

332 
pRows
->
aI¡VÆues
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
nRows
 * (
i64
));

333 if–
pRows
->
aI¡VÆues
 =
NULL
 ){

334  
SQLITE4_NOMEM
;

337 
pRows
->
µVÆues
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nRows
 * 
nCﬁs
 * (
sqlôe4_vÆue
*));

338 if–
pRows
->
µVÆues
 =
NULL
 ){

339  
SQLITE4_NOMEM
;

342  
SQLITE4_OK
;

343 
	}
}

345 
	$ve˘‹OutRowsPut
(
Ve˘‹OutRows
 *
pRows
, 
iRow
, 
iCﬁ
, c⁄° 
u64
 *
pI¡
, 
sqlôe4_vÆue
 *
pVÆue
, 
sqlôe4
 *
db
) {

346 
sqlôe4_vÆue
 *
pC›y
;

347 
	`as£π
–0 <
iRow
 && iRow < 
pRows
->
nRows
 );

348 
	`as£π
–0 <
iCﬁ
 && iCﬁ < 
pRows
->
nCﬁs
 );

349 
	`as£π
–
pRows
->
aI¡VÆues
 !
NULL
 ||ÖRows->
µVÆues
 != NULL );

350 
	`as£π
–
pI¡
 =
NULL
 || 
pRows
->
aI¡VÆues
 != NULL );

351 
	`as£π
–
pI¡
 !
NULL
 || 
pVÆue
 != NULL );

353 if–
pRows
->
aI¡VÆues
 !
NULL
 && 
pI¡
 != NULL ){

354 
	`as£π
–
pRows
->
nCﬁs
 == 1 );

355 
pRows
->
aI¡VÆues
[
iRow
] = *
pI¡
;

356 }if–
pRows
->
aI¡VÆues
 !
NULL
 ){

357 
	`as£π
–
pRows
->
nCﬁs
 == 1 );

358 
	`as£π
–
	`sqlôe4_vÆue_ty≥
(
pVÆue
Ë=
SQLITE4_INTEGER
 );

359 
pRows
->
aI¡VÆues
[
iRow
] = 
	`sqlôe4_vÆue_öt64
(
pVÆue
);

362 
pC›y
 = 
	`sqlôe4_vÆue_dup
(
db
->
pEnv
, 
pVÆue
);

363 if–
pC›y
 =
NULL
 ){

364  
SQLITE4_NOMEM
;

366 
pRows
->
µVÆues
[
iRow
 *ÖRows->
nCﬁs
 + 
iCﬁ
] = 
pC›y
;

368  
SQLITE4_OK
;

369 
	}
}

371 
	$ve˘‹OutRowsGë
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, c⁄° 
Ve˘‹OutRows
 *
pRows
, 
iRow
, 
iCﬁ
) {

372 
	`as£π
–0 <
iRow
 && iRow < 
pRows
->
nRows
 );

373 
	`as£π
–0 <
iCﬁ
 && iCﬁ < 
pRows
->
nCﬁs
 );

374 
	`as£π
–
pRows
->
aI¡VÆues
 !
NULL
 ||ÖRows->
µVÆues
 != NULL );

375 if–
pRows
->
aI¡VÆues
 !
NULL
 ){

376 
	`as£π
–
pRows
->
nCﬁs
 == 1 );

377 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
pRows
->
aI¡VÆues
[
iRow
]);

379 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
pRows
->
µVÆues
[
iRow
 *ÖRows->
nCﬁs
 + 
iCﬁ
]);

381 
	}
}

383 
	$ve˘‹OutRowsFªe
(
sqlôe4
 *
db
, 
Ve˘‹OutRows
 *
pRows
) {

384 
i
;

387 
	`as£π
–
pRows
->
aI¡VÆues
 =
NULL
 ||ÖRows->
µVÆues
 == NULL );

389 if–
pRows
->
aI¡VÆues
 !
NULL
 ){

390 
	`sqlôe4DbFªe
(
db
, 
pRows
->
aI¡VÆues
);

391 }if–
pRows
->
µVÆues
 !
NULL
 ){

392 
i
 = 0; i < 
pRows
->
nRows
 *ÖRows->
nCﬁs
; i++){

393 if–
pRows
->
µVÆues
[
i
] !
NULL
 ){

394 
	`sqlôe4_vÆue_‰ì
(
pRows
->
µVÆues
[
i
]);

397 
	`sqlôe4DbFªe
(
db
, 
pRows
->
µVÆues
);

399 
	}
}

408 
	sVe˘‹CﬁumnTy≥
 {

409 c⁄° *
	mzName
;

410 
	mty≥
;

413 
Ve˘‹CﬁumnTy≥
 
	gVECTOR_COLUMN_TYPES
[] = {

414 { "FLOAT32", 
VECTOR_TYPE_FLOAT32
 },

415 { "F32_BLOB", 
VECTOR_TYPE_FLOAT32
 },

416 { "FLOAT64", 
VECTOR_TYPE_FLOAT64
 },

417 { "F64_BLOB", 
VECTOR_TYPE_FLOAT64
 },

418 { "FLOAT1BIT", 
VECTOR_TYPE_FLOAT1BIT
 },

419 { "F1BIT_BLOB", 
VECTOR_TYPE_FLOAT1BIT
 },

420 { "FLOAT8", 
VECTOR_TYPE_FLOAT8
 },

421 { "F8_BLOB", 
VECTOR_TYPE_FLOAT8
 },

422 { "FLOAT16", 
VECTOR_TYPE_FLOAT16
 },

423 { "F16_BLOB", 
VECTOR_TYPE_FLOAT16
 },

424 { "FLOATB16", 
VECTOR_TYPE_FLOATB16
 },

425 { "FB16_BLOB", 
VECTOR_TYPE_FLOATB16
 },

432 
	sVe˘‹P¨amName
 {

433 c⁄° *
	mzName
;

434 
	mèg
;

435 
	mty≥
;

436 c⁄° *
	mzVÆueSå
;

437 
u64
 
	mvÆue
;

440 
Ve˘‹P¨amName
 
	gVECTOR_PARAM_NAMES
[] = {

441 { "ty≥", 
VECTOR_INDEX_TYPE_PARAM_ID
, 0, "disk™n", 
VECTOR_INDEX_TYPE_DISKANN
 },

442 { "mëric", 
VECTOR_METRIC_TYPE_PARAM_ID
, 0, "cosöe", 
VECTOR_METRIC_TYPE_COS
 },

443 { "mëric", 
VECTOR_METRIC_TYPE_PARAM_ID
, 0, "l2", 
VECTOR_METRIC_TYPE_L2
 },

444 { "com¥ess_√ighb‹s", 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
, 0, "Êﬂt1bô", 
VECTOR_TYPE_FLOAT1BIT
 },

445 { "com¥ess_√ighb‹s", 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
, 0, "Êﬂt8", 
VECTOR_TYPE_FLOAT8
 },

446 { "com¥ess_√ighb‹s", 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
, 0, "Êﬂt16", 
VECTOR_TYPE_FLOAT16
 },

447 { "com¥ess_√ighb‹s", 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
, 0, "Êﬂtb16", 
VECTOR_TYPE_FLOATB16
 },

448 { "com¥ess_√ighb‹s", 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
, 0, "Êﬂt32", 
VECTOR_TYPE_FLOAT32
 },

449 { "Æpha", 
VECTOR_PRUNING_ALPHA_PARAM_ID
, 2, 0, 0 },

450 { "£¨ch_l", 
VECTOR_SEARCH_L_PARAM_ID
, 1, 0, 0 },

451 { "ö£π_l", 
VECTOR_INSERT_L_PARAM_ID
, 1, 0, 0 },

452 { "max_√ighb‹s", 
VECTOR_MAX_NEIGHBORS_PARAM_ID
, 1, 0, 0 },

455 
	$∑r£Ve˘‹IdxP¨am
(c⁄° *
zP¨am
, 
Ve˘‹IdxP¨ams
 *
pP¨ams
, c⁄° **
pEºMsg
) {

456 
i
, 
iDñimôî
 = 0, 
nVÆueLí
 = 0;

457 c⁄° *
zVÆue
;

458  
zP¨am
[
iDñimôî
] && zParam[iDelimiter] != '=' ){

459 
iDñimôî
++;

461 if–
zP¨am
[
iDñimôî
] != '=' ){

462 *
pEºMsg
 = "unexpectedÖarameter format";

465 
zVÆue
 = 
zP¨am
 + 
iDñimôî
 + 1;

466 
nVÆueLí
 = 
	`sqlôe4SåÀn30
(
zVÆue
);

467 
i
 = 0; i < 
	`AºaySize
(
VECTOR_PARAM_NAMES
); i++){

468 if–
iDñimôî
 !
	`°æí
(
VECTOR_PARAM_NAMES
[
i
].
zName
Ë|| 
	`sqlôe4_°∫icmp
(VECTOR_PARAM_NAMES[i].zName, 
zP¨am
, iDelimiter) != 0 ){

471 if–
VECTOR_PARAM_NAMES
[
i
].
ty≥
 == 1 ){

472 
vÆue
 = 
	`sqlôe4Atoi
(
zVÆue
);

473 if–
vÆue
 == 0 ){

474 *
pEºMsg
 = "invalidÑepresentation of integer vector indexÖarameter";

477 if–
vÆue
 < 0 ){

478 *
pEºMsg
 = "integer vector indexÖarameter must beÖositive";

481 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_PARAM_NAMES
[
i
].
èg
, 
vÆue
) != 0 ){

482 *
pEºMsg
 = "unableÅo serialize integer vector indexÖarameter";

486 }if–
VECTOR_PARAM_NAMES
[
i
].
ty≥
 == 2 ){

487 
vÆue
;

489 if–
	`sqlôe4AtoF
(
zVÆue
, &
vÆue
, 
nVÆueLí
, 
SQLITE4_UTF8
) <= 0 ){

490 *
pEºMsg
 = "invalidÑepresentation of floatingÖoint vector indexÖarameter";

493 if–
	`ve˘‹IdxP¨amsPutF64
(
pP¨ams
, 
VECTOR_PARAM_NAMES
[
i
].
èg
, 
vÆue
) != 0 ){

494 *
pEºMsg
 = "unableÅo serialize floatingÖoint vector indexÖarameter";

498 }if–
VECTOR_PARAM_NAMES
[
i
].
ty≥
 == 0 ){

499 if–
	`sqlôe4_°∫icmp
(
VECTOR_PARAM_NAMES
[
i
].
zVÆueSå
, 
zVÆue
, 
nVÆueLí
) == 0 ){

500 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_PARAM_NAMES
[
i
].
èg
, VECTOR_PARAM_NAMES[i].
vÆue
) != 0 ){

501 *
pEºMsg
 = "unableÅo serialize vector indexÖarameter";

507 *
pEºMsg
 = "unexpectedÖarameterÅype";

511 *
pEºMsg
 = "invalidÖarameter";

513 
	}
}

516 
	$∑r£Ve˘‹IdxP¨ams
(
P¨£
 *
pP¨£
, 
Ve˘‹IdxP¨ams
 *
pP¨ams
, 
ty≥
, 
dims
, 
Ex¥Li°Iãm
 *
pArgLi°
, 
nArgs
) {

517 
i
;

518 c⁄° *
pEºMsg
;

519 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_FORMAT_PARAM_ID
, 
VECTOR_FORMAT_DEFAULT
) != 0 ){

520 
	`sqlôe4Eº‹Msg
(
pP¨£
, "vector index: unableÅo serialize vector indexÖarameter: format");

521  
SQLITE4_ERROR
;

523 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_TYPE_PARAM_ID
, 
ty≥
) != 0 ){

524 
	`sqlôe4Eº‹Msg
(
pP¨£
, "vector index: unableÅo serialize vector indexÖarameter:Åype");

525  
SQLITE4_ERROR
;

527 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_DIM_PARAM_ID
, 
dims
) != 0 ){

528 
	`sqlôe4Eº‹Msg
(
pP¨£
, "vector index: unableÅo serialize vector indexÖarameter: dim");

529  
SQLITE4_ERROR
;

531 
i
 = 0; i < 
nArgs
; i++){

532 
Ex¥
 *
pArgEx¥
 = 
pArgLi°
[
i
].
pEx¥
;

533 if–
pArgEx¥
->
›
 !
TK_STRING
 ){

534 
	`sqlôe4Eº‹Msg
(
pP¨£
, "vector index:állárgumentsáfter first must be strings");

535  
SQLITE4_ERROR
;

537 if–
	`∑r£Ve˘‹IdxP¨am
(
pArgEx¥
->
u
.
zTokí
, 
pP¨ams
, &
pEºMsg
) != 0 ){

538 
	`sqlôe4Eº‹Msg
(
pP¨£
, "ve˘‹ index: invÆid ve˘‹ indexÖ¨amëî '%s': %s", 
pArgEx¥
->
u
.
zTokí
, 
pEºMsg
);

539  
SQLITE4_ERROR
;

542  
SQLITE4_OK
;

543 
	}
}

552 
	sVe˘‹IdxCurs‹
 {

553 
sqlôe4
 *
	mdb
;

554 
DiskA¬Index
 *
	mpIndex
;

558 
	$skùS∑˚s
(c⁄° **
pzSå
) {

559  **
pzSå
 !'\0' && 
	`sqlôe4Is•a˚
(**pzStr) ){

560 (*
pzSå
)++;

562 
	}
}

571 
	$ve˘‹IdxP¨£CﬁumnTy≥
(c⁄° *
zTy≥
, *
pTy≥
, *
pDims
, c⁄° **
pEºMsg
){

572 
	`as£π
–
zTy≥
 !
NULL
 );

574 
dimísi⁄s
 = 0;

575 
i
;

576 
	`skùS∑˚s
(&
zTy≥
);

577 
i
 = 0; i < 
	`AºaySize
(
VECTOR_COLUMN_TYPES
); i++){

578 c⁄° * 
«me
 = 
VECTOR_COLUMN_TYPES
[
i
].
zName
;

579 c⁄° * 
zTy≥På
 = 
zTy≥
 + 
	`°æí
(
«me
);

580 if–
	`sqlôe4_°∫icmp
(
zTy≥
, 
«me
, 
	`°æí
(name)) != 0 ){

583 
	`skùS∑˚s
(&
zTy≥På
);

584 if–*
zTy≥På
 != '(' ) {

587 
zTy≥På
++;

588 
	`skùS∑˚s
(&
zTy≥På
);

590  *
zTy≥På
 !'\0' && *zTy≥På !')' && !
	`sqlôe4Is•a˚
(*zTypePtr) ){

591 if–!
	`sqlôe4Isdigô
(*
zTy≥På
) ){

592 *
pEºMsg
 = "non digit symbol in vector columnÖarameter";

595 
dimísi⁄s
 = dimísi⁄s*10 + (*
zTy≥På
 - '0');

596 if–
dimísi⁄s
 > 
MAX_VECTOR_SZ
 ) {

597 *
pEºMsg
 = "max vector dimensionÉxceeded";

600 
zTy≥På
++;

602 
	`skùS∑˚s
(&
zTy≥På
);

603 if–*
zTy≥På
 != ')' ){

604 *
pEºMsg
 = "missed closing brace for vector columnÅype";

607 
zTy≥På
++;

608 
	`skùS∑˚s
(&
zTy≥På
);

610 if–*
zTy≥På
 != '\0' ) {

611 *
pEºMsg
 = "extra dataáfter dimensionÖarameter for vector columnÅype";

615 if–
dimísi⁄s
 <= 0 ){

616 *
pEºMsg
 = "vector column must haveÇon-zero dimension for index";

620 *
pDims
 = 
dimísi⁄s
;

621 *
pTy≥
 = 
VECTOR_COLUMN_TYPES
[
i
].
ty≥
;

624 *
pEºMsg
 = "unexpected vector columnÅype";

626 
	}
}

630 
	$öôVe˘‹IndexMëaTabÀ
(
sqlôe4
* 
db
, c⁄° *
zDbSName
) {

631 
rc
;

632 c⁄° *
zSqlTem∂©e
 = "CREATE TABLE IF NOT EXISTS \"%w\"." 
VECTOR_INDEX_GLOBAL_META_TABLE
 " (Çame TEXT , metadata BLOB );";

633 * 
zSql
;

635 
	`as£π
–
zDbSName
 !
NULL
 );

637 
zSql
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, 
zSqlTem∂©e
, 
zDbSName
);

638 if–
zSql
 =
NULL
 ){

639  
SQLITE4_NOMEM
;

641 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 0, 0);

642 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zSql
);

643  
rc
;

644 
	}
}

647 
	$ö£πIndexP¨amëîs
(
sqlôe4
* 
db
, c⁄° *
zDbSName
, c⁄° *
zName
, c⁄° 
Ve˘‹IdxP¨ams
 *
pP¨amëîs
) {

648 
rc
 = 
SQLITE4_ERROR
;

649 c⁄° *
zSqlTem∂©e
 = "INSERT INTO \"%w\"." 
VECTOR_INDEX_GLOBAL_META_TABLE
 " VALUES (?, ?)";

650 
sqlôe4_°mt
* 
pSèãmít
 = 
NULL
;

651 *
zSql
;

653 
	`as£π
–
zDbSName
 !
NULL
 );

655 
zSql
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, 
zSqlTem∂©e
, 
zDbSName
);

656 if–
zSql
 =
NULL
 ){

657  
SQLITE4_NOMEM
;

660 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pSèãmít
, 0);

661 if–
rc
 !
SQLITE4_OK
 ){

662 
˛ór_™d_exô
;

664 
rc
 = 
	`sqlôe4_böd_ãxt
(
pSèãmít
, 1, 
zName
, -1, 
SQLITE4_STATIC
, 0);

665 if–
rc
 !
SQLITE4_OK
 ){

666 
˛ór_™d_exô
;

668 
rc
 = 
	`sqlôe4_böd_blob
(
pSèãmít
, 2, 
pP¨amëîs
->
pBöBuf
,ÖP¨amëîs->
nBöSize
, 
SQLITE4_STATIC
, 0);

669 if–
rc
 !
SQLITE4_OK
 ){

670 
˛ór_™d_exô
;

672 
rc
 = 
	`sqlôe4_°ï
(
pSèãmít
);

673 if–(
rc
&0xffË=
SQLITE4_CONSTRAINT
 ){

674 
rc
 = 
SQLITE4_CONSTRAINT
;

675 }if–
rc
 !
SQLITE4_DONE
 ){

676 
rc
 = 
SQLITE4_ERROR
;

678 
rc
 = 
SQLITE4_OK
;

680 
˛ór_™d_exô
:

681 if–
zSql
 !
NULL
 ){

682 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zSql
);

684 if–
pSèãmít
 !
NULL
 ){

685 
	`sqlôe4_föÆize
(
pSèãmít
);

687  
rc
;

688 
	}
}

690 
	$ªmoveIndexP¨amëîs
(
sqlôe4
* 
db
, c⁄° *
zName
) {

691 c⁄° *
zSql
 = "DELETE FROM " 
VECTOR_INDEX_GLOBAL_META_TABLE
 " WHEREÇame = ?";

692 
sqlôe4_°mt
* 
pSèãmít
 = 
NULL
;

693 
rc
 = 
SQLITE4_ERROR
;

695 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pSèãmít
, 0);

696 if–
rc
 !
SQLITE4_OK
 ){

697 
˛ór_™d_exô
;

699 
rc
 = 
	`sqlôe4_böd_ãxt
(
pSèãmít
, 1, 
zName
, -1, 
SQLITE4_STATIC
, 0);

700 if–
rc
 !
SQLITE4_OK
 ){

701 
˛ór_™d_exô
;

703 
rc
 = 
	`sqlôe4_°ï
(
pSèãmít
);

704 if–
rc
 !
SQLITE4_DONE
 ){

705 
rc
 = 
SQLITE4_ERROR
;

707 
rc
 = 
SQLITE4_OK
;

709 
˛ór_™d_exô
:

710 if–
pSèãmít
 !
NULL
 ){

711 
	`sqlôe4_föÆize
(
pSèãmít
);

713  
rc
;

714 
	}
}

716 
	$ve˘‹IndexTryGëP¨amëîsFromTabÀF‹m©
(
sqlôe4
 *
db
, c⁄° *
zSql
, c⁄° *
zIdxName
, 
Ve˘‹IdxP¨ams
 *
pP¨ams
) {

717 
rc
 = 
SQLITE4_OK
;

718 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

719 
nBöSize
;

721 
	`ve˘‹IdxP¨amsInô
(
pP¨ams
, 
NULL
, 0);

723 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

724 if–
rc
 !
SQLITE4_OK
 ){

725 
out
;

727 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zIdxName
, -1, 
SQLITE4_STATIC
, 0);

728 if–
rc
 !
SQLITE4_OK
 ){

729 
out
;

731 if–
	`sqlôe4_°ï
(
pStmt
Ë!
SQLITE4_ROW
 ){

732 
rc
 = 
SQLITE4_ERROR
;

733 
out
;

735 
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_FORMAT_PARAM_ID
, 1);

736 
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_INDEX_TYPE_PARAM_ID
, 
VECTOR_INDEX_TYPE_DISKANN
);

737 
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_TYPE_PARAM_ID
, 
VECTOR_TYPE_FLOAT32
);

738 
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_DIM_PARAM_ID
, 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 2));

739 
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_METRIC_TYPE_PARAM_ID
, 
VECTOR_METRIC_TYPE_COS
);

740 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_BLOCK_SIZE_PARAM_ID
, 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 1)) != 0 ){

741 
rc
 = 
SQLITE4_ERROR
;

742 
out
;

744 
	`as£π
–
	`sqlôe4_°ï
(
pStmt
Ë=
SQLITE4_DONE
 );

745 
rc
 = 
SQLITE4_OK
;

746 
out
:

747 if–
pStmt
 !
NULL
 ){

748 
	`sqlôe4_föÆize
(
pStmt
);

750  
rc
;

751 
	}
}

753 
	$ve˘‹IndexTryGëP¨amëîsFromBöF‹m©
(
sqlôe4
 *
db
, c⁄° *
zSql
, c⁄° *
zIdxName
, 
Ve˘‹IdxP¨ams
 *
pP¨ams
) {

754 
rc
 = 
SQLITE4_OK
;

755 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

756 
nBöSize
 = 0;

758 
	`ve˘‹IdxP¨amsInô
(
pP¨ams
, 
NULL
, 0);

760 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

761 if–
rc
 !
SQLITE4_OK
 ){

762 
out
;

764 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zIdxName
, -1, 
SQLITE4_STATIC
, 0);

765 if–
rc
 !
SQLITE4_OK
 ){

766 
out
;

768 if–
	`sqlôe4_°ï
(
pStmt
Ë!
SQLITE4_ROW
 ){

769 
rc
 = 
SQLITE4_ERROR
;

770 
out
;

772 
	`as£π
–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0Ë=
SQLITE4_BLOB
 );

774 c⁄° *
pBlob
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 0, &
nBöSize
);

775 if–
pBlob
==0 ){

776 
rc
 = 
SQLITE4_ERROR
;

777 
out
;

779 if–
nBöSize
 > 
VECTOR_INDEX_PARAMS_BUF_SIZE
 ){

780 
rc
 = 
SQLITE4_ERROR
;

781 
out
;

783 
	`ve˘‹IdxP¨amsInô
(
pP¨ams
, (
u8
*)
pBlob
, 
nBöSize
);

784 
	`as£π
–
	`sqlôe4_°ï
(
pStmt
Ë=
SQLITE4_DONE
 );

785 
rc
 = 
SQLITE4_OK
;

786 
out
:

787 if–
pStmt
 !
NULL
 ){

788 
	`sqlôe4_föÆize
(
pStmt
);

790  
rc
;

791 
	}
}

793 
	$ve˘‹IndexGëP¨amëîs
(

794 
sqlôe4
 *
db
,

795 c⁄° *
zDbSName
,

796 c⁄° *
zIdxName
,

797 
Ve˘‹IdxP¨ams
 *
pP¨ams


799 
rc
 = 
SQLITE4_OK
;

800 
	`as£π
–
zDbSName
 !
NULL
 );

802 c⁄° *
zSñe˘SqlTem∂©e
 = "SELECT mëad©®FROM \"%w\"." 
VECTOR_INDEX_GLOBAL_META_TABLE
 " WHEREÇame = ?";

803 * 
zSñe˘Sql
;

804 
zSñe˘Sql
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, 
zSñe˘SqlTem∂©e
, 
zDbSName
);

805 if–
zSñe˘Sql
 =
NULL
 ){

806  
SQLITE4_NOMEM
;

811 c⁄° * 
zSñe˘SqlPekkaLegacy
 = "SELECT vector_type, block_size, dims, distance_ops FROMÜibsql_vector_index WHEREÇame = ?";

812 
rc
 = 
	`ve˘‹IndexTryGëP¨amëîsFromBöF‹m©
(
db
, 
zSñe˘Sql
, 
zIdxName
, 
pP¨ams
);

813 
	`sqlôe4_‰ì
(
db
->
pEnv
, 
zSñe˘Sql
);

814 if–
rc
 =
SQLITE4_OK
 ){

815  
SQLITE4_OK
;

817 
rc
 = 
	`ve˘‹IndexTryGëP¨amëîsFromTabÀF‹m©
(
db
, 
zSñe˘SqlPekkaLegacy
, 
zIdxName
, 
pP¨ams
);

818 if–
rc
 =
SQLITE4_OK
 ){

819  
SQLITE4_OK
;

821  
SQLITE4_ERROR
;

822 
	}
}

857 
	$ve˘‹IndexCª©e
(
P¨£
 *
pP¨£
, c⁄° 
Index
 *
pIdx
, c⁄° *
zDbSName
) {

858 c⁄° 
CREATE_FAIL
 = -1;

859 c⁄° 
CREATE_IGNORE
 = 0;

860 c⁄° 
CREATE_OK_SKIP_REFILL
 = 1;

861 c⁄° 
CREATE_OK
 = 2;

863 
i
, 
rc
 = 
SQLITE4_OK
;

864 
dims
, 
ty≥
;

865 
hasLibsqlVe˘‹IdxFn
 = 0, 
hasCﬁœti⁄
 = 0;

866 c⁄° *
pzEºMsg
 = 
NULL
;

868 
	`as£π
–
zDbSName
 !
NULL
 );

870 
sqlôe4
 *
db
 = 
pP¨£
->db;

871 
TabÀ
 *
pTabÀ
 = 
pIdx
->pTable;

872 
Ex¥Li°Iãm
 *
pLi°Iãm
;

873 
Ex¥Li°
 *
pArgsLi°
;

874 
iEmbeddögCﬁumn
;

875 c⁄° * 
zEmbeddögCﬁumnTy≥Name
;

876 
Ve˘‹IdxKey
 
idxKey
;

877 
Ve˘‹IdxP¨ams
 
idxP¨ams
;

878 
	`ve˘‹IdxP¨amsInô
(&
idxP¨ams
, 
NULL
, 0);

899 i‡(
db
->
öô
.
busy
) {

900  
SQLITE4_OK
;

902 
	`¥ötf
("vectorIndexCreate:Éntered\n");

903 
	`¥ötf
("ve˘‹IndexCª©e: db->öô.busy = %d\n", 
db
->
öô
.
busy
);

904 i‡(
db
->
öô
.
busy
 == 1) {

905 
	`¥ötf
("ve˘‹IndexCª©e: fú° db->öô.busy = %d\n", 
db
->
öô
.
busy
);

906  
CREATE_IGNORE
;

910 if–
pIdx
->
aCﬁEx¥
 =
NULL
 ) {

911 
	`¥ötf
("vectorIndexCreate:ÖIdx->aColExpr == NULL\n");

912  
CREATE_IGNORE
;

915 if–
pIdx
->
aCﬁEx¥
==0 )  
CREATE_IGNORE
;

916 if–
pIdx
->
aCﬁEx¥
->
nEx¥
!=1 )  
CREATE_IGNORE
;

917 if–
pIdx
->
aCﬁEx¥
->
a
[0].
pEx¥
==0 )  
CREATE_IGNORE
;

920 
pLi°Iãm
 = 
pIdx
->
aCﬁEx¥
->
a
;

921 
i
=0; i<
pIdx
->
aCﬁEx¥
->
nEx¥
; i++, 
pLi°Iãm
++){

922 
Ex¥
* 
pEx¥
 = 
pLi°Iãm
->pExpr;

923  
pEx¥
->
›
 =
TK_COLLATE
 ){

924 
pEx¥
 =ÖEx¥->
pLe·
;

925 
hasCﬁœti⁄
 = 1;

927 if–
pEx¥
->
›
 =
TK_FUNCTION
 && 
	`sqlôe4_°ricmp
’Ex¥->
u
.
zTokí
, 
VECTOR_INDEX_MARKER_FUNCTION
) == 0 ) {

928 
hasLibsqlVe˘‹IdxFn
 = 1;

931 if–!
hasLibsqlVe˘‹IdxFn
 ) {

932  
CREATE_IGNORE
;

934 if–
hasCﬁœti⁄
 ){

935 
	`¥ötf
("vector index: collation inÉxpression is forbidden");

936  
CREATE_FAIL
;

938 if–
pIdx
->
aCﬁEx¥
->
nEx¥
 != 1 ) {

939 
	`¥ötf
("ve˘‹ index: mu° c⁄èöÉxa˘ly o√ cﬁum¿wøµed i¡ÿthê" 
VECTOR_INDEX_MARKER_FUNCTION
 " function");

940  
CREATE_FAIL
;

943 
pArgsLi°
 = 
pIdx
->
aCﬁEx¥
->
a
[0].
pEx¥
->
x
.
pLi°
;

944 
pLi°Iãm
 = 
pArgsLi°
->
a
;

946 if–
pArgsLi°
->
nEx¥
 < 1 ){

947 
	`¥ötf
("ve˘‹ index: " 
VECTOR_INDEX_MARKER_FUNCTION
 " must containátÜeast oneárgument");

948  
CREATE_FAIL
;

950 if–
pLi°Iãm
[0].
pEx¥
->
›
 !
TK_COLUMN
 ) {

951 
	`¥ötf
("ve˘‹ index: " 
VECTOR_INDEX_MARKER_FUNCTION
 " firstárgument must beá columnÅoken");

952  
CREATE_FAIL
;

954 
iEmbeddögCﬁumn
 = 
pLi°Iãm
[0].
pEx¥
->
iCﬁumn
;

955 if–
iEmbeddögCﬁumn
 < 0 ) {

956 
	`¥ötf
("ve˘‹ index: " 
VECTOR_INDEX_MARKER_FUNCTION
 " firstárgument must be column with vectorÅype");

957  
CREATE_FAIL
;

959 
	`as£π
–
iEmbeddögCﬁumn
 >0 && iEmbeddögCﬁum¿< 
pTabÀ
->
nCﬁ
 );

961 
zEmbeddögCﬁumnTy≥Name
 = 
	`sqlôe4CﬁumnTy≥
(&
pTabÀ
->
aCﬁ
[
iEmbeddögCﬁumn
], "");

962 if–
	`ve˘‹IdxP¨£CﬁumnTy≥
(
zEmbeddögCﬁumnTy≥Name
, &
ty≥
, &
dims
, &
pzEºMsg
) != 0 ){

963 
	`¥ötf
("ve˘‹ index: %s: %s", 
pzEºMsg
, 
zEmbeddögCﬁumnTy≥Name
);

964  
CREATE_FAIL
;

967 if–
db
->
öô
.
busy
 == 1 ){

968 
	`¥ötf
("ve˘‹IndexCª©e: db->öô.busy = %d\n", 
db
->
öô
.
busy
);

969  
CREATE_OK
;

972 
rc
 = 
	`öôVe˘‹IndexMëaTabÀ
(
db
, 
zDbSName
);

973 if–
rc
 !
SQLITE4_OK
 ){

974 
	`¥ötf
("ve˘‹ index: faûedÅÿöô më®èbÀ: %s", 
	`sqlôe4_îrmsg
(
db
));

975  
CREATE_FAIL
;

977 
rc
 = 
	`∑r£Ve˘‹IdxP¨ams
(
pP¨£
, &
idxP¨ams
, 
ty≥
, 
dims
, 
pLi°Iãm
 + 1, 
pArgsLi°
->
nEx¥
 - 1);

978 if–
rc
 !
SQLITE4_OK
 ){

979 
	`¥ötf
("vector index: failedÅoÖarse indexÖarameters");

980  
CREATE_FAIL
;

982 if–
	`ve˘‹IdxKeyGë
(
pIdx
, &
idxKey
, &
pzEºMsg
) != 0 ){

983 
	`¥ötf
("ve˘‹ index: faûedÅÿdëe˘ undîlyögÅabÀ key: %s", 
pzEºMsg
);

984  
CREATE_FAIL
;

986 if–
idxKey
.
nKeyCﬁumns
 != 1 ){

987 
	`¥ötf
("vector index: unsupported forÅables without ROWIDánd compositeÖrimary key");

988  
CREATE_FAIL
;

992 
	`¥ötf
("vectorIndexCreate: calling diskAnnCreateIndex\n");

993 
rc
 = 
	`diskA¬Cª©eIndex
(
db
, 
zDbSName
, 
pIdx
->
zName
, &
idxKey
, &
idxP¨ams
, &
pzEºMsg
);

994 
	`¥ötf
("diskA¬Cª©eIndex d⁄êwôhÑc=%d\n", 
rc
);

996 if–
rc
 !
SQLITE4_OK
 ){

997 if–
pzEºMsg
 !
NULL
 ){

998 
	`¥ötf
("ve˘‹ index: u«bÀÅÿöôülizêdisk™n: %s", 
pzEºMsg
);

1000 
	`¥ötf
("vector index: unableÅo initialize diskann");

1002  
CREATE_FAIL
;

1004 
rc
 = 
	`ö£πIndexP¨amëîs
(
db
, 
zDbSName
, 
pIdx
->
zName
, &
idxP¨ams
);

1008 if–(
rc
&0xffË=
SQLITE4_CONSTRAINT
 ){

1012  
CREATE_OK_SKIP_REFILL
;

1014 if–
rc
 !
SQLITE4_OK
 ){

1015 
	`¥ötf
("vector index: unableÅo update global metadataÅable");

1016  
CREATE_FAIL
;

1018 
	`¥ötf
("ve˘‹IndexCª©e: index %†¸óãd suc˚ssfuŒy\n", 
pIdx
->
zName
);

1019  
CREATE_OK
;

1020 
	}
}

1024 
	$gëIndexNameP¨ts
(
sqlôe4
 *
db
, c⁄° *
zIdxFuŒName
, **
pzIdxDbSName
, **
pzIdxName
) {

1025 
nFuŒName
, 
nDbSName
;

1026 c⁄° *
pDŸ
 = 
zIdxFuŒName
;

1027  *
pDŸ
 != '.' && *pDot != '\0' ){

1028 
pDŸ
++;

1030 if–*
pDŸ
 == '\0' ){

1031  
SQLITE4_OK
;

1033 
	`as£π
–*
pDŸ
 == '.' );

1034 
nFuŒName
 = 
	`sqlôe4SåÀn30
(
zIdxFuŒName
);

1035 
nDbSName
 = 
pDŸ
 - 
zIdxFuŒName
;

1036 *
pzIdxDbSName
 = 
	`sqlôe4DbSåNDup
(
db
, 
zIdxFuŒName
, 
nDbSName
);

1037 *
pzIdxName
 = 
	`sqlôe4DbSåNDup
(
db
, 
pDŸ
 + 1, 
nFuŒName
 - 
nDbSName
 - 1);

1038 if–
pzIdxName
 =
NULL
 || 
pzIdxDbSName
 == NULL ){

1039 
	`sqlôe4DbFªe
(
db
, *
pzIdxName
);

1040 
	`sqlôe4DbFªe
(
db
, *
pzIdxDbSName
);

1041  
SQLITE4_NOMEM
;

1043  
SQLITE4_OK
;

1044 
	}
}

1047 
	$ve˘‹IndexSórch
(

1048 
sqlôe4
 *
db
,

1049 
¨gc
,

1050 
sqlôe4_vÆue
 **
¨gv
,

1051 
Ve˘‹OutRows
 *
pRows
,

1052 *
nRóds
,

1053 *
nWrôes
,

1054 **
pzEºMsg


1056 
ty≥
, 
dims
, 
k
, 
rc
, 
iDb
 = -1;

1057 
kDoubÀ
;

1058 c⁄° *
zIdxFuŒName
;

1059 *
zIdxDbSNameAŒoc
 = 
NULL
;

1060 *
zIdxNameAŒoc
 = 
NULL
;

1061 c⁄° *
zIdxDbSName
 = 
NULL
;

1062 c⁄° *
zIdxName
 = 
NULL
;

1063 c⁄° *
zEºMsg
;

1064 
Ve˘‹
 *
pVe˘‹
 = 
NULL
;

1065 
DiskA¬Index
 *
pDiskA¬
 = 
NULL
;

1066 
Index
 *
pIndex
;

1067 
Ve˘‹IdxKey
 
pKey
;

1068 
Ve˘‹IdxP¨ams
 
idxP¨ams
;

1069 
	`ve˘‹IdxP¨amsInô
(&
idxP¨ams
, 
NULL
, 0);

1071 if–
¨gc
 != 3 ){

1072 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "ve˘‹ index(£¨ch): gŸ %dÖ¨amëîs,Éx≥˘ed 3", 
¨gc
);

1073 
rc
 = 
SQLITE4_ERROR
;

1074 
out
;

1076 if–
	`dëe˘Ve˘‹P¨amëîs
(
¨gv
[1], 
VECTOR_TYPE_FLOAT32
, &
ty≥
, &
dims
, 
pzEºMsg
) != 0 ){

1077 
rc
 = 
SQLITE4_ERROR
;

1078 
out
;

1081 
pVe˘‹
 = 
	`ve˘‹AŒoc
(
ty≥
, 
dims
);

1082 if–
pVe˘‹
 =
NULL
 ){

1083 
rc
 = 
SQLITE4_NOMEM
;

1084 
out
;

1086 if–
	`ve˘‹P¨£WôhTy≥
(
¨gv
[1], 
pVe˘‹
, 
pzEºMsg
) != 0 ){

1087 
rc
 = 
SQLITE4_ERROR
;

1088 
out
;

1090 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[2]Ë=
SQLITE4_INTEGER
 ){

1091 
k
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[2]);

1092 if–
k
 < 0 ){

1093 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search):ÅhirdÖarameter (k) must beáÇon-negative integer, butÇegative value wereÖrovided");

1094 
rc
 = 
SQLITE4_ERROR
;

1095 
out
;

1097 }if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[2]Ë=
SQLITE4_FLOAT
 ) {

1098 
kDoubÀ
 = 
	`sqlôe4_vÆue_doubÀ
(
¨gv
[2]);

1099 
k
 = ()
kDoubÀ
;

1100 if–()
k
 !
kDoubÀ
 ){

1101 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search):ÅhirdÖarameter (k) must beán integer, but float value wereÖrovided");

1102 
rc
 = 
SQLITE4_ERROR
;

1103 
out
;

1105 if–
k
 < 0 ){

1106 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search):ÅhirdÖarameter (k) must beáÇon-negative integer, butÇegative value wereÖrovided");

1107 
rc
 = 
SQLITE4_ERROR
;

1108 
out
;

1111 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search):ÅhirdÖarameter (k) must beán integer, but unexpectedÅype of value wereÖrovided");

1112 
rc
 = 
SQLITE4_ERROR
;

1113 
out
;

1116 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]Ë!
SQLITE4_TEXT
 ){

1117 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search): firstÖarameter (index) must beá string");

1118 
rc
 = 
SQLITE4_ERROR
;

1119 
out
;

1121 
zIdxFuŒName
 = (c⁄° *)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

1122 
rc
 = 
	`gëIndexNameP¨ts
(
db
, 
zIdxFuŒName
, &
zIdxDbSNameAŒoc
, &
zIdxNameAŒoc
);

1123 if–
rc
 !
SQLITE4_OK
 ){

1124 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search): failedÅoÖarse indexÇame");

1125 
out
;

1127 
	`as£π
–(
zIdxDbSNameAŒoc
 =
NULL
 && 
zIdxNameAŒoc
 == NULL) || (zIdxDbSNameAlloc != NULL && zIdxNameAlloc != NULL) );

1128 if–
zIdxDbSNameAŒoc
 =
NULL
 && 
zIdxNameAŒoc
 == NULL ){

1129 
zIdxDbSName
 = "main";

1130 
zIdxName
 = 
zIdxFuŒName
;

1132 
zIdxDbSName
 = 
zIdxDbSNameAŒoc
;

1133 
zIdxName
 = 
zIdxNameAŒoc
;

1134 
iDb
 = 
	`sqlôe4FödDbName
(
db
, 
zIdxDbSName
);

1135 if–
iDb
 < 0 ){

1136 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "ve˘‹ index(£¨ch): unknow¿schem®'%s'", 
zIdxDbSName
);

1137 
rc
 = 
SQLITE4_ERROR
;

1138 
out
;

1142 if–
iDb
 !=1 ){

1144 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

1148 if–
	`ve˘‹IndexGëP¨amëîs
(
db
, 
zIdxDbSName
, 
zIdxName
, &
idxP¨ams
) != 0 ){

1149 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search): failedÅoÖarse vector indexÖarameters");

1150 
rc
 = 
SQLITE4_ERROR
;

1151 
out
;

1153 
pIndex
 = 
	`sqlôe4FödIndex
(
db
, 
zIdxName
, 
zIdxDbSName
);

1154 if–
pIndex
 =
NULL
 ){

1155 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search): indexÇot found");

1156 
rc
 = 
SQLITE4_ERROR
;

1157 
out
;

1159 
rc
 = 
	`diskA¬O≥nIndex
(
db
, 
zIdxDbSName
, 
zIdxName
, &
idxP¨ams
, &
pDiskA¬
);

1160 if–
rc
 !
SQLITE4_OK
 ){

1161 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "vector index(search): failedÅo open diskann index");

1162 
out
;

1164 if–
	`ve˘‹IdxKeyGë
(
pIndex
, &
pKey
, &
zEºMsg
) != 0 ){

1165 *
pzEºMsg
 = 
	`sqlôe4_m¥ötf
(
db
->
pEnv
, "ve˘‹ index(£¨ch): faûedÅÿexåa˘ÅabÀ key: %s", 
zEºMsg
);

1166 
rc
 = 
SQLITE4_ERROR
;

1167 
out
;

1169 
rc
 = 
	`diskA¬Sórch
(
pDiskA¬
, 
pVe˘‹
, 
k
, &
pKey
, 
pRows
, 
pzEºMsg
);

1170 
out
:

1171 if–
pDiskA¬
 !
NULL
 ){

1172 *
nRóds
 +
pDiskA¬
->nReads;

1173 *
nWrôes
 +
pDiskA¬
->nWrites;

1174 
	`diskA¬Clo£Index
(
pDiskA¬
);

1176 if–
pVe˘‹
 !
NULL
 ){

1177 
	`ve˘‹Fªe
(
pVe˘‹
);

1179 
	`sqlôe4DbFªe
(
db
, 
zIdxNameAŒoc
);

1180 
	`sqlôe4DbFªe
(
db
, 
zIdxDbSNameAŒoc
);

1181 if–
iDb
 >= 0 && iDb != 1 ){

1182 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

1184  
rc
;

1185 
	}
}

1188 
	$ve˘‹IndexIn£π
(

1189 
Ve˘‹IdxCurs‹
 *
pCur
,

1190 c⁄° 
U≈ackedRec‹d
 *
pRec‹d
,

1191 **
pzEºMsg


1193 
rc
;

1194 
Ve˘‹InRow
 
ve˘‹InRow
;

1196 
rc
 = 
	`ve˘‹InRowAŒoc
(
pCur
->
db
, 
pRec‹d
, &
ve˘‹InRow
, 
pzEºMsg
);

1197 if–
rc
 !
SQLITE4_OK
 ){

1198  
rc
;

1200 if–
ve˘‹InRow
.
pVe˘‹
 =
NULL
 ){

1201  
SQLITE4_OK
;

1203 
rc
 = 
	`diskA¬In£π
(
pCur
->
pIndex
, &
ve˘‹InRow
, 
pzEºMsg
);

1204 
	`ve˘‹InRowFªe
(
pCur
->
db
, &
ve˘‹InRow
);

1205  
rc
;

1206 
	}
}

	@src/vectorIndexInt.h

1 #i‚de‡
_VECTOR_INDEX_H


2 
	#_VECTOR_INDEX_H


	)

4 
	~"sqlôe4.h
"

5 
	~"vdbeI¡.h
"

6 
	~"ve˘‹I¡.h
"

8 #ifde‡
__˝lu•lus


12 
DiskA¬Index
 
	tDiskA¬Index
;

13 
BlobSpŸ
 
	tBlobSpŸ
;

20 
	sDiskA¬Index
 {

21 
sqlôe4
 *
db
;

22 *
zDbSName
;

23 *
zName
;

24 *
zShadow
;

25 
nF‹m©Vîsi⁄
;

26 
nDi°™˚Func
;

27 
nBlockSize
;

28 
nVe˘‹Dims
;

29 
nNodeVe˘‹Ty≥
;

30 
nEdgeVe˘‹Ty≥
;

31 
nNodeVe˘‹Size
;

32 
nEdgeVe˘‹Size
;

33 
¥unögAÕha
;

34 
ö£πL
;

35 
£¨chL
;

37 
nRóds
;

38 
nWrôes
;

46 
	sBlobSpŸ
 {

47 
u64
 
nRowid
;

48 
sqlôe4_blob
 *
pBlob
;

49 
u8
 *
pBuf„r
;

50 
nBuf„rSize
;

53 
KVSt‹e
 *
pSt‹e
;

54 
KVByãAºay
 *
pKey
; 
KVSize
 
nKey
;

56 
isWrôabÀ
;

57 
isInôülized
;

58 
isAb‹ãd
;

61 
KVCurs‹
 *
pCur
;

66 
	#DISKANN_ROW_NOT_FOUND
 1001

	)

68 
	#DISKANN_BLOB_WRITABLE
 1

	)

69 
	#DISKANN_BLOB_READONLY
 0

	)

72 
blobSpŸCª©e
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 **
µBlobSpŸ
, 
u64
 
nRowid
, 
nBuf„rSize
, 
isWrôabÀ
);

73 
blobSpŸRñﬂd
(
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
u64
 
nRowid
, 
nBuf„rSize
);

74 
blobSpŸFlush
(
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
);

75 
blobSpŸFªe
(
BlobSpŸ
 *
pBlobSpŸ
);

84 
nodeEdgesMaxCou¡
(c⁄° 
DiskA¬Index
 *
pIndex
);

85 
nodeEdgesMëad©aOff£t
(c⁄° 
DiskA¬Index
 *
pIndex
);

86 
nodeBöInô
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
u64
 
nRowid
, 
Ve˘‹
 *
pVe˘‹
);

87 
nodeBöVe˘‹
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
, 
Ve˘‹
 *
pVe˘‹
);

88 
u16
 
nodeBöEdges
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
);

89 
nodeBöEdge
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
, 
iEdge
, 
u64
 *
pRowid
, *
di°™˚
, 
Ve˘‹
 *
pVe˘‹
);

90 
nodeBöEdgeFödIdx
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
, 
u64
 
nRowid
);

91 
nodeBöPru√Edges
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
nPru√d
);

92 
nodeBöRïœ˚Edge
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
iRïœ˚
, 
u64
 
nRowid
, 
di°™˚
, 
Ve˘‹
 *
pVe˘‹
);

93 
nodeBöDñëeEdge
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
iDñëe
);

94 
nodeBöDebug
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
);

101 
Ve˘‹IdxKey
 
	tVe˘‹IdxKey
;

102 
Ve˘‹IdxP¨ams
 
	tVe˘‹IdxP¨ams
;

103 
Ve˘‹InRow
 
	tVe˘‹InRow
;

104 
Ve˘‹OutRows
 
	tVe˘‹OutRows
;

106 
u8
 
	tIndexTy≥
;

107 
u8
 
	tMëricTy≥
;

116 
	#VECTOR_FORMAT_PARAM_ID
 1

	)

122 
	#VECTOR_FORMAT_V1
 1

	)

123 
	#VECTOR_FORMAT_V2
 2

	)

124 
	#VECTOR_FORMAT_DEFAULT
 3

	)

127 
	#VECTOR_INDEX_TYPE_PARAM_ID
 2

	)

128 
	#VECTOR_INDEX_TYPE_DISKANN
 1

	)

131 
	#VECTOR_TYPE_PARAM_ID
 3

	)

133 
	#VECTOR_DIM_PARAM_ID
 4

	)

136 
	#VECTOR_METRIC_TYPE_PARAM_ID
 5

	)

137 
	#VECTOR_METRIC_TYPE_COS
 1

	)

138 
	#VECTOR_METRIC_TYPE_L2
 2

	)

141 
	#VECTOR_BLOCK_SIZE_PARAM_ID
 6

	)

142 
	#VECTOR_BLOCK_SIZE_DEFAULT
 128

	)

144 
	#VECTOR_PRUNING_ALPHA_PARAM_ID
 7

	)

145 
	#VECTOR_PRUNING_ALPHA_DEFAULT
 1.2

	)

147 
	#VECTOR_INSERT_L_PARAM_ID
 8

	)

148 
	#VECTOR_INSERT_L_DEFAULT
 70

	)

150 
	#VECTOR_SEARCH_L_PARAM_ID
 9

	)

151 
	#VECTOR_SEARCH_L_DEFAULT
 200

	)

153 
	#VECTOR_MAX_NEIGHBORS_PARAM_ID
 10

	)

155 
	#VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
 11

	)

158 
	#VECTOR_PARAM_IDS_COUNT
 11

	)

165 
	#VECTOR_INDEX_PARAMS_BUF_SIZE
 128

	)

166 
	sVe˘‹IdxP¨ams
 {

167 
u8
 
pBöBuf
[
VECTOR_INDEX_PARAMS_BUF_SIZE
];

168 
nBöSize
;

177 
	#VECTOR_INDEX_MAX_KEY_COLUMNS
 16

	)

178 
	sVe˘‹IdxKey
 {

179 
nKeyCﬁumns
;

180 
aKeyAfföôy
[
VECTOR_INDEX_MAX_KEY_COLUMNS
];

182 c⁄° *
azKeyCﬁœti⁄
[
VECTOR_INDEX_MAX_KEY_COLUMNS
];

191 
	sVe˘‹InRow
 {

192 
Ve˘‹
 *
pVe˘‹
;

193 
nKeys
;

194 
sqlôe4_vÆue
 *
pKeyVÆues
;

204 
	#VECTOR_OUT_ROWS_MAX_CELLS
 (1<<30)

	)

205 
	sVe˘‹OutRows
 {

206 
nRows
;

207 
nCﬁs
;

208 
i64
 *
aI¡VÆues
;

209 
sqlôe4_vÆue
 **
µVÆues
;

215 
	#VECTOR_INDEX_SQL_RENDER_LIMIT
 128

	)

217 
ve˘‹IdxP¨amsInô
(
Ve˘‹IdxP¨ams
 *, 
u8
 *, );

218 
u64
 
ve˘‹IdxP¨amsGëU64
(c⁄° 
Ve˘‹IdxP¨ams
 *, );

219 
ve˘‹IdxP¨amsGëF64
(c⁄° 
Ve˘‹IdxP¨ams
 *, );

220 
ve˘‹IdxP¨amsPutU64
(
Ve˘‹IdxP¨ams
 *, , 
u64
);

221 
ve˘‹IdxP¨amsPutF64
(
Ve˘‹IdxP¨ams
 *, , );

223 
ve˘‹IdxKeyGë
(c⁄° 
Index
 *, 
Ve˘‹IdxKey
 *, const **);

224 
ve˘‹IdxKeyRowidLike
(c⁄° 
Ve˘‹IdxKey
 *);

225 
ve˘‹IdxKeyDefsRídî
(c⁄° 
Ve˘‹IdxKey
 *, const *, *, );

226 
ve˘‹IdxKeyNamesRídî
(, const *, *, );

228 
ve˘‹InRowAŒoc
(
sqlôe4
 *, c⁄° 
U≈ackedRec‹d
 *, 
Ve˘‹InRow
 *, **);

229 
sqlôe4_vÆue
* 
ve˘‹InRowKey
(c⁄° 
Ve˘‹InRow
 *, );

230 
ve˘‹InRowTryGëRowid
(c⁄° 
Ve˘‹InRow
 *, 
u64
 *);

231 
i64
 
ve˘‹InRowLegacyId
(c⁄° 
Ve˘‹InRow
 *);

232 
ve˘‹InRowPœ˚hﬁdîRídî
(c⁄° 
Ve˘‹InRow
 *, *, );

233 
ve˘‹InRowFªe
(
sqlôe4
 *, 
Ve˘‹InRow
 *);

235 
ve˘‹OutRowsAŒoc
(
sqlôe4
 *, 
Ve˘‹OutRows
 *, , , );

236 
ve˘‹OutRowsPut
(
Ve˘‹OutRows
 *, , , c⁄° 
u64
 *, 
sqlôe4_vÆue
 *, 
sqlôe4
 *);

237 
ve˘‹OutRowsGë
(
sqlôe4_c⁄ãxt
 *, c⁄° 
Ve˘‹OutRows
 *, , );

238 
ve˘‹OutRowsFªe
(
sqlôe4
 *, 
Ve˘‹OutRows
 *);

240 
diskA¬Cª©eIndex
(
sqlôe4
 *, c⁄° *, c⁄° *, c⁄° 
Ve˘‹IdxKey
 *, 
Ve˘‹IdxP¨ams
 *, const **);

241 
diskA¬CÀ¨Index
(
sqlôe4
 *, const *, const *);

242 
diskA¬Dr›Index
(
sqlôe4
 *, const *, const *);

243 
diskA¬O≥nIndex
(
sqlôe4
 *, c⁄° *, c⁄° *, c⁄° 
Ve˘‹IdxP¨ams
 *, 
DiskA¬Index
 **);

244 
diskA¬Clo£Index
(
DiskA¬Index
 *);

245 
diskA¬In£π
(
DiskA¬Index
 *, c⁄° 
Ve˘‹InRow
 *, **);

246 
diskA¬Dñëe
(
DiskA¬Index
 *, c⁄° 
Ve˘‹InRow
 *, **);

247 
diskA¬Sórch
(
DiskA¬Index
 *, c⁄° 
Ve˘‹
 *, , c⁄° 
Ve˘‹IdxKey
 *, 
Ve˘‹OutRows
 *, **);

249 
Ve˘‹IdxCurs‹
 
	tVe˘‹IdxCurs‹
;

251 
	#VECTOR_INDEX_VTAB_NAME
 "ve˘‹_t›_k"

	)

252 
	#VECTOR_INDEX_GLOBAL_META_TABLE
 "libsql_ve˘‹_mëa_shadow"

	)

253 
	#VECTOR_INDEX_MARKER_FUNCTION
 "libsql_ve˘‹_idx"

	)

255 
ve˘‹IdxP¨£CﬁumnTy≥
(const *, *, *, const **);

257 
ve˘‹IndexCª©e
(
P¨£
*, c⁄° 
Index
*, const *);

258 
ve˘‹IndexCÀ¨
(
sqlôe4
 *, const *, const *);

259 
ve˘‹IndexDr›
(
sqlôe4
 *, const *, const *);

262 
ve˘‹IndexSórch
(
sqlôe4
 *, , 
sqlôe4_vÆue
 **, 
Ve˘‹OutRows
 *, *, *, **);

265 
ve˘‹IndexIn£π
(
Ve˘‹IdxCurs‹
 *, c⁄° 
U≈ackedRec‹d
 *, **);

267 #ifde‡
__˝lu•lus


	@src/vectorInt.h

1 #i‚de‡
_VECTOR_H


2 
	#_VECTOR_H


	)

4 
	~"sqlôe4.h
"

5 
	~"sqlôeI¡.h
"

7 #ifde‡
__˝lu•lus


12 
Ve˘‹
 
	tVe˘‹
;

13 
u16
 
	tVe˘‹Ty≥
;

14 
u32
 
	tVe˘‹Dims
;

20 
	#MAX_VECTOR_SZ
 65536

	)

52 
	#VECTOR_TYPE_FLOAT32
 1

	)

53 
	#VECTOR_TYPE_FLOAT64
 2

	)

54 
	#VECTOR_TYPE_FLOAT1BIT
 3

	)

55 
	#VECTOR_TYPE_FLOAT8
 4

	)

56 
	#VECTOR_TYPE_FLOAT16
 5

	)

57 
	#VECTOR_TYPE_FLOATB16
 6

	)

59 
	#VECTOR_FLAGS_STATIC
 1

	)

61 
	#ALIGN
(
n
, 
size
Ë((“ + sizê- 1Ë/ sizeË* size)

	)

67 
	sVe˘‹
 {

68 
Ve˘‹Ty≥
 
ty≥
;

69 
u16
 
Êags
;

70 
Ve˘‹Dims
 
dims
;

71 *
d©a
;

74 
size_t
 
ve˘‹D©aSize
(
Ve˘‹Ty≥
, 
Ve˘‹Dims
);

75 
Ve˘‹
 *
ve˘‹AŒoc
(
Ve˘‹Ty≥
, 
Ve˘‹Dims
);

76 
ve˘‹Fªe
(
Ve˘‹
 *
v
);

77 
ve˘‹P¨£WôhTy≥
(
sqlôe4_vÆue
 *, 
Ve˘‹
 *, **);

78 
ve˘‹Inô
(
Ve˘‹
 *, 
Ve˘‹Ty≥
, 
Ve˘‹Dims
, *);

83 
ve˘‹Dump
 (c⁄° 
Ve˘‹
 *
v
);

84 
ve˘‹F8Dump
 (c⁄° 
Ve˘‹
 *
v
);

85 
ve˘‹F16Dump
 (c⁄° 
Ve˘‹
 *
v
);

86 
ve˘‹FB16Dump
(c⁄° 
Ve˘‹
 *
v
);

87 
ve˘‹F32Dump
 (c⁄° 
Ve˘‹
 *
v
);

88 
ve˘‹F64Dump
 (c⁄° 
Ve˘‹
 *
v
);

89 
ve˘‹1BôDump
(c⁄° 
Ve˘‹
 *
v
);

91 
ve˘‹F8GëP¨amëîs
(c⁄° 
u8
 *, , *, *);

92 
ve˘‹F8SëP¨amëîs
(
u8
 *, , , );

97 
ve˘‹M¨shÆToText
 (
sqlôe4_c⁄ãxt
 *, c⁄° 
Ve˘‹
 *);

98 
ve˘‹F32M¨shÆToText
(
sqlôe4_c⁄ãxt
 *, c⁄° 
Ve˘‹
 *);

99 
ve˘‹F64M¨shÆToText
(
sqlôe4_c⁄ãxt
 *, c⁄° 
Ve˘‹
 *);

104 
ve˘‹SîülizeToBlob
 (c⁄° 
Ve˘‹
 *, *, 
size_t
);

105 
ve˘‹F8SîülizeToBlob
 (c⁄° 
Ve˘‹
 *, *, 
size_t
);

106 
ve˘‹F16SîülizeToBlob
 (c⁄° 
Ve˘‹
 *, *, 
size_t
);

107 
ve˘‹FB16SîülizeToBlob
(c⁄° 
Ve˘‹
 *, *, 
size_t
);

108 
ve˘‹F32SîülizeToBlob
 (c⁄° 
Ve˘‹
 *, *, 
size_t
);

109 
ve˘‹F64SîülizeToBlob
 (c⁄° 
Ve˘‹
 *, *, 
size_t
);

110 
ve˘‹1BôSîülizeToBlob
(c⁄° 
Ve˘‹
 *, *, 
size_t
);

115 
ve˘‹Di°™˚Cos
 (c⁄° 
Ve˘‹
 *, const Vector *);

116 
ve˘‹F8Di°™˚Cos
 (c⁄° 
Ve˘‹
 *, const Vector *);

117 
ve˘‹F16Di°™˚Cos
 (c⁄° 
Ve˘‹
 *, const Vector *);

118 
ve˘‹FB16Di°™˚Cos
(c⁄° 
Ve˘‹
 *, const Vector *);

119 
ve˘‹F32Di°™˚Cos
 (c⁄° 
Ve˘‹
 *, const Vector *);

120 
ve˘‹F64Di°™˚Cos
(c⁄° 
Ve˘‹
 *, const Vector *);

125 
ve˘‹1BôDi°™˚Hammög
(c⁄° 
Ve˘‹
 *, const Vector *);

130 
ve˘‹Di°™˚L2
 (c⁄° 
Ve˘‹
 *, const Vector *);

131 
ve˘‹F8Di°™˚L2
 (c⁄° 
Ve˘‹
 *, const Vector *);

132 
ve˘‹F16Di°™˚L2
 (c⁄° 
Ve˘‹
 *, const Vector *);

133 
ve˘‹FB16Di°™˚L2
(c⁄° 
Ve˘‹
 *, const Vector *);

134 
ve˘‹F32Di°™˚L2
 (c⁄° 
Ve˘‹
 *, const Vector *);

135 
ve˘‹F64Di°™˚L2
(c⁄° 
Ve˘‹
 *, const Vector *);

142 
ve˘‹SîülizeWôhMëa
(
sqlôe4_c⁄ãxt
 *, c⁄° 
Ve˘‹
 *);

147 
ve˘‹P¨£SqlôeBlobWôhTy≥
(
sqlôe4_vÆue
 *, 
Ve˘‹
 *, **);

149 
ve˘‹F8De£rülizeFromBlob
 (
Ve˘‹
 *, c⁄° *, 
size_t
);

150 
ve˘‹F16De£rülizeFromBlob
 (
Ve˘‹
 *, c⁄° *, 
size_t
);

151 
ve˘‹FB16De£rülizeFromBlob
(
Ve˘‹
 *, c⁄° *, 
size_t
);

152 
ve˘‹F32De£rülizeFromBlob
 (
Ve˘‹
 *, c⁄° *, 
size_t
);

153 
ve˘‹F64De£rülizeFromBlob
 (
Ve˘‹
 *, c⁄° *, 
size_t
);

154 
ve˘‹1BôDe£rülizeFromBlob
(
Ve˘‹
 *, c⁄° *, 
size_t
);

156 
ve˘‹InôSètic
(
Ve˘‹
 *, 
Ve˘‹Ty≥
, 
Ve˘‹Dims
, *);

157 
ve˘‹InôFromBlob
(
Ve˘‹
 *, c⁄° *, 
size_t
);

159 
u16
 
ve˘‹F16FromFlﬂt
();

160 
ve˘‹F16ToFlﬂt
(
u16
);

162 
u16
 
ve˘‹FB16FromFlﬂt
();

163 
ve˘‹FB16ToFlﬂt
(
u16
);

165 
ve˘‹C⁄vît
(c⁄° 
Ve˘‹
 *, Vector *);

168 
dëe˘Ve˘‹P¨amëîs
(
sqlôe4_vÆue
 *, , *, *, **);

170 
ölöe
 
£rülizeF32
(*
pBuf
, 
vÆue
){

171 
u32
 *
p
 = (u32 *)&
vÆue
;

172 
pBuf
[0] = *
p
 & 0xFF;

173 
pBuf
[1] = (*
p
 >> 8) & 0xFF;

174 
pBuf
[2] = (*
p
 >> 16) & 0xFF;

175 
pBuf
[3] = (*
p
 >> 24) & 0xFF;

179 
ölöe
 
de£rülizeF32
(c⁄° *
pBuf
){

180 
u32
 
vÆue
 = 0;

181 
vÆue
 |(
u32
)
pBuf
[0];

182 
vÆue
 |(
u32
)
pBuf
[1] << 8;

183 
vÆue
 |(
u32
)
pBuf
[2] << 16;

184 
vÆue
 |(
u32
)
pBuf
[3] << 24;

185  *(*)&
vÆue
;

188 #ifde‡
__˝lu•lus


	@src/vectordiskann.c

54 #i‚de‡
SQLITE4_OMIT_VECTOR


56 
	~"m©h.h
"

57 
	~"sqlôeI¡.h
"

58 
	~"ve˘‹IndexI¡.h
"

61 #i‡
deföed
(
SQLITE4_DEBUG
Ë&& deföed(
SQLITE4_VECTOR_TRACE
)

62 
	#DiskA¬Tø˚
(
X
Ë
sqlôe4DebugPrötf
 X;

	)

64 
	#DiskA¬Tø˚
(
X
)

	)

70 
	#DISKANN_SQL_RENDER_LIMIT
 128

	)

75 
	#DISKANN_MAX_BLOCK_SZ
 134217728

	)

81 
	#DISKANN_BLOCK_SIZE_SHIFT
 9

	)

84 
Ve˘‹Paú
 
	tVe˘‹Paú
;

85 
DiskA¬SórchCtx
 
	tDiskA¬SórchCtx
;

86 
DiskA¬Node
 
	tDiskA¬Node
;

90 
	sVe˘‹Paú
 {

91 
	mnodeTy≥
;

92 
	medgeTy≥
;

93 
Ve˘‹
 *
	mpNode
;

94 
Ve˘‹
 *
	mpEdge
;

98 
	sDiskA¬Node
 {

99 
u64
 
	mnRowid
;

100 
	mvisôed
;

101 
DiskA¬Node
 *
	mpNext
;

102 
BlobSpŸ
 *
	mpBlobSpŸ
;

111 
	sDiskA¬SórchCtx
 {

112 
Ve˘‹Paú
 
	mquîy
;

113 
DiskA¬Node
 **
	maC™did©es
;

114 *
	maDi°™˚s
;

115 
	mnC™did©es
;

116 
	mmaxC™did©es
;

117 
DiskA¬Node
 **
	maT›C™did©es
;

118 *
	maT›Di°™˚s
;

119 
	mnT›C™did©es
;

120 
	mmaxT›C™did©es
;

121 
DiskA¬Node
 *
	mvisôedLi°
;

122 
	mnUnvisôed
;

123 
	mblobMode
;

130 
ölöe
 
u16
 
	$ªadLE16
(c⁄° *
p
){

131  (
u16
)
p
[0] | (u16)p[1] << 8;

132 
	}
}

134 
ölöe
 
u32
 
	$ªadLE32
(c⁄° *
p
){

135  (
u32
)
p
[0] | (u32)p[1] << 8 | (u32)p[2] << 16 | (u32)p[3] << 24;

136 
	}
}

138 
ölöe
 
u64
 
	$ªadLE64
(c⁄° *
p
){

139  (
u64
)
p
[0]

140 | (
u64
)
p
[1] << 8

141 | (
u64
)
p
[2] << 16

142 | (
u64
)
p
[3] << 24

143 | (
u64
)
p
[4] << 32

144 | (
u64
)
p
[5] << 40

145 | (
u64
)
p
[6] << 48

146 | (
u64
)
p
[7] << 56;

147 
	}
}

149 
ölöe
 
	$wrôeLE16
(*
p
, 
u16
 
v
){

150 
p
[0] = 
v
;

151 
p
[1] = 
v
 >> 8;

152 
	}
}

154 
ölöe
 
	$wrôeLE32
(*
p
, 
u32
 
v
){

155 
p
[0] = 
v
;

156 
p
[1] = 
v
 >> 8;

157 
p
[2] = 
v
 >> 16;

158 
p
[3] = 
v
 >> 24;

159 
	}
}

161 
ölöe
 
	$wrôeLE64
(*
p
, 
u64
 
v
){

162 
p
[0] = 
v
;

163 
p
[1] = 
v
 >> 8;

164 
p
[2] = 
v
 >> 16;

165 
p
[3] = 
v
 >> 24;

166 
p
[4] = 
v
 >> 32;

167 
p
[5] = 
v
 >> 40;

168 
p
[6] = 
v
 >> 48;

169 
p
[7] = 
v
 >> 56;

170 
	}
}

177 
	$blobSpŸC⁄vîtRc
(c⁄° 
DiskA¬Index
 *
pIndex
, 
rc
){

178 if–
rc
 =
SQLITE4_ERROR
 && 
	`°∫cmp
(
	`sqlôe4_îrmsg
(
pIndex
->
db
), "no suchÑowid", 13) == 0 ){

179  
DISKANN_ROW_NOT_FOUND
;

181  
rc
;

182 
	}
}

184 
	$blobSpŸCª©e
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 **
µBlobSpŸ
, 
u64
 
nRowid
, 
nBuf„rSize
, 
isWrôabÀ
) {

185 
rc
 = 
SQLITE4_OK
;

186 
BlobSpŸ
 *
pBlobSpŸ
;

187 
u8
 *
pBuf„r
;

189 
	`DiskA¬Tø˚
(("blob spŸ cª©ed:Ñowid=%Œd, isWrôabÀ=%d\n", 
nRowid
, 
isWrôabÀ
));

190 
	`as£π
–
nBuf„rSize
 > 0 );

192 
pBlobSpŸ
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, (
BlobSpŸ
));

193 if–
pBlobSpŸ
 =
NULL
 ){

194 
rc
 = 
SQLITE4_NOMEM
;

195 
out
;

198 
pBuf„r
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, 
nBuf„rSize
);

199 if–
pBuf„r
 =
NULL
 ){

200 
rc
 = 
SQLITE4_NOMEM
;

201 
out
;

205 
rc
 = 
	`sqlôe4_blob_›í
(
pIndex
->
db
,ÖIndex->
zDbSName
,ÖIndex->
zShadow
, "d©a", 
nRowid
, 
isWrôabÀ
, &
pBlobSpŸ
->
pBlob
);

206 
rc
 = 
	`blobSpŸC⁄vîtRc
(
pIndex
,Ñc);

207 if–
rc
 !
SQLITE4_OK
 ){

208 
out
;

210 
pBlobSpŸ
->
nRowid
 =ÇRowid;

211 
pBlobSpŸ
->
pBuf„r
 =ÖBuffer;

212 
pBlobSpŸ
->
nBuf„rSize
 =ÇBufferSize;

213 
pBlobSpŸ
->
isWrôabÀ
 = isWritable;

214 
pBlobSpŸ
->
isInôülized
 = 0;

215 
pBlobSpŸ
->
isAb‹ãd
 = 0;

217 *
µBlobSpŸ
 = 
pBlobSpŸ
;

218  
SQLITE4_OK
;

220 
out
:

221 if–
pBlobSpŸ
 !
NULL
 ){

222 
	`sqlôe4_‰ì
(
pIndex
->
db
->
pEnv
 , 
pBlobSpŸ
);

224 if–
pBuf„r
 !
NULL
 ){

225 
	`sqlôe4_‰ì
(
pIndex
->
db
->
pEnv
 , 
pBuf„r
);

227  
rc
;

228 
	}
}

230 
	$blobSpŸRñﬂd
(
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
u64
 
nRowid
, 
nBuf„rSize
) {

231 
rc
;

233 
	`DiskA¬Tø˚
(("blob spŸÑñﬂd:Ñowid=%Œd\n", 
nRowid
));

234 
	`as£π
–
pBlobSpŸ
 !
NULL
 && (pBlobSpŸ->
pBlob
 !NULL ||ÖBlobSpŸ->
isAb‹ãd
 ) );

235 
	`as£π
–
pBlobSpŸ
->
nBuf„rSize
 ==ÇBufferSize );

237 if–
pBlobSpŸ
->
nRowid
 =nRowid &&ÖBlobSpŸ->
isInôülized
 ){

238  
SQLITE4_OK
;

243 if–
pBlobSpŸ
->
isAb‹ãd
 ){

244 if–
pBlobSpŸ
->
pBlob
 !
NULL
 ){

245 
	`sqlôe4_blob_˛o£
(
pBlobSpŸ
->
pBlob
);

247 
pBlobSpŸ
->
pBlob
 = 
NULL
;

248 
pBlobSpŸ
->
isInôülized
 = 0;

249 
pBlobSpŸ
->
isAb‹ãd
 = 0;

250 
pBlobSpŸ
->
nRowid
 =ÇRowid;

252 
rc
 = 
	`sqlôe4_blob_›í
(
pIndex
->
db
,ÖIndex->
zDbSName
,ÖIndex->
zShadow
, "d©a", 
nRowid
, 
pBlobSpŸ
->
isWrôabÀ
, &pBlobSpŸ->
pBlob
);

253 
rc
 = 
	`blobSpŸC⁄vîtRc
(
pIndex
,Ñc);

254 if–
rc
 !
SQLITE4_OK
 ){

255 
ab‹t
;

259 if–
pBlobSpŸ
->
nRowid
 !=ÇRowid ){

260 
rc
 = 
	`sqlôe4_blob_ª›í
(
pBlobSpŸ
->
pBlob
, 
nRowid
);

261 
rc
 = 
	`blobSpŸC⁄vîtRc
(
pIndex
,Ñc);

262 if–
rc
 !
SQLITE4_OK
 ){

263 
ab‹t
;

265 
pBlobSpŸ
->
nRowid
 =ÇRowid;

266 
pBlobSpŸ
->
isInôülized
 = 0;

268 
rc
 = 
	`sqlôe4_blob_ªad
(
pBlobSpŸ
->
pBlob
,ÖBlobSpŸ->
pBuf„r
, 
nBuf„rSize
, 0);

269 if–
rc
 !
SQLITE4_OK
 ){

270 
ab‹t
;

272 
pIndex
->
nRóds
++;

273 
pBlobSpŸ
->
isInôülized
 = 1;

274  
SQLITE4_OK
;

276 
ab‹t
:

277 
pBlobSpŸ
->
isAb‹ãd
 = 1;

278 
pBlobSpŸ
->
isInôülized
 = 0;

279  
rc
;

280 
	}
}

282 
	$blobSpŸFlush
(
DiskA¬Index
* 
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
) {

283 
rc
 = 
	`sqlôe4_blob_wrôe
(
pBlobSpŸ
->
pBlob
,ÖBlobSpŸ->
pBuf„r
,ÖBlobSpŸ->
nBuf„rSize
, 0);

284 if–
rc
 !
SQLITE4_OK
 ){

285  
rc
;

287 
pIndex
->
nWrôes
++;

288  
rc
;

289 
	}
}

291 
	$blobSpŸFªe
(
BlobSpŸ
 *
pBlobSpŸ
) {

292 if–
pBlobSpŸ
->
pBlob
 !
NULL
 ){

293 
	`sqlôe4_blob_˛o£
(
pBlobSpŸ
->
pBlob
);

295 if–
pBlobSpŸ
->
pBuf„r
 !
NULL
 ){

296 
	`sqlôe4_‰ì
(0, 
pBlobSpŸ
->
pBuf„r
);

298 
	`sqlôe4_‰ì
(0, 
pBlobSpŸ
);

299 
	}
}

305 
	$nodeMëad©aSize
(
nF‹m©Vîsi⁄
){

306 if–
nF‹m©Vîsi⁄
 <
VECTOR_FORMAT_V2
 ){

307  ((
u64
Ë+ (
u16
));

309  ((
u64
) + (u64));

311 
	}
}

313 
	$edgeMëad©aSize
(
nF‹m©Vîsi⁄
){

314  ((
u64
) + (u64));

315 
	}
}

318 
	$nodeEdgeOvîhód
(
nF‹m©Vîsi⁄
, 
nEdgeVe˘‹Size
){

319  
nEdgeVe˘‹Size
 + 
	`edgeMëad©aSize
(
nF‹m©Vîsi⁄
);

320 
	}
}

323 
	$nodeOvîhód
(
nF‹m©Vîsi⁄
, 
nNodeVe˘‹Size
){

324  
nNodeVe˘‹Size
 + 
	`nodeMëad©aSize
(
nF‹m©Vîsi⁄
);

325 
	}
}

327 
	$nodeEdgesMaxCou¡
(c⁄° 
DiskA¬Index
 *
pIndex
){

328 
nMaxEdges
 = (
pIndex
->
nBlockSize
 - 
	`nodeOvîhód
’Index->
nF‹m©Vîsi⁄
,ÖIndex->
nNodeVe˘‹Size
)Ë/ 
	`nodeEdgeOvîhód
’Index->nF‹m©Vîsi⁄,ÖIndex->
nEdgeVe˘‹Size
);

329 
	`as£π
–
nMaxEdges
 > 0);

330  
nMaxEdges
;

331 
	}
}

333 
	$nodeEdgesMëad©aOff£t
(c⁄° 
DiskA¬Index
 *
pIndex
){

334 
off£t
;

335 
nMaxEdges
 = 
	`nodeEdgesMaxCou¡
(
pIndex
);

336 
off£t
 = 
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 + 
nMaxEdges
 *ÖIndex->
nEdgeVe˘‹Size
;

337 
	`as£π
–
off£t
 <
pIndex
->
nBlockSize
 );

338  
off£t
;

339 
	}
}

341 
	$nodeBöInô
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
u64
 
nRowid
, 
Ve˘‹
 *
pVe˘‹
){

342 
	`as£π
–
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 <
pBlobSpŸ
->
nBuf„rSize
 );

344 
	`mem£t
(
pBlobSpŸ
->
pBuf„r
, 0,ÖBlobSpŸ->
nBuf„rSize
);

345 
	`wrôeLE64
(
pBlobSpŸ
->
pBuf„r
, 
nRowid
);

348 
	`ve˘‹SîülizeToBlob
(
pVe˘‹
, 
pBlobSpŸ
->
pBuf„r
 + 
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
),ÖIndex->
nNodeVe˘‹Size
);

349 
	}
}

351 
	$nodeBöVe˘‹
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
, 
Ve˘‹
 *
pVe˘‹
) {

352 
	`as£π
–
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 <
pBlobSpŸ
->
nBuf„rSize
 );

354 
	`ve˘‹InôSètic
(
pVe˘‹
, 
pIndex
->
nNodeVe˘‹Ty≥
,ÖIndex->
nVe˘‹Dims
, 
pBlobSpŸ
->
pBuf„r
 + 
	`nodeMëad©aSize
’Index->
nF‹m©Vîsi⁄
));

355 
	}
}

357 
u16
 
	$nodeBöEdges
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
) {

358 
	`as£π
–
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë<
pBlobSpŸ
->
nBuf„rSize
 );

360  
	`ªadLE16
(
pBlobSpŸ
->
pBuf„r
 + (
u64
));

361 
	}
}

363 
	$nodeBöEdge
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
, 
iEdge
, 
u64
 *
pRowid
, *
pDi°™˚
, 
Ve˘‹
 *
pVe˘‹
) {

364 
u32
 
di°™˚
;

365 
off£t
 = 
	`nodeEdgesMëad©aOff£t
(
pIndex
);

367 if–
pRowid
 !
NULL
 ){

368 
	`as£π
–
off£t
 + (
iEdge
 + 1Ë* 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë<
pBlobSpŸ
->
nBuf„rSize
 );

369 *
pRowid
 = 
	`ªadLE64
(
pBlobSpŸ
->
pBuf„r
 + 
off£t
 + 
iEdge
 * 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ (
u64
));

371 if–
pIndex
->
nF‹m©Vîsi⁄
 !
VECTOR_FORMAT_V1
 && 
pDi°™˚
 !
NULL
 ){

372 
di°™˚
 = 
	`ªadLE32
(
pBlobSpŸ
->
pBuf„r
 + 
off£t
 + 
iEdge
 * 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ (
u32
));

373 *
pDi°™˚
 = *((*)&
di°™˚
);

375 if–
pVe˘‹
 !
NULL
 ){

376 
	`as£π
–
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 + 
iEdge
 *ÖIndex->
nEdgeVe˘‹Size
 < 
off£t
 );

377 
	`ve˘‹InôSètic
(

378 
pVe˘‹
,

379 
pIndex
->
nEdgeVe˘‹Ty≥
,

380 
pIndex
->
nVe˘‹Dims
,

381 
pBlobSpŸ
->
pBuf„r
 + 
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 + 
iEdge
 *ÖIndex->
nEdgeVe˘‹Size


384 
	}
}

386 
	$nodeBöEdgeFödIdx
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
, 
u64
 
nRowid
) {

387 
i
, 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pBlobSpŸ
);

389 
i
 = 0; i < 
nEdges
; i++){

390 
u64
 
edgeId
;

391 
	`nodeBöEdge
(
pIndex
, 
pBlobSpŸ
, 
i
, &
edgeId
, 
NULL
, NULL);

392 if–
edgeId
 =
nRowid
 ){

393  
i
;

397 
	}
}

399 
	$nodeBöPru√Edges
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
nPru√d
) {

400 
	`as£π
–0 <
nPru√d
 &&ÇPru√d <
	`nodeBöEdges
(
pIndex
, 
pBlobSpŸ
) );

402 
	`wrôeLE16
(
pBlobSpŸ
->
pBuf„r
 + (
u64
), 
nPru√d
);

403 
	}
}

406 
	$nodeBöRïœ˚Edge
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
iRïœ˚
, 
u64
 
nRowid
, 
di°™˚
, 
Ve˘‹
 *
pVe˘‹
) {

407 
nMaxEdges
 = 
	`nodeEdgesMaxCou¡
(
pIndex
);

408 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pBlobSpŸ
);

409 
edgeVe˘‹Off£t
, 
edgeMëaOff£t
, 
ôemsToMove
;

411 
	`as£π
–0 <
iRïœ˚
 && iRïœ˚ < 
nMaxEdges
 );

412 
	`as£π
–0 <
iRïœ˚
 && iRïœ˚ <
nEdges
 );

414 if–
iRïœ˚
 =
nEdges
 ){

415 
nEdges
++;

418 
edgeVe˘‹Off£t
 = 
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 + 
iRïœ˚
 *ÖIndex->
nEdgeVe˘‹Size
;

419 
edgeMëaOff£t
 = 
	`nodeEdgesMëad©aOff£t
(
pIndex
Ë+ 
iRïœ˚
 * 
	`edgeMëad©aSize
’Index->
nF‹m©Vîsi⁄
);

421 
	`as£π
–
edgeVe˘‹Off£t
 + 
pIndex
->
nEdgeVe˘‹Size
 <
pBlobSpŸ
->
nBuf„rSize
 );

422 
	`as£π
–
edgeMëaOff£t
 + 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë<
pBlobSpŸ
->
nBuf„rSize
 );

424 
	`ve˘‹SîülizeToBlob
(
pVe˘‹
, 
pBlobSpŸ
->
pBuf„r
 + 
edgeVe˘‹Off£t
, 
pIndex
->
nEdgeVe˘‹Size
);

425 
	`wrôeLE32
(
pBlobSpŸ
->
pBuf„r
 + 
edgeMëaOff£t
 + (
u32
), *((u32*)&
di°™˚
));

426 
	`wrôeLE64
(
pBlobSpŸ
->
pBuf„r
 + 
edgeMëaOff£t
 + (
u64
), 
nRowid
);

428 
	`wrôeLE16
(
pBlobSpŸ
->
pBuf„r
 + (
u64
), 
nEdges
);

429 
	}
}

432 
	$nodeBöDñëeEdge
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pBlobSpŸ
, 
iDñëe
) {

433 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pBlobSpŸ
);

434 
edgeVe˘‹Off£t
, 
edgeMëaOff£t
, 
œ°Ve˘‹Off£t
, 
œ°MëaOff£t
;

436 
	`as£π
–0 <
iDñëe
 && iDñëê< 
nEdges
 );

438 
edgeVe˘‹Off£t
 = 
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 + 
iDñëe
 *ÖIndex->
nEdgeVe˘‹Size
;

439 
œ°Ve˘‹Off£t
 = 
	`nodeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë+ÖIndex->
nNodeVe˘‹Size
 + (
nEdges
 - 1Ë*ÖIndex->
nEdgeVe˘‹Size
;

440 
edgeMëaOff£t
 = 
	`nodeEdgesMëad©aOff£t
(
pIndex
Ë+ 
iDñëe
 * 
	`edgeMëad©aSize
’Index->
nF‹m©Vîsi⁄
);

441 
œ°MëaOff£t
 = 
	`nodeEdgesMëad©aOff£t
(
pIndex
Ë+ (
nEdges
 - 1Ë* 
	`edgeMëad©aSize
’Index->
nF‹m©Vîsi⁄
);

443 
	`as£π
–
edgeVe˘‹Off£t
 + 
pIndex
->
nEdgeVe˘‹Size
 <
pBlobSpŸ
->
nBuf„rSize
 );

444 
	`as£π
–
œ°Ve˘‹Off£t
 + 
pIndex
->
nEdgeVe˘‹Size
 <
pBlobSpŸ
->
nBuf„rSize
 );

445 
	`as£π
–
edgeMëaOff£t
 + 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë<
pBlobSpŸ
->
nBuf„rSize
 );

446 
	`as£π
–
œ°MëaOff£t
 + 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
Ë<
pBlobSpŸ
->
nBuf„rSize
 );

448 if–
edgeVe˘‹Off£t
 < 
œ°Ve˘‹Off£t
 ){

449 
	`memmove
(
pBlobSpŸ
->
pBuf„r
 + 
edgeVe˘‹Off£t
,ÖBlobSpŸ->pBuf„∏+ 
œ°Ve˘‹Off£t
, 
pIndex
->
nEdgeVe˘‹Size
);

450 
	`memmove
(
pBlobSpŸ
->
pBuf„r
 + 
edgeMëaOff£t
,ÖBlobSpŸ->pBuf„∏+ 
œ°MëaOff£t
, 
	`edgeMëad©aSize
(
pIndex
->
nF‹m©Vîsi⁄
));

453 
	`wrôeLE16
(
pBlobSpŸ
->
pBuf„r
 + (
u64
), 
nEdges
 - 1);

454 
	}
}

456 
	$nodeBöDebug
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
BlobSpŸ
 *
pBlobSpŸ
) {

457 #i‡
	`deföed
(
SQLITE4_DEBUG
Ë&& deföed(
SQLITE4_VECTOR_TRACE
)

458 
nEdges
, 
nMaxEdges
, 
i
;

459 
u64
 
nRowid
;

460 
di°™˚
 = 0;

461 
Ve˘‹
 
ve˘‹
;

463 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pBlobSpŸ
);

464 
nMaxEdges
 = 
	`nodeEdgesMaxCou¡
(
pIndex
);

465 
	`nodeBöVe˘‹
(
pIndex
, 
pBlobSpŸ
, &
ve˘‹
);

467 
	`DiskA¬Tø˚
(("debug blob c⁄ã¡ f‹ÑoŸ=%Œd (buf„∏size=%d)\n", 
pBlobSpŸ
->
nRowid
,ÖBlobSpŸ->
nBuf„rSize
));

468 
	`DiskA¬Tø˚
(("ÇEdges=%d,ÇMaxEdges=%d, ve˘‹=", 
nEdges
, 
nMaxEdges
));

469 
	`ve˘‹Dump
(&
ve˘‹
);

470 
i
 = 0; i < 
nEdges
; i++){

471 
	`nodeBöEdge
(
pIndex
, 
pBlobSpŸ
, 
i
, &
nRowid
, &
di°™˚
, &
ve˘‹
);

472 
	`DiskA¬Tø˚
(("Åo=%Œd, di°™˚=%f, ve˘‹=", 
nRowid
, 
di°™˚
));

473 
	`ve˘‹Dump
(&
ve˘‹
);

476 
	}
}

482 
	$diskA¬FûlTabÀTnum
(
sqlôe4
 *
db
, c⁄° *
zDbSName
, c⁄° *
zTabName
){

483 
TabÀ
 *
pTab
;

484 
sqlôe4_°mt
 *
pStmt
 = 0;

485 
rc
 = 
SQLITE4_OK
;

486 *
zSql
 = 0;

487 
roŸ
 = 0;

489 
pTab
 = 
	`sqlôe4FödTabÀ
(
db
, 
zTabName
, 
zDbSName
);

490 if–
pTab
==0 )  
SQLITE4_ERROR
;

491 if–
pTab
->
äum
>0 )  
SQLITE4_OK
;

493 
zSql
 = 
	`sqlôe4MPrötf
(
db
,

495 
zDbSName


497 if–
zSql
==0 )  
SQLITE4_NOMEM
;

499 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

500 
	`sqlôe4DbFªe
(
db
, 
zSql
);

501 if–
rc
!=
SQLITE4_OK
 ) Ñc;

503 
	`sqlôe4_böd_ãxt
(
pStmt
, 1, 
zTabName
, -1, 
SQLITE4_STATIC
, 0);

504 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

505 if–
rc
==
SQLITE4_ROW
 ){

506 
roŸ
 = 
	`sqlôe4_cﬁumn_öt
(
pStmt
, 0);

507 if–
roŸ
>0 ) 
pTab
->
äum
 =Ñoot;

508 
rc
 = 
SQLITE4_OK
;

510 
rc
 = 
SQLITE4_ERROR
;

513 
	`sqlôe4_föÆize
(
pStmt
);

514  
rc
;

515 
	}
}

517 
	$diskA¬Cª©eIndex
(

518 
sqlôe4
 *
db
,

519 c⁄° *
zDbSName
,

520 c⁄° *
zIdxName
,

521 c⁄° 
Ve˘‹IdxKey
 *
pKey
,

522 
Ve˘‹IdxP¨ams
 *
pP¨ams
,

523 c⁄° **
pzEºMsg


525 
rc
;

526 
ty≥
, 
dims
, 
mëric
, 
√ighbours
;

527 
u64
 
maxNeighb‹sP¨am
, 
blockSizeByãs
;

528 *
zSql
;

529 c⁄° *
zRowidCﬁumnName
;

530 
cﬁumnSqlDefs
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

531 
cﬁumnSqlNames
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

533 
	`¥ötf
("diskAnnCreateIndex:Éntered\n");

534 if–
	`ve˘‹IdxKeyDefsRídî
(
pKey
, "ödex_key", 
cﬁumnSqlDefs
, (columnSqlDefs)) != 0 ){

535 
	`¥ötf
("diskAnnCreateIndex: vectorIdxKeyDefsRender failed\n");

536  
SQLITE4_ERROR
;

538 if–
	`ve˘‹IdxKeyNamesRídî
(
pKey
->
nKeyCﬁumns
, "ödex_key", 
cﬁumnSqlNames
, (columnSqlNames)) != 0 ){

539 
	`¥ötf
("diskAnnCreateIndex: vectorIdxKeyNamesRender failed\n");

540  
SQLITE4_ERROR
;

542 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_INDEX_TYPE_PARAM_ID
, 
VECTOR_INDEX_TYPE_DISKANN
) != 0 ){

543 
	`¥ötf
("diskAnnCreateIndex: vectorIdxParamsPutU64 failed\n");

544  
SQLITE4_ERROR
;

546 
ty≥
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_TYPE_PARAM_ID
);

547 if–
ty≥
 == 0 ){

548 
	`¥ötf
("diskAnnCreateIndex: vectorÅype isÇot specified\n");

549  
SQLITE4_ERROR
;

551 
dims
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_DIM_PARAM_ID
);

552 if–
dims
 == 0 ){

553 
	`¥ötf
("diskAnnCreateIndex: vector dimensions isÇot specified\n");

554  
SQLITE4_ERROR
;

556 
	`as£π
–0 < 
dims
 && dim†<
MAX_VECTOR_SZ
 );

558 
mëric
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_METRIC_TYPE_PARAM_ID
);

559 if–
mëric
 == 0 ){

560 
mëric
 = 
VECTOR_METRIC_TYPE_COS
;

561 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_METRIC_TYPE_PARAM_ID
, 
mëric
) != 0 ){

562 
	`¥ötf
("diskAnnCreateIndex: vectorIdxParamsPutU64 failed\n");

563  
SQLITE4_ERROR
;

566 
√ighbours
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
);

567 if–
√ighbours
 =
VECTOR_TYPE_FLOAT1BIT
 && 
mëric
 !
VECTOR_METRIC_TYPE_COS
 ){

568 *
pzEºMsg
 = "1-bit compressionávailable only for cosine metric";

569  
SQLITE4_ERROR
;

571 if–
√ighbours
 == 0 ){

572 
√ighbours
 = 
ty≥
;

575 
maxNeighb‹sP¨am
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_MAX_NEIGHBORS_PARAM_ID
);

576 if–
maxNeighb‹sP¨am
 == 0 ){

579 
maxNeighb‹sP¨am
 = 
	`MIN
(3 * (()(
	`sqπ
(
dims
)Ë+ 1), (50 * 
	`nodeOvîhód
(
VECTOR_FORMAT_DEFAULT
, 
	`ve˘‹D©aSize
(
ty≥
, dims))Ë/ 
	`nodeEdgeOvîhód
(VECTOR_FORMAT_DEFAULT, ve˘‹D©aSize(
√ighbours
, dims)) + 1);

581 
blockSizeByãs
 = 
	`nodeOvîhód
(
VECTOR_FORMAT_DEFAULT
, 
	`ve˘‹D©aSize
(
ty≥
, 
dims
)Ë+ 
maxNeighb‹sP¨am
 * (
u64
)
	`nodeEdgeOvîhód
(VECTOR_FORMAT_DEFAULT, ve˘‹D©aSize(
√ighbours
, dims));

582 if–
blockSizeByãs
 > 
DISKANN_MAX_BLOCK_SZ
 ){

583  
SQLITE4_ERROR
;

585 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_BLOCK_SIZE_PARAM_ID
, 
	`MAX
(256, 
blockSizeByãs
)) != 0 ){

586  
SQLITE4_ERROR
;

589 if–
	`ve˘‹IdxP¨amsGëF64
(
pP¨ams
, 
VECTOR_PRUNING_ALPHA_PARAM_ID
) == 0 ){

590 if–
	`ve˘‹IdxP¨amsPutF64
(
pP¨ams
, 
VECTOR_PRUNING_ALPHA_PARAM_ID
, 
VECTOR_PRUNING_ALPHA_DEFAULT
) != 0 ){

591  
SQLITE4_ERROR
;

594 if–
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_INSERT_L_PARAM_ID
) == 0 ){

595 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_INSERT_L_PARAM_ID
, 
VECTOR_INSERT_L_DEFAULT
) != 0 ){

596  
SQLITE4_ERROR
;

599 if–
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_SEARCH_L_PARAM_ID
) == 0 ){

600 if–
	`ve˘‹IdxP¨amsPutU64
(
pP¨ams
, 
VECTOR_SEARCH_L_PARAM_ID
, 
VECTOR_SEARCH_L_DEFAULT
) != 0 ){

601  
SQLITE4_ERROR
;

608 if–
	`ve˘‹IdxKeyRowidLike
(
pKey
) ){

609 
zSql
 = 
	`sqlôe4MPrötf
(

610 
db
,

612 
zDbSName
,

613 
zIdxName
,

614 
cﬁumnSqlDefs
,

615 
cﬁumnSqlNames


617 
zRowidCﬁumnName
 = "index_key";

619 
zSql
 = 
	`sqlôe4MPrötf
(

620 
db
,

622 
zDbSName
,

623 
zIdxName
,

624 
cﬁumnSqlDefs
,

625 
cﬁumnSqlNames


627 
zRowidCﬁumnName
 = "rowid";

629 
	`¥ötf
("diskA¬Cª©eIndex: cª©ög shadowÅabÀ wôh SQL: %s\n", 
zSql
);

630 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 0, 0);

632 
	`sqlôe4DbFªe
(
db
, 
zSql
);

633 if–
rc
 !
SQLITE4_OK
 ){

634  
rc
;

636 *
zShadowName
 = 
	`sqlôe4MPrötf
(
db
, "%s_shadow", 
zIdxName
);

637 if–
zShadowName
==0 )  
SQLITE4_NOMEM
;

638 
rc
 = 
	`diskA¬FûlTabÀTnum
(
db
, 
zDbSName
, 
zShadowName
);

639 
	`sqlôe4DbFªe
(
db
, 
zShadowName
);

640 if–
rc
!=
SQLITE4_OK
 ) Ñc;

649 
zSql
 = 
	`sqlôe4MPrötf
(

650 
db
,

652 
zDbSName
,

653 
zIdxName
,

654 
zIdxName
,

655 
zRowidCﬁumnName


657 
	`¥ötf
("diskA¬Cª©eIndex: cª©ög index wôh SQL: %s\n", 
zSql
);

658 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 0, 0);

660 
	`sqlôe4DbFªe
(
db
, 
zSql
);

663  
rc
;

664 
	}
}

666 
	$diskA¬CÀ¨Index
(
sqlôe4
 *
db
, c⁄° *
zDbSName
, c⁄° *
zIdxName
) {

667 *
zSql
 = 
	`sqlôe4MPrötf
(
db
, "DELETE FROM \"%w\".%s_shadow", 
zDbSName
, 
zIdxName
);

668 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 0, 0);

669 
	`sqlôe4DbFªe
(
db
, 
zSql
);

670  
rc
;

671 
	}
}

673 
	$diskA¬Dr›Index
(
sqlôe4
 *
db
, c⁄° *
zDbSName
, c⁄° *
zIdxName
){

674 *
zSql
 = 
	`sqlôe4MPrötf
(
db
, "DROP TABLE \"%w\".%s_shadow", 
zDbSName
, 
zIdxName
);

675 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 0, 0);

676 
	`sqlôe4DbFªe
(
db
, 
zSql
);

677  
rc
;

678 
	}
}

685 
	$diskA¬Sñe˘R™domShadowRow
(c⁄° 
DiskA¬Index
 *
pIndex
, 
u64
 *
pRowid
){

686 
rc
;

687 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

688 *
zSql
 = 
NULL
;

690 
zSql
 = 
	`sqlôe4MPrötf
(

691 
pIndex
->
db
,

693 
pIndex
->
zDbSName
,ÖIndex->
zShadow
,ÖIndex->zDbSName,ÖIndex->zShadow

695 if–
zSql
 =
NULL
 ){

696 
rc
 = 
SQLITE4_NOMEM
;

697 
out
;

699 
rc
 = 
	`sqlôe4_¥ï¨e
(
pIndex
->
db
, 
zSql
, -1, &
pStmt
, 0);

700 if–
rc
 !
SQLITE4_OK
 ){

701 
out
;

703 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

704 if–
rc
 !
SQLITE4_ROW
 ){

705 
out
;

708 
	`as£π
–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0Ë=
SQLITE4_INTEGER
 );

709 *
pRowid
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 0);

712 
	`as£π
–
	`sqlôe4_°ï
(
pStmt
Ë=
SQLITE4_DONE
 );

713 
rc
 = 
SQLITE4_OK
;

714 
out
:

715 if–
pStmt
 !
NULL
 ){

716 
	`sqlôe4_föÆize
(
pStmt
);

718 if–
zSql
 !
NULL
 ){

719 
	`sqlôe4DbFªe
(
pIndex
->
db
, 
zSql
);

721  
rc
;

722 
	}
}

728 
	$diskA¬GëShadowRowid
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
Ve˘‹InRow
 *
pInRow
, 
u64
 *
pRowid
) {

729 
rc
, 
i
;

730 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

731 *
zSql
 = 
NULL
;

733 
cﬁumnSqlNames
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

734 
cﬁumnSqlPœ˚hﬁdîs
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

735 if–
	`ve˘‹IdxKeyNamesRídî
(
pInRow
->
nKeys
, "ödex_key", 
cﬁumnSqlNames
, (columnSqlNames)) != 0 ){

736 
rc
 = 
SQLITE4_ERROR
;

737 
out
;

739 if–
	`ve˘‹InRowPœ˚hﬁdîRídî
(
pInRow
, 
cﬁumnSqlPœ˚hﬁdîs
, (columnSqlPlaceholders)) != 0 ){

740 
rc
 = 
SQLITE4_ERROR
;

741 
out
;

743 
zSql
 = 
	`sqlôe4MPrötf
(

744 
pIndex
->
db
,

746 
pIndex
->
zDbSName
,ÖIndex->
zShadow
, 
cﬁumnSqlNames
, 
cﬁumnSqlPœ˚hﬁdîs


748 if–
zSql
 =
NULL
 ){

749 
rc
 = 
SQLITE4_NOMEM
;

750 
out
;

752 
rc
 = 
	`sqlôe4_¥ï¨e
(
pIndex
->
db
, 
zSql
, -1, &
pStmt
, 0);

753 if–
rc
 !
SQLITE4_OK
 ){

754 
out
;

756 
i
 = 0; i < 
pInRow
->
nKeys
; i++){

757 
rc
 = 
	`sqlôe4_böd_vÆue
(
pStmt
, 
i
 + 1, 
	`ve˘‹InRowKey
(
pInRow
, i));

758 if–
rc
 !
SQLITE4_OK
 ){

759 
out
;

762 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

763 if–
rc
 !
SQLITE4_ROW
 ){

764 
out
;

767 
	`as£π
–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0Ë=
SQLITE4_INTEGER
 );

768 *
pRowid
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 0);

771 
	`as£π
–
	`sqlôe4_°ï
(
pStmt
Ë=
SQLITE4_DONE
 );

772 
rc
 = 
SQLITE4_OK
;

773 
out
:

774 if–
pStmt
 !
NULL
 ){

775 
	`sqlôe4_föÆize
(
pStmt
);

777 if–
zSql
 !
NULL
 ){

778 
	`sqlôe4DbFªe
(
pIndex
->
db
, 
zSql
);

780  
rc
;

781 
	}
}

786 
	$diskA¬GëShadowRowKeys
(c⁄° 
DiskA¬Index
 *
pIndex
, 
u64
 
nRowid
, c⁄° 
Ve˘‹IdxKey
 *
pKey
, 
Ve˘‹OutRows
 *
pRows
, 
iRow
) {

787 
rc
, 
i
;

788 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

789 *
zSql
 = 
NULL
;

791 
cﬁumnSqlNames
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

792 if–
	`ve˘‹IdxKeyNamesRídî
(
pKey
->
nKeyCﬁumns
, "ödex_key", 
cﬁumnSqlNames
, (columnSqlNames)) != 0 ){

793 
rc
 = 
SQLITE4_ERROR
;

794 
out
;

796 
zSql
 = 
	`sqlôe4MPrötf
(

797 
pIndex
->
db
,

799 
cﬁumnSqlNames
, 
pIndex
->
zDbSName
,ÖIndex->
zShadow


801 if–
zSql
 =
NULL
 ){

802 
rc
 = 
SQLITE4_NOMEM
;

803 
out
;

805 
rc
 = 
	`sqlôe4_¥ï¨e
(
pIndex
->
db
, 
zSql
, -1, &
pStmt
, 0);

806 if–
rc
 !
SQLITE4_OK
 ){

807 
out
;

809 
rc
 = 
	`sqlôe4_böd_öt64
(
pStmt
, 1, 
nRowid
);

810 if–
rc
 !
SQLITE4_OK
 ){

811 
out
;

813 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

814 if–
rc
 !
SQLITE4_ROW
 ){

815 
out
;

817 
i
 = 0; i < 
pRows
->
nCﬁs
; i++){

818 
rc
 = 
	`ve˘‹OutRowsPut
(
pRows
, 
iRow
, 
i
, 
NULL
, 
	`sqlôe4_cﬁumn_vÆue
(
pStmt
, i), 
pIndex
->
db
);

819 if–
rc
 !
SQLITE4_OK
 ){

820 
out
;

825 
	`as£π
–
	`sqlôe4_°ï
(
pStmt
Ë=
SQLITE4_DONE
 );

826 
rc
 = 
SQLITE4_OK
;

827 
out
:

828 if–
pStmt
 !
NULL
 ){

829 
	`sqlôe4_föÆize
(
pStmt
);

831 if–
zSql
 !
NULL
 ){

832 
	`sqlôe4DbFªe
(
pIndex
->
db
, 
zSql
);

834  
rc
;

835 
	}
}

840 
	$diskA¬In£πShadowRow
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
Ve˘‹InRow
 *
pVe˘‹InRow
, 
u64
 *
pRowid
){

841 
rc
, 
i
;

842 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

843 *
zSql
 = 
NULL
;

845 
cﬁumnSqlPœ˚hﬁdîs
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

846 
cﬁumnSqlNames
[
VECTOR_INDEX_SQL_RENDER_LIMIT
];

847 if–
	`ve˘‹InRowPœ˚hﬁdîRídî
(
pVe˘‹InRow
, 
cﬁumnSqlPœ˚hﬁdîs
, (columnSqlPlaceholders)) != 0 ){

848 
rc
 = 
SQLITE4_ERROR
;

849 
out
;

851 if–
	`ve˘‹IdxKeyNamesRídî
(
pVe˘‹InRow
->
nKeys
, "ödex_key", 
cﬁumnSqlNames
, (columnSqlNames)) != 0 ){

852  
SQLITE4_ERROR
;

854 
zSql
 = 
	`sqlôe4MPrötf
(

855 
pIndex
->
db
,

857 
pIndex
->
zDbSName
,ÖIndex->
zShadow
, 
cﬁumnSqlNames
, 
cﬁumnSqlPœ˚hﬁdîs


859 if–
zSql
 =
NULL
 ){

860 
rc
 = 
SQLITE4_NOMEM
;

861 
out
;

863 
rc
 = 
	`sqlôe4_¥ï¨e
(
pIndex
->
db
, 
zSql
, -1, &
pStmt
, 0);

864 if–
rc
 !
SQLITE4_OK
 ){

865 
out
;

867 
i
 = 0; i < 
pVe˘‹InRow
->
nKeys
; i++){

868 
rc
 = 
	`sqlôe4_böd_vÆue
(
pStmt
, 
i
 + 1, 
	`ve˘‹InRowKey
(
pVe˘‹InRow
, i));

869 if–
rc
 !
SQLITE4_OK
 ){

870 
out
;

873 
rc
 = 
	`sqlôe4_böd_zîoblob
(
pStmt
, 
pVe˘‹InRow
->
nKeys
 + 1, 
pIndex
->
nBlockSize
);

874 if–
rc
 !
SQLITE4_OK
 ){

875 
out
;

877 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

878 if–
rc
 !
SQLITE4_ROW
 ){

879 
rc
 = 
SQLITE4_ERROR
;

880 
out
;

883 
	`as£π
–
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 0Ë=
SQLITE4_INTEGER
 );

884 *
pRowid
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 0);

887 
	`as£π
–
	`sqlôe4_°ï
(
pStmt
Ë=
SQLITE4_DONE
 );

888 
rc
 = 
SQLITE4_OK
;

889 
out
:

890 if–
pStmt
 !
NULL
 ){

891 
	`sqlôe4_föÆize
(
pStmt
);

893 if–
zSql
 !
NULL
 ){

894 
	`sqlôe4DbFªe
(
pIndex
->
db
, 
zSql
);

896  
rc
;

897 
	}
}

902 
	$diskA¬DñëeShadowRow
(c⁄° 
DiskA¬Index
 *
pIndex
, 
i64
 
nRowid
){

903 
rc
;

904 
sqlôe4_°mt
 *
pStmt
 = 
NULL
;

905 *
zSql
 = 
	`sqlôe4MPrötf
(

906 
pIndex
->
db
,

908 
pIndex
->
zDbSName
,ÖIndex->
zShadow


910 if–
zSql
 =
NULL
 ){

911 
rc
 = 
SQLITE4_NOMEM
;

912 
out
;

914 
rc
 = 
	`sqlôe4_¥ï¨e
(
pIndex
->
db
, 
zSql
, -1, &
pStmt
, 0);

915 if–
rc
 !
SQLITE4_OK
 ){

916 
out
;

918 
rc
 = 
	`sqlôe4_böd_öt64
(
pStmt
, 1, 
nRowid
);

919 if–
rc
 !
SQLITE4_OK
 ){

920 
out
;

922 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

923 if–
rc
 !
SQLITE4_DONE
 ){

924 
out
;

926 
rc
 = 
SQLITE4_OK
;

927 
out
:

928 if–
pStmt
 !
NULL
 ){

929 
	`sqlôe4_föÆize
(
pStmt
);

931 if–
zSql
 !
NULL
 ){

932 
	`sqlôe4DbFªe
(
pIndex
->
db
, 
zSql
);

934  
rc
;

935 
	}
}

941 
	$öôVe˘‹Paú
(
nodeTy≥
, 
edgeTy≥
, 
dims
, 
Ve˘‹Paú
 *
pPaú
){

942 
pPaú
->
nodeTy≥
 =ÇodeType;

943 
pPaú
->
edgeTy≥
 =ÉdgeType;

944 
pPaú
->
pNode
 = 
NULL
;

945 
pPaú
->
pEdge
 = 
NULL
;

946 if–
pPaú
->
nodeTy≥
 =pPaú->
edgeTy≥
 ){

949 
pPaú
->
pEdge
 = 
	`ve˘‹AŒoc
(
edgeTy≥
, 
dims
);

950 if–
pPaú
->
pEdge
 =
NULL
 ){

951  
SQLITE4_NOMEM
;

954 
	}
}

956 
	$lﬂdVe˘‹Paú
(
Ve˘‹Paú
 *
pPaú
, c⁄° 
Ve˘‹
 *
pVe˘‹
){

957 
pPaú
->
pNode
 = (
Ve˘‹
*)
pVe˘‹
;

958 if–
pPaú
->
edgeTy≥
 !pPaú->
nodeTy≥
 ){

959 
	`ve˘‹C⁄vît
(
pPaú
->
pNode
,ÖPaú->
pEdge
);

961 
pPaú
->
pEdge
 =ÖPaú->
pNode
;

963 
	}
}

965 
	$deöôVe˘‹Paú
(
Ve˘‹Paú
 *
pPaú
) {

966 if–
pPaú
->
pEdge
 !
NULL
 &&ÖPaú->
pNode
 !=ÖPair->pEdge ){

967 
	`ve˘‹Fªe
(
pPaú
->
pEdge
);

969 
	}
}

971 
	$di°™˚Buf„rIn£πIdx
(c⁄° *
aDi°™˚s
, 
nSize
, 
nMaxSize
, 
di°™˚
){

972 
i
;

973 #ifde‡
SQLITE4_DEBUG


974 
i
 = 0; i < 
nSize
 - 1; i++){

975 
	`as£π
(
aDi°™˚s
[
i
] <=áDistances[i + 1]);

978 
i
 = 0; i < 
nSize
; i++){

979 if–
di°™˚
 < 
aDi°™˚s
[
i
] ){

980  
i
;

983  
nSize
 < 
nMaxSize
 ?ÇSize : -1;

984 
	}
}

986 
	$buf„rIn£π
(
u8
 *
aBuf„r
, 
nSize
, 
nMaxSize
, 
iIn£π
, 
nIãmSize
, c⁄° u8 *
pIãm
, u8 *
pLa°
) {

987 
ôemsToMove
;

989 
	`as£π
–
nMaxSize
 > 0 && 
nIãmSize
 > 0 );

990 
	`as£π
–
nSize
 <
nMaxSize
 );

991 
	`as£π
–0 <
iIn£π
 && iIn£π <
nSize
 && iIn£π < 
nMaxSize
 );

993 if–
nSize
 =
nMaxSize
 ){

994 if–
pLa°
 !
NULL
 ){

995 
	`mem˝y
(
pLa°
, 
aBuf„r
 + (
nSize
 - 1Ë* 
nIãmSize
,ÇItemSize);

997 
nSize
--;

999 
ôemsToMove
 = 
nSize
 - 
iIn£π
;

1000 
	`memmove
(
aBuf„r
 + (
iIn£π
 + 1Ë* 
nIãmSize
,áBuf„∏+ iIn£π *ÇIãmSize, 
ôemsToMove
 *ÇItemSize);

1001 
	`mem˝y
(
aBuf„r
 + 
iIn£π
 * 
nIãmSize
, 
pIãm
,ÇItemSize);

1002 
	}
}

1004 
	$buf„rDñëe
(
u8
 *
aBuf„r
, 
nSize
, 
iDñëe
, 
nIãmSize
) {

1005 
ôemsToMove
;

1007 
	`as£π
–
nIãmSize
 > 0 );

1008 
	`as£π
–0 <
iDñëe
 && iDñëê< 
nSize
 );

1010 
ôemsToMove
 = 
nSize
 - 
iDñëe
 - 1;

1011 
	`memmove
(
aBuf„r
 + 
iDñëe
 * 
nIãmSize
,áBuf„∏+ (iDñëê+ 1Ë*ÇIãmSize, 
ôemsToMove
 *ÇItemSize);

1012 
	}
}

1018 
	$diskA¬Ve˘‹Di°™˚
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
Ve˘‹
 *
pVec1
, c⁄° Ve˘‹ *
pVec2
){

1019  
pIndex
->
nDi°™˚Func
 ){

1020 
VECTOR_METRIC_TYPE_COS
:

1021  
	`ve˘‹Di°™˚Cos
(
pVec1
, 
pVec2
);

1022 
VECTOR_METRIC_TYPE_L2
:

1023  
	`ve˘‹Di°™˚L2
(
pVec1
, 
pVec2
);

1025 
	`as£π
(0);

1029 
	}
}

1031 
DiskA¬Node
 *
	$diskA¬NodeAŒoc
(c⁄° 
DiskA¬Index
 *
pIndex
, 
u64
 
nRowid
){

1032 
DiskA¬Node
 *
pNode
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, (DiskAnnNode));

1033 if–
pNode
 =
NULL
 ){

1034  
NULL
;

1036 
pNode
->
nRowid
 =ÇRowid;

1037 
pNode
->
visôed
 = 0;

1038 
pNode
->
pNext
 = 
NULL
;

1039 
pNode
->
pBlobSpŸ
 = 
NULL
;

1040  
pNode
;

1041 
	}
}

1043 
	$diskA¬NodeFªe
(
DiskA¬Node
 *
pNode
){

1044 if–
pNode
->
pBlobSpŸ
 !
NULL
 ){

1045 
	`blobSpŸFªe
(
pNode
->
pBlobSpŸ
);

1047 
	`sqlôe4_‰ì
(0, 
pNode
);

1048 
	}
}

1050 
	$diskA¬SórchCtxInô
(c⁄° 
DiskA¬Index
 *
pIndex
, 
DiskA¬SórchCtx
 *
pCtx
, c⁄° 
Ve˘‹
* 
pQuîy
, 
maxC™did©es
, 
t›C™did©es
, 
blobMode
){

1051 if–
	`öôVe˘‹Paú
(
pIndex
->
nNodeVe˘‹Ty≥
,ÖIndex->
nEdgeVe˘‹Ty≥
,ÖIndex->
nVe˘‹Dims
, &
pCtx
->
quîy
) != 0 ){

1052  
SQLITE4_NOMEM
;

1054 
	`lﬂdVe˘‹Paú
(&
pCtx
->
quîy
, 
pQuîy
);

1056 
pCtx
->
aDi°™˚s
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, 
maxC™did©es
 * ());

1057 
pCtx
->
aC™did©es
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, 
maxC™did©es
 * (
DiskA¬Node
*));

1058 
pCtx
->
nC™did©es
 = 0;

1059 
pCtx
->
maxC™did©es
 = maxCandidates;

1060 
pCtx
->
aT›Di°™˚s
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, 
t›C™did©es
 * ());

1061 
pCtx
->
aT›C™did©es
 = 
	`sqlôe4_mÆloc
(
pIndex
->
db
->
pEnv
, 
t›C™did©es
 * (
DiskA¬Node
*));

1062 
pCtx
->
nT›C™did©es
 = 0;

1063 
pCtx
->
maxT›C™did©es
 = 
t›C™did©es
;

1064 
pCtx
->
visôedLi°
 = 
NULL
;

1065 
pCtx
->
nUnvisôed
 = 0;

1066 
pCtx
->
blobMode
 = blobMode;

1068 if–
pCtx
->
aDi°™˚s
 !
NULL
 &&ÖCtx->
aC™did©es
 !NULL &&ÖCtx->
aT›Di°™˚s
 !NULL &&ÖCtx->
aT›C™did©es
 != NULL ){

1069  
SQLITE4_OK
;

1071 if–
pCtx
->
aDi°™˚s
 !
NULL
 ){

1072 
	`sqlôe4_‰ì
(
pIndex
->
db
->
pEnv
, 
pCtx
->
aDi°™˚s
);

1074 if–
pCtx
->
aC™did©es
 !
NULL
 ){

1075 
	`sqlôe4_‰ì
(
pIndex
->
db
->
pEnv
, 
pCtx
->
aC™did©es
);

1077 if–
pCtx
->
aT›Di°™˚s
 !
NULL
 ){

1078 
	`sqlôe4_‰ì
(
pIndex
->
db
->
pEnv
, 
pCtx
->
aT›Di°™˚s
);

1080 if–
pCtx
->
aT›C™did©es
 !
NULL
 ){

1081 
	`sqlôe4_‰ì
(
pIndex
->
db
->
pEnv
, 
pCtx
->
aT›C™did©es
);

1083 
	`deöôVe˘‹Paú
(&
pCtx
->
quîy
);

1084  
SQLITE4_NOMEM
;

1085 
	}
}

1087 
	$diskA¬SórchCtxDeöô
(
DiskA¬SórchCtx
 *
pCtx
){

1088 
i
;

1089 
DiskA¬Node
 *
pNode
, *
pNext
;

1093 
i
 = 0; i < 
pCtx
->
nC™did©es
; i++){

1094 if–!
pCtx
->
aC™did©es
[
i
]->
visôed
 ){

1095 
	`diskA¬NodeFªe
(
pCtx
->
aC™did©es
[
i
]);

1099 
pNode
 = 
pCtx
->
visôedLi°
;

1100  
pNode
 !
NULL
 ){

1101 
pNext
 = 
pNode
->pNext;

1102 
	`diskA¬NodeFªe
(
pNode
);

1103 
pNode
 = 
pNext
;

1105 
	`sqlôe4_‰ì
(0, 
pCtx
->
aC™did©es
);

1106 
	`sqlôe4_‰ì
(0, 
pCtx
->
aDi°™˚s
);

1107 
	`sqlôe4_‰ì
(0, 
pCtx
->
aT›C™did©es
);

1108 
	`sqlôe4_‰ì
(0, 
pCtx
->
aT›Di°™˚s
);

1109 
	`deöôVe˘‹Paú
(&
pCtx
->
quîy
);

1110 
	}
}

1114 
	$diskA¬SórchCtxIsVisôed
(c⁄° 
DiskA¬SórchCtx
 *
pCtx
, 
u64
 
nRowid
){

1115 
DiskA¬Node
 *
pNode
;

1116 
pNode
 = 
pCtx
->
visôedLi°
;ÖNodê!
NULL
;ÖNodêpNode->
pNext
){

1117 if–
pNode
->
nRowid
 ==ÇRowid ){

1122 
	}
}

1126 
	$diskA¬SórchCtxHasC™did©e
(c⁄° 
DiskA¬SórchCtx
 *
pCtx
, 
u64
 
nRowid
){

1127 
i
;

1128 
i
 = 0; i < 
pCtx
->
nC™did©es
; i++){

1129 if–
pCtx
->
aC™did©es
[
i
]->
nRowid
 ==ÇRowid ){

1134 
	}
}

1137 
	$diskA¬SórchCtxShouldAddC™did©e
(c⁄° 
DiskA¬Index
 *
pIndex
, c⁄° 
DiskA¬SórchCtx
 *
pCtx
, 
ˇndid©eDi°
){

1138 
i
;

1141 
i
 = 0; i < 
pCtx
->
nC™did©es
; i++){

1142 
di°C™did©e
 = 
pCtx
->
aDi°™˚s
[
i
];

1143 if–
ˇndid©eDi°
 < 
di°C™did©e
 ){

1144  
i
;

1147  
pCtx
->
nC™did©es
 <ÖCtx->
maxC™did©es
 ?ÖCtx->nCandidates : -1;

1148 
	}
}

1151 
	$diskA¬SórchCtxM¨kVisôed
(
DiskA¬SórchCtx
 *
pCtx
, 
DiskA¬Node
 *
pNode
, 
di°™˚
){

1152 
iIn£π
;

1154 
	`as£π
–
pCtx
->
nUnvisôed
 > 0 );

1155 
	`as£π
–
pNode
->
visôed
 == 0 );

1157 
pNode
->
visôed
 = 1;

1158 
pCtx
->
nUnvisôed
--;

1160 
pNode
->
pNext
 = 
pCtx
->
visôedLi°
;

1161 
pCtx
->
visôedLi°
 = 
pNode
;

1163 
iIn£π
 = 
	`di°™˚Buf„rIn£πIdx
(
pCtx
->
aT›Di°™˚s
,ÖCtx->
nT›C™did©es
,ÖCtx->
maxT›C™did©es
, 
di°™˚
);

1164 if–
iIn£π
 < 0 ){

1167 
	`buf„rIn£π
((
u8
*)
pCtx
->
aT›C™did©es
,ÖCtx->
nT›C™did©es
,ÖCtx->
maxT›C™did©es
, 
iIn£π
, (
DiskA¬Node
*), (u8*)&
pNode
, 
NULL
);

1168 
	`buf„rIn£π
((
u8
*)
pCtx
->
aT›Di°™˚s
,ÖCtx->
nT›C™did©es
,ÖCtx->
maxT›C™did©es
, 
iIn£π
, (), (u8*)&
di°™˚
, 
NULL
);

1169 
pCtx
->
nT›C™did©es
 = 
	`MIN
’Ctx->nT›C™did©e†+ 1,ÖCtx->
maxT›C™did©es
);

1170 
	}
}

1172 
	$diskA¬SórchCtxHasUnvisôed
(c⁄° 
DiskA¬SórchCtx
 *
pCtx
){

1173  
pCtx
->
nUnvisôed
 > 0;

1174 
	}
}

1176 
	$diskA¬SórchCtxGëC™did©e
(
DiskA¬SórchCtx
 *
pCtx
, 
i
, 
DiskA¬Node
 **
µNode
, *
pDi°™˚
){

1177 
	`as£π
–0 <
i
 && i < 
pCtx
->
nC™did©es
 );

1178 *
µNode
 = 
pCtx
->
aC™did©es
[
i
];

1179 *
pDi°™˚
 = 
pCtx
->
aDi°™˚s
[
i
];

1180 
	}
}

1182 
	$diskA¬SórchCtxDñëeC™did©e
(
DiskA¬SórchCtx
 *
pCtx
, 
iDñëe
){

1183 
i
;

1184 
	`as£π
–
pCtx
->
nUnvisôed
 > 0 );

1185 
	`as£π
–!
pCtx
->
aC™did©es
[
iDñëe
]->
visôed
 );

1186 
	`as£π
–
pCtx
->
aC™did©es
[
iDñëe
]->
pBlobSpŸ
 =
NULL
 );

1188 
	`diskA¬NodeFªe
(
pCtx
->
aC™did©es
[
iDñëe
]);

1189 
	`buf„rDñëe
((
u8
*)
pCtx
->
aC™did©es
,ÖCtx->
nC™did©es
, 
iDñëe
, (
DiskA¬Node
*));

1190 
	`buf„rDñëe
((
u8
*)
pCtx
->
aDi°™˚s
,ÖCtx->
nC™did©es
, 
iDñëe
, ());

1192 
pCtx
->
nC™did©es
--;

1193 
pCtx
->
nUnvisôed
--;

1194 
	}
}

1196 
	$diskA¬SórchCtxIn£πC™did©e
(
DiskA¬SórchCtx
 *
pCtx
, 
iIn£π
, 
DiskA¬Node
* 
pC™did©e
, 
di°™˚
){

1197 
DiskA¬Node
 *
pLa°
 = 
NULL
;

1198 
	`buf„rIn£π
((
u8
*)
pCtx
->
aC™did©es
,ÖCtx->
nC™did©es
,ÖCtx->
maxC™did©es
, 
iIn£π
, (
DiskA¬Node
*), (u8*)&
pC™did©e
, (u8*)&
pLa°
);

1199 
	`buf„rIn£π
((
u8
*)
pCtx
->
aDi°™˚s
,ÖCtx->
nC™did©es
,ÖCtx->
maxC™did©es
, 
iIn£π
, (), (u8*)&
di°™˚
, 
NULL
);

1200 
pCtx
->
nC™did©es
 = 
	`MIN
’Ctx->nC™did©e†+ 1,ÖCtx->
maxC™did©es
);

1201 if–
pLa°
 !
NULL
 && !pLa°->
visôed
 ){

1203 
	`as£π
–
pLa°
->
pBlobSpŸ
 =
NULL
 );

1204 
pCtx
->
nUnvisôed
--;

1205 
	`diskA¬NodeFªe
(
pLa°
);

1207 
pCtx
->
nUnvisôed
++;

1208 
	}
}

1212 
	$diskA¬SórchCtxFödClo£°C™did©eIdx
(c⁄° 
DiskA¬SórchCtx
 *
pCtx
){

1213 
i
;

1214 #ifde‡
SQLITE4_DEBUG


1215 
i
 = 0; i < 
pCtx
->
nC™did©es
 - 1; i++){

1216 
	`as£π
(
pCtx
->
aDi°™˚s
[
i
] <=ÖCtx->aDistances[i + 1]);

1219 
i
 = 0; i < 
pCtx
->
nC™did©es
; i++){

1220 
DiskA¬Node
 *
pC™did©e
 = 
pCtx
->
aC™did©es
[
i
];

1221 if–
pC™did©e
->
visôed
 ){

1224  
i
;

1227 
	}
}

1241 
	$diskA¬Rïœ˚EdgeIdx
(

1242 c⁄° 
DiskA¬Index
 *
pIndex
,

1243 
BlobSpŸ
 *
pNodeBlob
,

1244 
u64
 
√wRowid
,

1246 
Ve˘‹Paú
 *
pNewVe˘‹
,

1248 
Ve˘‹Paú
 *
pPœ˚hﬁdî
,

1250 *
pNodeToNew


1252 
i
, 
nEdges
, 
nMaxEdges
, 
iRïœ˚
 = -1;

1253 
Ve˘‹
 
nodeVe˘‹
, 
edgeVe˘‹
;

1254 
nodeToNew
, 
nodeToRïœ˚
;

1257 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pNodeBlob
);

1260 
nMaxEdges
 = 
	`nodeEdgesMaxCou¡
(
pIndex
);

1264 
	`nodeBöVe˘‹
(
pIndex
, 
pNodeBlob
, &
nodeVe˘‹
);

1265 
	`lﬂdVe˘‹Paú
(
pPœ˚hﬁdî
, &
nodeVe˘‹
);

1269 
nodeToNew
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, 
pPœ˚hﬁdî
->
pEdge
, 
pNewVe˘‹
->pEdge);

1271 *
pNodeToNew
 = 
nodeToNew
;

1275 
i
 = 
nEdges
 - 1; i >= 0; i--){

1276 
u64
 
edgeRowid
;

1277 
edgeToNew
, 
nodeToEdge
;

1280 
	`nodeBöEdge
(
pIndex
, 
pNodeBlob
, 
i
, &
edgeRowid
, &
nodeToEdge
, &
edgeVe˘‹
);

1281 if–
edgeRowid
 =
√wRowid
 ){

1285  
i
;

1288 if–
pIndex
->
nF‹m©Vîsi⁄
 =
VECTOR_FORMAT_V1
 ){

1289 
nodeToEdge
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, 
pPœ˚hﬁdî
->
pEdge
, &
edgeVe˘‹
);

1293 
edgeToNew
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, &
edgeVe˘‹
, 
pNewVe˘‹
->
pEdge
);

1296 if–
nodeToNew
 > 
pIndex
->
¥unögAÕha
 * 
edgeToNew
 ){

1301 if–
nodeToNew
 < 
nodeToEdge
 && (
iRïœ˚
 =-1 || 
nodeToRïœ˚
 <ÇodeToEdge) ){

1302 
nodeToRïœ˚
 = 
nodeToEdge
;

1303 
iRïœ˚
 = 
i
;

1308 if–
nEdges
 < 
nMaxEdges
 ){

1309  
nEdges
;

1312  
iRïœ˚
;

1313 
	}
}

1318 
	$diskA¬Pru√Edges
(c⁄° 
DiskA¬Index
 *
pIndex
, 
BlobSpŸ
 *
pNodeBlob
, 
iIn£πed
, 
Ve˘‹Paú
 *
pPœ˚hﬁdî
) {

1319 
i
, 
s
, 
nEdges
;

1320 
Ve˘‹
 
nodeVe˘‹
, 
hötEdgeVe˘‹
;

1321 
u64
 
hötRowid
;

1324 
	`nodeBöVe˘‹
(
pIndex
, 
pNodeBlob
, &
nodeVe˘‹
);

1325 
	`lﬂdVe˘‹Paú
(
pPœ˚hﬁdî
, &
nodeVe˘‹
);

1328 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pNodeBlob
);

1330 
	`as£π
–0 <
iIn£πed
 && iIn£πed < 
nEdges
 );

1332 #i‡
	`deföed
(
SQLITE4_DEBUG
Ë&& deföed(
SQLITE4_VECTOR_TRACE
)

1333 
	`DiskA¬Tø˚
(("beforeÖruning:\n"));

1334 
	`nodeBöDebug
(
pIndex
, 
pNodeBlob
);

1338 
	`nodeBöEdge
(
pIndex
, 
pNodeBlob
, 
iIn£πed
, &
hötRowid
, 
NULL
, &
hötEdgeVe˘‹
);

1341 
i
 = 0;

1343  
i
 < 
nEdges
 ){

1345 
Ve˘‹
 
edgeVe˘‹
;

1346 
nodeToEdge
, 
hötToEdge
;

1347 
u64
 
edgeRowid
;

1349 
	`nodeBöEdge
(
pIndex
, 
pNodeBlob
, 
i
, &
edgeRowid
, &
nodeToEdge
, &
edgeVe˘‹
);

1352 if–
hötRowid
 =
edgeRowid
 ){

1353 
i
++;

1356 if–
pIndex
->
nF‹m©Vîsi⁄
 =
VECTOR_FORMAT_V1
 ){

1358 
nodeToEdge
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, 
pPœ˚hﬁdî
->
pEdge
, &
edgeVe˘‹
);

1362 
hötToEdge
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, &
hötEdgeVe˘‹
, &
edgeVe˘‹
);

1365 if–
nodeToEdge
 > 
pIndex
->
¥unögAÕha
 * 
hötToEdge
 ){

1366 
	`nodeBöDñëeEdge
(
pIndex
, 
pNodeBlob
, 
i
);

1367 
nEdges
--;

1369 
i
++;

1373 #i‡
	`deföed
(
SQLITE4_DEBUG
Ë&& deföed(
SQLITE4_VECTOR_TRACE
)

1374 
	`DiskA¬Tø˚
(("afterÖruning:\n"));

1375 
	`nodeBöDebug
(
pIndex
, 
pNodeBlob
);

1379 
	`as£π
–
nEdges
 > 0 );

1380 
	}
}

1383 
	$diskA¬SórchI¡î«l
(
DiskA¬Index
 *
pIndex
, 
DiskA¬SórchCtx
 *
pCtx
, 
u64
 
nSèπRowid
, **
pzEºMsg
){

1384 
	`DiskA¬Tø˚
(("diskA¬SórchI¡î«l:ÑódyÅÿ£¨ch:ÑoŸId=%Œd\n", 
nSèπRowid
));

1385 
DiskA¬Node
 *
°¨t
 = 
NULL
;

1388 
BlobSpŸ
 *
pReußbÀBlobSpŸ
 = 
NULL
;

1389 
Ve˘‹
 
°¨tVe˘‹
;

1390 
°¨tDi°™˚
;

1391 
rc
, 
i
, 
nVisôed
 = 0;

1393 
°¨t
 = 
	`diskA¬NodeAŒoc
(
pIndex
, 
nSèπRowid
);

1394 if–
°¨t
 =
NULL
 ){

1395 
	`¥ötf
("vector index(search): failedÅoállocateÇewÇode");

1396 
rc
 = 
SQLITE4_NOMEM
;

1397 
out
;

1400 
rc
 = 
	`blobSpŸCª©e
(
pIndex
, &
°¨t
->
pBlobSpŸ
, 
nSèπRowid
,ÖIndex->
nBlockSize
, 
pCtx
->
blobMode
);

1401 if–
rc
 !
SQLITE4_OK
 ){

1402 
	`¥ötf
("vector index(search): failedÅo createÇew blob");

1403 
out
;

1406 
rc
 = 
	`blobSpŸRñﬂd
(
pIndex
, 
°¨t
->
pBlobSpŸ
, 
nSèπRowid
,ÖIndex->
nBlockSize
);

1407 if–
rc
 !
SQLITE4_OK
 ){

1408 
	`¥ötf
("vector index(search): failedÅoÜoadÇew blob");

1409 
out
;

1412 
	`nodeBöVe˘‹
(
pIndex
, 
°¨t
->
pBlobSpŸ
, &
°¨tVe˘‹
);

1413 
°¨tDi°™˚
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, 
pCtx
->
quîy
.
pNode
, &
°¨tVe˘‹
);

1415 if–
pCtx
->
blobMode
 =
DISKANN_BLOB_READONLY
 ){

1416 
	`as£π
–
°¨t
->
pBlobSpŸ
 !
NULL
 );

1417 
pReußbÀBlobSpŸ
 = 
°¨t
->
pBlobSpŸ
;

1418 
°¨t
->
pBlobSpŸ
 = 
NULL
;

1422 
	`diskA¬SórchCtxIn£πC™did©e
(
pCtx
, 0, 
°¨t
, 
°¨tDi°™˚
);

1423 
°¨t
 = 
NULL
;

1425  
	`diskA¬SórchCtxHasUnvisôed
(
pCtx
) ){

1426 
nEdges
;

1427 
Ve˘‹
 
vC™did©e
;

1428 
DiskA¬Node
 *
pC™did©e
;

1429 
BlobSpŸ
 *
pC™did©eBlob
;

1430 
di°™˚
;

1431 
iC™did©e
 = 
	`diskA¬SórchCtxFödClo£°C™did©eIdx
(
pCtx
);

1432 
	`diskA¬SórchCtxGëC™did©e
(
pCtx
, 
iC™did©e
, &
pC™did©e
, &
di°™˚
);

1434 
rc
 = 
SQLITE4_OK
;

1435 if–
pReußbÀBlobSpŸ
 !
NULL
 ){

1436 
rc
 = 
	`blobSpŸRñﬂd
(
pIndex
, 
pReußbÀBlobSpŸ
, 
pC™did©e
->
nRowid
,ÖIndex->
nBlockSize
);

1437 
pC™did©eBlob
 = 
pReußbÀBlobSpŸ
;

1440 if–
pC™did©e
->
pBlobSpŸ
 =
NULL
 ){

1441 
rc
 = 
	`blobSpŸCª©e
(
pIndex
, &
pC™did©e
->
pBlobSpŸ
,ÖC™did©e->
nRowid
,ÖIndex->
nBlockSize
, 
pCtx
->
blobMode
);

1443 if–
rc
 =
SQLITE4_OK
 ){

1444 
rc
 = 
	`blobSpŸRñﬂd
(
pIndex
, 
pC™did©e
->
pBlobSpŸ
,ÖC™did©e->
nRowid
,ÖIndex->
nBlockSize
);

1446 
pC™did©eBlob
 = 
pC™did©e
->
pBlobSpŸ
;

1449 if–
rc
 =
DISKANN_ROW_NOT_FOUND
 ){

1453 
	`diskA¬SórchCtxDñëeC™did©e
(
pCtx
, 
iC™did©e
);

1455 }if–
rc
 !
SQLITE4_OK
 ){

1456 
	`¥ötf
("vector index(search): failedÅo createÇew blob for candidate");

1457 
out
;

1460 
nVisôed
 += 1;

1461 
	`DiskA¬Tø˚
(("visôög c™did©e(%d): id=%Œd\n", 
nVisôed
, 
pC™did©e
->
nRowid
));

1462 
	`nodeBöVe˘‹
(
pIndex
, 
pC™did©eBlob
, &
vC™did©e
);

1463 
nEdges
 = 
	`nodeBöEdges
(
pIndex
, 
pC™did©eBlob
);

1466 if–
pCtx
->
quîy
.
pNode
 !pCtx->quîy.
pEdge
 ){

1467 
di°™˚
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, &
vC™did©e
, 
pCtx
->
quîy
.
pNode
);

1470 
	`diskA¬SórchCtxM¨kVisôed
(
pCtx
, 
pC™did©e
, 
di°™˚
);

1472 
i
 = 0; i < 
nEdges
; i++){

1473 
u64
 
edgeRowid
;

1474 
Ve˘‹
 
edgeVe˘‹
;

1475 
edgeDi°™˚
;

1476 
iIn£π
;

1477 
DiskA¬Node
 *
pNewC™did©e
;

1478 
	`nodeBöEdge
(
pIndex
, 
pC™did©eBlob
, 
i
, &
edgeRowid
, 
NULL
, &
edgeVe˘‹
);

1479 if–
	`diskA¬SórchCtxIsVisôed
(
pCtx
, 
edgeRowid
Ë|| 
	`diskA¬SórchCtxHasC™did©e
(pCtx,ÉdgeRowid) ){

1483 
edgeDi°™˚
 = 
	`diskA¬Ve˘‹Di°™˚
(
pIndex
, 
pCtx
->
quîy
.
pEdge
, &
edgeVe˘‹
);

1484 
iIn£π
 = 
	`diskA¬SórchCtxShouldAddC™did©e
(
pIndex
, 
pCtx
, 
edgeDi°™˚
);

1485 if–
iIn£π
 < 0 ){

1488 
pNewC™did©e
 = 
	`diskA¬NodeAŒoc
(
pIndex
, 
edgeRowid
);

1489 if–
pNewC™did©e
 =
NULL
 ){

1492 
	`DiskA¬Tø˚
(("w™àtÿö£πÇew c™did©ê%Œdáàposôi⁄ %d wôh di°™˚ %f\n", 
edgeRowid
, 
iIn£π
, 
edgeDi°™˚
));

1496 
	`diskA¬SórchCtxIn£πC™did©e
(
pCtx
, 
iIn£π
, 
pNewC™did©e
, 
edgeDi°™˚
);

1499 
	`DiskA¬Tø˚
(("diskA¬SórchI¡î«l: sórch c⁄ãxàöÅhêíd\n", 
nSèπRowid
));

1500 #i‡
	`deföed
(
SQLITE4_DEBUG
Ë&& deföed(
SQLITE4_VECTOR_TRACE
)

1501 
i
 = 0; i < 
pCtx
->
nC™did©es
; i++){

1502 
	`DiskA¬Tø˚
(("%Œd(%fË", 
pCtx
->
aC™did©es
[
i
]->
nRowid
,ÖCtx->
aDi°™˚s
[i]));

1504 
	`DiskA¬Tø˚
(("\n"));

1506 
out
:

1507 if–
°¨t
 !
NULL
 ){

1508 
	`diskA¬NodeFªe
(
°¨t
);

1510 if–
pReußbÀBlobSpŸ
 !
NULL
 ){

1511 
	`blobSpŸFªe
(
pReußbÀBlobSpŸ
);

1513  
SQLITE4_OK
;

1514 
	}
}

1521 
	$diskA¬Sórch
(

1522 
DiskA¬Index
 *
pIndex
,

1523 c⁄° 
Ve˘‹
 *
pVe˘‹
,

1524 
k
,

1525 c⁄° 
Ve˘‹IdxKey
 *
pKey
,

1526 
Ve˘‹OutRows
 *
pRows
,

1527 **
pzEºMsg


1529 
rc
 = 
SQLITE4_OK
;

1530 
DiskA¬SórchCtx
 
˘x
;

1531 
u64
 
nSèπRowid
;

1532 
nOutRows
;

1533 
i
;

1535 
	`DiskA¬Tø˚
(("diskAnnSearch started\n"));

1537 if–
k
 < 0 ){

1538 
	`¥ötf
("vector index(search): k must beáÇon-negative integer");

1539  
SQLITE4_ERROR
;

1541 if–
pVe˘‹
->
dims
 !
pIndex
->
nVe˘‹Dims
 ){

1542 
	`¥ötf
("ve˘‹ index(£¨ch): dimísi⁄†¨êdif„ª¡: %d !%d", 
pVe˘‹
->
dims
, 
pIndex
->
nVe˘‹Dims
);

1543  
SQLITE4_ERROR
;

1545 if–
pVe˘‹
->
ty≥
 !
pIndex
->
nNodeVe˘‹Ty≥
 ){

1546 
	`¥ötf
("ve˘‹ index(£¨ch): ve˘‹Åy≥ dif„r†‰om cﬁum¿ty≥: %d !%d", 
pVe˘‹
->
ty≥
, 
pIndex
->
nNodeVe˘‹Ty≥
);

1547  
SQLITE4_ERROR
;

1550 
rc
 = 
	`diskA¬Sñe˘R™domShadowRow
(
pIndex
, &
nSèπRowid
);

1551 if–
rc
 =
SQLITE4_DONE
 ){

1553 
pRows
->
nRows
 = 0;

1554 
pRows
->
nCﬁs
 = 
pKey
->
nKeyCﬁumns
;

1555  
SQLITE4_OK
;

1556 }if–
rc
 !
SQLITE4_OK
 ){

1557 
	`¥ötf
("vector index(search): failedÅo select startÇode for search");

1558  
rc
;

1560 
rc
 = 
	`diskA¬SórchCtxInô
(
pIndex
, &
˘x
, 
pVe˘‹
,ÖIndex->
£¨chL
, 
k
, 
DISKANN_BLOB_READONLY
);

1561 if–
rc
 !
SQLITE4_OK
 ){

1562 
	`¥ötf
("vector index(search): failedÅo initialize search context");

1563 
out
;

1565 
rc
 = 
	`diskA¬SórchI¡î«l
(
pIndex
, &
˘x
, 
nSèπRowid
, 
pzEºMsg
);

1566 if–
rc
 !
SQLITE4_OK
 ){

1567 
out
;

1569 
nOutRows
 = 
	`MIN
(
k
, 
˘x
.
nT›C™did©es
);

1570 
rc
 = 
	`ve˘‹OutRowsAŒoc
(
pIndex
->
db
, 
pRows
, 
nOutRows
, 
pKey
->
nKeyCﬁumns
, 
	`ve˘‹IdxKeyRowidLike
(pKey));

1571 if–
rc
 !
SQLITE4_OK
 ){

1572 
	`¥ötf
("vector index(search): failedÅoállocate outputÑows");

1573 
out
;

1575 
i
 = 0; i < 
nOutRows
; i++){

1576 if–
pRows
->
aI¡VÆues
 !
NULL
 ){

1577 
rc
 = 
	`ve˘‹OutRowsPut
(
pRows
, 
i
, 0, &
˘x
.
aT›C™did©es
[i]->
nRowid
, 
NULL
, 
pIndex
->
db
);

1579 
rc
 = 
	`diskA¬GëShadowRowKeys
(
pIndex
, 
˘x
.
aT›C™did©es
[
i
]->
nRowid
, 
pKey
, 
pRows
, i);

1581 if–
rc
 !
SQLITE4_OK
 ){

1582 
	`¥ötf
("vector index(search): failedÅoÖutÑesult inÅhe outputÑow");

1583 
out
;

1586 
rc
 = 
SQLITE4_OK
;

1587 
out
:

1588 
	`diskA¬SórchCtxDeöô
(&
˘x
);

1589  
rc
;

1590 
	}
}

1595 
	$diskA¬In£π
(

1596 
DiskA¬Index
 *
pIndex
,

1597 c⁄° 
Ve˘‹InRow
 *
pVe˘‹InRow
,

1598 **
pzEºMsg


1600 
rc
, 
fú°
 = 0;

1601 
u64
 
nSèπRowid
, 
nNewRowid
;

1602 
BlobSpŸ
 *
pBlobSpŸ
 = 
NULL
;

1603 
DiskA¬Node
 *
pVisôed
;

1604 
DiskA¬SórchCtx
 
˘x
;

1605 
Ve˘‹Paú
 
vIn£π
, 
vC™did©e
;

1606 
vIn£π
.
pNode
 = 
NULL
; vIn£π.
pEdge
 = NULL;

1607 
vC™did©e
.
pNode
 = 
NULL
; vC™did©e.
pEdge
 = NULL;

1609 if–
pVe˘‹InRow
->
pVe˘‹
->
dims
 !
pIndex
->
nVe˘‹Dims
 ){

1610 
	`¥ötf
("ve˘‹ index(ö£π): dimísi⁄†¨êdif„ª¡: %d !%d", 
pVe˘‹InRow
->
pVe˘‹
->
dims
, 
pIndex
->
nVe˘‹Dims
);

1611  
SQLITE4_ERROR
;

1613 if–
pVe˘‹InRow
->
pVe˘‹
->
ty≥
 !
pIndex
->
nNodeVe˘‹Ty≥
 ){

1614 
	`¥ötf
("ve˘‹ index(ö£π): ve˘‹Åy≥ dif„r†‰om cﬁum¿ty≥: %d !%d", 
pVe˘‹InRow
->
pVe˘‹
->
ty≥
, 
pIndex
->
nNodeVe˘‹Ty≥
);

1615  
SQLITE4_ERROR
;

1618 
	`DiskA¬Tø˚
(("diskAnnInset started\n"));

1623 
rc
 = 
	`diskA¬SórchCtxInô
(
pIndex
, &
˘x
, 
pVe˘‹InRow
->
pVe˘‹
,ÖIndex->
ö£πL
, 1, 
DISKANN_BLOB_WRITABLE
);

1624 if–
rc
 !
SQLITE4_OK
 ){

1625 
	`¥ötf
("vector index(insert): failedÅo initialize search context");

1626  
rc
;

1630 if–
	`öôVe˘‹Paú
(
pIndex
->
nNodeVe˘‹Ty≥
,ÖIndex->
nEdgeVe˘‹Ty≥
,ÖIndex->
nVe˘‹Dims
, &
vIn£π
) != 0 ){

1631 
	`¥ötf
("vector index(insert): unableÅoállocate mem forÇode VectorPair");

1632 
rc
 = 
SQLITE4_NOMEM
;

1633 
out
;

1636 if–
	`öôVe˘‹Paú
(
pIndex
->
nNodeVe˘‹Ty≥
,ÖIndex->
nEdgeVe˘‹Ty≥
,ÖIndex->
nVe˘‹Dims
, &
vC™did©e
) != 0 ){

1637 
	`¥ötf
("vector index(insert): unableÅoállocate mem for candidate VectorPair");

1638 
rc
 = 
SQLITE4_NOMEM
;

1639 
out
;

1644 
rc
 = 
	`diskA¬Sñe˘R™domShadowRow
(
pIndex
, &
nSèπRowid
);

1647 if–
rc
 =
SQLITE4_DONE
 ){

1648 
fú°
 = 1;

1649 }if–
rc
 !
SQLITE4_OK
 ){

1650 
	`¥ötf
("vector index(insert): failedÅo select startÇode for search");

1651 
rc
 = 
SQLITE4_ERROR
;

1652 
out
;

1656 if–!
fú°
 ){

1660 
rc
 = 
	`diskA¬SórchI¡î«l
(
pIndex
, &
˘x
, 
nSèπRowid
, 
pzEºMsg
);

1661 if–
rc
 !
SQLITE4_OK
 ){

1662 
out
;

1668 
rc
 = 
	`diskA¬In£πShadowRow
(
pIndex
, 
pVe˘‹InRow
, &
nNewRowid
);

1669 if–
rc
 !
SQLITE4_OK
 ){

1670 
	`¥ötf
("vector index(insert): failedÅo insert shadowÑow");

1671 
out
;

1675 
rc
 = 
	`blobSpŸCª©e
(
pIndex
, &
pBlobSpŸ
, 
nNewRowid
,ÖIndex->
nBlockSize
, 1);

1676 if–
rc
 !
SQLITE4_OK
 ){

1677 
	`¥ötf
("vector index(insert): failedÅoÑead blob for shadowÑow");

1678 
out
;

1681 
	`nodeBöInô
(
pIndex
, 
pBlobSpŸ
, 
nNewRowid
, 
pVe˘‹InRow
->
pVe˘‹
);

1684 if–
fú°
 ){

1685 
	`DiskA¬Tø˚
(("inserted firstÑow\n"));

1686 
rc
 = 
SQLITE4_OK
;

1687 
out
;

1693 
pVisôed
 = 
˘x
.
visôedLi°
;ÖVisôed !
NULL
;ÖVisôed =ÖVisôed->
pNext
){

1694 
Ve˘‹
 
nodeVe˘‹
;

1695 
iRïœ˚
;

1696 
nodeToNew
;

1699 
	`nodeBöVe˘‹
(
pIndex
, 
pVisôed
->
pBlobSpŸ
, &
nodeVe˘‹
);

1700 
	`lﬂdVe˘‹Paú
(&
vC™did©e
, &
nodeVe˘‹
);

1707 
iRïœ˚
 = 
	`diskA¬Rïœ˚EdgeIdx
(
pIndex
, 
pBlobSpŸ
, 
pVisôed
->
nRowid
, &
vC™did©e
, &
vIn£π
, &
nodeToNew
);

1708 if–
iRïœ˚
 == -1 ){

1712 
	`nodeBöRïœ˚Edge
(
pIndex
, 
pBlobSpŸ
, 
iRïœ˚
, 
pVisôed
->
nRowid
, 
nodeToNew
, 
vC™did©e
.
pEdge
);

1716 
	`diskA¬Pru√Edges
(
pIndex
, 
pBlobSpŸ
, 
iRïœ˚
, &
vIn£π
);

1721 
	`lﬂdVe˘‹Paú
(&
vIn£π
, 
pVe˘‹InRow
->
pVe˘‹
);

1724 
pVisôed
 = 
˘x
.
visôedLi°
;ÖVisôed !
NULL
;ÖVisôed =ÖVisôed->
pNext
){

1725 
iRïœ˚
;

1726 
nodeToNew
;

1729 
iRïœ˚
 = 
	`diskA¬Rïœ˚EdgeIdx
(
pIndex
, 
pVisôed
->
pBlobSpŸ
, 
nNewRowid
, &
vIn£π
, &
vC™did©e
, &
nodeToNew
);

1730 if–
iRïœ˚
 == -1 ){

1734 
	`nodeBöRïœ˚Edge
(
pIndex
, 
pVisôed
->
pBlobSpŸ
, 
iRïœ˚
, 
nNewRowid
, 
nodeToNew
, 
vIn£π
.
pEdge
);

1736 
	`diskA¬Pru√Edges
(
pIndex
, 
pVisôed
->
pBlobSpŸ
, 
iRïœ˚
, &
vC™did©e
);

1739 
rc
 = 
	`blobSpŸFlush
(
pIndex
, 
pVisôed
->
pBlobSpŸ
);

1740 if–
rc
 !
SQLITE4_OK
 ){

1741 
	`¥ötf
("vector index(insert): failedÅo flush blob");

1742 
out
;

1746 
rc
 = 
SQLITE4_OK
;

1747 
out
:

1748 
	`deöôVe˘‹Paú
(&
vIn£π
);

1749 
	`deöôVe˘‹Paú
(&
vC™did©e
);

1750 if–
rc
 =
SQLITE4_OK
 ){

1751 
rc
 = 
	`blobSpŸFlush
(
pIndex
, 
pBlobSpŸ
);

1752 if–
rc
 !
SQLITE4_OK
 ){

1753 
	`¥ötf
("vector index(insert): failedÅo flush blob");

1756 if–
pBlobSpŸ
 !
NULL
 ){

1757 
	`blobSpŸFªe
(
pBlobSpŸ
);

1759 
	`diskA¬SórchCtxDeöô
(&
˘x
);

1760  
rc
;

1761 
	}
}

1844 
	$diskA¬O≥nIndex
(

1845 
sqlôe4
 *
db
,

1846 c⁄° *
zDbSName
,

1847 c⁄° *
zIdxName
,

1848 c⁄° 
Ve˘‹IdxP¨ams
 *
pP¨ams
,

1849 
DiskA¬Index
 **
µIndex


1851 
DiskA¬Index
 *
pIndex
;

1852 
u64
 
nBlockSize
;

1853 
com¥essNeighbours
;

1854 
pIndex
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (
DiskA¬Index
));

1855 if–
pIndex
 =
NULL
 ){

1856  
SQLITE4_NOMEM
;

1858 
pIndex
->
db
 = db;

1859 
pIndex
->
zDbSName
 = 
	`sqlôe4DbSåDup
(
db
, zDbSName);

1860 
pIndex
->
zName
 = 
	`sqlôe4DbSåDup
(
db
, 
zIdxName
);

1861 
pIndex
->
zShadow
 = 
	`sqlôe4MPrötf
(
db
, "%s_shadow", 
zIdxName
);

1862 if–
pIndex
->
zShadow
 =
NULL
 ){

1863 
	`diskA¬Clo£Index
(
pIndex
);

1864  
SQLITE4_NOMEM
;

1866 
nBlockSize
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_BLOCK_SIZE_PARAM_ID
);

1868 if–
nBlockSize
 <= 128 ){

1869 
nBlockSize
 <<
DISKANN_BLOCK_SIZE_SHIFT
;

1872 
pIndex
->
nF‹m©Vîsi⁄
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_FORMAT_PARAM_ID
);

1873 
pIndex
->
nDi°™˚Func
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_METRIC_TYPE_PARAM_ID
);

1874 
pIndex
->
nBlockSize
 =ÇBlockSize;

1875 
pIndex
->
nNodeVe˘‹Ty≥
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_TYPE_PARAM_ID
);

1876 
pIndex
->
nVe˘‹Dims
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_DIM_PARAM_ID
);

1877 
pIndex
->
¥unögAÕha
 = 
	`ve˘‹IdxP¨amsGëF64
(
pP¨ams
, 
VECTOR_PRUNING_ALPHA_PARAM_ID
);

1878 
pIndex
->
ö£πL
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_INSERT_L_PARAM_ID
);

1879 
pIndex
->
£¨chL
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_SEARCH_L_PARAM_ID
);

1880 
pIndex
->
nRóds
 = 0;

1881 
pIndex
->
nWrôes
 = 0;

1882 if–
pIndex
->
nDi°™˚Func
 == 0 ||

1883 
pIndex
->
nBlockSize
 == 0 ||

1884 
pIndex
->
nNodeVe˘‹Ty≥
 == 0 ||

1885 
pIndex
->
nVe˘‹Dims
 == 0

1887 
	`diskA¬Clo£Index
(
pIndex
);

1888  
SQLITE4_ERROR
;

1890 if–
pIndex
->
¥unögAÕha
 == 0 ){

1891 
pIndex
->
¥unögAÕha
 = 
VECTOR_PRUNING_ALPHA_DEFAULT
;

1893 if–
pIndex
->
ö£πL
 == 0 ){

1894 
pIndex
->
ö£πL
 = 
VECTOR_INSERT_L_DEFAULT
;

1896 if–
pIndex
->
£¨chL
 == 0 ){

1897 
pIndex
->
£¨chL
 = 
VECTOR_SEARCH_L_DEFAULT
;

1899 
pIndex
->
nNodeVe˘‹Size
 = 
	`ve˘‹D©aSize
’Index->
nNodeVe˘‹Ty≥
,ÖIndex->
nVe˘‹Dims
);

1901 
com¥essNeighbours
 = 
	`ve˘‹IdxP¨amsGëU64
(
pP¨ams
, 
VECTOR_COMPRESS_NEIGHBORS_PARAM_ID
);

1902 if–
com¥essNeighbours
 == 0 ){

1903 
pIndex
->
nEdgeVe˘‹Ty≥
 =ÖIndex->
nNodeVe˘‹Ty≥
;

1904 
pIndex
->
nEdgeVe˘‹Size
 =ÖIndex->
nNodeVe˘‹Size
;

1906 
pIndex
->
nEdgeVe˘‹Ty≥
 = 
com¥essNeighbours
;

1907 
pIndex
->
nEdgeVe˘‹Size
 = 
	`ve˘‹D©aSize
(
com¥essNeighbours
,ÖIndex->
nVe˘‹Dims
);

1910 *
µIndex
 = 
pIndex
;

1911 
	`DiskA¬Tø˚
(("›íed index %s: maxÉdge†%d\n", 
zIdxName
, 
	`nodeEdgesMaxCou¡
(
pIndex
)));

1912  
SQLITE4_OK
;

1913 
	}
}

1915 
	$diskA¬Clo£Index
(
DiskA¬Index
 *
pIndex
){

1916 if–
pIndex
->
zDbSName
 ){

1917 
	`sqlôe4DbFªe
(
pIndex
->
db
,ÖIndex->
zDbSName
);

1919 if–
pIndex
->
zName
 ){

1920 
	`sqlôe4DbFªe
(
pIndex
->
db
,ÖIndex->
zName
);

1922 if–
pIndex
->
zShadow
 ){

1923 
	`sqlôe4DbFªe
(
pIndex
->
db
,ÖIndex->
zShadow
);

1925 
	`sqlôe4DbFªe
(
pIndex
->
db
,ÖIndex);

1926 
	}
}

	@src/vectorfloat16.c

29 #i‚de‡
SQLITE4_OMIT_VECTOR


30 
	~"sqlôeI¡.h
"

32 
	~"ve˘‹I¡.h
"

34 
	~<m©h.h
>

45 
	$ve˘‹F16ToFlﬂt
(
u16
 
f16
){

46 
u32
 
f32
;

48 
u32
 
sgn
 = ((u32)
f16
 & 0x8000) << 16;

50 
expBôs
 = (
f16
 >> 10) & 0x1f;

51 
exp
 = 
expBôs
 - 15;

53 
u32
 
m¡
 = ((u32)
f16
 & 0x3ff);

54 
u32
 
m¡N⁄Zîo
 = !!
m¡
;

56 if–
exp
 == 16 ){

57 
exp
 = 128, 
m¡
 = 
m¡N⁄Zîo
 << 22;

58 }if–
exp
 =-15 && 
m¡
 == 0 ){

59 
exp
 = -127, 
m¡
 = 0;

60 }if–
exp
 == -15 ){

62 
exp
++;

63  (
m¡
 & 0x400) == 0 ){

64 
m¡
 <<= 1;

65 
exp
--;

68 
m¡
 &= 0x3ff;

69 
m¡
 <<= 13;

71 
m¡
 <<= 13;

73 
f32
 = 
sgn
 | ((
u32
)(
exp
 + 127Ë<< 23Ë| 
m¡
;

74  *((*)&
f32
);

75 
	}
}

77 
u16
 
	$ve˘‹F16FromFlﬂt
(
f
){

78 
u32
 
i
 = *((u32*)&
f
);

81 
u32
 
sgn
 = (
i
 >> 16) & (0x8000);

84 
expBôs
 = (
i
 >> 23) & (0xff);

85 
exp
 = 
expBôs
 - 127;

88 
u32
 
m¡Bôs
 = (
i
 & 0x7fffff);

89 
u32
 
m¡N⁄Zîo
 = !!
m¡Bôs
;

90 
u32
 
m¡
;

92 if–
exp
 == 128 ){

93 
exp
 = 16, 
m¡Bôs
 = 
m¡N⁄Zîo
 << 22;

94 }if–
exp
 > 15 ){

95 
exp
 = 16, 
m¡Bôs
 = 0;

96 }if–
exp
 < -14 &&Éxp >= -25 ){

98 
m¡Bôs
 = (m¡Bô†| 0x800000Ë>> (-
exp
 - 14);

99 
exp
 = -15;

100 }if–
exp
 < -24 ){

101 
exp
 = -15, 
m¡Bôs
 = 0;

104 if–(
m¡Bôs
 & 0x1fff) > (0x1000 - ((mntBits >> 13) & 1)) ){

105 
m¡Bôs
 += 0x2000;

107 
m¡
 = 
m¡Bôs
 >> 13;

110  
sgn
 | ((
u32
)(
exp
 + 15 + (
m¡
 >> 10)) << 10) | (mnt & 0x3ff);

111 
	}
}

113 
	$ve˘‹F16Dump
(c⁄° 
Ve˘‹
 *
pVec
){

114 
u16
 *
ñems
 = 
pVec
->
d©a
;

115 
i
;

117 
	`as£π
–
pVec
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

119 
	`¥ötf
("f16: [");

120 
i
 = 0; i < 
pVec
->
dims
; i++){

121 
	`¥ötf
("%s%f", 
i
 =0 ? "" : ", ", 
	`ve˘‹F16ToFlﬂt
(
ñems
[i]));

123 
	`¥ötf
("]\n");

124 
	}
}

126 
	$ve˘‹F16SîülizeToBlob
(

127 c⁄° 
Ve˘‹
 *
pVe˘‹
,

128 *
pBlob
,

129 
size_t
 
nBlobSize


131 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

132 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

133 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

135 
	`mem˝y
(
pBlob
, 
pVe˘‹
->
d©a
,ÖVe˘‹->
dims
 * (
u16
));

136 
	}
}

138 
	$ve˘‹F16Di°™˚Cos
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

139 
i
;

140 
dŸ
 = 0, 
n‹m1
 = 0, 
n‹m2
 = 0;

141 
vÆue1
, 
vÆue2
;

142 
u16
 *
d©a1
 = 
v1
->
d©a
, *
d©a2
 = 
v2
->data;

144 
	`as£π
–
v1
->
dims
 =
v2
->dims );

145 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

146 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

148 
i
 = 0; i < 
v1
->
dims
; i++){

149 
vÆue1
 = 
	`ve˘‹F16ToFlﬂt
(
d©a1
[
i
]);

150 
vÆue2
 = 
	`ve˘‹F16ToFlﬂt
(
d©a2
[
i
]);

151 
dŸ
 +
vÆue1
*
vÆue2
;

152 
n‹m1
 +
vÆue1
*value1;

153 
n‹m2
 +
vÆue2
*value2;

156  1.0 - (
dŸ
 / 
	`sqπ
(
n‹m1
 * 
n‹m2
));

157 
	}
}

159 
	$ve˘‹F16Di°™˚L2
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

160 
i
;

161 
sum
 = 0;

162 
vÆue1
, 
vÆue2
;

163 
u16
 *
d©a1
 = 
v1
->
d©a
, *
d©a2
 = 
v2
->data;

165 
	`as£π
–
v1
->
dims
 =
v2
->dims );

166 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

167 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

169 
i
 = 0; i < 
v1
->
dims
; i++){

170 
vÆue1
 = 
	`ve˘‹F16ToFlﬂt
(
d©a1
[
i
]);

171 
vÆue2
 = 
	`ve˘‹F16ToFlﬂt
(
d©a2
[
i
]);

172 
d
 = (
vÆue1
 - 
vÆue2
);

173 
sum
 +
d
*d;

175  
	`sqπ
(
sum
);

176 
	}
}

178 
	$ve˘‹F16De£rülizeFromBlob
(

179 
Ve˘‹
 *
pVe˘‹
,

180 c⁄° *
pBlob
,

181 
size_t
 
nBlobSize


183 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT16
 );

184 
	`as£π
–0 <
pVe˘‹
->
dims
 &&ÖVe˘‹->dim†<
MAX_VECTOR_SZ
 );

185 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

187 
	`mem˝y
((
u8
*)
pVe˘‹
->
d©a
, (u8*)
pBlob
,ÖVe˘‹->
dims
 * (
u16
));

188 
	}
}

	@src/vectorfloat1bit.c

27 #i‚de‡
SQLITE4_OMIT_VECTOR


28 
	~"sqlôeI¡.h
"

30 
	~"ve˘‹I¡.h
"

32 
	~<m©h.h
>

38 
	$ve˘‹1BôDump
(c⁄° 
Ve˘‹
 *
pVec
){

39 
u8
 *
ñems
 = 
pVec
->
d©a
;

40 
i
;

42 
	`as£π
–
pVec
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 );

44 
	`¥ötf
("f1bit: [");

45 
i
 = 0; i < 
pVec
->
dims
; i++){

46 
	`¥ötf
("%s%d", 
i
 =0 ? "" : ", ", ((
ñems
[i / 8] >> (i & 7)) & 1) ? +1 : -1);

48 
	`¥ötf
("]\n");

49 
	}
}

55 
	$ve˘‹1BôSîülizeToBlob
(

56 c⁄° 
Ve˘‹
 *
pVe˘‹
,

57 *
pBlob
,

58 
size_t
 
nBlobSize


60 
u8
 *
ñems
 = 
pVe˘‹
->
d©a
;

61 
u8
 *
pPå
 = 
pBlob
;

62 
i
;

64 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 );

65 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

66 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

68 
i
 = 0; i < (
pVe˘‹
->
dims
 + 7) / 8; i++){

69 
pPå
[
i
] = 
ñems
[i];

71 
	}
}

74 
	gBôsCou¡
[256] = {

93 
ölöe
 
	$sqlôe4P›Cou¡32
(
u32
 
a
){

94 #i‡
GCC_VERSION
>=5004000 && !
	`deföed
(
__INTEL_COMPILER
)

95  
	`__buûtö_p›cou¡
(
a
);

97  
BôsCou¡
[
a
 >> 24] + BitsCount[(a >> 16) & 0xff] + BitsCount[(a >> 8) & 0xff] + BitsCount[a & 0xff];

99 
	}
}

101 
	$ve˘‹1BôDi°™˚Hammög
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

102 
diff
 = 0;

103 
u8
 *
e1U8
 = 
v1
->
d©a
;

104 
u32
 *
e1U32
 = 
v1
->
d©a
;

105 
u8
 *
e2U8
 = 
v2
->
d©a
;

106 
u32
 *
e2U32
 = 
v2
->
d©a
;

107 
i
, 
Àn8
, 
Àn32
, 
off£t8
;

109 
	`as£π
–
v1
->
dims
 =
v2
->dims );

110 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 );

111 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 );

113 
Àn8
 = (
v1
->
dims
 + 7) / 8;

114 
Àn32
 = 
v1
->
dims
 / 32;

115 
off£t8
 = 
Àn32
 * 4;

117 
i
 = 0; i < 
Àn32
; i++){

118 
diff
 +
	`sqlôe4P›Cou¡32
(
e1U32
[
i
] ^ 
e2U32
[i]);

120 
i
 = 
off£t8
; i < 
Àn8
; i++){

121 
diff
 +
	`sqlôe4P›Cou¡32
(
e1U8
[
i
] ^ 
e2U8
[i]);

123  
diff
;

124 
	}
}

126 
	$ve˘‹1BôDe£rülizeFromBlob
(

127 
Ve˘‹
 *
pVe˘‹
,

128 c⁄° *
pBlob
,

129 
size_t
 
nBlobSize


131 
u8
 *
ñems
 = 
pVe˘‹
->
d©a
;

133 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT1BIT
 );

134 
	`as£π
–0 <
pVe˘‹
->
dims
 &&ÖVe˘‹->dim†<
MAX_VECTOR_SZ
 );

135 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

137 
	`mem˝y
(
ñems
, 
pBlob
, (
pVe˘‹
->
dims
 + 7) / 8);

138 
	}
}

	@src/vectorfloat32.c

27 #i‚de‡
SQLITE4_OMIT_VECTOR


28 
	~"sqlôeI¡.h
"

30 
	~"ve˘‹I¡.h
"

32 
	~<m©h.h
>

38 
	$ve˘‹F32Dump
(c⁄° 
Ve˘‹
 *
pVec
){

39 *
ñems
 = 
pVec
->
d©a
;

40 
i
;

42 
	`as£π
–
pVec
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

44 
	`¥ötf
("f32: [");

45 
i
 = 0; i < 
pVec
->
dims
; i++){

46 
	`¥ötf
("%s%f", 
i
 =0 ? "" : ", ", 
ñems
[i]);

48 
	`¥ötf
("]\n");

49 
	}
}

55 
ölöe
 
	$f‹m©F32
(
vÆue
, *
pBuf
, 
nBufSize
){

56 
	`sqlôe4_¢¥ötf
(
pBuf
, 
nBufSize
, "%g", ()
vÆue
);

57  
	`°æí
(
pBuf
);

58 
	}
}

60 
	$ve˘‹F32SîülizeToBlob
(

61 c⁄° 
Ve˘‹
 *
pVe˘‹
,

62 *
pBlob
,

63 
size_t
 
nBlobSize


65 *
ñems
 = 
pVe˘‹
->
d©a
;

66 *
pPå
 = 
pBlob
;

67 
size_t
 
Àn
 = 0;

68 
i
;

70 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

71 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

72 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

74 
i
 = 0; i < 
pVe˘‹
->
dims
; i++){

75 
pPå
 +
	`£rülizeF32
’På, 
ñems
[
i
]);

77 
	}
}

80 
	$ve˘‹BlobFªe
(*
p
, *
pArg
){

81 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív*)
pArg
;

82 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

83 
	}
}

86 
	#SINGLE_FLOAT_CHAR_LIMIT
 32

	)

87 
	$ve˘‹F32M¨shÆToText
(

88 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

89 c⁄° 
Ve˘‹
 *
pVe˘‹


91 *
ñems
 = 
pVe˘‹
->
d©a
;

92 
size_t
 
nBufSize
;

93 
size_t
 
iBuf
 = 0;

94 *
pText
;

95 
vÆueBuf
[
SINGLE_FLOAT_CHAR_LIMIT
];

97 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

98 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

101 
nBufSize
 = 2 + 
pVe˘‹
->
dims
 * (
SINGLE_FLOAT_CHAR_LIMIT
 + 1 );

102 
pText
 = 
	`sqlôe4_mÆloc
(0, 
nBufSize
);

103 if–
pText
 !
NULL
 ){

104 
i
;

106 
pText
[
iBuf
++]= '[';

107 
i
 = 0; i < 
pVe˘‹
->
dims
; i++){

108 
vÆueLígth
 = 
	`f‹m©F32
(
ñems
[
i
], 
vÆueBuf
, (valueBuf));

109 
	`mem˝y
(&
pText
[
iBuf
], 
vÆueBuf
, 
vÆueLígth
);

110 
iBuf
 +
vÆueLígth
;

111 
pText
[
iBuf
++] = ',';

113 if–
pVe˘‹
->
dims
 > 0 ){

114 
iBuf
--;

116 
pText
[
iBuf
++] = ']';

118 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
pText
, 
iBuf
, 
ve˘‹BlobFªe
, 0);

120 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

122 
	}
}

124 
	$ve˘‹F32Di°™˚Cos
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

125 
dŸ
 = 0, 
n‹m1
 = 0, 
n‹m2
 = 0;

126 *
e1
 = 
v1
->
d©a
;

127 *
e2
 = 
v2
->
d©a
;

128 
i
;

130 
	`as£π
–
v1
->
dims
 =
v2
->dims );

131 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

132 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

134 
i
 = 0; i < 
v1
->
dims
; i++){

135 
dŸ
 +
e1
[
i
]*
e2
[i];

136 
n‹m1
 +
e1
[
i
]*e1[i];

137 
n‹m2
 +
e2
[
i
]*e2[i];

139  1.0 - (
dŸ
 / 
	`sqπ
(
n‹m1
 * 
n‹m2
));

140 
	}
}

142 
	$ve˘‹F32Di°™˚L2
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

143 
sum
 = 0;

144 *
e1
 = 
v1
->
d©a
;

145 *
e2
 = 
v2
->
d©a
;

146 
i
;

148 
	`as£π
–
v1
->
dims
 =
v2
->dims );

149 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

150 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

152 
i
 = 0; i < 
v1
->
dims
; i++){

153 
d
 = 
e1
[
i
]-
e2
[i];

154 
sum
 +
d
*d;

156  
	`sqπ
(
sum
);

157 
	}
}

159 
	$ve˘‹F32De£rülizeFromBlob
(

160 
Ve˘‹
 *
pVe˘‹
,

161 c⁄° *
pBlob
,

162 
size_t
 
nBlobSize


164 *
ñems
 = 
pVe˘‹
->
d©a
;

165 
i
;

167 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT32
 );

168 
	`as£π
–0 <
pVe˘‹
->
dims
 &&ÖVe˘‹->dim†<
MAX_VECTOR_SZ
 );

169 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

171 
i
 = 0; i < 
pVe˘‹
->
dims
; i++){

172 
ñems
[
i
] = 
	`de£rülizeF32
(
pBlob
);

173 
pBlob
 += ();

175 
	}
}

	@src/vectorfloat64.c

27 #i‚de‡
SQLITE4_OMIT_VECTOR


28 
	~"sqlôeI¡.h
"

30 
	~"ve˘‹I¡.h
"

32 
	~<m©h.h
>

38 
	$ve˘‹F64Dump
(c⁄° 
Ve˘‹
 *
pVec
){

39 *
ñems
 = 
pVec
->
d©a
;

40 
i
;

42 
	`as£π
–
pVec
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

44 
	`¥ötf
("f64: [");

45 
i
 = 0; i < 
pVec
->
dims
; i++){

46 
	`¥ötf
("%s%lf", 
i
 =0 ? "" : ", ", 
ñems
[i]);

48 
	`¥ötf
("]\n");

49 
	}
}

55 
ölöe
 
	$f‹m©F64
(
vÆue
, *
pBuf
, 
nBufSize
){

56 
	`sqlôe4_¢¥ötf
(
pBuf
, 
nBufSize
, "%g", 
vÆue
);

57  
	`°æí
(
pBuf
);

58 
	}
}

60 
ölöe
 
	$£rülizeF64
(*
pBuf
, 
vÆue
){

61 
u64
 *
p
 = (u64 *)&
vÆue
;

62 
pBuf
[0] = *
p
 & 0xFF;

63 
pBuf
[1] = (*
p
 >> 8) & 0xFF;

64 
pBuf
[2] = (*
p
 >> 16) & 0xFF;

65 
pBuf
[3] = (*
p
 >> 24) & 0xFF;

66 
pBuf
[4] = (*
p
 >> 32) & 0xFF;

67 
pBuf
[5] = (*
p
 >> 40) & 0xFF;

68 
pBuf
[6] = (*
p
 >> 48) & 0xFF;

69 
pBuf
[7] = (*
p
 >> 56) & 0xFF;

71 
	}
}

73 
ölöe
 
	$de£rülizeF64
(c⁄° *
pBuf
){

74 
u64
 
vÆue
 = 0;

75 
vÆue
 |(
u64
)
pBuf
[0];

76 
vÆue
 |(
u64
)
pBuf
[1] << 8;

77 
vÆue
 |(
u64
)
pBuf
[2] << 16;

78 
vÆue
 |(
u64
)
pBuf
[3] << 24;

79 
vÆue
 |(
u64
)
pBuf
[4] << 32;

80 
vÆue
 |(
u64
)
pBuf
[5] << 40;

81 
vÆue
 |(
u64
)
pBuf
[6] << 48;

82 
vÆue
 |(
u64
)
pBuf
[7] << 56;

83  *(*)&
vÆue
;

84 
	}
}

86 
	$ve˘‹F64SîülizeToBlob
(

87 c⁄° 
Ve˘‹
 *
pVe˘‹
,

88 *
pBlob
,

89 
size_t
 
nBlobSize


91 *
ñems
 = 
pVe˘‹
->
d©a
;

92 *
pPå
 = 
pBlob
;

93 
i
;

95 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

96 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

97 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

99 
i
 = 0; i < 
pVe˘‹
->
dims
; i++) {

100 
pPå
 +
	`£rülizeF64
’På, 
ñems
[
i
]);

102 
	}
}

105 
	$ve˘‹BlobFªe
(*
p
, *
pArg
){

106 
sqlôe4_ív
 *
pEnv
 = (sqlôe4_ív*)
pArg
;

107 
	`sqlôe4_‰ì
(
pEnv
, 
p
);

108 
	}
}

110 
	#SINGLE_DOUBLE_CHAR_LIMIT
 32

	)

111 
	$ve˘‹F64M¨shÆToText
(

112 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

113 c⁄° 
Ve˘‹
 *
pVe˘‹


115 *
ñems
 = 
pVe˘‹
->
d©a
;

116 
size_t
 
nBufSize
;

117 
size_t
 
iBuf
 = 0;

118 *
pText
;

119 
vÆueBuf
[
SINGLE_DOUBLE_CHAR_LIMIT
];

121 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

122 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

125 
nBufSize
 = 2 + 
pVe˘‹
->
dims
 * (
SINGLE_DOUBLE_CHAR_LIMIT
 + 1 );

126 
pText
 = 
	`sqlôe4_mÆloc
(0, 
nBufSize
);

127 if–
pText
 !
NULL
 ){

128 
i
;

130 
pText
[
iBuf
++]= '[';

131 
i
 = 0; i < 
pVe˘‹
->
dims
; i++){

132 
vÆueLígth
 = 
	`f‹m©F64
(
ñems
[
i
], 
vÆueBuf
, (valueBuf));

133 
	`mem˝y
(&
pText
[
iBuf
], 
vÆueBuf
, 
vÆueLígth
);

134 
iBuf
 +
vÆueLígth
;

135 
pText
[
iBuf
++] = ',';

137 if–
pVe˘‹
->
dims
 > 0 ){

138 
iBuf
--;

140 
pText
[
iBuf
++] = ']';

142 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
pText
, 
iBuf
, 
ve˘‹BlobFªe
, 0);

144 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

146 
	}
}

148 
	$ve˘‹F64Di°™˚Cos
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

149 
dŸ
 = 0, 
n‹m1
 = 0, 
n‹m2
 = 0;

150 *
e1
 = 
v1
->
d©a
;

151 *
e2
 = 
v2
->
d©a
;

152 
i
;

154 
	`as£π
–
v1
->
dims
 =
v2
->dims );

155 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

156 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

158 
i
 = 0; i < 
v1
->
dims
; i++){

159 
dŸ
 +
e1
[
i
]*
e2
[i];

160 
n‹m1
 +
e1
[
i
]*e1[i];

161 
n‹m2
 +
e2
[
i
]*e2[i];

163  1.0 - (
dŸ
 / 
	`sqπ
(
n‹m1
 * 
n‹m2
));

164 
	}
}

166 
	$ve˘‹F64Di°™˚L2
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

167 
sum
 = 0;

168 *
e1
 = 
v1
->
d©a
;

169 *
e2
 = 
v2
->
d©a
;

170 
i
;

172 
	`as£π
–
v1
->
dims
 =
v2
->dims );

173 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

174 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

176 
i
 = 0; i < 
v1
->
dims
; i++){

177 
d
 = 
e1
[
i
]-
e2
[i];

178 
sum
 +
d
*d;

180  
	`sqπ
(
sum
);

181 
	}
}

183 
	$ve˘‹F64De£rülizeFromBlob
(

184 
Ve˘‹
 *
pVe˘‹
,

185 c⁄° *
pBlob
,

186 
size_t
 
nBlobSize


188 *
ñems
 = 
pVe˘‹
->
d©a
;

189 
i
;

191 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT64
 );

192 
	`as£π
–0 <
pVe˘‹
->
dims
 &&ÖVe˘‹->dim†<
MAX_VECTOR_SZ
 );

193 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

195 
i
 = 0; i < 
pVe˘‹
->
dims
; i++){

196 
ñems
[
i
] = 
	`de£rülizeF64
(
pBlob
);

197 
pBlob
 += ();

199 
	}
}

	@src/vectorfloat8.c

35 #i‚de‡
SQLITE4__OMIT_VECTOR


36 
	~"sqlôeI¡.h
"

38 
	~"ve˘‹I¡.h
"

40 
	~<m©h.h
>

46 
	$ve˘‹F8GëP¨amëîs
(c⁄° 
u8
 *
pD©a
, 
dims
, *
pAÕha
, *
pShi·
){

47 
pD©a
 =ÖD©®+ 
	`ALIGN
(
dims
, ());

48 *
pAÕha
 = 
	`de£rülizeF32
(
pD©a
);

49 *
pShi·
 = 
	`de£rülizeF32
(
pD©a
 + (*
pAÕha
));

50 
	}
}

52 
	$ve˘‹F8SëP¨amëîs
(
u8
 *
pD©a
, 
dims
, 
Æpha
, 
shi·
){

53 
pD©a
 =ÖD©®+ 
	`ALIGN
(
dims
, ());

54 
	`£rülizeF32
(
pD©a
, 
Æpha
);

55 
	`£rülizeF32
(
pD©a
 + (
Æpha
), 
shi·
);

56 
	}
}

58 
	$ve˘‹F8Dump
(c⁄° 
Ve˘‹
 *
pVec
){

59 
u8
 *
ñems
 = 
pVec
->
d©a
;

60 
Æpha
, 
shi·
;

61 
i
;

63 
	`as£π
–
pVec
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

65 
	`ve˘‹F8GëP¨amëîs
(
pVec
->
d©a
,ÖVec->
dims
, &
Æpha
, &
shi·
);

67 
	`¥ötf
("f8: [");

68 
i
 = 0; i < 
pVec
->
dims
; i++){

69 
	`¥ötf
("%s%f", 
i
 =0 ? "" : ", ", ()
ñems
[i] * 
Æpha
 + 
shi·
);

71 
	`¥ötf
("]\n");

72 
	}
}

74 
	$ve˘‹F8SîülizeToBlob
(

75 c⁄° 
Ve˘‹
 *
pVe˘‹
,

76 *
pBlob
,

77 
size_t
 
nBlobSize


79 
Æpha
, 
shi·
;

81 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

82 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

83 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

85 
	`mem˝y
(
pBlob
, 
pVe˘‹
->
d©a
,ÖVe˘‹->
dims
);

87 
	`ve˘‹F8GëP¨amëîs
(
pVe˘‹
->
d©a
,ÖVe˘‹->
dims
, &
Æpha
, &
shi·
);

88 
	`ve˘‹F8SëP¨amëîs
(
pBlob
, 
pVe˘‹
->
dims
, 
Æpha
, 
shi·
);

89 
	}
}

91 
	$ve˘‹F8Di°™˚Cos
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

92 
i
;

93 
Æpha1
, 
shi·1
, 
Æpha2
, 
shi·2
;

94 
u32
 
sum1
 = 0, 
sum2
 = 0, 
sumsq1
 = 0, 
sumsq2
 = 0, 
dŸi
 = 0;

95 
dŸ
 = 0, 
n‹m1
 = 0, 
n‹m2
 = 0;

96 
u8
 *
d©a1
 = 
v1
->
d©a
, *
d©a2
 = 
v2
->data;

98 
	`as£π
–
v1
->
dims
 =
v2
->dims );

99 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

100 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

102 
	`ve˘‹F8GëP¨amëîs
(
v1
->
d©a
, v1->
dims
, &
Æpha1
, &
shi·1
);

103 
	`ve˘‹F8GëP¨amëîs
(
v2
->
d©a
, v2->
dims
, &
Æpha2
, &
shi·2
);

110 
i
 = 0; i < 
v1
->
dims
; i++){

111 
sum1
 +
d©a1
[
i
];

112 
sum2
 +
d©a2
[
i
];

113 
sumsq1
 +
d©a1
[
i
]*data1[i];

114 
sumsq2
 +
d©a2
[
i
]*data2[i];

115 
dŸi
 +
d©a1
[
i
]*
d©a2
[i];

118 
dŸ
 = 
Æpha1
 * 
Æpha2
 * ()
dŸi
 +áÕha1 * 
shi·2
 * ()
sum1
 +áÕha2 * 
shi·1
 * ()
sum2
 + shi·1 * shi·2 * 
v1
->
dims
;

119 
n‹m1
 = 
Æpha1
 *áÕha1 * ()
sumsq1
 + 2 *áÕha1 * 
shi·1
 * ()
sum1
 + shi·1 * shi·1 * 
v1
->
dims
;

120 
n‹m2
 = 
Æpha2
 *áÕha2 * ()
sumsq2
 + 2 *áÕha2 * 
shi·2
 * ()
sum2
 + shi·2 * shi·2 * 
v1
->
dims
;

122  1.0 - (
dŸ
 / 
	`sqπ
(
n‹m1
 * 
n‹m2
));

123 
	}
}

125 
	$ve˘‹F8Di°™˚L2
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

126 
i
;

127 
Æpha1
, 
shi·1
, 
Æpha2
, 
shi·2
;

128 
sum
 = 0;

129 
u8
 *
d©a1
 = 
v1
->
d©a
, *
d©a2
 = 
v2
->data;

131 
	`as£π
–
v1
->
dims
 =
v2
->dims );

132 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

133 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

135 
	`ve˘‹F8GëP¨amëîs
(
v1
->
d©a
, v1->
dims
, &
Æpha1
, &
shi·1
);

136 
	`ve˘‹F8GëP¨amëîs
(
v2
->
d©a
, v2->
dims
, &
Æpha2
, &
shi·2
);

138 
i
 = 0; i < 
v1
->
dims
; i++){

139 
d
 = (
Æpha1
 * 
d©a1
[
i
] + 
shi·1
Ë- (
Æpha2
 * 
d©a2
[i] + 
shi·2
);

140 
sum
 +
d
*d;

142  
	`sqπ
(
sum
);

143 
	}
}

145 
	$ve˘‹F8De£rülizeFromBlob
(

146 
Ve˘‹
 *
pVe˘‹
,

147 c⁄° *
pBlob
,

148 
size_t
 
nBlobSize


150 
Æpha
, 
shi·
;

152 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOAT8
 );

153 
	`as£π
–0 <
pVe˘‹
->
dims
 &&ÖVe˘‹->dim†<
MAX_VECTOR_SZ
 );

154 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

156 
	`mem˝y
((
u8
*)
pVe˘‹
->
d©a
, (u8*)
pBlob
, 
	`ALIGN
’Ve˘‹->
dims
, ()));

158 
	`ve˘‹F8GëP¨amëîs
(
pBlob
, 
pVe˘‹
->
dims
, &
Æpha
, &
shi·
);

159 
	`ve˘‹F8SëP¨amëîs
(
pVe˘‹
->
d©a
,ÖVe˘‹->
dims
, 
Æpha
, 
shi·
);

160 
	}
}

	@src/vectorfloatb16.c

29 #i‚de‡
SQLITE4_OMIT_VECTOR


30 
	~"sqlôeI¡.h
"

32 
	~"ve˘‹I¡.h
"

34 
	~<m©h.h
>

40 
	$ve˘‹FB16ToFlﬂt
(
u16
 
f16
){

41 
u32
 
f32
 = (u32)
f16
 << 16;

42  *((*)&
f32
);

43 
	}
}

45 
u16
 
	$ve˘‹FB16FromFlﬂt
(
f
){

46 
u32
 
f32
 = *((u32*)&
f
);

47  (
u16
)(
f32
 >> 16);

48 
	}
}

50 
	$ve˘‹FB16Dump
(c⁄° 
Ve˘‹
 *
pVec
){

51 
u16
 *
ñems
 = 
pVec
->
d©a
;

52 
i
;

54 
	`as£π
–
pVec
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

56 
	`¥ötf
("fb16: [");

57 
i
 = 0; i < 
pVec
->
dims
; i++){

58 
	`¥ötf
("%s%f", 
i
 =0 ? "" : ", ", 
	`ve˘‹FB16ToFlﬂt
(
ñems
[i]));

60 
	`¥ötf
("]\n");

61 
	}
}

63 
	$ve˘‹FB16SîülizeToBlob
(

64 c⁄° 
Ve˘‹
 *
pVe˘‹
,

65 *
pBlob
,

66 
size_t
 
nBlobSize


68 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

69 
	`as£π
–
pVe˘‹
->
dims
 <
MAX_VECTOR_SZ
 );

70 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

72 
	`mem˝y
(
pBlob
, 
pVe˘‹
->
d©a
,ÖVe˘‹->
dims
 * (
u16
));

73 
	}
}

75 
	$ve˘‹FB16Di°™˚Cos
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

76 
i
;

77 
dŸ
 = 0, 
n‹m1
 = 0, 
n‹m2
 = 0;

78 
vÆue1
, 
vÆue2
;

79 
u16
 *
d©a1
 = 
v1
->
d©a
, *
d©a2
 = 
v2
->data;

81 
	`as£π
–
v1
->
dims
 =
v2
->dims );

82 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

83 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

85 
i
 = 0; i < 
v1
->
dims
; i++){

86 
vÆue1
 = 
	`ve˘‹FB16ToFlﬂt
(
d©a1
[
i
]);

87 
vÆue2
 = 
	`ve˘‹FB16ToFlﬂt
(
d©a2
[
i
]);

88 
dŸ
 +
vÆue1
*
vÆue2
;

89 
n‹m1
 +
vÆue1
*value1;

90 
n‹m2
 +
vÆue2
*value2;

93  1.0 - (
dŸ
 / 
	`sqπ
(
n‹m1
 * 
n‹m2
));

94 
	}
}

96 
	$ve˘‹FB16Di°™˚L2
(c⁄° 
Ve˘‹
 *
v1
, c⁄° Ve˘‹ *
v2
){

97 
i
;

98 
sum
 = 0;

99 
vÆue1
, 
vÆue2
;

100 
u16
 *
d©a1
 = 
v1
->
d©a
, *
d©a2
 = 
v2
->data;

102 
	`as£π
–
v1
->
dims
 =
v2
->dims );

103 
	`as£π
–
v1
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

104 
	`as£π
–
v2
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

106 
i
 = 0; i < 
v1
->
dims
; i++){

107 
vÆue1
 = 
	`ve˘‹FB16ToFlﬂt
(
d©a1
[
i
]);

108 
vÆue2
 = 
	`ve˘‹FB16ToFlﬂt
(
d©a2
[
i
]);

109 
d
 = (
vÆue1
 - 
vÆue2
);

110 
sum
 +
d
*d;

112  
	`sqπ
(
sum
);

113 
	}
}

115 
	$ve˘‹FB16De£rülizeFromBlob
(

116 
Ve˘‹
 *
pVe˘‹
,

117 c⁄° *
pBlob
,

118 
size_t
 
nBlobSize


120 
	`as£π
–
pVe˘‹
->
ty≥
 =
VECTOR_TYPE_FLOATB16
 );

121 
	`as£π
–0 <
pVe˘‹
->
dims
 &&ÖVe˘‹->dim†<
MAX_VECTOR_SZ
 );

122 
	`as£π
–
nBlobSize
 >
	`ve˘‹D©aSize
(
pVe˘‹
->
ty≥
,ÖVe˘‹->
dims
) );

124 
	`mem˝y
((
u8
*)
pVe˘‹
->
d©a
, (u8*)
pBlob
,ÖVe˘‹->
dims
 * (
u16
));

125 
	}
}

	@src/vectorvtab.c

27 #i‡!
deföed
(
SQLITE_OMIT_VECTOR
Ë&& !deföed(
SQLITE_OMIT_VIRTUALTABLE
)

28 
	~"sqlôe3.h
"

29 
	~"vdbeI¡.h
"

30 
	~"ve˘‹IndexI¡.h
"

32 
ve˘‹Vèb
 
	tve˘‹Vèb
;

33 
	sve˘‹Vèb
 {

34 
sqlôe3_vèb
 
	mba£
;

35 
sqlôe3
 *
	mdb
;

38 
ve˘‹Vèb_curs‹
 
	tve˘‹Vèb_curs‹
;

39 
	sve˘‹Vèb_curs‹
 {

41 
sqlôe3_vèb_curs‹
 
	mba£
;

42 
	mnRóds
;

43 
	mnWrôes
;

44 
Ve˘‹OutRows
 
	mrows
;

45 
	miRow
;

49 
	#VECTOR_COLUMN_IDX
 0

	)

50 
	#VECTOR_COLUMN_VECTOR
 1

	)

51 
	#VECTOR_COLUMN_K
 2

	)

52 
	#VECTOR_COLUMN_OFFSET
 3

	)

54 
	$ve˘‹VèbC⁄√˘
(

55 
sqlôe3
 *
db
,

56 *
pAux
,

57 
¨gc
, c⁄° *c⁄° *
¨gv
,

58 
sqlôe3_vèb
 **
µVèb
,

59 **
pzEº


61 
ve˘‹Vèb
 *
pVèb
 = 
NULL
;

62 
rc
;

67 
rc
 = 
	`sqlôe3_de˛¨e_vèb
(
db
, "CREATE TABLE x(idx hidden, vector hidden, k hidden, id);");

68 if–
rc
 !
SQLITE_OK
 ){

69  
rc
;

71 
pVèb
 = 
	`sqlôe3_mÆloc
–(
ve˘‹Vèb
) );

72 if–
pVèb
 =
NULL
 ){

73  
SQLITE_NOMEM_BKPT
;

78 
	`mem£t
(
pVèb
, 0, (*pVtab));

79 
pVèb
->
db
 = db;

80 *
µVèb
 = (
sqlôe3_vèb
*)
pVèb
;

81  
SQLITE_OK
;

82 
	}
}

84 
	$ve˘‹VèbDisc⁄√˘
(
sqlôe3_vèb
 *
pVèb
){

85 
ve˘‹Vèb
 *
pVTab
 = (ve˘‹Vèb*)
pVèb
;

86 
	`sqlôe3_‰ì
(
pVèb
);

87  
SQLITE_OK
;

88 
	}
}

90 
	$ve˘‹VèbO≥n
(
sqlôe3_vèb
 *
p
, 
sqlôe3_vèb_curs‹
 **
µCurs‹
){

91 
ve˘‹Vèb
 *
pVTab
 = (ve˘‹Vèb*)
p
;

92 
ve˘‹Vèb_curs‹
 *
pCur
;

93 
pCur
 = 
	`sqlôe3_mÆloc
–(
ve˘‹Vèb_curs‹
) );

94 if–
pCur
 =
NULL
 ){

95  
SQLITE_NOMEM
;

97 
	`mem£t
(
pCur
, 0, (*pCur));

98 *
µCurs‹
 = &
pCur
->
ba£
;

99  
SQLITE_OK
;

100 
	}
}

102 
	$ve˘‹VèbClo£
(
sqlôe3_vèb_curs‹
 *
cur
){

103 
ve˘‹Vèb_curs‹
 *
pCur
 = (ve˘‹Vèb_curs‹*)
cur
;

104 
ve˘‹Vèb
 *
pVTab
 = (ve˘‹Vèb *)
cur
->
pVèb
;

105 
	`ve˘‹OutRowsFªe
(
pVTab
->
db
, &
pCur
->
rows
);

106 
	`sqlôe3_‰ì
(
pCur
);

107  
SQLITE_OK
;

108 
	}
}

110 
	$ve˘‹VèbNext
(
sqlôe3_vèb_curs‹
 *
cur
){

111 
ve˘‹Vèb_curs‹
 *
pCur
 = (ve˘‹Vèb_curs‹*)
cur
;

112 
pCur
->
iRow
++;

113  
SQLITE_OK
;

114 
	}
}

116 
	$ve˘‹VèbEof
(
sqlôe3_vèb_curs‹
 *
cur
){

117 
ve˘‹Vèb_curs‹
 *
pCur
 = (ve˘‹Vèb_curs‹*)
cur
;

118  
pCur
->
iRow
 >pCur->
rows
.
nRows
;

119 
	}
}

121 
	$ve˘‹VèbCﬁumn
(

122 
sqlôe3_vèb_curs‹
 *
cur
,

123 
sqlôe3_c⁄ãxt
 *
c⁄ãxt
,

124 
iCﬁ


126 
ve˘‹Vèb_curs‹
 *
pCur
 = (ve˘‹Vèb_curs‹*)
cur
;

127 
	`ve˘‹OutRowsGë
(
c⁄ãxt
, &
pCur
->
rows
,ÖCur->
iRow
, 
iCﬁ
 - 
VECTOR_COLUMN_OFFSET
);

128  
SQLITE_OK
;

129 
	}
}

131 
	$ve˘‹VèbRowid
(
sqlôe3_vèb_curs‹
 *
cur
, 
sqlôe_öt64
 *
pRowid
){

132 
ve˘‹Vèb_curs‹
 *
pCur
 = (ve˘‹Vèb_curs‹*)
cur
;

134 if–
pCur
->
rows
.
aI¡VÆues
 !
NULL
 ){

135 *
pRowid
 = 
pCur
->
rows
.
aI¡VÆues
[pCur->
iRow
];

137 *
pRowid
 = 
pCur
->
iRow
;

139  
SQLITE_OK
;

140 
	}
}

142 
	$ve˘‹VèbFûãr
(

143 
sqlôe3_vèb_curs‹
 *
pVèbCurs‹
,

144 
idxNum
, c⁄° *
idxSå
,

145 
¨gc
, 
sqlôe3_vÆue
 **
¨gv


147 
ve˘‹Vèb_curs‹
 *
pCur
 = (ve˘‹Vèb_curs‹ *)
pVèbCurs‹
;

148 
ve˘‹Vèb
 *
pVTab
 = (ve˘‹Vèb *)
pVèbCurs‹
->
pVèb
;

149 
pCur
->
rows
.
aI¡VÆues
 = 
NULL
;

150 
pCur
->
rows
.
µVÆues
 = 
NULL
;

152 if–
	`ve˘‹IndexSórch
(
pVTab
->
db
, 
¨gc
, 
¨gv
, &
pCur
->
rows
, &pCur->
nRóds
, &pCur->
nWrôes
, &pVTab->
ba£
.
zEºMsg
) != 0 ){

153  
SQLITE_ERROR
;

156 
	`as£π
–
pCur
->
rows
.
nRows
 >= 0 );

157 
	`as£π
–
pCur
->
rows
.
nCﬁs
 > 0 );

158 
pCur
->
iRow
 = 0;

159  
SQLITE_OK
;

160 
	}
}

162 
	$ve˘‹VèbBe°Index
(

163 
sqlôe3_vèb
 *
èb
,

164 
sqlôe3_ödex_öfo
 *
pIdxInfo


166 c⁄° 
sqlôe3_ödex_c⁄°øöt
 *
pC⁄°øöt
;

167 
i
;

169 
pIdxInfo
->
e°im©edCo°
 = ()1;

170 
pIdxInfo
->
e°im©edRows
 = 100;

171 
pIdxInfo
->
idxNum
 = 1;

173 
pC⁄°øöt
 = 
pIdxInfo
->
aC⁄°øöt
;

174 
i
=0; i<
pIdxInfo
->
nC⁄°øöt
; i++, 
pC⁄°øöt
++){

175 if–
pC⁄°øöt
->
ußbÀ
 == 0 ) ;

176 if–
pC⁄°øöt
->
›
 !
SQLITE_INDEX_CONSTRAINT_EQ
 ) ;

177  
pC⁄°øöt
->
iCﬁumn
 ){

178 
VECTOR_COLUMN_IDX
:

179 
pIdxInfo
->
aC⁄°øötUßge
[
i
].
¨gvIndex
 = 1;

180 
pIdxInfo
->
aC⁄°øötUßge
[
i
].
omô
 = 1;

182 
VECTOR_COLUMN_VECTOR
:

183 
pIdxInfo
->
aC⁄°øötUßge
[
i
].
¨gvIndex
 = 2;

184 
pIdxInfo
->
aC⁄°øötUßge
[
i
].
omô
 = 1;

186 
VECTOR_COLUMN_K
:

187 
pIdxInfo
->
aC⁄°øötUßge
[
i
].
¨gvIndex
 = 3;

188 
pIdxInfo
->
aC⁄°øötUßge
[
i
].
omô
 = 1;

192  
SQLITE_OK
;

193 
	}
}

195 
sqlôe3_moduÀ
 
	gve˘‹ModuÀ
 = {

198  
ve˘‹VèbC⁄√˘
,

199  
ve˘‹VèbBe°Index
,

200  
ve˘‹VèbDisc⁄√˘
,

202  
ve˘‹VèbO≥n
,

203  
ve˘‹VèbClo£
,

204  
ve˘‹VèbFûãr
,

205  
ve˘‹VèbNext
,

206  
ve˘‹VèbEof
,

207  
ve˘‹VèbCﬁumn
,

208  
ve˘‹VèbRowid
,

223 
	$ve˘‹VèbInô
(
sqlôe3
 *
db
){

224  
	`sqlôe3_¸óã_moduÀ
(
db
, 
VECTOR_INDEX_VTAB_NAME
, &
ve˘‹ModuÀ
, 0);

225 
	}
}

	@src/walker.c

15 
	~"sqlôeI¡.h
"

16 
	~<°dlib.h
>

17 
	~<°rög.h
>

39 
	$sqlôe4WÆkEx¥
(
WÆkî
 *
pWÆkî
, 
Ex¥
 *
pEx¥
){

40 
rc
;

41 if–
pEx¥
==0 )  
WRC_C⁄töue
;

42 
	`ã°ˇ£
–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_TokíO∆y
) );

43 
	`ã°ˇ£
–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_Redu˚d
) );

44 
rc
 = 
pWÆkî
->
	`xEx¥CÆlback
’WÆkî, 
pEx¥
);

45 if–
rc
==
WRC_C⁄töue


46 && !
	`Ex¥HasAnyPr›îty
(
pEx¥
,
EP_TokíO∆y
) ){

47 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
pEx¥
->
pLe·
ËË 
WRC_Ab‹t
;

48 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
pEx¥
->
pRight
ËË 
WRC_Ab‹t
;

49 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

50 if–
	`sqlôe4WÆkSñe˘
(
pWÆkî
, 
pEx¥
->
x
.
pSñe˘
ËË 
WRC_Ab‹t
;

52 if–
	`sqlôe4WÆkEx¥Li°
(
pWÆkî
, 
pEx¥
->
x
.
pLi°
ËË 
WRC_Ab‹t
;

55  
rc
 & 
WRC_Ab‹t
;

56 
	}
}

62 
	$sqlôe4WÆkEx¥Li°
(
WÆkî
 *
pWÆkî
, 
Ex¥Li°
 *
p
){

63 
i
;

64 
Ex¥Li°Iãm
 *
pIãm
;

65 if–
p
 ){

66 
i
=
p
->
nEx¥
, 
pIãm
ı->
a
; i>0; i--,ÖItem++){

67 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
pIãm
->
pEx¥
ËË 
WRC_Ab‹t
;

70  
WRC_C⁄töue
;

71 
	}
}

79 
	$sqlôe4WÆkSñe˘Ex¥
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
p
){

80 if–
	`sqlôe4WÆkEx¥Li°
(
pWÆkî
, 
p
->
pELi°
ËË 
WRC_Ab‹t
;

81 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
p
->
pWhîe
ËË 
WRC_Ab‹t
;

82 if–
	`sqlôe4WÆkEx¥Li°
(
pWÆkî
, 
p
->
pGroupBy
ËË 
WRC_Ab‹t
;

83 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
p
->
pHavög
ËË 
WRC_Ab‹t
;

84 if–
	`sqlôe4WÆkEx¥Li°
(
pWÆkî
, 
p
->
pOrdîBy
ËË 
WRC_Ab‹t
;

85 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
p
->
pLimô
ËË 
WRC_Ab‹t
;

86 if–
	`sqlôe4WÆkEx¥
(
pWÆkî
, 
p
->
pOff£t
ËË 
WRC_Ab‹t
;

87  
WRC_C⁄töue
;

88 
	}
}

97 
	$sqlôe4WÆkSñe˘From
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
p
){

98 
SrcLi°
 *
pSrc
;

99 
i
;

100 
SrcLi°Iãm
 *
pIãm
;

102 
pSrc
 = 
p
->pSrc;

103 if–
	`ALWAYS
(
pSrc
) ){

104 
i
=
pSrc
->
nSrc
, 
pIãm
ıSrc->
a
; i>0; i--,ÖItem++){

105 if–
	`sqlôe4WÆkSñe˘
(
pWÆkî
, 
pIãm
->
pSñe˘
) ){

106  
WRC_Ab‹t
;

110  
WRC_C⁄töue
;

111 
	}
}

124 
	$sqlôe4WÆkSñe˘
(
WÆkî
 *
pWÆkî
, 
Sñe˘
 *
p
){

125 
rc
;

126 if–
p
==0 || 
pWÆkî
->
xSñe˘CÆlback
==0 )  
WRC_C⁄töue
;

127 
rc
 = 
WRC_C⁄töue
;

128  
p
 ){

129 
rc
 = 
pWÆkî
->
	`xSñe˘CÆlback
’WÆkî, 
p
);

130 if–
rc
 ) ;

131 if–
	`sqlôe4WÆkSñe˘Ex¥
(
pWÆkî
, 
p
ËË 
WRC_Ab‹t
;

132 if–
	`sqlôe4WÆkSñe˘From
(
pWÆkî
, 
p
ËË 
WRC_Ab‹t
;

133 
p
 =Ö->
pPri‹
;

135  
rc
 & 
WRC_Ab‹t
;

136 
	}
}

	@src/where.c

19 
	~"sqlôeI¡.h
"

24 #i‡
deföed
(
SQLITE4_TEST
Ë|| deföed(
SQLITE4_DEBUG
)

25  
	gsqlôe4WhîeTø˚
 = 0;

27 #i‡
deföed
(
SQLITE4_DEBUG
) \

28 && (
deföed
(
SQLITE4_TEST
Ë|| 
	$deföed
(
SQLITE4_ENABLE_WHERETRACE
))

29 
	#WHERETRACE
(
K
,
X
Ëif(
sqlôe4WhîeTø˚
&(K)Ë
sqlôe4DebugPrötf
 
	)
X

30 
	#WHERETRACE_ENABLED
 1

	)

32 
	#WHERETRACE
(
K
,
X
)

	)

37 
WhîeCœu£
 
	tWhîeCœu£
;

38 
WhîeMaskSë
 
	tWhîeMaskSë
;

39 
WhîeOrInfo
 
	tWhîeOrInfo
;

40 
WhîeAndInfo
 
	tWhîeAndInfo
;

41 
WhîeLevñ
 
	tWhîeLevñ
;

42 
WhîeLo›
 
	tWhîeLo›
;

43 
WhîeP©h
 
	tWhîeP©h
;

44 
WhîeTîm
 
	tWhîeTîm
;

45 
WhîeLo›Buûdî
 
	tWhîeLo›Buûdî
;

46 
WhîeSˇn
 
	tWhîeSˇn
;

47 
WhîeOrCo°
 
	tWhîeOrCo°
;

48 
WhîeOrSë
 
	tWhîeOrSë
;

66 
	tWhîeCo°
;

83 
	sWhîeLevñ
 {

84 
iLe·Joö
;

85 
iTabCur
;

86 
iIdxCur
;

87 
addrBrk
;

88 
addrNxt
;

89 
addrC⁄t
;

90 
addrFú°
;

91 
u8
 
iFrom
;

92 
u8
 
›
, 
p5
;

93 
p1
, 
p2
;

96 
nIn
;

97 
	sInLo›
 {

98 
iCur
;

99 
addrInT›
;

100 
u8
 
eEndLo›Op
;

101 } *
aInLo›
;

102 } 
ö
;

103 
Index
 *
pCovidx
;

104 } 
u
;

105 
WhîeLo›
 *
pWLo›
;

122 
	sWhîeLo›
 {

123 
Bômask
 
¥îeq
;

124 
Bômask
 
maskSñf
;

125 #ifde‡
SQLITE4_DEBUG


126 
cId
;

128 
u8
 
iTab
;

129 
u8
 
iS‹tIdx
;

130 
WhîeCo°
 
rSëup
;

131 
WhîeCo°
 
rRun
;

132 
WhîeCo°
 
nOut
;

135 
nEq
;

136 
Index
 *
pIndex
;

137 } 
båì
;

139 
idxNum
;

140 
u8
 
√edFªe
;

141 
u8
 
isOrdîed
;

142 
u16
 
omôMask
;

143 *
idxSå
;

144 } 
vèb
;

145 } 
u
;

146 
u32
 
wsFœgs
;

147 
u16
 
nLTîm
;

149 
	#WHERE_LOOP_XFER_SZ
 
	`off£tof
(
WhîeLo›
,
nLSlŸ
)

	)

150 
u16
 
nLSlŸ
;

151 
WhîeTîm
 **
aLTîm
;

152 
WhîeLo›
 *
pNextLo›
;

153 
WhîeTîm
 *
aLTîmS∑˚
[4];

160 
	sWhîeOrCo°
 {

161 
Bômask
 
¥îeq
;

162 
WhîeCo°
 
rRun
;

163 
WhîeCo°
 
nOut
;

170 
	#N_OR_COST
 3

	)

171 
	sWhîeOrSë
 {

172 
u16
 
n
;

173 
WhîeOrCo°
 
a
[
N_OR_COST
];

178 
	`whîeLo›Resize
(
sqlôe4
*, 
WhîeLo›
*, );

198 
	sWhîeP©h
 {

199 
Bômask
 
maskLo›
;

200 
Bômask
 
ªvLo›
;

201 
WhîeCo°
 
nRow
;

202 
WhîeCo°
 
rCo°
;

203 
u8
 
isOrdîed
;

204 
u8
 
isOrdîedVÆid
;

205 
WhîeLo›
 **
aLo›
;

259 
	sWhîeTîm
 {

260 
Ex¥
 *
pEx¥
;

261 
iP¨ít
;

262 
À·Curs‹
;

264 
À·Cﬁumn
;

265 
WhîeOrInfo
 *
pOrInfo
;

266 
WhîeAndInfo
 *
pAndInfo
;

267 } 
u
;

268 
u16
 
eO≥øt‹
;

269 
u8
 
wtFœgs
;

270 
u8
 
nChûd
;

271 
WhîeCœu£
 *
pWC
;

272 
Bômask
 
¥îeqRight
;

273 
Bômask
 
¥îeqAŒ
;

279 
	#TERM_DYNAMIC
 0x01

	)

280 
	#TERM_VIRTUAL
 0x02

	)

281 
	#TERM_CODED
 0x04

	)

282 
	#TERM_COPIED
 0x08

	)

283 
	#TERM_ORINFO
 0x10

	)

284 
	#TERM_ANDINFO
 0x20

	)

285 
	#TERM_OR_OK
 0x40

	)

286 #ifde‡
SQLITE4_ENABLE_STAT3


287 
	#TERM_VNULL
 0x80

	)

289 
	#TERM_VNULL
 0x00

	)

296 
	sWhîeSˇn
 {

297 
WhîeCœu£
 *
pOrigWC
;

298 
WhîeCœu£
 *
pWC
;

299 *
zCﬁlName
;

300 
idxaff
;

301 
nEquiv
;

302 
iEquiv
;

303 
u32
 
›Mask
;

304 
k
;

305 
aEquiv
[22];

320 
	sWhîeCœu£
 {

321 
WhîeInfo
 *
pWInfo
;

322 
WhîeCœu£
 *
pOuãr
;

323 
u8
 
›
;

324 
nTîm
;

325 
nSlŸ
;

326 
WhîeTîm
 *
a
;

327 #i‡
	`deföed
(
SQLITE4_SMALL_STACK
)

328 
WhîeTîm
 
aSètic
[1];

330 
WhîeTîm
 
aSètic
[8];

338 
	sWhîeOrInfo
 {

339 
WhîeCœu£
 
wc
;

340 
Bômask
 
ödexabÀ
;

347 
	sWhîeAndInfo
 {

348 
WhîeCœu£
 
wc
;

377 
	sWhîeMaskSë
 {

378 
n
;

379 
ix
[
BMS
];

386 
	sWhîeLo›Buûdî
 {

387 
WhîeInfo
 *
pWInfo
;

388 
WhîeCœu£
 *
pWC
;

389 
Ex¥Li°
 *
pOrdîBy
;

390 
WhîeLo›
 *
pNew
;

391 
WhîeOrSë
 *
pOrSë
;

404 
	sWhîeInfo
 {

405 
P¨£
 *
pP¨£
;

406 
SrcLi°
 *
pTabLi°
;

407 
Ex¥Li°
 *
pOrdîBy
;

408 
Ex¥Li°
 *
pResu…Së
;

409 
WhîeLo›
 *
pLo›s
;

410 
Bômask
 
ªvMask
;

411 
WhîeCo°
 
nRowOut
;

412 
u16
 
w˘æFœgs
;

413 
u8
 
bOBS©
;

414 
u8
 
okO√Pass
;

415 
u8
 
u¡e°edTîms
;

416 
u8
 
eDi°ö˘
;

417 
u8
 
nLevñ
;

418 
iT›
;

419 
iC⁄töue
;

420 
iBªak
;

421 
ßvedNQuîyLo›
;

422 
WhîeMaskSë
 
sMaskSë
;

423 
WhîeCœu£
 
sWC
;

424 
WhîeLevñ
 
a
[1];

433 
	#WO_IN
 0x001

	)

434 
	#WO_EQ
 0x002

	)

435 
	#WO_LT
 (
WO_EQ
<<(
TK_LT
-
TK_EQ
))

	)

436 
	#WO_LE
 (
WO_EQ
<<(
TK_LE
-
TK_EQ
))

	)

437 
	#WO_GT
 (
WO_EQ
<<(
TK_GT
-
TK_EQ
))

	)

438 
	#WO_GE
 (
WO_EQ
<<(
TK_GE
-
TK_EQ
))

	)

439 
	#WO_MATCH
 0x040

	)

440 
	#WO_ISNULL
 0x080

	)

441 
	#WO_OR
 0x100

	)

442 
	#WO_AND
 0x200

	)

443 
	#WO_EQUIV
 0x400

	)

444 
	#WO_NOOP
 0x800

	)

446 
	#WO_ALL
 0xff‡

	)

447 
	#WO_SINGLE
 0x0f‡

	)

454 
	#WHERE_COLUMN_EQ
 0x00000001

	)

455 
	#WHERE_COLUMN_RANGE
 0x00000002

	)

456 
	#WHERE_COLUMN_IN
 0x00000004

	)

457 
	#WHERE_COLUMN_NULL
 0x00000008

	)

458 
	#WHERE_CONSTRAINT
 0x0000000‡

	)

459 
	#WHERE_TOP_LIMIT
 0x00000010

	)

460 
	#WHERE_BTM_LIMIT
 0x00000020

	)

461 
	#WHERE_BOTH_LIMIT
 0x00000030

	)

462 
	#WHERE_IDX_ONLY
 0x00000040

	)

463 
	#WHERE_PRIMARY_KEY
 0x00000100

	)

464 
	#WHERE_INDEXED
 0x00000200

	)

465 
	#WHERE_VIRTUALTABLE
 0x00000400

	)

466 
	#WHERE_IN_ABLE
 0x00000800

	)

467 
	#WHERE_ONEROW
 0x00001000

	)

468 
	#WHERE_MULTI_OR
 0x00002000

	)

469 
	#WHERE_AUTO_INDEX
 0x00004000

	)

475 
u64
 
	$whîeCo°ToI¡
(
WhîeCo°
 
x
){

476 
u64
 
n
;

477 if–
x
<10 )  1;

478 
n
 = 
x
%10;

479 
x
 /= 10;

480 if–
n
>=5 )Ç -= 2;

481 if–
n
>=1 )Ç -= 1;

482 if–
x
>=3 )  (
n
+8)<<(x-3);

483  (
n
+8)>>(3-
x
);

484 
	}
}

489 
u64
 
	$sqlôe4WhîeOuçutRowCou¡
(
WhîeInfo
 *
pWInfo
){

490  
	`whîeCo°ToI¡
(
pWInfo
->
nRowOut
);

491 
	}
}

497 
	$sqlôe4WhîeIsDi°ö˘
(
WhîeInfo
 *
pWInfo
){

498  
pWInfo
->
eDi°ö˘
;

499 
	}
}

505 
	$sqlôe4WhîeIsOrdîed
(
WhîeInfo
 *
pWInfo
){

506  
pWInfo
->
bOBS©
!=0;

507 
	}
}

513 
	$sqlôe4WhîeC⁄töueLabñ
(
WhîeInfo
 *
pWInfo
){

514  
pWInfo
->
iC⁄töue
;

515 
	}
}

521 
	$sqlôe4WhîeBªakLabñ
(
WhîeInfo
 *
pWInfo
){

522  
pWInfo
->
iBªak
;

523 
	}
}

530 
	$sqlôe4WhîeOkO√Pass
(
WhîeInfo
 *
pWInfo
){

531  
pWInfo
->
okO√Pass
;

532 
	}
}

537 
	$whîeOrMove
(
WhîeOrSë
 *
pDe°
, WhîeOrSë *
pSrc
){

538 
pDe°
->
n
 = 
pSrc
->n;

539 
	`mem˝y
(
pDe°
->
a
, 
pSrc
->a,ÖDe°->
n
*(pDest->a[0]));

540 
	}
}

549 
	$whîeOrIn£π
(

550 
WhîeOrSë
 *
pSë
,

551 
Bômask
 
¥îeq
,

552 
WhîeCo°
 
rRun
,

553 
WhîeCo°
 
nOut


555 
u16
 
i
;

556 
WhîeOrCo°
 *
p
;

557 
i
=
pSë
->
n
, 
p
ıSë->
a
; i>0; i--,Ö++){

558 if–
rRun
<=
p
->rRu¿&& (
¥îeq
 &Ö->prereq)==prereq ){

559 
whîeOrIn£π_d⁄e
;

561 if–
p
->
rRun
<ÙRu¿&& (p->
¥îeq
 &Örereq)==p->prereq ){

565 if–
pSë
->
n
<
N_OR_COST
 ){

566 
p
 = &
pSë
->
a
[pSë->
n
++];

567 
p
->
nOut
 =ÇOut;

569 
p
 = 
pSë
->
a
;

570 
i
=1; i<
pSë
->
n
; i++){

571 if–
p
->
rRun
>
pSë
->
a
[
i
].rRun )Ö =ÖSet->a + i;

573 if–
p
->
rRun
<=rRun )  0;

575 
whîeOrIn£π_d⁄e
:

576 
p
->
¥îeq
 =Örereq;

577 
p
->
rRun
 =ÑRun;

578 if–
p
->
nOut
>nOut )Ö->nOut =ÇOut;

580 
	}
}

585 
	$whîeCœu£Inô
(

586 
WhîeCœu£
 *
pWC
,

587 
WhîeInfo
 *
pWInfo


589 
pWC
->
pWInfo
 =ÖWInfo;

590 
pWC
->
pOuãr
 = 0;

591 
pWC
->
nTîm
 = 0;

592 
pWC
->
nSlŸ
 = 
	`AºaySize
’WC->
aSètic
);

593 
pWC
->
a
 =ÖWC->
aSètic
;

594 
	}
}

597 
whîeCœu£CÀ¨
(
WhîeCœu£
*);

602 
	$whîeOrInfoDñëe
(
sqlôe4
 *
db
, 
WhîeOrInfo
 *
p
){

603 
	`whîeCœu£CÀ¨
(&
p
->
wc
);

604 
	`sqlôe4DbFªe
(
db
, 
p
);

605 
	}
}

610 
	$whîeAndInfoDñëe
(
sqlôe4
 *
db
, 
WhîeAndInfo
 *
p
){

611 
	`whîeCœu£CÀ¨
(&
p
->
wc
);

612 
	`sqlôe4DbFªe
(
db
, 
p
);

613 
	}
}

619 
	$whîeCœu£CÀ¨
(
WhîeCœu£
 *
pWC
){

620 
i
;

621 
WhîeTîm
 *
a
;

622 
sqlôe4
 *
db
 = 
pWC
->
pWInfo
->
pP¨£
->db;

623 
i
=
pWC
->
nTîm
-1, 
a
=pWC->a; i>=0; i--,á++){

624 if–
a
->
wtFœgs
 & 
TERM_DYNAMIC
 ){

625 
	`sqlôe4Ex¥Dñëe
(
db
, 
a
->
pEx¥
);

627 if–
a
->
wtFœgs
 & 
TERM_ORINFO
 ){

628 
	`whîeOrInfoDñëe
(
db
, 
a
->
u
.
pOrInfo
);

629 }if–
a
->
wtFœgs
 & 
TERM_ANDINFO
 ){

630 
	`whîeAndInfoDñëe
(
db
, 
a
->
u
.
pAndInfo
);

633 if–
pWC
->
a
!ıWC->
aSètic
 ){

634 
	`sqlôe4DbFªe
(
db
, 
pWC
->
a
);

636 
	}
}

648 
Ex¥
 *
	$sqlôe4Ex¥SkùCﬁœã
(
Ex¥
 *
pEx¥
){

649 
	`as£π
–
pEx¥
==0 ||ÖEx¥->
›
!=
TK_COLLATE
 );

651  
pEx¥
 && (pEx¥->
›
==
TK_COLLATE
 ||ÖEx¥->›==
TK_AS
) ){

652 
pEx¥
 =ÖEx¥->
pLe·
;

654  
pEx¥
;

655 
	}
}

660 
	#MASKBIT
(
n
Ë(((
Bômask
)1)<<“))

	)

683 
	$whîeCœu£In£π
(
WhîeCœu£
 *
pWC
, 
Ex¥
 *
p
, 
u8
 
wtFœgs
){

684 
WhîeTîm
 *
pTîm
;

685 
idx
;

686 
	`ã°ˇ£
–
wtFœgs
 & 
TERM_VIRTUAL
 );

687 if–
pWC
->
nTîm
>ıWC->
nSlŸ
 ){

688 
WhîeTîm
 *
pOld
 = 
pWC
->
a
;

689 
sqlôe4
 *
db
 = 
pWC
->
pWInfo
->
pP¨£
->db;

690 
pWC
->
a
 = 
	`sqlôe4DbMÆlocRaw
(
db
, ’WC->a[0])*pWC->
nSlŸ
*2 );

691 if–
pWC
->
a
==0 ){

692 if–
wtFœgs
 & 
TERM_DYNAMIC
 ){

693 
	`sqlôe4Ex¥Dñëe
(
db
, 
p
);

695 
pWC
->
a
 = 
pOld
;

698 
	`mem˝y
(
pWC
->
a
, 
pOld
, ’WC->a[0])*pWC->
nTîm
);

699 if–
pOld
!=
pWC
->
aSètic
 ){

700 
	`sqlôe4DbFªe
(
db
, 
pOld
);

702 
pWC
->
nSlŸ
 = 
	`sqlôe4DbMÆlocSize
(
db
,ÖWC->
a
)/(pWC->a[0]);

704 
pTîm
 = &
pWC
->
a
[
idx
 =ÖWC->
nTîm
++];

705 
pTîm
->
pEx¥
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
p
);

706 
pTîm
->
wtFœgs
 = wtFlags;

707 
pTîm
->
pWC
 =ÖWC;

708 
pTîm
->
iP¨ít
 = -1;

709  
idx
;

710 
	}
}

729 
	$whîeS∂ô
(
WhîeCœu£
 *
pWC
, 
Ex¥
 *
pEx¥
, 
u8
 
›
){

730 
pWC
->
›
 = op;

731 if–
pEx¥
==0 ) ;

732 if–
pEx¥
->
›
!=op ){

733 
	`whîeCœu£In£π
(
pWC
, 
pEx¥
, 0);

735 
	`whîeS∂ô
(
pWC
, 
pEx¥
->
pLe·
, 
›
);

736 
	`whîeS∂ô
(
pWC
, 
pEx¥
->
pRight
, 
›
);

738 
	}
}

743 
	#öôMaskSë
(
P
Ë(P)->
n
=0

	)

749 
Bômask
 
	$gëMask
(
WhîeMaskSë
 *
pMaskSë
, 
iCurs‹
){

750 
i
;

751 
	`as£π
–
pMaskSë
->
n
<=()(
Bômask
)*8 );

752 
i
=0; i<
pMaskSë
->
n
; i++){

753 if–
pMaskSë
->
ix
[
i
]==
iCurs‹
 ){

754  
	`MASKBIT
(
i
);

758 
	}
}

768 
	$¸óãMask
(
WhîeMaskSë
 *
pMaskSë
, 
iCurs‹
){

769 
	`as£π
–
pMaskSë
->
n
 < 
	`AºaySize
’MaskSë->
ix
) );

770 
pMaskSë
->
ix
[pMaskSë->
n
++] = 
iCurs‹
;

771 
	}
}

778 
Bômask
 
ex¥Li°TabÀUßge
(
WhîeMaskSë
*, 
Ex¥Li°
*);

779 
Bômask
 
ex¥Sñe˘TabÀUßge
(
WhîeMaskSë
*, 
Sñe˘
*);

780 
Bômask
 
	$ex¥TabÀUßge
(
WhîeMaskSë
 *
pMaskSë
, 
Ex¥
 *
p
){

781 
Bômask
 
mask
 = 0;

782 if–
p
==0 )  0;

783 if–
p
->
›
==
TK_COLUMN
 ){

784 
mask
 = 
	`gëMask
(
pMaskSë
, 
p
->
iTabÀ
);

785  
mask
;

787 
mask
 = 
	`ex¥TabÀUßge
(
pMaskSë
, 
p
->
pRight
);

788 
mask
 |
	`ex¥TabÀUßge
(
pMaskSë
, 
p
->
pLe·
);

789 if–
	`Ex¥HasPr›îty
(
p
, 
EP_xIsSñe˘
) ){

790 
mask
 |
	`ex¥Sñe˘TabÀUßge
(
pMaskSë
, 
p
->
x
.
pSñe˘
);

792 
mask
 |
	`ex¥Li°TabÀUßge
(
pMaskSë
, 
p
->
x
.
pLi°
);

794  
mask
;

795 
	}
}

796 
Bômask
 
	$ex¥Li°TabÀUßge
(
WhîeMaskSë
 *
pMaskSë
, 
Ex¥Li°
 *
pLi°
){

797 
i
;

798 
Bômask
 
mask
 = 0;

799 if–
pLi°
 ){

800 
i
=0; i<
pLi°
->
nEx¥
; i++){

801 
mask
 |
	`ex¥TabÀUßge
(
pMaskSë
, 
pLi°
->
a
[
i
].
pEx¥
);

804  
mask
;

805 
	}
}

806 
Bômask
 
	$ex¥Sñe˘TabÀUßge
(
WhîeMaskSë
 *
pMaskSë
, 
Sñe˘
 *
pS
){

807 
Bômask
 
mask
 = 0;

808  
pS
 ){

809 
SrcLi°
 *
pSrc
 = 
pS
->pSrc;

810 
mask
 |
	`ex¥Li°TabÀUßge
(
pMaskSë
, 
pS
->
pELi°
);

811 
mask
 |
	`ex¥Li°TabÀUßge
(
pMaskSë
, 
pS
->
pGroupBy
);

812 
mask
 |
	`ex¥Li°TabÀUßge
(
pMaskSë
, 
pS
->
pOrdîBy
);

813 
mask
 |
	`ex¥TabÀUßge
(
pMaskSë
, 
pS
->
pWhîe
);

814 
mask
 |
	`ex¥TabÀUßge
(
pMaskSë
, 
pS
->
pHavög
);

815 if–
	`ALWAYS
(
pSrc
!=0) ){

816 
i
;

817 
i
=0; i<
pSrc
->
nSrc
; i++){

818 
mask
 |
	`ex¥Sñe˘TabÀUßge
(
pMaskSë
, 
pSrc
->
a
[
i
].
pSñe˘
);

819 
mask
 |
	`ex¥TabÀUßge
(
pMaskSë
, 
pSrc
->
a
[
i
].
pOn
);

822 
pS
 =ÖS->
pPri‹
;

824  
mask
;

825 
	}
}

839 
	$ÆlowedOp
(
›
){

840 
	`as£π
–
TK_GT
>
TK_EQ
 && TK_GT<
TK_GE
 );

841 
	`as£π
–
TK_LT
>
TK_EQ
 && TK_LT<
TK_GE
 );

842 
	`as£π
–
TK_LE
>
TK_EQ
 && TK_LE<
TK_GE
 );

843 
	`as£π
–
TK_GE
==
TK_EQ
+4 );

844  
›
==
TK_IN
 || (›>=
TK_EQ
 && op<=
TK_GE
Ë|| op==
TK_ISNULL
;

845 
	}
}

850 
	#SWAP
(
TYPE
,
A
,
B
Ë{TYPE 
t
=A; A=B; BÒ;}

	)

864 
	$ex¥Commuã
(
P¨£
 *
pP¨£
, 
Ex¥
 *
pEx¥
){

865 
u16
 
expRight
 = (
pEx¥
->
pRight
->
Êags
 & 
EP_ExpCﬁœã
);

866 
u16
 
expLe·
 = (
pEx¥
->
pLe·
->
Êags
 & 
EP_ExpCﬁœã
);

867 
	`as£π
–
	`ÆlowedOp
(
pEx¥
->
›
Ë&&ÖEx¥->›!=
TK_IN
 );

868 if–
expRight
==
expLe·
 ){

870 if–
expRight
 ){

873 
pEx¥
->
pRight
->
Êags
 &~
EP_ExpCﬁœã
;

874 }if–
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pEx¥
->
pLe·
)!=0 ){

878 
pEx¥
->
pLe·
->
Êags
 |
EP_ExpCﬁœã
;

881 
	`SWAP
(
Ex¥
*,
pEx¥
->
pRight
,pEx¥->
pLe·
);

882 if–
pEx¥
->
›
>=
TK_GT
 ){

883 
	`as£π
–
TK_LT
==
TK_GT
+2 );

884 
	`as£π
–
TK_GE
==
TK_LE
+2 );

885 
	`as£π
–
TK_GT
>
TK_EQ
 );

886 
	`as£π
–
TK_GT
<
TK_LE
 );

887 
	`as£π
–
pEx¥
->
›
>=
TK_GT
 &&ÖEx¥->›<=
TK_GE
 );

888 
pEx¥
->
›
 = (’Ex¥->›-
TK_GT
)^2)+TK_GT;

890 
	}
}

895 
u16
 
	$›î©‹Mask
(
›
){

896 
u16
 
c
;

897 
	`as£π
–
	`ÆlowedOp
(
›
) );

898 if–
›
==
TK_IN
 ){

899 
c
 = 
WO_IN
;

900 }if–
›
==
TK_ISNULL
 ){

901 
c
 = 
WO_ISNULL
;

903 
	`as£π
–(
WO_EQ
<<(
›
-
TK_EQ
)) < 0x7fff );

904 
c
 = (
u16
)(
WO_EQ
<<(
›
-
TK_EQ
));

906 
	`as£π
–
›
!=
TK_ISNULL
 || 
c
==
WO_ISNULL
 );

907 
	`as£π
–
›
!=
TK_IN
 || 
c
==
WO_IN
 );

908 
	`as£π
–
›
!=
TK_EQ
 || 
c
==
WO_EQ
 );

909 
	`as£π
–
›
!=
TK_LT
 || 
c
==
WO_LT
 );

910 
	`as£π
–
›
!=
TK_LE
 || 
c
==
WO_LE
 );

911 
	`as£π
–
›
!=
TK_GT
 || 
c
==
WO_GT
 );

912 
	`as£π
–
›
!=
TK_GE
 || 
c
==
WO_GE
 );

913  
c
;

914 
	}
}

921 
WhîeTîm
 *
	$whîeSˇnNext
(
WhîeSˇn
 *
pSˇn
){

922 
iCur
;

923 
iCﬁumn
;

924 
Ex¥
 *
pX
;

925 
WhîeCœu£
 *
pWC
;

926 
WhîeTîm
 *
pTîm
;

927 
k
 = 
pSˇn
->k;

929  
pSˇn
->
iEquiv
<ıSˇn->
nEquiv
 ){

930 
iCur
 = 
pSˇn
->
aEquiv
[pSˇn->
iEquiv
-2];

931 
iCﬁumn
 = 
pSˇn
->
aEquiv
[pSˇn->
iEquiv
-1];

932  (
pWC
 = 
pSˇn
->pWC)!=0 ){

933 
pTîm
=
pWC
->
a
+
k
; k<pWC->
nTîm
; k++,ÖTerm++){

934 if–
pTîm
->
À·Curs‹
==
iCur
 &&ÖTîm->
u
.
À·Cﬁumn
==
iCﬁumn
 ){

935 if–(
pTîm
->
eO≥øt‹
 & 
WO_EQUIV
)!=0

936 && 
pSˇn
->
nEquiv
<
	`AºaySize
’Sˇn->
aEquiv
)

938 
j
;

939 
pX
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pTîm
->
pEx¥
->
pRight
);

940 
	`as£π
–
pX
->
›
==
TK_COLUMN
 );

941 
j
=0; j<
pSˇn
->
nEquiv
; j+=2){

942 if–
pSˇn
->
aEquiv
[
j
]==
pX
->
iTabÀ


943 && 
pSˇn
->
aEquiv
[
j
+1]==
pX
->
iCﬁumn
 ){

947 if–
j
==
pSˇn
->
nEquiv
 ){

948 
pSˇn
->
aEquiv
[
j
] = 
pX
->
iTabÀ
;

949 
pSˇn
->
aEquiv
[
j
+1] = 
pX
->
iCﬁumn
;

950 
pSˇn
->
nEquiv
 += 2;

953 if–(
pTîm
->
eO≥øt‹
 & 
pSˇn
->
›Mask
)!=0 ){

955 if–
pSˇn
->
zCﬁlName
 && (
pTîm
->
eO≥øt‹
 & 
WO_ISNULL
)==0 ){

956 
CﬁlSeq
 *
pCﬁl
;

957 
P¨£
 *
pP¨£
 = 
pWC
->
pWInfo
->pParse;

958 
pX
 = 
pTîm
->
pEx¥
;

959 if–!
	`sqlôe4IndexAfföôyOk
(
pX
, 
pSˇn
->
idxaff
) ){

962 
	`as£π
(
pX
->
pLe·
);

963 
pCﬁl
 = 
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
pP¨£
,

964 
pX
->
pLe·
,ÖX->
pRight
);

965 if–
pCﬁl
==0 )ÖCﬁ»
pP¨£
->
db
->
pDÊtCﬁl
;

966 if–
	`sqlôe4_°ricmp
(
pCﬁl
->
zName
, 
pSˇn
->
zCﬁlName
) ){

970 if–(
pTîm
->
eO≥øt‹
 & 
WO_EQ
)!=0

971 && (
pX
 = 
pTîm
->
pEx¥
->
pRight
)->
›
==
TK_COLUMN


972 && 
pX
->
iTabÀ
==
pSˇn
->
aEquiv
[0]

973 && 
pX
->
iCﬁumn
==
pSˇn
->
aEquiv
[1]

977 
pSˇn
->
k
 = k+1;

978  
pTîm
;

982 
pSˇn
->
pWC
 =ÖSˇn->pWC->
pOuãr
;

983 
k
 = 0;

985 
pSˇn
->
pWC
 =ÖSˇn->
pOrigWC
;

986 
k
 = 0;

987 
pSˇn
->
iEquiv
 += 2;

990 
	}
}

1006 
	$idxCﬁumnNumbî
(
Index
 *
pIdx
, Index *
pPk
, 
iIdxCﬁ
){

1007 
iRë
 = -2;

1008 if–
iIdxCﬁ
<
pIdx
->
nCﬁumn
 ){

1009 
iRë
 = 
pIdx
->
aiCﬁumn
[
iIdxCﬁ
];

1010 }if–
pPk
 && 
iIdxCﬁ
<(
pIdx
->
nCﬁumn
 +ÖPk->nColumn) ){

1011 
iRë
 = 
pPk
->
aiCﬁumn
[
iIdxCﬁ
 - 
pIdx
->
nCﬁumn
];

1013  
iRë
;

1014 
	}
}

1021 *
	$idxCﬁumnCﬁœti⁄
(
Index
 *
pIdx
, Index *
pPk
, 
iIdxCﬁ
){

1022 *
zCﬁl
;

1023 
	`as£π
–
iIdxCﬁ
<(
pIdx
->
nCﬁumn
 + 
pPk
->nColumn) );

1024 if–
iIdxCﬁ
<
pIdx
->
nCﬁumn
 ){

1025 
zCﬁl
 = 
pIdx
->
azCﬁl
[
iIdxCﬁ
];

1026 }if–
pPk
 && 
iIdxCﬁ
<(
pIdx
->
nCﬁumn
 +ÖPk->nColumn) ){

1027 
zCﬁl
 = 
pPk
->
azCﬁl
[
iIdxCﬁ
 - 
pIdx
->
nCﬁumn
];

1029  
zCﬁl
;

1030 
	}
}

1036 
	$idxCﬁumnS‹tOrdî
(
Index
 *
pIdx
, Index *
pPk
, 
iIdxCﬁ
){

1037 
iRë
 = 
SQLITE4_SO_ASC
;

1038 if–
iIdxCﬁ
<
pIdx
->
nCﬁumn
 ){

1039 
iRë
 = 
pIdx
->
aS‹tOrdî
[
iIdxCﬁ
];

1041  
iRë
;

1042 
	}
}

1048 
	$idxCﬁumnCou¡
(
Index
 *
pIdx
, Index *
pPk
){

1049  (
pIdx
->
nCﬁumn
 + ((
pPk
==0 ||ÖIdx==pPk) ? 0 :ÖPk->nColumn));

1050 
	}
}

1068 
WhîeTîm
 *
	$whîeSˇnInô
(

1069 
WhîeSˇn
 *
pSˇn
,

1070 
WhîeCœu£
 *
pWC
,

1071 
iCur
,

1072 
iCﬁumn
,

1073 
u32
 
›Mask
,

1074 
Index
 *
pIdx


1076 
j
;

1079 
pSˇn
->
pOrigWC
 = 
pWC
;

1080 
pSˇn
->
pWC
 =ÖWC;

1081 if–
pIdx
 && 
iCﬁumn
>=0 ){

1082 
Index
 *
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pIdx
->
pTabÀ
, 0);

1083 
pSˇn
->
idxaff
 = 
pIdx
->
pTabÀ
->
aCﬁ
[
iCﬁumn
].
afföôy
;

1084 
j
=0; 
	`idxCﬁumnNumbî
(
pIdx
, 
pPk
, j)!=
iCﬁumn
; j++){

1085 if–
	`NEVER
(
j
>=
	`idxCﬁumnCou¡
(
pIdx
, 
pPk
)) )  0;

1087 
pSˇn
->
zCﬁlName
 = 
	`idxCﬁumnCﬁœti⁄
(
pIdx
, 
pPk
, 
j
);

1089 
pSˇn
->
idxaff
 = 0;

1090 
pSˇn
->
zCﬁlName
 = 0;

1092 
pSˇn
->
›Mask
 = opMask;

1093 
pSˇn
->
k
 = 0;

1094 
pSˇn
->
aEquiv
[0] = 
iCur
;

1095 
pSˇn
->
aEquiv
[1] = 
iCﬁumn
;

1096 
pSˇn
->
nEquiv
 = 2;

1097 
pSˇn
->
iEquiv
 = 2;

1098  
	`whîeSˇnNext
(
pSˇn
);

1099 
	}
}

1124 
WhîeTîm
 *
	$födTîm
(

1125 
WhîeCœu£
 *
pWC
,

1126 
iCur
,

1127 
iCﬁumn
,

1128 
Bômask
 
nŸRódy
,

1129 
u32
 
›
,

1130 
Index
 *
pIdx


1132 
WhîeTîm
 *
pResu…
 = 0;

1133 
WhîeTîm
 *
p
;

1134 
WhîeSˇn
 
sˇn
;

1136 
p
 = 
	`whîeSˇnInô
(&
sˇn
, 
pWC
, 
iCur
, 
iCﬁumn
, 
›
, 
pIdx
);

1137  
p
 ){

1138 if–(
p
->
¥îeqRight
 & 
nŸRódy
)==0 ){

1139 if–
p
->
¥îeqRight
==0 && (p->
eO≥øt‹
&
WO_EQ
)!=0 ){

1140  
p
;

1142 if–
pResu…
==0 )ÖResu… = 
p
;

1144 
p
 = 
	`whîeSˇnNext
(&
sˇn
);

1146  
pResu…
;

1147 
	}
}

1150 
ex¥A«lyze
(
SrcLi°
*, 
WhîeCœu£
*, );

1155 
	$ex¥A«lyzeAŒ
(

1156 
SrcLi°
 *
pTabLi°
,

1157 
WhîeCœu£
 *
pWC


1159 
i
;

1160 
i
=
pWC
->
nTîm
-1; i>=0; i--){

1161 
	`ex¥A«lyze
(
pTabLi°
, 
pWC
, 
i
);

1163 
	}
}

1165 #i‚de‡
SQLITE4_OMIT_LIKE_OPTIMIZATION


1174 
	$isLikeOrGlob
(

1175 
P¨£
 *
pP¨£
,

1176 
Ex¥
 *
pEx¥
,

1177 
Ex¥
 **
µPªfix
,

1178 *
pisCom∂ëe
,

1179 *
≤oCa£


1181 c⁄° *
z
 = 0;

1182 
Ex¥
 *
pRight
, *
pLe·
;

1183 
Ex¥Li°
 *
pLi°
;

1184 
c
;

1185 
˙t
;

1186 
wc
[3];

1187 
sqlôe4
 *
db
 = 
pP¨£
->db;

1188 
sqlôe4_vÆue
 *
pVÆ
 = 0;

1189 
›
;

1191 if–!
	`sqlôe4IsLikeFun˘i⁄
(
db
, 
pEx¥
, 
≤oCa£
, 
wc
) ){

1194 #ifde‡
SQLITE4_EBCDIC


1195 if–*
≤oCa£
 )  0;

1197 
pLi°
 = 
pEx¥
->
x
.pList;

1198 
pLe·
 = 
pLi°
->
a
[1].
pEx¥
;

1199 if–
pLe·
->
›
!=
TK_COLUMN


1200 || 
	`sqlôe4Ex¥Afföôy
(
pLe·
)!=
SQLITE4_AFF_TEXT


1201 || 
	`IsVútuÆ
(
pLe·
->
pTab
)

1207 
	`as£π
–
pLe·
->
iCﬁumn
!=(-1) );

1209 
pRight
 = 
pLi°
->
a
[0].
pEx¥
;

1210 
›
 = 
pRight
->op;

1211 if–
›
==
TK_REGISTER
 ){

1212 
›
 = 
pRight
->
›2
;

1214 if–
›
==
TK_VARIABLE
 ){

1215 
Vdbe
 *
pRïª∑ª
 = 
pP¨£
->pReprepare;

1216 
iCﬁ
 = 
pRight
->
iCﬁumn
;

1217 
pVÆ
 = 
	`sqlôe4VdbeGëVÆue
(
pRïª∑ª
, 
iCﬁ
, 
SQLITE4_AFF_NONE
);

1218 if–
pVÆ
 && 
	`sqlôe4_vÆue_ty≥
’VÆ)==
SQLITE4_TEXT
 ){

1219 
z
 = (*)
	`sqlôe4_vÆue_ãxt
(
pVÆ
, 0);

1221 
	`sqlôe4VdbeSëV¨mask
(
pP¨£
->
pVdbe
, 
iCﬁ
);

1222 
	`as£π
–
pRight
->
›
==
TK_VARIABLE
 ||ÖRight->›==
TK_REGISTER
 );

1223 }if–
›
==
TK_STRING
 ){

1224 
z
 = 
pRight
->
u
.
zTokí
;

1226 if–
z
 ){

1227 
˙t
 = 0;

1228  (
c
=
z
[
˙t
])!=0 && c!=
wc
[0] && c!=wc[1] && c!=wc[2] ){

1229 
˙t
++;

1231 if–
˙t
!=0 && 255!=(
u8
)
z
[cnt-1] ){

1232 
Ex¥
 *
pPªfix
;

1233 *
pisCom∂ëe
 = 
c
==
wc
[0] && 
z
[
˙t
+1]==0;

1234 
pPªfix
 = 
	`sqlôe4Ex¥
(
db
, 
TK_STRING
, 
z
);

1235 if–
pPªfix
 )ÖPªfix->
u
.
zTokí
[
˙t
] = 0;

1236 *
µPªfix
 = 
pPªfix
;

1237 if–
›
==
TK_VARIABLE
 ){

1238 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

1239 
	`sqlôe4VdbeSëV¨mask
(
v
, 
pRight
->
iCﬁumn
);

1240 if–*
pisCom∂ëe
 && 
pRight
->
u
.
zTokí
[1] ){

1247 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

1248 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pRight
, 
r1
);

1249 
	`sqlôe4VdbeCh™geP3
(
v
, 
	`sqlôe4VdbeCuºítAddr
(v)-1, 0);

1250 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

1254 
z
 = 0;

1258 
	`sqlôe4VÆueFªe
(
pVÆ
);

1259  (
z
!=0);

1260 
	}
}

1264 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1272 
	$isM©chOfCﬁumn
(

1273 
Ex¥
 *
pEx¥


1275 
Ex¥Li°
 *
pLi°
;

1277 if–
pEx¥
->
›
!=
TK_FUNCTION
 ){

1280 if–
	`sqlôe4_°ricmp
(
pEx¥
->
u
.
zTokí
,"match")!=0 ){

1283 
pLi°
 = 
pEx¥
->
x
.pList;

1284 if–
pLi°
->
nEx¥
!=2 ){

1287 if–
pLi°
->
a
[1].
pEx¥
->
›
 !
TK_COLUMN
 ){

1291 
	}
}

1298 
	$å™s„rJoöM¨kögs
(
Ex¥
 *
pDîived
, Ex¥ *
pBa£
){

1299 
pDîived
->
Êags
 |
pBa£
->Êag†& 
EP_FromJoö
;

1300 
pDîived
->
iRightJoöTabÀ
 = 
pBa£
->iRightJoinTable;

1301 
	}
}

1303 #i‡!
deföed
(
SQLITE4_OMIT_OR_OPTIMIZATION
Ë&& !deföed(
SQLITE4_OMIT_SUBQUERY
)

1380 
	$ex¥A«lyzeOrTîm
(

1381 
SrcLi°
 *
pSrc
,

1382 
WhîeCœu£
 *
pWC
,

1383 
idxTîm


1385 
WhîeInfo
 *
pWInfo
 = 
pWC
->pWInfo;

1386 
P¨£
 *
pP¨£
 = 
pWInfo
->pParse;

1387 
sqlôe4
 *
db
 = 
pP¨£
->db;

1388 
WhîeTîm
 *
pTîm
 = &
pWC
->
a
[
idxTîm
];

1389 
Ex¥
 *
pEx¥
 = 
pTîm
->pExpr;

1390 
i
;

1391 
WhîeCœu£
 *
pOrWc
;

1392 
WhîeTîm
 *
pOrTîm
;

1393 
WhîeOrInfo
 *
pOrInfo
;

1394 
Bômask
 
chngToIN
;

1395 
Bômask
 
ödexabÀ
;

1402 
	`as£π
–(
pTîm
->
wtFœgs
 & (
TERM_DYNAMIC
|
TERM_ORINFO
|
TERM_ANDINFO
))==0 );

1403 
	`as£π
–
pEx¥
->
›
==
TK_OR
 );

1404 
pTîm
->
u
.
pOrInfo
 =ÖOrInfÿ
	`sqlôe4DbMÆlocZîo
(
db
, (*pOrInfo));

1405 if–
pOrInfo
==0 ) ;

1406 
pTîm
->
wtFœgs
 |
TERM_ORINFO
;

1407 
pOrWc
 = &
pOrInfo
->
wc
;

1408 
	`whîeCœu£Inô
(
pOrWc
, 
pWInfo
);

1409 
	`whîeS∂ô
(
pOrWc
, 
pEx¥
, 
TK_OR
);

1410 
	`ex¥A«lyzeAŒ
(
pSrc
, 
pOrWc
);

1411 if–
db
->
mÆlocFaûed
 ) ;

1412 
	`as£π
–
pOrWc
->
nTîm
>=2 );

1417 
ödexabÀ
 = ~(
Bômask
)0;

1418 
chngToIN
 = ~(
Bômask
)0;

1419 
i
=
pOrWc
->
nTîm
-1, 
pOrTîm
ıOrWc->
a
; i>=0 && 
ödexabÀ
; i--,ÖOrTerm++){

1420 if–(
pOrTîm
->
eO≥øt‹
 & 
WO_SINGLE
)==0 ){

1421 
WhîeAndInfo
 *
pAndInfo
;

1422 
	`as£π
–(
pOrTîm
->
wtFœgs
 & (
TERM_ANDINFO
|
TERM_ORINFO
))==0 );

1423 
chngToIN
 = 0;

1424 
pAndInfo
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (*pAndInfo));

1425 if–
pAndInfo
 ){

1426 
WhîeCœu£
 *
pAndWC
;

1427 
WhîeTîm
 *
pAndTîm
;

1428 
j
;

1429 
Bômask
 
b
 = 0;

1430 
pOrTîm
->
u
.
pAndInfo
 =ÖAndInfo;

1431 
pOrTîm
->
wtFœgs
 |
TERM_ANDINFO
;

1432 
pOrTîm
->
eO≥øt‹
 = 
WO_AND
;

1433 
pAndWC
 = &
pAndInfo
->
wc
;

1434 
	`whîeCœu£Inô
(
pAndWC
, 
pWC
->
pWInfo
);

1435 
	`whîeS∂ô
(
pAndWC
, 
pOrTîm
->
pEx¥
, 
TK_AND
);

1436 
	`ex¥A«lyzeAŒ
(
pSrc
, 
pAndWC
);

1437 
pAndWC
->
pOuãr
 = 
pWC
;

1438 
	`ã°ˇ£
–
db
->
mÆlocFaûed
 );

1439 if–!
db
->
mÆlocFaûed
 ){

1440 
j
=0, 
pAndTîm
=
pAndWC
->
a
; j<pAndWC->
nTîm
; j++,ÖAndTerm++){

1441 
	`as£π
–
pAndTîm
->
pEx¥
 );

1442 if–
	`ÆlowedOp
(
pAndTîm
->
pEx¥
->
›
) ){

1443 
b
 |
	`gëMask
(&
pWInfo
->
sMaskSë
, 
pAndTîm
->
À·Curs‹
);

1447 
ödexabÀ
 &
b
;

1449 }if–
pOrTîm
->
wtFœgs
 & 
TERM_COPIED
 ){

1453 
Bômask
 
b
;

1454 
b
 = 
	`gëMask
(&
pWInfo
->
sMaskSë
, 
pOrTîm
->
À·Curs‹
);

1455 if–
pOrTîm
->
wtFœgs
 & 
TERM_VIRTUAL
 ){

1456 
WhîeTîm
 *
pOthî
 = &
pOrWc
->
a
[
pOrTîm
->
iP¨ít
];

1457 
b
 |
	`gëMask
(&
pWInfo
->
sMaskSë
, 
pOthî
->
À·Curs‹
);

1459 
ödexabÀ
 &
b
;

1460 if–(
pOrTîm
->
eO≥øt‹
 & 
WO_EQ
)==0 ){

1461 
chngToIN
 = 0;

1463 
chngToIN
 &
b
;

1472 
pOrInfo
->
ödexabÀ
 = indexable;

1473 
pTîm
->
eO≥øt‹
 = 
ödexabÀ
==0 ? 0 : 
WO_OR
;

1496 if–
chngToIN
 ){

1497 
okToChngToIN
 = 0;

1498 
iCﬁumn
 = -1;

1499 
iCurs‹
 = -1;

1500 
j
 = 0;

1508 
j
=0; j<2 && !
okToChngToIN
; j++){

1509 
pOrTîm
 = 
pOrWc
->
a
;

1510 
i
=
pOrWc
->
nTîm
-1; i>=0; i--, 
pOrTîm
++){

1511 
	`as£π
–
pOrTîm
->
eO≥øt‹
 & 
WO_EQ
 );

1512 
pOrTîm
->
wtFœgs
 &~
TERM_OR_OK
;

1513 if–
pOrTîm
->
À·Curs‹
==
iCurs‹
 ){

1516 
	`as£π
–
j
==1 );

1519 if–(
chngToIN
 & 
	`gëMask
(&
pWInfo
->
sMaskSë
, 
pOrTîm
->
À·Curs‹
))==0 ){

1524 
	`ã°ˇ£
–
pOrTîm
->
wtFœgs
 & 
TERM_COPIED
 );

1525 
	`ã°ˇ£
–
pOrTîm
->
wtFœgs
 & 
TERM_VIRTUAL
 );

1526 
	`as£π
–
pOrTîm
->
wtFœgs
 & (
TERM_COPIED
|
TERM_VIRTUAL
) );

1529 
iCﬁumn
 = 
pOrTîm
->
u
.
À·Cﬁumn
;

1530 
iCurs‹
 = 
pOrTîm
->
À·Curs‹
;

1533 if–
i
<0 ){

1536 
	`as£π
–
j
==1 );

1537 
	`as£π
–
	`IsPowîOfTwo
(
chngToIN
) );

1538 
	`as£π
–
chngToIN
==
	`gëMask
(&
pWInfo
->
sMaskSë
, 
iCurs‹
) );

1541 
	`ã°ˇ£
–
j
==1 );

1545 
okToChngToIN
 = 1;

1546 ; 
i
>=0 && 
okToChngToIN
; i--, 
pOrTîm
++){

1547 
	`as£π
–
pOrTîm
->
eO≥øt‹
 & 
WO_EQ
 );

1548 if–
pOrTîm
->
À·Curs‹
!=
iCurs‹
 ){

1549 
pOrTîm
->
wtFœgs
 &~
TERM_OR_OK
;

1550 }if–
pOrTîm
->
u
.
À·Cﬁumn
!=
iCﬁumn
 ){

1551 
okToChngToIN
 = 0;

1553 
affLe·
, 
affRight
;

1558 
affRight
 = 
	`sqlôe4Ex¥Afföôy
(
pOrTîm
->
pEx¥
->
pRight
);

1559 
affLe·
 = 
	`sqlôe4Ex¥Afföôy
(
pOrTîm
->
pEx¥
->
pLe·
);

1560 if–
affRight
!=0 &&áffRight!=
affLe·
 ){

1561 
okToChngToIN
 = 0;

1563 
pOrTîm
->
wtFœgs
 |
TERM_OR_OK
;

1575 if–
okToChngToIN
 ){

1576 
Ex¥
 *
pDup
;

1577 
Ex¥Li°
 *
pLi°
 = 0;

1578 
Ex¥
 *
pLe·
 = 0;

1579 
Ex¥
 *
pNew
;

1581 
i
=
pOrWc
->
nTîm
-1, 
pOrTîm
ıOrWc->
a
; i>=0; i--,ÖOrTerm++){

1582 if–(
pOrTîm
->
wtFœgs
 & 
TERM_OR_OK
)==0 ) ;

1583 
	`as£π
–
pOrTîm
->
eO≥øt‹
 & 
WO_EQ
 );

1584 
	`as£π
–
pOrTîm
->
À·Curs‹
==
iCurs‹
 );

1585 
	`as£π
–
pOrTîm
->
u
.
À·Cﬁumn
==
iCﬁumn
 );

1586 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pOrTîm
->
pEx¥
->
pRight
, 0);

1587 
pLi°
 = 
	`sqlôe4Ex¥Li°Aµíd
(
pWInfo
->
pP¨£
,ÖLi°, 
pDup
);

1588 
pLe·
 = 
pOrTîm
->
pEx¥
->pLeft;

1590 
	`as£π
–
pLe·
!=0 );

1591 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pLe·
, 0);

1592 
pNew
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_IN
, 
pDup
, 0, 0);

1593 if–
pNew
 ){

1594 
idxNew
;

1595 
	`å™s„rJoöM¨kögs
(
pNew
, 
pEx¥
);

1596 
	`as£π
–!
	`Ex¥HasPr›îty
(
pNew
, 
EP_xIsSñe˘
) );

1597 
pNew
->
x
.
pLi°
 =ÖList;

1598 
idxNew
 = 
	`whîeCœu£In£π
(
pWC
, 
pNew
, 
TERM_VIRTUAL
|
TERM_DYNAMIC
);

1599 
	`ã°ˇ£
–
idxNew
==0 );

1600 
	`ex¥A«lyze
(
pSrc
, 
pWC
, 
idxNew
);

1601 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1602 
pWC
->
a
[
idxNew
].
iP¨ít
 = 
idxTîm
;

1603 
pTîm
->
nChûd
 = 1;

1605 
	`sqlôe4Ex¥Li°Dñëe
(
db
, 
pLi°
);

1607 
pTîm
->
eO≥øt‹
 = 
WO_NOOP
;

1610 
	}
}

1631 
	$ex¥A«lyze
(

1632 
SrcLi°
 *
pSrc
,

1633 
WhîeCœu£
 *
pWC
,

1634 
idxTîm


1636 
WhîeInfo
 *
pWInfo
 = 
pWC
->pWInfo;

1637 
WhîeTîm
 *
pTîm
;

1638 
WhîeMaskSë
 *
pMaskSë
;

1639 
Ex¥
 *
pEx¥
;

1640 
Bômask
 
¥îeqLe·
;

1641 
Bômask
 
¥îeqAŒ
;

1642 
Bômask
 
exåaRight
 = 0;

1643 
Ex¥
 *
pSå1
 = 0;

1644 
isCom∂ëe
 = 0;

1645 
noCa£
 = 0;

1646 
›
;

1647 
P¨£
 *
pP¨£
 = 
pWInfo
->pParse;

1648 
sqlôe4
 *
db
 = 
pP¨£
->db;

1650 if–
db
->
mÆlocFaûed
 ){

1653 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1654 
pMaskSë
 = &
pWInfo
->
sMaskSë
;

1655 
pEx¥
 = 
pTîm
->pExpr;

1656 
	`as£π
–
pEx¥
->
›
!=
TK_AS
 &&ÖEx¥->›!=
TK_COLLATE
 );

1657 
¥îeqLe·
 = 
	`ex¥TabÀUßge
(
pMaskSë
, 
pEx¥
->
pLe·
);

1658 
›
 = 
pEx¥
->op;

1659 if–
›
==
TK_IN
 ){

1660 
	`as£π
–
pEx¥
->
pRight
==0 );

1661 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

1662 
pTîm
->
¥îeqRight
 = 
	`ex¥Sñe˘TabÀUßge
(
pMaskSë
, 
pEx¥
->
x
.
pSñe˘
);

1664 
pTîm
->
¥îeqRight
 = 
	`ex¥Li°TabÀUßge
(
pMaskSë
, 
pEx¥
->
x
.
pLi°
);

1666 }if–
›
==
TK_ISNULL
 ){

1667 
pTîm
->
¥îeqRight
 = 0;

1669 
pTîm
->
¥îeqRight
 = 
	`ex¥TabÀUßge
(
pMaskSë
, 
pEx¥
->
pRight
);

1671 
¥îeqAŒ
 = 
	`ex¥TabÀUßge
(
pMaskSë
, 
pEx¥
);

1672 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_FromJoö
) ){

1673 
Bômask
 
x
 = 
	`gëMask
(
pMaskSë
, 
pEx¥
->
iRightJoöTabÀ
);

1674 
¥îeqAŒ
 |
x
;

1675 
exåaRight
 = 
x
-1;

1678 
pTîm
->
¥îeqAŒ
 =ÖrereqAll;

1679 
pTîm
->
À·Curs‹
 = -1;

1680 
pTîm
->
iP¨ít
 = -1;

1681 
pTîm
->
eO≥øt‹
 = 0;

1682 if–
	`ÆlowedOp
(
›
) ){

1683 
Ex¥
 *
pLe·
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pEx¥
->pLeft);

1684 
Ex¥
 *
pRight
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pEx¥
->pRight);

1685 
u16
 
›Mask
 = (
pTîm
->
¥îeqRight
 & 
¥îeqLe·
)==0 ? 
WO_ALL
 : 
WO_EQUIV
;

1686 if–
pLe·
->
›
==
TK_COLUMN
 ){

1687 
pTîm
->
À·Curs‹
 = 
pLe·
->
iTabÀ
;

1688 
pTîm
->
u
.
À·Cﬁumn
 = 
pLe·
->
iCﬁumn
;

1689 
pTîm
->
eO≥øt‹
 = 
	`›î©‹Mask
(
›
Ë& 
›Mask
;

1691 if–
pRight
 &&ÖRight->
›
==
TK_COLUMN
 ){

1692 
WhîeTîm
 *
pNew
;

1693 
Ex¥
 *
pDup
;

1694 
u16
 
eExåaOp
 = 0;

1695 if–
pTîm
->
À·Curs‹
>=0 ){

1696 
idxNew
;

1697 
pDup
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pEx¥
, 0);

1698 if–
db
->
mÆlocFaûed
 ){

1699 
	`sqlôe4Ex¥Dñëe
(
db
, 
pDup
);

1702 
idxNew
 = 
	`whîeCœu£In£π
(
pWC
, 
pDup
, 
TERM_VIRTUAL
|
TERM_DYNAMIC
);

1703 if–
idxNew
==0 ) ;

1704 
pNew
 = &
pWC
->
a
[
idxNew
];

1705 
pNew
->
iP¨ít
 = 
idxTîm
;

1706 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1707 
pTîm
->
nChûd
 = 1;

1708 
pTîm
->
wtFœgs
 |
TERM_COPIED
;

1709 if–
pEx¥
->
›
==
TK_EQ


1710 && !
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_FromJoö
)

1711 && 
	`O±imiz©i⁄E«bÀd
(
db
, 
SQLITE4_Tønsôive
)

1713 
pTîm
->
eO≥øt‹
 |
WO_EQUIV
;

1714 
eExåaOp
 = 
WO_EQUIV
;

1717 
pDup
 = 
pEx¥
;

1718 
pNew
 = 
pTîm
;

1720 
	`ex¥Commuã
(
pP¨£
, 
pDup
);

1721 
pLe·
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pDup
->pLeft);

1722 
pNew
->
À·Curs‹
 = 
pLe·
->
iTabÀ
;

1723 
pNew
->
u
.
À·Cﬁumn
 = 
pLe·
->
iCﬁumn
;

1724 
	`ã°ˇ£
–(
¥îeqLe·
 | 
exåaRight
) !=ÖrereqLeft );

1725 
pNew
->
¥îeqRight
 = 
¥îeqLe·
 | 
exåaRight
;

1726 
pNew
->
¥îeqAŒ
 =ÖrereqAll;

1727 
pNew
->
eO≥øt‹
 = (
	`›î©‹Mask
(
pDup
->
›
Ë+ 
eExåaOp
Ë& 
›Mask
;

1731 #i‚de‡
SQLITE4_OMIT_BETWEEN_OPTIMIZATION


1747 if–
pEx¥
->
›
==
TK_BETWEEN
 && 
pWC
->›==
TK_AND
 ){

1748 
Ex¥Li°
 *
pLi°
 = 
pEx¥
->
x
.pList;

1749 
i
;

1750 c⁄° 
u8
 
›s
[] = {
TK_GE
, 
TK_LE
};

1751 
	`as£π
–
pLi°
!=0 );

1752 
	`as£π
–
pLi°
->
nEx¥
==2 );

1753 
i
=0; i<2; i++){

1754 
Ex¥
 *
pNewEx¥
;

1755 
idxNew
;

1756 
pNewEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
›s
[
i
],

1757 
	`sqlôe4Ex¥Dup
(
db
, 
pEx¥
->
pLe·
, 0),

1758 
	`sqlôe4Ex¥Dup
(
db
, 
pLi°
->
a
[
i
].
pEx¥
, 0), 0);

1759 
idxNew
 = 
	`whîeCœu£In£π
(
pWC
, 
pNewEx¥
, 
TERM_VIRTUAL
|
TERM_DYNAMIC
);

1760 
	`ã°ˇ£
–
idxNew
==0 );

1761 
	`ex¥A«lyze
(
pSrc
, 
pWC
, 
idxNew
);

1762 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1763 
pWC
->
a
[
idxNew
].
iP¨ít
 = 
idxTîm
;

1765 
pTîm
->
nChûd
 = 2;

1769 #i‡!
	`deföed
(
SQLITE4_OMIT_OR_OPTIMIZATION
Ë&& !deföed(
SQLITE4_OMIT_SUBQUERY
)

1773 if–
pEx¥
->
›
==
TK_OR
 ){

1774 
	`as£π
–
pWC
->
›
==
TK_AND
 );

1775 
	`ex¥A«lyzeOrTîm
(
pSrc
, 
pWC
, 
idxTîm
);

1776 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1780 #i‚de‡
SQLITE4_OMIT_LIKE_OPTIMIZATION


1791 if–
pWC
->
›
==
TK_AND


1792 && 
	`isLikeOrGlob
(
pP¨£
, 
pEx¥
, &
pSå1
, &
isCom∂ëe
, &
noCa£
)

1794 
Ex¥
 *
pLe·
;

1795 
Ex¥
 *
pSå2
;

1796 
Ex¥
 *
pNewEx¥1
;

1797 
Ex¥
 *
pNewEx¥2
;

1798 
idxNew1
;

1799 
idxNew2
;

1800 
Tokí
 
sCﬁlSeqName
;

1802 
pLe·
 = 
pEx¥
->
x
.
pLi°
->
a
[1].pExpr;

1803 
pSå2
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pSå1
, 0);

1804 if–!
db
->
mÆlocFaûed
 ){

1805 
u8
 
c
, *
pC
;

1806 
pC
 = (
u8
*)&
pSå2
->
u
.
zTokí
[
	`sqlôe4SåÀn30
(pStr2->u.zToken)-1];

1807 
c
 = *
pC
;

1808 if–
noCa£
 ){

1815 if–
c
=='A'-1 ) 
isCom∂ëe
 = 0;

1818 
c
 = 
sqlôe4UµîToLowî
[c];

1820 *
pC
 = 
c
 + 1;

1822 
sCﬁlSeqName
.
z
 = 
noCa£
 ? "NOCASE" : "BINARY";

1823 
sCﬁlSeqName
.
n
 = 6;

1824 
pNewEx¥1
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pLe·
, 0);

1825 
	`sqlôe4Ex¥SëCﬁlByTokí
(
pP¨£
, 
pNewEx¥1
, &
sCﬁlSeqName
);

1826 
pNewEx¥1
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_GE
,ÖNewEx¥1, 
pSå1
, 0);

1827 
idxNew1
 = 
	`whîeCœu£In£π
(
pWC
, 
pNewEx¥1
, 
TERM_VIRTUAL
|
TERM_DYNAMIC
);

1828 
	`ã°ˇ£
–
idxNew1
==0 );

1829 
	`ex¥A«lyze
(
pSrc
, 
pWC
, 
idxNew1
);

1830 
pNewEx¥2
 = 
	`sqlôe4Ex¥Dup
(
db
, 
pLe·
, 0);

1831 
	`sqlôe4Ex¥SëCﬁlByTokí
(
pP¨£
, 
pNewEx¥2
, &
sCﬁlSeqName
);

1832 
pNewEx¥2
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_LT
,ÖNewEx¥2, 
pSå2
, 0);

1833 
idxNew2
 = 
	`whîeCœu£In£π
(
pWC
, 
pNewEx¥2
, 
TERM_VIRTUAL
|
TERM_DYNAMIC
);

1834 
	`ã°ˇ£
–
idxNew2
==0 );

1835 
	`ex¥A«lyze
(
pSrc
, 
pWC
, 
idxNew2
);

1836 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1837 if–
isCom∂ëe
 ){

1838 
pWC
->
a
[
idxNew1
].
iP¨ít
 = 
idxTîm
;

1839 
pWC
->
a
[
idxNew2
].
iP¨ít
 = 
idxTîm
;

1840 
pTîm
->
nChûd
 = 2;

1845 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


1852 if–
	`isM©chOfCﬁumn
(
pEx¥
) ){

1853 
idxNew
;

1854 
Ex¥
 *
pRight
, *
pLe·
;

1855 
WhîeTîm
 *
pNewTîm
;

1856 
Bômask
 
¥îeqCﬁumn
, 
¥îeqEx¥
;

1858 
pRight
 = 
pEx¥
->
x
.
pLi°
->
a
[0].pExpr;

1859 
pLe·
 = 
pEx¥
->
x
.
pLi°
->
a
[1].pExpr;

1860 
¥îeqEx¥
 = 
	`ex¥TabÀUßge
(
pMaskSë
, 
pRight
);

1861 
¥îeqCﬁumn
 = 
	`ex¥TabÀUßge
(
pMaskSë
, 
pLe·
);

1862 if–(
¥îeqEx¥
 & 
¥îeqCﬁumn
)==0 ){

1863 
Ex¥
 *
pNewEx¥
;

1864 
pNewEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_MATCH
,

1865 0, 
	`sqlôe4Ex¥Dup
(
db
, 
pRight
, 0), 0);

1866 
idxNew
 = 
	`whîeCœu£In£π
(
pWC
, 
pNewEx¥
, 
TERM_VIRTUAL
|
TERM_DYNAMIC
);

1867 
	`ã°ˇ£
–
idxNew
==0 );

1868 
pNewTîm
 = &
pWC
->
a
[
idxNew
];

1869 
pNewTîm
->
¥îeqRight
 = 
¥îeqEx¥
;

1870 
pNewTîm
->
À·Curs‹
 = 
pLe·
->
iTabÀ
;

1871 
pNewTîm
->
u
.
À·Cﬁumn
 = 
pLe·
->
iCﬁumn
;

1872 
pNewTîm
->
eO≥øt‹
 = 
WO_MATCH
;

1873 
pNewTîm
->
iP¨ít
 = 
idxTîm
;

1874 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1875 
pTîm
->
nChûd
 = 1;

1876 
pTîm
->
wtFœgs
 |
TERM_COPIED
;

1877 
pNewTîm
->
¥îeqAŒ
 = 
pTîm
->prereqAll;

1882 #ifde‡
SQLITE4_ENABLE_STAT3


1893 if–
pEx¥
->
›
==
TK_NOTNULL


1894 && 
pEx¥
->
pLe·
->
›
==
TK_COLUMN


1895 && 
pEx¥
->
pLe·
->
iCﬁumn
>=0

1896 && 
	`O±imiz©i⁄E«bÀd
(
db
, 
SQLITE4_Sèt3
)

1898 
Ex¥
 *
pNewEx¥
;

1899 
Ex¥
 *
pLe·
 = 
pEx¥
->pLeft;

1900 
idxNew
;

1901 
WhîeTîm
 *
pNewTîm
;

1903 
pNewEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_GT
,

1904 
	`sqlôe4Ex¥Dup
(
db
, 
pLe·
, 0),

1905 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_NULL
, 0, 0, 0), 0);

1907 
idxNew
 = 
	`whîeCœu£In£π
(
pWC
, 
pNewEx¥
,

1908 
TERM_VIRTUAL
|
TERM_DYNAMIC
|
TERM_VNULL
);

1909 if–
idxNew
 ){

1910 
pNewTîm
 = &
pWC
->
a
[
idxNew
];

1911 
pNewTîm
->
¥îeqRight
 = 0;

1912 
pNewTîm
->
À·Curs‹
 = 
pLe·
->
iTabÀ
;

1913 
pNewTîm
->
u
.
À·Cﬁumn
 = 
pLe·
->
iCﬁumn
;

1914 
pNewTîm
->
eO≥øt‹
 = 
WO_GT
;

1915 
pNewTîm
->
iP¨ít
 = 
idxTîm
;

1916 
pTîm
 = &
pWC
->
a
[
idxTîm
];

1917 
pTîm
->
nChûd
 = 1;

1918 
pTîm
->
wtFœgs
 |
TERM_COPIED
;

1919 
pNewTîm
->
¥îeqAŒ
 = 
pTîm
->prereqAll;

1927 
pTîm
->
¥îeqRight
 |
exåaRight
;

1928 
	}
}

1937 
	$födIndexCﬁ
(

1938 
P¨£
 *
pP¨£
,

1939 
Ex¥Li°
 *
pLi°
,

1940 
iBa£
,

1941 
Index
 *
pIdx
,

1942 
iCﬁ


1944 
i
;

1945 c⁄° *
zCﬁl
 = 
pIdx
->
azCﬁl
[
iCﬁ
];

1947 
i
=0; i<
pLi°
->
nEx¥
; i++){

1948 
Ex¥
 *
p
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pLi°
->
a
[
i
].
pEx¥
);

1949 if–
p
->
›
==
TK_COLUMN


1950 && 
p
->
iCﬁumn
==
pIdx
->
aiCﬁumn
[
iCﬁ
]

1951 && 
p
->
iTabÀ
==
iBa£


1953 
CﬁlSeq
 *
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pP¨£
, 
pLi°
->
a
[
i
].
pEx¥
);

1954 if–
	`ALWAYS
(
pCﬁl
Ë&& 0==
	`sqlôe4_°ricmp
’Cﬁl->
zName
, 
zCﬁl
) ){

1955  
i
;

1961 
	}
}

1970 
	$isDi°ö˘Redund™t
(

1971 
P¨£
 *
pP¨£
,

1972 
SrcLi°
 *
pTabLi°
,

1973 
WhîeCœu£
 *
pWC
,

1974 
Ex¥Li°
 *
pDi°ö˘


1976 
TabÀ
 *
pTab
;

1977 
Index
 *
pIdx
;

1978 
i
;

1979 
iBa£
;

1984 if–
pTabLi°
->
nSrc
!=1 )  0;

1985 
iBa£
 = 
pTabLi°
->
a
[0].
iCurs‹
;

1986 
pTab
 = 
pTabLi°
->
a
[0].pTab;

1992 
i
=0; i<
pDi°ö˘
->
nEx¥
; i++){

1993 
Ex¥
 *
p
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pDi°ö˘
->
a
[
i
].
pEx¥
);

1994 if–
p
->
›
==
TK_COLUMN
 &&Ö->
iTabÀ
==
iBa£
 &&Ö->
iCﬁumn
<0 )  1;

2010 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

2011 if–
pIdx
->
⁄Eº‹
==
OE_N⁄e
 ) ;

2012 
i
=0; i<
pIdx
->
nCﬁumn
; i++){

2013 
iCﬁ
 = 
pIdx
->
aiCﬁumn
[
i
];

2014 if–0==
	`födTîm
(
pWC
, 
iBa£
, 
iCﬁ
, ~(
Bômask
)0, 
WO_EQ
, 
pIdx
) ){

2015 
iIdxCﬁ
 = 
	`födIndexCﬁ
(
pP¨£
, 
pDi°ö˘
, 
iBa£
, 
pIdx
, 
i
);

2016 if–
iIdxCﬁ
<0 || 
pTab
->
aCﬁ
[
pIdx
->
aiCﬁumn
[
i
]].
nŸNuŒ
==0 ){

2021 if–
i
==
pIdx
->
nCﬁumn
 ){

2028 
	}
}

2036 
WhîeCo°
 
	$whîeCo°Add
(
WhîeCo°
 
a
, WhîeCo° 
b
){

2037 c⁄° 
x
[] = {

2048 if–
a
>=
b
 ){

2049 if–
a
>
b
+49 ) á;

2050 if–
a
>
b
+31 ) á+1;

2051  
a
+
x
[a-
b
];

2053 if–
b
>
a
+49 )  b;

2054 if–
b
>
a
+31 )  b+1;

2055  
b
+
x
[b-
a
];

2057 
	}
}

2063 
WhîeCo°
 
	$whîeCo°
(
tRow˙t
 
x
){

2064 
WhîeCo°
 
a
[] = { 0, 2, 3, 5, 6, 7, 8, 9 };

2065 
WhîeCo°
 
y
 = 40;

2066 if–
x
<8 ){

2067 if–
x
<2 )  0;

2068  
x
<8 ){ 
y
 -= 10; x <<= 1; }

2070  
x
>255 ){ 
y
 += 40; x >>= 4; }

2071  
x
>15 ){ 
y
 += 10; x >>= 1; }

2073  
a
[
x
&7] + 
y
 - 10;

2074 
	}
}

2076 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


2082 
WhîeCo°
 
	$whîeCo°FromDoubÀ
(
x
){

2083 
u64
 
a
;

2084 
WhîeCo°
 
e
;

2085 
	`as£π
–(
x
)==8 && (
a
)==8 );

2086 if–
x
<=1 )  0;

2087 if–
x
<=2000000000 )  
	`whîeCo°
((
tRow˙t
)x);

2088 
	`mem˝y
(&
a
, &
x
, 8);

2089 
e
 = (
a
>>52) - 1022;

2090  
e
*10;

2091 
	}
}

2097 
WhîeCo°
 
	$e°Log
(
WhîeCo°
 
N
){

2098 
WhîeCo°
 
x
 = 
	`whîeCo°
(
N
);

2099  
x
>33 ? x - 33 : 0;

2100 
	}
}

2108 #i‡!
deföed
(
SQLITE4_OMIT_VIRTUALTABLE
Ë&& deföed(
WHERETRACE_ENABLED
)

2109 
	$TRACE_IDX_INPUTS
(
sqlôe4_ödex_öfo
 *
p
){

2110 
i
;

2111 if–!
sqlôe4WhîeTø˚
 ) ;

2112 
i
=0; i<
p
->
nC⁄°øöt
; i++){

2113 
	`sqlôe4DebugPrötf
(" constraint[%d]: col=%dÅermid=%d op=%d usabled=%d\n",

2114 
i
,

2115 
p
->
aC⁄°øöt
[
i
].
iCﬁumn
,

2116 
p
->
aC⁄°øöt
[
i
].
iTîmOff£t
,

2117 
p
->
aC⁄°øöt
[
i
].
›
,

2118 
p
->
aC⁄°øöt
[
i
].
ußbÀ
);

2120 
i
=0; i<
p
->
nOrdîBy
; i++){

2121 
	`sqlôe4DebugPrötf
(" orderby[%d]: col=%d desc=%d\n",

2122 
i
,

2123 
p
->
aOrdîBy
[
i
].
iCﬁumn
,

2124 
p
->
aOrdîBy
[
i
].
desc
);

2126 
	}
}

2127 
	$TRACE_IDX_OUTPUTS
(
sqlôe4_ödex_öfo
 *
p
){

2128 
i
;

2129 if–!
sqlôe4WhîeTø˚
 ) ;

2130 
i
=0; i<
p
->
nC⁄°øöt
; i++){

2131 
	`sqlôe4DebugPrötf
(" usage[%d]:árgvIdx=%d omit=%d\n",

2132 
i
,

2133 
p
->
aC⁄°øötUßge
[
i
].
¨gvIndex
,

2134 
p
->
aC⁄°øötUßge
[
i
].
omô
);

2136 
	`sqlôe4DebugPrötf
(" idxNum=%d\n", 
p
->
idxNum
);

2137 
	`sqlôe4DebugPrötf
(" idxSå=%s\n", 
p
->
idxSå
);

2138 
	`sqlôe4DebugPrötf
(" ordîByC⁄sumed=%d\n", 
p
->
‹dîByC⁄sumed
);

2139 
	`sqlôe4DebugPrötf
("É°im©edCo°=%g\n", 
p
->
e°im©edCo°
);

2140 
	}
}

2142 
	#TRACE_IDX_INPUTS
(
A
)

	)

2143 
	#TRACE_IDX_OUTPUTS
(
A
)

	)

2146 #i‚de‡
SQLITE4_OMIT_AUTOMATIC_INDEX


2152 
	$ãrmC™DriveIndex
(

2153 
WhîeTîm
 *
pTîm
,

2154 
SrcLi°Iãm
 *
pSrc
,

2155 
Bômask
 
nŸRódy


2157 
aff
;

2158 if–
pTîm
->
À·Curs‹
!=
pSrc
->
iCurs‹
 )  0;

2159 if–(
pTîm
->
eO≥øt‹
 & 
WO_EQ
)==0 )  0;

2160 if–(
pTîm
->
¥îeqRight
 & 
nŸRódy
)!=0 )  0;

2161 if–
pTîm
->
u
.
À·Cﬁumn
<0 )  0;

2162 
aff
 = 
pSrc
->
pTab
->
aCﬁ
[
pTîm
->
u
.
À·Cﬁumn
].
afföôy
;

2163 if–!
	`sqlôe4IndexAfföôyOk
(
pTîm
->
pEx¥
, 
aff
) )  0;

2165 
	}
}

2169 #i‚de‡
SQLITE4_OMIT_AUTOMATIC_INDEX


2175 
	$c⁄°ru˘Autom©icIndex
(

2176 
P¨£
 *
pP¨£
,

2177 
WhîeCœu£
 *
pWC
,

2178 
SrcLi°Iãm
 *
pSrc
,

2179 
Bômask
 
nŸRódy
,

2180 
WhîeLevñ
 *
pLevñ


2182 
nCﬁumn
;

2183 
WhîeTîm
 *
pTîm
;

2184 
WhîeTîm
 *
pWCEnd
;

2185 
nByã
;

2186 
Index
 *
pIdx
;

2187 
Vdbe
 *
v
;

2188 
addrInô
;

2189 
TabÀ
 *
pTabÀ
;

2190 
KeyInfo
 *
pKeyöfo
;

2191 
addrT›
;

2192 
ªgRec‹d
;

2193 
ªgKey
;

2194 
n
;

2195 
i
;

2196 
mxBôCﬁ
;

2197 
iPkC§
;

2198 
CﬁlSeq
 *
pCﬁl
;

2199 
WhîeLo›
 *
pLo›
;

2200 
Bômask
 
idxCﬁs
;

2201 
Bômask
 
exåaCﬁs
;

2202 
u8
 
£¡W¨nög
 = 0;

2206 
v
 = 
pP¨£
->
pVdbe
;

2207 
	`as£π
–
v
!=0 );

2208 
addrInô
 = 
	`sqlôe4CodeOn˚
(
pP¨£
);

2212 
nCﬁumn
 = 0;

2213 
pTabÀ
 = 
pSrc
->
pTab
;

2214 
pWCEnd
 = &
pWC
->
a
[pWC->
nTîm
];

2215 
pLo›
 = 
pLevñ
->
pWLo›
;

2216 
idxCﬁs
 = 0;

2217 
pTîm
=
pWC
->
a
;ÖTîm<
pWCEnd
;ÖTerm++){

2218 if–
	`ãrmC™DriveIndex
(
pTîm
, 
pSrc
, 
nŸRódy
) ){

2219 
iCﬁ
 = 
pTîm
->
u
.
À·Cﬁumn
;

2220 
Bômask
 
cMask
 = 
iCﬁ
>=
BMS
 ? 
	`MASKBIT
(BMS-1) : MASKBIT(iCol);

2221 
	`ã°ˇ£
–
iCﬁ
==
BMS
 );

2222 
	`ã°ˇ£
–
iCﬁ
==
BMS
-1 );

2223 if–!
£¡W¨nög
 ){

2224 
	`sqlôe4_log
(
pP¨£
->
db
->
pEnv
, 
SQLITE4_WARNING_AUTOINDEX
,

2225 "autom©i¯ödex o¿%s(%s)", 
pTabÀ
->
zName
,

2226 
pTabÀ
->
aCﬁ
[
iCﬁ
].
zName
);

2227 
£¡W¨nög
 = 1;

2229 if–(
idxCﬁs
 & 
cMask
)==0 ){

2230 if–
	`whîeLo›Resize
(
pP¨£
->
db
, 
pLo›
, 
nCﬁumn
+1) ) ;

2231 
pLo›
->
aLTîm
[
nCﬁumn
++] = 
pTîm
;

2232 
idxCﬁs
 |
cMask
;

2236 
	`as£π
–
nCﬁumn
>0 );

2237 
pLo›
->
u
.
båì
.
nEq
 =ÖLo›->
nLTîm
 = 
nCﬁumn
;

2238 
pLo›
->
wsFœgs
 = 
WHERE_COLUMN_EQ
 | 
WHERE_IDX_ONLY
 | 
WHERE_INDEXED


2239 | 
WHERE_AUTO_INDEX
;

2249 
exåaCﬁs
 = 
pSrc
->
cﬁU£d
 & (~
idxCﬁs
 | 
	`MASKBIT
(
BMS
-1));

2250 
mxBôCﬁ
 = (
pTabÀ
->
nCﬁ
 >
BMS
-1) ? BMS-1 :ÖTable->nCol;

2251 
	`ã°ˇ£
–
pTabÀ
->
nCﬁ
==
BMS
-1 );

2252 
	`ã°ˇ£
–
pTabÀ
->
nCﬁ
==
BMS
-2 );

2253 
i
=0; i<
mxBôCﬁ
; i++){

2254 if–
exåaCﬁs
 & 
	`MASKBIT
(
i
ËË
nCﬁumn
++;

2256 if–
pSrc
->
cﬁU£d
 & 
	`MASKBIT
(
BMS
-1) ){

2257 
nCﬁumn
 +
pTabÀ
->
nCﬁ
 - 
BMS
 + 1;

2259 
pLo›
->
wsFœgs
 |
WHERE_COLUMN_EQ
 | 
WHERE_IDX_ONLY
;

2262 
nByã
 = (
Index
);

2263 
nByã
 +
nCﬁumn
*();

2264 
nByã
 +
nCﬁumn
*(*);

2265 
nByã
 +
nCﬁumn
;

2266 
pIdx
 = 
	`sqlôe4DbMÆlocZîo
(
pP¨£
->
db
, 
nByã
);

2267 if–
pIdx
==0 ) ;

2268 
pLo›
->
u
.
båì
.
pIndex
 = 
pIdx
;

2269 
pIdx
->
azCﬁl
 = (**)&pIdx[1];

2270 
pIdx
->
aiCﬁumn
 = (*)&pIdx->
azCﬁl
[
nCﬁumn
];

2271 
pIdx
->
aS‹tOrdî
 = (
u8
*)&pIdx->
aiCﬁumn
[
nCﬁumn
];

2272 
pIdx
->
zName
 = "auto-index";

2273 
pIdx
->
nCﬁumn
 =ÇColumn;

2274 
pIdx
->
pTabÀ
 =ÖTable;

2275 
pIdx
->
aiCovî
 =ÖIdx->
aiCﬁumn
;

2276 
pIdx
->
nCovî
 =ÖIdx->
nCﬁumn
;

2277 
pIdx
->
eIndexTy≥
 = 
SQLITE4_INDEX_TEMP
;

2278 
n
 = 0;

2279 
idxCﬁs
 = 0;

2280 
pTîm
=
pWC
->
a
;ÖTîm<
pWCEnd
;ÖTerm++){

2281 if–
	`ãrmC™DriveIndex
(
pTîm
, 
pSrc
, 
nŸRódy
) ){

2282 
iCﬁ
 = 
pTîm
->
u
.
À·Cﬁumn
;

2283 
Bômask
 
cMask
 = 
iCﬁ
>=
BMS
 ? 
	`MASKBIT
(BMS-1) : MASKBIT(iCol);

2284 
	`ã°ˇ£
–
iCﬁ
==
BMS
-1 );

2285 
	`ã°ˇ£
–
iCﬁ
==
BMS
 );

2286 if–(
idxCﬁs
 & 
cMask
)==0 ){

2287 
Ex¥
 *
pX
 = 
pTîm
->
pEx¥
;

2288 
idxCﬁs
 |
cMask
;

2289 
pIdx
->
aiCﬁumn
[
n
] = 
pTîm
->
u
.
À·Cﬁumn
;

2290 
pCﬁl
 = 
	`sqlôe4Bö¨yCom∑ªCﬁlSeq
(
pP¨£
, 
pX
->
pLe·
,ÖX->
pRight
);

2291 
pIdx
->
azCﬁl
[
n
] = 
	`ALWAYS
(
pCﬁl
Ë?ÖCﬁl->
zName
 : "BINARY";

2292 
n
++;

2296 
	`as£π
–(
u32
)
n
==
pLo›
->
u
.
båì
.
nEq
 );

2300 
i
=0; i<
mxBôCﬁ
; i++){

2301 if–
exåaCﬁs
 & 
	`MASKBIT
(
i
) ){

2302 
pIdx
->
aiCﬁumn
[
n
] = 
i
;

2303 
pIdx
->
azCﬁl
[
n
] = "BINARY";

2304 
n
++;

2307 if–
pSrc
->
cﬁU£d
 & 
	`MASKBIT
(
BMS
-1) ){

2308 
i
=
BMS
-1; i<
pTabÀ
->
nCﬁ
; i++){

2309 
pIdx
->
aiCﬁumn
[
n
] = 
i
;

2310 
pIdx
->
azCﬁl
[
n
] = "BINARY";

2311 
n
++;

2314 
	`as£π
–
n
==
nCﬁumn
 );

2317 
pKeyöfo
 = 
	`sqlôe4IndexKeyöfo
(
pP¨£
, 
pIdx
);

2318 
	`as£π
–
pLevñ
->
iIdxCur
>=0 );

2319 
pLevñ
->
iIdxCur
 = 
pP¨£
->
nTab
++;

2320 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_O≥nAutoödex
, 
pLevñ
->
iIdxCur
, 
nCﬁumn
+1, 0,

2321 (*)
pKeyöfo
, 
P4_KEYINFO_HANDOFF
);

2322 
	`VdbeCommít
((
v
, "f‹ %s", 
pTabÀ
->
zName
));

2325 
iPkC§
 = 
pLevñ
->
iTabCur
;

2326 
addrT›
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Rewöd
, 
iPkC§
);

2327 
ªgRec‹d
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 2);

2328 
ªgKey
 = 
ªgRec‹d
 + 1;

2329 
	`sqlôe4EncodeIndexKey
(
pP¨£
, 0, 
iPkC§
, 
pIdx
, 
pLevñ
->
iIdxCur
, 1, 
ªgKey
);

2330 
	`sqlôe4EncodeIndexVÆue
(
pP¨£
, 
iPkC§
, 
pIdx
, 
ªgRec‹d
);

2331 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_In£π
, 
pLevñ
->
iIdxCur
, 
ªgRec‹d
, 
ªgKey
);

2333 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Next
, 
pLevñ
->
iTabCur
, 
addrT›
+1);

2334 
	`sqlôe4VdbeCh™geP5
(
v
, 
SQLITE4_STMTSTATUS_AUTOINDEX
);

2335 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrT›
);

2336 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
ªgRec‹d
, 2);

2339 
	`sqlôe4VdbeJumpHîe
(
v
, 
addrInô
);

2340 
	}
}

2343 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


2349 
sqlôe4_ödex_öfo
 *
	$ÆloˇãIndexInfo
(

2350 
P¨£
 *
pP¨£
,

2351 
WhîeCœu£
 *
pWC
,

2352 
SrcLi°Iãm
 *
pSrc
,

2353 
Ex¥Li°
 *
pOrdîBy


2355 
i
, 
j
;

2356 
nTîm
;

2357 
sqlôe4_ödex_c⁄°øöt
 *
pIdxC⁄s
;

2358 
sqlôe4_ödex_‹dîby
 *
pIdxOrdîBy
;

2359 
sqlôe4_ödex_c⁄°øöt_ußge
 *
pUßge
;

2360 
WhîeTîm
 *
pTîm
;

2361 
nOrdîBy
;

2362 
sqlôe4_ödex_öfo
 *
pIdxInfo
;

2366 
i
=
nTîm
=0, 
pTîm
=
pWC
->
a
; i<pWC->nTerm; i++,ÖTerm++){

2367 if–
pTîm
->
À·Curs‹
 !
pSrc
->
iCurs‹
 ) ;

2368 
	`as£π
–
	`IsPowîOfTwo
(
pTîm
->
eO≥øt‹
 & ~
WO_EQUIV
) );

2369 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_IN
 );

2370 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_ISNULL
 );

2371 if–
pTîm
->
eO≥øt‹
 & (
WO_ISNULL
) ) ;

2372 if–
pTîm
->
wtFœgs
 & 
TERM_VNULL
 ) ;

2373 
nTîm
++;

2380 
nOrdîBy
 = 0;

2381 if–
pOrdîBy
 ){

2382 
n
 = 
pOrdîBy
->
nEx¥
;

2383 
i
=0; i<
n
; i++){

2384 
Ex¥
 *
pEx¥
 = 
pOrdîBy
->
a
[
i
].pExpr;

2385 if–
pEx¥
->
›
!=
TK_COLUMN
 ||ÖEx¥->
iTabÀ
!=
pSrc
->
iCurs‹
 ) ;

2387 if–
i
==
n
){

2388 
nOrdîBy
 = 
n
;

2394 
pIdxInfo
 = 
	`sqlôe4DbMÆlocZîo
(
pP¨£
->
db
, (*pIdxInfo)

2395 + ((*
pIdxC⁄s
Ë+ (*
pUßge
))*
nTîm


2396 + (*
pIdxOrdîBy
)*
nOrdîBy
 );

2397 if–
pIdxInfo
==0 ){

2398 
	`sqlôe4Eº‹Msg
(
pP¨£
, "out of memory");

2407 
pIdxC⁄s
 = (
sqlôe4_ödex_c⁄°øöt
*)&
pIdxInfo
[1];

2408 
pIdxOrdîBy
 = (
sqlôe4_ödex_‹dîby
*)&
pIdxC⁄s
[
nTîm
];

2409 
pUßge
 = (
sqlôe4_ödex_c⁄°øöt_ußge
*)&
pIdxOrdîBy
[
nOrdîBy
];

2410 *(*)&
pIdxInfo
->
nC⁄°øöt
 = 
nTîm
;

2411 *(*)&
pIdxInfo
->
nOrdîBy
 =ÇOrderBy;

2412 *(
sqlôe4_ödex_c⁄°øöt
**)&
pIdxInfo
->
aC⁄°øöt
 = 
pIdxC⁄s
;

2413 *(
sqlôe4_ödex_‹dîby
**)&
pIdxInfo
->
aOrdîBy
 = 
pIdxOrdîBy
;

2414 *(
sqlôe4_ödex_c⁄°øöt_ußge
**)&
pIdxInfo
->
aC⁄°øötUßge
 =

2415 
pUßge
;

2417 
i
=
j
=0, 
pTîm
=
pWC
->
a
; i<pWC->
nTîm
; i++,ÖTerm++){

2418 
u8
 
›
;

2419 if–
pTîm
->
À·Curs‹
 !
pSrc
->
iCurs‹
 ) ;

2420 
	`as£π
–
	`IsPowîOfTwo
(
pTîm
->
eO≥øt‹
 & ~
WO_EQUIV
) );

2421 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_IN
 );

2422 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_ISNULL
 );

2423 if–
pTîm
->
eO≥øt‹
 & (
WO_ISNULL
) ) ;

2424 if–
pTîm
->
wtFœgs
 & 
TERM_VNULL
 ) ;

2425 
pIdxC⁄s
[
j
].
iCﬁumn
 = 
pTîm
->
u
.
À·Cﬁumn
;

2426 
pIdxC⁄s
[
j
].
iTîmOff£t
 = 
i
;

2427 
›
 = (
u8
)
pTîm
->
eO≥øt‹
 & 
WO_ALL
;

2428 if–
›
==
WO_IN
 ) o∞
WO_EQ
;

2429 
pIdxC⁄s
[
j
].
›
 = op;

2433 
	`as£π
–
WO_EQ
==
SQLITE4_INDEX_CONSTRAINT_EQ
 );

2434 
	`as£π
–
WO_LT
==
SQLITE4_INDEX_CONSTRAINT_LT
 );

2435 
	`as£π
–
WO_LE
==
SQLITE4_INDEX_CONSTRAINT_LE
 );

2436 
	`as£π
–
WO_GT
==
SQLITE4_INDEX_CONSTRAINT_GT
 );

2437 
	`as£π
–
WO_GE
==
SQLITE4_INDEX_CONSTRAINT_GE
 );

2438 
	`as£π
–
WO_MATCH
==
SQLITE4_INDEX_CONSTRAINT_MATCH
 );

2439 
	`as£π
–
pTîm
->
eO≥øt‹
 & (
WO_IN
|
WO_EQ
|
WO_LT
|
WO_LE
|
WO_GT
|
WO_GE
|
WO_MATCH
) );

2440 
j
++;

2442 
i
=0; i<
nOrdîBy
; i++){

2443 
Ex¥
 *
pEx¥
 = 
pOrdîBy
->
a
[
i
].pExpr;

2444 
pIdxOrdîBy
[
i
].
iCﬁumn
 = 
pEx¥
->iColumn;

2445 
pIdxOrdîBy
[
i
].
desc
 = 
pOrdîBy
->
a
[i].
s‹tOrdî
;

2448  
pIdxInfo
;

2449 
	}
}

2465 
	$vèbBe°Index
(
P¨£
 *
pP¨£
, 
TabÀ
 *
pTab
, 
sqlôe4_ödex_öfo
 *
p
){

2466 
sqlôe4_vèb
 *
pVèb
 = 
	`sqlôe4GëVTabÀ
(
pP¨£
->
db
, 
pTab
)->pVtab;

2467 
i
;

2468 
rc
;

2470 
	`TRACE_IDX_INPUTS
(
p
);

2471 
rc
 = 
pVèb
->
pModuÀ
->
	`xBe°Index
’Vèb, 
p
);

2472 
	`TRACE_IDX_OUTPUTS
(
p
);

2474 if–
rc
!=
SQLITE4_OK
 ){

2475 if–
rc
==
SQLITE4_NOMEM
 ){

2476 
pP¨£
->
db
->
mÆlocFaûed
 = 1;

2477 }if–!
pVèb
->
zEºMsg
 ){

2478 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s", 
	`sqlôe4EºSå
(
rc
));

2480 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s", 
pVèb
->
zEºMsg
);

2483 
	`sqlôe4_‰ì
(
pVèb
->
zEºMsg
);

2484 
pVèb
->
zEºMsg
 = 0;

2486 
i
=0; i<
p
->
nC⁄°øöt
; i++){

2487 if–!
p
->
aC⁄°øöt
[
i
].
ußbÀ
 &&Ö->
aC⁄°øötUßge
[i].
¨gvIndex
>0 ){

2488 
	`sqlôe4Eº‹Msg
(
pP¨£
,

2489 "èbÀ %s: xBe°IndexÑëu∫edá¿övÆidÖœn", 
pTab
->
zName
);

2493  
pP¨£
->
nEº
;

2494 
	}
}

2498 #ifde‡
SQLITE4_ENABLE_STAT3


2508 
	$whîeKeySèts
(

2509 
P¨£
 *
pP¨£
,

2510 
Index
 *
pIdx
,

2511 
sqlôe4_buf„r
 *
pBuf
,

2512 
roundUp
,

2513 
tRow˙t
 *
aSèt


2515 
tRow˙t
 
n
;

2516 
IndexSam∂e
 *
aSam∂e
;

2517 
i
;

2518 
isEq
 = 0;

2520 
	`as£π
–
roundUp
==0 ||ÑoundUp==1 );

2521 
	`as£π
–
pIdx
->
nSam∂e
>0 );

2522 
	`as£π
–
pBuf
->
n
>0 );

2524 
n
 = 
pIdx
->
aiRowE°
[0];

2525 
aSam∂e
 = 
pIdx
->aSample;

2531 
i
=0; i<
pIdx
->
nSam∂e
; i++){

2532 
ªs
;

2533 
n
 = 
pBuf
->n;

2534 if–
n
>
aSam∂e
[
i
].
nVÆ
 )Ç =áSample[i].nVal;

2536 
ªs
 = 
	`memcmp
(
pBuf
->
p
, 
aSam∂e
[
i
].
aVÆ
, 
n
);

2537 if–
ªs
==0 )Ñe†
pBuf
->
n
 - 
aSam∂e
[
i
].
nVÆ
;

2538 if–
ªs
<=0 ){

2539 
isEq
 = (
ªs
==0);

2548 if–
isEq
 ){

2549 
	`as£π
–
i
<
pIdx
->
nSam∂e
 );

2550 
aSèt
[0] = 
aSam∂e
[
i
].
nLt
;

2551 
aSèt
[1] = 
aSam∂e
[
i
].
nEq
;

2553 
tRow˙t
 
iLowî
, 
iUµî
, 
iG≠
;

2554 if–
i
==0 ){

2555 
iLowî
 = 0;

2556 
iUµî
 = 
aSam∂e
[0].
nLt
;

2558 
iUµî
 = 
i
>=
pIdx
->
nSam∂e
 ? 
n
 : 
aSam∂e
[i].
nLt
;

2559 
iLowî
 = 
aSam∂e
[
i
-1].
nEq
 +áSam∂e[i-1].
nLt
;

2561 
aSèt
[1] = 
pIdx
->
avgEq
;

2562 if–
iLowî
>=
iUµî
 ){

2563 
iG≠
 = 0;

2565 
iG≠
 = 
iUµî
 - 
iLowî
;

2567 if–
roundUp
 ){

2568 
iG≠
 = (iGap*2)/3;

2570 
iG≠
 = iGap/3;

2572 
aSèt
[0] = 
iLowî
 + 
iG≠
;

2574  
SQLITE4_OK
;

2575 
	}
}

2591 #ifde‡
SQLITE4_ENABLE_STAT3


2592 
	$vÆueFromEx¥
(

2593 
P¨£
 *
pP¨£
,

2594 
KeyInfo
 *
pKeyöfo
,

2595 
Ex¥
 *
pEx¥
,

2596 
u8
 
aff
,

2597 
sqlôe4_buf„r
 *
pBuf


2599 
rc
 = 
SQLITE4_OK
;

2600 
sqlôe4
 *
db
 = 
pP¨£
->db;

2601 
sqlôe4_vÆue
 *
pVÆ
 = 0;

2603 
	`as£π
–
pBuf
->
n
==0 );

2605 if–
pEx¥
->
›
==
TK_VARIABLE


2606 || (
pEx¥
->
›
==
TK_REGISTER
 &&ÖEx¥->
›2
==
TK_VARIABLE
)

2608 
iV¨
 = 
pEx¥
->
iCﬁumn
;

2609 
	`sqlôe4VdbeSëV¨mask
(
pP¨£
->
pVdbe
, 
iV¨
);

2610 
pVÆ
 = 
	`sqlôe4VdbeGëVÆue
(
pP¨£
->
pRïª∑ª
, 
iV¨
, 
aff
);

2612 
rc
 = 
	`sqlôe4VÆueFromEx¥
(
db
, 
pEx¥
, 
SQLITE4_UTF8
, 
aff
, &
pVÆ
);

2615 if–
pVÆ
 && 
rc
==
SQLITE4_OK
 ){

2616 
u8
 *
aOut
;

2617 
nOut
;

2618 
rc
 = 
	`sqlôe4VdbeEncodeKey
(
db
, 
pVÆ
, 1, -1, 
pKeyöfo
, &
aOut
, &
nOut
, 0);

2619 if–
rc
==
SQLITE4_OK
 ){

2620 
rc
 = 
	`sqlôe4_buf„r_£t
(
pBuf
, 
aOut
, 
nOut
);

2622 
	`sqlôe4DbFªe
(
db
, 
aOut
);

2625 
	`sqlôe4VÆueFªe
(
pVÆ
);

2626  
SQLITE4_OK
;

2627 
	}
}

2634 
	$whîeSam∂eKeyöfo
(
P¨£
 *
pP¨£
, 
Index
 *
p
, 
KeyInfo
 *
pKeyInfo
){

2635 
CﬁlSeq
 *
pCﬁl
;

2636 
	`mem£t
(
pKeyInfo
, 0, (
KeyInfo
));

2637 
pKeyInfo
->
nFõld
 = 
p
->
nCﬁumn
;

2638 
pKeyInfo
->
nPK
 = 1;

2639 
pKeyInfo
->
nD©a
 = 0;

2640 
pKeyInfo
->
aS‹tOrdî
 = 
p
->aSortOrder;

2641 
pKeyInfo
->
aCﬁl
[0] = 
pCﬁl
 = 
	`sqlôe4LoˇãCﬁlSeq
(
pP¨£
, 
p
->
azCﬁl
[0]);

2642 
pKeyInfo
->
aCﬁl
[0] = 
pCﬁl
;

2643  
pCﬁl
 ? 
SQLITE4_OK
 : 
SQLITE4_ERROR
;

2644 
	}
}

2686 
	$whîeR™geSˇnE°
(

2687 
P¨£
 *
pP¨£
,

2688 
Index
 *
p
,

2689 
nEq
,

2690 
WhîeTîm
 *
pLowî
,

2691 
WhîeTîm
 *
pUµî
,

2692 
WhîeCo°
 *
pR™geDiv


2694 
rc
 = 
SQLITE4_OK
;

2696 #ifde‡
SQLITE4_ENABLE_STAT3


2698 if–
nEq
==0 && 
p
->
nSam∂e
 && 
	`O±imiz©i⁄E«bÀd
(
pP¨£
->
db
, 
SQLITE4_Sèt3
) ){

2699 
sqlôe4
 *
db
 = 
pP¨£
->db;

2700 
KeyInfo
 
keyöfo
;

2701 
sqlôe4_buf„r
 
buf
;

2702 
tRow˙t
 
iLowî
 = 0;

2703 
tRow˙t
 
iUµî
 = 
p
->
aiRowE°
[0];

2704 
tRow˙t
 
a
[2];

2705 
u8
 
aff
 = 
p
->
pTabÀ
->
aCﬁ
[p->
aiCﬁumn
[0]].
afföôy
;

2707 
	`sqlôe4_buf„r_öô
(&
buf
, 
db
->
pEnv
->
pMM
);

2708 
rc
 = 
	`whîeSam∂eKeyöfo
(
pP¨£
, 
p
, &
keyöfo
);

2710 if–
rc
==
SQLITE4_OK
 && 
pLowî
 ){

2711 
Ex¥
 *
pEx¥
 = 
pLowî
->pEx¥->
pRight
;

2712 
rc
 = 
	`vÆueFromEx¥
(
pP¨£
, &
keyöfo
, 
pEx¥
, 
aff
, &
buf
);

2713 
	`as£π
–(
pLowî
->
eO≥øt‹
 & (
WO_GT
|
WO_GE
))!=0 );

2714 if–
rc
==
SQLITE4_OK
 && 
buf
.
n


2715 && 
	`whîeKeySèts
(
pP¨£
, 
p
, &
buf
, 0, 
a
)==
SQLITE4_OK


2717 
iLowî
 = 
a
[0];

2718 if–(
pLowî
->
eO≥øt‹
 & 
WO_GT
)!=0 ) 
iLowî
 +
a
[1];

2720 
	`sqlôe4_buf„r_£t
(&
buf
, 0, 0);

2722 if–
rc
==
SQLITE4_OK
 && 
pUµî
 ){

2723 
Ex¥
 *
pEx¥
 = 
pUµî
->pEx¥->
pRight
;

2724 
rc
 = 
	`vÆueFromEx¥
(
pP¨£
, &
keyöfo
, 
pEx¥
, 
aff
, &
buf
);

2725 
	`as£π
–(
pUµî
->
eO≥øt‹
 & (
WO_LT
|
WO_LE
))!=0 );

2726 if–
rc
==
SQLITE4_OK
 && 
buf
.
n


2727 && 
	`whîeKeySèts
(
pP¨£
, 
p
, &
buf
, 1, 
a
)==
SQLITE4_OK


2729 
iUµî
 = 
a
[0];

2730 if–(
pUµî
->
eO≥øt‹
 & 
WO_LE
)!=0 ) 
iUµî
 +
a
[1];

2733 
	`sqlôe4_buf„r_˛ór
(&
buf
);

2734 if–
rc
==
SQLITE4_OK
 ){

2735 
WhîeCo°
 
iBa£
 = 
	`whîeCo°
(
p
->
aiRowE°
[0]);

2736 if–
iUµî
>
iLowî
 ){

2737 
iBa£
 -
	`whîeCo°
(
iUµî
 - 
iLowî
);

2739 *
pR™geDiv
 = 
iBa£
;

2740 
	`WHERETRACE
(0x100, ("range scanÑegions: %u..%u div=%d\n",

2741 (
u32
)
iLowî
, (u32)
iUµî
, *
pR™geDiv
));

2742  
SQLITE4_OK
;

2746 
	`UNUSED_PARAMETER
(
pP¨£
);

2747 
	`UNUSED_PARAMETER
(
p
);

2748 
	`UNUSED_PARAMETER
(
nEq
);

2750 
	`as£π
–
pLowî
 || 
pUµî
 );

2751 *
pR™geDiv
 = 0;

2754 if–
pLowî
 && (pLowî->
wtFœgs
 & 
TERM_VNULL
)==0 ){

2755 *
pR™geDiv
 +20; 
	`as£π
–20==
	`whîeCo°
(4) );

2757 if–
pUµî
 ){

2758 *
pR™geDiv
 +20; 
	`as£π
–20==
	`whîeCo°
(4) );

2760  
rc
;

2761 
	}
}

2763 #ifde‡
SQLITE4_ENABLE_STAT3


2781 
	$whîeEquÆSˇnE°
(

2782 
P¨£
 *
pP¨£
,

2783 
Index
 *
p
,

2784 
Ex¥
 *
pEx¥
,

2785 
tRow˙t
 *
≤Row


2787 
sqlôe4_buf„r
 
buf
;

2788 
u8
 
aff
;

2789 
rc
;

2790 
tRow˙t
 
a
[2];

2792 
	`as£π
–
p
->
aSam∂e
!=0 );

2793 
	`as£π
–
p
->
nSam∂e
>0 );

2794 
	`sqlôe4_buf„r_öô
(&
buf
, 
pP¨£
->
db
->
pEnv
->
pMM
);

2795 
aff
 = 
p
->
pTabÀ
->
aCﬁ
[p->
aiCﬁumn
[0]].
afföôy
;

2796 if–
pEx¥
 ){

2797 
KeyInfo
 
keyöfo
;

2798 
rc
 = 
	`whîeSam∂eKeyöfo
(
pP¨£
, 
p
, &
keyöfo
);

2799 if–
rc
==
SQLITE4_OK
 ){

2800 
rc
 = 
	`vÆueFromEx¥
(
pP¨£
, &
keyöfo
, 
pEx¥
, 
aff
, &
buf
);

2801 if–
rc
==
SQLITE4_OK
 && 
buf
.
n
==0 )Ñ¯
SQLITE4_NOTFOUND
;

2805 
u8
 
aNuŒ
[2] = {0x05, 0xfa};

2806 
rc
 = 
	`sqlôe4_buf„r_£t
(&
buf
, &
aNuŒ
[
p
->
aS‹tOrdî
[0]], 1);

2809 if–
rc
==
SQLITE4_OK
 ){

2810 
rc
 = 
	`whîeKeySèts
(
pP¨£
, 
p
, &
buf
, 0, 
a
);

2811 if–
rc
==
SQLITE4_OK
 ){

2812 
	`WHERETRACE
(0x100,("equÆôy sˇ¿ªgi⁄s: %d\n", ()
a
[1]));

2813 *
≤Row
 = 
a
[1];

2816 
whîeEquÆSˇnE°_ˇn˚l
:

2817 
	`sqlôe4_buf„r_˛ór
(&
buf
);

2818  
rc
;

2819 
	}
}

2822 #ifde‡
SQLITE4_ENABLE_STAT3


2839 
	$whîeInSˇnE°
(

2840 
P¨£
 *
pP¨£
,

2841 
Index
 *
p
,

2842 
Ex¥Li°
 *
pLi°
,

2843 
tRow˙t
 *
≤Row


2845 
rc
 = 
SQLITE4_OK
;

2846 
tRow˙t
 
nE°
;

2847 
tRow˙t
 
nRowE°
 = 0;

2848 
i
;

2850 
	`as£π
–
p
->
aSam∂e
!=0 );

2851 
i
=0; 
rc
==
SQLITE4_OK
 && i<
pLi°
->
nEx¥
; i++){

2852 
nE°
 = 
p
->
aiRowE°
[0];

2853 
rc
 = 
	`whîeEquÆSˇnE°
(
pP¨£
, 
p
, 
pLi°
->
a
[
i
].
pEx¥
, &
nE°
);

2854 
nRowE°
 +
nE°
;

2856 if–
rc
==
SQLITE4_OK
 ){

2857 if–
nRowE°
 > 
p
->
aiRowE°
[0] )ÇRowEst =Ö->aiRowEst[0];

2858 *
≤Row
 = 
nRowE°
;

2859 
	`WHERETRACE
(0x100,("INÑowÉ°im©e:É°=%g\n", 
nRowE°
));

2861  
rc
;

2862 
	}
}

2891 
	$dißbÀTîm
(
WhîeLevñ
 *
pLevñ
, 
WhîeTîm
 *
pTîm
){

2892 if–
pTîm


2893 && (
pTîm
->
wtFœgs
 & 
TERM_CODED
)==0

2894 && (
pLevñ
->
iLe·Joö
==0 || 
	`Ex¥HasPr›îty
(
pTîm
->
pEx¥
, 
EP_FromJoö
))

2896 
pTîm
->
wtFœgs
 |
TERM_CODED
;

2897 if–
pTîm
->
iP¨ít
>=0 ){

2898 
WhîeTîm
 *
pOthî
 = &
pTîm
->
pWC
->
a
[pTîm->
iP¨ít
];

2899 if–(--
pOthî
->
nChûd
)==0 ){

2900 
	`dißbÀTîm
(
pLevñ
, 
pOthî
);

2904 
	}
}

2917 
	$codeAµlyAfföôy
(
P¨£
 *
pP¨£
, 
ba£
, 
n
, *
zAff
){

2918 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2919 if–
zAff
==0 ){

2920 
	`as£π
–
pP¨£
->
db
->
mÆlocFaûed
 );

2923 
	`as£π
–
v
!=0 );

2928  
n
>0 && 
zAff
[0]==
SQLITE4_AFF_NONE
 ){

2929 
n
--;

2930 
ba£
++;

2931 
zAff
++;

2933  
n
>1 && 
zAff
[n-1]==
SQLITE4_AFF_NONE
 ){

2934 
n
--;

2938 if–
n
>0 ){

2939 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Afföôy
, 
ba£
, 
n
);

2940 
	`sqlôe4VdbeCh™geP4
(
v
, -1, 
zAff
, 
n
);

2941 
	`sqlôe4Ex¥CacheAfföôyCh™ge
(
pP¨£
, 
ba£
, 
n
);

2943 
	}
}

2957 
	$codeEquÆôyTîm
(

2958 
P¨£
 *
pP¨£
,

2959 
WhîeTîm
 *
pTîm
,

2960 
WhîeLevñ
 *
pLevñ
,

2961 
iEq
,

2962 
bRev
,

2963 
iT¨gë


2965 
Ex¥
 *
pX
 = 
pTîm
->
pEx¥
;

2966 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

2967 
iReg
;

2969 
	`as£π
–
iT¨gë
>0 );

2970 if–
pX
->
›
==
TK_EQ
 ){

2971 
iReg
 = 
	`sqlôe4Ex¥CodeT¨gë
(
pP¨£
, 
pX
->
pRight
, 
iT¨gë
);

2972 }if–
pX
->
›
==
TK_ISNULL
 ){

2973 
iReg
 = 
iT¨gë
;

2974 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
iReg
);

2975 #i‚de‡
SQLITE4_OMIT_SUBQUERY


2977 
eTy≥
;

2978 
iTab
;

2979 
iCov
;

2980 
InLo›
 *
pIn
;

2981 
WhîeLo›
 *
pLo›
 = 
pLevñ
->
pWLo›
;

2983 if–(
pLo›
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)==0

2984 && 
pLo›
->
u
.
båì
.
pIndex
!=0

2985 && 
pLo›
->
u
.
båì
.
pIndex
->
aS‹tOrdî
[
iEq
]

2987 
	`ã°ˇ£
–
iEq
==0 );

2988 
	`ã°ˇ£
–
bRev
 );

2989 
bRev
 = !bRev;

2991 
	`as£π
–
pX
->
›
==
TK_IN
 );

2992 
iReg
 = 
iT¨gë
;

2993 
eTy≥
 = 
	`sqlôe4FödInIndex
(
pP¨£
, 
pX
, 0, &
iCov
);

2994 if–
eTy≥
==
IN_INDEX_INDEX_DESC
 ){

2995 
	`ã°ˇ£
–
bRev
 );

2996 
bRev
 = !bRev;

2998 
iTab
 = 
pX
->
iTabÀ
;

2999 
	`sqlôe4VdbeAddOp2
(
v
, 
bRev
 ? 
OP_La°
 : 
OP_Rewöd
, 
iTab
, 0);

3000 
	`as£π
–(
pLo›
->
wsFœgs
 & 
WHERE_MULTI_OR
)==0 );

3001 
pLo›
->
wsFœgs
 |
WHERE_IN_ABLE
;

3002 if–
pLevñ
->
u
.
ö
.
nIn
==0 ){

3003 
pLevñ
->
addrNxt
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3005 
pLevñ
->
u
.
ö
.
nIn
++;

3006 
pLevñ
->
u
.
ö
.
aInLo›
 =

3007 
	`sqlôe4DbRóŒocOrFªe
(
pP¨£
->
db
, 
pLevñ
->
u
.
ö
.
aInLo›
,

3008 (
pLevñ
->
u
.
ö
.
aInLo›
[0])*pLevñ->u.ö.
nIn
);

3009 
pIn
 = 
pLevñ
->
u
.
ö
.
aInLo›
;

3010 if–
pIn
 ){

3011 
pIn
 +
pLevñ
->
u
.
ö
.
nIn
 - 1;

3012 
pIn
->
iCur
 = 
iTab
;

3013 if–
eTy≥
==
IN_INDEX_ROWID
 ){

3014 
pIn
->
addrInT›
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Rowid
, 
iTab
, 
iReg
);

3016 
pIn
->
addrInT›
 = 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_Cﬁumn
, 
iTab
, 
iCov
, 
iReg
);

3018 
pIn
->
eEndLo›Op
 = 
bRev
 ? 
OP_Pªv
 : 
OP_Next
;

3019 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IsNuŒ
, 
iReg
);

3021 
pLevñ
->
u
.
ö
.
nIn
 = 0;

3025 
	`dißbÀTîm
(
pLevñ
, 
pTîm
);

3026  
iReg
;

3027 
	}
}

3068 
	$codeAŒEquÆôyTîms
(

3069 
P¨£
 *
pP¨£
,

3070 
WhîeLevñ
 *
pLevñ
,

3071 
bRev
,

3072 
nExåaReg
,

3073 **
pzAff


3075 
nEq
;

3076 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3077 
Index
 *
pIdx
;

3078 
WhîeTîm
 *
pTîm
;

3079 
WhîeLo›
 *
pLo›
;

3080 
j
;

3081 
ªgBa£
;

3082 
nReg
;

3083 *
zAff
;

3086 
pLo›
 = 
pLevñ
->
pWLo›
;

3087 
	`as£π
–(
pLo›
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)==0 );

3088 
nEq
 = 
pLo›
->
u
.
båì
.nEq;

3089 
pIdx
 = 
pLo›
->
u
.
båì
.
pIndex
;

3090 
	`as£π
–
pIdx
!=0 );

3094 
ªgBa£
 = 
pP¨£
->
nMem
 + 1;

3095 
nReg
 = 
pLo›
->
u
.
båì
.
nEq
 + 
nExåaReg
;

3096 
pP¨£
->
nMem
 +
nReg
;

3098 
zAff
 = 
	`sqlôe4DbSåDup
(
pP¨£
->
db
, 
	`sqlôe4IndexAfföôySå
(
v
, 
pIdx
));

3099 if–!
zAff
 ){

3100 
pP¨£
->
db
->
mÆlocFaûed
 = 1;

3105 
	`as£π
–
	`idxCﬁumnCou¡
(
pIdx
, 
	`sqlôe4FödPrim¨yKey
’Idx->
pTabÀ
, 0))>=
nEq
 );

3106 
j
=0; j<
nEq
; j++){

3107 
r1
;

3108 
pTîm
 = 
pLo›
->
aLTîm
[
j
];

3109 
	`as£π
–
pTîm
!=0 );

3112 
	`ã°ˇ£
–(
pTîm
->
wtFœgs
 & 
TERM_CODED
)!=0 );

3113 
	`ã°ˇ£
–
pTîm
->
wtFœgs
 & 
TERM_VIRTUAL
 );

3114 
r1
 = 
	`codeEquÆôyTîm
(
pP¨£
, 
pTîm
, 
pLevñ
, 
j
, 
bRev
, 
ªgBa£
+j);

3115 if–
r1
!=
ªgBa£
+
j
 ){

3116 if–
nReg
==1 ){

3117 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
ªgBa£
);

3118 
ªgBa£
 = 
r1
;

3120 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_SC›y
, 
r1
, 
ªgBa£
+
j
);

3123 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_ISNULL
 );

3124 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_IN
 );

3125 if–(
pTîm
->
eO≥øt‹
 & (
WO_ISNULL
|
WO_IN
))==0 ){

3126 
Ex¥
 *
pRight
 = 
pTîm
->
pEx¥
->pRight;

3127 
	`sqlôe4Ex¥CodeIsNuŒJump
(
v
, 
pRight
, 
ªgBa£
+
j
, 
pLevñ
->
addrBrk
);

3128 if–
zAff
 ){

3129 if–
	`sqlôe4Com∑ªAfföôy
(
pRight
, 
zAff
[
j
])==
SQLITE4_AFF_NONE
 ){

3130 
zAff
[
j
] = 
SQLITE4_AFF_NONE
;

3132 if–
	`sqlôe4Ex¥NìdsNoAfföôyCh™ge
(
pRight
, 
zAff
[
j
]) ){

3133 
zAff
[
j
] = 
SQLITE4_AFF_NONE
;

3138 *
pzAff
 = 
zAff
;

3139  
ªgBa£
;

3140 
	}
}

3142 #i‚de‡
SQLITE4_OMIT_EXPLAIN


3151 
	$ex∂aöAµídTîm
(

3152 
SåAccum
 *
pSå
,

3153 
iTîm
,

3154 c⁄° *
zCﬁumn
,

3155 c⁄° *
zOp


3157 if–
iTîm
 ) 
	`sqlôe4SåAccumAµíd
(
pSå
, " AND ", 5);

3158 
	`sqlôe4SåAccumAµíd
(
pSå
, 
zCﬁumn
, -1);

3159 
	`sqlôe4SåAccumAµíd
(
pSå
, 
zOp
, 1);

3160 
	`sqlôe4SåAccumAµíd
(
pSå
, "?", 1);

3161 
	}
}

3182 *
	$ex∂aöIndexR™ge
(
sqlôe4
 *
db
, 
WhîeLo›
 *
pLo›
, 
TabÀ
 *
pTab
){

3183 
Index
 *
pIndex
 = 
pLo›
->
u
.
båì
.pIndex;

3184 
nEq
 = 
pLo›
->
u
.
båì
.nEq;

3185 
i
, 
j
;

3186 
Cﬁumn
 *
aCﬁ
 = 
pTab
->aCol;

3187 *
aiCﬁumn
 = 
pIndex
->aiColumn;

3188 
SåAccum
 
txt
;

3190 if–
nEq
==0 && (
pLo›
->
wsFœgs
 & (
WHERE_BTM_LIMIT
|
WHERE_TOP_LIMIT
))==0 ){

3193 
	`sqlôe4SåAccumInô
(&
txt
, 0, 0, 
SQLITE4_MAX_LENGTH
);

3194 
txt
.
db
 = db;

3195 
	`sqlôe4SåAccumAµíd
(&
txt
, " (", 2);

3196 
i
=0; i<
nEq
; i++){

3197 
	`ex∂aöAµídTîm
(&
txt
, 
i
, 
aCﬁ
[
aiCﬁumn
[i]].
zName
, "=");

3200 
j
 = 
i
;

3201 if–
pLo›
->
wsFœgs
&
WHERE_BTM_LIMIT
 ){

3202 *
z
 = (
j
==
pIndex
->
nCﬁumn
 ) ? "rowid" : 
aCﬁ
[
aiCﬁumn
[j]].
zName
;

3203 
	`ex∂aöAµídTîm
(&
txt
, 
i
++, 
z
, ">");

3205 if–
pLo›
->
wsFœgs
&
WHERE_TOP_LIMIT
 ){

3206 *
z
 = (
j
==
pIndex
->
nCﬁumn
 ) ? "rowid" : 
aCﬁ
[
aiCﬁumn
[j]].
zName
;

3207 
	`ex∂aöAµídTîm
(&
txt
, 
i
, 
z
, "<");

3209 
	`sqlôe4SåAccumAµíd
(&
txt
, ")", 1);

3210  
	`sqlôe4SåAccumFöish
(&
txt
);

3211 
	}
}

3219 
	$ex∂aöO√Sˇn
(

3220 
P¨£
 *
pP¨£
,

3221 
SrcLi°
 *
pTabLi°
,

3222 
WhîeLevñ
 *
pLevñ
,

3223 
iLevñ
,

3224 
iFrom
,

3225 
u16
 
w˘æFœgs


3227 if–
pP¨£
->
ex∂aö
==2 ){

3228 
SrcLi°Iãm
 *
pIãm
 = &
pTabLi°
->
a
[
pLevñ
->
iFrom
];

3229 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

3230 
sqlôe4
 *
db
 = 
pP¨£
->db;

3231 *
zMsg
;

3232 
iId
 = 
pP¨£
->
iSñe˘Id
;

3233 
isSórch
;

3234 
WhîeLo›
 *
pLo›
;

3235 
u32
 
Êags
;

3237 
pLo›
 = 
pLevñ
->
pWLo›
;

3238 
Êags
 = 
pLo›
->
wsFœgs
;

3239 if–(
Êags
&
WHERE_MULTI_OR
Ë|| (
w˘æFœgs
&
WHERE_ONETABLE_ONLY
) ) ;

3241 
isSórch
 = (
Êags
&(
WHERE_BTM_LIMIT
|
WHERE_TOP_LIMIT
))!=0

3242 || ((
Êags
&
WHERE_VIRTUALTABLE
)==0 && (
pLo›
->
u
.
båì
.
nEq
>0))

3243 || (
w˘æFœgs
&(
WHERE_ORDERBY_MIN
|
WHERE_ORDERBY_MAX
));

3245 
zMsg
 = 
	`sqlôe4MPrötf
(
db
, "%s", 
isSórch
?"SEARCH":"SCAN");

3246 if–
pIãm
->
pSñe˘
 ){

3247 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%†SUBQUERY %d", zMsg,
pIãm
->
iSñe˘Id
);

3249 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%†TABLE %s", zMsg, 
pIãm
->
zName
);

3252 if–
pIãm
->
zAlüs
 ){

3253 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%†AS %s", zMsg, 
pIãm
->
zAlüs
);

3255 if–(
Êags
 & 
WHERE_VIRTUALTABLE
)==0

3256 && 
	`ALWAYS
(
pLo›
->
u
.
båì
.
pIndex
!=0)

3258 *
zWhîe
 = 
	`ex∂aöIndexR™ge
(
db
, 
pLo›
, 
pIãm
->
pTab
);

3259 
Index
 *
pIdx
 = 
pLo›
->
u
.
båì
.
pIndex
;

3260 if–
Êags
 & 
WHERE_AUTO_INDEX
 ){

3261 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%s USING AUTOMATIC COVERING INDEX%s",

3262 
zMsg
, 
zWhîe


3264 }if–
pIdx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

3265 if–
isSórch
 ){

3266 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%s USING PRIMARY KEY%s",

3267 
zMsg
, 
zWhîe


3271 c⁄° *
zCovî
 = (
Êags
 & 
WHERE_IDX_ONLY
) ? " COVERING" : "";

3272 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%s USING%s INDEX %s%s",

3273 
zMsg
, 
zCovî
, 
pIdx
->
zName
, 
zWhîe


3276 
	`sqlôe4DbFªe
(
db
, 
zWhîe
);

3278 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


3279 if–(
Êags
 & 
WHERE_VIRTUALTABLE
)!=0 ){

3280 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%s VIRTUAL TABLE INDEX %d:%s", zMsg,

3281 
pLo›
->
u
.
vèb
.
idxNum
,ÖLo›->u.vèb.
idxSå
);

3284 
zMsg
 = 
	`sqlôe4MAµídf
(
db
, zMsg, "%s", zMsg);

3285 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_Ex∂aö
, 
iId
, 
iLevñ
, 
iFrom
, 
zMsg
, 
P4_DYNAMIC
);

3287 
	}
}

3289 
	#ex∂aöO√Sˇn
(
u
,
v
,
w
,
x
,
y
,
z
)

	)

3298 
	$födM©chEx¥
(

3299 
WhîeCœu£
 *
pWC
,

3300 
SrcLi°Iãm
 *
pTabIãm
,

3301 *
piTîm


3303 
i
;

3304 
iC§
 = 
pTabIãm
->
iCurs‹
;

3306 
i
=0; i<
pWC
->
nTîm
; i++){

3307 
Ex¥
 *
pM©ch
 = 
pWC
->
a
[
i
].
pEx¥
;

3308 if–
pM©ch
->
iTabÀ
==
iC§
 &&ÖM©ch->
›
==
TK_MATCH
 ) ;

3310 if–
i
==
pWC
->
nTîm
 )  0;

3312 *
piTîm
 = 
i
;

3314 
	}
}

3321 
Bômask
 
	$codeO√Lo›Sèπ
(

3322 
WhîeInfo
 *
pWInfo
,

3323 
iLevñ
,

3324 
Bômask
 
nŸRódy


3326 
j
, 
k
;

3327 
iCur
;

3328 
addrNxt
;

3329 
omôTabÀ
;

3330 
bRev
;

3331 
WhîeLevñ
 *
pLevñ
;

3332 
WhîeLo›
 *
pLo›
;

3333 
WhîeCœu£
 *
pWC
;

3334 
WhîeTîm
 *
pTîm
;

3335 
P¨£
 *
pP¨£
;

3336 
Vdbe
 *
v
;

3337 
SrcLi°Iãm
 *
pTabIãm
;

3338 
addrBrk
;

3339 
addrC⁄t
;

3340 
iRowidReg
 = 0;

3341 
iRñó£Reg
 = 0;

3342 
Bômask
 
√wNŸRódy
;

3344 
pP¨£
 = 
pWInfo
->pParse;

3345 
v
 = 
pP¨£
->
pVdbe
;

3346 
pWC
 = &
pWInfo
->
sWC
;

3347 
pLevñ
 = &
pWInfo
->
a
[
iLevñ
];

3348 
pLo›
 = 
pLevñ
->
pWLo›
;

3349 
pTabIãm
 = &
pWInfo
->
pTabLi°
->
a
[
pLevñ
->
iFrom
];

3350 
iCur
 = 
pTabIãm
->
iCurs‹
;

3351 
bRev
 = (
pWInfo
->
ªvMask
>>
iLevñ
)&1;

3352 
omôTabÀ
 = (
pLo›
->
wsFœgs
 & 
WHERE_IDX_ONLY
)!=0

3353 && (
pWInfo
->
w˘æFœgs
 & 
WHERE_FORCE_TABLE
)==0;

3354 
	`VdbeNo›Commít
((
v
, "Begö Joö Lo› %d", 
iLevñ
));

3366 
addrBrk
 = 
pLevñ
->addrBrk =ÖLevñ->
addrNxt
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3367 
addrC⁄t
 = 
pLevñ
->addrC⁄à
	`sqlôe4VdbeMakeLabñ
(
v
);

3373 if–
pLevñ
->
iFrom
>0 && (
pTabIãm
[0].
joöty≥
 & 
JT_LEFT
)!=0 ){

3374 
pLevñ
->
iLe·Joö
 = ++
pP¨£
->
nMem
;

3375 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
pLevñ
->
iLe·Joö
);

3376 
	`VdbeCommít
((
v
, "init LEFT JOINÇo-match flag"));

3381 if–
pTabIãm
->
vüC‹outöe
 ){

3382 
ªgYõld
 = 
pTabIãm
->
ªgRëu∫
;

3383 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
pTabIãm
->
addrFûlSub
-1, 
ªgYõld
);

3384 
pLevñ
->
p2
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Yõld
, 
ªgYõld
);

3385 
	`VdbeCommít
((
v
, "√xàrow o‡co-routöê%s", 
pTabIãm
->
pTab
->
zName
));

3386 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_If
, 
ªgYõld
+1, 
addrBrk
);

3387 
pLevñ
->
›
 = 
OP_GŸo
;

3391 if–(
pLo›
->
wsFœgs
 & 
WHERE_INDEXED
)

3392 && (
pLo›
->
u
.
båì
.
pIndex
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
)

3395 
iTîm
;

3396 
rM©ch
;

3397 
rFªe
;

3398 
	`födM©chEx¥
(
pWC
, 
pTabIãm
, &
iTîm
);

3400 
rM©ch
 = 
	`sqlôe4Ex¥CodeTemp
(
pP¨£
, 
pWC
->
a
[
iTîm
].
pEx¥
->
pRight
, &
rFªe
);

3401 
pWC
->
a
[
iTîm
].
wtFœgs
 |
TERM_CODED
;

3402 
	`sqlôe4Fts5CodeQuîy
(
pP¨£
,

3403 
pLo›
->
u
.
båì
.
pIndex
, 
pLevñ
->
iIdxCur
, 
addrBrk
, 
rM©ch


3405 
	`sqlôe4VdbeCh™geP5
(
v
, 
bRev
);

3406 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
rFªe
);

3408 
pLevñ
->
p2
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

3409 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_SìkPk
, 
iCur
, 0, 
pLevñ
->
iIdxCur
);

3410 
pLevñ
->
›
 = 
OP_FtsNext
;

3411 
pLevñ
->
p1
 =ÖLevñ->
iIdxCur
;

3414 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


3415 if–(
pLo›
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)!=0 ){

3419 
iReg
;

3420 
addrNŸFound
;

3421 
nC⁄°øöt
 = 
pLo›
->
nLTîm
;

3423 
	`sqlôe4Ex¥CachePush
(
pP¨£
);

3424 
iReg
 = 
	`sqlôe4GëTempR™ge
(
pP¨£
, 
nC⁄°øöt
+2);

3425 
addrNŸFound
 = 
pLevñ
->
addrBrk
;

3426 
j
=0; j<
nC⁄°øöt
; j++){

3427 
iT¨gë
 = 
iReg
+
j
+2;

3428 
pTîm
 = 
pLo›
->
aLTîm
[
j
];

3429 if–
pTîm
==0 ) ;

3430 if–
pTîm
->
eO≥øt‹
 & 
WO_IN
 ){

3431 
	`codeEquÆôyTîm
(
pP¨£
, 
pTîm
, 
pLevñ
, 
j
, 
bRev
, 
iT¨gë
);

3432 
addrNŸFound
 = 
pLevñ
->
addrNxt
;

3434 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pTîm
->
pEx¥
->
pRight
, 
iT¨gë
);

3437 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
pLo›
->
u
.
vèb
.
idxNum
, 
iReg
);

3438 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 
nC⁄°øöt
, 
iReg
+1);

3439 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VFûãr
, 
iCur
, 
addrNŸFound
, 
iReg
,

3440 
pLo›
->
u
.
vèb
.
idxSå
,

3441 
pLo›
->
u
.
vèb
.
√edFªe
 ? 
P4_DYNAMIC
 : 
P4_STATIC
);

3442 
pLo›
->
u
.
vèb
.
√edFªe
 = 0;

3443 
j
=0; j<
nC⁄°øöt
 && j<16; j++){

3444 if–(
pLo›
->
u
.
vèb
.
omôMask
>>
j
)&1 ){

3445 
	`dißbÀTîm
(
pLevñ
, 
pLo›
->
aLTîm
[
j
]);

3448 
pLevñ
->
›
 = 
OP_VNext
;

3449 
pLevñ
->
p1
 = 
iCur
;

3450 
pLevñ
->
p2
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

3451 
	`sqlôe4Rñó£TempR™ge
(
pP¨£
, 
iReg
, 
nC⁄°øöt
+2);

3452 
	`sqlôe4Ex¥CacheP›
(
pP¨£
, 1);

3456 if–
pLo›
->
wsFœgs
 & 
WHERE_INDEXED
 ){

3488 c⁄° 
u8
 
aSèπOp
[] = {

3491 
OP_Rewöd
,

3492 
OP_La°
,

3493 
OP_SìkGt
,

3494 
OP_SìkLt
,

3495 
OP_SìkGe
,

3496 
OP_SìkLe


3498 c⁄° 
u8
 
aEndOp
[] = {

3499 
OP_No›
,

3500 
OP_IdxGE
,

3501 
OP_IdxLE
,

3502 
OP_IdxGT
,

3503 
OP_IdxLT


3506 
nEq
 = 
pLo›
->
u
.
båì
.nEq;

3507 
isMöQuîy
 = 0;

3508 
ªgBa£
;

3509 
r1
;

3510 
WhîeTîm
 *
pR™geSèπ
 = 0;

3511 
WhîeTîm
 *
pR™geEnd
 = 0;

3512 
°¨tEq
;

3513 
ídEq
;

3514 
°¨t_c⁄°øöts
;

3515 
nC⁄°øöt
;

3516 
Index
 *
pIdx
;

3517 
iIdxCur
;

3518 
nExåaReg
 = 0;

3519 
›
;

3520 *
zSèπAff
;

3521 *
zEndAff
;

3522 
ªgEndKey
;

3523 
iI√q
;

3524 
Index
 *
pPk
;

3526 
pIdx
 = 
pLo›
->
u
.
båì
.
pIndex
;

3527 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pIdx
->
pTabÀ
, 0);

3528 
iI√q
 = 
	`idxCﬁumnNumbî
(
pIdx
, 
pPk
, 
nEq
);

3529 
iIdxCur
 = 
pLevñ
->iIdxCur;

3530 
	`as£π
–
iCur
==
pLevñ
->
iTabCur
 );

3540 if–(
pWInfo
->
w˘æFœgs
&
WHERE_ORDERBY_MIN
)!=0

3541 && (
pWInfo
->
bOBS©
!=0)

3542 && (
pIdx
->
nCﬁumn
>
nEq
)

3546 
isMöQuîy
 = 1;

3547 
nExåaReg
 = 1;

3553 
j
 = 
nEq
;

3554 if–
pLo›
->
wsFœgs
 & 
WHERE_BTM_LIMIT
 ){

3555 
pR™geSèπ
 = 
pLo›
->
aLTîm
[
j
++];

3556 
nExåaReg
 = 1;

3558 if–
pLo›
->
wsFœgs
 & 
WHERE_TOP_LIMIT
 ){

3559 
pR™geEnd
 = 
pLo›
->
aLTîm
[
j
++];

3560 
nExåaReg
 = 1;

3567 
ªgBa£
 = 
	`codeAŒEquÆôyTîms
(
pP¨£
,
pLevñ
,
bRev
,
nExåaReg
,&
zSèπAff
);

3568 
	`as£π
–(
ªgBa£
+
nEq
+
nExåaReg
-1)<=
pP¨£
->
nMem
 );

3569 
zEndAff
 = 
	`sqlôe4DbSåDup
(
pP¨£
->
db
, 
zSèπAff
);

3570 
addrNxt
 = 
pLevñ
->addrNxt;

3576 if–(
nEq
<
pIdx
->
nCﬁumn
 && 
bRev
==’Idx->
aS‹tOrdî
[nEq]==
SQLITE4_SO_ASC
))

3577 || (
bRev
 && 
pIdx
->
nCﬁumn
==
nEq
)

3579 
	`SWAP
(
WhîeTîm
 *, 
pR™geEnd
, 
pR™geSèπ
);

3582 
	`ã°ˇ£
–
pR™geSèπ
 && (pR™geSèπ->
eO≥øt‹
 & 
WO_LE
)!=0 );

3583 
	`ã°ˇ£
–
pR™geSèπ
 && (pR™geSèπ->
eO≥øt‹
 & 
WO_GE
)!=0 );

3584 
	`ã°ˇ£
–
pR™geEnd
 && (pR™geEnd->
eO≥øt‹
 & 
WO_LE
)!=0 );

3585 
	`ã°ˇ£
–
pR™geEnd
 && (pR™geEnd->
eO≥øt‹
 & 
WO_GE
)!=0 );

3586 
°¨tEq
 = !
pR™geSèπ
 ||ÖR™geSèπ->
eO≥øt‹
 & (
WO_LE
|
WO_GE
);

3587 
ídEq
 = !
pR™geEnd
 ||ÖR™geEnd->
eO≥øt‹
 & (
WO_LE
|
WO_GE
);

3588 
°¨t_c⁄°øöts
 = 
pR™geSèπ
 || 
nEq
>0;

3591 
nC⁄°øöt
 = 
nEq
;

3592 if–
pR™geSèπ
 ){

3593 
Ex¥
 *
pRight
 = 
pR™geSèπ
->
pEx¥
->pRight;

3594 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pRight
, 
ªgBa£
+
nEq
);

3595 if–(
pR™geSèπ
->
wtFœgs
 & 
TERM_VNULL
)==0 ){

3596 
	`sqlôe4Ex¥CodeIsNuŒJump
(
v
, 
pRight
, 
ªgBa£
+
nEq
, 
addrNxt
);

3598 if–
zSèπAff
 ){

3599 if–
	`sqlôe4Com∑ªAfföôy
(
pRight
, 
zSèπAff
[
nEq
])==
SQLITE4_AFF_NONE
){

3603 
zSèπAff
[
nEq
] = 
SQLITE4_AFF_NONE
;

3605 if–
	`sqlôe4Ex¥NìdsNoAfföôyCh™ge
(
pRight
, 
zSèπAff
[
nEq
]) ){

3606 
zSèπAff
[
nEq
] = 
SQLITE4_AFF_NONE
;

3609 
nC⁄°øöt
++;

3610 
	`ã°ˇ£
–
pR™geSèπ
->
wtFœgs
 & 
TERM_VIRTUAL
 );

3611 }if–
isMöQuîy
 ){

3612 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgBa£
+
nEq
);

3613 
nC⁄°øöt
++;

3614 
°¨tEq
 = 0;

3615 
°¨t_c⁄°øöts
 = 1;

3617 
	`codeAµlyAfföôy
(
pP¨£
, 
ªgBa£
, 
nC⁄°øöt
, 
zSèπAff
);

3618 
›
 = 
aSèπOp
[(
°¨t_c⁄°øöts
<<2Ë+ (
°¨tEq
<<1Ë+ 
bRev
];

3619 
	`as£π
–
›
!=0 );

3620 
	`ã°ˇ£
–
›
==
OP_Rewöd
 );

3621 
	`ã°ˇ£
–
›
==
OP_La°
 );

3622 
	`ã°ˇ£
–
›
==
OP_SìkGt
 );

3623 
	`ã°ˇ£
–
›
==
OP_SìkGe
 );

3624 
	`ã°ˇ£
–
›
==
OP_SìkLe
 );

3625 
	`ã°ˇ£
–
›
==
OP_SìkLt
 );

3626 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
›
, 
iIdxCur
, 
addrNxt
, 
ªgBa£
, 
nC⁄°øöt
);

3631 
	`as£π
–(
ídEq
==0 ||ÉndEq==1) );

3632 
›
 = 
aEndOp
[(
pR™geEnd
 || 
nEq
Ë* (1 + (
ídEq
+ídEqË+ 
bRev
)];

3633 
	`ã°ˇ£
–
›
==
OP_No›
 );

3634 
	`ã°ˇ£
–
›
==
OP_IdxGE
 );

3635 
	`ã°ˇ£
–
›
==
OP_IdxLT
 );

3636 
	`ã°ˇ£
–
›
==
OP_IdxLE
 );

3637 
	`ã°ˇ£
–
›
==
OP_IdxGT
 );

3639 if–
›
!=
OP_No›
 ){

3643 
nC⁄°øöt
 = 
nEq
;

3644 if–
pR™geEnd
 ){

3645 
Ex¥
 *
pRight
 = 
pR™geEnd
->
pEx¥
->pRight;

3646 
	`sqlôe4Ex¥CacheRemove
(
pP¨£
, 
ªgBa£
+
nEq
, 1);

3647 
	`sqlôe4Ex¥Code
(
pP¨£
, 
pRight
, 
ªgBa£
+
nEq
);

3648 if–(
pR™geEnd
->
wtFœgs
 & 
TERM_VNULL
)==0 ){

3649 
	`sqlôe4Ex¥CodeIsNuŒJump
(
v
, 
pRight
, 
ªgBa£
+
nEq
, 
addrNxt
);

3651 if–
zEndAff
 ){

3652 if–
	`sqlôe4Com∑ªAfföôy
(
pRight
, 
zEndAff
[
nEq
])==
SQLITE4_AFF_NONE
){

3656 
zEndAff
[
nEq
] = 
SQLITE4_AFF_NONE
;

3658 if–
	`sqlôe4Ex¥NìdsNoAfföôyCh™ge
(
pRight
, 
zEndAff
[
nEq
]) ){

3659 
zEndAff
[
nEq
] = 
SQLITE4_AFF_NONE
;

3662 
	`codeAµlyAfföôy
(
pP¨£
, 
ªgBa£
, 
nEq
+1, 
zEndAff
);

3663 
nC⁄°øöt
++;

3664 
	`ã°ˇ£
–
pR™geEnd
->
wtFœgs
 & 
TERM_VIRTUAL
 );

3668 
ªgEndKey
 = ++
pP¨£
->
nMem
;

3669 if–
pIdx
->
äum
==
KVSTORE_ROOT
 ){

3670 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_C›y
, 
ªgBa£
, 
ªgEndKey
);

3671 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_ToBlob
, 
ªgEndKey
);

3673 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_MakeKey
, 
ªgBa£
, 
nC⁄°øöt
, 
ªgEndKey
,

3674 
iIdxCur
);

3678 
	`sqlôe4DbFªe
(
pP¨£
->
db
, 
zSèπAff
);

3679 
	`sqlôe4DbFªe
(
pP¨£
->
db
, 
zEndAff
);

3682 
pLevñ
->
p2
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

3684 if–
›
!=
OP_No›
 ){

3685 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
›
, 
iIdxCur
, 
addrNxt
, 
ªgEndKey
, 
nC⁄°øöt
);

3689 
	`dißbÀTîm
(
pLevñ
, 
pR™geSèπ
);

3690 
	`dißbÀTîm
(
pLevñ
, 
pR™geEnd
);

3691 if–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY


3692 && 
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_TEMP


3693 && 0==(
pLo›
->
wsFœgs
 & 
WHERE_IDX_ONLY
)

3695 
	`sqlôe4VdbeAddOp3
(
v
, 
OP_SìkPk
, 
iCur
, 0, 
iIdxCur
);

3702 
r1
 = 
	`sqlôe4GëTempReg
(
pP¨£
);

3703 
	`ã°ˇ£
–
pLo›
->
wsFœgs
 & 
WHERE_BTM_LIMIT
 );

3704 
	`ã°ˇ£
–
pLo›
->
wsFœgs
 & 
WHERE_TOP_LIMIT
 );

3705 if–(
pLo›
->
wsFœgs
 & (
WHERE_BTM_LIMIT
|
WHERE_TOP_LIMIT
))!=0 ){

3706 
	`sqlôe4Ex¥CodeGëCﬁumnOfTabÀ
(
v
, 
pIdx
->
pTabÀ
, 
iCur
, 
iI√q
, 
r1
);

3707 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_IsNuŒ
, 
r1
, 
addrC⁄t
);

3709 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
r1
);

3714 if–
pLo›
->
wsFœgs
 & 
WHERE_ONEROW
 ){

3715 
pLevñ
->
›
 = 
OP_No›
;

3716 }if–
bRev
 ){

3717 
pLevñ
->
›
 = 
OP_Pªv
;

3719 
pLevñ
->
›
 = 
OP_Next
;

3721 
pLevñ
->
p1
 = 
iIdxCur
;

3722 if–(
pLo›
->
wsFœgs
 & 
WHERE_CONSTRAINT
)==0 ){

3723 
pLevñ
->
p5
 = 
SQLITE4_STMTSTATUS_FULLSCAN_STEP
;

3725 
	`as£π
–
pLevñ
->
p5
==0 );

3729 #i‚de‡
SQLITE4_OMIT_OR_OPTIMIZATION


3730 if–
pLo›
->
wsFœgs
 & 
WHERE_MULTI_OR
 ){

3770 
WhîeCœu£
 *
pOrWc
;

3771 
SrcLi°
 *
pOrTab
;

3772 
Index
 *
pCov
 = 0;

3773 
iCovCur
 = 
pP¨£
->
nTab
++;

3775 
ªgRëu∫
 = ++
pP¨£
->
nMem
;

3776 
ªgKey£t
 = 0;

3777 
ªgKey
 = 0;

3778 
iLo›Body
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

3779 
iRëInô
;

3780 
u¡e°edTîms
 = 0;

3781 
ii
;

3782 
Ex¥
 *
pAndEx¥
 = 0;

3784 
pTîm
 = 
pLo›
->
aLTîm
[0];

3785 
	`as£π
–
pTîm
!=0 );

3786 
	`as£π
–
pTîm
->
eO≥øt‹
 & 
WO_OR
 );

3787 
	`as£π
–(
pTîm
->
wtFœgs
 & 
TERM_ORINFO
)!=0 );

3788 
pOrWc
 = &
pTîm
->
u
.
pOrInfo
->
wc
;

3789 
pLevñ
->
›
 = 
OP_Rëu∫
;

3790 
pLevñ
->
p1
 = 
ªgRëu∫
;

3796 if–
pWInfo
->
nLevñ
>1 ){

3797 
nNŸRódy
;

3798 
SrcLi°Iãm
 *
‹igSrc
;

3799 
nNŸRódy
 = 
pWInfo
->
nLevñ
 - 
iLevñ
 - 1;

3800 
pOrTab
 = 
	`sqlôe4SèckAŒocRaw
(
pP¨£
->
db
,

3801 (*
pOrTab
)+ 
nNŸRódy
*’OrTab->
a
[0]));

3802 if–
pOrTab
==0 )  
nŸRódy
;

3803 
pOrTab
->
nAŒoc
 = (
u8
)(
nNŸRódy
 + 1);

3804 
pOrTab
->
nSrc
 =ÖOrTab->
nAŒoc
;

3805 
	`mem˝y
(
pOrTab
->
a
, 
pTabIãm
, (*pTabItem));

3806 
‹igSrc
 = 
pWInfo
->
pTabLi°
->
a
;

3807 
k
=1; k<=
nNŸRódy
; k++){

3808 
	`mem˝y
(&
pOrTab
->
a
[
k
], &
‹igSrc
[
pLevñ
[k].
iFrom
], (pOrTab->a[k]));

3811 
pOrTab
 = 
pWInfo
->
pTabLi°
;

3825 if–(
pWInfo
->
w˘æFœgs
 & 
WHERE_DUPLICATES_OK
)==0 ){

3826 
ªgKey£t
 = ++
pP¨£
->
nMem
;

3827 
ªgKey
 = ++
pP¨£
->
nMem
;

3828 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_NuŒ
, 0, 
ªgKey£t
);

3830 
iRëInô
 = 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 0, 
ªgRëu∫
);

3846 if–
pWC
->
nTîm
>1 ){

3847 
iTîm
;

3848 
iTîm
=0; iTîm<
pWC
->
nTîm
; iTerm++){

3849 
Ex¥
 *
pEx¥
 = 
pWC
->
a
[
iTîm
].pExpr;

3850 if–&
pWC
->
a
[
iTîm
] =
pTîm
 ) ;

3851 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_FromJoö
) ) ;

3852 if–
pWC
->
a
[
iTîm
].
wtFœgs
 & (
TERM_ORINFO
) ) ;

3853 if–(
pWC
->
a
[
iTîm
].
eO≥øt‹
 & 
WO_ALL
)==0 ) ;

3854 
pEx¥
 = 
	`sqlôe4Ex¥Dup
(
pP¨£
->
db
,ÖExpr, 0);

3855 
pAndEx¥
 = 
	`sqlôe4Ex¥And
(
pP¨£
->
db
,ÖAndEx¥, 
pEx¥
);

3857 if–
pAndEx¥
 ){

3858 
pAndEx¥
 = 
	`sqlôe4PEx¥
(
pP¨£
, 
TK_AND
, 0,ÖAndExpr, 0);

3862 
ii
=0; ii<
pOrWc
->
nTîm
; ii++){

3863 
WhîeTîm
 *
pOrTîm
 = &
pOrWc
->
a
[
ii
];

3864 if–
pOrTîm
->
À·Curs‹
==
iCur
 || (pOrTîm->
eO≥øt‹
 & 
WO_AND
)!=0 ){

3865 
WhîeInfo
 *
pSubWInfo
;

3866 
Ex¥
 *
pOrEx¥
 = 
pOrTîm
->
pEx¥
;

3867 if–
pAndEx¥
 && !
	`Ex¥HasPr›îty
(
pOrEx¥
, 
EP_FromJoö
) ){

3868 
pAndEx¥
->
pLe·
 = 
pOrEx¥
;

3869 
pOrEx¥
 = 
pAndEx¥
;

3872 
pSubWInfo
 = 
	`sqlôe4WhîeBegö
(
pP¨£
, 
pOrTab
, 
pOrEx¥
, 0, 0,

3873 
WHERE_OMIT_OPEN_CLOSE
 | 
WHERE_AND_ONLY
 |

3874 
WHERE_FORCE_TABLE
 | 
WHERE_ONETABLE_ONLY
, 
iCovCur
);

3875 
	`as£π
–
pSubWInfo
 || 
pP¨£
->
nEº
 ||ÖP¨£->
db
->
mÆlocFaûed
 );

3876 if–
pSubWInfo
 ){

3877 
WhîeLo›
 *
pSubLo›
;

3878 
	`ex∂aöO√Sˇn
(

3879 
pP¨£
, 
pOrTab
, &
pSubWInfo
->
a
[0], 
iLevñ
, 
pLevñ
->
iFrom
, 0

3881 if–(
pWInfo
->
w˘æFœgs
 & 
WHERE_DUPLICATES_OK
)==0 ){

3882 
iSë
 = ((
ii
==
pOrWc
->
nTîm
-1)?-1:ii);

3883 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_RowKey
, 
iCur
, 
ªgKey
);

3884 
	`sqlôe4VdbeAddOp4I¡
(
v
, 
OP_RowSëTe°
, 
ªgKey£t
,

3885 
	`sqlôe4VdbeCuºítAddr
(
v
)+2, 
ªgKey
, 
iSë
);

3887 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
ªgRëu∫
, 
iLo›Body
);

3894 if–
pSubWInfo
->
u¡e°edTîms
 ) untestedTerms = 1;

3908 
pSubLo›
 = 
pSubWInfo
->
a
[0].
pWLo›
;

3909 
	`as£π
–(
pSubLo›
->
wsFœgs
 & 
WHERE_AUTO_INDEX
)==0 );

3910 if–(
pSubLo›
->
wsFœgs
 & 
WHERE_INDEXED
)!=0

3911 && (
ii
==0 || 
pSubLo›
->
u
.
båì
.
pIndex
==
pCov
)

3913 
pCov
 = 
pSubLo›
->
u
.
båì
.
pIndex
;

3914 
	`as£π
–
pCov
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY


3915 || 
pSubWInfo
->
a
[0].
iIdxCur
==
iCovCur


3918 
pCov
 = 0;

3922 
	`sqlôe4WhîeEnd
(
pSubWInfo
);

3926 
	`as£π
–
pLevñ
->
u
.
pCovidx
==0 );

3927 if–
pCov
 &&ÖCov->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 ){

3928 
pLevñ
->
iIdxCur
 = 
iCovCur
;

3929 
pLevñ
->
u
.
pCovidx
 = 
pCov
;

3931 if–
pAndEx¥
 ){

3932 
pAndEx¥
->
pLe·
 = 0;

3933 
	`sqlôe4Ex¥Dñëe
(
pP¨£
->
db
, 
pAndEx¥
);

3935 
	`sqlôe4VdbeCh™geP1
(
v
, 
iRëInô
, 
	`sqlôe4VdbeCuºítAddr
(v));

3936 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
pLevñ
->
addrBrk
);

3937 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
iLo›Body
);

3939 if–
pWInfo
->
nLevñ
>1 ) 
	`sqlôe4SèckFªe
(
pP¨£
->
db
, 
pOrTab
);

3940 if–!
u¡e°edTîms
 ) 
	`dißbÀTîm
(
pLevñ
, 
pTîm
);

3950 c⁄° 
u8
 
aSãp
[] = { 
OP_Next
, 
OP_Pªv
 };

3951 c⁄° 
u8
 
aSèπ
[] = { 
OP_Rewöd
, 
OP_La°
 };

3952 
	`as£π
–
bRev
==0 || bRev==1 );

3953 
pLevñ
->
›
 = 
aSãp
[
bRev
];

3954 
pLevñ
->
p1
 = 
iCur
;

3955 
pLevñ
->
p2
 = 1 + 
	`sqlôe4VdbeAddOp2
(
v
, 
aSèπ
[
bRev
], 
iCur
, 
addrBrk
);

3956 
pLevñ
->
p5
 = 
SQLITE4_STMTSTATUS_FULLSCAN_STEP
;

3958 
√wNŸRódy
 = 
nŸRódy
 & ~
	`gëMask
(&
pWInfo
->
sMaskSë
, 
iCur
);

3967 
pTîm
=
pWC
->
a
, 
j
ıWC->
nTîm
; j>0; j--,ÖTerm++){

3968 
Ex¥
 *
pE
;

3969 
	`ã°ˇ£
–
pTîm
->
wtFœgs
 & 
TERM_VIRTUAL
 );

3970 
	`ã°ˇ£
–
pTîm
->
wtFœgs
 & 
TERM_CODED
 );

3971 if–
pTîm
->
wtFœgs
 & (
TERM_VIRTUAL
|
TERM_CODED
) ) ;

3972 if–(
pTîm
->
¥îeqAŒ
 & 
√wNŸRódy
)!=0 ){

3973 
	`ã°ˇ£
–
pWInfo
->
u¡e°edTîms
==0

3974 && (
pWInfo
->
w˘æFœgs
 & 
WHERE_ONETABLE_ONLY
)!=0 );

3975 
pWInfo
->
u¡e°edTîms
 = 1;

3978 
pE
 = 
pTîm
->
pEx¥
;

3979 
	`as£π
–
pE
!=0 );

3980 if–
pLevñ
->
iLe·Joö
 && !
	`Ex¥HasPr›îty
(
pE
, 
EP_FromJoö
) ){

3983 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pE
, 
addrC⁄t
, 
SQLITE4_JUMPIFNULL
);

3984 
pTîm
->
wtFœgs
 |
TERM_CODED
;

3995 
pTîm
=
pWC
->
a
, 
j
ıWC->
nTîm
; j>0; j--,ÖTerm++){

3996 
Ex¥
 *
pE
;

3997 
WhîeTîm
 *
pA…
;

3998 
Ex¥
 
sEq
;

3999 if–
pTîm
->
wtFœgs
 & (
TERM_VIRTUAL
|
TERM_CODED
) ) ;

4000 if–
pTîm
->
eO≥øt‹
!=(
WO_EQUIV
|
WO_EQ
) ) ;

4001 if–
pTîm
->
À·Curs‹
!=
iCur
 ) ;

4002 if–
pLevñ
->
iLe·Joö
 ) ;

4003 
pE
 = 
pTîm
->
pEx¥
;

4004 
	`as£π
–!
	`Ex¥HasPr›îty
(
pE
, 
EP_FromJoö
) );

4005 
	`as£π
–(
pTîm
->
¥îeqRight
 & 
√wNŸRódy
)!=0 );

4006 
pA…
 = 
	`födTîm
(
pWC
, 
iCur
, 
pTîm
->
u
.
À·Cﬁumn
, 
nŸRódy
, 
WO_EQ
|
WO_IN
, 0);

4007 if–
pA…
==0 ) ;

4008 if–
pA…
->
wtFœgs
 & (
TERM_CODED
) ) ;

4009 
	`ã°ˇ£
–
pA…
->
eO≥øt‹
 & 
WO_EQ
 );

4010 
	`ã°ˇ£
–
pA…
->
eO≥øt‹
 & 
WO_IN
 );

4011 
	`VdbeNo›Commít
((
v
, "beginÅransitive constraint"));

4012 
sEq
 = *
pA…
->
pEx¥
;

4013 
sEq
.
pLe·
 = 
pE
->pLeft;

4014 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, &
sEq
, 
addrC⁄t
, 
SQLITE4_JUMPIFNULL
);

4020 if–
pLevñ
->
iLe·Joö
 ){

4021 
pLevñ
->
addrFú°
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

4022 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_I¡egî
, 1, 
pLevñ
->
iLe·Joö
);

4023 
	`VdbeCommít
((
v
, "record LEFT JOIN hit"));

4024 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

4025 
pTîm
=
pWC
->
a
, 
j
=0; j<pWC->
nTîm
; j++,ÖTerm++){

4026 
	`ã°ˇ£
–
pTîm
->
wtFœgs
 & 
TERM_VIRTUAL
 );

4027 
	`ã°ˇ£
–
pTîm
->
wtFœgs
 & 
TERM_CODED
 );

4028 if–
pTîm
->
wtFœgs
 & (
TERM_VIRTUAL
|
TERM_CODED
) ) ;

4029 if–(
pTîm
->
¥îeqAŒ
 & 
√wNŸRódy
)!=0 ){

4030 
	`as£π
–
pWInfo
->
u¡e°edTîms
 );

4033 
	`as£π
–
pTîm
->
pEx¥
 );

4034 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pTîm
->
pEx¥
, 
addrC⁄t
, 
SQLITE4_JUMPIFNULL
);

4035 
pTîm
->
wtFœgs
 |
TERM_CODED
;

4038 
	`sqlôe4Rñó£TempReg
(
pP¨£
, 
iRñó£Reg
);

4040  
√wNŸRódy
;

4041 
	}
}

4043 #ifde‡
WHERETRACE_ENABLED


4047 
	$whîeLo›Pröt
(
WhîeLo›
 *
p
, 
SrcLi°
 *
pTabLi°
){

4048 
nb
 = 1+(
pTabLi°
->
nSrc
+7)/8;

4049 
SrcLi°Iãm
 *
pIãm
 = 
pTabLi°
->
a
 + 
p
->
iTab
;

4050 
TabÀ
 *
pTab
 = 
pIãm
->pTab;

4051 
	`sqlôe4DebugPrötf
("%c%2d.%0*Œx.%0*Œx", 
p
->
cId
,

4052 
p
->
iTab
, 
nb
,Ö->
maskSñf
,Çb,Ö->
¥îeq
);

4053 
	`sqlôe4DebugPrötf
(" %12s",

4054 
pIãm
->
zAlüs
 ?ÖIãm->zAlü†: 
pTab
->
zName
);

4055 if–(
p
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)==0 ){

4056 if–
p
->
u
.
båì
.
pIndex
 ){

4057 c⁄° *
zName
 = 
p
->
u
.
båì
.
pIndex
->zName;

4058 if–
zName
==0 ) zName = "ipk";

4059 if–
	`°∫cmp
(
zName
, "sqlite_autoindex_", 17)==0 ){

4060 
i
 = 
	`sqlôe4SåÀn30
(
zName
) - 1;

4061  
zName
[
i
]!='_' ) i--;

4062 
zName
 +
i
;

4064 
	`sqlôe4DebugPrötf
(".%-16†%2d", 
zName
, 
p
->
u
.
båì
.
nEq
);

4066 
	`sqlôe4DebugPrötf
("%20s","");

4069 *
z
;

4070 if–
p
->
u
.
vèb
.
idxSå
 ){

4071 
z
 = 
	`sqlôe4_m¥ötf
(0, "(%d,\"%s\",%x)",

4072 
p
->
u
.
vèb
.
idxNum
,Ö->u.vèb.
idxSå
,Ö->u.vèb.
omôMask
);

4074 
z
 = 
	`sqlôe4_m¥ötf
(0, "(%d,%x)", 
p
->
u
.
vèb
.
idxNum
,Ö->u.vèb.
omôMask
);

4076 
	`sqlôe4DebugPrötf
(" %-19s", 
z
);

4077 
	`sqlôe4_‰ì
(0, 
z
);

4079 
	`sqlôe4DebugPrötf
(" f %04x N %d", 
p
->
wsFœgs
,Ö->
nLTîm
);

4080 
	`sqlôe4DebugPrötf
(" co° %d,%d,%d\n", 
p
->
rSëup
,Ö->
rRun
,Ö->
nOut
);

4081 
	}
}

4088 
	$whîeLo›Inô
(
WhîeLo›
 *
p
){

4089 
p
->
aLTîm
 =Ö->
aLTîmS∑˚
;

4090 
p
->
nLTîm
 = 0;

4091 
p
->
nLSlŸ
 = 
	`AºaySize
’->
aLTîmS∑˚
);

4092 
p
->
wsFœgs
 = 0;

4093 
	}
}

4098 
	$whîeLo›CÀ¨Uni⁄
(
sqlôe4
 *
db
, 
WhîeLo›
 *
p
){

4099 if–
p
->
wsFœgs
 & (
WHERE_VIRTUALTABLE
|
WHERE_AUTO_INDEX
) ){

4100 if–(
p
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)!=0 &&Ö->
u
.
vèb
.
√edFªe
 ){

4102 
	`sqlôe4_‰ì
(
p
->
u
.
vèb
.
idxSå
);

4104 
p
->
u
.
vèb
.
√edFªe
 = 0;

4105 
p
->
u
.
vèb
.
idxSå
 = 0;

4106 }if–(
p
->
wsFœgs
 & 
WHERE_AUTO_INDEX
)!=0 &&Ö->
u
.
båì
.
pIndex
!=0 ){

4107 
	`sqlôe4DbFªe
(
db
, 
p
->
u
.
båì
.
pIndex
->
zCﬁAff
);

4108 
	`sqlôe4DbFªe
(
db
, 
p
->
u
.
båì
.
pIndex
);

4109 
p
->
u
.
båì
.
pIndex
 = 0;

4112 
	}
}

4117 
	$whîeLo›CÀ¨
(
sqlôe4
 *
db
, 
WhîeLo›
 *
p
){

4118 if–
p
->
aLTîm
!ı->
aLTîmS∑˚
 ) 
	`sqlôe4DbFªe
(
db
,Ö->aLTerm);

4119 
	`whîeLo›CÀ¨Uni⁄
(
db
, 
p
);

4120 
	`whîeLo›Inô
(
p
);

4121 
	}
}

4126 
	$whîeLo›Resize
(
sqlôe4
 *
db
, 
WhîeLo›
 *
p
, 
n
){

4127 
WhîeTîm
 **
∑New
;

4128 if–
p
->
nLSlŸ
>=
n
 )  
SQLITE4_OK
;

4129 
n
 = (n+7)&~7;

4130 
∑New
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (
p
->
aLTîm
[0])*
n
);

4131 if–
∑New
==0 )  
SQLITE4_NOMEM
;

4132 
	`mem˝y
(
∑New
, 
p
->
aLTîm
, ’->aLTîm[0])*p->
nLSlŸ
);

4133 if–
p
->
aLTîm
!ı->
aLTîmS∑˚
 ) 
	`sqlôe4DbFªe
(
db
,Ö->aLTerm);

4134 
p
->
aLTîm
 = 
∑New
;

4135 
p
->
nLSlŸ
 = 
n
;

4136  
SQLITE4_OK
;

4137 
	}
}

4142 
	$whîeLo›X„r
(
sqlôe4
 *
db
, 
WhîeLo›
 *
pTo
, WhîeLo› *
pFrom
){

4143 if–
	`whîeLo›Resize
(
db
, 
pTo
, 
pFrom
->
nLTîm
ËË 
SQLITE4_NOMEM
;

4144 
	`whîeLo›CÀ¨Uni⁄
(
db
, 
pTo
);

4145 
	`mem˝y
(
pTo
, 
pFrom
, 
WHERE_LOOP_XFER_SZ
);

4146 
	`mem˝y
(
pTo
->
aLTîm
, 
pFrom
->aLTîm,ÖTo->
nLTîm
*(pTo->aLTerm[0]));

4147 if–
pFrom
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
 ){

4148 
pFrom
->
u
.
vèb
.
√edFªe
 = 0;

4149 }if–(
pFrom
->
wsFœgs
 & 
WHERE_AUTO_INDEX
)!=0 ){

4150 
pFrom
->
u
.
båì
.
pIndex
 = 0;

4152  
SQLITE4_OK
;

4153 
	}
}

4158 
	$whîeLo›Dñëe
(
sqlôe4
 *
db
, 
WhîeLo›
 *
p
){

4159 
	`whîeLo›CÀ¨
(
db
, 
p
);

4160 
	`sqlôe4DbFªe
(
db
, 
p
);

4161 
	}
}

4166 
	$whîeInfoFªe
(
sqlôe4
 *
db
, 
WhîeInfo
 *
pWInfo
){

4167 if–
	`ALWAYS
(
pWInfo
) ){

4168 
	`whîeCœu£CÀ¨
(&
pWInfo
->
sWC
);

4169  
pWInfo
->
pLo›s
 ){

4170 
WhîeLo›
 *
p
 = 
pWInfo
->
pLo›s
;

4171 
pWInfo
->
pLo›s
 = 
p
->
pNextLo›
;

4172 
	`whîeLo›Dñëe
(
db
, 
p
);

4174 
	`sqlôe4DbFªe
(
db
, 
pWInfo
);

4176 
	}
}

4204 
	$whîeLo›In£π
(
WhîeLo›Buûdî
 *
pBuûdî
, 
WhîeLo›
 *
pTem∂©e
){

4205 
WhîeLo›
 **
µPªv
, *
p
, *
pNext
 = 0;

4206 
WhîeInfo
 *
pWInfo
 = 
pBuûdî
->pWInfo;

4207 
sqlôe4
 *
db
 = 
pWInfo
->
pP¨£
->db;

4209 
	`as£π
–
pTem∂©e
->
u
.
båì
.
pIndex
 || !’Tem∂©e->
wsFœgs
 & 
WHERE_INDEXED
) );

4214 if–
pBuûdî
->
pOrSë
!=0 ){

4215 #i‡
WHERETRACE_ENABLED


4216 
u16
 
n
 = 
pBuûdî
->
pOrSë
->n;

4217 
x
 =

4219 
	`whîeOrIn£π
(
pBuûdî
->
pOrSë
, 
pTem∂©e
->
¥îeq
,ÖTem∂©e->
rRun
,

4220 
pTem∂©e
->
nOut
);

4221 #i‡
WHERETRACE_ENABLED


4222 if–
sqlôe4WhîeTø˚
 & 0x8 ){

4224 
	`sqlôe4DebugPrötf
(
x
?" or-%d: ":" or-X: ", 
n
);

4225 
	`whîeLo›Pröt
(
pTem∂©e
, 
pWInfo
->
pTabLi°
);

4228  
SQLITE4_OK
;

4234 
µPªv
=&
pWInfo
->
pLo›s
, 
p
=*µPªv;Ö;ÖpPªv=&p->
pNextLo›
,Ö=*ppPrev){

4235 if–
p
->
iTab
!=
pTem∂©e
->iTab ||Ö->
iS‹tIdx
!=pTemplate->iSortIdx ){

4244 
	`as£π
–
p
->
rSëup
==0 || 
pTem∂©e
->rSetup==0

4245 || 
p
->
rSëup
==
pTem∂©e
->rSetup );

4250 
	`as£π
–
p
->
rSëup
>=
pTem∂©e
->rSetup );

4252 if–(
p
->
¥îeq
 & 
pTem∂©e
->prereq)==p->prereq

4253 && 
p
->
rSëup
<=
pTem∂©e
->rSetup

4254 && 
p
->
rRun
<=
pTem∂©e
->rRun

4258 
	`as£π
–
p
->
rSëup
==
pTem∂©e
->rSetup );

4259 if–
p
->
nLTîm
<
pTem∂©e
->nLTerm

4260 && (
p
->
wsFœgs
 & 
WHERE_INDEXED
)!=0

4261 && (
pTem∂©e
->
wsFœgs
 & 
WHERE_INDEXED
)!=0

4262 && 
p
->
u
.
båì
.
pIndex
==
pTem∂©e
->u.btree.pIndex

4263 && 
p
->
¥îeq
==
pTem∂©e
->prereq

4267 
pNext
 = 
p
->
pNextLo›
;

4272 
whîeLo›In£π_no›
;

4275 if–(
p
->
¥îeq
 & 
pTem∂©e
->prereq)==pTemplate->prereq

4276 && 
p
->
rRun
>=
pTem∂©e
->rRun

4277 && 
	`ALWAYS
(
p
->
rSëup
>=
pTem∂©e
->rSetup)

4282 
pNext
 = 
p
->
pNextLo›
;

4291 #i‡
WHERETRACE_ENABLED


4292 if–
sqlôe4WhîeTø˚
 & 0x8 ){

4293 if–
p
!=0 ){

4294 
	`sqlôe4DebugPrötf
("ins-del: ");

4295 
	`whîeLo›Pröt
(
p
, 
pWInfo
->
pTabLi°
);

4297 
	`sqlôe4DebugPrötf
("ins-new: ");

4298 
	`whîeLo›Pröt
(
pTem∂©e
, 
pWInfo
->
pTabLi°
);

4301 if–
p
==0 ){

4302 
p
 = 
	`sqlôe4DbMÆlocRaw
(
db
, (
WhîeLo›
));

4303 if–
p
==0 )  
SQLITE4_NOMEM
;

4304 
	`whîeLo›Inô
(
p
);

4306 
	`whîeLo›X„r
(
db
, 
p
, 
pTem∂©e
);

4307 
p
->
pNextLo›
 = 
pNext
;

4308 *
µPªv
 = 
p
;

4309 if–(
p
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)==0 ){

4310 
Index
 *
pIndex
 = 
p
->
u
.
båì
.pIndex;

4311 if–
pIndex
 &&ÖIndex->
äum
==0 ){

4312 
p
->
u
.
båì
.
pIndex
 = 0;

4315  
SQLITE4_OK
;

4318 
whîeLo›In£π_no›
:

4319 #i‡
WHERETRACE_ENABLED


4320 if–
sqlôe4WhîeTø˚
 & 0x8 ){

4321 
	`sqlôe4DebugPrötf
("ins-noop: ");

4322 
	`whîeLo›Pröt
(
pTem∂©e
, 
pWInfo
->
pTabLi°
);

4325  
SQLITE4_OK
;

4326 
	}
}

4333 
	$whîeLo›AddBåìIndex
(

4334 
WhîeLo›Buûdî
 *
pBuûdî
,

4335 
SrcLi°Iãm
 *
pSrc
,

4336 
Index
 *
pProbe
,

4337 
WhîeCo°
 
nInMul


4339 
WhîeInfo
 *
pWInfo
 = 
pBuûdî
->pWInfo;

4340 
P¨£
 *
pP¨£
 = 
pWInfo
->pParse;

4341 
sqlôe4
 *
db
 = 
pP¨£
->db;

4342 
WhîeLo›
 *
pNew
;

4343 
WhîeTîm
 *
pTîm
;

4344 
›Mask
;

4345 
WhîeSˇn
 
sˇn
;

4346 
Bômask
 
ßved_¥îeq
;

4347 
u16
 
ßved_nLTîm
;

4348 
ßved_nEq
;

4349 
u32
 
ßved_wsFœgs
;

4350 
WhîeCo°
 
ßved_nOut
;

4351 
iCﬁ
;

4352 
rc
 = 
SQLITE4_OK
;

4353 
WhîeCo°
 
nRowE°
;

4354 
WhîeCo°
 
rLogSize
;

4355 
WhîeTîm
 *
pT›
 = 0, *
pBtm
 = 0;

4357 
	`as£π
–
pProbe
->
eIndexTy≥
==
SQLITE4_INDEX_USER


4358 || 
pProbe
->
eIndexTy≥
==
SQLITE4_INDEX_UNIQUE


4359 || 
pProbe
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY


4362 
pNew
 = 
pBuûdî
->pNew;

4363 if–
db
->
mÆlocFaûed
 )  
SQLITE4_NOMEM
;

4365 
	`as£π
–(
pNew
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)==0 );

4366 
	`as£π
–(
pNew
->
wsFœgs
 & 
WHERE_TOP_LIMIT
)==0 );

4367 if–
pNew
->
wsFœgs
 & 
WHERE_BTM_LIMIT
 ){

4368 
›Mask
 = 
WO_LT
|
WO_LE
;

4369 }if–
pProbe
->
äum
<=0 || (
pSrc
->
joöty≥
 & 
JT_LEFT
)!=0 ){

4370 
›Mask
 = 
WO_EQ
|
WO_IN
|
WO_GT
|
WO_GE
|
WO_LT
|
WO_LE
;

4372 
›Mask
 = 
WO_EQ
|
WO_IN
|
WO_ISNULL
|
WO_GT
|
WO_GE
|
WO_LT
|
WO_LE
;

4374 if–
pProbe
->
bUn‹dîed
 ) 
›Mask
 &~(
WO_GT
|
WO_GE
|
WO_LT
|
WO_LE
);

4376 if–
pNew
->
u
.
båì
.
nEq
 < 
pProbe
->
nCﬁumn
 ){

4377 
iCﬁ
 = 
pProbe
->
aiCﬁumn
[
pNew
->
u
.
båì
.
nEq
];

4378 
nRowE°
 = 
	`whîeCo°
(
pProbe
->
aiRowE°
[
pNew
->
u
.
båì
.
nEq
+1]);

4379 if–
nRowE°
==0 && 
pProbe
->
⁄Eº‹
==
OE_N⁄e
 )ÇRowEst = 1;

4380 }if–
pProbe
->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 ){

4381 
Index
 *
pPk
;

4382 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pProbe
->
pTabÀ
, 0);

4383 
iCﬁ
 = 
	`idxCﬁumnNumbî
(
pProbe
, 
pPk
, 
pNew
->
u
.
båì
.
nEq
);

4384 
nRowE°
 = 0;

4386  
SQLITE4_OK
;

4388 
	`as£π
–
iCﬁ
>=-1 );

4389 
pTîm
 = 
	`whîeSˇnInô
(&
sˇn
, 
pBuûdî
->
pWC
, 
pSrc
->
iCurs‹
, 
iCﬁ
,

4390 
›Mask
, 
pProbe
);

4391 
ßved_nEq
 = 
pNew
->
u
.
båì
.
nEq
;

4392 
ßved_nLTîm
 = 
pNew
->
nLTîm
;

4393 
ßved_wsFœgs
 = 
pNew
->
wsFœgs
;

4394 
ßved_¥îeq
 = 
pNew
->
¥îeq
;

4395 
ßved_nOut
 = 
pNew
->
nOut
;

4396 
pNew
->
rSëup
 = 0;

4397 
rLogSize
 = 
	`e°Log
(
	`whîeCo°
(
pProbe
->
aiRowE°
[0]));

4398 ; 
rc
==
SQLITE4_OK
 && 
pTîm
!=0;ÖTîm = 
	`whîeSˇnNext
(&
sˇn
)){

4399 
nIn
 = 0;

4400 if–
pTîm
->
¥îeqRight
 & 
pNew
->
maskSñf
 ) ;

4401 #ifde‡
SQLITE4_ENABLE_STAT3


4402 if–(
pTîm
->
wtFœgs
 & 
TERM_VNULL
)!=0 && 
pSrc
->
pTab
->
aCﬁ
[
iCﬁ
].
nŸNuŒ
 ){

4406 
pNew
->
wsFœgs
 = 
ßved_wsFœgs
;

4407 
pNew
->
u
.
båì
.
nEq
 = 
ßved_nEq
;

4408 
pNew
->
nLTîm
 = 
ßved_nLTîm
;

4409 if–
	`whîeLo›Resize
(
db
, 
pNew
,ÖNew->
nLTîm
+1) ) ;

4410 
pNew
->
aLTîm
[pNew->
nLTîm
++] = 
pTîm
;

4411 
pNew
->
¥îeq
 = (
ßved_¥îeq
 | 
pTîm
->
¥îeqRight
Ë& ~pNew->
maskSñf
;

4412 
pNew
->
rRun
 = 
rLogSize
;

4413 if–
pTîm
->
eO≥øt‹
 & 
WO_IN
 ){

4414 
Ex¥
 *
pEx¥
 = 
pTîm
->pExpr;

4415 
pNew
->
wsFœgs
 |
WHERE_COLUMN_IN
;

4416 if–
	`Ex¥HasPr›îty
(
pEx¥
, 
EP_xIsSñe˘
) ){

4418 
nIn
 = 46; 
	`as£π
–46==
	`whîeCo°
(25) );

4419 }if–
	`ALWAYS
(
pEx¥
->
x
.
pLi°
 &&ÖEx¥->x.pLi°->
nEx¥
) ){

4421 
nIn
 = 
	`whîeCo°
(
pEx¥
->
x
.
pLi°
->
nEx¥
);

4423 
pNew
->
rRun
 +
nIn
;

4424 
pNew
->
u
.
båì
.
nEq
++;

4425 
pNew
->
nOut
 = 
nRowE°
 + 
nInMul
 + 
nIn
;

4426 }if–
pTîm
->
eO≥øt‹
 & (
WO_EQ
) ){

4427 
	`as£π
–(
pNew
->
wsFœgs
 & (
WHERE_COLUMN_NULL
|
WHERE_COLUMN_IN
))!=0

4428 || 
nInMul
==0 );

4429 
pNew
->
wsFœgs
 |
WHERE_COLUMN_EQ
;

4430 if–
iCﬁ
<0

4431 || (
pProbe
->
⁄Eº‹
!=
OE_N⁄e
 && 
nInMul
==0

4432 && 
pNew
->
u
.
båì
.
nEq
==
pProbe
->
nCﬁumn
-1)

4434 
	`as£π
–(
pNew
->
wsFœgs
 & 
WHERE_COLUMN_IN
)==0 || 
iCﬁ
<0 );

4435 
pNew
->
wsFœgs
 |
WHERE_ONEROW
;

4437 
pNew
->
u
.
båì
.
nEq
++;

4438 
pNew
->
nOut
 = 
nRowE°
 + 
nInMul
;

4439 }if–
pTîm
->
eO≥øt‹
 & (
WO_ISNULL
) ){

4440 
pNew
->
wsFœgs
 |
WHERE_COLUMN_NULL
;

4441 
pNew
->
u
.
båì
.
nEq
++;

4443 
nIn
 = 10; 
	`as£π
–10==
	`whîeCo°
(2) );

4444 
pNew
->
nOut
 = 
nRowE°
 + 
nInMul
 + 
nIn
;

4445 }if–
pTîm
->
eO≥øt‹
 & (
WO_GT
|
WO_GE
) ){

4446 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_GT
 );

4447 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_GE
 );

4448 
pNew
->
wsFœgs
 |
WHERE_COLUMN_RANGE
|
WHERE_BTM_LIMIT
;

4449 
pBtm
 = 
pTîm
;

4450 
pT›
 = 0;

4452 
	`as£π
–
pTîm
->
eO≥øt‹
 & (
WO_LT
|
WO_LE
) );

4453 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_LT
 );

4454 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_LE
 );

4455 
pNew
->
wsFœgs
 |
WHERE_COLUMN_RANGE
|
WHERE_TOP_LIMIT
;

4456 
pT›
 = 
pTîm
;

4457 
pBtm
 = (
pNew
->
wsFœgs
 & 
WHERE_BTM_LIMIT
)!=0 ?

4458 
pNew
->
aLTîm
[pNew->
nLTîm
-2] : 0;

4460 if–
pNew
->
wsFœgs
 & 
WHERE_COLUMN_RANGE
 ){

4462 
WhîeCo°
 
rDiv
;

4463 
	`whîeR™geSˇnE°
(
pP¨£
, 
pProbe
, 
pNew
->
u
.
båì
.
nEq
,

4464 
pBtm
, 
pT›
, &
rDiv
);

4465 
pNew
->
nOut
 = 
ßved_nOut
>
rDiv
+10 ? saved_nOut -ÑDiv : 10;

4467 #ifde‡
SQLITE4_ENABLE_STAT3


4468 if–
pNew
->
u
.
båì
.
nEq
==1 && 
pProbe
->
nSam∂e


4469 && 
	`O±imiz©i⁄E«bÀd
(
db
, 
SQLITE4_Sèt3
) ){

4470 
tRow˙t
 
nOut
 = 0;

4471 if–(
pTîm
->
eO≥øt‹
 & (
WO_EQ
|
WO_ISNULL
))!=0 ){

4472 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_EQ
 );

4473 
	`ã°ˇ£
–
pTîm
->
eO≥øt‹
 & 
WO_ISNULL
 );

4474 
rc
 = 
	`whîeEquÆSˇnE°
(
pP¨£
, 
pProbe
, 
pTîm
->
pEx¥
->
pRight
, &
nOut
);

4475 }if–(
pTîm
->
eO≥øt‹
 & 
WO_IN
)

4476 && !
	`Ex¥HasPr›îty
(
pTîm
->
pEx¥
, 
EP_xIsSñe˘
) ){

4477 
rc
 = 
	`whîeInSˇnE°
(
pP¨£
, 
pProbe
, 
pTîm
->
pEx¥
->
x
.
pLi°
, &
nOut
);

4479 if–
rc
==
SQLITE4_OK
 ) 
pNew
->
nOut
 = 
	`whîeCo°
(nOut);

4482 if–(
pNew
->
wsFœgs
 & (
WHERE_IDX_ONLY
|
WHERE_PRIMARY_KEY
))==0 ){

4485 
pNew
->
rRun
 = 
	`whîeCo°Add
’New->rRun, 
rLogSize
>27 ?ÑLogSize-17 : 10);

4488 
pNew
->
rRun
 = 
	`whîeCo°Add
’New->rRun,ÖNew->
nOut
);

4490 
rc
 = 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

4491 if–(
pNew
->
wsFœgs
 & 
WHERE_TOP_LIMIT
)==0

4492 && 
pNew
->
u
.
båì
.
nEq
<(
pProbe
->
nCﬁumn
 + (pProbe->
zName
!=0))

4494 
	`whîeLo›AddBåìIndex
(
pBuûdî
, 
pSrc
, 
pProbe
, 
nInMul
+
nIn
);

4497 
pNew
->
¥îeq
 = 
ßved_¥îeq
;

4498 
pNew
->
u
.
båì
.
nEq
 = 
ßved_nEq
;

4499 
pNew
->
wsFœgs
 = 
ßved_wsFœgs
;

4500 
pNew
->
nOut
 = 
ßved_nOut
;

4501 
pNew
->
nLTîm
 = 
ßved_nLTîm
;

4502  
rc
;

4503 
	}
}

4513 
	$ödexMightHñpWôhOrdîBy
(

4514 
WhîeLo›Buûdî
 *
pBuûdî
,

4515 
Index
 *
pIndex
,

4516 
iCurs‹


4518 
Ex¥Li°
 *
pOB
;

4519 
ii
, 
jj
;

4521 if–
pIndex
->
bUn‹dîed
 )  0;

4522 if–(
pOB
 = 
pBuûdî
->
pWInfo
->
pOrdîBy
)==0 )  0;

4523 
ii
=0; ii<
pOB
->
nEx¥
; ii++){

4524 
Ex¥
 *
pEx¥
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pOB
->
a
[
ii
].pExpr);

4525 if–
pEx¥
->
›
!=
TK_COLUMN
 )  0;

4526 if–
pEx¥
->
iTabÀ
==
iCurs‹
 ){

4527 
jj
=0; jj<
pIndex
->
nCﬁumn
; jj++){

4528 if–
pEx¥
->
iCﬁumn
==
pIndex
->
aiCﬁumn
[
jj
] )  1;

4533 
	}
}

4539 
Bômask
 
	$cﬁumnsInIndex
(
Index
 *
pIdx
){

4540 
Bômask
 
m
 = 0;

4541 if–
pIdx
->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY
 ){

4542 
j
;

4543 
j
=
pIdx
->
nCovî
-1; j>=0; j--){

4544 
x
 = 
pIdx
->
aiCovî
[
j
];

4545 
	`ã°ˇ£
–
x
==
BMS
-1 );

4546 
	`ã°ˇ£
–
x
==
BMS
-2 );

4547 if–
x
<
BMS
-1 ) 
m
 |
	`MASKBIT
(x);

4550  
m
;

4551 
	}
}

4553 
	$whîeLo›AddM©ch
(

4554 
WhîeLo›Buûdî
 *
pBuûdî
,

4555 
SrcLi°Iãm
 *
pSrc
,

4556 
Bômask
 
mExåa
,

4557 *
pbD⁄e


4559 
WhîeCœu£
 *
pWC
 = 
pBuûdî
->pWC;

4560 
iTîm
;

4561 
rc
 = 
SQLITE4_OK
;

4562 if–
	`födM©chEx¥
(
pWC
, 
pSrc
, &
iTîm
) ){

4563 
WhîeLo›
 *
pNew
 = 
pBuûdî
->pNew;

4565 
pNew
->
¥îeq
 = 
pWC
->
a
[
iTîm
].
¥îeqRight
;

4566 
pNew
->
wsFœgs
 = 
WHERE_INDEXED
;

4567 
pNew
->
rSëup
 = 0;

4568 
pNew
->
rRun
 = 1;

4569 
pNew
->
nOut
 = 1;

4570 
pNew
->
u
.
båì
.
nEq
 = 0;

4571 
pNew
->
u
.
båì
.
pIndex
 = 
pWC
->
a
[
iTîm
].
pEx¥
->
pIdx
;

4573 
rc
 = 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

4574 *
pbD⁄e
 = 1;

4576 *
pbD⁄e
 = 0;

4578  
rc
;

4579 
	}
}

4586 
	$whîeLo›AddBåì
(

4587 
WhîeLo›Buûdî
 *
pBuûdî
,

4588 
Bômask
 
mExåa


4590 
WhîeInfo
 *
pWInfo
;

4591 
Index
 *
pProbe
;

4592 
Index
 *
pPk
;

4593 
SrcLi°
 *
pTabLi°
;

4594 
SrcLi°Iãm
 *
pSrc
;

4595 
WhîeLo›
 *
pNew
;

4596 
rc
 = 
SQLITE4_OK
;

4597 
iS‹tIdx
 = 1;

4598 
b
;

4599 
WhîeCo°
 
rSize
;

4600 
WhîeCo°
 
rLogSize
;

4602 
pNew
 = 
pBuûdî
->pNew;

4603 
pWInfo
 = 
pBuûdî
->pWInfo;

4604 
pTabLi°
 = 
pWInfo
->pTabList;

4605 
pSrc
 = 
pTabLi°
->
a
 + 
pNew
->
iTab
;

4606 
	`as£π
–!
	`IsVútuÆ
(
pSrc
->
pTab
) );

4607 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pSrc
->
pTab
, 0);

4609 if–
pSrc
->
pIndex
 ){

4611 
pProbe
 = 
pSrc
->
pIndex
;

4612 }if–
pSrc
->
nŸIndexed
 ){

4614 
pProbe
 = 
pPk
;

4617 
pProbe
 = 
pSrc
->
pTab
->
pIndex
;

4620 
rc
 = 
	`whîeLo›AddM©ch
(
pBuûdî
, 
pSrc
, 
mExåa
, &
b
);

4621 if–
b
 )  
rc
;

4622 
	`as£π
–
rc
==
SQLITE4_OK
 );

4624 
rSize
 = 
	`whîeCo°
(
pSrc
->
pTab
->
nRowE°
);

4625 
rLogSize
 = 
	`e°Log
(
rSize
);

4627 #i‚de‡
SQLITE4_OMIT_AUTOMATIC_INDEX


4629 if–!
pBuûdî
->
pOrSë


4630 && (
pWInfo
->
pP¨£
->
db
->
Êags
 & 
SQLITE4_AutoIndex
)!=0

4631 && 
pSrc
->
pIndex
==0

4633 && !
pSrc
->
vüC‹outöe


4635 && !
pSrc
->
nŸIndexed


4636 && !
pSrc
->
isC‹ªœãd


4639 
WhîeCœu£
 *
pWC
 = 
pBuûdî
->pWC;

4640 
WhîeTîm
 *
pTîm
;

4641 
WhîeTîm
 *
pWCEnd
 = 
pWC
->
a
 +ÖWC->
nTîm
;

4642 
pTîm
=
pWC
->
a
; 
rc
==
SQLITE4_OK
 &&ÖTîm<
pWCEnd
;ÖTerm++){

4643 if–
pTîm
->
¥îeqRight
 & 
pNew
->
maskSñf
 ) ;

4644 if–
	`ãrmC™DriveIndex
(
pTîm
, 
pSrc
, 0) ){

4645 
pNew
->
u
.
båì
.
nEq
 = 1;

4646 
pNew
->
u
.
båì
.
pIndex
 = 0;

4647 
pNew
->
nLTîm
 = 1;

4648 
pNew
->
aLTîm
[0] = 
pTîm
;

4652 
pNew
->
rSëup
 = 
rLogSize
 + 
rSize
 + 28; 
	`as£π
–28==
	`whîeCo°
(7) );

4657 
pNew
->
nOut
 = 43; 
	`as£π
–43==
	`whîeCo°
(20) );

4658 
pNew
->
rRun
 = 
	`whîeCo°Add
(
rLogSize
,pNew->
nOut
);

4659 
pNew
->
wsFœgs
 = 
WHERE_AUTO_INDEX
;

4660 
pNew
->
¥îeq
 = 
mExåa
 | 
pTîm
->
¥îeqRight
;

4661 
rc
 = 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

4670 if–
pPk
==0 ){

4671 
	`as£π
–
pSrc
->
pTab
->
pSñe˘
 || (pSrc->pTab->
èbFœgs
 & 
TF_EphemîÆ
) );

4672 
pNew
->
u
.
båì
.
nEq
 = 0;

4673 
pNew
->
nLTîm
 = 0;

4674 
pNew
->
iS‹tIdx
 = 0;

4675 
pNew
->
rSëup
 = 0;

4676 
pNew
->
¥îeq
 = 
mExåa
;

4677 
pNew
->
nOut
 = 
rSize
;

4678 
pNew
->
u
.
båì
.
pIndex
 = 0;

4679 
pNew
->
wsFœgs
 = 0;

4680 
pNew
->
rRun
 = 
	`whîeCo°Add
(
rSize
,
rLogSize
) + 16;

4681 
rc
 = 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

4685 ; 
rc
==
SQLITE4_OK
 && 
pProbe
;ÖProbeıProbe->
pNext
, 
iS‹tIdx
++){

4686 
bCovî
 = (
pProbe
!=
pPk
 && 0==(
pSrc
->
cﬁU£d
 & ~
	`cﬁumnsInIndex
(pProbe)));

4687 if–
pProbe
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
 ) ;

4688 
	`as£π
–
pProbe
->
äum
>0 );

4690 
pNew
->
u
.
båì
.
nEq
 = 0;

4691 
pNew
->
nLTîm
 = 0;

4692 
pNew
->
rSëup
 = 0;

4693 
pNew
->
¥îeq
 = 
mExåa
;

4694 
pNew
->
nOut
 = 
rSize
;

4695 
pNew
->
u
.
båì
.
pIndex
 = 
pProbe
;

4696 
pNew
->
wsFœgs
 = 
WHERE_INDEXED
;

4697 
pNew
->
wsFœgs
 |(
bCovî
 ? 
WHERE_IDX_ONLY
 : 0);

4698 
pNew
->
wsFœgs
 |(
pProbe
==
pPk
 ? 
WHERE_PRIMARY_KEY
 : 0);

4700 
b
 = 
	`ödexMightHñpWôhOrdîBy
(
pBuûdî
, 
pProbe
, 
pSrc
->
iCurs‹
);

4702 
	`as£π
–(
pWInfo
->
w˘æFœgs
 & 
WHERE_ONEPASS_DESIRED
)==0 || 
b
==0 );

4703 
pNew
->
iS‹tIdx
 = 
b
 ? iSortIdx : 0;

4705 if–
pProbe
==
pPk
 || 
b
 || (
bCovî


4706 && 
pProbe
->
bUn‹dîed
==0

4707 && (
pWInfo
->
w˘æFœgs
 & 
WHERE_ONEPASS_DESIRED
)==0

4709 && 
sqlôe4GlobÆC⁄fig
.
bU£Cis


4710 && 
	`O±imiz©i⁄E«bÀd
(
pWInfo
->
pP¨£
->
db
, 
SQLITE_CovîIdxSˇn
)

4713 if–
pProbe
==
pPk
 ){

4719 
pNew
->
rRun
 = 
	`whîeCo°Add
(
rSize
,
rLogSize
) + 16;

4720 }if–
bCovî
 ){

4729 
pNew
->
rRun
 = 10 + 
	`whîeCo°Add
(
rSize
,
rLogSize
Ë- 
b
;

4731 
	`as£π
–
b
!=0 );

4734 
pNew
->
rRun
 = 
rSize
 + 
rLogSize
;

4736 
rc
 = 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

4737 if–
rc
 ) ;

4740 
rc
 = 
	`whîeLo›AddBåìIndex
(
pBuûdî
, 
pSrc
, 
pProbe
, 0);

4744 if–
pSrc
->
pIndex
 ||ÖSrc->
nŸIndexed
 ) ;

4746  
rc
;

4747 
	}
}

4749 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4754 
	$whîeLo›AddVútuÆ
(

4755 
WhîeLo›Buûdî
 *
pBuûdî


4757 
WhîeInfo
 *
pWInfo
;

4758 
P¨£
 *
pP¨£
;

4759 
WhîeCœu£
 *
pWC
;

4760 
SrcLi°Iãm
 *
pSrc
;

4761 
TabÀ
 *
pTab
;

4762 
sqlôe4
 *
db
;

4763 
sqlôe4_ödex_öfo
 *
pIdxInfo
;

4764 
sqlôe4_ödex_c⁄°øöt
 *
pIdxC⁄s
;

4765 
sqlôe4_ödex_c⁄°øöt_ußge
 *
pUßge
;

4766 
WhîeTîm
 *
pTîm
;

4767 
i
, 
j
;

4768 
iTîm
, 
mxTîm
;

4769 
nC⁄°øöt
;

4770 
£íIn
 = 0;

4771 
£íV¨
 = 0;

4772 
iPha£
;

4773 
WhîeLo›
 *
pNew
;

4774 
rc
 = 
SQLITE4_OK
;

4776 
pWInfo
 = 
pBuûdî
->pWInfo;

4777 
pP¨£
 = 
pWInfo
->pParse;

4778 
db
 = 
pP¨£
->db;

4779 
pWC
 = 
pBuûdî
->pWC;

4780 
pNew
 = 
pBuûdî
->pNew;

4781 
pSrc
 = &
pWInfo
->
pTabLi°
->
a
[
pNew
->
iTab
];

4782 
pTab
 = 
pSrc
->pTab;

4783 
	`as£π
–
	`IsVútuÆ
(
pTab
) );

4784 
pIdxInfo
 = 
	`ÆloˇãIndexInfo
(
pP¨£
, 
pWC
, 
pSrc
, 
pBuûdî
->
pOrdîBy
);

4785 if–
pIdxInfo
==0 )  
SQLITE4_NOMEM
;

4786 
pNew
->
¥îeq
 = 0;

4787 
pNew
->
rSëup
 = 0;

4788 
pNew
->
wsFœgs
 = 
WHERE_VIRTUALTABLE
;

4789 
pNew
->
nLTîm
 = 0;

4790 
pNew
->
u
.
vèb
.
√edFªe
 = 0;

4791 
pUßge
 = 
pIdxInfo
->
aC⁄°øötUßge
;

4792 
nC⁄°øöt
 = 
pIdxInfo
->nConstraint;

4793 if–
	`whîeLo›Resize
(
db
, 
pNew
, 
nC⁄°øöt
) ){

4794 
	`sqlôe4DbFªe
(
db
, 
pIdxInfo
);

4795  
SQLITE4_NOMEM
;

4798 
iPha£
=0; iPhase<=3; iPhase++){

4799 if–!
£íIn
 && (
iPha£
&1)!=0 ){

4800 
iPha£
++;

4801 if–
iPha£
>3 ) ;

4803 if–!
£íV¨
 && 
iPha£
>1 ) ;

4804 
pIdxC⁄s
 = *(
sqlôe4_ödex_c⁄°øöt
**)&
pIdxInfo
->
aC⁄°øöt
;

4805 
i
=0; i<
pIdxInfo
->
nC⁄°øöt
; i++, 
pIdxC⁄s
++){

4806 
j
 = 
pIdxC⁄s
->
iTîmOff£t
;

4807 
pTîm
 = &
pWC
->
a
[
j
];

4808  
iPha£
 ){

4810 
pIdxC⁄s
->
ußbÀ
 = 0;

4811 if–(
pTîm
->
eO≥øt‹
 & 
WO_IN
)!=0 ){

4812 
£íIn
 = 1;

4814 if–
pTîm
->
¥îeqRight
!=0 ){

4815 
£íV¨
 = 1;

4816 }if–(
pTîm
->
eO≥øt‹
 & 
WO_IN
)==0 ){

4817 
pIdxC⁄s
->
ußbÀ
 = 1;

4821 
	`as£π
–
£íIn
 );

4822 
pIdxC⁄s
->
ußbÀ
 = (
pTîm
->
¥îeqRight
==0);

4825 
	`as£π
–
£íV¨
 );

4826 
pIdxC⁄s
->
ußbÀ
 = (
pTîm
->
eO≥øt‹
 & 
WO_IN
)==0;

4829 
	`as£π
–
£íV¨
 && 
£íIn
 );

4830 
pIdxC⁄s
->
ußbÀ
 = 1;

4834 
	`mem£t
(
pUßge
, 0, ’Ußge[0])*
pIdxInfo
->
nC⁄°øöt
);

4835 if–
pIdxInfo
->
√edToFªeIdxSå
 ) 
	`sqlôe4_‰ì
’IdxInfo->
idxSå
);

4836 
pIdxInfo
->
idxSå
 = 0;

4837 
pIdxInfo
->
idxNum
 = 0;

4838 
pIdxInfo
->
√edToFªeIdxSå
 = 0;

4839 
pIdxInfo
->
‹dîByC⁄sumed
 = 0;

4840 
pIdxInfo
->
e°im©edCo°
 = 
SQLITE4_BIG_DBL
 / ()2;

4841 
rc
 = 
	`vèbBe°Index
(
pP¨£
, 
pTab
, 
pIdxInfo
);

4842 if–
rc
 ) 
whîeLo›AddVèb_exô
;

4843 
pIdxC⁄s
 = *(
sqlôe4_ödex_c⁄°øöt
**)&
pIdxInfo
->
aC⁄°øöt
;

4844 
pNew
->
¥îeq
 = 0;

4845 
mxTîm
 = -1;

4846 
	`as£π
–
pNew
->
nLSlŸ
>=
nC⁄°øöt
 );

4847 
i
=0; i<
nC⁄°øöt
; i++Ë
pNew
->
aLTîm
[i] = 0;

4848 
pNew
->
u
.
vèb
.
omôMask
 = 0;

4849 
i
=0; i<
nC⁄°øöt
; i++, 
pIdxC⁄s
++){

4850 if–(
iTîm
 = 
pUßge
[
i
].
¨gvIndex
 - 1)>=0 ){

4851 
j
 = 
pIdxC⁄s
->
iTîmOff£t
;

4852 if–
iTîm
>=
nC⁄°øöt


4853 || 
j
<0

4854 || 
j
>=
pWC
->
nTîm


4855 || 
pNew
->
aLTîm
[
iTîm
]!=0

4857 
rc
 = 
SQLITE4_ERROR
;

4858 
	`sqlôe4Eº‹Msg
(
pP¨£
, "%s.xBe°Index(ËmÆfun˘i⁄", 
pTab
->
zName
);

4859 
whîeLo›AddVèb_exô
;

4861 
	`ã°ˇ£
–
iTîm
==
nC⁄°øöt
-1 );

4862 
	`ã°ˇ£
–
j
==0 );

4863 
	`ã°ˇ£
–
j
==
pWC
->
nTîm
-1 );

4864 
pTîm
 = &
pWC
->
a
[
j
];

4865 
pNew
->
¥îeq
 |
pTîm
->
¥îeqRight
;

4866 
	`as£π
–
iTîm
<
pNew
->
nLSlŸ
 );

4867 
pNew
->
aLTîm
[
iTîm
] = 
pTîm
;

4868 if–
iTîm
>
mxTîm
 ) mxTerm = iTerm;

4869 
	`ã°ˇ£
–
iTîm
==15 );

4870 
	`ã°ˇ£
–
iTîm
==16 );

4871 if–
iTîm
<16 && 
pUßge
[
i
].
omô
 ) 
pNew
->
u
.
vèb
.
omôMask
 |= 1<<iTerm;

4872 if–(
pTîm
->
eO≥øt‹
 & 
WO_IN
)!=0 ){

4873 if–
pUßge
[
i
].
omô
==0 ){

4885 
pIdxInfo
->
‹dîByC⁄sumed
 = 0;

4889 if–
i
>=
nC⁄°øöt
 ){

4890 
pNew
->
nLTîm
 = 
mxTîm
+1;

4891 
	`as£π
–
pNew
->
nLTîm
<ıNew->
nLSlŸ
 );

4892 
pNew
->
u
.
vèb
.
idxNum
 = 
pIdxInfo
->idxNum;

4893 
pNew
->
u
.
vèb
.
√edFªe
 = 
pIdxInfo
->
√edToFªeIdxSå
;

4894 
pIdxInfo
->
√edToFªeIdxSå
 = 0;

4895 
pNew
->
u
.
vèb
.
idxSå
 = 
pIdxInfo
->idxStr;

4896 
pNew
->
u
.
vèb
.
isOrdîed
 = (
u8
)((
pIdxInfo
->
nOrdîBy
!=0)

4897 && 
pIdxInfo
->
‹dîByC⁄sumed
);

4898 
pNew
->
rSëup
 = 0;

4899 
pNew
->
rRun
 = 
	`whîeCo°FromDoubÀ
(
pIdxInfo
->
e°im©edCo°
);

4901 
pNew
->
nOut
 = 46; 
	`as£π
–46==
	`whîeCo°
(25) );

4902 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

4903 if–
pNew
->
u
.
vèb
.
√edFªe
 ){

4904 
	`sqlôe4_‰ì
(
pNew
->
u
.
vèb
.
idxSå
);

4905 
pNew
->
u
.
vèb
.
√edFªe
 = 0;

4910 
whîeLo›AddVèb_exô
:

4911 if–
pIdxInfo
->
√edToFªeIdxSå
 ) 
	`sqlôe4_‰ì
’IdxInfo->
idxSå
);

4912 
	`sqlôe4DbFªe
(
db
, 
pIdxInfo
);

4913  
rc
;

4914 
	}
}

4921 
	$whîeLo›AddOr
(
WhîeLo›Buûdî
 *
pBuûdî
, 
Bômask
 
mExåa
){

4922 
WhîeInfo
 *
pWInfo
 = 
pBuûdî
->pWInfo;

4923 
WhîeCœu£
 *
pWC
;

4924 
WhîeLo›
 *
pNew
;

4925 
WhîeTîm
 *
pTîm
, *
pWCEnd
;

4926 
rc
 = 
SQLITE4_OK
;

4927 
iCur
;

4928 
WhîeCœu£
 
ãmpWC
;

4929 
WhîeLo›Buûdî
 
sSubBuûd
;

4930 
WhîeOrSë
 
sSum
, 
sCur
, 
sPªv
;

4931 
SrcLi°Iãm
 *
pIãm
;

4933 
pWC
 = 
pBuûdî
->pWC;

4934 if–
pWInfo
->
w˘æFœgs
 & 
WHERE_AND_ONLY
 )  
SQLITE4_OK
;

4935 
pWCEnd
 = 
pWC
->
a
 +ÖWC->
nTîm
;

4936 
pNew
 = 
pBuûdî
->pNew;

4938 
pTîm
=
pWC
->
a
;ÖTîm<
pWCEnd
 && 
rc
==
SQLITE4_OK
;ÖTerm++){

4939 if–(
pTîm
->
eO≥øt‹
 & 
WO_OR
)!=0

4940 && (
pTîm
->
u
.
pOrInfo
->
ödexabÀ
 & 
pNew
->
maskSñf
)!=0

4942 
WhîeCœu£
 * c⁄° 
pOrWC
 = &
pTîm
->
u
.
pOrInfo
->
wc
;

4943 
WhîeTîm
 * c⁄° 
pOrWCEnd
 = &
pOrWC
->
a
[pOrWC->
nTîm
];

4944 
WhîeTîm
 *
pOrTîm
;

4945 
⁄˚
 = 1;

4946 
i
, 
j
;

4948 
pIãm
 = 
pWInfo
->
pTabLi°
->
a
 + 
pNew
->
iTab
;

4949 
iCur
 = 
pIãm
->
iCurs‹
;

4950 
sSubBuûd
 = *
pBuûdî
;

4951 
sSubBuûd
.
pOrdîBy
 = 0;

4952 
sSubBuûd
.
pOrSë
 = &
sCur
;

4954 
pOrTîm
=
pOrWC
->
a
;ÖOrTîm<
pOrWCEnd
;ÖOrTerm++){

4955 if–(
pOrTîm
->
eO≥øt‹
 & 
WO_AND
)!=0 ){

4956 
sSubBuûd
.
pWC
 = &
pOrTîm
->
u
.
pAndInfo
->
wc
;

4957 }if–
pOrTîm
->
À·Curs‹
==
iCur
 ){

4958 
ãmpWC
.
pWInfo
 = 
pWC
->pWInfo;

4959 
ãmpWC
.
pOuãr
 = 
pWC
;

4960 
ãmpWC
.
›
 = 
TK_AND
;

4961 
ãmpWC
.
nTîm
 = 1;

4962 
ãmpWC
.
a
 = 
pOrTîm
;

4963 
sSubBuûd
.
pWC
 = &
ãmpWC
;

4967 
sCur
.
n
 = 0;

4968 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


4969 if–
	`IsVútuÆ
(
pIãm
->
pTab
) ){

4970 
rc
 = 
	`whîeLo›AddVútuÆ
(&
sSubBuûd
);

4971 
i
=0; i<
sCur
.
n
; i++ËsCur.
a
[i].
¥îeq
 |
mExåa
;

4975 
rc
 = 
	`whîeLo›AddBåì
(&
sSubBuûd
, 
mExåa
);

4977 
	`as£π
–
rc
==
SQLITE4_OK
 || 
sCur
.
n
==0 );

4978 if–
sCur
.
n
==0 ){

4979 
sSum
.
n
 = 0;

4981 }if–
⁄˚
 ){

4982 
	`whîeOrMove
(&
sSum
, &
sCur
);

4983 
⁄˚
 = 0;

4985 
	`whîeOrMove
(&
sPªv
, &
sSum
);

4986 
sSum
.
n
 = 0;

4987 
i
=0; i<
sPªv
.
n
; i++){

4988 
j
=0; j<
sCur
.
n
; j++){

4989 
	`whîeOrIn£π
(&
sSum
, 
sPªv
.
a
[
i
].
¥îeq
 | 
sCur
.a[
j
].prereq,

4990 
	`whîeCo°Add
(
sPªv
.
a
[
i
].
rRun
, 
sCur
.a[
j
].rRun),

4991 
	`whîeCo°Add
(
sPªv
.
a
[
i
].
nOut
, 
sCur
.a[
j
].nOut));

4996 
pNew
->
nLTîm
 = 1;

4997 
pNew
->
aLTîm
[0] = 
pTîm
;

4998 
pNew
->
wsFœgs
 = 
WHERE_MULTI_OR
;

4999 
pNew
->
rSëup
 = 0;

5000 
pNew
->
iS‹tIdx
 = 0;

5001 
	`mem£t
(&
pNew
->
u
, 0, (pNew->u));

5002 
i
=0; 
rc
==
SQLITE4_OK
 && i<
sSum
.
n
; i++){

5004 
pNew
->
rRun
 = 
sSum
.
a
[
i
].rRun + 18;

5005 
pNew
->
nOut
 = 
sSum
.
a
[
i
].nOut;

5006 
pNew
->
¥îeq
 = 
sSum
.
a
[
i
].prereq;

5007 
rc
 = 
	`whîeLo›In£π
(
pBuûdî
, 
pNew
);

5011  
rc
;

5012 
	}
}

5017 
	$whîeLo›AddAŒ
(
WhîeLo›Buûdî
 *
pBuûdî
){

5018 
WhîeInfo
 *
pWInfo
 = 
pBuûdî
->pWInfo;

5019 
Bômask
 
mExåa
 = 0;

5020 
Bômask
 
mPri‹
 = 0;

5021 
iTab
;

5022 
SrcLi°
 *
pTabLi°
 = 
pWInfo
->pTabList;

5023 
SrcLi°Iãm
 *
pIãm
;

5024 
sqlôe4
 *
db
 = 
pWInfo
->
pP¨£
->db;

5025 
nTabLi°
 = 
pWInfo
->
nLevñ
;

5026 
rc
 = 
SQLITE4_OK
;

5027 
u8
 
¥i‹JoöTy≥
 = 0;

5028 
WhîeLo›
 *
pNew
;

5031 
pNew
 = 
pBuûdî
->pNew;

5032 
	`whîeLo›Inô
(
pNew
);

5033 
iTab
=0, 
pIãm
=
pTabLi°
->
a
; iTab<
nTabLi°
; iTab++,ÖItem++){

5034 
pNew
->
iTab
 = iTab;

5035 
pNew
->
maskSñf
 = 
	`gëMask
(&
pWInfo
->
sMaskSë
, 
pIãm
->
iCurs‹
);

5036 if–((
pIãm
->
joöty≥
|
¥i‹JoöTy≥
Ë& (
JT_LEFT
|
JT_CROSS
))!=0 ){

5037 
mExåa
 = 
mPri‹
;

5039 
¥i‹JoöTy≥
 = 
pIãm
->
joöty≥
;

5040 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


5041 if–
	`IsVútuÆ
(
pIãm
->
pTab
) ){

5042 
rc
 = 
	`whîeLo›AddVútuÆ
(
pBuûdî
);

5046 
rc
 = 
	`whîeLo›AddBåì
(
pBuûdî
, 
mExåa
);

5048 if–
rc
==
SQLITE4_OK
 ){

5049 
rc
 = 
	`whîeLo›AddOr
(
pBuûdî
, 
mExåa
);

5051 
mPri‹
 |
pNew
->
maskSñf
;

5052 if–
rc
 || 
db
->
mÆlocFaûed
 ) ;

5054 
	`whîeLo›CÀ¨
(
db
, 
pNew
);

5055  
rc
;

5056 
	}
}

5075 
	$whîeP©hS©isfõsOrdîBy
(

5076 
WhîeInfo
 *
pWInfo
,

5077 
Ex¥Li°
 *
pOrdîBy
,

5078 
WhîeP©h
 *
pP©h
,

5079 
u16
 
w˘æFœgs
,

5080 
u16
 
nLo›
,

5081 
WhîeLo›
 *
pLa°
,

5082 
Bômask
 *
pRevMask


5084 
u8
 
ªvSë
;

5085 
u8
 
ªv
;

5086 
u8
 
ªvIdx
;

5087 
u8
 
isOrdîDi°ö˘
;

5088 
u8
 
isM©ch
;

5089 
u16
 
nCﬁumn
;

5090 
u16
 
nOrdîBy
;

5091 
iLo›
;

5092 
i
, 
j
;

5093 
iCur
;

5094 
iCﬁumn
;

5095 
WhîeLo›
 *
pLo›
 = 0;

5096 
WhîeTîm
 *
pTîm
;

5097 
Ex¥
 *
pOBEx¥
;

5098 
CﬁlSeq
 *
pCﬁl
;

5099 
Index
 *
pIndex
;

5100 
sqlôe4
 *
db
 = 
pWInfo
->
pP¨£
->db;

5101 
Bômask
 
obS©
 = 0;

5102 
Bômask
 
obD⁄e
;

5103 
Bômask
 
‹dîDi°ö˘Mask
;

5104 
Bômask
 
ªady
;

5128 
	`as£π
–
pOrdîBy
!=0 );

5132 if–
pLa°
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
 ){

5133 
	`ã°ˇ£
–
nLo›
>0 );

5135  
pLa°
->
u
.
vèb
.
isOrdîed
;

5137 if–
nLo›
 && 
	`O±imiz©i⁄DißbÀd
(
db
, 
SQLITE4_OrdîByIdxJoö
) )  0;

5139 
nOrdîBy
 = 
pOrdîBy
->
nEx¥
;

5140 
	`ã°ˇ£
–
nOrdîBy
==
BMS
-1 );

5141 if–
nOrdîBy
>
BMS
-1 )  0;

5142 
isOrdîDi°ö˘
 = 1;

5143 
obD⁄e
 = 
	`MASKBIT
(
nOrdîBy
)-1;

5144 
‹dîDi°ö˘Mask
 = 0;

5145 
ªady
 = 0;

5146 
iLo›
=0; 
isOrdîDi°ö˘
 && 
obS©
<
obD⁄e
 && iLo›<=
nLo›
; iLoop++){

5147 if–
iLo›
>0 ) 
ªady
 |
pLo›
->
maskSñf
;

5148 
pLo›
 = 
iLo›
<
nLo›
 ? 
pP©h
->
aLo›
[iLo›] : 
pLa°
;

5149 
	`as£π
–(
pLo›
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)==0 );

5150 
iCur
 = 
pWInfo
->
pTabLi°
->
a
[
pLo›
->
iTab
].
iCurs‹
;

5157 
i
=0; i<
nOrdîBy
; i++){

5158 if–
	`MASKBIT
(
i
Ë& 
obS©
 ) ;

5159 
pOBEx¥
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pOrdîBy
->
a
[
i
].
pEx¥
);

5160 if–
pOBEx¥
->
›
!=
TK_COLUMN
 ) ;

5161 if–
pOBEx¥
->
iTabÀ
!=
iCur
 ) ;

5162 
pTîm
 = 
	`födTîm
(&
pWInfo
->
sWC
, 
iCur
, 
pOBEx¥
->
iCﬁumn
,

5163 ~
ªady
, 
WO_EQ
|
WO_ISNULL
, 0);

5164 if–
pTîm
==0 ) ;

5165 if–(
pTîm
->
eO≥øt‹
&
WO_EQ
)!=0 && 
pOBEx¥
->
iCﬁumn
>=0 ){

5166 c⁄° *
z1
, *
z2
;

5167 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pWInfo
->
pP¨£
, 
pOrdîBy
->
a
[
i
].
pEx¥
);

5168 if–!
pCﬁl
 )ÖCﬁ»
db
->
pDÊtCﬁl
;

5169 
z1
 = 
pCﬁl
->
zName
;

5170 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pWInfo
->
pP¨£
, 
pTîm
->
pEx¥
);

5171 if–!
pCﬁl
 )ÖCﬁ»
db
->
pDÊtCﬁl
;

5172 
z2
 = 
pCﬁl
->
zName
;

5173 if–
	`sqlôe4_°ricmp
(
z1
, 
z2
)!=0 ) ;

5175 
obS©
 |
	`MASKBIT
(
i
);

5178 if–(
pLo›
->
wsFœgs
 & 
WHERE_ONEROW
)==0 ){

5179 
Index
 *
pPk
 = 0;

5180 if–(
pIndex
 = 
pLo›
->
u
.
båì
.pIndex)==0

5181 || 
pIndex
->
bUn‹dîed


5182 || 
pIndex
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5


5186 
isOrdîDi°ö˘
 = 
pIndex
->
⁄Eº‹
!=
OE_N⁄e
;

5187 
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pIndex
->
pTabÀ
, 0);

5188 
nCﬁumn
 = 
	`idxCﬁumnCou¡
(
pIndex
, 
pPk
);

5194 
ªv
 = 
ªvSë
 = 0;

5195 
j
=0; j<
nCﬁumn
; j++){

5196 
u8
 
bOn˚
;

5199 if–
j
<
pLo›
->
u
.
båì
.
nEq


5200 && ((
i
 = 
pLo›
->
aLTîm
[
j
]->
eO≥øt‹
Ë& (
WO_EQ
|
WO_ISNULL
))!=0

5202 if–
i
 & 
WO_ISNULL
 ){

5203 
	`ã°ˇ£
–
isOrdîDi°ö˘
 );

5204 
isOrdîDi°ö˘
 = 0;

5212 if–
j
<
nCﬁumn
 ){

5214 
iCﬁumn
 = 
	`idxCﬁumnNumbî
(
pIndex
, 
pPk
, 
j
);

5215 
ªvIdx
 = 
	`idxCﬁumnS‹tOrdî
(
pIndex
, 
pPk
, 
j
);

5218 
	`as£π
–
j
==
nCﬁumn
 );

5219 
iCﬁumn
 = -1;

5220 
ªvIdx
 = 0;

5226 if–
isOrdîDi°ö˘


5227 && 
iCﬁumn
>=0

5228 && 
j
>=
pLo›
->
u
.
båì
.
nEq


5229 && 
pIndex
->
pTabÀ
->
aCﬁ
[
iCﬁumn
].
nŸNuŒ
==0

5231 
isOrdîDi°ö˘
 = 0;

5237 
bOn˚
 = 1;

5238 
isM©ch
 = 0;

5239 
i
=0; 
bOn˚
 && i<
nOrdîBy
; i++){

5240 if–
	`MASKBIT
(
i
Ë& 
obS©
 ) ;

5241 
pOBEx¥
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pOrdîBy
->
a
[
i
].
pEx¥
);

5242 
	`ã°ˇ£
–
w˘æFœgs
 & 
WHERE_GROUPBY
 );

5243 
	`ã°ˇ£
–
w˘æFœgs
 & 
WHERE_DISTINCTBY
 );

5244 if–(
w˘æFœgs
 & (
WHERE_GROUPBY
|
WHERE_DISTINCTBY
))==0 ) 
bOn˚
 = 0;

5245 if–
pOBEx¥
->
›
!=
TK_COLUMN
 ) ;

5246 if–
pOBEx¥
->
iTabÀ
!=
iCur
 ) ;

5247 if–
pOBEx¥
->
iCﬁumn
!=iColumn ) ;

5248 if–
iCﬁumn
>=0 ){

5249 c⁄° *
zIdxCﬁl
;

5250 
pCﬁl
 = 
	`sqlôe4Ex¥CﬁlSeq
(
pWInfo
->
pP¨£
, 
pOrdîBy
->
a
[
i
].
pEx¥
);

5251 if–!
pCﬁl
 )ÖCﬁ»
db
->
pDÊtCﬁl
;

5252 
zIdxCﬁl
 = 
	`idxCﬁumnCﬁœti⁄
(
pIndex
, 
pPk
, 
j
);

5253 if–
	`sqlôe4_°ricmp
(
pCﬁl
->
zName
, 
zIdxCﬁl
)!=0 ) ;

5255 
isM©ch
 = 1;

5258 if–
isM©ch
 ){

5259 
obS©
 |
	`MASKBIT
(
i
);

5260 if–(
pWInfo
->
w˘æFœgs
 & 
WHERE_GROUPBY
)==0 ){

5263 if–
ªvSë
 ){

5264 if–(
ªv
 ^ 
ªvIdx
)!=
pOrdîBy
->
a
[
i
].
s‹tOrdî
 )  0;

5266 
ªv
 = 
ªvIdx
 ^ 
pOrdîBy
->
a
[
i
].
s‹tOrdî
;

5267 if–
ªv
 ) *
pRevMask
 |
	`MASKBIT
(
iLo›
);

5268 
ªvSë
 = 1;

5273 if–
j
==0 || j<
nCﬁumn
 ){

5274 
	`ã°ˇ£
–
isOrdîDi°ö˘
!=0 );

5275 
isOrdîDi°ö˘
 = 0;

5285 if–
j
==
nCﬁumn
 ){

5286 
	`ã°ˇ£
–
isOrdîDi°ö˘
==0 );

5287 
isOrdîDi°ö˘
 = 1;

5292 if–
isOrdîDi°ö˘
 ){

5293 
‹dîDi°ö˘Mask
 |
pLo›
->
maskSñf
;

5294 
i
=0; i<
nOrdîBy
; i++){

5295 
Ex¥
 *
p
;

5296 if–
	`MASKBIT
(
i
Ë& 
obS©
 ) ;

5297 
p
 = 
pOrdîBy
->
a
[
i
].
pEx¥
;

5298 if–(
	`ex¥TabÀUßge
(&
pWInfo
->
sMaskSë
, 
p
)&~
‹dîDi°ö˘Mask
)==0 ){

5299 
obS©
 |
	`MASKBIT
(
i
);

5304 if–
obS©
==
obD⁄e
 )  1;

5305 if–!
isOrdîDi°ö˘
 )  0;

5307 
	}
}

5309 #ifde‡
WHERETRACE_ENABLED


5311 c⁄° *
	$whîeP©hName
(
WhîeP©h
 *
pP©h
, 
nLo›
, 
WhîeLo›
 *
pLa°
){

5312 
zName
[65];

5313 
i
;

5314 
i
=0; i<
nLo›
; i++){ 
zName
[i] = 
pP©h
->
aLo›
[i]->
cId
; }

5315 if–
pLa°
 ) 
zName
[
i
++] =ÖLa°->
cId
;

5316 
zName
[
i
] = 0;

5317  
zName
;

5318 
	}
}

5334 
	$whîeP©hSﬁvî
(
WhîeInfo
 *
pWInfo
, 
WhîeCo°
 
nRowE°
){

5335 
mxChoi˚
;

5336 
nLo›
;

5337 
P¨£
 *
pP¨£
;

5338 
sqlôe4
 *
db
;

5339 
iLo›
;

5340 
ii
, 
jj
;

5341 
WhîeCo°
 
rCo°
;

5342 
WhîeCo°
 
mxCo°
 = 0;

5343 
WhîeCo°
 
rS‹tCo°
;

5344 
nTo
, 
nFrom
;

5345 
WhîeP©h
 *
aFrom
;

5346 
WhîeP©h
 *
aTo
;

5347 
WhîeP©h
 *
pFrom
;

5348 
WhîeP©h
 *
pTo
;

5349 
WhîeLo›
 *
pWLo›
;

5350 
WhîeLo›
 **
pX
;

5351 *
pS∑˚
;

5353 
pP¨£
 = 
pWInfo
->pParse;

5354 
db
 = 
pP¨£
->db;

5355 
nLo›
 = 
pWInfo
->
nLevñ
;

5359 
mxChoi˚
 = (
nLo›
==1) ? 1 : (nLoop==2 ? 5 : 10);

5360 
	`as£π
–
nLo›
<=
pWInfo
->
pTabLi°
->
nSrc
 );

5361 
	`WHERETRACE
(0x002, ("---- begin solver\n"));

5364 
ii
 = ((
WhîeP©h
)+(
WhîeLo›
*)*
nLo›
)*
mxChoi˚
*2;

5365 
pS∑˚
 = 
	`sqlôe4DbMÆlocRaw
(
db
, 
ii
);

5366 if–
pS∑˚
==0 )  
SQLITE4_NOMEM
;

5367 
aTo
 = (
WhîeP©h
*)
pS∑˚
;

5368 
aFrom
 = 
aTo
+
mxChoi˚
;

5369 
	`mem£t
(
aFrom
, 0, (aFrom[0]));

5370 
pX
 = (
WhîeLo›
**)(
aFrom
+
mxChoi˚
);

5371 
ii
=
mxChoi˚
*2, 
pFrom
=
aTo
; ii>0; ii--,ÖFrom++, 
pX
 +
nLo›
){

5372 
pFrom
->
aLo›
 = 
pX
;

5380 
aFrom
[0].
nRow
 = 
	`MIN
(
pP¨£
->
nQuîyLo›
, 46); 
	`as£π
–46==
	`whîeCo°
(25) );

5381 
nFrom
 = 1;

5385 
rS‹tCo°
 = 0;

5386 if–
pWInfo
->
pOrdîBy
==0 || 
nRowE°
==0 ){

5387 
aFrom
[0].
isOrdîedVÆid
 = 1;

5391 
rS‹tCo°
 = 
nRowE°
 + 
	`e°Log
(nRowEst);

5392 
	`WHERETRACE
(0x002,("---- s‹àco°=%-3d\n", 
rS‹tCo°
));

5398 
iLo›
=0; iLo›<
nLo›
; iLoop++){

5399 
nTo
 = 0;

5400 
ii
=0, 
pFrom
=
aFrom
; ii<
nFrom
; ii++,ÖFrom++){

5401 
pWLo›
=
pWInfo
->
pLo›s
;ÖWLo›;ÖWLo›ıWLo›->
pNextLo›
){

5402 
Bômask
 
maskNew
;

5403 
Bômask
 
ªvMask
 = 0;

5404 
u8
 
isOrdîedVÆid
 = 
pFrom
->isOrderedValid;

5405 
u8
 
isOrdîed
 = 
pFrom
->isOrdered;

5406 if–(
pWLo›
->
¥îeq
 & ~
pFrom
->
maskLo›
)!=0 ) ;

5407 if–(
pWLo›
->
maskSñf
 & 
pFrom
->
maskLo›
)!=0 ) ;

5410 
rCo°
 = 
	`whîeCo°Add
(
pWLo›
->
rSëup
,pWLo›->
rRun
 + 
pFrom
->
nRow
);

5411 
rCo°
 = 
	`whîeCo°Add
‘Co°, 
pFrom
->rCost);

5412 
maskNew
 = 
pFrom
->
maskLo›
 | 
pWLo›
->
maskSñf
;

5413 if–!
isOrdîedVÆid
 ){

5414  
	`whîeP©hS©isfõsOrdîBy
(
pWInfo
,

5415 
pWInfo
->
pOrdîBy
, 
pFrom
,ÖWInfo->
w˘æFœgs
,

5416 
iLo›
, 
pWLo›
, &
ªvMask
) ){

5418 
isOrdîed
 = 1;

5419 
isOrdîedVÆid
 = 1;

5422 
isOrdîed
 = 0;

5423 
isOrdîedVÆid
 = 1;

5424 
rCo°
 = 
	`whîeCo°Add
‘Co°, 
rS‹tCo°
);

5430 
ªvMask
 = 
pFrom
->
ªvLo›
;

5433 
jj
=0, 
pTo
=
aTo
; jj<
nTo
; jj++,ÖTo++){

5434 if–
pTo
->
maskLo›
==
maskNew
 &&ÖTo->
isOrdîedVÆid
==isOrderedValid ){

5435 
	`ã°ˇ£
–
jj
==
nTo
-1 );

5439 if–
jj
>=
nTo
 ){

5440 if–
nTo
>=
mxChoi˚
 && 
rCo°
>=
mxCo°
 ){

5441 #ifde‡
WHERETRACE_ENABLED


5442 if–
sqlôe4WhîeTø˚
&0x4 ){

5443 
	`sqlôe4DebugPrötf
("Skip %s cost=%3d order=%c\n",

5444 
	`whîeP©hName
(
pFrom
, 
iLo›
, 
pWLo›
), 
rCo°
,

5445 
isOrdîedVÆid
 ? (
isOrdîed
 ? 'Y' : 'N') : '?');

5451 if–
nTo
<
mxChoi˚
 ){

5453 
jj
 = 
nTo
++;

5456 
jj
=
nTo
-1; 
aTo
[jj].
rCo°
<
mxCo°
; jj--){ 
	`as£π
(jj>0); }

5458 
pTo
 = &
aTo
[
jj
];

5459 #ifde‡
WHERETRACE_ENABLED


5460 if–
sqlôe4WhîeTø˚
&0x4 ){

5461 
	`sqlôe4DebugPrötf
("New %s cost=%-3d order=%c\n",

5462 
	`whîeP©hName
(
pFrom
, 
iLo›
, 
pWLo›
), 
rCo°
,

5463 
isOrdîedVÆid
 ? (
isOrdîed
 ? 'Y' : 'N') : '?');

5467 if–
pTo
->
rCo°
<=rCost ){

5468 #ifde‡
WHERETRACE_ENABLED


5469 if–
sqlôe4WhîeTø˚
&0x4 ){

5470 
	`sqlôe4DebugPrötf
(

5472 
	`whîeP©hName
(
pFrom
, 
iLo›
, 
pWLo›
), 
rCo°
,

5473 
isOrdîedVÆid
 ? (
isOrdîed
 ? 'Y' : 'N') : '?');

5474 
	`sqlôe4DebugPrötf
(" vs %s cost=%-3d order=%c\n",

5475 
	`whîeP©hName
(
pTo
, 
iLo›
+1, 0),ÖTo->
rCo°
,

5476 
pTo
->
isOrdîedVÆid
 ? (pTo->
isOrdîed
 ? 'Y' : 'N') : '?');

5479 
	`ã°ˇ£
–
pTo
->
rCo°
==rCost );

5482 
	`ã°ˇ£
–
pTo
->
rCo°
==rCost+1 );

5484 #ifde‡
WHERETRACE_ENABLED


5485 if–
sqlôe4WhîeTø˚
&0x4 ){

5486 
	`sqlôe4DebugPrötf
(

5488 
	`whîeP©hName
(
pFrom
, 
iLo›
, 
pWLo›
), 
rCo°
,

5489 
isOrdîedVÆid
 ? (
isOrdîed
 ? 'Y' : 'N') : '?');

5490 
	`sqlôe4DebugPrötf
(" was %s cost=%-3d order=%c\n",

5491 
	`whîeP©hName
(
pTo
, 
iLo›
+1, 0),ÖTo->
rCo°
,

5492 
pTo
->
isOrdîedVÆid
 ? (pTo->
isOrdîed
 ? 'Y' : 'N') : '?');

5497 
pTo
->
maskLo›
 = 
pFrom
->maskLo› | 
pWLo›
->
maskSñf
;

5498 
pTo
->
ªvLo›
 = 
ªvMask
;

5499 
pTo
->
nRow
 = 
pFrom
->nRow + 
pWLo›
->
nOut
;

5500 
pTo
->
rCo°
 =ÑCost;

5501 
pTo
->
isOrdîedVÆid
 = isOrderedValid;

5502 
pTo
->
isOrdîed
 = isOrdered;

5503 
	`mem˝y
(
pTo
->
aLo›
, 
pFrom
->aLo›, (
WhîeLo›
*)*
iLo›
);

5504 
pTo
->
aLo›
[
iLo›
] = 
pWLo›
;

5505 if–
nTo
>=
mxChoi˚
 ){

5506 
mxCo°
 = 
aTo
[0].
rCo°
;

5507 
jj
=1, 
pTo
=&
aTo
[1]; jj<
mxChoi˚
; jj++,ÖTo++){

5508 if–
pTo
->
rCo°
>
mxCo°
 ) mxCost =ÖTo->rCost;

5514 #ifde‡
WHERETRACE_ENABLED


5515 if–
sqlôe4WhîeTø˚
>=2 ){

5516 
	`sqlôe4DebugPrötf
("----á·îÑound %d ----\n", 
iLo›
);

5517 
ii
=0, 
pTo
=
aTo
; ii<
nTo
; ii++,ÖTo++){

5518 
	`sqlôe4DebugPrötf
(" %s cost=%-3dÇrow=%-3d order=%c",

5519 
	`whîeP©hName
(
pTo
, 
iLo›
+1, 0),ÖTo->
rCo°
,ÖTo->
nRow
,

5520 
pTo
->
isOrdîedVÆid
 ? (pTo->
isOrdîed
 ? 'Y' : 'N') : '?');

5521 if–
pTo
->
isOrdîedVÆid
 &&ÖTo->
isOrdîed
 ){

5522 
	`sqlôe4DebugPrötf
("Ñev=0x%Œx\n", 
pTo
->
ªvLo›
);

5524 
	`sqlôe4DebugPrötf
("\n");

5531 
pFrom
 = 
aTo
;

5532 
aTo
 = 
aFrom
;

5533 
aFrom
 = 
pFrom
;

5534 
nFrom
 = 
nTo
;

5537 if–
nFrom
==0 ){

5538 
	`sqlôe4Eº‹Msg
(
pP¨£
, "no query solution");

5539 
	`sqlôe4DbFªe
(
db
, 
pS∑˚
);

5540  
SQLITE4_ERROR
;

5544 
pFrom
 = 
aFrom
;

5545 
	`as£π
–
nFrom
==1 );

5547 
ii
=1; ii<
nFrom
; ii++){

5548 if–
pFrom
->
rCo°
>
aFrom
[
ii
].rCost )ÖFrom = &aFrom[ii];

5551 
	`as£π
–
pWInfo
->
nLevñ
==
nLo›
 );

5553 
iLo›
=0; iLo›<
nLo›
; iLoop++){

5554 
WhîeLevñ
 *
pLevñ
 = 
pWInfo
->
a
 + 
iLo›
;

5555 
pLevñ
->
pWLo›
 =ÖWLo› = 
pFrom
->
aLo›
[
iLo›
];

5556 
pLevñ
->
iFrom
 = 
pWLo›
->
iTab
;

5557 
pLevñ
->
iTabCur
 = 
pWInfo
->
pTabLi°
->
a
[pLevñ->
iFrom
].
iCurs‹
;

5559 if–(
pWInfo
->
w˘æFœgs
 & 
WHERE_WANT_DISTINCT
)!=0

5560 && (
pWInfo
->
w˘æFœgs
 & 
WHERE_DISTINCTBY
)==0

5561 && 
pWInfo
->
eDi°ö˘
==
WHERE_DISTINCT_NOOP


5562 && 
nRowE°


5564 
Bômask
 
nŸU£d
;

5565 
rc
 = 
	`whîeP©hS©isfõsOrdîBy
(
pWInfo
,ÖWInfo->
pResu…Së
, 
pFrom
,

5566 
WHERE_DISTINCTBY
, 
nLo›
-1, 
pFrom
->
aLo›
[nLo›-1], &
nŸU£d
);

5567 if–
rc
==1 ) 
pWInfo
->
eDi°ö˘
 = 
WHERE_DISTINCT_ORDERED
;

5569 if–
pFrom
->
isOrdîed
 ){

5570 if–
pWInfo
->
w˘æFœgs
 & 
WHERE_DISTINCTBY
 ){

5571 
pWInfo
->
eDi°ö˘
 = 
WHERE_DISTINCT_ORDERED
;

5573 
pWInfo
->
bOBS©
 = 1;

5574 
pWInfo
->
ªvMask
 = 
pFrom
->
ªvLo›
;

5577 
pWInfo
->
nRowOut
 = 
pFrom
->
nRow
;

5580 
	`sqlôe4DbFªe
(
db
, 
pS∑˚
);

5581  
SQLITE4_OK
;

5582 
	}
}

5595 
	$whîeSh‹tCut
(
WhîeLo›Buûdî
 *
pBuûdî
){

5596 
WhîeInfo
 *
pWInfo
;

5597 
SrcLi°Iãm
 *
pIãm
;

5598 
WhîeCœu£
 *
pWC
;

5599 
WhîeTîm
 *
pTîm
;

5600 
WhîeLo›
 *
pLo›
;

5601 
iCur
;

5602 
j
;

5603 
TabÀ
 *
pTab
;

5604 
Index
 *
pIdx
;

5606 
pWInfo
 = 
pBuûdî
->pWInfo;

5607 if–
pWInfo
->
w˘æFœgs
 & 
WHERE_FORCE_TABLE
 )  0;

5608 
	`as£π
–
pWInfo
->
pTabLi°
->
nSrc
>=1 );

5609 
pIãm
 = 
pWInfo
->
pTabLi°
->
a
;

5610 
pTab
 = 
pIãm
->pTab;

5611 if–
	`IsVútuÆ
(
pTab
) )  0;

5612 if–
pIãm
->
zIndex
 )  0;

5613 
iCur
 = 
pIãm
->
iCurs‹
;

5614 
pWC
 = &
pWInfo
->
sWC
;

5615 
pLo›
 = 
pBuûdî
->
pNew
;

5616 
pLo›
->
wsFœgs
 = 0;

5618 
pIdx
=
pTab
->
pIndex
;ÖIdx;ÖIdxıIdx->
pNext
){

5619 if–
pIdx
->
⁄Eº‹
==
OE_N⁄e
 ) ;

5620 
j
=0; j<
pIdx
->
nCﬁumn
; j++){

5621 
pTîm
 = 
	`födTîm
(
pWC
, 
iCur
, 
pIdx
->
aiCﬁumn
[
j
], 0, 
WO_EQ
,ÖIdx);

5622 if–
pTîm
==0 ) ;

5623 
	`whîeLo›Resize
(
pWInfo
->
pP¨£
->
db
, 
pLo›
, 
j
);

5624 
pLo›
->
aLTîm
[
j
] = 
pTîm
;

5626 if–
j
!=
pIdx
->
nCﬁumn
 ) ;

5627 
pLo›
->
wsFœgs
 = 
WHERE_COLUMN_EQ
|
WHERE_ONEROW
|
WHERE_INDEXED
;

5628 if–(
pIãm
->
cﬁU£d
 & ~
	`cﬁumnsInIndex
(
pIdx
))==0 ){

5629 
pLo›
->
wsFœgs
 |
WHERE_IDX_ONLY
;

5631 
pLo›
->
nLTîm
 = 
j
;

5632 
pLo›
->
u
.
båì
.
nEq
 = 
j
;

5633 
pLo›
->
u
.
båì
.
pIndex
 = 
pIdx
;

5635 
pLo›
->
rRun
 = 39;

5639 if–
pLo›
->
wsFœgs
 ){

5640 
pLo›
->
nOut
 = (
WhîeCo°
)1;

5641 
pWInfo
->
a
[0].
pWLo›
 = 
pLo›
;

5642 
pLo›
->
maskSñf
 = 
	`gëMask
(&
pWInfo
->
sMaskSë
, 
iCur
);

5643 
pWInfo
->
a
[0].
iTabCur
 = 
iCur
;

5644 
pWInfo
->
nRowOut
 = 1;

5645 if–
pWInfo
->
pOrdîBy
 )ÖWInfo->
bOBS©
 = 1;

5646 if–
pWInfo
->
w˘æFœgs
 & 
WHERE_WANT_DISTINCT
 ){

5647 
pWInfo
->
eDi°ö˘
 = 
WHERE_DISTINCT_UNIQUE
;

5649 #ifde‡
SQLITE4_DEBUG


5650 
pLo›
->
cId
 = '0';

5655 
	}
}

5737 
WhîeInfo
 *
	$sqlôe4WhîeBegö
(

5738 
P¨£
 *
pP¨£
,

5739 
SrcLi°
 *
pTabLi°
,

5740 
Ex¥
 *
pWhîe
,

5741 
Ex¥Li°
 *
pOrdîBy
,

5742 
Ex¥Li°
 *
pResu…Së
,

5743 
u16
 
w˘æFœgs
,

5744 
iIdxCur


5746 
nByãWInfo
;

5747 
nTabLi°
;

5748 
WhîeInfo
 *
pWInfo
;

5749 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

5750 
Bômask
 
nŸRódy
;

5751 
WhîeLo›Buûdî
 
sWLB
;

5752 
WhîeMaskSë
 *
pMaskSë
;

5753 
WhîeLevñ
 *
pLevñ
;

5754 
WhîeLo›
 *
pLo›
;

5755 
ii
;

5756 
sqlôe4
 *
db
;

5757 
rc
;

5760 if–
pResu…Së
 ) 
w˘æFœgs
 |
WHERE_WANT_DISTINCT
;

5763 
db
 = 
pP¨£
->db;

5764 
	`mem£t
(&
sWLB
, 0, (sWLB));

5765 
sWLB
.
pOrdîBy
 =ÖOrderBy;

5769 if–
	`O±imiz©i⁄DißbÀd
(
db
, 
SQLITE4_Di°ö˘O±
) ){

5770 
w˘æFœgs
 &~
WHERE_WANT_DISTINCT
;

5776 
	`ã°ˇ£
–
pTabLi°
->
nSrc
==
BMS
 );

5777 if–
pTabLi°
->
nSrc
>
BMS
 ){

5778 
	`sqlôe4Eº‹Msg
(
pP¨£
, "© mo° %dÅabÀ†öá joö", 
BMS
);

5787 
nTabLi°
 = (
w˘æFœgs
 & 
WHERE_ONETABLE_ONLY
Ë? 1 : 
pTabLi°
->
nSrc
;

5796 
nByãWInfo
 = 
	`ROUND8
((
WhîeInfo
)+(
nTabLi°
-1)*(
WhîeLevñ
));

5797 
pWInfo
 = 
	`sqlôe4DbMÆlocZîo
(
db
, 
nByãWInfo
 + (
WhîeLo›
));

5798 if–
db
->
mÆlocFaûed
 ){

5799 
	`sqlôe4DbFªe
(
db
, 
pWInfo
);

5800 
pWInfo
 = 0;

5801 
whîeBegöEº‹
;

5803 
pWInfo
->
nLevñ
 = 
nTabLi°
;

5804 
pWInfo
->
pP¨£
 =ÖParse;

5805 
pWInfo
->
pTabLi°
 =ÖTabList;

5806 
pWInfo
->
pOrdîBy
 =ÖOrderBy;

5807 
pWInfo
->
pResu…Së
 =ÖResultSet;

5808 
pWInfo
->
iBªak
 = 
	`sqlôe4VdbeMakeLabñ
(
v
);

5809 
pWInfo
->
w˘æFœgs
 = wctrlFlags;

5810 
pWInfo
->
ßvedNQuîyLo›
 = 
pP¨£
->
nQuîyLo›
;

5811 
pMaskSë
 = &
pWInfo
->
sMaskSë
;

5812 
sWLB
.
pWInfo
 =ÖWInfo;

5813 
sWLB
.
pWC
 = &
pWInfo
->
sWC
;

5814 
sWLB
.
pNew
 = (
WhîeLo›
*)(((*)
pWInfo
)+
nByãWInfo
);

5815 
	`as£π
–
	`EIGHT_BYTE_ALIGNMENT
(
sWLB
.
pNew
) );

5816 
	`whîeLo›Inô
(
sWLB
.
pNew
);

5817 #ifde‡
SQLITE4_DEBUG


5818 
sWLB
.
pNew
->
cId
 = '*';

5824 
	`öôMaskSë
(
pMaskSë
);

5825 
	`whîeCœu£Inô
(&
pWInfo
->
sWC
,ÖWInfo);

5826 
	`sqlôe4Ex¥CodeC⁄°™ts
(
pP¨£
, 
pWhîe
);

5827 
	`whîeS∂ô
(&
pWInfo
->
sWC
, 
pWhîe
, 
TK_AND
);

5828 
	`sqlôe4CodeVîifySchema
(
pP¨£
, -1);

5833 if–
pWhîe
 && (
nTabLi°
==0 || 
	`sqlôe4Ex¥IsC⁄°™tNŸJoö
(pWhere)) ){

5834 
	`sqlôe4Ex¥IfFÆ£
(
pP¨£
, 
pWhîe
, 
pWInfo
->
iBªak
, 
SQLITE4_JUMPIFNULL
);

5835 
pWhîe
 = 0;

5840 if–
nTabLi°
==0 ){

5841 if–
pOrdîBy
 ) 
pWInfo
->
bOBS©
 = 1;

5842 if–
w˘æFœgs
 & 
WHERE_WANT_DISTINCT
 ){

5843 
pWInfo
->
eDi°ö˘
 = 
WHERE_DISTINCT_UNIQUE
;

5863 
ii
=0; ii<
pTabLi°
->
nSrc
; ii++){

5864 
	`¸óãMask
(
pMaskSë
, 
pTabLi°
->
a
[
ii
].
iCurs‹
);

5866 #i‚de‡
NDEBUG


5868 
Bômask
 
toTheLe·
 = 0;

5869 
ii
=0; ii<
pTabLi°
->
nSrc
; ii++){

5870 
Bômask
 
m
 = 
	`gëMask
(
pMaskSë
, 
pTabLi°
->
a
[
ii
].
iCurs‹
);

5871 
	`as£π
–(
m
-1)==
toTheLe·
 );

5872 
toTheLe·
 |
m
;

5882 
	`ex¥A«lyzeAŒ
(
pTabLi°
, &
pWInfo
->
sWC
);

5883 if–
db
->
mÆlocFaûed
 ){

5884 
whîeBegöEº‹
;

5891 if–
pOrdîBy
 && (
w˘æFœgs
 & 
WHERE_WANT_DISTINCT
)!=0 ){

5892 
ii
=0; ii<
pOrdîBy
->
nEx¥
; ii++){

5893 
Ex¥
 *
pEx¥
 = 
	`sqlôe4Ex¥SkùCﬁœã
(
pOrdîBy
->
a
[
ii
].pExpr);

5894 if–
pEx¥
->
›
!=
TK_COLUMN
 ){

5895 
pWInfo
->
pOrdîBy
 =ÖOrderBy = 0;

5897 }if–
pEx¥
->
iCﬁumn
<0 ){

5903 if–
w˘æFœgs
 & 
WHERE_WANT_DISTINCT
 ){

5904 if–
	`isDi°ö˘Redund™t
(
pP¨£
, 
pTabLi°
, &
pWInfo
->
sWC
, 
pResu…Së
) ){

5906 
pWInfo
->
eDi°ö˘
 = 
WHERE_DISTINCT_UNIQUE
;

5907 }if–
pOrdîBy
==0 ){

5909 
pWInfo
->
w˘æFœgs
 |
WHERE_DISTINCTBY
;

5910 
pWInfo
->
pOrdîBy
 = 
pResu…Së
;

5915 
	`WHERETRACE
(0xffff,("*** Optimizer Start ***\n"));

5916 if–
nTabLi°
!=1 || 
	`whîeSh‹tCut
(&
sWLB
)==0 ){

5917 
rc
 = 
	`whîeLo›AddAŒ
(&
sWLB
);

5918 if–
rc
 ) 
whîeBegöEº‹
;

5921 #ifde‡
WHERETRACE_ENABLED


5922 if–
sqlôe4WhîeTø˚
 ){

5923 
WhîeLo›
 *
p
;

5924 
i
;

5925 
zLabñ
[] = "0123456789abcdefghijklmnopqrstuvwyxz"

5927 
p
=
pWInfo
->
pLo›s
, 
i
=0;Ö;Öı->
pNextLo›
, i++){

5928 
p
->
cId
 = 
zLabñ
[
i
%(zLabel)];

5929 
	`whîeLo›Pröt
(
p
, 
pTabLi°
);

5934 
	`whîeP©hSﬁvî
(
pWInfo
, 0);

5935 if–
db
->
mÆlocFaûed
 ) 
whîeBegöEº‹
;

5936 if–
pWInfo
->
pOrdîBy
 ){

5937 
	`whîeP©hSﬁvî
(
pWInfo
,ÖWInfo->
nRowOut
+1);

5938 if–
db
->
mÆlocFaûed
 ) 
whîeBegöEº‹
;

5941 if–
pWInfo
->
pOrdîBy
==0 && (
db
->
Êags
 & 
SQLITE4_Revî£Ordî
)!=0 ){

5942 
pWInfo
->
ªvMask
 = (
Bômask
)(-1);

5944 if–
pP¨£
->
nEº
 || 
	`NEVER
(
db
->
mÆlocFaûed
) ){

5945 
whîeBegöEº‹
;

5947 #ifde‡
WHERETRACE_ENABLED


5948 if–
sqlôe4WhîeTø˚
 ){

5949 
ii
;

5950 
	`sqlôe4DebugPrötf
("---- Sﬁuti⁄ÇRow=%d", 
pWInfo
->
nRowOut
);

5951 if–
pWInfo
->
bOBS©
 ){

5952 
	`sqlôe4DebugPrötf
(" ORDERBY=0x%Œx", 
pWInfo
->
ªvMask
);

5954  
pWInfo
->
eDi°ö˘
 ){

5955 
WHERE_DISTINCT_UNIQUE
: {

5956 
	`sqlôe4DebugPrötf
(" DISTINCT=unique");

5959 
WHERE_DISTINCT_ORDERED
: {

5960 
	`sqlôe4DebugPrötf
(" DISTINCT=ordered");

5963 
WHERE_DISTINCT_UNORDERED
: {

5964 
	`sqlôe4DebugPrötf
(" DISTINCT=unordered");

5968 
	`sqlôe4DebugPrötf
("\n");

5969 
ii
=0; ii<
pWInfo
->
nLevñ
; ii++){

5970 
	`whîeLo›Pröt
(
pWInfo
->
a
[
ii
].
pWLo›
, 
pTabLi°
);

5975 if–
pWInfo
->
nLevñ
>=2

5976 && 
pResu…Së
!=0

5977 && 
	`O±imiz©i⁄E«bÀd
(
db
, 
SQLITE4_OmôNo›Joö
)

5979 
Bômask
 
èbU£d
 = 
	`ex¥Li°TabÀUßge
(
pMaskSë
, 
pResu…Së
);

5980 if–
pOrdîBy
 ) 
èbU£d
 |
	`ex¥Li°TabÀUßge
(
pMaskSë
,ÖOrderBy);

5981  
pWInfo
->
nLevñ
>=2 ){

5982 
WhîeTîm
 *
pTîm
, *
pEnd
;

5983 
pLo›
 = 
pWInfo
->
a
[pWInfo->
nLevñ
-1].
pWLo›
;

5984 if–(
pWInfo
->
pTabLi°
->
a
[
pLo›
->
iTab
].
joöty≥
 & 
JT_LEFT
)==0 ) ;

5985 if–(
w˘æFœgs
 & 
WHERE_WANT_DISTINCT
)==0

5986 && (
pLo›
->
wsFœgs
 & 
WHERE_ONEROW
)==0

5990 if–(
èbU£d
 & 
pLo›
->
maskSñf
)!=0 ) ;

5991 
pEnd
 = 
sWLB
.
pWC
->
a
 + sWLB.pWC->
nTîm
;

5992 
pTîm
=
sWLB
.
pWC
->
a
;ÖTîm<
pEnd
;ÖTerm++){

5993 if–(
pTîm
->
¥îeqAŒ
 & 
pLo›
->
maskSñf
)!=0

5994 && !
	`Ex¥HasPr›îty
(
pTîm
->
pEx¥
, 
EP_FromJoö
)

5999 if–
pTîm
<
pEnd
 ) ;

6000 
	`WHERETRACE
(0xffff, ("-> dr›Üo› %¯nŸ u£d\n", 
pLo›
->
cId
));

6001 
pWInfo
->
nLevñ
--;

6002 
nTabLi°
--;

6005 
	`WHERETRACE
(0xffff,("*** Optimizer Finished ***\n"));

6006 
pWInfo
->
pP¨£
->
nQuîyLo›
 +pWInfo->
nRowOut
;

6013 
	`as£π
–(
w˘æFœgs
 & 
WHERE_ONEPASS_DESIRED
)==0 || 
pWInfo
->
nLevñ
==1 );

6014 if–(
w˘æFœgs
 & 
WHERE_ONEPASS_DESIRED
)!=0

6015 && (
pWInfo
->
a
[0].
pWLo›
->
wsFœgs
 & 
WHERE_ONEROW
)!=0 ){

6016 
pWInfo
->
okO√Pass
 = 1;

6017 
pWInfo
->
a
[0].
pWLo›
->
wsFœgs
 &~
WHERE_IDX_ONLY
;

6023 
nŸRódy
 = ~(
Bômask
)0;

6024 
ii
=0, 
pLevñ
=
pWInfo
->
a
; ii<
nTabLi°
; ii++,ÖLevel++){

6025 
TabÀ
 *
pTab
;

6026 
iDb
;

6027 
SrcLi°Iãm
 *
pTabIãm
;

6029 
pTabIãm
 = &
pTabLi°
->
a
[
pLevñ
->
iFrom
];

6030 
pTab
 = 
pTabIãm
->pTab;

6031 
iDb
 = 
	`sqlôe4SchemaToIndex
(
db
, 
pTab
->
pSchema
);

6032 
pLo›
 = 
pLevñ
->
pWLo›
;

6033 if–(
pTab
->
èbFœgs
 & 
TF_EphemîÆ
)!=0 ||ÖTab->
pSñe˘
 ){

6036 #i‚de‡
SQLITE4_OMIT_VIRTUALTABLE


6037 if–(
pLo›
->
wsFœgs
 & 
WHERE_VIRTUALTABLE
)!=0 ){

6038 c⁄° *
pVTab
 = (c⁄° *)
	`sqlôe4GëVTabÀ
(
db
, 
pTab
);

6039 
iCur
 = 
pTabIãm
->
iCurs‹
;

6040 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_VO≥n
, 
iCur
, 0, 0, 
pVTab
, 
P4_VTAB
);

6041 }if–
	`IsVútuÆ
(
pTab
) ){

6045 if–(
pLo›
->
wsFœgs
 & 
WHERE_IDX_ONLY
)==0

6046 && (
w˘æFœgs
 & 
WHERE_OMIT_OPEN_CLOSE
)==0 ){

6047 
›
 = 
pWInfo
->
okO√Pass
 ? 
OP_O≥nWrôe
 : 
OP_O≥nRód
;

6048 
	`sqlôe4O≥nPrim¨yKey
(
pP¨£
, 
pTabIãm
->
iCurs‹
, 
iDb
, 
pTab
, 
›
);

6049 
	`ã°ˇ£
–!
pWInfo
->
okO√Pass
 && 
pTab
->
nCﬁ
==
BMS
-1 );

6050 
	`ã°ˇ£
–!
pWInfo
->
okO√Pass
 && 
pTab
->
nCﬁ
==
BMS
 );

6052 #i‚de‡
SQLITE4_OMIT_AUTOMATIC_INDEX


6053 if–(
pLo›
->
wsFœgs
 & 
WHERE_AUTO_INDEX
)!=0 ){

6054 
	`c⁄°ru˘Autom©icIndex
(
pP¨£
, &
pWInfo
->
sWC
, 
pTabIãm
, 
nŸRódy
, 
pLevñ
);

6057 if–
pLo›
->
wsFœgs
 & 
WHERE_INDEXED
 ){

6058 
Index
 *
pIx
 = 
pLo›
->
u
.
båì
.
pIndex
;

6059 if–
pIx
->
eIndexTy≥
==
SQLITE4_INDEX_PRIMARYKEY
 ){

6060 
pLevñ
->
iIdxCur
 = 
pTabIãm
->
iCurs‹
;

6063 
pLevñ
->
iIdxCur
 = iIdxCu∏? iIdxCu∏: 
pP¨£
->
nTab
++;

6064 if–
pIx
->
eIndexTy≥
!=
SQLITE4_INDEX_FTS5
 ){

6065 
KeyInfo
 *
pKey
 = 
	`sqlôe4IndexKeyöfo
(
pP¨£
, 
pIx
);

6066 
	`as£π
–
pIx
->
pSchema
==
pTab
->pSchema );

6067 
	`as£π
–
pLevñ
->
iIdxCur
>=0 );

6068 
	`sqlôe4VdbeAddOp4
(
v
, 
OP_O≥nRód
, 
pLevñ
->
iIdxCur
, 
pIx
->
äum
, 
iDb
,

6069 (*)
pKey
, 
P4_KEYINFO_HANDOFF
);

6070 
	`VdbeCommít
((
v
, "%s", 
pIx
->
zName
));

6074 
	`sqlôe4CodeVîifySchema
(
pP¨£
, 
iDb
);

6075 
nŸRódy
 &~
	`gëMask
(&
pWInfo
->
sMaskSë
, 
pTabIãm
->
iCurs‹
);

6077 
pWInfo
->
iT›
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

6078 if–
db
->
mÆlocFaûed
 ) 
whîeBegöEº‹
;

6084 
nŸRódy
 = ~(
Bômask
)0;

6085 
ii
=0; ii<
nTabLi°
; ii++){

6086 
pLevñ
 = &
pWInfo
->
a
[
ii
];

6087 
	`ex∂aöO√Sˇn
(
pP¨£
, 
pTabLi°
, 
pLevñ
, 
ii
,ÖLevñ->
iFrom
, 
w˘æFœgs
);

6088 
nŸRódy
 = 
	`codeO√Lo›Sèπ
(
pWInfo
, 
ii
,ÇotReady);

6089 
pWInfo
->
iC⁄töue
 = 
pLevñ
->
addrC⁄t
;

6093  
pWInfo
;

6096 
whîeBegöEº‹
:

6097 if–
pWInfo
 ){

6098 
pP¨£
->
nQuîyLo›
 = 
pWInfo
->
ßvedNQuîyLo›
;

6099 
	`whîeInfoFªe
(
db
, 
pWInfo
);

6102 
	}
}

6108 
	$sqlôe4WhîeEnd
(
WhîeInfo
 *
pWInfo
){

6109 
P¨£
 *
pP¨£
 = 
pWInfo
->pParse;

6110 
Vdbe
 *
v
 = 
pP¨£
->
pVdbe
;

6111 
i
;

6112 
WhîeLevñ
 *
pLevñ
;

6113 
WhîeLo›
 *
pLo›
;

6114 
SrcLi°
 *
pTabLi°
 = 
pWInfo
->pTabList;

6115 
sqlôe4
 *
db
 = 
pP¨£
->db;

6119 
	`sqlôe4Ex¥CacheCÀ¨
(
pP¨£
);

6120 
i
=
pWInfo
->
nLevñ
-1; i>=0; i--){

6121 
pLevñ
 = &
pWInfo
->
a
[
i
];

6122 
pLo›
 = 
pLevñ
->
pWLo›
;

6123 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
pLevñ
->
addrC⁄t
);

6124 if–
pLevñ
->
›
!=
OP_No›
 ){

6125 
	`sqlôe4VdbeAddOp2
(
v
, 
pLevñ
->
›
,ÖLevñ->
p1
,ÖLevñ->
p2
);

6126 
	`sqlôe4VdbeCh™geP5
(
v
, 
pLevñ
->
p5
);

6128 if–
pLo›
->
wsFœgs
 & 
WHERE_IN_ABLE
 && 
pLevñ
->
u
.
ö
.
nIn
>0 ){

6129 
InLo›
 *
pIn
;

6130 
j
;

6131 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
pLevñ
->
addrNxt
);

6132 
j
=
pLevñ
->
u
.
ö
.
nIn
, 
pIn
=&pLevñ->u.ö.
aInLo›
[j-1]; j>0; j--,ÖIn--){

6133 
	`sqlôe4VdbeJumpHîe
(
v
, 
pIn
->
addrInT›
+1);

6134 
	`sqlôe4VdbeAddOp2
(
v
, 
pIn
->
eEndLo›Op
,ÖIn->
iCur
,ÖIn->
addrInT›
);

6135 
	`sqlôe4VdbeJumpHîe
(
v
, 
pIn
->
addrInT›
-1);

6137 
	`sqlôe4DbFªe
(
db
, 
pLevñ
->
u
.
ö
.
aInLo›
);

6139 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
pLevñ
->
addrBrk
);

6140 if–
pLevñ
->
iLe·Joö
 ){

6141 
addr
;

6142 
addr
 = 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_IfPos
, 
pLevñ
->
iLe·Joö
);

6143 
	`as£π
–(
pLo›
->
wsFœgs
 & 
WHERE_IDX_ONLY
)==0

6144 || (
pLo›
->
wsFœgs
 & 
WHERE_INDEXED
)!=0 );

6145 if–(
pLo›
->
wsFœgs
 & 
WHERE_IDX_ONLY
)==0 ){

6146 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NuŒRow
, 
pTabLi°
->
a
[
i
].
iCurs‹
);

6148 if–
pLo›
->
wsFœgs
 & 
WHERE_INDEXED
 ){

6149 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_NuŒRow
, 
pLevñ
->
iIdxCur
);

6151 if–
pLevñ
->
›
==
OP_Rëu∫
 ){

6152 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_Gosub
, 
pLevñ
->
p1
,ÖLevñ->
addrFú°
);

6154 
	`sqlôe4VdbeAddOp2
(
v
, 
OP_GŸo
, 0, 
pLevñ
->
addrFú°
);

6156 
	`sqlôe4VdbeJumpHîe
(
v
, 
addr
);

6163 
	`sqlôe4VdbeResﬁveLabñ
(
v
, 
pWInfo
->
iBªak
);

6167 
	`as£π
–
pWInfo
->
nLevñ
<=
pTabLi°
->
nSrc
 );

6168 
i
=0, 
pLevñ
=
pWInfo
->
a
; i<pWInfo->
nLevñ
; i++,ÖLevel++){

6169 
Index
 *
pIdx
 = 0;

6170 
SrcLi°Iãm
 *
pTabIãm
 = &
pTabLi°
->
a
[
pLevñ
->
iFrom
];

6171 
TabÀ
 *
pTab
 = 
pTabIãm
->pTab;

6172 
	`as£π
–
pTab
!=0 );

6173 
pLo›
 = 
pLevñ
->
pWLo›
;

6174 if–(
pTab
->
èbFœgs
 & 
TF_EphemîÆ
)==0

6175 && 
pTab
->
pSñe˘
==0

6176 && (
pWInfo
->
w˘æFœgs
 & 
WHERE_OMIT_OPEN_CLOSE
)==0

6178 
ws
 = 
pLo›
->
wsFœgs
;

6179 if–!
pWInfo
->
okO√Pass
 && (
ws
 & 
WHERE_IDX_ONLY
)==0 ){

6180 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
pTabIãm
->
iCurs‹
);

6182 if–(
ws
 & 
WHERE_INDEXED
)!=0 && (w†& 
WHERE_AUTO_INDEX
)==0 ){

6183 if–
pLevñ
->
iIdxCur
!=
pTabIãm
->
iCurs‹
 ){

6184 
	`sqlôe4VdbeAddOp1
(
v
, 
OP_Clo£
, 
pLevñ
->
iIdxCur
);

6200 if–
pLo›
->
wsFœgs
 & (
WHERE_INDEXED
|
WHERE_IDX_ONLY
) ){

6201 
pIdx
 = 
pLo›
->
u
.
båì
.
pIndex
;

6202 }if–
pLo›
->
wsFœgs
 & 
WHERE_MULTI_OR
 ){

6203 
pIdx
 = 
pLevñ
->
u
.
pCovidx
;

6205 if–
pIdx
 &&ÖIdx->
eIndexTy≥
!=
SQLITE4_INDEX_PRIMARYKEY


6206 && !
db
->
mÆlocFaûed


6208 *
aiCovî
 = 
pIdx
->aiCover;

6209 
nCovî
 = 
pIdx
->nCover;

6210 
k
, 
j
, 
œ°
;

6211 
VdbeOp
 *
pOp
;

6213 
pOp
 = 
	`sqlôe4VdbeGëOp
(
v
, 
pWInfo
->
iT›
);

6214 
œ°
 = 
	`sqlôe4VdbeCuºítAddr
(
v
);

6215 
k
=
pWInfo
->
iT›
; k<
œ°
; k++, 
pOp
++){

6216 if–
pOp
->
p1
!=
pLevñ
->
iTabCur
 ) ;

6217 if–
pOp
->
›code
==
OP_Cﬁumn
 ){

6218 
j
=0; j<
nCovî
; j++){

6219 if–
pOp
->
p2
==
aiCovî
[
j
] ){

6220 
pOp
->
p2
 = 
j
;

6221 
pOp
->
p1
 = 
pLevñ
->
iIdxCur
;

6225 
	`as£π
–(
pLo›
->
wsFœgs
 & 
WHERE_IDX_ONLY
)==0 || 
j
<
nCovî
 );

6226 }if–
pOp
->
›code
==
OP_RowKey
 ){

6227 
Index
 *
pPk
 = 
	`sqlôe4FödPrim¨yKey
(
pTab
, 0);

6228 
pOp
->
p3
 = 
pPk
->
äum
;

6229 
pOp
->
p1
 = 
pLevñ
->
iIdxCur
;

6230 
pOp
->
›code
 = 
OP_IdxRowkey
;

6235 if–(
pLo›
->
wsFœgs
 & 
WHERE_INDEXED
)

6236 && (
pLo›
->
u
.
båì
.
pIndex
->
eIndexTy≥
==
SQLITE4_INDEX_FTS5
)

6238 
VdbeOp
 *
pOp
;

6239 
VdbeOp
 *
pEnd
;

6241 
	`as£π
–
pLevñ
->
iTabCur
!ıLevñ->
iIdxCur
 );

6242 
pOp
 = 
	`sqlôe4VdbeGëOp
(
v
, 
pWInfo
->
iT›
);

6243 
pEnd
 = &
pOp
[
	`sqlôe4VdbeCuºítAddr
(
v
Ë- 
pWInfo
->
iT›
];

6245  
pOp
<
pEnd
 ){

6246 if–
pOp
->
p1
==
pLevñ
->
iTabCur
 &&ÖOp->
›code
==
OP_Mifun˘i⁄
 ){

6247 
pOp
->
p1
 = 
pLevñ
->
iIdxCur
;

6249 
pOp
++;

6256 
pP¨£
->
nQuîyLo›
 = 
pWInfo
->
ßvedNQuîyLo›
;

6257 
	`whîeInfoFªe
(
db
, 
pWInfo
);

6259 
	}
}

	@test/crashtest1.c

17 
	~<°dio.h
>

18 
	~<uni°d.h
>

19 
	~<sys/ty≥s.h
>

20 
	~<sys/waô.h
>

21 
	~<sig«l.h
>

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<sched.h
>

25 
	~"sqlôe.h
"

27 
	$do_some_sql
(
∑ª¡
){

28 *
zEº
;

29 
rc
 = 
SQLITE4_OK
;

30 
sqlôe
 *
db
;

31 
˙t
 = 0;

32 
zBig
[] =

36 if–
	`ac˚ss
("./test.db-journal",0)==0 ){

37  
	`u∆ök
("test.db-saved");

38 
	`sy°em
("cpÅest.dbÅest.db-saved");

39 
	`u∆ök
("test.db-journal-saved");

40 
	`sy°em
("cpÅest.db-journalÅest.db-journal-saved");

42 
db
 = 
	`sqlôe_›í
("./ã°.db", 0, &
zEº
);

43 if–
db
==0 ){

44 
	`¥ötf
("ERROR: %s\n", 
zEº
);

45 if–
	`°rcmp
(
zEº
,"database disk image is malformed")==0 ){

46 
	`kûl
(
∑ª¡
, 
SIGKILL
);

48 
	`exô
(1);

50 
	`§™d
(
	`gëpid
());

51  
rc
==
SQLITE4_OK
 ){

52 
˙t
++;

53 
rc
 = 
	`sqlôe_exec_¥ötf
(
db
,

54 "INSERT INTOÅ1 VALUES(%d,'%d%s')", 0, 0, &
zEº
,

55 
	`ønd
(),Ñ™d(), 
zBig
);

57 if–
rc
!=
SQLITE4_OK
 ){

58 
	`¥ötf
("ERROR #%d: %s\n", 
rc
, 
zEº
);

59 if–
rc
==
SQLITE4_CORRUPT
 ){

60 
	`kûl
(
∑ª¡
, 
SIGKILL
);

63 
	`¥ötf
("pid %d: c¡=%d\n", 
	`gëpid
(), 
˙t
);

64 
	}
}

67 
	$maö
(
¨gc
, **
¨gv
){

68 
i
;

69 
sqlôe
 *
db
;

70 *
zEº
;

71 
°©us
;

72 
∑ª¡
 = 
	`gëpid
();

74 
	`u∆ök
("test.db");

75 
	`u∆ök
("test.db-journal");

76 
db
 = 
	`sqlôe_›í
("ã°.db", 0, &
zEº
);

77 if–
db
==0 ){

78 
	`¥ötf
("C™nŸ inôülize: %s\n", 
zEº
);

81 
	`sqlôe_exec
(
db
, "CREATE TABLEÅ1(a,b)", 0, 0, 0);

82 
	`sqlôe_˛o£
(
db
);

83 
i
=0; i<10000; i++){

84 
pid
 = 
	`f‹k
();

85 if–
pid
==0 ){

86 
	`sched_yõld
();

87 
	`do_some_sql
(
∑ª¡
);

90 
	`¥ötf
("ã° %d,Öid=%d\n", 
i
, 
pid
);

91 
	`u¶ìp
(
	`ønd
()%10000 + 1000);

92 
	`kûl
(
pid
, 
SIGKILL
);

93 
	`waôpid
(
pid
, &
°©us
, 0);

96 
	}
}

	@test/testInt.h

13 #i‚de‡
__TEST_INT_H


14 
	#__TEST_INT_H


	)

16 
	~<t˛.h
>

20 
Sqlôëe°_auth_öô
(
T˛_I¡îp
 *
öãΩ
);

24 
Sqlôëe°_func_Inô
(
T˛_I¡îp
 *);

27 
sqlôe4Te°Inô
(
T˛_I¡îp
*);

28 *
sqlôe4Te°TextToPå
(c⁄° *
z
);

29 
sqlôe4Te°DbH™dÀ
(
T˛_I¡îp
 *, 
T˛_Obj
 *, 
sqlôe4
 **);

30 
sqlôe4Te°SëResu…
(
T˛_I¡îp
 *
öãΩ
, 
rc
);

66 
	#TESTMEM_CTRL_REPORT
 62930001

	)

67 
	#TESTMEM_CTRL_FAULTCONFIG
 62930002

	)

68 
	#TESTMEM_CTRL_FAULTREPORT
 62930003

	)

70 
sqlôe4_mm
 *
ã°_mm_debug
(sqlôe4_mm *
p
);

71 
sqlôe4_mm
 *
ã°_mm_Áu…sim
(sqlôe4_mm *
p
);

74 
Sqlôëe°_num_öô
(
T˛_I¡îp
 *
öãΩ
);

77 
Sqlôëe°Bt_Inô
(
T˛_I¡îp
 *
öãΩ
);

	@test/test_auth.c

12 
	~<°dio.h
>

13 
	~<as£π.h
>

14 
	~<°rög.h
>

16 
	~"sqlôe4.h
"

17 
	~"ã°I¡.h
"

19 
Te°Auth
 
	tTe°Auth
;

20 
	sTe°Auth
 {

21 
T˛_I¡îp
 *
	möãΩ
;

22 
T˛_Obj
 *
	mpS¸ùt
;

23 
T˛_Obj
 *
	mpDe°roy
;

24 
sqlôe4
 *
	mdb
;

27 c⁄° *
	$sqlôe4Te°AuthCode
(
rˇuth
){

28  
rˇuth
 ){

29 
SQLITE4_CREATE_INDEX
:  "SQLITE4_CREATE_INDEX";

30 
SQLITE4_CREATE_TABLE
:  "SQLITE4_CREATE_TABLE";

31 
SQLITE4_CREATE_TEMP_INDEX
:  "SQLITE4_CREATE_TEMP_INDEX";

32 
SQLITE4_CREATE_TEMP_TABLE
:  "SQLITE4_CREATE_TEMP_TABLE";

33 
SQLITE4_CREATE_TEMP_TRIGGER
:  "SQLITE4_CREATE_TEMP_TRIGGER";

34 
SQLITE4_CREATE_TEMP_VIEW
:  "SQLITE4_CREATE_TEMP_VIEW";

35 
SQLITE4_CREATE_TRIGGER
:  "SQLITE4_CREATE_TRIGGER";

36 
SQLITE4_CREATE_VIEW
:  "SQLITE4_CREATE_VIEW";

37 
SQLITE4_DELETE
:  "SQLITE4_DELETE";

38 
SQLITE4_DROP_INDEX
:  "SQLITE4_DROP_INDEX";

39 
SQLITE4_DROP_TABLE
:  "SQLITE4_DROP_TABLE";

40 
SQLITE4_DROP_TEMP_INDEX
:  "SQLITE4_DROP_TEMP_INDEX";

41 
SQLITE4_DROP_TEMP_TABLE
:  "SQLITE4_DROP_TEMP_TABLE";

42 
SQLITE4_DROP_TEMP_TRIGGER
:  "SQLITE4_DROP_TEMP_TRIGGER";

43 
SQLITE4_DROP_TEMP_VIEW
:  "SQLITE4_DROP_TEMP_VIEW";

44 
SQLITE4_DROP_TRIGGER
:  "SQLITE4_DROP_TRIGGER";

45 
SQLITE4_DROP_VIEW
:  "SQLITE4_DROP_VIEW";

46 
SQLITE4_INSERT
:  "SQLITE4_INSERT";

47 
SQLITE4_PRAGMA
:  "SQLITE4_PRAGMA";

48 
SQLITE4_READ
:  "SQLITE4_READ";

49 
SQLITE4_SELECT
:  "SQLITE4_SELECT";

50 
SQLITE4_TRANSACTION
:  "SQLITE4_TRANSACTION";

51 
SQLITE4_UPDATE
:  "SQLITE4_UPDATE";

52 
SQLITE4_ATTACH
:  "SQLITE4_ATTACH";

53 
SQLITE4_DETACH
:  "SQLITE4_DETACH";

54 
SQLITE4_ALTER_TABLE
:  "SQLITE4_ALTER_TABLE";

55 
SQLITE4_REINDEX
:  "SQLITE4_REINDEX";

56 
SQLITE4_ANALYZE
:  "SQLITE4_ANALYZE";

57 
SQLITE4_CREATE_VTABLE
:  "SQLITE4_CREATE_VTABLE";

58 
SQLITE4_DROP_VTABLE
:  "SQLITE4_DROP_VTABLE";

59 
SQLITE4_FUNCTION
:  "SQLITE4_FUNCTION";

60 
SQLITE4_SAVEPOINT
:  "SQLITE4_SAVEPOINT";

63 
	}
}

65 
	$ã°auth_xDñ
(*
pCtx
){

66 
Te°Auth
 *
p
 = (Te°Auth *)
pCtx
;

67 if–
p
->
pDe°roy
 ){

68 
	`T˛_EvÆObjEx
(
p
->
öãΩ
,Ö->
pDe°roy
, 
TCL_EVAL_GLOBAL
);

69 
	`T˛_De¸RefCou¡
(
p
->
pDe°roy
);

71 
	`T˛_De¸RefCou¡
(
p
->
pS¸ùt
);

72 
	`ck‰ì
(
p
);

73 
	}
}

75 
	$ã°auth_xAuth
(

76 *
pCtx
,

77 
code
,

78 c⁄° *
z1
,

79 c⁄° *
z2
,

80 c⁄° *
z3
,

81 c⁄° *
z4


83 
Te°Auth
 *
p
 = (Te°Auth *)
pCtx
;

84 
T˛_I¡îp
 *
öãΩ
 = 
p
->interp;

85 
T˛_Obj
 *
pEvÆ
;

86 
T˛_Obj
 *
pCode
;

87 
rc
;

89 
pEvÆ
 = 
	`T˛_Du∂iˇãObj
(
p
->
pS¸ùt
);

90 
	`T˛_In¸RefCou¡
(
pEvÆ
);

92 
pCode
 = 
	`T˛_NewSåögObj
(
	`sqlôe4Te°AuthCode
(
code
), -1);

93 if–
TCL_OK
!=
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pEvÆ
, 
pCode
)

94 || 
TCL_OK
!=
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pEvÆ
, 
	`T˛_NewSåögObj
(
z1
, -1))

95 || 
TCL_OK
!=
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pEvÆ
, 
	`T˛_NewSåögObj
(
z2
, -1))

96 || 
TCL_OK
!=
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pEvÆ
, 
	`T˛_NewSåögObj
(
z3
, -1))

97 || 
TCL_OK
!=
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pEvÆ
, 
	`T˛_NewSåögObj
(
z4
, -1))

99 
rc
 = -1;

101 if–
TCL_OK
!=
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pEvÆ
, 
TCL_EVAL_GLOBAL
) ){

102 
rc
 = -2;

104 c⁄° *
zRes
 = 
	`T˛_GëSåögResu…
(
p
->
öãΩ
);

105 
rc
 = -3;

106 if–
	`°rcmp
(
zRes
, "SQLITE4_OK")==0 ) 
rc
 = 
SQLITE4_OK
;

107 if–
	`°rcmp
(
zRes
, "SQLITE4_ALLOW")==0 ) 
rc
 = 
SQLITE4_ALLOW
;

108 if–
	`°rcmp
(
zRes
, "SQLITE4_IGNORE")==0 ) 
rc
 = 
SQLITE4_IGNORE
;

109 if–
	`°rcmp
(
zRes
, "SQLITE4_DENY")==0 ) 
rc
 = 
SQLITE4_DENY
;

113 
	`T˛_De¸RefCou¡
(
pEvÆ
);

114  
rc
;

115 
	}
}

120 
	$ã°auth_push
(

121 * 
˛õ¡D©a
,

122 
T˛_I¡îp
 *
öãΩ
,

123 
objc
,

124 
T˛_Obj
 *
CONST
 
objv
[]

126 
Te°Auth
 *
pNew
;

127 
sqlôe4
 *
db
;

128 
rc
;

130 if–
objc
!=3 && objc!=4 ){

131 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB SCRIPT ?DESTRUCTOR-SCRIPT?");

132  
TCL_ERROR
;

134 
rc
 = 
	`sqlôe4Te°DbH™dÀ
(
öãΩ
, 
objv
[1], &
db
);

135 if–
rc
!=
TCL_OK
 ) Ñc;

137 
pNew
 = (
Te°Auth
 *)
	`ckÆloc
((TestAuth));

138 
	`mem£t
(
pNew
, 0, (
Te°Auth
));

140 
pNew
->
öãΩ
 = interp;

141 
pNew
->
db
 = db;

142 
pNew
->
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
objv
[2]);

143 
	`T˛_In¸RefCou¡
(
pNew
->
pS¸ùt
);

144 if–
objc
==4 ){

145 
pNew
->
pDe°roy
 = 
	`T˛_Du∂iˇãObj
(
objv
[3]);

146 
	`T˛_In¸RefCou¡
(
pNew
->
pDe°roy
);

149 
rc
 = 
	`sqlôe4_auth‹izî_push
(
db
, (*)
pNew
, 
ã°auth_xAuth
, 
ã°auth_xDñ
);

150 if–
rc
!=
SQLITE4_OK
 ){

151 
	`sqlôe4Te°SëResu…
(
öãΩ
, 
rc
);

152  
TCL_ERROR
;

154 
	`T˛_Re£tResu…
(
öãΩ
);

155  
TCL_OK
;

156 
	}
}

161 
	$ã°auth_p›
(

162 *
˛õ¡D©a
,

163 
T˛_I¡îp
 *
öãΩ
,

164 
objc
,

165 
T˛_Obj
 *
CONST
 
objv
[]

167 
rc
;

168 
sqlôe4
 *
db
;

170 if–
objc
!=2 ){

171 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB");

172  
TCL_ERROR
;

174 
rc
 = 
	`sqlôe4Te°DbH™dÀ
(
öãΩ
, 
objv
[1], &
db
);

175 if–
rc
!=
TCL_OK
 ) Ñc;

177 
rc
 = 
	`sqlôe4_auth‹izî_p›
(
db
);

178 if–
rc
 ){

179 
	`sqlôe4Te°SëResu…
(
öãΩ
, 
rc
);

180  
TCL_ERROR
;

182 
	`T˛_Re£tResu…
(
öãΩ
);

183  
TCL_OK
;

184 
	}
}

186 
	$Sqlôëe°_auth_öô
(
T˛_I¡îp
 *
öãΩ
){

187 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sqlôe4_auth‹izî_push", 
ã°auth_push
, 0, 0);

188 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sqlôe4_auth‹izî_p›", 
ã°auth_p›
, 0, 0);

189  
TCL_OK
;

190 
	}
}

	@test/test_bt.c

14 
	~<t˛.h
>

15 
	~"bt.h
"

16 
	~"sqlôe4.h
"

17 
	~"ã°I¡.h
"

18 
	~<as£π.h
>

19 
	~<°rög.h
>

21 
	#MIN
(
x
,
y
Ë(((x)<(y)Ë? (xË: (y))

	)

22 
	#MAX
(
x
,
y
Ë(((x)<(y)Ë? (yË: (x))

	)

24 
sqlôe4_öt64
 
	ti64
;

25 
	tu8
;

26 
BtTe°Env
 
	tBtTe°Env
;

27 
BtTe°Fûe
 
	tBtTe°Fûe
;

28 
BtTe°Se˘‹
 
	tBtTe°Se˘‹
;

34 
	sBtTe°Env
 {

35 
bt_ív
 
	mba£
;

36 
sqlôe4_ív
 *
	mpSqlEnv
;

37 
bt_ív
 *
	mpEnv
;

40 
	mnI€ºC¡
;

41 
	mbI€ºPîsi°
;

42 
	mnI€ºInje˘ed
;

45 
	mnCøshC¡
;

46 
	mbWÆCøsh
;

47 
	mbCøshed
;

49 
BtTe°Fûe
 *
	mpTe°Fûe
;

52 
	#BTTEST_SECTOR_SIZE
 512

	)

53 
	sBtTe°Se˘‹
 {

54 
	miFú°Unsyn˚d
;

55 
	miLa°Unsyn˚d
;

56 
u8
 
	maBuf
[
BTTEST_SECTOR_SIZE
];

59 
	sBtTe°Fûe
 {

60 
BtTe°Env
 *
	mpTe°Env
;

61 
BtTe°Fûe
 *
	mpNext
;

62 
	mÊags
;

63 
bt_fûe
 *
	mpFûe
;

65 
	mnSe˘‹
;

66 
BtTe°Se˘‹
 **
	m≠Se˘‹
;

74 
	$ã°Flush
(
BtTe°Fûe
 *
pTe°
){

75 
i
;

76 
bt_ív
 *
pEnv
 = 
pTe°
->
pTe°Env
->pEnv;

78 
i
=0; i<
pTe°
->
nSe˘‹
; i++){

79 
BtTe°Se˘‹
 *
pSe˘‹
 = 
pTe°
->
≠Se˘‹
[
i
];

80 if–
pSe˘‹
 ){

81 
i64
 
iOff
 = (i64)
i
 * 
BTTEST_SECTOR_SIZE
 + 
pSe˘‹
->
iFú°Unsyn˚d
;

82 
nD©a
 = 
pSe˘‹
->
iLa°Unsyn˚d
 -ÖSe˘‹->
iFú°Unsyn˚d
;

83 
pEnv
->
	`xWrôe
(

84 
pTe°
->
pFûe
, 
iOff
, &
pSe˘‹
->
aBuf
[pSe˘‹->
iFú°Unsyn˚d
], 
nD©a


88 
pTe°
->
≠Se˘‹
[
i
] = 0;

89 
	`ck‰ì
(
pSe˘‹
);

92 
	`ck‰ì
(
pTe°
->
≠Se˘‹
);

93 
pTe°
->
≠Se˘‹
 = 0;

94 
pTe°
->
nSe˘‹
 = 0;

95 
	}
}

97 
	$ã°Cøsh
(
BtTe°Env
 *
pTe°Env
){

98 
BtTe°Fûe
 *
pFûe
;

99 
pFûe
=
pTe°Env
->
pTe°Fûe
;ÖFûe;ÖFûeıFûe->
pNext
){

100 
i
;

101 
i
=0; i<
pFûe
->
nSe˘‹
; i++){

102 
r
;

103 
BtTe°Se˘‹
 *
pSe˘‹
 = 
pFûe
->
≠Se˘‹
[
i
];

104 if–
pSe˘‹
==0 ) ;

106 
	`sqlôe4_øndom√ss
(
pTe°Env
->
pSqlEnv
, (), &
r
);

107  
r
%3 ){

113 
	`ck‰ì
(
pSe˘‹
);

114 
pFûe
->
≠Se˘‹
[
i
] = 0;

118 
nByã
 = (
pSe˘‹
->
iLa°Unsyn˚d
 -ÖSe˘‹->
iFú°Unsyn˚d
);

119 
	`sqlôe4_øndom√ss
(

120 
pTe°Env
->
pSqlEnv
, 
nByã
, &
pSe˘‹
->
aBuf
[pSe˘‹->
iFú°Unsyn˚d
]

128 
pTe°Env
->
bCøshed
 = 1;

129 
	}
}

136 
	$ã°CøshOrFlush
(
BtTe°Fûe
 *
pTe°
){

137 
bAŒ
 = 0;

138 
BtTe°Env
 *
pTe°Env
 = 
pTe°
->pTestEnv;

140 if–
pTe°Env
->
nCøshC¡
 ){

141 if–((
pTe°
->
Êags
 & 
BT_OPEN_LOG
Ë&& 
pTe°Env
->
bWÆCøsh
)

142 || ((
pTe°
->
Êags
 & 
BT_OPEN_DATABASE
Ë&& 
pTe°Env
->
bWÆCøsh
==0)

144 
pTe°Env
->
nCøshC¡
--;

145 if–
pTe°Env
->
nCøshC¡
==0 ){

146 
	`ã°Cøsh
(
pTe°Env
);

147 
bAŒ
 = 1;

152 if–
bAŒ
 ){

153 
BtTe°Fûe
 *
pFûe
;

154 
pFûe
=
pTe°Env
->
pTe°Fûe
;ÖFûe;ÖFûeıFûe->
pNext
){

155 
	`ã°Flush
(
pFûe
);

158 
	`ã°Flush
(
pTe°
);

160 
	}
}

169 
	$ã°Inje˘I€º
(
BtTe°Env
 *
p
){

170 if–
p
->
bCøshed
 )  1;

171 if–(
p
->
nI€ºC¡
==0 &&Ö->
bI€ºPîsi°
)

172 || (
p
->
nI€ºC¡
>0 && (--p->nIoerrCnt)==0)

174 
p
->
nI€ºInje˘ed
++;

178 
	}
}

183 
	$ã°BtOsO≥n
(

184 
sqlôe4_ív
 *
pSqlEnv
,

185 
bt_ív
 *
pEnv
,

186 c⁄° *
zFûe
,

187 
Êags
,

188 
bt_fûe
 **
µFûe


190 
BtTe°Env
 *
p
 = (BtTe°Env*)
pEnv
;

191 
BtTe°Fûe
 *
pNew
 = 0;

192 
rc
;

194 if–
	`ã°Inje˘I€º
(
p
) ){

195 
rc
 = 
SQLITE4_CANTOPEN
;

197 
pNew
 = 
	`ckÆloc
((
BtTe°Fûe
));

198 
	`mem£t
(
pNew
, 0, (
BtTe°Fûe
));

199 
pNew
->
pTe°Env
 = 
p
;

200 
pNew
->
Êags
 = flags;

201 
rc
 = 
p
->
pEnv
->
	`xO≥n
(
pSqlEnv
,Ö->pEnv, 
zFûe
, 
Êags
, &
pNew
->
pFûe
);

202 if–
rc
!=
SQLITE4_OK
 ){

203 
	`ck‰ì
(
pNew
);

204 
pNew
 = 0;

206 
pNew
->
pNext
 = 
p
->
pTe°Fûe
;

207 
p
->
pTe°Fûe
 = 
pNew
;

210 *
µFûe
 = (
bt_fûe
*)
pNew
;

211  
rc
;

212 
	}
}

214 
	$ã°BtOsSize
(
bt_fûe
 *
pFûe
, 
i64
 *
≤Byã
){

215 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

216 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

217 
rc
;

219 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

220 
rc
 = 
SQLITE4_IOERR_FSTAT
;

222 
rc
 = 
pEnv
->
	`xSize
(
pTe°Fûe
->
pFûe
, 
≤Byã
);

224  
rc
;

225 
	}
}

227 
	$ã°BtOsWrôe
(

228 
bt_fûe
 *
pFûe
,

229 
i64
 
iOff
,

230 *
pD©a
,

231 
nD©a


233 
BtTe°Fûe
 *
pTe°
 = (BtTe°Fûe*)
pFûe
;

234 
BtTe°Env
 *
pTe°Env
 = 
pTe°
->pTestEnv;

235 
rc
;

237 if–
pTe°Env
->
nCøshC¡
 ){

240 
i64
 
iWrôe
 = 
iOff
;

241 
nRem
 = 
nD©a
;

242 
u8
 *
aRem
 = (u8*)
pD©a
;

243 
nSe˘‹
;

244 
iSe˘‹
;

247 
nSe˘‹
 = ((
iOff
+
nD©a
Ë+ 
BTTEST_SECTOR_SIZE
 - 1) / BTTEST_SECTOR_SIZE;

248 if–
nSe˘‹
>
pTe°
->nSector ){

249 
nByã
 = (
BtTe°Se˘‹
*)*
nSe˘‹
;

250 
nExåa
 = 
nByã
 - (
BtTe°Se˘‹
*)*
pTe°
->
nSe˘‹
;

251 
pTe°
->
≠Se˘‹
 = (
BtTe°Se˘‹
**)
	`ckªÆloc
’Te°->≠Se˘‹, 
nByã
);

252 
	`mem£t
(&
pTe°
->
≠Se˘‹
[pTe°->
nSe˘‹
], 0, 
nExåa
);

253 
pTe°
->
nSe˘‹
 =ÇSector;

257 
iSe˘‹
=(
iOff
 / 
BTTEST_SECTOR_SIZE
); iSe˘‹<
nSe˘‹
; iSector++){

258 
BtTe°Se˘‹
 *
pSe˘‹
;

259 
nC›y
;

260 
iSe˘‹Off
;

262 if–
pTe°
->
≠Se˘‹
[
iSe˘‹
]==0 ){

263 
nByã
 = (
BtTe°Se˘‹
);

264 
pTe°
->
≠Se˘‹
[
iSe˘‹
] = (
BtTe°Se˘‹
*)
	`ckÆloc
(
nByã
);

265 
	`mem£t
(
pTe°
->
≠Se˘‹
[
iSe˘‹
], 0, 
nByã
);

267 
pSe˘‹
 = 
pTe°
->
≠Se˘‹
[
iSe˘‹
];

269 
iSe˘‹Off
 = (
iWrôe
 % 
BTTEST_SECTOR_SIZE
);

270 
nC›y
 = 
	`MIN
(
nRem
, (
BTTEST_SECTOR_SIZE
 - 
iSe˘‹Off
));

271 
	`mem˝y
(&
pSe˘‹
->
aBuf
[
iSe˘‹Off
], 
aRem
, 
nC›y
);

273 
nRem
 -
nC›y
;

274 
aRem
 +
nC›y
;

275 
iWrôe
 +
nC›y
;

277 if–
pSe˘‹
->
iLa°Unsyn˚d
==0 ){

278 
pSe˘‹
->
iFú°Unsyn˚d
 = 
iSe˘‹Off
;

279 
pSe˘‹
->
iLa°Unsyn˚d
 = 
nC›y
;

281 
pSe˘‹
->
iFú°Unsyn˚d
 = 
	`MIN
’Se˘‹->iFú°Unsyn˚d, 
iSe˘‹Off
);

282 
pSe˘‹
->
iLa°Unsyn˚d
 = 
	`MAX
’Se˘‹->iLa°Unsyn˚d, 
iSe˘‹Off
+
nC›y
);

285 
rc
 = 
SQLITE4_OK
;

286 }if–
	`ã°Inje˘I€º
(
pTe°
->
pTe°Env
) ){

287 
rc
 = 
SQLITE4_IOERR_WRITE
;

289 
rc
 = 
pTe°Env
->
pEnv
->
	`xWrôe
(
pTe°
->
pFûe
, 
iOff
, 
pD©a
, 
nD©a
);

291  
rc
;

292 
	}
}

294 
	$ã°BtOsTrunˇã
(

295 
bt_fûe
 *
pFûe
,

296 
i64
 
nSize


298 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

299 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

300 
rc
;

302 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

303 
rc
 = 
SQLITE4_IOERR_TRUNCATE
;

305 
rc
 = 
pEnv
->
	`xTrunˇã
(
pTe°Fûe
->
pFûe
, 
nSize
);

307  
rc
;

308 
	}
}

310 
	$ã°BtOsRód
(

311 
bt_fûe
 *
pFûe
,

312 
i64
 
iOff
,

313 *
pD©a
,

314 
nD©a


316 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

317 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

318 
rc
;

320 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

321 
rc
 = 
SQLITE4_IOERR_READ
;

323 
iSe˘‹
;

324 
u8
 *
aOut
 = (u8*)
pD©a
;

325 
nRem
 = 
nD©a
;

326 
iOff£t
 = (
iOff
 % 
BTTEST_SECTOR_SIZE
);

328 
rc
 = 
pEnv
->
	`xRód
(
pTe°Fûe
->
pFûe
, 
iOff
, 
pD©a
, 
nD©a
);

331 
iSe˘‹
=(
iOff
 / 
BTTEST_SECTOR_SIZE
); 
nRem
>0; iSector++){

332 if–(
pTe°Fûe
->
nSe˘‹
 > 
iSe˘‹
Ë&&ÖTe°Fûe->
≠Se˘‹
[iSector] ){

333 
BtTe°Se˘‹
 *
pSe˘‹
 = 
pTe°Fûe
->
≠Se˘‹
[
iSe˘‹
];

334 
iSèπ
 = 
	`MAX
(
pSe˘‹
->
iFú°Unsyn˚d
, 
iOff£t
);

335 
nC›y
 = 
	`MIN
(
BTTEST_SECTOR_SIZE
 - 
iSèπ
, 
nRem
 + 
iOff£t
 - iStart);

337 if–
nC›y
>0 ){

338 
	`mem˝y
(&
aOut
[
iOff£t
-
iSèπ
], &
pSe˘‹
->
aBuf
[iSèπ], 
nC›y
);

341 
nRem
 -(
BTTEST_SECTOR_SIZE
 - 
iOff£t
);

342 
aOut
 +(
BTTEST_SECTOR_SIZE
 - 
iOff£t
);

343 
iOff£t
 = 0;

347  
rc
;

348 
	}
}

350 
	$ã°BtOsSync
(
bt_fûe
 *
pFûe
){

351 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

352 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

353 
rc
;

356 
	`ã°CøshOrFlush
(
pTe°Fûe
);

358 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

359 
rc
 = 
SQLITE4_IOERR_FSYNC
;

361 
rc
 = 
pEnv
->
	`xSync
(
pTe°Fûe
->
pFûe
);

363  
rc
;

364 
	}
}

366 
	$ã°BtOsSe˘‹Size
(
bt_fûe
 *
pFûe
){

367 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

368 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

369 
ªs
;

371 
ªs
 = 
pEnv
->
	`xSe˘‹Size
(
pTe°Fûe
->
pFûe
);

372  
ªs
;

373 
	}
}

375 
	$ã°BtOsFuŒ∑th
(

376 
sqlôe4_ív
 *
pSqlEnv
,

377 
bt_ív
 *
pEnv
,

378 c⁄° *
zName
,

379 **
pzOut


381 
BtTe°Env
 *
p
 = (BtTe°Env*)
pEnv
;

382 
rc
;

384 if–
	`ã°Inje˘I€º
(
p
) ){

385 
rc
 = 
SQLITE4_IOERR
;

387 
rc
 = 
p
->
pEnv
->
	`xFuŒ∑th
(
pSqlEnv
,Ö->pEnv, 
zName
, 
pzOut
);

389  
rc
;

390 
	}
}

392 
	$ã°BtOsU∆ök
(

393 
sqlôe4_ív
 *
pSqlEnv
,

394 
bt_ív
 *
pEnv
,

395 c⁄° *
zFûe


397 
BtTe°Env
 *
p
 = (BtTe°Env*)
pEnv
;

398 
rc
;

400 if–
	`ã°Inje˘I€º
(
p
) ){

401 
rc
 = 
SQLITE4_IOERR_DIR_FSYNC
;

403 
rc
 = 
p
->
pEnv
->
	`xU∆ök
(
pSqlEnv
,Ö->pEnv, 
zFûe
);

405  
rc
;

406 
	}
}

408 
	$ã°BtOsLock
(
bt_fûe
 *
pFûe
, 
iLock
, 
eTy≥
){

409 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

410 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

411 
rc
;

413 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

414 
rc
 = 
SQLITE4_IOERR_LOCK
;

416 
rc
 = 
pEnv
->
	`xLock
(
pTe°Fûe
->
pFûe
, 
iLock
, 
eTy≥
);

418  
rc
;

419 
	}
}

421 
	$ã°BtOsTe°Lock
(
bt_fûe
 *
pFûe
, 
iLock
, 
nLock
, 
eTy≥
){

422 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

423 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

424 
rc
;

426 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

427 
rc
 = 
SQLITE4_IOERR
;

429 
rc
 = 
pEnv
->
	`xTe°Lock
(
pTe°Fûe
->
pFûe
, 
iLock
, 
nLock
, 
eTy≥
);

431  
rc
;

432 
	}
}

434 
	$ã°BtOsShmM≠
(
bt_fûe
 *
pFûe
, 
iChunk
, 
sz
, **
µShm
){

435 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

436 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

437 
rc
;

439 if–
	`ã°Inje˘I€º
(
pTe°Fûe
->
pTe°Env
) ){

440 
rc
 = 
SQLITE4_IOERR_SHMMAP
;

442 
rc
 = 
pEnv
->
	`xShmM≠
(
pTe°Fûe
->
pFûe
, 
iChunk
, 
sz
, 
µShm
);

444  
rc
;

445 
	}
}

447 
	$ã°BtOsShmB¨rõr
(
bt_fûe
 *
pFûe
){

448 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

449 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

451 
pEnv
->
	`xShmB¨rõr
(
pTe°Fûe
->
pFûe
);

452 
	}
}

454 
	$ã°BtOsShmUnm≠
(
bt_fûe
 *
pFûe
, 
bDñëe
){

455 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

456 
bt_ív
 *
pEnv
 = 
pTe°Fûe
->
pTe°Env
->pEnv;

457 
rc
;

459 
rc
 = 
pEnv
->
	`xShmUnm≠
(
pTe°Fûe
->
pFûe
, 
bDñëe
);

460  
rc
;

461 
	}
}

463 
	$ã°BtOsClo£
(
bt_fûe
 *
pFûe
){

464 
BtTe°Fûe
 *
pTe°Fûe
 = (BtTe°Fûe*)
pFûe
;

465 
BtTe°Env
 *
pTe°Env
 = 
pTe°Fûe
->pTestEnv;

466 
BtTe°Fûe
 **
µ
;

467 
rc
;

469 
µ
=&
pTe°Env
->
pTe°Fûe
; *µ!ıTe°Fûe;Ö∞&(*µ)->
pNext
);

470 *
µ
 = 
pTe°Fûe
->
pNext
;

472 
rc
 = 
pTe°Env
->
pEnv
->
	`xClo£
(
pTe°Fûe
->
pFûe
);

473 
	`ck‰ì
(
pTe°Fûe
);

474  
rc
;

475 
	}
}

480 
	$ã°_bãnv_dñ
(*
˘x
){

481 
BtTe°Env
 *
p
 = (BtTe°Env*)
˘x
;

482 
	`ck‰ì
(
p
);

483 
	}
}

488 
	$ã°_bãnv_cmd
(

489 * 
˛õ¡D©a
,

490 
T˛_I¡îp
 *
öãΩ
,

491 
objc
,

492 
T˛_Obj
 *
CONST
 
objv
[]

494 
BtTe°Env
 *
p
 = (BtTe°Env*)
˛õ¡D©a
;

496 
	eBãnvCmdSymbﬁ
 {

497 
BTC_ATTACH
,

498 
BTC_DELETE
,

499 
BTC_IOERR
,

500 
BTC_CRASH
,

502 
	sBãnvCmd
 {

503 c⁄° *
zO±
;

504 
eO±
;

505 
nArg
;

506 c⁄° *
zEº
;

507 } 
aCmd
[] = {

508 { "©èch", 
BTC_ATTACH
, 3, "DBCMD" },

509 { "dñëe", 
BTC_DELETE
, 2, "" },

510 { "i€º", 
BTC_IOERR
, 4, "COUNT PERSISTENT" },

511 { "¸ash", 
BTC_CRASH
, 4, "COUNT WAL" },

514 
rc
 = 
TCL_OK
;

515 
iO±
;

517 if–
objc
<2 ){

518 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "sub-command ...");

519  
TCL_ERROR
;

521 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

522 
öãΩ
, 
objv
[1], 
aCmd
, ◊Cmd[0]), "sub-comm™d", 0, &
iO±


524 if–
rc
!=
TCL_OK
 ) Ñc;

526 if–
objc
!=
aCmd
[
iO±
].
nArg
 ){

527 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, 
aCmd
[
iO±
].
zEº
);

528  
TCL_ERROR
;

531  
aCmd
[
iO±
].
eO±
 ){

532 
BTC_ATTACH
: {

533 if–
p
->
pEnv
 ){

534 
	`T˛_AµídResu…
(
öãΩ
, "object hasálready beenáttachedÅo db", 0);

535 
rc
 = 
TCL_ERROR
;

537 
sqlôe4
 *
db
 = 0;

538 
rc
 = 
	`sqlôe4Te°DbH™dÀ
(
öãΩ
, 
objv
[2], &
db
);

539 if–
rc
==
TCL_OK
 ){

540 *
pArg
 = (*)(&
p
->
pEnv
);

541 
rc
 = 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, "maö", 
BT_CONTROL_GETVFS
, 
pArg
);

542 if–
rc
==
SQLITE4_NOTFOUND
 ){

543 
	`T˛_AµídResu…
(
öãΩ
, "notá bt database", 0);

544 
rc
 = 
TCL_ERROR
;

546 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, "maö", 
BT_CONTROL_SETVFS
, (*)
p
);

553 
BTC_DELETE
: {

554 
	`T˛_DñëeComm™d
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[0]));

558 
BTC_IOERR
: {

559 
ªt
 = 
p
->
nI€ºInje˘ed
;

560 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
p
->
nI€ºC¡
)

561 || 
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[3], &
p
->
bI€ºPîsi°
)

563 
rc
 = 
TCL_ERROR
;

565 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
ªt
));

571 
BTC_CRASH
: {

572 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
p
->
nCøshC¡
)

573 || 
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[3], &
p
->
bWÆCøsh
)

575 
rc
 = 
TCL_ERROR
;

577 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
p
->
bCøshed
));

578 
p
->
bCøshed
 = 0;

584 
	`as£π
( 0 );

588  
rc
;

589 
	}
}

594 
	$ã°_bãnv
(

595 * 
˛õ¡D©a
,

596 
T˛_I¡îp
 *
öãΩ
,

597 
objc
,

598 
T˛_Obj
 *
CONST
 
objv
[]

600 
BtTe°Env
 *
p
;

601 c⁄° *
zName
;

603 if–
objc
!=2 ){

604 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "NAME");

605  
TCL_ERROR
;

607 
zName
 = 
	`T˛_GëSåög
(
objv
[1]);

609 
p
 = 
	`ckÆloc
((
BtTe°Env
));

610 
	`mem£t
(
p
, 0, (
BtTe°Env
));

612 
p
->
ba£
.
xFuŒ∑th
 = 
ã°BtOsFuŒ∑th
;

613 
p
->
ba£
.
xO≥n
 = 
ã°BtOsO≥n
;

614 
p
->
ba£
.
xSize
 = 
ã°BtOsSize
;

615 
p
->
ba£
.
xRód
 = 
ã°BtOsRód
;

616 
p
->
ba£
.
xWrôe
 = 
ã°BtOsWrôe
;

617 
p
->
ba£
.
xTrunˇã
 = 
ã°BtOsTrunˇã
;

618 
p
->
ba£
.
xSync
 = 
ã°BtOsSync
;

619 
p
->
ba£
.
xSe˘‹Size
 = 
ã°BtOsSe˘‹Size
;

620 
p
->
ba£
.
xClo£
 = 
ã°BtOsClo£
;

621 
p
->
ba£
.
xU∆ök
 = 
ã°BtOsU∆ök
;

622 
p
->
ba£
.
xLock
 = 
ã°BtOsLock
;

623 
p
->
ba£
.
xTe°Lock
 = 
ã°BtOsTe°Lock
;

624 
p
->
ba£
.
xShmM≠
 = 
ã°BtOsShmM≠
;

625 
p
->
ba£
.
xShmB¨rõr
 = 
ã°BtOsShmB¨rõr
;

626 
p
->
ba£
.
xShmUnm≠
 = 
ã°BtOsShmUnm≠
;

628 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
zName
, 
ã°_bãnv_cmd
, (*)
p
, 
ã°_bãnv_dñ
);

629 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
zName
, -1));

630  
TCL_OK
;

631 
	}
}

633 
	$Sqlôëe°Bt_Inô
(
T˛_I¡îp
 *
öãΩ
){

634 
	sSysˇŒCmd
 {

635 c⁄° *
zName
;

636 
T˛_ObjCmdProc
 *
xCmd
;

637 } 
aCmd
[] = {

638 { "bãnv", 
ã°_bãnv
 },

640 
i
;

642 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

643 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xCmd
, 0, 0);

645  
TCL_OK
;

646 
	}
}

	@test/test_config.c

20 
	~"sqlôeLimô.h
"

22 
	~"sqlôeI¡.h
"

23 
	~"t˛.h
"

24 
	~<°dlib.h
>

25 
	~<°rög.h
>

31 
	#STRINGVALUE2
(
x
Ë#x

	)

32 
	#STRINGVALUE
(
x
Ë
	`STRINGVALUE2
(x)

	)

39 
	$£t_›ti⁄s
(
T˛_I¡îp
 *
öãΩ
){

40 #ifde‡
HAVE_MALLOC_USABLE_SIZE


41 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "malloc_usable_size", "1",

42 
TCL_GLOBAL_ONLY
);

44 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "malloc_usable_size", "0",

45 
TCL_GLOBAL_ONLY
);

48 #ifde‡
SQLITE4_32BIT_ROWID


49 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "rowid32", "1", 
TCL_GLOBAL_ONLY
);

51 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "rowid32", "0", 
TCL_GLOBAL_ONLY
);

54 #ifde‡
SQLITE4_CASE_SENSITIVE_LIKE


55 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s","ˇ££nsôivñike","1",
TCL_GLOBAL_ONLY
);

57 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s","ˇ££nsôivñike","0",
TCL_GLOBAL_ONLY
);

60 #ifde‡
SQLITE4_DEBUG


61 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "debug", "1", 
TCL_GLOBAL_ONLY
);

63 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "debug", "0", 
TCL_GLOBAL_ONLY
);

66 #ifde‡
SQLITE4_DIRECT_OVERFLOW_READ


67 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "dúe˘_ªad", "1", 
TCL_GLOBAL_ONLY
);

69 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "dúe˘_ªad", "0", 
TCL_GLOBAL_ONLY
);

72 #ifde‡
SQLITE4_DISABLE_DIRSYNC


73 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "dúsync", "0", 
TCL_GLOBAL_ONLY
);

75 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "dúsync", "1", 
TCL_GLOBAL_ONLY
);

78 #ifde‡
SQLITE4_DISABLE_LFS


79 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "lfs", "0", 
TCL_GLOBAL_ONLY
);

81 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "lfs", "1", 
TCL_GLOBAL_ONLY
);

85 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "memdebug", "1", 
TCL_GLOBAL_ONLY
);

87 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "memdebug", "0", 
TCL_GLOBAL_ONLY
);

90 #ifde‡
SQLITE4_ENABLE_8_3_NAMES


91 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "8_3_«mes", "1", 
TCL_GLOBAL_ONLY
);

93 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "8_3_«mes", "0", 
TCL_GLOBAL_ONLY
);

96 #ifde‡
SQLITE4_ENABLE_MEMSYS3


97 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem3", "1", 
TCL_GLOBAL_ONLY
);

99 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem3", "0", 
TCL_GLOBAL_ONLY
);

102 #ifde‡
SQLITE4_ENABLE_MEMSYS5


103 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem5", "1", 
TCL_GLOBAL_ONLY
);

105 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem5", "0", 
TCL_GLOBAL_ONLY
);

108 #ifde‡
SQLITE4_MUTEX_OMIT


109 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "muãx", "0", 
TCL_GLOBAL_ONLY
);

111 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "muãx", "1", 
TCL_GLOBAL_ONLY
);

114 #ifde‡
SQLITE4_MUTEX_NOOP


115 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "muãx_no›", "1", 
TCL_GLOBAL_ONLY
);

117 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "muãx_no›", "0", 
TCL_GLOBAL_ONLY
);

120 #ifde‡
SQLITE4_OMIT_ALTERTABLE


121 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ÆãπabÀ", "0", 
TCL_GLOBAL_ONLY
);

123 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ÆãπabÀ", "1", 
TCL_GLOBAL_ONLY
);

126 #ifde‡
SQLITE4_OMIT_ANALYZE


127 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "™Æyze", "0", 
TCL_GLOBAL_ONLY
);

129 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "™Æyze", "1", 
TCL_GLOBAL_ONLY
);

132 #ifde‡
SQLITE4_ENABLE_ATOMIC_WRITE


133 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "©omicwrôe", "1", 
TCL_GLOBAL_ONLY
);

135 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "©omicwrôe", "0", 
TCL_GLOBAL_ONLY
);

138 #ifde‡
SQLITE4_OMIT_ATTACH


139 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "©èch", "0", 
TCL_GLOBAL_ONLY
);

141 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "©èch", "1", 
TCL_GLOBAL_ONLY
);

144 #ifde‡
SQLITE4_OMIT_AUTHORIZATION


145 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "auth", "0", 
TCL_GLOBAL_ONLY
);

147 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "auth", "1", 
TCL_GLOBAL_ONLY
);

150 #ifde‡
SQLITE4_OMIT_AUTOINCREMENT


151 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "autoöc", "0", 
TCL_GLOBAL_ONLY
);

153 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "autoöc", "1", 
TCL_GLOBAL_ONLY
);

156 #ifde‡
SQLITE4_OMIT_AUTOMATIC_INDEX


157 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "autoödex", "0", 
TCL_GLOBAL_ONLY
);

159 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "autoödex", "1", 
TCL_GLOBAL_ONLY
);

162 #ifde‡
SQLITE4_OMIT_AUTORESET


163 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "aut‹e£t", "0", 
TCL_GLOBAL_ONLY
);

165 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "aut‹e£t", "1", 
TCL_GLOBAL_ONLY
);

168 #ifde‡
SQLITE4_OMIT_AUTOVACUUM


169 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "autovacuum", "0", 
TCL_GLOBAL_ONLY
);

171 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "autovacuum", "1", 
TCL_GLOBAL_ONLY
);

173 #i‡!
	`deföed
(
SQLITE4_DEFAULT_AUTOVACUUM
)

174 
	`T˛_SëV¨2
(
öãΩ
,"sqlôe_›ti⁄s","deÁu…_autovacuum","0",
TCL_GLOBAL_ONLY
);

176 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "default_autovacuum",

177 
	`STRINGVALUE
(
SQLITE4_DEFAULT_AUTOVACUUM
), 
TCL_GLOBAL_ONLY
);

180 #ifde‡
SQLITE4_OMIT_BETWEEN_OPTIMIZATION


181 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "bëwìn_›t", "0", 
TCL_GLOBAL_ONLY
);

183 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "bëwìn_›t", "1", 
TCL_GLOBAL_ONLY
);

186 #ifde‡
SQLITE4_OMIT_BUILTIN_TEST


187 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "buûtö_ã°", "0", 
TCL_GLOBAL_ONLY
);

189 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "buûtö_ã°", "1", 
TCL_GLOBAL_ONLY
);

192 #ifde‡
SQLITE4_OMIT_BLOB_LITERAL


193 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "bloblô", "0", 
TCL_GLOBAL_ONLY
);

195 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "bloblô", "1", 
TCL_GLOBAL_ONLY
);

198 #ifde‡
SQLITE4_OMIT_CAST


199 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ˇ°", "0", 
TCL_GLOBAL_ONLY
);

201 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ˇ°", "1", 
TCL_GLOBAL_ONLY
);

204 #ifde‡
SQLITE4_OMIT_CHECK


205 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "check", "0", 
TCL_GLOBAL_ONLY
);

207 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "check", "1", 
TCL_GLOBAL_ONLY
);

210 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


211 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "cﬁumnmëad©a", "1", 
TCL_GLOBAL_ONLY
);

213 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "cﬁumnmëad©a", "0", 
TCL_GLOBAL_ONLY
);

216 #ifde‡
SQLITE4_ENABLE_OVERSIZE_CELL_CHECK


217 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "oversize_cell_check", "1",

218 
TCL_GLOBAL_ONLY
);

220 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "oversize_cell_check", "0",

221 
TCL_GLOBAL_ONLY
);

224 #ifde‡
SQLITE4_OMIT_COMPILEOPTION_DIAGS


225 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "compûe›ti⁄_dügs", "0", 
TCL_GLOBAL_ONLY
);

227 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "compûe›ti⁄_dügs", "1", 
TCL_GLOBAL_ONLY
);

230 #ifde‡
SQLITE4_OMIT_COMPLETE


231 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "com∂ëe", "0", 
TCL_GLOBAL_ONLY
);

233 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "com∂ëe", "1", 
TCL_GLOBAL_ONLY
);

236 #ifde‡
SQLITE4_OMIT_COMPOUND_SELECT


237 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "compound", "0", 
TCL_GLOBAL_ONLY
);

239 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "compound", "1", 
TCL_GLOBAL_ONLY
);

242 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "c⁄Êi˘", "1", 
TCL_GLOBAL_ONLY
);

244 #i‡
SQLITE4_OS_UNIX


245 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "¸ashã°", "1", 
TCL_GLOBAL_ONLY
);

247 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "¸ashã°", "0", 
TCL_GLOBAL_ONLY
);

250 #ifde‡
SQLITE4_OMIT_DATETIME_FUNCS


251 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "d©ëime", "0", 
TCL_GLOBAL_ONLY
);

253 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "d©ëime", "1", 
TCL_GLOBAL_ONLY
);

256 #ifde‡
SQLITE4_OMIT_DECLTYPE


257 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "de˛ty≥", "0", 
TCL_GLOBAL_ONLY
);

259 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "de˛ty≥", "1", 
TCL_GLOBAL_ONLY
);

262 #ifde‡
SQLITE4_OMIT_DEPRECATED


263 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "dïªˇãd", "0", 
TCL_GLOBAL_ONLY
);

265 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "dïªˇãd", "1", 
TCL_GLOBAL_ONLY
);

268 #ifde‡
SQLITE4_OMIT_DISKIO


269 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "diskio", "0", 
TCL_GLOBAL_ONLY
);

271 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "diskio", "1", 
TCL_GLOBAL_ONLY
);

274 #ifde‡
SQLITE4_OMIT_EXPLAIN


275 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ex∂aö", "0", 
TCL_GLOBAL_ONLY
);

277 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ex∂aö", "1", 
TCL_GLOBAL_ONLY
);

280 #ifde‡
SQLITE4_OMIT_FLOATING_POINT


281 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "Êﬂtögpoöt", "0", 
TCL_GLOBAL_ONLY
);

283 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "Êﬂtögpoöt", "1", 
TCL_GLOBAL_ONLY
);

286 #ifde‡
SQLITE4_OMIT_FOREIGN_KEY


287 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "f‹eignkey", "0", 
TCL_GLOBAL_ONLY
);

289 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "f‹eignkey", "1", 
TCL_GLOBAL_ONLY
);

292 #ifde‡
SQLITE4_ENABLE_FTS1


293 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "·s1", "1", 
TCL_GLOBAL_ONLY
);

295 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "·s1", "0", 
TCL_GLOBAL_ONLY
);

298 #ifde‡
SQLITE4_ENABLE_FTS2


299 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "·s2", "1", 
TCL_GLOBAL_ONLY
);

301 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "·s2", "0", 
TCL_GLOBAL_ONLY
);

304 #ifde‡
SQLITE4_ENABLE_FTS3


305 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "·s3", "1", 
TCL_GLOBAL_ONLY
);

307 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "·s3", "0", 
TCL_GLOBAL_ONLY
);

310 #ifde‡
SQLITE4_OMIT_GET_TABLE


311 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "gëèbÀ", "0", 
TCL_GLOBAL_ONLY
);

313 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "gëèbÀ", "1", 
TCL_GLOBAL_ONLY
);

316 #ifde‡
SQLITE4_ENABLE_ICU


317 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "icu", "1", 
TCL_GLOBAL_ONLY
);

319 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "icu", "0", 
TCL_GLOBAL_ONLY
);

322 #ifde‡
SQLITE4_OMIT_INTEGRITY_CHECK


323 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "öãgrôyck", "0", 
TCL_GLOBAL_ONLY
);

325 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "öãgrôyck", "1", 
TCL_GLOBAL_ONLY
);

328 #ifde‡
SQLITE4_OMIT_LIKE_OPTIMIZATION


329 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "like_›t", "0", 
TCL_GLOBAL_ONLY
);

331 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "like_›t", "1", 
TCL_GLOBAL_ONLY
);

334 #ifde‡
SQLITE4_OMIT_LOAD_EXTENSION


335 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "lﬂd_ext", "0", 
TCL_GLOBAL_ONLY
);

337 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "lﬂd_ext", "1", 
TCL_GLOBAL_ONLY
);

340 #ifde‡
SQLITE4_OMIT_LOCALTIME


341 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "loˇ…ime", "0", 
TCL_GLOBAL_ONLY
);

343 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "loˇ…ime", "1", 
TCL_GLOBAL_ONLY
);

346 #ifde‡
SQLITE4_OMIT_LOOKASIDE


347 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "lookaside", "0", 
TCL_GLOBAL_ONLY
);

349 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "lookaside", "1", 
TCL_GLOBAL_ONLY
);

352 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "long_double",

353 (
LONGDOUBLE_TYPE
)>() ? "1" : "0",

354 
TCL_GLOBAL_ONLY
);

356 #ifde‡
SQLITE4_OMIT_MEMORYDB


357 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem‹ydb", "0", 
TCL_GLOBAL_ONLY
);

359 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem‹ydb", "1", 
TCL_GLOBAL_ONLY
);

362 #ifde‡
SQLITE4_ENABLE_MEMORY_MANAGEMENT


363 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem‹ym™age", "1", 
TCL_GLOBAL_ONLY
);

365 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mem‹ym™age", "0", 
TCL_GLOBAL_ONLY
);

368 #ifde‡
SQLITE4_OMIT_OR_OPTIMIZATION


369 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "‹_›t", "0", 
TCL_GLOBAL_ONLY
);

371 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "‹_›t", "1", 
TCL_GLOBAL_ONLY
);

374 #ifde‡
SQLITE4_OMIT_PAGER_PRAGMAS


375 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "∑gî_¥agmas", "0", 
TCL_GLOBAL_ONLY
);

377 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "∑gî_¥agmas", "1", 
TCL_GLOBAL_ONLY
);

380 #i‡
	`deföed
(
SQLITE4_OMIT_PRAGMA
Ë|| deföed(
SQLITE4_OMIT_FLAG_PRAGMAS
)

381 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "¥agma", "0", 
TCL_GLOBAL_ONLY
);

382 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "öãgrôyck", "0", 
TCL_GLOBAL_ONLY
);

384 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "¥agma", "1", 
TCL_GLOBAL_ONLY
);

387 #ifde‡
SQLITE4_OMIT_PROGRESS_CALLBACK


388 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "¥ogªss", "0", 
TCL_GLOBAL_ONLY
);

390 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "¥ogªss", "1", 
TCL_GLOBAL_ONLY
);

393 #ifde‡
SQLITE4_OMIT_REINDEX


394 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ªödex", "0", 
TCL_GLOBAL_ONLY
);

396 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ªödex", "1", 
TCL_GLOBAL_ONLY
);

399 #ifde‡
SQLITE4_ENABLE_RTREE


400 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "πªe", "1", 
TCL_GLOBAL_ONLY
);

402 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "πªe", "0", 
TCL_GLOBAL_ONLY
);

405 #ifde‡
SQLITE4_OMIT_SCHEMA_PRAGMAS


406 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "schema_¥agmas", "0", 
TCL_GLOBAL_ONLY
);

408 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "schema_¥agmas", "1", 
TCL_GLOBAL_ONLY
);

411 #ifde‡
SQLITE4_OMIT_SCHEMA_VERSION_PRAGMAS


412 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "schema_vîsi⁄", "0", 
TCL_GLOBAL_ONLY
);

414 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "schema_vîsi⁄", "1", 
TCL_GLOBAL_ONLY
);

417 #ifde‡
SQLITE4_ENABLE_STAT3


418 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "°©3", "1", 
TCL_GLOBAL_ONLY
);

420 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "°©3", "0", 
TCL_GLOBAL_ONLY
);

423 #i‡!
	`deföed
(
SQLITE4_ENABLE_LOCKING_STYLE
)

424 #i‡
	`deföed
(
__APPLE__
)

425 
	#SQLITE4_ENABLE_LOCKING_STYLE
 1

	)

427 
	#SQLITE4_ENABLE_LOCKING_STYLE
 0

	)

430 #i‡
SQLITE4_ENABLE_LOCKING_STYLE
 && 
	`deföed
(
__APPLE__
)

431 
	`T˛_SëV¨2
(
öãΩ
,"sqlôe_›ti⁄s","lock_¥oxy_¥agmas","1",
TCL_GLOBAL_ONLY
);

433 
	`T˛_SëV¨2
(
öãΩ
,"sqlôe_›ti⁄s","lock_¥oxy_¥agmas","0",
TCL_GLOBAL_ONLY
);

435 #i‡
	`deföed
(
SQLITE4_PREFER_PROXY_LOCKING
Ë&& deföed(
__APPLE__
)

436 
	`T˛_SëV¨2
(
öãΩ
,"sqlôe_›ti⁄s","¥e„r_¥oxy_lockög","1",
TCL_GLOBAL_ONLY
);

438 
	`T˛_SëV¨2
(
öãΩ
,"sqlôe_›ti⁄s","¥e„r_¥oxy_lockög","0",
TCL_GLOBAL_ONLY
);

442 #ifde‡
SQLITE4_OMIT_SUBQUERY


443 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "subquîy", "0", 
TCL_GLOBAL_ONLY
);

445 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "subquîy", "1", 
TCL_GLOBAL_ONLY
);

448 #ifde‡
SQLITE4_OMIT_TCL_VARIABLE


449 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "t˛v¨", "0", 
TCL_GLOBAL_ONLY
);

451 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "t˛v¨", "1", 
TCL_GLOBAL_ONLY
);

454 
	`T˛_SëV¨2
(
öãΩ
, "sqlite_options", "threadsafe",

455 
	`STRINGVALUE
(
SQLITE4_THREADSAFE
), 
TCL_GLOBAL_ONLY
);

457 #ifde‡
SQLITE4_OMIT_TEMPDB


458 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ãmpdb", "0", 
TCL_GLOBAL_ONLY
);

460 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "ãmpdb", "1", 
TCL_GLOBAL_ONLY
);

463 #ifde‡
SQLITE4_OMIT_TRACE


464 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "åa˚", "0", 
TCL_GLOBAL_ONLY
);

466 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "åa˚", "1", 
TCL_GLOBAL_ONLY
);

469 #ifde‡
SQLITE4_OMIT_TRIGGER


470 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "åiggî", "0", 
TCL_GLOBAL_ONLY
);

472 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "åiggî", "1", 
TCL_GLOBAL_ONLY
);

475 #ifde‡
SQLITE4_OMIT_TRUNCATE_OPTIMIZATION


476 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "åunˇã_›t", "0", 
TCL_GLOBAL_ONLY
);

478 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "åunˇã_›t", "1", 
TCL_GLOBAL_ONLY
);

481 #ifde‡
SQLITE4_OMIT_UTF16


482 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "utf16", "0", 
TCL_GLOBAL_ONLY
);

484 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "utf16", "1", 
TCL_GLOBAL_ONLY
);

487 #i‡
	`deföed
(
SQLITE4_OMIT_VACUUM
Ë|| deföed(
SQLITE4_OMIT_ATTACH
)

488 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "vacuum", "0", 
TCL_GLOBAL_ONLY
);

490 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "vacuum", "1", 
TCL_GLOBAL_ONLY
);

493 #ifde‡
SQLITE4_OMIT_VIEW


494 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "võw", "0", 
TCL_GLOBAL_ONLY
);

496 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "võw", "1", 
TCL_GLOBAL_ONLY
);

499 #ifde‡
SQLITE4_OMIT_VIRTUALTABLE


500 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "vèb", "0", 
TCL_GLOBAL_ONLY
);

502 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "vèb", "1", 
TCL_GLOBAL_ONLY
);

505 #ifde‡
SQLITE4_OMIT_WAL


506 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "wÆ", "0", 
TCL_GLOBAL_ONLY
);

508 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "wÆ", "1", 
TCL_GLOBAL_ONLY
);

511 #ifde‡
SQLITE4_OMIT_WSD


512 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "wsd", "0", 
TCL_GLOBAL_ONLY
);

514 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "wsd", "1", 
TCL_GLOBAL_ONLY
);

517 #i‡
	`deföed
(
SQLITE4_ENABLE_UPDATE_DELETE_LIMIT
Ë&& !deföed(
SQLITE4_OMIT_SUBQUERY
)

518 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "upd©e_dñëe_limô", "1", 
TCL_GLOBAL_ONLY
);

520 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "upd©e_dñëe_limô", "0", 
TCL_GLOBAL_ONLY
);

523 #i‡
	`deföed
(
SQLITE4_ENABLE_UNLOCK_NOTIFY
)

524 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "u∆ock_nŸify", "1", 
TCL_GLOBAL_ONLY
);

526 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "u∆ock_nŸify", "0", 
TCL_GLOBAL_ONLY
);

529 #ifde‡
SQLITE4_SECURE_DELETE


530 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "£cuª_dñëe", "1", 
TCL_GLOBAL_ONLY
);

532 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "£cuª_dñëe", "0", 
TCL_GLOBAL_ONLY
);

535 #ifde‡
SQLITE4_MULTIPLEX_EXT_OVWR


536 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mu…ùÀx_ext_ovîwrôe", "1", 
TCL_GLOBAL_ONLY
);

538 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "mu…ùÀx_ext_ovîwrôe", "0", 
TCL_GLOBAL_ONLY
);

541 #ifde‡
YYTRACKMAXSTACKDEPTH


542 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "yyåackmax°ackdïth", "1", 
TCL_GLOBAL_ONLY
);

544 
	`T˛_SëV¨2
(
öãΩ
, "sqlôe_›ti⁄s", "yyåackmax°ackdïth", "0", 
TCL_GLOBAL_ONLY
);

547 
	#LINKVAR
(
x
) { \

548 c⁄° 
cv_
 ## 
x
 = 
SQLITE4_
 ## x; \

549 
	`T˛_LökV¨
(
öãΩ
, "SQLITE4_" #x, (*)&(
cv_
 ## 
x
), \

550 
TCL_LINK_INT
 | 
TCL_LINK_READ_ONLY
); }

	)

552 
	`LINKVAR
–
MAX_LENGTH
 );

553 
	`LINKVAR
–
MAX_COLUMN
 );

554 
	`LINKVAR
–
MAX_SQL_LENGTH
 );

555 
	`LINKVAR
–
MAX_EXPR_DEPTH
 );

556 
	`LINKVAR
–
MAX_COMPOUND_SELECT
 );

557 
	`LINKVAR
–
MAX_VDBE_OP
 );

558 
	`LINKVAR
–
MAX_FUNCTION_ARG
 );

559 
	`LINKVAR
–
MAX_VARIABLE_NUMBER
 );

560 
	`LINKVAR
–
MAX_PAGE_SIZE
 );

561 
	`LINKVAR
–
MAX_PAGE_COUNT
 );

562 
	`LINKVAR
–
MAX_LIKE_PATTERN_LENGTH
 );

563 
	`LINKVAR
–
MAX_TRIGGER_DEPTH
 );

564 
	`LINKVAR
–
DEFAULT_TEMP_CACHE_SIZE
 );

565 
	`LINKVAR
–
DEFAULT_CACHE_SIZE
 );

566 
	`LINKVAR
–
DEFAULT_PAGE_SIZE
 );

567 
	`LINKVAR
–
MAX_ATTACHED
 );

568 
	`LINKVAR
–
MAX_DEFAULT_PAGE_SIZE
 );

571 c⁄° 
cv_TEMP_STORE
 = 
SQLITE4_TEMP_STORE
;

572 
	`T˛_LökV¨
(
öãΩ
, "TEMP_STORE", (*)&(
cv_TEMP_STORE
),

573 
TCL_LINK_INT
 | 
TCL_LINK_READ_ONLY
);

575 
	}
}

581 
	$Sqlôec⁄fig_Inô
(
T˛_I¡îp
 *
öãΩ
){

582 
	`£t_›ti⁄s
(
öãΩ
);

583  
TCL_OK
;

584 
	}
}

	@test/test_func.c

15 
	~"sqlôe4.h
"

16 
	~"t˛.h
"

17 
	~<°dlib.h
>

18 
	~<°rög.h
>

19 
	~<as£π.h
>

27 *
	$ã°C⁄ãxtMÆloc
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
nByã
){

28 *
z
 = 
	`sqlôe4_mÆloc
(
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
), 
nByã
);

29 if–!
z
 && 
nByã
>0 ){

30 
	`sqlôe4_ªsu…_îr‹_nomem
(
c⁄ãxt
);

32  
z
;

33 
	}
}

39 
	$øndSå
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

40 c⁄° 
zSrc
[] =

45 
iMö
, 
iMax
, 
n
, 
r
, 
i
;

46 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
);

47 
zBuf
[1000];

52 
	`as£π
(
¨gc
==2);

54 
iMö
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[0]);

55 if–
iMö
<0 ) iMin = 0;

56 if–
iMö
>=(
zBuf
) ) iMin = (zBuf)-1;

57 
iMax
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[1]);

58 if–
iMax
<
iMö
 ) iMax = iMin;

59 if–
iMax
>=(
zBuf
) ) iMax = (zBuf)-1;

60 
n
 = 
iMö
;

61 if–
iMax
>
iMö
 ){

62 
	`sqlôe4_øndom√ss
(
pEnv
, (
r
), &r);

63 
r
 &= 0x7fffffff;

64 
n
 +
r
%(
iMax
 + 1 - 
iMö
);

66 
	`as£π
–
n
<(
zBuf
) );

67 
	`sqlôe4_øndom√ss
(
pEnv
, 
n
, 
zBuf
);

68 
i
=0; i<
n
; i++){

69 
zBuf
[
i
] = 
zSrc
[zBuf[i]%((zSrc)-1)];

71 
zBuf
[
n
] = 0;

72 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, (*)
zBuf
, 
n
, 
SQLITE4_TRANSIENT
, 0);

73 
	}
}

86 
	gã°_de°ru˘‹_cou¡_v¨
 = 0;

87 
	$de°ru˘‹
(*
pNŸU£d
, *
p
){

88 *
zVÆ
 = (*)
p
;

89 
	`as£π
(
zVÆ
);

90 
zVÆ
--;

91 
	`sqlôe4_‰ì
(0, 
zVÆ
);

92 
ã°_de°ru˘‹_cou¡_v¨
--;

93 
	}
}

94 
	$ã°_de°ru˘‹
(

95 
sqlôe4_c⁄ãxt
 *
pCtx
,

96 
nArg
,

97 
sqlôe4_vÆue
 **
¨gv


99 *
zVÆ
;

100 c⁄° *
zText
;

101 
nText
;

103 
ã°_de°ru˘‹_cou¡_v¨
++;

104 
	`as£π
–
nArg
==1 );

105 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ) ;

106 
zText
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
nText
);

107 
zVÆ
 = 
	`ã°C⁄ãxtMÆloc
(
pCtx
, 
nText
+3);

108 if–!
zVÆ
 ){

111 
zVÆ
[
nText
+1] = 0;

112 
zVÆ
[
nText
+2] = 0;

113 
zVÆ
++;

114 
	`mem˝y
(
zVÆ
, 
zText
, 
nText
);

115 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
zVÆ
, -1, 
de°ru˘‹
, 0);

116 
	}
}

117 #i‚de‡
SQLITE4_OMIT_UTF16


118 
	$ã°_de°ru˘‹16
(

119 
sqlôe4_c⁄ãxt
 *
pCtx
,

120 
nArg
,

121 
sqlôe4_vÆue
 **
¨gv


123 *
zVÆ
;

124 c⁄° *
pText
;

125 
nText
;

127 
ã°_de°ru˘‹_cou¡_v¨
++;

128 
	`as£π
–
nArg
==1 );

129 if–
	`sqlôe4_vÆue_ty≥
(
¨gv
[0])==
SQLITE4_NULL
 ) ;

130 
pText
 = 
	`sqlôe4_vÆue_ãxt16
(
¨gv
[0], &
nText
);

131 
zVÆ
 = 
	`ã°C⁄ãxtMÆloc
(
pCtx
, 
nText
+3);

132 if–!
zVÆ
 ){

135 
zVÆ
[
nText
+1] = 0;

136 
zVÆ
[
nText
+2] = 0;

137 
zVÆ
++;

138 
	`mem˝y
(
zVÆ
, 
pText
, 
nText
);

139 
	`sqlôe4_ªsu…_ãxt16
(
pCtx
, 
zVÆ
, -1, 
de°ru˘‹
, 0);

140 
	}
}

142 
	$ã°_de°ru˘‹_cou¡
(

143 
sqlôe4_c⁄ãxt
 *
pCtx
,

144 
nArg
,

145 
sqlôe4_vÆue
 **
¨gv


147 
	`sqlôe4_ªsu…_öt
(
pCtx
, 
ã°_de°ru˘‹_cou¡_v¨
);

148 
	}
}

155 #i‚de‡
SQLITE4_OMIT_BUILTIN_TEST


156 
sqlôe4BegöBíignMÆloc
();

157 
sqlôe4EndBíignMÆloc
();

159 
	#sqlôe4BegöBíignMÆloc
()

	)

160 
	#sqlôe4EndBíignMÆloc
()

	)

174 
	$‰ì_ã°_auxd©a
(*
pEnv
, *
p
){

175 
	`sqlôe4_‰ì
((
sqlôe4_ív
*)
pEnv
, 
p
);

176 
	}
}

177 
	$ã°_auxd©a
(

178 
sqlôe4_c⁄ãxt
 *
pCtx
,

179 
nArg
,

180 
sqlôe4_vÆue
 **
¨gv


182 
i
;

183 *
zRë
 = 
	`ã°C⁄ãxtMÆloc
(
pCtx
, 
nArg
*2);

184 if–!
zRë
 ) ;

185 
	`mem£t
(
zRë
, 0, 
nArg
*2);

186 
i
=0; i<
nArg
; i++){

187 c⁄° *
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], 0);

188 if–
z
 ){

189 
n
;

190 *
zAux
 = 
	`sqlôe4_auxd©a_„tch
(
pCtx
, 
i
);

191 if–
zAux
 ){

192 
zRë
[
i
*2] = '1';

193 
	`as£π
–
	`°rcmp
(
zAux
,
z
)==0 );

195 
zRë
[
i
*2] = '0';

197 
n
 = 
	`°æí
(
z
) + 1;

198 
zAux
 = 
	`ã°C⁄ãxtMÆloc
(
pCtx
, 
n
);

199 if–
zAux
 ){

200 
	`mem˝y
(
zAux
, 
z
, 
n
);

201 
	`sqlôe4_auxd©a_°‹e
(
pCtx
, 
i
, 
zAux
,

202 
‰ì_ã°_auxd©a
, 
	`sqlôe4_c⁄ãxt_ív
(
pCtx
));

204 
zRë
[
i
*2+1] = ' ';

207 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
zRë
, 2*
nArg
-1,

208 
‰ì_ã°_auxd©a
, 
	`sqlôe4_c⁄ãxt_ív
(
pCtx
));

209 
	}
}

216 
	$ã°_îr‹
(

217 
sqlôe4_c⁄ãxt
 *
pCtx
,

218 
nArg
,

219 
sqlôe4_vÆue
 **
¨gv


221 
	`sqlôe4_ªsu…_îr‹
(
pCtx
, 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0), -1);

222 if–
nArg
==2 ){

223 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
	`sqlôe4_vÆue_öt
(
¨gv
[1]));

225 
	}
}

229 
	scou¡îObje˘
 { 
	m˙t
; 
sqlôe4_ív
 *
	mpEnv
; };

230 
	$cou¡îFªe
(*
NŸU£d
, *
x
){

231 
cou¡îObje˘
 *
p
 = (cou¡îObje˘*)
x
;

232 
	`sqlôe4_‰ì
(
p
->
pEnv
,Ö);

233 
	}
}

241 
	$cou¡îFunc
(

242 
sqlôe4_c⁄ãxt
 *
pCtx
,

243 
nArg
,

244 
sqlôe4_vÆue
 **
¨gv


246 
cou¡îObje˘
 *
pCou¡î
;

247 
pCou¡î
 = (
cou¡îObje˘
*)
	`sqlôe4_auxd©a_„tch
(
pCtx
, 0);

248 if–
pCou¡î
==0 ){

249 
pCou¡î
 = 
	`sqlôe4_mÆloc
(
	`sqlôe4_c⁄ãxt_ív
(
pCtx
), (*pCounter) );

250 if–
pCou¡î
==0 ){

251 
	`sqlôe4_ªsu…_îr‹_nomem
(
pCtx
);

254 
pCou¡î
->
˙t
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[0]);

255 
pCou¡î
->
pEnv
 = 
	`sqlôe4_c⁄ãxt_ív
(
pCtx
);

256 
	`sqlôe4_auxd©a_°‹e
(
pCtx
, 0, 
pCou¡î
, 
cou¡îFªe
, 0);

258 
pCou¡î
->
˙t
++;

260 
	`sqlôe4_ªsu…_öt
(
pCtx
, 
pCou¡î
->
˙t
);

261 
	}
}

276 
	$ã°_isﬁ©i⁄
(

277 
sqlôe4_c⁄ãxt
 *
pCtx
,

278 
nArg
,

279 
sqlôe4_vÆue
 **
¨gv


281 #i‚de‡
SQLITE4_OMIT_UTF16


282 
	`sqlôe4_vÆue_ãxt16
(
¨gv
[0], 0);

283 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

284 
	`sqlôe4_vÆue_ãxt16
(
¨gv
[0], 0);

285 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

287 
	`sqlôe4_ªsu…_vÆue
(
pCtx
, 
¨gv
[1]);

288 
	}
}

294 
	$ã°_evÆ
(

295 
sqlôe4_c⁄ãxt
 *
pCtx
,

296 
nArg
,

297 
sqlôe4_vÆue
 **
¨gv


299 
sqlôe4_°mt
 *
pStmt
;

300 
rc
;

301 
sqlôe4
 *
db
 = 
	`sqlôe4_c⁄ãxt_db_h™dÀ
(
pCtx
);

302 c⁄° *
zSql
;

304 
zSql
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

305 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, -1, &
pStmt
, 0);

306 if–
rc
==
SQLITE4_OK
 ){

307 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

308 if–
rc
==
SQLITE4_ROW
 ){

309 
	`sqlôe4_ªsu…_vÆue
(
pCtx
, 
	`sqlôe4_cﬁumn_vÆue
(
pStmt
, 0));

311 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

313 if–
rc
 ){

314 *
zEº
;

315 
sqlôe4_ív
 *
pEnv
 = 
	`sqlôe4_c⁄ãxt_ív
(
pCtx
);

316 
	`as£π
–
pStmt
==0 );

317 
zEº
 = 
	`sqlôe4_m¥ötf
(
pEnv
, "sqlite4_prepare()Érror: %s",

318 
	`sqlôe4_îrmsg
(
db
));

319 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
zEº
, -1, 
SQLITE4_DYNAMIC
, 0);

320 
	`sqlôe4_ªsu…_îr‹_code
(
pCtx
, 
rc
);

322 
	}
}

328 
	$ã°HexCh¨
(
c
){

329 if–
c
>='0' && c<='9' ){

330  
c
 - '0';

331 }if–
c
>='a' && c<='f' ){

332  
c
 - 'a' + 10;

333 }if–
c
>='A' && c<='F' ){

334  
c
 - 'A' + 10;

337 
	}
}

342 
	$ã°HexToBö
(c⁄° *
zIn
, *
zOut
){

343  
zIn
[0] && zIn[1] ){

344 *(
zOut
++Ë(
	`ã°HexCh¨
(
zIn
[0])<<4) +ÅestHexChar(zIn[1]);

345 
zIn
 += 2;

347 
	}
}

355 #i‚de‡
SQLITE4_OMIT_UTF16


356 
	$ã°HexToUtf16be
(

357 
sqlôe4_c⁄ãxt
 *
pCtx
,

358 
nArg
,

359 
sqlôe4_vÆue
 **
¨gv


361 
n
;

362 c⁄° *
zIn
;

363 *
zOut
;

364 
	`as£π
–
nArg
==1 );

365 
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
n
);

366 
zOut
 = 
	`sqlôe4_mÆloc
(
	`sqlôe4_c⁄ãxt_ív
(
pCtx
), 
n
/2 );

367 if–
zOut
==0 ){

368 
	`sqlôe4_ªsu…_îr‹_nomem
(
pCtx
);

370 
	`ã°HexToBö
(
zIn
, 
zOut
);

371 
	`sqlôe4_ªsu…_ãxt16be
(
pCtx
, 
zOut
, 
n
/2, 
SQLITE4_DYNAMIC
, 0);

373 
	}
}

382 
	$ã°HexToUtf8
(

383 
sqlôe4_c⁄ãxt
 *
pCtx
,

384 
nArg
,

385 
sqlôe4_vÆue
 **
¨gv


387 
n
;

388 c⁄° *
zIn
;

389 *
zOut
;

390 
	`as£π
–
nArg
==1 );

391 
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
n
);

392 
zOut
 = 
	`sqlôe4_mÆloc
(
	`sqlôe4_c⁄ãxt_ív
(
pCtx
), 
n
/2 );

393 if–
zOut
==0 ){

394 
	`sqlôe4_ªsu…_îr‹_nomem
(
pCtx
);

396 
	`ã°HexToBö
(
zIn
, 
zOut
);

397 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
zOut
, 
n
/2, 
SQLITE4_DYNAMIC
, 0);

399 
	}
}

407 #i‚de‡
SQLITE4_OMIT_UTF16


408 
	$ã°HexToUtf16À
(

409 
sqlôe4_c⁄ãxt
 *
pCtx
,

410 
nArg
,

411 
sqlôe4_vÆue
 **
¨gv


413 
n
;

414 c⁄° *
zIn
;

415 *
zOut
;

416 
	`as£π
–
nArg
==1 );

417 
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
n
);

418 
zOut
 = 
	`sqlôe4_mÆloc
(
	`sqlôe4_c⁄ãxt_ív
(
pCtx
), 
n
/2 );

419 if–
zOut
==0 ){

420 
	`sqlôe4_ªsu…_îr‹_nomem
(
pCtx
);

422 
	`ã°HexToBö
(
zIn
, 
zOut
);

423 
	`sqlôe4_ªsu…_ãxt16À
(
pCtx
, 
zOut
, 
n
/2, 
SQLITE4_DYNAMIC
, 0);

425 
	}
}

428 
	$ªgi°îTe°Fun˘i⁄s
(
sqlôe4
 *
db
){

430 *
zName
;

431 sig√d 
nArg
;

432 
eTextRï
;

433 (*
xFunc
)(
sqlôe4_c⁄ãxt
*,,
sqlôe4_vÆue
 **);

434 } 
aFuncs
[] = {

435 { "ønd°r", 2, 
SQLITE4_UTF8
, 
øndSå
 },

436 { "ã°_de°ru˘‹", 1, 
SQLITE4_UTF8
, 
ã°_de°ru˘‹
},

437 #i‚de‡
SQLITE4_OMIT_UTF16


438 { "ã°_de°ru˘‹16", 1, 
SQLITE4_UTF8
, 
ã°_de°ru˘‹16
},

439 { "hex_to_utf16be", 1, 
SQLITE4_UTF8
, 
ã°HexToUtf16be
},

440 { "hex_to_utf16À", 1, 
SQLITE4_UTF8
, 
ã°HexToUtf16À
},

442 { "hex_to_utf8", 1, 
SQLITE4_UTF8
, 
ã°HexToUtf8
},

443 { "ã°_de°ru˘‹_cou¡", 0, 
SQLITE4_UTF8
, 
ã°_de°ru˘‹_cou¡
},

444 { "ã°_auxd©a", -1, 
SQLITE4_UTF8
, 
ã°_auxd©a
},

445 { "ã°_îr‹", 1, 
SQLITE4_UTF8
, 
ã°_îr‹
},

446 { "ã°_îr‹", 2, 
SQLITE4_UTF8
, 
ã°_îr‹
},

447 { "ã°_evÆ", 1, 
SQLITE4_UTF8
, 
ã°_evÆ
},

448 { "ã°_isﬁ©i⁄", 2, 
SQLITE4_UTF8
, 
ã°_isﬁ©i⁄
},

449 { "ã°_cou¡î", 1, 
SQLITE4_UTF8
, 
cou¡îFunc
},

451 
i
;

453 
i
=0; i<(
aFuncs
)/(aFuncs[0]); i++){

454 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
aFuncs
[
i
].
zName
,áFuncs[i].
nArg
,

455 0, 
aFuncs
[
i
].
xFunc
, 0, 0, 0);

458  
SQLITE4_OK
;

459 
	}
}

464 
	$tSãp
(
sqlôe4_c⁄ãxt
 *
a
, 
b
, 
sqlôe4_vÆue
 **
c
){
	}
}

465 
	$tFöÆ
(
sqlôe4_c⁄ãxt
 *
a
){
	}
}

474 
	$abu£_¸óã_fun˘i⁄
(

475 * 
˛õ¡D©a
,

476 
T˛_I¡îp
 *
öãΩ
,

477 
objc
,

478 
T˛_Obj
 *
CONST
 
objv
[]

480 
	`gëDbPoöãr
(
T˛_I¡îp
*, c⁄° *, 
sqlôe4
**);

481 
sqlôe4
 *
db
;

482 
rc
;

483 
mxArg
;

485 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

487 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(

488 
db
, "tx", 1, 0, 
tSãp
,ÅSãp, 
tFöÆ
, 0);

489 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

491 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tx", 1, 0, 
tSãp
,ÅStep, 0,0);

492 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

494 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tx", 1, 0, 
tSãp
, 0,
tFöÆ
,0);

495 if–
rc
!=
SQLITE4_MISUSE
Ë
abu£_îr
;

497 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tx", 1, 0, 0, 0, 
tFöÆ
, 0);

498 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

500 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tx", 1, 0, 0, 
tSãp
, 0, 0);

501 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

503 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tx", -2, 0, 
tSãp
, 0, 0, 0);

504 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

506 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tx", 128, 0, 
tSãp
, 0, 0, 0);

507 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

509 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "funcxx"

515 1, 0, 
tSãp
, 0, 0, 0);

516 if–
rc
!=
SQLITE4_MISUSE
 ) 
abu£_îr
;

522 
	`sqlôe4_limô
(
db
, 
SQLITE4_LIMIT_FUNCTION_ARG
, 10000);

523 
mxArg
 = 
	`sqlôe4_limô
(
db
, 
SQLITE4_LIMIT_FUNCTION_ARG
, -1);

524 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "nullx"

530 
mxArg
, 0, 
tSãp
, 0, 0, 0);

531 if–
rc
!=
SQLITE4_OK
 ) 
abu£_îr
;

533  
TCL_OK
;

535 
abu£_îr
:

536 
	`T˛_AµídResu…
(
öãΩ
, "sqlite4_create_functionábusedÅest failed",

538  
TCL_ERROR
;

539 
	}
}

544 
	$Sqlôëe°_func_Inô
(
T˛_I¡îp
 *
öãΩ
){

546 *
zName
;

547 
T˛_ObjCmdProc
 *
xProc
;

548 } 
aObjCmd
[] = {

549 { "abu£_¸óã_fun˘i⁄", 
abu£_¸óã_fun˘i⁄
 },

551 
i
;

553 
i
=0; i<(
aObjCmd
)/(aObjCmd[0]); i++){

554 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aObjCmd
[
i
].
zName
,áObjCmd[i].
xProc
, 0, 0);

556  
TCL_OK
;

557 
	}
}

559 
	$sqlôe4ã°_ö°Æl_ã°_fun˘i⁄s
(
sqlôe4
 *
db
){

560 
rc
;

561 
	`Md5_Regi°î
(
sqlôe4
*);

563 
rc
 = 
	`ªgi°îTe°Fun˘i⁄s
(
db
);

564 if–
rc
==
SQLITE4_OK
 ){

565 
rc
 = 
	`Md5_Regi°î
(
db
);

567  
rc
;

568 
	}
}

	@test/test_hexio.c

20 
	~"sqlôeI¡.h
"

21 
	~"t˛.h
"

22 
	~<°dlib.h
>

23 
	~<°rög.h
>

24 
	~<as£π.h
>

32 
	$sqlôe4Te°BöToHex
(*
zBuf
, 
N
){

33 c⁄° 
zHex
[] = "0123456789ABCDEF";

34 
i
, 
j
;

35 
c
;

36 
i
 = 
N
*2;

37 
zBuf
[
i
--] = 0;

38 
j
=
N
-1; j>=0; j--){

39 
c
 = 
zBuf
[
j
];

40 
zBuf
[
i
--] = 
zHex
[
c
&0xf];

41 
zBuf
[
i
--] = 
zHex
[
c
>>4];

43 
	`as£π
–
i
==-1 );

44 
	}
}

52 
	$sqlôe4Te°HexToBö
(c⁄° *
zIn
, 
N
, *
aOut
){

53 c⁄° 
aM≠
[] = {

71 
i
, 
j
;

72 
hi
=1;

73 
c
;

75 
i
=
j
=0; i<
N
; i++){

76 
c
 = 
aM≠
[
zIn
[
i
]];

77 if–
c
==0 ) ;

78 if–
hi
 ){

79 
aOut
[
j
] = (
c
-1)<<4;

80 
hi
 = 0;

82 
aOut
[
j
++] |
c
-1;

83 
hi
 = 1;

86  
j
;

87 
	}
}

97 
	$hexio_ªad
(

98 * 
˛õ¡D©a
,

99 
T˛_I¡îp
 *
öãΩ
,

100 
objc
,

101 
T˛_Obj
 *
CONST
 
objv
[]

103 
off£t
;

104 
amt
, 
gŸ
;

105 c⁄° *
zFûe
;

106 *
zBuf
;

107 
FILE
 *
ö
;

109 if–
objc
!=4 ){

110 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "FILENAME OFFSET AMT");

111  
TCL_ERROR
;

113 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
off£t
ËË 
TCL_ERROR
;

114 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
amt
ËË 
TCL_ERROR
;

115 
zFûe
 = 
	`T˛_GëSåög
(
objv
[1]);

116 
zBuf
 = 
	`sqlôe4_mÆloc
(0, 
amt
*2+1 );

117 if–
zBuf
==0 ){

118  
TCL_ERROR
;

120 
ö
 = 
	`f›í
(
zFûe
, "rb");

121 if–
ö
==0 ){

122 
ö
 = 
	`f›í
(
zFûe
, "r");

124 if–
ö
==0 ){

125 
	`T˛_AµídResu…
(
öãΩ
, "ˇ¬Ÿ o≥¿öpuàfûê", 
zFûe
, 0);

126  
TCL_ERROR
;

128 
	`f£ek
(
ö
, 
off£t
, 
SEEK_SET
);

129 
gŸ
 = 
	`‰ód
(
zBuf
, 1, 
amt
, 
ö
);

130 
	`f˛o£
(
ö
);

131 if–
gŸ
<0 ){

132 
gŸ
 = 0;

134 
	`sqlôe4Te°BöToHex
(
zBuf
, 
gŸ
);

135 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

136 
	`sqlôe4_‰ì
(0, 
zBuf
);

137  
TCL_OK
;

138 
	}
}

147 
	$hexio_wrôe
(

148 * 
˛õ¡D©a
,

149 
T˛_I¡îp
 *
öãΩ
,

150 
objc
,

151 
T˛_Obj
 *
CONST
 
objv
[]

153 
off£t
;

154 
nIn
, 
nOut
, 
wrôãn
;

155 c⁄° *
zFûe
;

156 c⁄° *
zIn
;

157 *
aOut
;

158 
FILE
 *
out
;

160 if–
objc
!=4 ){

161 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "FILENAME OFFSET HEXDATA");

162  
TCL_ERROR
;

164 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
off£t
ËË 
TCL_ERROR
;

165 
zFûe
 = 
	`T˛_GëSåög
(
objv
[1]);

166 
zIn
 = (c⁄° *)
	`T˛_GëSåögFromObj
(
objv
[3], &
nIn
);

167 
aOut
 = 
	`sqlôe4_mÆloc
(0, 
nIn
/2 );

168 if–
aOut
==0 ){

169  
TCL_ERROR
;

171 
nOut
 = 
	`sqlôe4Te°HexToBö
(
zIn
, 
nIn
, 
aOut
);

172 
out
 = 
	`f›í
(
zFûe
, "r+b");

173 if–
out
==0 ){

174 
out
 = 
	`f›í
(
zFûe
, "r+");

176 if–
out
==0 ){

177 
	`T˛_AµídResu…
(
öãΩ
, "ˇ¬Ÿ o≥¿ouçuàfûê", 
zFûe
, 0);

178  
TCL_ERROR
;

180 
	`f£ek
(
out
, 
off£t
, 
SEEK_SET
);

181 
wrôãn
 = 
	`fwrôe
(
aOut
, 1, 
nOut
, 
out
);

182 
	`sqlôe4_‰ì
(0, 
aOut
);

183 
	`f˛o£
(
out
);

184 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
wrôãn
));

185  
TCL_OK
;

186 
	}
}

195 
	$hexio_gë_öt
(

196 * 
˛õ¡D©a
,

197 
T˛_I¡îp
 *
öãΩ
,

198 
objc
,

199 
T˛_Obj
 *
CONST
 
objv
[]

201 
vÆ
;

202 
nIn
, 
nOut
;

203 c⁄° *
zIn
;

204 *
aOut
;

205 
aNum
[4];

207 if–
objc
!=2 ){

208 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "HEXDATA");

209  
TCL_ERROR
;

211 
zIn
 = (c⁄° *)
	`T˛_GëSåögFromObj
(
objv
[1], &
nIn
);

212 
aOut
 = 
	`sqlôe4_mÆloc
(0, 
nIn
/2 );

213 if–
aOut
==0 ){

214  
TCL_ERROR
;

216 
nOut
 = 
	`sqlôe4Te°HexToBö
(
zIn
, 
nIn
, 
aOut
);

217 if–
nOut
>=4 ){

218 
	`mem˝y
(
aNum
, 
aOut
, 4);

220 
	`mem£t
(
aNum
, 0, (aNum));

221 
	`mem˝y
(&
aNum
[4-
nOut
], 
aOut
,ÇOut);

223 
	`sqlôe4_‰ì
(0, 
aOut
);

224 
vÆ
 = (
aNum
[0]<<24) | (aNum[1]<<16) | (aNum[2]<<8) |áNum[3];

225 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
vÆ
));

226  
TCL_OK
;

227 
	}
}

235 
	$hexio_ªndî_öt16
(

236 * 
˛õ¡D©a
,

237 
T˛_I¡îp
 *
öãΩ
,

238 
objc
,

239 
T˛_Obj
 *
CONST
 
objv
[]

241 
vÆ
;

242 
aNum
[10];

244 if–
objc
!=2 ){

245 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "INTEGER");

246  
TCL_ERROR
;

248 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
vÆ
ËË 
TCL_ERROR
;

249 
aNum
[0] = 
vÆ
>>8;

250 
aNum
[1] = 
vÆ
;

251 
	`sqlôe4Te°BöToHex
(
aNum
, 2);

252 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
((*)
aNum
, 4));

253  
TCL_OK
;

254 
	}
}

262 
	$hexio_ªndî_öt32
(

263 * 
˛õ¡D©a
,

264 
T˛_I¡îp
 *
öãΩ
,

265 
objc
,

266 
T˛_Obj
 *
CONST
 
objv
[]

268 
vÆ
;

269 
aNum
[10];

271 if–
objc
!=2 ){

272 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "INTEGER");

273  
TCL_ERROR
;

275 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
vÆ
ËË 
TCL_ERROR
;

276 
aNum
[0] = 
vÆ
>>24;

277 
aNum
[1] = 
vÆ
>>16;

278 
aNum
[2] = 
vÆ
>>8;

279 
aNum
[3] = 
vÆ
;

280 
	`sqlôe4Te°BöToHex
(
aNum
, 4);

281 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
((*)
aNum
, 8));

282  
TCL_OK
;

283 
	}
}

292 
	$utf8_to_utf8
(

293 * 
˛õ¡D©a
,

294 
T˛_I¡îp
 *
öãΩ
,

295 
objc
,

296 
T˛_Obj
 *
CONST
 
objv
[]

298 #ifde‡
SQLITE4_DEBUG


299 
n
;

300 
nOut
;

301 c⁄° *
zOrig
;

302 *
z
;

303 if–
objc
!=2 ){

304 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "HEX");

305  
TCL_ERROR
;

307 
zOrig
 = (*)
	`T˛_GëSåögFromObj
(
objv
[1], &
n
);

308 
z
 = 
	`sqlôe4_mÆloc
(0, 
n
+3 );

309 
n
 = 
	`sqlôe4Te°HexToBö
(
zOrig
,Ç, 
z
);

310 
z
[
n
] = 0;

311 
nOut
 = 
	`sqlôe4Utf8To8
((*)
z
);

312 
	`sqlôe4Te°BöToHex
(
z
, 
nOut
);

313 
	`T˛_AµídResu…
(
öãΩ
, (*)
z
, 0);

314 
	`sqlôe4_‰ì
(0, 
z
);

315  
TCL_OK
;

317 
	`T˛_AµídResu…
(
öãΩ
,

320  
TCL_ERROR
;

322 
	}
}

324 
	$gëFts3V¨öt
(c⁄° *
p
, 
sqlôe4_öt64
 *
v
){

325 c⁄° *
q
 = (c⁄° *Ë
p
;

326 
sqlôe4_uöt64
 
x
 = 0, 
y
 = 1;

327  (*
q
 & 0x80) == 0x80 ){

328 
x
 +
y
 * (*
q
++ & 0x7f);

329 
y
 <<= 7;

331 
x
 +
y
 * (*
q
++);

332 *
v
 = (
sqlôe4_öt64
Ë
x
;

333  (Ë(
q
 - (*)
p
);

334 
	}
}

343 
	$ªad_·s3v¨öt
(

344 * 
˛õ¡D©a
,

345 
T˛_I¡îp
 *
öãΩ
,

346 
objc
,

347 
T˛_Obj
 *
CONST
 
objv
[]

349 
nBlob
;

350 *
zBlob
;

351 
sqlôe4_öt64
 
iVÆ
;

352 
nVÆ
;

354 if–
objc
!=3 ){

355 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "BLOB VARNAME");

356  
TCL_ERROR
;

358 
zBlob
 = 
	`T˛_GëByãAºayFromObj
(
objv
[1], &
nBlob
);

360 
nVÆ
 = 
	`gëFts3V¨öt
((*)
zBlob
, (
sqlôe4_öt64
 *)(&
iVÆ
));

361 
	`T˛_ObjSëV¨2
(
öãΩ
, 
objv
[2], 0, 
	`T˛_NewWideI¡Obj
(
iVÆ
), 0);

362 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
nVÆ
));

363  
TCL_OK
;

364 
	}
}

370 
	$Sqlôëe°_hexio_Inô
(
T˛_I¡îp
 *
öãΩ
){

372 *
zName
;

373 
T˛_ObjCmdProc
 *
xProc
;

374 } 
aObjCmd
[] = {

375 { "hexio_ªad", 
hexio_ªad
 },

376 { "hexio_wrôe", 
hexio_wrôe
 },

377 { "hexio_gë_öt", 
hexio_gë_öt
 },

378 { "hexio_ªndî_öt16", 
hexio_ªndî_öt16
 },

379 { "hexio_ªndî_öt32", 
hexio_ªndî_öt32
 },

380 { "utf8_to_utf8", 
utf8_to_utf8
 },

381 { "ªad_·s3v¨öt", 
ªad_·s3v¨öt
 },

383 
i
;

384 
i
=0; i<(
aObjCmd
)/(aObjCmd[0]); i++){

385 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aObjCmd
[
i
].
zName
,áObjCmd[i].
xProc
, 0, 0);

387  
TCL_OK
;

388 
	}
}

	@test/test_kv.c

15 
	~"sqlôeI¡.h
"

18 *
sqlôe4Te°TextToPå
(const *);

21 
sqlôe4Te°BöToHex
(*,);

22 
sqlôe4Te°HexToBö
(c⁄° *
ö
,,*
out
);

26 
	$°‹ageSëT˛Eº‹Name
(
T˛_I¡îp
 *
öãΩ
, 
rc
){

27 c⁄° *
	`sqlôe4Te°Eº‹Name
();

28 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
	`sqlôe4Te°Eº‹Name
(
rc
), -1));

29 
	}
}

36 
	$ã°_°‹age_›í
(

37 * 
˛õ¡D©a
,

38 
T˛_I¡îp
 *
öãΩ
,

39 
objc
,

40 
T˛_Obj
 *
CONST
 
objv
[]

42 
KVSt‹e
 *
pNew
 = 0;

43 
rc
;

44 
Êags
 = 0;

45 
sqlôe4
 
db
;

46 
zRes
[50];

47 if–
objc
!=2 && objc!=3 ){

48 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "URI ?FLAGS?");

49  
TCL_ERROR
;

51 if–
objc
==3 && 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
Êags
) ){

52  
TCL_ERROR
;

54 
	`mem£t
(&
db
, 0, (db));

55 
rc
 = 
	`sqlôe4KVSt‹eO≥n
(&
db
, "ã°", 
	`T˛_GëSåög
(
objv
[1]), &
pNew
, 
Êags
);

56 if–
rc
 ){

57 
	`sqlôe4KVSt‹eClo£
(
pNew
);

58 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

59  
TCL_ERROR
;

61 
	`sqlôe4_¢¥ötf
(
zRes
,(zRes), "%p", 
pNew
);

62 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
zRes
,-1));

63  
TCL_OK
;

64 
	}
}

71 
	$ã°_°‹age_˛o£
(

72 * 
˛õ¡D©a
,

73 
T˛_I¡îp
 *
öãΩ
,

74 
objc
,

75 
T˛_Obj
 *
CONST
 
objv
[]

77 
KVSt‹e
 *
pOld
 = 0;

78 
rc
;

79 if–
objc
!=2 ){

80 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "STORAGE");

81  
TCL_ERROR
;

83 
pOld
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

84 
rc
 = 
	`sqlôe4KVSt‹eClo£
(
pOld
);

85 if–
rc
 ){

86 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

87  
TCL_ERROR
;

89  
TCL_OK
;

90 
	}
}

97 
	$ã°_°‹age_›í_curs‹
(

98 * 
˛õ¡D©a
,

99 
T˛_I¡îp
 *
öãΩ
,

100 
objc
,

101 
T˛_Obj
 *
CONST
 
objv
[]

103 
KVCurs‹
 *
pNew
 = 0;

104 
KVSt‹e
 *
pSt‹e
 = 0;

105 
rc
;

106 
zRes
[50];

107 if–
objc
!=2 ){

108 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "STORAGE");

109  
TCL_ERROR
;

111 
pSt‹e
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

112 
rc
 = 
	`sqlôe4KVSt‹eO≥nCurs‹
(
pSt‹e
, &
pNew
);

113 if–
rc
 ){

114 
	`sqlôe4KVCurs‹Clo£
(
pNew
);

115 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

116  
TCL_ERROR
;

118 
	`sqlôe4_¢¥ötf
(
zRes
,(zRes), "%p", 
pNew
);

119 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
zRes
,-1));

120  
TCL_OK
;

121 
	}
}

128 
	$ã°_°‹age_˛o£_curs‹
(

129 * 
˛õ¡D©a
,

130 
T˛_I¡îp
 *
öãΩ
,

131 
objc
,

132 
T˛_Obj
 *
CONST
 
objv
[]

134 
KVCurs‹
 *
pOld
 = 0;

135 
rc
;

136 if–
objc
!=2 ){

137 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

138  
TCL_ERROR
;

140 
pOld
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

141 
rc
 = 
	`sqlôe4KVCurs‹Clo£
(
pOld
);

142 if–
rc
 ){

143 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

144  
TCL_ERROR
;

146  
TCL_OK
;

147 
	}
}

150 
	$sqlôe4DecodeHex
(
T˛_Obj
 *
pObj
, *
a
, *
pN
){

151 c⁄° *
pIn
;

152 
nIn
;

153 
pIn
 = (c⁄° *)
	`T˛_GëSåögFromObj
(
pObj
, &
nIn
);

154 *
pN
 = 
	`sqlôe4Te°HexToBö
(
pIn
, 
nIn
, 
a
);

155 
	}
}

162 
	$ã°_°‹age_ª∂a˚
(

163 * 
˛õ¡D©a
,

164 
T˛_I¡îp
 *
öãΩ
,

165 
objc
,

166 
T˛_Obj
 *
CONST
 
objv
[]

168 
KVSt‹e
 *
p
 = 0;

169 
rc
;

170 
nKey
, 
nD©a
;

171 
zKey
[200];

172 
zD©a
[200];

173 if–
objc
!=4 ){

174 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "STORAGE KEY VALUE");

175  
TCL_ERROR
;

177 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

178 
	`sqlôe4DecodeHex
(
objv
[2], 
zKey
, &
nKey
);

179 
	`sqlôe4DecodeHex
(
objv
[3], 
zD©a
, &
nD©a
);

180 
rc
 = 
	`sqlôe4KVSt‹eRïœ˚
(
p
, 
zKey
, 
nKey
, 
zD©a
, 
nD©a
);

181 if–
rc
 ){

182 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

183  
TCL_ERROR
;

185  
TCL_OK
;

186 
	}
}

193 
	$ã°_°‹age_begö
(

194 * 
˛õ¡D©a
,

195 
T˛_I¡îp
 *
öãΩ
,

196 
objc
,

197 
T˛_Obj
 *
CONST
 
objv
[]

199 
KVSt‹e
 *
p
 = 0;

200 
rc
;

201 
iLevñ
;

202 if–
objc
!=3 ){

203 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "STORAGE LEVEL");

204  
TCL_ERROR
;

206 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

207 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
iLevñ
ËË 
TCL_ERROR
;

208 
rc
 = 
	`sqlôe4KVSt‹eBegö
(
p
, 
iLevñ
);

209 if–
rc
 ){

210 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

211  
TCL_ERROR
;

213  
TCL_OK
;

214 
	}
}

221 
	$ã°_°‹age_commô
(

222 * 
˛õ¡D©a
,

223 
T˛_I¡îp
 *
öãΩ
,

224 
objc
,

225 
T˛_Obj
 *
CONST
 
objv
[]

227 
KVSt‹e
 *
p
 = 0;

228 
rc
;

229 
iLevñ
;

230 if–
objc
!=3 ){

231 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "STORAGE LEVEL");

232  
TCL_ERROR
;

234 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

235 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
iLevñ
ËË 
TCL_ERROR
;

236 
rc
 = 
	`sqlôe4KVSt‹eCommôPha£O√
(
p
, 
iLevñ
);

237 if–
rc
 ){

238 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

239  
TCL_ERROR
;

241 
rc
 = 
	`sqlôe4KVSt‹eCommôPha£Two
(
p
, 
iLevñ
);

242 if–
rc
 ){

243 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

244  
TCL_ERROR
;

246  
TCL_OK
;

247 
	}
}

254 
	$ã°_°‹age_rﬁlback
(

255 * 
˛õ¡D©a
,

256 
T˛_I¡îp
 *
öãΩ
,

257 
objc
,

258 
T˛_Obj
 *
CONST
 
objv
[]

260 
KVSt‹e
 *
p
 = 0;

261 
rc
;

262 
iLevñ
;

263 if–
objc
!=3 ){

264 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "STORAGE LEVEL");

265  
TCL_ERROR
;

267 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

268 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
iLevñ
ËË 
TCL_ERROR
;

269 
rc
 = 
	`sqlôe4KVSt‹eRﬁlback
(
p
, 
iLevñ
);

270 if–
rc
 ){

271 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

272  
TCL_ERROR
;

274  
TCL_OK
;

275 
	}
}

282 
	$ã°_°‹age_£ek
(

283 * 
˛õ¡D©a
,

284 
T˛_I¡îp
 *
öãΩ
,

285 
objc
,

286 
T˛_Obj
 *
CONST
 
objv
[]

288 
KVCurs‹
 *
p
 = 0;

289 
rc
;

290 
nKey
, 
dú
;

291 
aKey
[100];

292 if–
objc
!=4 ){

293 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 4, 
objv
, "CURSOR KEY DIRECTION");

294  
TCL_ERROR
;

296 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

297 
	`sqlôe4DecodeHex
(
objv
[2], 
aKey
, &
nKey
);

298 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
dú
ËË 
TCL_ERROR
;

299 
rc
 = 
	`sqlôe4KVCurs‹Sìk
(
p
, 
aKey
, 
nKey
, 
dú
);

300 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

301  
TCL_OK
;

302 
	}
}

309 
	$ã°_°‹age_√xt
(

310 * 
˛õ¡D©a
,

311 
T˛_I¡îp
 *
öãΩ
,

312 
objc
,

313 
T˛_Obj
 *
CONST
 
objv
[]

315 
KVCurs‹
 *
p
 = 0;

316 
rc
;

317 if–
objc
!=2 ){

318 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

319  
TCL_ERROR
;

321 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

322 
rc
 = 
	`sqlôe4KVCurs‹Next
(
p
);

323 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

324  
TCL_OK
;

325 
	}
}

332 
	$ã°_°‹age_¥ev
(

333 * 
˛õ¡D©a
,

334 
T˛_I¡îp
 *
öãΩ
,

335 
objc
,

336 
T˛_Obj
 *
CONST
 
objv
[]

338 
KVCurs‹
 *
p
 = 0;

339 
rc
;

340 if–
objc
!=2 ){

341 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

342  
TCL_ERROR
;

344 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

345 
rc
 = 
	`sqlôe4KVCurs‹Pªv
(
p
);

346 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

347  
TCL_OK
;

348 
	}
}

355 
	$ã°_°‹age_dñëe
(

356 * 
˛õ¡D©a
,

357 
T˛_I¡îp
 *
öãΩ
,

358 
objc
,

359 
T˛_Obj
 *
CONST
 
objv
[]

361 
KVCurs‹
 *
p
 = 0;

362 
rc
;

363 if–
objc
!=2 ){

364 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

365  
TCL_ERROR
;

367 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

368 
rc
 = 
	`sqlôe4KVCurs‹Dñëe
(
p
);

369 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

370  
TCL_OK
;

371 
	}
}

378 
	$ã°_°‹age_ª£t
(

379 * 
˛õ¡D©a
,

380 
T˛_I¡îp
 *
öãΩ
,

381 
objc
,

382 
T˛_Obj
 *
CONST
 
objv
[]

384 
KVCurs‹
 *
p
 = 0;

385 
rc
;

386 if–
objc
!=2 ){

387 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

388  
TCL_ERROR
;

390 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

391 
rc
 = 
	`sqlôe4KVCurs‹Re£t
(
p
);

392 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

393  
TCL_OK
;

394 
	}
}

401 
	$ã°_°‹age_key
(

402 * 
˛õ¡D©a
,

403 
T˛_I¡îp
 *
öãΩ
,

404 
objc
,

405 
T˛_Obj
 *
CONST
 
objv
[]

407 
KVCurs‹
 *
p
 = 0;

408 
rc
;

409 c⁄° *
aKey
;

410 
nKey
;

411 if–
objc
!=2 ){

412 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

413  
TCL_ERROR
;

415 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

416 
rc
 = 
	`sqlôe4KVCurs‹Key
(
p
, &
aKey
, &
nKey
);

417 if–
rc
 ){

418 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

420 
zBuf
[500];

421 
	`mem˝y
(
zBuf
, 
aKey
, 
nKey
);

422 
	`sqlôe4Te°BöToHex
(
zBuf
, 
nKey
);

423 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
((*)
zBuf
, -1));

425  
TCL_OK
;

426 
	}
}

433 
	$ã°_°‹age_d©a
(

434 * 
˛õ¡D©a
,

435 
T˛_I¡îp
 *
öãΩ
,

436 
objc
,

437 
T˛_Obj
 *
CONST
 
objv
[]

439 
KVCurs‹
 *
p
 = 0;

440 
rc
;

441 c⁄° *
aD©a
;

442 
nD©a
;

443 if–
objc
!=2 ){

444 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "CURSOR");

445  
TCL_ERROR
;

447 
p
 = 
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

448 
rc
 = 
	`sqlôe4KVCurs‹D©a
(
p
, 0, 0, &
aD©a
, &
nD©a
);

449 if–
rc
 ){

450 
	`°‹ageSëT˛Eº‹Name
(
öãΩ
, 
rc
);

452 
zBuf
[500];

453 
	`mem˝y
(
zBuf
, 
aD©a
, 
nD©a
);

454 
	`sqlôe4Te°BöToHex
(
zBuf
, 
nD©a
);

455 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
((*)
zBuf
, -1));

457  
TCL_OK
;

458 
	}
}

468 
	$Sqlôëe°°‹age_Inô
(
T˛_I¡îp
 *
öãΩ
){

469 
	sSysˇŒCmd
 {

470 c⁄° *
zName
;

471 
T˛_ObjCmdProc
 *
xCmd
;

472 } 
aCmd
[] = {

473 { "°‹age_›í", 
ã°_°‹age_›í
 },

474 { "°‹age_˛o£", 
ã°_°‹age_˛o£
 },

475 { "°‹age_›í_curs‹", 
ã°_°‹age_›í_curs‹
 },

476 { "°‹age_˛o£_curs‹", 
ã°_°‹age_˛o£_curs‹
 },

477 { "°‹age_ª∂a˚", 
ã°_°‹age_ª∂a˚
 },

478 { "°‹age_begö", 
ã°_°‹age_begö
 },

479 { "°‹age_commô", 
ã°_°‹age_commô
 },

480 { "°‹age_rﬁlback", 
ã°_°‹age_rﬁlback
 },

481 { "°‹age_£ek", 
ã°_°‹age_£ek
 },

482 { "°‹age_√xt", 
ã°_°‹age_√xt
 },

483 { "°‹age_¥ev", 
ã°_°‹age_¥ev
 },

484 { "°‹age_dñëe", 
ã°_°‹age_dñëe
 },

485 { "°‹age_ª£t", 
ã°_°‹age_ª£t
 },

486 { "°‹age_key", 
ã°_°‹age_key
 },

487 { "°‹age_d©a", 
ã°_°‹age_d©a
 },

489 
i
;

491 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

492 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xCmd
, 0, 0);

494  
TCL_OK
;

495 
	}
}

	@test/test_kv2.c

15 
	~"sqlôeI¡.h
"

18 
	sKVWøpGlobÆ
 {

19 
sqlôe4_kvÁ˘‹y
 
	mxFa˘‹y
;

20 
	mnSãp
;

21 
	mnSìk
;

22 } 
	gkvwg
 = {0};

24 
KVWøp
 
	tKVWøp
;

25 
KVWøpC§
 
	tKVWøpC§
;

27 
	sKVWøp
 {

28 
KVSt‹e
 
	mba£
;

29 
KVSt‹e
 *
	mpRól
;

32 
	sKVWøpC§
 {

33 
KVCurs‹
 
	mba£
;

34 
KVCurs‹
 *
	mpRól
;

37 
	$kvwøpBegö
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

38 
rc
;

39 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

40 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xBegö
’->pRól, 
iLevñ
);

41 
p
->
ba£
.
iTønsLevñ
 =Ö->
pRól
->iTransLevel;

42  
rc
;

43 
	}
}

45 
	$kvwøpCommôPha£O√
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

46 
rc
;

47 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

48 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xCommôPha£O√
’->pRól, 
iLevñ
);

49 
p
->
ba£
.
iTønsLevñ
 =Ö->
pRól
->iTransLevel;

50  
rc
;

51 
	}
}

53 
	$kvwøpCommôPha£Two
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

54 
rc
;

55 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

56 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xCommôPha£Two
’->pRól, 
iLevñ
);

57 
p
->
ba£
.
iTønsLevñ
 =Ö->
pRól
->iTransLevel;

58  
rc
;

59 
	}
}

61 
	$kvwøpRﬁlback
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

62 
rc
;

63 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

64 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xRﬁlback
’->pRól, 
iLevñ
);

65 
p
->
ba£
.
iTønsLevñ
 =Ö->
pRól
->iTransLevel;

66  
rc
;

67 
	}
}

69 
	$kvwøpRevît
(
KVSt‹e
 *
pKVSt‹e
, 
iLevñ
){

70 
rc
;

71 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

72 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xRevît
’->pRól, 
iLevñ
);

73 
p
->
ba£
.
iTønsLevñ
 =Ö->
pRól
->iTransLevel;

74  
rc
;

75 
	}
}

77 
	$kvwøpRïœ˚
(

78 
KVSt‹e
 *
pKVSt‹e
,

79 c⁄° 
KVByãAºay
 *
aKey
, 
KVSize
 
nKey
,

80 c⁄° 
KVByãAºay
 *
aD©a
, 
KVSize
 
nD©a


82 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

83  
p
->
pRól
->
pSt‹eVfunc
->
	`xRïœ˚
’->pRól, 
aKey
, 
nKey
, 
aD©a
, 
nD©a
);

84 
	}
}

89 
	$kvwøpO≥nCurs‹
(
KVSt‹e
 *
pKVSt‹e
, 
KVCurs‹
 **
µKVCurs‹
){

90 
rc
 = 
SQLITE4_OK
;

91 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

92 
KVWøpC§
 *
pC§
;

94 
pC§
 = (
KVWøpC§
 *)
	`sqlôe4_mÆloc
(0, (KVWrapCsr));

95 if–
pC§
==0 ){

96 
rc
 = 
SQLITE4_NOMEM
;

98 
	`mem£t
(
pC§
, 0, (
KVWøpC§
));

99 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xO≥nCurs‹
’->pRól, &
pC§
->pReal);

100 if–
rc
!=
SQLITE4_OK
 ){

101 
	`sqlôe4_‰ì
(0, 
pC§
);

102 
pC§
 = 0;

104 
pC§
->
ba£
.
pSt‹e
 = 
pKVSt‹e
;

105 
pC§
->
ba£
.
pSt‹eVfunc
 = 
pKVSt‹e
->pStoreVfunc;

109 *
µKVCurs‹
 = (
KVCurs‹
*)
pC§
;

110  
rc
;

111 
	}
}

116 
	$kvwøpRe£t
(
KVCurs‹
 *
pKVCurs‹
){

117 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

118 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

119  
p
->
pRól
->
pSt‹eVfunc
->
	`xRe£t
(
pC§
->pReal);

120 
	}
}

125 
	$kvwøpClo£Curs‹
(
KVCurs‹
 *
pKVCurs‹
){

126 
rc
;

127 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

128 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

129 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xClo£Curs‹
(
pC§
->pReal);

130 
	`sqlôe4_‰ì
(0, 
pC§
);

131  
rc
;

132 
	}
}

137 
	$kvwøpNextE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

138 
rc
;

139 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

140 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

141 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xNext
(
pC§
->pReal);

142 
kvwg
.
nSãp
++;

143  
rc
;

144 
	}
}

149 
	$kvwøpPªvE¡ry
(
KVCurs‹
 *
pKVCurs‹
){

150 
rc
;

151 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

152 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

153 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xPªv
(
pC§
->pReal);

154 
kvwg
.
nSãp
++;

155  
rc
;

156 
	}
}

161 
	$kvwøpSìk
(

162 
KVCurs‹
 *
pKVCurs‹
,

163 c⁄° 
KVByãAºay
 *
aKey
,

164 
KVSize
 
nKey
,

165 
dú


167 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

168 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

171 if–
aKey
[0] ) 
kvwg
.
nSìk
++;

173  
p
->
pRól
->
pSt‹eVfunc
->
	`xSìk
(
pC§
->pRól, 
aKey
, 
nKey
, 
dú
);

174 
	}
}

184 
	$kvwøpDñëe
(
KVCurs‹
 *
pKVCurs‹
){

185 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

186 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

187  
p
->
pRól
->
pSt‹eVfunc
->
	`xDñëe
(
pC§
->pReal);

188 
	}
}

193 
	$kvwøpKey
(

194 
KVCurs‹
 *
pKVCurs‹
,

195 c⁄° 
KVByãAºay
 **
∑Key
,

196 
KVSize
 *
pN


198 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

199 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

200  
p
->
pRól
->
pSt‹eVfunc
->
	`xKey
(
pC§
->pRól, 
∑Key
, 
pN
);

201 
	}
}

206 
	$kvwøpD©a
(

207 
KVCurs‹
 *
pKVCurs‹
,

208 
KVSize
 
of°
,

209 
KVSize
 
n
,

210 c⁄° 
KVByãAºay
 **
∑D©a
,

211 
KVSize
 *
pND©a


213 
KVWøp
 *
p
 = (KVWø∞*)(
pKVCurs‹
->
pSt‹e
);

214 
KVWøpC§
 *
pC§
 = (KVWøpC§ *)
pKVCurs‹
;

215  
p
->
pRól
->
pSt‹eVfunc
->
	`xD©a
(
pC§
->pRól, 
of°
, 
n
, 
∑D©a
, 
pND©a
);

216 
	}
}

221 
	$kvwøpClo£
(
KVSt‹e
 *
pKVSt‹e
){

222 
rc
;

223 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

224 
rc
 = 
p
->
pRól
->
pSt‹eVfunc
->
	`xClo£
(p->pReal);

225 
	`sqlôe4_‰ì
(0, 
p
);

226  
rc
;

227 
	}
}

232 
	$kvwøpC⁄åﬁ
(
KVSt‹e
 *
pKVSt‹e
, 
›
, *
pArg
){

233 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

234  
p
->
pRól
->
pSt‹eVfunc
->
	`xC⁄åﬁ
’->pRól, 
›
, 
pArg
);

235 
	}
}

237 
	$kvwøpGëMëa
(
KVSt‹e
 *
pKVSt‹e
, *
piVÆ
){

238 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

239  
p
->
pRól
->
pSt‹eVfunc
->
	`xGëMëa
’->pRól, 
piVÆ
);

240 
	}
}

242 
	$kvwøpPutMëa
(
KVSt‹e
 *
pKVSt‹e
, 
iVÆ
){

243 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

244  
p
->
pRól
->
pSt‹eVfunc
->
	`xPutMëa
’->pRól, 
iVÆ
);

245 
	}
}

247 
kvwøpGëMëhod
(

248 
sqlôe4_kv°‹e
 *
pKVSt‹e
,

249 c⁄° *
zMëhod
,

250 **
µArg
,

251 (**
pxFunc
)(
sqlôe4_c⁄ãxt
 *, , 
sqlôe4_vÆue
 **),

252 (**
pxDe°roy
)(*)

254 
KVWøp
 *
p
 = (KVWø∞*)
pKVSt‹e
;

255  
p
->
pRól
->
pSt‹eVfunc
->
	`xGëMëhod
(

256 
p
->
pRól
, 
zMëhod
, 
µArg
, 
pxFunc
, 
pxDe°roy


258 
	}
}

260 
	$√wFûeSt‹age
(

261 
sqlôe4_ív
 *
pEnv
,

262 
KVSt‹e
 **
µKVSt‹e
,

263 c⁄° *
zName
,

264 
›íFœgs


268 c⁄° 
KVSt‹eMëhods
 
kvwøpMëhods
 = {

270 (
KVSt‹eMëhods
),

271 
kvwøpRïœ˚
,

272 
kvwøpO≥nCurs‹
,

273 
kvwøpSìk
,

274 
kvwøpNextE¡ry
,

275 
kvwøpPªvE¡ry
,

276 
kvwøpDñëe
,

277 
kvwøpKey
,

278 
kvwøpD©a
,

279 
kvwøpRe£t
,

280 
kvwøpClo£Curs‹
,

281 
kvwøpBegö
,

282 
kvwøpCommôPha£O√
,

283 
kvwøpCommôPha£Two
,

284 
kvwøpRﬁlback
,

285 
kvwøpRevît
,

286 
kvwøpClo£
,

287 
kvwøpC⁄åﬁ
,

288 
kvwøpGëMëa
,

289 
kvwøpPutMëa
,

290 
kvwøpGëMëhod


293 
KVWøp
 *
pNew
;

294 
rc
 = 
SQLITE4_OK
;

296 
pNew
 = (
KVWøp
 *)
	`sqlôe4_mÆloc
(0, (KVWrap));

297 if–
pNew
==0 ){

298 
rc
 = 
SQLITE4_NOMEM
;

300 
	`mem£t
(
pNew
, 0, (
KVWøp
));

301 
pNew
->
ba£
.
pSt‹eVfunc
 = &
kvwøpMëhods
;

302 
rc
 = 
kvwg
.
	`xFa˘‹y
(
pEnv
, &
pNew
->
pRól
, 
zName
, 
›íFœgs
);

303 if–
rc
!=
SQLITE4_OK
 ){

304 
	`sqlôe4_‰ì
(0, 
pNew
);

305 
pNew
 = 0;

309 *
µKVSt‹e
 = (
KVSt‹e
*)
pNew
;

310  
rc
;

311 
	}
}

313 
	$kvwøp_ö°Æl_cmd
(
T˛_I¡îp
 *
öãΩ
, 
objc
, 
T˛_Obj
 **
objv
){

314 c⁄° *
z
 = "main";

316 if–
objc
!=2 && objc!=3 ){

317 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "?FACTORY?");

318  
TCL_ERROR
;

320 if–
objc
==3 ){

321 
z
 = 
	`T˛_GëSåög
(
objv
[2]);

324 if–
kvwg
.
xFa˘‹y
==0 ){

325 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_KVSTORE_GET
,
z
,&
kvwg
.
xFa˘‹y
);

326 if–
kvwg
.
xFa˘‹y
==0 ){

327 
	`T˛_AµídResu…
(
öãΩ
, "nÿsuch fa˘‹y: ", 
z
, 0);

328  
TCL_ERROR
;

330 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_KVSTORE_PUSH
,"maö",
√wFûeSt‹age
);

332  
TCL_OK
;

333 
	}
}

335 
	$kvwøp_unö°Æl_cmd
(
T˛_I¡îp
 *
öãΩ
, 
objc
, 
T˛_Obj
 **
objv
){

336 if–
objc
!=2 ){

337 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "");

338  
TCL_ERROR
;

341 if–
kvwg
.
xFa˘‹y
 ){

342 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_KVSTORE_POP
,"maö", &
kvwg
.
xFa˘‹y
);

343 
kvwg
.
xFa˘‹y
 = 0;

345  
TCL_OK
;

346 
	}
}

348 
	$kvwøp_£ek_cmd
(
T˛_I¡îp
 *
öãΩ
, 
objc
, 
T˛_Obj
 **
objv
){

349 if–
objc
!=2 ){

350 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "");

351  
TCL_ERROR
;

354 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
kvwg
.
nSìk
));

355  
TCL_OK
;

356 
	}
}

358 
	$kvwøp_°ï_cmd
(
T˛_I¡îp
 *
öãΩ
, 
objc
, 
T˛_Obj
 **
objv
){

359 if–
objc
!=2 ){

360 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "");

361  
TCL_ERROR
;

364 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
kvwg
.
nSãp
));

365  
TCL_OK
;

366 
	}
}

368 
	$kvwøp_ª£t_cmd
(
T˛_I¡îp
 *
öãΩ
, 
objc
, 
T˛_Obj
 **
objv
){

369 if–
objc
!=2 ){

370 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "");

371  
TCL_ERROR
;

374 
kvwg
.
nSãp
 = 0;

375 
kvwg
.
nSìk
 = 0;

377 
	`T˛_Re£tResu…
(
öãΩ
);

378  
TCL_OK
;

379 
	}
}

385 
	$kvwøp_comm™d
(

386 * 
˛õ¡D©a
,

387 
T˛_I¡îp
 *
öãΩ
,

388 
objc
,

389 
T˛_Obj
 *
CONST
 
objv
[]

391 
	sSubcmd
 {

392 c⁄° *
zCmd
;

393 (*
xCmd
)(
T˛_I¡îp
 *, , 
T˛_Obj
 **);

394 } 
aSub
[] = {

395 { "ö°Æl", 
kvwøp_ö°Æl_cmd
 },

396 { "°ï", 
kvwøp_°ï_cmd
 },

397 { "£ek", 
kvwøp_£ek_cmd
 },

398 { "ª£t", 
kvwøp_ª£t_cmd
 },

399 { "unö°Æl", 
kvwøp_unö°Æl_cmd
 },

401 
iSub
;

402 
rc
;

404 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

405 
öãΩ
, 
objv
[1], 
aSub
, ◊Sub[0]), "sub-comm™d", 0, &
iSub


407 if–
rc
==
TCL_OK
 ){

408 
rc
 = 
aSub
[
iSub
].
	`xCmd
(
öãΩ
, 
objc
, (
T˛_Obj
 **)
objv
);

411  
rc
;

412 
	}
}

417 
	$kv_deÁu…_cmd
(

418 * 
˛õ¡D©a
,

419 
T˛_I¡îp
 *
öãΩ
,

420 
objc
,

421 
T˛_Obj
 *
CONST
 
objv
[]

423 
sqlôe4_kvÁ˘‹y
 
Á˘‹y
 = 0;

424 c⁄° *
zDÊt
;

426 if–
objc
!=2 ){

427 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DEFAULT");

428  
TCL_ERROR
;

431 
zDÊt
 = 
	`T˛_GëSåög
(
objv
[1]);

433 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_KVSTORE_GET
, 
zDÊt
, &
Á˘‹y
);

434 if–
Á˘‹y
==0 ){

435 
	`T˛_Re£tResu…
(
öãΩ
);

436 
	`T˛_AµídResu…
(
öãΩ
, "nÿsuch fa˘‹y: ", 
zDÊt
, 0);

437  
TCL_ERROR
;

439 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_KVSTORE_PUSH
, "maö", 
Á˘‹y
);

440  
TCL_OK
;

441 
	}
}

449 
	$Sqlôëe°°‹age2_Inô
(
T˛_I¡îp
 *
öãΩ
){

450 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "kvwøp", 
kvwøp_comm™d
, 0, 0);

451 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "kv_deÁu…", 
kv_deÁu…_cmd
, 0, 0);

452  
TCL_OK
;

453 
	}
}

	@test/test_lsm.c

14 
	~<t˛.h
>

15 
	~"lsm.h
"

16 
	~"sqlôe4.h
"

17 
	~<as£π.h
>

18 
	~<°rög.h
>

20 
gëDbPoöãr
(
T˛_I¡îp
 *
öãΩ
, c⁄° *
zA
, 
sqlôe4
 **
µDb
);

21 c⁄° *
sqlôe4Te°Eº‹Name
();

25 
	#ENCRYPTION_XOR_MASK
 0x23b2bbb6

	)

26 
	$ã°Com¥essEncBound
(*
pCtx
, 
nSrc
){

27  
nSrc
;

28 
	}
}

29 
	$ã°Com¥essEncCom¥ess
(

30 *
pCtx
,

31 *
pOut
, *
≤Out
,

32 c⁄° *
pIn
, 
nIn


34 
i
;

35 *
aIn
 = (*)
pOut
;

36 *
aOut
 = (*)
pIn
;

38 
	`as£π
–(
nIn
%4)==0 );

39 
i
=0; i<(
nIn
/4); i++){

40 
aOut
[
i
] = (
aIn
[i] ^ 
ENCRYPTION_XOR_MASK
);

42 *
≤Out
 = 
nIn
;

44  
LSM_OK
;

45 
	}
}

46 
	$ã°Com¥essEncUncom¥ess
(

47 *
pCtx
,

48 *
pOut
, *
≤Out
,

49 c⁄° *
pIn
, 
nIn


51  
	`ã°Com¥essEncCom¥ess
(
pCtx
, 
pOut
, 
≤Out
, 
pIn
, 
nIn
);

52 
	}
}

53 
	$ã°Com¥essEncFªe
(*
pCtx
){

55 
	}
}

62 
	$ã°Com¥essRÀBound
(*
pCtx
, 
nSrc
){

63  
nSrc
*2;

64 
	}
}

65 
	$ã°Com¥essRÀCom¥ess
(

66 *
pCtx
,

67 *
pOut
, *
≤Out
,

68 c⁄° *
pIn
, 
nIn


70 
iOut
 = 0;

71 
i
;

72 
c
;

73 
n
;

75 
c
 = 
pIn
[0];

76 
n
 = 1;

77 
i
=1; i<
nIn
; i++){

78 if–
pIn
[
i
]==
c
 && 
n
<127 ){

79 
n
++;

81 
pOut
[
iOut
++] = 
c
;

82 
pOut
[
iOut
++] = ()
n
;

83 
c
 = 
pIn
[
i
];

84 
n
 = 1;

88 
pOut
[
iOut
++] = 
c
;

89 
pOut
[
iOut
++] = ()
n
;

90 *
≤Out
 = 
iOut
;

92  
LSM_OK
;

93 
	}
}

94 
	$ã°Com¥essRÀUncom¥ess
(

95 *
pCtx
,

96 *
pOut
, *
≤Out
,

97 c⁄° *
pIn
, 
nIn


99 
i
;

100 
iOut
 = 0;

102 
i
=0; i<
nIn
; i+=2){

103 
iRï
;

104 
c
 = 
pIn
[
i
];

105 
n
 = ()(
pIn
[
i
+1]);

107 
iRï
=0; iRï<
n
; iRep++){

108 
pOut
[
iOut
++] = 
c
;

112 *
≤Out
 = 
iOut
;

113  
LSM_OK
;

114 
	}
}

115 
	$ã°Com¥essRÀFªe
(*
pCtx
){

116 
	}
}

123 
	$ã°Com¥essNo›Bound
(*
pCtx
, 
nSrc
){

124  
nSrc
;

125 
	}
}

126 
	$ã°Com¥essNo›Com¥ess
(

127 *
pCtx
,

128 *
pOut
, *
≤Out
,

129 c⁄° *
pIn
, 
nIn


131 *
≤Out
 = 
nIn
;

132 
	`mem˝y
(
pOut
, 
pIn
, 
nIn
);

133  
LSM_OK
;

134 
	}
}

135 
	$ã°Com¥essNo›Uncom¥ess
(

136 *
pCtx
,

137 *
pOut
, *
≤Out
,

138 c⁄° *
pIn
, 
nIn


140 *
≤Out
 = 
nIn
;

141 
	`mem˝y
(
pOut
, 
pIn
, 
nIn
);

142  
LSM_OK
;

143 
	}
}

144 
	$ã°Com¥essNo›Fªe
(*
pCtx
){

145 
	}
}

150 
	$ã°C⁄figuªSëCom¥essi⁄
(

151 
T˛_I¡îp
 *
öãΩ
,

152 
lsm_db
 *
db
,

153 
T˛_Obj
 *
pCmp
,

154 
iId


156 
	sCom¥essi⁄Scheme
 {

157 c⁄° *
zName
;

158 
lsm_com¥ess
 
cmp
;

159 } 
aCmp
[] = {

161 
ã°Com¥essEncBound
, 
ã°Com¥essEncCom¥ess
,

162 
ã°Com¥essEncUncom¥ess
, 
ã°Com¥essEncFªe


165 
ã°Com¥essRÀBound
, 
ã°Com¥essRÀCom¥ess
,

166 
ã°Com¥essRÀUncom¥ess
, 
ã°Com¥essRÀFªe


169 
ã°Com¥essNo›Bound
, 
ã°Com¥essNo›Com¥ess
,

170 
ã°Com¥essNo›Uncom¥ess
, 
ã°Com¥essNo›Fªe


174 
iO±
;

175 
rc
;

177 if–
öãΩ
 ){

178 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

179 
öãΩ
, 
pCmp
, 
aCmp
, ◊Cmp[0]), "scheme", 0, &
iO±


181 if–
rc
!=
TCL_OK
 ) Ñc;

183 
nO±
 = (
aCmp
)/(aCmp[0]);

184 
iO±
=0; iO±<
nO±
; iOpt++){

185 if–
iId
==
aCmp
[
iO±
].
cmp
.iId ) ;

187 if–
iO±
==
nO±
 )  0;

190 
rc
 = 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_SET_COMPRESSION
, &
aCmp
[
iO±
].
cmp
);

191  
rc
;

192 
	}
}

194 
	$ã°Com¥essFa˘‹y
(*
pCtx
, 
lsm_db
 *
db
, 
iId
){

195  
	`ã°C⁄figuªSëCom¥essi⁄
(0, 
db
, 0, 
iId
);

196 
	}
}

198 
	$ã°C⁄figuªSëFa˘‹y
(

199 
T˛_I¡îp
 *
öãΩ
,

200 
lsm_db
 *
db
,

201 
T˛_Obj
 *
pArg


203 
lsm_com¥ess_Á˘‹y
 
aFa˘‹y
[2] = {

205 { 0, 
ã°Com¥essFa˘‹y
, 0 },

207 
bArg
 = 0;

208 
rc
;

210 
rc
 = 
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
pArg
, &
bArg
);

211 if–
rc
!=
TCL_OK
 ) Ñc;

212 
	`as£π
–
bArg
==1 || bArg==0 );

214 
rc
 = 
	`lsm_c⁄fig
(
db
, 
LSM_CONFIG_SET_COMPRESSION_FACTORY
, &
aFa˘‹y
[
bArg
]);

215  
rc
;

216 
	}
}

239 
	$ã°C⁄figuªLsm
(

240 
T˛_I¡îp
 *
öãΩ
,

241 
lsm_db
 *
db
,

242 
nObj
,

243 
T˛_Obj
 *c⁄°* 
≠Obj


245 
	sLsmc⁄fig
 {

246 c⁄° *
zO±
;

247 
eO±
;

248 
bI¡egî
;

249 } 
aC⁄fig
[] = {

250 { "autoÊush", 
LSM_CONFIG_AUTOFLUSH
, 1 },

251 { "∑ge_size", 
LSM_CONFIG_PAGE_SIZE
, 1 },

252 { "block_size", 
LSM_CONFIG_BLOCK_SIZE
, 1 },

253 { "ß„ty", 
LSM_CONFIG_SAFETY
, 1 },

254 { "autow‹k", 
LSM_CONFIG_AUTOWORK
, 1 },

255 { "autocheckpoöt", 
LSM_CONFIG_AUTOCHECKPOINT
, 1 },

256 { "mm≠", 
LSM_CONFIG_MMAP
, 1 },

257 { "u£_log", 
LSM_CONFIG_USE_LOG
, 1 },

258 { "automîge", 
LSM_CONFIG_AUTOMERGE
, 1 },

259 { "max_‰ìli°", 
LSM_CONFIG_MAX_FREELIST
, 1 },

260 { "mu…i_¥oc", 
LSM_CONFIG_MULTIPLE_PROCESSES
, 1 },

261 { "£t_com¥essi⁄", 
LSM_CONFIG_SET_COMPRESSION
, 0 },

262 { "£t_com¥essi⁄_Á˘‹y", 
LSM_CONFIG_SET_COMPRESSION_FACTORY
, 0 },

263 { "ªad⁄ly", 
LSM_CONFIG_READONLY
, 1 },

266 
i
;

267 
rc
 = 
TCL_OK
;

269 
i
=0; 
rc
==
TCL_OK
 && i<
nObj
; i+=2){

270 
iO±
;

271 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

272 
öãΩ
, 
≠Obj
[
i
], 
aC⁄fig
, ◊C⁄fig[0]), "›ti⁄", 0, &
iO±


274 if–
rc
==
TCL_OK
 ){

275 if–
i
==(
nObj
-1) ){

276 
	`T˛_Re£tResu…
(
öãΩ
);

277 if–
aC⁄fig
[
iO±
].
bI¡egî
 ){

278 
iVÆ
 = -1;

279 
	`lsm_c⁄fig
(
db
, 
aC⁄fig
[
iO±
].
eO±
, &
iVÆ
);

280 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
iVÆ
));

283 if–
aC⁄fig
[
iO±
].
eO±
==
LSM_CONFIG_SET_COMPRESSION
 ){

284 
rc
 = 
	`ã°C⁄figuªSëCom¥essi⁄
(
öãΩ
, 
db
, 
≠Obj
[
i
+1], 0);

286 if–
aC⁄fig
[
iO±
].
eO±
==
LSM_CONFIG_SET_COMPRESSION_FACTORY
 ){

287 
rc
 = 
	`ã°C⁄figuªSëFa˘‹y
(
öãΩ
, 
db
, 
≠Obj
[
i
+1]);

290 
iVÆ
;

291 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
≠Obj
[
i
+1], &
iVÆ
);

292 if–
rc
==
TCL_OK
 ){

293 
	`lsm_c⁄fig
(
db
, 
aC⁄fig
[
iO±
].
eO±
, &
iVÆ
);

295 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
iVÆ
));

301  
rc
;

302 
	}
}

307 
	$ã°_sqlôe4_lsm_c⁄fig
(

308 * 
˛õ¡D©a
,

309 
T˛_I¡îp
 *
öãΩ
,

310 
objc
,

311 
T˛_Obj
 *
CONST
 
objv
[]

314 c⁄° *
zDb
;

315 c⁄° *
zName
;

317 
rc
;

318 
sqlôe4
 *
db
;

319 
lsm_db
 *
pLsm
;

322 if–
objc
!=4 && objc!=5 ){

323 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB DBNAME PARAM ?VALUE?");

324  
TCL_ERROR
;

326 
zDb
 = 
	`T˛_GëSåög
(
objv
[1]);

327 
zName
 = 
	`T˛_GëSåög
(
objv
[2]);

329 
rc
 = 
	`gëDbPoöãr
(
öãΩ
, 
zDb
, &
db
);

330 if–
rc
==
TCL_OK
 ){

331 
rc
 = 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, 
zName
, 
SQLITE4_KVCTRL_LSM_HANDLE
, &
pLsm
);

332 if–
rc
!=
SQLITE4_OK
 ){

333 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_STATIC
);

334 
rc
 = 
TCL_ERROR
;

338 if–
rc
==
SQLITE4_OK
 ){

339 
	`ã°C⁄figuªLsm
(
öãΩ
, 
pLsm
, 
objc
-3, &
objv
[3]);

341  
rc
;

342 
	}
}

347 
	$ã°_sqlôe4_lsm_öfo
(

348 * 
˛õ¡D©a
,

349 
T˛_I¡îp
 *
öãΩ
,

350 
objc
,

351 
T˛_Obj
 *
CONST
 
objv
[]

353 
	sSwôch
 {

354 c⁄° *
zSwôch
;

355 
iVÆ
;

356 } 
aP¨am
[] = {

357 { "db-°ru˘uª", 
LSM_INFO_DB_STRUCTURE
 },

358 { "log-°ru˘uª", 
LSM_INFO_LOG_STRUCTURE
 },

362 c⁄° *
zDb
;

363 c⁄° *
zName
;

364 
iP¨am
;

366 
rc
;

367 
sqlôe4
 *
db
;

368 
lsm_db
 *
pLsm
;

371 if–
objc
!=4 ){

372 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB DBNAME PARAM");

373  
TCL_ERROR
;

375 
zDb
 = 
	`T˛_GëSåög
(
objv
[1]);

376 
zName
 = 
	`T˛_GëSåög
(
objv
[2]);

377 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

378 
öãΩ
, 
objv
[3], 
aP¨am
, ◊P¨am[0]), "∑øm", 0, &
iP¨am


380 if–
rc
!=
TCL_OK
 ) Ñc;

381 if–
rc
==
TCL_OK
 ){

382 
iP¨am
 = 
aP¨am
[iP¨am].
iVÆ
;

383 
rc
 = 
	`gëDbPoöãr
(
öãΩ
, 
zDb
, &
db
);

385 if–
rc
!=
TCL_OK
 ) Ñc;

387 
rc
 = 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, 
zName
, 
SQLITE4_KVCTRL_LSM_HANDLE
, &
pLsm
);

388 if–
rc
==
SQLITE4_OK
 ){

389 *
zLi°
;

390 
	`lsm_öfo
(
pLsm
, 
iP¨am
, &
zLi°
);

391 
	`T˛_SëResu…
(
öãΩ
, 
zLi°
, 
TCL_VOLATILE
);

392 
	`lsm_‰ì
(
	`lsm_gë_ív
(
pLsm
), 
zLi°
);

395 if–
rc
!=
SQLITE4_OK
 ){

396 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_STATIC
);

397  
TCL_ERROR
;

399  
TCL_OK
;

400 
	}
}

405 
	$ã°_sqlôe4_lsm_w‹k
(

406 * 
˛õ¡D©a
,

407 
T˛_I¡îp
 *
öãΩ
,

408 
objc
,

409 
T˛_Obj
 *
CONST
 
objv
[]

411 
	sSwôch
 {

412 c⁄° *
zSwôch
;

413 } 
aSwôch
[] = {

419 
nMîge
 = 1;

420 
nPage
 = 0;

421 c⁄° *
zDb
;

422 c⁄° *
zName
;

423 
i
;

424 
rc
;

425 
sqlôe4
 *
db
;

426 
lsm_db
 *
pLsm
;

427 
nW‹k
;

429 if–
objc
!=3 && objc!=5 && objc!=7 ){

430 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB DBNAME ?-nmerge N? ?-npage N?");

431  
TCL_ERROR
;

433 
zDb
 = 
	`T˛_GëSåög
(
objv
[1]);

434 
zName
 = 
	`T˛_GëSåög
(
objv
[2]);

436 
i
=3; i<
objc
; i+=2){

437 
iIdx
;

438 
iVÆ
;

439 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

440 
öãΩ
, 
objv
[
i
], 
aSwôch
, ◊Swôch[0]), "swôch", 0, &
iIdx


442 if–
rc
!=
TCL_OK
 ) Ñc;

443 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[
i
+1], &
iVÆ
);

444 if–
rc
!=
TCL_OK
 ) Ñc;

445 if–
iIdx
==0 ) 
nMîge
 = 
iVÆ
;

446 if–
iIdx
==1 ) 
nPage
 = 
iVÆ
;

449 
rc
 = 
	`gëDbPoöãr
(
öãΩ
, 
zDb
, &
db
);

450 if–
rc
!=
TCL_OK
 ) Ñc;

452 
rc
 = 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, 
zName
, 
SQLITE4_KVCTRL_LSM_HANDLE
, &
pLsm
);

453 if–
rc
==
SQLITE4_OK
 ){

454 
rc
 = 
	`lsm_w‹k
(
pLsm
, 
nMîge
, 
nPage
, &
nW‹k
);

456 if–
rc
!=
SQLITE4_OK
 ){

457 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_STATIC
);

458  
TCL_ERROR
;

461 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
nW‹k
));

462  
TCL_OK
;

463 
	}
}

468 
	$ã°_sqlôe4_lsm_checkpoöt
(

469 * 
˛õ¡D©a
,

470 
T˛_I¡îp
 *
öãΩ
,

471 
objc
,

472 
T˛_Obj
 *
CONST
 
objv
[]

474 c⁄° *
zDb
;

475 c⁄° *
zName
;

476 
rc
;

477 
sqlôe4
 *
db
;

478 
lsm_db
 *
pLsm
;

480 if–
objc
!=3 ){

481 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB DBNAME");

482  
TCL_ERROR
;

484 
zDb
 = 
	`T˛_GëSåög
(
objv
[1]);

485 
zName
 = 
	`T˛_GëSåög
(
objv
[2]);

487 
rc
 = 
	`gëDbPoöãr
(
öãΩ
, 
zDb
, &
db
);

488 if–
rc
!=
TCL_OK
 ) Ñc;

490 
rc
 = 
	`sqlôe4_kv°‹e_c⁄åﬁ
(
db
, 
zName
, 
SQLITE4_KVCTRL_LSM_HANDLE
, &
pLsm
);

491 if–
rc
==
SQLITE4_OK
 ){

492 
rc
 = 
	`lsm_checkpoöt
(
pLsm
, 0);

494 if–
rc
!=
SQLITE4_OK
 ){

495 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_STATIC
);

496  
TCL_ERROR
;

499 
	`T˛_Re£tResu…
(
öãΩ
);

500  
TCL_OK
;

501 
	}
}

504 
T˛LsmCurs‹
 
	tT˛LsmCurs‹
;

505 
T˛Lsm
 
	tT˛Lsm
;

507 
	sT˛Lsm
 {

508 
lsm_db
 *
	mdb
;

511 
	sT˛LsmCurs‹
 {

512 
lsm_curs‹
 *
	mc§
;

515 
	$ã°_lsm_îr‹
(
T˛_I¡îp
 *
öãΩ
, c⁄° *
zApi
, 
rc
){

516 
zMsg
[64];

517 if–
rc
==
LSM_OK
 ){

518  
TCL_OK
;

521 
	`•rötf
(
zMsg
, "îr‹ i¿%s(Ë- %d", 
zApi
, 
rc
);

522 
	`T˛_Re£tResu…
(
öãΩ
);

523 
	`T˛_AµídResu…
(
öãΩ
, 
zMsg
, 0);

524  
TCL_ERROR
;

525 
	}
}

527 
	$ã°_lsm_curs‹_dñ
(*
˘x
){

528 
T˛LsmCurs‹
 *
pC§
 = (T˛LsmCurs‹ *)
˘x
;

529 if–
pC§
 ){

530 
	`lsm_c§_˛o£
(
pC§
->
c§
);

531 
	`ck‰ì
((*)
pC§
);

533 
	}
}

535 
	$ã°_lsm_dñ
(*
˘x
){

536 
T˛Lsm
 *
p
 = (T˛Lsm *)
˘x
;

537 if–
p
 ){

538 
	`lsm_˛o£
(
p
->
db
);

539 
	`ck‰ì
((*)
p
);

541 
	}
}

543 
	$ã°InfoLsm
(
T˛_I¡îp
 *
öãΩ
, 
lsm_db
 *
db
, 
T˛_Obj
 *
pObj
){

544 
	sLsmöfo
 {

545 c⁄° *
zO±
;

546 
eO±
;

547 } 
aInfo
[] = {

548 { "com¥essi⁄_id", 
LSM_INFO_COMPRESSION_ID
 },

551 
rc
;

552 
iO±
;

554 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

555 
öãΩ
, 
pObj
, 
aInfo
, ◊Info[0]), "›ti⁄", 0, &
iO±


557 if–
rc
==
LSM_OK
 ){

558  
aInfo
[
iO±
].
eO±
 ){

559 
LSM_INFO_COMPRESSION_ID
: {

560 
iCmpId
 = 0;

561 
rc
 = 
	`lsm_öfo
(
db
, 
LSM_INFO_COMPRESSION_ID
, &
iCmpId
);

562 if–
rc
==
LSM_OK
 ){

563 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewWideI¡Obj
((
T˛_WideI¡
)
iCmpId
));

565 
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_öfo", 
rc
);

572  
rc
;

573 
	}
}

578 
	$ã°_lsm_curs‹_cmd
(

579 * 
˛õ¡D©a
,

580 
T˛_I¡îp
 *
öãΩ
,

581 
objc
,

582 
T˛_Obj
 *
CONST
 
objv
[]

584 
	sSubcmd
 {

585 c⁄° *
zCmd
;

586 
nArg
;

587 c⁄° *
zUßge
;

588 } 
aCmd
[] = {

600 
iCmd
;

601 
rc
;

602 
T˛LsmCurs‹
 *
pC§
 = (T˛LsmCurs‹ *)
˛õ¡D©a
;

604 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

605 
öãΩ
, 
objv
[1], 
aCmd
, ◊Cmd[0]), "sub-comm™d", 0, &
iCmd


607 if–
rc
!=
TCL_OK
 ) Ñc;

608 if–
aCmd
[
iCmd
].
nArg
>=0 && 
objc
!=(2 +áCmd[iCmd].nArg) ){

609 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, 
aCmd
[
iCmd
].
zUßge
);

610  
TCL_ERROR
;

613  
iCmd
 ){

615 0: 
	`as£π
–0==
	`°rcmp
(
aCmd
[0].
zCmd
, "close") ); {

616 
	`T˛_DñëeComm™d
(
öãΩ
, 
	`T˛_GëSåögFromObj
(
objv
[0], 0));

617  
TCL_OK
;

620 1: 
	`as£π
–0==
	`°rcmp
(
aCmd
[1].
zCmd
, "seek") ); {

621 
	sSìkbüs
 {

622 c⁄° *
zBüs
;

623 
eBüs
;

624 } 
aBüs
[] = {

625 {"eq", 
LSM_SEEK_EQ
},

626 {"À", 
LSM_SEEK_LE
},

627 {"ÀÁ°", 
LSM_SEEK_LEFAST
},

628 {"ge", 
LSM_SEEK_GE
},

631 
iBüs
;

632 c⁄° *
zKey
; 
nKey
;

633 
zKey
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
nKey
);

635 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

636 
öãΩ
, 
objv
[3], 
aBüs
, ◊Büs[0]), "büs", 0, &
iBüs


638 if–
rc
!=
TCL_OK
 ) Ñc;

640 
rc
 = 
	`lsm_c§_£ek
(
pC§
->
c§
, 
zKey
, 
nKey
, 
aBüs
[
iBüs
].
eBüs
);

641  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_£ek", 
rc
);

648 c⁄° *
zApi
;

650 
	`as£π
–0==
	`°rcmp
(
aCmd
[2].
zCmd
, "first") );

651 
	`as£π
–0==
	`°rcmp
(
aCmd
[3].
zCmd
, "last") );

652 
	`as£π
–0==
	`°rcmp
(
aCmd
[4].
zCmd
, "next") );

653 
	`as£π
–0==
	`°rcmp
(
aCmd
[5].
zCmd
, "prev") );

655  
iCmd
 ){

656 2: 
rc
 = 
	`lsm_c§_fú°
(
pC§
->
c§
); 
zApi
 = "lsm_csr_first"; ;

657 3: 
rc
 = 
	`lsm_c§_œ°
(
pC§
->
c§
); 
zApi
 = "lsm_csr_last"; ;

658 4: 
rc
 = 
	`lsm_c§_√xt
(
pC§
->
c§
); 
zApi
 = "lsm_csr_next"; ;

659 5: 
rc
 = 
	`lsm_c§_¥ev
(
pC§
->
c§
); 
zApi
 = "lsm_csr_prev"; ;

662  
	`ã°_lsm_îr‹
(
öãΩ
, 
zApi
, 
rc
);

665 6: 
	`as£π
–0==
	`°rcmp
(
aCmd
[6].
zCmd
, "key") ); {

666 c⁄° *
pKey
; 
nKey
;

667 
rc
 = 
	`lsm_c§_key
(
pC§
->
c§
, &
pKey
, &
nKey
);

668 if–
rc
!=
LSM_OK
 ) 
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_csr_key",Ñc);

670 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
((c⁄° *)
pKey
, 
nKey
));

671  
TCL_OK
;

674 7: 
	`as£π
–0==
	`°rcmp
(
aCmd
[7].
zCmd
, "value") ); {

675 c⁄° *
pVÆ
; 
nVÆ
;

676 
rc
 = 
	`lsm_c§_vÆue
(
pC§
->
c§
, &
pVÆ
, &
nVÆ
);

677 if–
rc
!=
LSM_OK
 ) 
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_csr_value",Ñc);

679 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
((c⁄° *)
pVÆ
, 
nVÆ
));

680  
TCL_OK
;

683 8: 
	`as£π
–0==
	`°rcmp
(
aCmd
[8].
zCmd
, "valid") ); {

684 
bVÆid
 = 
	`lsm_c§_vÆid
(
pC§
->
c§
);

685 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
bVÆid
));

686  
TCL_OK
;

690 
	`T˛_AµídResu…
(
öãΩ
, "internalÉrror", 0);

691  
TCL_ERROR
;

692 
	}
}

697 
	$ã°_lsm_cmd
(

698 * 
˛õ¡D©a
,

699 
T˛_I¡îp
 *
öãΩ
,

700 
objc
,

701 
T˛_Obj
 *
CONST
 
objv
[]

703 
	sSubcmd
 {

704 c⁄° *
zCmd
;

705 
nArg
;

706 c⁄° *
zUßge
;

707 } 
aCmd
[] = {

723 
iCmd
;

724 
rc
;

725 
T˛Lsm
 *
p
 = (T˛Lsm *)
˛õ¡D©a
;

727 if–
objc
<2 ){

728 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SUB-COMMAND ...");

729  
TCL_ERROR
;

732 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

733 
öãΩ
, 
objv
[1], 
aCmd
, ◊Cmd[0]), "sub-comm™d", 0, &
iCmd


735 if–
rc
!=
TCL_OK
 ) Ñc;

736 if–
aCmd
[
iCmd
].
nArg
>=0 && 
objc
!=(2 +áCmd[iCmd].nArg) ){

737 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, 
aCmd
[
iCmd
].
zUßge
);

738  
TCL_ERROR
;

741  
iCmd
 ){

743 0: 
	`as£π
–0==
	`°rcmp
(
aCmd
[0].
zCmd
, "close") ); {

744 
	`T˛_DñëeComm™d
(
öãΩ
, 
	`T˛_GëSåögFromObj
(
objv
[0], 0));

745  
TCL_OK
;

748 1: 
	`as£π
–0==
	`°rcmp
(
aCmd
[1].
zCmd
, "write") ); {

749 c⁄° *
zKey
; 
nKey
;

750 c⁄° *
zVÆ
; 
nVÆ
;

752 
zKey
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
nKey
);

753 
zVÆ
 = 
	`T˛_GëSåögFromObj
(
objv
[3], &
nVÆ
);

755 
rc
 = 
	`lsm_ö£π
(
p
->
db
, 
zKey
, 
nKey
, 
zVÆ
, 
nVÆ
);

756  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_ö£π", 
rc
);

759 2: 
	`as£π
–0==
	`°rcmp
(
aCmd
[2].
zCmd
, "delete") ); {

760 c⁄° *
zKey
; 
nKey
;

762 
zKey
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
nKey
);

764 
rc
 = 
	`lsm_dñëe
(
p
->
db
, 
zKey
, 
nKey
);

765  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_dñëe", 
rc
);

768 3: 
	`as£π
–0==
	`°rcmp
(
aCmd
[3].
zCmd
, "delete_range") ); {

769 c⁄° *
zKey1
; 
nKey1
;

770 c⁄° *
zKey2
; 
nKey2
;

772 
zKey1
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
nKey1
);

773 
zKey2
 = 
	`T˛_GëSåögFromObj
(
objv
[3], &
nKey2
);

775 
rc
 = 
	`lsm_dñëe_ønge
(
p
->
db
, 
zKey1
, 
nKey1
, 
zKey2
, 
nKey2
);

776  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_dñëe_ønge", 
rc
);

782 c⁄° *
zApi
;

783 
iLevñ
;

785 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
iLevñ
);

786 if–
rc
!=
TCL_OK
 ) Ñc;

788 
	`as£π
–0==
	`°rcmp
(
aCmd
[4].
zCmd
, "begin") );

789 
	`as£π
–0==
	`°rcmp
(
aCmd
[5].
zCmd
, "commit") );

790 
	`as£π
–0==
	`°rcmp
(
aCmd
[6].
zCmd
, "rollback") );

791  
iCmd
 ){

792 4: 
rc
 = 
	`lsm_begö
(
p
->
db
, 
iLevñ
); 
zApi
 = "lsm_begin"; ;

793 5: 
rc
 = 
	`lsm_commô
(
p
->
db
, 
iLevñ
); 
zApi
 = "lsm_commit"; ;

794 6: 
rc
 = 
	`lsm_rﬁlback
(
p
->
db
, 
iLevñ
); 
zApi
 = "lsm_rollback"; ;

797  
	`ã°_lsm_îr‹
(
öãΩ
, 
zApi
, 
rc
);

800 7: 
	`as£π
–0==
	`°rcmp
(
aCmd
[7].
zCmd
, "csr_open") ); {

801 c⁄° *
zC§
 = 
	`T˛_GëSåög
(
objv
[2]);

802 
T˛LsmCurs‹
 *
pC§
;

804 
pC§
 = (
T˛LsmCurs‹
 *)
	`ckÆloc
((TclLsmCursor));

805 
rc
 = 
	`lsm_c§_›í
(
p
->
db
, &
pC§
->
c§
);

806 if–
rc
!=
LSM_OK
 ){

807 
	`ã°_lsm_curs‹_dñ
(
pC§
);

808  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_c§_›í", 
rc
);

811 
	`T˛_Cª©eObjComm™d
(

812 
öãΩ
, 
zC§
, 
ã°_lsm_curs‹_cmd
,

813 (
Clõ¡D©a
)
pC§
, 
ã°_lsm_curs‹_dñ


815 
	`T˛_SëObjResu…
(
öãΩ
, 
objv
[2]);

816  
TCL_OK
;

819 8: 
	`as£π
–0==
	`°rcmp
(
aCmd
[8].
zCmd
, "work") ); {

820 
nW‹k
 = 0;

821 
nMîge
 = 1;

822 
nWrôe
 = 0;

824 if–
objc
==3 ){

825 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
nW‹k
);

826 }if–
objc
==4 ){

827 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
nMîge
);

828 if–
rc
!=
TCL_OK
 ) Ñc;

829 
rc
 = 
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
nW‹k
);

831 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "?NMERGE? NWRITE");

832  
TCL_ERROR
;

834 if–
rc
!=
TCL_OK
 ) Ñc;

836 
rc
 = 
	`lsm_w‹k
(
p
->
db
, 
nMîge
, 
nW‹k
, &
nWrôe
);

837 if–
rc
!=
LSM_OK
 )  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_work",Ñc);

838 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
nWrôe
));

839  
TCL_OK
;

842 9: 
	`as£π
–0==
	`°rcmp
(
aCmd
[9].
zCmd
, "flush") ); {

843 
rc
 = 
	`lsm_Êush
(
p
->
db
);

844  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_Êush", 
rc
);

847 10: 
	`as£π
–0==
	`°rcmp
(
aCmd
[10].
zCmd
, "config") ); {

848 
T˛_Obj
 **
≠Obj
;

849 
nObj
;

850 if–
TCL_OK
==
	`T˛_Li°ObjGëEÀmíts
(
öãΩ
, 
objv
[2], &
nObj
, &
≠Obj
) ){

851  
	`ã°C⁄figuªLsm
(
öãΩ
, 
p
->
db
, 
nObj
, 
≠Obj
);

853  
TCL_ERROR
;

856 11: 
	`as£π
–0==
	`°rcmp
(
aCmd
[11].
zCmd
, "checkpoint") ); {

857 
rc
 = 
	`lsm_checkpoöt
(
p
->
db
, 0);

858  
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_checkpoöt", 
rc
);

861 12: 
	`as£π
–0==
	`°rcmp
(
aCmd
[12].
zCmd
, "info") ); {

862  
	`ã°InfoLsm
(
öãΩ
, 
p
->
db
, 
objv
[2]);

866 
	`as£π
( 0 );

869 
	`T˛_AµídResu…
(
öãΩ
, "internalÉrror", 0);

870  
TCL_ERROR
;

871 
	}
}

873 
	$xLog
(*
pCtx
, 
rc
, c⁄° *
z
){

874 ()(
rc
);

875 ()(
pCtx
);

876 
	`Ârötf
(
°dîr
, "%s\n", 
z
);

877 
	`fÊush
(
°dîr
);

878 
	}
}

883 
	$ã°_lsm_›í
(

884 * 
˛õ¡D©a
,

885 
T˛_I¡îp
 *
öãΩ
,

886 
objc
,

887 
T˛_Obj
 *
CONST
 
objv
[]

889 
T˛Lsm
 *
p
;

890 
rc
;

891 c⁄° *
zDb
 = 0;

892 c⁄° *
zFûe
 = 0;

894 if–
objc
!=3 && objc!=4 ){

895 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB FILENAME ?CONFIG?");

896  
TCL_ERROR
;

899 
zDb
 = 
	`T˛_GëSåög
(
objv
[1]);

900 
zFûe
 = 
	`T˛_GëSåög
(
objv
[2]);

902 
p
 = (
T˛Lsm
 *)
	`ckÆloc
((TclLsm));

903 
rc
 = 
	`lsm_√w
(0, &
p
->
db
);

904 if–
rc
!=
LSM_OK
 ){

905 
	`ã°_lsm_dñ
((*)
p
);

906 
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_√w", 
rc
);

907  
TCL_ERROR
;

910 if–
objc
==4 ){

911 
T˛_Obj
 **
≠Obj
;

912 
nObj
;

913 
rc
 = 
	`T˛_Li°ObjGëEÀmíts
(
öãΩ
, 
objv
[3], &
nObj
, &
≠Obj
);

914 if–
rc
==
TCL_OK
 ){

915 
rc
 = 
	`ã°C⁄figuªLsm
(
öãΩ
, 
p
->
db
, 
nObj
, 
≠Obj
);

917 if–
rc
!=
TCL_OK
 ){

918 
	`ã°_lsm_dñ
((*)
p
);

919  
rc
;

923 
	`lsm_c⁄fig_log
(
p
->
db
, 
xLog
, 0);

925 
rc
 = 
	`lsm_›í
(
p
->
db
, 
zFûe
);

926 if–
rc
!=
LSM_OK
 ){

927 
	`ã°_lsm_dñ
((*)
p
);

928 
	`ã°_lsm_îr‹
(
öãΩ
, "lsm_›í", 
rc
);

929  
TCL_ERROR
;

932 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
zDb
, 
ã°_lsm_cmd
, (
Clõ¡D©a
)
p
, 
ã°_lsm_dñ
);

933 
	`T˛_SëObjResu…
(
öãΩ
, 
objv
[1]);

934  
TCL_OK
;

935 
	}
}

937 
	$Sqlôëe°Lsm_Inô
(
T˛_I¡îp
 *
öãΩ
){

938 
	sSysˇŒCmd
 {

939 c⁄° *
zName
;

940 
T˛_ObjCmdProc
 *
xCmd
;

941 } 
aCmd
[] = {

942 { "sqlôe4_lsm_w‹k", 
ã°_sqlôe4_lsm_w‹k
 },

943 { "sqlôe4_lsm_checkpoöt", 
ã°_sqlôe4_lsm_checkpoöt
 },

944 { "sqlôe4_lsm_öfo", 
ã°_sqlôe4_lsm_öfo
 },

945 { "sqlôe4_lsm_c⁄fig", 
ã°_sqlôe4_lsm_c⁄fig
 },

946 { "lsm_›í", 
ã°_lsm_›í
 },

948 
i
;

950 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

951 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xCmd
, 0, 0);

953  
TCL_OK
;

954 
	}
}

	@test/test_main.c

16 
	~"sqlôeI¡.h
"

17 
	~"vdbeI¡.h
"

18 
	~"t˛.h
"

19 
	~"ã°I¡.h
"

20 
	~<°dlib.h
>

21 
	~<°rög.h
>

29 
	sSqlôeDb
 {

30 
sqlôe4
 *
	mdb
;

37 
	$ã°HexToI¡
(
h
){

38 if–
h
>='0' && h<='9' ){

39  
h
 - '0';

40 }if–
h
>='a' && h<='f' ){

41  
h
 - 'a' + 10;

43 
	`as£π
–
h
>='A' && h<='F' );

44  
h
 - 'A' + 10;

46 
	}
}

47 *
	$sqlôe4Te°TextToPå
(c⁄° *
z
){

48 *
p
;

49 
u64
 
v
;

50 
u32
 
v2
;

51 if–
z
[0]=='0' && z[1]=='x' ){

52 
z
 += 2;

54 
v
 = 0;

55  *
z
 ){

56 
v
 = (v<<4Ë+ 
	`ã°HexToI¡
(*
z
);

57 
z
++;

59 if–(
p
)==(
v
) ){

60 
	`mem˝y
(&
p
, &
v
, (p));

62 
	`as£π
–(
p
)==(
v2
) );

63 
v2
 = (
u32
)
v
;

64 
	`mem˝y
(&
p
, &
v2
, (p));

66  
p
;

67 
	}
}

75 
	$gë_sqlôe_poöãr
(

76 * 
˛õ¡D©a
,

77 
T˛_I¡îp
 *
öãΩ
,

78 
objc
,

79 
T˛_Obj
 *
CONST
 
objv
[]

81 
SqlôeDb
 *
p
;

82 
T˛_CmdInfo
 
cmdInfo
;

83 
zBuf
[100];

84 if–
objc
!=2 ){

85 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SQLITE-CONNECTION");

86  
TCL_ERROR
;

88 if–!
	`T˛_GëComm™dInfo
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
cmdInfo
) ){

89 
	`T˛_AµídResu…
(
öãΩ
, "commandÇot found: ",

90 
	`T˛_GëSåög
(
objv
[1]), (*)0);

91  
TCL_ERROR
;

93 
p
 = (
SqlôeDb
*)
cmdInfo
.
objClõ¡D©a
;

94 
	`•rötf
(
zBuf
, "%p", 
p
->
db
);

95 if–
	`°∫cmp
(
zBuf
,"0x",2) ){

96 
	`•rötf
(
zBuf
, "0x%p", 
p
->
db
);

98 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

99  
TCL_OK
;

100 
	}
}

105 
	$gëDbPoöãr
(
T˛_I¡îp
 *
öãΩ
, c⁄° *
zA
, 
sqlôe4
 **
µDb
){

106 
SqlôeDb
 *
p
;

107 
T˛_CmdInfo
 
cmdInfo
;

108 if–
	`T˛_GëComm™dInfo
(
öãΩ
, 
zA
, &
cmdInfo
) ){

109 
p
 = (
SqlôeDb
*)
cmdInfo
.
objClõ¡D©a
;

110 *
µDb
 = 
p
->
db
;

112 *
µDb
 = (
sqlôe4
*)
	`sqlôe4Te°TextToPå
(
zA
);

114  
TCL_OK
;

115 
	}
}

117 
	$sqlôe4Te°DbH™dÀ
(
T˛_I¡îp
 *
öãΩ
, 
T˛_Obj
 *
pObj
, 
sqlôe4
 **
µDb
){

118  
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
pObj
), 
µDb
);

119 
	}
}

121 c⁄° *
	$sqlôe4Te°Eº‹Name
(
rc
){

122 c⁄° *
zName
 = 0;

123  
rc
 ){

124 
SQLITE4_OK
: 
zName
 = "SQLITE4_OK"; ;

125 
SQLITE4_ERROR
: 
zName
 = "SQLITE4_ERROR"; ;

126 
SQLITE4_INTERNAL
: 
zName
 = "SQLITE4_INTERNAL"; ;

127 
SQLITE4_PERM
: 
zName
 = "SQLITE4_PERM"; ;

128 
SQLITE4_ABORT
: 
zName
 = "SQLITE4_ABORT"; ;

129 
SQLITE4_BUSY
: 
zName
 = "SQLITE4_BUSY"; ;

130 
SQLITE4_LOCKED
: 
zName
 = "SQLITE4_LOCKED"; ;

131 
SQLITE4_LOCKED_SHAREDCACHE
: 
zName
 = "SQLITE4_LOCKED_SHAREDCACHE";;

132 
SQLITE4_NOMEM
: 
zName
 = "SQLITE4_NOMEM"; ;

133 
SQLITE4_READONLY
: 
zName
 = "SQLITE4_READONLY"; ;

134 
SQLITE4_INTERRUPT
: 
zName
 = "SQLITE4_INTERRUPT"; ;

135 
SQLITE4_IOERR
: 
zName
 = "SQLITE4_IOERR"; ;

136 
SQLITE4_CORRUPT
: 
zName
 = "SQLITE4_CORRUPT"; ;

137 
SQLITE4_NOTFOUND
: 
zName
 = "SQLITE4_NOTFOUND"; ;

138 
SQLITE4_FULL
: 
zName
 = "SQLITE4_FULL"; ;

139 
SQLITE4_CANTOPEN
: 
zName
 = "SQLITE4_CANTOPEN"; ;

140 
SQLITE4_PROTOCOL
: 
zName
 = "SQLITE4_PROTOCOL"; ;

141 
SQLITE4_EMPTY
: 
zName
 = "SQLITE4_EMPTY"; ;

142 
SQLITE4_SCHEMA
: 
zName
 = "SQLITE4_SCHEMA"; ;

143 
SQLITE4_TOOBIG
: 
zName
 = "SQLITE4_TOOBIG"; ;

144 
SQLITE4_CONSTRAINT
: 
zName
 = "SQLITE4_CONSTRAINT"; ;

145 
SQLITE4_MISMATCH
: 
zName
 = "SQLITE4_MISMATCH"; ;

146 
SQLITE4_MISUSE
: 
zName
 = "SQLITE4_MISUSE"; ;

147 
SQLITE4_NOLFS
: 
zName
 = "SQLITE4_NOLFS"; ;

148 
SQLITE4_AUTH
: 
zName
 = "SQLITE4_AUTH"; ;

149 
SQLITE4_FORMAT
: 
zName
 = "SQLITE4_FORMAT"; ;

150 
SQLITE4_RANGE
: 
zName
 = "SQLITE4_RANGE"; ;

151 
SQLITE4_NOTADB
: 
zName
 = "SQLITE4_NOTADB"; ;

152 
SQLITE4_ROW
: 
zName
 = "SQLITE4_ROW"; ;

153 
SQLITE4_DONE
: 
zName
 = "SQLITE4_DONE"; ;

154 
SQLITE4_INEXACT
: 
zName
 = "SQLITE4_INEXACT"; ;

155 
SQLITE4_IOERR_READ
: 
zName
 = "SQLITE4_IOERR_READ"; ;

156 
SQLITE4_IOERR_SHORT_READ
: 
zName
 = "SQLITE4_IOERR_SHORT_READ"; ;

157 
SQLITE4_IOERR_WRITE
: 
zName
 = "SQLITE4_IOERR_WRITE"; ;

158 
SQLITE4_IOERR_FSYNC
: 
zName
 = "SQLITE4_IOERR_FSYNC"; ;

159 
SQLITE4_IOERR_DIR_FSYNC
: 
zName
 = "SQLITE4_IOERR_DIR_FSYNC"; ;

160 
SQLITE4_IOERR_TRUNCATE
: 
zName
 = "SQLITE4_IOERR_TRUNCATE"; ;

161 
SQLITE4_IOERR_FSTAT
: 
zName
 = "SQLITE4_IOERR_FSTAT"; ;

162 
SQLITE4_IOERR_UNLOCK
: 
zName
 = "SQLITE4_IOERR_UNLOCK"; ;

163 
SQLITE4_IOERR_RDLOCK
: 
zName
 = "SQLITE4_IOERR_RDLOCK"; ;

164 
SQLITE4_IOERR_DELETE
: 
zName
 = "SQLITE4_IOERR_DELETE"; ;

165 
SQLITE4_IOERR_BLOCKED
: 
zName
 = "SQLITE4_IOERR_BLOCKED"; ;

166 
SQLITE4_IOERR_NOMEM
: 
zName
 = "SQLITE4_IOERR_NOMEM"; ;

167 
SQLITE4_IOERR_ACCESS
: 
zName
 = "SQLITE4_IOERR_ACCESS"; ;

168 
SQLITE4_IOERR_CHECKRESERVEDLOCK
:

169 
zName
 = "SQLITE4_IOERR_CHECKRESERVEDLOCK"; ;

170 
SQLITE4_IOERR_LOCK
: 
zName
 = "SQLITE4_IOERR_LOCK"; ;

171 
SQLITE4_CORRUPT_VTAB
: 
zName
 = "SQLITE4_CORRUPT_VTAB"; ;

172 
SQLITE4_READONLY_RECOVERY
: 
zName
 = "SQLITE4_READONLY_RECOVERY"; ;

173 
SQLITE4_READONLY_CANTLOCK
: 
zName
 = "SQLITE4_READONLY_CANTLOCK"; ;

174 : 
zName
 = "SQLITE4_Unknown"; ;

176  
zName
;

177 
	}
}

178 
	#t1Eº‹Name
 
sqlôe4Te°Eº‹Name


	)

180 
	$sqlôe4Te°SëResu…
(
T˛_I¡îp
 *
öãΩ
, 
rc
){

181 c⁄° *
z
 = 
	`sqlôe4Te°Eº‹Name
(
rc
);

182 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
z
, -1));

183  
TCL_OK
;

184 
	}
}

190 
	#StmtToDb
(
X
Ë
	`sqlôe4_db_h™dÀ
(X)

	)

196 
	$sqlôe4Te°EºCode
(
T˛_I¡îp
 *
öãΩ
, 
sqlôe4
 *
db
, 
rc
){

197 if–
rc
!=
SQLITE4_MISUSE
 &&Ñc!=
SQLITE4_OK
 && 
	`sqlôe4_îrcode
(
db
)!=rc ){

198 
zBuf
[200];

199 
r2
 = 
	`sqlôe4_îrcode
(
db
);

200 
	`•rötf
(
zBuf
, "error code %s (%d) doesÇot match sqlite4_errcode %s (%d)",

201 
	`t1Eº‹Name
(
rc
),Ñc,Å1Eº‹Name(
r2
),Ñ2);

202 
	`T˛_Re£tResu…
(
öãΩ
);

203 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

207 
	}
}

212 
	$gëStmtPoöãr
(

213 
T˛_I¡îp
 *
öãΩ
,

214 c⁄° *
zArg
,

215 
sqlôe4_°mt
 **
µStmt


217 *
µStmt
 = (
sqlôe4_°mt
*)
	`sqlôe4Te°TextToPå
(
zArg
);

218  
TCL_OK
;

219 
	}
}

234 
	$sqlôe4Te°MakePoöãrSå
(
T˛_I¡îp
 *
öãΩ
, *
zPå
, *
p
){

235 
	`sqlôe4_¢¥ötf
(
zPå
, 100, "%p", 
p
);

236  
TCL_OK
;

237 
	}
}

242 
	$exec_¥ötf_cb
(

243 *
pArg
,

244 
nVÆ
,

245 
sqlôe4_vÆue
 **
≠VÆ
,

246 c⁄° **
azCﬁ


248 
T˛_DSåög
 *
°r
 = (T˛_DSåög*)
pArg
;

249 
i
;

251 if–
	`T˛_DSåögLígth
(
°r
)==0 ){

252 
i
=0; i<
nVÆ
; i++){

253 
	`T˛_DSåögAµídEÀmít
(
°r
, 
azCﬁ
[
i
] ?ázCol[i] : "NULL");

256 
i
=0; i<
nVÆ
; i++){

257 c⁄° *
z
 = 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[
i
], 0);

258 
	`T˛_DSåögAµídEÀmít
(
°r
, 
z
 ? z : "NULL");

261 
	}
}

266 #i‡!
deföed
(
SQLITE4_OMIT_TRACE
Ë&& deföed(
SQLITE4_ENABLE_IOTRACE
)

267 
FILE
 *
	giŸø˚_fûe
 = 0;

268 
	$io_åa˚_ˇŒback
(c⁄° *
zF‹m©
, ...){

269 
va_li°
 
≠
;

270 
	`va_°¨t
(
≠
, 
zF‹m©
);

271 
	`vÂrötf
(
iŸø˚_fûe
, 
zF‹m©
, 
≠
);

272 
	`va_íd
(
≠
);

273 
	`fÊush
(
iŸø˚_fûe
);

274 
	}
}

284 
	$ã°_io_åa˚
(

285 *
NŸU£d
,

286 
T˛_I¡îp
 *
öãΩ
,

287 
¨gc
,

288 **
¨gv


290 #i‡!
	`deföed
(
SQLITE4_OMIT_TRACE
Ë&& deföed(
SQLITE4_ENABLE_IOTRACE
)

291 if–
¨gc
!=2 ){

292 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

294  
TCL_ERROR
;

296 if–
iŸø˚_fûe
 ){

297 if–
iŸø˚_fûe
!=
°dout
 && iŸø˚_fûe!=
°dîr
 ){

298 
	`f˛o£
(
iŸø˚_fûe
);

300 
iŸø˚_fûe
 = 0;

301 
sqlôe4IoTø˚
 = 0;

303 if–
¨gv
[1][0] ){

304 if–
	`°rcmp
(
¨gv
[1],"stdout")==0 ){

305 
iŸø˚_fûe
 = 
°dout
;

306 }if–
	`°rcmp
(
¨gv
[1],"stderr")==0 ){

307 
iŸø˚_fûe
 = 
°dîr
;

309 
iŸø˚_fûe
 = 
	`f›í
(
¨gv
[1], "w");

311 
sqlôe4IoTø˚
 = 
io_åa˚_ˇŒback
;

314  
TCL_OK
;

315 
	}
}

325 
	$ã°_exec_¥ötf
(

326 *
NŸU£d
,

327 
T˛_I¡îp
 *
öãΩ
,

328 
¨gc
,

329 **
¨gv


331 
sqlôe4
 *
db
;

332 
T˛_DSåög
 
°r
;

333 
rc
;

334 *
zSql
;

335 
zBuf
[30];

336 if–
¨gc
!=4 ){

337 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

339  
TCL_ERROR
;

341 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

342 
	`T˛_DSåögInô
(&
°r
);

343 
zSql
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[2],árgv[3]);

344 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
exec_¥ötf_cb
, &
°r
);

345 
	`sqlôe4_‰ì
(0, 
zSql
);

346 
	`•rötf
(
zBuf
, "%d", 
rc
);

347 
	`T˛_AµídEÀmít
(
öãΩ
, 
zBuf
);

348 
	`T˛_AµídEÀmít
(
öãΩ
, !
rc
 ? 
	`T˛_DSåögVÆue
(&
°r
Ë: 
	`sqlôe4_îrmsg
(
db
));

349 
	`T˛_DSåögFªe
(&
°r
);

350 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

351  
TCL_OK
;

352 
	}
}

361 
	$ã°_exec_hex
(

362 *
NŸU£d
,

363 
T˛_I¡îp
 *
öãΩ
,

364 
¨gc
,

365 **
¨gv


367 
sqlôe4
 *
db
;

368 
T˛_DSåög
 
°r
;

369 
rc
, 
i
, 
j
;

370 *
zHex
;

371 
zSql
[500];

372 
zBuf
[30];

373 if–
¨gc
!=3 ){

374 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

376  
TCL_ERROR
;

378 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

379 
zHex
 = 
¨gv
[2];

380 
i
=
j
=0; i<(
zSql
Ë&& 
zHex
[j]; i++, j++){

381 if–
zHex
[
j
]=='%' && zHex[j+2] && zHex[j+2] ){

382 
zSql
[
i
] = (
	`ã°HexToI¡
(
zHex
[
j
+1])<<4) +ÅestHexToInt(zHex[j+2]);

383 
j
 += 2;

385 
zSql
[
i
] = 
zHex
[
j
];

388 
zSql
[
i
] = 0;

389 
	`T˛_DSåögInô
(&
°r
);

390 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
exec_¥ötf_cb
, &
°r
);

391 
	`•rötf
(
zBuf
, "%d", 
rc
);

392 
	`T˛_AµídEÀmít
(
öãΩ
, 
zBuf
);

393 
	`T˛_AµídEÀmít
(
öãΩ
, !
rc
 ? 
	`T˛_DSåögVÆue
(&
°r
Ë: 
	`sqlôe4_îrmsg
(
db
));

394 
	`T˛_DSåögFªe
(&
°r
);

395 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

396  
TCL_OK
;

397 
	}
}

405 
	$db_íãr
(

406 *
NŸU£d
,

407 
T˛_I¡îp
 *
öãΩ
,

408 
¨gc
,

409 **
¨gv


411 
sqlôe4
 *
db
;

412 if–
¨gc
!=2 ){

413 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

415  
TCL_ERROR
;

417 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

418 
	`sqlôe4_muãx_íãr
(
db
->
muãx
);

419  
TCL_OK
;

420 
	}
}

421 
	$db_Àave
(

422 *
NŸU£d
,

423 
T˛_I¡îp
 *
öãΩ
,

424 
¨gc
,

425 **
¨gv


427 
sqlôe4
 *
db
;

428 if–
¨gc
!=2 ){

429 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

431  
TCL_ERROR
;

433 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

434 
	`sqlôe4_muãx_Àave
(
db
->
muãx
);

435  
TCL_OK
;

436 
	}
}

443 
	$ã°_exec
(

444 *
NŸU£d
,

445 
T˛_I¡îp
 *
öãΩ
,

446 
¨gc
,

447 **
¨gv


449 
sqlôe4
 *
db
;

450 
T˛_DSåög
 
°r
;

451 
rc
;

452 *
zSql
;

453 
i
, 
j
;

454 
zBuf
[30];

455 if–
¨gc
!=3 ){

456 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

458  
TCL_ERROR
;

460 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

461 
	`T˛_DSåögInô
(&
°r
);

462 
zSql
 = 
	`sqlôe4_m¥ötf
(0, "%s", 
¨gv
[2]);

463 
i
=
j
=0; 
zSql
[i];){

464 if–
zSql
[
i
]=='%' ){

465 
zSql
[
j
++] = (
	`ã°HexToI¡
(zSql[
i
+1])<<4) +ÅestHexToInt(zSql[i+2]);

466 
i
 += 3;

468 
zSql
[
j
++] = zSql[
i
++];

471 
zSql
[
j
] = 0;

472 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
exec_¥ötf_cb
, &
°r
);

473 
	`sqlôe4_‰ì
(0, 
zSql
);

474 
	`•rötf
(
zBuf
, "%d", 
rc
);

475 
	`T˛_AµídEÀmít
(
öãΩ
, 
zBuf
);

476 
	`T˛_AµídEÀmít
(
öãΩ
, !
rc
 ? 
	`T˛_DSåögVÆue
(&
°r
Ë: 
	`sqlôe4_îrmsg
(
db
));

477 
	`T˛_DSåögFªe
(&
°r
);

478 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

479  
TCL_OK
;

480 
	}
}

488 
	$ã°_exec_ƒ
(

489 *
NŸU£d
,

490 
T˛_I¡îp
 *
öãΩ
,

491 
¨gc
,

492 **
¨gv


494 
sqlôe4
 *
db
;

495 
rc
;

496 if–
¨gc
!=3 ){

497 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

499  
TCL_ERROR
;

501 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

502 
rc
 = 
	`sqlôe4_exec
(
db
, 
¨gv
[2], 0, 0);

503 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

504  
TCL_OK
;

505 
	}
}

514 
	$ã°_m¥ötf_z
(

515 *
NŸU£d
,

516 
T˛_I¡îp
 *
öãΩ
,

517 
¨gc
,

518 **
¨gv


520 *
zResu…
 = 0;

521 
i
;

523 
i
=2; i<
¨gc
 && (i==2 || 
zResu…
); i++){

524 
zResu…
 = 
	`sqlôe4_m¥ötf
(0, "%z%s%s", zResu…, 
¨gv
[1],árgv[
i
]);

526 
	`T˛_AµídResu…
(
öãΩ
, 
zResu…
, 0);

527 
	`sqlôe4_‰ì
(0, 
zResu…
);

528  
TCL_OK
;

529 
	}
}

537 
	$ã°_m¥ötf_n
(

538 *
NŸU£d
,

539 
T˛_I¡îp
 *
öãΩ
,

540 
¨gc
,

541 **
¨gv


543 *
zSå
;

544 
n
 = 0;

545 
zSå
 = 
	`sqlôe4_m¥ötf
(0, "%s%n", 
¨gv
[1], &
n
);

546 
	`sqlôe4_‰ì
(0, 
zSå
);

547 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
n
));

548  
TCL_OK
;

549 
	}
}

561 
	$ã°_¢¥ötf_öt
(

562 *
NŸU£d
,

563 
T˛_I¡îp
 *
öãΩ
,

564 
¨gc
,

565 **
¨gv


567 
zSå
[100];

568 
n
 = 
	`©oi
(
¨gv
[1]);

569 c⁄° *
zF‹m©
 = 
¨gv
[2];

570 
a1
 = 
	`©oi
(
¨gv
[3]);

571 if–
n
>(
zSå
) )Ç = (zStr);

572 
	`sqlôe4_¢¥ötf
(
zSå
, (zStr), "abcdefghijklmnopqrstuvwxyz");

573 
	`sqlôe4_¢¥ötf
(
zSå
, 
n
, 
zF‹m©
, 
a1
);

574 
	`T˛_AµídResu…
(
öãΩ
, 
zSå
, 0);

575  
TCL_OK
;

576 
	}
}

584 
	$ã°_key
(

585 *
NŸU£d
,

586 
T˛_I¡îp
 *
öãΩ
,

587 
¨gc
,

588 **
¨gv


590 #ifde‡
SQLITE4_HAS_CODEC


591 
sqlôe4
 *
db
;

592 c⁄° *
zKey
;

593 
nKey
;

594 if–
¨gc
!=3 ){

595 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

597  
TCL_ERROR
;

599 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

600 
zKey
 = 
¨gv
[2];

601 
nKey
 = 
	`°æí
(
zKey
);

602 
	`sqlôe4_key
(
db
, 
zKey
, 
nKey
);

604  
TCL_OK
;

605 
	}
}

612 
	$ã°_ªkey
(

613 *
NŸU£d
,

614 
T˛_I¡îp
 *
öãΩ
,

615 
¨gc
,

616 **
¨gv


618 #ifde‡
SQLITE4_HAS_CODEC


619 
sqlôe4
 *
db
;

620 c⁄° *
zKey
;

621 
nKey
;

622 if–
¨gc
!=3 ){

623 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

625  
TCL_ERROR
;

627 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

628 
zKey
 = 
¨gv
[2];

629 
nKey
 = 
	`°æí
(
zKey
);

630 
	`sqlôe4_ªkey
(
db
, 
zKey
, 
nKey
);

632  
TCL_OK
;

633 
	}
}

640 
	$sqlôe_ã°_˛o£
(

641 *
NŸU£d
,

642 
T˛_I¡îp
 *
öãΩ
,

643 
¨gc
,

644 **
¨gv


646 
sqlôe4
 *
db
;

647 
rc
;

648 if–
¨gc
!=2 ){

649 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

651  
TCL_ERROR
;

653 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

654 
rc
 = 
	`sqlôe4_˛o£
(
db
, 0);

655 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 
TCL_STATIC
);

656  
TCL_OK
;

657 
	}
}

663 
	$t1_i‚uŒFunc
(

664 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

665 
¨gc
,

666 
sqlôe4_vÆue
 **
¨gv


668 
i
;

669 
i
=0; i<
¨gc
; i++){

670 if–
SQLITE4_NULL
!=
	`sqlôe4_vÆue_ty≥
(
¨gv
[
i
]) ){

671 
n
;

672 c⁄° *
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], &
n
);

673 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
z
, 
n
, 
SQLITE4_TRANSIENT
, 0);

677 
	}
}

684 
	$hex8Func
(
sqlôe4_c⁄ãxt
 *
p
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

685 c⁄° *
z
;

686 
i
;

687 
zBuf
[200];

688 
z
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

689 
i
=0; i<(
zBuf
)/2 - 2 && 
z
[i]; i++){

690 
	`•rötf
(&
zBuf
[
i
*2], "%02x", 
z
[i]&0xff);

692 
zBuf
[
i
*2] = 0;

693 
	`sqlôe4_ªsu…_ãxt
(
p
, 
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

694 
	}
}

695 #i‚de‡
SQLITE4_OMIT_UTF16


696 
	$hex16Func
(
sqlôe4_c⁄ãxt
 *
p
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

697 c⁄° *
z
;

698 
i
;

699 
zBuf
[400];

700 
z
 = 
	`sqlôe4_vÆue_ãxt16
(
¨gv
[0], 0);

701 
i
=0; i<(
zBuf
)/4 - 4 && 
z
[i]; i++){

702 
	`•rötf
(&
zBuf
[
i
*4], "%04x", 
z
[i]&0xff);

704 
zBuf
[
i
*4] = 0;

705 
	`sqlôe4_ªsu…_ãxt
(
p
, (*)
zBuf
, -1, 
SQLITE4_TRANSIENT
, 0);

706 
	}
}

712 
	sd°r
 {

713 
	mnAŒoc
;

714 
	mnU£d
;

715 *
	mz
;

721 
	$d°rAµíd
(
d°r
 *
p
, c⁄° *
z
, 
dividî
){

722 
n
 = 
	`°æí
(
z
);

723 if–
p
->
nU£d
 + 
n
 + 2 >Ö->
nAŒoc
 ){

724 *
zNew
;

725 
p
->
nAŒoc
 =Ö->nAŒoc*2 + 
n
 + 200;

726 
zNew
 = 
	`sqlôe4_ªÆloc
(0, 
p
->
z
,Ö->
nAŒoc
);

727 if–
zNew
==0 ){

728 
	`sqlôe4_‰ì
(0, 
p
->
z
);

729 
	`mem£t
(
p
, 0, (*p));

732 
p
->
z
 = 
zNew
;

734 if–
dividî
 && 
p
->
nU£d
>0 ){

735 
p
->
z
[p->
nU£d
++] = 
dividî
;

737 
	`mem˝y
(&
p
->
z
[p->
nU£d
], z, 
n
+1);

738 
p
->
nU£d
 +
n
;

739 
	}
}

744 
	$execFuncCÆlback
(

745 *
pD©a
,

746 
nVÆ
,

747 
sqlôe4_vÆue
 **
≠VÆ
,

748 c⁄° **
azCﬁ


750 
d°r
 *
p
 = (d°r*)
pD©a
;

751 
i
;

752 
i
=0; i<
nVÆ
; i++){

753 if–
	`sqlôe4_vÆue_ty≥
(
≠VÆ
[
i
])==
SQLITE4_NULL
 ){

754 
	`d°rAµíd
(
p
, "NULL", ' ');

756 
	`d°rAµíd
(
p
, 
	`sqlôe4_vÆue_ãxt
(
≠VÆ
[
i
], 0), ' ');

760 
	}
}

773 
	$sqlôe4ExecFunc
(

774 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

775 
¨gc
,

776 
sqlôe4_vÆue
 **
¨gv


778 
d°r
 
x
;

779 
sqlôe4
 *
db
 = (sqlôe4 *)
	`sqlôe4_c⁄ãxt_≠pd©a
(
c⁄ãxt
);

780 c⁄° *
zSql
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

781 
	`mem£t
(&
x
, 0, (x));

782 ()
	`sqlôe4_exec
(
db
, 
zSql
, 
execFuncCÆlback
, &
x
);

783 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
x
.
z
, x.
nU£d
, 
SQLITE4_TRANSIENT
, 0);

784 
	`sqlôe4_‰ì
(0, 
x
.
z
);

785 
	}
}

803 
	$tkt2213Fun˘i⁄
(

804 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

805 
¨gc
,

806 
sqlôe4_vÆue
 **
¨gv


808 
nText
;

809 c⁄° *
zText1
;

810 c⁄° *
zText2
;

811 c⁄° *
zText3
;

813 
zText1
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], &
nText
);

814 
zText2
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

815 
zText3
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

817 if–
zText1
!=
zText2
 || zText2!=
zText3
 ){

818 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "tkt2213 isÇot fixed", -1);

820 *
zC›y
 = (*)
	`sqlôe4_mÆloc
(
	`sqlôe4_c⁄ãxt_ív
(
c⁄ãxt
),
nText
);

821 
	`mem˝y
(
zC›y
, 
zText1
, 
nText
);

822 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, 
zC›y
, 
nText
, 
SQLITE4_DYNAMIC
, 0);

824 
	}
}

841 
	$ã°_¸óã_fun˘i⁄
(

842 *
NŸU£d
,

843 
T˛_I¡îp
 *
öãΩ
,

844 
¨gc
,

845 **
¨gv


847 
rc
;

848 
sqlôe4
 *
db
;

850 if–
¨gc
!=2 ){

851 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

853  
TCL_ERROR
;

855 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

856 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "x_cﬂÀs˚", -1, 0, 
t1_i‚uŒFunc
, 0, 0, 0);

857 if–
rc
==
SQLITE4_OK
 ){

858 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "hex8", 1, 0, 
hex8Func
, 0, 0, 0);

860 #i‚de‡
SQLITE4_OMIT_UTF16


861 if–
rc
==
SQLITE4_OK
 ){

862 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "hex16", 1, 0, 
hex16Func
, 0, 0, 0);

865 if–
rc
==
SQLITE4_OK
 ){

866 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "tkt2213func", 1, 0,

867 
tkt2213Fun˘i⁄
, 0, 0, 0);

870 if–
rc
==
SQLITE4_OK
 ){

871 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(

872 
db
, "x_sqlôe_exec", 1, db, 
sqlôe4ExecFunc
, 0, 0, 0

876 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

877 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 0);

878  
TCL_OK
;

879 
	}
}

892 
t1Cou¡Ctx
 
	tt1Cou¡Ctx
;

893 
	st1Cou¡Ctx
 {

894 
	mn
;

896 
	$t1Cou¡Sãp
(

897 
sqlôe4_c⁄ãxt
 *
c⁄ãxt
,

898 
¨gc
,

899 
sqlôe4_vÆue
 **
¨gv


901 
t1Cou¡Ctx
 *
p
;

902 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*p));

903 if–(
¨gc
==0 || 
SQLITE4_NULL
!=
	`sqlôe4_vÆue_ty≥
(
¨gv
[0]ËË&& 
p
 ){

904 
p
->
n
++;

906 if–
¨gc
>0 ){

907 
v
 = 
	`sqlôe4_vÆue_öt
(
¨gv
[0]);

908 if–
v
==40 ){

909 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "value of 40 handedÅo x_count", -1);

910 #i‚de‡
SQLITE4_OMIT_UTF16


911 }if–
v
==41 ){

912 c⁄° 
zUtf16EºMsg
[] = { 0, 0x61, 0, 0x62, 0, 0x63, 0, 0, 0};

913 
	`sqlôe4_ªsu…_îr‹16
(
c⁄ãxt
, &
zUtf16EºMsg
[1-
SQLITE4_BIGENDIAN
], -1);

917 
	}
}

918 
	$t1Cou¡FöÆize
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
){

919 
t1Cou¡Ctx
 *
p
;

920 
p
 = 
	`sqlôe4_aggªg©e_c⁄ãxt
(
c⁄ãxt
, (*p));

921 if–
p
 ){

922 if–
p
->
n
==42 ){

923 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
, "x_countÅotalsÅo 42", -1);

925 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
p
 ?Ö->
n
 : 0);

928 
	}
}

949 
	$ã°_¸óã_aggªg©e
(

950 *
NŸU£d
,

951 
T˛_I¡îp
 *
öãΩ
,

952 
¨gc
,

953 **
¨gv


955 
sqlôe4
 *
db
;

956 
rc
;

957 if–
¨gc
!=2 ){

958 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

960  
TCL_ERROR
;

962 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

963 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "x_count", 0, 0, 0,

964 
t1Cou¡Sãp
, 
t1Cou¡FöÆize
, 0);

965 if–
rc
==
SQLITE4_OK
 ){

966 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "x_count", 1, 0, 0,

967 
t1Cou¡Sãp
, 
t1Cou¡FöÆize
, 0);

969 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

970 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 0);

971  
TCL_OK
;

972 
	}
}

983 
	$ã°_¥ötf
(

984 *
NŸU£d
,

985 
T˛_I¡îp
 *
öãΩ
,

986 
¨gc
,

987 **
¨gv


989 if–
¨gc
!=2 ){

990 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

992  
TCL_ERROR
;

994 
	`¥ötf
("%s\n", 
¨gv
[1]);

995  
TCL_OK
;

996 
	}
}

1005 
	$sqlôe4_m¥ötf_öt
(

1006 *
NŸU£d
,

1007 
T˛_I¡îp
 *
öãΩ
,

1008 
¨gc
,

1009 **
¨gv


1011 
a
[3], 
i
;

1012 *
z
;

1013 if–
¨gc
!=5 ){

1014 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1016  
TCL_ERROR
;

1018 
i
=2; i<5; i++){

1019 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[
i
], &
a
[i-2]ËË 
TCL_ERROR
;

1021 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
a
[0],á[1],á[2]);

1022 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1023 
	`sqlôe4_‰ì
(0, 
z
);

1024  
TCL_OK
;

1025 
	}
}

1032 
	$sqlôe4_m¥ötf_öt64
(

1033 *
NŸU£d
,

1034 
T˛_I¡îp
 *
öãΩ
,

1035 
¨gc
,

1036 **
¨gv


1038 
i
;

1039 
sqlôe4_öt64
 
a
[3];

1040 *
z
;

1041 if–
¨gc
!=5 ){

1042 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1044  
TCL_ERROR
;

1046 
i
=2; i<5; i++){

1047 if–
	`sqlôe4Atoi64
(
¨gv
[
i
], &
a
[i-2], 1000000, 
SQLITE4_UTF8
) ){

1048 
	`T˛_AµídResu…
(
öãΩ
, "argument isÇotá valid 64-bit integer", 0);

1049  
TCL_ERROR
;

1052 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
a
[0],á[1],á[2]);

1053 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1054 
	`sqlôe4_‰ì
(0, 
z
);

1055  
TCL_OK
;

1056 
	}
}

1065 
	$sqlôe4_m¥ötf_l⁄g
(

1066 *
NŸU£d
,

1067 
T˛_I¡îp
 *
öãΩ
,

1068 
¨gc
,

1069 **
¨gv


1071 
i
;

1072 
a
[3];

1073 
b
[3];

1074 *
z
;

1075 if–
¨gc
!=5 ){

1076 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1078  
TCL_ERROR
;

1080 
i
=2; i<5; i++){

1081 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[
i
], &
b
[i-2]ËË 
TCL_ERROR
;

1082 
a
[
i
-2] = ()
b
[i-2];

1083 
a
[
i
-2] &(((
u64
)1)<<(()*8))-1;

1085 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
a
[0],á[1],á[2]);

1086 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1087 
	`sqlôe4_‰ì
(0, 
z
);

1088  
TCL_OK
;

1089 
	}
}

1096 
	$sqlôe4_m¥ötf_°r
(

1097 *
NŸU£d
,

1098 
T˛_I¡îp
 *
öãΩ
,

1099 
¨gc
,

1100 **
¨gv


1102 
a
[3], 
i
;

1103 *
z
;

1104 if–
¨gc
<4 ||árgc>5 ){

1105 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1107  
TCL_ERROR
;

1109 
i
=2; i<4; i++){

1110 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[
i
], &
a
[i-2]ËË 
TCL_ERROR
;

1112 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
a
[0],á[1], 
¨gc
>4 ?árgv[4] : 
NULL
);

1113 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1114 
	`sqlôe4_‰ì
(0, 
z
);

1115  
TCL_OK
;

1116 
	}
}

1123 
	$sqlôe4_¢¥ötf_°r
(

1124 *
NŸU£d
,

1125 
T˛_I¡îp
 *
öãΩ
,

1126 
¨gc
,

1127 **
¨gv


1129 
a
[3], 
i
;

1130 
n
;

1131 *
z
;

1132 if–
¨gc
<5 ||árgc>6 ){

1133 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1135  
TCL_ERROR
;

1137 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[1], &
n
ËË 
TCL_ERROR
;

1138 if–
n
<0 ){

1139 
	`T˛_AµídResu…
(
öãΩ
, "N must beÇon-negative", 0);

1140  
TCL_ERROR
;

1142 
i
=3; i<5; i++){

1143 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[
i
], &
a
[i-3]ËË 
TCL_ERROR
;

1145 
z
 = 
	`sqlôe4_mÆloc
(0, 
n
+1);

1146 
	`sqlôe4_¢¥ötf
(
z
, 
n
, 
¨gv
[2], 
a
[0],á[1], 
¨gc
>4 ?árgv[5] : 
NULL
);

1147 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1148 
	`sqlôe4_‰ì
(0, 
z
);

1149  
TCL_OK
;

1150 
	}
}

1157 
	$sqlôe4_m¥ötf_doubÀ
(

1158 *
NŸU£d
,

1159 
T˛_I¡îp
 *
öãΩ
,

1160 
¨gc
,

1161 **
¨gv


1163 
a
[3], 
i
;

1164 
r
;

1165 *
z
;

1166 if–
¨gc
!=5 ){

1167 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1169  
TCL_ERROR
;

1171 
i
=2; i<4; i++){

1172 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[
i
], &
a
[i-2]ËË 
TCL_ERROR
;

1174 if–
	`T˛_GëDoubÀ
(
öãΩ
, 
¨gv
[4], &
r
ËË 
TCL_ERROR
;

1175 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
a
[0],á[1], 
r
);

1176 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1177 
	`sqlôe4_‰ì
(0, 
z
);

1178  
TCL_OK
;

1179 
	}
}

1188 
	$sqlôe4_m¥ötf_sˇÀd
(

1189 *
NŸU£d
,

1190 
T˛_I¡îp
 *
öãΩ
,

1191 
¨gc
,

1192 **
¨gv


1194 
i
;

1195 
r
[2];

1196 *
z
;

1197 if–
¨gc
!=4 ){

1198 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1200  
TCL_ERROR
;

1202 
i
=2; i<4; i++){

1203 if–
	`T˛_GëDoubÀ
(
öãΩ
, 
¨gv
[
i
], &
r
[i-2]ËË 
TCL_ERROR
;

1205 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
r
[0]*r[1]);

1206 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1207 
	`sqlôe4_‰ì
(0, 
z
);

1208  
TCL_OK
;

1209 
	}
}

1218 
	$sqlôe4_m¥ötf_°r⁄ly
(

1219 *
NŸU£d
,

1220 
T˛_I¡îp
 *
öãΩ
,

1221 
¨gc
,

1222 **
¨gv


1224 *
z
;

1225 if–
¨gc
!=3 ){

1226 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1228  
TCL_ERROR
;

1230 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1],árgv[2]);

1231 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1232 
	`sqlôe4_‰ì
(0, 
z
);

1233  
TCL_OK
;

1234 
	}
}

1242 
	$sqlôe4_m¥ötf_hexdoubÀ
(

1243 *
NŸU£d
,

1244 
T˛_I¡îp
 *
öãΩ
,

1245 
¨gc
,

1246 **
¨gv


1248 *
z
;

1249 
r
;

1250 
x1
, 
x2
;

1251 
sqlôe4_uöt64
 
d
;

1252 if–
¨gc
!=3 ){

1253 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1255  
TCL_ERROR
;

1257 if–
	`ssˇnf
(
¨gv
[2], "%08x%08x", &
x2
, &
x1
)!=2 ){

1258 
	`T˛_AµídResu…
(
öãΩ
, "2ndárgument should be 16-characters of hex", 0);

1259  
TCL_ERROR
;

1261 
d
 = 
x2
;

1262 
d
 = (d<<32Ë+ 
x1
;

1263 
	`mem˝y
(&
r
, &
d
, (r));

1264 
z
 = 
	`sqlôe4_m¥ötf
(0, 
¨gv
[1], 
r
);

1265 
	`T˛_AµídResu…
(
öãΩ
, 
z
, 0);

1266 
	`sqlôe4_‰ì
(0, 
z
);

1267  
TCL_OK
;

1268 
	}
}

1274 
	$ã°_libvîsi⁄_numbî
(

1275 
Clõ¡D©a
 
˛õ¡D©a
,

1276 
T˛_I¡îp
 *
öãΩ
,

1277 
objc
,

1278 
T˛_Obj
 *
CONST
 
objv
[]

1280 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_libvîsi⁄_numbî
()));

1281  
TCL_OK
;

1282 
	}
}

1288 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


1289 
	$ã°_èbÀ_cﬁumn_mëad©a
(

1290 
Clõ¡D©a
 
˛õ¡D©a
,

1291 
T˛_I¡îp
 *
öãΩ
,

1292 
objc
,

1293 
T˛_Obj
 *
CONST
 
objv
[]

1295 
sqlôe4
 *
db
;

1296 c⁄° *
zDb
;

1297 c⁄° *
zTbl
;

1298 c⁄° *
zCﬁ
;

1299 
rc
;

1300 
T˛_Obj
 *
pRë
;

1302 c⁄° *
zD©©y≥
;

1303 c⁄° *
zCﬁl£q
;

1304 
nŸnuŒ
;

1305 
¥im¨ykey
;

1306 
autoö¸emít
;

1308 if–
objc
!=5 ){

1309 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB dbnameÅblname colname");

1310  
TCL_ERROR
;

1312 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1313 
zDb
 = 
	`T˛_GëSåög
(
objv
[2]);

1314 
zTbl
 = 
	`T˛_GëSåög
(
objv
[3]);

1315 
zCﬁ
 = 
	`T˛_GëSåög
(
objv
[4]);

1317 if–
	`°æí
(
zDb
)==0 ) zDb = 0;

1319 
rc
 = 
	`sqlôe4_èbÀ_cﬁumn_mëad©a
(
db
, 
zDb
, 
zTbl
, 
zCﬁ
,

1320 &
zD©©y≥
, &
zCﬁl£q
, &
nŸnuŒ
, &
¥im¨ykey
, &
autoö¸emít
);

1322 if–
rc
!=
SQLITE4_OK
 ){

1323 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4_îrmsg
(
db
), 0);

1324  
TCL_ERROR
;

1327 
pRë
 = 
	`T˛_NewObj
();

1328 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewSåögObj
(
zD©©y≥
, -1));

1329 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewSåögObj
(
zCﬁl£q
, -1));

1330 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewI¡Obj
(
nŸnuŒ
));

1331 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewI¡Obj
(
¥im¨ykey
));

1332 
	`T˛_Li°ObjAµídEÀmít
(0, 
pRë
, 
	`T˛_NewI¡Obj
(
autoö¸emít
));

1333 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

1335  
TCL_OK
;

1336 
	}
}

1343 
	sTe°Cﬁœti⁄X
 {

1344 
T˛_I¡îp
 *
	möãΩ
;

1345 
T˛_Obj
 *
	mpCmp
;

1346 
T˛_Obj
 *
	mpMkkey
;

1347 
T˛_Obj
 *
	mpDñ
;

1349 
Te°Cﬁœti⁄X
 
	tTe°Cﬁœti⁄X
;

1351 
	$ã°Cª©eCﬁœti⁄Dñ
(*
pCtx
){

1352 
Te°Cﬁœti⁄X
 *
p
 = (Te°Cﬁœti⁄X *)
pCtx
;

1354 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
,Ö->
pDñ
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1355 if–
rc
!=
TCL_OK
 ){

1356 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1359 
	`T˛_De¸RefCou¡
(
p
->
pCmp
);

1360 
	`T˛_De¸RefCou¡
(
p
->
pDñ
);

1361 
	`T˛_De¸RefCou¡
(
p
->
pMkkey
);

1362 
	`sqlôe4_‰ì
(0, (*)
p
);

1363 
	}
}

1365 
	$ã°Cª©eCﬁœti⁄Cmp
(

1366 *
pCtx
,

1367 
sqlôe4_vÆue
 *
pLe·
,

1368 
sqlôe4_vÆue
 *
pRight
,

1369 *
pRes


1371 
nLe·
;

1372 
nRight
;

1373 c⁄° *
zLe·
;

1374 c⁄° *
zRight
;

1376 
Te°Cﬁœti⁄X
 *
p
 = (Te°Cﬁœti⁄X *)
pCtx
;

1377 
T˛_Obj
 *
pS¸ùt
;

1378 
iRes
 = 0;

1379 
rc
;

1381 
zLe·
 = 
	`sqlôe4_vÆue_ãxt
(
pLe·
, &
nLe·
);

1382 
zRight
 = 
	`sqlôe4_vÆue_ãxt
(
pRight
, &
nRight
);

1383 if–!
zLe·
 || !
zRight
 )  
SQLITE4_NOMEM
;

1385 
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
p
->
pCmp
);

1386 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1387 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
zLe·
, 
nLe·
));

1388 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
zRight
,
nRight
));

1390 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pS¸ùt
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1391 if–
rc
==
TCL_OK
 ){

1392 
rc
 = 
	`T˛_GëI¡FromObj
(
p
->
öãΩ
, 
	`T˛_GëObjResu…
’->öãΩ), &
iRes
);

1394 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

1396 if–
rc
!=
TCL_OK
 ){

1397  
SQLITE4_ERROR
;

1399 *
pRes
 = 
iRes
;

1400  
SQLITE4_OK
;

1401 
	}
}

1403 
	$ã°Cª©eCﬁœti⁄Mkkey
(

1404 *
pCtx
,

1405 
sqlôe4_vÆue
 *
pVÆ
,

1406 
nBuf
,

1407 *
pBuf
,

1408 *
≤Out


1410 
Te°Cﬁœti⁄X
 *
p
 = (Te°Cﬁœti⁄X *)
pCtx
;

1411 
T˛_Obj
 *
pS¸ùt
;

1412 c⁄° *
zIn
;

1413 
nIn
;

1414 
rc
;

1415 c⁄° *
zOut
;

1416 
nOut
;

1418 
zIn
 = 
	`sqlôe4_vÆue_ãxt
(
pVÆ
, &
nIn
);

1419 if–!
zIn
 )  
SQLITE4_NOMEM
;

1421 
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
p
->
pMkkey
);

1422 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1423 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
zIn
, 
nIn
));

1425 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pS¸ùt
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1426 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

1427 if–
rc
!=
TCL_OK
 ){

1428  
SQLITE4_ERROR
;

1431 
zOut
 = 
	`T˛_GëSåögFromObj
(
	`T˛_GëObjResu…
(
p
->
öãΩ
), &
nOut
);

1432 if–
nOut
<=
nBuf
 ){

1433 
	`mem˝y
(
pBuf
, 
zOut
, 
nOut
);

1435 *
≤Out
 = 
nOut
;

1436  
SQLITE4_OK
;

1437 
	}
}

1439 
	$ã°_¸óã_cﬁœti⁄
(

1440 
Clõ¡D©a
 
˛õ¡D©a
,

1441 
T˛_I¡îp
 *
öãΩ
,

1442 
objc
,

1443 
T˛_Obj
 *
CONST
 
objv
[]

1446 (*
xCom∑ª
)(*, 
sqlôe4_vÆue
*, sqlite4_value*, *);

1447 (*
xMakeKey
)(*, 
sqlôe4_vÆue
*, , *, *);

1448 
nByã
;

1449 
Te°Cﬁœti⁄X
 *
p
;

1450 
sqlôe4
 *
db
;

1451 
rc
;

1453 if–
objc
!=6 ){

1454 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB NAME CMP-PROC MKKEY-PROC DEL-PROC");

1455  
TCL_ERROR
;

1457 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1459 
	`T˛_GëSåögFromObj
(
objv
[3], &
nByã
);

1460 
xCom∑ª
 = (
nByã
>0 ? 
ã°Cª©eCﬁœti⁄Cmp
 : 0);

1461 
	`T˛_GëSåögFromObj
(
objv
[4], &
nByã
);

1462 
xMakeKey
 = (
nByã
>0 ? 
ã°Cª©eCﬁœti⁄Mkkey
 : 0);

1464 if–
xCom∑ª
==0 && 
xMakeKey
==0 ){

1465 
rc
 = 
	`sqlôe4_¸óã_cﬁœti⁄
(
db
, 
	`T˛_GëSåög
(
objv
[2]), 0, 0, 0, 0);

1467 
p
 = (
Te°Cﬁœti⁄X
 *)
	`sqlôe4_mÆloc
(0, (TestCollationX));

1468 
p
->
pCmp
 = 
objv
[3];

1469 
p
->
pMkkey
 = 
objv
[4];

1470 
p
->
pDñ
 = 
objv
[5];

1471 
p
->
öãΩ
 = interp;

1472 
	`T˛_In¸RefCou¡
(
p
->
pCmp
);

1473 
	`T˛_In¸RefCou¡
(
p
->
pMkkey
);

1474 
	`T˛_In¸RefCou¡
(
p
->
pDñ
);

1476 
rc
 = 
	`sqlôe4_¸óã_cﬁœti⁄
(
db
, 
	`T˛_GëSåög
(
objv
[2]), (*)
p
,

1477 
ã°Cª©eCﬁœti⁄Cmp
, 
ã°Cª©eCﬁœti⁄Mkkey
, 
ã°Cª©eCﬁœti⁄Dñ


1481 if–
rc
!=
SQLITE4_OK
 ){

1482 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
	`sqlôe4Te°Eº‹Name
(
rc
), -1));

1483  
TCL_ERROR
;

1485 
	`T˛_Re£tResu…
(
öãΩ
);

1486  
TCL_OK
;

1487 
	}
}

1494 
	sTe°NìdedX
 {

1495 
T˛_I¡îp
 *
	möãΩ
;

1496 
T˛_Obj
 *
	mpNìded
;

1497 
T˛_Obj
 *
	mpDñ
;

1499 
Te°NìdedX
 
	tTe°NìdedX
;

1501 
	$ã°Cﬁœti⁄Nìded
(*
pCtx
, 
sqlôe4
 *
db
, c⁄° *
zReq
){

1502 
Te°NìdedX
 *
p
 = (Te°NìdedX *)
pCtx
;

1503 
T˛_Obj
 *
pS¸ùt
;

1504 
rc
;

1506 
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
p
->
pNìded
);

1507 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1508 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
zReq
, -1));

1509 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pS¸ùt
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1510 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

1512 if–
rc
!=
TCL_OK
 ){

1513 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1515 
	}
}

1517 
	$ã°Cﬁœti⁄NìdedDñ
(*
pCtx
){

1518 
Te°NìdedX
 *
p
 = (Te°NìdedX*)
pCtx
;

1519 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
,Ö->
pDñ
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1520 if–
rc
!=
TCL_OK
 ){

1521 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1524 
	`T˛_De¸RefCou¡
(
p
->
pNìded
);

1525 
	`T˛_De¸RefCou¡
(
p
->
pDñ
);

1526 
	`sqlôe4_‰ì
(0, (*)
p
);

1527 
	}
}

1529 
	$ã°_cﬁœti⁄_√eded
(

1530 
Clõ¡D©a
 
˛õ¡D©a
,

1531 
T˛_I¡îp
 *
öãΩ
,

1532 
objc
,

1533 
T˛_Obj
 *
CONST
 
objv
[]

1535 
nByã
;

1536 
Te°NìdedX
 *
p
;

1537 
sqlôe4
 *
db
;

1538 
rc
;

1540 if–
objc
!=4 ){

1541 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB CALLBACK-PROC DEL-PROC");

1542  
TCL_ERROR
;

1544 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1546 
	`T˛_GëSåögFromObj
(
objv
[2], &
nByã
);

1547 if–
nByã
==0 ){

1548 
rc
 = 
	`sqlôe4_cﬁœti⁄_√eded
(
db
, 0, 0, 0);

1550 
p
 = (
Te°NìdedX
*)
	`sqlôe4_mÆloc
(0, (TestNeededX));

1551 
p
->
pNìded
 = 
objv
[2];

1552 
p
->
pDñ
 = 
objv
[3];

1553 
p
->
öãΩ
 = interp;

1554 
	`T˛_In¸RefCou¡
(
p
->
pNìded
);

1555 
	`T˛_In¸RefCou¡
(
p
->
pDñ
);

1557 
rc
 = 
	`sqlôe4_cﬁœti⁄_√eded
(

1558 
db
, (*)
p
, 
ã°Cﬁœti⁄Nìded
, 
ã°Cﬁœti⁄NìdedDñ


1562 if–
rc
!=
SQLITE4_OK
 ){

1563 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
	`sqlôe4Te°Eº‹Name
(
rc
), -1));

1564  
TCL_ERROR
;

1566 
	`T˛_Re£tResu…
(
öãΩ
);

1567  
TCL_OK
;

1568 
	}
}

1574 
	sTe°ProfûeX
 {

1575 
T˛_I¡îp
 *
	möãΩ
;

1576 
T˛_Obj
 *
	mpProfûe
;

1577 
T˛_Obj
 *
	mpDñ
;

1579 
Te°ProfûeX
 
	tTe°ProfûeX
;

1580 
	$ã°Profûe
(*
pCtx
, c⁄° *
z
, 
sqlôe4_uöt64
 
i
){

1581 
Te°ProfûeX
 *
p
 = (Te°ProfûeX *)
pCtx
;

1582 
T˛_Obj
 *
pS¸ùt
;

1583 
rc
;

1584 
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
p
->
pProfûe
);

1585 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1586 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
z
, -1));

1587 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewWideI¡Obj
(
i
));

1588 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pS¸ùt
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1589 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

1590 if–
rc
!=
TCL_OK
 ){

1591 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1593 
	}
}

1594 
	$ã°ProfûeDñ
(*
pCtx
){

1595 
Te°ProfûeX
 *
p
 = (Te°ProfûeX*)
pCtx
;

1596 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
,Ö->
pDñ
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1597 if–
rc
!=
TCL_OK
 ){

1598 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1600 
	`T˛_De¸RefCou¡
(
p
->
pProfûe
);

1601 
	`T˛_De¸RefCou¡
(
p
->
pDñ
);

1602 
	`sqlôe4_‰ì
(0, (*)
p
);

1603 
	}
}

1604 
	$ã°_¥ofûe
(

1605 
Clõ¡D©a
 
˛õ¡D©a
,

1606 
T˛_I¡îp
 *
öãΩ
,

1607 
objc
,

1608 
T˛_Obj
 *
CONST
 
objv
[]

1610 
nByã
;

1611 
Te°ProfûeX
 *
p
;

1612 
sqlôe4
 *
db
;

1614 if–
objc
!=4 ){

1615 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB PROFILE-CMD DEL-CMD");

1616  
TCL_ERROR
;

1618 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1620 
	`T˛_GëSåögFromObj
(
objv
[2], &
nByã
);

1621 if–
nByã
==0 ){

1622 
	`sqlôe4_¥ofûe
(
db
, 0, 0, 0);

1624 
p
 = (
Te°ProfûeX
*)
	`sqlôe4_mÆloc
(0, (TestProfileX));

1625 
p
->
pProfûe
 = 
objv
[2];

1626 
p
->
pDñ
 = 
objv
[3];

1627 
p
->
öãΩ
 = interp;

1628 
	`T˛_In¸RefCou¡
(
p
->
pProfûe
);

1629 
	`T˛_In¸RefCou¡
(
p
->
pDñ
);

1630 
	`sqlôe4_¥ofûe
(
db
, (*)
p
, 
ã°Profûe
, 
ã°ProfûeDñ
);

1633 
	`T˛_Re£tResu…
(
öãΩ
);

1634  
TCL_OK
;

1635 
	}
}

1642 
	sTe°Tø˚X
 {

1643 
T˛_I¡îp
 *
	möãΩ
;

1644 
T˛_Obj
 *
	mpTø˚
;

1645 
T˛_Obj
 *
	mpDñ
;

1647 
Te°Tø˚X
 
	tTe°Tø˚X
;

1648 
	$ã°Tø˚
(*
pCtx
, c⁄° *
z
){

1649 
Te°Tø˚X
 *
p
 = (Te°Tø˚X *)
pCtx
;

1650 
T˛_Obj
 *
pS¸ùt
;

1651 
rc
;

1652 
pS¸ùt
 = 
	`T˛_Du∂iˇãObj
(
p
->
pTø˚
);

1653 
	`T˛_In¸RefCou¡
(
pS¸ùt
);

1654 
	`T˛_Li°ObjAµídEÀmít
(0, 
pS¸ùt
, 
	`T˛_NewSåögObj
(
z
, -1));

1655 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
, 
pS¸ùt
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1656 
	`T˛_De¸RefCou¡
(
pS¸ùt
);

1657 if–
rc
!=
TCL_OK
 ){

1658 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1660 
	}
}

1661 
	$ã°Tø˚Dñ
(*
pCtx
){

1662 
Te°Tø˚X
 *
p
 = (Te°Tø˚X*)
pCtx
;

1663 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
,Ö->
pDñ
, 
TCL_EVAL_DIRECT
|
TCL_EVAL_GLOBAL
);

1664 if–
rc
!=
TCL_OK
 ){

1665 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1667 
	`T˛_De¸RefCou¡
(
p
->
pTø˚
);

1668 
	`T˛_De¸RefCou¡
(
p
->
pDñ
);

1669 
	`sqlôe4_‰ì
(0, (*)
p
);

1670 
	}
}

1671 
	$ã°_åa˚
(

1672 
Clõ¡D©a
 
˛õ¡D©a
,

1673 
T˛_I¡îp
 *
öãΩ
,

1674 
objc
,

1675 
T˛_Obj
 *
CONST
 
objv
[]

1677 
nByã
;

1678 
Te°Tø˚X
 *
p
;

1679 
sqlôe4
 *
db
;

1681 if–
objc
!=4 ){

1682 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB PROFILE-CMD DEL-CMD");

1683  
TCL_ERROR
;

1685 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1687 
	`T˛_GëSåögFromObj
(
objv
[2], &
nByã
);

1688 if–
nByã
==0 ){

1689 
	`sqlôe4_åa˚
(
db
, 0, 0, 0);

1691 
p
 = (
Te°Tø˚X
*)
	`sqlôe4_mÆloc
(0, (TestTraceX));

1692 
p
->
pTø˚
 = 
objv
[2];

1693 
p
->
pDñ
 = 
objv
[3];

1694 
p
->
öãΩ
 = interp;

1695 
	`T˛_In¸RefCou¡
(
p
->
pTø˚
);

1696 
	`T˛_In¸RefCou¡
(
p
->
pDñ
);

1697 
	`sqlôe4_åa˚
(
db
, (*)
p
, 
ã°Tø˚
, 
ã°Tø˚Dñ
);

1700 
	`T˛_Re£tResu…
(
öãΩ
);

1701  
TCL_OK
;

1702 
	}
}

1715 
Cª©eFun˘i⁄V2
 
	tCª©eFun˘i⁄V2
;

1716 
	sCª©eFun˘i⁄V2
 {

1717 
T˛_I¡îp
 *
	möãΩ
;

1718 
T˛_Obj
 *
	mpFunc
;

1719 
T˛_Obj
 *
	mpSãp
;

1720 
T˛_Obj
 *
	mpFöÆ
;

1721 
T˛_Obj
 *
	mpDe°roy
;

1723 
	$cf2Func
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
aArg
){

1724 
	}
}

1725 
	$cf2Sãp
(
sqlôe4_c⁄ãxt
 *
˘x
, 
nArg
, 
sqlôe4_vÆue
 **
aArg
){

1726 
	}
}

1727 
	$cf2FöÆ
(
sqlôe4_c⁄ãxt
 *
˘x
){

1728 
	}
}

1729 
	$cf2De°roy
(*
pU£r
){

1730 
Cª©eFun˘i⁄V2
 *
p
 = (Cª©eFun˘i⁄V2 *)
pU£r
;

1732 if–
p
->
öãΩ
 &&Ö->
pDe°roy
 ){

1733 
rc
 = 
	`T˛_EvÆObjEx
(
p
->
öãΩ
,Ö->
pDe°roy
, 0);

1734 if–
rc
!=
TCL_OK
 ) 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

1737 if–
p
->
pFunc
 ) 
	`T˛_De¸RefCou¡
(p->pFunc);

1738 if–
p
->
pSãp
 ) 
	`T˛_De¸RefCou¡
(p->pStep);

1739 if–
p
->
pFöÆ
 ) 
	`T˛_De¸RefCou¡
(p->pFinal);

1740 if–
p
->
pDe°roy
 ) 
	`T˛_De¸RefCou¡
(p->pDestroy);

1741 
	`sqlôe4_‰ì
(0, 
p
);

1742 
	}
}

1743 
	$ã°_¸óã_fun˘i⁄_v2
(

1744 
Clõ¡D©a
 
˛õ¡D©a
,

1745 
T˛_I¡îp
 *
öãΩ
,

1746 
objc
,

1747 
T˛_Obj
 *
CONST
 
objv
[]

1749 
sqlôe4
 *
db
;

1750 c⁄° *
zFunc
;

1751 
nArg
;

1752 
Cª©eFun˘i⁄V2
 *
p
;

1753 
i
;

1754 
rc
;

1756 if–
objc
<4 || (objc%2) ){

1757 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB NAME NARG SWITCHES...");

1758  
TCL_ERROR
;

1761 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1762 
zFunc
 = 
	`T˛_GëSåög
(
objv
[2]);

1763 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
nArg
ËË 
TCL_ERROR
;

1765 
p
 = 
	`sqlôe4_mÆloc
(0, (
Cª©eFun˘i⁄V2
));

1766 
	`as£π
–
p
 );

1767 
	`mem£t
(
p
, 0, (
Cª©eFun˘i⁄V2
));

1768 
p
->
öãΩ
 = interp;

1770 
i
=4; i<
objc
; i+=2){

1771 
iSwôch
;

1772 c⁄° *
azSwôch
[] = {"-func", "-step", "-final", "-destroy", 0};

1773 if–
	`T˛_GëIndexFromObj
(
öãΩ
, 
objv
[
i
], 
azSwôch
, "swôch", 0, &
iSwôch
) ){

1774 
	`sqlôe4_‰ì
(0, 
p
);

1775  
TCL_ERROR
;

1778  
iSwôch
 ){

1779 0: 
p
->
pFunc
 = 
objv
[
i
+1]; ;

1780 1: 
p
->
pSãp
 = 
objv
[
i
+1]; ;

1781 2: 
p
->
pFöÆ
 = 
objv
[
i
+1]; ;

1782 3: 
p
->
pDe°roy
 = 
objv
[
i
+1]; ;

1785 if–
p
->
pFunc
 )Ö->pFun¯
	`T˛_Du∂iˇãObj
(p->pFunc);

1786 if–
p
->
pSãp
 )Ö->pSã∞
	`T˛_Du∂iˇãObj
(p->pStep);

1787 if–
p
->
pFöÆ
 )Ö->pFöÆ = 
	`T˛_Du∂iˇãObj
(p->pFinal);

1788 if–
p
->
pDe°roy
 )Ö->pDe°roy = 
	`T˛_Du∂iˇãObj
(p->pDestroy);

1790 if–
p
->
pFunc
 ) 
	`T˛_In¸RefCou¡
(p->pFunc);

1791 if–
p
->
pSãp
 ) 
	`T˛_In¸RefCou¡
(p->pStep);

1792 if–
p
->
pFöÆ
 ) 
	`T˛_In¸RefCou¡
(p->pFinal);

1793 if–
p
->
pDe°roy
 ) 
	`T˛_In¸RefCou¡
(p->pDestroy);

1795 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
zFunc
, 
nArg
, (*)
p
,

1796 (
p
->
pFunc
 ? 
cf2Func
 : 0),

1797 (
p
->
pSãp
 ? 
cf2Sãp
 : 0),

1798 (
p
->
pFöÆ
 ? 
cf2FöÆ
 : 0),

1799 
cf2De°roy


1801 if–
rc
!=
SQLITE4_OK
 ){

1802 
	`T˛_Re£tResu…
(
öãΩ
);

1803 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4Te°Eº‹Name
(
rc
), 0);

1804  
TCL_ERROR
;

1806  
TCL_OK
;

1807 
	}
}

1817 
	$sqlôe_ab‹t
(

1818 *
NŸU£d
,

1819 
T˛_I¡îp
 *
öãΩ
,

1820 
¨gc
,

1821 **
¨gv


1823 #i‡
	`deföed
(
_MSC_VER
)

1827 
	`_£t_ab‹t_behavi‹
–0, 
_CALL_REPORTFAULT
 );

1829 
	`exô
(255);

1830 
	`as£π
–
öãΩ
==0 );

1831  
TCL_OK
;

1832 
	}
}

1838 
	$ã°Func
(
sqlôe4_c⁄ãxt
 *
c⁄ãxt
, 
¨gc
, 
sqlôe4_vÆue
 **
¨gv
){

1839  
¨gc
>=2 ){

1840 c⁄° *
zArg0
 = (*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0);

1841 if–
zArg0
 ){

1842 if–0==
	`sqlôe4_°ricmp
(
zArg0
, "int") ){

1843 
	`sqlôe4_ªsu…_öt
(
c⁄ãxt
, 
	`sqlôe4_vÆue_öt
(
¨gv
[1]));

1844 }if–
	`sqlôe4_°ricmp
(
zArg0
,"int64")==0 ){

1845 
	`sqlôe4_ªsu…_öt64
(
c⁄ãxt
, 
	`sqlôe4_vÆue_öt64
(
¨gv
[1]));

1846 }if–
	`sqlôe4_°ricmp
(
zArg0
,"string")==0 ){

1847 
	`sqlôe4_ªsu…_ãxt
(
c⁄ãxt
, (*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[1], 0), -1,

1848 
SQLITE4_TRANSIENT
, 0);

1849 }if–
	`sqlôe4_°ricmp
(
zArg0
,"double")==0 ){

1850 
	`sqlôe4_ªsu…_doubÀ
(
c⁄ãxt
, 
	`sqlôe4_vÆue_doubÀ
(
¨gv
[1]));

1851 }if–
	`sqlôe4_°ricmp
(
zArg0
,"null")==0 ){

1852 
	`sqlôe4_ªsu…_nuŒ
(
c⁄ãxt
);

1853 }if–
	`sqlôe4_°ricmp
(
zArg0
,"value")==0 ){

1854 
	`sqlôe4_ªsu…_vÆue
(
c⁄ãxt
, 
¨gv
[
	`sqlôe4_vÆue_öt
(argv[1])]);

1856 
îr‹_out
;

1859 
îr‹_out
;

1861 
¨gc
 -= 2;

1862 
¨gv
 += 2;

1866 
îr‹_out
:

1867 
	`sqlôe4_ªsu…_îr‹
(
c⁄ãxt
,"firstárgument should be one of: "

1869 
	}
}

1876 
	$ã°_ªgi°î_func
(

1877 *
NŸU£d
,

1878 
T˛_I¡îp
 *
öãΩ
,

1879 
¨gc
,

1880 **
¨gv


1882 
sqlôe4
 *
db
;

1883 
rc
;

1884 if–
¨gc
!=3 ){

1885 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

1887  
TCL_ERROR
;

1889 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

1890 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
¨gv
[2], -1, 0, 
ã°Func
, 0, 0, 0);

1891 if–
rc
!=0 ){

1892 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4EºSå
(
rc
), 0);

1893  
TCL_ERROR
;

1895 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

1896  
TCL_OK
;

1897 
	}
}

1904 
	$ã°_föÆize
(

1905 * 
˛õ¡D©a
,

1906 
T˛_I¡îp
 *
öãΩ
,

1907 
objc
,

1908 
T˛_Obj
 *
CONST
 
objv
[]

1910 
sqlôe4_°mt
 *
pStmt
;

1911 
rc
;

1912 
sqlôe4
 *
db
 = 0;

1914 if–
objc
!=2 ){

1915 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

1916 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " <STMT>", 0);

1917  
TCL_ERROR
;

1920 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

1922 if–
pStmt
 ){

1923 
db
 = 
	`StmtToDb
(
pStmt
);

1925 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

1926 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 
TCL_STATIC
);

1927 if–
db
 && 
	`sqlôe4Te°EºCode
(
öãΩ
, db, 
rc
ËË 
TCL_ERROR
;

1928  
TCL_OK
;

1929 
	}
}

1936 
	$ã°_°mt_°©us
(

1937 * 
˛õ¡D©a
,

1938 
T˛_I¡îp
 *
öãΩ
,

1939 
objc
,

1940 
T˛_Obj
 *
CONST
 
objv
[]

1942 
iVÆue
;

1943 
i
, 
›
, 
ª£tFœg
;

1944 c⁄° *
zOpName
;

1945 
sqlôe4_°mt
 *
pStmt
;

1948 c⁄° *
zName
;

1949 
›
;

1950 } 
aOp
[] = {

1951 { "SQLITE4_STMTSTATUS_FULLSCAN_STEP", 
SQLITE4_STMTSTATUS_FULLSCAN_STEP
 },

1952 { "SQLITE4_STMTSTATUS_SORT", 
SQLITE4_STMTSTATUS_SORT
 },

1953 { "SQLITE4_STMTSTATUS_AUTOINDEX", 
SQLITE4_STMTSTATUS_AUTOINDEX
 },

1955 if–
objc
!=4 ){

1956 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT PARAMETER RESETFLAG");

1957  
TCL_ERROR
;

1959 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

1960 
zOpName
 = 
	`T˛_GëSåög
(
objv
[2]);

1961 
i
=0; i<
	`AºaySize
(
aOp
); i++){

1962 if–
	`°rcmp
(
aOp
[
i
].
zName
, 
zOpName
)==0 ){

1963 
›
 = 
aOp
[
i
].op;

1967 if–
i
>=
	`AºaySize
(
aOp
) ){

1968 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
›
ËË 
TCL_ERROR
;

1970 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[3], &
ª£tFœg
ËË 
TCL_ERROR
;

1971 
iVÆue
 = 
	`sqlôe4_°mt_°©us
(
pStmt
, 
›
, 
ª£tFœg
);

1972 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
iVÆue
));

1973  
TCL_OK
;

1974 
	}
}

1981 
	$ã°_√xt_°mt
(

1982 * 
˛õ¡D©a
,

1983 
T˛_I¡îp
 *
öãΩ
,

1984 
objc
,

1985 
T˛_Obj
 *
CONST
 
objv
[]

1987 
sqlôe4_°mt
 *
pStmt
;

1988 
sqlôe4
 *
db
 = 0;

1989 
zBuf
[50];

1991 if–
objc
!=3 ){

1992 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

1993 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " DB STMT", 0);

1994  
TCL_ERROR
;

1997 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1998 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[2]), &
pStmt
ËË 
TCL_ERROR
;

1999 
pStmt
 = 
	`sqlôe4_√xt_°mt
(
db
,ÖStmt);

2000 if–
pStmt
 ){

2001 if–
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
pStmt
ËË 
TCL_ERROR
;

2002 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

2004  
TCL_OK
;

2005 
	}
}

2013 
	$ã°_°mt_ªad⁄ly
(

2014 * 
˛õ¡D©a
,

2015 
T˛_I¡îp
 *
öãΩ
,

2016 
objc
,

2017 
T˛_Obj
 *
CONST
 
objv
[]

2019 
sqlôe4_°mt
 *
pStmt
;

2020 
rc
;

2022 if–
objc
!=2 ){

2023 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2024 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT", 0);

2025  
TCL_ERROR
;

2028 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2029 
rc
 = 
	`sqlôe4_°mt_ªad⁄ly
(
pStmt
);

2030 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
rc
));

2031  
TCL_OK
;

2032 
	}
}

2040 
	$ã°_°mt_busy
(

2041 * 
˛õ¡D©a
,

2042 
T˛_I¡îp
 *
öãΩ
,

2043 
objc
,

2044 
T˛_Obj
 *
CONST
 
objv
[]

2046 
sqlôe4_°mt
 *
pStmt
;

2047 
rc
;

2049 if–
objc
!=2 ){

2050 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2051 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT", 0);

2052  
TCL_ERROR
;

2055 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2056 
rc
 = 
	`sqlôe4_°mt_busy
(
pStmt
);

2057 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
rc
));

2058  
TCL_OK
;

2059 
	}
}

2066 
	$u£s_°mt_jou∫Æ
(

2067 * 
˛õ¡D©a
,

2068 
T˛_I¡îp
 *
öãΩ
,

2069 
objc
,

2070 
T˛_Obj
 *
CONST
 
objv
[]

2072 
sqlôe4_°mt
 *
pStmt
;

2074 if–
objc
!=2 ){

2075 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2076 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT", 0);

2077  
TCL_ERROR
;

2080 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2081 
	`sqlôe4_°mt_ªad⁄ly
(
pStmt
);

2082 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(((
Vdbe
 *)
pStmt
)->
√edSavïoöt
));

2083  
TCL_OK
;

2084 
	}
}

2092 
	$ã°_ª£t
(

2093 * 
˛õ¡D©a
,

2094 
T˛_I¡îp
 *
öãΩ
,

2095 
objc
,

2096 
T˛_Obj
 *
CONST
 
objv
[]

2098 
sqlôe4_°mt
 *
pStmt
;

2099 
rc
;

2101 if–
objc
!=2 ){

2102 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2103 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " <STMT>", 0);

2104  
TCL_ERROR
;

2107 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2109 
rc
 = 
	`sqlôe4_ª£t
(
pStmt
);

2110 if–
pStmt
 && 
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
’Stmt), 
rc
) ){

2111  
TCL_ERROR
;

2113 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 
TCL_STATIC
);

2119  
TCL_OK
;

2120 
	}
}

2128 
	$ã°_ch™ges
(

2129 * 
˛õ¡D©a
,

2130 
T˛_I¡îp
 *
öãΩ
,

2131 
objc
,

2132 
T˛_Obj
 *
CONST
 
objv
[]

2134 
sqlôe4
 *
db
;

2135 if–
objc
!=2 ){

2136 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2137 
	`T˛_GëSåög
(
objv
[0]), " DB", 0);

2138  
TCL_ERROR
;

2140 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

2141 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_ch™ges
(
db
)));

2142  
TCL_OK
;

2143 
	}
}

2149 *
	gsqlôe_°©ic_böd_vÆue
 = 0;

2150 
	gsqlôe_°©ic_böd_nbyã
 = 0;

2163 
	$ã°_böd
(

2164 *
NŸU£d
,

2165 
T˛_I¡îp
 *
öãΩ
,

2166 
¨gc
,

2167 **
¨gv


2169 
sqlôe4_°mt
 *
pStmt
;

2170 
rc
;

2171 
idx
;

2172 if–
¨gc
!=5 ){

2173 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

2175  
TCL_ERROR
;

2177 if–
	`gëStmtPoöãr
(
öãΩ
, 
¨gv
[1], &
pStmt
ËË 
TCL_ERROR
;

2178 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[2], &
idx
ËË 
TCL_ERROR
;

2179 if–
	`°rcmp
(
¨gv
[4],"null")==0 ){

2180 
rc
 = 
	`sqlôe4_böd_nuŒ
(
pStmt
, 
idx
);

2181 }if–
	`°rcmp
(
¨gv
[4],"static")==0 ){

2182 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 
idx
, 
sqlôe_°©ic_böd_vÆue
, -1, 0, 0);

2183 }if–
	`°rcmp
(
¨gv
[4],"static-nbytes")==0 ){

2184 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 
idx
, 
sqlôe_°©ic_böd_vÆue
,

2185 
sqlôe_°©ic_böd_nbyã
, 0, 0);

2186 }if–
	`°rcmp
(
¨gv
[4],"normal")==0 ){

2187 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 
idx
, 
¨gv
[3], -1, 
SQLITE4_TRANSIENT
, 0);

2188 }if–
	`°rcmp
(
¨gv
[4],"blob10")==0 ){

2189 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 
idx
, "abc\000xyz\000pq", 10,
SQLITE4_STATIC
,0);

2191 
	`T˛_AµídResu…
(
öãΩ
, "4thárgument should be "

2193  
TCL_ERROR
;

2195 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2196 if–
rc
 ){

2197 
zBuf
[50];

2198 
	`•rötf
(
zBuf
, "(%dË", 
rc
);

2199 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 
	`sqlôe4EºSå
(
rc
), 0);

2200  
TCL_ERROR
;

2202  
TCL_OK
;

2203 
	}
}

2230 #i‚de‡
SQLITE4_OMIT_UTF16


2231 
	$ã°_fun˘i⁄_utf8
(

2232 
sqlôe4_c⁄ãxt
 *
pCtx
,

2233 
nArg
,

2234 
sqlôe4_vÆue
 **
¨gv


2236 
T˛_I¡îp
 *
öãΩ
;

2237 
T˛_Obj
 *
pX
;

2238 
sqlôe4_vÆue
 *
pVÆ
;

2239 
öãΩ
 = (
T˛_I¡îp
 *)
	`sqlôe4_c⁄ãxt_≠pd©a
(
pCtx
);

2240 
pX
 = 
	`T˛_NewSåögObj
("test_function", -1);

2241 
	`T˛_In¸RefCou¡
(
pX
);

2242 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pX
, 
	`T˛_NewSåögObj
("UTF-8", -1));

2243 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pX
,

2244 
	`T˛_NewSåögObj
((*)
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0), -1));

2245 
	`T˛_EvÆObjEx
(
öãΩ
, 
pX
, 0);

2246 
	`T˛_De¸RefCou¡
(
pX
);

2247 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
	`T˛_GëSåögResu…
(
öãΩ
), -1,

2248 
SQLITE4_TRANSIENT
, 0);

2249 
pVÆ
 = 
	`sqlôe4VÆueNew
(0);

2250 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
	`T˛_GëSåögResu…
(
öãΩ
),

2251 
SQLITE4_UTF8
, 
SQLITE4_STATIC
, 0);

2252 
	`sqlôe4_ªsu…_ãxt16be
(
pCtx
, 
	`sqlôe4_vÆue_ãxt16be
(
pVÆ
, 0),

2253 -1, 
SQLITE4_TRANSIENT
, 0);

2254 
	`sqlôe4VÆueFªe
(
pVÆ
);

2255 
	}
}

2256 
	$ã°_fun˘i⁄_utf16À
(

2257 
sqlôe4_c⁄ãxt
 *
pCtx
,

2258 
nArg
,

2259 
sqlôe4_vÆue
 **
¨gv


2261 
T˛_I¡îp
 *
öãΩ
;

2262 
T˛_Obj
 *
pX
;

2263 
sqlôe4_vÆue
 *
pVÆ
;

2264 
öãΩ
 = (
T˛_I¡îp
 *)
	`sqlôe4_c⁄ãxt_≠pd©a
(
pCtx
);

2265 
pX
 = 
	`T˛_NewSåögObj
("test_function", -1);

2266 
	`T˛_In¸RefCou¡
(
pX
);

2267 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pX
, 
	`T˛_NewSåögObj
("UTF-16LE", -1));

2268 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pX
,

2269 
	`T˛_NewSåögObj
(
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0), -1));

2270 
	`T˛_EvÆObjEx
(
öãΩ
, 
pX
, 0);

2271 
	`T˛_De¸RefCou¡
(
pX
);

2272 
pVÆ
 = 
	`sqlôe4VÆueNew
(0);

2273 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
	`T˛_GëSåögResu…
(
öãΩ
),

2274 
SQLITE4_UTF8
, 
SQLITE4_STATIC
, 0);

2275 
	`sqlôe4_ªsu…_ãxt
(
pCtx
, 
	`sqlôe4_vÆue_ãxt
(
pVÆ
, 0), -1,

2276 
SQLITE4_TRANSIENT
, 0);

2277 
	`sqlôe4VÆueFªe
(
pVÆ
);

2278 
	}
}

2279 
	$ã°_fun˘i⁄_utf16be
(

2280 
sqlôe4_c⁄ãxt
 *
pCtx
,

2281 
nArg
,

2282 
sqlôe4_vÆue
 **
¨gv


2284 
T˛_I¡îp
 *
öãΩ
;

2285 
T˛_Obj
 *
pX
;

2286 
sqlôe4_vÆue
 *
pVÆ
;

2287 
öãΩ
 = (
T˛_I¡îp
 *)
	`sqlôe4_c⁄ãxt_≠pd©a
(
pCtx
);

2288 
pX
 = 
	`T˛_NewSåögObj
("test_function", -1);

2289 
	`T˛_In¸RefCou¡
(
pX
);

2290 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pX
, 
	`T˛_NewSåögObj
("UTF-16BE", -1));

2291 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pX
,

2292 
	`T˛_NewSåögObj
(
	`sqlôe4_vÆue_ãxt
(
¨gv
[0], 0), -1));

2293 
	`T˛_EvÆObjEx
(
öãΩ
, 
pX
, 0);

2294 
	`T˛_De¸RefCou¡
(
pX
);

2295 
pVÆ
 = 
	`sqlôe4VÆueNew
(0);

2296 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
	`T˛_GëSåögResu…
(
öãΩ
),

2297 
SQLITE4_UTF8
, 
SQLITE4_STATIC
, 0);

2298 
	`sqlôe4_ªsu…_ãxt16
(
pCtx
, 
	`sqlôe4_vÆue_ãxt16À
(
pVÆ
, 0),

2299 -1, 
SQLITE4_TRANSIENT
, 0);

2300 
	`sqlôe4_ªsu…_ãxt16be
(
pCtx
, 
	`sqlôe4_vÆue_ãxt16À
(
pVÆ
, 0),

2301 -1, 
SQLITE4_TRANSIENT
, 0);

2302 
	`sqlôe4_ªsu…_ãxt16À
(
pCtx
, 
	`sqlôe4_vÆue_ãxt16À
(
pVÆ
, 0),

2303 -1, 
SQLITE4_TRANSIENT
, 0);

2304 
	`sqlôe4VÆueFªe
(
pVÆ
);

2305 
	}
}

2307 
	$ã°_fun˘i⁄
(

2308 * 
˛õ¡D©a
,

2309 
T˛_I¡îp
 *
öãΩ
,

2310 
objc
,

2311 
T˛_Obj
 *
CONST
 
objv
[]

2313 #i‚de‡
SQLITE4_OMIT_UTF16


2314 
sqlôe4
 *
db
;

2315 
vÆ
;

2317 if–
objc
!=5 ) 
bad_¨gs
;

2318 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

2320 if–
TCL_OK
!=
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[2], &
vÆ
ËË 
TCL_ERROR
;

2321 if–
vÆ
 ){

2322 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "test_function", 1,

2323 
öãΩ
, 
ã°_fun˘i⁄_utf8
, 0, 0, 0);

2325 if–
TCL_OK
!=
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[3], &
vÆ
ËË 
TCL_ERROR
;

2326 if–
vÆ
 ){

2327 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "test_function", 1,

2328 
öãΩ
, 
ã°_fun˘i⁄_utf16À
, 0, 0, 0);

2330 if–
TCL_OK
!=
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[4], &
vÆ
ËË 
TCL_ERROR
;

2331 if–
vÆ
 ){

2332 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, "test_function", 1,

2333 
öãΩ
, 
ã°_fun˘i⁄_utf16be
, 0, 0, 0);

2336  
TCL_OK
;

2337 
bad_¨gs
:

2338 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2339 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " <DB> <utf8> <utf16le> <utf16be>", 0);

2341  
TCL_ERROR
;

2342 
	}
}

2352 
	$ã°_îr°r
(

2353 * 
˛õ¡D©a
,

2354 
T˛_I¡îp
 *
öãΩ
,

2355 
objc
,

2356 
T˛_Obj
 *
CONST
 
objv
[]

2358 *
zCode
;

2359 
i
;

2360 if–
objc
!=1 ){

2361 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "<error code>");

2364 
zCode
 = 
	`T˛_GëSåög
(
objv
[1]);

2365 
i
=0; i<200; i++){

2366 if–0==
	`°rcmp
(
	`t1Eº‹Name
(
i
), 
zCode
) ) ;

2368 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4EºSå
(
i
), 0);

2369  
TCL_OK
;

2370 
	}
}

2385 
	$ã°_bªakpoöt
(

2386 *
NŸU£d
,

2387 
T˛_I¡îp
 *
öãΩ
,

2388 
¨gc
,

2389 **
¨gv


2391  
TCL_OK
;

2392 
	}
}

2401 
	$ã°_böd_öt
(

2402 * 
˛õ¡D©a
,

2403 
T˛_I¡îp
 *
öãΩ
,

2404 
objc
,

2405 
T˛_Obj
 *
CONST
 
objv
[]

2407 
sqlôe4_°mt
 *
pStmt
;

2408 
idx
;

2409 
vÆue
;

2410 
rc
;

2412 if–
objc
!=4 ){

2413 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2414 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N VALUE", 0);

2415  
TCL_ERROR
;

2418 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2419 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
idx
ËË 
TCL_ERROR
;

2420 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
vÆue
ËË 
TCL_ERROR
;

2422 
rc
 = 
	`sqlôe4_böd_öt
(
pStmt
, 
idx
, 
vÆue
);

2423 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2424 if–
rc
!=
SQLITE4_OK
 ){

2425  
TCL_ERROR
;

2428  
TCL_OK
;

2429 
	}
}

2439 
	$ã°_böd_öt64
(

2440 * 
˛õ¡D©a
,

2441 
T˛_I¡îp
 *
öãΩ
,

2442 
objc
,

2443 
T˛_Obj
 *
CONST
 
objv
[]

2445 
sqlôe4_°mt
 *
pStmt
;

2446 
idx
;

2447 
i64
 
vÆue
;

2448 
rc
;

2450 if–
objc
!=4 ){

2451 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2452 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N VALUE", 0);

2453  
TCL_ERROR
;

2456 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2457 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
idx
ËË 
TCL_ERROR
;

2458 if–
	`T˛_GëWideI¡FromObj
(
öãΩ
, 
objv
[3], &
vÆue
ËË 
TCL_ERROR
;

2460 
rc
 = 
	`sqlôe4_böd_öt64
(
pStmt
, 
idx
, 
vÆue
);

2461 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2462 if–
rc
!=
SQLITE4_OK
 ){

2463  
TCL_ERROR
;

2466  
TCL_OK
;

2467 
	}
}

2477 
	$ã°_böd_doubÀ
(

2478 * 
˛õ¡D©a
,

2479 
T˛_I¡îp
 *
öãΩ
,

2480 
objc
,

2481 
T˛_Obj
 *
CONST
 
objv
[]

2483 
sqlôe4_°mt
 *
pStmt
;

2484 
idx
;

2485 
vÆue
;

2486 
rc
;

2487 c⁄° *
zVÆ
;

2488 
i
;

2490 c⁄° *
zName
;

2491 
iUµî
;

2492 
iLowî
;

2493 } 
aS≥cülFp
[] = {

2506 if–
objc
!=4 ){

2507 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2508 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N VALUE", 0);

2509  
TCL_ERROR
;

2512 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2513 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
idx
ËË 
TCL_ERROR
;

2520 
zVÆ
 = 
	`T˛_GëSåög
(
objv
[3]);

2521 
i
=0; i<(
aS≥cülFp
)/(aSpecialFp[0]); i++){

2522 if–
	`°rcmp
(
aS≥cülFp
[
i
].
zName
, 
zVÆ
)==0 ){

2523 
sqlôe4_uöt64
 
x
;

2524 
x
 = 
aS≥cülFp
[
i
].
iUµî
;

2525 
x
 <<= 32;

2526 
x
 |
aS≥cülFp
[
i
].
iLowî
;

2527 
	`as£π
–(
vÆue
)==8 );

2528 
	`as£π
–(
x
)==8 );

2529 
	`mem˝y
(&
vÆue
, &
x
, 8);

2533 if–
i
>=(
aS≥cülFp
)/(aSpecialFp[0]) &&

2534 
	`T˛_GëDoubÀFromObj
(
öãΩ
, 
objv
[3], &
vÆue
) ){

2535  
TCL_ERROR
;

2537 
rc
 = 
	`sqlôe4_böd_doubÀ
(
pStmt
, 
idx
, 
vÆue
);

2538 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2539 if–
rc
!=
SQLITE4_OK
 ){

2540  
TCL_ERROR
;

2543  
TCL_OK
;

2544 
	}
}

2553 
	$ã°_böd_nuŒ
(

2554 * 
˛õ¡D©a
,

2555 
T˛_I¡îp
 *
öãΩ
,

2556 
objc
,

2557 
T˛_Obj
 *
CONST
 
objv
[]

2559 
sqlôe4_°mt
 *
pStmt
;

2560 
idx
;

2561 
rc
;

2563 if–
objc
!=3 ){

2564 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2565 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N", 0);

2566  
TCL_ERROR
;

2569 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2570 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
idx
ËË 
TCL_ERROR
;

2572 
rc
 = 
	`sqlôe4_böd_nuŒ
(
pStmt
, 
idx
);

2573 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2574 if–
rc
!=
SQLITE4_OK
 ){

2575  
TCL_ERROR
;

2578  
TCL_OK
;

2579 
	}
}

2589 
	$ã°_böd_ãxt
(

2590 * 
˛õ¡D©a
,

2591 
T˛_I¡îp
 *
öãΩ
,

2592 
objc
,

2593 
T˛_Obj
 *
CONST
 
objv
[]

2595 
sqlôe4_°mt
 *
pStmt
;

2596 
idx
;

2597 
byãs
;

2598 *
vÆue
;

2599 
rc
;

2601 if–
objc
!=5 ){

2602 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2603 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N VALUE BYTES", 0);

2604  
TCL_ERROR
;

2607 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2608 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
idx
ËË 
TCL_ERROR
;

2609 
vÆue
 = (*)
	`T˛_GëByãAºayFromObj
(
objv
[3], &
byãs
);

2610 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[4], &
byãs
ËË 
TCL_ERROR
;

2612 
rc
 = 
	`sqlôe4_böd_ãxt
(
pStmt
, 
idx
, 
vÆue
, 
byãs
, 
SQLITE4_TRANSIENT
, 0);

2613 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2614 if–
rc
!=
SQLITE4_OK
 ){

2615 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4Te°Eº‹Name
(
rc
), 0);

2616  
TCL_ERROR
;

2619  
TCL_OK
;

2620 
	}
}

2630 
	$ã°_böd_ãxt16
(

2631 * 
˛õ¡D©a
,

2632 
T˛_I¡îp
 *
öãΩ
,

2633 
objc
,

2634 
T˛_Obj
 *
CONST
 
objv
[]

2636 #i‚de‡
SQLITE4_OMIT_UTF16


2637 
sqlôe4_°mt
 *
pStmt
;

2638 
idx
;

2639 
byãs
;

2640 *
vÆue
;

2641 
rc
;

2643 (*
xDñ
)(Ë(
objc
==6?
SQLITE4_STATIC
:
SQLITE4_TRANSIENT
);

2644 
T˛_Obj
 *
oStmt
 = 
objv
[
objc
-4];

2645 
T˛_Obj
 *
oN
 = 
objv
[
objc
-3];

2646 
T˛_Obj
 *
oSåög
 = 
objv
[
objc
-2];

2647 
T˛_Obj
 *
oByãs
 = 
objv
[
objc
-1];

2649 if–
objc
!=5 && objc!=6){

2650 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2651 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N VALUE BYTES", 0);

2652  
TCL_ERROR
;

2655 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
oStmt
), &
pStmt
ËË 
TCL_ERROR
;

2656 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
oN
, &
idx
ËË 
TCL_ERROR
;

2657 
vÆue
 = (*)
	`T˛_GëByãAºayFromObj
(
oSåög
, 0);

2658 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
oByãs
, &
byãs
ËË 
TCL_ERROR
;

2660 
rc
 = 
	`sqlôe4_böd_ãxt16
(
pStmt
, 
idx
, (*)
vÆue
, 
byãs
, 
xDñ
, 0);

2661 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2662 if–
rc
!=
SQLITE4_OK
 ){

2663 
	`T˛_AµídResu…
(
öãΩ
, 
	`sqlôe4Te°Eº‹Name
(
rc
), 0);

2664  
TCL_ERROR
;

2668  
TCL_OK
;

2669 
	}
}

2678 
	$ã°_böd_blob
(

2679 * 
˛õ¡D©a
,

2680 
T˛_I¡îp
 *
öãΩ
,

2681 
objc
,

2682 
T˛_Obj
 *
CONST
 
objv
[]

2684 
sqlôe4_°mt
 *
pStmt
;

2685 
idx
;

2686 
byãs
;

2687 *
vÆue
;

2688 
rc
;

2689 
sqlôe4_de°ru˘‹_ty≥
 
xDe°ru˘‹
 = 
SQLITE4_TRANSIENT
;

2691 if–
objc
!=5 && objc!=6 ){

2692 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2693 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " STMT N DATA BYTES", 0);

2694  
TCL_ERROR
;

2697 if–
objc
==6 ){

2698 
xDe°ru˘‹
 = 
SQLITE4_STATIC
;

2699 
objv
++;

2702 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2703 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
idx
ËË 
TCL_ERROR
;

2704 
vÆue
 = 
	`T˛_GëSåög
(
objv
[3]);

2705 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[4], &
byãs
ËË 
TCL_ERROR
;

2707 
rc
 = 
	`sqlôe4_böd_blob
(
pStmt
, 
idx
, 
vÆue
, 
byãs
, 
xDe°ru˘‹
, 0);

2708 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
	`StmtToDb
(
pStmt
), 
rc
ËË 
TCL_ERROR
;

2709 if–
rc
!=
SQLITE4_OK
 ){

2710  
TCL_ERROR
;

2713  
TCL_OK
;

2714 
	}
}

2721 
	$ã°_böd_∑ømëî_cou¡
(

2722 * 
˛õ¡D©a
,

2723 
T˛_I¡îp
 *
öãΩ
,

2724 
objc
,

2725 
T˛_Obj
 *
CONST
 
objv
[]

2727 
sqlôe4_°mt
 *
pStmt
;

2729 if–
objc
!=2 ){

2730 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT");

2731  
TCL_ERROR
;

2733 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2734 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_böd_∑ømëî_cou¡
(
pStmt
)));

2735  
TCL_OK
;

2736 
	}
}

2745 
	$ã°_böd_∑ømëî_«me
(

2746 * 
˛õ¡D©a
,

2747 
T˛_I¡îp
 *
öãΩ
,

2748 
objc
,

2749 
T˛_Obj
 *
CONST
 
objv
[]

2751 
sqlôe4_°mt
 *
pStmt
;

2752 
i
;

2754 if–
objc
!=3 ){

2755 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT N");

2756  
TCL_ERROR
;

2758 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2759 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
i
ËË 
TCL_ERROR
;

2760 
	`T˛_SëObjResu…
(
öãΩ
,

2761 
	`T˛_NewSåögObj
(
	`sqlôe4_böd_∑ømëî_«me
(
pStmt
,
i
),-1)

2763  
TCL_OK
;

2764 
	}
}

2772 
	$ã°_böd_∑ømëî_ödex
(

2773 * 
˛õ¡D©a
,

2774 
T˛_I¡îp
 *
öãΩ
,

2775 
objc
,

2776 
T˛_Obj
 *
CONST
 
objv
[]

2778 
sqlôe4_°mt
 *
pStmt
;

2780 if–
objc
!=3 ){

2781 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT NAME");

2782  
TCL_ERROR
;

2784 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2785 
	`T˛_SëObjResu…
(
öãΩ
,

2786 
	`T˛_NewI¡Obj
(

2787 
	`sqlôe4_böd_∑ømëî_ödex
(
pStmt
,
	`T˛_GëSåög
(
objv
[2]))

2790  
TCL_OK
;

2791 
	}
}

2797 
	$ã°_˛ór_bödögs
(

2798 * 
˛õ¡D©a
,

2799 
T˛_I¡îp
 *
öãΩ
,

2800 
objc
,

2801 
T˛_Obj
 *
CONST
 
objv
[]

2803 
sqlôe4_°mt
 *
pStmt
;

2805 if–
objc
!=2 ){

2806 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT");

2807  
TCL_ERROR
;

2809 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

2810 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_˛ór_bödögs
(
pStmt
)));

2811  
TCL_OK
;

2812 
	}
}

2817 
	$ã°_¶ìp
(

2818 * 
˛õ¡D©a
,

2819 
T˛_I¡îp
 *
öãΩ
,

2820 
objc
,

2821 
T˛_Obj
 *
CONST
 
objv
[]

2823 
ms
;

2825 if–
objc
!=2 ){

2826 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "MILLISECONDS");

2827  
TCL_ERROR
;

2829 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
ms
) ){

2830  
TCL_ERROR
;

2832 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_¶ìp
(
ms
)));

2833  
TCL_OK
;

2834 
	}
}

2843 
	$ã°_îrcode
(

2844 * 
˛õ¡D©a
,

2845 
T˛_I¡îp
 *
öãΩ
,

2846 
objc
,

2847 
T˛_Obj
 *
CONST
 
objv
[]

2849 
sqlôe4
 *
db
;

2850 
rc
;

2852 if–
objc
!=2 ){

2853 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2854 
	`T˛_GëSåög
(
objv
[0]), " DB", 0);

2855  
TCL_ERROR
;

2857 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

2858 
rc
 = 
	`sqlôe4_îrcode
(
db
);

2859 
	`T˛_AµídResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 0);

2860  
TCL_OK
;

2861 
	}
}

2869 
	$ã°_îrmsg
(

2870 * 
˛õ¡D©a
,

2871 
T˛_I¡îp
 *
öãΩ
,

2872 
objc
,

2873 
T˛_Obj
 *
CONST
 
objv
[]

2875 
sqlôe4
 *
db
;

2876 c⁄° *
zEº
;

2878 if–
objc
!=2 ){

2879 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2880 
	`T˛_GëSåög
(
objv
[0]), " DB", 0);

2881  
TCL_ERROR
;

2883 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

2885 
zEº
 = 
	`sqlôe4_îrmsg
(
db
);

2886 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
zEº
, -1));

2887  
TCL_OK
;

2888 
	}
}

2898 
	$ã°_¥ï¨e
(

2899 * 
˛õ¡D©a
,

2900 
T˛_I¡îp
 *
öãΩ
,

2901 
objc
,

2902 
T˛_Obj
 *
CONST
 
objv
[]

2904 
sqlôe4
 *
db
;

2905 c⁄° *
zSql
;

2906 
byãs
;

2907 
nU£d
;

2908 
sqlôe4_°mt
 *
pStmt
 = 0;

2909 
zBuf
[50];

2910 
rc
;

2912 if–
objc
!=5 && objc!=4 ){

2913 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2914 
	`T˛_GëSåög
(
objv
[0]), " DB sql bytes ?tailvar?", 0);

2915  
TCL_ERROR
;

2917 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

2918 
zSql
 = 
	`T˛_GëSåög
(
objv
[2]);

2919 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
byãs
ËË 
TCL_ERROR
;

2921 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, 
byãs
, &
pStmt
, 
objc
>=5 ? &
nU£d
 : 0);

2922 
	`T˛_Re£tResu…
(
öãΩ
);

2923 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

2924 if–
objc
>=5 ){

2925 c⁄° *
zTaû
 = &
zSql
[
nU£d
];

2926 
nTaû
 = -1;

2927 if–
byãs
>=0 ){

2928 
nTaû
 = (
byãs
 - 
nU£d
);

2929 if–
nTaû
>
	`°æí
(
zTaû
) )ÇTail = strlen(zTail);

2931 
	`T˛_ObjSëV¨2
(
öãΩ
, 
objv
[4], 0, 
	`T˛_NewSåögObj
(
zTaû
, 
nTaû
), 0);

2933 if–
rc
!=
SQLITE4_OK
 ){

2934 
	`as£π
–
pStmt
==0 );

2935 
	`•rötf
(
zBuf
, "(%dË", 
rc
);

2936 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 
	`sqlôe4_îrmsg
(
db
), 0);

2937  
TCL_ERROR
;

2940 if–
pStmt
 ){

2941 if–
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
pStmt
ËË 
TCL_ERROR
;

2942 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

2944  
TCL_OK
;

2945 
	}
}

2953 
	$ã°_¥ï¨e_tkt3134
(

2954 * 
˛õ¡D©a
,

2955 
T˛_I¡îp
 *
öãΩ
,

2956 
objc
,

2957 
T˛_Obj
 *
CONST
 
objv
[]

2959 
sqlôe4
 *
db
;

2960 c⁄° 
zSql
[] = "\000SELECT 1";

2961 
sqlôe4_°mt
 *
pStmt
 = 0;

2962 
zBuf
[50];

2963 
rc
;

2965 if–
objc
!=2 ){

2966 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

2967 
	`T˛_GëSåög
(
objv
[0]), " DB sql bytesÅailvar", 0);

2968  
TCL_ERROR
;

2970 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

2971 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, &
zSql
[1], 0, &
pStmt
, 0);

2972 
	`as£π
(
rc
==
SQLITE4_OK
 || 
pStmt
==0);

2973 if–
	`sqlôe4Te°EºCode
(
öãΩ
, 
db
, 
rc
ËË 
TCL_ERROR
;

2974 if–
rc
!=
SQLITE4_OK
 ){

2975 
	`as£π
–
pStmt
==0 );

2976 
	`•rötf
(
zBuf
, "(%dË", 
rc
);

2977 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 
	`sqlôe4_îrmsg
(
db
), 0);

2978  
TCL_ERROR
;

2981 if–
pStmt
 ){

2982 if–
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
pStmt
ËË 
TCL_ERROR
;

2983 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

2985  
TCL_OK
;

2986 
	}
}

2991 
	$ã°_›í
(

2992 * 
˛õ¡D©a
,

2993 
T˛_I¡îp
 *
öãΩ
,

2994 
objc
,

2995 
T˛_Obj
 *
CONST
 
objv
[]

2997 c⁄° *
zFûíame
;

2998 
sqlôe4
 *
db
;

2999 
rc
;

3000 
zBuf
[100];

3002 if–
objc
!=3 && objc!=2 && objc!=1 ){

3003 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3004 
	`T˛_GëSåög
(
objv
[0]), " filename options-list", 0);

3005  
TCL_ERROR
;

3008 
zFûíame
 = 
objc
>1 ? 
	`T˛_GëSåög
(
objv
[1]) : 0;

3009 
rc
 = 
	`sqlôe4_›í
(0, 
zFûíame
, &
db
, 0);

3011 if–
rc
!=
SQLITE4_OK


3012 || 
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
db
)

3014  
TCL_ERROR
;

3016 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

3017  
TCL_OK
;

3018 
	}
}

3023 
	$ã°_›í_v2
(

3024 * 
˛õ¡D©a
,

3025 
T˛_I¡îp
 *
öãΩ
,

3026 
objc
,

3027 
T˛_Obj
 *
CONST
 
objv
[]

3029 c⁄° *
zFûíame
;

3030 c⁄° *
zVfs
;

3031 
Êags
 = 0;

3032 
sqlôe4
 *
db
;

3033 
rc
;

3034 
zBuf
[100];

3036 
nFœg
;

3037 
T˛_Obj
 **
≠Fœg
;

3038 
i
;

3040 if–
objc
!=4 ){

3041 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "FILENAME FLAGS VFS");

3042  
TCL_ERROR
;

3044 
zFûíame
 = 
	`T˛_GëSåög
(
objv
[1]);

3045 
zVfs
 = 
	`T˛_GëSåög
(
objv
[3]);

3046 if–
zVfs
[0]==0x00 ) zVfs = 0;

3048 
rc
 = 
	`T˛_Li°ObjGëEÀmíts
(
öãΩ
, 
objv
[2], &
nFœg
, &
≠Fœg
);

3049 if–
rc
!=
TCL_OK
 ) Ñc;

3050 
i
=0; i<
nFœg
; i++){

3051 
iFœg
;

3052 
	sO≥nFœg
 {

3053 c⁄° *
zFœg
;

3054 
Êag
;

3055 } 
aFœg
[] = {

3056 { "SQLITE4_OPEN_READONLY", 
SQLITE4_OPEN_READONLY
 },

3057 { "SQLITE4_OPEN_READWRITE", 
SQLITE4_OPEN_READWRITE
 },

3058 { "SQLITE4_OPEN_CREATE", 
SQLITE4_OPEN_CREATE
 },

3061 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(
öãΩ
, 
≠Fœg
[
i
], 
aFœg
, (aFlag[0]),

3062 "Êag", 0, &
iFœg


3064 if–
rc
!=
TCL_OK
 ) Ñc;

3065 
Êags
 |
aFœg
[
iFœg
].
Êag
;

3068 
rc
 = 
	`sqlôe4_›í
(0, 
zFûíame
, &
db
, 0);

3069 if–
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
db
ËË 
TCL_ERROR
;

3070 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

3071  
TCL_OK
;

3072 
	}
}

3079 
	$ã°_°ï
(

3080 * 
˛õ¡D©a
,

3081 
T˛_I¡îp
 *
öãΩ
,

3082 
objc
,

3083 
T˛_Obj
 *
CONST
 
objv
[]

3085 
sqlôe4_°mt
 *
pStmt
;

3086 
rc
;

3088 if–
objc
!=2 ){

3089 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3090 
	`T˛_GëSåög
(
objv
[0]), " STMT", 0);

3091  
TCL_ERROR
;

3094 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3095 
rc
 = 
	`sqlôe4_°ï
(
pStmt
);

3098 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 0);

3099  
TCL_OK
;

3100 
	}
}

3102 
	$ã°_°mt_sql
(

3103 * 
˛õ¡D©a
,

3104 
T˛_I¡îp
 *
öãΩ
,

3105 
objc
,

3106 
T˛_Obj
 *
CONST
 
objv
[]

3108 
sqlôe4_°mt
 *
pStmt
;

3110 if–
objc
!=2 ){

3111 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT");

3112  
TCL_ERROR
;

3115 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3116 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4_°mt_sql
(
pStmt
), 
TCL_VOLATILE
);

3117  
TCL_OK
;

3118 
	}
}

3125 
	$ã°_cﬁumn_cou¡
(

3126 * 
˛õ¡D©a
,

3127 
T˛_I¡îp
 *
öãΩ
,

3128 
objc
,

3129 
T˛_Obj
 *
CONST
 
objv
[]

3131 
sqlôe4_°mt
 *
pStmt
;

3133 if–
objc
!=2 ){

3134 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3135 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3136  
TCL_ERROR
;

3139 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3141 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_cﬁumn_cou¡
(
pStmt
)));

3142  
TCL_OK
;

3143 
	}
}

3150 
	$ã°_cﬁumn_ty≥
(

3151 * 
˛õ¡D©a
,

3152 
T˛_I¡îp
 *
öãΩ
,

3153 
objc
,

3154 
T˛_Obj
 *
CONST
 
objv
[]

3156 
sqlôe4_°mt
 *
pStmt
;

3157 
cﬁ
;

3158 
ç
;

3160 if–
objc
!=3 ){

3161 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3162 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3163  
TCL_ERROR
;

3166 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3167 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

3169 
ç
 = 
	`sqlôe4_cﬁumn_ty≥
(
pStmt
, 
cﬁ
);

3170  
ç
 ){

3171 
SQLITE4_INTEGER
:

3172 
	`T˛_SëResu…
(
öãΩ
, "INTEGER", 
TCL_STATIC
);

3174 
SQLITE4_NULL
:

3175 
	`T˛_SëResu…
(
öãΩ
, "NULL", 
TCL_STATIC
);

3177 
SQLITE4_FLOAT
:

3178 
	`T˛_SëResu…
(
öãΩ
, "FLOAT", 
TCL_STATIC
);

3180 
SQLITE4_TEXT
:

3181 
	`T˛_SëResu…
(
öãΩ
, "TEXT", 
TCL_STATIC
);

3183 
SQLITE4_BLOB
:

3184 
	`T˛_SëResu…
(
öãΩ
, "BLOB", 
TCL_STATIC
);

3187 
	`as£π
(0);

3190  
TCL_OK
;

3191 
	}
}

3199 
	$ã°_cﬁumn_öt64
(

3200 * 
˛õ¡D©a
,

3201 
T˛_I¡îp
 *
öãΩ
,

3202 
objc
,

3203 
T˛_Obj
 *
CONST
 
objv
[]

3205 
sqlôe4_°mt
 *
pStmt
;

3206 
cﬁ
;

3207 
i64
 
iVÆ
;

3209 if–
objc
!=3 ){

3210 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3211 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3212  
TCL_ERROR
;

3215 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3216 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

3218 
iVÆ
 = 
	`sqlôe4_cﬁumn_öt64
(
pStmt
, 
cﬁ
);

3219 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewWideI¡Obj
(
iVÆ
));

3220  
TCL_OK
;

3221 
	}
}

3226 
	$ã°_cﬁumn_blob
(

3227 * 
˛õ¡D©a
,

3228 
T˛_I¡îp
 *
öãΩ
,

3229 
objc
,

3230 
T˛_Obj
 *
CONST
 
objv
[]

3232 
sqlôe4_°mt
 *
pStmt
;

3233 
cﬁ
;

3235 
Àn
;

3236 c⁄° *
pBlob
;

3238 if–
objc
!=3 ){

3239 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3240 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3241  
TCL_ERROR
;

3244 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3245 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

3247 
pBlob
 = 
	`sqlôe4_cﬁumn_blob
(
pStmt
, 
cﬁ
, &
Àn
);

3248 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewByãAºayObj
(
pBlob
, 
Àn
));

3249  
TCL_OK
;

3250 
	}
}

3257 
	$ã°_cﬁumn_doubÀ
(

3258 * 
˛õ¡D©a
,

3259 
T˛_I¡îp
 *
öãΩ
,

3260 
objc
,

3261 
T˛_Obj
 *
CONST
 
objv
[]

3263 
sqlôe4_°mt
 *
pStmt
;

3264 
cﬁ
;

3265 
rVÆ
;

3267 if–
objc
!=3 ){

3268 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3269 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3270  
TCL_ERROR
;

3273 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3274 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

3276 
rVÆ
 = 
	`sqlôe4_cﬁumn_doubÀ
(
pStmt
, 
cﬁ
);

3277 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewDoubÀObj
(
rVÆ
));

3278  
TCL_OK
;

3279 
	}
}

3286 
	$ã°_d©a_cou¡
(

3287 * 
˛õ¡D©a
,

3288 
T˛_I¡îp
 *
öãΩ
,

3289 
objc
,

3290 
T˛_Obj
 *
CONST
 
objv
[]

3292 
sqlôe4_°mt
 *
pStmt
;

3294 if–
objc
!=2 ){

3295 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3296 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3297  
TCL_ERROR
;

3300 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3302 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`sqlôe4_d©a_cou¡
(
pStmt
)));

3303  
TCL_OK
;

3304 
	}
}

3313 
	$ã°_°mt_utf8
(

3314 * 
˛õ¡D©a
,

3315 
T˛_I¡îp
 *
öãΩ
,

3316 
objc
,

3317 
T˛_Obj
 *
CONST
 
objv
[]

3319 
sqlôe4_°mt
 *
pStmt
;

3320 
cﬁ
;

3321 c⁄° *(*
xFunc
)(
sqlôe4_°mt
*, , *);

3322 c⁄° *
zRë
;

3324 
xFunc
 = (c⁄° *(*)(
sqlôe4_°mt
*, , *))
˛õ¡D©a
;

3325 if–
objc
!=3 ){

3326 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3327 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3328  
TCL_ERROR
;

3331 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3332 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

3333 
zRë
 = 
	`xFunc
(
pStmt
, 
cﬁ
, 0);

3334 if–
zRë
 ){

3335 
	`T˛_SëResu…
(
öãΩ
, (*)
zRë
, 0);

3337  
TCL_OK
;

3338 
	}
}

3343 
	$ã°_°mt_öt
(

3344 * 
˛õ¡D©a
,

3345 
T˛_I¡îp
 *
öãΩ
,

3346 
objc
,

3347 
T˛_Obj
 *
CONST
 
objv
[]

3349 
sqlôe4_°mt
 *
pStmt
;

3350 
cﬁ
;

3351 (*
xFunc
)(
sqlôe4_°mt
*, );

3353 
xFunc
 = ((*)(
sqlôe4_°mt
*, ))
˛õ¡D©a
;

3354 if–
objc
!=3 ){

3355 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3356 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

3357  
TCL_ERROR
;

3360 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3361 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

3363 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`xFunc
(
pStmt
, 
cﬁ
)));

3364  
TCL_OK
;

3365 
	}
}

3372 
	$sqlôe_£t_magic
(

3373 * 
˛õ¡D©a
,

3374 
T˛_I¡îp
 *
öãΩ
,

3375 
¨gc
,

3376 **
¨gv


3378 
sqlôe4
 *
db
;

3379 if–
¨gc
!=3 ){

3380 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

3382  
TCL_ERROR
;

3384 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

3385 if–
	`°rcmp
(
¨gv
[2], "SQLITE4_MAGIC_OPEN")==0 ){

3386 
db
->
magic
 = 
SQLITE4_MAGIC_OPEN
;

3387 }if–
	`°rcmp
(
¨gv
[2], "SQLITE4_MAGIC_CLOSED")==0 ){

3388 
db
->
magic
 = 
SQLITE4_MAGIC_CLOSED
;

3389 }if–
	`°rcmp
(
¨gv
[2], "SQLITE4_MAGIC_BUSY")==0 ){

3390 
db
->
magic
 = 
SQLITE4_MAGIC_BUSY
;

3391 }if–
	`°rcmp
(
¨gv
[2], "SQLITE4_MAGIC_ERROR")==0 ){

3392 
db
->
magic
 = 
SQLITE4_MAGIC_ERROR
;

3393 }if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[2], (*)&
db
->
magic
) ){

3394  
TCL_ERROR
;

3396  
TCL_OK
;

3397 
	}
}

3404 
	$ã°_öãºu±
(

3405 * 
˛õ¡D©a
,

3406 
T˛_I¡îp
 *
öãΩ
,

3407 
¨gc
,

3408 **
¨gv


3410 
sqlôe4
 *
db
;

3411 if–
¨gc
!=2 ){

3412 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0], " DB", 0);

3413  
TCL_ERROR
;

3415 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

3416 
	`sqlôe4_öãºu±
(
db
);

3417  
TCL_OK
;

3418 
	}
}

3420 
u8
 *
	gsqlôe4_°ack_ba£löe
 = 0;

3425 
	$¥ïSèck
(){

3426 
i
;

3427 
u32
 
bigBuf
[65536];

3428 
i
=0; i<(
bigBuf
)/(bigBuf[0]); i++) bigBuf[i] = 0xdeadbeef;

3429 
sqlôe4_°ack_ba£löe
 = (
u8
*)&
bigBuf
[65536];

3430 
	}
}

3435 
u64
 
	$sqlôe4SèckDïth
(){

3436 
u8
 
x
;

3437  (
u64
)(
sqlôe4_°ack_ba£löe
 - &
x
);

3438 
	}
}

3445 
	$ã°_°ack_u£d
(

3446 * 
˛õ¡D©a
,

3447 
T˛_I¡îp
 *
öãΩ
,

3448 
¨gc
,

3449 **
¨gv


3451 
sqlôe4
 *
db
;

3452 
i
;

3453 if–
¨gc
!=3 ){

3454 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

3456  
TCL_ERROR
;

3458 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

3459 
	`¥ïSèck
();

3460 ()
	`sqlôe4_exec
(
db
, 
¨gv
[2], 0, 0);

3461 
i
=65535; i>=0 && ((
u32
*)
sqlôe4_°ack_ba£löe
)[-i]==0xdeadbeef; i--){}

3462 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
i
*4));

3463  
TCL_OK
;

3464 
	}
}

3473 
	$dñëe_fun˘i⁄
(

3474 * 
˛õ¡D©a
,

3475 
T˛_I¡îp
 *
öãΩ
,

3476 
¨gc
,

3477 **
¨gv


3479 
rc
;

3480 
sqlôe4
 *
db
;

3481 if–
¨gc
!=3 ){

3482 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

3484  
TCL_ERROR
;

3486 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

3487 
rc
 = 
	`sqlôe4_¸óã_fun˘i⁄
(
db
, 
¨gv
[2], -1, 0, 0, 0, 0, 0);

3488 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 
TCL_STATIC
);

3489  
TCL_OK
;

3490 
	}
}

3497 
	$dñëe_cﬁœti⁄
(

3498 * 
˛õ¡D©a
,

3499 
T˛_I¡îp
 *
öãΩ
,

3500 
¨gc
,

3501 **
¨gv


3503 
rc
;

3504 
sqlôe4
 *
db
;

3505 if–
¨gc
!=3 ){

3506 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

3508  
TCL_ERROR
;

3510 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

3511 
rc
 = 
	`sqlôe4_¸óã_cﬁœti⁄
(
db
, 
¨gv
[2], 0, 0, 0, 0);

3512 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 
TCL_STATIC
);

3513  
TCL_OK
;

3514 
	}
}

3522 
	$db_å™ß˘i⁄_°©us
(

3523 * 
˛õ¡D©a
,

3524 
T˛_I¡îp
 *
öãΩ
,

3525 
¨gc
,

3526 **
¨gv


3528 
zBuf
[30];

3529 
sqlôe4
 *
db
;

3530 if–
¨gc
!=2 ){

3531 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

3533  
TCL_ERROR
;

3535 if–
	`gëDbPoöãr
(
öãΩ
, 
¨gv
[1], &
db
ËË 
TCL_ERROR
;

3536 
	`•rötf
(
zBuf
, "%d", 
	`sqlôe4_db_å™ß˘i⁄_°©us
(
db
));

3537 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

3538  
TCL_OK
;

3539 
	}
}

3547 
	$t˛_v¨übÀ_ty≥
(

3548 * 
˛õ¡D©a
,

3549 
T˛_I¡îp
 *
öãΩ
,

3550 
objc
,

3551 
T˛_Obj
 *
CONST
 
objv
[]

3553 
T˛_Obj
 *
pV¨
;

3554 if–
objc
!=2 ){

3555 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "VARIABLE");

3556  
TCL_ERROR
;

3558 
pV¨
 = 
	`T˛_GëV¨2Ex
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), 0, 
TCL_LEAVE_ERR_MSG
);

3559 if–
pV¨
==0 )  
TCL_ERROR
;

3560 if–
pV¨
->
ty≥På
 ){

3561 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewSåögObj
(
pV¨
->
ty≥På
->
«me
, -1));

3563  
TCL_OK
;

3564 
	}
}

3572 
	$ã°_db_ªÀa£_mem‹y
(

3573 * 
˛õ¡D©a
,

3574 
T˛_I¡îp
 *
öãΩ
,

3575 
objc
,

3576 
T˛_Obj
 *
CONST
 
objv
[]

3578 
sqlôe4
 *
db
;

3579 
rc
;

3580 if–
objc
!=2 ){

3581 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB");

3582  
TCL_ERROR
;

3584 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

3585 
rc
 = 
	`sqlôe4_db_ªÀa£_mem‹y
(
db
);

3586 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
rc
));

3587  
TCL_OK
;

3588 
	}
}

3603 
	$w‹kög_64bô_öt
(

3604 
Clõ¡D©a
 
˛õ¡D©a
,

3605 
T˛_I¡îp
 *
öãΩ
,

3606 
objc
,

3607 
T˛_Obj
 *
CONST
 
objv
[]

3609 
T˛_Obj
 *
pTe°Obj
;

3610 
w‹kög
 = 0;

3612 
pTe°Obj
 = 
	`T˛_NewWideI¡Obj
(1000000*(
i64
)1234567890);

3613 
w‹kög
 = 
	`°rcmp
(
	`T˛_GëSåög
(
pTe°Obj
), "1234567890000000")==0;

3614 
	`T˛_De¸RefCou¡
(
pTe°Obj
);

3615 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewBoﬁónObj
(
w‹kög
));

3616  
TCL_OK
;

3617 
	}
}

3626 
	$ã°_limô
(

3627 
Clõ¡D©a
 
˛õ¡D©a
,

3628 
T˛_I¡îp
 *
öãΩ
,

3629 
objc
,

3630 
T˛_Obj
 *
CONST
 
objv
[]

3632 
sqlôe4
 *
db
;

3633 
rc
;

3635 *
zName
;

3636 
id
;

3637 } 
aId
[] = {

3638 { "SQLITE4_LIMIT_LENGTH", 
SQLITE4_LIMIT_LENGTH
 },

3639 { "SQLITE4_LIMIT_SQL_LENGTH", 
SQLITE4_LIMIT_SQL_LENGTH
 },

3640 { "SQLITE4_LIMIT_COLUMN", 
SQLITE4_LIMIT_COLUMN
 },

3641 { "SQLITE4_LIMIT_EXPR_DEPTH", 
SQLITE4_LIMIT_EXPR_DEPTH
 },

3642 { "SQLITE4_LIMIT_COMPOUND_SELECT", 
SQLITE4_LIMIT_COMPOUND_SELECT
 },

3643 { "SQLITE4_LIMIT_VDBE_OP", 
SQLITE4_LIMIT_VDBE_OP
 },

3644 { "SQLITE4_LIMIT_FUNCTION_ARG", 
SQLITE4_LIMIT_FUNCTION_ARG
 },

3645 { "SQLITE4_LIMIT_ATTACHED", 
SQLITE4_LIMIT_ATTACHED
 },

3646 { "SQLITE4_LIMIT_LIKE_PATTERN_LENGTH", 
SQLITE4_LIMIT_LIKE_PATTERN_LENGTH
 },

3647 { "SQLITE4_LIMIT_VARIABLE_NUMBER", 
SQLITE4_LIMIT_VARIABLE_NUMBER
 },

3648 { "SQLITE4_LIMIT_TRIGGER_DEPTH", 
SQLITE4_LIMIT_TRIGGER_DEPTH
 },

3652 { "SQLITE4_LIMIT_TOOBIG", 
SQLITE4_LIMIT_TRIGGER_DEPTH
+1 },

3654 
i
, 
id
;

3655 
vÆ
;

3656 c⁄° *
zId
;

3658 if–
objc
!=4 ){

3659 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

3660 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " DB ID VALUE", 0);

3661  
TCL_ERROR
;

3663 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

3664 
zId
 = 
	`T˛_GëSåög
(
objv
[2]);

3665 
i
=0; i<(
aId
)/(aId[0]); i++){

3666 if–
	`°rcmp
(
zId
, 
aId
[
i
].
zName
)==0 ){

3667 
id
 = 
aId
[
i
].id;

3671 if–
i
>=(
aId
)/(aId[0]) ){

3672 
	`T˛_AµídResu…
(
öãΩ
, "unknow¿limôÅy≥: ", 
zId
, (*)0);

3673  
TCL_ERROR
;

3675 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
vÆ
ËË 
TCL_ERROR
;

3676 
rc
 = 
	`sqlôe4_limô
(
db
, 
id
, 
vÆ
);

3677 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
rc
));

3678  
TCL_OK
;

3679 
	}
}

3682 #ifde‡
SQLITE4_ENABLE_UNLOCK_NOTIFY


3683 
	$ã°_u∆ock_nŸify_cb
(**
aArg
, 
nArg
){

3684 
ii
;

3685 
ii
=0; ii<
nArg
; ii++){

3686 
	`T˛_EvÆEx
((
T˛_I¡îp
 *)
aArg
[
ii
], "u∆ock_nŸify", -1, 
TCL_EVAL_GLOBAL
);

3688 
	}
}

3694 #ifde‡
SQLITE4_ENABLE_UNLOCK_NOTIFY


3695 
	$ã°_u∆ock_nŸify
(

3696 
Clõ¡D©a
 
˛õ¡D©a
,

3697 
T˛_I¡îp
 *
öãΩ
,

3698 
objc
,

3699 
T˛_Obj
 *
CONST
 
objv
[]

3701 
sqlôe4
 *
db
;

3702 
rc
;

3704 if–
objc
!=2 ){

3705 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB");

3706  
TCL_ERROR
;

3709 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
) ){

3710  
TCL_ERROR
;

3712 
rc
 = 
	`sqlôe4_u∆ock_nŸify
(
db
, 
ã°_u∆ock_nŸify_cb
, (*)
öãΩ
);

3713 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 
TCL_STATIC
);

3714  
TCL_OK
;

3715 
	}
}

3722 
	sLogCÆlback
 {

3723 
T˛_I¡îp
 *
	mpI¡îp
;

3724 
T˛_Obj
 *
	mpObj
;

3725 } 
	glogˇŒback
 = {0, 0};

3726 
	$xLogˇŒback
(*
unu£d
, 
îr
, *
zMsg
){

3727 
T˛_Obj
 *
pNew
 = 
	`T˛_Du∂iˇãObj
(
logˇŒback
.
pObj
);

3728 
	`T˛_In¸RefCou¡
(
pNew
);

3729 
	`T˛_Li°ObjAµídEÀmít
(

3730 0, 
pNew
, 
	`T˛_NewSåögObj
(
	`sqlôe4Te°Eº‹Name
(
îr
), -1)

3732 
	`T˛_Li°ObjAµídEÀmít
(0, 
pNew
, 
	`T˛_NewSåögObj
(
zMsg
, -1));

3733 
	`T˛_EvÆObjEx
(
logˇŒback
.
pI¡îp
, 
pNew
, 
TCL_EVAL_GLOBAL
|
TCL_EVAL_DIRECT
);

3734 
	`T˛_De¸RefCou¡
(
pNew
);

3735 
	}
}

3736 
	$ã°_sqlôe4_log
(

3737 
Clõ¡D©a
 
˛õ¡D©a
,

3738 
T˛_I¡îp
 *
öãΩ
,

3739 
objc
,

3740 
T˛_Obj
 *
CONST
 
objv
[]

3742 if–
objc
>2 ){

3743 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SCRIPT");

3744  
TCL_ERROR
;

3746 if–
logˇŒback
.
pObj
 ){

3747 
	`T˛_De¸RefCou¡
(
logˇŒback
.
pObj
);

3748 
logˇŒback
.
pObj
 = 0;

3749 
logˇŒback
.
pI¡îp
 = 0;

3750 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_LOG
, 0, 0);

3752 if–
objc
>1 ){

3753 
logˇŒback
.
pObj
 = 
objv
[1];

3754 
	`T˛_In¸RefCou¡
(
logˇŒback
.
pObj
);

3755 
logˇŒback
.
pI¡îp
 = 
öãΩ
;

3756 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_LOG
, 
xLogˇŒback
, 0);

3758  
TCL_OK
;

3759 
	}
}

3767 
	$runAsObjProc
(

3768 * 
˛õ¡D©a
,

3769 
T˛_I¡îp
 *
öãΩ
,

3770 
objc
,

3771 
T˛_Obj
 *
CONST
 
objv
[]

3773 
T˛_CmdInfo
 
cmdInfo
;

3774 if–
objc
<2 ){

3775 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "COMMAND ...");

3776  
TCL_ERROR
;

3778 if–!
	`T˛_GëComm™dInfo
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
cmdInfo
) ){

3779 
	`T˛_AµídResu…
(
öãΩ
, "commandÇot found: ",

3780 
	`T˛_GëSåög
(
objv
[1]), (*)0);

3781  
TCL_ERROR
;

3783 if–
cmdInfo
.
objProc
==0 ){

3784 
	`T˛_AµídResu…
(
öãΩ
, "command hasÇo objProc: ",

3785 
	`T˛_GëSåög
(
objv
[1]), (*)0);

3786  
TCL_ERROR
;

3788  
cmdInfo
.
	`objProc
(cmdInfo.
objClõ¡D©a
, 
öãΩ
, 
objc
-1, 
objv
+1);

3789 
	}
}

3791 #i‚de‡
SQLITE4_OMIT_EXPLAIN


3802 
	$¥ötEx∂aöQuîyPœn
(
sqlôe4_°mt
 *
pStmt
){

3803 c⁄° *
zSql
;

3804 *
zEx∂aö
;

3805 
sqlôe4_°mt
 *
pEx∂aö
;

3806 
rc
;

3808 
zSql
 = 
	`sqlôe4_°mt_sql
(
pStmt
);

3809 if–
zSql
==0 )  
SQLITE4_ERROR
;

3811 
zEx∂aö
 = 
	`sqlôe4_m¥ötf
(0, "EXPLAIN QUERY PLAN %s", 
zSql
);

3812 if–
zEx∂aö
==0 )  
SQLITE4_NOMEM
;

3814 
rc
 = 
	`sqlôe4_¥ï¨e
(
	`sqlôe4_db_h™dÀ
(
pStmt
), 
zEx∂aö
, -1, &
pEx∂aö
, 0);

3815 
	`sqlôe4_‰ì
(0, 
zEx∂aö
);

3816 if–
rc
!=
SQLITE4_OK
 ) Ñc;

3818  
SQLITE4_ROW
==
	`sqlôe4_°ï
(
pEx∂aö
) ){

3819 
iSñe˘id
 = 
	`sqlôe4_cﬁumn_öt
(
pEx∂aö
, 0);

3820 
iOrdî
 = 
	`sqlôe4_cﬁumn_öt
(
pEx∂aö
, 1);

3821 
iFrom
 = 
	`sqlôe4_cﬁumn_öt
(
pEx∂aö
, 2);

3822 c⁄° *
zDëaû
 = (c⁄° *)
	`sqlôe4_cﬁumn_ãxt
(
pEx∂aö
, 3, 0);

3824 
	`¥ötf
("%d %d %d %s\n", 
iSñe˘id
, 
iOrdî
, 
iFrom
, 
zDëaû
);

3827  
	`sqlôe4_föÆize
(
pEx∂aö
);

3828 
	}
}

3830 
	$ã°_¥öt_eqp
(

3831 * 
˛õ¡D©a
,

3832 
T˛_I¡îp
 *
öãΩ
,

3833 
objc
,

3834 
T˛_Obj
 *
CONST
 
objv
[]

3836 
rc
;

3837 
sqlôe4_°mt
 *
pStmt
;

3839 if–
objc
!=2 ){

3840 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT");

3841  
TCL_ERROR
;

3843 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

3844 
rc
 = 
	`¥ötEx∂aöQuîyPœn
(
pStmt
);

3849 
	`fÊush
(
°dout
);

3850 
	`T˛_SëResu…
(
öãΩ
, (*)
	`t1Eº‹Name
(
rc
), 0);

3851  
TCL_OK
;

3852 
	}
}

3855 
	$ã°_¥ng_°©e_gë
(

3856 * 
˛õ¡D©a
,

3857 
T˛_I¡îp
 *
öãΩ
,

3858 
objc
,

3859 
T˛_Obj
 *
CONST
 
objv
[]

3861 
sqlôe4_öt64
 
iVÆ
;

3862 if–
objc
!=0 ){

3863 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

3864  
TCL_ERROR
;

3866 
	`sqlôe4_ã°_c⁄åﬁ
(
SQLITE4_TESTCTRL_PRNG_SET
, (
sqlôe4_ív
 *)0, &
iVÆ
);

3867 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewWideI¡Obj
(
iVÆ
));

3868  
TCL_OK
;

3869 
	}
}

3871 
	$ã°_¥ng_°©e_£t
(

3872 * 
˛õ¡D©a
,

3873 
T˛_I¡îp
 *
öãΩ
,

3874 
objc
,

3875 
T˛_Obj
 *
CONST
 
objv
[]

3877 
sqlôe4_öt64
 
iVÆ
;

3878 if–
objc
!=2 ){

3879 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "VALUE");

3880  
TCL_ERROR
;

3882 if–
	`T˛_GëWideI¡FromObj
(
öãΩ
, 
objv
[1], &
iVÆ
) ){

3883  
TCL_ERROR
;

3885 
	`sqlôe4_ã°_c⁄åﬁ
(
SQLITE4_TESTCTRL_PRNG_SET
, (
sqlôe4_ív
 *)0, 
iVÆ
);

3886  
TCL_OK
;

3887 
	}
}

3892 
	$ã°_ã°_c⁄åﬁ
(

3893 * 
˛õ¡D©a
,

3894 
T˛_I¡îp
 *
öãΩ
,

3895 
objc
,

3896 
T˛_Obj
 *
CONST
 
objv
[]

3898 
	sVîb
 {

3899 c⁄° *
zName
;

3900 
i
;

3901 } 
aVîb
[] = {

3902 { "SQLITE4_TESTCTRL_LOCALTIME_FAULT", 
SQLITE4_TESTCTRL_LOCALTIME_FAULT
 },

3904 
iVîb
;

3905 
iFœg
;

3906 
rc
;

3908 if–
objc
<2 ){

3909 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "VERB ARGS...");

3910  
TCL_ERROR
;

3913 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

3914 
öãΩ
, 
objv
[1], 
aVîb
, ◊Vîb[0]), "VERB", 0, &
iVîb


3916 if–
rc
!=
TCL_OK
 ) Ñc;

3918 
iFœg
 = 
aVîb
[
iVîb
].
i
;

3919  
iFœg
 ){

3920 
SQLITE4_TESTCTRL_LOCALTIME_FAULT
: {

3921 
vÆ
;

3922 if–
objc
!=3 ){

3923 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, "ONOFF");

3924  
TCL_ERROR
;

3926 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[2], &
vÆ
ËË 
TCL_ERROR
;

3927 
	`sqlôe4_ã°_c⁄åﬁ
(
SQLITE4_TESTCTRL_LOCALTIME_FAULT
, 
vÆ
);

3932 
	`T˛_Re£tResu…
(
öãΩ
);

3933  
TCL_OK
;

3934 
	}
}

3936 #i‡
SQLITE4_OS_WIN


3941 
	swö32FûeLockî
 {

3942 *
	mevName
;

3943 
HANDLE
 
	mh
;

3944 
	mdñay1
;

3945 
	mdñay2
;

3946 
	mok
;

3947 
	mîr
;

3952 #i‡
SQLITE4_OS_WIN


3956 
	$wö32_fûe_lockî
(*
pAµD©a
){

3957 
wö32FûeLockî
 *
p
 = (wö32FûeLockî*)
pAµD©a
;

3958 if–
p
->
evName
 ){

3959 
HANDLE
 
ev
 = 
	`O≥nEvít
(
EVENT_MODIFY_STATE
, 
FALSE
, 
p
->
evName
);

3960 i‡–
ev
 ){

3961 
	`SëEvít
(
ev
);

3962 
	`Clo£H™dÀ
(
ev
);

3965 if–
p
->
dñay1
 ) 
	`SÀï
(p->delay1);

3966 if–
	`LockFûe
(
p
->
h
, 0, 0, 100000000, 0) ){

3967 
	`SÀï
(
p
->
dñay2
);

3968 
	`U∆ockFûe
(
p
->
h
, 0, 0, 100000000, 0);

3969 
p
->
ok
 = 1;

3971 
p
->
îr
 = 1;

3973 
	`Clo£H™dÀ
(
p
->
h
);

3974 
p
->
h
 = 0;

3975 
p
->
dñay1
 = 0;

3976 
p
->
dñay2
 = 0;

3977 
	}
}

3980 #i‡
SQLITE4_OS_WIN


3987 
	$wö32_fûe_lock
(

3988 * 
˛õ¡D©a
,

3989 
T˛_I¡îp
 *
öãΩ
,

3990 
objc
,

3991 
T˛_Obj
 *
CONST
 
objv
[]

3993 
wö32FûeLockî
 
x
 = { "win32_file_lock", 0, 0, 0, 0, 0 };

3994 c⁄° *
zFûíame
;

3995 
zBuf
[200];

3996 
ªåy
 = 0;

3997 
HANDLE
 
ev
;

3998 
DWORD
 
wResu…
;

4000 if–
objc
!=4 && objc!=1 ){

4001 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "FILENAME DELAY1 DELAY2");

4002  
TCL_ERROR
;

4004 if–
objc
==1 ){

4005 
	`sqlôe4_¢¥ötf
(
zBuf
, (zBuf), "%d %d %d %d %d",

4006 
x
.
ok
, x.
îr
, x.
dñay1
, x.
dñay2
, x.
h
);

4007 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, (*)0);

4008  
TCL_OK
;

4010  
x
.
h
 && 
ªåy
<30 ){

4011 
ªåy
++;

4012 
	`SÀï
(100);

4014 if–
x
.
h
 ){

4015 
	`T˛_AµídResu…
(
öãΩ
, "busy", (*)0);

4016  
TCL_ERROR
;

4018 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
x
.
dñay1
ËË 
TCL_ERROR
;

4019 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
x
.
dñay2
ËË 
TCL_ERROR
;

4020 
zFûíame
 = 
	`T˛_GëSåög
(
objv
[1]);

4021 
x
.
h
 = 
	`Cª©eFûe
(
zFûíame
, 
GENERIC_READ
|
GENERIC_WRITE
,

4022 
FILE_SHARE_READ
|
FILE_SHARE_WRITE
, 0, 
OPEN_ALWAYS
,

4023 
FILE_ATTRIBUTE_NORMAL
, 0);

4024 if–!
x
.
h
 ){

4025 
	`T˛_AµídResu…
(
öãΩ
, "ˇ¬Ÿ o≥¿fûe: ", 
zFûíame
, (*)0);

4026  
TCL_ERROR
;

4028 
ev
 = 
	`Cª©eEvít
(
NULL
, 
TRUE
, 
FALSE
, 
x
.
evName
);

4029 i‡–!
ev
 ){

4030 
	`T˛_AµídResu…
(
öãΩ
, "ˇ¬Ÿ cª©êevít: ", 
x
.
evName
, (*)0);

4031  
TCL_ERROR
;

4033 
	`_begöthªad
(
wö32_fûe_lockî
, 0, (*)&
x
);

4034 
	`SÀï
(0);

4035 i‡–(
wResu…
 = 
	`WaôF‹SögÀObje˘
(
ev
, 10000))!=
WAIT_OBJECT_0
 ){

4036 
	`sqlôe4_¢¥ötf
(
zBuf
, (zBuf), "0x%x", 
wResu…
);

4037 
	`T˛_AµídResu…
(
öãΩ
, "waô faûed: ", 
zBuf
, (*)0);

4038 
	`Clo£H™dÀ
(
ev
);

4039  
TCL_ERROR
;

4041 
	`Clo£H™dÀ
(
ev
);

4042  
TCL_OK
;

4043 
	}
}

4054 
	$›timiz©i⁄_c⁄åﬁ
(

4055 * 
˛õ¡D©a
,

4056 
T˛_I¡îp
 *
öãΩ
,

4057 
objc
,

4058 
T˛_Obj
 *
CONST
 
objv
[]

4060 
i
;

4061 
sqlôe4
 *
db
;

4062 c⁄° *
zO±
;

4063 
⁄off
;

4064 
mask
;

4066 c⁄° *
zO±Name
;

4067 
mask
;

4068 } 
aO±
[] = {

4069 { "Æl", 
SQLITE4_O±Mask
 },

4070 { "quîy-Ê©ã√r", 
SQLITE4_QuîyFœâíî
 },

4071 { "cﬁumn-ˇche", 
SQLITE4_CﬁumnCache
 },

4072 { "ödex-s‹t", 
SQLITE4_IndexS‹t
 },

4073 { "ödex-£¨ch", 
SQLITE4_IndexSórch
 },

4074 { "ödex-covî", 
SQLITE4_IndexCovî
 },

4075 { "groupby-‹dî", 
SQLITE4_GroupByOrdî
 },

4076 { "Á˘‹-c⁄°™ts", 
SQLITE4_Fa˘‹OutC⁄°
 },

4077 { "ªÆ-as-öt", 
SQLITE4_IdxRólAsI¡
 },

4080 if–
objc
!=4 ){

4081 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB OPT BOOLEAN");

4082  
TCL_ERROR
;

4084 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

4085 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[3], &
⁄off
ËË 
TCL_ERROR
;

4086 
zO±
 = 
	`T˛_GëSåög
(
objv
[2]);

4087 
i
=0; i<(
aO±
)/(aOpt[0]); i++){

4088 if–
	`°rcmp
(
zO±
, 
aO±
[
i
].
zO±Name
)==0 ){

4089 
mask
 = 
aO±
[
i
].mask;

4093 if–
⁄off
 ) 
mask
 = ~mask;

4094 if–
i
>=(
aO±
)/(aOpt[0]) ){

4095 
	`T˛_AµídResu…
(
öãΩ
, "unknown optimization - should be one of:",

4097 
i
=0; i<(
aO±
)/(aOpt[0]); i++){

4098 
	`T˛_AµídResu…
(
öãΩ
, " ", 
aO±
[
i
].
zO±Name
);

4100  
TCL_ERROR
;

4102 
	`sqlôe4_ã°_c⁄åﬁ
(
SQLITE4_TESTCTRL_OPTIMIZATIONS
, 
db
, 
mask
);

4103  
TCL_OK
;

4104 
	}
}

4113 
	$ã°_°mt_utf16
(

4114 * 
˛õ¡D©a
,

4115 
T˛_I¡îp
 *
öãΩ
,

4116 
objc
,

4117 
T˛_Obj
 *
CONST
 
objv
[]

4119 #i‚de‡
SQLITE4_OMIT_UTF16


4120 
sqlôe4_°mt
 *
pStmt
;

4121 
cﬁ
;

4122 
T˛_Obj
 *
pRë
;

4123 c⁄° *
zName16
;

4124 c⁄° *(*
xFunc
)(
sqlôe4_°mt
*, , *);

4125 
dummy
;

4127 
xFunc
 = (c⁄° *(*)(
sqlôe4_°mt
*, , *))
˛õ¡D©a
;

4128 if–
objc
!=3 ){

4129 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

4130 
	`T˛_GëSåög
(
objv
[0]), " STMT column", 0);

4131  
TCL_ERROR
;

4134 if–
	`gëStmtPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
pStmt
ËË 
TCL_ERROR
;

4135 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
cﬁ
ËË 
TCL_ERROR
;

4137 
zName16
 = 
	`xFunc
(
pStmt
, 
cﬁ
, &
dummy
);

4138 if–
zName16
 ){

4139 
n
;

4140 c⁄° *
z
 = 
zName16
;

4141 
n
=0; 
z
[n] || z[n+1];Ç+=2){}

4142 
pRë
 = 
	`T˛_NewByãAºayObj
(
zName16
, 
n
+2);

4143 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

4147  
TCL_OK
;

4148 
	}
}

4150 
	$sqlôe4Te°Inô
(
T˛_I¡îp
 *
öãΩ
){

4151 
	`Sqlôëe°_auth_öô
(
öãΩ
);

4152 
	`Sqlôëe°_num_öô
(
öãΩ
);

4153 
	`Sqlôëe°_func_Inô
(
öãΩ
);

4154 
	`Sqlôëe°Bt_Inô
(
öãΩ
);

4155 
	}
}

4160 
	$Sqlôëe°1_Inô
(
T˛_I¡îp
 *
öãΩ
){

4161 
sqlôe4_£¨ch_cou¡
;

4162 
sqlôe4_found_cou¡
;

4163 
sqlôe4_öãºu±_cou¡
;

4164 
sqlôe4_s‹t_cou¡
;

4165 
sqlôe4_cuºít_time
;

4166 #i‡
SQLITE4_OS_UNIX
 && 
	`deföed
(
__APPLE__
Ë&& 
SQLITE4_ENABLE_LOCKING_STYLE


4167 
sqlôe4_ho°id_num
;

4169 
sqlôe4_max_blobsize
;

4171 *
zName
;

4172 
T˛_CmdProc
 *
xProc
;

4173 } 
aCmd
[] = {

4174 { "db_íãr", (
T˛_CmdProc
*)
db_íãr
 },

4175 { "db_Àave", (
T˛_CmdProc
*)
db_Àave
 },

4176 { "sqlôe4_m¥ötf_öt", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_öt
 },

4177 { "sqlôe4_m¥ötf_öt64", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_öt64
 },

4178 { "sqlôe4_m¥ötf_l⁄g", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_l⁄g
 },

4179 { "sqlôe4_m¥ötf_°r", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_°r
 },

4180 { "sqlôe4_¢¥ötf_°r", (
T˛_CmdProc
*)
sqlôe4_¢¥ötf_°r
 },

4181 { "sqlôe4_m¥ötf_°r⁄ly", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_°r⁄ly
},

4182 { "sqlôe4_m¥ötf_doubÀ", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_doubÀ
 },

4183 { "sqlôe4_m¥ötf_sˇÀd", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_sˇÀd
 },

4184 { "sqlôe4_m¥ötf_hexdoubÀ", (
T˛_CmdProc
*)
sqlôe4_m¥ötf_hexdoubÀ
},

4185 { "sqlôe4_m¥ötf_z_ã°", (
T˛_CmdProc
*)
ã°_m¥ötf_z
 },

4186 { "sqlôe4_m¥ötf_n_ã°", (
T˛_CmdProc
*)
ã°_m¥ötf_n
 },

4187 { "sqlôe4_¢¥ötf_öt", (
T˛_CmdProc
*)
ã°_¢¥ötf_öt
 },

4188 { "sqlôe4_exec_¥ötf", (
T˛_CmdProc
*)
ã°_exec_¥ötf
 },

4189 { "sqlôe4_exec_hex", (
T˛_CmdProc
*)
ã°_exec_hex
 },

4190 { "sqlôe4_exec", (
T˛_CmdProc
*)
ã°_exec
 },

4191 { "sqlôe4_exec_ƒ", (
T˛_CmdProc
*)
ã°_exec_ƒ
 },

4192 { "sqlôe4_˛o£", (
T˛_CmdProc
*)
sqlôe_ã°_˛o£
 },

4193 { "sqlôe4_¸óã_fun˘i⁄", (
T˛_CmdProc
*)
ã°_¸óã_fun˘i⁄
 },

4194 { "sqlôe4_¸óã_aggªg©e", (
T˛_CmdProc
*)
ã°_¸óã_aggªg©e
 },

4195 { "sqlôe_ªgi°î_ã°_fun˘i⁄", (
T˛_CmdProc
*)
ã°_ªgi°î_func
 },

4196 { "sqlôe_ab‹t", (
T˛_CmdProc
*)
sqlôe_ab‹t
 },

4197 { "sqlôe_böd", (
T˛_CmdProc
*)
ã°_böd
 },

4198 { "bªakpoöt", (
T˛_CmdProc
*)
ã°_bªakpoöt
 },

4199 { "sqlôe4_key", (
T˛_CmdProc
*)
ã°_key
 },

4200 { "sqlôe4_ªkey", (
T˛_CmdProc
*)
ã°_ªkey
 },

4201 { "sqlôe_£t_magic", (
T˛_CmdProc
*)
sqlôe_£t_magic
 },

4202 { "sqlôe4_öãºu±", (
T˛_CmdProc
*)
ã°_öãºu±
 },

4203 { "sqlôe_dñëe_fun˘i⁄", (
T˛_CmdProc
*)
dñëe_fun˘i⁄
 },

4204 { "sqlôe_dñëe_cﬁœti⁄", (
T˛_CmdProc
*)
dñëe_cﬁœti⁄
 },

4205 { "sqlôe4_db_å™ß˘i⁄_°©us", (
T˛_CmdProc
*)
db_å™ß˘i⁄_°©us
 },

4206 { "sqlôe4_°ack_u£d", (
T˛_CmdProc
*)
ã°_°ack_u£d
 },

4207 { "¥ötf", (
T˛_CmdProc
*)
ã°_¥ötf
 },

4208 { "sqlôe4IoTø˚", (
T˛_CmdProc
*)
ã°_io_åa˚
 },

4211 *
zName
;

4212 
T˛_ObjCmdProc
 *
xProc
;

4213 *
˛õ¡D©a
;

4214 } 
aObjCmd
[] = {

4215 { "sqlôe4_c⁄√˘i⁄_poöãr", 
gë_sqlôe_poöãr
, 0 },

4216 { "sqlôe4_böd_öt", 
ã°_böd_öt
, 0 },

4217 { "sqlôe4_böd_öt64", 
ã°_böd_öt64
, 0 },

4218 { "sqlôe4_böd_doubÀ", 
ã°_böd_doubÀ
, 0 },

4219 { "sqlôe4_böd_nuŒ", 
ã°_böd_nuŒ
 ,0 },

4220 { "sqlôe4_böd_ãxt", 
ã°_böd_ãxt
 ,0 },

4221 { "sqlôe4_böd_ãxt16", 
ã°_böd_ãxt16
 ,0 },

4222 { "sqlôe4_böd_blob", 
ã°_böd_blob
 ,0 },

4223 { "sqlôe4_böd_∑ømëî_cou¡", 
ã°_böd_∑ømëî_cou¡
, 0},

4224 { "sqlôe4_böd_∑ømëî_«me", 
ã°_böd_∑ømëî_«me
, 0},

4225 { "sqlôe4_böd_∑ømëî_ödex", 
ã°_böd_∑ømëî_ödex
, 0},

4226 { "sqlôe4_˛ór_bödögs", 
ã°_˛ór_bödögs
, 0},

4227 { "sqlôe4_¶ìp", 
ã°_¶ìp
, 0},

4228 { "sqlôe4_îrcode", 
ã°_îrcode
 ,0 },

4229 { "sqlôe4_îrmsg", 
ã°_îrmsg
 ,0 },

4230 { "sqlôe4_›í", 
ã°_›í
 ,0 },

4231 { "sqlôe4_›í_v2", 
ã°_›í_v2
 ,0 },

4233 { "sqlôe4_¥ï¨e", 
ã°_¥ï¨e
 ,0 },

4234 { "sqlôe4_¥ï¨e_tkt3134", 
ã°_¥ï¨e_tkt3134
, 0},

4235 { "sqlôe4_föÆize", 
ã°_föÆize
 ,0 },

4236 { "sqlôe4_°mt_°©us", 
ã°_°mt_°©us
 ,0 },

4237 { "sqlôe4_ª£t", 
ã°_ª£t
 ,0 },

4238 { "sqlôe4_ch™ges", 
ã°_ch™ges
 ,0 },

4239 { "sqlôe4_°ï", 
ã°_°ï
 ,0 },

4240 { "sqlôe4_°mt_sql", 
ã°_°mt_sql
 ,0 },

4241 { "sqlôe4_√xt_°mt", 
ã°_√xt_°mt
 ,0 },

4242 { "sqlôe4_°mt_ªad⁄ly", 
ã°_°mt_ªad⁄ly
 ,0 },

4243 { "sqlôe4_°mt_busy", 
ã°_°mt_busy
 ,0 },

4244 { "u£s_°mt_jou∫Æ", 
u£s_°mt_jou∫Æ
 ,0 },

4246 { "sqlôe4_db_ªÀa£_mem‹y", 
ã°_db_ªÀa£_mem‹y
, 0},

4248 { "sqlôe4_limô", 
ã°_limô
, 0},

4250 { "›timiz©i⁄_c⁄åﬁ", 
›timiz©i⁄_c⁄åﬁ
,0},

4251 #i‡
SQLITE4_OS_WIN


4252 { "lock_wö32_fûe", 
wö32_fûe_lock
, 0 },

4254 { "t˛_obj¥oc", 
runAsObjProc
, 0 },

4257 { "sqlôe4_cﬁumn_cou¡", 
ã°_cﬁumn_cou¡
 ,0 },

4258 { "sqlôe4_d©a_cou¡", 
ã°_d©a_cou¡
 ,0 },

4259 { "sqlôe4_cﬁumn_ty≥", 
ã°_cﬁumn_ty≥
 ,0 },

4260 { "sqlôe4_cﬁumn_blob", 
ã°_cﬁumn_blob
 ,0 },

4261 { "sqlôe4_cﬁumn_doubÀ", 
ã°_cﬁumn_doubÀ
 ,0 },

4262 { "sqlôe4_cﬁumn_öt64", 
ã°_cﬁumn_öt64
 ,0 },

4263 { "sqlôe4_cﬁumn_ãxt", 
ã°_°mt_utf8
, (*)
sqlôe4_cﬁumn_ãxt
 },

4264 { "sqlôe4_cﬁumn_«me", 
ã°_°mt_utf8
, (*)
sqlôe4_cﬁumn_«me
 },

4265 { "sqlôe4_cﬁumn_öt", 
ã°_°mt_öt
, (*)
sqlôe4_cﬁumn_öt
 },

4266 #i‚de‡
SQLITE4_OMIT_DECLTYPE


4267 { "sqlôe4_cﬁumn_de˛ty≥",
ã°_°mt_utf8
,(*)
sqlôe4_cﬁumn_de˛ty≥
},

4269 #ifde‡
SQLITE4_ENABLE_COLUMN_METADATA


4270 { "sqlôe4_cﬁumn_d©aba£_«me",
ã°_°mt_utf8
,(*)
sqlôe4_cﬁumn_d©aba£_«me
},

4271 { "sqlôe4_cﬁumn_èbÀ_«me",
ã°_°mt_utf8
,(*)
sqlôe4_cﬁumn_èbÀ_«me
},

4272 { "sqlôe4_cﬁumn_‹igö_«me",
ã°_°mt_utf8
,(*)
sqlôe4_cﬁumn_‹igö_«me
},

4275 #i‚de‡
SQLITE4_OMIT_UTF16


4276 { "sqlôe4_cﬁumn_ãxt16", 
ã°_°mt_utf16
, (*)
sqlôe4_cﬁumn_ãxt16
},

4279 { "sqlôe4_¸óã_cﬁœti⁄", 
ã°_¸óã_cﬁœti⁄
, 0 },

4280 { "sqlôe4_cﬁœti⁄_√eded", 
ã°_cﬁœti⁄_√eded
, 0 },

4281 { "sqlôe4_¥ofûe", 
ã°_¥ofûe
, 0 },

4282 { "sqlôe4_åa˚", 
ã°_åa˚
, 0 },

4283 { "w‹kög_64bô_öt", 
w‹kög_64bô_öt
, 0 },

4284 { "sqlôe4_¸óã_fun˘i⁄_v2", 
ã°_¸óã_fun˘i⁄_v2
, 0 },

4287 #i‚de‡
SQLITE4_OMIT_UTF16


4288 { "add_ã°_fun˘i⁄", 
ã°_fun˘i⁄
, 0 },

4290 { "sqlôe4_ã°_îr°r", 
ã°_îr°r
, 0 },

4291 { "t˛_v¨übÀ_ty≥", 
t˛_v¨übÀ_ty≥
, 0 },

4292 { "sqlôe4_libvîsi⁄_numbî", 
ã°_libvîsi⁄_numbî
, 0 },

4293 { "ã°_sqlôe4_log", 
ã°_sqlôe4_log
, 0 },

4294 #i‚de‡
SQLITE4_OMIT_EXPLAIN


4295 { "¥öt_ex∂aö_quîy_∂™", 
ã°_¥öt_eqp
, 0 },

4297 { "sqlôe4_ã°_c⁄åﬁ", 
ã°_ã°_c⁄åﬁ
 },

4299 { "¥ng_°©e_gë", 
ã°_¥ng_°©e_gë
 },

4300 { "¥ng_°©e_£t", 
ã°_¥ng_°©e_£t
 },

4302 
bômask_size
 = (
Bômask
)*8;

4303 
i
;

4304 
sqlôe4_›íãmp_cou¡
;

4305 
sqlôe4_like_cou¡
;

4306 
sqlôe4_x„r›t_cou¡
;

4307 
sqlôe4_∑gî_ªaddb_cou¡
;

4308 
sqlôe4_∑gî_wrôedb_cou¡
;

4309 
sqlôe4_∑gî_wrôej_cou¡
;

4310 #i‡
SQLITE4_OS_WIN


4311 
sqlôe4_os_ty≥
;

4313 #ifde‡
SQLITE4_DEBUG


4314 
sqlôe4WhîeTø˚
;

4315 
sqlôe4OSTø˚
;

4317 #ifde‡
SQLITE4_TEST


4318 #ifde‡
SQLITE4_ENABLE_FTS3


4319 
sqlôe4_·s3_íabÀ_∑ª¡he£s
;

4323 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

4324 
	`T˛_Cª©eComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xProc
, 0, 0);

4326 
i
=0; i<(
aObjCmd
)/(aObjCmd[0]); i++){

4327 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aObjCmd
[
i
].
zName
,

4328 
aObjCmd
[
i
].
xProc
,áObjCmd[i].
˛õ¡D©a
, 0);

4330 
	`T˛_LökV¨
(
öãΩ
, "sqlite_search_count",

4331 (*)&
sqlôe4_£¨ch_cou¡
, 
TCL_LINK_INT
);

4332 
	`T˛_LökV¨
(
öãΩ
, "sqlite_found_count",

4333 (*)&
sqlôe4_found_cou¡
, 
TCL_LINK_INT
);

4334 
	`T˛_LökV¨
(
öãΩ
, "sqlite_sort_count",

4335 (*)&
sqlôe4_s‹t_cou¡
, 
TCL_LINK_INT
);

4336 
	`T˛_LökV¨
(
öãΩ
, "sqlite4_max_blobsize",

4337 (*)&
sqlôe4_max_blobsize
, 
TCL_LINK_INT
);

4338 
	`T˛_LökV¨
(
öãΩ
, "sqlite_like_count",

4339 (*)&
sqlôe4_like_cou¡
, 
TCL_LINK_INT
);

4340 
	`T˛_LökV¨
(
öãΩ
, "sqlite_interrupt_count",

4341 (*)&
sqlôe4_öãºu±_cou¡
, 
TCL_LINK_INT
);

4343 
	`T˛_LökV¨
(
öãΩ
, "sqlite_current_time",

4344 (*)&
sqlôe4_cuºít_time
, 
TCL_LINK_INT
);

4345 #i‡
SQLITE4_OS_UNIX
 && 
	`deföed
(
__APPLE__
Ë&& 
SQLITE4_ENABLE_LOCKING_STYLE


4346 
	`T˛_LökV¨
(
öãΩ
, "sqlite_hostid_num",

4347 (*)&
sqlôe4_ho°id_num
, 
TCL_LINK_INT
);

4349 
	`T˛_LökV¨
(
öãΩ
, "sqlite4_xferopt_count",

4350 (*)&
sqlôe4_x„r›t_cou¡
, 
TCL_LINK_INT
);

4351 #i‡
SQLITE4_OS_WIN


4352 
	`T˛_LökV¨
(
öãΩ
, "sqlite_os_type",

4353 (*)&
sqlôe4_os_ty≥
, 
TCL_LINK_INT
);

4355 #ifde‡
SQLITE4_DEBUG


4356 
	`T˛_LökV¨
(
öãΩ
, "sqlite_where_trace",

4357 (*)&
sqlôe4WhîeTø˚
, 
TCL_LINK_INT
);

4359 
	`T˛_LökV¨
(
öãΩ
, "sqlite_static_bind_value",

4360 (*)&
sqlôe_°©ic_böd_vÆue
, 
TCL_LINK_STRING
);

4361 
	`T˛_LökV¨
(
öãΩ
, "sqlite_static_bind_nbyte",

4362 (*)&
sqlôe_°©ic_böd_nbyã
, 
TCL_LINK_INT
);

4363 
	`T˛_LökV¨
(
öãΩ
, "bitmask_size",

4364 (*)&
bômask_size
, 
TCL_LINK_INT
|
TCL_LINK_READ_ONLY
);

4365 #i‡
	`deföed
(
SQLITE4_ENABLE_FTS3
Ë&& deföed(
SQLITE4_TEST
)

4366 
	`T˛_LökV¨
(
öãΩ
, "sqlite_fts3_enable_parentheses",

4367 (*)&
sqlôe4_·s3_íabÀ_∑ª¡he£s
, 
TCL_LINK_INT
);

4369  
TCL_OK
;

4370 
	}
}

	@test/test_malloc.c

16 
	~"sqlôeI¡.h
"

17 
	~"t˛.h
"

18 
	~<°dlib.h
>

19 
	~<°rög.h
>

20 
	~<as£π.h
>

22 
	~"ã°I¡.h
"

29 
	sMemFau…
 {

30 
	miCou¡down
;

31 
	mnRïót
;

32 
	mnBíign
;

33 
	mnFaû
;

34 
u8
 
	míabÀ
;

35 
	misIn°ÆÀd
;

36 
	misBíignMode
;

37 
sqlôe4_mem_mëhods
 
	mm
;

38 } 
	gmemÁu…
;

44 
	$sqlôe4Fau…
(){

45 
˙t
 = 0;

46 
˙t
++;

47 
	}
}

53 
	$Áu…simSãp
(){

54 if–!
memÁu…
.
íabÀ
 ){

57 if–
memÁu…
.
iCou¡down
>0 ){

58 
memÁu…
.
iCou¡down
--;

61 
	`sqlôe4Fau…
();

62 
memÁu…
.
nFaû
++;

63 if–
memÁu…
.
isBíignMode
>0 ){

64 
memÁu…
.
nBíign
++;

66 
memÁu…
.
nRïót
--;

67 if–
memÁu…
.
nRïót
<=0 ){

68 
memÁu…
.
íabÀ
 = 0;

71 
	}
}

77 *
	$Áu…simMÆloc
(*
pMem
, 
sqlôe4_size_t
 
n
){

78 *
p
 = 0;

79 
	`as£π
–
pMem
==(*)&
memÁu…
 );

80 if–!
	`Áu…simSãp
() ){

81 
p
 = 
memÁu…
.
m
.
	`xMÆloc
(memÁu….m.
pMemEnv
, 
n
);

83  
p
;

84 
	}
}

91 *
	$Áu…simRóŒoc
(*
pMem
, *
pOld
, 
sqlôe4_size_t
 
n
){

92 *
p
 = 0;

93 
	`as£π
–
pMem
==(*)&
memÁu…
 );

94 if–!
	`Áu…simSãp
() ){

95 
p
 = 
memÁu…
.
m
.
	`xRóŒoc
(memÁu….m.
pMemEnv
, 
pOld
, 
n
);

97  
p
;

98 
	}
}

109 
	$Áu…simFªe
(*
pMem
, *
p
){

110 
	`as£π
–
pMem
==(*)&
memÁu…
 );

111 
memÁu…
.
m
.
	`xFªe
(memÁu….m.
pMemEnv
, 
p
);

112 
	}
}

113 
sqlôe4_size_t
 
	$Áu…simSize
(*
pMem
, *
p
){

114 
	`as£π
–
pMem
==(*)&
memÁu…
 );

115  
memÁu…
.
m
.
	`xSize
(memÁu….m.
pMemEnv
, 
p
);

116 
	}
}

117 
	$Áu…simInô
(*
pMem
){

118  
memÁu…
.
m
.
	`xInô
(memÁu….m.
pMemEnv
);

119 
	}
}

120 
	$Áu…simShutdown
(*
pMem
){

121 
memÁu…
.
m
.
	`xShutdown
(memÁu….m.
pMemEnv
);

122 
	}
}

130 
	$Áu…simC⁄fig
(
nDñay
, 
nRïót
){

131 
memÁu…
.
iCou¡down
 = 
nDñay
;

132 
memÁu…
.
nRïót
 =ÇRepeat;

133 
memÁu…
.
nBíign
 = 0;

134 
memÁu…
.
nFaû
 = 0;

135 
memÁu…
.
íabÀ
 = 
nDñay
>=0;

144 
memÁu…
.
isBíignMode
 = 0;

145 
	}
}

151 
	$Áu…simFaûuªs
(){

152  
memÁu…
.
nFaû
;

153 
	}
}

159 
	$Áu…simBíignFaûuªs
(){

160  
memÁu…
.
nBíign
;

161 
	}
}

167 
	$Áu…simPídög
(){

168 if–
memÁu…
.
íabÀ
 ){

169  
memÁu…
.
iCou¡down
;

173 
	}
}

176 
	$Áu…simBegöBíign
(*
pMem
){

177 
memÁu…
.
isBíignMode
++;

178 
	}
}

179 
	$Áu…simEndBíign
(*
pMem
){

180 
memÁu…
.
isBíignMode
--;

181 
	}
}

187 
	$Áu…simIn°Æl
(
ö°Æl
){

189 
sqlôe4_mem_mëhods
 
m
 = {

190 
Áu…simMÆloc
,

191 
Áu…simFªe
,

192 
Áu…simRóŒoc
,

193 
Áu…simSize
,

194 
Áu…simInô
,

195 
Áu…simShutdown
,

196 
Áu…simBegöBíign
,

197 
Áu…simEndBíign
,

198 (*)&
memÁu…


200 
rc
;

202 
ö°Æl
 = (install ? 1 : 0);

203 
	`as£π
(
memÁu…
.
isIn°ÆÀd
==1 || memfault.isInstalled==0);

205 if–
ö°Æl
==
memÁu…
.
isIn°ÆÀd
 ){

206  
SQLITE4_ERROR
;

209 if–
ö°Æl
 ){

210 
	`sqlôe4_öôülize
(0);

211 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMALLOC
, &
memÁu…
.
m
);

212 
	`as£π
(
memÁu…
.
m
.
xMÆloc
);

213 if–
rc
==
SQLITE4_OK
 ){

214 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MALLOC
, &
m
);

217 
sqlôe4_mem_mëhods
 
m
;

218 
	`as£π
(
memÁu…
.
m
.
xMÆloc
);

222 
	`mem£t
(&
m
, 0, (m));

223 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MALLOC
, &
m
);

224 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMALLOC
, &
m
);

225 
	`as£π
–
	`memcmp
(&
m
, &
memÁu…
.m, (m))==0 );

227 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MALLOC
, &
memÁu…
.
m
);

230 if–
rc
==
SQLITE4_OK
 ){

231 
memÁu…
.
isIn°ÆÀd
 = 1;

233  
rc
;

235 
	}
}

238 #ifde‡
SQLITE4_TEST


250 c⁄° *
sqlôe4Te°Eº‹Name
();

255 
	$poöãrToText
(*
p
, *
z
){

256 c⁄° 
zHex
[] = "0123456789abcdef";

257 
i
, 
k
;

258 
u
;

259 
sqlôe4_uöt64
 
n
;

260 if–
p
==0 ){

261 
	`°r˝y
(
z
, "0");

264 if–(
n
)==(
p
) ){

265 
	`mem˝y
(&
n
, &
p
, (p));

266 }if–(
u
)==(
p
) ){

267 
	`mem˝y
(&
u
, &
p
, (u));

268 
n
 = 
u
;

270 
	`as£π
( 0 );

272 
i
=0, 
k
=(
p
)*2-1; i<(p)*2; i++, k--){

273 
z
[
k
] = 
zHex
[
n
&0xf];

274 
n
 >>= 4;

276 
z
[(
p
)*2] = 0;

277 
	}
}

278 
	$hexToI¡
(
h
){

279 if–
h
>='0' && h<='9' ){

280  
h
 - '0';

281 }if–
h
>='a' && h<='f' ){

282  
h
 - 'a' + 10;

286 
	}
}

287 
	$ãxtToPoöãr
(c⁄° *
z
, **
µ
){

288 
sqlôe4_uöt64
 
n
 = 0;

289 
i
;

290 
u
;

291 
i
=0; i<(*)*2 && 
z
[0]; i++){

292 
v
;

293 
v
 = 
	`hexToI¡
(*
z
++);

294 if–
v
<0 )  
TCL_ERROR
;

295 
n
 =Ç*16 + 
v
;

297 if–*
z
!=0 )  
TCL_ERROR
;

298 if–(
n
)==(*
µ
) ){

299 
	`mem˝y
(
µ
, &
n
, (n));

300 }if–(
u
)==(*
µ
) ){

301 
u
 = ()
n
;

302 
	`mem˝y
(
µ
, &
u
, (u));

304 
	`as£π
( 0 );

306  
TCL_OK
;

307 
	}
}

314 
	$ã°_mÆloc
(

315 * 
˛õ¡D©a
,

316 
T˛_I¡îp
 *
öãΩ
,

317 
objc
,

318 
T˛_Obj
 *
CONST
 
objv
[]

320 
nByã
;

321 *
p
;

322 
zOut
[100];

323 if–
objc
!=2 ){

324 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "NBYTES");

325  
TCL_ERROR
;

327 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
nByã
ËË 
TCL_ERROR
;

328 
p
 = 
	`sqlôe4_mÆloc
(0, ()
nByã
);

329 
	`poöãrToText
(
p
, 
zOut
);

330 
	`T˛_AµídResu…
(
öãΩ
, 
zOut
, 
NULL
);

331  
TCL_OK
;

332 
	}
}

339 
	$ã°_ªÆloc
(

340 * 
˛õ¡D©a
,

341 
T˛_I¡îp
 *
öãΩ
,

342 
objc
,

343 
T˛_Obj
 *
CONST
 
objv
[]

345 
nByã
;

346 *
pPri‹
, *
p
;

347 
zOut
[100];

348 if–
objc
!=3 ){

349 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "PRIOR NBYTES");

350  
TCL_ERROR
;

352 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
nByã
ËË 
TCL_ERROR
;

353 if–
	`ãxtToPoöãr
(
	`T˛_GëSåög
(
objv
[1]), &
pPri‹
) ){

354 
	`T˛_AµídResu…
(
öãΩ
, "badÖoöãr: ", 
	`T˛_GëSåög
(
objv
[1]), (*)0);

355  
TCL_ERROR
;

357 
p
 = 
	`sqlôe4_ªÆloc
(0, 
pPri‹
, ()
nByã
);

358 
	`poöãrToText
(
p
, 
zOut
);

359 
	`T˛_AµídResu…
(
öãΩ
, 
zOut
, 
NULL
);

360  
TCL_OK
;

361 
	}
}

368 
	$ã°_‰ì
(

369 * 
˛õ¡D©a
,

370 
T˛_I¡îp
 *
öãΩ
,

371 
objc
,

372 
T˛_Obj
 *
CONST
 
objv
[]

374 *
pPri‹
;

375 if–
objc
!=2 ){

376 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "PRIOR");

377  
TCL_ERROR
;

379 if–
	`ãxtToPoöãr
(
	`T˛_GëSåög
(
objv
[1]), &
pPri‹
) ){

380 
	`T˛_AµídResu…
(
öãΩ
, "badÖoöãr: ", 
	`T˛_GëSåög
(
objv
[1]), (*)0);

381  
TCL_ERROR
;

383 
	`sqlôe4_‰ì
(0, 
pPri‹
);

384  
TCL_OK
;

385 
	}
}

390 
sqlôe4Te°HexToBö
(const *, , *);

391 
sqlôe4Te°BöToHex
(*,);

399 
	$ã°_mem£t
(

400 * 
˛õ¡D©a
,

401 
T˛_I¡îp
 *
öãΩ
,

402 
objc
,

403 
T˛_Obj
 *
CONST
 
objv
[]

405 *
p
;

406 
size
, 
n
, 
i
;

407 *
zHex
;

408 *
zOut
;

409 
zBö
[100];

411 if–
objc
!=4 ){

412 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "ADDRESS SIZE HEX");

413  
TCL_ERROR
;

415 if–
	`ãxtToPoöãr
(
	`T˛_GëSåög
(
objv
[1]), &
p
) ){

416 
	`T˛_AµídResu…
(
öãΩ
, "badÖoöãr: ", 
	`T˛_GëSåög
(
objv
[1]), (*)0);

417  
TCL_ERROR
;

419 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
size
) ){

420  
TCL_ERROR
;

422 if–
size
<=0 ){

423 
	`T˛_AµídResu…
(
öãΩ
, "size must beÖositive", (*)0);

424  
TCL_ERROR
;

426 
zHex
 = 
	`T˛_GëSåögFromObj
(
objv
[3], &
n
);

427 if–
n
>(
zBö
)*2 )Ç = (zBin)*2;

428 
n
 = 
	`sqlôe4Te°HexToBö
(
zHex
,Ç, 
zBö
);

429 if–
n
==0 ){

430 
	`T˛_AµídResu…
(
öãΩ
, "no data", (*)0);

431  
TCL_ERROR
;

433 
zOut
 = 
p
;

434 
i
=0; i<
size
; i++){

435 
zOut
[
i
] = 
zBö
[i%
n
];

437  
TCL_OK
;

438 
	}
}

445 
	$ã°_memgë
(

446 * 
˛õ¡D©a
,

447 
T˛_I¡îp
 *
öãΩ
,

448 
objc
,

449 
T˛_Obj
 *
CONST
 
objv
[]

451 *
p
;

452 
size
, 
n
;

453 *
zBö
;

454 
zHex
[100];

456 if–
objc
!=3 ){

457 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "ADDRESS SIZE");

458  
TCL_ERROR
;

460 if–
	`ãxtToPoöãr
(
	`T˛_GëSåög
(
objv
[1]), &
p
) ){

461 
	`T˛_AµídResu…
(
öãΩ
, "badÖoöãr: ", 
	`T˛_GëSåög
(
objv
[1]), (*)0);

462  
TCL_ERROR
;

464 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
size
) ){

465  
TCL_ERROR
;

467 if–
size
<=0 ){

468 
	`T˛_AµídResu…
(
öãΩ
, "size must beÖositive", (*)0);

469  
TCL_ERROR
;

471 
zBö
 = 
p
;

472  
size
>0 ){

473 if–
size
>((
zHex
)-1)/2 ){

474 
n
 = ((
zHex
)-1)/2;

476 
n
 = 
size
;

478 
	`mem˝y
(
zHex
, 
zBö
, 
n
);

479 
zBö
 +
n
;

480 
size
 -
n
;

481 
	`sqlôe4Te°BöToHex
(
zHex
, 
n
);

482 
	`T˛_AµídResu…
(
öãΩ
, 
zHex
, (*)0);

484  
TCL_OK
;

485 
	}
}

493 
	$ã°_memdebug_backåa˚
(

494 * 
˛õ¡D©a
,

495 
T˛_I¡îp
 *
öãΩ
,

496 
objc
,

497 
T˛_Obj
 *
CONST
 
objv
[]

499 
dïth
;

500 if–
objc
!=2 ){

501 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DEPT");

502  
TCL_ERROR
;

504 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
dïth
ËË 
TCL_ERROR
;

505 #ifde‡
SQLITE4_MEMDEBUG


507 
	`sqlôe4MemdebugBackåa˚
();

508 
	`sqlôe4MemdebugBackåa˚
(
dïth
);

511  
TCL_OK
;

512 
	}
}

519 
	$ã°_memdebug_dump
(

520 * 
˛õ¡D©a
,

521 
T˛_I¡îp
 *
öãΩ
,

522 
objc
,

523 
T˛_Obj
 *
CONST
 
objv
[]

525 if–
objc
!=2 ){

526 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "FILENAME");

527  
TCL_ERROR
;

529 #i‡
	`deföed
(
SQLITE4_MEMDEBUG
Ë|| deföed(
SQLITE4_MEMORY_SIZE
) \

530 || 
	`deföed
(
SQLITE4_POW2_MEMORY_SIZE
)

532 
	`sqlôe4MemdebugDump
(const *);

533 
	`sqlôe4MemdebugDump
(
	`T˛_GëSåög
(
objv
[1]));

536  
TCL_OK
;

537 
	}
}

544 
	$ã°_memdebug_mÆloc_cou¡
(

545 * 
˛õ¡D©a
,

546 
T˛_I¡îp
 *
öãΩ
,

547 
objc
,

548 
T˛_Obj
 *
CONST
 
objv
[]

550 
nMÆloc
 = -1;

551 if–
objc
!=1 ){

552 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

553  
TCL_ERROR
;

555 #i‡
	`deföed
(
SQLITE4_MEMDEBUG
)

557 
	`sqlôe4MemdebugMÆlocCou¡
();

558 
nMÆloc
 = 
	`sqlôe4MemdebugMÆlocCou¡
();

561 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
nMÆloc
));

562  
TCL_OK
;

563 
	}
}

584 
	$ã°_memdebug_Áû
(

585 * 
˛õ¡D©a
,

586 
T˛_I¡îp
 *
öãΩ
,

587 
objc
,

588 
T˛_Obj
 *
CONST
 
objv
[]

590 
ii
;

591 
iFaû
;

592 
nRïót
 = 1;

593 
T˛_Obj
 *
pBíignC¡
 = 0;

594 
nBíign
;

595 
nFaû
 = 0;

597 if–
objc
<2 ){

598 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "COUNTER ?OPTIONS?");

599  
TCL_ERROR
;

601 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
iFaû
ËË 
TCL_ERROR
;

603 
ii
=2; ii<
objc
; ii+=2){

604 
nO±i⁄
;

605 *
zO±i⁄
 = 
	`T˛_GëSåögFromObj
(
objv
[
ii
], &
nO±i⁄
);

606 *
zEº
 = 0;

608 if–
nO±i⁄
>1 && 
	`°∫cmp
(
zO±i⁄
, "-repeat",ÇOption)==0 ){

609 if–
ii
==(
objc
-1) ){

610 
zEº
 = "optionÑequiresánárgument: ";

612 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[
ii
+1], &
nRïót
) ){

613  
TCL_ERROR
;

616 }if–
nO±i⁄
>1 && 
	`°∫cmp
(
zO±i⁄
, "-benigncnt",ÇOption)==0 ){

617 if–
ii
==(
objc
-1) ){

618 
zEº
 = "optionÑequiresánárgument: ";

620 
pBíignC¡
 = 
objv
[
ii
+1];

623 
zEº
 = "unknown option: ";

626 if–
zEº
 ){

627 
	`T˛_AµídResu…
(
öãΩ
, 
zEº
, 
zO±i⁄
, 0);

628  
TCL_ERROR
;

632 
nBíign
 = 
	`Áu…simBíignFaûuªs
();

633 
nFaû
 = 
	`Áu…simFaûuªs
();

634 
	`Áu…simC⁄fig
(
iFaû
, 
nRïót
);

636 if–
pBíignC¡
 ){

637 
	`T˛_ObjSëV¨2
(
öãΩ
, 
pBíignC¡
, 0, 
	`T˛_NewI¡Obj
(
nBíign
), 0);

639 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
nFaû
));

640  
TCL_OK
;

641 
	}
}

650 
	$ã°_memdebug_≥ndög
(

651 * 
˛õ¡D©a
,

652 
T˛_I¡îp
 *
öãΩ
,

653 
objc
,

654 
T˛_Obj
 *
CONST
 
objv
[]

656 
nPídög
;

657 if–
objc
!=1 ){

658 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

659  
TCL_ERROR
;

661 
nPídög
 = 
	`Áu…simPídög
();

662 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
nPídög
));

663  
TCL_OK
;

664 
	}
}

677 
	$ã°_memdebug_£âôÀ
(

678 * 
˛õ¡D©a
,

679 
T˛_I¡îp
 *
öãΩ
,

680 
objc
,

681 
T˛_Obj
 *
CONST
 
objv
[]

683 c⁄° *
zTôÀ
;

684 if–
objc
!=2 ){

685 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "TITLE");

686  
TCL_ERROR
;

688 
zTôÀ
 = 
	`T˛_GëSåög
(
objv
[1]);

689 #ifde‡
SQLITE4_MEMDEBUG


691 
	`sqlôe4MemdebugSëtôÀ
(const *);

692 
	`sqlôe4MemdebugSëtôÀ
(
zTôÀ
);

695  
TCL_OK
;

696 
	}
}

698 
	#MALLOC_LOG_FRAMES
 10

	)

699 
	#MALLOC_LOG_KEYINTS
 ( \

701 )

	)

702 
T˛_HashTabÀ
 
	gaMÆlocLog
;

703 
	gmÆlocLogE«bÀd
 = 0;

705 
MÆlocLog
 
	tMÆlocLog
;

706 
	sMÆlocLog
 {

707 
	mnCÆl
;

708 
	mnByã
;

711 #ifde‡
SQLITE4_MEMDEBUG


712 
	$ã°_memdebug_ˇŒback
(
nByã
, 
nFøme
, **
aFøme
){

713 if–
mÆlocLogE«bÀd
 ){

714 
MÆlocLog
 *
pLog
;

715 
T˛_HashE¡ry
 *
pE¡ry
;

716 
isNew
;

718 
aKey
[
MALLOC_LOG_KEYINTS
];

719 
nKey
 = ()*
MALLOC_LOG_KEYINTS
;

721 
	`mem£t
(
aKey
, 0, 
nKey
);

722 if–((*)*
nFøme
)<
nKey
 ){

723 
nKey
 = 
nFøme
*(*);

725 
	`mem˝y
(
aKey
, 
aFøme
, 
nKey
);

727 
pE¡ry
 = 
	`T˛_Cª©eHashE¡ry
(&
aMÆlocLog
, (c⁄° *)
aKey
, &
isNew
);

728 if–
isNew
 ){

729 
pLog
 = (
MÆlocLog
 *)
	`T˛_AŒoc
((MallocLog));

730 
	`mem£t
(
pLog
, 0, (
MÆlocLog
));

731 
	`T˛_SëHashVÆue
(
pE¡ry
, (
Clõ¡D©a
)
pLog
);

733 
pLog
 = (
MÆlocLog
 *)
	`T˛_GëHashVÆue
(
pE¡ry
);

736 
pLog
->
nCÆl
++;

737 
pLog
->
nByã
 +=ÇByte;

739 
	}
}

742 
	$ã°_memdebug_log_˛ór
(){

743 
T˛_HashSórch
 
£¨ch
;

744 
T˛_HashE¡ry
 *
pE¡ry
;

746 
pE¡ry
=
	`T˛_Fú°HashE¡ry
(&
aMÆlocLog
, &
£¨ch
);

747 
pE¡ry
;

748 
pE¡ry
=
	`T˛_NextHashE¡ry
(&
£¨ch
)

750 
MÆlocLog
 *
pLog
 = (MÆlocLog *)
	`T˛_GëHashVÆue
(
pE¡ry
);

751 
	`T˛_Fªe
((*)
pLog
);

753 
	`T˛_DñëeHashTabÀ
(&
aMÆlocLog
);

754 
	`T˛_InôHashTabÀ
(&
aMÆlocLog
, 
MALLOC_LOG_KEYINTS
);

755 
	}
}

757 
	$ã°_memdebug_log
(

758 * 
˛õ¡D©a
,

759 
T˛_I¡îp
 *
öãΩ
,

760 
objc
,

761 
T˛_Obj
 *
CONST
 
objv
[]

763 
isInô
 = 0;

764 
iSub
;

766 c⁄° *
MB_°rs
[] = { "start", "stop", "dump", "clear", "sync" };

767 
	eMB_íum
 {

768 
MB_LOG_START
, 
MB_LOG_STOP
, 
MB_LOG_DUMP
, 
MB_LOG_CLEAR
, 
MB_LOG_SYNC


771 if–!
isInô
 ){

772 #ifde‡
SQLITE4_MEMDEBUG


773 
	`sqlôe4MemdebugBackåa˚CÆlback
(

774 (*
xBackåa˚
)(, , **));

775 
	`sqlôe4MemdebugBackåa˚CÆlback
(
ã°_memdebug_ˇŒback
);

777 
	`T˛_InôHashTabÀ
(&
aMÆlocLog
, 
MALLOC_LOG_KEYINTS
);

778 
isInô
 = 1;

781 if–
objc
<2 ){

782 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SUB-COMMAND ...");

784 if–
	`T˛_GëIndexFromObj
(
öãΩ
, 
objv
[1], 
MB_°rs
, "sub-comm™d", 0, &
iSub
) ){

785  
TCL_ERROR
;

788  (
MB_íum
)
iSub
 ){

789 
MB_LOG_START
:

790 
mÆlocLogE«bÀd
 = 1;

792 
MB_LOG_STOP
:

793 
mÆlocLogE«bÀd
 = 0;

795 
MB_LOG_DUMP
: {

796 
T˛_HashSórch
 
£¨ch
;

797 
T˛_HashE¡ry
 *
pE¡ry
;

798 
T˛_Obj
 *
pRë
 = 
	`T˛_NewObj
();

800 
	`as£π
((
T˛_WideI¡
)>=(*));

803 
pE¡ry
=
	`T˛_Fú°HashE¡ry
(&
aMÆlocLog
, &
£¨ch
);

804 
pE¡ry
;

805 
pE¡ry
=
	`T˛_NextHashE¡ry
(&
£¨ch
)

807 
T˛_Obj
 *
≠EÀm
[
MALLOC_LOG_FRAMES
+2];

808 
MÆlocLog
 *
pLog
 = (MÆlocLog *)
	`T˛_GëHashVÆue
(
pE¡ry
);

809 
T˛_WideI¡
 *
aKey
 = (T˛_WideI¡ *)
	`T˛_GëHashKey
(&
aMÆlocLog
, 
pE¡ry
);

810 
ii
;

812 
≠EÀm
[0] = 
	`T˛_NewI¡Obj
(
pLog
->
nCÆl
);

813 
≠EÀm
[1] = 
	`T˛_NewI¡Obj
(
pLog
->
nByã
);

814 
ii
=0; ii<
MALLOC_LOG_FRAMES
; ii++){

815 
≠EÀm
[
ii
+2] = 
	`T˛_NewWideI¡Obj
(
aKey
[ii]);

818 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
,

819 
	`T˛_NewLi°Obj
(
MALLOC_LOG_FRAMES
+2, 
≠EÀm
)

823 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

826 
MB_LOG_CLEAR
: {

827 
	`ã°_memdebug_log_˛ór
();

831 
MB_LOG_SYNC
: {

832 #ifde‡
SQLITE4_MEMDEBUG


833 
	`sqlôe4MemdebugSync
();

834 
	`ã°_memdebug_log_˛ór
();

835 
mÆlocLogE«bÀd
 = 1;

836 
	`sqlôe4MemdebugSync
();

842  
TCL_OK
;

843 
	}
}

850 
	$ã°_c⁄fig_mem°©us
(

851 * 
˛õ¡D©a
,

852 
T˛_I¡îp
 *
öãΩ
,

853 
objc
,

854 
T˛_Obj
 *
CONST
 
objv
[]

856 
íabÀ
, 
rc
;

857 if–
objc
!=2 ){

858 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "BOOLEAN");

859  
TCL_ERROR
;

861 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[1], &
íabÀ
ËË 
TCL_ERROR
;

862 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MEMSTATUS
, 
íabÀ
);

863 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
rc
));

864  
TCL_OK
;

865 
	}
}

871 
	$ã°_ívc⁄fig_lookaside
(

872 * 
˛õ¡D©a
,

873 
T˛_I¡îp
 *
öãΩ
,

874 
objc
,

875 
T˛_Obj
 *
CONST
 
objv
[]

877 
rc
;

878 
sz
, 
˙t
;

879 
T˛_Obj
 *
pRë
;

880 if–
objc
!=3 ){

881 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SIZE COUNT");

882  
TCL_ERROR
;

884 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
sz
ËË 
TCL_ERROR
;

885 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
˙t
ËË 
TCL_ERROR
;

886 
pRë
 = 
	`T˛_NewObj
();

887 
	`T˛_Li°ObjAµídEÀmít
(

888 
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
sqlôe4DeÁu…Env
.
szLookaside
)

890 
	`T˛_Li°ObjAµídEÀmít
(

891 
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
sqlôe4DeÁu…Env
.
nLookaside
)

893 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_LOOKASIDE
, 
sz
, 
˙t
);

894 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

895  
TCL_OK
;

896 
	}
}

906 
	$ã°_db_c⁄fig_lookaside
(

907 * 
˛õ¡D©a
,

908 
T˛_I¡îp
 *
öãΩ
,

909 
objc
,

910 
T˛_Obj
 *
CONST
 
objv
[]

912 
rc
;

913 
sz
, 
˙t
;

914 
sqlôe4
 *
db
;

915 
bufid
;

916 
azBuf
[2][10000];

917 
	`gëDbPoöãr
(
T˛_I¡îp
*, c⁄° *, 
sqlôe4
**);

918 if–
objc
!=5 ){

919 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "BUFID SIZE COUNT");

920  
TCL_ERROR
;

922 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

923 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
bufid
ËË 
TCL_ERROR
;

924 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
sz
ËË 
TCL_ERROR
;

925 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[4], &
˙t
ËË 
TCL_ERROR
;

926 if–
bufid
==0 ){

927 
rc
 = 
	`sqlôe4_db_c⁄fig
(
db
, 
SQLITE4_DBCONFIG_LOOKASIDE
, 0, 
sz
, 
˙t
);

928 }if–
bufid
>=1 && bufid<=2 && 
sz
*
˙t
<=(
azBuf
[0]) ){

929 
rc
 = 
	`sqlôe4_db_c⁄fig
(
db
, 
SQLITE4_DBCONFIG_LOOKASIDE
, 
azBuf
[
bufid
], 
sz
,
˙t
);

931 
	`T˛_AµídResu…
(
öãΩ
, "illegalárguments - see documentation", (*)0);

932  
TCL_ERROR
;

934 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
rc
));

935  
TCL_OK
;

936 
	}
}

944 
	$ã°_c⁄fig_îr‹
(

945 * 
˛õ¡D©a
,

946 
T˛_I¡îp
 *
öãΩ
,

947 
objc
,

948 
T˛_Obj
 *
CONST
 
objv
[]

950 
sqlôe4
 *
db
;

951 
	`gëDbPoöãr
(
T˛_I¡îp
*, c⁄° *, 
sqlôe4
**);

953 if–
objc
!=2 && objc!=1 ){

954 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "[DB]");

955  
TCL_ERROR
;

957 if–
objc
==2 ){

958 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

959 if–
	`sqlôe4_db_c⁄fig
(
db
, 99999)!=
SQLITE4_ERROR
 ){

960 
	`T˛_AµídResu…
(
öãΩ
,

963  
TCL_ERROR
;

966 if–
	`sqlôe4_ív_c⁄fig
(0, 99999)!=
SQLITE4_ERROR
 ){

967 
	`T˛_AµídResu…
(
öãΩ
,

970  
TCL_ERROR
;

973  
TCL_OK
;

974 
	}
}

983 
	$ã°_°©us
(

984 * 
˛õ¡D©a
,

985 
T˛_I¡îp
 *
öãΩ
,

986 
objc
,

987 
T˛_Obj
 *
CONST
 
objv
[]

989 
rc
;

990 
sqlôe4_uöt64
 
iVÆue
, 
mxVÆue
;

991 
i
, 
›
, 
ª£tFœg
;

992 c⁄° *
zOpName
;

994 c⁄° *
zName
;

995 
›
;

996 } 
aOp
[] = {

997 { "SQLITE4_ENVSTATUS_MEMORY_USED", 
SQLITE4_ENVSTATUS_MEMORY_USED
 },

998 { "SQLITE4_ENVSTATUS_MALLOC_SIZE", 
SQLITE4_ENVSTATUS_MALLOC_SIZE
 },

999 { "SQLITE4_ENVSTATUS_PARSER_STACK", 
SQLITE4_ENVSTATUS_PARSER_STACK
 },

1000 { "SQLITE4_ENVSTATUS_MALLOC_COUNT", 
SQLITE4_ENVSTATUS_MALLOC_COUNT
 },

1002 
T˛_Obj
 *
pResu…
;

1003 if–
objc
!=3 ){

1004 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "PARAMETER RESETFLAG");

1005  
TCL_ERROR
;

1007 
zOpName
 = 
	`T˛_GëSåög
(
objv
[1]);

1008 
i
=0; i<
	`AºaySize
(
aOp
); i++){

1009 if–
	`°rcmp
(
aOp
[
i
].
zName
, 
zOpName
)==0 ){

1010 
›
 = 
aOp
[
i
].op;

1014 if–
i
>=
	`AºaySize
(
aOp
) ){

1015 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
›
ËË 
TCL_ERROR
;

1017 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[2], &
ª£tFœg
ËË 
TCL_ERROR
;

1018 
iVÆue
 = 0;

1019 
mxVÆue
 = 0;

1020 
rc
 = 
	`sqlôe4_ív_°©us
(0, 
›
, &
iVÆue
, &
mxVÆue
, 
ª£tFœg
);

1021 
pResu…
 = 
	`T˛_NewObj
();

1022 
	`T˛_Li°ObjAµídEÀmít
(0, 
pResu…
, 
	`T˛_NewI¡Obj
(
rc
));

1023 
	`T˛_Li°ObjAµídEÀmít
(0, 
pResu…
, 
	`T˛_NewWideI¡Obj
(
iVÆue
));

1024 
	`T˛_Li°ObjAµídEÀmít
(0, 
pResu…
, 
	`T˛_NewWideI¡Obj
(
mxVÆue
));

1025 
	`T˛_SëObjResu…
(
öãΩ
, 
pResu…
);

1026  
TCL_OK
;

1027 
	}
}

1035 
	$ã°_db_°©us
(

1036 * 
˛õ¡D©a
,

1037 
T˛_I¡îp
 *
öãΩ
,

1038 
objc
,

1039 
T˛_Obj
 *
CONST
 
objv
[]

1041 
rc
, 
iVÆue
, 
mxVÆue
;

1042 
i
, 
›
, 
ª£tFœg
;

1043 c⁄° *
zOpName
;

1044 
sqlôe4
 *
db
;

1045 
	`gëDbPoöãr
(
T˛_I¡îp
*, c⁄° *, 
sqlôe4
**);

1047 c⁄° *
zName
;

1048 
›
;

1049 } 
aOp
[] = {

1050 { "LOOKASIDE_USED", 
SQLITE4_DBSTATUS_LOOKASIDE_USED
 },

1051 { "CACHE_USED", 
SQLITE4_DBSTATUS_CACHE_USED
 },

1052 { "SCHEMA_USED", 
SQLITE4_DBSTATUS_SCHEMA_USED
 },

1053 { "STMT_USED", 
SQLITE4_DBSTATUS_STMT_USED
 },

1054 { "LOOKASIDE_HIT", 
SQLITE4_DBSTATUS_LOOKASIDE_HIT
 },

1055 { "LOOKASIDE_MISS_SIZE", 
SQLITE4_DBSTATUS_LOOKASIDE_MISS_SIZE
 },

1056 { "LOOKASIDE_MISS_FULL", 
SQLITE4_DBSTATUS_LOOKASIDE_MISS_FULL
 },

1057 { "CACHE_HIT", 
SQLITE4_DBSTATUS_CACHE_HIT
 },

1058 { "CACHE_MISS", 
SQLITE4_DBSTATUS_CACHE_MISS
 }

1060 
T˛_Obj
 *
pResu…
;

1061 if–
objc
!=4 ){

1062 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB PARAMETER RESETFLAG");

1063  
TCL_ERROR
;

1065 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

1066 
zOpName
 = 
	`T˛_GëSåög
(
objv
[2]);

1067 if–
	`memcmp
(
zOpName
, "SQLITE4_", 7)==0 ) zOpName += 7;

1068 if–
	`memcmp
(
zOpName
, "DBSTATUS_", 9)==0 ) zOpName += 9;

1069 
i
=0; i<
	`AºaySize
(
aOp
); i++){

1070 if–
	`°rcmp
(
aOp
[
i
].
zName
, 
zOpName
)==0 ){

1071 
›
 = 
aOp
[
i
].op;

1075 if–
i
>=
	`AºaySize
(
aOp
) ){

1076 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
›
ËË 
TCL_ERROR
;

1078 if–
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[3], &
ª£tFœg
ËË 
TCL_ERROR
;

1079 
iVÆue
 = 0;

1080 
mxVÆue
 = 0;

1081 
rc
 = 
	`sqlôe4_db_°©us
(
db
, 
›
, &
iVÆue
, &
mxVÆue
, 
ª£tFœg
);

1082 
pResu…
 = 
	`T˛_NewObj
();

1083 
	`T˛_Li°ObjAµídEÀmít
(0, 
pResu…
, 
	`T˛_NewI¡Obj
(
rc
));

1084 
	`T˛_Li°ObjAµídEÀmít
(0, 
pResu…
, 
	`T˛_NewI¡Obj
(
iVÆue
));

1085 
	`T˛_Li°ObjAµídEÀmít
(0, 
pResu…
, 
	`T˛_NewI¡Obj
(
mxVÆue
));

1086 
	`T˛_SëObjResu…
(
öãΩ
, 
pResu…
);

1087  
TCL_OK
;

1088 
	}
}

1093 
	$ã°_ö°Æl_mÆloc_Áu…sim
(

1094 * 
˛õ¡D©a
,

1095 
T˛_I¡îp
 *
öãΩ
,

1096 
objc
,

1097 
T˛_Obj
 *
CONST
 
objv
[]

1099 
rc
;

1100 
isIn°Æl
;

1102 if–
objc
!=2 ){

1103 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "BOOLEAN");

1104  
TCL_ERROR
;

1106 if–
TCL_OK
!=
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[1], &
isIn°Æl
) ){

1107  
TCL_ERROR
;

1109 
rc
 = 
	`Áu…simIn°Æl
(
isIn°Æl
);

1110 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_VOLATILE
);

1111  
TCL_OK
;

1112 
	}
}

1117 
	$ã°_ö°Æl_memsys3
(

1118 * 
˛õ¡D©a
,

1119 
T˛_I¡îp
 *
öãΩ
,

1120 
objc
,

1121 
T˛_Obj
 *
CONST
 
objv
[]

1123 
rc
 = 
SQLITE4_MISUSE
;

1124 #ifde‡
SQLITE4_ENABLE_MEMSYS3


1125 c⁄° 
sqlôe4_mem_mëhods
 *
	`sqlôe4MemGëMemsys3
();

1126 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MALLOC
, 
	`sqlôe4MemGëMemsys3
());

1128 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_VOLATILE
);

1129  
TCL_OK
;

1130 
	}
}

1137 
	$ã°_mm_ö°Æl
(

1138 * 
˛õ¡D©a
,

1139 
T˛_I¡îp
 *
öãΩ
,

1140 
objc
,

1141 
T˛_Obj
 *
CONST
 
objv
[]

1143 c⁄° *
azO±
[] = {

1150 
sqlôe4_mm
 *
pMM
 = 0;

1151 
i
;

1152 
bDebug
 = 0;

1153 
bBackåa˚
 = 0;

1154 
bSèts
 = 0;

1155 
bFau…sim
 = 0;

1157 
i
=1; i<
objc
; i++){

1158 
iO±
 = 0;

1159 
rc
 = 
	`T˛_GëIndexFromObj
(
öãΩ
, 
objv
[
i
], 
azO±
, "›ti⁄", 0, &
iO±
);

1160 if–
rc
!=
TCL_OK
 ) Ñc;

1162  
iO±
 ){

1164 
bDebug
 = 1;

1167 
bBackåa˚
 = 1;

1170 
bSèts
 = 1;

1173 
bFau…sim
 = 1;

1178 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMM
, &
pMM
);

1179 if–
pMM
==
	`sqlôe4_mm_deÁu…
() ){

1180 if–
bDebug
 ){

1181 
pMM
 = 
	`ã°_mm_debug
(pMM);

1183 if–
bFau…sim
 ){

1184 
pMM
 = 
	`ã°_mm_Áu…sim
(pMM);

1186 if–
bSèts
 ){

1187 
pMM
 = 
	`sqlôe4_mm_√w
(
SQLITE4_MM_STATS
,ÖMM);

1190 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_SETMM
, 
pMM
);

1193  
TCL_OK
;

1194 
	}
}

1199 
	$ã°_mm_°©
(

1200 * 
˛õ¡D©a
,

1201 
T˛_I¡îp
 *
öãΩ
,

1202 
objc
,

1203 
T˛_Obj
 *
CONST
 
objv
[]

1205 
Êags
 = 0;

1206 
sqlôe4_mm
 *
pMM
 = 0;

1207 
sqlôe4_öt64
 
iRë
 = -1;

1208 
T˛_Obj
 *
pO±
;

1210 if–
objc
!=2 && objc!=3 ){

1211 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "?-reset? STATISTIC");

1212  
TCL_ERROR
;

1215 if–
objc
==3 ){

1216 c⁄° *
azO±
[] = { "-reset", 0 };

1217 
iO±
 = 0;

1218 
rc
 = 
	`T˛_GëIndexFromObj
(
öãΩ
, 
objv
[1], 
azO±
, "›ti⁄", 0, &
iO±
);

1219 if–
rc
!=
TCL_OK
 ) Ñc;

1220 
Êags
 = 
SQLITE4_MMSTAT_RESET
;

1222 
pO±
 = 
objv
[
objc
-1];

1224 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMM
, &
pMM
);

1225 if–
pMM
 ){

1226 c⁄° *
azO±
[] = {

1232 
iO±
 = 0;

1233 
rc
 = 
	`T˛_GëIndexFromObj
(
öãΩ
, 
pO±
, 
azO±
, "›ti⁄", 0, &
iO±
);

1234 if–
rc
!=
TCL_OK
 ) Ñc;

1236 
iRë
 = 
	`sqlôe4_mm_°©
(
pMM
, 
iO±
+1, 
Êags
);

1239 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewWideI¡Obj
(
iRë
));

1240  
TCL_OK
;

1241 
	}
}

1246 
	$ã°_mm_ªp‹t
(

1247 * 
˛õ¡D©a
,

1248 
T˛_I¡îp
 *
öãΩ
,

1249 
objc
,

1250 
T˛_Obj
 *
CONST
 
objv
[]

1252 
FILE
 *
pFûe
;

1253 c⁄° *
zFûe
;

1254 
sqlôe4_mm
 *
pMM
;

1256 if–
objc
!=2 ){

1257 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "FILE");

1258  
TCL_ERROR
;

1261 
zFûe
 = 
	`T˛_GëSåög
(
objv
[1]);

1262 
pFûe
 = 
	`f›í
(
zFûe
, "w");

1263 if–
pFûe
==0 ){

1264 
	`T˛_AµídResu…
(
öãΩ
, "FaûedÅÿ›í fûe: ", 
zFûe
, 0);

1265  
TCL_ERROR
;

1268 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMM
, &
pMM
);

1269 
	`sqlôe4_mm_c⁄åﬁ
(
pMM
, 
TESTMEM_CTRL_REPORT
, 
pFûe
);

1270 
	`f˛o£
(
pFûe
);

1272  
TCL_OK
;

1273 
	}
}

1278 
	$ã°_mm_Áu…c⁄fig
(

1279 * 
˛õ¡D©a
,

1280 
T˛_I¡îp
 *
öãΩ
,

1281 
objc
,

1282 
T˛_Obj
 *
CONST
 
objv
[]

1284 
sqlôe4_mm
 *
pMM
 = 0;

1285 
iC¡
 = 0;

1286 
bPîsi°
 = 0;

1288 if–
objc
!=3 ){

1289 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "COUNT PERSISTENT");

1290  
TCL_ERROR
;

1293 if–
TCL_OK
!=
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
iC¡
)

1294 || 
TCL_OK
!=
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[2], &
bPîsi°
)

1296  
TCL_ERROR
;

1299 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMM
, &
pMM
);

1300 
	`sqlôe4_mm_c⁄åﬁ
(
pMM
, 
TESTMEM_CTRL_FAULTCONFIG
, 
iC¡
, 
bPîsi°
);

1301  
TCL_OK
;

1302 
	}
}

1307 
	$ã°_mm_Áu…ªp‹t
(

1308 * 
˛õ¡D©a
,

1309 
T˛_I¡îp
 *
öãΩ
,

1310 
objc
,

1311 
T˛_Obj
 *
CONST
 
objv
[]

1313 
sqlôe4_mm
 *
pMM
 = 0;

1314 
nFau…
 = 0;

1315 
nBíign
 = 0;

1316 
T˛_Obj
 *
pRë
;

1318 if–
objc
!=1 ){

1319 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

1320  
TCL_ERROR
;

1323 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMM
, &
pMM
);

1324 
	`sqlôe4_mm_c⁄åﬁ
(
pMM
, 
TESTMEM_CTRL_FAULTREPORT
, &
nFau…
, &
nBíign
);

1325 
pRë
 = 
	`T˛_NewObj
();

1326 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
nFau…
));

1327 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
nBíign
));

1328 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

1329  
TCL_OK
;

1330 
	}
}

1336 
	$Sqlôëe°_mÆloc_Inô
(
T˛_I¡îp
 *
öãΩ
){

1338 *
zName
;

1339 
T˛_ObjCmdProc
 *
xProc
;

1340 
˛õ¡D©a
;

1341 } 
aObjCmd
[] = {

1343 { "sqlôe4_mÆloc", 
ã°_mÆloc
 ,0 },

1344 { "sqlôe4_ªÆloc", 
ã°_ªÆloc
 ,0 },

1345 { "sqlôe4_‰ì", 
ã°_‰ì
 ,0 },

1346 { "mem£t", 
ã°_mem£t
 ,0 },

1347 { "memgë", 
ã°_memgë
 ,0 },

1348 { "sqlôe4_memdebug_backåa˚", 
ã°_memdebug_backåa˚
 ,0 },

1349 { "sqlôe4_memdebug_dump", 
ã°_memdebug_dump
 ,0 },

1350 { "sqlôe4_memdebug_Áû", 
ã°_memdebug_Áû
 ,0 },

1351 { "sqlôe4_memdebug_≥ndög", 
ã°_memdebug_≥ndög
 ,0 },

1352 { "sqlôe4_memdebug_£âôÀ", 
ã°_memdebug_£âôÀ
 ,0 },

1353 { "sqlôe4_memdebug_mÆloc_cou¡", 
ã°_memdebug_mÆloc_cou¡
 ,0 },

1354 { "sqlôe4_memdebug_log", 
ã°_memdebug_log
 ,0 },

1355 { "sqlôe4_ív_°©us", 
ã°_°©us
 ,0 },

1356 { "sqlôe4_db_°©us", 
ã°_db_°©us
 ,0 },

1357 { "ö°Æl_mÆloc_Áu…sim", 
ã°_ö°Æl_mÆloc_Áu…sim
 ,0 },

1358 { "sqlôe4_ív_c⁄fig_mem°©us", 
ã°_c⁄fig_mem°©us
 ,0 },

1359 { "sqlôe4_ívc⁄fig_lookaside", 
ã°_ívc⁄fig_lookaside
 ,0 },

1360 { "sqlôe4_c⁄fig_îr‹", 
ã°_c⁄fig_îr‹
 ,0 },

1361 { "sqlôe4_db_c⁄fig_lookaside", 
ã°_db_c⁄fig_lookaside
 ,0 },

1362 { "sqlôe4_ö°Æl_memsys3", 
ã°_ö°Æl_memsys3
 ,0 },

1365 { "ã°_mm_ö°Æl", 
ã°_mm_ö°Æl
 ,0 },

1366 { "ã°_mm_°©", 
ã°_mm_°©
 ,0 },

1367 { "ã°_mm_ªp‹t", 
ã°_mm_ªp‹t
 ,0 },

1368 { "ã°_mm_Áu…c⁄fig", 
ã°_mm_Áu…c⁄fig
 ,0 },

1369 { "ã°_mm_Áu…ªp‹t", 
ã°_mm_Áu…ªp‹t
 ,0 },

1371 
i
;

1372 
i
=0; i<(
aObjCmd
)/(aObjCmd[0]); i++){

1373 
Clõ¡D©a
 
c
 = (Clõ¡D©a)
	`SQLITE4_INT_TO_PTR
(
aObjCmd
[
i
].
˛õ¡D©a
);

1374 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aObjCmd
[
i
].
zName
,áObjCmd[i].
xProc
, 
c
, 0);

1376  
TCL_OK
;

1377 
	}
}

	@test/test_mem.c

12 
	~<°dio.h
>

13 
	~<as£π.h
>

14 
	~<°rög.h
>

16 
	~"sqlôeI¡.h
"

17 
	~"ã°I¡.h
"

19 #i‡
deföed
(
__GLIBC__
)

20 
backåa˚
(**,);

21 
backåa˚_symbﬁs_fd
(*const*,,);

22 
	#TM_BACKTRACE
 12

	)

24 
	#backåa˚
(
A
,
B
Ë1

	)

25 
	#backåa˚_symbﬁs_fd
(
A
,
B
,
C
)

	)

28 
TmBlockHdr
 
	tTmBlockHdr
;

29 
TmAgg
 
	tTmAgg
;

30 
Te°mem
 
	tTe°mem
;

35 
	sTe°mem
 {

36 
sqlôe4_mm
 
	mba£
;

37 
sqlôe4_mm
 *
	mp
;

38 
sqlôe4_muãx
 *
	mmuãx
;

40 
TmBlockHdr
 *
	mpFú°
;

41 #ifde‡
TM_BACKTRACE


42 
TmAgg
 *
	maHash
[10000];

46 
	sTmBlockHdr
 {

47 
TmBlockHdr
 *
	mpNext
;

48 
TmBlockHdr
 *
	mpPªv
;

49 
	mnByã
;

50 #ifde‡
TM_BACKTRACE


51 
TmAgg
 *
	mpAgg
;

53 
u32
 
	miF‹eGu¨d
;

56 #ifde‡
TM_BACKTRACE


57 
	sTmAgg
 {

58 
	mnAŒoc
;

59 
	mnByã
;

60 
	mnOutAŒoc
;

61 
	mnOutByã
;

62 *
	maFøme
[
TM_BACKTRACE
];

63 
TmAgg
 *
	mpNext
;

67 
	#FOREGUARD
 0x80F5E153

	)

68 
	#REARGUARD
 0xE4676B53

	)

69 c⁄° 
u32
 
	gª¨gu¨d
 = 
REARGUARD
;

71 
	#ROUND8
(
x
Ë(((x)+7)&~7)

	)

72 
	#BLOCK_HDR_SIZE
 (
	`ROUND8
–(
TmBlockHdr
Ë))

	)

78 
TmBlockHdr
 *
	$u£rToBlock
(c⁄° *
p
){

79  (
TmBlockHdr
 *)(((c⁄° 
u8
 *)
p
Ë- 
BLOCK_HDR_SIZE
);

80 
	}
}

85 *
	$mmDebugMÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
nByã
){

86 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

87 
TmBlockHdr
 *
pNew
;

88 
u8
 *
pU£r
;

89 
nReq
;

94 
	`as£π
–(
ª¨gu¨d
)==4 );

95 
nReq
 = 
BLOCK_HDR_SIZE
 + 
nByã
 + 4;

96 
pNew
 = (
TmBlockHdr
 *)
	`sqlôe4_mm_mÆloc
(
pTe°
->
p
, 
nReq
);

97 
	`mem£t
(
pNew
, 0, (
TmBlockHdr
));

99 
	`sqlôe4_muãx_íãr
(
pTe°
->
muãx
);

101 
pNew
->
iF‹eGu¨d
 = 
FOREGUARD
;

102 
pNew
->
nByã
 =ÇByte;

103 
pNew
->
pNext
 = 
pTe°
->
pFú°
;

105 if–
pTe°
->
pFú°
 ){

106 
pTe°
->
pFú°
->
pPªv
 = 
pNew
;

108 
pTe°
->
pFú°
 = 
pNew
;

110 
pU£r
 = &((
u8
 *)
pNew
)[
BLOCK_HDR_SIZE
];

111 
	`mem£t
(
pU£r
, 0x56, 
nByã
);

112 
	`mem˝y
(&
pU£r
[
nByã
], &
ª¨gu¨d
, 4);

114 #ifde‡
TM_BACKTRACE


116 
TmAgg
 *
pAgg
;

117 
i
;

118 
u32
 
iHash
 = 0;

119 *
aFøme
[
TM_BACKTRACE
];

120 
	`mem£t
(
aFøme
, 0, (aFrame));

121 
	`backåa˚
(
aFøme
, 
TM_BACKTRACE
);

123 
i
=0; i<
	`AºaySize
(
aFøme
); i++){

124 
iHash
 +(
u64
)(
aFøme
[
i
]) + (iHash<<3);

126 
iHash
 = iHash % 
	`AºaySize
(
pTe°
->
aHash
);

128 
pAgg
=
pTe°
->
aHash
[
iHash
];ÖAgg;ÖAggıAgg->
pNext
){

129 if–
	`memcmp
(
pAgg
->
aFøme
,áFrame, (aFrame))==0 ) ;

131 if–!
pAgg
 ){

132 
pAgg
 = (
TmAgg
 *)
	`sqlôe4_mm_mÆloc
(
pTe°
->
p
, (TmAgg));

133 
	`mem£t
(
pAgg
, 0, (
TmAgg
));

134 
	`mem˝y
(
pAgg
->
aFøme
,áFrame, (aFrame));

135 
pAgg
->
pNext
 = 
pTe°
->
aHash
[
iHash
];

136 
pTe°
->
aHash
[
iHash
] = 
pAgg
;

138 
pAgg
->
nAŒoc
++;

139 
pAgg
->
nByã
 +=ÇByte;

140 
pAgg
->
nOutAŒoc
++;

141 
pAgg
->
nOutByã
 +
nByã
;

142 
pNew
->
pAgg
 =ÖAgg;

146 
	`sqlôe4_muãx_Àave
(
pTe°
->
muãx
);

147  
pU£r
;

148 
	}
}

153 
	$mmDebugFªe
(
sqlôe4_mm
 *
pMM
, *
p
){

154 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

155 if–
p
 ){

156 
TmBlockHdr
 *
pHdr
 = 
	`u£rToBlock
(
p
);

157 
u8
 *
pU£r
 = (u8 *)
p
;

159 
	`sqlôe4_muãx_íãr
(
pTe°
->
muãx
);

161 
	`as£π
–
pHdr
->
iF‹eGu¨d
==
FOREGUARD
 );

162 
	`as£π
–0==
	`memcmp
(&
pU£r
[
pHdr
->
nByã
], &
ª¨gu¨d
, 4) );

165 if–
pHdr
->
pPªv
 ){

166 
	`as£π
–
pHdr
->
pPªv
->
pNext
==pHdr );

167 
pHdr
->
pPªv
->
pNext
 =ÖHdr->pNext;

169 
	`as£π
–
pHdr
==
pTe°
->
pFú°
 );

170 
pTe°
->
pFú°
 = 
pHdr
->
pNext
;

172 if–
pHdr
->
pNext
 ){

173 
	`as£π
–
pHdr
->
pNext
->
pPªv
==pHdr );

174 
pHdr
->
pNext
->
pPªv
 =ÖHdr->pPrev;

177 #ifde‡
TM_BACKTRACE


178 
pHdr
->
pAgg
->
nOutAŒoc
--;

179 
pHdr
->
pAgg
->
nOutByã
 -pHdr->
nByã
;

182 
	`sqlôe4_muãx_Àave
(
pTe°
->
muãx
);

184 
	`mem£t
(
pU£r
, 0x58, 
pHdr
->
nByã
);

185 
	`mem£t
(
pHdr
, 0x57, (
TmBlockHdr
));

186 
	`sqlôe4_mm_‰ì
(
pTe°
->
p
, 
pHdr
);

188 
	}
}

193 *
	$mmDebugRóŒoc
(
sqlôe4_mm
 *
pMM
, *
p
, 
nByã
){

194 *
pNew
;

196 
pNew
 = 
	`sqlôe4_mm_mÆloc
(
pMM
, 
nByã
);

197 if–
pNew
 && 
p
 ){

198 
nOrig
 = 
	`sqlôe4_mm_msize
(
pMM
, 
p
);

199 
	`mem˝y
(
pNew
, 
p
, 
	`MIN
(
nByã
, 
nOrig
));

200 
	`sqlôe4_mm_‰ì
(
pMM
, 
p
);

203  
pNew
;

204 
	}
}

209 
sqlôe4_size_t
 
	$mmDebugMsize
(
sqlôe4_mm
 *
pMM
, *
p
){

210 if–
p
==0 )  0;

211 
TmBlockHdr
 *
pHdr
 = 
	`u£rToBlock
(
p
);

212  
pHdr
->
nByã
;

213 
	}
}

218 
	$mmDebugMembî
(
sqlôe4_mm
 *
pMM
, c⁄° *
p
){

219 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

220  
	`sqlôe4_mm_membî
(
pTe°
->
p
, (c⁄° *)
	`u£rToBlock
(p));

221 
	}
}

226 
	$mmDebugBíign
(
sqlôe4_mm
 *
pMM
, 
bBíign
){

227 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

228 
	`sqlôe4_mm_bíign_Áûuªs
(
pTe°
->
p
, 
bBíign
);

229 
	}
}

234 
sqlôe4_öt64
 
	$mmDebugSèt
(

235 
sqlôe4_mm
 *
pMM
,

236 
eTy≥
,

237 
Êags


239 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

240  
	`sqlôe4_mm_°©
(
pTe°
->
p
, 
eTy≥
, 
Êags
);

241 
	}
}

247 
	$mmDebugRï‹t
(
Te°mem
 *
pTe°
, 
FILE
 *
pFûe
){

248 #ifde‡
TM_BACKTRACE


249 
i
;

250 
	`Ârötf
(
pFûe
, "LEAKS\n");

251 
i
=0; i<
	`AºaySize
(
pTe°
->
aHash
); i++){

252 
TmAgg
 *
pAgg
;

253 
pAgg
=
pTe°
->
aHash
[
i
];ÖAgg;ÖAggıAgg->
pNext
){

254 if–
pAgg
->
nOutAŒoc
 ){

255 
j
;

256 
	`Ârötf
(
pFûe
, "%d %d ", 
pAgg
->
nOutByã
,ÖAgg->
nOutAŒoc
);

257 
j
=0; j<
TM_BACKTRACE
; j++){

258 
	`Ârötf
(
pFûe
, "%∞", 
pAgg
->
aFøme
[
j
]);

260 
	`Ârötf
(
pFûe
, "\n");

264 
	`Ârötf
(
pFûe
, "\nALLOCATIONS\n");

265 
i
=0; i<
	`AºaySize
(
pTe°
->
aHash
); i++){

266 
TmAgg
 *
pAgg
;

267 
pAgg
=
pTe°
->
aHash
[
i
];ÖAgg;ÖAggıAgg->
pNext
){

268 
j
;

269 
	`Ârötf
(
pFûe
, "%d %d ", 
pAgg
->
nByã
,ÖAgg->
nAŒoc
);

270 
j
=0; j<
TM_BACKTRACE
; j++Ë
	`Ârötf
(
pFûe
, "%∞", 
pAgg
->
aFøme
[j]);

271 
	`Ârötf
(
pFûe
, "\n");

275 ()
pFûe
;

276 ()
pTe°
;

278 
	}
}

280 
	$mmDebugCål
(
sqlôe4_mm
 *
pMM
, 
eTy≥
, 
va_li°
 
≠
){

281 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

282 
rc
 = 
SQLITE4_OK
;

283 if–
eTy≥
==
TESTMEM_CTRL_REPORT
 ){

284 
FILE
 *
pFûe
 = 
	`va_¨g
(
≠
, FILE*);

285 
	`mmDebugRï‹t
(
pTe°
, 
pFûe
);

287 
rc
 = 
	`sqlôe4_mm_c⁄åﬁ_va
(
pTe°
->
p
, 
eTy≥
, 
≠
);

289  
rc
;

290 
	}
}

295 
	$mmDebugFöÆ
(
sqlôe4_mm
 *
pMM
){

296 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

297 
sqlôe4_mm
 *
p
 = 
pTe°
->p;

298 
	`sqlôe4_mm_‰ì
(
p
, (*)
pTe°
);

299 
	`sqlôe4_mm_de°roy
(
p
);

300 
	}
}

306 
sqlôe4_mm
 *
	$ã°_mm_debug
(
sqlôe4_mm
 *
p
){

307 c⁄° 
sqlôe4_mm_mëhods
 
mmDebugMëhods
 = {

309  
mmDebugMÆloc
,

310  
mmDebugRóŒoc
,

311  
mmDebugFªe
,

312  
mmDebugMsize
,

313  
mmDebugMembî
,

314  
mmDebugBíign
,

315  
mmDebugSèt
,

316  
mmDebugCål
,

317  
mmDebugFöÆ


319 
Te°mem
 *
pTe°
;

320 
pTe°
 = (
Te°mem
 *)
	`sqlôe4_mm_mÆloc
(
p
, (Testmem));

321 if–
pTe°
 ){

322 
	`mem£t
(
pTe°
, 0, (
Te°mem
));

323 
pTe°
->
ba£
.
pMëhods
 = &
mmDebugMëhods
;

324 
pTe°
->
p
 =Ö;

326  (
sqlôe4_mm
 *)
pTe°
;

327 
	}
}

332 
Fau…MM
 
	tFau…MM
;

333 
	sFau…MM
 {

334 
sqlôe4_mm
 
	mba£
;

335 
sqlôe4_mm
 *
	mp
;

336 
sqlôe4_muãx
 *
	mmuãx
;

338 
	miC¡
;

339 
	mbPîsi°ít
;

340 
	mbBíign
;

341 
	mnFau…
;

342 
	mnBíignFau…
;

345 
	$öje˘OOM
(
Fau…MM
 *
pFau…
){

346 if–
pFau…
->
nFau…
 &&ÖFau…->
bPîsi°ít
 )  1;

347 if–
pFau…
->
iC¡
>0 ){

348 
pFau…
->
iC¡
--;

349 if–
pFau…
->
iC¡
==0 )  1;

352 
	}
}

357 *
	$mmFau…MÆloc
(
sqlôe4_mm
 *
pMM
, 
sqlôe4_size_t
 
nByã
){

358 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

359 if–
	`öje˘OOM
(
pFau…
) ){

360 
pFau…
->
nFau…
++;

361 if–
pFau…
->
bBíign
 )ÖFau…->
nBíignFau…
++;

364  
	`sqlôe4_mm_mÆloc
(
pFau…
->
p
, 
nByã
);

365 
	}
}

370 
	$mmFau…Fªe
(
sqlôe4_mm
 *
pMM
, *
p
){

371 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

372 
	`sqlôe4_mm_‰ì
(
pFau…
->
p
,Ö);

373 
	}
}

378 *
	$mmFau…RóŒoc
(
sqlôe4_mm
 *
pMM
, *
p
, 
nByã
){

379 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

380 if–
	`öje˘OOM
(
pFau…
) ){

381 
pFau…
->
nFau…
++;

382 if–
pFau…
->
bBíign
 )ÖFau…->
nBíignFau…
++;

385  
	`sqlôe4_mm_ªÆloc
(
pFau…
->
p
,Ö, 
nByã
);

386 
	}
}

391 
sqlôe4_size_t
 
	$mmFau…Msize
(
sqlôe4_mm
 *
pMM
, *
p
){

392 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

393  
	`sqlôe4_mm_msize
(
pFau…
->
p
,Ö);

394 
	}
}

399 
	$mmFau…Membî
(
sqlôe4_mm
 *
pMM
, c⁄° *
p
){

400 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

401  
	`sqlôe4_mm_membî
(
pFau…
->
p
,Ö);

402 
	}
}

407 
	$mmFau…Bíign
(
sqlôe4_mm
 *
pMM
, 
bBíign
){

408 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

409 
pFau…
->
bBíign
 = bBenign;

410 
	`sqlôe4_mm_bíign_Áûuªs
(
pFau…
->
p
, 
bBíign
);

411 
	}
}

416 
sqlôe4_öt64
 
	$mmFau…Sèt
(

417 
sqlôe4_mm
 *
pMM
,

418 
eTy≥
,

419 
Êags


421 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

422  
	`sqlôe4_mm_°©
(
pFau…
->
p
, 
eTy≥
, 
Êags
);

423 
	}
}

425 
	$mmFau…Cål
(
sqlôe4_mm
 *
pMM
, 
eTy≥
, 
va_li°
 
≠
){

426 
Fau…MM
 *
pFau…
 = (Fau…MM *)
pMM
;

427 
rc
 = 
SQLITE4_OK
;

429  
eTy≥
 ){

430 
TESTMEM_CTRL_FAULTCONFIG
: {

431 
iC¡
 = 
	`va_¨g
(
≠
, );

432 
bPîsi°ít
 = 
	`va_¨g
(
≠
, );

433 
pFau…
->
iC¡
 = iCnt;

434 
pFau…
->
bPîsi°ít
 = bPersistent;

435 
pFau…
->
nFau…
 = 0;

436 
pFau…
->
nBíignFau…
 = 0;

440 
TESTMEM_CTRL_FAULTREPORT
: {

441 *
≤Fau…
 = 
	`va_¨g
(
≠
, *);

442 *
≤Bíign
 = 
	`va_¨g
(
≠
, *);

443 *
≤Fau…
 = 
pFau…
->
nFau…
;

444 *
≤Bíign
 = 
pFau…
->
nBíignFau…
;

449 
rc
 = 
	`sqlôe4_mm_c⁄åﬁ_va
(
pFau…
->
p
, 
eTy≥
, 
≠
);

453  
rc
;

454 
	}
}

459 
	$mmFau…FöÆ
(
sqlôe4_mm
 *
pMM
){

460 
Te°mem
 *
pTe°
 = (Te°mem *)
pMM
;

461 
sqlôe4_mm
 *
p
 = 
pTe°
->p;

462 
	`sqlôe4_mm_‰ì
(
p
, (*)
pTe°
);

463 
	`sqlôe4_mm_de°roy
(
p
);

464 
	}
}

466 
sqlôe4_mm
 *
	$ã°_mm_Áu…sim
(
sqlôe4_mm
 *
p
){

467 c⁄° 
sqlôe4_mm_mëhods
 
mmFau…Mëhods
 = {

469  
mmFau…MÆloc
,

470  
mmFau…RóŒoc
,

471  
mmFau…Fªe
,

472  
mmFau…Msize
,

473  
mmFau…Membî
,

474  
mmFau…Bíign
,

475  
mmFau…Sèt
,

476  
mmFau…Cål
,

477  
mmFau…FöÆ


479 
Te°mem
 *
pTe°
;

480 
pTe°
 = (
Te°mem
 *)
	`sqlôe4_mm_mÆloc
(
p
, (Testmem));

481 if–
pTe°
 ){

482 
	`mem£t
(
pTe°
, 0, (
Te°mem
));

483 
pTe°
->
ba£
.
pMëhods
 = &
mmFau…Mëhods
;

484 
pTe°
->
p
 =Ö;

486  (
sqlôe4_mm
 *)
pTe°
;

487 
	}
}

	@test/test_misc1.c

17 
	~"sqlôeI¡.h
"

18 
	~"t˛.h
"

19 
	~<°dlib.h
>

20 
	~<°rög.h
>

25 
	$c_cﬁœti⁄_ã°
(

26 
Clõ¡D©a
 
˛õ¡D©a
,

27 
T˛_I¡îp
 *
öãΩ
,

28 
objc
,

29 
T˛_Obj
 *
CONST
 
objv
[]

31 c⁄° *
zEºFun˘i⁄
 = "N/A";

32 
sqlôe4
 *
db
;

34 
rc
;

35 if–
objc
!=1 ){

36 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

37  
TCL_ERROR
;

41 
rc
 = 
	`sqlôe4_›í
(0, ":mem‹y:", &
db
, 0);

42 if–
rc
!=
SQLITE4_OK
 ){

43 
zEºFun˘i⁄
 = "sqlite4_open";

44 
îr‹_out
;

47 
	`sqlôe4_˛o£
(
db
, 0);

48  
TCL_OK
;

50 
îr‹_out
:

51 
	`T˛_Re£tResu…
(
öãΩ
);

52 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹Åe°ög fun˘i⁄: ", 
zEºFun˘i⁄
, 0);

53  
TCL_ERROR
;

54 
	}
}

59 
	$c_ªÆloc_ã°
(

60 
Clõ¡D©a
 
˛õ¡D©a
,

61 
T˛_I¡îp
 *
öãΩ
,

62 
objc
,

63 
T˛_Obj
 *
CONST
 
objv
[]

65 *
p
;

66 c⁄° *
zEºFun˘i⁄
 = "N/A";

68 if–
objc
!=1 ){

69 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

70  
TCL_ERROR
;

73 
p
 = 
	`sqlôe4_mÆloc
(0, 5);

74 if–!
p
 ){

75 
zEºFun˘i⁄
 = "sqlite4_malloc";

76 
îr‹_out
;

82 
p
 = 
	`sqlôe4_ªÆloc
(0,Ö, -1);

83 if–
p
 ){

84 
zEºFun˘i⁄
 = "sqlite4_realloc";

85 
îr‹_out
;

88  
TCL_OK
;

90 
îr‹_out
:

91 
	`T˛_Re£tResu…
(
öãΩ
);

92 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹Åe°ög fun˘i⁄: ", 
zEºFun˘i⁄
, 0);

93  
TCL_ERROR
;

94 
	}
}

100 
	$c_misu£_ã°
(

101 
Clõ¡D©a
 
˛õ¡D©a
,

102 
T˛_I¡îp
 *
öãΩ
,

103 
objc
,

104 
T˛_Obj
 *
CONST
 
objv
[]

106 c⁄° *
zEºFun˘i⁄
 = "N/A";

107 
sqlôe4
 *
db
 = 0;

108 
sqlôe4_°mt
 *
pStmt
;

109 
rc
;

111 if–
objc
!=1 ){

112 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

113  
TCL_ERROR
;

119 
rc
 = 
	`sqlôe4_›í
(0, ":mem‹y:", &
db
, 0);

120 if–
rc
!=
SQLITE4_OK
 ){

121 
zEºFun˘i⁄
 = "sqlite4_open";

122 
îr‹_out
;

124 
	`sqlôe4_˛o£
(
db
, 0);

127 
rc
 = 
	`sqlôe4_îrcode
(
db
);

128 if–
rc
!=
SQLITE4_MISUSE
 ){

129 
zEºFun˘i⁄
 = "sqlite4_errcode";

130 
îr‹_out
;

133 
pStmt
 = (
sqlôe4_°mt
*)1234;

134 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 0, 0, &
pStmt
, 0);

135 if–
rc
!=
SQLITE4_MISUSE
 ){

136 
zEºFun˘i⁄
 = "sqlite4_prepare";

137 
îr‹_out
;

139 
	`as£π
–
pStmt
==0 );

141  
TCL_OK
;

143 
îr‹_out
:

144 
	`T˛_Re£tResu…
(
öãΩ
);

145 
	`T˛_AµídResu…
(
öãΩ
, "Eº‹Åe°ög fun˘i⁄: ", 
zEºFun˘i⁄
, 0);

146  
TCL_ERROR
;

147 
	}
}

152 
	$Sqlôëe°9_Inô
(
T˛_I¡îp
 *
öãΩ
){

154 *
zName
;

155 
T˛_ObjCmdProc
 *
xProc
;

156 *
˛õ¡D©a
;

157 } 
aObjCmd
[] = {

158 { "c_misu£_ã°", 
c_misu£_ã°
, 0 },

159 { "c_ªÆloc_ã°", 
c_ªÆloc_ã°
, 0 },

160 { "c_cﬁœti⁄_ã°", 
c_cﬁœti⁄_ã°
, 0 },

162 
i
;

163 
i
=0; i<(
aObjCmd
)/(aObjCmd[0]); i++){

164 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aObjCmd
[
i
].
zName
,

165 
aObjCmd
[
i
].
xProc
,áObjCmd[i].
˛õ¡D©a
, 0);

167  
TCL_OK
;

168 
	}
}

	@test/test_mutex.c

15 
	~"t˛.h
"

16 
	~"sqlôe4.h
"

17 
	~"sqlôeI¡.h
"

18 
	~<°dlib.h
>

19 
	~<as£π.h
>

20 
	~<°rög.h
>

23 c⁄° *
sqlôe4Te°Eº‹Name
();

26 
	ssqlôe4Cou¡îMuãx
 {

27 
sqlôe4_muãx
 
	mba£
;

28 
sqlôe4_muãx
 *
	mpRól
;

29 
	meTy≥
;

30 } 
	tsqlôe4Cou¡îMuãx
;

33 
	sã°_muãx_globÆs
 {

34 
	misIn°ÆÀd
;

35 
	mdißbÀInô
;

36 
	mdißbÀTry
;

37 
	misInô
;

38 
sqlôe4_muãx_mëhods
 
	mm
;

39 
	maCou¡î
[8];

40 } 
	gg
 = {0};

43 
	$cou¡îMuãxHñd
(
sqlôe4_muãx
 *
pMuãx
){

44 
sqlôe4Cou¡îMuãx
 *
p
 = (sqlôe4Cou¡îMuãx*)
pMuãx
;

45  
g
.
m
.
	`xMuãxHñd
(
p
->
pRól
);

46 
	}
}

49 
	$cou¡îMuãxNŸhñd
(
sqlôe4_muãx
 *
pMuãx
){

50 
sqlôe4Cou¡îMuãx
 *
p
 = (sqlôe4Cou¡îMuãx*)
pMuãx
;

51  
g
.
m
.
	`xMuãxNŸhñd
(
p
->
pRól
);

52 
	}
}

59 
	$cou¡îMuãxInô
(*
p
){

60 
rc
;

61 if–
g
.
dißbÀInô
 )  g.disableInit;

62 
rc
 = 
g
.
m
.
	`xMuãxInô
(
p
);

63 
g
.
isInô
 = 1;

64  
rc
;

65 
	}
}

70 
	$cou¡îMuãxEnd
(*
p
){

71 
g
.
isInô
 = 0;

72  
g
.
m
.
	`xMuãxEnd
(
p
);

73 
	}
}

78 
sqlôe4_muãx
 *
	$cou¡îMuãxAŒoc
(*
pMuãxEnv
, 
eTy≥
){

79 
sqlôe4_muãx
 *
pRól
;

80 
sqlôe4Cou¡îMuãx
 *
pRë
 = 0;

82 
	`as£π
–
g
.
isInô
 );

83 
	`as£π
(
eTy≥
<8 &&ÉType>=0);

85 
pRól
 = 
g
.
m
.
	`xMuãxAŒoc
(g.m.
pMuãxEnv
, 
eTy≥
);

86 if–!
pRól
 )  0;

87 
pRë
 = (
sqlôe4Cou¡îMuãx
 *)
	`mÆloc
((*pRet));

88 
pRë
->
eTy≥
 =ÉType;

89 
pRë
->
pRól
 =ÖReal;

90  (
sqlôe4_muãx
*)
pRë
;

91 
	}
}

96 
	$cou¡îMuãxFªe
(
sqlôe4_muãx
 *
pMuãx
){

97 
sqlôe4Cou¡îMuãx
 *
p
 = (sqlôe4Cou¡îMuãx*)
pMuãx
;

98 
	`as£π
–
g
.
isInô
 );

99 
g
.
m
.
	`xMuãxFªe
(
p
->
pRól
);

100 if–
p
->
eTy≥
==
SQLITE4_MUTEX_FAST
 ||Ö->eTy≥==
SQLITE4_MUTEX_RECURSIVE
 ){

101 
	`‰ì
(
p
);

103 
	}
}

108 
	$cou¡îMuãxE¡î
(
sqlôe4_muãx
 *
pMuãx
){

109 
sqlôe4Cou¡îMuãx
 *
p
 = (sqlôe4Cou¡îMuãx*)
pMuãx
;

110 
	`as£π
–
g
.
isInô
 );

111 
g
.
aCou¡î
[
p
->
eTy≥
]++;

112 
g
.
m
.
	`xMuãxE¡î
(
p
->
pRól
);

113 
	}
}

118 
	$cou¡îMuãxTry
(
sqlôe4_muãx
 *
pMuãx
){

119 
sqlôe4Cou¡îMuãx
 *
p
 = (sqlôe4Cou¡îMuãx*)
pMuãx
;

120 
	`as£π
–
g
.
isInô
 );

121 
g
.
aCou¡î
[
p
->
eTy≥
]++;

122 if–
g
.
dißbÀTry
 )  
SQLITE4_BUSY
;

123  
g
.
m
.
	`xMuãxTry
(
p
->
pRól
);

124 
	}
}

128 
	$cou¡îMuãxLóve
(
sqlôe4_muãx
 *
pMuãx
){

129 
sqlôe4Cou¡îMuãx
 *
p
 = (sqlôe4Cou¡îMuãx*)
pMuãx
;

130 
	`as£π
–
g
.
isInô
 );

131 
g
.
m
.
	`xMuãxLóve
(
p
->
pRól
);

132 
	}
}

137 
	$ã°_shutdown
(

138 * 
˛õ¡D©a
,

139 
T˛_I¡îp
 *
öãΩ
,

140 
objc
,

141 
T˛_Obj
 *
CONST
 
objv
[]

143 
rc
;

145 if–
objc
!=1 ){

146 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

147  
TCL_ERROR
;

150 
rc
 = 
	`sqlôe4_shutdown
(0);

151 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_VOLATILE
);

152  
TCL_OK
;

153 
	}
}

158 
	$ã°_öôülize
(

159 * 
˛õ¡D©a
,

160 
T˛_I¡îp
 *
öãΩ
,

161 
objc
,

162 
T˛_Obj
 *
CONST
 
objv
[]

164 
rc
;

166 if–
objc
!=1 ){

167 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

168  
TCL_ERROR
;

171 
rc
 = 
	`sqlôe4_öôülize
(0);

172 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_VOLATILE
);

173  
TCL_OK
;

174 
	}
}

179 
	$ã°_ö°Æl_muãx_cou¡îs
(

180 * 
˛õ¡D©a
,

181 
T˛_I¡îp
 *
öãΩ
,

182 
objc
,

183 
T˛_Obj
 *
CONST
 
objv
[]

185 
rc
 = 
SQLITE4_OK
;

186 
isIn°Æl
;

188 
sqlôe4_muãx_mëhods
 
cou¡î_mëhods
 = {

189 
cou¡îMuãxInô
,

190 
cou¡îMuãxEnd
,

191 
cou¡îMuãxAŒoc
,

192 
cou¡îMuãxFªe
,

193 
cou¡îMuãxE¡î
,

194 
cou¡îMuãxTry
,

195 
cou¡îMuãxLóve
,

196 
cou¡îMuãxHñd
,

197 
cou¡îMuãxNŸhñd
,

201 if–
objc
!=2 ){

202 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "BOOLEAN");

203  
TCL_ERROR
;

205 if–
TCL_OK
!=
	`T˛_GëBoﬁónFromObj
(
öãΩ
, 
objv
[1], &
isIn°Æl
) ){

206  
TCL_ERROR
;

209 
	`as£π
(
isIn°Æl
==0 || isInstall==1);

210 
	`as£π
(
g
.
isIn°ÆÀd
==0 || g.isInstalled==1);

211 if–
isIn°Æl
==
g
.
isIn°ÆÀd
 ){

212 
	`T˛_AµídResu…
(
öãΩ
, "mutex countersáre ", 0);

213 
	`T˛_AµídResu…
(
öãΩ
, 
isIn°Æl
?"already installed":"not installed", 0);

214  
TCL_ERROR
;

217 if–
isIn°Æl
 ){

218 
	`as£π
–
g
.
m
.
xMuãxAŒoc
==0 );

219 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_GETMUTEX
, &
g
.
m
);

220 if–
rc
==
SQLITE4_OK
 ){

221 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MUTEX
, &
cou¡î_mëhods
);

223 
g
.
dißbÀTry
 = 0;

225 
	`as£π
–
g
.
m
.
xMuãxAŒoc
 );

226 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
SQLITE4_ENVCONFIG_MUTEX
, &
g
.
m
);

227 
	`mem£t
(&
g
.
m
, 0, (
sqlôe4_muãx_mëhods
));

230 if–
rc
==
SQLITE4_OK
 ){

231 
g
.
isIn°ÆÀd
 = 
isIn°Æl
;

234 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_VOLATILE
);

235  
TCL_OK
;

236 
	}
}

241 
	$ã°_ªad_muãx_cou¡îs
(

242 * 
˛õ¡D©a
,

243 
T˛_I¡îp
 *
öãΩ
,

244 
objc
,

245 
T˛_Obj
 *
CONST
 
objv
[]

247 
T˛_Obj
 *
pRë
;

248 
ii
;

249 *
aName
[8] = {

254 if–
objc
!=1 ){

255 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

256  
TCL_ERROR
;

259 
pRë
 = 
	`T˛_NewObj
();

260 
	`T˛_In¸RefCou¡
(
pRë
);

261 
ii
=0; ii<8; ii++){

262 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
, 
	`T˛_NewSåögObj
(
aName
[
ii
], -1));

263 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pRë
, 
	`T˛_NewI¡Obj
(
g
.
aCou¡î
[
ii
]));

265 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

266 
	`T˛_De¸RefCou¡
(
pRë
);

268  
TCL_OK
;

269 
	}
}

274 
	$ã°_˛ór_muãx_cou¡îs
(

275 * 
˛õ¡D©a
,

276 
T˛_I¡îp
 *
öãΩ
,

277 
objc
,

278 
T˛_Obj
 *
CONST
 
objv
[]

280 
ii
;

282 if–
objc
!=1 ){

283 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

284  
TCL_ERROR
;

287 
ii
=0; ii<8; ii++){

288 
g
.
aCou¡î
[
ii
] = 0;

290  
TCL_OK
;

291 
	}
}

298 
	$ã°_Æloc_muãx
(

299 * 
˛õ¡D©a
,

300 
T˛_I¡îp
 *
öãΩ
,

301 
objc
,

302 
T˛_Obj
 *
CONST
 
objv
[]

304 #i‡
SQLITE4_THREADSAFE


305 
sqlôe4_muãx
 *
p
 = 
	`sqlôe4_muãx_Æloc
(0, 
SQLITE4_MUTEX_FAST
);

306 
zBuf
[100];

307 
	`sqlôe4_muãx_‰ì
(
p
);

308 
	`sqlôe4_¢¥ötf
(
zBuf
, (zBuf), "%p", 
p
);

309 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, (*)0);

311  
TCL_OK
;

312 
	}
}

325 
	$ã°_c⁄fig
(

326 * 
˛õ¡D©a
,

327 
T˛_I¡îp
 *
öãΩ
,

328 
objc
,

329 
T˛_Obj
 *
CONST
 
objv
[]

331 
	sC⁄figO±i⁄
 {

332 c⁄° *
zName
;

333 
iVÆue
;

334 } 
aO±
[] = {

335 {"sögÀthªad", 
SQLITE4_ENVCONFIG_SINGLETHREAD
},

336 {"mu…ôhªad", 
SQLITE4_ENVCONFIG_MULTITHREAD
},

337 {"£rülized", 
SQLITE4_ENVCONFIG_SERIALIZED
},

340 
s
 = (
C⁄figO±i⁄
);

341 
i
;

342 
rc
;

344 if–
objc
!=2 ){

345 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "");

346  
TCL_ERROR
;

349 if–
	`T˛_GëIndexFromObjSåu˘
(
öãΩ
, 
objv
[1], 
aO±
, 
s
, "Êag", 0, &
i
) ){

350 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
i
) ){

351  
TCL_ERROR
;

354 
i
 = 
aO±
[i].
iVÆue
;

357 
rc
 = 
	`sqlôe4_ív_c⁄fig
(0, 
i
);

358 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 
TCL_VOLATILE
);

359  
TCL_OK
;

360 
	}
}

362 
sqlôe4
 *
	$gëDbPoöãr
(
T˛_I¡îp
 *
pI¡îp
, 
T˛_Obj
 *
pObj
){

363 
sqlôe4
 *
db
;

364 
T˛_CmdInfo
 
öfo
;

365 *
zCmd
 = 
	`T˛_GëSåög
(
pObj
);

366 if–
	`T˛_GëComm™dInfo
(
pI¡îp
, 
zCmd
, &
öfo
) ){

367 
db
 = *((
sqlôe4
 **)
öfo
.
objClõ¡D©a
);

369 
db
 = (
sqlôe4
*)
	`sqlôe4Te°TextToPå
(
zCmd
);

371 
	`as£π
–
db
 );

372  
db
;

373 
	}
}

375 
	$ã°_íãr_db_muãx
(

376 * 
˛õ¡D©a
,

377 
T˛_I¡îp
 *
öãΩ
,

378 
objc
,

379 
T˛_Obj
 *
CONST
 
objv
[]

381 
sqlôe4
 *
db
;

382 if–
objc
!=2 ){

383 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB");

384  
TCL_ERROR
;

386 
db
 = 
	`gëDbPoöãr
(
öãΩ
, 
objv
[1]);

387 if–!
db
 ){

388  
TCL_ERROR
;

390 
	`sqlôe4_muãx_íãr
(
	`sqlôe4_db_muãx
(
db
));

391  
TCL_OK
;

392 
	}
}

394 
	$ã°_Àave_db_muãx
(

395 * 
˛õ¡D©a
,

396 
T˛_I¡îp
 *
öãΩ
,

397 
objc
,

398 
T˛_Obj
 *
CONST
 
objv
[]

400 
sqlôe4
 *
db
;

401 if–
objc
!=2 ){

402 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "DB");

403  
TCL_ERROR
;

405 
db
 = 
	`gëDbPoöãr
(
öãΩ
, 
objv
[1]);

406 if–!
db
 ){

407  
TCL_ERROR
;

409 
	`sqlôe4_muãx_Àave
(
	`sqlôe4_db_muãx
(
db
));

410  
TCL_OK
;

411 
	}
}

413 
	$Sqlôëe°_muãx_Inô
(
T˛_I¡îp
 *
öãΩ
){

415 *
zName
;

416 
T˛_ObjCmdProc
 *
xProc
;

417 } 
aCmd
[] = {

418 { "sqlôe4_shutdown", (
T˛_ObjCmdProc
*)
ã°_shutdown
 },

419 { "sqlôe4_öôülize", (
T˛_ObjCmdProc
*)
ã°_öôülize
 },

420 { "sqlôe4_ív_c⁄fig", (
T˛_ObjCmdProc
*)
ã°_c⁄fig
 },

422 { "íãr_db_muãx", (
T˛_ObjCmdProc
*)
ã°_íãr_db_muãx
 },

423 { "Àave_db_muãx", (
T˛_ObjCmdProc
*)
ã°_Àave_db_muãx
 },

425 { "Æloc_dóŒoc_muãx", (
T˛_ObjCmdProc
*)
ã°_Æloc_muãx
 },

426 { "ö°Æl_muãx_cou¡îs", (
T˛_ObjCmdProc
*)
ã°_ö°Æl_muãx_cou¡îs
 },

427 { "ªad_muãx_cou¡îs", (
T˛_ObjCmdProc
*)
ã°_ªad_muãx_cou¡îs
 },

428 { "˛ór_muãx_cou¡îs", (
T˛_ObjCmdProc
*)
ã°_˛ór_muãx_cou¡îs
 },

430 
i
;

431 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

432 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xProc
, 0, 0);

435 
	`T˛_LökV¨
(
öãΩ
, "disable_mutex_init",

436 (*)&
g
.
dißbÀInô
, 
TCL_LINK_INT
);

437 
	`T˛_LökV¨
(
öãΩ
, "disable_mutex_try",

438 (*)&
g
.
dißbÀTry
, 
TCL_LINK_INT
);

439  
SQLITE4_OK
;

440 
	}
}

	@test/test_num.c

16 
	~"sqlôe4.h
"

17 
	~<t˛.h
>

18 
	~<°rög.h
>

20 
	#NUM_FORMAT
 "sign:%dáµrox:%dÉ:%d m:%Œu"

	)

24 
	$≠≥nd_num_ªsu…
–
T˛_I¡îp
 *
öãΩ
, 
sqlôe4_num
 
A
 ){

25 
buf
[100];

26 
	`•rötf
–
buf
, 
NUM_FORMAT
, 
A
.
sign
, A.
≠¥ox
, A.
e
, A.
m
 );

27 
	`T˛_AµídResu…
(
öãΩ
, 
buf
, 0);

28 
	}
}

34 
sqlôe4_num
 
	$ã°_∑r£_num
–*
¨g
 ){

35 
sqlôe4_num
 
A
;

36 
sign
, 
≠¥ox
, 
e
;

37 if–
	`ssˇnf
–
¨g
, 
NUM_FORMAT
, &
sign
, &
≠¥ox
, &
e
, &
A
.
m
)==4 ){

38 
A
.
sign
 = sign;

39 
A
.
≠¥ox
 =ápprox;

40 
A
.
e
 =É;

41  
A
;

43  
	`sqlôe4_num_‰om_ãxt
(
¨g
, -1, 0, 0);

45 
	}
}

50 *
	$des¸ibe_num_com∑ris⁄
–
code
 ){

51  
code
 ){

58 
	}
}

63 
	$ã°_num_com∑ª
(

64 *
NŸU£d
,

65 
T˛_I¡îp
 *
öãΩ
,

66 
¨gc
,

67 **
¨gv


69 
sqlôe4_num
 
A
, 
B
;

70 
cmp
;

71 if–
¨gc
!=3 ){

72 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

74  
TCL_ERROR
;

77 
A
 = 
	`ã°_∑r£_num
–
¨gv
[1] );

78 
B
 = 
	`ã°_∑r£_num
–
¨gv
[2] );

79 
cmp
 = 
	`sqlôe4_num_com∑ª
(
A
, 
B
);

80 
	`T˛_AµídResu…
–
öãΩ
, 
	`des¸ibe_num_com∑ris⁄
–
cmp
 ), 0);

81  
TCL_OK
;

82 
	}
}

87 
	$ã°_num_‰om_ãxt
(

88 *
NŸU£d
,

89 
T˛_I¡îp
 *
öãΩ
,

90 
¨gc
,

91 **
¨gv


93 
sqlôe4_num
 
A
;

94 
Àn
;

95 
öput_Àn
;

96 
Êags
;

97 
ícodög
 = 0;

98 
i
;

99 *
utf16_ãxt
 = 0;

100 *
ãxt
;

101 if–
¨gc
<2 ||árgc>4 ){

102 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

103 " STRING\" o∏\"", 
¨gv
[0], " STRING INTEGER\" or \"",

104 
¨gv
[0], " STRING INTEGER STRING\"", 0);

105  
TCL_ERROR
;

108 if–
¨gc
>=3 ){

109 i‡–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[2], &
Àn
ËË 
TCL_ERROR
;

111 
Àn
 = -1;

114 
Êags
 = 0;

115 if–
¨gc
>=4 ){

116 if–
	`°rchr
(
¨gv
[3], 'w'ËË
Êags
 |
SQLITE4_IGNORE_WHITESPACE
;

117 if–
	`°rchr
(
¨gv
[3], 'p'ËË
Êags
 |
SQLITE4_PREFIX_ONLY
;

118 if–
	`°rchr
(
¨gv
[3], 'b'ËË
ícodög
 = 
SQLITE4_UTF16BE
;

119 if–
	`°rchr
(
¨gv
[3], 'l'ËË
ícodög
 = 
SQLITE4_UTF16LE
;

122 if–
ícodög
==
SQLITE4_UTF16BE
 ||Éncodög==
SQLITE4_UTF16LE
 ){

123 
Êags
 |
ícodög
;

124 
öput_Àn
 = 
	`°æí
(
¨gv
[1]);

125 
utf16_ãxt
 = 
	`sqlôe4_mÆloc
(0, 2*(
öput_Àn
+1));

126 if–!
utf16_ãxt
 ){

127 
	`T˛_AµídResu…
(
öãΩ
, "utf16 stringállocation failed");

128  
TCL_ERROR
;

130  
i
=0; i<2*(
öput_Àn
+1); i++ ){

131 
utf16_ãxt
[
i
] = 0;

133  
i
=0; i<
öput_Àn
; i++ ){

134 
utf16_ãxt
[ 
i
*2+ (
ícodög
==
SQLITE4_UTF16BE
Ë] = 
¨gv
[1][i];

136 
ãxt
 = 
utf16_ãxt
;

138 
ãxt
 = 
¨gv
[1];

141 
A
 = 
	`sqlôe4_num_‰om_ãxt
(
ãxt
, 
Àn
, 
Êags
, 0);

142 
	`≠≥nd_num_ªsu…
(
öãΩ
, 
A
);

143 if–
utf16_ãxt
 ){

144 
	`sqlôe4_‰ì
(0, 
utf16_ãxt
);

146  
TCL_OK
;

147 
	}
}

149 
	$ã°_num_ãxt_is_ªÆ
(

150 *
NŸU£d
,

151 
T˛_I¡îp
 *
öãΩ
,

152 
¨gc
,

153 **
¨gv


155 
pbRól
;

156 
Àn
;

157 if–
¨gc
!=2 &&árgc!=3 ){

158 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

159 " STRING\" o∏\"", 
¨gv
[0], " STRING INTEGER\"", 0);

160  
TCL_ERROR
;

163 if–
¨gc
==3 ){

164 i‡–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[2], &
Àn
ËË 
TCL_ERROR
;

166 
Àn
 = -1;

169 
	`sqlôe4_num_‰om_ãxt
(
¨gv
[1], 
Àn
, 0, &
pbRól
);

170 
	`T˛_AµídResu…
–
öãΩ
, 
pbRól
 ? "true" : "false", 0 );

171  
TCL_OK
;

172 
	}
}

174 
	$ã°_num_to_ãxt
(

175 *
NŸU£d
,

176 
T˛_I¡îp
 *
öãΩ
,

177 
¨gc
,

178 **
¨gv


180 
ãxt
[30];

181 if–
¨gc
!=2 ){

182 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

184  
TCL_ERROR
;

186 
	`sqlôe4_num_to_ãxt
–
	`ã°_∑r£_num
–
¨gv
[1] ), 
ãxt
, 0 );

187 
	`T˛_AµídResu…
–
öãΩ
, 
ãxt
, 0 );

188  
TCL_OK
;

189 
	}
}

191 
ã°_num_bö¨y_›
(

192 
T˛_I¡îp
 *
öãΩ
,

193 
¨gc
,

194 **
¨gv
,

195 
	$sqlôe4_num
 (*
›
Ë(
sqlôe4_num
, sqlite4_num)

197 
sqlôe4_num
 
A
, 
B
, 
R
;

198 if–
¨gc
!=3 ){

199 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

201  
TCL_ERROR
;

203 
A
 = 
	`ã°_∑r£_num
(
¨gv
[1]);

204 
B
 = 
	`ã°_∑r£_num
(
¨gv
[2]);

205 
R
 = 
	`›
(
A
, 
B
);

206 
	`≠≥nd_num_ªsu…
(
öãΩ
, 
R
);

207  
TCL_OK
;

208 
	}
}

210 
	$ã°_num_add
(

211 *
NŸU£d
,

212 
T˛_I¡îp
 *
öãΩ
,

213 
¨gc
,

214 **
¨gv


216  
	`ã°_num_bö¨y_›
–
öãΩ
, 
¨gc
, 
¨gv
, 
sqlôe4_num_add
 );

217 
	}
}

219 
	$ã°_num_sub
(

220 *
NŸU£d
,

221 
T˛_I¡îp
 *
öãΩ
,

222 
¨gc
,

223 **
¨gv


225  
	`ã°_num_bö¨y_›
–
öãΩ
, 
¨gc
, 
¨gv
, 
sqlôe4_num_sub
 );

226 
	}
}

228 
	$ã°_num_mul
(

229 *
NŸU£d
,

230 
T˛_I¡îp
 *
öãΩ
,

231 
¨gc
,

232 **
¨gv


234  
	`ã°_num_bö¨y_›
–
öãΩ
, 
¨gc
, 
¨gv
, 
sqlôe4_num_mul
 );

235 
	}
}

237 
	$ã°_num_div
(

238 *
NŸU£d
,

239 
T˛_I¡îp
 *
öãΩ
,

240 
¨gc
,

241 **
¨gv


243  
	`ã°_num_bö¨y_›
–
öãΩ
, 
¨gc
, 
¨gv
, 
sqlôe4_num_div
 );

244 
	}
}

246 
ã°_num_¥ediˇã
(

247 
T˛_I¡îp
 *
öãΩ
,

248 
¨gc
,

249 **
¨gv
,

250 (*
¥ed
Ë(
sqlôe4_num
)

252 
sqlôe4_num
 
A
;

253 if–
¨gc
!=2 ){

254 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

256  
TCL_ERROR
;

258 
A
 = 
	`ã°_∑r£_num
(
¨gv
[1]);

259 
	`T˛_AµídResu…
(
öãΩ
, 
	`¥ed
(
A
) ? "true" : "false", 0);

260  
TCL_OK
;

261 
	}
}

263 
	$ã°_num_isöf
(

264 *
NŸU£d
,

265 
T˛_I¡îp
 *
öãΩ
,

266 
¨gc
,

267 **
¨gv


269  
	`ã°_num_¥ediˇã
–
öãΩ
, 
¨gc
, 
¨gv
, 
sqlôe4_num_isöf
 );

270 
	}
}

272 
	$ã°_num_i¢™
(

273 *
NŸU£d
,

274 
T˛_I¡îp
 *
öãΩ
,

275 
¨gc
,

276 **
¨gv


278  
	`ã°_num_¥ediˇã
–
öãΩ
, 
¨gc
, 
¨gv
, 
sqlôe4_num_i¢™
 );

279 
	}
}

282 
	$ã°_num_‰om_doubÀ
(

283 * 
˛õ¡D©a
,

284 
T˛_I¡îp
 *
öãΩ
,

285 
objc
,

286 
T˛_Obj
 *
CONST
 
objv
[]

288 
sqlôe4_num
 
ªt
;

289 
vÆ
;

291 if–
objc
!=2 ){

292 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "NUMBER");

293  
TCL_ERROR
;

295 if–
	`T˛_GëDoubÀFromObj
(
öãΩ
, 
objv
[1], &
vÆ
) ){

296  
TCL_ERROR
;

299 
ªt
 = 
	`sqlôe4_num_‰om_doubÀ
(
vÆ
);

301 
	`T˛_Re£tResu…
(
öãΩ
);

302 
	`≠≥nd_num_ªsu…
(
öãΩ
, 
ªt
);

303  
TCL_OK
;

304 
	}
}

307 
	$ã°_num_to_öt32
(

308 *
NŸU£d
,

309 
T˛_I¡îp
 *
öãΩ
,

310 
¨gc
,

311 **
¨gv


313 
sqlôe4_num
 
A
;

314 
lossy
;

315 
iVÆ
;

316 
buf
[50];

317 if–
¨gc
!=2 ){

318 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

320  
TCL_ERROR
;

322 
A
 = 
	`ã°_∑r£_num
(
¨gv
[1]);

323 
iVÆ
 = 
	`sqlôe4_num_to_öt32
(
A
, &
lossy
);

324 
	`•rötf
–
buf
, "%s%d", 
lossy
?"~":"", 
iVÆ
 );

325 
	`T˛_AµídResu…
(
öãΩ
, 
buf
, 0);

326  
TCL_OK
;

327 
	}
}

329 
	$ã°_num_to_öt64
(

330 *
NŸU£d
,

331 
T˛_I¡îp
 *
öãΩ
,

332 
¨gc
,

333 **
¨gv


335 
sqlôe4_num
 
A
;

336 
lossy
;

337 
sqlôe4_öt64
 
iVÆ
;

338 
buf
[50];

339 if–
¨gc
!=2 ){

340 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

342  
TCL_ERROR
;

344 
A
 = 
	`ã°_∑r£_num
(
¨gv
[1]);

345 
iVÆ
 = 
	`sqlôe4_num_to_öt64
(
A
, &
lossy
);

346 
	`•rötf
–
buf
, "%s%Œd", 
lossy
?"~":"", 
iVÆ
 );

347 
	`T˛_AµídResu…
(
öãΩ
, 
buf
, 0);

348  
TCL_OK
;

349 
	}
}

355 
	$Sqlôëe°_num_öô
(
T˛_I¡îp
 *
öãΩ
){

357 *
zName
;

358 
T˛_CmdProc
 *
xProc
;

359 } 
aCmd
[] = {

360 { "sqlôe4_num_com∑ª", (
T˛_CmdProc
*)
ã°_num_com∑ª
 },

361 { "sqlôe4_num_‰om_ãxt", (
T˛_CmdProc
*)
ã°_num_‰om_ãxt
 },

362 { "sqlôe4_num_ãxt_is_ªÆ", (
T˛_CmdProc
*)
ã°_num_ãxt_is_ªÆ
 },

363 { "sqlôe4_num_to_ãxt", (
T˛_CmdProc
*)
ã°_num_to_ãxt
 },

364 { "sqlôe4_num_add", (
T˛_CmdProc
*)
ã°_num_add
 },

365 { "sqlôe4_num_sub", (
T˛_CmdProc
*)
ã°_num_sub
 },

366 { "sqlôe4_num_mul", (
T˛_CmdProc
*)
ã°_num_mul
 },

367 { "sqlôe4_num_div", (
T˛_CmdProc
*)
ã°_num_div
 },

368 { "sqlôe4_num_isöf", (
T˛_CmdProc
*)
ã°_num_isöf
 },

369 { "sqlôe4_num_i¢™", (
T˛_CmdProc
*)
ã°_num_i¢™
 },

370 { "sqlôe4_num_to_öt32", (
T˛_CmdProc
*)
ã°_num_to_öt32
 },

371 { "sqlôe4_num_to_öt64", (
T˛_CmdProc
*)
ã°_num_to_öt64
 },

375 *
zName
;

376 
T˛_ObjCmdProc
 *
xProc
;

377 *
˛õ¡D©a
;

378 } 
aObjCmd
[] = {

379 { "sqlôe4_num_‰om_doubÀ", 
ã°_num_‰om_doubÀ
, 0 },

381 
i
;

383 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

384 
	`T˛_Cª©eComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xProc
, 0, 0);

386 
i
=0; i<(
aObjCmd
)/(aObjCmd[0]); i++){

387 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aObjCmd
[
i
].
zName
,áObjCmd[i].
xProc
, 0, 0);

390  
TCL_OK
;

391 
	}
}

	@test/test_thread.c

18 
	~"sqlôeI¡.h
"

19 
	~<t˛.h
>

21 #i‡
SQLITE4_THREADSAFE


23 
	~<î∫o.h
>

25 #i‡!
deföed
(
_MSC_VER
)

26 
	~<uni°d.h
>

32 
SqlThªad
 
	tSqlThªad
;

33 
	sSqlThªad
 {

34 
T˛_ThªadId
 
	m∑ª¡
;

35 
T˛_I¡îp
 *
	möãΩ
;

36 *
	mzS¸ùt
;

37 *
	mzV¨«me
;

47 
EvÆEvít
 
	tEvÆEvít
;

48 
	sEvÆEvít
 {

49 
T˛_Evít
 
	mba£
;

50 *
	mzS¸ùt
;

51 
T˛_I¡îp
 *
	möãΩ
;

54 
T˛_ObjCmdProc
 
	gsq…hªad_¥oc
;

55 
T˛_ObjCmdProc
 
	g˛ock_£c⁄ds_¥oc
;

56 #i‡
SQLITE4_OS_UNIX
 && 
deföed
(
SQLITE4_ENABLE_UNLOCK_NOTIFY
)

57 
T˛_ObjCmdProc
 
	gblockög_°ï_¥oc
;

58 
T˛_ObjCmdProc
 
	gblockög_¥ï¨e_¥oc
;

60 
Sqlôëe°1_Inô
(
T˛_I¡îp
 *);

61 
Sqlôe3_Inô
(
T˛_I¡îp
 *);

64 *
sqlôe4Te°TextToPå
(const *);

65 c⁄° *
sqlôe4Te°Eº‹Name
();

66 
gëDbPoöãr
(
T˛_I¡îp
 *, c⁄° *, 
sqlôe4
 **);

67 
sqlôe4Te°MakePoöãrSå
(
T˛_I¡îp
 *, *, *);

68 
sqlôe4Te°EºCode
(
T˛_I¡îp
 *, 
sqlôe4
 *, );

73 
	$t˛S¸ùtEvít
(
T˛_Evít
 *
evPå
, 
Êags
){

74 
rc
;

75 
EvÆEvít
 *
p
 = (EvÆEvíà*)
evPå
;

76 
rc
 = 
	`T˛_EvÆ
(
p
->
öãΩ
,Ö->
zS¸ùt
);

77 if–
rc
!=
TCL_OK
 ){

78 
	`T˛_BackgroundEº‹
(
p
->
öãΩ
);

80 
	`UNUSED_PARAMETER
(
Êags
);

82 
	}
}

88 
	$po°ToP¨ít
(
SqlThªad
 *
p
, 
T˛_Obj
 *
pS¸ùt
){

89 
EvÆEvít
 *
pEvít
;

90 *
zMsg
;

91 
nMsg
;

93 
zMsg
 = 
	`T˛_GëSåögFromObj
(
pS¸ùt
, &
nMsg
);

94 
pEvít
 = (
EvÆEvít
 *)
	`ckÆloc
((EvÆEvít)+
nMsg
+1);

95 
pEvít
->
ba£
.
√xtPå
 = 0;

96 
pEvít
->
ba£
.
¥oc
 = 
t˛S¸ùtEvít
;

97 
pEvít
->
zS¸ùt
 = (*)&pEvent[1];

98 
	`mem˝y
(
pEvít
->
zS¸ùt
, 
zMsg
, 
nMsg
+1);

99 
pEvít
->
öãΩ
 = 
p
->interp;

101 
	`T˛_ThªadQueueEvít
(
p
->
∑ª¡
, (
T˛_Evít
 *)
pEvít
, 
TCL_QUEUE_TAIL
);

102 
	`T˛_ThªadAÀπ
(
p
->
∑ª¡
);

103 
	}
}

108 
T˛_ThªadCª©eTy≥
 
	$t˛S¸ùtThªad
(
Clõ¡D©a
 
pSqlThªad
){

109 
T˛_I¡îp
 *
öãΩ
;

110 
T˛_Obj
 *
pRes
;

111 
T˛_Obj
 *
pLi°
;

112 
rc
;

113 
SqlThªad
 *
p
 = (SqlThªad *)
pSqlThªad
;

114 
	`Sqlôëe°_muãx_Inô
(
T˛_I¡îp
*);

116 
öãΩ
 = 
	`T˛_Cª©eI¡îp
();

117 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "˛ock_£c⁄ds", 
˛ock_£c⁄ds_¥oc
, 0, 0);

118 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sq…hªad", 
sq…hªad_¥oc
, 
pSqlThªad
, 0);

119 #i‡
SQLITE4_OS_UNIX
 && 
	`deföed
(
SQLITE4_ENABLE_UNLOCK_NOTIFY
)

120 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sqlôe4_blockög_°ï", 
blockög_°ï_¥oc
,0,0);

121 
	`T˛_Cª©eObjComm™d
(
öãΩ
,

122 "sqlôe4_blockög_¥ï¨e", 
blockög_¥ï¨e_¥oc
, (*)1, 0);

123 
	`T˛_Cª©eObjComm™d
(
öãΩ
,

124 "sqlôe4_n⁄blockög_¥ï¨e", 
blockög_¥ï¨e_¥oc
, 0, 0);

126 
	`Sqlôëe°1_Inô
(
öãΩ
);

127 
	`Sqlôëe°_muãx_Inô
(
öãΩ
);

128 
	`Sqlôe3_Inô
(
öãΩ
);

130 
rc
 = 
	`T˛_EvÆ
(
öãΩ
, 
p
->
zS¸ùt
);

131 
pRes
 = 
	`T˛_GëObjResu…
(
öãΩ
);

132 
pLi°
 = 
	`T˛_NewObj
();

133 
	`T˛_In¸RefCou¡
(
pLi°
);

134 
	`T˛_In¸RefCou¡
(
pRes
);

136 if–
rc
!=
TCL_OK
 ){

137 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pLi°
, 
	`T˛_NewSåögObj
("error", -1));

138 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pLi°
, 
pRes
);

139 
	`po°ToP¨ít
(
p
, 
pLi°
);

140 
	`T˛_De¸RefCou¡
(
pLi°
);

141 
pLi°
 = 
	`T˛_NewObj
();

144 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pLi°
, 
	`T˛_NewSåögObj
("set", -1));

145 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pLi°
, 
	`T˛_NewSåögObj
(
p
->
zV¨«me
, -1));

146 
	`T˛_Li°ObjAµídEÀmít
(
öãΩ
, 
pLi°
, 
pRes
);

147 
	`po°ToP¨ít
(
p
, 
pLi°
);

149 
	`ck‰ì
((*)
p
);

150 
	`T˛_De¸RefCou¡
(
pLi°
);

151 
	`T˛_De¸RefCou¡
(
pRes
);

152 
	`T˛_DñëeI¡îp
(
öãΩ
);

153  
	`T˛_DoO√Evít
(
TCL_ALL_EVENTS
|
TCL_DONT_WAIT
) );

154 
	`T˛_ExôThªad
(0);

155 
TCL_THREAD_CREATE_RETURN
;

156 
	}
}

168 
	$sq…hªad_•awn
(

169 
Clõ¡D©a
 
˛õ¡D©a
,

170 
T˛_I¡îp
 *
öãΩ
,

171 
objc
,

172 
T˛_Obj
 *
CONST
 
objv
[]

174 
T˛_ThªadId
 
x
;

175 
SqlThªad
 *
pNew
;

176 
rc
;

178 
nV¨«me
; *
zV¨«me
;

179 
nS¸ùt
; *
zS¸ùt
;

182 c⁄° 
nSèck
 = 
TCL_THREAD_STACK_DEFAULT
;

183 c⁄° 
Êags
 = 
TCL_THREAD_NOFLAGS
;

185 
	`as£π
(
objc
==4);

186 
	`UNUSED_PARAMETER
(
˛õ¡D©a
);

187 
	`UNUSED_PARAMETER
(
objc
);

189 
zV¨«me
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
nV¨«me
);

190 
zS¸ùt
 = 
	`T˛_GëSåögFromObj
(
objv
[3], &
nS¸ùt
);

192 
pNew
 = (
SqlThªad
 *)
	`ckÆloc
((SqlThªad)+
nV¨«me
+
nS¸ùt
+2);

193 
pNew
->
zV¨«me
 = (*)&pNew[1];

194 
pNew
->
zS¸ùt
 = (*)&pNew->
zV¨«me
[
nV¨«me
+1];

195 
	`mem˝y
(
pNew
->
zV¨«me
, zV¨«me, 
nV¨«me
+1);

196 
	`mem˝y
(
pNew
->
zS¸ùt
, zS¸ùt, 
nS¸ùt
+1);

197 
pNew
->
∑ª¡
 = 
	`T˛_GëCuºítThªad
();

198 
pNew
->
öãΩ
 = interp;

200 
rc
 = 
	`T˛_Cª©eThªad
(&
x
, 
t˛S¸ùtThªad
, (*)
pNew
, 
nSèck
, 
Êags
);

201 if–
rc
!=
TCL_OK
 ){

202 
	`T˛_AµídResu…
(
öãΩ
, "Error in Tcl_CreateThread()", 0);

203 
	`ck‰ì
((*)
pNew
);

204  
TCL_ERROR
;

207  
TCL_OK
;

208 
	}
}

221 
	$sq…hªad_∑ª¡
(

222 
Clõ¡D©a
 
˛õ¡D©a
,

223 
T˛_I¡îp
 *
öãΩ
,

224 
objc
,

225 
T˛_Obj
 *
CONST
 
objv
[]

227 
EvÆEvít
 *
pEvít
;

228 *
zMsg
;

229 
nMsg
;

230 
SqlThªad
 *
p
 = (SqlThªad *)
˛õ¡D©a
;

232 
	`as£π
(
objc
==3);

233 
	`UNUSED_PARAMETER
(
objc
);

235 if–
p
==0 ){

236 
	`T˛_AµídResu…
(
öãΩ
, "noÖarentÅhread", 0);

237  
TCL_ERROR
;

240 
zMsg
 = 
	`T˛_GëSåögFromObj
(
objv
[2], &
nMsg
);

241 
pEvít
 = (
EvÆEvít
 *)
	`ckÆloc
((EvÆEvít)+
nMsg
+1);

242 
pEvít
->
ba£
.
√xtPå
 = 0;

243 
pEvít
->
ba£
.
¥oc
 = 
t˛S¸ùtEvít
;

244 
pEvít
->
zS¸ùt
 = (*)&pEvent[1];

245 
	`mem˝y
(
pEvít
->
zS¸ùt
, 
zMsg
, 
nMsg
+1);

246 
pEvít
->
öãΩ
 = 
p
->interp;

247 
	`T˛_ThªadQueueEvít
(
p
->
∑ª¡
, (
T˛_Evít
 *)
pEvít
, 
TCL_QUEUE_TAIL
);

248 
	`T˛_ThªadAÀπ
(
p
->
∑ª¡
);

250  
TCL_OK
;

251 
	}
}

259 
	$sq…hªad_›í
(

260 
Clõ¡D©a
 
˛õ¡D©a
,

261 
T˛_I¡îp
 *
öãΩ
,

262 
objc
,

263 
T˛_Obj
 *
CONST
 
objv
[]

265 
	`sqlôe4Te°MakePoöãrSå
(
T˛_I¡îp
 *
öãΩ
, *
zPå
, *
p
);

267 c⁄° *
zFûíame
;

268 
sqlôe4
 *
db
;

269 
rc
;

270 
zBuf
[100];

271 
	`Md5_Regi°î
(
sqlôe4
*);

273 
	`UNUSED_PARAMETER
(
˛õ¡D©a
);

274 
	`UNUSED_PARAMETER
(
objc
);

276 
zFûíame
 = 
	`T˛_GëSåög
(
objv
[2]);

277 
rc
 = 
	`sqlôe4_›í
(0, 
zFûíame
, &
db
, 0);

278 
	`Md5_Regi°î
(
db
);

280 if–
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
db
ËË 
TCL_ERROR
;

281 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

283  
TCL_OK
;

284 
	}
}

293 
	$sq…hªad_id
(

294 
Clõ¡D©a
 
˛õ¡D©a
,

295 
T˛_I¡îp
 *
öãΩ
,

296 
objc
,

297 
T˛_Obj
 *
CONST
 
objv
[]

299 
T˛_ThªadId
 
id
 = 
	`T˛_GëCuºítThªad
();

300 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
	`SQLITE4_PTR_TO_INT
(
id
)));

301 
	`UNUSED_PARAMETER
(
˛õ¡D©a
);

302 
	`UNUSED_PARAMETER
(
objc
);

303 
	`UNUSED_PARAMETER
(
objv
);

304  
TCL_OK
;

305 
	}
}

311 
	$sq…hªad_¥oc
(

312 
Clõ¡D©a
 
˛õ¡D©a
,

313 
T˛_I¡îp
 *
öãΩ
,

314 
objc
,

315 
T˛_Obj
 *
CONST
 
objv
[]

317 
	sSubComm™d
 {

318 *
zName
;

319 
T˛_ObjCmdProc
 *
xProc
;

320 
nArg
;

321 *
zUßge
;

322 } 
aSub
[] = {

323 {"∑ª¡", 
sq…hªad_∑ª¡
, 1, "SCRIPT"},

324 {"•awn", 
sq…hªad_•awn
, 2, "VARNAME SCRIPT"},

325 {"›í", 
sq…hªad_›í
, 1, "DBNAME"},

326 {"id", 
sq…hªad_id
, 0, ""},

329 
SubComm™d
 *
pSub
;

330 
rc
;

331 
iIndex
;

333 if–
objc
<2 ){

334 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "SUB-COMMAND");

335  
TCL_ERROR
;

338 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

339 
öãΩ
, 
objv
[1], 
aSub
, ◊Sub[0]), "sub-comm™d", 0, &
iIndex


341 if–
rc
!=
TCL_OK
 ) Ñc;

342 
pSub
 = &
aSub
[
iIndex
];

344 if–
objc
<(
pSub
->
nArg
+2) ){

345 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 2, 
objv
, 
pSub
->
zUßge
);

346  
TCL_ERROR
;

349  
pSub
->
	`xProc
(
˛õ¡D©a
, 
öãΩ
, 
objc
, 
objv
);

350 
	}
}

359 
	$˛ock_£c⁄ds_¥oc
(

360 
Clõ¡D©a
 
˛õ¡D©a
,

361 
T˛_I¡îp
 *
öãΩ
,

362 
objc
,

363 
T˛_Obj
 *
CONST
 
objv
[]

365 
T˛_Time
 
now
;

366 
	`T˛_GëTime
(&
now
);

367 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewI¡Obj
(
now
.
£c
));

368 
	`UNUSED_PARAMETER
(
˛õ¡D©a
);

369 
	`UNUSED_PARAMETER
(
objc
);

370 
	`UNUSED_PARAMETER
(
objv
);

371  
TCL_OK
;

372 
	}
}

387 #i‡
SQLITE4_OS_UNIX
 && 
deföed
(
SQLITE4_ENABLE_UNLOCK_NOTIFY
)

391 
	~<±hªad.h
>

397 
U∆ockNŸifiˇti⁄
 
	tU∆ockNŸifiˇti⁄
;

398 
	sU∆ockNŸifiˇti⁄
 {

399 
	mfúed
;

400 
±hªad_c⁄d_t
 
	mc⁄d
;

401 
±hªad_muãx_t
 
	mmuãx
;

407 
	$u∆ock_nŸify_cb
(**
≠Arg
, 
nArg
){

408 
i
;

409 
i
=0; i<
nArg
; i++){

410 
U∆ockNŸifiˇti⁄
 *
p
 = (U∆ockNŸifiˇti⁄ *)
≠Arg
[
i
];

411 
	`±hªad_muãx_lock
(&
p
->
muãx
);

412 
p
->
fúed
 = 1;

413 
	`±hªad_c⁄d_sig«l
(&
p
->
c⁄d
);

414 
	`±hªad_muãx_u∆ock
(&
p
->
muãx
);

416 
	}
}

432 
	$waô_f‹_u∆ock_nŸify
(
sqlôe4
 *
db
){

433 
rc
;

434 
U∆ockNŸifiˇti⁄
 
un
;

437 
un
.
fúed
 = 0;

438 
	`±hªad_muãx_öô
(&
un
.
muãx
, 0);

439 
	`±hªad_c⁄d_öô
(&
un
.
c⁄d
, 0);

442 
rc
 = 
	`sqlôe4_u∆ock_nŸify
(
db
, 
u∆ock_nŸify_cb
, (*)&
un
);

443 
	`as£π
–
rc
==
SQLITE4_LOCKED
 ||Ñc==
SQLITE4_OK
 );

453 if–
rc
==
SQLITE4_OK
 ){

454 
	`±hªad_muãx_lock
(&
un
.
muãx
);

455 if–!
un
.
fúed
 ){

456 
	`±hªad_c⁄d_waô
(&
un
.
c⁄d
, &un.
muãx
);

458 
	`±hªad_muãx_u∆ock
(&
un
.
muãx
);

462 
	`±hªad_c⁄d_de°roy
(&
un
.
c⁄d
);

463 
	`±hªad_muãx_de°roy
(&
un
.
muãx
);

465  
rc
;

466 
	}
}

471 
	$sqlôe4_blockög_°ï
(
sqlôe4_°mt
 *
pStmt
){

472 
rc
;

473  
SQLITE4_LOCKED
==(
rc
 = 
	`sqlôe4_°ï
(
pStmt
)) ){

474 
rc
 = 
	`waô_f‹_u∆ock_nŸify
(
	`sqlôe4_db_h™dÀ
(
pStmt
));

475 if–
rc
!=
SQLITE4_OK
 ) ;

476 
	`sqlôe4_ª£t
(
pStmt
);

478  
rc
;

479 
	}
}

492 
	$sqlôe4_blockög_¥ï¨e
(

493 
sqlôe4
 *
db
,

494 c⁄° *
zSql
,

495 
nSql
,

496 
sqlôe4_°mt
 **
µStmt
,

497 *
≤


499 
rc
;

500  
SQLITE4_LOCKED
==(
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, 
nSql
, 
µStmt
, 
≤
)) ){

501 
rc
 = 
	`waô_f‹_u∆ock_nŸify
(
db
);

502 if–
rc
!=
SQLITE4_OK
 ) ;

504  
rc
;

505 
	}
}

513 
	$blockög_°ï_¥oc
(

514 * 
˛õ¡D©a
,

515 
T˛_I¡îp
 *
öãΩ
,

516 
objc
,

517 
T˛_Obj
 *
CONST
 
objv
[]

520 
sqlôe4_°mt
 *
pStmt
;

521 
rc
;

523 if–
objc
!=2 ){

524 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "STMT");

525  
TCL_ERROR
;

528 
pStmt
 = (
sqlôe4_°mt
*)
	`sqlôe4Te°TextToPå
(
	`T˛_GëSåög
(
objv
[1]));

529 
rc
 = 
	`sqlôe4_blockög_°ï
(
pStmt
);

531 
	`T˛_SëResu…
(
öãΩ
, (*)
	`sqlôe4Te°Eº‹Name
(
rc
), 0);

532  
TCL_OK
;

533 
	}
}

539 
	$blockög_¥ï¨e_¥oc
(

540 * 
˛õ¡D©a
,

541 
T˛_I¡îp
 *
öãΩ
,

542 
objc
,

543 
T˛_Obj
 *
CONST
 
objv
[]

545 
sqlôe4
 *
db
;

546 c⁄° *
zSql
;

547 
byãs
;

548 
nU£d
;

549 
sqlôe4_°mt
 *
pStmt
 = 0;

550 
zBuf
[50];

551 
rc
;

552 
isBlockög
 = !(
˛õ¡D©a
==0);

554 if–
objc
!=5 && objc!=4 ){

555 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

556 
	`T˛_GëSåög
(
objv
[0]), " DB sql bytesÅailvar", 0);

557  
TCL_ERROR
;

559 if–
	`gëDbPoöãr
(
öãΩ
, 
	`T˛_GëSåög
(
objv
[1]), &
db
ËË 
TCL_ERROR
;

560 
zSql
 = 
	`T˛_GëSåög
(
objv
[2]);

561 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[3], &
byãs
ËË 
TCL_ERROR
;

563 if–
isBlockög
 ){

564 
rc
 = 
	`sqlôe4_blockög_¥ï¨e
(
db
, 
zSql
, 
byãs
, &
pStmt
, &
nU£d
);

566 
rc
 = 
	`sqlôe4_¥ï¨e
(
db
, 
zSql
, 
byãs
, &
pStmt
, &
nU£d
);

569 
	`as£π
(
rc
==
SQLITE4_OK
 || 
pStmt
==0);

570 if–
objc
>=5 ){

571 c⁄° *
zTaû
 = 
zSql
[
nU£d
];

572 
nTaû
 = -1;

573 if–
byãs
>=0 ){

574 
nTaû
 = 
byãs
 - 
nU£d
;

576 
	`T˛_ObjSëV¨2
(
öãΩ
, 
objv
[4], 0, 
	`T˛_NewSåögObj
(
zTaû
, 
nTaû
), 0);

578 if–
rc
!=
SQLITE4_OK
 ){

579 
	`as£π
–
pStmt
==0 );

580 
	`•rötf
(
zBuf
, "%†", (*)
	`sqlôe4Te°Eº‹Name
(
rc
));

581 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 
	`sqlôe4_îrmsg
(
db
), 0);

582  
TCL_ERROR
;

585 if–
pStmt
 ){

586 if–
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
pStmt
ËË 
TCL_ERROR
;

587 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

589  
TCL_OK
;

590 
	}
}

600 
	$Sqlôëe°Thªad_Inô
(
T˛_I¡îp
 *
öãΩ
){

601 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sq…hªad", 
sq…hªad_¥oc
, 0, 0);

602 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "˛ock_£c⁄ds", 
˛ock_£c⁄ds_¥oc
, 0, 0);

603 #i‡
SQLITE4_OS_UNIX
 && 
	`deföed
(
SQLITE4_ENABLE_UNLOCK_NOTIFY
)

604 
	`T˛_Cª©eObjComm™d
(
öãΩ
, "sqlôe4_blockög_°ï", 
blockög_°ï_¥oc
,0,0);

605 
	`T˛_Cª©eObjComm™d
(
öãΩ
,

606 "sqlôe4_blockög_¥ï¨e", 
blockög_¥ï¨e_¥oc
, (*)1, 0);

607 
	`T˛_Cª©eObjComm™d
(
öãΩ
,

608 "sqlôe4_n⁄blockög_¥ï¨e", 
blockög_¥ï¨e_¥oc
, 0, 0);

610  
TCL_OK
;

611 
	}
}

613 
	$Sqlôëe°Thªad_Inô
(
T˛_I¡îp
 *
öãΩ
){

614  
TCL_OK
;

615 
	}
}

	@test/test_thread0.c

14 
	~"sqlôeI¡.h
"

15 
	~"t˛.h
"

16 #i‡0 && 
SQLITE4_OS_UNIX
 && 
SQLITE4_THREADSAFE


17 
	~<°dlib.h
>

18 
	~<°rög.h
>

19 
	~<±hªad.h
>

20 
	~<sched.h
>

21 
	~<˘y≥.h
>

27 
Thªad
 
	tThªad
;

28 
	sThªad
 {

31 *
	mzFûíame
;

32 (*
	mxOp
)(
	mThªad
*);

33 *
	mzArg
;

34 
	m›num
;

35 
	mbusy
;

39 
	mcom∂ëed
;

40 
sqlôe4
 *
	mdb
;

41 
sqlôe4_°mt
 *
	mpStmt
;

42 *
	mzEº
;

43 *
	mzSèticEº
;

44 
	mrc
;

45 
	m¨gc
;

46 c⁄° *
	m¨gv
[100];

47 c⁄° *
	mcﬁv
[100];

54 
	#N_THREAD
 26

	)

55 
Thªad
 
	gthªad£t
[
N_THREAD
];

61 *
	$thªad_maö
(*
pArg
){

62 
Thªad
 *
p
 = (Thªad*)
pArg
;

63 if–
p
->
db
 ){

64 
	`sqlôe4_˛o£
(
p
->
db
, 0);

66 
	`sqlôe4_›í
(0, 
p
->
zFûíame
, &p->
db
, 0);

67 if–
SQLITE4_OK
!=
	`sqlôe4_îrcode
(
p
->
db
) ){

68 
p
->
zEº
 = 
	`°rdup
(
	`sqlôe4_îrmsg
’->
db
));

69 
	`sqlôe4_˛o£
(
p
->
db
, 0);

70 
p
->
db
 = 0;

72 
p
->
pStmt
 = 0;

73 
p
->
com∂ëed
 = 1;

74  
p
->
›num
<ı->
com∂ëed
 ) 
	`sched_yõld
();

75  
p
->
xOp
 ){

76 if–
p
->
zEº
 &&Ö->zEº!ı->
zSèticEº
 ){

77 
	`sqlôe4_‰ì
(0, 
p
->
zEº
);

78 
p
->
zEº
 = 0;

80 (*
p
->
xOp
)(p);

81 
p
->
com∂ëed
++;

82  
p
->
›num
<ı->
com∂ëed
 ) 
	`sched_yõld
();

84 if–
p
->
pStmt
 ){

85 
	`sqlôe4_föÆize
(
p
->
pStmt
);

86 
p
->
pStmt
 = 0;

88 if–
p
->
db
 ){

89 
	`sqlôe4_˛o£
(
p
->
db
, 0);

90 
p
->
db
 = 0;

92 if–
p
->
zEº
 &&Ö->zEº!ı->
zSèticEº
 ){

93 
	`sqlôe4_‰ì
(0, 
p
->
zEº
);

94 
p
->
zEº
 = 0;

96 
p
->
com∂ëed
++;

98 
	}
}

105 
	$∑r£_thªad_id
(
T˛_I¡îp
 *
öãΩ
, c⁄° *
zArg
){

106 if–
zArg
==0 || zArg[0]==0 || zArg[1]!=0 || !
	`isuµî
(()zArg[0]) ){

107 
	`T˛_AµídResu…
(
öãΩ
, "thread ID must beán upper caseÜetter", 0);

110  
zArg
[0] - 'A';

111 
	}
}

119 
	$t˛_thªad_¸óã
(

120 *
NŸU£d
,

121 
T˛_I¡îp
 *
öãΩ
,

122 
¨gc
,

123 c⁄° **
¨gv


125 
i
;

126 
±hªad_t
 
x
;

127 
rc
;

129 if–
¨gc
!=3 ){

130 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

132  
TCL_ERROR
;

134 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

135 if–
i
<0 )  
TCL_ERROR
;

136 if–
thªad£t
[
i
].
busy
 ){

137 
	`T˛_AµídResu…
(
öãΩ
, "thªad ", 
¨gv
[1], " isálreadyÑunning", 0);

138  
TCL_ERROR
;

140 
thªad£t
[
i
].
busy
 = 1;

141 
	`sqlôe4_‰ì
(0, 
thªad£t
[
i
].
zFûíame
);

142 
thªad£t
[
i
].
zFûíame
 = 
	`sqlôe4_m¥ötf
(0, "%s", 
¨gv
[2]);

143 
thªad£t
[
i
].
›num
 = 1;

144 
thªad£t
[
i
].
com∂ëed
 = 0;

145 
rc
 = 
	`±hªad_¸óã
(&
x
, 0, 
thªad_maö
, &
thªad£t
[
i
]);

146 if–
rc
 ){

147 
	`T˛_AµídResu…
(
öãΩ
, "failedÅo createÅheÅhread", 0);

148 
	`sqlôe4_‰ì
(0, 
thªad£t
[
i
].
zFûíame
);

149 
thªad£t
[
i
].
busy
 = 0;

150  
TCL_ERROR
;

152 
	`±hªad_dëach
(
x
);

153  
TCL_OK
;

154 
	}
}

159 
	$thªad_waô
(
Thªad
 *
p
){

160  
p
->
›num
>p->
com∂ëed
 ) 
	`sched_yõld
();

161 
	}
}

168 
	$t˛_thªad_waô
(

169 *
NŸU£d
,

170 
T˛_I¡îp
 *
öãΩ
,

171 
¨gc
,

172 c⁄° **
¨gv


174 
i
;

176 if–
¨gc
!=2 ){

177 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

179  
TCL_ERROR
;

181 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

182 if–
i
<0 )  
TCL_ERROR
;

183 if–!
thªad£t
[
i
].
busy
 ){

184 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

185  
TCL_ERROR
;

187 
	`thªad_waô
(&
thªad£t
[
i
]);

188  
TCL_OK
;

189 
	}
}

194 
	$°›_thªad
(
Thªad
 *
p
){

195 
	`thªad_waô
(
p
);

196 
p
->
xOp
 = 0;

197 
p
->
›num
++;

198 
	`thªad_waô
(
p
);

199 
	`sqlôe4_‰ì
(0, 
p
->
zArg
);

200 
p
->
zArg
 = 0;

201 
	`sqlôe4_‰ì
(0, 
p
->
zFûíame
);

202 
p
->
zFûíame
 = 0;

203 
p
->
busy
 = 0;

204 
	}
}

212 
	$t˛_thªad_hÆt
(

213 *
NŸU£d
,

214 
T˛_I¡îp
 *
öãΩ
,

215 
¨gc
,

216 c⁄° **
¨gv


218 
i
;

220 if–
¨gc
!=2 ){

221 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

223  
TCL_ERROR
;

225 if–
¨gv
[1][0]=='*' &&árgv[1][1]==0 ){

226 
i
=0; i<
N_THREAD
; i++){

227 if–
thªad£t
[
i
].
busy
 ) 
	`°›_thªad
(&threadset[i]);

230 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

231 if–
i
<0 )  
TCL_ERROR
;

232 if–!
thªad£t
[
i
].
busy
 ){

233 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

234  
TCL_ERROR
;

236 
	`°›_thªad
(&
thªad£t
[
i
]);

238  
TCL_OK
;

239 
	}
}

247 
	$t˛_thªad_¨gc
(

248 *
NŸU£d
,

249 
T˛_I¡îp
 *
öãΩ
,

250 
¨gc
,

251 c⁄° **
¨gv


253 
i
;

254 
zBuf
[100];

256 if–
¨gc
!=2 ){

257 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

259  
TCL_ERROR
;

261 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

262 if–
i
<0 )  
TCL_ERROR
;

263 if–!
thªad£t
[
i
].
busy
 ){

264 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

265  
TCL_ERROR
;

267 
	`thªad_waô
(&
thªad£t
[
i
]);

268 
	`•rötf
(
zBuf
, "%d", 
thªad£t
[
i
].
¨gc
);

269 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, 0);

270  
TCL_OK
;

271 
	}
}

279 
	$t˛_thªad_¨gv
(

280 *
NŸU£d
,

281 
T˛_I¡îp
 *
öãΩ
,

282 
¨gc
,

283 c⁄° **
¨gv


285 
i
;

286 
n
;

288 if–
¨gc
!=3 ){

289 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

291  
TCL_ERROR
;

293 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

294 if–
i
<0 )  
TCL_ERROR
;

295 if–!
thªad£t
[
i
].
busy
 ){

296 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

297  
TCL_ERROR
;

299 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[2], &
n
ËË 
TCL_ERROR
;

300 
	`thªad_waô
(&
thªad£t
[
i
]);

301 if–
n
<0 ||Ç>=
thªad£t
[
i
].
¨gc
 ){

302 
	`T˛_AµídResu…
(
öãΩ
, "columnÇumber out ofÑange", 0);

303  
TCL_ERROR
;

305 
	`T˛_AµídResu…
(
öãΩ
, 
thªad£t
[
i
].
¨gv
[
n
], 0);

306  
TCL_OK
;

307 
	}
}

315 
	$t˛_thªad_cﬁ«me
(

316 *
NŸU£d
,

317 
T˛_I¡îp
 *
öãΩ
,

318 
¨gc
,

319 c⁄° **
¨gv


321 
i
;

322 
n
;

324 if–
¨gc
!=3 ){

325 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

327  
TCL_ERROR
;

329 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

330 if–
i
<0 )  
TCL_ERROR
;

331 if–!
thªad£t
[
i
].
busy
 ){

332 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

333  
TCL_ERROR
;

335 if–
	`T˛_GëI¡
(
öãΩ
, 
¨gv
[2], &
n
ËË 
TCL_ERROR
;

336 
	`thªad_waô
(&
thªad£t
[
i
]);

337 if–
n
<0 ||Ç>=
thªad£t
[
i
].
¨gc
 ){

338 
	`T˛_AµídResu…
(
öãΩ
, "columnÇumber out ofÑange", 0);

339  
TCL_ERROR
;

341 
	`T˛_AµídResu…
(
öãΩ
, 
thªad£t
[
i
].
cﬁv
[
n
], 0);

342  
TCL_OK
;

343 
	}
}

351 
	$t˛_thªad_ªsu…
(

352 *
NŸU£d
,

353 
T˛_I¡îp
 *
öãΩ
,

354 
¨gc
,

355 c⁄° **
¨gv


357 
i
;

358 c⁄° *
zName
;

360 if–
¨gc
!=2 ){

361 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

363  
TCL_ERROR
;

365 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

366 if–
i
<0 )  
TCL_ERROR
;

367 if–!
thªad£t
[
i
].
busy
 ){

368 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

369  
TCL_ERROR
;

371 
	`thªad_waô
(&
thªad£t
[
i
]);

372  
thªad£t
[
i
].
rc
 ){

373 
SQLITE4_OK
: 
zName
 = "SQLITE4_OK"; ;

374 
SQLITE4_ERROR
: 
zName
 = "SQLITE4_ERROR"; ;

375 
SQLITE4_PERM
: 
zName
 = "SQLITE4_PERM"; ;

376 
SQLITE4_ABORT
: 
zName
 = "SQLITE4_ABORT"; ;

377 
SQLITE4_BUSY
: 
zName
 = "SQLITE4_BUSY"; ;

378 
SQLITE4_LOCKED
: 
zName
 = "SQLITE4_LOCKED"; ;

379 
SQLITE4_NOMEM
: 
zName
 = "SQLITE4_NOMEM"; ;

380 
SQLITE4_READONLY
: 
zName
 = "SQLITE4_READONLY"; ;

381 
SQLITE4_INTERRUPT
: 
zName
 = "SQLITE4_INTERRUPT"; ;

382 
SQLITE4_IOERR
: 
zName
 = "SQLITE4_IOERR"; ;

383 
SQLITE4_CORRUPT
: 
zName
 = "SQLITE4_CORRUPT"; ;

384 
SQLITE4_FULL
: 
zName
 = "SQLITE4_FULL"; ;

385 
SQLITE4_CANTOPEN
: 
zName
 = "SQLITE4_CANTOPEN"; ;

386 
SQLITE4_PROTOCOL
: 
zName
 = "SQLITE4_PROTOCOL"; ;

387 
SQLITE4_EMPTY
: 
zName
 = "SQLITE4_EMPTY"; ;

388 
SQLITE4_SCHEMA
: 
zName
 = "SQLITE4_SCHEMA"; ;

389 
SQLITE4_CONSTRAINT
: 
zName
 = "SQLITE4_CONSTRAINT"; ;

390 
SQLITE4_MISMATCH
: 
zName
 = "SQLITE4_MISMATCH"; ;

391 
SQLITE4_MISUSE
: 
zName
 = "SQLITE4_MISUSE"; ;

392 
SQLITE4_NOLFS
: 
zName
 = "SQLITE4_NOLFS"; ;

393 
SQLITE4_AUTH
: 
zName
 = "SQLITE4_AUTH"; ;

394 
SQLITE4_FORMAT
: 
zName
 = "SQLITE4_FORMAT"; ;

395 
SQLITE4_RANGE
: 
zName
 = "SQLITE4_RANGE"; ;

396 
SQLITE4_ROW
: 
zName
 = "SQLITE4_ROW"; ;

397 
SQLITE4_DONE
: 
zName
 = "SQLITE4_DONE"; ;

398 : 
zName
 = "SQLITE4_Unknown"; ;

400 
	`T˛_AµídResu…
(
öãΩ
, 
zName
, 0);

401  
TCL_OK
;

402 
	}
}

410 
	$t˛_thªad_îr‹
(

411 *
NŸU£d
,

412 
T˛_I¡îp
 *
öãΩ
,

413 
¨gc
,

414 c⁄° **
¨gv


416 
i
;

418 if–
¨gc
!=2 ){

419 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

421  
TCL_ERROR
;

423 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

424 if–
i
<0 )  
TCL_ERROR
;

425 if–!
thªad£t
[
i
].
busy
 ){

426 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

427  
TCL_ERROR
;

429 
	`thªad_waô
(&
thªad£t
[
i
]);

430 
	`T˛_AµídResu…
(
öãΩ
, 
thªad£t
[
i
].
zEº
, 0);

431  
TCL_OK
;

432 
	}
}

437 
	$do_compûe
(
Thªad
 *
p
){

438 if–
p
->
db
==0 ){

439 
p
->
zEº
 =Ö->
zSèticEº
 = "no database is open";

440 
p
->
rc
 = 
SQLITE4_ERROR
;

443 if–
p
->
pStmt
 ){

444 
	`sqlôe4_föÆize
(
p
->
pStmt
);

445 
p
->
pStmt
 = 0;

447 
p
->
rc
 = 
	`sqlôe4_¥ï¨e
’->
db
,Ö->
zArg
, -1, &p->
pStmt
, 0);

448 
	}
}

455 
	$t˛_thªad_compûe
(

456 *
NŸU£d
,

457 
T˛_I¡îp
 *
öãΩ
,

458 
¨gc
,

459 c⁄° **
¨gv


461 
i
;

462 if–
¨gc
!=3 ){

463 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

465  
TCL_ERROR
;

467 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

468 if–
i
<0 )  
TCL_ERROR
;

469 if–!
thªad£t
[
i
].
busy
 ){

470 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

471  
TCL_ERROR
;

473 
	`thªad_waô
(&
thªad£t
[
i
]);

474 
thªad£t
[
i
].
xOp
 = 
do_compûe
;

475 
	`sqlôe4_‰ì
(0, 
thªad£t
[
i
].
zArg
);

476 
thªad£t
[
i
].
zArg
 = 
	`sqlôe4_m¥ötf
(0, "%s", 
¨gv
[2]);

477 
thªad£t
[
i
].
›num
++;

478  
TCL_OK
;

479 
	}
}

484 
	$do_°ï
(
Thªad
 *
p
){

485 
i
;

486 if–
p
->
pStmt
==0 ){

487 
p
->
zEº
 =Ö->
zSèticEº
 = "no virtual machineávailable";

488 
p
->
rc
 = 
SQLITE4_ERROR
;

491 
p
->
rc
 = 
	`sqlôe4_°ï
’->
pStmt
);

492 if–
p
->
rc
==
SQLITE4_ROW
 ){

493 
p
->
¨gc
 = 
	`sqlôe4_cﬁumn_cou¡
’->
pStmt
);

494 
i
=0; i<
	`sqlôe4_d©a_cou¡
(
p
->
pStmt
); i++){

495 
p
->
¨gv
[
i
] = (*)
	`sqlôe4_cﬁumn_ãxt
’->
pStmt
, i);

497 
i
=0; i<
p
->
¨gc
; i++){

498 
p
->
cﬁv
[
i
] = 
	`sqlôe4_cﬁumn_«me
’->
pStmt
, i);

501 
	}
}

508 
	$t˛_thªad_°ï
(

509 *
NŸU£d
,

510 
T˛_I¡îp
 *
öãΩ
,

511 
¨gc
,

512 c⁄° **
¨gv


514 
i
;

515 if–
¨gc
!=2 ){

516 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

518  
TCL_ERROR
;

520 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

521 if–
i
<0 )  
TCL_ERROR
;

522 if–!
thªad£t
[
i
].
busy
 ){

523 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

524  
TCL_ERROR
;

526 
	`thªad_waô
(&
thªad£t
[
i
]);

527 
thªad£t
[
i
].
xOp
 = 
do_°ï
;

528 
thªad£t
[
i
].
›num
++;

529  
TCL_OK
;

530 
	}
}

535 
	$do_föÆize
(
Thªad
 *
p
){

536 if–
p
->
pStmt
==0 ){

537 
p
->
zEº
 =Ö->
zSèticEº
 = "no virtual machineávailable";

538 
p
->
rc
 = 
SQLITE4_ERROR
;

541 
p
->
rc
 = 
	`sqlôe4_föÆize
’->
pStmt
);

542 
p
->
pStmt
 = 0;

543 
	}
}

550 
	$t˛_thªad_föÆize
(

551 *
NŸU£d
,

552 
T˛_I¡îp
 *
öãΩ
,

553 
¨gc
,

554 c⁄° **
¨gv


556 
i
;

557 if–
¨gc
!=2 ){

558 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

560  
TCL_ERROR
;

562 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

563 if–
i
<0 )  
TCL_ERROR
;

564 if–!
thªad£t
[
i
].
busy
 ){

565 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

566  
TCL_ERROR
;

568 
	`thªad_waô
(&
thªad£t
[
i
]);

569 
thªad£t
[
i
].
xOp
 = 
do_föÆize
;

570 
	`sqlôe4_‰ì
(0, 
thªad£t
[
i
].
zArg
);

571 
thªad£t
[
i
].
zArg
 = 0;

572 
thªad£t
[
i
].
›num
++;

573  
TCL_OK
;

574 
	}
}

581 
	$t˛_thªad_sw≠
(

582 *
NŸU£d
,

583 
T˛_I¡îp
 *
öãΩ
,

584 
¨gc
,

585 c⁄° **
¨gv


587 
i
, 
j
;

588 
sqlôe4
 *
ãmp
;

589 if–
¨gc
!=3 ){

590 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

592  
TCL_ERROR
;

594 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

595 if–
i
<0 )  
TCL_ERROR
;

596 if–!
thªad£t
[
i
].
busy
 ){

597 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

598  
TCL_ERROR
;

600 
	`thªad_waô
(&
thªad£t
[
i
]);

601 
j
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[2]);

602 if–
j
<0 )  
TCL_ERROR
;

603 if–!
thªad£t
[
j
].
busy
 ){

604 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

605  
TCL_ERROR
;

607 
	`thªad_waô
(&
thªad£t
[
j
]);

608 
ãmp
 = 
thªad£t
[
i
].
db
;

609 
thªad£t
[
i
].
db
 =Åhªad£t[
j
].db;

610 
thªad£t
[
j
].
db
 = 
ãmp
;

611  
TCL_OK
;

612 
	}
}

621 
	$t˛_thªad_db_gë
(

622 *
NŸU£d
,

623 
T˛_I¡îp
 *
öãΩ
,

624 
¨gc
,

625 c⁄° **
¨gv


627 
i
;

628 
zBuf
[100];

629 
	`sqlôe4Te°MakePoöãrSå
(
T˛_I¡îp
*, *, *);

630 if–
¨gc
!=2 ){

631 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

633  
TCL_ERROR
;

635 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

636 if–
i
<0 )  
TCL_ERROR
;

637 if–!
thªad£t
[
i
].
busy
 ){

638 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

639  
TCL_ERROR
;

641 
	`thªad_waô
(&
thªad£t
[
i
]);

642 
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
thªad£t
[
i
].
db
);

643 
thªad£t
[
i
].
db
 = 0;

644 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, (*)0);

645  
TCL_OK
;

646 
	}
}

652 
	$t˛_thªad_db_put
(

653 *
NŸU£d
,

654 
T˛_I¡îp
 *
öãΩ
,

655 
¨gc
,

656 c⁄° **
¨gv


658 
i
;

659 
	`sqlôe4Te°MakePoöãrSå
(
T˛_I¡îp
*, *, *);

660 *
	`sqlôe4Te°TextToPå
(const *);

661 if–
¨gc
!=3 ){

662 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

664  
TCL_ERROR
;

666 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

667 if–
i
<0 )  
TCL_ERROR
;

668 if–!
thªad£t
[
i
].
busy
 ){

669 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

670  
TCL_ERROR
;

672 
	`thªad_waô
(&
thªad£t
[
i
]);

673 
	`as£π
–!
thªad£t
[
i
].
db
 );

674 
thªad£t
[
i
].
db
 = (
sqlôe4
*)
	`sqlôe4Te°TextToPå
(
¨gv
[2]);

675  
TCL_OK
;

676 
	}
}

684 
	$t˛_thªad_°mt_gë
(

685 *
NŸU£d
,

686 
T˛_I¡îp
 *
öãΩ
,

687 
¨gc
,

688 c⁄° **
¨gv


690 
i
;

691 
zBuf
[100];

692 
	`sqlôe4Te°MakePoöãrSå
(
T˛_I¡îp
*, *, *);

693 if–
¨gc
!=2 ){

694 
	`T˛_AµídResu…
(
öãΩ
, "wr⁄g #árgs: should bê\"", 
¨gv
[0],

696  
TCL_ERROR
;

698 
i
 = 
	`∑r£_thªad_id
(
öãΩ
, 
¨gv
[1]);

699 if–
i
<0 )  
TCL_ERROR
;

700 if–!
thªad£t
[
i
].
busy
 ){

701 
	`T˛_AµídResu…
(
öãΩ
, "no suchÅhread", 0);

702  
TCL_ERROR
;

704 
	`thªad_waô
(&
thªad£t
[
i
]);

705 
	`sqlôe4Te°MakePoöãrSå
(
öãΩ
, 
zBuf
, 
thªad£t
[
i
].
pStmt
);

706 
thªad£t
[
i
].
pStmt
 = 0;

707 
	`T˛_AµídResu…
(
öãΩ
, 
zBuf
, (*)0);

708  
TCL_OK
;

709 
	}
}

714 
	$Sqlôëe°4_Inô
(
T˛_I¡îp
 *
öãΩ
){

716 *
zName
;

717 
T˛_CmdProc
 *
xProc
;

718 } 
aCmd
[] = {

719 { "thªad_¸óã", (
T˛_CmdProc
*)
t˛_thªad_¸óã
 },

720 { "thªad_waô", (
T˛_CmdProc
*)
t˛_thªad_waô
 },

721 { "thªad_hÆt", (
T˛_CmdProc
*)
t˛_thªad_hÆt
 },

722 { "thªad_¨gc", (
T˛_CmdProc
*)
t˛_thªad_¨gc
 },

723 { "thªad_¨gv", (
T˛_CmdProc
*)
t˛_thªad_¨gv
 },

724 { "thªad_cﬁ«me", (
T˛_CmdProc
*)
t˛_thªad_cﬁ«me
 },

725 { "thªad_ªsu…", (
T˛_CmdProc
*)
t˛_thªad_ªsu…
 },

726 { "thªad_îr‹", (
T˛_CmdProc
*)
t˛_thªad_îr‹
 },

727 { "thªad_compûe", (
T˛_CmdProc
*)
t˛_thªad_compûe
 },

728 { "thªad_°ï", (
T˛_CmdProc
*)
t˛_thªad_°ï
 },

729 { "thªad_föÆize", (
T˛_CmdProc
*)
t˛_thªad_föÆize
 },

730 { "thªad_sw≠", (
T˛_CmdProc
*)
t˛_thªad_sw≠
 },

731 { "thªad_db_gë", (
T˛_CmdProc
*)
t˛_thªad_db_gë
 },

732 { "thªad_db_put", (
T˛_CmdProc
*)
t˛_thªad_db_put
 },

733 { "thªad_°mt_gë", (
T˛_CmdProc
*)
t˛_thªad_°mt_gë
 },

735 
i
;

737 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

738 
	`T˛_Cª©eComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xProc
, 0, 0);

740  
TCL_OK
;

741 
	}
}

743 
	$Sqlôëe°4_Inô
(
T˛_I¡îp
 *
öãΩ
){  
TCL_OK
; 
	}
}

	@test/test_utf.c

18 
	~"sqlôeI¡.h
"

19 
	~"vdbeI¡.h
"

20 
	~"t˛.h
"

21 
	~<°dlib.h
>

22 
	~<°rög.h
>

29 
	$bö¨ize
(

30 * 
˛õ¡D©a
,

31 
T˛_I¡îp
 *
öãΩ
,

32 
objc
,

33 
T˛_Obj
 *
CONST
 
objv
[]

35 
Àn
;

36 
bNŸîm
 = 0;

37 *
byãs
;

38 
T˛_Obj
 *
pRë
;

40 if–
objc
!=2 && objc!=3 ){

41 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "?-noterm? STR");

42  
TCL_ERROR
;

44 if–
objc
==3 ){

45 
bNŸîm
 = 1;

48 
byãs
 = 
	`T˛_GëSåögFromObj
(
objv
[
objc
-1], &
Àn
);

49 
pRë
 = 
	`T˛_NewByãAºayObj
((
u8
*)
byãs
, 
Àn
+1-
bNŸîm
);

50 
	`T˛_SëObjResu…
(
öãΩ
, 
pRë
);

51  
TCL_OK
;

52 
	}
}

65 
	$ã°_vÆue_ovîhód
(

66 * 
˛õ¡D©a
,

67 
T˛_I¡îp
 *
öãΩ
,

68 
objc
,

69 
T˛_Obj
 *
CONST
 
objv
[]

71 
do_ˇŒs
;

72 
ª≥©_cou¡
;

73 
i
;

74 
Mem
 
vÆ
;

75 c⁄° *
zVÆ
;

77 if–
objc
!=3 ){

78 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

79 
	`T˛_GëSåögFromObj
(
objv
[0], 0), " <repeat-count> <do-calls>", 0);

80  
TCL_ERROR
;

83 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[1], &
ª≥©_cou¡
ËË 
TCL_ERROR
;

84 if–
	`T˛_GëI¡FromObj
(
öãΩ
, 
objv
[2], &
do_ˇŒs
ËË 
TCL_ERROR
;

86 
vÆ
.
Êags
 = 
MEM_Så
|
MEM_Tîm
|
MEM_Sètic
;

87 
vÆ
.
z
 = "hello world";

88 
vÆ
.
ty≥
 = 
SQLITE4_TEXT
;

89 
vÆ
.
íc
 = 
SQLITE4_UTF8
;

91 
i
=0; i<
ª≥©_cou¡
; i++){

92 if–
do_ˇŒs
 ){

93 
zVÆ
 = 
	`sqlôe4_vÆue_ãxt
(&
vÆ
, 0);

94 
	`UNUSED_PARAMETER
(
zVÆ
);

98  
TCL_OK
;

99 
	}
}

101 
u8
 
	$«me_to_íc
(
T˛_I¡îp
 *
öãΩ
, 
T˛_Obj
 *
pObj
){

102 
	sEncName
 {

103 *
zName
;

104 
u8
 
íc
;

105 } 
í˙ames
[] = {

106 { "UTF8", 
SQLITE4_UTF8
 },

107 { "UTF16LE", 
SQLITE4_UTF16LE
 },

108 { "UTF16BE", 
SQLITE4_UTF16BE
 },

109 { "UTF16", 
SQLITE4_UTF16
 },

112 
EncName
 *
pEnc
;

113 *
z
 = 
	`T˛_GëSåög
(
pObj
);

114 
pEnc
=&
í˙ames
[0];ÖEnc->
zName
;ÖEnc++){

115 if–0==
	`sqlôe4_°ricmp
(
z
, 
pEnc
->
zName
) ){

119 if–!
pEnc
->
íc
 ){

120 
	`T˛_AµídResu…
(
öãΩ
, "NÿsuchÉncodög: ", 
z
, 0);

122 if–
pEnc
->
íc
==
SQLITE4_UTF16
 ){

123  
SQLITE4_UTF16NATIVE
;

125  
pEnc
->
íc
;

126 
	}
}

128 
	$‰ìSå
(*
pEnv
, *
pSå
){

129 
	`sqlôe4_‰ì
((
sqlôe4_ív
*)
pEnv
, 
pSå
);

130 
	}
}

135 
	$ã°_sqlôe4_å™¶©e
(

136 * 
˛õ¡D©a
,

137 
T˛_I¡îp
 *
öãΩ
,

138 
objc
,

139 
T˛_Obj
 *
CONST
 
objv
[]

141 
	sTøn¶©i⁄
 {

142 c⁄° *
zTøns
;

143 
eTøns
;

144 
isUtf8
;

145 } 
aTøns
[] = {

146 { "utf8_utf16", 
SQLITE4_TRANSLATE_UTF8_UTF16
, 1 },

147 { "utf8_utf16À", 
SQLITE4_TRANSLATE_UTF8_UTF16LE
, 1 },

148 { "utf8_utf16be", 
SQLITE4_TRANSLATE_UTF8_UTF16BE
, 1 },

149 { "utf16_utf8", 
SQLITE4_TRANSLATE_UTF16_UTF8
, 0 },

150 { "utf16À_utf8", 
SQLITE4_TRANSLATE_UTF16LE_UTF8
, 0 },

151 { "utf16be_utf8", 
SQLITE4_TRANSLATE_UTF16BE_UTF8
, 0 },

155 
rc
;

156 
iO±
;

158 if–
objc
!=3 ){

159 
	`T˛_Wr⁄gNumArgs
(
öãΩ
, 1, 
objv
, "VALUE TRANSLATION");

160 
rc
 = 
TCL_ERROR
;

162 
rc
 = 
	`T˛_GëIndexFromObjSåu˘
(

163 
öãΩ
, 
objv
[2], 
aTøns
, ◊Tøns[0]), "å™¶©i⁄", 0, &
iO±


167 if–
rc
==
TCL_OK
 ){

168 
sqlôe4_buf„r
 
buf
;

169 *
p
;

170 
n
;

171 
isUtf8
 = 
aTøns
[
iO±
].isUtf8;

172 
eTøns
 = 
aTøns
[
iO±
].eTrans;

174 if–
isUtf8
 ){

175 
p
 = 
	`T˛_GëSåög
(
objv
[1]);

176 
n
 = 
	`°æí
((*)
p
);

178 
p
 = 
	`T˛_GëByãAºayFromObj
(
objv
[1], &
n
);

181 
	`sqlôe4_buf„r_öô
(&
buf
, 0);

182 
	`sqlôe4_å™¶©e
(&
buf
, 
p
, 
n
, 
eTøns
);

183 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewByãAºayObj
(
buf
.
p
, buf.
n
));

184 
	`sqlôe4_buf„r_˛ór
(&
buf
);

187  
rc
;

188 
	}
}

194 
	$ã°_å™¶©e
(

195 * 
˛õ¡D©a
,

196 
T˛_I¡îp
 *
öãΩ
,

197 
objc
,

198 
T˛_Obj
 *
CONST
 
objv
[]

200 
u8
 
íc_‰om
;

201 
u8
 
íc_to
;

202 
sqlôe4_vÆue
 *
pVÆ
;

204 *
z
;

205 
Àn
;

206 (*
xDñ
)(*,*Ë
SQLITE4_STATIC
;

208 if–
objc
!=4 && objc!=5 ){

209 
	`T˛_AµídResu…
(
öãΩ
, "wrong #árgs: should be \"",

210 
	`T˛_GëSåögFromObj
(
objv
[0], 0),

213  
TCL_ERROR
;

215 if–
objc
==5 ){

216 
xDñ
 = 
‰ìSå
;

219 
íc_‰om
 = 
	`«me_to_íc
(
öãΩ
, 
objv
[2]);

220 if–!
íc_‰om
 )  
TCL_ERROR
;

221 
íc_to
 = 
	`«me_to_íc
(
öãΩ
, 
objv
[3]);

222 if–!
íc_to
 )  
TCL_ERROR
;

224 
pVÆ
 = 
	`sqlôe4VÆueNew
(0);

226 if–
íc_‰om
==
SQLITE4_UTF8
 ){

227 
z
 = 
	`T˛_GëSåög
(
objv
[1]);

228 if–
objc
==5 ){

229 
z
 = 
	`sqlôe4_m¥ötf
(0, "%s", z);

231 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
z
, 
íc_‰om
, 
xDñ
, 0);

233 
z
 = (*)
	`T˛_GëByãAºayFromObj
(
objv
[1], &
Àn
);

234 if–
objc
==5 ){

235 *
zTmp
 = 
z
;

236 
z
 = 
	`sqlôe4_mÆloc
(0, 
Àn
);

237 
	`mem˝y
(
z
, 
zTmp
, 
Àn
);

239 
	`sqlôe4VÆueSëSå
(
pVÆ
, -1, 
z
, 
íc_‰om
, 
xDñ
, 0);

242 
z
 = (*)
	`sqlôe4VÆueText
(
pVÆ
, 
íc_to
);

243 
Àn
 = 
	`sqlôe4VÆueByãs
(
pVÆ
, 
íc_to
Ë+ (íc_to==
SQLITE4_UTF8
?1:2);

244 
	`T˛_SëObjResu…
(
öãΩ
, 
	`T˛_NewByãAºayObj
((
u8
*)
z
, 
Àn
));

246 
	`sqlôe4VÆueFªe
(
pVÆ
);

248  
TCL_OK
;

249 
	}
}

257 
sqlôe4UtfSñfTe°
();

258 
	$ã°_å™¶©e_£l·e°
(

259 * 
˛õ¡D©a
,

260 
T˛_I¡îp
 *
öãΩ
,

261 
objc
,

262 
T˛_Obj
 *
CONST
 
objv
[]

264 #i‚de‡
SQLITE4_OMIT_UTF16


265 
	`sqlôe4UtfSñfTe°
();

267  
SQLITE4_OK
;

268 
	}
}

274 
	$Sqlôëe°5_Inô
(
T˛_I¡îp
 *
öãΩ
){

276 *
zName
;

277 
T˛_ObjCmdProc
 *
xProc
;

278 } 
aCmd
[] = {

279 { "bö¨ize", (
T˛_ObjCmdProc
*)
bö¨ize
 },

280 { "ã°_vÆue_ovîhód", (
T˛_ObjCmdProc
*)
ã°_vÆue_ovîhód
 },

281 { "ã°_å™¶©e", (
T˛_ObjCmdProc
*)
ã°_å™¶©e
 },

282 { "sqlôe4_å™¶©e", (
T˛_ObjCmdProc
*)
ã°_sqlôe4_å™¶©e
 },

283 { "å™¶©e_£l·e°", (
T˛_ObjCmdProc
*)
ã°_å™¶©e_£l·e°
},

285 
i
;

286 
i
=0; i<(
aCmd
)/(aCmd[0]); i++){

287 
	`T˛_Cª©eObjComm™d
(
öãΩ
, 
aCmd
[
i
].
zName
,áCmd[i].
xProc
, 0, 0);

289  
SQLITE4_OK
;

290 
	}
}

	@test/test_wsd.c

18 #i‡
deföed
(
SQLITE4_OMIT_WSD
Ë&& deföed(
SQLITE4_TEST
)

20 
	~"sqlôeI¡.h
"

22 
	#PLS_HASHSIZE
 43

	)

24 
Pro˚ssLoˇlSt‹age
 
	tPro˚ssLoˇlSt‹age
;

25 
Pro˚ssLoˇlV¨
 
	tPro˚ssLoˇlV¨
;

27 
	sPro˚ssLoˇlSt‹age
 {

28 
Pro˚ssLoˇlV¨
 *
	maD©a
[
PLS_HASHSIZE
];

29 
	mnFªe
;

30 
u8
 *
	mpFªe
;

33 
	sPro˚ssLoˇlV¨
 {

34 *
	mpKey
;

35 
Pro˚ssLoˇlV¨
 *
	mpNext
;

38 
Pro˚ssLoˇlSt‹age
 *
	gpGlobÆ
 = 0;

40 
	$sqlôe4_wsd_öô
(
N
, 
J
){

41 if–!
pGlobÆ
 ){

42 
nMÆloc
 = 
N
 + (
Pro˚ssLoˇlSt‹age
Ë+ 
J
*(
Pro˚ssLoˇlV¨
);

43 
pGlobÆ
 = (
Pro˚ssLoˇlSt‹age
 *)
	`mÆloc
(
nMÆloc
);

44 if–
pGlobÆ
 ){

45 
	`mem£t
(
pGlobÆ
, 0, (
Pro˚ssLoˇlSt‹age
));

46 
pGlobÆ
->
nFªe
 = 
nMÆloc
 - (
Pro˚ssLoˇlSt‹age
);

47 
pGlobÆ
->
pFªe
 = (
u8
 *)&pGlobal[1];

51  
pGlobÆ
 ? 
SQLITE4_OK
 : 
SQLITE4_NOMEM
;

52 
	}
}

54 *
	$sqlôe4_wsd_föd
(*
K
, 
L
){

55 
i
;

56 
iHash
 = 0;

57 
Pro˚ssLoˇlV¨
 *
pV¨
;

60 
i
=0; i<(*); i++){

61 
iHash
 = (iHash<<3Ë+ ((*)&
K
)[
i
];

63 
iHash
 = iHash%
PLS_HASHSIZE
;

66 
pV¨
=
pGlobÆ
->
aD©a
[
iHash
];ÖV¨ &&ÖV¨->
pKey
!=
K
;ÖV¨ıV¨->
pNext
);

69 if–!
pV¨
 ){

70 
nByã
 = 
	`ROUND8
((
Pro˚ssLoˇlV¨
Ë+ 
L
);

71 
	`as£π
–
pGlobÆ
->
nFªe
>=
nByã
 );

72 
pV¨
 = (
Pro˚ssLoˇlV¨
 *)
pGlobÆ
->
pFªe
;

73 
pV¨
->
pKey
 = 
K
;

74 
pV¨
->
pNext
 = 
pGlobÆ
->
aD©a
[
iHash
];

75 
pGlobÆ
->
aD©a
[
iHash
] = 
pV¨
;

76 
pGlobÆ
->
nFªe
 -
nByã
;

77 
pGlobÆ
->
pFªe
 +
nByã
;

78 
	`mem˝y
(&
pV¨
[1], 
K
, 
L
);

81  (*)&
pV¨
[1];

82 
	}
}

	@test/tt3_checkpoint.c

42 
	#CHECKPOINT_STARVATION_FRAMELIMIT
 50

	)

45 
	#CHECKPOINT_STARVATION_READMS
 100

	)

47 
	sCheckpoötSèrv©i⁄Ctx
 {

48 
	meMode
;

49 
	mnMaxFøme
;

51 
CheckpoötSèrv©i⁄Ctx
 
	tCheckpoötSèrv©i⁄Ctx
;

53 
	$checkpoöt_°¨v©i⁄_wÆhook
(

54 *
pCtx
,

55 
sqlôe4
 *
db
,

56 c⁄° *
zDb
,

57 
nFøme


59 
CheckpoötSèrv©i⁄Ctx
 *
p
 = (CheckpoötSèrv©i⁄Ctx *)
pCtx
;

60 if–
nFøme
>
p
->
nMaxFøme
 ){

61 
p
->
nMaxFøme
 = 
nFøme
;

63 if–
nFøme
>=
CHECKPOINT_STARVATION_FRAMELIMIT
 ){

64 
	`sqlôe4_wÆ_checkpoöt_v2
(
db
, 
zDb
, 
p
->
eMode
, 0, 0);

66  
SQLITE4_OK
;

67 
	}
}

69 *
	$checkpoöt_°¨v©i⁄_ªadî
(
iTid
, 
iArg
){

70 
Eº‹
 
îr
 = {0};

71 
Sqlôe
 
db
 = {0};

73 
	`›ídb
(&
îr
, &
db
, "test.db", 0);

74  !
	`timëo°›
(&
îr
) ){

75 
i64
 
iCou¡1
, 
iCou¡2
;

76 
	`sql_s¸ùt
(&
îr
, &
db
, "BEGIN");

77 
iCou¡1
 = 
	`execsql_i64
(&
îr
, &
db
, "SELECT count(x) FROMÅ1");

78 
	`u¶ìp
(
CHECKPOINT_STARVATION_READMS
*1000);

79 
iCou¡2
 = 
	`execsql_i64
(&
îr
, &
db
, "SELECT count(x) FROMÅ1");

80 
	`sql_s¸ùt
(&
îr
, &
db
, "COMMIT");

82 if–
iCou¡1
!=
iCou¡2
 ){

83 
	`ã°_îr‹
(&
îr
, "Isﬁ©i⁄ faûuª - %Œd %Œd", 
iCou¡1
, 
iCou¡2
);

86 
	`˛o£db
(&
îr
, &
db
);

88 
	`¥öt_™d_‰ì_îr
(&
îr
);

90 
	}
}

92 
	$checkpoöt_°¨v©i⁄_maö
(
nMs
, 
CheckpoötSèrv©i⁄Ctx
 *
p
){

93 
Eº‹
 
îr
 = {0};

94 
Sqlôe
 
db
 = {0};

95 
Thªad£t
 
thªads
 = {0};

96 
nIn£π
 = 0;

97 
i
;

99 
	`›ídb
(&
îr
, &
db
, "test.db", 1);

100 
	`sql_s¸ùt
(&
îr
, &
db
,

106 
	`£t°›time
(&
îr
, 
nMs
);

108 
i
=0; i<4; i++){

109 
	`œunch_thªad
(&
îr
, &
thªads
, 
checkpoöt_°¨v©i⁄_ªadî
, 0);

110 
	`u¶ìp
(
CHECKPOINT_STARVATION_READMS
*1000/4);

113 
	`sqlôe4_wÆ_hook
(
db
.db, 
checkpoöt_°¨v©i⁄_wÆhook
, (*)
p
);

114  !
	`timëo°›
(&
îr
) ){

115 
	`sql_s¸ùt
(&
îr
, &
db
, "INSERT INTOÅ1 VALUES(randomblob(1200))");

116 
nIn£π
++;

119 
	`¥ötf
(" Checkpoint mode : %s\n",

120 
p
->
eMode
==
SQLITE4_CHECKPOINT_PASSIVE
 ? "PASSIVE" : "RESTART"

122 
	`¥ötf
(" Pók WAL : %d fømes\n", 
p
->
nMaxFøme
);

123 
	`¥ötf
(" Tønß˘i⁄ cou¡: %dÅønß˘i⁄s\n", 
nIn£π
);

125 
	`joö_Æl_thªads
(&
îr
, &
thªads
);

126 
	`˛o£db
(&
îr
, &
db
);

127 
	`¥öt_™d_‰ì_îr
(&
îr
);

128 
	}
}

130 
	$checkpoöt_°¨v©i⁄_1
(
nMs
){

131 
Eº‹
 
îr
 = {0};

132 
CheckpoötSèrv©i⁄Ctx
 
˘x
 = { 
SQLITE4_CHECKPOINT_PASSIVE
, 0 };

133 
	`checkpoöt_°¨v©i⁄_maö
(
nMs
, &
˘x
);

134 if–
˘x
.
nMaxFøme
<(
CHECKPOINT_STARVATION_FRAMELIMIT
*10) ){

135 
	`ã°_îr‹
(&
îr
, "WAL faûedÅÿgrow - %d fømes", 
˘x
.
nMaxFøme
);

137 
	`¥öt_™d_‰ì_îr
(&
îr
);

138 
	}
}

140 
	$checkpoöt_°¨v©i⁄_2
(
nMs
){

141 
Eº‹
 
îr
 = {0};

142 
CheckpoötSèrv©i⁄Ctx
 
˘x
 = { 
SQLITE4_CHECKPOINT_RESTART
, 0 };

143 
	`checkpoöt_°¨v©i⁄_maö
(
nMs
, &
˘x
);

144 if–
˘x
.
nMaxFøme
>
CHECKPOINT_STARVATION_FRAMELIMIT
+10 ){

145 
	`ã°_îr‹
(&
îr
, "WAL gªwÅoÿœrgê- %d fømes", 
˘x
.
nMaxFøme
);

147 
	`¥öt_™d_‰ì_îr
(&
îr
);

148 
	}
}

	@test_blob.c

1 
	~"sqlôe4.h
"

2 
	~<°dio.h
>

3 
	~<öây≥s.h
>

5 
	$¥öt_ˇŒback
(

6 *
NŸU£d
,

7 
¨gc
,

8 
sqlôe4_vÆue
 **
¨gv
,

9 c⁄° **
cﬁName


11 
i
;

12 
i
 = 0; i < 
¨gc
; i++) {

13 c⁄° *
vÆ
;

15 i‡(
¨gv
[
i
] == 0) {

16 
vÆ
 = "NULL";

18 
vÆ
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], 
NULL
);

19 i‡(!
vÆ
) val = "(non-text)";

22 
	`¥ötf
("%s=%s\t", 
cﬁName
[
i
], 
vÆ
);

24 
	`¥ötf
("\n");

26 
	}
}

29 
	$maö
(
¨gc
, **
¨gv
) {

30 ()
¨gc
; ()
¨gv
;

32 
sqlôe4
 *
db
 = 0;

33 
rc
 = 0;

35 
rc
 = 
	`sqlôe4_›í
(0, "ã°.db", &
db
);

36 i‡(
rc
) {

37 
	`¥ötf
("›í faûed: %d\n", 
rc
);

40 
	`¥ötf
("Database opened successfully\n");

42 
	`¥ötf
("\n-- creatingÅable --\n");

43 
rc
 = 
	`sqlôe4_exec
(

44 
db
,

48 i‡(
rc
) {

49 
	`¥ötf
("sq»îr‹ (¸óã):Ñc=%d\n", 
rc
);

50 
	`sqlôe4_˛o£
(
db
, 0);

53 
	`¥ötf
("Table created successfully\n");

55 
	`¥ötf
("\n-- creating index --\n");

56 
rc
 = 
	`sqlôe4_exec
(

57 
db
,

61 i‡(
rc
) {

62 
	`¥ötf
("sq»îr‹ (¸óã index):Ñc=%d\n", 
rc
);

63 
	`sqlôe4_˛o£
(
db
, 0);

67 
	`¥ötf
("\n-- createdÅables --\n");

68 
rc
 = 
	`sqlôe4_exec
(

69 
db
,

71 
¥öt_ˇŒback
,

74 i‡(
rc
) {

75 
	`¥ötf
("sq»îr‹ (£À˘ÅabÀs):Ñc=%d\n", 
rc
);

76 
	`sqlôe4_˛o£
(
db
, 0);

80 
	`¥ötf
("\n-- created indexes --\n");

81 
rc
 = 
	`sqlôe4_exec
(

82 
db
,

84 
¥öt_ˇŒback
,

87 i‡(
rc
) {

88 
	`¥ötf
("sq»îr‹ (£À˘ indexes):Ñc=%d\n", 
rc
);

89 
	`sqlôe4_˛o£
(
db
, 0);

93 
	`¥ötf
("\n--Åablesánd indexes SQL--\n");

94 
rc
 = 
	`sqlôe4_exec
(

95 
db
,

97 
¥öt_ˇŒback
,

100 i‡(
rc
) {

101 
	`¥ötf
("sq»îr‹ (¥öàèbÀ†™d indexes):Ñc=%d\n", 
rc
);

102 
	`sqlôe4_˛o£
(
db
, 0);

107 
	`¥ötf
("\n-- inserting data --\n");

108 
rc
 = 
	`sqlôe4_exec
(

109 
db
,

114 i‡(
rc
) {

115 
	`¥ötf
("sq»îr‹ (ö£π d©a):Ñc=%d\n", 
rc
);

116 
	`sqlôe4_˛o£
(
db
, 0);

119 
	`¥ötf
("Data inserted successfully\n");

122 
	`¥ötf
("\n-- selecting data --\n");

123 
rc
 = 
	`sqlôe4_exec
(

124 
db
,

126 
¥öt_ˇŒback
,

129 i‡(
rc
) {

130 
	`¥ötf
("sq»îr‹ (£À˘ d©a):Ñc=%d\n", 
rc
);

131 
	`sqlôe4_˛o£
(
db
, 0);

134 
	`¥ötf
("Data selected successfully\n");

136 
	`sqlôe4_˛o£
(
db
, 0);

138 
	}
}

	@test_libsql.c

1 
	~"sqlôe4.h
"

2 
	~<°dio.h
>

3 
	~<öây≥s.h
>

5 
	$¥öt_ˇŒback
(

6 *
NŸU£d
,

7 
¨gc
,

8 
sqlôe4_vÆue
 **
¨gv
,

9 c⁄° **
cﬁName


11 
i
;

12 
i
 = 0; i < 
¨gc
; i++) {

13 c⁄° *
vÆ
;

15 i‡(
¨gv
[
i
] == 0) {

16 
vÆ
 = "NULL";

18 
vÆ
 = 
	`sqlôe4_vÆue_ãxt
(
¨gv
[
i
], 
NULL
);

19 i‡(!
vÆ
) val = "(non-text)";

22 
	`¥ötf
("%s=%s\t", 
cﬁName
[
i
], 
vÆ
);

24 
	`¥ötf
("\n");

26 
	}
}

29 
	$maö
(
¨gc
, **
¨gv
) {

30 ()
¨gc
; ()
¨gv
;

32 
sqlôe4
 *
db
 = 0;

33 
rc
 = 0;

35 
rc
 = 
	`sqlôe4_›í
(0, "ã°.db", &
db
);

36 i‡(
rc
) {

37 
	`¥ötf
("›í faûed: %d\n", 
rc
);

40 
	`¥ötf
("Database opened successfully\n");

42 
	`¥ötf
("\n-- creatingÅable --\n");

43 
rc
 = 
	`sqlôe4_exec
(

44 
db
,

48 i‡(
rc
) {

49 
	`¥ötf
("sq»îr‹ (¸óã):Ñc=%d\n", 
rc
);

50 
	`sqlôe4_˛o£
(
db
, 0);

53 
	`¥ötf
("Table created successfully\n");

55 
	`¥ötf
("\n-- creating index --\n");

56 
rc
 = 
	`sqlôe4_exec
(

57 
db
,

61 i‡(
rc
) {

62 
	`¥ötf
("sq»îr‹ (¸óã index):Ñc=%d\n", 
rc
);

63 
	`sqlôe4_˛o£
(
db
, 0);

67 
	`¥ötf
("\n-- createdÅables --\n");

68 
rc
 = 
	`sqlôe4_exec
(

69 
db
,

71 
¥öt_ˇŒback
,

74 i‡(
rc
) {

75 
	`¥ötf
("sq»îr‹ (£À˘ÅabÀs):Ñc=%d\n", 
rc
);

76 
	`sqlôe4_˛o£
(
db
, 0);

80 
	`¥ötf
("\n-- created indexes --\n");

81 
rc
 = 
	`sqlôe4_exec
(

82 
db
,

84 
¥öt_ˇŒback
,

87 i‡(
rc
) {

88 
	`¥ötf
("sq»îr‹ (£À˘ indexes):Ñc=%d\n", 
rc
);

89 
	`sqlôe4_˛o£
(
db
, 0);

93 
	`¥ötf
("\n--Åablesánd indexes SQL--\n");

94 
rc
 = 
	`sqlôe4_exec
(

95 
db
,

97 
¥öt_ˇŒback
,

100 i‡(
rc
) {

101 
	`¥ötf
("sq»îr‹ (¥öàèbÀ†™d indexes):Ñc=%d\n", 
rc
);

102 
	`sqlôe4_˛o£
(
db
, 0);

107 
	`¥ötf
("\n-- inserting data --\n");

108 
rc
 = 
	`sqlôe4_exec
(

109 
db
,

114 i‡(
rc
) {

115 
	`¥ötf
("sq»îr‹ (ö£π d©a):Ñc=%d\n", 
rc
);

116 
	`sqlôe4_˛o£
(
db
, 0);

119 
	`¥ötf
("Data inserted successfully\n");

122 
	`¥ötf
("\n-- selecting data --\n");

123 
rc
 = 
	`sqlôe4_exec
(

124 
db
,

126 
¥öt_ˇŒback
,

129 i‡(
rc
) {

130 
	`¥ötf
("sq»îr‹ (£À˘ d©a):Ñc=%d\n", 
rc
);

131 
	`sqlôe4_˛o£
(
db
, 0);

134 
	`¥ötf
("Data selected successfully\n");

136 
	`¥ötf
("\n--Çumber of data fromÅable (x) --\n");

137 
	`sqlôe4_exec
(
db
, "SELECT cou¡(*ËASÇ FROM x;", 
¥öt_ˇŒback
, 0);

138 
	`¥ötf
("\n--Çumber of data from shadowÅable (x_idx_shadow) --\n");

139 
	`sqlôe4_exec
(
db
, "SELECT cou¡(*ËASÇ FROM x_idx_shadow;", 
¥öt_ˇŒback
, 0);

140 
	`¥ötf
("\n--Çumber of data from vector indexÅable (x_idx) --\n");

141 
	`sqlôe4_exec
(
db
, "SELECTÇame, sq»FROM sqlôe_schem®WHEREÇamêLIKE 'x_idx%';", 
¥öt_ˇŒback
, 0);

143 
	`sqlôe4_˛o£
(
db
, 0);

145 
	}
}

	@tool/diffdb.c

4 
	~<°dio.h
>

5 
	~<˘y≥.h
>

6 
	~<sys/ty≥s.h
>

7 
	~<sys/°©.h
>

8 
	~<f˙é.h
>

9 
	~<uni°d.h
>

10 
	~<°dlib.h
>

13 
	#PAGESIZE
 1024

	)

14 
	gdb1
 = -1;

15 
	gdb2
 = -1;

17 
	$maö
(
¨gc
, **
¨gv
){

18 
iPg
;

19 
a1
[
PAGESIZE
], 
a2
[PAGESIZE];

20 if–
¨gc
!=3 ){

21 
	`Ârötf
(
°dîr
,"Ußge: %†FILENAME FILENAME\n", 
¨gv
[0]);

22 
	`exô
(1);

24 
db1
 = 
	`›í
(
¨gv
[1], 
O_RDONLY
);

25 if–
db1
<0 ){

26 
	`Ârötf
(
°dîr
,"%s: c™'à›í %s\n", 
¨gv
[0],árgv[1]);

27 
	`exô
(1);

29 
db2
 = 
	`›í
(
¨gv
[2], 
O_RDONLY
);

30 if–
db2
<0 ){

31 
	`Ârötf
(
°dîr
,"%s: c™'à›í %s\n", 
¨gv
[0],árgv[2]);

32 
	`exô
(1);

34 
iPg
 = 1;

35  
	`ªad
(
db1
, 
a1
, 
PAGESIZE
)==PAGESIZE &&Ñód(
db2
,
a2
,PAGESIZE)==PAGESIZE ){

36 if–
	`memcmp
(
a1
,
a2
,
PAGESIZE
) ){

37 
	`¥ötf
("Pagê%d\n", 
iPg
);

39 
iPg
++;

41 
	`¥ötf
("%dÖage†checked\n", 
iPg
-1);

42 
	`˛o£
(
db1
);

43 
	`˛o£
(
db2
);

44 
	}
}

	@tool/extract.c

10 
	~<°dio.h
>

11 
	~<°dlib.h
>

13 
	$maö
(
¨gc
, **
¨gv
){

14 
FILE
 *
f
;

15 *
zBuf
;

16 
of°
;

17 
n
;

18 
size_t
 
gŸ
;

20 if–
¨gc
!=4 ){

21 
	`Ârötf
(
°dîr
, "Ußge: %†FILENAME OFFSET AMOUNT\n", *
¨gv
);

24 
f
 = 
	`f›í
(
¨gv
[1], "rb");

25 if–
f
==0 ){

26 
	`Ârötf
(
°dîr
, "ˇ¬Ÿ o≥¿\"%s\"\n", 
¨gv
[1]);

29 
of°
 = 
	`©oi
(
¨gv
[2]);

30 
n
 = 
	`©oi
(
¨gv
[3]);

31 
zBuf
 = 
	`mÆloc
–
n
 );

32 if–
zBuf
==0 ){

33 
	`Ârötf
(
°dîr
, "out of memory\n");

36 
	`f£ek
(
f
, 
of°
, 
SEEK_SET
);

37 
gŸ
 = 
	`‰ód
(
zBuf
, 1, 
n
, 
f
);

38 
	`f˛o£
(
f
);

39 if–
gŸ
<
n
 ){

40 
	`Ârötf
(
°dîr
, "gŸ o∆y %d o‡%d byãs\n", 
gŸ
, 
n
);

43 
	`fwrôe
(
zBuf
, 1, 
n
, 
°dout
);

46 
	}
}

	@tool/lemon.c

9 
	~<°dio.h
>

10 
	~<°d¨g.h
>

11 
	~<°rög.h
>

12 
	~<˘y≥.h
>

13 
	~<°dlib.h
>

14 
	~<as£π.h
>

16 #i‚de‡
__WIN32__


17 #i‡
deföed
(
_WIN32
Ë|| deföed(
WIN32
)

18 
	#__WIN32__


	)

22 #ifde‡
__WIN32__


23 #ifde‡
__˝lu•lus


26 
ac˚ss
(c⁄° *
∑th
, 
mode
);

27 #ifde‡
__˝lu•lus


31 
	~<uni°d.h
>

35 
	#PRIVATE


	)

37 #ifde‡
TEST


38 
	#MAXRHS
 5

	)

40 
	#MAXRHS
 1000

	)

43 
	gshowPª˚dí˚C⁄Êi˘
 = 0;

44 *
ms‹t
(*,**,(*)(const *,const *));

51 
	#Àm⁄SåÀn
(
X
Ë(()
	`°æí
(X))

	)

54 
ruÀ
;

55 
Àm⁄
;

56 
a˘i⁄
;

58 
a˘i⁄
 *
	`A˘i⁄_√w
();

59 
a˘i⁄
 *
	`A˘i⁄_s‹t
(action *);

62 
	`FödRuÀPª˚dí˚s
();

63 
	`FödFú°Sës
();

64 
	`FödSèãs
();

65 
	`FödLöks
();

66 
	`FödFﬁlowSës
();

67 
	`FödA˘i⁄s
();

70 
	`C⁄figli°_öô
();

71 
c⁄fig
 *
	`C⁄figli°_add
(
ruÀ
 *, );

72 
c⁄fig
 *
	`C⁄figli°_addbasis
(
ruÀ
 *, );

73 
	`C⁄figli°_˛osuª
(
Àm⁄
 *);

74 
	`C⁄figli°_s‹t
();

75 
	`C⁄figli°_s‹tbasis
();

76 
c⁄fig
 *
	`C⁄figli°_ªtu∫
();

77 
c⁄fig
 *
	`C⁄figli°_basis
();

78 
	`C⁄figli°_ót
(
c⁄fig
 *);

79 
	`C⁄figli°_ª£t
();

82 
	`Eº‹Msg
(const *, ,const *, ...);

85 
	e›ti⁄_ty≥
 { 
OPT_FLAG
=1, 
OPT_INT
, 
OPT_DBL
, 
OPT_STR
,

86 
OPT_FFLAG
, 
OPT_FINT
, 
OPT_FDBL
, 
OPT_FSTR
};

87 
	ss_›ti⁄s
 {

88 
›ti⁄_ty≥
 
ty≥
;

89 c⁄° *
œbñ
;

90 *
¨g
;

91 c⁄° *
mesßge
;

93 
	`O±Inô
(**,
s_›ti⁄s
*,
FILE
*);

94 
	`O±NArgs
();

95 *
	`O±Arg
();

96 
	`O±Eº
();

97 
	`O±Pröt
();

100 
	`P¨£
(
Àm⁄
 *
Àmp
);

103 
∂ök
 *
	`Plök_√w
();

104 
	`Plök_add
(
∂ök
 **, 
c⁄fig
 *);

105 
	`Plök_c›y
(
∂ök
 **, plink *);

106 
	`Plök_dñëe
(
∂ök
 *);

109 
	`Rïröt
(
Àm⁄
 *);

110 
	`Rï‹tOuçut
(
Àm⁄
 *);

111 
	`Rï‹tTabÀ
(
Àm⁄
 *, );

112 
	`Rï‹tHódî
(
Àm⁄
 *);

113 
	`Com¥essTabÀs
(
Àm⁄
 *);

114 
	`Res‹tSèãs
(
Àm⁄
 *);

117 
	`SëSize
();

118 *
	`SëNew
();

119 
	`SëFªe
(*);

120 
	`SëAdd
(*,);

121 
	`SëUni⁄
(*,*);

122 
	#SëFöd
(
X
,
Y
Ë(X[Y]Ë

	)

129 íum {
LEMON_FALSE
=0, 
LEMON_TRUE
} 
	tBoﬁón
;

133 
	esymbﬁ_ty≥
 {

134 
TERMINAL
,

135 
NONTERMINAL
,

136 
MULTITERMINAL


138 
	ee_assoc
 {

139 
LEFT
,

140 
RIGHT
,

141 
NONE
,

142 
UNK


144 
	ssymbﬁ
 {

145 c⁄° *
«me
;

146 
ödex
;

147 
symbﬁ_ty≥
 
ty≥
;

148 
ruÀ
 *rule;

149 
symbﬁ
 *
ÁŒback
;

150 
¥ec
;

151 
e_assoc
 
assoc
;

152 *
fú°£t
;

153 
Boﬁón
 
œmbda
;

154 
u£C¡
;

155 *
de°ru˘‹
;

157 
de°Löío
;

158 *
d©©y≥
;

160 
däum
;

164 
nsubsym
;

165 
symbﬁ
 **
subsym
;

170 
	sruÀ
 {

171 
symbﬁ
 *
lhs
;

172 c⁄° *
lhßlüs
;

173 
lhsSèπ
;

174 
ruÀlöe
;

175 
ƒhs
;

176 
symbﬁ
 **
rhs
;

177 c⁄° **
rhßlüs
;

178 
löe
;

179 c⁄° *
code
;

180 
symbﬁ
 *
¥ecsym
;

181 
ödex
;

182 
Boﬁón
 
ˇnRedu˚
;

183 
ruÀ
 *
√xéhs
;

184 
ruÀ
 *
√xt
;

192 
	ecfg°©us
 {

193 
COMPLETE
,

194 
INCOMPLETE


196 
	sc⁄fig
 {

197 
ruÀ
 *
Ω
;

198 
dŸ
;

199 *
fws
;

200 
∂ök
 *
ÂÕ
;

201 
∂ök
 *
b∂p
;

202 
°©e
 *
°p
;

203 
cfg°©us
 
°©us
;

204 
c⁄fig
 *
√xt
;

205 
c⁄fig
 *
bp
;

208 
	ee_a˘i⁄
 {

209 
SHIFT
,

210 
ACCEPT
,

211 
REDUCE
,

212 
ERROR
,

213 
SSCONFLICT
,

214 
SRCONFLICT
,

215 
RRCONFLICT
,

216 
SH_RESOLVED
,

217 
RD_RESOLVED
,

218 
NOT_USED


222 
	sa˘i⁄
 {

223 
symbﬁ
 *
•
;

224 
e_a˘i⁄
 
ty≥
;

226 
°©e
 *
°p
;

227 
ruÀ
 *
Ω
;

228 } 
x
;

229 
a˘i⁄
 *
√xt
;

230 
a˘i⁄
 *
cﬁlide
;

235 
	s°©e
 {

236 
c⁄fig
 *
bp
;

237 
c⁄fig
 *
cÂ
;

238 
°©íum
;

239 
a˘i⁄
 *
≠
;

240 
nTknA˘
, 
nNtA˘
;

241 
iTknOf°
, 
iNtOf°
;

242 
iDÊt
;

244 
	#NO_OFFSET
 (-2147483647)

	)

249 
	s∂ök
 {

250 
c⁄fig
 *
cÂ
;

251 
∂ök
 *
√xt
;

258 
	sÀm⁄
 {

259 
°©e
 **
s‹ãd
;

260 
ruÀ
 *rule;

261 
n°©e
;

262 
ƒuÀ
;

263 
nsymbﬁ
;

264 
¡îmöÆ
;

265 
symbﬁ
 **
symbﬁs
;

266 
îr‹˙t
;

267 
symbﬁ
 *
îrsym
;

268 
symbﬁ
 *
wûdˇrd
;

269 *
«me
;

270 *
¨g
;

271 *
tokíty≥
;

272 *
v¨ty≥
;

273 *
°¨t
;

274 *
°acksize
;

275 *
ö˛ude
;

276 *
îr‹
;

277 *
ovîÊow
;

278 *
Áûuª
;

279 *
ac˚±
;

280 *
exåacode
;

281 *
tokíde°
;

282 *
v¨de°
;

283 *
fûíame
;

284 *
ouäame
;

285 *
tokí¥efix
;

286 
nc⁄Êi˘
;

287 
èbÀsize
;

288 
basisÊag
;

289 
has_ÁŒback
;

290 
nﬁöíosÊag
;

291 *
¨gv0
;

294 
	#Mem‹yCheck
(
X
) if((X)==0){ \

295 
	`mem‹y_îr‹
(); \

296 
	`mem‹y_îr‹
(); \

297 
	}

	)
}

313 c⁄° *
Såß„
(const *);

315 
Såß„_öô
();

316 
Såß„_ö£π
(const *);

317 c⁄° *
Såß„_föd
(const *);

321 
symbﬁ
 *
Symbﬁ_√w
(const *);

322 
Symbﬁcmµ
(const *, const *);

323 
Symbﬁ_öô
();

324 
Symbﬁ_ö£π
(
symbﬁ
 *, const *);

325 
symbﬁ
 *
Symbﬁ_föd
(const *);

326 
symbﬁ
 *
Symbﬁ_Nth
();

327 
Symbﬁ_cou¡
();

328 
symbﬁ
 **
Symbﬁ_¨øyof
();

332 
C⁄figcmp
(const *, const *);

333 
°©e
 *
Sèã_√w
();

334 
Sèã_öô
();

335 
Sèã_ö£π
(
°©e
 *, 
c⁄fig
 *);

336 
°©e
 *
Sèã_föd
(
c⁄fig
 *);

337 
°©e
 **
Sèã_¨øyof
( );

341 
C⁄figèbÀ_öô
();

342 
C⁄figèbÀ_ö£π
(
c⁄fig
 *);

343 
c⁄fig
 *
C⁄figèbÀ_föd
(config *);

344 
C⁄figèbÀ_˛ór
((*)(
c⁄fig
 *));

352 
a˘i⁄
 *
	$A˘i⁄_√w
(){

353 
a˘i⁄
 *
‰ìli°
 = 0;

354 
a˘i⁄
 *
√wa˘i⁄
;

356 if–
‰ìli°
==0 ){

357 
i
;

358 
amt
 = 100;

359 
‰ìli°
 = (
a˘i⁄
 *)
	`ˇŒoc
(
amt
, (action));

360 if–
‰ìli°
==0 ){

361 
	`Ârötf
(
°dîr
,"UnableÅoállocate memory foráÇewÖarseráction.");

362 
	`exô
(1);

364 
i
=0; i<
amt
-1; i++Ë
‰ìli°
[i].
√xt
 = &freelist[i+1];

365 
‰ìli°
[
amt
-1].
√xt
 = 0;

367 
√wa˘i⁄
 = 
‰ìli°
;

368 
‰ìli°
 = fªñi°->
√xt
;

369  
√wa˘i⁄
;

370 
	}
}

376 
	$a˘i⁄cmp
(

377 
a˘i⁄
 *
≠1
,

378 
a˘i⁄
 *
≠2


380 
rc
;

381 
rc
 = 
≠1
->
•
->
ödex
 - 
≠2
->sp->index;

382 if–
rc
==0 ){

383 
rc
 = ()
≠1
->
ty≥
 - ()
≠2
->type;

385 if–
rc
==0 && 
≠1
->
ty≥
==
REDUCE
 ){

386 
rc
 = 
≠1
->
x
.
Ω
->
ödex
 - 
≠2
->x.rp->index;

388 if–
rc
==0 ){

389 
rc
 = (Ë(
≠2
 - 
≠1
);

391  
rc
;

392 
	}
}

395 
a˘i⁄
 *
	$A˘i⁄_s‹t
(

396 
a˘i⁄
 *
≠


398 
≠
 = (
a˘i⁄
 *)
	`ms‹t
((*Ôp,(**)&≠->
√xt
,

399 ((*)(c⁄° *,c⁄° *))
a˘i⁄cmp
);

400  
≠
;

401 
	}
}

403 
	$A˘i⁄_add
(

404 
a˘i⁄
 **
≠p
,

405 
e_a˘i⁄
 
ty≥
,

406 
symbﬁ
 *
•
,

407 *
¨g


409 
a˘i⁄
 *
√wa˘i⁄
;

410 
√wa˘i⁄
 = 
	`A˘i⁄_√w
();

411 
√wa˘i⁄
->
√xt
 = *
≠p
;

412 *
≠p
 = 
√wa˘i⁄
;

413 
√wa˘i⁄
->
ty≥
 =Åype;

414 
√wa˘i⁄
->
•
 = sp;

415 if–
ty≥
==
SHIFT
 ){

416 
√wa˘i⁄
->
x
.
°p
 = (
°©e
 *)
¨g
;

418 
√wa˘i⁄
->
x
.
Ω
 = (
ruÀ
 *)
¨g
;

420 
	}
}

446 
	slookahód_a˘i⁄
 {

447 
	mlookahód
;

448 
	ma˘i⁄
;

450 
a˘èb
 
	ta˘èb
;

451 
	sa˘èb
 {

452 
	mnA˘i⁄
;

453 
	mnA˘i⁄AŒoc
;

454 
lookahód_a˘i⁄


455 *
	maA˘i⁄
,

456 *
	maLookahód
;

457 
	mmnLookahód
;

458 
	mmnA˘i⁄
;

459 
	mmxLookahód
;

460 
	mnLookahód
;

461 
	mnLookahódAŒoc
;

465 
	#a˘èb_size
(
X
Ë((X)->
nA˘i⁄
)

	)

468 
	#a˘èb_yya˘i⁄
(
X
,
N
Ë((X)->
aA˘i⁄
[N].
a˘i⁄
)

	)

471 
	#a˘èb_yylookahód
(
X
,
N
Ë((X)->
aA˘i⁄
[N].
lookahód
)

	)

474 
	$a˘èb_‰ì
(
a˘èb
 *
p
){

475 
	`‰ì
–
p
->
aA˘i⁄
 );

476 
	`‰ì
–
p
->
aLookahód
 );

477 
	`‰ì
–
p
 );

478 
	}
}

481 
a˘èb
 *
	$a˘èb_Æloc
(){

482 
a˘èb
 *
p
 = (a˘èb *Ë
	`ˇŒoc
( 1, (*p) );

483 if–
p
==0 ){

484 
	`Ârötf
(
°dîr
,"UnableÅoállocate memory foráÇewácttab.");

485 
	`exô
(1);

487 
	`mem£t
(
p
, 0, (*p));

488  
p
;

489 
	}
}

496 
	$a˘èb_a˘i⁄
(
a˘èb
 *
p
, 
lookahód
, 
a˘i⁄
){

497 if–
p
->
nLookahód
>ı->
nLookahódAŒoc
 ){

498 
p
->
nLookahódAŒoc
 += 25;

499 
p
->
aLookahód
 = (
lookahód_a˘i⁄
 *Ë
	`ªÆloc
(Ö->aLookahead,

500 (
p
->
aLookahód
[0])*p->
nLookahódAŒoc
 );

501 if–
p
->
aLookahód
==0 ){

502 
	`Ârötf
(
°dîr
,"malloc failed\n");

503 
	`exô
(1);

506 if–
p
->
nLookahód
==0 ){

507 
p
->
mxLookahód
 = 
lookahód
;

508 
p
->
mnLookahód
 = 
lookahód
;

509 
p
->
mnA˘i⁄
 = 
a˘i⁄
;

511 if–
p
->
mxLookahód
<
lookahód
 )Ö->mxLookahead =Üookahead;

512 if–
p
->
mnLookahód
>
lookahód
 ){

513 
p
->
mnLookahód
 = 
lookahód
;

514 
p
->
mnA˘i⁄
 = 
a˘i⁄
;

517 
p
->
aLookahód
[p->
nLookahód
].
lookahód
 =Üookahead;

518 
p
->
aLookahód
[p->
nLookahód
].
a˘i⁄
 =áction;

519 
p
->
nLookahód
++;

520 
	}
}

529 
	$a˘èb_ö£π
(
a˘èb
 *
p
){

530 
i
, 
j
, 
k
, 
n
;

531 
	`as£π
–
p
->
nLookahód
>0 );

537 
n
 = 
p
->
mxLookahód
 + 1;

538 if–
p
->
nA˘i⁄
 + 
n
 >p->
nA˘i⁄AŒoc
 ){

539 
ﬁdAŒoc
 = 
p
->
nA˘i⁄AŒoc
;

540 
p
->
nA˘i⁄AŒoc
 =Ö->
nA˘i⁄
 + 
n
 +Ö->nActionAlloc + 20;

541 
p
->
aA˘i⁄
 = (
lookahód_a˘i⁄
 *Ë
	`ªÆloc
(Ö->aAction,

542 (
p
->
aA˘i⁄
[0])*p->
nA˘i⁄AŒoc
);

543 if–
p
->
aA˘i⁄
==0 ){

544 
	`Ârötf
(
°dîr
,"malloc failed\n");

545 
	`exô
(1);

547 
i
=
ﬁdAŒoc
; i<
p
->
nA˘i⁄AŒoc
; i++){

548 
p
->
aA˘i⁄
[
i
].
lookahód
 = -1;

549 
p
->
aA˘i⁄
[
i
].
a˘i⁄
 = -1;

559 
i
=
p
->
nA˘i⁄
-1; i>=0; i--){

560 if–
p
->
aA˘i⁄
[
i
].
lookahód
=ı->
mnLookahód
 ){

563 if–
p
->
aA˘i⁄
[
i
].
a˘i⁄
!ı->
mnA˘i⁄
 ) ;

564 
j
=0; j<
p
->
nLookahód
; j++){

565 
k
 = 
p
->
aLookahód
[
j
].
lookahód
 -Ö->
mnLookahód
 + 
i
;

566 if–
k
<0 || k>=
p
->
nA˘i⁄
 ) ;

567 if–
p
->
aLookahód
[
j
].
lookahód
!ı->
aA˘i⁄
[
k
].lookahead ) ;

568 if–
p
->
aLookahód
[
j
].
a˘i⁄
!ı->
aA˘i⁄
[
k
].action ) ;

570 if–
j
<
p
->
nLookahód
 ) ;

574 
n
 = 0;

575 
j
=0; j<
p
->
nA˘i⁄
; j++){

576 if–
p
->
aA˘i⁄
[
j
].
lookahód
<0 ) ;

577 if–
p
->
aA˘i⁄
[
j
].
lookahód
==j+p->
mnLookahód
-
i
 ) 
n
++;

579 if–
n
==
p
->
nLookahód
 ){

589 if–
i
<0 ){

594 
i
=0; i<
p
->
nA˘i⁄AŒoc
 -Ö->
mxLookahód
; i++){

595 if–
p
->
aA˘i⁄
[
i
].
lookahód
<0 ){

596 
j
=0; j<
p
->
nLookahód
; j++){

597 
k
 = 
p
->
aLookahód
[
j
].
lookahód
 -Ö->
mnLookahód
 + 
i
;

598 if–
k
<0 ) ;

599 if–
p
->
aA˘i⁄
[
k
].
lookahód
>=0 ) ;

601 if–
j
<
p
->
nLookahód
 ) ;

602 
j
=0; j<
p
->
nA˘i⁄
; j++){

603 if–
p
->
aA˘i⁄
[
j
].
lookahód
==j+p->
mnLookahód
-
i
 ) ;

605 if–
j
==
p
->
nA˘i⁄
 ){

612 
j
=0; j<
p
->
nLookahód
; j++){

613 
k
 = 
p
->
aLookahód
[
j
].
lookahód
 -Ö->
mnLookahód
 + 
i
;

614 
p
->
aA˘i⁄
[
k
] =Ö->
aLookahód
[
j
];

615 if–
k
>=
p
->
nA˘i⁄
 )Ö->nAction = k+1;

617 
p
->
nLookahód
 = 0;

621  
i
 - 
p
->
mnLookahód
;

622 
	}
}

639 
	$FödRuÀPª˚dí˚s
(
Àm⁄
 *
xp
)

641 
ruÀ
 *
Ω
;

642 
Ω
=
xp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

643 if–
Ω
->
¥ecsym
==0 ){

644 
i
, 
j
;

645 
i
=0; i<
Ω
->
ƒhs
 &&Ñp->
¥ecsym
==0; i++){

646 
symbﬁ
 *
•
 = 
Ω
->
rhs
[
i
];

647 if–
•
->
ty≥
==
MULTITERMINAL
 ){

648 
j
=0; j<
•
->
nsubsym
; j++){

649 if–
•
->
subsym
[
j
]->
¥ec
>=0 ){

650 
Ω
->
¥ecsym
 = 
•
->
subsym
[
j
];

654 }if–
•
->
¥ec
>=0 ){

655 
Ω
->
¥ecsym
 =Ñp->
rhs
[
i
];

661 
	}
}

668 
	$FödFú°Sës
(
Àm⁄
 *
Àmp
)

670 
i
, 
j
;

671 
ruÀ
 *
Ω
;

672 
¥ogªss
;

674 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

675 
Àmp
->
symbﬁs
[
i
]->
œmbda
 = 
LEMON_FALSE
;

677 
i
=
Àmp
->
¡îmöÆ
; i<Àmp->
nsymbﬁ
; i++){

678 
Àmp
->
symbﬁs
[
i
]->
fú°£t
 = 
	`SëNew
();

683 
¥ogªss
 = 0;

684 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

685 if–
Ω
->
lhs
->
œmbda
 ) ;

686 
i
=0; i<
Ω
->
ƒhs
; i++){

687 
symbﬁ
 *
•
 = 
Ω
->
rhs
[
i
];

688 
	`as£π
–
•
->
ty≥
==
NONTERMINAL
 || sp->
œmbda
==
LEMON_FALSE
 );

689 if–
•
->
œmbda
==
LEMON_FALSE
 ) ;

691 if–
i
==
Ω
->
ƒhs
 ){

692 
Ω
->
lhs
->
œmbda
 = 
LEMON_TRUE
;

693 
¥ogªss
 = 1;

696 } 
¥ogªss
 );

700 
symbﬁ
 *
s1
, *
s2
;

701 
¥ogªss
 = 0;

702 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

703 
s1
 = 
Ω
->
lhs
;

704 
i
=0; i<
Ω
->
ƒhs
; i++){

705 
s2
 = 
Ω
->
rhs
[
i
];

706 if–
s2
->
ty≥
==
TERMINAL
 ){

707 
¥ogªss
 +
	`SëAdd
(
s1
->
fú°£t
,
s2
->
ödex
);

709 }if–
s2
->
ty≥
==
MULTITERMINAL
 ){

710 
j
=0; j<
s2
->
nsubsym
; j++){

711 
¥ogªss
 +
	`SëAdd
(
s1
->
fú°£t
,
s2
->
subsym
[
j
]->
ödex
);

714 }if–
s1
==
s2
 ){

715 if–
s1
->
œmbda
==
LEMON_FALSE
 ) ;

717 
¥ogªss
 +
	`SëUni⁄
(
s1
->
fú°£t
,
s2
->firstset);

718 if–
s2
->
œmbda
==
LEMON_FALSE
 ) ;

722 } 
¥ogªss
 );

724 
	}
}

730 
PRIVATE
 
°©e
 *
gë°©e
(
Àm⁄
 *);

731 
	$FödSèãs
(
Àm⁄
 *
Àmp
)

733 
symbﬁ
 *
•
;

734 
ruÀ
 *
Ω
;

736 
	`C⁄figli°_öô
();

739 if–
Àmp
->
°¨t
 ){

740 
•
 = 
	`Symbﬁ_föd
(
Àmp
->
°¨t
);

741 if–
•
==0 ){

742 
	`Eº‹Msg
(
Àmp
->
fûíame
,0,

743 "Thê•ecifõd sèπ symbﬁ \"%s\" i†nŸ \
áÇ⁄ãrmöÆ o‡thêgømm¨. \"%s\" wû»bêu£dá†thê°¨à\
 in°ód.",
Àmp
->
°¨t
,Àmp->
ruÀ
->
lhs
->
«me
);

746 
Àmp
->
îr‹˙t
++;

747 
•
 = 
Àmp
->
ruÀ
->
lhs
;

750 
•
 = 
Àmp
->
ruÀ
->
lhs
;

756 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

757 
i
;

758 
i
=0; i<
Ω
->
ƒhs
; i++){

759 if–
Ω
->
rhs
[
i
]==
•
 ){

760 
	`Eº‹Msg
(
Àmp
->
fûíame
,0,

761 "Thê°¨àsymbﬁ \"%s\" occur†⁄Åhê\
-h™d sidêo‡®ruÀ. Thi†wû»ªsu… i¿®∑r£∏which \
ÇŸ w‹kÖr›îly.",
•
->
«me
);

764 
Àmp
->
îr‹˙t
++;

772 
Ω
=
•
->
ruÀ
;Ñp;ÑpÙp->
√xéhs
){

773 
c⁄fig
 *
√wcÂ
;

774 
Ω
->
lhsSèπ
 = 1;

775 
√wcÂ
 = 
	`C⁄figli°_addbasis
(
Ω
,0);

776 
	`SëAdd
(
√wcÂ
->
fws
,0);

782 ()
	`gë°©e
(
Àmp
);

784 
	}
}

789 
PRIVATE
 
buûdshi·s
(
Àm⁄
 *, 
°©e
 *);

790 
PRIVATE
 
°©e
 *
	$gë°©e
(
Àm⁄
 *
Àmp
)

792 
c⁄fig
 *
cÂ
, *
bp
;

793 
°©e
 *
°p
;

797 
	`C⁄figli°_s‹tbasis
();

798 
bp
 = 
	`C⁄figli°_basis
();

801 
°p
 = 
	`Sèã_föd
(
bp
);

802 if–
°p
 ){

806 
c⁄fig
 *
x
, *
y
;

807 
x
=
bp
, 
y
=
°p
->bp; x && y; x=x->bp, y=y->bp){

808 
	`Plök_c›y
(&
y
->
b∂p
,
x
->bplp);

809 
	`Plök_dñëe
(
x
->
ÂÕ
);

810 
x
->
ÂÕ
 = x->
b∂p
 = 0;

812 
cÂ
 = 
	`C⁄figli°_ªtu∫
();

813 
	`C⁄figli°_ót
(
cÂ
);

816 
	`C⁄figli°_˛osuª
(
Àmp
);

817 
	`C⁄figli°_s‹t
();

818 
cÂ
 = 
	`C⁄figli°_ªtu∫
();

819 
°p
 = 
	`Sèã_√w
();

820 
	`Mem‹yCheck
(
°p
);

821 
°p
->
bp
 = bp;

822 
°p
->
cÂ
 = cfp;

823 
°p
->
°©íum
 = 
Àmp
->
n°©e
++;

824 
°p
->
≠
 = 0;

825 
	`Sèã_ö£π
(
°p
,°p->
bp
);

826 
	`buûdshi·s
(
Àmp
,
°p
);

828  
°p
;

829 
	}
}

834 
	$ßme_symbﬁ
(
symbﬁ
 *
a
, symbﬁ *
b
)

836 
i
;

837 if–
a
==
b
 )  1;

838 if–
a
->
ty≥
!=
MULTITERMINAL
 )  0;

839 if–
b
->
ty≥
!=
MULTITERMINAL
 )  0;

840 if–
a
->
nsubsym
!=
b
->nsubsym )  0;

841 
i
=0; i<
a
->
nsubsym
; i++){

842 if–
a
->
subsym
[
i
]!=
b
->subsym[i] )  0;

845 
	}
}

850 
PRIVATE
 
	$buûdshi·s
(
Àm⁄
 *
Àmp
, 
°©e
 *
°p
)

852 
c⁄fig
 *
cÂ
;

853 
c⁄fig
 *
bcÂ
;

854 
c⁄fig
 *
√wcfg
;

855 
symbﬁ
 *
•
;

856 
symbﬁ
 *
b•
;

857 
°©e
 *
√w°p
;

861 
cÂ
=
°p
->cÂ; cÂ; cÂ=cÂ->
√xt
ËcÂ->
°©us
 = 
INCOMPLETE
;

864 
cÂ
=
°p
->cÂ; cÂ; cÂ=cÂ->
√xt
){

865 if–
cÂ
->
°©us
==
COMPLETE
 ) ;

866 if–
cÂ
->
dŸ
>=cÂ->
Ω
->
ƒhs
 ) ;

867 
	`C⁄figli°_ª£t
();

868 
•
 = 
cÂ
->
Ω
->
rhs
[cÂ->
dŸ
];

873 
bcÂ
=
cÂ
; bcÂ; bcÂ=bcÂ->
√xt
){

874 if–
bcÂ
->
°©us
==
COMPLETE
 ) ;

875 if–
bcÂ
->
dŸ
>=bcÂ->
Ω
->
ƒhs
 ) ;

876 
b•
 = 
bcÂ
->
Ω
->
rhs
[bcÂ->
dŸ
];

877 if–!
	`ßme_symbﬁ
(
b•
,
•
) ) ;

878 
bcÂ
->
°©us
 = 
COMPLETE
;

879 
√wcfg
 = 
	`C⁄figli°_addbasis
(
bcÂ
->
Ω
,bcÂ->
dŸ
+1);

880 
	`Plök_add
(&
√wcfg
->
b∂p
,
bcÂ
);

885 
√w°p
 = 
	`gë°©e
(
Àmp
);

889 if–
•
->
ty≥
==
MULTITERMINAL
 ){

890 
i
;

891 
i
=0; i<
•
->
nsubsym
; i++){

892 
	`A˘i⁄_add
(&
°p
->
≠
,
SHIFT
,
•
->
subsym
[
i
],(*)
√w°p
);

895 
	`A˘i⁄_add
(&
°p
->
≠
,
SHIFT
,
•
,(*)
√w°p
);

898 
	}
}

903 
	$FödLöks
(
Àm⁄
 *
Àmp
)

905 
i
;

906 
c⁄fig
 *
cÂ
, *
Ÿhî
;

907 
°©e
 *
°p
;

908 
∂ök
 *
∂p
;

913 
i
=0; i<
Àmp
->
n°©e
; i++){

914 
°p
 = 
Àmp
->
s‹ãd
[
i
];

915 
cÂ
=
°p
->cÂ; cÂ; cÂ=cÂ->
√xt
){

916 
cÂ
->
°p
 = stp;

922 
i
=0; i<
Àmp
->
n°©e
; i++){

923 
°p
 = 
Àmp
->
s‹ãd
[
i
];

924 
cÂ
=
°p
->cÂ; cÂ; cÂ=cÂ->
√xt
){

925 
∂p
=
cÂ
->
b∂p
;ÖÕ;ÖÕıÕ->
√xt
){

926 
Ÿhî
 = 
∂p
->
cÂ
;

927 
	`Plök_add
(&
Ÿhî
->
ÂÕ
,
cÂ
);

931 
	}
}

938 
	$FödFﬁlowSës
(
Àm⁄
 *
Àmp
)

940 
i
;

941 
c⁄fig
 *
cÂ
;

942 
∂ök
 *
∂p
;

943 
¥ogªss
;

944 
ch™ge
;

946 
i
=0; i<
Àmp
->
n°©e
; i++){

947 
cÂ
=
Àmp
->
s‹ãd
[
i
]->cÂ; cÂ; cÂ=cÂ->
√xt
){

948 
cÂ
->
°©us
 = 
INCOMPLETE
;

953 
¥ogªss
 = 0;

954 
i
=0; i<
Àmp
->
n°©e
; i++){

955 
cÂ
=
Àmp
->
s‹ãd
[
i
]->cÂ; cÂ; cÂ=cÂ->
√xt
){

956 if–
cÂ
->
°©us
==
COMPLETE
 ) ;

957 
∂p
=
cÂ
->
ÂÕ
;ÖÕ;ÖÕıÕ->
√xt
){

958 
ch™ge
 = 
	`SëUni⁄
(
∂p
->
cÂ
->
fws
,cfp->fws);

959 if–
ch™ge
 ){

960 
∂p
->
cÂ
->
°©us
 = 
INCOMPLETE
;

961 
¥ogªss
 = 1;

964 
cÂ
->
°©us
 = 
COMPLETE
;

967 } 
¥ogªss
 );

968 
	}
}

970 
ªsﬁve_c⁄Êi˘
(
a˘i⁄
 *,action *);

974 
	$FödA˘i⁄s
(
Àm⁄
 *
Àmp
)

976 
i
,
j
;

977 
c⁄fig
 *
cÂ
;

978 
°©e
 *
°p
;

979 
symbﬁ
 *
•
;

980 
ruÀ
 *
Ω
;

986 
i
=0; i<
Àmp
->
n°©e
; i++){

987 
°p
 = 
Àmp
->
s‹ãd
[
i
];

988 
cÂ
=
°p
->cÂ; cÂ; cÂ=cÂ->
√xt
){

989 if–
cÂ
->
Ω
->
ƒhs
==cÂ->
dŸ
 ){

990 
j
=0; j<
Àmp
->
¡îmöÆ
; j++){

991 if–
	`SëFöd
(
cÂ
->
fws
,
j
) ){

994 
	`A˘i⁄_add
(&
°p
->
≠
,
REDUCE
,
Àmp
->
symbﬁs
[
j
],(*)
cÂ
->
Ω
);

1002 if–
Àmp
->
°¨t
 ){

1003 
•
 = 
	`Symbﬁ_föd
(
Àmp
->
°¨t
);

1004 if–
•
==0 ) s∞
Àmp
->
ruÀ
->
lhs
;

1006 
•
 = 
Àmp
->
ruÀ
->
lhs
;

1011 
	`A˘i⁄_add
(&
Àmp
->
s‹ãd
[0]->
≠
,
ACCEPT
,
•
,0);

1014 
i
=0; i<
Àmp
->
n°©e
; i++){

1015 
a˘i⁄
 *
≠
, *
«p
;

1016 
°©e
 *
°p
;

1017 
°p
 = 
Àmp
->
s‹ãd
[
i
];

1019 
°p
->
≠
 = 
	`A˘i⁄_s‹t
(stp->ap);

1020 
≠
=
°p
->≠;á∞&&áp->
√xt
;áp=ap->next){

1021 
«p
=
≠
->
√xt
;Ç≠ &&Ç≠->
•
==ap->sp;Çap=nap->next){

1024 
Àmp
->
nc⁄Êi˘
 +
	`ªsﬁve_c⁄Êi˘
(
≠
,
«p
);

1030 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
ËΩ->
ˇnRedu˚
 = 
LEMON_FALSE
;

1031 
i
=0; i<
Àmp
->
n°©e
; i++){

1032 
a˘i⁄
 *
≠
;

1033 
≠
=
Àmp
->
s‹ãd
[
i
]->≠;áp;áp˜p->
√xt
){

1034 if–
≠
->
ty≥
==
REDUCE
 )áp->
x
.
Ω
->
ˇnRedu˚
 = 
LEMON_TRUE
;

1037 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

1038 if–
Ω
->
ˇnRedu˚
 ) ;

1039 
	`Eº‹Msg
(
Àmp
->
fûíame
,
Ω
->
ruÀlöe
,"ThisÑule canÇot beÑeduced.\n");

1040 
Àmp
->
îr‹˙t
++;

1042 
	}
}

1057 
	$ªsﬁve_c⁄Êi˘
(

1058 
a˘i⁄
 *
≠x
,

1059 
a˘i⁄
 *
≠y


1061 
symbﬁ
 *
•x
, *
•y
;

1062 
îr˙t
 = 0;

1063 
	`as£π
–
≠x
->
•
==
≠y
->sp );

1064 if–
≠x
->
ty≥
==
SHIFT
 && 
≠y
->type==SHIFT ){

1065 
≠y
->
ty≥
 = 
SSCONFLICT
;

1066 
îr˙t
++;

1068 if–
≠x
->
ty≥
==
SHIFT
 && 
≠y
->ty≥==
REDUCE
 ){

1069 
•x
 = 
≠x
->
•
;

1070 
•y
 = 
≠y
->
x
.
Ω
->
¥ecsym
;

1071 if–
•y
==0 || 
•x
->
¥ec
<0 || spy->prec<0 ){

1073 
≠y
->
ty≥
 = 
SRCONFLICT
;

1074 
îr˙t
++;

1075 }if–
•x
->
¥ec
>
•y
->prec ){

1076 
≠y
->
ty≥
 = 
RD_RESOLVED
;

1077 }if–
•x
->
¥ec
<
•y
->prec ){

1078 
≠x
->
ty≥
 = 
SH_RESOLVED
;

1079 }if–
•x
->
¥ec
==
•y
->¥e¯&& spx->
assoc
==
RIGHT
 ){

1080 
≠y
->
ty≥
 = 
RD_RESOLVED
;

1081 }if–
•x
->
¥ec
==
•y
->¥e¯&& spx->
assoc
==
LEFT
 ){

1082 
≠x
->
ty≥
 = 
SH_RESOLVED
;

1084 
	`as£π
–
•x
->
¥ec
==
•y
->¥e¯&& spx->
assoc
==
NONE
 );

1085 
≠y
->
ty≥
 = 
SRCONFLICT
;

1086 
îr˙t
++;

1088 }if–
≠x
->
ty≥
==
REDUCE
 && 
≠y
->type==REDUCE ){

1089 
•x
 = 
≠x
->
x
.
Ω
->
¥ecsym
;

1090 
•y
 = 
≠y
->
x
.
Ω
->
¥ecsym
;

1091 if–
•x
==0 || 
•y
==0 || spx->
¥ec
<0 ||

1092 
•y
->
¥ec
<0 || 
•x
->prec==spy->prec ){

1093 
≠y
->
ty≥
 = 
RRCONFLICT
;

1094 
îr˙t
++;

1095 }if–
•x
->
¥ec
>
•y
->prec ){

1096 
≠y
->
ty≥
 = 
RD_RESOLVED
;

1097 }if–
•x
->
¥ec
<
•y
->prec ){

1098 
≠x
->
ty≥
 = 
RD_RESOLVED
;

1101 
	`as£π
(

1102 
≠x
->
ty≥
==
SH_RESOLVED
 ||

1103 
≠x
->
ty≥
==
RD_RESOLVED
 ||

1104 
≠x
->
ty≥
==
SSCONFLICT
 ||

1105 
≠x
->
ty≥
==
SRCONFLICT
 ||

1106 
≠x
->
ty≥
==
RRCONFLICT
 ||

1107 
≠y
->
ty≥
==
SH_RESOLVED
 ||

1108 
≠y
->
ty≥
==
RD_RESOLVED
 ||

1109 
≠y
->
ty≥
==
SSCONFLICT
 ||

1110 
≠y
->
ty≥
==
SRCONFLICT
 ||

1111 
≠y
->
ty≥
==
RRCONFLICT


1117  
îr˙t
;

1118 
	}
}

1125 
c⁄fig
 *
	g‰ìli°
 = 0;

1126 
c⁄fig
 *
	gcuºít
 = 0;

1127 
c⁄fig
 **
	gcuºíãnd
 = 0;

1128 
c⁄fig
 *
	gbasis
 = 0;

1129 
c⁄fig
 **
	gbasi£nd
 = 0;

1132 
PRIVATE
 
c⁄fig
 *
	$√wc⁄fig
(){

1133 
c⁄fig
 *
√wcfg
;

1134 if–
‰ìli°
==0 ){

1135 
i
;

1136 
amt
 = 3;

1137 
‰ìli°
 = (
c⁄fig
 *)
	`ˇŒoc
–
amt
, (config) );

1138 if–
‰ìli°
==0 ){

1139 
	`Ârötf
(
°dîr
,"UnableÅoállocate memory foráÇew configuration.");

1140 
	`exô
(1);

1142 
i
=0; i<
amt
-1; i++Ë
‰ìli°
[i].
√xt
 = &freelist[i+1];

1143 
‰ìli°
[
amt
-1].
√xt
 = 0;

1145 
√wcfg
 = 
‰ìli°
;

1146 
‰ìli°
 = fªñi°->
√xt
;

1147  
√wcfg
;

1148 
	}
}

1151 
PRIVATE
 
	$dñëec⁄fig
(
c⁄fig
 *
ﬁd
)

1153 
ﬁd
->
√xt
 = 
‰ìli°
;

1154 
‰ìli°
 = 
ﬁd
;

1155 
	}
}

1158 
	$C⁄figli°_öô
(){

1159 
cuºít
 = 0;

1160 
cuºíãnd
 = &
cuºít
;

1161 
basis
 = 0;

1162 
basi£nd
 = &
basis
;

1163 
	`C⁄figèbÀ_öô
();

1165 
	}
}

1168 
	$C⁄figli°_ª£t
(){

1169 
cuºít
 = 0;

1170 
cuºíãnd
 = &
cuºít
;

1171 
basis
 = 0;

1172 
basi£nd
 = &
basis
;

1173 
	`C⁄figèbÀ_˛ór
(0);

1175 
	}
}

1178 
c⁄fig
 *
	$C⁄figli°_add
(

1179 
ruÀ
 *
Ω
,

1180 
dŸ


1182 
c⁄fig
 *
cÂ
, 
modñ
;

1184 
	`as£π
–
cuºíãnd
!=0 );

1185 
modñ
.
Ω
 =Ñp;

1186 
modñ
.
dŸ
 = dot;

1187 
cÂ
 = 
	`C⁄figèbÀ_föd
(&
modñ
);

1188 if–
cÂ
==0 ){

1189 
cÂ
 = 
	`√wc⁄fig
();

1190 
cÂ
->
Ω
 =Ñp;

1191 
cÂ
->
dŸ
 = dot;

1192 
cÂ
->
fws
 = 
	`SëNew
();

1193 
cÂ
->
°p
 = 0;

1194 
cÂ
->
ÂÕ
 = cÂ->
b∂p
 = 0;

1195 
cÂ
->
√xt
 = 0;

1196 
cÂ
->
bp
 = 0;

1197 *
cuºíãnd
 = 
cÂ
;

1198 
cuºíãnd
 = &
cÂ
->
√xt
;

1199 
	`C⁄figèbÀ_ö£π
(
cÂ
);

1201  
cÂ
;

1202 
	}
}

1205 
c⁄fig
 *
	$C⁄figli°_addbasis
(
ruÀ
 *
Ω
, 
dŸ
)

1207 
c⁄fig
 *
cÂ
, 
modñ
;

1209 
	`as£π
–
basi£nd
!=0 );

1210 
	`as£π
–
cuºíãnd
!=0 );

1211 
modñ
.
Ω
 =Ñp;

1212 
modñ
.
dŸ
 = dot;

1213 
cÂ
 = 
	`C⁄figèbÀ_föd
(&
modñ
);

1214 if–
cÂ
==0 ){

1215 
cÂ
 = 
	`√wc⁄fig
();

1216 
cÂ
->
Ω
 =Ñp;

1217 
cÂ
->
dŸ
 = dot;

1218 
cÂ
->
fws
 = 
	`SëNew
();

1219 
cÂ
->
°p
 = 0;

1220 
cÂ
->
ÂÕ
 = cÂ->
b∂p
 = 0;

1221 
cÂ
->
√xt
 = 0;

1222 
cÂ
->
bp
 = 0;

1223 *
cuºíãnd
 = 
cÂ
;

1224 
cuºíãnd
 = &
cÂ
->
√xt
;

1225 *
basi£nd
 = 
cÂ
;

1226 
basi£nd
 = &
cÂ
->
bp
;

1227 
	`C⁄figèbÀ_ö£π
(
cÂ
);

1229  
cÂ
;

1230 
	}
}

1233 
	$C⁄figli°_˛osuª
(
Àm⁄
 *
Àmp
)

1235 
c⁄fig
 *
cÂ
, *
√wcÂ
;

1236 
ruÀ
 *
Ω
, *
√wΩ
;

1237 
symbﬁ
 *
•
, *
x•
;

1238 
i
, 
dŸ
;

1240 
	`as£π
–
cuºíãnd
!=0 );

1241 
cÂ
=
cuºít
; cÂ; cÂ=cÂ->
√xt
){

1242 
Ω
 = 
cÂ
->rp;

1243 
dŸ
 = 
cÂ
->dot;

1244 if–
dŸ
>=
Ω
->
ƒhs
 ) ;

1245 
•
 = 
Ω
->
rhs
[
dŸ
];

1246 if–
•
->
ty≥
==
NONTERMINAL
 ){

1247 if–
•
->
ruÀ
==0 && sp!=
Àmp
->
îrsym
 ){

1248 
	`Eº‹Msg
(
Àmp
->
fûíame
,
Ω
->
löe
,"Nonterminal \"%s\" hasÇoÑules.",

1249 
•
->
«me
);

1250 
Àmp
->
îr‹˙t
++;

1252 
√wΩ
=
•
->
ruÀ
;ÇewΩ;ÇewΩÚewΩ->
√xéhs
){

1253 
√wcÂ
 = 
	`C⁄figli°_add
(
√wΩ
,0);

1254 
i
=
dŸ
+1; i<
Ω
->
ƒhs
; i++){

1255 
x•
 = 
Ω
->
rhs
[
i
];

1256 if–
x•
->
ty≥
==
TERMINAL
 ){

1257 
	`SëAdd
(
√wcÂ
->
fws
,
x•
->
ödex
);

1259 }if–
x•
->
ty≥
==
MULTITERMINAL
 ){

1260 
k
;

1261 
k
=0; k<
x•
->
nsubsym
; k++){

1262 
	`SëAdd
(
√wcÂ
->
fws
, 
x•
->
subsym
[
k
]->
ödex
);

1266 
	`SëUni⁄
(
√wcÂ
->
fws
,
x•
->
fú°£t
);

1267 if–
x•
->
œmbda
==
LEMON_FALSE
 ) ;

1270 if–
i
==
Ω
->
ƒhs
 ) 
	`Plök_add
(&
cÂ
->
ÂÕ
,
√wcÂ
);

1275 
	}
}

1278 
	$C⁄figli°_s‹t
(){

1279 
cuºít
 = (
c⁄fig
 *)
	`ms‹t
((*)cuºít,(**)&(cuºít->
√xt
),
C⁄figcmp
);

1280 
cuºíãnd
 = 0;

1282 
	}
}

1285 
	$C⁄figli°_s‹tbasis
(){

1286 
basis
 = (
c⁄fig
 *)
	`ms‹t
((*)
cuºít
,(**)&(cuºít->
bp
),
C⁄figcmp
);

1287 
basi£nd
 = 0;

1289 
	}
}

1293 
c⁄fig
 *
	$C⁄figli°_ªtu∫
(){

1294 
c⁄fig
 *
ﬁd
;

1295 
ﬁd
 = 
cuºít
;

1296 
cuºít
 = 0;

1297 
cuºíãnd
 = 0;

1298  
ﬁd
;

1299 
	}
}

1303 
c⁄fig
 *
	$C⁄figli°_basis
(){

1304 
c⁄fig
 *
ﬁd
;

1305 
ﬁd
 = 
basis
;

1306 
basis
 = 0;

1307 
basi£nd
 = 0;

1308  
ﬁd
;

1309 
	}
}

1312 
	$C⁄figli°_ót
(
c⁄fig
 *
cÂ
)

1314 
c⁄fig
 *
√xtcÂ
;

1315 ; 
cÂ
; cÂ=
√xtcÂ
){

1316 
√xtcÂ
 = 
cÂ
->
√xt
;

1317 
	`as£π
–
cÂ
->
ÂÕ
==0 );

1318 
	`as£π
–
cÂ
->
b∂p
==0 );

1319 if–
cÂ
->
fws
 ) 
	`SëFªe
(cfp->fws);

1320 
	`dñëec⁄fig
(
cÂ
);

1323 
	}
}

1329 
	$Eº‹Msg
(c⁄° *
fûíame
, 
löío
, c⁄° *
f‹m©
, ...){

1330 
va_li°
 
≠
;

1331 
	`Ârötf
(
°dîr
, "%s:%d: ", 
fûíame
, 
löío
);

1332 
	`va_°¨t
(
≠
, 
f‹m©
);

1333 
	`vÂrötf
(
°dîr
,
f‹m©
,
≠
);

1334 
	`va_íd
(
≠
);

1335 
	`Ârötf
(
°dîr
, "\n");

1336 
	}
}

1345 
	$mem‹y_îr‹
(){

1346 
	`Ârötf
(
°dîr
,"Out of memory. Aborting...\n");

1347 
	`exô
(1);

1348 
	}
}

1350 
	gnDeföe
 = 0;

1351 **
	gazDeföe
 = 0;

1356 
	$h™dÀ_D_›ti⁄
(*
z
){

1357 **
∑z
;

1358 
nDeföe
++;

1359 
azDeföe
 = (**Ë
	`ªÆloc
◊zDeföe, ◊zDeföe[0])*
nDeföe
);

1360 if–
azDeföe
==0 ){

1361 
	`Ârötf
(
°dîr
,"out of memory\n");

1362 
	`exô
(1);

1364 
∑z
 = &
azDeföe
[
nDeföe
-1];

1365 *
∑z
 = (*Ë
	`mÆloc
–
	`Àm⁄SåÀn
(
z
)+1 );

1366 if–*
∑z
==0 ){

1367 
	`Ârötf
(
°dîr
,"out of memory\n");

1368 
	`exô
(1);

1370 
	`°r˝y
(*
∑z
, 
z
);

1371 
z
=*
∑z
; *z && *z!='='; z++){}

1372 *
z
 = 0;

1373 
	}
}

1375 *
	gu£r_ãm∂©íame
 = 
NULL
;

1376 
	$h™dÀ_T_›ti⁄
(*
z
){

1377 
u£r_ãm∂©íame
 = (*Ë
	`mÆloc
–
	`Àm⁄SåÀn
(
z
)+1 );

1378 if–
u£r_ãm∂©íame
==0 ){

1379 
	`mem‹y_îr‹
();

1381 
	`°r˝y
(
u£r_ãm∂©íame
, 
z
);

1382 
	}
}

1385 
	$maö
(
¨gc
, **
¨gv
)

1387 
vîsi⁄
 = 0;

1388 
ΩÊag
 = 0;

1389 
basisÊag
 = 0;

1390 
com¥ess
 = 0;

1391 
quõt
 = 0;

1392 
°©i°ics
 = 0;

1393 
mhÊag
 = 0;

1394 
nﬁöíosÊag
 = 0;

1395 
noRes‹t
 = 0;

1396 
s_›ti⁄s
 
›ti⁄s
[] = {

1397 {
OPT_FLAG
, "b", (*)&
basisÊag
, "Print onlyÅhe basis inÑeport."},

1398 {
OPT_FLAG
, "c", (*)&
com¥ess
, "Don't compressÅheáctionÅable."},

1399 {
OPT_FSTR
, "D", (*)
h™dÀ_D_›ti⁄
, "Defineán %ifdef macro."},

1400 {
OPT_FSTR
, "T", (*)
h™dÀ_T_›ti⁄
, "SpecifyáÅemplate file."},

1401 {
OPT_FLAG
, "g", (*)&
ΩÊag
, "Print grammar withoutáctions."},

1402 {
OPT_FLAG
, "m", (*)&
mhÊag
, "Outputá makeheaders compatible file."},

1403 {
OPT_FLAG
, "l", (*)&
nﬁöíosÊag
, "DoÇotÖrint #line statements."},

1404 {
OPT_FLAG
, "p", (*)&
showPª˚dí˚C⁄Êi˘
,

1406 {
OPT_FLAG
, "q", (*)&
quõt
, "(Quiet) Don'tÖrintÅheÑeport file."},

1407 {
OPT_FLAG
, "r", (*)&
noRes‹t
, "DoÇot sort orÑenumber states"},

1408 {
OPT_FLAG
, "s", (*)&
°©i°ics
,

1410 {
OPT_FLAG
, "x", (*)&
vîsi⁄
, "PrintÅhe versionÇumber."},

1411 {
OPT_FLAG
,0,0,0}

1413 
i
;

1414 
exôcode
;

1415 
Àm⁄
 
Àm
;

1417 
	`O±Inô
(
¨gv
,
›ti⁄s
,
°dîr
);

1418 if–
vîsi⁄
 ){

1419 
	`¥ötf
("Lemon version 1.0\n");

1420 
	`exô
(0);

1422 if–
	`O±NArgs
()!=1 ){

1423 
	`Ârötf
(
°dîr
,"Exactly one filenameárgument isÑequired.\n");

1424 
	`exô
(1);

1426 
	`mem£t
(&
Àm
, 0, (lem));

1427 
Àm
.
îr‹˙t
 = 0;

1430 
	`Såß„_öô
();

1431 
	`Symbﬁ_öô
();

1432 
	`Sèã_öô
();

1433 
Àm
.
¨gv0
 = 
¨gv
[0];

1434 
Àm
.
fûíame
 = 
	`O±Arg
(0);

1435 
Àm
.
basisÊag
 = basisflag;

1436 
Àm
.
nﬁöíosÊag
 =Çolinenosflag;

1437 
	`Symbﬁ_√w
("$");

1438 
Àm
.
îrsym
 = 
	`Symbﬁ_√w
("error");

1439 
Àm
.
îrsym
->
u£C¡
 = 0;

1442 
	`P¨£
(&
Àm
);

1443 if–
Àm
.
îr‹˙t
 ) 
	`exô
(lem.errorcnt);

1444 if–
Àm
.
ƒuÀ
==0 ){

1445 
	`Ârötf
(
°dîr
,"Empty grammar.\n");

1446 
	`exô
(1);

1450 
Àm
.
nsymbﬁ
 = 
	`Symbﬁ_cou¡
();

1451 
	`Symbﬁ_√w
("{default}");

1452 
Àm
.
symbﬁs
 = 
	`Symbﬁ_¨øyof
();

1453 
i
=0; i<=
Àm
.
nsymbﬁ
; i++ËÀm.
symbﬁs
[i]->
ödex
 = i;

1454 
	`qs‹t
(
Àm
.
symbﬁs
,Àm.
nsymbﬁ
+1,(
symbﬁ
*), 
Symbﬁcmµ
);

1455 
i
=0; i<=
Àm
.
nsymbﬁ
; i++ËÀm.
symbﬁs
[i]->
ödex
 = i;

1456 
i
=1; 
	`isuµî
(
Àm
.
symbﬁs
[i]->
«me
[0]); i++);

1457 
Àm
.
¡îmöÆ
 = 
i
;

1460 if–
ΩÊag
 ){

1461 
	`Rïröt
(&
Àm
);

1464 
	`SëSize
(
Àm
.
¡îmöÆ
+1);

1467 
	`FödRuÀPª˚dí˚s
(&
Àm
);

1471 
	`FödFú°Sës
(&
Àm
);

1475 
Àm
.
n°©e
 = 0;

1476 
	`FödSèãs
(&
Àm
);

1477 
Àm
.
s‹ãd
 = 
	`Sèã_¨øyof
();

1480 
	`FödLöks
(&
Àm
);

1483 
	`FödFﬁlowSës
(&
Àm
);

1486 
	`FödA˘i⁄s
(&
Àm
);

1489 if–
com¥ess
==0 ) 
	`Com¥essTabÀs
(&
Àm
);

1494 if–
noRes‹t
==0 ) 
	`Res‹tSèãs
(&
Àm
);

1497 if–!
quõt
 ) 
	`Rï‹tOuçut
(&
Àm
);

1500 
	`Rï‹tTabÀ
(&
Àm
, 
mhÊag
);

1505 if–!
mhÊag
 ) 
	`Rï‹tHódî
(&
Àm
);

1507 if–
°©i°ics
 ){

1508 
	`¥ötf
("Parser statistics: %dÅerminals, %dÇonterminals, %dÑules\n",

1509 
Àm
.
¡îmöÆ
,Üem.
nsymbﬁ
 -Üem.¡îmöÆ,Üem.
ƒuÀ
);

1510 
	`¥ötf
(" %d states, %dÖarserÅableÉntries, %d conflicts\n",

1511 
Àm
.
n°©e
,Üem.
èbÀsize
,Üem.
nc⁄Êi˘
);

1513 if–
Àm
.
nc⁄Êi˘
 > 0 ){

1514 
	`Ârötf
(
°dîr
,"%dÖ¨sög c⁄Êi˘s.\n",
Àm
.
nc⁄Êi˘
);

1518 
exôcode
 = ((
Àm
.
îr‹˙t
 > 0Ë|| (Àm.
nc⁄Êi˘
 > 0)) ? 1 : 0;

1519 
	`exô
(
exôcode
);

1520  (
exôcode
);

1521 
	}
}

1549 
	#NEXT
(
A
Ë(*(**)((()A)+
off£t
))

	)

1566 *
mîge
(

1567 *
a
,

1568 *
b
,

1569 (*
cmp
)(const *,const *),

1570 
off£t


1572 *
±r
, *
hód
;

1574 if–
a
==0 ){

1575 
hód
 = 
b
;

1576 }if–
b
==0 ){

1577 
hód
 = 
a
;

1579 if–(*
cmp
)(
a
,
b
)<=0 ){

1580 
±r
 = 
a
;

1581 
a
 = 
	`NEXT
(a);

1583 
±r
 = 
b
;

1584 
b
 = 
	`NEXT
(b);

1586 
hód
 = 
±r
;

1587  
a
 && 
b
 ){

1588 if–(*
cmp
)(
a
,
b
)<=0 ){

1589 
	`NEXT
(
±r
Ë
a
;

1590 
±r
 = 
a
;

1591 
a
 = 
	`NEXT
(a);

1593 
	`NEXT
(
±r
Ë
b
;

1594 
±r
 = 
b
;

1595 
b
 = 
	`NEXT
(b);

1598 if–
a
 ) 
	`NEXT
(
±r
) =á;

1599 
	`NEXT
(
±r
Ë
b
;

1601  
hód
;

1602 
	}
}

1617 
	#LISTSIZE
 30

	)

1618 *
ms‹t
(

1619 *
li°
,

1620 **
√xt
,

1621 (*
cmp
)(const *,const *)

1623 
off£t
;

1624 *
ï
;

1625 *
£t
[
LISTSIZE
];

1626 
i
;

1627 
off£t
 = ()
√xt
 - ()
li°
;

1628 
i
=0; i<
LISTSIZE
; i++Ë
£t
[i] = 0;

1629  
li°
 ){

1630 
ï
 = 
li°
;

1631 
li°
 = 
	`NEXT
(list);

1632 
	`NEXT
(
ï
) = 0;

1633 
i
=0; i<
LISTSIZE
-1 && 
£t
[i]!=0; i++){

1634 
ï
 = 
	`mîge
”p,
£t
[
i
],
cmp
,
off£t
);

1635 
£t
[
i
] = 0;

1637 
£t
[
i
] = 
ï
;

1639 
ï
 = 0;

1640 
i
=0; i<
LISTSIZE
; i++Ëif–
£t
[i] ) 
ï
 = 
	`mîge
(£t[i],ï,
cmp
,
off£t
);

1641  
ï
;

1642 
	}
}

1644 **
	g¨gv
;

1645 
s_›ti⁄s
 *
	g›
;

1646 
FILE
 *
	gîr°ªam
;

1648 
	#ISOPT
(
X
Ë((X)[0]=='-'||(X)[0]=='+'||
	`°rchr
((X),'=')!=0)

	)

1654 
	$îæöe
(
n
, 
k
, 
FILE
 *
îr
)

1656 
•˙t
, 
i
;

1657 if–
¨gv
[0] ) 
	`Ârötf
(
îr
,"%s",argv[0]);

1658 
•˙t
 = 
	`Àm⁄SåÀn
(
¨gv
[0]) + 1;

1659 
i
=1; i<
n
 && 
¨gv
[i]; i++){

1660 
	`Ârötf
(
îr
," %s",
¨gv
[
i
]);

1661 
•˙t
 +
	`Àm⁄SåÀn
(
¨gv
[
i
])+1;

1663 
•˙t
 +
k
;

1664 ; 
¨gv
[
i
]; i++Ë
	`Ârötf
(
îr
," %s",argv[i]);

1665 if–
•˙t
<20 ){

1666 
	`Ârötf
(
îr
,"\n%*s^-- hîe\n",
•˙t
,"");

1668 
	`Ârötf
(
îr
,"\n%*shîê--^\n",
•˙t
-7,"");

1670 
	}
}

1676 
	$¨gödex
(
n
)

1678 
i
;

1679 
dashdash
 = 0;

1680 if–
¨gv
!=0 && *argv!=0 ){

1681 
i
=1; 
¨gv
[i]; i++){

1682 if–
dashdash
 || !
	`ISOPT
(
¨gv
[
i
]) ){

1683 if–
n
==0 )  
i
;

1684 
n
--;

1686 if–
	`°rcmp
(
¨gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1690 
	}
}

1692 
	gemsg
[] = "CommandÜine syntaxÉrror: ";

1697 
	$h™dÀÊags
(
i
, 
FILE
 *
îr
)

1699 
v
;

1700 
îr˙t
 = 0;

1701 
j
;

1702 
j
=0; 
›
[j].
œbñ
; j++){

1703 if–
	`°∫cmp
(&
¨gv
[
i
][1],
›
[
j
].
œbñ
,
	`Àm⁄SåÀn
(op[j].label))==0 ) ;

1705 
v
 = 
¨gv
[
i
][0]=='-' ? 1 : 0;

1706 if–
›
[
j
].
œbñ
==0 ){

1707 if–
îr
 ){

1708 
	`Ârötf
(
îr
,"%sundeföed o±i⁄.\n",
emsg
);

1709 
	`îæöe
(
i
,1,
îr
);

1711 
îr˙t
++;

1712 }if–
›
[
j
].
ty≥
==
OPT_FLAG
 ){

1713 *((*)
›
[
j
].
¨g
Ë
v
;

1714 }if–
›
[
j
].
ty≥
==
OPT_FFLAG
 ){

1715 (*((*)())(
›
[
j
].
¨g
))(
v
);

1716 }if–
›
[
j
].
ty≥
==
OPT_FSTR
 ){

1717 (*((*)(*))(
›
[
j
].
¨g
))(&
¨gv
[
i
][2]);

1719 if–
îr
 ){

1720 
	`Ârötf
(
îr
,"%smissögárgumíà⁄ swôch.\n",
emsg
);

1721 
	`îæöe
(
i
,1,
îr
);

1723 
îr˙t
++;

1725  
îr˙t
;

1726 
	}
}

1731 
	$h™dÀswôch
(
i
, 
FILE
 *
îr
)

1733 
lv
 = 0;

1734 
dv
 = 0.0;

1735 *
sv
 = 0, *
íd
;

1736 *
˝
;

1737 
j
;

1738 
îr˙t
 = 0;

1739 
˝
 = 
	`°rchr
(
¨gv
[
i
],'=');

1740 
	`as£π
–
˝
!=0 );

1741 *
˝
 = 0;

1742 
j
=0; 
›
[j].
œbñ
; j++){

1743 if–
	`°rcmp
(
¨gv
[
i
],
›
[
j
].
œbñ
)==0 ) ;

1745 *
˝
 = '=';

1746 if–
›
[
j
].
œbñ
==0 ){

1747 if–
îr
 ){

1748 
	`Ârötf
(
îr
,"%sundeföed o±i⁄.\n",
emsg
);

1749 
	`îæöe
(
i
,0,
îr
);

1751 
îr˙t
++;

1753 
˝
++;

1754  
›
[
j
].
ty≥
 ){

1755 
OPT_FLAG
:

1756 
OPT_FFLAG
:

1757 if–
îr
 ){

1758 
	`Ârötf
(
îr
,"%s›ti⁄Ñequúe†™árgumít.\n",
emsg
);

1759 
	`îæöe
(
i
,0,
îr
);

1761 
îr˙t
++;

1763 
OPT_DBL
:

1764 
OPT_FDBL
:

1765 
dv
 = 
	`°πod
(
˝
,&
íd
);

1766 if–*
íd
 ){

1767 if–
îr
 ){

1768 
	`Ârötf
(
îr
,"%sûÀgÆ ch¨a˘î i¿Êﬂtög-poöà¨gumít.\n",
emsg
);

1769 
	`îæöe
(
i
,(()
íd
)-()
¨gv
[i],
îr
);

1771 
îr˙t
++;

1774 
OPT_INT
:

1775 
OPT_FINT
:

1776 
lv
 = 
	`°πﬁ
(
˝
,&
íd
,0);

1777 if–*
íd
 ){

1778 if–
îr
 ){

1779 
	`Ârötf
(
îr
,"%sûÀgÆ ch¨a˘î i¿öãgîárgumít.\n",
emsg
);

1780 
	`îæöe
(
i
,(()
íd
)-()
¨gv
[i],
îr
);

1782 
îr˙t
++;

1785 
OPT_STR
:

1786 
OPT_FSTR
:

1787 
sv
 = 
˝
;

1790  
›
[
j
].
ty≥
 ){

1791 
OPT_FLAG
:

1792 
OPT_FFLAG
:

1794 
OPT_DBL
:

1795 *(*)(
›
[
j
].
¨g
Ë
dv
;

1797 
OPT_FDBL
:

1798 (*((*)())(
›
[
j
].
¨g
))(
dv
);

1800 
OPT_INT
:

1801 *(*)(
›
[
j
].
¨g
Ë
lv
;

1803 
OPT_FINT
:

1804 (*((*)())(
›
[
j
].
¨g
))(()
lv
);

1806 
OPT_STR
:

1807 *(**)(
›
[
j
].
¨g
Ë
sv
;

1809 
OPT_FSTR
:

1810 (*((*)(*))(
›
[
j
].
¨g
))(
sv
);

1814  
îr˙t
;

1815 
	}
}

1817 
	$O±Inô
(**
a
, 
s_›ti⁄s
 *
o
, 
FILE
 *
îr
)

1819 
îr˙t
 = 0;

1820 
¨gv
 = 
a
;

1821 
›
 = 
o
;

1822 
îr°ªam
 = 
îr
;

1823 if–
¨gv
 && *¨gv && 
›
 ){

1824 
i
;

1825 
i
=1; 
¨gv
[i]; i++){

1826 if–
¨gv
[
i
][0]=='+' ||árgv[i][0]=='-' ){

1827 
îr˙t
 +
	`h™dÀÊags
(
i
,
îr
);

1828 }if–
	`°rchr
(
¨gv
[
i
],'=') ){

1829 
îr˙t
 +
	`h™dÀswôch
(
i
,
îr
);

1833 if–
îr˙t
>0 ){

1834 
	`Ârötf
(
îr
,"VÆid comm™dÜöê›ti⁄†f‹ \"%s\"áª:\n",*
a
);

1835 
	`O±Pröt
();

1836 
	`exô
(1);

1839 
	}
}

1841 
	$O±NArgs
(){

1842 
˙t
 = 0;

1843 
dashdash
 = 0;

1844 
i
;

1845 if–
¨gv
!=0 &&árgv[0]!=0 ){

1846 
i
=1; 
¨gv
[i]; i++){

1847 if–
dashdash
 || !
	`ISOPT
(
¨gv
[
i
]ËË
˙t
++;

1848 if–
	`°rcmp
(
¨gv
[
i
],"--")==0 ) 
dashdash
 = 1;

1851  
˙t
;

1852 
	}
}

1854 *
	$O±Arg
(
n
)

1856 
i
;

1857 
i
 = 
	`¨gödex
(
n
);

1858  
i
>=0 ? 
¨gv
[i] : 0;

1859 
	}
}

1861 
	$O±Eº
(
n
)

1863 
i
;

1864 
i
 = 
	`¨gödex
(
n
);

1865 if–
i
>=0 ) 
	`îæöe
(i,0,
îr°ªam
);

1866 
	}
}

1868 
	$O±Pröt
(){

1869 
i
;

1870 
max
, 
Àn
;

1871 
max
 = 0;

1872 
i
=0; 
›
[i].
œbñ
; i++){

1873 
Àn
 = 
	`Àm⁄SåÀn
(
›
[
i
].
œbñ
) + 1;

1874  
›
[
i
].
ty≥
 ){

1875 
OPT_FLAG
:

1876 
OPT_FFLAG
:

1878 
OPT_INT
:

1879 
OPT_FINT
:

1880 
Àn
 += 9;

1882 
OPT_DBL
:

1883 
OPT_FDBL
:

1884 
Àn
 += 6;

1886 
OPT_STR
:

1887 
OPT_FSTR
:

1888 
Àn
 += 8;

1891 if–
Àn
>
max
 ) max =Üen;

1893 
i
=0; 
›
[i].
œbñ
; i++){

1894  
›
[
i
].
ty≥
 ){

1895 
OPT_FLAG
:

1896 
OPT_FFLAG
:

1897 
	`Ârötf
(
îr°ªam
," -%-*† %s\n",
max
,
›
[
i
].
œbñ
,›[i].
mesßge
);

1899 
OPT_INT
:

1900 
OPT_FINT
:

1901 
	`Ârötf
(
îr°ªam
," %s=<öãgî>%*† %s\n",
›
[
i
].
œbñ
,

1902 ()(
max
-
	`Àm⁄SåÀn
(
›
[
i
].
œbñ
)-9),"",›[i].
mesßge
);

1904 
OPT_DBL
:

1905 
OPT_FDBL
:

1906 
	`Ârötf
(
îr°ªam
," %s=<ªÆ>%*† %s\n",
›
[
i
].
œbñ
,

1907 ()(
max
-
	`Àm⁄SåÀn
(
›
[
i
].
œbñ
)-6),"",›[i].
mesßge
);

1909 
OPT_STR
:

1910 
OPT_FSTR
:

1911 
	`Ârötf
(
îr°ªam
," %s=<°rög>%*† %s\n",
›
[
i
].
œbñ
,

1912 ()(
max
-
	`Àm⁄SåÀn
(
›
[
i
].
œbñ
)-8),"",›[i].
mesßge
);

1916 
	}
}

1923 
	ee_°©e
 {

1924 
	mINITIALIZE
,

1925 
	mWAITING_FOR_DECL_OR_RULE
,

1926 
	mWAITING_FOR_DECL_KEYWORD
,

1927 
	mWAITING_FOR_DECL_ARG
,

1928 
	mWAITING_FOR_PRECEDENCE_SYMBOL
,

1929 
	mWAITING_FOR_ARROW
,

1930 
	mIN_RHS
,

1931 
	mLHS_ALIAS_1
,

1932 
	mLHS_ALIAS_2
,

1933 
	mLHS_ALIAS_3
,

1934 
	mRHS_ALIAS_1
,

1935 
	mRHS_ALIAS_2
,

1936 
	mPRECEDENCE_MARK_1
,

1937 
	mPRECEDENCE_MARK_2
,

1938 
	mRESYNC_AFTER_RULE_ERROR
,

1939 
	mRESYNC_AFTER_DECL_ERROR
,

1940 
	mWAITING_FOR_DESTRUCTOR_SYMBOL
,

1941 
	mWAITING_FOR_DATATYPE_SYMBOL
,

1942 
	mWAITING_FOR_FALLBACK_ID
,

1943 
	mWAITING_FOR_WILDCARD_ID


1945 
	sp°©e
 {

1946 *
	mfûíame
;

1947 
	mtokílöío
;

1948 
	mîr‹˙t
;

1949 *
	mtokí°¨t
;

1950 
Àm⁄
 *
	mgp
;

1951 
e_°©e
 
	m°©e
;

1952 
symbﬁ
 *
	mÁŒback
;

1953 
symbﬁ
 *
	mlhs
;

1954 c⁄° *
	mlhßlüs
;

1955 
	mƒhs
;

1956 
symbﬁ
 *
	mrhs
[
MAXRHS
];

1957 c⁄° *
	mÆüs
[
MAXRHS
];

1958 
ruÀ
 *
	m¥evruÀ
;

1959 c⁄° *
	mde˛keyw‹d
;

1960 **
	mde˛¨g¶Ÿ
;

1961 
	mö£πLöeMa¸o
;

1962 *
	mde˛löío¶Ÿ
;

1963 
e_assoc
 
	mde˛assoc
;

1964 
	m¥eccou¡î
;

1965 
ruÀ
 *
	mfú°ruÀ
;

1966 
ruÀ
 *
	mœ°ruÀ
;

1970 
	$∑r£⁄ëokí
(
p°©e
 *
p•
)

1972 c⁄° *
x
;

1973 
x
 = 
	`Såß„
(
p•
->
tokí°¨t
);

1975 
	`¥ötf
("%s:%d: Tokí=[%s] sèã=%d\n",
p•
->
fûíame
,p•->
tokílöío
,

1976 
x
,
p•
->
°©e
);

1978  
p•
->
°©e
 ){

1979 
INITIALIZE
:

1980 
p•
->
¥evruÀ
 = 0;

1981 
p•
->
¥eccou¡î
 = 0;

1982 
p•
->
fú°ruÀ
 =Ö•->
œ°ruÀ
 = 0;

1983 
p•
->
gp
->
ƒuÀ
 = 0;

1985 
WAITING_FOR_DECL_OR_RULE
:

1986 if–
x
[0]=='%' ){

1987 
p•
->
°©e
 = 
WAITING_FOR_DECL_KEYWORD
;

1988 }if–
	`i¶owî
(
x
[0]) ){

1989 
p•
->
lhs
 = 
	`Symbﬁ_√w
(
x
);

1990 
p•
->
ƒhs
 = 0;

1991 
p•
->
lhßlüs
 = 0;

1992 
p•
->
°©e
 = 
WAITING_FOR_ARROW
;

1993 }if–
x
[0]=='{' ){

1994 if–
p•
->
¥evruÀ
==0 ){

1995 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

1998 
p•
->
îr‹˙t
++;

1999 }if–
p•
->
¥evruÀ
->
code
!=0 ){

2000 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2003 
p•
->
îr‹˙t
++;

2005 
p•
->
¥evruÀ
->
löe
 =Ö•->
tokílöío
;

2006 
p•
->
¥evruÀ
->
code
 = &
x
[1];

2008 }if–
x
[0]=='[' ){

2009 
p•
->
°©e
 = 
PRECEDENCE_MARK_1
;

2011 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2013 
x
);

2014 
p•
->
îr‹˙t
++;

2017 
PRECEDENCE_MARK_1
:

2018 if–!
	`isuµî
(
x
[0]) ){

2019 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2021 
p•
->
îr‹˙t
++;

2022 }if–
p•
->
¥evruÀ
==0 ){

2023 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2024 "Thîêi†nÿ¥i‹ÑuÀÅÿassig¿¥e˚dí˚ \"[%s]\".",
x
);

2025 
p•
->
îr‹˙t
++;

2026 }if–
p•
->
¥evruÀ
->
¥ecsym
!=0 ){

2027 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2030 
p•
->
îr‹˙t
++;

2032 
p•
->
¥evruÀ
->
¥ecsym
 = 
	`Symbﬁ_√w
(
x
);

2034 
p•
->
°©e
 = 
PRECEDENCE_MARK_2
;

2036 
PRECEDENCE_MARK_2
:

2037 if–
x
[0]!=']' ){

2038 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2040 
p•
->
îr‹˙t
++;

2042 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2044 
WAITING_FOR_ARROW
:

2045 if–
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2046 
p•
->
°©e
 = 
IN_RHS
;

2047 }if–
x
[0]=='(' ){

2048 
p•
->
°©e
 = 
LHS_ALIAS_1
;

2050 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2052 
p•
->
lhs
->
«me
);

2053 
p•
->
îr‹˙t
++;

2054 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2057 
LHS_ALIAS_1
:

2058 if–
	`ißÕha
(
x
[0]) ){

2059 
p•
->
lhßlüs
 = 
x
;

2060 
p•
->
°©e
 = 
LHS_ALIAS_2
;

2062 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2064 
x
,
p•
->
lhs
->
«me
);

2065 
p•
->
îr‹˙t
++;

2066 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2069 
LHS_ALIAS_2
:

2070 if–
x
[0]==')' ){

2071 
p•
->
°©e
 = 
LHS_ALIAS_3
;

2073 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2074 "Missög \")\" fﬁlowög LHSálü†«mê\"%s\".",
p•
->
lhßlüs
);

2075 
p•
->
îr‹˙t
++;

2076 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2079 
LHS_ALIAS_3
:

2080 if–
x
[0]==':' && x[1]==':' && x[2]=='=' ){

2081 
p•
->
°©e
 = 
IN_RHS
;

2083 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2085 
p•
->
lhs
->
«me
,p•->
lhßlüs
);

2086 
p•
->
îr‹˙t
++;

2087 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2090 
IN_RHS
:

2091 if–
x
[0]=='.' ){

2092 
ruÀ
 *
Ω
;

2093 
Ω
 = (
ruÀ
 *)
	`ˇŒoc
( (rule) +

2094 (
symbﬁ
*)*
p•
->
ƒhs
 + (*)*psp->nrhs, 1);

2095 if–
Ω
==0 ){

2096 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2098 
p•
->
îr‹˙t
++;

2099 
p•
->
¥evruÀ
 = 0;

2101 
i
;

2102 
Ω
->
ruÀlöe
 = 
p•
->
tokílöío
;

2103 
Ω
->
rhs
 = (
symbﬁ
**)&rp[1];

2104 
Ω
->
rhßlüs
 = (c⁄° **)&‘p->
rhs
[
p•
->
ƒhs
]);

2105 
i
=0; i<
p•
->
ƒhs
; i++){

2106 
Ω
->
rhs
[
i
] = 
p•
->rhs[i];

2107 
Ω
->
rhßlüs
[
i
] = 
p•
->
Æüs
[i];

2109 
Ω
->
lhs
 = 
p•
->lhs;

2110 
Ω
->
lhßlüs
 = 
p•
->lhsalias;

2111 
Ω
->
ƒhs
 = 
p•
->nrhs;

2112 
Ω
->
code
 = 0;

2113 
Ω
->
¥ecsym
 = 0;

2114 
Ω
->
ödex
 = 
p•
->
gp
->
ƒuÀ
++;

2115 
Ω
->
√xéhs
 =Ñp->
lhs
->
ruÀ
;

2116 
Ω
->
lhs
->
ruÀ
 =Ñp;

2117 
Ω
->
√xt
 = 0;

2118 if–
p•
->
fú°ruÀ
==0 ){

2119 
p•
->
fú°ruÀ
 =Ö•->
œ°ruÀ
 = 
Ω
;

2121 
p•
->
œ°ruÀ
->
√xt
 = 
Ω
;

2122 
p•
->
œ°ruÀ
 = 
Ω
;

2124 
p•
->
¥evruÀ
 = 
Ω
;

2126 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2127 }if–
	`ißÕha
(
x
[0]) ){

2128 if–
p•
->
ƒhs
>=
MAXRHS
 ){

2129 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2131 
x
);

2132 
p•
->
îr‹˙t
++;

2133 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2135 
p•
->
rhs
[p•->
ƒhs
] = 
	`Symbﬁ_√w
(
x
);

2136 
p•
->
Æüs
[p•->
ƒhs
] = 0;

2137 
p•
->
ƒhs
++;

2139 }if–(
x
[0]=='|' || x[0]=='/'Ë&& 
p•
->
ƒhs
>0 ){

2140 
symbﬁ
 *
m•
 = 
p•
->
rhs
[p•->
ƒhs
-1];

2141 if–
m•
->
ty≥
!=
MULTITERMINAL
 ){

2142 
symbﬁ
 *
‹ig•
 = 
m•
;

2143 
m•
 = (
symbﬁ
 *Ë
	`ˇŒoc
(1,(*msp));

2144 
	`mem£t
(
m•
, 0, (*msp));

2145 
m•
->
ty≥
 = 
MULTITERMINAL
;

2146 
m•
->
nsubsym
 = 1;

2147 
m•
->
subsym
 = (
symbﬁ
 **Ë
	`ˇŒoc
(1,(symbol*));

2148 
m•
->
subsym
[0] = 
‹ig•
;

2149 
m•
->
«me
 = 
‹ig•
->name;

2150 
p•
->
rhs
[p•->
ƒhs
-1] = 
m•
;

2152 
m•
->
nsubsym
++;

2153 
m•
->
subsym
 = (
symbﬁ
 **Ë
	`ªÆloc
(msp->subsym,

2154 (
symbﬁ
*)*
m•
->
nsubsym
);

2155 
m•
->
subsym
[m•->
nsubsym
-1] = 
	`Symbﬁ_√w
(&
x
[1]);

2156 if–
	`i¶owî
(
x
[1]Ë|| i¶owî(
m•
->
subsym
[0]->
«me
[0]) ){

2157 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2159 
p•
->
îr‹˙t
++;

2161 }if–
x
[0]=='(' && 
p•
->
ƒhs
>0 ){

2162 
p•
->
°©e
 = 
RHS_ALIAS_1
;

2164 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2165 "IŒegÆ ch¨a˘î o¿RHS o‡ruÀ: \"%s\".",
x
);

2166 
p•
->
îr‹˙t
++;

2167 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2170 
RHS_ALIAS_1
:

2171 if–
	`ißÕha
(
x
[0]) ){

2172 
p•
->
Æüs
[p•->
ƒhs
-1] = 
x
;

2173 
p•
->
°©e
 = 
RHS_ALIAS_2
;

2175 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2177 
x
,
p•
->
rhs
[p•->
ƒhs
-1]->
«me
);

2178 
p•
->
îr‹˙t
++;

2179 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2182 
RHS_ALIAS_2
:

2183 if–
x
[0]==')' ){

2184 
p•
->
°©e
 = 
IN_RHS
;

2186 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2187 "Missög \")\" fﬁlowög LHSálü†«mê\"%s\".",
p•
->
lhßlüs
);

2188 
p•
->
îr‹˙t
++;

2189 
p•
->
°©e
 = 
RESYNC_AFTER_RULE_ERROR
;

2192 
WAITING_FOR_DECL_KEYWORD
:

2193 if–
	`ißÕha
(
x
[0]) ){

2194 
p•
->
de˛keyw‹d
 = 
x
;

2195 
p•
->
de˛¨g¶Ÿ
 = 0;

2196 
p•
->
de˛löío¶Ÿ
 = 0;

2197 
p•
->
ö£πLöeMa¸o
 = 1;

2198 
p•
->
°©e
 = 
WAITING_FOR_DECL_ARG
;

2199 if–
	`°rcmp
(
x
,"name")==0 ){

2200 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
«me
);

2201 
p•
->
ö£πLöeMa¸o
 = 0;

2202 }if–
	`°rcmp
(
x
,"include")==0 ){

2203 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
ö˛ude
);

2204 }if–
	`°rcmp
(
x
,"code")==0 ){

2205 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
exåacode
);

2206 }if–
	`°rcmp
(
x
,"token_destructor")==0 ){

2207 
p•
->
de˛¨g¶Ÿ
 = &p•->
gp
->
tokíde°
;

2208 }if–
	`°rcmp
(
x
,"default_destructor")==0 ){

2209 
p•
->
de˛¨g¶Ÿ
 = &p•->
gp
->
v¨de°
;

2210 }if–
	`°rcmp
(
x
,"token_prefix")==0 ){

2211 
p•
->
de˛¨g¶Ÿ
 = &p•->
gp
->
tokí¥efix
;

2212 
p•
->
ö£πLöeMa¸o
 = 0;

2213 }if–
	`°rcmp
(
x
,"syntax_error")==0 ){

2214 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
îr‹
);

2215 }if–
	`°rcmp
(
x
,"parse_accept")==0 ){

2216 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
ac˚±
);

2217 }if–
	`°rcmp
(
x
,"parse_failure")==0 ){

2218 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
Áûuª
);

2219 }if–
	`°rcmp
(
x
,"stack_overflow")==0 ){

2220 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
ovîÊow
);

2221 }if–
	`°rcmp
(
x
,"extra_argument")==0 ){

2222 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
¨g
);

2223 
p•
->
ö£πLöeMa¸o
 = 0;

2224 }if–
	`°rcmp
(
x
,"token_type")==0 ){

2225 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
tokíty≥
);

2226 
p•
->
ö£πLöeMa¸o
 = 0;

2227 }if–
	`°rcmp
(
x
,"default_type")==0 ){

2228 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
v¨ty≥
);

2229 
p•
->
ö£πLöeMa¸o
 = 0;

2230 }if–
	`°rcmp
(
x
,"stack_size")==0 ){

2231 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
°acksize
);

2232 
p•
->
ö£πLöeMa¸o
 = 0;

2233 }if–
	`°rcmp
(
x
,"start_symbol")==0 ){

2234 
p•
->
de˛¨g¶Ÿ
 = &’•->
gp
->
°¨t
);

2235 
p•
->
ö£πLöeMa¸o
 = 0;

2236 }if–
	`°rcmp
(
x
,"left")==0 ){

2237 
p•
->
¥eccou¡î
++;

2238 
p•
->
de˛assoc
 = 
LEFT
;

2239 
p•
->
°©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2240 }if–
	`°rcmp
(
x
,"right")==0 ){

2241 
p•
->
¥eccou¡î
++;

2242 
p•
->
de˛assoc
 = 
RIGHT
;

2243 
p•
->
°©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2244 }if–
	`°rcmp
(
x
,"nonassoc")==0 ){

2245 
p•
->
¥eccou¡î
++;

2246 
p•
->
de˛assoc
 = 
NONE
;

2247 
p•
->
°©e
 = 
WAITING_FOR_PRECEDENCE_SYMBOL
;

2248 }if–
	`°rcmp
(
x
,"destructor")==0 ){

2249 
p•
->
°©e
 = 
WAITING_FOR_DESTRUCTOR_SYMBOL
;

2250 }if–
	`°rcmp
(
x
,"type")==0 ){

2251 
p•
->
°©e
 = 
WAITING_FOR_DATATYPE_SYMBOL
;

2252 }if–
	`°rcmp
(
x
,"fallback")==0 ){

2253 
p•
->
ÁŒback
 = 0;

2254 
p•
->
°©e
 = 
WAITING_FOR_FALLBACK_ID
;

2255 }if–
	`°rcmp
(
x
,"wildcard")==0 ){

2256 
p•
->
°©e
 = 
WAITING_FOR_WILDCARD_ID
;

2258 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2259 "Unknow¿de˛¨©i⁄ keyw‹d: \"%%%s\".",
x
);

2260 
p•
->
îr‹˙t
++;

2261 
p•
->
°©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2264 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2265 "IŒegÆ de˛¨©i⁄ keyw‹d: \"%s\".",
x
);

2266 
p•
->
îr‹˙t
++;

2267 
p•
->
°©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2270 
WAITING_FOR_DESTRUCTOR_SYMBOL
:

2271 if–!
	`ißÕha
(
x
[0]) ){

2272 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2274 
p•
->
îr‹˙t
++;

2275 
p•
->
°©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2277 
symbﬁ
 *
•
 = 
	`Symbﬁ_√w
(
x
);

2278 
p•
->
de˛¨g¶Ÿ
 = &
•
->
de°ru˘‹
;

2279 
p•
->
de˛löío¶Ÿ
 = &
•
->
de°Löío
;

2280 
p•
->
ö£πLöeMa¸o
 = 1;

2281 
p•
->
°©e
 = 
WAITING_FOR_DECL_ARG
;

2284 
WAITING_FOR_DATATYPE_SYMBOL
:

2285 if–!
	`ißÕha
(
x
[0]) ){

2286 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2288 
p•
->
îr‹˙t
++;

2289 
p•
->
°©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2291 
symbﬁ
 *
•
 = 
	`Symbﬁ_föd
(
x
);

2292 if((
•
Ë&& (•->
d©©y≥
)){

2293 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2294 "Symbﬁ %%ty≥ \"%s\"áÃódy deföed", 
x
);

2295 
p•
->
îr‹˙t
++;

2296 
p•
->
°©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2298 i‡(!
•
){

2299 
•
 = 
	`Symbﬁ_√w
(
x
);

2301 
p•
->
de˛¨g¶Ÿ
 = &
•
->
d©©y≥
;

2302 
p•
->
ö£πLöeMa¸o
 = 0;

2303 
p•
->
°©e
 = 
WAITING_FOR_DECL_ARG
;

2307 
WAITING_FOR_PRECEDENCE_SYMBOL
:

2308 if–
x
[0]=='.' ){

2309 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2310 }if–
	`isuµî
(
x
[0]) ){

2311 
symbﬁ
 *
•
;

2312 
•
 = 
	`Symbﬁ_√w
(
x
);

2313 if–
•
->
¥ec
>=0 ){

2314 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2315 "Symbﬁ \"%s\" ha†Æªady bêgivíáÖª˚dí˚.",
x
);

2316 
p•
->
îr‹˙t
++;

2318 
•
->
¥ec
 = 
p•
->
¥eccou¡î
;

2319 
•
->
assoc
 = 
p•
->
de˛assoc
;

2322 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2323 "C™'àassig¿®¥e˚dí˚Åÿ\"%s\".",
x
);

2324 
p•
->
îr‹˙t
++;

2327 
WAITING_FOR_DECL_ARG
:

2328 if–
x
[0]=='{' || x[0]=='\"' || 
	`iß um
(x[0]) ){

2329 c⁄° *
zOld
, *
zNew
;

2330 *
zBuf
, *
z
;

2331 
nOld
, 
n
, 
nLöe
, 
nNew
, 
nBack
;

2332 
addLöeMa¸o
;

2333 
zLöe
[50];

2334 
zNew
 = 
x
;

2335 if–
zNew
[0]=='"' || zNew[0]=='{' ) zNew++;

2336 
nNew
 = 
	`Àm⁄SåÀn
(
zNew
);

2337 if–*
p•
->
de˛¨g¶Ÿ
 ){

2338 
zOld
 = *
p•
->
de˛¨g¶Ÿ
;

2340 
zOld
 = "";

2342 
nOld
 = 
	`Àm⁄SåÀn
(
zOld
);

2343 
n
 = 
nOld
 + 
nNew
 + 20;

2344 
addLöeMa¸o
 = !
p•
->
gp
->
nﬁöíosÊag
 &&Ö•->
ö£πLöeMa¸o
 &&

2345 (
p•
->
de˛löío¶Ÿ
==0 ||Ösp->decllinenoslot[0]!=0);

2346 if–
addLöeMa¸o
 ){

2347 
z
=
p•
->
fûíame
, 
nBack
=0; *z; z++){

2348 if–*
z
=='\\' ) 
nBack
++;

2350 
	`•rötf
(
zLöe
, "#löê%d ", 
p•
->
tokílöío
);

2351 
nLöe
 = 
	`Àm⁄SåÀn
(
zLöe
);

2352 
n
 +
nLöe
 + 
	`Àm⁄SåÀn
(
p•
->
fûíame
Ë+ 
nBack
;

2354 *
p•
->
de˛¨g¶Ÿ
 = (*Ë
	`ªÆloc
(*p•->de˛¨g¶Ÿ, 
n
);

2355 
zBuf
 = *
p•
->
de˛¨g¶Ÿ
 + 
nOld
;

2356 if–
addLöeMa¸o
 ){

2357 if–
nOld
 && 
zBuf
[-1]!='\n' ){

2358 *(
zBuf
++) = '\n';

2360 
	`mem˝y
(
zBuf
, 
zLöe
, 
nLöe
);

2361 
zBuf
 +
nLöe
;

2362 *(
zBuf
++) = '"';

2363 
z
=
p•
->
fûíame
; *z; z++){

2364 if–*
z
=='\\' ){

2365 *(
zBuf
++) = '\\';

2367 *(
zBuf
++Ë*
z
;

2369 *(
zBuf
++) = '"';

2370 *(
zBuf
++) = '\n';

2372 if–
p•
->
de˛löío¶Ÿ
 &&Ösp->decllinenoslot[0]==0 ){

2373 
p•
->
de˛löío¶Ÿ
[0] =Ö•->
tokílöío
;

2375 
	`mem˝y
(
zBuf
, 
zNew
, 
nNew
);

2376 
zBuf
 +
nNew
;

2377 *
zBuf
 = 0;

2378 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2380 
	`Eº‹Msg
(
p•
->
fûíame
,p•->
tokílöío
,

2381 "IŒegÆárgumíàtÿ%%%s: %s",
p•
->
de˛keyw‹d
,
x
);

2382 
p•
->
îr‹˙t
++;

2383 
p•
->
°©e
 = 
RESYNC_AFTER_DECL_ERROR
;

2386 
WAITING_FOR_FALLBACK_ID
:

2387 if–
x
[0]=='.' ){

2388 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2389 }if–!
	`isuµî
(
x
[0]) ){

2390 
	`Eº‹Msg
(
p•
->
fûíame
,Ö•->
tokílöío
,

2391 "%%ÁŒbackárgumíà\"%s\" should bê®tokí", 
x
);

2392 
p•
->
îr‹˙t
++;

2394 
symbﬁ
 *
•
 = 
	`Symbﬁ_√w
(
x
);

2395 if–
p•
->
ÁŒback
==0 ){

2396 
p•
->
ÁŒback
 = 
•
;

2397 }if–
•
->
ÁŒback
 ){

2398 
	`Eº‹Msg
(
p•
->
fûíame
,Ö•->
tokílöío
,

2399 "M‹êth™ o√ fÆlbackássig√dÅÿtokí %s", 
x
);

2400 
p•
->
îr‹˙t
++;

2402 
•
->
ÁŒback
 = 
p•
->fallback;

2403 
p•
->
gp
->
has_ÁŒback
 = 1;

2407 
WAITING_FOR_WILDCARD_ID
:

2408 if–
x
[0]=='.' ){

2409 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2410 }if–!
	`isuµî
(
x
[0]) ){

2411 
	`Eº‹Msg
(
p•
->
fûíame
,Ö•->
tokílöío
,

2412 "%%wûdˇrdárgumíà\"%s\" should bê®tokí", 
x
);

2413 
p•
->
îr‹˙t
++;

2415 
symbﬁ
 *
•
 = 
	`Symbﬁ_√w
(
x
);

2416 if–
p•
->
gp
->
wûdˇrd
==0 ){

2417 
p•
->
gp
->
wûdˇrd
 = 
•
;

2419 
	`Eº‹Msg
(
p•
->
fûíame
,Ö•->
tokílöío
,

2420 "Exå®wûdˇrdÅÿtokí: %s", 
x
);

2421 
p•
->
îr‹˙t
++;

2425 
RESYNC_AFTER_RULE_ERROR
:

2428 
RESYNC_AFTER_DECL_ERROR
:

2429 if–
x
[0]=='.' ) 
p•
->
°©e
 = 
WAITING_FOR_DECL_OR_RULE
;

2430 if–
x
[0]=='%' ) 
p•
->
°©e
 = 
WAITING_FOR_DECL_KEYWORD
;

2433 
	}
}

2440 
	$¥ïro˚ss_öput
(*
z
){

2441 
i
, 
j
, 
k
, 
n
;

2442 
ex˛ude
 = 0;

2443 
°¨t
 = 0;

2444 
löío
 = 1;

2445 
°¨t_löío
 = 1;

2446 
i
=0; 
z
[i]; i++){

2447 if–
z
[
i
]=='\n' ) 
löío
++;

2448 if–
z
[
i
]!='%' || (i>0 && z[i-1]!='\n') ) ;

2449 if–
	`°∫cmp
(&
z
[
i
],"%ídif",6)==0 && 
	`is•a˚
(z[i+6]) ){

2450 if–
ex˛ude
 ){

2451 
ex˛ude
--;

2452 if–
ex˛ude
==0 ){

2453 
j
=
°¨t
; j<
i
; j++Ëif–
z
[j]!='\n' ) z[j] = ' ';

2456 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2457 }if–(
	`°∫cmp
(&
z
[
i
],"%ifdef",6)==0 && 
	`is•a˚
(z[i+6]))

2458 || (
	`°∫cmp
(&
z
[
i
],"%i‚def",7)==0 && 
	`is•a˚
(z[i+7])) ){

2459 if–
ex˛ude
 ){

2460 
ex˛ude
++;

2462 
j
=
i
+7; 
	`is•a˚
(
z
[j]); j++){}

2463 
n
=0; 
z
[
j
+n] && !
	`is•a˚
(z[j+n]);Ç++){}

2464 
ex˛ude
 = 1;

2465 
k
=0; k<
nDeföe
; k++){

2466 if–
	`°∫cmp
(
azDeföe
[
k
],&
z
[
j
],
n
)==0 && 
	`Àm⁄SåÀn
(azDefine[k])==n ){

2467 
ex˛ude
 = 0;

2471 if–
z
[
i
+3]=='n' ) 
ex˛ude
 = !exclude;

2472 if–
ex˛ude
 ){

2473 
°¨t
 = 
i
;

2474 
°¨t_löío
 = 
löío
;

2477 
j
=
i
; 
z
[j] && z[j]!='\n'; j++) z[j] = ' ';

2480 if–
ex˛ude
 ){

2481 
	`Ârötf
(
°dîr
,"u¡îmö©ed %%ifde‡°¨tög o¿löê%d\n", 
°¨t_löío
);

2482 
	`exô
(1);

2484 
	}
}

2491 
	$P¨£
(
Àm⁄
 *
gp
)

2493 
p°©e
 
ps
;

2494 
FILE
 *
Â
;

2495 *
fûebuf
;

2496 
fûesize
;

2497 
löío
;

2498 
c
;

2499 *
˝
, *
√xt˝
;

2500 
°¨éöe
 = 0;

2502 
	`mem£t
(&
ps
, '\0', (ps));

2503 
ps
.
gp
 = gp;

2504 
ps
.
fûíame
 = 
gp
->filename;

2505 
ps
.
îr‹˙t
 = 0;

2506 
ps
.
°©e
 = 
INITIALIZE
;

2509 
Â
 = 
	`f›í
(
ps
.
fûíame
,"rb");

2510 if–
Â
==0 ){

2511 
	`Eº‹Msg
(
ps
.
fûíame
,0,"Can't openÅhis file forÑeading.");

2512 
gp
->
îr‹˙t
++;

2515 
	`f£ek
(
Â
,0,2);

2516 
fûesize
 = 
	`·ñl
(
Â
);

2517 
	`ªwöd
(
Â
);

2518 
fûebuf
 = (*)
	`mÆloc
–
fûesize
+1 );

2519 if–
fûebuf
==0 ){

2520 
	`Eº‹Msg
(
ps
.
fûíame
,0,"Can'tállocate %d of memoryÅo holdÅhis file.",

2521 
fûesize
+1);

2522 
gp
->
îr‹˙t
++;

2523 
	`f˛o£
(
Â
);

2526 if–
	`‰ód
(
fûebuf
,1,
fûesize
,
Â
)!=filesize ){

2527 
	`Eº‹Msg
(
ps
.
fûíame
,0,"Can'tÑead ináll %d bytes ofÅhis file.",

2528 
fûesize
);

2529 
	`‰ì
(
fûebuf
);

2530 
gp
->
îr‹˙t
++;

2531 
	`f˛o£
(
Â
);

2534 
	`f˛o£
(
Â
);

2535 
fûebuf
[
fûesize
] = 0;

2538 
	`¥ïro˚ss_öput
(
fûebuf
);

2541 
löío
 = 1;

2542 
˝
=
fûebuf
; (
c
= *cp)!=0; ){

2543 if–
c
=='\n' ) 
löío
++;

2544 if–
	`is•a˚
(
c
Ë){ 
˝
++; ; }

2545 if–
c
=='/' && 
˝
[1]=='/' ){

2546 
˝
+=2;

2547  (
c
*
˝
)!=0 && c!='\n' ) cp++;

2550 if–
c
=='/' && 
˝
[1]=='*' ){

2551 
˝
+=2;

2552  (
c
*
˝
)!=0 && (c!='/' || cp[-1]!='*') ){

2553 if–
c
=='\n' ) 
löío
++;

2554 
˝
++;

2556 if–
c
 ) 
˝
++;

2559 
ps
.
tokí°¨t
 = 
˝
;

2560 
ps
.
tokílöío
 = 
löío
;

2561 if–
c
=='\"' ){

2562 
˝
++;

2563  (
c
*
˝
)!=0 && c!='\"' ){

2564 if–
c
=='\n' ) 
löío
++;

2565 
˝
++;

2567 if–
c
==0 ){

2568 
	`Eº‹Msg
(
ps
.
fûíame
,
°¨éöe
,

2570 
ps
.
îr‹˙t
++;

2571 
√xt˝
 = 
˝
;

2573 
√xt˝
 = 
˝
+1;

2575 }if–
c
=='{' ){

2576 
Àvñ
;

2577 
˝
++;

2578 
Àvñ
=1; (
c
*
˝
)!=0 && (level>1 || c!='}'); cp++){

2579 if–
c
=='\n' ) 
löío
++;

2580 if–
c
=='{' ) 
Àvñ
++;

2581 if–
c
=='}' ) 
Àvñ
--;

2582 if–
c
=='/' && 
˝
[1]=='*' ){

2583 
¥evc
;

2584 
˝
 = &cp[2];

2585 
¥evc
 = 0;

2586  (
c
*
˝
)!=0 && (c!='/' || 
¥evc
!='*') ){

2587 if–
c
=='\n' ) 
löío
++;

2588 
¥evc
 = 
c
;

2589 
˝
++;

2591 }if–
c
=='/' && 
˝
[1]=='/' ){

2592 
˝
 = &cp[2];

2593  (
c
*
˝
)!=0 && c!='\n' ) cp++;

2594 if–
c
 ) 
löío
++;

2595 }if–
c
=='\'' || c=='\"' ){

2596 
°¨tch¨
, 
¥evc
;

2597 
°¨tch¨
 = 
c
;

2598 
¥evc
 = 0;

2599 
˝
++; (
c
*˝)!=0 && (c!=
°¨tch¨
 || 
¥evc
=='\\'); cp++){

2600 if–
c
=='\n' ) 
löío
++;

2601 if–
¥evc
=='\\' )Örevc = 0;

2602 
¥evc
 = 
c
;

2606 if–
c
==0 ){

2607 
	`Eº‹Msg
(
ps
.
fûíame
,ps.
tokílöío
,

2609 
ps
.
îr‹˙t
++;

2610 
√xt˝
 = 
˝
;

2612 
√xt˝
 = 
˝
+1;

2614 }if–
	`iß um
(
c
) ){

2615  (
c
*
˝
)!=0 && (
	`iß um
(c) || c=='_') ) cp++;

2616 
√xt˝
 = 
˝
;

2617 }if–
c
==':' && 
˝
[1]==':' && cp[2]=='=' ){

2618 
˝
 += 3;

2619 
√xt˝
 = 
˝
;

2620 }if–(
c
=='/' || c=='|'Ë&& 
	`ißÕha
(
˝
[1]) ){

2621 
˝
 += 2;

2622  (
c
 = *
˝
)!=0 && (
	`iß um
(c) || c=='_') ) cp++;

2623 
√xt˝
 = 
˝
;

2625 
˝
++;

2626 
√xt˝
 = 
˝
;

2628 
c
 = *
˝
;

2629 *
˝
 = 0;

2630 
	`∑r£⁄ëokí
(&
ps
);

2631 *
˝
 = 
c
;

2632 
˝
 = 
√xt˝
;

2634 
	`‰ì
(
fûebuf
);

2635 
gp
->
ruÀ
 = 
ps
.
fú°ruÀ
;

2636 
gp
->
îr‹˙t
 = 
ps
.errorcnt;

2637 
	}
}

2643 
∂ök
 *
	g∂ök_‰ìli°
 = 0;

2646 
∂ök
 *
	$Plök_√w
(){

2647 
∂ök
 *
√wlök
;

2649 if–
∂ök_‰ìli°
==0 ){

2650 
i
;

2651 
amt
 = 100;

2652 
∂ök_‰ìli°
 = (
∂ök
 *)
	`ˇŒoc
–
amt
, (plink) );

2653 if–
∂ök_‰ìli°
==0 ){

2654 
	`Ârötf
(
°dîr
,

2656 
	`exô
(1);

2658 
i
=0; i<
amt
-1; i++Ë
∂ök_‰ìli°
[i].
√xt
 = &plink_freelist[i+1];

2659 
∂ök_‰ìli°
[
amt
-1].
√xt
 = 0;

2661 
√wlök
 = 
∂ök_‰ìli°
;

2662 
∂ök_‰ìli°
 =Ölök_‰ìli°->
√xt
;

2663  
√wlök
;

2664 
	}
}

2667 
	$Plök_add
(
∂ök
 **
∂µ
, 
c⁄fig
 *
cÂ
)

2669 
∂ök
 *
√wlök
;

2670 
√wlök
 = 
	`Plök_√w
();

2671 
√wlök
->
√xt
 = *
∂µ
;

2672 *
∂µ
 = 
√wlök
;

2673 
√wlök
->
cÂ
 = cfp;

2674 
	}
}

2677 
	$Plök_c›y
(
∂ök
 **
to
, ∂ök *
‰om
)

2679 
∂ök
 *
√xçl
;

2680  
‰om
 ){

2681 
√xçl
 = 
‰om
->
√xt
;

2682 
‰om
->
√xt
 = *
to
;

2683 *
to
 = 
‰om
;

2684 
‰om
 = 
√xçl
;

2686 
	}
}

2689 
	$Plök_dñëe
(
∂ök
 *
∂p
)

2691 
∂ök
 *
√xçl
;

2693  
∂p
 ){

2694 
√xçl
 = 
∂p
->
√xt
;

2695 
∂p
->
√xt
 = 
∂ök_‰ìli°
;

2696 
∂ök_‰ìli°
 = 
∂p
;

2697 
∂p
 = 
√xçl
;

2699 
	}
}

2709 
PRIVATE
 *
	$fûe_makíame
(
Àm⁄
 *
Àmp
, c⁄° *
suffix
)

2711 *
«me
;

2712 *
˝
;

2714 
«me
 = (*)
	`mÆloc
–
	`Àm⁄SåÀn
(
Àmp
->
fûíame
Ë+Üem⁄SåÀn(
suffix
) + 5 );

2715 if–
«me
==0 ){

2716 
	`Ârötf
(
°dîr
,"Can'tállocate space forá filename.\n");

2717 
	`exô
(1);

2719 
	`°r˝y
(
«me
,
Àmp
->
fûíame
);

2720 
˝
 = 
	`°ºchr
(
«me
,'.');

2721 if–
˝
 ) *cp = 0;

2722 
	`°rˇt
(
«me
,
suffix
);

2723  
«me
;

2724 
	}
}

2729 
PRIVATE
 
FILE
 *
	$fûe_›í
(

2730 
Àm⁄
 *
Àmp
,

2731 c⁄° *
suffix
,

2732 c⁄° *
mode


2734 
FILE
 *
Â
;

2736 if–
Àmp
->
ouäame
 ) 
	`‰ì
(lemp->outname);

2737 
Àmp
->
ouäame
 = 
	`fûe_makíame
÷emp, 
suffix
);

2738 
Â
 = 
	`f›í
(
Àmp
->
ouäame
,
mode
);

2739 if–
Â
==0 && *
mode
=='w' ){

2740 
	`Ârötf
(
°dîr
,"C™'à›í fûê\"%s\".\n",
Àmp
->
ouäame
);

2741 
Àmp
->
îr‹˙t
++;

2744  
Â
;

2745 
	}
}

2749 
	$Rïröt
(
Àm⁄
 *
Àmp
)

2751 
ruÀ
 *
Ω
;

2752 
symbﬁ
 *
•
;

2753 
i
, 
j
, 
maxÀn
, 
Àn
, 
ncﬁumns
, 
skù
;

2754 
	`¥ötf
("// Rïröào‡öpuàfûê\"%s\".\n// Symbﬁs:\n",
Àmp
->
fûíame
);

2755 
maxÀn
 = 10;

2756 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

2757 
•
 = 
Àmp
->
symbﬁs
[
i
];

2758 
Àn
 = 
	`Àm⁄SåÀn
(
•
->
«me
);

2759 if–
Àn
>
maxÀn
 ) maxlen =Üen;

2761 
ncﬁumns
 = 76/(
maxÀn
+5);

2762 if–
ncﬁumns
<1 )Çcolumns = 1;

2763 
skù
 = (
Àmp
->
nsymbﬁ
 + 
ncﬁumns
 - 1)/ncolumns;

2764 
i
=0; i<
skù
; i++){

2765 
	`¥ötf
("//");

2766 
j
=
i
; j<
Àmp
->
nsymbﬁ
; j+=
skù
){

2767 
•
 = 
Àmp
->
symbﬁs
[
j
];

2768 
	`as£π
–
•
->
ödex
==
j
 );

2769 
	`¥ötf
(" %3d %-*.*s",
j
,
maxÀn
,maxÀn,
•
->
«me
);

2771 
	`¥ötf
("\n");

2773 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

2774 
	`¥ötf
("%s",
Ω
->
lhs
->
«me
);

2776 
	`¥ötf
(" ::=");

2777 
i
=0; i<
Ω
->
ƒhs
; i++){

2778 
•
 = 
Ω
->
rhs
[
i
];

2779 
	`¥ötf
(" %s", 
•
->
«me
);

2780 if–
•
->
ty≥
==
MULTITERMINAL
 ){

2781 
j
=1; j<
•
->
nsubsym
; j++){

2782 
	`¥ötf
("|%s", 
•
->
subsym
[
j
]->
«me
);

2787 
	`¥ötf
(".");

2788 if–
Ω
->
¥ecsym
 ) 
	`¥ötf
(" [%s]",Ω->¥ecsym->
«me
);

2790 
	`¥ötf
("\n");

2792 
	}
}

2794 
	$C⁄figPröt
(
FILE
 *
Â
, 
c⁄fig
 *
cÂ
)

2796 
ruÀ
 *
Ω
;

2797 
symbﬁ
 *
•
;

2798 
i
, 
j
;

2799 
Ω
 = 
cÂ
->rp;

2800 
	`Ârötf
(
Â
,"%†::=",
Ω
->
lhs
->
«me
);

2801 
i
=0; i<=
Ω
->
ƒhs
; i++){

2802 if–
i
==
cÂ
->
dŸ
 ) 
	`Ârötf
(
Â
," *");

2803 if–
i
==
Ω
->
ƒhs
 ) ;

2804 
•
 = 
Ω
->
rhs
[
i
];

2805 
	`Ârötf
(
Â
," %s", 
•
->
«me
);

2806 if–
•
->
ty≥
==
MULTITERMINAL
 ){

2807 
j
=1; j<
•
->
nsubsym
; j++){

2808 
	`Ârötf
(
Â
,"|%s",
•
->
subsym
[
j
]->
«me
);

2812 
	}
}

2817 
PRIVATE
 
	$SëPröt
(
out
,
£t
,
Àmp
)

2818 
FILE
 *
out
;

2819 *
£t
;

2820 
Àm⁄
 *
Àmp
;

2822 
i
;

2823 *
•a˚r
;

2824 
•a˚r
 = "";

2825 
	`Ârötf
(
out
,"%12s[","");

2826 
i
=0; i<
Àmp
->
¡îmöÆ
; i++){

2827 if–
	`SëFöd
(
£t
,
i
) ){

2828 
	`Ârötf
(
out
,"%s%s",
•a˚r
,
Àmp
->
symbﬁs
[
i
]->
«me
);

2829 
•a˚r
 = " ";

2832 
	`Ârötf
(
out
,"]\n");

2833 
	}
}

2836 
PRIVATE
 
	$PlökPröt
(
out
,
∂p
,
èg
)

2837 
FILE
 *
out
;

2838 
∂ök
 *
∂p
;

2839 *
èg
;

2841  
∂p
 ){

2842 
	`Ârötf
(
out
,"%12s%†(°©ê%2dË","",
èg
,
∂p
->
cÂ
->
°p
->
°©íum
);

2843 
	`C⁄figPröt
(
out
,
∂p
->
cÂ
);

2844 
	`Ârötf
(
out
,"\n");

2845 
∂p
 =ÖÕ->
√xt
;

2847 
	}
}

2853 
	$PrötA˘i⁄
(
a˘i⁄
 *
≠
, 
FILE
 *
Â
, 
ödít
){

2854 
ªsu…
 = 1;

2855  
≠
->
ty≥
 ){

2856 
SHIFT
:

2857 
	`Ârötf
(
Â
,"%*†shi· %d",
ödít
,
≠
->
•
->
«me
,≠->
x
.
°p
->
°©íum
);

2859 
REDUCE
:

2860 
	`Ârötf
(
Â
,"%*†ªdu˚ %d",
ödít
,
≠
->
•
->
«me
,≠->
x
.
Ω
->
ödex
);

2862 
ACCEPT
:

2863 
	`Ârötf
(
Â
,"%*†ac˚±",
ödít
,
≠
->
•
->
«me
);

2865 
ERROR
:

2866 
	`Ârötf
(
Â
,"%*†îr‹",
ödít
,
≠
->
•
->
«me
);

2868 
SRCONFLICT
:

2869 
RRCONFLICT
:

2870 
	`Ârötf
(
Â
,"%*sÑeduce %-3d ** Parsing conflict **",

2871 
ödít
,
≠
->
•
->
«me
,≠->
x
.
Ω
->
ödex
);

2873 
SSCONFLICT
:

2874 
	`Ârötf
(
Â
,"%*s shift %-3d ** Parsing conflict **",

2875 
ödít
,
≠
->
•
->
«me
,≠->
x
.
°p
->
°©íum
);

2877 
SH_RESOLVED
:

2878 if–
showPª˚dí˚C⁄Êi˘
 ){

2879 
	`Ârötf
(
Â
,"%*s shift %-3d -- dropped byÖrecedence",

2880 
ödít
,
≠
->
•
->
«me
,≠->
x
.
°p
->
°©íum
);

2882 
ªsu…
 = 0;

2885 
RD_RESOLVED
:

2886 if–
showPª˚dí˚C⁄Êi˘
 ){

2887 
	`Ârötf
(
Â
,"%*sÑeduce %-3d -- dropped byÖrecedence",

2888 
ödít
,
≠
->
•
->
«me
,≠->
x
.
Ω
->
ödex
);

2890 
ªsu…
 = 0;

2893 
NOT_USED
:

2894 
ªsu…
 = 0;

2897  
ªsu…
;

2898 
	}
}

2901 
	$Rï‹tOuçut
(
Àm⁄
 *
Àmp
)

2903 
i
;

2904 
°©e
 *
°p
;

2905 
c⁄fig
 *
cÂ
;

2906 
a˘i⁄
 *
≠
;

2907 
FILE
 *
Â
;

2909 
Â
 = 
	`fûe_›í
(
Àmp
,".out","wb");

2910 if–
Â
==0 ) ;

2911 
i
=0; i<
Àmp
->
n°©e
; i++){

2912 
°p
 = 
Àmp
->
s‹ãd
[
i
];

2913 
	`Ârötf
(
Â
,"Sèã %d:\n",
°p
->
°©íum
);

2914 if–
Àmp
->
basisÊag
 ) 
cÂ
=
°p
->
bp
;

2915 
cÂ
=
°p
->cfp;

2916  
cÂ
 ){

2917 
buf
[20];

2918 if–
cÂ
->
dŸ
==cÂ->
Ω
->
ƒhs
 ){

2919 
	`•rötf
(
buf
,"(%d)",
cÂ
->
Ω
->
ödex
);

2920 
	`Ârötf
(
Â
," %5†",
buf
);

2922 
	`Ârötf
(
Â
," ");

2924 
	`C⁄figPröt
(
Â
,
cÂ
);

2925 
	`Ârötf
(
Â
,"\n");

2927 
	`SëPröt
(
Â
,
cÂ
->
fws
,
Àmp
);

2928 
	`PlökPröt
(
Â
,
cÂ
->
ÂÕ
,"To ");

2929 
	`PlökPröt
(
Â
,
cÂ
->
b∂p
,"From");

2931 if–
Àmp
->
basisÊag
 ) 
cÂ
=cÂ->
bp
;

2932 
cÂ
=cÂ->
√xt
;

2934 
	`Ârötf
(
Â
,"\n");

2935 
≠
=
°p
->≠;áp;áp˜p->
√xt
){

2936 if–
	`PrötA˘i⁄
(
≠
,
Â
,30ËË
	`Ârötf
(fp,"\n");

2938 
	`Ârötf
(
Â
,"\n");

2940 
	`Ârötf
(
Â
, "----------------------------------------------------\n");

2941 
	`Ârötf
(
Â
, "Symbols:\n");

2942 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

2943 
j
;

2944 
symbﬁ
 *
•
;

2946 
•
 = 
Àmp
->
symbﬁs
[
i
];

2947 
	`Ârötf
(
Â
, " %3d: %s", 
i
, 
•
->
«me
);

2948 if–
•
->
ty≥
==
NONTERMINAL
 ){

2949 
	`Ârötf
(
Â
, ":");

2950 if–
•
->
œmbda
 ){

2951 
	`Ârötf
(
Â
, " <lambda>");

2953 
j
=0; j<
Àmp
->
¡îmöÆ
; j++){

2954 if–
•
->
fú°£t
 && 
	`SëFöd
(•->fú°£t, 
j
) ){

2955 
	`Ârötf
(
Â
, " %s", 
Àmp
->
symbﬁs
[
j
]->
«me
);

2959 
	`Ârötf
(
Â
, "\n");

2961 
	`f˛o£
(
Â
);

2963 
	}
}

2967 
PRIVATE
 *
	$∑th£¨ch
(*
¨gv0
, *
«me
, 
modemask
)

2969 c⁄° *
∑thli°
;

2970 *
∑thbuÂå
;

2971 *
∑thbuf
;

2972 *
∑th
,*
˝
;

2973 
c
;

2975 #ifde‡
__WIN32__


2976 
˝
 = 
	`°ºchr
(
¨gv0
,'\\');

2978 
˝
 = 
	`°ºchr
(
¨gv0
,'/');

2980 if–
˝
 ){

2981 
c
 = *
˝
;

2982 *
˝
 = 0;

2983 
∑th
 = (*)
	`mÆloc
–
	`Àm⁄SåÀn
(
¨gv0
Ë+Üem⁄SåÀn(
«me
) + 2 );

2984 if–
∑th
 ) 
	`•rötf
’©h,"%s/%s",
¨gv0
,
«me
);

2985 *
˝
 = 
c
;

2987 
∑thli°
 = 
	`gëív
("PATH");

2988 if–
∑thli°
==0 )Öathlist = ".:/bin:/usr/bin";

2989 
∑thbuf
 = (*Ë
	`mÆloc
–
	`Àm⁄SåÀn
(
∑thli°
) + 1 );

2990 
∑th
 = (*)
	`mÆloc
–
	`Àm⁄SåÀn
(
∑thli°
)+Àm⁄SåÀn(
«me
)+2 );

2991 if–(
∑thbuf
 !0Ë&& (
∑th
!=0) ){

2992 
∑thbuÂå
 = 
∑thbuf
;

2993 
	`°r˝y
(
∑thbuf
, 
∑thli°
);

2994  *
∑thbuf
 ){

2995 
˝
 = 
	`°rchr
(
∑thbuf
,':');

2996 if–
˝
==0 ) c∞&
∑thbuf
[
	`Àm⁄SåÀn
(pathbuf)];

2997 
c
 = *
˝
;

2998 *
˝
 = 0;

2999 
	`•rötf
(
∑th
,"%s/%s",
∑thbuf
,
«me
);

3000 *
˝
 = 
c
;

3001 if–
c
==0 ) 
∑thbuf
[0] = 0;

3002 
∑thbuf
 = &
˝
[1];

3003 if–
	`ac˚ss
(
∑th
,
modemask
)==0 ) ;

3005 
	`‰ì
(
∑thbuÂå
);

3008  
∑th
;

3009 
	}
}

3015 
PRIVATE
 
	$compuã_a˘i⁄
(
Àm⁄
 *
Àmp
, 
a˘i⁄
 *
≠
)

3017 
a˘
;

3018  
≠
->
ty≥
 ){

3019 
SHIFT
: 
a˘
 = 
≠
->
x
.
°p
->
°©íum
; ;

3020 
REDUCE
: 
a˘
 = 
≠
->
x
.
Ω
->
ödex
 + 
Àmp
->
n°©e
; ;

3021 
ERROR
: 
a˘
 = 
Àmp
->
n°©e
 +Üemp->
ƒuÀ
; ;

3022 
ACCEPT
: 
a˘
 = 
Àmp
->
n°©e
 +Üemp->
ƒuÀ
 + 1; ;

3023 : 
a˘
 = -1; ;

3025  
a˘
;

3026 
	}
}

3028 
	#LINESIZE
 1000

	)

3038 
PRIVATE
 
	$ç…_x„r
(*
«me
, 
FILE
 *
ö
, FILE *
out
, *
löío
)

3040 
i
, 
iSèπ
;

3041 
löe
[
LINESIZE
];

3042  
	`fgës
(
löe
,
LINESIZE
,
ö
) && (line[0]!='%' ||Üine[1]!='%') ){

3043 (*
löío
)++;

3044 
iSèπ
 = 0;

3045 if–
«me
 ){

3046 
i
=0; 
löe
[i]; i++){

3047 if–
löe
[
i
]=='P' && 
	`°∫cmp
(&line[i],"Parse",5)==0

3048 && (
i
==0 || !
	`ißÕha
(
löe
[i-1]))

3050 if–
i
>
iSèπ
 ) 
	`Ârötf
(
out
,"%.*s",i-iSèπ,&
löe
[iStart]);

3051 
	`Ârötf
(
out
,"%s",
«me
);

3052 
i
 += 4;

3053 
iSèπ
 = 
i
+1;

3057 
	`Ârötf
(
out
,"%s",&
löe
[
iSèπ
]);

3059 
	}
}

3063 
PRIVATE
 
FILE
 *
	$ç…_›í
(
Àm⁄
 *
Àmp
)

3065 
ãm∂©íame
[] = "lempar.c";

3066 
buf
[1000];

3067 
FILE
 *
ö
;

3068 *
ç…«me
;

3069 *
˝
;

3072 i‡(
u£r_ãm∂©íame
 != 0) {

3073 if–
	`ac˚ss
(
u£r_ãm∂©íame
,004)==-1 ){

3074 
	`Ârötf
(
°dîr
,"Can't findÅheÖarser driverÅemplate file \"%s\".\n",

3075 
u£r_ãm∂©íame
);

3076 
Àmp
->
îr‹˙t
++;

3079 
ö
 = 
	`f›í
(
u£r_ãm∂©íame
,"rb");

3080 if–
ö
==0 ){

3081 
	`Ârötf
(
°dîr
,"C™'à›íÅhêãm∂©êfûê\"%s\".\n",
u£r_ãm∂©íame
);

3082 
Àmp
->
îr‹˙t
++;

3085  
ö
;

3088 
˝
 = 
	`°ºchr
(
Àmp
->
fûíame
,'.');

3089 if–
˝
 ){

3090 
	`•rötf
(
buf
,"%.*s.…",()(
˝
-
Àmp
->
fûíame
),lemp->filename);

3092 
	`•rötf
(
buf
,"%s.…",
Àmp
->
fûíame
);

3094 if–
	`ac˚ss
(
buf
,004)==0 ){

3095 
ç…«me
 = 
buf
;

3096 }if–
	`ac˚ss
(
ãm∂©íame
,004)==0 ){

3097 
ç…«me
 = 
ãm∂©íame
;

3099 
ç…«me
 = 
	`∑th£¨ch
(
Àmp
->
¨gv0
,
ãm∂©íame
,0);

3101 if–
ç…«me
==0 ){

3102 
	`Ârötf
(
°dîr
,"Can't findÅheÖarser driverÅemplate file \"%s\".\n",

3103 
ãm∂©íame
);

3104 
Àmp
->
îr‹˙t
++;

3107 
ö
 = 
	`f›í
(
ç…«me
,"rb");

3108 if–
ö
==0 ){

3109 
	`Ârötf
(
°dîr
,"C™'à›íÅhêãm∂©êfûê\"%s\".\n",
ãm∂©íame
);

3110 
Àmp
->
îr‹˙t
++;

3113  
ö
;

3114 
	}
}

3117 
PRIVATE
 
	$ç…_löedú
(
FILE
 *
out
, 
löío
, *
fûíame
)

3119 
	`Ârötf
(
out
,"#löê%d \"",
löío
);

3120  *
fûíame
 ){

3121 if–*
fûíame
 ='\\' ) 
	`putc
('\\',
out
);

3122 
	`putc
(*
fûíame
,
out
);

3123 
fûíame
++;

3125 
	`Ârötf
(
out
,"\"\n");

3126 
	}
}

3129 
PRIVATE
 
	$ç…_¥öt
(
FILE
 *
out
, 
Àm⁄
 *
Àmp
, *
°r
, *
löío
)

3131 if–
°r
==0 ) ;

3132  *
°r
 ){

3133 
	`putc
(*
°r
,
out
);

3134 if–*
°r
=='\n' ) (*
löío
)++;

3135 
°r
++;

3137 if–
°r
[-1]!='\n' ){

3138 
	`putc
('\n',
out
);

3139 (*
löío
)++;

3141 i‡(!
Àmp
->
nﬁöíosÊag
) {

3142 (*
löío
)++; 
	`ç…_löedú
(
out
,*löío,
Àmp
->
ouäame
);

3145 
	}
}

3151 
	$emô_de°ru˘‹_code
(

3152 
FILE
 *
out
,

3153 
symbﬁ
 *
•
,

3154 
Àm⁄
 *
Àmp
,

3155 *
löío


3157 *
˝
 = 0;

3159 if–
•
->
ty≥
==
TERMINAL
 ){

3160 
˝
 = 
Àmp
->
tokíde°
;

3161 if–
˝
==0 ) ;

3162 
	`Ârötf
(
out
,"{\n"); (*
löío
)++;

3163 }if–
•
->
de°ru˘‹
 ){

3164 
˝
 = 
•
->
de°ru˘‹
;

3165 
	`Ârötf
(
out
,"{\n"); (*
löío
)++;

3166 i‡(!
Àmp
->
nﬁöíosÊag
Ë{ (*
löío
)++; 
	`ç…_löedú
(
out
,
•
->
de°Löío
,Àmp->
fûíame
); }

3167 }if–
Àmp
->
v¨de°
 ){

3168 
˝
 = 
Àmp
->
v¨de°
;

3169 if–
˝
==0 ) ;

3170 
	`Ârötf
(
out
,"{\n"); (*
löío
)++;

3172 
	`as£π
( 0 );

3174 ; *
˝
; cp++){

3175 if–*
˝
=='$' && cp[1]=='$' ){

3176 
	`Ârötf
(
out
,"(yypmö‹->yy%d)",
•
->
däum
);

3177 
˝
++;

3180 if–*
˝
=='\n' ) (*
löío
)++;

3181 
	`Âutc
(*
˝
,
out
);

3183 
	`Ârötf
(
out
,"\n"); (*
löío
)++;

3184 i‡(!
Àmp
->
nﬁöíosÊag
) {

3185 (*
löío
)++; 
	`ç…_löedú
(
out
,*löío,
Àmp
->
ouäame
);

3187 
	`Ârötf
(
out
,"}\n"); (*
löío
)++;

3189 
	}
}

3194 
	$has_de°ru˘‹
(
symbﬁ
 *
•
, 
Àm⁄
 *
Àmp
)

3196 
ªt
;

3197 if–
•
->
ty≥
==
TERMINAL
 ){

3198 
ªt
 = 
Àmp
->
tokíde°
!=0;

3200 
ªt
 = 
Àmp
->
v¨de°
!=0 || 
•
->
de°ru˘‹
!=0;

3202  
ªt
;

3203 
	}
}

3217 
PRIVATE
 *
	$≠≥nd_°r
(c⁄° *
zText
, 
n
, 
p1
, 
p2
){

3218 
em±y
[1] = { 0 };

3219 *
z
 = 0;

3220 
Ælo˚d
 = 0;

3221 
u£d
 = 0;

3222 
c
;

3223 
zI¡
[40];

3224 if–
zText
==0 ){

3225 
u£d
 = 0;

3226  
z
;

3228 if–
n
<=0 ){

3229 if–
n
<0 ){

3230 
u£d
 +
n
;

3231 
	`as£π
–
u£d
>=0 );

3233 
n
 = 
	`Àm⁄SåÀn
(
zText
);

3235 if–(Ë(
n
+(
zI¡
)*2+
u£d
Ë>
Ælo˚d
 ){

3236 
Ælo˚d
 = 
n
 + (
zI¡
)*2 + 
u£d
 + 200;

3237 
z
 = (*Ë
	`ªÆloc
(z, 
Ælo˚d
);

3239 if–
z
==0 )  
em±y
;

3240  
n
-- > 0 ){

3241 
c
 = *(
zText
++);

3242 if–
c
=='%' && 
n
>0 && 
zText
[0]=='d' ){

3243 
	`•rötf
(
zI¡
, "%d", 
p1
);

3244 
p1
 = 
p2
;

3245 
	`°r˝y
(&
z
[
u£d
], 
zI¡
);

3246 
u£d
 +
	`Àm⁄SåÀn
(&
z
[used]);

3247 
zText
++;

3248 
n
--;

3250 
z
[
u£d
++] = 
c
;

3253 
z
[
u£d
] = 0;

3254  
z
;

3255 
	}
}

3262 
PRIVATE
 
	$å™¶©e_code
(
Àm⁄
 *
Àmp
, 
ruÀ
 *
Ω
){

3263 *
˝
, *
xp
;

3264 
i
;

3265 
lhsu£d
 = 0;

3266 
u£d
[
MAXRHS
];

3268 
i
=0; i<
Ω
->
ƒhs
; i++Ë
u£d
[i] = 0;

3269 
lhsu£d
 = 0;

3271 if–
Ω
->
code
==0 ){

3272 
√wlöe°r
[2] = { '\n', '\0' };

3273 
Ω
->
code
 = 
√wlöe°r
;

3274 
Ω
->
löe
 =Ñp->
ruÀlöe
;

3277 
	`≠≥nd_°r
(0,0,0,0);

3280 
˝
=(*)
Ω
->
code
; *cp; cp++){

3281 if–
	`ißÕha
(*
˝
Ë&& (˝==
Ω
->
code
 || (!
	`iß um
(cp[-1]) && cp[-1]!='_')) ){

3282 
ßved
;

3283 
xp
&
˝
[1]; 
	`iß um
(*xp) || *xp=='_'; xp++);

3284 
ßved
 = *
xp
;

3285 *
xp
 = 0;

3286 if–
Ω
->
lhßlüs
 && 
	`°rcmp
(
˝
,rp->lhsalias)==0 ){

3287 
	`≠≥nd_°r
("yygŸomö‹.yy%d",0,
Ω
->
lhs
->
däum
,0);

3288 
˝
 = 
xp
;

3289 
lhsu£d
 = 1;

3291 
i
=0; i<
Ω
->
ƒhs
; i++){

3292 if–
Ω
->
rhßlüs
[
i
] && 
	`°rcmp
(
˝
,rp->rhsalias[i])==0 ){

3293 if–
˝
!=
Ω
->
code
 && cp[-1]=='@' ){

3296 
	`≠≥nd_°r
("yym•[%d].maj‹",-1,
i
-
Ω
->
ƒhs
+1,0);

3298 
symbﬁ
 *
•
 = 
Ω
->
rhs
[
i
];

3299 
däum
;

3300 if–
•
->
ty≥
==
MULTITERMINAL
 ){

3301 
däum
 = 
•
->
subsym
[0]->dtnum;

3303 
däum
 = 
•
->dtnum;

3305 
	`≠≥nd_°r
("yym•[%d].mö‹.yy%d",0,
i
-
Ω
->
ƒhs
+1, 
däum
);

3307 
˝
 = 
xp
;

3308 
u£d
[
i
] = 1;

3313 *
xp
 = 
ßved
;

3315 
	`≠≥nd_°r
(
˝
, 1, 0, 0);

3319 if–
Ω
->
lhßlüs
 && !
lhsu£d
 ){

3320 
	`Eº‹Msg
(
Àmp
->
fûíame
,
Ω
->
ruÀlöe
,

3322 
Ω
->
lhßlüs
,Ω->
lhs
->
«me
,rp->lhsalias);

3323 
Àmp
->
îr‹˙t
++;

3328 
i
=0; i<
Ω
->
ƒhs
; i++){

3329 if–
Ω
->
rhßlüs
[
i
] && !
u£d
[i] ){

3330 
	`Eº‹Msg
(
Àmp
->
fûíame
,
Ω
->
ruÀlöe
,

3332 
Ω
->
rhßlüs
[
i
],Ω->
rhs
[i]->
«me
,rp->rhsalias[i]);

3333 
Àmp
->
îr‹˙t
++;

3334 }if–
Ω
->
rhßlüs
[
i
]==0 ){

3335 if–
	`has_de°ru˘‹
(
Ω
->
rhs
[
i
],
Àmp
) ){

3336 
	`≠≥nd_°r
(" yy_destructor(yypParser,%d,&yymsp[%d].minor);\n", 0,

3337 
Ω
->
rhs
[
i
]->
ödex
,i-Ω->
ƒhs
+1);

3343 if–
Ω
->
code
 ){

3344 
˝
 = 
	`≠≥nd_°r
(0,0,0,0);

3345 
Ω
->
code
 = 
	`Såß„
(
˝
?cp:"");

3347 
	}
}

3353 
PRIVATE
 
	$emô_code
(

3354 
FILE
 *
out
,

3355 
ruÀ
 *
Ω
,

3356 
Àm⁄
 *
Àmp
,

3357 *
löío


3359 c⁄° *
˝
;

3362 if–
Ω
->
code
 ){

3363 i‡(!
Àmp
->
nﬁöíosÊag
Ë{ (*
löío
)++; 
	`ç…_löedú
(
out
,
Ω
->
löe
,Àmp->
fûíame
); }

3364 
	`Ârötf
(
out
,"{%s",
Ω
->
code
);

3365 
˝
=
Ω
->
code
; *cp; cp++){

3366 if–*
˝
=='\n' ) (*
löío
)++;

3368 
	`Ârötf
(
out
,"}\n"); (*
löío
)++;

3369 i‡(!
Àmp
->
nﬁöíosÊag
Ë{ (*
löío
)++; 
	`ç…_löedú
(
out
,*löío,Àmp->
ouäame
); }

3373 
	}
}

3382 
	$¥öt_°ack_uni⁄
(

3383 
FILE
 *
out
,

3384 
Àm⁄
 *
Àmp
,

3385 *
∂öío
,

3386 
mhÊag


3388 
löío
 = *
∂öío
;

3389 **
ty≥s
;

3390 
¨øysize
;

3391 
maxdéígth
;

3392 *
°ddt
;

3393 
i
,
j
;

3394 
hash
;

3395 c⁄° *
«me
;

3398 
¨øysize
 = 
Àmp
->
nsymbﬁ
 * 2;

3399 
ty≥s
 = (**)
	`ˇŒoc
–
¨øysize
, (*) );

3400 if–
ty≥s
==0 ){

3401 
	`Ârötf
(
°dîr
,"Out of memory.\n");

3402 
	`exô
(1);

3404 
i
=0; i<
¨øysize
; i++Ë
ty≥s
[i] = 0;

3405 
maxdéígth
 = 0;

3406 if–
Àmp
->
v¨ty≥
 ){

3407 
maxdéígth
 = 
	`Àm⁄SåÀn
(
Àmp
->
v¨ty≥
);

3409 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

3410 
Àn
;

3411 
symbﬁ
 *
•
 = 
Àmp
->
symbﬁs
[
i
];

3412 if–
•
->
d©©y≥
==0 ) ;

3413 
Àn
 = 
	`Àm⁄SåÀn
(
•
->
d©©y≥
);

3414 if–
Àn
>
maxdéígth
 ) maxdtlength =Üen;

3416 
°ddt
 = (*)
	`mÆloc
–
maxdéígth
*2 + 1 );

3417 if–
°ddt
==0 ){

3418 
	`Ârötf
(
°dîr
,"Out of memory.\n");

3419 
	`exô
(1);

3428 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

3429 
symbﬁ
 *
•
 = 
Àmp
->
symbﬁs
[
i
];

3430 *
˝
;

3431 if–
•
==
Àmp
->
îrsym
 ){

3432 
•
->
däum
 = 
¨øysize
+1;

3435 if–
•
->
ty≥
!=
NONTERMINAL
 || (•->
d©©y≥
==0 && 
Àmp
->
v¨ty≥
==0) ){

3436 
•
->
däum
 = 0;

3439 
˝
 = 
•
->
d©©y≥
;

3440 if–
˝
==0 ) c∞
Àmp
->
v¨ty≥
;

3441 
j
 = 0;

3442  
	`is•a˚
(*
˝
) ) cp++;

3443  *
˝
 ) 
°ddt
[
j
++] = *cp++;

3444  
j
>0 && 
	`is•a˚
(
°ddt
[j-1]) ) j--;

3445 
°ddt
[
j
] = 0;

3446 if–
Àmp
->
tokíty≥
 && 
	`°rcmp
(
°ddt
,Üemp->tokentype)==0 ){

3447 
•
->
däum
 = 0;

3450 
hash
 = 0;

3451 
j
=0; 
°ddt
[j]; j++){

3452 
hash
 = hash*53 + 
°ddt
[
j
];

3454 
hash
 = (hash & 0x7fffffff)%
¨øysize
;

3455  
ty≥s
[
hash
] ){

3456 if–
	`°rcmp
(
ty≥s
[
hash
],
°ddt
)==0 ){

3457 
•
->
däum
 = 
hash
 + 1;

3460 
hash
++;

3461 if–
hash
>=
¨øysize
 ) hash = 0;

3463 if–
ty≥s
[
hash
]==0 ){

3464 
•
->
däum
 = 
hash
 + 1;

3465 
ty≥s
[
hash
] = (*)
	`mÆloc
–
	`Àm⁄SåÀn
(
°ddt
)+1 );

3466 if–
ty≥s
[
hash
]==0 ){

3467 
	`Ârötf
(
°dîr
,"Out of memory.\n");

3468 
	`exô
(1);

3470 
	`°r˝y
(
ty≥s
[
hash
],
°ddt
);

3475 
«me
 = 
Àmp
->name ?Üemp->name : "Parse";

3476 
löío
 = *
∂öío
;

3477 if–
mhÊag
 ){ 
	`Ârötf
(
out
,"#i‡INTERFACE\n"); 
löío
++; }

3478 
	`Ârötf
(
out
,"#deföê%sTOKENTYPE %s\n",
«me
,

3479 
Àmp
->
tokíty≥
?Àmp->tokíty≥:"void*"); 
löío
++;

3480 if–
mhÊag
 ){ 
	`Ârötf
(
out
,"#ídif\n"); 
löío
++; }

3481 
	`Ârötf
(
out
,"ty≥de‡uni⁄ {\n"); 
löío
++;

3482 
	`Ârötf
(
out
," i¡ yyöô;\n"); 
löío
++;

3483 
	`Ârötf
(
out
," %sTOKENTYPE yy0;\n",
«me
); 
löío
++;

3484 
i
=0; i<
¨øysize
; i++){

3485 if–
ty≥s
[
i
]==0 ) ;

3486 
	`Ârötf
(
out
," %†yy%d;\n",
ty≥s
[
i
],i+1); 
löío
++;

3487 
	`‰ì
(
ty≥s
[
i
]);

3489 if–
Àmp
->
îrsym
->
u£C¡
 ){

3490 
	`Ârötf
(
out
," i¡ yy%d;\n",
Àmp
->
îrsym
->
däum
); 
löío
++;

3492 
	`‰ì
(
°ddt
);

3493 
	`‰ì
(
ty≥s
);

3494 
	`Ârötf
(
out
,"} YYMINORTYPE;\n"); 
löío
++;

3495 *
∂öío
 = 
löío
;

3496 
	}
}

3502 c⁄° *
	$möimum_size_ty≥
(
lwr
, 
u¥
){

3503 if–
lwr
>=0 ){

3504 if–
u¥
<=255 ){

3506 }if–
u¥
<65535 ){

3511 }if–
lwr
>=-127 && 
u¥
<=127 ){

3513 }if–
lwr
>=-32767 && 
u¥
<32767 ){

3518 
	}
}

3526 
	sax£t
 {

3527 
°©e
 *
	m°p
;

3528 
	misTkn
;

3529 
	mnA˘i⁄
;

3530 
	miOrdî
;

3536 
	$ax£t_com∑ª
(c⁄° *
a
, c⁄° *
b
){

3537 
ax£t
 *
p1
 = (ax£t*)
a
;

3538 
ax£t
 *
p2
 = (ax£t*)
b
;

3539 
c
;

3540 
c
 = 
p2
->
nA˘i⁄
 - 
p1
->nAction;

3541 if–
c
==0 ){

3542 
c
 = 
p2
->
iOrdî
 - 
p1
->iOrder;

3544 
	`as£π
–
c
!=0 || 
p1
==
p2
 );

3545  
c
;

3546 
	}
}

3551 
	$wrôeRuÀText
(
FILE
 *
out
, 
ruÀ
 *
Ω
){

3552 
j
;

3553 
	`Ârötf
(
out
,"%†::=", 
Ω
->
lhs
->
«me
);

3554 
j
=0; j<
Ω
->
ƒhs
; j++){

3555 
symbﬁ
 *
•
 = 
Ω
->
rhs
[
j
];

3556 
	`Ârötf
(
out
," %s", 
•
->
«me
);

3557 if–
•
->
ty≥
==
MULTITERMINAL
 ){

3558 
k
;

3559 
k
=1; k<
•
->
nsubsym
; k++){

3560 
	`Ârötf
(
out
,"|%s",
•
->
subsym
[
k
]->
«me
);

3564 
	}
}

3568 
	$Rï‹tTabÀ
(

3569 
Àm⁄
 *
Àmp
,

3570 
mhÊag


3572 
FILE
 *
out
, *
ö
;

3573 
löe
[
LINESIZE
];

3574 
löío
;

3575 
°©e
 *
°p
;

3576 
a˘i⁄
 *
≠
;

3577 
ruÀ
 *
Ω
;

3578 
a˘èb
 *
pA˘èb
;

3579 
i
, 
j
, 
n
;

3580 c⁄° *
«me
;

3581 
mnTknOf°
, 
mxTknOf°
;

3582 
mnNtOf°
, 
mxNtOf°
;

3583 
ax£t
 *
ax
;

3585 
ö
 = 
	`ç…_›í
(
Àmp
);

3586 if–
ö
==0 ) ;

3587 
out
 = 
	`fûe_›í
(
Àmp
,".c","wb");

3588 if–
out
==0 ){

3589 
	`f˛o£
(
ö
);

3592 
löío
 = 1;

3593 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3596 
	`ç…_¥öt
(
out
,
Àmp
,Àmp->
ö˛ude
,&
löío
);

3597 if–
mhÊag
 ){

3598 *
«me
 = 
	`fûe_makíame
(
Àmp
, ".h");

3599 
	`Ârötf
(
out
,"#ö˛udê\"%s\"\n", 
«me
); 
löío
++;

3600 
	`‰ì
(
«me
);

3602 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3605 if–
mhÊag
 ){

3606 c⁄° *
¥efix
;

3607 
	`Ârötf
(
out
,"#i‡INTERFACE\n"); 
löío
++;

3608 if–
Àmp
->
tokí¥efix
 ) 
¥efix
 =Üemp->tokenprefix;

3609 
¥efix
 = "";

3610 
i
=1; i<
Àmp
->
¡îmöÆ
; i++){

3611 
	`Ârötf
(
out
,"#deföê%s%-30†%2d\n",
¥efix
,
Àmp
->
symbﬁs
[
i
]->
«me
,i);

3612 
löío
++;

3614 
	`Ârötf
(
out
,"#ídif\n"); 
löío
++;

3616 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3619 
	`Ârötf
(
out
,"#define YYCODETYPE %s\n",

3620 
	`möimum_size_ty≥
(0, 
Àmp
->
nsymbﬁ
+1)); 
löío
++;

3621 
	`Ârötf
(
out
,"#deföêYYNOCODE %d\n",
Àmp
->
nsymbﬁ
+1); 
löío
++;

3622 
	`Ârötf
(
out
,"#define YYACTIONTYPE %s\n",

3623 
	`möimum_size_ty≥
(0, 
Àmp
->
n°©e
+Àmp->
ƒuÀ
+5)); 
löío
++;

3624 if–
Àmp
->
wûdˇrd
 ){

3625 
	`Ârötf
(
out
,"#define YYWILDCARD %d\n",

3626 
Àmp
->
wûdˇrd
->
ödex
); 
löío
++;

3628 
	`¥öt_°ack_uni⁄
(
out
,
Àmp
,&
löío
,
mhÊag
);

3629 
	`Ârötf
(
out
, "#i‚de‡YYSTACKDEPTH\n"); 
löío
++;

3630 if–
Àmp
->
°acksize
 ){

3631 
	`Ârötf
(
out
,"#deföêYYSTACKDEPTH %s\n",
Àmp
->
°acksize
); 
löío
++;

3633 
	`Ârötf
(
out
,"#deföêYYSTACKDEPTH 100\n"); 
löío
++;

3635 
	`Ârötf
(
out
, "#ídif\n"); 
löío
++;

3636 if–
mhÊag
 ){

3637 
	`Ârötf
(
out
,"#i‡INTERFACE\n"); 
löío
++;

3639 
«me
 = 
Àmp
->name ?Üemp->name : "Parse";

3640 if–
Àmp
->
¨g
 &&Üemp->arg[0] ){

3641 
i
;

3642 
i
 = 
	`Àm⁄SåÀn
(
Àmp
->
¨g
);

3643  
i
>=1 && 
	`is•a˚
(
Àmp
->
¨g
[i-1]) ) i--;

3644  
i
>=1 && (
	`iß um
(
Àmp
->
¨g
[i-1]) ||Üemp->arg[i-1]=='_') ) i--;

3645 
	`Ârötf
(
out
,"#deföê%sARG_SDECL %s;\n",
«me
,
Àmp
->
¨g
); 
löío
++;

3646 
	`Ârötf
(
out
,"#deföê%sARG_PDECL ,%s\n",
«me
,
Àmp
->
¨g
); 
löío
++;

3647 
	`Ârötf
(
out
,"#define %sARG_FETCH %s = yypParser->%s\n",

3648 
«me
,
Àmp
->
¨g
,&Àmp->¨g[
i
]); 
löío
++;

3649 
	`Ârötf
(
out
,"#define %sARG_STORE yypParser->%s = %s\n",

3650 
«me
,&
Àmp
->
¨g
[
i
],&Àmp->¨g[i]); 
löío
++;

3652 
	`Ârötf
(
out
,"#deföê%sARG_SDECL\n",
«me
); 
löío
++;

3653 
	`Ârötf
(
out
,"#deföê%sARG_PDECL\n",
«me
); 
löío
++;

3654 
	`Ârötf
(
out
,"#deföê%sARG_FETCH\n",
«me
); 
löío
++;

3655 
	`Ârötf
(
out
,"#deföê%sARG_STORE\n",
«me
); 
löío
++;

3657 if–
mhÊag
 ){

3658 
	`Ârötf
(
out
,"#ídif\n"); 
löío
++;

3660 
	`Ârötf
(
out
,"#deföêYYNSTATE %d\n",
Àmp
->
n°©e
); 
löío
++;

3661 
	`Ârötf
(
out
,"#deföêYYNRULE %d\n",
Àmp
->
ƒuÀ
); 
löío
++;

3662 if–
Àmp
->
îrsym
->
u£C¡
 ){

3663 
	`Ârötf
(
out
,"#deföêYYERRORSYMBOL %d\n",
Àmp
->
îrsym
->
ödex
); 
löío
++;

3664 
	`Ârötf
(
out
,"#deföêYYERRSYMDT yy%d\n",
Àmp
->
îrsym
->
däum
); 
löío
++;

3666 if–
Àmp
->
has_ÁŒback
 ){

3667 
	`Ârötf
(
out
,"#deföêYYFALLBACK 1\n"); 
löío
++;

3669 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3684 
ax
 = (
ax£t
 *Ë
	`ˇŒoc
(
Àmp
->
n°©e
*2, (ax[0]));

3685 if–
ax
==0 ){

3686 
	`Ârötf
(
°dîr
,"malloc failed\n");

3687 
	`exô
(1);

3689 
i
=0; i<
Àmp
->
n°©e
; i++){

3690 
°p
 = 
Àmp
->
s‹ãd
[
i
];

3691 
ax
[
i
*2].
°p
 = stp;

3692 
ax
[
i
*2].
isTkn
 = 1;

3693 
ax
[
i
*2].
nA˘i⁄
 = 
°p
->
nTknA˘
;

3694 
ax
[
i
*2+1].
°p
 = stp;

3695 
ax
[
i
*2+1].
isTkn
 = 0;

3696 
ax
[
i
*2+1].
nA˘i⁄
 = 
°p
->
nNtA˘
;

3698 
mxTknOf°
 = 
mnTknOf°
 = 0;

3699 
mxNtOf°
 = 
mnNtOf°
 = 0;

3705 
i
=0; i<
Àmp
->
n°©e
*2; i++Ë
ax
[i].
iOrdî
 = i;

3706 
	`qs‹t
(
ax
, 
Àmp
->
n°©e
*2, ◊x[0]), 
ax£t_com∑ª
);

3707 
pA˘èb
 = 
	`a˘èb_Æloc
();

3708 
i
=0; i<
Àmp
->
n°©e
*2 && 
ax
[i].
nA˘i⁄
>0; i++){

3709 
°p
 = 
ax
[
i
].stp;

3710 if–
ax
[
i
].
isTkn
 ){

3711 
≠
=
°p
->≠;áp;áp˜p->
√xt
){

3712 
a˘i⁄
;

3713 if–
≠
->
•
->
ödex
>=
Àmp
->
¡îmöÆ
 ) ;

3714 
a˘i⁄
 = 
	`compuã_a˘i⁄
(
Àmp
, 
≠
);

3715 if–
a˘i⁄
<0 ) ;

3716 
	`a˘èb_a˘i⁄
(
pA˘èb
, 
≠
->
•
->
ödex
, 
a˘i⁄
);

3718 
°p
->
iTknOf°
 = 
	`a˘èb_ö£π
(
pA˘èb
);

3719 if–
°p
->
iTknOf°
<
mnTknOf°
 ) mnTknOfst = stp->iTknOfst;

3720 if–
°p
->
iTknOf°
>
mxTknOf°
 ) mxTknOfst = stp->iTknOfst;

3722 
≠
=
°p
->≠;áp;áp˜p->
√xt
){

3723 
a˘i⁄
;

3724 if–
≠
->
•
->
ödex
<
Àmp
->
¡îmöÆ
 ) ;

3725 if–
≠
->
•
->
ödex
==
Àmp
->
nsymbﬁ
 ) ;

3726 
a˘i⁄
 = 
	`compuã_a˘i⁄
(
Àmp
, 
≠
);

3727 if–
a˘i⁄
<0 ) ;

3728 
	`a˘èb_a˘i⁄
(
pA˘èb
, 
≠
->
•
->
ödex
, 
a˘i⁄
);

3730 
°p
->
iNtOf°
 = 
	`a˘èb_ö£π
(
pA˘èb
);

3731 if–
°p
->
iNtOf°
<
mnNtOf°
 ) mnNtOfst = stp->iNtOfst;

3732 if–
°p
->
iNtOf°
>
mxNtOf°
 ) mxNtOfst = stp->iNtOfst;

3735 
	`‰ì
(
ax
);

3738 
n
 = 
	`a˘èb_size
(
pA˘èb
);

3739 
	`Ârötf
(
out
,"#deföêYY_ACTTAB_COUNT (%d)\n", 
n
); 
löío
++;

3740 
	`Ârötf
(
out
,"°©i¯c⁄° YYACTIONTYPE yy_a˘i⁄[] = {\n"); 
löío
++;

3741 
i
=
j
=0; i<
n
; i++){

3742 
a˘i⁄
 = 
	`a˘èb_yya˘i⁄
(
pA˘èb
, 
i
);

3743 if–
a˘i⁄
<0 )á˘i⁄ = 
Àmp
->
n°©e
 +Üemp->
ƒuÀ
 + 2;

3744 if–
j
==0 ) 
	`Ârötf
(
out
," /* %5d */ ", 
i
);

3745 
	`Ârötf
(
out
, " %4d,", 
a˘i⁄
);

3746 if–
j
==9 || 
i
==
n
-1 ){

3747 
	`Ârötf
(
out
, "\n"); 
löío
++;

3748 
j
 = 0;

3750 
j
++;

3753 
	`Ârötf
(
out
, "};\n"); 
löío
++;

3756 
	`Ârötf
(
out
,"°©i¯c⁄° YYCODETYPE yy_lookahód[] = {\n"); 
löío
++;

3757 
i
=
j
=0; i<
n
; i++){

3758 
œ
 = 
	`a˘èb_yylookahód
(
pA˘èb
, 
i
);

3759 if–
œ
<0 )Ü®
Àmp
->
nsymbﬁ
;

3760 if–
j
==0 ) 
	`Ârötf
(
out
," /* %5d */ ", 
i
);

3761 
	`Ârötf
(
out
, " %4d,", 
œ
);

3762 if–
j
==9 || 
i
==
n
-1 ){

3763 
	`Ârötf
(
out
, "\n"); 
löío
++;

3764 
j
 = 0;

3766 
j
++;

3769 
	`Ârötf
(
out
, "};\n"); 
löío
++;

3772 
	`Ârötf
(
out
, "#deföêYY_SHIFT_USE_DFLT (%d)\n", 
mnTknOf°
-1); 
löío
++;

3773 
n
 = 
Àmp
->
n°©e
;

3774  
n
>0 && 
Àmp
->
s‹ãd
[n-1]->
iTknOf°
==
NO_OFFSET
 )Ç--;

3775 
	`Ârötf
(
out
, "#deföêYY_SHIFT_COUNT (%d)\n", 
n
-1); 
löío
++;

3776 
	`Ârötf
(
out
, "#deföêYY_SHIFT_MIN (%d)\n", 
mnTknOf°
); 
löío
++;

3777 
	`Ârötf
(
out
, "#deföêYY_SHIFT_MAX (%d)\n", 
mxTknOf°
); 
löío
++;

3778 
	`Ârötf
(
out
, "static const %s yy_shift_ofst[] = {\n",

3779 
	`möimum_size_ty≥
(
mnTknOf°
-1, 
mxTknOf°
)); 
löío
++;

3780 
i
=
j
=0; i<
n
; i++){

3781 
of°
;

3782 
°p
 = 
Àmp
->
s‹ãd
[
i
];

3783 
of°
 = 
°p
->
iTknOf°
;

3784 if–
of°
==
NO_OFFSET
 ) of° = 
mnTknOf°
 - 1;

3785 if–
j
==0 ) 
	`Ârötf
(
out
," /* %5d */ ", 
i
);

3786 
	`Ârötf
(
out
, " %4d,", 
of°
);

3787 if–
j
==9 || 
i
==
n
-1 ){

3788 
	`Ârötf
(
out
, "\n"); 
löío
++;

3789 
j
 = 0;

3791 
j
++;

3794 
	`Ârötf
(
out
, "};\n"); 
löío
++;

3797 
	`Ârötf
(
out
, "#deföêYY_REDUCE_USE_DFLT (%d)\n", 
mnNtOf°
-1); 
löío
++;

3798 
n
 = 
Àmp
->
n°©e
;

3799  
n
>0 && 
Àmp
->
s‹ãd
[n-1]->
iNtOf°
==
NO_OFFSET
 )Ç--;

3800 
	`Ârötf
(
out
, "#deföêYY_REDUCE_COUNT (%d)\n", 
n
-1); 
löío
++;

3801 
	`Ârötf
(
out
, "#deföêYY_REDUCE_MIN (%d)\n", 
mnNtOf°
); 
löío
++;

3802 
	`Ârötf
(
out
, "#deföêYY_REDUCE_MAX (%d)\n", 
mxNtOf°
); 
löío
++;

3803 
	`Ârötf
(
out
, "static const %s yy_reduce_ofst[] = {\n",

3804 
	`möimum_size_ty≥
(
mnNtOf°
-1, 
mxNtOf°
)); 
löío
++;

3805 
i
=
j
=0; i<
n
; i++){

3806 
of°
;

3807 
°p
 = 
Àmp
->
s‹ãd
[
i
];

3808 
of°
 = 
°p
->
iNtOf°
;

3809 if–
of°
==
NO_OFFSET
 ) of° = 
mnNtOf°
 - 1;

3810 if–
j
==0 ) 
	`Ârötf
(
out
," /* %5d */ ", 
i
);

3811 
	`Ârötf
(
out
, " %4d,", 
of°
);

3812 if–
j
==9 || 
i
==
n
-1 ){

3813 
	`Ârötf
(
out
, "\n"); 
löío
++;

3814 
j
 = 0;

3816 
j
++;

3819 
	`Ârötf
(
out
, "};\n"); 
löío
++;

3822 
	`Ârötf
(
out
, "°©i¯c⁄° YYACTIONTYPE yy_deÁu…[] = {\n"); 
löío
++;

3823 
n
 = 
Àmp
->
n°©e
;

3824 
i
=
j
=0; i<
n
; i++){

3825 
°p
 = 
Àmp
->
s‹ãd
[
i
];

3826 if–
j
==0 ) 
	`Ârötf
(
out
," /* %5d */ ", 
i
);

3827 
	`Ârötf
(
out
, " %4d,", 
°p
->
iDÊt
);

3828 if–
j
==9 || 
i
==
n
-1 ){

3829 
	`Ârötf
(
out
, "\n"); 
löío
++;

3830 
j
 = 0;

3832 
j
++;

3835 
	`Ârötf
(
out
, "};\n"); 
löío
++;

3836 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3840 if–
Àmp
->
has_ÁŒback
 ){

3841 
mx
 = 
Àmp
->
¡îmöÆ
 - 1;

3842  
mx
>0 && 
Àmp
->
symbﬁs
[mx]->
ÁŒback
==0 ){ mx--; }

3843 
i
=0; i<=
mx
; i++){

3844 
symbﬁ
 *
p
 = 
Àmp
->
symbﬁs
[
i
];

3845 if–
p
->
ÁŒback
==0 ){

3846 
	`Ârötf
(
out
, " 0, /* %10†=>ÇŸhög */\n", 
p
->
«me
);

3848 
	`Ârötf
(
out
, " %3d, /* %10†=> %†*/\n", 
p
->
ÁŒback
->
ödex
,

3849 
p
->
«me
,Ö->
ÁŒback
->name);

3851 
löío
++;

3854 
	`ç…_x„r
(
Àmp
->
«me
, 
ö
, 
out
, &
löío
);

3858 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

3859 
	`•rötf
(
löe
,"\"%s\",",
Àmp
->
symbﬁs
[
i
]->
«me
);

3860 
	`Ârötf
(
out
," %-15s",
löe
);

3861 if–(
i
&3)==3 ){ 
	`Ârötf
(
out
,"\n"); 
löío
++; }

3863 if–(
i
&3)!=0 ){ 
	`Ârötf
(
out
,"\n"); 
löío
++; }

3864 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3870 
i
=0, 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
, i++){

3871 
	`as£π
–
Ω
->
ödex
==
i
 );

3872 
	`Ârötf
(
out
," /* %3d */ \"", 
i
);

3873 
	`wrôeRuÀText
(
out
, 
Ω
);

3874 
	`Ârötf
(
out
,"\",\n"); 
löío
++;

3876 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3882 if–
Àmp
->
tokíde°
 ){

3883 
⁄˚
 = 1;

3884 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

3885 
symbﬁ
 *
•
 = 
Àmp
->
symbﬁs
[
i
];

3886 if–
•
==0 || sp->
ty≥
!=
TERMINAL
 ) ;

3887 if–
⁄˚
 ){

3888 
	`Ârötf
(
out
, " /* TERMINAL De°ru˘‹ */\n"); 
löío
++;

3889 
⁄˚
 = 0;

3891 
	`Ârötf
(
out
," ca£ %d: /* %†*/\n", 
•
->
ödex
, sp->
«me
); 
löío
++;

3893 
i
=0; i<
Àmp
->
nsymbﬁ
 &&Üemp->
symbﬁs
[i]->
ty≥
!=
TERMINAL
; i++);

3894 if–
i
<
Àmp
->
nsymbﬁ
 ){

3895 
	`emô_de°ru˘‹_code
(
out
,
Àmp
->
symbﬁs
[
i
],Àmp,&
löío
);

3896 
	`Ârötf
(
out
," bªak;\n"); 
löío
++;

3899 if–
Àmp
->
v¨de°
 ){

3900 
symbﬁ
 *
dÊt_•
 = 0;

3901 
⁄˚
 = 1;

3902 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

3903 
symbﬁ
 *
•
 = 
Àmp
->
symbﬁs
[
i
];

3904 if–
•
==0 || sp->
ty≥
==
TERMINAL
 ||

3905 
•
->
ödex
<=0 || sp->
de°ru˘‹
!=0 ) ;

3906 if–
⁄˚
 ){

3907 
	`Ârötf
(
out
, " /* DeÁu… NON-TERMINAL De°ru˘‹ */\n"); 
löío
++;

3908 
⁄˚
 = 0;

3910 
	`Ârötf
(
out
," ca£ %d: /* %†*/\n", 
•
->
ödex
, sp->
«me
); 
löío
++;

3911 
dÊt_•
 = 
•
;

3913 if–
dÊt_•
!=0 ){

3914 
	`emô_de°ru˘‹_code
(
out
,
dÊt_•
,
Àmp
,&
löío
);

3916 
	`Ârötf
(
out
," bªak;\n"); 
löío
++;

3918 
i
=0; i<
Àmp
->
nsymbﬁ
; i++){

3919 
symbﬁ
 *
•
 = 
Àmp
->
symbﬁs
[
i
];

3920 if–
•
==0 || sp->
ty≥
==
TERMINAL
 || sp->
de°ru˘‹
==0 ) ;

3921 
	`Ârötf
(
out
," ca£ %d: /* %†*/\n", 
•
->
ödex
, sp->
«me
); 
löío
++;

3924 
j
=
i
+1; j<
Àmp
->
nsymbﬁ
; j++){

3925 
symbﬁ
 *
•2
 = 
Àmp
->
symbﬁs
[
j
];

3926 if–
•2
 && sp2->
ty≥
!=
TERMINAL
 && sp2->
de°ru˘‹


3927 && 
•2
->
däum
==
•
->dtnum

3928 && 
	`°rcmp
(
•
->
de°ru˘‹
,
•2
->destructor)==0 ){

3929 
	`Ârötf
(
out
," case %d: /* %s */\n",

3930 
•2
->
ödex
, sp2->
«me
); 
löío
++;

3931 
•2
->
de°ru˘‹
 = 0;

3935 
	`emô_de°ru˘‹_code
(
out
,
Àmp
->
symbﬁs
[
i
],Àmp,&
löío
);

3936 
	`Ârötf
(
out
," bªak;\n"); 
löío
++;

3938 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3941 
	`ç…_¥öt
(
out
,
Àmp
,Àmp->
ovîÊow
,&
löío
);

3942 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3949 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

3950 
	`Ârötf
(
out
," { %d, %d },\n",
Ω
->
lhs
->
ödex
,Ω->
ƒhs
); 
löío
++;

3952 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3955 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

3956 
	`å™¶©e_code
(
Àmp
, 
Ω
);

3959 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

3960 
ruÀ
 *
Ω2
;

3961 if–
Ω
->
code
==0 ) ;

3962 if–
Ω
->
code
[0]=='\n' &&Ñp->code[1]==0 ) ;

3963 
	`Ârötf
(
out
," ca£ %d: /* ", 
Ω
->
ödex
);

3964 
	`wrôeRuÀText
(
out
, 
Ω
);

3965 
	`Ârötf
(
out
, " */\n"); 
löío
++;

3966 
Ω2
=
Ω
->
√xt
;Ñp2;Ñp2=rp2->next){

3967 if–
Ω2
->
code
==
Ω
->code ){

3968 
	`Ârötf
(
out
," ca£ %d: /* ", 
Ω2
->
ödex
);

3969 
	`wrôeRuÀText
(
out
, 
Ω2
);

3970 
	`Ârötf
(
out
," */ yyã°ˇ£(yyruÀno==%d);\n", 
Ω2
->
ödex
); 
löío
++;

3971 
Ω2
->
code
 = 0;

3974 
	`emô_code
(
out
,
Ω
,
Àmp
,&
löío
);

3975 
	`Ârötf
(
out
," bªak;\n"); 
löío
++;

3976 
Ω
->
code
 = 0;

3980 
	`Ârötf
(
out
," deÁu…:\n"); 
löío
++;

3981 
Ω
=
Àmp
->
ruÀ
;Ñp;ÑpÙp->
√xt
){

3982 if–
Ω
->
code
==0 ) ;

3983 
	`as£π
–
Ω
->
code
[0]=='\n' &&Ñp->code[1]==0 );

3984 
	`Ârötf
(
out
," /* (%dË", 
Ω
->
ödex
);

3985 
	`wrôeRuÀText
(
out
, 
Ω
);

3986 
	`Ârötf
(
out
, " */ yyã°ˇ£(yyruÀno==%d);\n", 
Ω
->
ödex
); 
löío
++;

3988 
	`Ârötf
(
out
," bªak;\n"); 
löío
++;

3989 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3992 
	`ç…_¥öt
(
out
,
Àmp
,Àmp->
Áûuª
,&
löío
);

3993 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

3996 
	`ç…_¥öt
(
out
,
Àmp
,Àmp->
îr‹
,&
löío
);

3997 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

4000 
	`ç…_¥öt
(
out
,
Àmp
,Àmp->
ac˚±
,&
löío
);

4001 
	`ç…_x„r
(
Àmp
->
«me
,
ö
,
out
,&
löío
);

4004 
	`ç…_¥öt
(
out
,
Àmp
,Àmp->
exåacode
,&
löío
);

4006 
	`f˛o£
(
ö
);

4007 
	`f˛o£
(
out
);

4009 
	}
}

4012 
	$Rï‹tHódî
(
Àm⁄
 *
Àmp
)

4014 
FILE
 *
out
, *
ö
;

4015 c⁄° *
¥efix
;

4016 
löe
[
LINESIZE
];

4017 
∑âîn
[
LINESIZE
];

4018 
i
;

4020 if–
Àmp
->
tokí¥efix
 ) 
¥efix
 =Üemp->tokenprefix;

4021 
¥efix
 = "";

4022 
ö
 = 
	`fûe_›í
(
Àmp
,".h","rb");

4023 if–
ö
 ){

4024 
i
=1; i<
Àmp
->
¡îmöÆ
 && 
	`fgës
(
löe
,
LINESIZE
,
ö
); i++){

4025 
	`•rötf
(
∑âîn
,"#deföê%s%-30†%2d\n",
¥efix
,
Àmp
->
symbﬁs
[
i
]->
«me
,i);

4026 if–
	`°rcmp
(
löe
,
∑âîn
) ) ;

4028 
	`f˛o£
(
ö
);

4029 if–
i
==
Àmp
->
¡îmöÆ
 ){

4034 
out
 = 
	`fûe_›í
(
Àmp
,".h","wb");

4035 if–
out
 ){

4036 
i
=1; i<
Àmp
->
¡îmöÆ
; i++){

4037 
	`Ârötf
(
out
,"#deföê%s%-30†%2d\n",
¥efix
,
Àmp
->
symbﬁs
[
i
]->
«me
,i);

4039 
	`f˛o£
(
out
);

4042 
	}
}

4051 
	$Com¥essTabÀs
(
Àm⁄
 *
Àmp
)

4053 
°©e
 *
°p
;

4054 
a˘i⁄
 *
≠
, *
≠2
;

4055 
ruÀ
 *
Ω
, *
Ω2
, *
rbe°
;

4056 
nbe°
, 
n
;

4057 
i
;

4058 
u£sWûdˇrd
;

4060 
i
=0; i<
Àmp
->
n°©e
; i++){

4061 
°p
 = 
Àmp
->
s‹ãd
[
i
];

4062 
nbe°
 = 0;

4063 
rbe°
 = 0;

4064 
u£sWûdˇrd
 = 0;

4066 
≠
=
°p
->≠;áp;áp˜p->
√xt
){

4067 if–
≠
->
ty≥
==
SHIFT
 &&áp->
•
==
Àmp
->
wûdˇrd
 ){

4068 
u£sWûdˇrd
 = 1;

4070 if–
≠
->
ty≥
!=
REDUCE
 ) ;

4071 
Ω
 = 
≠
->
x
.rp;

4072 if–
Ω
->
lhsSèπ
 ) ;

4073 if–
Ω
==
rbe°
 ) ;

4074 
n
 = 1;

4075 
≠2
=
≠
->
√xt
;áp2;áp2=ap2->next){

4076 if–
≠2
->
ty≥
!=
REDUCE
 ) ;

4077 
Ω2
 = 
≠2
->
x
.
Ω
;

4078 if–
Ω2
==
rbe°
 ) ;

4079 if–
Ω2
==
Ω
 ) 
n
++;

4081 if–
n
>
nbe°
 ){

4082 
nbe°
 = 
n
;

4083 
rbe°
 = 
Ω
;

4091 if–
nbe°
<1 || 
u£sWûdˇrd
 ) ;

4095 
≠
=
°p
->≠;áp;áp˜p->
√xt
){

4096 if–
≠
->
ty≥
==
REDUCE
 &&áp->
x
.
Ω
==
rbe°
 ) ;

4098 
	`as£π
–
≠
 );

4099 
≠
->
•
 = 
	`Symbﬁ_√w
("{default}");

4100 
≠
˜p->
√xt
;áp;áp=ap->next){

4101 if–
≠
->
ty≥
==
REDUCE
 &&áp->
x
.
Ω
==
rbe°
 )áp->ty≥ = 
NOT_USED
;

4103 
°p
->
≠
 = 
	`A˘i⁄_s‹t
(stp->ap);

4105 
	}
}

4114 
	$°©eRes‹tCom∑ª
(c⁄° *
a
, c⁄° *
b
){

4115 c⁄° 
°©e
 *
pA
 = *(c⁄° °©e**)
a
;

4116 c⁄° 
°©e
 *
pB
 = *(c⁄° °©e**)
b
;

4117 
n
;

4119 
n
 = 
pB
->
nNtA˘
 - 
pA
->nNtAct;

4120 if–
n
==0 ){

4121 
n
 = 
pB
->
nTknA˘
 - 
pA
->nTknAct;

4122 if–
n
==0 ){

4123 
n
 = 
pB
->
°©íum
 - 
pA
->statenum;

4126 
	`as£π
–
n
!=0 );

4127  
n
;

4128 
	}
}

4135 
	$Res‹tSèãs
(
Àm⁄
 *
Àmp
)

4137 
i
;

4138 
°©e
 *
°p
;

4139 
a˘i⁄
 *
≠
;

4141 
i
=0; i<
Àmp
->
n°©e
; i++){

4142 
°p
 = 
Àmp
->
s‹ãd
[
i
];

4143 
°p
->
nTknA˘
 = sç->
nNtA˘
 = 0;

4144 
°p
->
iDÊt
 = 
Àmp
->
n°©e
 +Üemp->
ƒuÀ
;

4145 
°p
->
iTknOf°
 = 
NO_OFFSET
;

4146 
°p
->
iNtOf°
 = 
NO_OFFSET
;

4147 
≠
=
°p
->≠;áp;áp˜p->
√xt
){

4148 if–
	`compuã_a˘i⁄
(
Àmp
,
≠
)>=0 ){

4149 if–
≠
->
•
->
ödex
<
Àmp
->
¡îmöÆ
 ){

4150 
°p
->
nTknA˘
++;

4151 }if–
≠
->
•
->
ödex
<
Àmp
->
nsymbﬁ
 ){

4152 
°p
->
nNtA˘
++;

4154 
°p
->
iDÊt
 = 
	`compuã_a˘i⁄
(
Àmp
, 
≠
);

4159 
	`qs‹t
(&
Àmp
->
s‹ãd
[1],Üemp->
n°©e
-1, (lemp->sorted[0]),

4160 
°©eRes‹tCom∑ª
);

4161 
i
=0; i<
Àmp
->
n°©e
; i++){

4162 
Àmp
->
s‹ãd
[
i
]->
°©íum
 = i;

4164 
	}
}

4172 
	gsize
 = 0;

4175 
	$SëSize
(
n
)

4177 
size
 = 
n
+1;

4178 
	}
}

4181 *
	$SëNew
(){

4182 *
s
;

4183 
s
 = (*)
	`ˇŒoc
–
size
, 1);

4184 if–
s
==0 ){

4185 
	`mem‹y_îr‹
();

4186 
	`mem‹y_îr‹
();

4188  
s
;

4189 
	}
}

4192 
	$SëFªe
(*
s
)

4194 
	`‰ì
(
s
);

4195 
	}
}

4199 
	$SëAdd
(*
s
, 
e
)

4201 
rv
;

4202 
	`as£π
–
e
>=0 &&É<
size
 );

4203 
rv
 = 
s
[
e
];

4204 
s
[
e
] = 1;

4205  !
rv
;

4206 
	}
}

4209 
	$SëUni⁄
(*
s1
, *
s2
)

4211 
i
, 
¥ogªss
;

4212 
¥ogªss
 = 0;

4213 
i
=0; i<
size
; i++){

4214 if–
s2
[
i
]==0 ) ;

4215 if–
s1
[
i
]==0 ){

4216 
¥ogªss
 = 1;

4217 
s1
[
i
] = 1;

4220  
¥ogªss
;

4221 
	}
}

4235 
PRIVATE
 
	$°rhash
(c⁄° *
x
)

4237 
h
 = 0;

4238  *
x
Ë
h
 = h*13 + *(x++);

4239  
h
;

4240 
	}
}

4246 c⁄° *
	$Såß„
(c⁄° *
y
)

4248 c⁄° *
z
;

4249 *
˝y
;

4251 if–
y
==0 )  0;

4252 
z
 = 
	`Såß„_föd
(
y
);

4253 if–
z
==0 && (
˝y
=(*)
	`mÆloc
–
	`Àm⁄SåÀn
(
y
)+1 ))!=0 ){

4254 
	`°r˝y
(
˝y
,
y
);

4255 
z
 = 
˝y
;

4256 
	`Såß„_ö£π
(
z
);

4258 
	`Mem‹yCheck
(
z
);

4259  
z
;

4260 
	}
}

4265 
	ss_x1
 {

4266 
	msize
;

4269 
	mcou¡
;

4270 
s_x1node
 *
	mtbl
;

4271 
s_x1node
 **
	mht
;

4277 
	ss_x1node
 {

4278 c⁄° *
	md©a
;

4279 
s_x1node
 *
	m√xt
;

4280 
s_x1node
 **
	m‰om
;

4281 } 
	tx1node
;

4284 
s_x1
 *
	gx1a
;

4287 
	$Såß„_öô
(){

4288 if–
x1a
 ) ;

4289 
x1a
 = (
s_x1
*)
	`mÆloc
( (s_x1) );

4290 if–
x1a
 ){

4291 
x1a
->
size
 = 1024;

4292 
x1a
->
cou¡
 = 0;

4293 
x1a
->
tbl
 = (
x1node
*)
	`mÆloc
(

4294 ((
x1node
) + (x1node*))*1024 );

4295 if–
x1a
->
tbl
==0 ){

4296 
	`‰ì
(
x1a
);

4297 
x1a
 = 0;

4299 
i
;

4300 
x1a
->
ht
 = (
x1node
**)&(x1a->
tbl
[1024]);

4301 
i
=0; i<1024; i++Ë
x1a
->
ht
[i] = 0;

4304 
	}
}

4307 
	$Såß„_ö£π
(c⁄° *
d©a
)

4309 
x1node
 *
≈
;

4310 
h
;

4311 
ph
;

4313 if–
x1a
==0 )  0;

4314 
ph
 = 
	`°rhash
(
d©a
);

4315 
h
 = 
ph
 & (
x1a
->
size
-1);

4316 
≈
 = 
x1a
->
ht
[
h
];

4317  
≈
 ){

4318 if–
	`°rcmp
(
≈
->
d©a
,data)==0 ){

4323 
≈
 =Çp->
√xt
;

4325 if–
x1a
->
cou¡
>=x1a->
size
 ){

4327 
i
,
size
;

4328 
s_x1
 
¨øy
;

4329 
¨øy
.
size
 = sizê
x1a
->size*2;

4330 
¨øy
.
cou¡
 = 
x1a
->count;

4331 
¨øy
.
tbl
 = (
x1node
*)
	`mÆloc
(

4332 ((
x1node
Ë+ (x1node*))*
size
 );

4333 if–
¨øy
.
tbl
==0 )  0;

4334 
¨øy
.
ht
 = (
x1node
**)&◊ºay.
tbl
[
size
]);

4335 
i
=0; i<
size
; i++Ë
¨øy
.
ht
[i] = 0;

4336 
i
=0; i<
x1a
->
cou¡
; i++){

4337 
x1node
 *
ﬁd≈
, *
√w≈
;

4338 
ﬁd≈
 = &(
x1a
->
tbl
[
i
]);

4339 
h
 = 
	`°rhash
(
ﬁd≈
->
d©a
Ë& (
size
-1);

4340 
√w≈
 = &(
¨øy
.
tbl
[
i
]);

4341 if–
¨øy
.
ht
[
h
] )áºay.ht[h]->
‰om
 = &(
√w≈
->
√xt
);

4342 
√w≈
->
√xt
 = 
¨øy
.
ht
[
h
];

4343 
√w≈
->
d©a
 = 
ﬁd≈
->data;

4344 
√w≈
->
‰om
 = &(
¨øy
.
ht
[
h
]);

4345 
¨øy
.
ht
[
h
] = 
√w≈
;

4347 
	`‰ì
(
x1a
->
tbl
);

4348 *
x1a
 = 
¨øy
;

4351 
h
 = 
ph
 & (
x1a
->
size
-1);

4352 
≈
 = &(
x1a
->
tbl
[x1a->
cou¡
++]);

4353 
≈
->
d©a
 = data;

4354 if–
x1a
->
ht
[
h
] ) x1a->ht[h]->
‰om
 = &(
≈
->
√xt
);

4355 
≈
->
√xt
 = 
x1a
->
ht
[
h
];

4356 
x1a
->
ht
[
h
] = 
≈
;

4357 
≈
->
‰om
 = &(
x1a
->
ht
[
h
]);

4359 
	}
}

4363 c⁄° *
	$Såß„_föd
(c⁄° *
key
)

4365 
h
;

4366 
x1node
 *
≈
;

4368 if–
x1a
==0 )  0;

4369 
h
 = 
	`°rhash
(
key
Ë& (
x1a
->
size
-1);

4370 
≈
 = 
x1a
->
ht
[
h
];

4371  
≈
 ){

4372 if–
	`°rcmp
(
≈
->
d©a
,
key
)==0 ) ;

4373 
≈
 =Çp->
√xt
;

4375  
≈
 ?Çp->
d©a
 : 0;

4376 
	}
}

4381 
symbﬁ
 *
	$Symbﬁ_√w
(c⁄° *
x
)

4383 
symbﬁ
 *
•
;

4385 
•
 = 
	`Symbﬁ_föd
(
x
);

4386 if–
•
==0 ){

4387 
•
 = (
symbﬁ
 *)
	`ˇŒoc
(1, (symbol) );

4388 
	`Mem‹yCheck
(
•
);

4389 
•
->
«me
 = 
	`Såß„
(
x
);

4390 
•
->
ty≥
 = 
	`isuµî
(*
x
Ë? 
TERMINAL
 : 
NONTERMINAL
;

4391 
•
->
ruÀ
 = 0;

4392 
•
->
ÁŒback
 = 0;

4393 
•
->
¥ec
 = -1;

4394 
•
->
assoc
 = 
UNK
;

4395 
•
->
fú°£t
 = 0;

4396 
•
->
œmbda
 = 
LEMON_FALSE
;

4397 
•
->
de°ru˘‹
 = 0;

4398 
•
->
de°Löío
 = 0;

4399 
•
->
d©©y≥
 = 0;

4400 
•
->
u£C¡
 = 0;

4401 
	`Symbﬁ_ö£π
(
•
,•->
«me
);

4403 
•
->
u£C¡
++;

4404  
•
;

4405 
	}
}

4417 
	$Symbﬁcmµ
(c⁄° *
_a
, c⁄° *
_b
)

4419 c⁄° 
symbﬁ
 **
a
 = (c⁄° symbﬁ **Ë
_a
;

4420 c⁄° 
symbﬁ
 **
b
 = (c⁄° symbﬁ **Ë
_b
;

4421 
i1
 = (**
a
).
ödex
 + 10000000*((**a).
«me
[0]>'Z');

4422 
i2
 = (**
b
).
ödex
 + 10000000*((**b).
«me
[0]>'Z');

4423 
	`as£π
–
i1
!=
i2
 || 
	`°rcmp
((**
a
).
«me
,(**
b
).name)==0 );

4424  
i1
-
i2
;

4425 
	}
}

4430 
	ss_x2
 {

4431 
	msize
;

4434 
	mcou¡
;

4435 
s_x2node
 *
	mtbl
;

4436 
s_x2node
 **
	mht
;

4442 
	ss_x2node
 {

4443 
symbﬁ
 *
	md©a
;

4444 c⁄° *
	mkey
;

4445 
s_x2node
 *
	m√xt
;

4446 
s_x2node
 **
	m‰om
;

4447 } 
	tx2node
;

4450 
s_x2
 *
	gx2a
;

4453 
	$Symbﬁ_öô
(){

4454 if–
x2a
 ) ;

4455 
x2a
 = (
s_x2
*)
	`mÆloc
( (s_x2) );

4456 if–
x2a
 ){

4457 
x2a
->
size
 = 128;

4458 
x2a
->
cou¡
 = 0;

4459 
x2a
->
tbl
 = (
x2node
*)
	`mÆloc
(

4460 ((
x2node
) + (x2node*))*128 );

4461 if–
x2a
->
tbl
==0 ){

4462 
	`‰ì
(
x2a
);

4463 
x2a
 = 0;

4465 
i
;

4466 
x2a
->
ht
 = (
x2node
**)&(x2a->
tbl
[128]);

4467 
i
=0; i<128; i++Ë
x2a
->
ht
[i] = 0;

4470 
	}
}

4473 
	$Symbﬁ_ö£π
(
symbﬁ
 *
d©a
, c⁄° *
key
)

4475 
x2node
 *
≈
;

4476 
h
;

4477 
ph
;

4479 if–
x2a
==0 )  0;

4480 
ph
 = 
	`°rhash
(
key
);

4481 
h
 = 
ph
 & (
x2a
->
size
-1);

4482 
≈
 = 
x2a
->
ht
[
h
];

4483  
≈
 ){

4484 if–
	`°rcmp
(
≈
->
key
,key)==0 ){

4489 
≈
 =Çp->
√xt
;

4491 if–
x2a
->
cou¡
>=x2a->
size
 ){

4493 
i
,
size
;

4494 
s_x2
 
¨øy
;

4495 
¨øy
.
size
 = sizê
x2a
->size*2;

4496 
¨øy
.
cou¡
 = 
x2a
->count;

4497 
¨øy
.
tbl
 = (
x2node
*)
	`mÆloc
(

4498 ((
x2node
Ë+ (x2node*))*
size
 );

4499 if–
¨øy
.
tbl
==0 )  0;

4500 
¨øy
.
ht
 = (
x2node
**)&◊ºay.
tbl
[
size
]);

4501 
i
=0; i<
size
; i++Ë
¨øy
.
ht
[i] = 0;

4502 
i
=0; i<
x2a
->
cou¡
; i++){

4503 
x2node
 *
ﬁd≈
, *
√w≈
;

4504 
ﬁd≈
 = &(
x2a
->
tbl
[
i
]);

4505 
h
 = 
	`°rhash
(
ﬁd≈
->
key
Ë& (
size
-1);

4506 
√w≈
 = &(
¨øy
.
tbl
[
i
]);

4507 if–
¨øy
.
ht
[
h
] )áºay.ht[h]->
‰om
 = &(
√w≈
->
√xt
);

4508 
√w≈
->
√xt
 = 
¨øy
.
ht
[
h
];

4509 
√w≈
->
key
 = 
ﬁd≈
->key;

4510 
√w≈
->
d©a
 = 
ﬁd≈
->data;

4511 
√w≈
->
‰om
 = &(
¨øy
.
ht
[
h
]);

4512 
¨øy
.
ht
[
h
] = 
√w≈
;

4514 
	`‰ì
(
x2a
->
tbl
);

4515 *
x2a
 = 
¨øy
;

4518 
h
 = 
ph
 & (
x2a
->
size
-1);

4519 
≈
 = &(
x2a
->
tbl
[x2a->
cou¡
++]);

4520 
≈
->
key
 = key;

4521 
≈
->
d©a
 = data;

4522 if–
x2a
->
ht
[
h
] ) x2a->ht[h]->
‰om
 = &(
≈
->
√xt
);

4523 
≈
->
√xt
 = 
x2a
->
ht
[
h
];

4524 
x2a
->
ht
[
h
] = 
≈
;

4525 
≈
->
‰om
 = &(
x2a
->
ht
[
h
]);

4527 
	}
}

4531 
symbﬁ
 *
	$Symbﬁ_föd
(c⁄° *
key
)

4533 
h
;

4534 
x2node
 *
≈
;

4536 if–
x2a
==0 )  0;

4537 
h
 = 
	`°rhash
(
key
Ë& (
x2a
->
size
-1);

4538 
≈
 = 
x2a
->
ht
[
h
];

4539  
≈
 ){

4540 if–
	`°rcmp
(
≈
->
key
,key)==0 ) ;

4541 
≈
 =Çp->
√xt
;

4543  
≈
 ?Çp->
d©a
 : 0;

4544 
	}
}

4547 
symbﬁ
 *
	$Symbﬁ_Nth
(
n
)

4549 
symbﬁ
 *
d©a
;

4550 if–
x2a
 && 
n
>0 &&Ç<=x2a->
cou¡
 ){

4551 
d©a
 = 
x2a
->
tbl
[
n
-1].data;

4553 
d©a
 = 0;

4555  
d©a
;

4556 
	}
}

4559 
	$Symbﬁ_cou¡
()

4561  
x2a
 ? x2a->
cou¡
 : 0;

4562 
	}
}

4567 
symbﬁ
 **
	$Symbﬁ_¨øyof
()

4569 
symbﬁ
 **
¨øy
;

4570 
i
,
size
;

4571 if–
x2a
==0 )  0;

4572 
size
 = 
x2a
->
cou¡
;

4573 
¨øy
 = (
symbﬁ
 **)
	`ˇŒoc
(
size
, (symbol *));

4574 if–
¨øy
 ){

4575 
i
=0; i<
size
; i++Ë
¨øy
[i] = 
x2a
->
tbl
[i].
d©a
;

4577  
¨øy
;

4578 
	}
}

4581 
	$C⁄figcmp
(c⁄° *
_a
,c⁄° *
_b
)

4583 c⁄° 
c⁄fig
 *
a
 = (c⁄fig *Ë
_a
;

4584 c⁄° 
c⁄fig
 *
b
 = (c⁄fig *Ë
_b
;

4585 
x
;

4586 
x
 = 
a
->
Ω
->
ödex
 - 
b
->rp->index;

4587 if–
x
==0 ) x = 
a
->
dŸ
 - 
b
->dot;

4588  
x
;

4589 
	}
}

4592 
PRIVATE
 
	$°©ecmp
(
c⁄fig
 *
a
, c⁄fig *
b
)

4594 
rc
;

4595 
rc
=0;Ñc==0 && 
a
 && 
b
;á˜->
bp
, b=b->bp){

4596 
rc
 = 
a
->
Ω
->
ödex
 - 
b
->rp->index;

4597 if–
rc
==0 )Ñ¯
a
->
dŸ
 - 
b
->dot;

4599 if–
rc
==0 ){

4600 if–
a
 ) 
rc
 = 1;

4601 if–
b
 ) 
rc
 = -1;

4603  
rc
;

4604 
	}
}

4607 
PRIVATE
 
	$°©ehash
(
c⁄fig
 *
a
)

4609 
h
=0;

4610  
a
 ){

4611 
h
 = h*571 + 
a
->
Ω
->
ödex
*37 +á->
dŸ
;

4612 
a
 =á->
bp
;

4614  
h
;

4615 
	}
}

4618 
°©e
 *
	$Sèã_√w
()

4620 
°©e
 *
√w°©e
;

4621 
√w°©e
 = (
°©e
 *)
	`ˇŒoc
(1, (state) );

4622 
	`Mem‹yCheck
(
√w°©e
);

4623  
√w°©e
;

4624 
	}
}

4629 
	ss_x3
 {

4630 
	msize
;

4633 
	mcou¡
;

4634 
s_x3node
 *
	mtbl
;

4635 
s_x3node
 **
	mht
;

4641 
	ss_x3node
 {

4642 
°©e
 *
	md©a
;

4643 
c⁄fig
 *
	mkey
;

4644 
s_x3node
 *
	m√xt
;

4645 
s_x3node
 **
	m‰om
;

4646 } 
	tx3node
;

4649 
s_x3
 *
	gx3a
;

4652 
	$Sèã_öô
(){

4653 if–
x3a
 ) ;

4654 
x3a
 = (
s_x3
*)
	`mÆloc
( (s_x3) );

4655 if–
x3a
 ){

4656 
x3a
->
size
 = 128;

4657 
x3a
->
cou¡
 = 0;

4658 
x3a
->
tbl
 = (
x3node
*)
	`mÆloc
(

4659 ((
x3node
) + (x3node*))*128 );

4660 if–
x3a
->
tbl
==0 ){

4661 
	`‰ì
(
x3a
);

4662 
x3a
 = 0;

4664 
i
;

4665 
x3a
->
ht
 = (
x3node
**)&(x3a->
tbl
[128]);

4666 
i
=0; i<128; i++Ë
x3a
->
ht
[i] = 0;

4669 
	}
}

4672 
	$Sèã_ö£π
(
°©e
 *
d©a
, 
c⁄fig
 *
key
)

4674 
x3node
 *
≈
;

4675 
h
;

4676 
ph
;

4678 if–
x3a
==0 )  0;

4679 
ph
 = 
	`°©ehash
(
key
);

4680 
h
 = 
ph
 & (
x3a
->
size
-1);

4681 
≈
 = 
x3a
->
ht
[
h
];

4682  
≈
 ){

4683 if–
	`°©ecmp
(
≈
->
key
,key)==0 ){

4688 
≈
 =Çp->
√xt
;

4690 if–
x3a
->
cou¡
>=x3a->
size
 ){

4692 
i
,
size
;

4693 
s_x3
 
¨øy
;

4694 
¨øy
.
size
 = sizê
x3a
->size*2;

4695 
¨øy
.
cou¡
 = 
x3a
->count;

4696 
¨øy
.
tbl
 = (
x3node
*)
	`mÆloc
(

4697 ((
x3node
Ë+ (x3node*))*
size
 );

4698 if–
¨øy
.
tbl
==0 )  0;

4699 
¨øy
.
ht
 = (
x3node
**)&◊ºay.
tbl
[
size
]);

4700 
i
=0; i<
size
; i++Ë
¨øy
.
ht
[i] = 0;

4701 
i
=0; i<
x3a
->
cou¡
; i++){

4702 
x3node
 *
ﬁd≈
, *
√w≈
;

4703 
ﬁd≈
 = &(
x3a
->
tbl
[
i
]);

4704 
h
 = 
	`°©ehash
(
ﬁd≈
->
key
Ë& (
size
-1);

4705 
√w≈
 = &(
¨øy
.
tbl
[
i
]);

4706 if–
¨øy
.
ht
[
h
] )áºay.ht[h]->
‰om
 = &(
√w≈
->
√xt
);

4707 
√w≈
->
√xt
 = 
¨øy
.
ht
[
h
];

4708 
√w≈
->
key
 = 
ﬁd≈
->key;

4709 
√w≈
->
d©a
 = 
ﬁd≈
->data;

4710 
√w≈
->
‰om
 = &(
¨øy
.
ht
[
h
]);

4711 
¨øy
.
ht
[
h
] = 
√w≈
;

4713 
	`‰ì
(
x3a
->
tbl
);

4714 *
x3a
 = 
¨øy
;

4717 
h
 = 
ph
 & (
x3a
->
size
-1);

4718 
≈
 = &(
x3a
->
tbl
[x3a->
cou¡
++]);

4719 
≈
->
key
 = key;

4720 
≈
->
d©a
 = data;

4721 if–
x3a
->
ht
[
h
] ) x3a->ht[h]->
‰om
 = &(
≈
->
√xt
);

4722 
≈
->
√xt
 = 
x3a
->
ht
[
h
];

4723 
x3a
->
ht
[
h
] = 
≈
;

4724 
≈
->
‰om
 = &(
x3a
->
ht
[
h
]);

4726 
	}
}

4730 
°©e
 *
	$Sèã_föd
(
c⁄fig
 *
key
)

4732 
h
;

4733 
x3node
 *
≈
;

4735 if–
x3a
==0 )  0;

4736 
h
 = 
	`°©ehash
(
key
Ë& (
x3a
->
size
-1);

4737 
≈
 = 
x3a
->
ht
[
h
];

4738  
≈
 ){

4739 if–
	`°©ecmp
(
≈
->
key
,key)==0 ) ;

4740 
≈
 =Çp->
√xt
;

4742  
≈
 ?Çp->
d©a
 : 0;

4743 
	}
}

4748 
°©e
 **
	$Sèã_¨øyof
()

4750 
°©e
 **
¨øy
;

4751 
i
,
size
;

4752 if–
x3a
==0 )  0;

4753 
size
 = 
x3a
->
cou¡
;

4754 
¨øy
 = (
°©e
 **)
	`mÆloc
–(°©ê*)*
size
 );

4755 if–
¨øy
 ){

4756 
i
=0; i<
size
; i++Ë
¨øy
[i] = 
x3a
->
tbl
[i].
d©a
;

4758  
¨øy
;

4759 
	}
}

4762 
PRIVATE
 
	$c⁄fighash
(
c⁄fig
 *
a
)

4764 
h
=0;

4765 
h
 = h*571 + 
a
->
Ω
->
ödex
*37 +á->
dŸ
;

4766  
h
;

4767 
	}
}

4772 
	ss_x4
 {

4773 
	msize
;

4776 
	mcou¡
;

4777 
s_x4node
 *
	mtbl
;

4778 
s_x4node
 **
	mht
;

4784 
	ss_x4node
 {

4785 
c⁄fig
 *
	md©a
;

4786 
s_x4node
 *
	m√xt
;

4787 
s_x4node
 **
	m‰om
;

4788 } 
	tx4node
;

4791 
s_x4
 *
	gx4a
;

4794 
	$C⁄figèbÀ_öô
(){

4795 if–
x4a
 ) ;

4796 
x4a
 = (
s_x4
*)
	`mÆloc
( (s_x4) );

4797 if–
x4a
 ){

4798 
x4a
->
size
 = 64;

4799 
x4a
->
cou¡
 = 0;

4800 
x4a
->
tbl
 = (
x4node
*)
	`mÆloc
(

4801 ((
x4node
) + (x4node*))*64 );

4802 if–
x4a
->
tbl
==0 ){

4803 
	`‰ì
(
x4a
);

4804 
x4a
 = 0;

4806 
i
;

4807 
x4a
->
ht
 = (
x4node
**)&(x4a->
tbl
[64]);

4808 
i
=0; i<64; i++Ë
x4a
->
ht
[i] = 0;

4811 
	}
}

4814 
	$C⁄figèbÀ_ö£π
(
c⁄fig
 *
d©a
)

4816 
x4node
 *
≈
;

4817 
h
;

4818 
ph
;

4820 if–
x4a
==0 )  0;

4821 
ph
 = 
	`c⁄fighash
(
d©a
);

4822 
h
 = 
ph
 & (
x4a
->
size
-1);

4823 
≈
 = 
x4a
->
ht
[
h
];

4824  
≈
 ){

4825 if–
	`C⁄figcmp
((c⁄° *Ë
≈
->
d©a
,(const *) data)==0 ){

4830 
≈
 =Çp->
√xt
;

4832 if–
x4a
->
cou¡
>=x4a->
size
 ){

4834 
i
,
size
;

4835 
s_x4
 
¨øy
;

4836 
¨øy
.
size
 = sizê
x4a
->size*2;

4837 
¨øy
.
cou¡
 = 
x4a
->count;

4838 
¨øy
.
tbl
 = (
x4node
*)
	`mÆloc
(

4839 ((
x4node
Ë+ (x4node*))*
size
 );

4840 if–
¨øy
.
tbl
==0 )  0;

4841 
¨øy
.
ht
 = (
x4node
**)&◊ºay.
tbl
[
size
]);

4842 
i
=0; i<
size
; i++Ë
¨øy
.
ht
[i] = 0;

4843 
i
=0; i<
x4a
->
cou¡
; i++){

4844 
x4node
 *
ﬁd≈
, *
√w≈
;

4845 
ﬁd≈
 = &(
x4a
->
tbl
[
i
]);

4846 
h
 = 
	`c⁄fighash
(
ﬁd≈
->
d©a
Ë& (
size
-1);

4847 
√w≈
 = &(
¨øy
.
tbl
[
i
]);

4848 if–
¨øy
.
ht
[
h
] )áºay.ht[h]->
‰om
 = &(
√w≈
->
√xt
);

4849 
√w≈
->
√xt
 = 
¨øy
.
ht
[
h
];

4850 
√w≈
->
d©a
 = 
ﬁd≈
->data;

4851 
√w≈
->
‰om
 = &(
¨øy
.
ht
[
h
]);

4852 
¨øy
.
ht
[
h
] = 
√w≈
;

4854 
	`‰ì
(
x4a
->
tbl
);

4855 *
x4a
 = 
¨øy
;

4858 
h
 = 
ph
 & (
x4a
->
size
-1);

4859 
≈
 = &(
x4a
->
tbl
[x4a->
cou¡
++]);

4860 
≈
->
d©a
 = data;

4861 if–
x4a
->
ht
[
h
] ) x4a->ht[h]->
‰om
 = &(
≈
->
√xt
);

4862 
≈
->
√xt
 = 
x4a
->
ht
[
h
];

4863 
x4a
->
ht
[
h
] = 
≈
;

4864 
≈
->
‰om
 = &(
x4a
->
ht
[
h
]);

4866 
	}
}

4870 
c⁄fig
 *
	$C⁄figèbÀ_föd
(
c⁄fig
 *
key
)

4872 
h
;

4873 
x4node
 *
≈
;

4875 if–
x4a
==0 )  0;

4876 
h
 = 
	`c⁄fighash
(
key
Ë& (
x4a
->
size
-1);

4877 
≈
 = 
x4a
->
ht
[
h
];

4878  
≈
 ){

4879 if–
	`C⁄figcmp
((c⁄° *Ë
≈
->
d©a
,(c⁄° *Ë
key
)==0 ) ;

4880 
≈
 =Çp->
√xt
;

4882  
≈
 ?Çp->
d©a
 : 0;

4883 
	}
}

4887 
C⁄figèbÀ_˛ór
((*
f
)(
c⁄fig
 *))

4889 
i
;

4890 if–
x4a
==0 || x4a->
cou¡
==0 ) ;

4891 if–
f
 ) 
i
=0; i<
x4a
->
cou¡
; i++Ë(*f)(x4a->
tbl
[i].
d©a
);

4892 
i
=0; i<
x4a
->
size
; i++Ëx4a->
ht
[i] = 0;

4893 
x4a
->
cou¡
 = 0;

4895 
	}
}

	@tool/lempar.c

6 
	~<°dio.h
>

7 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

18 
	}
%%

21 #i‚de‡
INTERFACE


22 
	#INTERFACE
 1

	)

58 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

59 #
deföe
 
	`YY_NO_ACTION
 (
YYNSTATE
+
YYNRULE
+2)

60 #
deföe
 
	`YY_ACCEPT_ACTION
 (
YYNSTATE
+
YYNRULE
+1)

61 #
deföe
 
	`YY_ERROR_ACTION
 (
YYNSTATE
+
YYNRULE
)

65 c⁄° 
YYMINORTYPE
 
	gyyzîomö‹
 = { 0 };

75 #
i‚def
 
yyã°ˇ£


76 #
deföe
 
	`yyã°ˇ£
(
X
)

77 #
ídif


127 
	}
%%

139 #ifde‡
YYFALLBACK


140 c⁄° 
YYCODETYPE
 
	gyyFÆlback
[] = {

141 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

143 #
ídif


157 
	syySèckE¡ry
 {

158 
YYACTIONTYPE
 
	m°©ío
;

159 
YYCODETYPE
 
	mmaj‹
;

161 
YYMINORTYPE
 
	mmö‹
;

164 
yySèckE¡ry
 
	tyySèckE¡ry
;

168 
	syyP¨£r
 {

169 
	myyidx
;

170 #
ifdef
 
YYTRACKMAXSTACKDEPTH


171 
	myyidxMax
;

172 #
ídif


173 
	myyîr˙t
;

174 
	mP¨£ARG_SDECL


175 #
YYSTACKDEPTH
<=0

176 
	myy°ksz
;

177 
yySèckE¡ry
 *
	myy°ack
;

179 
yySèckE¡ry
 
	myy°ack
[
YYSTACKDEPTH
];

180 #
ídif


182 
yyP¨£r
 
	tyyP¨£r
;

184 #
i‚def
 
NDEBUG


185 #
ö˛ude
 <
°dio
.
h
>

186 
FILE
 *
	gyyTø˚FILE
 = 0;

187 *
	gyyTø˚Prom±
 = 0;

188 #
ídif


190 #
i‚def
 
NDEBUG


208 
	`P¨£Tø˚
(
FILE
 *
	gTø˚FILE
, *
	gzTø˚Prom±
){

209 
	gyyTø˚FILE
 = 
Tø˚FILE
;

210 
	gyyTø˚Prom±
 = 
zTø˚Prom±
;

211 if–
	gyyTø˚FILE
==0 ) 
yyTø˚Prom±
 = 0;

212 if–
	gyyTø˚Prom±
==0 ) 
yyTø˚FILE
 = 0;

214 #
ídif


216 #
i‚def
 
NDEBUG


219 c⁄° *c⁄° 
	gyyTokíName
[] = {

220 
	}
%%

224 #i‚de‡
NDEBUG


227 c⁄° *c⁄° 
	gyyRuÀName
[] = {

228 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

230 #
ídif


233 #
YYSTACKDEPTH
<=0

237 
	`yyGrowSèck
(
yyP¨£r
 *
	gp
){

238 
	g√wSize
;

239 
yySèckE¡ry
 *
	gpNew
;

241 
	g√wSize
 = 
p
->
yy°ksz
*2 + 100;

242 
	gpNew
 = 
	`ªÆloc
(
p
->
yy°ack
, 
√wSize
*(pNew[0]));

243 if–
	gpNew
 ){

244 
	gp
->
	gyy°ack
 = 
pNew
;

245 
	gp
->
	gyy°ksz
 = 
√wSize
;

246 #
i‚def
 
NDEBUG


247 if–
	gyyTø˚FILE
 ){

248 
	`Ârötf
(
	gyyTø˚FILE
,"%sStack growsÅo %dÉntries!\n",

249 
	gyyTø˚Prom±
, 
	gp
->
	gyy°ksz
);

251 #
ídif


254 #
ídif


268 *
	`P¨£AŒoc
(*(*
	gmÆlocProc
)(
	gsize_t
)){

269 
yyP¨£r
 *
	gpP¨£r
;

270 
	gpP¨£r
 = (
yyP¨£r
*)(*
mÆlocProc
)–(
size_t
)(yyParser) );

271 if–
	gpP¨£r
 ){

272 
	gpP¨£r
->
	gyyidx
 = -1;

273 #
ifdef
 
YYTRACKMAXSTACKDEPTH


274 
	gpP¨£r
->
	gyyidxMax
 = 0;

275 #
ídif


276 #
YYSTACKDEPTH
<=0

277 
	gpP¨£r
->
	gyy°ack
 = 
NULL
;

278 
	gpP¨£r
->
	gyy°ksz
 = 0;

279 
	`yyGrowSèck
(
	gpP¨£r
);

280 #
ídif


282  
	gpP¨£r
;

290 
	`yy_de°ru˘‹
(

291 
yyP¨£r
 *
	gyypP¨£r
,

292 
YYCODETYPE
 
	gyymaj‹
,

293 
YYMINORTYPE
 *
	gyypmö‹


295 
	gP¨£ARG_FETCH
;

296  
	gyymaj‹
 ){

307 
	}
%%

320 
	$yy_p›_∑r£r_°ack
(
yyP¨£r
 *
pP¨£r
){

321 
YYCODETYPE
 
yymaj‹
;

322 
yySèckE¡ry
 *
yytos
 = &
pP¨£r
->
yy°ack
[pP¨£r->
yyidx
];

324 if–
pP¨£r
->
yyidx
<0 )  0;

325 #i‚de‡
NDEBUG


326 if–
yyTø˚FILE
 && 
pP¨£r
->
yyidx
>=0 ){

327 
	`Ârötf
(
yyTø˚FILE
,"%sPopping %s\n",

328 
yyTø˚Prom±
,

329 
yyTokíName
[
yytos
->
maj‹
]);

332 
yymaj‹
 = 
yytos
->
maj‹
;

333 
	`yy_de°ru˘‹
(
pP¨£r
, 
yymaj‹
, &
yytos
->
mö‹
);

334 
pP¨£r
->
yyidx
--;

335  
yymaj‹
;

336 
	}
}

350 
P¨£Fªe
(

351 *
p
,

352 (*
‰ìProc
)(*)

354 
yyP¨£r
 *
pP¨£r
 = (yyP¨£r*)
p
;

355 if–
pP¨£r
==0 ) ;

356  
pP¨£r
->
yyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(pParser);

357 #i‡
YYSTACKDEPTH
<=0

358 
	`‰ì
(
pP¨£r
->
yy°ack
);

360 (*
‰ìProc
)((*)
pP¨£r
);

361 
	}
}

366 #ifde‡
YYTRACKMAXSTACKDEPTH


367 
	$P¨£SèckPók
(*
p
){

368 
yyP¨£r
 *
pP¨£r
 = (yyP¨£r*)
p
;

369  
pP¨£r
->
yyidxMax
;

370 
	}
}

381 
	$yy_föd_shi·_a˘i⁄
(

382 
yyP¨£r
 *
pP¨£r
,

383 
YYCODETYPE
 
iLookAhód


385 
i
;

386 
°©ío
 = 
pP¨£r
->
yy°ack
[pP¨£r->
yyidx
].stateno;

388 if–
°©ío
>
YY_SHIFT_COUNT


389 || (
i
 = 
yy_shi·_of°
[
°©ío
])==
YY_SHIFT_USE_DFLT
 ){

390  
yy_deÁu…
[
°©ío
];

392 
	`as£π
–
iLookAhód
!=
YYNOCODE
 );

393 
i
 +
iLookAhód
;

394 if–
i
<0 || i>=
YY_ACTTAB_COUNT
 || 
yy_lookahód
[i]!=
iLookAhód
 ){

395 if–
iLookAhód
>0 ){

396 #ifde‡
YYFALLBACK


397 
YYCODETYPE
 
iFÆlback
;

398 if–
iLookAhód
<(
yyFÆlback
)/(yyFallback[0])

399 && (
iFÆlback
 = 
yyFÆlback
[
iLookAhód
])!=0 ){

400 #i‚de‡
NDEBUG


401 if–
yyTø˚FILE
 ){

402 
	`Ârötf
(
yyTø˚FILE
, "%sFALLBACK %s => %s\n",

403 
yyTø˚Prom±
, 
yyTokíName
[
iLookAhód
], yyTokíName[
iFÆlback
]);

406  
	`yy_föd_shi·_a˘i⁄
(
pP¨£r
, 
iFÆlback
);

409 #ifde‡
YYWILDCARD


411 
j
 = 
i
 - 
iLookAhód
 + 
YYWILDCARD
;

413 #i‡
YY_SHIFT_MIN
+
YYWILDCARD
<0

414 
j
>=0 &&

416 #i‡
YY_SHIFT_MAX
+
YYWILDCARD
>=
YY_ACTTAB_COUNT


417 
j
<
YY_ACTTAB_COUNT
 &&

419 
yy_lookahód
[
j
]==
YYWILDCARD


421 #i‚de‡
NDEBUG


422 if–
yyTø˚FILE
 ){

423 
	`Ârötf
(
yyTø˚FILE
, "%sWILDCARD %s => %s\n",

424 
yyTø˚Prom±
, 
yyTokíName
[
iLookAhód
], yyTokíName[
YYWILDCARD
]);

427  
yy_a˘i⁄
[
j
];

432  
yy_deÁu…
[
°©ío
];

434  
yy_a˘i⁄
[
i
];

436 
	}
}

446 
	$yy_föd_ªdu˚_a˘i⁄
(

447 
°©ío
,

448 
YYCODETYPE
 
iLookAhód


450 
i
;

451 #ifde‡
YYERRORSYMBOL


452 if–
°©ío
>
YY_REDUCE_COUNT
 ){

453  
yy_deÁu…
[
°©ío
];

456 
	`as£π
–
°©ío
<=
YY_REDUCE_COUNT
 );

458 
i
 = 
yy_ªdu˚_of°
[
°©ío
];

459 
	`as£π
–
i
!=
YY_REDUCE_USE_DFLT
 );

460 
	`as£π
–
iLookAhód
!=
YYNOCODE
 );

461 
i
 +
iLookAhód
;

462 #ifde‡
YYERRORSYMBOL


463 if–
i
<0 || i>=
YY_ACTTAB_COUNT
 || 
yy_lookahód
[i]!=
iLookAhód
 ){

464  
yy_deÁu…
[
°©ío
];

467 
	`as£π
–
i
>=0 && i<
YY_ACTTAB_COUNT
 );

468 
	`as£π
–
yy_lookahód
[
i
]==
iLookAhód
 );

470  
yy_a˘i⁄
[
i
];

471 
	}
}

476 
	$yySèckOvîÊow
(
yyP¨£r
 *
yypP¨£r
, 
YYMINORTYPE
 *
yypMö‹
){

477 
P¨£ARG_FETCH
;

478 
yypP¨£r
->
yyidx
--;

479 #i‚de‡
NDEBUG


480 if–
yyTø˚FILE
 ){

481 
	`Ârötf
(
yyTø˚FILE
,"%sSèck OvîÊow!\n",
yyTø˚Prom±
);

484  
yypP¨£r
->
yyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(yypParser);

487 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

488 
P¨£ARG_STORE
;

489 
	}
}

494 
	`yy_shi·
(

495 
yyP¨£r
 *
	gyypP¨£r
,

496 
	gyyNewSèã
,

497 
	gyyMaj‹
,

498 
YYMINORTYPE
 *
	gyypMö‹


500 
yySèckE¡ry
 *
	gyytos
;

501 
	gyypP¨£r
->
	gyyidx
++;

502 #
ifdef
 
YYTRACKMAXSTACKDEPTH


503 if–
	gyypP¨£r
->
	gyyidx
>yypP¨£r->
	gyyidxMax
 ){

504 
	gyypP¨£r
->
	gyyidxMax
 = 
yypP¨£r
->
yyidx
;

506 #
ídif


507 #
YYSTACKDEPTH
>0

508 if–
	gyypP¨£r
->
	gyyidx
>=
YYSTACKDEPTH
 ){

509 
	`yySèckOvîÊow
(
yypP¨£r
, 
yypMö‹
);

513 if–
	gyypP¨£r
->
	gyyidx
>=
yypP¨£r
->
yy°ksz
 ){

514 
	`yyGrowSèck
(
yypP¨£r
);

515 if–
	gyypP¨£r
->
	gyyidx
>=
yypP¨£r
->
yy°ksz
 ){

516 
	`yySèckOvîÊow
(
yypP¨£r
, 
yypMö‹
);

520 #
ídif


521 
	gyytos
 = &
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
];

522 
	gyytos
->
	g°©ío
 = (
YYACTIONTYPE
)
yyNewSèã
;

523 
	gyytos
->
	gmaj‹
 = (
YYCODETYPE
)
yyMaj‹
;

524 
	gyytos
->
	gmö‹
 = *
yypMö‹
;

525 #
i‚def
 
NDEBUG


526 if–
	gyyTø˚FILE
 && 
	gyypP¨£r
->
	gyyidx
>0 ){

527 
	gi
;

528 
	`Ârötf
(
	gyyTø˚FILE
,"%sShi· %d\n",
	gyyTø˚Prom±
,
	gyyNewSèã
);

529 
	`Ârötf
(
	gyyTø˚FILE
,"%sSèck:",
	gyyTø˚Prom±
);

530 
	gi
=1; i<=
yypP¨£r
->
yyidx
; i++)

531 
	`Ârötf
(
	gyyTø˚FILE
," %s",
	gyyTokíName
[
yypP¨£r
->
yy°ack
[
i
].
	gmaj‹
]);

532 
	`Ârötf
(
	gyyTø˚FILE
,"\n");

534 #
ídif


541 
YYCODETYPE
 
	mlhs
;

542 
	mƒhs
;

543 } 
	gyyRuÀInfo
[] = {

544 
	}
%%

547 
yy_ac˚±
(
yyP¨£r
*);

553 
	$yy_ªdu˚
(

554 
yyP¨£r
 *
yypP¨£r
,

555 
yyruÀno


557 
yygŸo
;

558 
yya˘
;

559 
YYMINORTYPE
 
yygŸomö‹
;

560 
yySèckE¡ry
 *
yym•
;

561 
yysize
;

562 
P¨£ARG_FETCH
;

563 
yym•
 = &
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
];

564 #i‚de‡
NDEBUG


565 if–
yyTø˚FILE
 && 
yyruÀno
>=0

566 && 
yyruÀno
<()((
yyRuÀName
)/(yyRuleName[0])) ){

567 
	`Ârötf
(
yyTø˚FILE
, "%sRedu˚ [%s].\n", 
yyTø˚Prom±
,

568 
yyRuÀName
[
yyruÀno
]);

587 
yygŸomö‹
 = 
yyzîomö‹
;

590  
yyruÀno
 ){

599 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

600 
	}
};

601 
	gyygŸo
 = 
yyRuÀInfo
[
yyruÀno
].
lhs
;

602 
	gyysize
 = 
yyRuÀInfo
[
yyruÀno
].
ƒhs
;

603 
	gyypP¨£r
->
	gyyidx
 -
yysize
;

604 
	gyya˘
 = 
	`yy_föd_ªdu˚_a˘i⁄
(
yym•
[-
yysize
].
°©ío
,(
	gYYCODETYPE
)
	gyygŸo
);

605 if–
	gyya˘
 < 
	gYYNSTATE
 ){

606 #
ifdef
 
NDEBUG


611 if–
	gyysize
 ){

612 
	gyypP¨£r
->
	gyyidx
++;

613 
	gyym•
 -
yysize
-1;

614 
	gyym•
->
	g°©ío
 = (
YYACTIONTYPE
)
yya˘
;

615 
	gyym•
->
	gmaj‹
 = (
YYCODETYPE
)
yygŸo
;

616 
	gyym•
->
	gmö‹
 = 
yygŸomö‹
;

618 #
ídif


620 
	`yy_shi·
(
	gyypP¨£r
,
	gyya˘
,
	gyygŸo
,&
	gyygŸomö‹
);

623 
	`as£π
–
	gyya˘
 =
YYNSTATE
 + 
YYNRULE
 + 1 );

624 
	`yy_ac˚±
(
	gyypP¨£r
);

631 #
i‚def
 
YYNOERRORRECOVERY


632 
	`yy_∑r£_Áûed
(

633 
yyP¨£r
 *
	gyypP¨£r


635 
	gP¨£ARG_FETCH
;

636 #
i‚def
 
NDEBUG


637 if–
	gyyTø˚FILE
 ){

638 
	`Ârötf
(
	gyyTø˚FILE
,"%sFaû!\n",
	gyyTø˚Prom±
);

640 #
ídif


641  
	gyypP¨£r
->
	gyyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(
yypP¨£r
);

644 
	}
%%

645 
	gP¨£ARG_STORE
;

652 
	$yy_sy¡ax_îr‹
(

653 
yyP¨£r
 *
yypP¨£r
,

654 
yymaj‹
,

655 
YYMINORTYPE
 
yymö‹


657 
P¨£ARG_FETCH
;

658 
	#TOKEN
 (
yymö‹
.
yy0
)

	)

659 %% /* 
	$yy∑r£
 */ 
	`yyÀx
()

660 
P¨£ARG_STORE
;

661 
	}
}

666 
	`yy_ac˚±
(

667 
yyP¨£r
 *
	gyypP¨£r


669 
	gP¨£ARG_FETCH
;

670 #
i‚def
 
NDEBUG


671 if–
	gyyTø˚FILE
 ){

672 
	`Ârötf
(
	gyyTø˚FILE
,"%sAc˚±!\n",
	gyyTø˚Prom±
);

674 #
ídif


675  
	gyypP¨£r
->
	gyyidx
>=0 ) 
	`yy_p›_∑r£r_°ack
(
yypP¨£r
);

678 
	}
%%

679 
	gP¨£ARG_STORE
;

701 
	$P¨£
(

702 *
yyp
,

703 
yymaj‹
,

704 
P¨£TOKENTYPE
 
yymö‹


705 
P¨£ARG_PDECL


707 
YYMINORTYPE
 
yymö‹uni⁄
;

708 
yya˘
;

709 
yyídoföput
;

710 #ifde‡
YYERRORSYMBOL


711 
yyîr‹hô
 = 0;

713 
yyP¨£r
 *
yypP¨£r
;

716 
yypP¨£r
 = (
yyP¨£r
*)
yyp
;

717 if–
yypP¨£r
->
yyidx
<0 ){

718 #i‡
YYSTACKDEPTH
<=0

719 if–
yypP¨£r
->
yy°ksz
 <=0 ){

721 
yymö‹uni⁄
 = 
yyzîomö‹
;

722 
	`yySèckOvîÊow
(
yypP¨£r
, &
yymö‹uni⁄
);

726 
yypP¨£r
->
yyidx
 = 0;

727 
yypP¨£r
->
yyîr˙t
 = -1;

728 
yypP¨£r
->
yy°ack
[0].
°©ío
 = 0;

729 
yypP¨£r
->
yy°ack
[0].
maj‹
 = 0;

731 
yymö‹uni⁄
.
yy0
 = 
yymö‹
;

732 
yyídoföput
 = (
yymaj‹
==0);

733 
P¨£ARG_STORE
;

735 #i‚de‡
NDEBUG


736 if–
yyTø˚FILE
 ){

737 
	`Ârötf
(
yyTø˚FILE
,"%sI≈uà%s\n",
yyTø˚Prom±
,
yyTokíName
[
yymaj‹
]);

742 
yya˘
 = 
	`yy_föd_shi·_a˘i⁄
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
);

743 if–
yya˘
<
YYNSTATE
 ){

744 
	`as£π
–!
yyídoföput
 );

745 
	`yy_shi·
(
yypP¨£r
,
yya˘
,
yymaj‹
,&
yymö‹uni⁄
);

746 
yypP¨£r
->
yyîr˙t
--;

747 
yymaj‹
 = 
YYNOCODE
;

748 }if–
yya˘
 < 
YYNSTATE
 + 
YYNRULE
 ){

749 
	`yy_ªdu˚
(
yypP¨£r
,
yya˘
-
YYNSTATE
);

751 
	`as£π
–
yya˘
 =
YY_ERROR_ACTION
 );

752 #ifde‡
YYERRORSYMBOL


753 
yymx
;

755 #i‚de‡
NDEBUG


756 if–
yyTø˚FILE
 ){

757 
	`Ârötf
(
yyTø˚FILE
,"%sSy¡ax Eº‹!\n",
yyTø˚Prom±
);

760 #ifde‡
YYERRORSYMBOL


780 if–
yypP¨£r
->
yyîr˙t
<0 ){

781 
	`yy_sy¡ax_îr‹
(
yypP¨£r
,
yymaj‹
,
yymö‹uni⁄
);

783 
yymx
 = 
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
].
maj‹
;

784 if–
yymx
==
YYERRORSYMBOL
 || 
yyîr‹hô
 ){

785 #i‚de‡
NDEBUG


786 if–
yyTø˚FILE
 ){

787 
	`Ârötf
(
yyTø˚FILE
,"%sDiscard inputÅoken %s\n",

788 
yyTø˚Prom±
,
yyTokíName
[
yymaj‹
]);

791 
	`yy_de°ru˘‹
(
yypP¨£r
, (
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

792 
yymaj‹
 = 
YYNOCODE
;

795 
yypP¨£r
->
yyidx
 >= 0 &&

796 
yymx
 !
YYERRORSYMBOL
 &&

797 (
yya˘
 = 
	`yy_föd_ªdu˚_a˘i⁄
(

798 
yypP¨£r
->
yy°ack
[yypP¨£r->
yyidx
].
°©ío
,

799 
YYERRORSYMBOL
)Ë>
YYNSTATE


801 
	`yy_p›_∑r£r_°ack
(
yypP¨£r
);

803 if–
yypP¨£r
->
yyidx
 < 0 || 
yymaj‹
==0 ){

804 
	`yy_de°ru˘‹
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

805 
	`yy_∑r£_Áûed
(
yypP¨£r
);

806 
yymaj‹
 = 
YYNOCODE
;

807 }if–
yymx
!=
YYERRORSYMBOL
 ){

808 
YYMINORTYPE
 
u2
;

809 
u2
.
YYERRSYMDT
 = 0;

810 
	`yy_shi·
(
yypP¨£r
,
yya˘
,
YYERRORSYMBOL
,&
u2
);

813 
yypP¨£r
->
yyîr˙t
 = 3;

814 
yyîr‹hô
 = 1;

815 #ñi‡
	`deföed
(
YYNOERRORRECOVERY
)

823 
	`yy_sy¡ax_îr‹
(
yypP¨£r
,
yymaj‹
,
yymö‹uni⁄
);

824 
	`yy_de°ru˘‹
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

825 
yymaj‹
 = 
YYNOCODE
;

837 if–
yypP¨£r
->
yyîr˙t
<=0 ){

838 
	`yy_sy¡ax_îr‹
(
yypP¨£r
,
yymaj‹
,
yymö‹uni⁄
);

840 
yypP¨£r
->
yyîr˙t
 = 3;

841 
	`yy_de°ru˘‹
(
yypP¨£r
,(
YYCODETYPE
)
yymaj‹
,&
yymö‹uni⁄
);

842 if–
yyídoföput
 ){

843 
	`yy_∑r£_Áûed
(
yypP¨£r
);

845 
yymaj‹
 = 
YYNOCODE
;

848 } 
yymaj‹
!=
YYNOCODE
 && 
yypP¨£r
->
yyidx
>=0 );

850 
	}
}

	@tool/lsmheader.c

5 
	~<°dio.h
>

6 
	~<°dlib.h
>

7 
	~<°rög.h
>

9 
	$ußge
(c⁄° *
¨gv
){

10 
	`Ârötf
(
°dîr
, "Ußge: %†DBFILE 1|2\n", 
¨gv
);

11 
	`exô
(1);

12 
	}
}

14 
	$gëI¡
(c⁄° *
a
, 
n
){

15 
a
 +
n
*4;

16  (
a
[0]<<24) | (a[1]<<16) | (a[2]<<8) |á[3];

17 
	}
}

19 
	$¥löe
(c⁄° *
zTôÀ
, 
v
){

20 
n
 = ()
	`°æí
(
zTôÀ
);

21 
	`¥ötf
("%s%.*†%10u %08x\n", 
zTôÀ
,

22 55-
n
, "............................................................",

23 
v
, v);

24 
	}
}

26 
	$¥£gmít
(c⁄° *
zName
, *
aD©a
){

27 
zTôÀ
[100];

28 
	`¢¥ötf
(
zTôÀ
, (zTôÀ), "%†fú°Öage", 
zName
);

29 
	`¥löe
(
zTôÀ
, 
	`gëI¡
(
aD©a
, 0));

30 
	`¢¥ötf
(
zTôÀ
, (zTôÀ), "%†œ°Öage", 
zName
);

31 
	`¥löe
(
zTôÀ
, 
	`gëI¡
(
aD©a
, 1));

32 
	`¢¥ötf
(
zTôÀ
, (zTôÀ), "%†roŸÖage", 
zName
);

33 
	`¥löe
(
zTôÀ
, 
	`gëI¡
(
aD©a
, 2));

34 
	`¢¥ötf
(
zTôÀ
, (zTôÀ), "%†numbî o‡∑ges", 
zName
);

35 
	`¥löe
(
zTôÀ
, 
	`gëI¡
(
aD©a
, 3));

36 
	}
}

38 
	$maö
(
¨gc
, **
¨gv
){

39 
FILE
 *
ö
;

40 
pgno
;

41 
sz
, 
nLevñ
, 
nRight
, 
nMîge
;

42 
iLevñ
, 
iRight
, 
iMîge
;

43 
ba£
;

44 
nFªe
;

45 
ovÊFœg
;

46 
z
[100];

47 
aPage
[4200];

49 if–
¨gc
!=3 ) 
	`ußge
(
¨gv
[0]);

50 
pgno
 = 
	`©oi
(
¨gv
[2]);

51 if–
pgno
!=1 &&Ögno!=2 ) 
	`ußge
(
¨gv
[0]);

52 
ö
 = 
	`f›í
(
¨gv
[1], "rb");

53 if–
ö
==0 ) 
	`ußge
(
¨gv
[0]);

54 if–
pgno
==2 ) 
	`f£ek
(
ö
, 4096, 
SEEK_SET
);

55 
	`‰ód
(
aPage
, 1, 4096, 
ö
);

56 
	`mem£t
(
aPage
+4096, 0, 100);

57 
	`¥löe
("Checkpoöàid MSW", 
	`gëI¡
(
aPage
,0));

58 
	`¥löe
("Checkpoöàid LSW", 
	`gëI¡
(
aPage
,1));

59 
sz
 = 
	`gëI¡
(
aPage
,2);

60 
	`¥löe
("VÆue†ö checkpoöt", 
sz
);

61 
	`¥löe
("Block†ö d©aba£", 
	`gëI¡
(
aPage
,3));

62 
	`¥löe
("Block size", 
	`gëI¡
(
aPage
,4));

63 
nLevñ
 = 
	`gëI¡
(
aPage
,5);

64 
	`¥löe
("Numbî o‡Àvñs", 
nLevñ
);

65 
	`¥löe
("D©aba£Öagêsize", 
	`gëI¡
(
aPage
,6));

66 
ovÊFœg
 = 
	`gëI¡
(
aPage
, 7);

67 
	`¥löe
("LEVELSánd FREELISTÑec‹d†ö L0?", 
ovÊFœg
);

68 
ba£
 = 8;

70 
	`¥löe
("LogÖoöã∏#1", 
	`gëI¡
(
aPage
,
ba£
));

71 
	`¥löe
("LogÖoöã∏#2", 
	`gëI¡
(
aPage
,
ba£
+1));

72 
	`¥löe
("LogÖoöã∏#3", 
	`gëI¡
(
aPage
,
ba£
+2));

73 
	`¥löe
("LogÖoöã∏#4", 
	`gëI¡
(
aPage
,
ba£
+3));

75 
ba£
 += 4;

76 
iLevñ
=0; iLevñ<
nLevñ
 && 
ba£
<1024; iLevel++){

77 
	`¥ötf
("Levñ[%d]:\n", 
iLevñ
);

78 
	`¥löe
(" Agêo‡thi†Àvñ", 
	`gëI¡
(
aPage
, 
ba£
));

79 
nRight
 = 
	`gëI¡
(
aPage
, 
ba£
+1);

80 
	`¥löe
(" Numbî o‡right-h™d segmíts", 
nRight
);

81 
ba£
 += 2;

82 
	`¥£gmít
(" Le· segmít", 
aPage
 + (
ba£
*4));

83 
ba£
 += 4;

84 
iRight
=0; iRight<
nRight
 && 
ba£
<1024; iRight++){

85 
	`¢¥ötf
(
z
, 50, " Righà£gmíà%d", 
iRight
);

86 
	`¥£gmít
(
z
, 
aPage
 + 
ba£
*4);

87 
ba£
 += 4;

89 if–
nRight
>0 ){

90 
nMîge
 = 
	`gëI¡
(
aPage
, 
ba£
); base++;

91 
	`¥löe
(" Numbî o‡£gmít†övﬁved i¿thêmîge", 
nMîge
);

92 
	`¥löe
(" CuºíànSkù vÆue", 
	`gëI¡
(
aPage
, 
ba£
)); base++;

93 
iMîge
=0; iMîge<
nMîge
 && 
ba£
<1024; iMerge++){

94 
	`¢¥ötf
(
z
, 80, " Righà£gmíà%dÇexà∑ge", 
iMîge
);

95 
	`¥löe
(
z
, 
	`gëI¡
(
aPage
, 
ba£
));

96 
	`¢¥ötf
(
z
, 80, " Righà£gmíà%dÇexà˚Œ", 
iMîge
);

97 
	`¥löe
(
z
, 
	`gëI¡
(
aPage
, 
ba£
+1));

98 
ba£
 += 2;

100 
	`¥löe
(" S∂ô-keyÖage", 
	`gëI¡
(
aPage
, 
ba£
));

101 
	`¥löe
(" S∂ô-key cñl", 
	`gëI¡
(
aPage
, 
ba£
));

102 
ba£
 += 2;

105 if–
ba£
>=1020 )  0;

107 if–
ovÊFœg
==0 ){

108 
nFªe
 = 
	`gëI¡
(
aPage
, 
ba£
);

109 
i
;

110 
	`¥löe
("Numbî o‡⁄-checkpoöà‰ìli° blocks", 
nFªe
);

111 
i
=0; i<
nFªe
; i++){

112 
	`¢¥ötf
(
z
, 80, "Fªñi° block %d", 
i
);

113 
	`¥löe
(
z
, 
	`gëI¡
(
aPage
, 
ba£
+
i
+1));

115 
ba£
 +
nFªe
+1;

117 
	`¥löe
("Sizêtÿåunˇã fªêli°Åÿa·îÜﬂdög", 
	`gëI¡
(
aPage
, 
ba£
));

118 
	`¥löe
("Fú°Ñe‰ì block", 
	`gëI¡
(
aPage
, 
ba£
+1));

119 
	`¥löe
("Sec⁄dÑe‰ì block", 
	`gëI¡
(
aPage
, 
ba£
+2));

120 
ba£
 += 3;

122 
	`¥löe
("Checksum vÆuê1", 
	`gëI¡
(
aPage
, 
ba£
));

123 
	`¥löe
("Checksum vÆuê2", 
	`gëI¡
(
aPage
, 
ba£
+1));

125 
ba£
 += 2;

126 
	`¥ötf
("****************************************"

128 
	`¥ötf
("Used %d out 1024 integersávailable inÅhe header (%d%%)\n",

129 
ba£
, base*100/1024);

131 
	}
}

	@tool/mkkeywordhash.c

6 
	~<°dio.h
>

7 
	~<°rög.h
>

8 
	~<°dlib.h
>

9 
	~<as£π.h
>

14 c⁄° 
	gzHdr
[] =

34 
Keyw‹d
 
	tKeyw‹d
;

35 
	sKeyw‹d
 {

36 *
	mzName
;

37 *
	mzTokíTy≥
;

38 
	mmask
;

39 
	mid
;

40 
	mhash
;

41 
	moff£t
;

42 
	mÀn
;

43 
	m¥efix
;

44 
	ml⁄ge°Suffix
;

45 
	miNext
;

46 
	msub°rId
;

47 
	msub°rOff£t
;

48 
	mzOrigName
[20];

54 #ifde‡
SQLITE4_OMIT_ALTERTABLE


55 
	#ALTER
 0

	)

57 
	#ALTER
 0x00000001

	)

59 
	#ALWAYS
 0x00000002

	)

60 #ifde‡
SQLITE4_OMIT_ANALYZE


61 
	#ANALYZE
 0

	)

63 
	#ANALYZE
 0x00000004

	)

65 #ifde‡
SQLITE4_OMIT_ATTACH


66 
	#ATTACH
 0

	)

68 
	#ATTACH
 0x00000008

	)

70 #ifde‡
SQLITE4_OMIT_AUTOINCREMENT


71 
	#AUTOINCR
 0

	)

73 
	#AUTOINCR
 0x00000010

	)

75 #ifde‡
SQLITE4_OMIT_CAST


76 
	#CAST
 0

	)

78 
	#CAST
 0x00000020

	)

80 #ifde‡
SQLITE4_OMIT_COMPOUND_SELECT


81 
	#COMPOUND
 0

	)

83 
	#COMPOUND
 0x00000040

	)

85 #ifde‡
SQLITE4_OMIT_CONFLICT_CLAUSE


86 
	#CONFLICT
 0

	)

88 
	#CONFLICT
 0x00000080

	)

90 #ifde‡
SQLITE4_OMIT_EXPLAIN


91 
	#EXPLAIN
 0

	)

93 
	#EXPLAIN
 0x00000100

	)

95 #ifde‡
SQLITE4_OMIT_FOREIGN_KEY


96 
	#FKEY
 0

	)

98 
	#FKEY
 0x00000200

	)

100 #ifde‡
SQLITE4_OMIT_PRAGMA


101 
	#PRAGMA
 0

	)

103 
	#PRAGMA
 0x00000400

	)

105 #ifde‡
SQLITE4_OMIT_REINDEX


106 
	#REINDEX
 0

	)

108 
	#REINDEX
 0x00000800

	)

110 #ifde‡
SQLITE4_OMIT_SUBQUERY


111 
	#SUBQUERY
 0

	)

113 
	#SUBQUERY
 0x00001000

	)

115 #ifde‡
SQLITE4_OMIT_TRIGGER


116 
	#TRIGGER
 0

	)

118 
	#TRIGGER
 0x00002000

	)

120 #ifde‡
SQLITE4_OMIT_VIEW


121 
	#VIEW
 0

	)

123 
	#VIEW
 0x00008000

	)

125 #ifde‡
SQLITE4_OMIT_VIRTUALTABLE


126 
	#VTAB
 0

	)

128 
	#VTAB
 0x00010000

	)

130 #ifde‡
SQLITE4_OMIT_AUTOVACUUM


131 
	#AUTOVACUUM
 0

	)

133 
	#AUTOVACUUM
 0x00020000

	)

139 
Keyw‹d
 
	gaKeyw‹dTabÀ
[] = {

140 { "ABORT", "TK_ABORT", 
CONFLICT
|
TRIGGER
 },

141 { "ACTION", "TK_ACTION", 
FKEY
 },

142 { "ADD", "TK_ADD", 
ALTER
 },

143 { "AFTER", "TK_AFTER", 
TRIGGER
 },

144 { "ALL", "TK_ALL", 
ALWAYS
 },

145 { "ALTER", "TK_ALTER", 
ALTER
 },

146 { "ANALYZE", "TK_ANALYZE", 
ANALYZE
 },

147 { "AND", "TK_AND", 
ALWAYS
 },

148 { "AS", "TK_AS", 
ALWAYS
 },

149 { "ASC", "TK_ASC", 
ALWAYS
 },

150 { "ATTACH", "TK_ATTACH", 
ATTACH
 },

151 { "AUTOINCREMENT", "TK_AUTOINCR", 
AUTOINCR
 },

152 { "BEFORE", "TK_BEFORE", 
TRIGGER
 },

153 { "BEGIN", "TK_BEGIN", 
ALWAYS
 },

154 { "BETWEEN", "TK_BETWEEN", 
ALWAYS
 },

155 { "BY", "TK_BY", 
ALWAYS
 },

156 { "CASCADE", "TK_CASCADE", 
FKEY
 },

157 { "CASE", "TK_CASE", 
ALWAYS
 },

158 { "CAST", "TK_CAST", 
CAST
 },

159 { "CHECK", "TK_CHECK", 
ALWAYS
 },

160 { "COLLATE", "TK_COLLATE", 
ALWAYS
 },

161 { "COLUMN", "TK_COLUMNKW", 
ALTER
 },

162 { "COMMIT", "TK_COMMIT", 
ALWAYS
 },

163 { "CONFLICT", "TK_CONFLICT", 
CONFLICT
 },

164 { "CONSTRAINT", "TK_CONSTRAINT", 
ALWAYS
 },

165 { "COVERING", "TK_COVERING", 
ALWAYS
 },

166 { "CREATE", "TK_CREATE", 
ALWAYS
 },

167 { "CROSS", "TK_JOIN_KW", 
ALWAYS
 },

168 { "CURRENT_DATE", "TK_CTIME_KW", 
ALWAYS
 },

169 { "CURRENT_TIME", "TK_CTIME_KW", 
ALWAYS
 },

170 { "CURRENT_TIMESTAMP","TK_CTIME_KW", 
ALWAYS
 },

171 { "DATABASE", "TK_DATABASE", 
ATTACH
 },

172 { "DEFAULT", "TK_DEFAULT", 
ALWAYS
 },

173 { "DEFERRED", "TK_DEFERRED", 
ALWAYS
 },

174 { "DEFERRABLE", "TK_DEFERRABLE", 
FKEY
 },

175 { "DELETE", "TK_DELETE", 
ALWAYS
 },

176 { "DESC", "TK_DESC", 
ALWAYS
 },

177 { "DETACH", "TK_DETACH", 
ATTACH
 },

178 { "DISTINCT", "TK_DISTINCT", 
ALWAYS
 },

179 { "DROP", "TK_DROP", 
ALWAYS
 },

180 { "END", "TK_END", 
ALWAYS
 },

181 { "EACH", "TK_EACH", 
TRIGGER
 },

182 { "ELSE", "TK_ELSE", 
ALWAYS
 },

183 { "ESCAPE", "TK_ESCAPE", 
ALWAYS
 },

184 { "EXCEPT", "TK_EXCEPT", 
COMPOUND
 },

185 { "EXCLUSIVE", "TK_EXCLUSIVE", 
ALWAYS
 },

186 { "EXISTS", "TK_EXISTS", 
ALWAYS
 },

187 { "EXPLAIN", "TK_EXPLAIN", 
EXPLAIN
 },

188 { "FAIL", "TK_FAIL", 
CONFLICT
|
TRIGGER
 },

189 { "FOR", "TK_FOR", 
TRIGGER
 },

190 { "FOREIGN", "TK_FOREIGN", 
FKEY
 },

191 { "FROM", "TK_FROM", 
ALWAYS
 },

192 { "FULL", "TK_JOIN_KW", 
ALWAYS
 },

193 { "GLOB", "TK_LIKE_KW", 
ALWAYS
 },

194 { "GROUP", "TK_GROUP", 
ALWAYS
 },

195 { "HAVING", "TK_HAVING", 
ALWAYS
 },

196 { "IF", "TK_IF", 
ALWAYS
 },

197 { "IGNORE", "TK_IGNORE", 
CONFLICT
|
TRIGGER
 },

198 { "IMMEDIATE", "TK_IMMEDIATE", 
ALWAYS
 },

199 { "IN", "TK_IN", 
ALWAYS
 },

200 { "INDEX", "TK_INDEX", 
ALWAYS
 },

201 { "INDEXED", "TK_INDEXED", 
ALWAYS
 },

202 { "INITIALLY", "TK_INITIALLY", 
FKEY
 },

203 { "INNER", "TK_JOIN_KW", 
ALWAYS
 },

204 { "INSERT", "TK_INSERT", 
ALWAYS
 },

205 { "INSTEAD", "TK_INSTEAD", 
TRIGGER
 },

206 { "INTERSECT", "TK_INTERSECT", 
COMPOUND
 },

207 { "INTO", "TK_INTO", 
ALWAYS
 },

208 { "IS", "TK_IS", 
ALWAYS
 },

209 { "ISNULL", "TK_ISNULL", 
ALWAYS
 },

210 { "JOIN", "TK_JOIN", 
ALWAYS
 },

211 { "KEY", "TK_KEY", 
ALWAYS
 },

212 { "LEFT", "TK_JOIN_KW", 
ALWAYS
 },

213 { "LIKE", "TK_LIKE_KW", 
ALWAYS
 },

214 { "LIMIT", "TK_LIMIT", 
ALWAYS
 },

215 { "MATCH", "TK_MATCH", 
ALWAYS
 },

216 { "NATURAL", "TK_JOIN_KW", 
ALWAYS
 },

217 { "NO", "TK_NO", 
FKEY
 },

218 { "NOT", "TK_NOT", 
ALWAYS
 },

219 { "NOTNULL", "TK_NOTNULL", 
ALWAYS
 },

220 { "NULL", "TK_NULL", 
ALWAYS
 },

221 { "OF", "TK_OF", 
ALWAYS
 },

222 { "OFFSET", "TK_OFFSET", 
ALWAYS
 },

223 { "ON", "TK_ON", 
ALWAYS
 },

224 { "OR", "TK_OR", 
ALWAYS
 },

225 { "ORDER", "TK_ORDER", 
ALWAYS
 },

226 { "OUTER", "TK_JOIN_KW", 
ALWAYS
 },

227 { "PLAN", "TK_PLAN", 
EXPLAIN
 },

228 { "PRAGMA", "TK_PRAGMA", 
PRAGMA
 },

229 { "PRIMARY", "TK_PRIMARY", 
ALWAYS
 },

230 { "QUERY", "TK_QUERY", 
EXPLAIN
 },

231 { "RAISE", "TK_RAISE", 
TRIGGER
 },

232 { "REFERENCES", "TK_REFERENCES", 
FKEY
 },

233 { "REGEXP", "TK_LIKE_KW", 
ALWAYS
 },

234 { "REINDEX", "TK_REINDEX", 
REINDEX
 },

235 { "RELEASE", "TK_RELEASE", 
ALWAYS
 },

236 { "RENAME", "TK_RENAME", 
ALTER
 },

237 { "REPLACE", "TK_REPLACE", 
CONFLICT
 },

238 { "RESTRICT", "TK_RESTRICT", 
FKEY
 },

239 { "RIGHT", "TK_JOIN_KW", 
ALWAYS
 },

240 { "ROLLBACK", "TK_ROLLBACK", 
ALWAYS
 },

241 { "ROW", "TK_ROW", 
TRIGGER
 },

242 { "SAVEPOINT", "TK_SAVEPOINT", 
ALWAYS
 },

243 { "SELECT", "TK_SELECT", 
ALWAYS
 },

244 { "SET", "TK_SET", 
ALWAYS
 },

245 { "TABLE", "TK_TABLE", 
ALWAYS
 },

246 { "TEMP", "TK_TEMP", 
ALWAYS
 },

247 { "TEMPORARY", "TK_TEMP", 
ALWAYS
 },

248 { "THEN", "TK_THEN", 
ALWAYS
 },

249 { "TO", "TK_TO", 
ALWAYS
 },

250 { "TRANSACTION", "TK_TRANSACTION", 
ALWAYS
 },

251 { "TRIGGER", "TK_TRIGGER", 
TRIGGER
 },

252 { "UNION", "TK_UNION", 
COMPOUND
 },

253 { "UNIQUE", "TK_UNIQUE", 
ALWAYS
 },

254 { "UPDATE", "TK_UPDATE", 
ALWAYS
 },

255 { "USING", "TK_USING", 
ALWAYS
 },

256 { "VALUES", "TK_VALUES", 
ALWAYS
 },

257 { "VIEW", "TK_VIEW", 
VIEW
 },

258 { "VIRTUAL", "TK_VIRTUAL", 
VTAB
 },

259 { "WHEN", "TK_WHEN", 
ALWAYS
 },

260 { "WHERE", "TK_WHERE", 
ALWAYS
 },

264 
	gnKeyw‹d
 = ((
aKeyw‹dTabÀ
)/(aKeywordTable[0]));

269 c⁄° 
	gsqlôe4UµîToLowî
[] = {

286 
	#UµîToLowî
 
sqlôe4UµîToLowî


	)

291 
	$keyw‹dCom∑ª1
(c⁄° *
a
, c⁄° *
b
){

292 c⁄° 
Keyw‹d
 *
pA
 = (Keyw‹d*)
a
;

293 c⁄° 
Keyw‹d
 *
pB
 = (Keyw‹d*)
b
;

294 
n
 = 
pA
->
Àn
 - 
pB
->len;

295 if–
n
==0 ){

296 
n
 = 
	`°rcmp
(
pA
->
zName
, 
pB
->zName);

298 
	`as£π
–
n
!=0 );

299  
n
;

300 
	}
}

301 
	$keyw‹dCom∑ª2
(c⁄° *
a
, c⁄° *
b
){

302 c⁄° 
Keyw‹d
 *
pA
 = (Keyw‹d*)
a
;

303 c⁄° 
Keyw‹d
 *
pB
 = (Keyw‹d*)
b
;

304 
n
 = 
pB
->
l⁄ge°Suffix
 - 
pA
->longestSuffix;

305 if–
n
==0 ){

306 
n
 = 
	`°rcmp
(
pA
->
zName
, 
pB
->zName);

308 
	`as£π
–
n
!=0 );

309  
n
;

310 
	}
}

311 
	$keyw‹dCom∑ª3
(c⁄° *
a
, c⁄° *
b
){

312 c⁄° 
Keyw‹d
 *
pA
 = (Keyw‹d*)
a
;

313 c⁄° 
Keyw‹d
 *
pB
 = (Keyw‹d*)
b
;

314 
n
 = 
pA
->
off£t
 - 
pB
->offset;

315 if–
n
==0 )Ç = 
pB
->
id
 - 
pA
->id;

316 
	`as£π
–
n
!=0 );

317  
n
;

318 
	}
}

323 
Keyw‹d
 *
	$födById
(
id
){

324 
i
;

325 
i
=0; i<
nKeyw‹d
; i++){

326 if–
aKeyw‹dTabÀ
[
i
].
id
==id ) ;

328  &
aKeyw‹dTabÀ
[
i
];

329 
	}
}

335 
	$maö
(
¨gc
, **
¨gv
){

336 
i
, 
j
, 
k
, 
h
;

337 
be°Size
, 
be°Cou¡
;

338 
cou¡
;

339 
nCh¨
;

340 
tŸÆLí
 = 0;

341 
aHash
[1000];

342 
zText
[2000];

345 
i
=
j
=0; i<
nKeyw‹d
; i++){

346 if–
aKeyw‹dTabÀ
[
i
].
mask
==0 ) ;

347 if–
j
<
i
 ){

348 
aKeyw‹dTabÀ
[
j
] =áKeyw‹dTabÀ[
i
];

350 
j
++;

352 
nKeyw‹d
 = 
j
;

355 
i
=0; i<
nKeyw‹d
; i++){

356 
Keyw‹d
 *
p
 = &
aKeyw‹dTabÀ
[
i
];

357 
p
->
Àn
 = 
	`°æí
’->
zName
);

358 
	`as£π
–
p
->
Àn
<’->
zOrigName
) );

359 
	`°r˝y
(
p
->
zOrigName
,Ö->
zName
);

360 
tŸÆLí
 +
p
->
Àn
;

361 
p
->
hash
 = (
UµîToLowî
[(Ì->
zName
[0]]*4) ^

362 (
UµîToLowî
[()
p
->
zName
[p->
Àn
-1]]*3) ^Ö->len;

363 
p
->
id
 = 
i
+1;

367 
	`qs‹t
(
aKeyw‹dTabÀ
, 
nKeyw‹d
, ◊Keyw‹dTabÀ[0]), 
keyw‹dCom∑ª1
);

370 
i
=
nKeyw‹d
-2; i>=0; i--){

371 
Keyw‹d
 *
p
 = &
aKeyw‹dTabÀ
[
i
];

372 
j
=
nKeyw‹d
-1; j>
i
 && 
p
->
sub°rId
==0; j--){

373 
Keyw‹d
 *
pOthî
 = &
aKeyw‹dTabÀ
[
j
];

374 if–
pOthî
->
sub°rId
 ) ;

375 if–
pOthî
->
Àn
<=
p
->len ) ;

376 
k
=0; k<=
pOthî
->
Àn
-
p
->len; k++){

377 if–
	`memcmp
(
p
->
zName
, &
pOthî
->zName[
k
],Ö->
Àn
)==0 ){

378 
p
->
sub°rId
 = 
pOthî
->
id
;

379 
p
->
sub°rOff£t
 = 
k
;

387 
i
=0; i<
nKeyw‹d
; i++){

388 
Keyw‹d
 *
p
 = &
aKeyw‹dTabÀ
[
i
];

389 if–
p
->
sub°rId
 ) ;

390 
j
=0; j<
nKeyw‹d
; j++){

391 
Keyw‹d
 *
pOthî
;

392 if–
j
==
i
 ) ;

393 
pOthî
 = &
aKeyw‹dTabÀ
[
j
];

394 if–
pOthî
->
sub°rId
 ) ;

395 
k
=
p
->
l⁄ge°Suffix
+1; k<p->
Àn
 && k<
pOthî
->len; k++){

396 if–
	`memcmp
(&
p
->
zName
[p->
Àn
-
k
], 
pOthî
->zName, k)==0 ){

397 
p
->
l⁄ge°Suffix
 = 
k
;

404 
	`qs‹t
(
aKeyw‹dTabÀ
, 
nKeyw‹d
, ◊Keyw‹dTabÀ[0]), 
keyw‹dCom∑ª2
);

407 
nCh¨
 = 0;

408 
i
=0; i<
nKeyw‹d
; i++){

409 
Keyw‹d
 *
p
 = &
aKeyw‹dTabÀ
[
i
];

410 if–
p
->
off£t
>0 ||Ö->
sub°rId
 ) ;

411 
p
->
off£t
 = 
nCh¨
;

412 
nCh¨
 +
p
->
Àn
;

413 
k
=
p
->
Àn
-1; k>=1; k--){

414 
j
=
i
+1; j<
nKeyw‹d
; j++){

415 
Keyw‹d
 *
pOthî
 = &
aKeyw‹dTabÀ
[
j
];

416 if–
pOthî
->
off£t
>0 ||ÖOthî->
sub°rId
 ) ;

417 if–
pOthî
->
Àn
<=
k
 ) ;

418 if–
	`memcmp
(&
p
->
zName
[p->
Àn
-
k
], 
pOthî
->zName, k)==0 ){

419 
p
 = 
pOthî
;

420 
p
->
off£t
 = 
nCh¨
 - 
k
;

421 
nCh¨
 = 
p
->
off£t
 +Ö->
Àn
;

422 
p
->
zName
 +
k
;

423 
p
->
Àn
 -
k
;

424 
p
->
¥efix
 = 
k
;

425 
j
 = 
i
;

426 
k
 = 
p
->
Àn
;

431 
i
=0; i<
nKeyw‹d
; i++){

432 
Keyw‹d
 *
p
 = &
aKeyw‹dTabÀ
[
i
];

433 if–
p
->
sub°rId
 ){

434 
p
->
off£t
 = 
	`födById
’->
sub°rId
)->off£à+Ö->
sub°rOff£t
;

439 
	`qs‹t
(
aKeyw‹dTabÀ
, 
nKeyw‹d
, ◊Keyw‹dTabÀ[0]), 
keyw‹dCom∑ª3
);

443 
be°Size
 = 
nKeyw‹d
;

444 
be°Cou¡
 = 
nKeyw‹d
*nKeyword;

445 
i
=
nKeyw‹d
/2; i<=2*nKeyword; i++){

446 
j
=0; j<
i
; j++Ë
aHash
[j] = 0;

447 
j
=0; j<
nKeyw‹d
; j++){

448 
h
 = 
aKeyw‹dTabÀ
[
j
].
hash
 % 
i
;

449 
aHash
[
h
] *= 2;

450 
aHash
[
h
]++;

452 
j
=
cou¡
=0; j<
i
; j++Ëcou¡ +
aHash
[j];

453 if–
cou¡
<
be°Cou¡
 ){

454 
be°Cou¡
 = 
cou¡
;

455 
be°Size
 = 
i
;

460 
i
=0; i<
be°Size
; i++Ë
aHash
[i] = 0;

461 
i
=0; i<
nKeyw‹d
; i++){

462 
h
 = 
aKeyw‹dTabÀ
[
i
].
hash
 % 
be°Size
;

463 
aKeyw‹dTabÀ
[
i
].
iNext
 = 
aHash
[
h
];

464 
aHash
[
h
] = 
i
+1;

468 
	`¥ötf
("%s", 
zHdr
);

469 
	`¥ötf
("/* Hash sc‹e: %d */\n", 
be°Cou¡
);

470 
	`¥ötf
("static int keywordCode(const char *z, intÇ){\n");

471 
	`¥ötf
(" /* zText[]Éncodes %d bytes of keywords in %d bytes */\n",

472 
tŸÆLí
 + 
nKeyw‹d
, 
nCh¨
+1 );

473 
i
=
j
=
k
=0; i<
nKeyw‹d
; i++){

474 
Keyw‹d
 *
p
 = &
aKeyw‹dTabÀ
[
i
];

475 if–
p
->
sub°rId
 ) ;

476 
	`mem˝y
(&
zText
[
k
], 
p
->
zName
,Ö->
Àn
);

477 
k
 +
p
->
Àn
;

478 if–
j
+
p
->
Àn
>70 ){

479 
	`¥ötf
("%*†*/\n", 74-
j
, "");

480 
j
 = 0;

482 if–
j
==0 ){

483 
	`¥ötf
(" /* ");

484 
j
 = 8;

486 
	`¥ötf
("%s", 
p
->
zName
);

487 
j
 +
p
->
Àn
;

489 if–
j
>0 ){

490 
	`¥ötf
("%*†*/\n", 74-
j
, "");

492 
	`¥ötf
(" sèti¯c⁄° ch¨ zText[%d] = {\n", 
nCh¨
);

493 
zText
[
nCh¨
] = 0;

494 
i
=
j
=0; i<
k
; i++){

495 if–
j
==0 ){

496 
	`¥ötf
(" ");

498 if–
zText
[
i
]==0 ){

499 
	`¥ötf
("0");

501 
	`¥ötf
("'%c',", 
zText
[
i
]);

503 
j
 += 4;

504 if–
j
>68 ){

505 
	`¥ötf
("\n");

506 
j
 = 0;

509 if–
j
>0 ) 
	`¥ötf
("\n");

510 
	`¥ötf
(" };\n");

512 
	`¥ötf
(" sèti¯c⁄° unsig√d ch¨áHash[%d] = {\n", 
be°Size
);

513 
i
=
j
=0; i<
be°Size
; i++){

514 if–
j
==0 ) 
	`¥ötf
(" ");

515 
	`¥ötf
(" %3d,", 
aHash
[
i
]);

516 
j
++;

517 if–
j
>12 ){

518 
	`¥ötf
("\n");

519 
j
 = 0;

522 
	`¥ötf
("%† };\n", 
j
==0 ? "" : "\n");

524 
	`¥ötf
(" sèti¯c⁄° unsig√d ch¨áNext[%d] = {\n", 
nKeyw‹d
);

525 
i
=
j
=0; i<
nKeyw‹d
; i++){

526 if–
j
==0 ) 
	`¥ötf
(" ");

527 
	`¥ötf
(" %3d,", 
aKeyw‹dTabÀ
[
i
].
iNext
);

528 
j
++;

529 if–
j
>12 ){

530 
	`¥ötf
("\n");

531 
j
 = 0;

534 
	`¥ötf
("%† };\n", 
j
==0 ? "" : "\n");

536 
	`¥ötf
(" sèti¯c⁄° unsig√d ch¨áLí[%d] = {\n", 
nKeyw‹d
);

537 
i
=
j
=0; i<
nKeyw‹d
; i++){

538 if–
j
==0 ) 
	`¥ötf
(" ");

539 
	`¥ötf
(" %3d,", 
aKeyw‹dTabÀ
[
i
].
Àn
+aKeyw‹dTabÀ[i].
¥efix
);

540 
j
++;

541 if–
j
>12 ){

542 
	`¥ötf
("\n");

543 
j
 = 0;

546 
	`¥ötf
("%† };\n", 
j
==0 ? "" : "\n");

548 
	`¥ötf
(" sèti¯c⁄° unsig√d sh‹àöàaOff£t[%d] = {\n", 
nKeyw‹d
);

549 
i
=
j
=0; i<
nKeyw‹d
; i++){

550 if–
j
==0 ) 
	`¥ötf
(" ");

551 
	`¥ötf
(" %3d,", 
aKeyw‹dTabÀ
[
i
].
off£t
);

552 
j
++;

553 if–
j
>12 ){

554 
	`¥ötf
("\n");

555 
j
 = 0;

558 
	`¥ötf
("%† };\n", 
j
==0 ? "" : "\n");

560 
	`¥ötf
(" sèti¯c⁄° unsig√d ch¨áCode[%d] = {\n", 
nKeyw‹d
);

561 
i
=
j
=0; i<
nKeyw‹d
; i++){

562 *
zTokí
 = 
aKeyw‹dTabÀ
[
i
].
zTokíTy≥
;

563 if–
j
==0 ) 
	`¥ötf
(" ");

564 
	`¥ötf
("%s,%*s", 
zTokí
, ()(14-
	`°æí
(zToken)), "");

565 
j
++;

566 if–
j
>=5 ){

567 
	`¥ötf
("\n");

568 
j
 = 0;

571 
	`¥ötf
("%† };\n", 
j
==0 ? "" : "\n");

573 
	`¥ötf
(" int h, i;\n");

574 
	`¥ötf
(" if(Ç<2 )Ñeturn TK_ID;\n");

575 
	`¥ötf
(" h = ((charMap(z[0])*4) ^\n"

577 "ÇË%% %d;\n", 
be°Size
);

578 
	`¥ötf
(" for(i=((int)aHash[h])-1; i>=0; i=((int)aNext[i])-1){\n");

579 
	`¥ötf
(" if(áLen[i]==n &&"

581 
i
=0; i<
nKeyw‹d
; i++){

582 
	`¥ötf
("Åestcase( i==%d ); /* %s */\n",

583 
i
, 
aKeyw‹dTabÀ
[i].
zOrigName
);

585 
	`¥ötf
("ÑeturnáCode[i];\n");

586 
	`¥ötf
(" }\n");

587 
	`¥ötf
(" }\n");

588 
	`¥ötf
("Ñeturn TK_ID;\n");

589 
	`¥ötf
("}\n");

590 
	`¥ötf
("int sqlite4KeywordCode(const unsigned char *z, intÇ){\n");

591 
	`¥ötf
("Ñeturn keywordCode((char*)z,Ç);\n");

592 
	`¥ötf
("}\n");

593 
	`¥ötf
("#deföêSQLITE4_N_KEYWORD %d\n", 
nKeyw‹d
);

596 
	}
}

	@tool/rollback-test.c

13 
	~<°dio.h
>

14 
	~<°dlib.h
>

15 
	~<°rög.h
>

16 
	~"sqlôe4.h
"

18 
	$ußge
(*
¨gv0
){

19 
	`Ârötf
(
°dîr
,

23 
¨gv0
,árgv0,árgv0

25 
	`exô
(1);

26 
	}
}

28 
sqlôe4
 *
	$›íDb
(c⁄° *
zFûíame
){

29 
rc
;

30 
sqlôe4
 *
db
;

31 
rc
 = 
	`sqlôe4_›í
(
zFûíame
, &
db
);

32 if–
rc
 ){

33 
	`Ârötf
(
°dîr
, "Cannot open \"%s\": %s\n",

34 
zFûíame
, 
	`sqlôe4_îrmsg
(
db
));

35 
	`sqlôe4_˛o£
(
db
);

36 
	`exô
(1);

38  
db
;

39 
	}
}

41 
	gnRïly
 = 0;

42 
	gzRïly
[1000];

44 
	$execCÆlback
(*
NŸU£d
, 
nArg
, **
azArg
, **
azCﬁ
){

45 
i
, 
n
;

46 *
z
;

47 
i
=0; i<
nArg
; i++){

48 
z
 = 
azArg
[
i
];

49 if–
z
==0 ) z = "NULL";

50 if–
nRïly
>0 &&ÇRïly<(
zRïly
)-1 ) zReply[nReply++] = ' ';

51 
n
 = 
	`°æí
(
z
);

52 if–
nRïly
+
n
>=(
zRïly
)-1 )Ç = (zReply) -ÇReply - 1;

53 
	`mem˝y
(&
zRïly
[
nRïly
], 
z
, 
n
);

54 
nRïly
 +
n
;

55 
zRïly
[
nRïly
] = 0;

58 
	}
}

60 
	$runSql
(
sqlôe4
 *
db
, c⁄° *
zSql
){

61 *
zEº
 = 0;

62 
rc
;

63 
nRïly
 = 0;

64 
rc
 = 
	`sqlôe4_exec
(
db
, 
zSql
, 
execCÆlback
, 0, &
zEº
);

65 if–
zEº
 ){

66 
	`Ârötf
(
°dîr
, "SQLÉº‹: %s\n", 
zEº
);

67 
	`exô
(1);

69 if–
rc
 ){

70 
	`Ârötf
(
°dîr
, "SQLÉº‹: %s\n", 
	`sqlôe4_îrmsg
(
db
));

71 
	`exô
(1);

73 
	}
}

75 
	$maö
(
¨gc
, **
¨gv
){

76 
sqlôe4
 *
db
;

77 
i
;

79 if–
¨gc
<3 ) 
	`ußge
(
¨gv
[0]);

80 if–
	`°rcmp
(
¨gv
[1], "new")==0 ){

81 
db
 = 
	`›íDb
(
¨gv
[
¨gc
-1]);

82 
i
=2; i<
¨gc
-1; i++){

83 if–
	`°rcmp
(
¨gv
[
i
],"-utf8")==0 ){

84 
	`runSql
(
db
, "PRAGMAÉncoding=UTF8");

85 }if–
	`°rcmp
(
¨gv
[
i
], "-utf16le")==0 ){

86 
	`runSql
(
db
, "PRAGMAÉncoding=UTF16LE");

87 }if–
	`°rcmp
(
¨gv
[
i
], "-utf16be")==0 ){

88 
	`runSql
(
db
, "PRAGMAÉncoding=UTF16BE");

89 }if–
	`°∫cmp
(
¨gv
[
i
], "-pagesize=", 10)==0 ){

90 
szPg
 = 
	`©oi
(&
¨gv
[
i
][10]);

91 
zBuf
[100];

92 
	`•rötf
(
zBuf
, "PRAGMAÖagesize=%d", 
szPg
);

93 
	`runSql
(
db
, 
zBuf
);

95 
	`Ârötf
(
°dîr
, "unknow¿›ti⁄ %s\n", 
¨gv
[
i
]);

96 
	`ußge
(
¨gv
[0]);

99 
	`runSql
(
db
,

117 
	`sqlôe4_˛o£
(
db
);

118 }if–
	`°rcmp
(
¨gv
[1], "check")==0 ){

119 
db
 = 
	`›íDb
(
¨gv
[
¨gc
-1]);

120 
	`runSql
(
db
, "PRAGMA integrity_check");

121 if–
	`°rcmp
(
zRïly
, "ok")!=0 ){

122 
	`Ârötf
(
°dîr
, "I¡egrôy check: %s\n", 
zRïly
);

123 
	`exô
(1);

125 
	`runSql
(
db
,

128 if–
	`°rcmp
(
zRïly
, "0")!=0 ){

129 
	`Ârötf
(
°dîr
, "Wrong content\n");

130 
	`exô
(1);

132 
	`¥ötf
("Ok\n");

133 }if–
	`°rcmp
(
¨gv
[1], "crash")==0 ){

134 
db
 = 
	`›íDb
(
¨gv
[
¨gc
-1]);

135 
i
=2; i<
¨gc
-1; i++){

136 if–
	`°rcmp
(
¨gv
[
i
],"-wal")==0 ){

137 
	`runSql
(
db
, "PRAGMA journal_mode=WAL");

138 }if–
	`°rcmp
(
¨gv
[
i
], "-rollback")==0 ){

139 
	`runSql
(
db
, "PRAGMA journal_mode=DELETE");

141 
	`Ârötf
(
°dîr
, "unknow¿›ti⁄ %s\n", 
¨gv
[
i
]);

142 
	`ußge
(
¨gv
[0]);

145 
	`runSql
(
db
,

150 
	`exô
(0);

152 
	`ußge
(
¨gv
[0]);

155 
	}
}

	@tool/speedtest16.c

25 
	~<°dio.h
>

26 
	~<°rög.h
>

27 
	~<°dlib.h
>

28 
	~<˘y≥.h
>

29 
	~<uni°d.h
>

30 
	~"sqlôe4.h
"

36 
	~"hwtime.h
"

43 *
	$asciiToUtf16À
(c⁄° *
z
){

44 
n
 = 
	`°æí
(
z
);

45 *
z16
;

46 
i
, 
j
;

48 
z16
 = 
	`mÆloc
–
n
*2 + 2 );

49 
i
=
j
=0; i<=
n
; i++){

50 
z16
[
j
++] = 
z
[
i
];

51 
z16
[
j
++] = 0;

53  (*)
z16
;

54 
	}
}

59 
sqlôe_uöt64
 
	g¥ïTime
 = 0;

60 
sqlôe_uöt64
 
	grunTime
 = 0;

61 
sqlôe_uöt64
 
	gföÆizeTime
 = 0;

66 
	$¥ï¨eAndRun
(
sqlôe4
 *
db
, c⁄° *
zSql
){

67 *
utf16
;

68 
sqlôe4_°mt
 *
pStmt
;

69 c⁄° *
°mtTaû
;

70 
sqlôe_uöt64
 
iSèπ
, 
iEœp£
;

71 
rc
;

73 
	`¥ötf
("****************************************************************\n");

74 
	`¥ötf
("SQL sèãmít: [%s]\n", 
zSql
);

75 
utf16
 = 
	`asciiToUtf16À
(
zSql
);

76 
iSèπ
 = 
	`sqlôe4Hwtime
();

77 
rc
 = 
	`sqlôe4_¥ï¨e16_v2
(
db
, 
utf16
, -1, &
pStmt
, &
°mtTaû
);

78 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

79 
¥ïTime
 +
iEœp£
;

80 
	`¥ötf
("sqlôe4_¥ï¨e16_v2(Ëªtu∫†%d i¿%Œu cy˛es\n", 
rc
, 
iEœp£
);

81 if–
rc
==
SQLITE4_OK
 ){

82 
nRow
 = 0;

83 
iSèπ
 = 
	`sqlôe4Hwtime
();

84  (
rc
=
	`sqlôe4_°ï
(
pStmt
))==
SQLITE4_ROW
 ){ 
nRow
++; }

85 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

86 
runTime
 +
iEœp£
;

87 
	`¥ötf
("sqlite4_step()Ñeturns %dáfter %dÑows in %llu cycles\n",

88 
rc
, 
nRow
, 
iEœp£
);

89 
iSèπ
 = 
	`sqlôe4Hwtime
();

90 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

91 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

92 
föÆizeTime
 +
iEœp£
;

93 
	`¥ötf
("sqlôe4_föÆize(Ëªtu∫†%d i¿%Œu cy˛es\n", 
rc
, 
iEœp£
);

95 
	`‰ì
(
utf16
);

96 
	}
}

98 
	$maö
(
¨gc
, **
¨gv
){

99 *
utf16
;

100 
sqlôe4
 *
db
;

101 
rc
;

102 
nSql
;

103 *
zSql
;

104 
i
, 
j
;

105 
FILE
 *
ö
;

106 
sqlôe_uöt64
 
iSèπ
, 
iEœp£
;

107 
sqlôe_uöt64
 
iSëup
 = 0;

108 
nStmt
 = 0;

109 
nByã
 = 0;

111 if–
¨gc
!=3 ){

112 
	`Ârötf
(
°dîr
, "Usage: %s FILENAME SQL-SCRIPT\n"

114 
¨gv
[0]);

115 
	`exô
(1);

117 
ö
 = 
	`f›í
(
¨gv
[2], "r");

118 
	`f£ek
(
ö
, 0L, 
SEEK_END
);

119 
nSql
 = 
	`·ñl
(
ö
);

120 
zSql
 = 
	`mÆloc
–
nSql
+1 );

121 
	`f£ek
(
ö
, 0L, 
SEEK_SET
);

122 
nSql
 = 
	`‰ód
(
zSql
, 1,ÇSql, 
ö
);

123 
zSql
[
nSql
] = 0;

125 
	`¥ötf
("SQLôêvîsi⁄: %d\n", 
	`sqlôe4_libvîsi⁄_numbî
());

126 
	`u∆ök
(
¨gv
[1]);

127 
utf16
 = 
	`asciiToUtf16À
(
¨gv
[1]);

128 
iSèπ
 = 
	`sqlôe4Hwtime
();

129 
rc
 = 
	`sqlôe4_›í16
(
utf16
, &
db
);

130 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

131 
iSëup
 = 
iEœp£
;

132 
	`¥ötf
("sqlôe4_›í16(Ëªtu∫†%d i¿%Œu cy˛es\n", 
rc
, 
iEœp£
);

133 
	`‰ì
(
utf16
);

134 
i
=
j
=0; j<
nSql
; j++){

135 if–
zSql
[
j
]==';' ){

136 
isCom∂ëe
;

137 
c
 = 
zSql
[
j
+1];

138 
zSql
[
j
+1] = 0;

139 
isCom∂ëe
 = 
	`sqlôe4_com∂ëe
(&
zSql
[
i
]);

140 
zSql
[
j
+1] = 
c
;

141 if–
isCom∂ëe
 ){

142 
zSql
[
j
] = 0;

143  
i
<
j
 && 
	`is•a˚
(
zSql
[i]) ){ i++; }

144 if–
i
<
j
 ){

145 
nStmt
++;

146 
nByã
 +
j
-
i
;

147 
	`¥ï¨eAndRun
(
db
, &
zSql
[
i
]);

149 
zSql
[
j
] = ';';

150 
i
 = 
j
+1;

154 
iSèπ
 = 
	`sqlôe4Hwtime
();

155 
	`sqlôe4_˛o£
(
db
);

156 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

157 
iSëup
 +
iEœp£
;

158 
	`¥ötf
("sqlôe4_˛o£(Ëªtu∫†ö %Œu cy˛es\n", 
iEœp£
);

159 
	`¥ötf
("\n");

160 
	`¥ötf
("Sèãmít†run: %15d\n", 
nStmt
);

161 
	`¥ötf
("Byã†o‡SQLÅext: %15d\n", 
nByã
);

162 
	`¥ötf
("TŸÆÖª∑ªÅime: %15Œu cy˛es\n", 
¥ïTime
);

163 
	`¥ötf
("TŸÆÑu¿time: %15Œu cy˛es\n", 
runTime
);

164 
	`¥ötf
("TŸÆ föÆizêtime: %15Œu cy˛es\n", 
föÆizeTime
);

165 
	`¥ötf
("O≥n/Clo£Åime: %15Œu cy˛es\n", 
iSëup
);

166 
	`¥ötf
("Total Time: %15llu cycles\n",

167 
¥ïTime
 + 
runTime
 + 
föÆizeTime
 + 
iSëup
);

169 
	}
}

	@tool/speedtest8.c

24 
	~<°dio.h
>

25 
	~<°rög.h
>

26 
	~<°dlib.h
>

27 
	~<˘y≥.h
>

28 
	~<time.h
>

30 #i‡
deföed
(
_MSC_VER
)

31 
	~<wödows.h
>

33 
	~<uni°d.h
>

34 
	~<sys/times.h
>

35 
	~<sched.h
>

38 
	~"sqlôe4.h
"

44 
	~"hwtime.h
"

49 
sqlôe_uöt64
 
	g¥ïTime
 = 0;

50 
sqlôe_uöt64
 
	grunTime
 = 0;

51 
sqlôe_uöt64
 
	gföÆizeTime
 = 0;

56 
	$¥ï¨eAndRun
(
sqlôe4
 *
db
, c⁄° *
zSql
, 
bQuõt
){

57 
sqlôe4_°mt
 *
pStmt
;

58 c⁄° *
°mtTaû
;

59 
sqlôe_uöt64
 
iSèπ
, 
iEœp£
;

60 
rc
;

62 i‡(!
bQuõt
){

63 
	`¥ötf
("***************************************************************\n");

65 i‡(!
bQuõt
Ë
	`¥ötf
("SQL sèãmít: [%s]\n", 
zSql
);

66 
iSèπ
 = 
	`sqlôe4Hwtime
();

67 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, &
°mtTaû
);

68 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

69 
¥ïTime
 +
iEœp£
;

70 i‡(!
bQuõt
){

71 
	`¥ötf
("sqlôe4_¥ï¨e_v2(Ëªtu∫†%d i¿%Œu cy˛es\n", 
rc
, 
iEœp£
);

73 if–
rc
==
SQLITE4_OK
 ){

74 
nRow
 = 0;

75 
iSèπ
 = 
	`sqlôe4Hwtime
();

76  (
rc
=
	`sqlôe4_°ï
(
pStmt
))==
SQLITE4_ROW
 ){ 
nRow
++; }

77 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

78 
runTime
 +
iEœp£
;

79 i‡(!
bQuõt
){

80 
	`¥ötf
("sqlite4_step()Ñeturns %dáfter %dÑows in %llu cycles\n",

81 
rc
, 
nRow
, 
iEœp£
);

83 
iSèπ
 = 
	`sqlôe4Hwtime
();

84 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

85 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

86 
föÆizeTime
 +
iEœp£
;

87 i‡(!
bQuõt
){

88 
	`¥ötf
("sqlôe4_föÆize(Ëªtu∫†%d i¿%Œu cy˛es\n", 
rc
, 
iEœp£
);

91 
	}
}

93 
	$maö
(
¨gc
, **
¨gv
){

94 
sqlôe4
 *
db
;

95 
rc
;

96 
nSql
;

97 *
zSql
;

98 
i
, 
j
;

99 
FILE
 *
ö
;

100 
sqlôe_uöt64
 
iSèπ
, 
iEœp£
;

101 
sqlôe_uöt64
 
iSëup
 = 0;

102 
nStmt
 = 0;

103 
nByã
 = 0;

104 c⁄° *
zArgv0
 = 
¨gv
[0];

105 
bQuõt
 = 0;

106 #i‡!
	`deföed
(
_MSC_VER
)

107 
tms
 
tmsSèπ
, 
tmsEnd
;

108 
˛ock_t
 
˛kSèπ
, 
˛kEnd
;

111 #ifde‡
HAVE_OSINST


112 
sqlôe4_vfs
 *
	`sqlôe4_ö°vfs_bö¨ylog
(*, *, *);

113 
	`sqlôe4_ö°vfs_de°roy
(
sqlôe4_vfs
 *);

114 
sqlôe4_vfs
 *
pVfs
 = 0;

117 
¨gc
>3)

119 #ifde‡
HAVE_OSINST


120 if–
¨gc
>4 && (
	`°rcmp
(
¨gv
[1], "-log")==0) ){

121 
pVfs
 = 
	`sqlôe4_ö°vfs_bö¨ylog
("o¶og", 0, 
¨gv
[2]);

122 
	`sqlôe4_vfs_ªgi°î
(
pVfs
, 1);

123 
¨gv
 += 2;

124 
¨gc
 -= 2;

135 if–
¨gc
>4 && (
	`°rcmp
(
¨gv
[1], "-priority")==0) ){

136 #i‡
	`deföed
(
_MSC_VER
)

137 
√w_¥i‹ôy
 = 
	`©oi
(
¨gv
[2]);

138 if(!
	`SëPri‹ôyCœss
(
	`GëCuºítPro˚ss
(),

139 (
√w_¥i‹ôy
<=-5Ë? 
HIGH_PRIORITY_CLASS
 :

140 (
√w_¥i‹ôy
<=0Ë? 
ABOVE_NORMAL_PRIORITY_CLASS
 :

141 (
√w_¥i‹ôy
==0Ë? 
NORMAL_PRIORITY_CLASS
 :

142 (
√w_¥i‹ôy
<5Ë? 
BELOW_NORMAL_PRIORITY_CLASS
 :

143 
IDLE_PRIORITY_CLASS
)){

144 
	`¥ötf
 ("error settingÖriority\n");

145 
	`exô
(2);

148 
sched_∑øm
 
myP¨am
;

149 
	`sched_gë∑øm
(0, &
myP¨am
);

150 
	`¥ötf
 ("Cuºíà¥o˚s†¥i‹ôy i†%d.\n", ()
myP¨am
.
sched_¥i‹ôy
);

151 
myP¨am
.
sched_¥i‹ôy
 = 
	`©oi
(
¨gv
[2]);

152 
	`¥ötf
 ("SëtögÖro˚s†¥i‹ôyÅÿ%d.\n", ()
myP¨am
.
sched_¥i‹ôy
);

153 i‡(
	`sched_£ç¨am
 (0, &
myP¨am
) != 0){

154 
	`¥ötf
 ("error settingÖriority\n");

155 
	`exô
(2);

158 
¨gv
 += 2;

159 
¨gc
 -= 2;

163 if–
¨gc
>3 && 
	`°rcmp
(
¨gv
[1], "-quiet")==0 ){

164 
bQuõt
 = -1;

165 
¨gv
++;

166 
¨gc
--;

173 if–
¨gc
!=3 ){

174 
	`Ârötf
(
°dîr
, "Usage: %s [options] FILENAME SQL-SCRIPT\n"

177 #ifde‡
HAVE_OSINST


182 
zArgv0
);

183 
	`exô
(1);

186 
ö
 = 
	`f›í
(
¨gv
[2], "r");

187 
	`f£ek
(
ö
, 0L, 
SEEK_END
);

188 
nSql
 = 
	`·ñl
(
ö
);

189 
zSql
 = 
	`mÆloc
–
nSql
+1 );

190 
	`f£ek
(
ö
, 0L, 
SEEK_SET
);

191 
nSql
 = 
	`‰ód
(
zSql
, 1,ÇSql, 
ö
);

192 
zSql
[
nSql
] = 0;

194 
	`¥ötf
("SQLôêvîsi⁄: %d\n", 
	`sqlôe4_libvîsi⁄_numbî
());

195 
	`u∆ök
(
¨gv
[1]);

196 #i‡!
	`deföed
(
_MSC_VER
)

197 
˛kSèπ
 = 
	`times
(&
tmsSèπ
);

199 
iSèπ
 = 
	`sqlôe4Hwtime
();

200 
rc
 = 
	`sqlôe4_›í
(
¨gv
[1], &
db
);

201 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

202 
iSëup
 = 
iEœp£
;

203 i‡(!
bQuõt
Ë
	`¥ötf
("sqlôe4_›í(Ëªtu∫†%d i¿%Œu cy˛es\n", 
rc
, 
iEœp£
);

204 
i
=
j
=0; j<
nSql
; j++){

205 if–
zSql
[
j
]==';' ){

206 
isCom∂ëe
;

207 
c
 = 
zSql
[
j
+1];

208 
zSql
[
j
+1] = 0;

209 
isCom∂ëe
 = 
	`sqlôe4_com∂ëe
(&
zSql
[
i
]);

210 
zSql
[
j
+1] = 
c
;

211 if–
isCom∂ëe
 ){

212 
zSql
[
j
] = 0;

213  
i
<
j
 && 
	`is•a˚
(
zSql
[i]) ){ i++; }

214 if–
i
<
j
 ){

215 
n
 = 
j
 - 
i
;

216 if–
n
>=6 && 
	`memcmp
(&
zSql
[
i
], ".¸ash",6)==0 ) 
	`exô
(1);

217 
nStmt
++;

218 
nByã
 +
n
;

219 
	`¥ï¨eAndRun
(
db
, &
zSql
[
i
], 
bQuõt
);

221 
zSql
[
j
] = ';';

222 
i
 = 
j
+1;

226 
iSèπ
 = 
	`sqlôe4Hwtime
();

227 
	`sqlôe4_˛o£
(
db
);

228 
iEœp£
 = 
	`sqlôe4Hwtime
(Ë- 
iSèπ
;

229 #i‡!
	`deföed
(
_MSC_VER
)

230 
˛kEnd
 = 
	`times
(&
tmsEnd
);

232 
iSëup
 +
iEœp£
;

233 i‡(!
bQuõt
Ë
	`¥ötf
("sqlôe4_˛o£(Ëªtu∫†ö %Œu cy˛es\n", 
iEœp£
);

235 
	`¥ötf
("\n");

236 
	`¥ötf
("Sèãmít†run: %15d stmts\n", 
nStmt
);

237 
	`¥ötf
("Byã†o‡SQLÅext: %15d byãs\n", 
nByã
);

238 
	`¥ötf
("TŸÆÖª∑ªÅime: %15Œu cy˛es\n", 
¥ïTime
);

239 
	`¥ötf
("TŸÆÑu¿time: %15Œu cy˛es\n", 
runTime
);

240 
	`¥ötf
("TŸÆ föÆizêtime: %15Œu cy˛es\n", 
föÆizeTime
);

241 
	`¥ötf
("O≥n/Clo£Åime: %15Œu cy˛es\n", 
iSëup
);

242 
	`¥ötf
("TotalÅime: %15llu cycles\n",

243 
¥ïTime
 + 
runTime
 + 
föÆizeTime
 + 
iSëup
);

245 #i‡!
	`deföed
(
_MSC_VER
)

246 
	`¥ötf
("\n");

247 
	`¥ötf
("TŸÆ u£∏CPUÅime: %15.3g secs\n", (
tmsEnd
.
tms_utime
 - 
tmsSèπ
.tms_utime)/()
CLOCKS_PER_SEC
 );

248 
	`¥ötf
("TŸÆ sy°em CPUÅime: %15.3g secs\n", (
tmsEnd
.
tms_°ime
 - 
tmsSèπ
.tms_°ime)/()
CLOCKS_PER_SEC
 );

249 
	`¥ötf
("TŸÆÑó»time: %15.3g secs\n", (
˛kEnd
 -
˛kSèπ
)/()
CLOCKS_PER_SEC
 );

252 #ifde‡
HAVE_OSINST


253 if–
pVfs
 ){

254 
	`sqlôe4_ö°vfs_de°roy
(
pVfs
);

255 
	`¥ötf
("vf†log wrôã¿tÿ%s\n", 
¨gv
[0]);

260 
	}
}

	@tool/speedtest8inst1.c

24 
	~<°dio.h
>

25 
	~<°rög.h
>

26 
	~<°dlib.h
>

27 
	~<˘y≥.h
>

28 
	~<uni°d.h
>

29 
	~<°d¨g.h
>

30 
	~"sqlôe4.h
"

32 
	~"ã°_osö°.c
"

37 
	$¥ï¨eAndRun
(
sqlôe4_vfs
 *
pIn°Vfs
, 
sqlôe4
 *
db
, c⁄° *
zSql
){

38 
sqlôe4_°mt
 *
pStmt
;

39 c⁄° *
°mtTaû
;

40 
rc
;

41 
zMesßge
[1024];

42 
zMesßge
[1023] = '\0';

44 
sqlôe4_uöt64
 
iTime
;

46 
	`sqlôe4_¢¥ötf
(1023, 
zMesßge
, "sqlôe4_¥ï¨e_v2: %s", 
zSql
);

47 
	`sqlôe4_ö°vfs_bö¨ylog_m¨kî
(
pIn°Vfs
, 
zMesßge
);

49 
iTime
 = 
	`sqlôe4Hwtime
();

50 
rc
 = 
	`sqlôe4_¥ï¨e_v2
(
db
, 
zSql
, -1, &
pStmt
, &
°mtTaû
);

51 
iTime
 = 
	`sqlôe4Hwtime
() - iTime;

52 
	`sqlôe4_ö°vfs_bö¨ylog_ˇŒ
(
pIn°Vfs
,
BINARYLOG_PREPARE_V2
,
iTime
,
rc
,
zSql
);

54 if–
rc
==
SQLITE4_OK
 ){

55 
nRow
 = 0;

57 
	`sqlôe4_¢¥ötf
(1023, 
zMesßge
, "sqlôe4_°ïÜo›: %s", 
zSql
);

58 
	`sqlôe4_ö°vfs_bö¨ylog_m¨kî
(
pIn°Vfs
, 
zMesßge
);

59 
iTime
 = 
	`sqlôe4Hwtime
();

60  (
rc
=
	`sqlôe4_°ï
(
pStmt
))==
SQLITE4_ROW
 ){ 
nRow
++; }

61 
iTime
 = 
	`sqlôe4Hwtime
() - iTime;

62 
	`sqlôe4_ö°vfs_bö¨ylog_ˇŒ
(
pIn°Vfs
, 
BINARYLOG_STEP
, 
iTime
, 
rc
, 
zSql
);

64 
	`sqlôe4_¢¥ötf
(1023, 
zMesßge
, "sqlôe4_föÆize: %s", 
zSql
);

65 
	`sqlôe4_ö°vfs_bö¨ylog_m¨kî
(
pIn°Vfs
, 
zMesßge
);

66 
iTime
 = 
	`sqlôe4Hwtime
();

67 
rc
 = 
	`sqlôe4_föÆize
(
pStmt
);

68 
iTime
 = 
	`sqlôe4Hwtime
() - iTime;

69 
	`sqlôe4_ö°vfs_bö¨ylog_ˇŒ
(
pIn°Vfs
, 
BINARYLOG_FINALIZE
, 
iTime
, 
rc
, 
zSql
);

71 
	}
}

73 
	$°rögcom∑ª
(c⁄° *
zLe·
, c⁄° *
zRight
){

74 
ii
;

75 
ii
=0; 
zLe·
[ii] && 
zRight
[ii]; ii++){

76 if–
zLe·
[
ii
]!=
zRight
[ii] )  0;

78 –
zLe·
[
ii
]==
zRight
[ii] );

79 
	}
}

81 *
	$ªadS¸ùtFûe
(c⁄° *
zFûe
, *
≤S¸ùt
){

82 
sqlôe4_vfs
 *
pVfs
 = 
	`sqlôe4_vfs_föd
(0);

83 
sqlôe4_fûe
 *
p
;

84 
rc
;

85 
sqlôe4_öt64
 
nByã
;

86 *
zD©a
 = 0;

87 
Êags
 = 
SQLITE4_OPEN_READONLY
|
SQLITE4_OPEN_MAIN_DB
;

89 
p
 = (
sqlôe4_fûe
 *)
	`mÆloc
(
pVfs
->
szOsFûe
);

90 
rc
 = 
pVfs
->
	`xO≥n
’Vfs, 
zFûe
, 
p
, 
Êags
, &flags);

91 if–
rc
!=
SQLITE4_OK
 ){

92 
îr‹_out
;

95 
rc
 = 
p
->
pMëhods
->
	`xFûeSize
’, &
nByã
);

96 if–
rc
!=
SQLITE4_OK
 ){

97 
˛o£_out
;

100 
zD©a
 = (*)
	`mÆloc
(
nByã
+1);

101 
rc
 = 
p
->
pMëhods
->
	`xRód
’, 
zD©a
, 
nByã
, 0);

102 if–
rc
!=
SQLITE4_OK
 ){

103 
˛o£_out
;

105 
zD©a
[
nByã
] = '\0';

107 
p
->
pMëhods
->
	`xClo£
(p);

108 
	`‰ì
(
p
);

109 *
≤S¸ùt
 = 
nByã
;

110  
zD©a
;

112 
˛o£_out
:

113 
p
->
pMëhods
->
	`xClo£
(p);

115 
îr‹_out
:

116 
	`‰ì
(
p
);

117 
	`‰ì
(
zD©a
);

119 
	}
}

121 
	$maö
(
¨gc
, **
¨gv
){

123 c⁄° 
zUßgeMsg
[] =

136 c⁄° *
zDb
 = 0;

137 c⁄° *
zS¸ùt
 = 0;

138 c⁄° *
zLog
 = 0;

139 
logd©a
 = 0;

141 
ii
;

142 
i
, 
j
;

143 
rc
;

145 
sqlôe4_vfs
 *
pIn°Vfs
;

147 *
zSql
 = 0;

148 
nSql
;

150 
sqlôe4
 *
db
;

152 
ii
=1; ii<
¨gc
; ii++){

153 if–
	`°rögcom∑ª
("-db", 
¨gv
[
ii
]Ë&& (ii+1)<
¨gc
 ){

154 
zDb
 = 
¨gv
[++
ii
];

157 if–
	`°rögcom∑ª
("-s¸ùt", 
¨gv
[
ii
]Ë&& (ii+1)<
¨gc
 ){

158 
zS¸ùt
 = 
¨gv
[++
ii
];

161 if–
	`°rögcom∑ª
("-log", 
¨gv
[
ii
]Ë&& (ii+1)<
¨gc
 ){

162 
zLog
 = 
¨gv
[++
ii
];

165 if–
	`°rögcom∑ª
("-logd©a", 
¨gv
[
ii
]) ){

166 
logd©a
 = 1;

170 
ußge
;

173 if–!
zDb
 || !
zS¸ùt
 || !
zLog
 ) 
ußge
;

175 
zSql
 = 
	`ªadS¸ùtFûe
(
zS¸ùt
, &
nSql
);

176 if–!
zSql
 ){

177 
	`Ârötf
(
°dîr
, "FailedÅoÑead script file\n");

181 
pIn°Vfs
 = 
	`sqlôe4_ö°vfs_bö¨ylog
("loggög", 0, 
zLog
, 
logd©a
);

183 
rc
 = 
	`sqlôe4_›í_v2
(

184 
zDb
, &
db
, 
SQLITE4_OPEN_READWRITE
 | 
SQLITE4_OPEN_CREATE
, "logging"

186 if–
rc
!=
SQLITE4_OK
 ){

187 
	`Ârötf
(
°dîr
, "FaûedÅÿ›í db: %s\n", 
	`sqlôe4_îrmsg
(
db
));

191 
i
=
j
=0; j<
nSql
; j++){

192 if–
zSql
[
j
]==';' ){

193 
isCom∂ëe
;

194 
c
 = 
zSql
[
j
+1];

195 
zSql
[
j
+1] = 0;

196 
isCom∂ëe
 = 
	`sqlôe4_com∂ëe
(&
zSql
[
i
]);

197 
zSql
[
j
+1] = 
c
;

198 if–
isCom∂ëe
 ){

199 
zSql
[
j
] = 0;

200  
i
<
j
 && 
	`is•a˚
(
zSql
[i]) ){ i++; }

201 if–
i
<
j
 ){

202 
	`¥ï¨eAndRun
(
pIn°Vfs
, 
db
, &
zSql
[
i
]);

204 
zSql
[
j
] = ';';

205 
i
 = 
j
+1;

210 
	`sqlôe4_ö°vfs_de°roy
(
pIn°Vfs
);

213 
ußge
:

214 
	`Ârötf
(
°dîr
, 
zUßgeMsg
, 
¨gv
[0]);

216 
	}
}

	@
1
.
0
211
3526
benchmark/anntest.c
benchmark/benchtest.c
benchmark/blobtest.c
ext/fts1/ft_hash.c
ext/fts1/ft_hash.h
ext/fts1/fts1.c
ext/fts1/fts1.h
ext/fts1/fts1_hash.c
ext/fts1/fts1_hash.h
ext/fts1/fts1_porter.c
ext/fts1/fts1_tokenizer.h
ext/fts1/fts1_tokenizer1.c
ext/fts1/fulltext.c
ext/fts1/fulltext.h
ext/fts1/simple_tokenizer.c
ext/fts1/tokenizer.h
ext/fts2/fts2.c
ext/fts2/fts2.h
ext/fts2/fts2_hash.c
ext/fts2/fts2_hash.h
ext/fts2/fts2_icu.c
ext/fts2/fts2_porter.c
ext/fts2/fts2_tokenizer.c
ext/fts2/fts2_tokenizer.h
ext/fts2/fts2_tokenizer1.c
ext/fts3/fts3.c
ext/fts3/fts3.h
ext/fts3/fts3Int.h
ext/fts3/fts3_aux.c
ext/fts3/fts3_expr.c
ext/fts3/fts3_hash.c
ext/fts3/fts3_hash.h
ext/fts3/fts3_icu.c
ext/fts3/fts3_porter.c
ext/fts3/fts3_snippet.c
ext/fts3/fts3_term.c
ext/fts3/fts3_test.c
ext/fts3/fts3_tokenizer.c
ext/fts3/fts3_tokenizer.h
ext/fts3/fts3_tokenizer1.c
ext/fts3/fts3_write.c
ext/icu/icu.c
ext/icu/sqliteicu.h
ext/rtree/rtree.c
ext/rtree/rtree.h
ext/rtree/sqlite4rtree.h
lsm-test/lsmtest.h
lsm-test/lsmtest1.c
lsm-test/lsmtest2.c
lsm-test/lsmtest3.c
lsm-test/lsmtest4.c
lsm-test/lsmtest5.c
lsm-test/lsmtest6.c
lsm-test/lsmtest7.c
lsm-test/lsmtest8.c
lsm-test/lsmtest9.c
lsm-test/lsmtest_datasource.c
lsm-test/lsmtest_func.c
lsm-test/lsmtest_io.c
lsm-test/lsmtest_main.c
lsm-test/lsmtest_mem.c
lsm-test/lsmtest_tdb.c
lsm-test/lsmtest_tdb.h
lsm-test/lsmtest_tdb2.cc
lsm-test/lsmtest_tdb3.c
lsm-test/lsmtest_tdb4.c
lsm-test/lsmtest_util.c
lsm-test/sqltest.c
src/alter.c
src/analyze.c
src/attach.c
src/auth.c
src/bt.h
src/btInt.h
src/bt_lock.c
src/bt_log.c
src/bt_main.c
src/bt_pager.c
src/bt_unix.c
src/bt_varint.c
src/build.c
src/callback.c
src/complete.c
src/ctime.c
src/date.c
src/delete.c
src/env.c
src/expr.c
src/fault.c
src/fkey.c
src/fts5.c
src/fts5func.c
src/func.c
src/global.c
src/hash.c
src/hash.h
src/hwtime.h
src/insert.c
src/kv.c
src/kv.h
src/kvbt.c
src/kvlsm.c
src/kvmem.c
src/legacy.c
src/lempar.c
src/lsm.h
src/lsmInt.h
src/lsm_ckpt.c
src/lsm_file.c
src/lsm_log.c
src/lsm_main.c
src/lsm_mem.c
src/lsm_mutex.c
src/lsm_shared.c
src/lsm_sorted.c
src/lsm_str.c
src/lsm_tree.c
src/lsm_unix.c
src/lsm_varint.c
src/main.c
src/malloc.c
src/math.c
src/mem.c
src/mem.h
src/mem0.c
src/mem1.c
src/mem2.c
src/mem3.c
src/mem5.c
src/mutex.c
src/mutex.h
src/mutex_noop.c
src/mutex_unix.c
src/mutex_w32.c
src/os.c
src/os.h
src/parse.y
src/pragma.c
src/prepare.c
src/printf.c
src/random.c
src/resolve.c
src/rowset.c
src/select.c
src/sqliteInt.h
src/sqliteLimit.h
src/status.c
src/tclsqlite.c
src/tokenize.c
src/trigger.c
src/update.c
src/utf.c
src/util.c
src/varint.c
src/vdbe.c
src/vdbe.h
src/vdbeInt.h
src/vdbeapi.c
src/vdbeaux.c
src/vdbeblob.c
src/vdbecodec.c
src/vdbecursor.c
src/vdbemem.c
src/vdbetrace.c
src/vector.c
src/vectorIndex.c
src/vectorIndexInt.h
src/vectorInt.h
src/vectordiskann.c
src/vectorfloat16.c
src/vectorfloat1bit.c
src/vectorfloat32.c
src/vectorfloat64.c
src/vectorfloat8.c
src/vectorfloatb16.c
src/vectorvtab.c
src/walker.c
src/where.c
test/crashtest1.c
test/testInt.h
test/test_auth.c
test/test_bt.c
test/test_config.c
test/test_func.c
test/test_hexio.c
test/test_kv.c
test/test_kv2.c
test/test_lsm.c
test/test_main.c
test/test_malloc.c
test/test_mem.c
test/test_misc1.c
test/test_mutex.c
test/test_num.c
test/test_thread.c
test/test_thread0.c
test/test_utf.c
test/test_wsd.c
test/tt3_checkpoint.c
test_blob.c
test_libsql.c
tool/diffdb.c
tool/extract.c
tool/lemon.c
tool/lempar.c
tool/lsmheader.c
tool/mkkeywordhash.c
tool/rollback-test.c
tool/speedtest16.c
tool/speedtest8.c
tool/speedtest8inst1.c
